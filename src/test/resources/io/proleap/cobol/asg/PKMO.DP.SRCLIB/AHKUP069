000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.         AHKUP069.                                    00020000
000300 AUTHOR.             NANCY EILBES.                                00030000
000400 DATE-WRITTEN.       APRIL 2000.                                  00040000
000500 DATE-COMPILED.                                                   00050000
000600*************************************************************     00060000
000700*    COBOL 2 WITH SQL                                       *     00070000
000800*                                                           *     00080000
000900*   AHKUP069 - ARCHIVE HISTORY DATA DELETION - TTRBNTF      *     00090000
001000*                                                           *     00100000
001100*   PROGRAM OVERVIEW:                                       *     00110000
001200*                                                           *     00120000
001300*  THIS PROGRAM DELETES "OLD" ROWS FROM DB2 TABLE TTRBNTF.  *     00130000
001400*  ROWS DELETED ARE THOSE PREVIOUSLY:                       *     00140000
001500*  - IDENTIFIED/EXTRACTED WITHIN THE ARCHIVE/HISTORY SYSTEM.*     00150000
001600*                                                           *     00160000
001700*  THE EXTRACT FILE USED AS INPUT WILL BE SORTED BY THE     *     00170000
001800*  CLUSTERING INDEX COLUMNS TO SPEED THE DELETION PROCESS.  *     00180000
001900*  THESE COLUMNS ARE PO_NBR, PAYT_REQ_SEQ_NBR.              *     00190000
002000*                                                           *     00200000
002100*  NOTE THAT CASCADE/DELETE WILL ALSO REMOVE RELATED ROWS   *     00210000
002200*  FROM THE FOLLOWING TABLES:                               *     00220000
002300*  - TTRBDTL                                                *     00230001
002400*                                                           *     00240000
002500*   INPUT:                                                  *     00250000
002600*                                                           *     00260000
002700*     1. TTRBNTF DELETION FILE  COPYBOOK AHRD006            *     00270002
002800*                                                           *     00280000
002900*   DB2 TABLES:                                             *     00290000
003000*                                                           *     00300000
003100*        TTRBNTF - TROUBLE NOTIFICATION TABLE               *     00310001
003200*        TTRBDTL - TROUBLE DETAIL TABLE                     *     00320001
003300*                                                           *     00330000
003400*************************************************************     00340000
003500*                                                           *     00350000
003600*************************************************************     00360000
003700 EJECT                                                            00370000
003800 ENVIRONMENT DIVISION.                                            00380000
003900 CONFIGURATION SECTION.                                           00390000
004000 SOURCE-COMPUTER.        IBM-370.                                 00400000
004100 OBJECT-COMPUTER.        IBM-370.                                 00410000
004200                                                                  00420000
004300 INPUT-OUTPUT SECTION.                                            00430000
004400 FILE-CONTROL.                                                    00440000
004500     SELECT TTRBNTF-EXTRACT-FILE ASSIGN TO INP01.                 00450000
004600                                                                  00460000
004700 DATA DIVISION.                                                   00470000
004800 FILE SECTION.                                                    00480000
004900 FD  TTRBNTF-EXTRACT-FILE                                         00490000
005000     RECORDING MODE IS F                                          00500000
005100     LABEL RECORDS ARE STANDARD                                   00510000
005200     BLOCK CONTAINS 0 RECORDS                                     00520000
005300     RECORD CONTAINS 247 CHARACTERS                               00530002
005400     DATA RECORD IS TTRBNTF-EXTRACT-DATA.                         00540000
005500 01  TTRBNTF-EXTRACT-DATA       PIC X(247).                       00550000
005600                                                                  00560000
005700                                                                  00570000
005800 EJECT                                                            00580000
005900 WORKING-STORAGE SECTION.                                         00590000
006000                                                                  00600000
006100 01  FILLER                       PIC X(58)     VALUE             00610000
006200     '************WORKING STORAGE STARTS HERE*******************'.00620000
006300                                                                  00630000
006400 01  PV-PROGRAM-VARIABLES.                                        00640000
006500     05  PV-PROGRAM-NAME          PIC  X(08)    VALUE 'AHKUP069'. 00650000
006600     05  PV-CKPT-STAT-CODE        PIC X(01)     VALUE SPACE.      00660000
006700     05  PV-CURRENT-PARAGRAPH     PIC X(50)     VALUE SPACES.     00670000
006800     05  PV-CURRENT-TMST          PIC X(26)     VALUE SPACES.     00680000
006900                                                                  00690000
007000     05  PV-TTRBNTF-INPUT-COUNT   PIC S9(09)    VALUE ZERO        00700000
007100                                                COMP-3.           00710000
007200     05  PV-TTRBNTF-DELETE-COUNT  PIC S9(09)    VALUE ZERO        00720000
007300                                                COMP-3.           00730000
007400     05  PV-SQL-DELETE-COUNT      PIC S9(09)    VALUE ZERO        00740000
007500                                                COMP-3.           00750000
007600     05  PV-SQLERRD3              PIC S9(09)    VALUE ZERO        00760000
007700                                                COMP-3.           00770000
008010     05  PV-NOTIFY-NBR            PIC X(09)    VALUE SPACES.      00801005
008100 01  PC-PROGRAM-CONSTANTS.                                        00810000
008200     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          00820000
008300                                                COMP SYNC.        00830000
008400     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      00840000
008500     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00850000
008600     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00860000
008700                                                                  00870000
008800 01  PS-PROGRAM-SWITCHES.                                         00880000
008900     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.        00890000
009000         88  COMMITS-TAKEN                      VALUE 'T'.        00900000
009100         88  NO-COMMITS-TAKEN                   VALUE 'N'.        00910000
009200     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.        00920000
009300         88  MORE-EXTRACT                       VALUE 'M'.        00930000
009400         88  END-OF-EXTRACT                     VALUE 'E'.        00940000
009500     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        00950000
009600         88  NORMAL-RUN                         VALUE '0'.        00960000
009700         88  RESTART-RUN                        VALUE '9'.        00970000
009800                                                                  00980000
009900 01  WS-COUNTER.                                                  00990000
010000     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.     01000000
010100     05  WS-TMST                  PIC X(26)     VALUE SPACES.     01010000
010200                                                                  01020000
010300 01  CKPT-RESTART-INFO.                                           01030000
010400     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.       01040000
010500                                                                  01050000
010600*----------------------------------------------------------------*01060000
010700*  ABEND DATA AREAS                                              *01070000
010800*----------------------------------------------------------------*01080000
010900 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01090000
011000                                             COMP SYNC.           01100000
011100     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         01110000
011200     88  AC-BAD-DATA                         VALUE +4008.         01120000
011300     88  AC-DB2-ERROR                        VALUE +4013.         01130000
011400     88  AC-DATE-ERROR                       VALUE +4019.         01140000
011500                                                                  01150000
011600                                                                  01160000
011700 01  ABEND-AREAS.                                                 01170000
011800     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01180000
011900             '*****       ABEND'.                                 01190000
012000     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01200000
012100             '*****   PROGRAM: AHKUP069'.                         01210000
012200     05  AA-PARAGRAPH-LIT.                                        01220000
012300         10  FILLER              PIC  X(17)  VALUE                01230000
012400             '***** PARAGRAPH: '.                                 01240000
012500         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01250000
012600     05  AA-MESSAGE-LINE-1.                                       01260000
012700         10  FILLER              PIC  X(06)  VALUE '*****'.       01270000
012800         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01280000
012900     05  AA-MESSAGE-LINE-2.                                       01290000
013000         10  FILLER              PIC  X(06)  VALUE '*****'.       01300000
013100         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01310000
013200     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01320000
013300             '*****    DB2 ERROR'.                                01330000
013400     05  AA-DB2-OPERATION-LIT.                                    01340000
013500         10  FILLER              PIC  X(17)  VALUE                01350000
013600             '***** OPERATION: '.                                 01360000
013700         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01370000
013800     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01380000
013900     EJECT                                                        01390000
014000                                                                  01400000
014100*----------------------------------------------------------------*01410000
014200*      TTRBNTF DELETION CONTROL FILE                              01420000
014300*----------------------------------------------------------------*01430000
014400*                                                                 01440000
014500     COPY AHRD006.                                                01450002
014600     EJECT                                                        01460000
014700     COPY DPWS004.                                                01470000
014800     EJECT                                                        01480000
014900*----------------------------------------------------------------*01490000
015000*      TTRBNTF TABLE LAYOUT                                       01500000
015100*----------------------------------------------------------------*01510000
015200         EXEC SQL                                                 01520000
015300             INCLUDE TTRBNTF                                      01530000
015400         END-EXEC.                                                01540000
015500                                                                  01550000
015600*----------------------------------------------------------------*01560000
015700*      TCKRSTCNTL TABLE LAYOUT                                    01570000
015800*----------------------------------------------------------------*01580000
015900         EXEC SQL                                                 01590000
016000             INCLUDE TCKRSTCN                                     01600000
016100         END-EXEC.                                                01610000
016200                                                                  01620000
016300*----------------------------------------------------------------*01630000
016400*      TCKRSTINF TABLE LAYOUT                                     01640000
016500*----------------------------------------------------------------*01650000
016600         EXEC SQL                                                 01660000
016700             INCLUDE TCKRSTIN                                     01670000
016800         END-EXEC.                                                01680000
016900 EJECT                                                            01690000
017000*----------------------------------------------------------------*01700000
017100*  DB2 COMMUNICATION AREA                                         01710000
017200*----------------------------------------------------------------*01720000
017300*                                                                 01730000
017400     EXEC SQL                                                     01740000
017500         INCLUDE SQLCA                                            01750000
017600     END-EXEC.                                                    01760000
017700                                                                  01770000
017800*----------------------------------------------------------------*01780000
017900*  DB2 COMMUNICATION AREA2                                        01790000
018000*----------------------------------------------------------------*01800000
018100*                                                                 01810000
018200     COPY SQLCA2.                                                 01820000
018300     EJECT                                                        01830000
018400 PROCEDURE DIVISION.                                              01840000
018500 A100-MAINLINE-ROUTINE.                                           01850000
018600                                                                  01860000
018700     PERFORM B100-INITIALIZATION.                                 01870000
018800                                                                  01880000
018900     PERFORM B200-TTRBNTF-EXTRACT-PROCESS                         01890000
019000       UNTIL END-OF-EXTRACT.                                      01900000
019100                                                                  01910000
019200     PERFORM B300-EOJ-PROCESSING.                                 01920000
019300                                                                  01930000
019400     GOBACK.                                                      01940000
019500 EJECT                                                            01950000
019600 B100-INITIALIZATION.                                             01960000
019700                                                                  01970000
019800     EXEC SQL                                                     01980000
019900         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 01990000
020000     END-EXEC.                                                    02000000
020100                                                                  02010000
020200     PERFORM X300-GET-CHECKPOINT-CNTL.                            02020000
020300     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    02030000
020400                                                                  02040000
020500     OPEN INPUT TTRBNTF-EXTRACT-FILE.                             02050000
020600                                                                  02060000
020700     IF RESTART-RUN                                               02070000
020800         PERFORM X200-CHECKPOINT-RESTART                          02080000
020900     ELSE                                                         02090000
021000         PERFORM R100-READ-EXTRACT-FILE                           02100000
021100     END-IF.                                                      02110000
021200                                                                  02120000
021300     PERFORM X500-SET-CHECKPOINT-TIME.                            02130000
021400                                                                  02140000
021500                                                                  02150000
021600     EJECT                                                        02160000
021700 B200-TTRBNTF-EXTRACT-PROCESS.                                    02170000
021800                                                                  02180000
021900     MOVE AH006-NOTIF-NBR           TO TRBNTF-NOTIF-NBR           02190005
022000                                       PV-NOTIFY-NBR.             02200004
022500                                                                  02250000
022600     PERFORM D100-DELETE-TTRBNTF.                                 02260000
022700                                                                  02270000
022800     PERFORM X100-CHECKPOINT-CHECK.                               02280000
022900                                                                  02290000
023000     PERFORM R100-READ-EXTRACT-FILE.                              02300000
023100     EJECT                                                        02310000
023200                                                                  02320000
023300                                                                  02330000
023400 B300-EOJ-PROCESSING.                                             02340000
023500                                                                  02350000
023600     DISPLAY '** AHKUP069 SUMMARY **'.                            02360000
023700     DISPLAY '** TTRBNTF INPUT COUNT = ' PV-TTRBNTF-INPUT-COUNT.  02370000
023800     DISPLAY '** TTRBNTF DELETE COUNT = ' PV-TTRBNTF-DELETE-COUNT.02380000
023900     DISPLAY '** SQL DELETE COUNT = ' PV-SQL-DELETE-COUNT.        02390007
024000                                                                  02400000
024100     CLOSE  TTRBNTF-EXTRACT-FILE.                                 02410000
024200                                                                  02420000
024300     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02430000
024400     PERFORM X600-UPDATE-TCKRSTCNTL.                              02440000
024500                                                                  02450000
024600     EJECT                                                        02460000
024700*----------------------------------------------------------------*02470000
024800*    DELETES FROM THE TTRBNTF TABLE.  CASCADE DELETE WILL ALSO   *02480000
024900*    CAUSE ROWS TO BE DELETED FROM THE TTRBNTF TABLE.            *02490000
025000*----------------------------------------------------------------*02500000
025100 D100-DELETE-TTRBNTF.                                             02510000
025200                                                                  02520000
025300     MOVE 'D100-DELETE-TTRBNTF' TO PV-CURRENT-PARAGRAPH.          02530000
025400                                                                  02540000
025500     PERFORM WITH TEST AFTER                                      02550000
025600        VARYING PC-RETRY-COUNT FROM 1 BY 1                        02560000
025700          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                     02570000
025800             OR SQLCODE = ZERO                                    02580000
025900                                                                  02590000
026000         EXEC SQL                                                 02600000
026100              DELETE                                              02610000
026200                FROM TTRBNTF                                      02620000
026300               WHERE NOTIF_NBR         = :TRBNTF-NOTIF-NBR        02630004
026600         END-EXEC                                                 02660000
026700                                                                  02670000
026800         EVALUATE TRUE                                            02680000
026900             WHEN SQLCODE = ZERO                                  02690000
027000                 ADD 1 TO PV-TTRBNTF-DELETE-COUNT                 02700000
027100                 MOVE SQLERRD(3) TO PV-SQLERRD3                   02710000
027200                 ADD PV-SQLERRD3 TO PV-SQL-DELETE-COUNT           02720000
027300                                                                  02730000
027400             WHEN SQLCODE = -904                                  02740000
027500             WHEN SQLCODE = -913                                  02750000
027600                  CONTINUE                                        02760000
027700                                                                  02770000
027800             WHEN SQLCODE = +100                                  02780000
027900                 MOVE PV-CURRENT-PARAGRAPH                        02790000
028000                                     TO AA-PARAGRAPH-NAME         02800000
028100                 DISPLAY '******** NOTIFY NBR:'                   02810004
028200                          PV-NOTIFY-NBR                           02820005
028700                 MOVE 'ROW NOT ON TABLE ********'                 02870000
028800                          TO AA-MESSAGE-1                         02880000
028900                 MOVE SPACES TO AA-MESSAGE-2                      02890000
029000                 MOVE 'UNSUCCESSFUL DELETE'                       02900000
029100                          TO AA-DB2-OPERATION                     02910000
029200                 MOVE 'TTRBNTF'  TO AA-DB2-TABLE                  02920000
029300                 PERFORM Z999-DB2-ABEND                           02930000
029400             WHEN SQLWARN0 NOT = SPACES                           02940000
029500             WHEN SQLCODE  NOT = ZERO                             02950000
029600                 MOVE PV-CURRENT-PARAGRAPH                        02960000
029700                                     TO AA-PARAGRAPH-NAME         02970000
029710                 DISPLAY '******** NOTIFY NBR:'                   02971004
029720                          PV-NOTIFY-NBR                           02972005
030400                 MOVE SPACES TO AA-MESSAGE-1                      03040000
030500                                AA-MESSAGE-2                      03050000
030600                 MOVE 'UNSUCCESSFUL DELETE'                       03060000
030700                                     TO AA-DB2-OPERATION          03070000
030800                 MOVE 'TTRBNTF'      TO AA-DB2-TABLE              03080000
030900                 PERFORM Z999-DB2-ABEND                           03090000
031000         END-EVALUATE                                             03100000
031100     END-PERFORM.                                                 03110000
031200                                                                  03120000
031300     IF PC-RETRY-COUNT > PC-RETRY-MAX                             03130000
031400         MOVE PV-CURRENT-PARAGRAPH                                03140000
031500                             TO AA-PARAGRAPH-NAME                 03150000
031510         DISPLAY '******** NOTIFY NBR:'                           03151004
031520                          PV-NOTIFY-NBR                           03152005
032200         MOVE SPACES TO AA-MESSAGE-1                              03220000
032300                        AA-MESSAGE-2                              03230000
032400         MOVE 'MAX RETRIES EXCEEDED ON DELETE'                    03240000
032500                             TO AA-DB2-OPERATION                  03250000
032600         MOVE 'TTRBNTF'      TO AA-DB2-TABLE                      03260000
032700         PERFORM Z999-DB2-ABEND                                   03270000
032800     END-IF.                                                      03280000
032900                                                                  03290000
033000     EJECT                                                        03300000
033100 R100-READ-EXTRACT-FILE.                                          03310000
033200                                                                  03320000
033300     READ TTRBNTF-EXTRACT-FILE                                    03330000
033400          INTO AH006-TTRBNTF                                      03340002
033500          AT END SET END-OF-EXTRACT TO TRUE.                      03350000
033600                                                                  03360000
033700     IF MORE-EXTRACT                                              03370000
033800         ADD 1 TO PV-TTRBNTF-INPUT-COUNT                          03380000
033900     END-IF.                                                      03390000
034000                                                                  03400000
034100                                                                  03410000
034200     EJECT                                                        03420000
034300*----------------------------------------------------------------*03430000
034400*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03440000
034500*----------------------------------------------------------------*03450000
034600 X100-CHECKPOINT-CHECK.                                           03460000
034700                                                                  03470000
034800     MOVE 'X100-CHECKPOINT-CHECK' TO PV-CURRENT-PARAGRAPH.        03480000
034900                                                                  03490000
035000     EXEC SQL                                                     03500000
035100       SET :WS-TMST = CURRENT TIMESTAMP                           03510000
035200     END-EXEC.                                                    03520000
035300                                                                  03530000
035400     IF SQLCODE = +0                                              03540000
035500         CONTINUE                                                 03550000
035600     ELSE                                                         03560000
035700         MOVE PV-CURRENT-PARAGRAPH                                03570000
035800                             TO AA-PARAGRAPH-NAME                 03580000
035900         MOVE SPACES TO AA-MESSAGE-1                              03590000
036000                        AA-MESSAGE-2                              03600000
036100         MOVE 'BAD SET COMMAND'                                   03610000
036200                             TO AA-DB2-OPERATION                  03620000
036300         MOVE SPACES             TO AA-DB2-TABLE                  03630000
036400         PERFORM Z999-DB2-ABEND                                   03640000
036500     END-IF.                                                      03650000
036600                                                                  03660000
036700     IF WS-TMST > WS-HOLD-TMST                                    03670000
036800         IF NO-COMMITS-TAKEN                                      03680000
036900             MOVE PC-IN-PROCESS-CODE TO PV-CKPT-STAT-CODE         03690000
037000             PERFORM X600-UPDATE-TCKRSTCNTL                       03700000
037100             SET COMMITS-TAKEN TO TRUE                            03710000
037200         END-IF                                                   03720000
037300         PERFORM X700-UPDATE-TCKRSTINF                            03730000
037400         PERFORM Y100-COMMIT                                      03740000
037500         PERFORM X500-SET-CHECKPOINT-TIME                         03750000
037600     END-IF.                                                      03760000
037700                                                                  03770000
037800 EJECT                                                            03780000
037900*----------------------------------------------------------------*03790000
038000*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03800000
038100*----------------------------------------------------------------*03810000
038200 X200-CHECKPOINT-RESTART.                                         03820000
038300                                                                  03830000
038400     MOVE 'X200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.      03840000
038500                                                                  03850000
038600     PERFORM X400-GET-CHECKPOINT-INFO.                            03860000
038700     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     03870000
038800                                                                  03880000
038900     DISPLAY '** AHKUP069 CHECKPOINT RESTART **'                  03890000
039000     DISPLAY '** EXTRACT RECS BYPASSED ON RESTART = '             03900000
039100              CR-EXTRACT-RECS-WORKED.                             03910000
039200     DISPLAY '***********************************************'    03920000
039300                                                                  03930000
039400     PERFORM R100-READ-EXTRACT-FILE                               03940000
039500         CR-EXTRACT-RECS-WORKED TIMES.                            03950000
039600     PERFORM R100-READ-EXTRACT-FILE.                              03960000
039700 EJECT                                                            03970000
039800*----------------------------------------------------------------*03980000
039900*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *03990000
040000*----------------------------------------------------------------*04000000
040100 X300-GET-CHECKPOINT-CNTL.                                        04010000
040200                                                                  04020000
040300     MOVE 'X300-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     04030000
040400                                                                  04040000
040500     PERFORM WITH TEST AFTER                                      04050000
040600             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04060000
040700             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04070000
040800                     SQLCODE = ZERO                               04080000
040900                                                                  04090000
041000             EXEC SQL                                             04100000
041100              SELECT CKPT_STAT_CODE                               04110000
041200               INTO :PV-CKPT-STAT-CODE                            04120000
041300               FROM TCKRSTCNTL                                    04130000
041400               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04140000
041500             END-EXEC                                             04150000
041600                                                                  04160000
041700             EVALUATE TRUE                                        04170000
041800                 WHEN SQLCODE = ZERO                              04180000
041900                 WHEN SQLCODE = -904                              04190000
042000                 WHEN SQLCODE = -913                              04200000
042100                      CONTINUE                                    04210000
042200                                                                  04220000
042300                 WHEN SQLWARN0 NOT = SPACES                       04230000
042400                 WHEN SQLCODE  NOT = ZERO                         04240000
042500                     MOVE PV-CURRENT-PARAGRAPH                    04250000
042600                                         TO AA-PARAGRAPH-NAME     04260000
042700                     DISPLAY '******** PLAN_NAME:'                04270000
042800                              PV-PROGRAM-NAME                     04280000
042900                     MOVE SPACES TO AA-MESSAGE-1                  04290000
043000                                    AA-MESSAGE-2                  04300000
043100                     MOVE 'UNSUCCESSFUL SELECT'                   04310000
043200                                         TO AA-DB2-OPERATION      04320000
043300                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          04330000
043400                     PERFORM Z999-DB2-ABEND                       04340000
043500             END-EVALUATE                                         04350000
043600     END-PERFORM.                                                 04360000
043700                                                                  04370000
043800     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04380000
043900         MOVE PV-CURRENT-PARAGRAPH                                04390000
044000                             TO AA-PARAGRAPH-NAME                 04400000
044100         DISPLAY '******** PLAN_NAME:'                            04410000
044200                  PV-PROGRAM-NAME                                 04420000
044300         MOVE SPACES TO AA-MESSAGE-1                              04430000
044400                        AA-MESSAGE-2                              04440000
044500         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    04450000
044600                             TO AA-DB2-OPERATION                  04460000
044700         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      04470000
044800         PERFORM Z999-DB2-ABEND                                   04480000
044900     END-IF.                                                      04490000
045000                                                                  04500000
045100 EJECT                                                            04510000
045200*----------------------------------------------------------------*04520000
045300*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *04530000
045400*----------------------------------------------------------------*04540000
045500 X400-GET-CHECKPOINT-INFO.                                        04550000
045600                                                                  04560000
045700     MOVE 'X400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     04570000
045800                                                                  04580000
045900     PERFORM WITH TEST AFTER                                      04590000
046000             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04600000
046100             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04610000
046200                     SQLCODE = ZERO                               04620000
046300                                                                  04630000
046400             EXEC SQL                                             04640000
046500              SELECT WORK_STRG_DESC                               04650000
046600               INTO :TCKRSTINF-WORK-STRG-DESC                     04660000
046700               FROM TCKRSTINF                                     04670000
046800               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04680000
046900             END-EXEC                                             04690000
047000                                                                  04700000
047100             EVALUATE TRUE                                        04710000
047200                 WHEN SQLCODE = ZERO                              04720000
047300                 WHEN SQLCODE = -904                              04730000
047400                 WHEN SQLCODE = -913                              04740000
047500                      CONTINUE                                    04750000
047600                                                                  04760000
047700                 WHEN SQLWARN0 NOT = SPACES                       04770000
047800                 WHEN SQLCODE  NOT = ZERO                         04780000
047900                     MOVE PV-CURRENT-PARAGRAPH                    04790000
048000                                         TO AA-PARAGRAPH-NAME     04800000
048100                     DISPLAY '******** PLAN_NAME:'                04810000
048200                              PV-PROGRAM-NAME                     04820000
048300                     MOVE SPACES TO AA-MESSAGE-1                  04830000
048400                                    AA-MESSAGE-2                  04840000
048500                     MOVE 'UNSUCCESSFUL SELECT'                   04850000
048600                                         TO AA-DB2-OPERATION      04860000
048700                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          04870000
048800                     PERFORM Z999-DB2-ABEND                       04880000
048900             END-EVALUATE                                         04890000
049000     END-PERFORM.                                                 04900000
049100                                                                  04910000
049200     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04920000
049300         MOVE PV-CURRENT-PARAGRAPH                                04930000
049400                             TO AA-PARAGRAPH-NAME                 04940000
049500         DISPLAY '******** PLAN_NAME:'                            04950000
049600                  PV-PROGRAM-NAME                                 04960000
049700         MOVE SPACES TO AA-MESSAGE-1                              04970000
049800                        AA-MESSAGE-2                              04980000
049900         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    04990000
050000                             TO AA-DB2-OPERATION                  05000000
050100         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      05010000
050200         PERFORM Z999-DB2-ABEND                                   05020000
050300     END-IF.                                                      05030000
050400                                                                  05040000
050500 EJECT                                                            05050000
050600*----------------------------------------------------------------*05060000
050700*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *05070000
050800*----------------------------------------------------------------*05080000
050900 X500-SET-CHECKPOINT-TIME.                                        05090000
051000                                                                  05100000
051100     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-CURRENT-PARAGRAPH.     05110000
051200                                                                  05120000
051300     PERFORM WITH TEST AFTER                                      05130000
051400             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05140000
051500             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05150000
051600                     SQLCODE = ZERO                               05160000
051700                                                                  05170000
051800             EXEC SQL                                             05180000
051900              SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)05190000
052000               INTO :WS-HOLD-TMST                                 05200000
052100               FROM TCKRSTCNTL                                    05210000
052200               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05220000
052300             END-EXEC                                             05230000
052400                                                                  05240000
052500             EVALUATE TRUE                                        05250000
052600                 WHEN SQLCODE = ZERO                              05260000
052700                 WHEN SQLCODE = -904                              05270000
052800                 WHEN SQLCODE = -913                              05280000
052900                      CONTINUE                                    05290000
053000                                                                  05300000
053100                 WHEN SQLWARN0 NOT = SPACES                       05310000
053200                 WHEN SQLCODE  NOT = ZERO                         05320000
053300                     MOVE PV-CURRENT-PARAGRAPH                    05330000
053400                                         TO AA-PARAGRAPH-NAME     05340000
053500                     DISPLAY '******** PLAN_NAME:'                05350000
053600                              PV-PROGRAM-NAME                     05360000
053700                     MOVE SPACES TO AA-MESSAGE-1                  05370000
053800                                    AA-MESSAGE-2                  05380000
053900                     MOVE 'UNSUCCESSFUL SELECT'                   05390000
054000                                         TO AA-DB2-OPERATION      05400000
054100                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05410000
054200                     PERFORM Z999-DB2-ABEND                       05420000
054300             END-EVALUATE                                         05430000
054400     END-PERFORM.                                                 05440000
054500                                                                  05450000
054600     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05460000
054700         MOVE PV-CURRENT-PARAGRAPH                                05470000
054800                             TO AA-PARAGRAPH-NAME                 05480000
054900         DISPLAY '******** PLAN_NAME:'                            05490000
055000                  PV-PROGRAM-NAME                                 05500000
055100         MOVE SPACES TO AA-MESSAGE-1                              05510000
055200                        AA-MESSAGE-2                              05520000
055300         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05530000
055400                             TO AA-DB2-OPERATION                  05540000
055500         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05550000
055600         PERFORM Z999-DB2-ABEND                                   05560000
055700     END-IF.                                                      05570000
055800                                                                  05580000
055900 EJECT                                                            05590000
056000*----------------------------------------------------------------*05600000
056100*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *05610000
056200*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *05620000
056300*----------------------------------------------------------------*05630000
056400 X600-UPDATE-TCKRSTCNTL.                                          05640000
056500                                                                  05650000
056600     MOVE 'X600-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       05660000
056700                                                                  05670000
056800     PERFORM WITH TEST AFTER                                      05680000
056900             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05690000
057000             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05700000
057100                     SQLCODE = ZERO                               05710000
057200                                                                  05720000
057300             EXEC SQL                                             05730000
057400                 UPDATE TCKRSTCNTL                                05740000
057500                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          05750000
057600                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          05760000
057700             END-EXEC                                             05770000
057800                                                                  05780000
057900             EVALUATE TRUE                                        05790000
058000                 WHEN SQLCODE = ZERO                              05800000
058100                 WHEN SQLCODE = -904                              05810000
058200                 WHEN SQLCODE = -913                              05820000
058300                      CONTINUE                                    05830000
058400                                                                  05840000
058500                 WHEN SQLWARN0 NOT = SPACES                       05850000
058600                 WHEN SQLCODE  NOT = ZERO                         05860000
058700                     MOVE PV-CURRENT-PARAGRAPH                    05870000
058800                                         TO AA-PARAGRAPH-NAME     05880000
058900                     DISPLAY '******** PLAN_NAME:'                05890000
059000                              PV-PROGRAM-NAME                     05900000
059100                     MOVE SPACES TO AA-MESSAGE-1                  05910000
059200                                    AA-MESSAGE-2                  05920000
059300                     MOVE 'UNSUCCESSFUL UPDATE'                   05930000
059400                                         TO AA-DB2-OPERATION      05940000
059500                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05950000
059600                     PERFORM Z999-DB2-ABEND                       05960000
059700             END-EVALUATE                                         05970000
059800     END-PERFORM.                                                 05980000
059900                                                                  05990000
060000     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06000000
060100         MOVE PV-CURRENT-PARAGRAPH                                06010000
060200                             TO AA-PARAGRAPH-NAME                 06020000
060300         DISPLAY '******** PLAN_NAME:'                            06030000
060400                  PV-PROGRAM-NAME                                 06040000
060500         MOVE SPACES TO AA-MESSAGE-1                              06050000
060600                        AA-MESSAGE-2                              06060000
060700         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06070000
060800                             TO AA-DB2-OPERATION                  06080000
060900         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06090000
061000         PERFORM Z999-DB2-ABEND                                   06100000
061100     END-IF.                                                      06110000
061200                                                                  06120000
061300     EJECT                                                        06130000
061400*----------------------------------------------------------------*06140000
061500*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *06150000
061600*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *06160000
061700*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *06170000
061800*----------------------------------------------------------------*06180000
061900 X700-UPDATE-TCKRSTINF.                                           06190000
062000                                                                  06200000
062100     MOVE 'X700-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        06210000
062200                                                                  06220000
062300     MOVE PV-TTRBNTF-INPUT-COUNT TO CR-EXTRACT-RECS-WORKED.       06230000
062400     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   06240000
062500     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    06250000
062600                                                                  06260000
062700     PERFORM WITH TEST AFTER                                      06270000
062800             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06280000
062900             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06290000
063000                     SQLCODE = ZERO                               06300000
063100                                                                  06310000
063200             EXEC SQL                                             06320000
063300                 UPDATE TCKRSTINF                                 06330000
063400                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 06340000
063500                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06350000
063600             END-EXEC                                             06360000
063700                                                                  06370000
063800             EVALUATE TRUE                                        06380000
063900                 WHEN SQLCODE = ZERO                              06390000
064000                 WHEN SQLCODE = -904                              06400000
064100                 WHEN SQLCODE = -913                              06410000
064200                      CONTINUE                                    06420000
064300                                                                  06430000
064400                 WHEN SQLWARN0 NOT = SPACES                       06440000
064500                 WHEN SQLCODE  NOT = ZERO                         06450000
064600                     MOVE PV-CURRENT-PARAGRAPH                    06460000
064700                                         TO AA-PARAGRAPH-NAME     06470000
064800                     DISPLAY '******** PLAN_NAME:'                06480000
064900                              PV-PROGRAM-NAME                     06490000
065000                     MOVE SPACES TO AA-MESSAGE-1                  06500000
065100                                    AA-MESSAGE-2                  06510000
065200                     MOVE 'UNSUCCESSFUL UPDATE'                   06520000
065300                                         TO AA-DB2-OPERATION      06530000
065400                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          06540000
065500                     PERFORM Z999-DB2-ABEND                       06550000
065600             END-EVALUATE                                         06560000
065700     END-PERFORM.                                                 06570000
065800                                                                  06580000
065900     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06590000
066000         MOVE PV-CURRENT-PARAGRAPH                                06600000
066100                             TO AA-PARAGRAPH-NAME                 06610000
066200         DISPLAY '******** PLAN_NAME:'                            06620000
066300                  PV-PROGRAM-NAME                                 06630000
066400         MOVE SPACES TO AA-MESSAGE-1                              06640000
066500                        AA-MESSAGE-2                              06650000
066600         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06660000
066700                             TO AA-DB2-OPERATION                  06670000
066800         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      06680000
066900         PERFORM Z999-DB2-ABEND                                   06690000
067000     END-IF.                                                      06700000
067100                                                                  06710000
067200 EJECT                                                            06720000
067300                                                                  06730000
067400*----------------------------------------------------------------*06740000
067500*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *06750000
067600*----------------------------------------------------------------*06760000
067700 Y100-COMMIT.                                                     06770000
067800                                                                  06780000
067900     MOVE 'Y100-COMMIT'    TO PV-CURRENT-PARAGRAPH.               06790000
068000                                                                  06800000
068100     EXEC SQL                                                     06810000
068200         COMMIT                                                   06820000
068300     END-EXEC.                                                    06830000
068400                                                                  06840000
068500     EVALUATE TRUE                                                06850000
068600         WHEN SQLCODE = ZEROS                                     06860000
068700             CONTINUE                                             06870000
068800         WHEN OTHER                                               06880000
068900             MOVE PV-CURRENT-PARAGRAPH                            06890000
069000                                 TO AA-PARAGRAPH-NAME             06900000
069100             MOVE SPACES TO AA-MESSAGE-1                          06910000
069200                            AA-MESSAGE-2                          06920000
069300             MOVE 'UNSUCCESSFUL COMMIT'                           06930000
069400                                 TO AA-DB2-OPERATION              06940000
069500             MOVE SPACES         TO AA-DB2-TABLE                  06950000
069600             PERFORM Z999-DB2-ABEND                               06960000
069700     END-EVALUATE.                                                06970000
069800 EJECT                                                            06980000
069900 Z900-PROCESS-ABEND.                                              06990000
070000                                                                  07000000
070100     DISPLAY '*** ABEND'.                                         07010000
070200     DISPLAY '*** PROGRAM   = AHKUP069'.                          07020000
070300     DISPLAY '*** PARAGRAPH = ' PV-CURRENT-PARAGRAPH.             07030000
070400     DISPLAY AA-MESSAGE-LINE-1.                                   07040000
070500     DISPLAY AA-MESSAGE-LINE-2.                                   07050000
070600     COPY DPPD004.                                                07060000
070700     CALL 'ILBOABN0' USING ABEND-CODE.                            07070000
070800                                                                  07080000
070900                                                                  07090000
071000                                                                  07100000
071100 Z999-DB2-ABEND.                                                  07110000
071200                                                                  07120000
071300     DISPLAY AA-ABEND-LIT.                                        07130000
071400     DISPLAY AA-DB2-ERROR-LIT.                                    07140000
071500     DISPLAY AA-PROGRAM-LIT.                                      07150000
071600     DISPLAY AA-PARAGRAPH-LIT.                                    07160000
071700     DISPLAY AA-DB2-OPERATION-LIT.                                07170000
071800     DISPLAY AA-DB2-TABLE.                                        07180000
071900     SET AC-DB2-ERROR TO TRUE.                                    07190000
072000                                                                  07200000
072100     COPY DPPD004.                                                07210000
072200                                                                  07220000
072300     CALL 'ILBOABN0' USING ABEND-CODE.                            07230000
