000100*-----------------------*                                         00010002
000200 IDENTIFICATION DIVISION.                                         00020002
000300*-----------------------*                                         00030002
000400                                                                  00040002
000500 PROGRAM-ID.    APKCS322.                                         00050002
000600 AUTHOR.        DOUG NOLTNER.                                     00060002
000700 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00070002
000800 DATE-WRITTEN.  06/94.                                            00080002
000900 DATE-COMPILED.                                                   00090002
001000*----------------------------------------------------------------*00100002
001100*    A322 - AP - ALLOWANCE/CHARGE MAINTENENCE                    *00110002
001200*                                                                *00120002
001300*    THIS PROGRAM ALLOWS THE USER TO ADD, UPDATE, OR DELETE      *00130002
001400*    ALLOWANCES OR CHARGES FOR AN INVOICE.                       *00140002
001500*----------------------------------------------------------------*00150099
001600*----------------------------------------------------------------*00160002
001700*                                                                *00170002
001800* CHANGE LOG:                                                    *00180002
001900*                                                                *00190002
002000* 10/19/94    BMW  ATTEMPT TO FIX 'OB' PROBLEM AND NOT ALLOW      00200091
002100*                  UPDATES IF RI INVOICE.                         00210091
002200*                                                                 00220091
002300* 03/15/95  P.KEBER  CHANGED NEXT-ACT-RETURN AND CLEAR LOGIC TO   00230091
002400*                    REBUILD THE SCREEN FROM THE COMMAREA.        00240091
002500*                                                                 00250091
002600* 05/11/95  P.KEBER  ADDED AN EDIT CHECK TO ONLY ALLOW A CHARGE   00260091
002700*                    AMOUNT (NOT A CHARGE PERCENT) FOR A FREIGHT  00270091
002800*                    CHARGE UPDATE.                               00280091
002900*                                                                 00290091
003000* 11/16/95      - IN 4400-MOVE-COMMAREA-TO-SCREEN, CHANGED TO     00300091
003100* MARY KING       CHECK FOR A STATUS OF 'PD' INSTEAD OF 'PY'.     00310091
003200*                                                                 00320091
003300* 01/14/97  PDVOLK   ADDED TOTAL FIELDS TO THE HEADER AREAS TO    00330091
003400*                    DISPLAY THE TOTAL ALLW AND TOTAL CHARGES.    00340091
003500*                                                                 00350091
003600* 03/21/97  M WILKINSON                                           00360091
003700*                    ADDED LOGIC TO PROCESS 'WO' INVOICES.  THE   00370091
003800*                    WRITE-OFF INVOICES CANNOT HAVE ALLOW/CHRGS   00380091
003900*                    ADDED.                                       00390091
004000*  8/25/97  C KUNSTMANN                                           00400091
004100*    WR4164          ADDED LOGIC TO PROCESS EXPENSE INVOICES.     00410091
004200*                    EXPENSE INVOICES MUST HAVE CHRGS ADDED TO    00420091
004300*                    ACCOUNT FOR THE NET INVOICE AMOUNT.          00430091
004400*                    ACCUMULATE ALLOWANCES ENTERED AS AMOUNTS     00440091
004500*                    TO BE SUBTRACTED FROM THE MDSE COST. THIS    00450091
004600*                    WILL CALCULATE THE CORRECT NET INOICE AMT.   00460091
004700*                    REMOVED EDITS FOR GROSS & NET COST AMT.      00470091
004800*                    ADDED TEXTENT TBL FOR THE REMIT TO VENDOR    00480091
004900*                    NAME. CHANGES IN 1150- & 4001- PARAGRAPH.    00490091
005000*                                                                 00500091
005100*  9/25/97  M BESKE  ADDED LOGIC TO UPDATE THE ENTR_DTE ON        00510091
005200*                    TPAYREQ ONLY FOR EXPENSE INVOICES WHENEVER   00520091
005300*                    THE STATUS_CDE CHANGES FROM 'IB' OR OB' TO   00530091
005400*                    'EN'.  THE DATE TO BE USED FOR UPDATING      00540091
005500*                    WILL BE THE CURRENT DATE (8000- PARA CHGD,   00550091
005600*                    5700- PARA ADDED).                           00560091
005700*                                                                 00570091
005800*  9/20/01  M BESKE  ADDED A NEW LITERAL DESCRIPTION OF THE       00580091
005900*    WR: 20530       INVOICE STATUS.  THE LITERAL 'PR' AND THE    00590091
006000*                    DESCRIPTION IS 'PENDING RVW'.  MOD PARA 4400 00600091
006100*                                                                 00610094
006200*  5/17/02  M BESKE  AS PART OF THE ARK PO PH.I: REPLACED PAYT_REQ00620094
006300*    WR: 23500       _SEQ_NBR AS THE KEY IN SQL WITH PO_NBR AND   00630094
006400*                    INVC_ID.  ALSO ADDED UPDATE OF CRE_DTE IN    00640094
006500*                    PARA 5700-.                                  00650094
006600*                                                                 00660095
006700*  8/05/02 K CATLIN  COLBY HANGER EXPENSE PROCESSING.  RECOMPILE  00670097
006800*    WR: 23254       FROM PRODUCTION TO INCORPORATE COPYBOOK      00680096
006900*                    CHANGES.                                     00690095
007000*                                                                 00700098
007100*  8/22/02 K CATLIN  REPLACE PAYT_REQ_SEQ_NBR WITH PO_NBR AND     00710098
007200*    WR: 23500       INVC_ID IN REFERENCES TO TABLE TALCHRG.      00720098
007300*                    PARAGRAPHS MODIFIED ARE 5200, 5210, 5300,    00730098
007400*                    5600, AND 6200.                              00740098
007500*                                                                 00750099
007600*  11/04/02 M BESKE COLBY DATING PROJECT                          00760099
007700*                    MODIFIED THE SQL IN 3055- TO STANDARD EXIST- 00770099
007800*    WR: 23750       ENCE CHECKING.  ADDED NEW STATUS OF 'PJ' TO  00780099
007900*                    THE LIST OF STATUS DESCRIPTIONS AND ADDED IT 00790099
008000*                    TO THE CODE THAT DOES NOT ALLOW UPDATES TO BE00800099
008100*                    DONE TO INVOICES WITH THIS STATUS.           00810099
008200*                                                                 00820099
008300* DATE  07/22/2003                                                00830099
008400*     CHANGE MADE: COMPOUND PREPACK EDI PROJECT                   00840099
008500*     RECOMPILED TO PICK UP CHANGED COPYBOOK(S).                  00850099
008600*     MADE BY: MIKE BESKE              WR/IR #: WR24685           00860099
008700*                                                                 00870099
008800*   DATE  03/11/2007                                              00880099
008900*       CHANGE MADE: MATCH BY DC PROJECT                          00890099
009000*       REMOVED ALL LOGIC RELATED TO TAUDINC TABLE.               00900099
009100*       DELETE PARA 5600-.                                        00910099
009200*       REMOVED ALL LOGIC RELATED TO TPAYREQ TABLE.               00920099
009300*       MOD PARA 5700-.                                           00930099
009400*       MADE BY: MIKE BESKE              WR/IR #: WR21578         00940099
009401*                                                                 00940199
009402*   DATE  07/20/2016                                              00940299
009410*       THE LENGTH OF THE PO NUMBER IN MAP APKM321 WAS SET TO 7   00941099
009420*       INSTEAD OF 9. THE PO NUMBER WAS GETTING TRUNCATED ON THE  00942099
009430*       SCREEN BECAUSE OF THIS, SO THE MAP WAS CHANGED AND THE    00943099
009440*       PROGRAM WAS RECOMPILED FOR THE SAME.                      00944099
009460*       BY:  SRINATH(COGNIZANT)             WR #: CHG0146972      00946099
009461*   DATE  09/01/2021                                              00946199
009480*            - CHANGE CALL OF DPKUT100 TO                         00948099
009490*              CALL DP010I-NUMERIC-EDIT-ROUTINE                   00949099
009491*              MAKING THE CALL DYNAMIC VS STATIC                  00949199
009492*       BY:  GERMAN BANDA                   WR #: CHG0261053      00949299
009493*   DATE  10/21/2022                                              00949399
009494*            - ADD COPYBOOK DPWS930                               00949499
009495*              CHANGE CICS ARCHITECTURE CALL TO USE               00949599
009496*              DP930-CICS-ARCH-API                                00949699
009497*       BY:  BOB MCASEY                     WR #: CHG0276864      00949799
009500*----------------------------------------------------------------*00950002
009600                                                                  00960091
009700*--------------------*                                            00970002
009800 ENVIRONMENT DIVISION.                                            00980002
009900*--------------------*                                            00990002
010000                                                                  01000002
010100*-------------*                                                   01010002
010200 DATA DIVISION.                                                   01020002
010300*-------------*                                                   01030002
010400                                                                  01040002
010500 WORKING-STORAGE SECTION.                                         01050002
010600                                                                  01060002
010700 01  PC-PROGRAM-CONSTANTS.                                        01070002
010800     05  PC-CURRENT-PROGRAM-NAME  PIC  X(08)  VALUE  'APKCS322'.  01080002
010900     05  PC-CURRENT-MAP-NAME      PIC  X(08)  VALUE  'AP322A  '.  01090002
011000     05  PC-CURRENT-MAPSET-NAME   PIC  X(08)  VALUE  'APKM322 '.  01100002
011100     05  PC-MAX-RETRIES           PIC S9(04)  VALUE  +3           01110002
011200                                              COMP.               01120002
011300     05  PC-MAX-ALLW-CHRG-LINES   PIC S9(04)  VALUE  +14          01130002
011400                                              COMP.               01140002
011500     05  PC-TSYMSG-NUMBERS.                                       01150002
011600         10  PC-TSYMSG-00004      PIC  9(05)  VALUE  00004.       01160002
011700         10  PC-TSYMSG-00005      PIC  9(05)  VALUE  00005.       01170002
011800         10  PC-TSYMSG-00007      PIC  9(05)  VALUE  00007.       01180002
011900         10  PC-TSYMSG-00008      PIC  9(05)  VALUE  00008.       01190002
012000         10  PC-TSYMSG-00057      PIC  9(05)  VALUE  00057.       01200002
012100         10  PC-TSYMSG-00059      PIC  9(05)  VALUE  00059.       01210002
012200         10  PC-TSYMSG-00115      PIC  9(05)  VALUE  00115.       01220002
012300         10  PC-TSYMSG-00118      PIC  9(05)  VALUE  00118.       01230002
012400         10  PC-TSYMSG-00170      PIC  9(05)  VALUE  00170.       01240002
012500         10  PC-TSYMSG-00342      PIC  9(05)  VALUE  00342.       01250002
012600         10  PC-TSYMSG-00430      PIC  9(05)  VALUE  00430.       01260002
012700         10  PC-TSYMSG-00850      PIC  9(05)  VALUE  00850.       01270002
012800         10  PC-TSYMSG-00851      PIC  9(05)  VALUE  00851.       01280002
012900         10  PC-TSYMSG-00852      PIC  9(05)  VALUE  00852.       01290002
013000         10  PC-TSYMSG-00855      PIC  9(05)  VALUE  00855.       01300002
013100         10  PC-TSYMSG-00862      PIC  9(05)  VALUE  00862.       01310002
013200         10  PC-TSYMSG-00931      PIC  9(05)  VALUE  00931.       01320002
013300         10  PC-TSYMSG-00961      PIC  9(05)  VALUE  00961.       01330002
013400         10  PC-TSYMSG-00970      PIC  9(05)  VALUE  00970.       01340002
013500         10  PC-TSYMSG-01012      PIC  9(05)  VALUE  01012.       01350002
013600         10  PC-TSYMSG-01122      PIC  9(05)  VALUE  01122.       01360091
013700         10  PC-TSYMSG-01517      PIC  9(05)  VALUE  01517.       01370002
013800         10  PC-TSYMSG-01592      PIC  9(05)  VALUE  01592.       01380091
013900                                                                  01390002
014000 01  PS-PROGRAM-SWITCHES.                                         01400002
014100     05  PS-ERROR-SW              PIC  X(01)  VALUE  'N'.         01410002
014200         88  PS-ERROR                         VALUE  'Y'.         01420002
014300         88  PS-NO-ERROR                      VALUE  'N'.         01430002
014400     05  PS-END-OF-CSR-SW         PIC  X(01)  VALUE  'N'.         01440002
014500         88  PS-END-OF-CSR                    VALUE  'Y'.         01450002
014600         88  PS-NOT-END-OF-CSR                VALUE  'N'.         01460002
014700     05  PS-AC-AMT-VALID-SW       PIC  X(01)  VALUE  'Y'.         01470002
014800         88  PS-AC-AMT-VALID                  VALUE  'Y'.         01480002
014900         88  PS-AC-AMT-INVALID                VALUE  'N'.         01490002
015000     05  PS-AC-PCT-VALID-SW       PIC  X(01)  VALUE  'Y'.         01500002
015100         88  PS-AC-PCT-VALID                  VALUE  'Y'.         01510002
015200         88  PS-AC-PCT-INVALID                VALUE  'N'.         01520002
015300     05  PS-INVOICE-UPDATED-SW    PIC  X(01)  VALUE  'Y'.         01530002
015400         88  INVOICE-UPDATED                  VALUE  'Y'.         01540002
015500         88  INVOICE-NOT-UPDATED              VALUE  'N'.         01550002
015600     05  EI-CHARGE-CODE-VALID-SW  PIC  X(01)  VALUE  'Y'.         01560091
015700         88  EI-CHARGE-CODE-VALID             VALUE  'Y'.         01570091
015800         88  EI-CHARGE-CODE-INVALID           VALUE  'N'.         01580091
015900                                                                  01590002
016000 01  PV-PROGRAM-VARIABLES.                                        01600002
016100     05  PV-ONE                   PIC X      VALUE SPACES.        01610099
016200     05  PV-DB2-COUNT             PIC S9(04)  COMP VALUE ZERO.    01620002
016300     05  PV-CICS-RESPONSE         PIC S9(04)  VALUE +0            01630002
016400                                              COMP SYNC.          01640002
016500     05  PV-RETRY-COUNTER         PIC S9(04)  VALUE +0            01650002
016600                                              COMP SYNC.          01660002
016700     05  PV-SUB                   PIC S9(04)  VALUE +0            01670002
016800                                              COMP SYNC.          01680002
016900     05  PV-PO-NBR-LOW            PIC S9(09)  VALUE +0            01690002
017000                                              COMP SYNC.          01700002
017100     05  PV-PO-NBR-HIGH           PIC S9(09)  VALUE +0            01710002
017200                                              COMP SYNC.          01720002
017300     05  PV-TOTAL-PIECES          PIC S9(8)   VALUE +0            01730002
017400                                              COMP SYNC.          01740002
017500     05  PV-PER-UNIT-COST         PIC S9(10)V9(3)                 01750002
017600                                              COMP-3.             01760002
017700     05  PV-CHRG-AMT              PIC  9(08)V99.                  01770002
017800     05  PV-TOT-ALLW-AMT          PIC S9(11)V99 COMP-3.           01780091
017900     05  PV-AMT-DIS               PIC ZZZZZZZ9.99.                01790002
018000     05  PV-PCT-DIS               PIC Z9.99.                      01800002
018100     05  PV-8V99                  PIC Z(8).99.                    01810002
018200     05  PV-8V99-X REDEFINES                                      01820002
018300         PV-8V99                  PIC X(11).                      01830002
018400     05  PV-NET-AMT-X.                                            01840091
018500         10  PV-MINUS             PIC X.                          01850002
018600         10  PV-NET-AMT           PIC 9(7).99.                    01860002
018700                                                                  01870002
018800*----------------------------------------------------------------*01880002
018900*    AP CHARGE CODE COPYBOOK.                                    *01890002
019000*----------------------------------------------------------------*01900002
019100     COPY APRD053.                                                01910002
019200                                                                  01920002
019300*----------------------------------------------------------------*01930002
019400*    MAP LAYOUT                                                  *01940002
019500*----------------------------------------------------------------*01950002
019600     COPY APKM322.                                                01960002
019700                                                                  01970002
019800 01  MR-OCCURS-LAYOUT                   REDEFINES  AP322AO.       01980002
019900     05  FILLER                         PIC X(164).               01990099
020000     05  MR-SCROLL-AREA                 OCCURS 14 TIMES.          02000002
020100         10  MR-SELECTL                 PIC S9(04) COMP.          02010002
020200         10  MR-SELECTA                 PIC  X(01).               02020002
020300         10  MR-SELECTC                 PIC  X(01).               02030002
020400         10  MR-SELECTH                 PIC  X(01).               02040002
020500         10  MR-SELECT                  PIC  X(01).               02050002
020600                                                                  02060002
020700         10  MR-AC-INDL                 PIC S9(04) COMP.          02070002
020800         10  MR-AC-INDA                 PIC  X(01).               02080002
020900         10  MR-AC-INDC                 PIC  X(01).               02090002
021000         10  MR-AC-INDH                 PIC  X(01).               02100002
021100         10  MR-AC-IND                  PIC  X(01).               02110002
021200                                                                  02120002
021300         10  MR-AC-CDEL                 PIC S9(04) COMP.          02130002
021400         10  MR-AC-CDEA                 PIC  X(01).               02140002
021500         10  MR-AC-CDEC                 PIC  X(01).               02150002
021600         10  MR-AC-CDEH                 PIC  X(01).               02160002
021700         10  MR-AC-CDE                  PIC  X(03).               02170002
021800                                                                  02180002
021900         10  MR-AC-PCTL                 PIC S9(04) COMP.          02190002
022000         10  MR-AC-PCTA                 PIC  X(01).               02200002
022100         10  MR-AC-PCTC                 PIC  X(01).               02210002
022200         10  MR-AC-PCTH                 PIC  X(01).               02220002
022300         10  MR-AC-PCT                  PIC  X(05).               02230002
022400                                                                  02240002
022500         10  MR-AC-AMTL                 PIC S9(04) COMP.          02250002
022600         10  MR-AC-AMTA                 PIC  X(01).               02260002
022700         10  MR-AC-AMTC                 PIC  X(01).               02270002
022800         10  MR-AC-AMTH                 PIC  X(01).               02280002
022900         10  MR-AC-AMT                  PIC  X(11).               02290002
023000                                                                  02300002
023100         10  MR-SS-CDEL                 PIC S9(04) COMP.          02310002
023200         10  MR-SS-CDEA                 PIC  X(01).               02320002
023300         10  MR-SS-CDEC                 PIC  X(01).               02330002
023400         10  MR-SS-CDEH                 PIC  X(01).               02340002
023500         10  MR-SS-CDE                  PIC  X(10).               02350002
023600                                                                  02360002
023700*----------------------------------------------------------------*02370002
023800*    ATTRIBUTE SETTINGS COPYBOOK.                                *02380002
023900*----------------------------------------------------------------*02390002
024000     COPY DPWS015.                                                02400002
024100                                                                  02410002
024200*----------------------------------------------------------------*02420002
024300*    FUNCTION KEYS COPYBOOK                                      *02430002
024400*----------------------------------------------------------------*02440002
024500     COPY DPWS016.                                                02450002
024600                                                                  02460002
024700**--------------------------------------------------------------**02470002
024800** THE CALLING PARAMETER LIST (DPWS010) FOR THE NUMERIC EDIT    **02480002
024900** SUB-ROUTINE (DPKUT100).                                      **02490002
025000**--------------------------------------------------------------**02500002
025100     COPY DPWS010I.                                               02510002
025200                                                                  02520002
025300**--------------------------------------------------------------**02530002
025400** THE CALLING PARAMETER LIST (DPWS030) FOR THE CICS ARCHITECTURE*02540002
025500** APPLICATION PROGRAMMING INTERFACE MODULE -- DPKCS030.        **02550002
025600**--------------------------------------------------------------**02560002
025700     COPY DPWS030.                                                02570002
025710     COPY DPWS930.                                                02571099
025800                                                                  02580002
025900**--------------------------------------------------------------**02590002
026000*    STANDARD COMMAREA.                                           02600002
026100**--------------------------------------------------------------**02610002
026200     COPY DPWS020.                                                02620002
026300     05  FILLER REDEFINES DP020-VARIABLE-COMMAREA.                02630002
026400                                                                  02640002
026500***************************************************************** 02650002
026600*    INTER-APPLICATION COMMAREA.                                  02660002
026700***************************************************************** 02670002
026800         10  INTER-APPL-COMM-AREA PIC X(200).                     02680002
026900     COPY APWS300.                                                02690002
027000                                                                  02700002
027100***************************************************************** 02710002
027200*    SPECIFIC COMMMAREA FOR POKCS006.                             02720002
027300***************************************************************** 02730002
027400         10  ASC-SPECIFIC-COMMAREA.                               02740002
027500             15  ASC-INT-APPL-FORMAT-IND   PIC X(01).             02750002
027600                 88  ASC-INTER-APPL-ADD          VALUE ' '.       02760002
027700                 88  ASC-INTER-APPL-UPDATE       VALUE '1'.       02770002
027800             15  ASC-UPDATES-ALLOWED-IND   PIC X(01).             02780002
027900                 88  ASC-NO-UPDATES-ALLOWED      VALUE 'N'.       02790002
028000             15  ASC-SAVE-PO-NBR           PIC S9(09) COMP.       02800002
028100             15  ASC-SAVE-INVC-ID          PIC  X(22).            02810002
028200             15  ASC-SAVE-ENTR-MTHD-CDE    PIC  X(02).            02820002
028300             15  ASC-SAVE-INVC-STATUS      PIC  X(02).            02830002
028400             15  ASC-OLD-INVC-STATUS       PIC  X(02).            02840091
028500             15  ASC-SAVE-INVC-TYP-CDE     PIC  X(02).            02850002
028600                 88  ASC-VALID-INVC-TYP  VALUE 'EI', 'MI'.        02860006
028700                 88  ASC-EXPENSE-INVC    VALUE 'EI'.              02870006
028800                                                                  02880006
028900             15  ASC-SAVE-NET-INVC-AMT     PIC S9(11)V99 COMP-3.  02890002
029000             15  ASC-NEW-NET-INVC-AMT      PIC S9(11)V99 COMP-3.  02900002
029100             15  ASC-ALP-NET-INVC-AMT.                            02910002
029200                 20  ASC-ALP-NET-INVC-AMT-NUM  PIC 9(9)V99.       02920002
029300                                                                  02930002
029400             15  ASC-SAVE-GRO-COST-AMT     PIC S9(11)V99 COMP-3.  02940002
029500             15  ASC-NEW-GRO-COST-AMT      PIC S9(11)V99 COMP-3.  02950002
029600             15  ASC-ALP-GRO-COST-AMT.                            02960002
029700                 20  ASC-ALP-GRO-COST-AMT-NUM  PIC 9(9)V99.       02970002
029800             15  ASC-SAVE-CALC-INVC-AMT    PIC S9(11)V99 COMP-3.  02980002
029900             15  ASC-NEW-CALC-INVC-AMT     PIC S9(11)V99 COMP-3.  02990002
030000                                                                  03000002
030100             15  ASC-PAYT-REQ-SEQ-NBR      PIC S9(09)    COMP.    03010002
030200             15  ASC-TOT-CHARGES           PIC S9(11)V99 COMP-3.  03020002
030300             15  ASC-TOT-ALLOWS            PIC S9(11)V99 COMP-3.  03030002
030400             15  ASC-CALC-PREQIT-COST      PIC S9(9)V99           03040002
030500                                                         COMP-3.  03050002
030600             15  ASC-ENT-NAME              PIC  X(10).            03060002
030700             15  ASC-CONFIRM-SW            PIC  X(01).            03070002
030800             15  ASC-CURRENT-TIMESTAMP        PIC  X(26).         03080002
030900             15  ASC-CURRENT-TS-RDF       REDEFINES               03090002
031000                 ASC-CURRENT-TIMESTAMP.                           03100002
031100                 20  ASC-CURRENT-DATE     PIC X(10).              03110002
031200                 20  FILLER               PIC X(01).              03120002
031300                 20  ASC-CURRENT-TIME.                            03130002
031400                     25  ASC-HH           PIC 9(02).              03140002
031500                     25  FILLER           PIC X(01).              03150002
031600                     25  ASC-MIN          PIC 9(02).              03160002
031700                     25  FILLER           PIC X(01).              03170002
031800                     25  ASC-SEC          PIC 9(02).              03180002
031900                     25  FILLER           PIC X(01).              03190002
032000                     25  ASC-MILLI-SEC    PIC 9(06).              03200002
032100             15  ASC-SCREEN-DATA.                                 03210002
032200                 20  FILLER OCCURS 14 TIMES.                      03220002
032300                     25  ASC-SELECT        PIC  X(01).            03230002
032400                     25  ASC-AC-IND        PIC  X(01).            03240002
032500                     25  ASC-AC-CDE        PIC  X(03).            03250002
032600                     25  ASC-AC-PCT        PIC  X(05).            03260002
032700                     25  ASC-AC-PCT-N      PIC  9(02)V99.         03270002
032800                     25  ASC-AC-AMT        PIC  X(11).            03280002
032900                     25  ASC-AC-AMT-N      PIC  9(08)V99.         03290002
033000                     25  ASC-SS-CDE        PIC  X(10).            03300002
033100                     25  ASC-AC-SEQ-NBR    PIC S9(04) COMP.       03310002
033200                                                                  03320002
033300*----------------------------------------------------------------*03330002
033400*    ABEND PROCESSING COPYBOOK.                                  *03340002
033500*----------------------------------------------------------------*03350002
033600     COPY DPWS013.                                                03360002
033700                                                                  03370002
033800*    DB2 AREA FOR TPURCHS (PURCHASE ORDER)                        03380002
033900                                                                  03390002
034000     EXEC SQL                                                     03400002
034100          INCLUDE TPURCHS                                         03410002
034200     END-EXEC.                                                    03420002
034300                                                                  03430002
034400*    DB2 AREA FOR TENTNME (ENTERPRISE NAME)                       03440002
034500                                                                  03450002
034600     EXEC SQL                                                     03460002
034700          INCLUDE TENTNME                                         03470002
034800     END-EXEC.                                                    03480002
034900                                                                  03490091
035000*    DB2 AREA FOR TEXTENT (ENTERPRISE ENTITY)                     03500002
035100                                                                  03510002
035200     EXEC SQL                                                     03520002
035300          INCLUDE TEXTENT                                         03530002
035400     END-EXEC.                                                    03540002
035500                                                                  03550002
035600*    DB2 AREA FOR TINVOIC (INVOICE)                               03560002
035700                                                                  03570002
035800     EXEC SQL                                                     03580002
035900          INCLUDE TINVOIC                                         03590002
036000     END-EXEC.                                                    03600002
036100                                                                  03610002
036200*    DB2 AREA FOR TPREQIT (INVOICE ITEM)                          03620002
036300                                                                  03630002
036400     EXEC SQL                                                     03640002
036500          INCLUDE TPREQIT                                         03650002
036600     END-EXEC.                                                    03660002
036700                                                                  03670002
036800*    DB2 AREA FOR TALCHRG (ALLOWANCE CHARGE)                      03680002
036900                                                                  03690002
037000     EXEC SQL                                                     03700002
037100          INCLUDE TALCHRG                                         03710002
037200     END-EXEC.                                                    03720002
037300                                                                  03730002
037400*    DB2 AREA FOR TACCTYP (ALLOWANCE CHARGE TYPE)                 03740002
037500     EXEC SQL                                                     03750002
037600          INCLUDE TACCTYP                                         03760002
037700     END-EXEC.                                                    03770002
037800                                                                  03780002
037900*    DB2 AREA FOR TAPCNTL (AP CONTROL)                            03790091
038000                                                                  03800002
038100     EXEC SQL                                                     03810002
038200          INCLUDE TAPCNTL                                         03820002
038300     END-EXEC.                                                    03830002
038400                                                                  03840002
038500*    DB2 AREA FOR SYSDUMMY1                                       03850099
038600                                                                  03860099
038700     EXEC SQL                                                     03870099
038800          INCLUDE SYSDUMMY                                        03880099
038900     END-EXEC.                                                    03890099
039000*    DB2 AREA FOR COMMUNICATIONS                                  03900099
039100                                                                  03910002
039200     EXEC SQL                                                     03920002
039300          INCLUDE SQLCA                                           03930002
039400     END-EXEC.                                                    03940002
039500                                                                  03950002
039600*    DB2 CURSOR DEFINE TALCHRG-CSR                                03960002
039700                                                                  03970002
039800     EXEC SQL                                                     03980002
039900          DECLARE AC-CSR CURSOR FOR                               03990002
040000          SELECT ALW_CHRG_SEQ_NBR                                 04000002
040100                ,ALW_CHRG_TYP_CDE                                 04010002
040200                ,ALW_CHRG_CDE                                     04020002
040300                ,ALW_CHRG_SER_CDE                                 04030002
040400                ,ALW_CHRG_PCT                                     04040002
040500                ,ALW_CHRG_AMT                                     04050002
040600          FROM   TALCHRG                                          04060002
040700          WHERE PO_NBR  = :ASC-SAVE-PO-NBR                        04070098
040800            AND INVC_ID = :ASC-SAVE-INVC-ID                       04080098
040900          ORDER BY ALW_CHRG_SEQ_NBR                               04090002
041000     END-EXEC.                                                    04100002
041100                                                                  04110002
041200*    DB2 CURSOR DEFINE TPREQIT-CSR                                04120002
041300                                                                  04130002
041400     EXEC SQL                                                     04140002
041500          DECLARE PREQIT_CSR       CURSOR FOR                     04150002
041600          SELECT   PAY_REQ_LNE_QTY                                04160002
041700                  ,UNT_COST_AMT                                   04170002
041800          FROM     TPREQIT                                        04180002
041900          WHERE    PAYT_REQ_SEQ_NBR = :ASC-PAYT-REQ-SEQ-NBR       04190002
042000     END-EXEC.                                                    04200002
042100                                                                  04210002
042200                                                                  04220002
042300 LINKAGE SECTION.                                                 04230002
042400                                                                  04240002
042500 01  DFHCOMMAREA.                                                 04250002
042600     05  FILLER                         OCCURS  1 TO 4072 TIMES   04260002
042700                                        DEPENDING ON EIBCALEN.    04270002
042800         10  FILLER                     PIC X.                    04280002
042900                                                                  04290002
043000                                                                  04300002
043100*------------------*                                              04310002
043200 PROCEDURE DIVISION.                                              04320002
043300*------------------*                                              04330002
043400***************************************************************** 04340002
043500** THIS MODULE CONTROLS THE OVERALL PROCESSING IN THE PROGRAM. ** 04350002
043600** THE SETUP AND PERFORM OF PARAGRAPH 0001-CALL-CICS-ARCH-API  ** 04360002
043700** MUST BE THE FIRST CODE EXECUTED IN THIS PROGRAM.            ** 04370002
043800**                                                             ** 04380002
043900** THE SECOND OR 'EXIT' PERFORM OF THIS PARAGRAPH MUST BE THE  ** 04390002
044000** LAST CODE EXECUTED ON EACH ITERATION OF THIS PROGRAM.       ** 04400002
044100***************************************************************** 04410002
044200 0000-MAIN-MODULE.                                                04420002
044300                                                                  04430002
044400     INITIALIZE DP030-CICS-API-FIELDS.                            04440002
044500     MOVE +1                       TO DP030-NUMBER-OF-MAPS.       04450002
044600     MOVE PC-CURRENT-MAPSET-NAME   TO DP030-MAPSET-NAME.          04460002
044700     MOVE PC-CURRENT-MAP-NAME      TO DP030-MAP-NAME (1).         04470002
044800     SET DP030-RECEIVE-APPL-MAP    TO TRUE.                       04480002
044900     MOVE LENGTH OF AP322AI        TO DP030-MAP-LENGTH (1).       04490002
045000     MOVE 'PROGRAM ENTRY CALL'     TO DP013-MESSAGE-TEXT (1).     04500002
045100     PERFORM 0001-CALL-CICS-ARCH-API.                             04510002
045200     PERFORM 1000-CONTROL-PROCESSING                              04520002
045300     MOVE 'PROGRAM EXIT CALL'      TO DP013-MESSAGE-TEXT (1).     04530002
045400     PERFORM 0001-CALL-CICS-ARCH-API.                             04540002
045500                                                                  04550002
045600                                                                  04560002
045700 0001-CALL-CICS-ARCH-API.                                         04570002
045800                                                                  04580002
045900     CALL DP930-CICS-ARCH-API USING DFHEIBLK                      04590099
046000                                    DFHCOMMAREA                   04600099
046100                                    DP030-CICS-API-FIELDS         04610099
046200                                    DP020-STANDARD-COMMAREA       04620099
046300                                    AP322AI.                      04630099
046400                                                                  04640002
046500     IF  DP030-RC-CALL-SUCCESSFUL                                 04650002
046600         CONTINUE                                                 04660002
046700     ELSE                                                         04670002
046800         SET DP013-NO-ROLLBACK                                    04680002
046900             DP013-XCTL-DISPLAY-RESTART                           04690002
047000             DP013-CICS-ABEND      TO TRUE                        04700002
047100         MOVE 'BEFORE 0000-MAIN-MODULE'                           04710002
047200                                   TO DP013-PARAGRAPH             04720002
047410         MOVE 'CALL TO CICS ARCH API NOT SUCCESSFUL, RETURN-CODE O04741099
047420-             'N NEXT LINE'        TO DP013-MESSAGE-TEXT (2)      04742099
047500         MOVE DP030-RETURN-CODE    TO DP013-MESSAGE-TEXT (3)      04750002
047600         PERFORM DP013-0000-PROCESS-ABEND                         04760002
047700     END-IF.                                                      04770002
047800                                                                  04780002
047900                                                                  04790002
048000*----------------------------------------------------------------*04800002
048100*    PROCESS THE APPROPRIATE PARAGRAPHS BASED ON WHAT THE NEXT   *04810002
048200*    COURSE OF ACTION IS FOR THIS TRANSACTION.                   *04820002
048300*----------------------------------------------------------------*04830002
048400 1000-CONTROL-PROCESSING.                                         04840002
048500                                                                  04850002
048600     EVALUATE TRUE                                                04860002
048700         WHEN DP020-NEXT-ACT-INITIAL                              04870002
048800             PERFORM 1100-FIND-OBJECT-KEYS                        04880002
048900                                                                  04890002
049000         WHEN DP020-NEXT-ACT-READ-MAP                             04900002
049100             PERFORM 2000-PROCESS-PANEL                           04910002
049200                                                                  04920002
049300         WHEN DP020-NEXT-ACT-RETURN                               04930002
049400             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 04940002
049500             PERFORM 3000-EDIT-DATA-IN-COMMAREA                   04950002
049600             MOVE 'N'              TO ASC-CONFIRM-SW              04960002
049700                                                                  04970002
049800         WHEN OTHER                                               04980002
049900             SET DP013-LOGIC-ABEND                                04990002
050000                 DP013-NO-ROLLBACK TO TRUE                        05000002
050100             MOVE '1000-CONTROL-PROCESSING'                       05010002
050200                                   TO DP013-PARAGRAPH             05020002
050300             MOVE 'INVALID NEXT ACTIVITY RETURNED TO APPL PGM:'   05030002
050400                                   TO DP013-MESSAGE-TEXT(1)       05040002
050500             MOVE DP020-NEXT-APPL-ACTIVITY                        05050002
050600                                   TO DP013-MESSAGE-TEXT(2)       05060002
050700             PERFORM DP013-0000-PROCESS-ABEND                     05070002
050800     END-EVALUATE.                                                05080002
050900                                                                  05090002
051000                                                                  05100002
051100******************************************************************05110002
051200** DETERMINE THE KEY OF THE OBJECT TO BE UPDATED BASED ON THE   **05120002
051300** INTER-APPLICATION FORMAT CODE.                               **05130002
051400******************************************************************05140002
051500 1100-FIND-OBJECT-KEYS.                                           05150002
051600                                                                  05160002
051700     INITIALIZE ASC-SPECIFIC-COMMAREA.                            05170002
051800     MOVE DP020-INT-APPL-FORMAT-IND TO ASC-INT-APPL-FORMAT-IND    05180002
051900     MOVE AP300-INVC-ID            TO ASC-SAVE-INVC-ID.           05190002
052000     IF  AP300-PO-NBR > ZERO                                      05200002
052100         MOVE AP300-PO-NBR         TO PV-PO-NBR-LOW               05210002
052200                                      PV-PO-NBR-HIGH              05220002
052300     ELSE                                                         05230002
052400         MOVE 0                    TO PV-PO-NBR-LOW               05240002
052500         MOVE +999999999           TO PV-PO-NBR-HIGH              05250002
052600     END-IF.                                                      05260002
052700     MOVE AP300-INVC-TYP-CDE       TO ASC-SAVE-INVC-TYP-CDE       05270091
052800     PERFORM 1150-GET-INVOICE.                                    05280002
052900     IF SQLCODE = +0                                              05290002
053000         MOVE INVOIC-STATUS-CDE    TO ASC-SAVE-INVC-STATUS        05300002
053100         MOVE INVOIC-INVC-TYP-CDE  TO ASC-SAVE-INVC-TYP-CDE       05310002
053200         MOVE INVOIC-INVC-NET-COST-AMT                            05320002
053300                                   TO ASC-SAVE-NET-INVC-AMT       05330091
053400         MOVE INVOIC-GRO-COST-AMT  TO ASC-SAVE-GRO-COST-AMT       05340002
053500*KPC     MOVE PAYREQ-PO-NBR        TO ASC-SAVE-PO-NBR             05350098
053600         MOVE INVOIC-PO-NBR        TO ASC-SAVE-PO-NBR             05360098
053700         MOVE INVOIC-PAYT-REQ-SEQ-NBR                             05370099
053800                                   TO ASC-PAYT-REQ-SEQ-NBR        05380002
053900         MOVE SPACE                TO ASC-ENT-NAME                05390002
054000         PERFORM 4000-BUILD-INITIAL-PANEL                         05400091
054100     ELSE                                                         05410002
054200         IF SQLCODE = -811                                        05420002
054300*            --  MULTIPLE INVOICES --                             05430002
054400             MOVE PC-TSYMSG-00852  TO DP020-MSG-NUMBER            05440002
054500             SET DP020-MSG-FATAL                                  05450002
054600                 DP020-NEXT-ACT-APPL-ERROR TO TRUE                05460002
054700         ELSE                                                     05470002
054800*            --  INVOICE NOT FOUND --                             05480002
054900             MOVE PC-TSYMSG-00855  TO DP020-MSG-NUMBER            05490002
055000             SET DP020-MSG-FATAL                                  05500002
055100                 DP020-NEXT-ACT-APPL-ERROR TO TRUE                05510002
055200         END-IF                                                   05520002
055300     END-IF.                                                      05530002
055400                                                                  05540002
055500                                                                  05550002
055600*----------------------------------------------------------------*05560002
055700* VALIDATE THAT THE INVOICE EXISTS                               *05570002
055800*----------------------------------------------------------------*05580002
055900 1150-GET-INVOICE.                                                05590002
056000                                                                  05600002
056100     PERFORM                                                      05610002
056200         WITH TEST AFTER                                          05620002
056300         VARYING PV-RETRY-COUNTER                                 05630002
056400         FROM 1 BY 1                                              05640002
056500         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               05650002
056600                   OR (SQLCODE = ZERO)                            05660002
056700                   OR (SQLCODE = +100)                            05670002
056800                   OR (SQLCODE = -811))                           05680002
056900                                                                  05690002
057000         EXEC SQL                                                 05700002
057100             SELECT PO_NBR                                        05710098
057200                   ,PAYT_REQ_SEQ_NBR                              05720098
057300                   ,RMIT_VND_ID                                   05730098
057400                   ,STATUS_CDE                                    05740098
057500                   ,INVC_TYP_CDE                                  05750098
057600                   ,ENTR_MTHD_CDE                                 05760098
057700                   ,GRO_COST_AMT                                  05770098
057800                   ,INVC_NET_COST_AMT                             05780098
057900             INTO   :INVOIC-PO-NBR                                05790098
058000                   ,:INVOIC-PAYT-REQ-SEQ-NBR                      05800098
058100                   ,:INVOIC-RMIT-VND-ID                           05810098
058200                   ,:INVOIC-STATUS-CDE                            05820002
058300                   ,:INVOIC-INVC-TYP-CDE                          05830002
058400                   ,:INVOIC-ENTR-MTHD-CDE                         05840002
058500                   ,:INVOIC-GRO-COST-AMT                          05850002
058600                   ,:INVOIC-INVC-NET-COST-AMT                     05860002
058700             FROM   TINVOIC                                       05870098
058800             WHERE  INVC_ID      = :ASC-SAVE-INVC-ID              05880098
058900               AND  PO_NBR BETWEEN :PV-PO-NBR-LOW AND             05890098
059000                                   :PV-PO-NBR-HIGH                05900098
059100         END-EXEC                                                 05910002
059200                                                                  05920002
059300         EVALUATE TRUE                                            05930002
059400             WHEN SQLCODE = ZERO                                  05940002
059500             WHEN SQLCODE = -811                                  05950002
059600             WHEN SQLCODE = +100                                  05960002
059700             WHEN SQLCODE = -904                                  05970002
059800             WHEN SQLCODE = -913                                  05980002
059900                 CONTINUE                                         05990002
060000             WHEN SQLWARN0 NOT = SPACES                           06000002
060100             WHEN SQLCODE < ZERO                                  06010002
060200             WHEN SQLCODE > ZERO                                  06020002
060300                 MOVE '1150-GET-INVOICE'                          06030002
060400                                   TO DP013-PARAGRAPH             06040002
060500                 MOVE 'SELECT INVOICE'                            06050002
060600                                   TO DP013-MESSAGE-TEXT (1)      06060002
060700                 MOVE SQLCA        TO DP013-SQLCA                 06070002
060800                 MOVE 'TINVOIC'    TO DP013-DB2-TABLE-NAME (1)    06080002
060900                 MOVE SPACES       TO DP013-DB2-TABLE-NAME (2)    06090098
061000                 SET DP013-DB2-ABEND                              06100002
061100                     DP013-XCTL-DISPLAY-RESTART                   06110002
061200                                   TO TRUE                        06120002
061300                 PERFORM DP013-0000-PROCESS-ABEND                 06130002
061400         END-EVALUATE                                             06140002
061500     END-PERFORM.                                                 06150002
061600                                                                  06160002
061700     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        06170002
061800         MOVE '1150-GET-INVOICE'                                  06180002
061900                                   TO DP013-PARAGRAPH             06190002
062000         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO SELECT'     06200002
062100                                   TO DP013-MESSAGE-TEXT (1)      06210002
062200         MOVE 'INVOICE       '     TO DP013-MESSAGE-TEXT (2)      06220002
062300         MOVE SQLCA                TO DP013-SQLCA                 06230002
062400         MOVE 'TINVOIC'            TO DP013-DB2-TABLE-NAME (1)    06240002
062500         MOVE SPACES               TO DP013-DB2-TABLE-NAME (2)    06250098
062600         SET DP013-DB2-ABEND                                      06260002
062700             DP013-XCTL-DISPLAY-RESTART                           06270002
062800                                   TO TRUE                        06280002
062900         PERFORM DP013-0000-PROCESS-ABEND                         06290002
063000     END-IF.                                                      06300002
063100                                                                  06310002
063200                                                                  06320002
063300*----------------------------------------------------------------*06330002
063400* DO ANY PROCESSING FOR KEYS FOR WHICH NO EDITTING OF THE DATA   *06340002
063500* ON THE SCREEN NEEDS TO BE DONE.  IF ONE OF THOSE KEYS IS NOT   *06350002
063600* USED, EDIT THE DATA ON THE SCREEN AND GO ON TO CHECK THE REST  *06360002
063700* OF THE FUNCTION KEYS.  NOTE THAT WITH THE API, NO INVALID      *06370002
063800* FUNCTION KEYS CAN GET THIS FAR.                                *06380002
063900*----------------------------------------------------------------*06390002
064000 2000-PROCESS-PANEL.                                              06400002
064100                                                                  06410002
064200     EVALUATE TRUE                                                06420002
064300                                                                  06430002
064400         WHEN DP020-SRC-AID = DP016-CLEAR                         06440002
064500             PERFORM 3000-EDIT-DATA-IN-COMMAREA                   06450002
064600             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 06460002
064700             MOVE 'N'              TO ASC-CONFIRM-SW              06470002
064800                                                                  06480002
064900         WHEN DP020-FK-REFRESH(DP020-SRC-AID)                     06490002
065000             PERFORM 4000-BUILD-INITIAL-PANEL                     06500002
065100             MOVE 'N'              TO ASC-CONFIRM-SW              06510002
065200                                                                  06520002
065300         WHEN OTHER                                               06530002
065400             PERFORM 2200-MOVE-SCREEN-TO-COMMAREA                 06540002
065500             PERFORM 3000-EDIT-DATA-IN-COMMAREA                   06550002
065600             IF  PS-NO-ERROR                                      06560002
065700                 SET DP030-CONTINUE-GO                            06570002
065800                                   TO TRUE                        06580002
065900                 PERFORM 2100-CHECK-FUNCTION-KEY                  06590002
066000             ELSE                                                 06600002
066100                 SET DP030-OVERRIDE-GO                            06610002
066200                                   TO TRUE                        06620002
066300                 PERFORM 4400-MOVE-COMMAREA-TO-SCREEN             06630002
066400                 MOVE 'N'           TO ASC-CONFIRM-SW             06640002
066500             END-IF                                               06650002
066600     END-EVALUATE.                                                06660002
066700                                                                  06670002
066800                                                                  06680002
066900*----------------------------------------------------------------*06690002
067000* ACT ON ANY FUNCTION KEYS THAT REQUIRE EDITS TO BE PASSED       *06700002
067100* FIRST.  NOTE THAT INVALID FUNCTION KEYS WILL NOT BE RETURNED   *06710002
067200* FROM THE CICS ARCHITECTURE API.                                *06720002
067300*----------------------------------------------------------------*06730002
067400 2100-CHECK-FUNCTION-KEY.                                         06740002
067500                                                                  06750002
067600     EVALUATE TRUE                                                06760002
067700         WHEN DP020-SRC-AID = DP016-ENTER                         06770002
067800             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 06780002
067900             MOVE 'N'              TO ASC-CONFIRM-SW              06790002
068000                                                                  06800002
068100         WHEN DP020-FK-DESELECT(DP020-SRC-AID)                    06810002
068200             PERFORM 2110-DESELECT-ALL-ITEMS                      06820002
068300             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 06830002
068400                                                                  06840002
068500         WHEN DP020-FK-SELECT-ALL(DP020-SRC-AID)                  06850002
068600             PERFORM 2120-SELECT-ALL-ITEMS                        06860002
068700             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 06870002
068800                                                                  06880002
068900         WHEN DP020-FK-LOCAL-FUNC-01 (DP020-SRC-AID)              06890002
069000             PERFORM 3998-SELECTION-EDITS                         06900002
069100             IF PS-NO-ERROR                                       06910002
069200                 PERFORM 5000-UPDATE-AC                           06920002
069300                 MOVE ASC-NEW-NET-INVC-AMT   TO                   06930002
069400                      ASC-SAVE-NET-INVC-AMT                       06940002
069500                 MOVE ASC-NEW-GRO-COST-AMT   TO                   06950002
069600                      ASC-SAVE-GRO-COST-AMT                       06960002
069700                 MOVE ASC-NEW-CALC-INVC-AMT  TO                   06970002
069800                      ASC-SAVE-CALC-INVC-AMT                      06980002
069900                 PERFORM 4000-BUILD-INITIAL-PANEL                 06990002
070000                 MOVE 'N'          TO ASC-CONFIRM-SW              07000002
070100                 IF DP020-MSG-WARNING                             07010002
070200* OUT-OF-BALANCE CONDITION PERSISTS. ALLOW UPDATES, BUT SEND MSG  07020091
070300                     CONTINUE                                     07030091
070400                 ELSE                                             07040091
070500*                --- UPDATES SUCCESSFUL ---                       07050002
070600                     MOVE PC-TSYMSG-00059                         07060002
070700                                   TO DP020-MSG-NUMBER            07070002
070800                     SET DP020-MSG-INFORMATIONAL                  07080002
070900                                   TO TRUE                        07090002
071000                 END-IF                                           07100091
071100             ELSE                                                 07110002
071200                 PERFORM 8000-CHECK-INVOIC-STATUS                 07120002
071300*                -- THE THE STATUS OR GRO_COST CHANGED, THEN      07130002
071400*                -- IT'S O.K. TO HAVE HIT THE UPDATE KEY W/OUT    07140002
071500*                -- SELECTING A LINE ITEM.                        07150002
071600                 IF INVOICE-UPDATED                               07160002
071700                     MOVE ASC-NEW-NET-INVC-AMT   TO               07170002
071800                          ASC-SAVE-NET-INVC-AMT                   07180002
071900                     MOVE ASC-NEW-GRO-COST-AMT   TO               07190002
072000                          ASC-SAVE-GRO-COST-AMT                   07200002
072100                     MOVE ASC-NEW-CALC-INVC-AMT  TO               07210002
072200                          ASC-SAVE-CALC-INVC-AMT                  07220002
072300                     PERFORM 4000-BUILD-INITIAL-PANEL             07230002
072400                     MOVE 'N'          TO ASC-CONFIRM-SW          07240002
072500*                    --- UPDATES SUCCESSFUL ---                   07250002
072600                     MOVE PC-TSYMSG-00059  TO DP020-MSG-NUMBER    07260002
072700                     SET DP020-MSG-INFORMATIONAL                  07270002
072800                         PS-NO-ERROR   TO TRUE                    07280002
072900                 ELSE                                             07290002
073000*                    --- NOTHING SELECTED ---                     07300002
073100                     MOVE PC-TSYMSG-00057  TO DP020-MSG-NUMBER    07310002
073200                     SET DP020-MSG-INFORMATIONAL                  07320002
073300                                       TO TRUE                    07330002
073400                     PERFORM 4400-MOVE-COMMAREA-TO-SCREEN         07340002
073500                 END-IF                                           07350002
073600             END-IF                                               07360002
073700                                                                  07370002
073800         WHEN DP020-FK-LOCAL-FUNC-02 (DP020-SRC-AID)              07380002
073900             PERFORM 3998-SELECTION-EDITS                         07390002
074000             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 07400002
074100             IF PS-NO-ERROR                                       07410002
074200*                --- PRESS PF2 TO CONFIRM ---                     07420002
074300                 MOVE PC-TSYMSG-00004  TO DP020-MSG-NUMBER        07430002
074400                 SET DP020-MSG-INFORMATIONAL                      07440002
074500                                   TO TRUE                        07450002
074600                 MOVE 'Y'          TO ASC-CONFIRM-SW              07460002
074700             ELSE                                                 07470002
074800*                --- NOTHING SELECTED ---                         07480002
074900                 MOVE PC-TSYMSG-00057  TO DP020-MSG-NUMBER        07490002
075000                 SET DP020-MSG-INFORMATIONAL                      07500002
075100                                   TO TRUE                        07510002
075200             END-IF                                               07520002
075300                                                                  07530002
075400         WHEN DP020-FK-CONFIRM (DP020-SRC-AID)                    07540002
075500             IF ASC-CONFIRM-SW = 'Y'                              07550002
075600                 PERFORM 3998-SELECTION-EDITS                     07560002
075700                 IF PS-NO-ERROR                                   07570002
075800                     PERFORM 6000-DELETE-AC                       07580002
075900                     PERFORM 4000-BUILD-INITIAL-PANEL             07590002
076000*                    --- DELETES SUCCESSFUL ---                   07600002
076100                     MOVE PC-TSYMSG-00115  TO DP020-MSG-NUMBER    07610002
076200                     SET DP020-MSG-INFORMATIONAL                  07620002
076300                                   TO TRUE                        07630002
076400                     MOVE 'N'      TO ASC-CONFIRM-SW              07640002
076500                 ELSE                                             07650002
076600*                    -- NOTHING SELECTED --                       07660002
076700                     MOVE PC-TSYMSG-00057  TO DP020-MSG-NUMBER    07670002
076800                     SET DP020-MSG-INFORMATIONAL                  07680002
076900                                   TO TRUE                        07690002
077000                     PERFORM 4400-MOVE-COMMAREA-TO-SCREEN         07700002
077100                 END-IF                                           07710002
077200             ELSE                                                 07720002
077300*                --- NOT READY FOR DELETE --                      07730002
077400                 MOVE PC-TSYMSG-00118  TO DP020-MSG-NUMBER        07740002
077500                 SET DP020-MSG-INFORMATIONAL                      07750002
077600                                   TO TRUE                        07760002
077700                 PERFORM 4400-MOVE-COMMAREA-TO-SCREEN             07770002
077800             END-IF                                               07780002
077900                                                                  07790002
078000         WHEN OTHER                                               07800002
078100             SET DP013-NO-ROLLBACK                                07810002
078200                 DP013-XCTL-DISPLAY-RESTART                       07820002
078300                 DP013-CICS-ABEND  TO TRUE                        07830002
078400             MOVE '2100-PROCESS-PANEL'                            07840002
078500                                   TO DP013-PARAGRAPH             07850002
078600             MOVE 'INVALID FUNCTION KEY NOT CAPTURED BY API'      07860002
078700                                   TO DP013-MESSAGE-TEXT (1)      07870002
078800             PERFORM DP013-0000-PROCESS-ABEND                     07880002
078900     END-EVALUATE.                                                07890002
079000                                                                  07900002
079100                                                                  07910002
079200*----------------------------------------------------------------*07920002
079300* REMOVE ALL 'S' SELECTIONS FROM COMMAREA TABLE                  *07930002
079400*----------------------------------------------------------------*07940002
079500 2110-DESELECT-ALL-ITEMS.                                         07950002
079600                                                                  07960002
079700     PERFORM 2111-MOVE-SPACES-TO-SELECTION                        07970002
079800         VARYING PV-SUB                                           07980002
079900         FROM 1 BY 1                                              07990002
080000         UNTIL PV-SUB > PC-MAX-ALLW-CHRG-LINES.                   08000002
080100                                                                  08010002
080200                                                                  08020002
080300*----------------------------------------------------------------*08030002
080400* MOVES SPACES TO SELECTION FIELD                                *08040002
080500*----------------------------------------------------------------*08050002
080600 2111-MOVE-SPACES-TO-SELECTION.                                   08060002
080700                                                                  08070002
080800     MOVE SPACES                   TO ASC-SELECT (PV-SUB).        08080002
080900                                                                  08090002
081000                                                                  08100002
081100*----------------------------------------------------------------*08110002
081200* SELECT ALL ELIGIBLE ROWS FROM COMMAREA TABLE                   *08120002
081300*----------------------------------------------------------------*08130002
081400 2120-SELECT-ALL-ITEMS.                                           08140002
081500                                                                  08150002
081600     PERFORM 2121-MOVE-S-TO-SELECTION                             08160002
081700         VARYING PV-SUB                                           08170002
081800         FROM 1 BY 1                                              08180002
081900         UNTIL PV-SUB > PC-MAX-ALLW-CHRG-LINES.                   08190002
082000                                                                  08200002
082100                                                                  08210002
082200*----------------------------------------------------------------*08220002
082300* MOVES 'S' TO SELECTION FIELD                                   *08230002
082400*----------------------------------------------------------------*08240002
082500 2121-MOVE-S-TO-SELECTION.                                        08250002
082600                                                                  08260002
082700     IF ASC-AC-IND (PV-SUB) > SPACES                              08270002
082800         MOVE 'S'                   TO ASC-SELECT (PV-SUB)        08280002
082900     END-IF.                                                      08290002
083000                                                                  08300002
083100                                                                  08310002
083200*----------------------------------------------------------------*08320002
083300* MOVE DATA ENTERED ON THE SCREEN INTO THEIR RESPECTIVE FIELDS   *08330002
083400* IN THE APPLICATION-SPECIFIC COMMAREA.  ALL EDITS ARE DONE IN   *08340002
083500* THE APPLICATION-SPECIFIC COMMAERA, NOT ON THE SCREEN.          *08350002
083600*----------------------------------------------------------------*08360002
083700 2200-MOVE-SCREEN-TO-COMMAREA.                                    08370002
083800                                                                  08380002
083900     PERFORM 2210-MOVE-LINES-TO-COMMAREA                          08390002
084000         VARYING PV-SUB                                           08400002
084100         FROM 1 BY 1                                              08410002
084200         UNTIL PV-SUB > PC-MAX-ALLW-CHRG-LINES.                   08420002
084300                                                                  08430002
084400                                                                  08440002
084500******************************************************************08450002
084600** MOVE THE ENTERABLE FIELDS ON EACH LIST LINE INTO THE COMMAREA**08460002
084700******************************************************************08470002
084800 2210-MOVE-LINES-TO-COMMAREA.                                     08480002
084900                                                                  08490002
085000     IF MR-SELECTL (PV-SUB) > ZERO                                08500002
085100         MOVE MR-SELECT (PV-SUB)   TO ASC-SELECT (PV-SUB)         08510002
085200     ELSE                                                         08520002
085300         IF MR-SELECTA (PV-SUB) = DP015-ERASE-EOF                 08530002
085400             MOVE SPACE            TO ASC-SELECT (PV-SUB)         08540002
085500         END-IF                                                   08550002
085600     END-IF.                                                      08560002
085700                                                                  08570002
085800     IF ASC-EXPENSE-INVC                                          08580002
085900         MOVE 'C'                  TO ASC-AC-IND (PV-SUB)         08590002
086000     ELSE                                                         08600091
086100         IF MR-AC-INDL (PV-SUB) > ZERO                            08610002
086200             MOVE MR-AC-IND (PV-SUB) TO ASC-AC-IND (PV-SUB)       08620002
086300         ELSE                                                     08630002
086400             IF MR-AC-INDA (PV-SUB) = DP015-ERASE-EOF             08640002
086500                 MOVE SPACE        TO ASC-AC-IND (PV-SUB)         08650002
086600             END-IF                                               08660002
086700         END-IF                                                   08670002
086800     END-IF.                                                      08680002
086900                                                                  08690002
087000     IF MR-AC-CDEL (PV-SUB) > ZERO                                08700002
087100         MOVE MR-AC-CDE (PV-SUB)   TO ASC-AC-CDE (PV-SUB)         08710002
087200     ELSE                                                         08720002
087300         IF MR-AC-CDEA (PV-SUB) = DP015-ERASE-EOF                 08730002
087400             MOVE SPACE            TO ASC-AC-CDE (PV-SUB)         08740002
087500         END-IF                                                   08750002
087600     END-IF.                                                      08760002
087700                                                                  08770002
087800     IF MR-AC-PCTL (PV-SUB) > ZERO                                08780002
087900         MOVE MR-AC-PCT (PV-SUB)   TO ASC-AC-PCT (PV-SUB)         08790002
088000     ELSE                                                         08800002
088100         IF MR-AC-PCTA (PV-SUB) = DP015-ERASE-EOF                 08810002
088200             MOVE SPACE            TO ASC-AC-PCT (PV-SUB)         08820002
088300         END-IF                                                   08830002
088400     END-IF.                                                      08840002
088500                                                                  08850002
088600     IF MR-AC-AMTL (PV-SUB) > ZERO                                08860002
088700         MOVE MR-AC-AMT (PV-SUB)   TO ASC-AC-AMT (PV-SUB)         08870002
088800     ELSE                                                         08880002
088900         IF MR-AC-AMTA (PV-SUB) = DP015-ERASE-EOF                 08890002
089000             MOVE SPACE            TO ASC-AC-AMT (PV-SUB)         08900002
089100         END-IF                                                   08910002
089200     END-IF.                                                      08920002
089300                                                                  08930002
089400     IF MR-SS-CDEL (PV-SUB) > ZERO                                08940002
089500         MOVE MR-SS-CDE (PV-SUB)   TO ASC-SS-CDE (PV-SUB)         08950002
089600     ELSE                                                         08960002
089700         IF MR-SS-CDEA (PV-SUB) = DP015-ERASE-EOF                 08970002
089800             MOVE SPACE            TO ASC-SS-CDE (PV-SUB)         08980002
089900         END-IF                                                   08990002
090000     END-IF.                                                      09000002
090100                                                                  09010002
090200                                                                  09020002
090300*----------------------------------------------------------------*09030002
090400* PERFORM EDITS ON EACH FIELD ENTERED BY THE USER.  IF AN ERROR  *09040002
090500* IS FOUND, THE CURSOR IS POSITIONED AT THAT FIELD AND AN        *09050002
090600* APPROPRIATE ERROR MESSAGE IS DISPLAYED.                        *09060002
090700*----------------------------------------------------------------*09070002
090800 3000-EDIT-DATA-IN-COMMAREA.                                      09080002
090900                                                                  09090002
091000     SET PS-NO-ERROR               TO TRUE.                       09100002
091100                                                                  09110002
091200     IF ASC-NO-UPDATES-ALLOWED                                    09120002
091300         SET PS-ERROR TO TRUE                                     09130002
091400         PERFORM 3220-PROTECT-ENTRIES                             09140002
091500     ELSE                                                         09150002
091600         PERFORM 3005-PROCESS-PANEL                               09160002
091700     END-IF.                                                      09170002
091800                                                                  09180002
091900 3005-PROCESS-PANEL.                                              09190002
092000                                                                  09200002
092100     PERFORM 3200-RESET-ATTRIBUTES.                               09210002
092200     MOVE +0 TO ASC-TOT-CHARGES                                   09220002
092300                ASC-TOT-ALLOWS                                    09230002
092400                PV-TOT-ALLW-AMT.                                  09240002
092500                                                                  09250002
092600     PERFORM 3050-LINE-EDITS                                      09260002
092700         VARYING PV-SUB                                           09270002
092800         FROM PC-MAX-ALLW-CHRG-LINES BY -1                        09280002
092900         UNTIL PV-SUB < +1.                                       09290002
093000                                                                  09300002
093100*  ***  DON'T SUBTRACT ALLOWANCES ENTERED AS PERCENTAGES.     *   09310091
093200     COMPUTE ASC-NEW-CALC-INVC-AMT = ASC-NEW-GRO-COST-AMT +       09320002
093300                      ASC-TOT-CHARGES - PV-TOT-ALLW-AMT.          09330091
093400                                                                  09340002
093500     IF ASC-NEW-NET-INVC-AMT NOT = ASC-NEW-CALC-INVC-AMT          09350002
093600       AND PS-NO-ERROR                                            09360002
093700         MOVE -1                 TO MR-SELECTL (1)                09370002
093800         MOVE PC-TSYMSG-00931    TO DP020-MSG-NUMBER              09380002
093900         SET DP030-SET-CURSOR-APPL-1                              09390002
094000             DP020-MSG-WARNING   TO TRUE                          09400002
094100     END-IF.                                                      09410002
094200                                                                  09420002
094300*----------------------------------------------------------------*09430002
094400* EDIT EACH LINES DATA                                           *09440002
094500*----------------------------------------------------------------*09450002
094600 3050-LINE-EDITS.                                                 09460002
094700                                                                  09470002
094800     IF (ASC-SELECT (PV-SUB) = SPACES AND                         09480002
094900         ASC-AC-IND (PV-SUB) = SPACES AND                         09490002
095000         ASC-AC-CDE (PV-SUB) = SPACES AND                         09500002
095100         ASC-AC-PCT (PV-SUB) = SPACES AND                         09510002
095200         ASC-AC-AMT (PV-SUB) = SPACES AND                         09520002
095300         ASC-SS-CDE (PV-SUB) = SPACES )                           09530002
095400       OR (ASC-EXPENSE-INVC             AND                       09540006
095500           ASC-SELECT (PV-SUB) = SPACES AND                       09550002
095600*   ASC-AC-IND (PV-SUB) WILL ALWAYS BE 'C' FOR EXPENSE INVOICE    09560002
095700           ASC-AC-CDE (PV-SUB) = SPACES AND                       09570002
095800           ASC-AC-PCT (PV-SUB) = SPACES AND                       09580002
095900           ASC-AC-AMT (PV-SUB) = SPACES AND                       09590002
096000           ASC-SS-CDE (PV-SUB) = SPACES )                         09600002
096100        CONTINUE                                                  09610002
096200     ELSE                                                         09620002
096300                                                                  09630002
096400         IF ASC-SS-CDE (PV-SUB) = SPACES OR 'FG' OR 'NC'          09640002
096500             CONTINUE                                             09650002
096600         ELSE                                                     09660002
096700             SET PS-ERROR                                         09670002
096800                 DP020-MSG-FATAL       TO TRUE                    09680002
096900*            -- INVALID VALUE --                                  09690002
097000             MOVE PC-TSYMSG-00005      TO DP020-MSG-NUMBER        09700002
097100             MOVE DP015-UNP-ALP-BRT-OFF                           09710002
097200                                       TO MR-SS-CDEA (PV-SUB)     09720002
097300             MOVE DP015-RED            TO MR-SS-CDEC (PV-SUB)     09730002
097400             MOVE DP015-REVERSE        TO MR-SS-CDEH (PV-SUB)     09740002
097500             MOVE -1                   TO MR-SS-CDEL (PV-SUB)     09750002
097600             SET DP030-SET-CURSOR-APPL-1                          09760002
097700                                       TO TRUE                    09770002
097800         END-IF                                                   09780002
097900                                                                  09790002
098000         SET PS-AC-AMT-VALID           TO TRUE                    09800002
098100         IF  ASC-AC-AMT (PV-SUB) = SPACES                         09810002
098200             MOVE 0                    TO ASC-AC-AMT-N (PV-SUB)   09820002
098300             MOVE ASC-AC-AMT-N (PV-SUB)                           09830002
098400                                       TO PV-AMT-DIS              09840002
098500             MOVE PV-AMT-DIS           TO ASC-AC-AMT (PV-SUB)     09850002
098600             IF ASC-EXPENSE-INVC                                  09860007
098700                 MOVE SPACE            TO MR-AC-AMT (PV-SUB)      09870002
098800                 SET DP020-MSG-FATAL   TO TRUE                    09880002
098900*                -- MUST BE NUMERIC AND GREATER THAN ZERO --      09890002
099000                 MOVE DP015-UNP-ALP-BRT-OFF                       09900002
099100                                       TO MR-AC-AMTA (PV-SUB)     09910002
099200                 MOVE DP015-RED        TO MR-AC-AMTC (PV-SUB)     09920002
099300                 MOVE DP015-REVERSE    TO MR-AC-AMTH (PV-SUB)     09930002
099400                 MOVE -1               TO MR-AC-AMTL (PV-SUB)     09940002
099500                 IF PS-NO-ERROR                                   09950002
099600                     MOVE PC-TSYMSG-00342 TO DP020-MSG-NUMBER     09960002
099700                 END-IF                                           09970002
099800                 SET PS-ERROR                                     09980002
099900                     PS-AC-AMT-INVALID                            09990002
100000                     DP030-SET-CURSOR-APPL-1                      10000002
100100                                       TO TRUE                    10010002
100200             END-IF                                               10020091
100300         ELSE                                                     10030002
100400             MOVE ASC-AC-AMT (PV-SUB)  TO DP010I-UNEDITED-FIELD   10040002
100500             MOVE 8                    TO DP010I-MAXIMUM-DIGITS   10050002
100600             MOVE 2                    TO DP010I-MAXIMUM-DECIMALS 10060002
100700             SET  DP010I-NEGATIVE-NOT-ALLOWED                     10070002
100800                                       TO TRUE                    10080002
100910             CALL DP010I-NUMERIC-EDIT-ROUTINE                     10091099
100920                             USING DP010I-NUMERIC-EDIT-AREA       10092099
101000             IF DP010I-ERROR-DETECTED                             10100002
101100                 SET PS-ERROR                                     10110002
101200                     PS-AC-AMT-INVALID                            10120002
101300                     DP020-MSG-FATAL   TO TRUE                    10130002
101400*                -- MUST BE NUMERIC --                            10140002
101500                 MOVE PC-TSYMSG-00008  TO DP020-MSG-NUMBER        10150002
101600                 MOVE DP015-UNP-ALP-BRT-OFF                       10160002
101700                                       TO MR-AC-AMTA (PV-SUB)     10170002
101800                 MOVE DP015-RED        TO MR-AC-AMTC (PV-SUB)     10180002
101900                 MOVE DP015-REVERSE    TO MR-AC-AMTH (PV-SUB)     10190002
102000                 MOVE -1               TO MR-AC-AMTL (PV-SUB)     10200002
102100                 SET DP030-SET-CURSOR-APPL-1                      10210002
102200                                       TO TRUE                    10220002
102300             ELSE                                                 10230002
102400                 MOVE DP010I-NUMERIC-FIELD                        10240002
102500                                       TO ASC-AC-AMT-N (PV-SUB)   10250002
102600                 MOVE ASC-AC-AMT-N (PV-SUB)                       10260002
102700                                       TO PV-AMT-DIS              10270002
102800                 MOVE PV-AMT-DIS       TO ASC-AC-AMT (PV-SUB)     10280002
102900                 IF DP010I-NUMERIC-FIELD = ZERO                   10290002
103000                   AND ASC-EXPENSE-INVC                           10300007
103100                     MOVE SPACE        TO MR-AC-AMT (PV-SUB)      10310002
103200                     SET DP020-MSG-FATAL TO TRUE                  10320002
103300*                -- MUST BE NUMERIC AND GREATER THAN ZERO --      10330002
103400                     MOVE DP015-UNP-ALP-BRT-OFF                   10340002
103500                                       TO MR-AC-AMTA (PV-SUB)     10350002
103600                     MOVE DP015-RED    TO MR-AC-AMTC (PV-SUB)     10360002
103700                     MOVE DP015-REVERSE TO MR-AC-AMTH (PV-SUB)    10370002
103800                     MOVE -1           TO MR-AC-AMTL (PV-SUB)     10380002
103900                     IF PS-NO-ERROR                               10390002
104000                         MOVE PC-TSYMSG-00342                     10400002
104100                                       TO DP020-MSG-NUMBER        10410002
104200                     END-IF                                       10420002
104300                     SET PS-AC-AMT-INVALID                        10430002
104400                         DP030-SET-CURSOR-APPL-1                  10440002
104500                         PS-ERROR      TO TRUE                    10450002
104600                 END-IF                                           10460002
104700             END-IF                                               10470002
104800         END-IF                                                   10480002
104900                                                                  10490002
105000         SET PS-AC-PCT-VALID           TO TRUE                    10500002
105100         IF  ASC-AC-PCT (PV-SUB) =  SPACES                        10510002
105200           OR ASC-EXPENSE-INVC                                    10520007
105300             MOVE 0                    TO ASC-AC-PCT-N (PV-SUB)   10530002
105400             MOVE ASC-AC-PCT-N (PV-SUB)                           10540002
105500                                       TO PV-PCT-DIS              10550002
105600             MOVE PV-PCT-DIS           TO ASC-AC-PCT (PV-SUB)     10560002
105700         ELSE                                                     10570002
105800             MOVE ASC-AC-PCT (PV-SUB)  TO DP010I-UNEDITED-FIELD   10580002
105900             MOVE 2                    TO DP010I-MAXIMUM-DIGITS   10590002
106000             MOVE 2                    TO DP010I-MAXIMUM-DECIMALS 10600002
106100             SET DP010I-NEGATIVE-NOT-ALLOWED                      10610002
106200                                       TO TRUE                    10620002
106310             CALL DP010I-NUMERIC-EDIT-ROUTINE                     10631099
106320                             USING DP010I-NUMERIC-EDIT-AREA       10632099
106400             IF  DP010I-ERROR-DETECTED                            10640002
106500                 SET PS-AC-PCT-INVALID                            10650002
106600                     PS-ERROR                                     10660002
106700                     DP020-MSG-FATAL   TO TRUE                    10670002
106800*                -- MUST BE NUMERIC --                            10680002
106900                 MOVE PC-TSYMSG-00008  TO DP020-MSG-NUMBER        10690002
107000                 MOVE DP015-UNP-ALP-BRT-OFF                       10700002
107100                                       TO MR-AC-PCTA (PV-SUB)     10710002
107200                 MOVE DP015-RED        TO MR-AC-PCTC (PV-SUB)     10720002
107300                 MOVE DP015-REVERSE    TO MR-AC-PCTH (PV-SUB)     10730002
107400                 MOVE -1               TO MR-AC-PCTL (PV-SUB)     10740002
107500                 SET DP030-SET-CURSOR-APPL-1                      10750002
107600                                       TO TRUE                    10760002
107700             ELSE                                                 10770002
107800                 MOVE DP010I-NUMERIC-FIELD                        10780002
107900                                       TO ASC-AC-PCT-N (PV-SUB)   10790002
108000                 MOVE ASC-AC-PCT-N (PV-SUB)                       10800002
108100                                       TO PV-PCT-DIS              10810002
108200                 MOVE PV-PCT-DIS       TO ASC-AC-PCT (PV-SUB)     10820002
108300             END-IF                                               10830002
108400         END-IF                                                   10840002
108500                                                                  10850002
108600         IF PS-AC-AMT-VALID AND                                   10860002
108700            PS-AC-PCT-VALID                                       10870002
108800             IF ( ASC-AC-AMT-N (PV-SUB) = 0 AND                   10880007
108900                  ASC-AC-PCT-N (PV-SUB) = 0 )                     10890007
109000             OR ( ASC-AC-AMT-N (PV-SUB) > 0 AND                   10900007
109100                  ASC-AC-PCT-N (PV-SUB) > 0 )                     10910007
109200                 SET PS-ERROR                                     10920007
109300                     DP020-MSG-FATAL  TO TRUE                     10930007
109400*                    -- PCT OR AMT MUST BE ENTERED --             10940007
109500                 MOVE PC-TSYMSG-00862 TO DP020-MSG-NUMBER         10950007
109600                 MOVE DP015-UNP-ALP-BRT-OFF                       10960007
109700                                      TO MR-AC-AMTA (PV-SUB)      10970007
109800                                         MR-AC-PCTA (PV-SUB)      10980007
109900                 MOVE DP015-RED       TO MR-AC-AMTC (PV-SUB)      10990007
110000                                         MR-AC-PCTC (PV-SUB)      11000007
110100                 MOVE DP015-REVERSE   TO MR-AC-AMTH (PV-SUB)      11010007
110200                                         MR-AC-PCTH (PV-SUB)      11020007
110300                 MOVE -1              TO MR-AC-PCTL (PV-SUB)      11030007
110400                 SET DP030-SET-CURSOR-APPL-1                      11040002
110500                                      TO TRUE                     11050007
110600             END-IF                                               11060002
110700         END-IF                                                   11070002
110800                                                                  11080002
110900         MOVE ASC-AC-CDE (PV-SUB)     TO AP053-ALLW-CHRG-CODE     11090002
111000         IF ASC-AC-IND (PV-SUB) = 'A'                             11100002
111100           IF NOT ASC-EXPENSE-INVC                                11110007
111200             IF AP053-VALID-ALLW-CDES                             11120002
111300                 IF PS-AC-AMT-VALID                               11130002
111400*      ***  ONLY ACCUMULATE ALLOWANCES ENTERED AS AMOUNTS. *      11140091
111500                     ADD ASC-AC-AMT-N (PV-SUB)                    11150002
111600                                      TO ASC-TOT-ALLOWS           11160002
111700                                         PV-TOT-ALLW-AMT          11170091
111800                 END-IF                                           11180002
111900                 IF PS-AC-PCT-VALID                               11190002
112000                     COMPUTE ASC-TOT-ALLOWS  =                    11200002
112100                         (((ASC-AC-PCT-N(PV-SUB)  *               11210002
112200                            ASC-NEW-GRO-COST-AMT) * .01) +        11220002
112300                            ASC-TOT-ALLOWS)                       11230002
112400                 END-IF                                           11240002
112500             ELSE                                                 11250002
112600                 SET PS-ERROR                                     11260002
112700                     DP020-MSG-FATAL   TO TRUE                    11270002
112800*                -- INVALID VALUE --                              11280002
112900                 MOVE PC-TSYMSG-00005  TO DP020-MSG-NUMBER        11290002
113000                 MOVE DP015-UNP-ALP-BRT-OFF                       11300002
113100                                       TO MR-AC-CDEA (PV-SUB)     11310002
113200                 MOVE DP015-RED        TO MR-AC-CDEC (PV-SUB)     11320002
113300                 MOVE DP015-REVERSE    TO MR-AC-CDEH (PV-SUB)     11330002
113400                 MOVE -1               TO MR-AC-CDEL (PV-SUB)     11340002
113500                 SET DP030-SET-CURSOR-APPL-1                      11350002
113600                                       TO TRUE                    11360002
113700             END-IF                                               11370002
113800           ELSE                                                   11380002
113900             SET DP030-SET-CURSOR-APPL-1                          11390002
114000                 PS-ERROR                                         11400002
114100                 DP020-MSG-FATAL TO TRUE                          11410002
114200* -- ALLOWANCES ARE NOT ACCEPTED ON IMPORT EXPENSE INVOICES --    11420002
114300             MOVE PC-TSYMSG-01592 TO DP020-MSG-NUMBER             11430002
114400             MOVE DP015-UNP-ALP-BRT-OFF                           11440002
114500                                 TO MR-AC-INDA (PV-SUB)           11450002
114600             MOVE DP015-RED      TO MR-AC-INDC (PV-SUB)           11460002
114700             MOVE DP015-REVERSE  TO MR-AC-INDH (PV-SUB)           11470002
114800             MOVE -1             TO MR-AC-INDL (PV-SUB)           11480002
114900           END-IF                                                 11490002
115000         ELSE                                                     11500002
115100         IF ASC-AC-IND (PV-SUB) = 'C'                             11510002
115200             IF ASC-EXPENSE-INVC                                  11520007
115300                 PERFORM 3055-GET-EI-CHRG-CODES                   11530007
115400                 IF EI-CHARGE-CODE-INVALID                        11540091
115500                     SET PS-ERROR                                 11550002
115600                         DP020-MSG-FATAL  TO TRUE                 11560002
115700*                -- INVALID VALUE --                              11570002
115800                     MOVE PC-TSYMSG-00005 TO DP020-MSG-NUMBER     11580002
115900                     MOVE DP015-UNP-ALP-BRT-OFF                   11590002
116000                                          TO MR-AC-CDEA (PV-SUB)  11600002
116100                     MOVE DP015-RED       TO MR-AC-CDEC (PV-SUB)  11610002
116200                     MOVE DP015-REVERSE   TO MR-AC-CDEH (PV-SUB)  11620002
116300                     MOVE -1              TO MR-AC-CDEL (PV-SUB)  11630002
116400                     SET DP030-SET-CURSOR-APPL-1                  11640002
116500                                          TO TRUE                 11650002
116600                 END-IF                                           11660091
116700                 IF PS-AC-AMT-VALID                               11670002
116800                     ADD ASC-AC-AMT-N (PV-SUB) TO ASC-TOT-CHARGES 11680002
116900                 END-IF                                           11690002
117000             ELSE                                                 11700091
117100             IF AP053-VALID-CHRG-CDES                             11710002
117200                 IF AP053-VALID-FRGHT-CHRG-CDES AND               11720002
117300                    ASC-AC-PCT-N (PV-SUB) > 0                     11730002
117400                     SET PS-ERROR                                 11740002
117500                         DP020-MSG-FATAL  TO TRUE                 11750002
117600*                    -- FREIGHT CHARGE MUST BE ENTERED AS AMT --  11760002
117700                     MOVE PC-TSYMSG-01012 TO DP020-MSG-NUMBER     11770002
117800                     MOVE DP015-UNP-ALP-BRT-OFF                   11780002
117900                                          TO MR-AC-AMTA (PV-SUB)  11790002
118000                                             MR-AC-PCTA (PV-SUB)  11800002
118100                     MOVE DP015-RED       TO MR-AC-AMTC (PV-SUB)  11810002
118200                                             MR-AC-PCTC (PV-SUB)  11820002
118300                     MOVE DP015-REVERSE   TO MR-AC-AMTH (PV-SUB)  11830002
118400                                             MR-AC-PCTH (PV-SUB)  11840002
118500                     MOVE -1              TO MR-AC-PCTL (PV-SUB)  11850002
118600                     SET DP030-SET-CURSOR-APPL-1                  11860002
118700                                          TO TRUE                 11870002
118800                 END-IF                                           11880002
118900                 IF PS-AC-AMT-VALID                               11890002
119000                     ADD ASC-AC-AMT-N (PV-SUB) TO ASC-TOT-CHARGES 11900002
119100                 END-IF                                           11910002
119200                 IF PS-AC-PCT-VALID                               11920002
119300                     COMPUTE ASC-TOT-CHARGES =                    11930002
119400                    (((ASC-AC-PCT-N (PV-SUB) *                    11940002
119500                       ASC-NEW-GRO-COST-AMT) * .01) +             11950002
119600                       ASC-TOT-CHARGES)                           11960002
119700                 END-IF                                           11970002
119800             ELSE                                                 11980002
119900                 SET PS-ERROR                                     11990002
120000                     DP020-MSG-FATAL   TO TRUE                    12000002
120100*                -- INVALID VALUE --                              12010002
120200                 MOVE PC-TSYMSG-00005  TO DP020-MSG-NUMBER        12020002
120300                 MOVE DP015-UNP-ALP-BRT-OFF                       12030002
120400                                       TO MR-AC-CDEA (PV-SUB)     12040002
120500                 MOVE DP015-RED        TO MR-AC-CDEC (PV-SUB)     12050002
120600                 MOVE DP015-REVERSE    TO MR-AC-CDEH (PV-SUB)     12060002
120700                 MOVE -1               TO MR-AC-CDEL (PV-SUB)     12070002
120800                 SET DP030-SET-CURSOR-APPL-1                      12080002
120900                                       TO TRUE                    12090002
121000             END-IF                                               12100002
121100             END-IF                                               12110002
121200         ELSE                                                     12120002
121300             SET DP030-SET-CURSOR-APPL-1                          12130002
121400                 PS-ERROR                                         12140002
121500                 DP020-MSG-FATAL       TO TRUE                    12150002
121600*                -- INVALID VALUE --                              12160002
121700             MOVE PC-TSYMSG-00005      TO DP020-MSG-NUMBER        12170002
121800             MOVE DP015-UNP-ALP-BRT-OFF                           12180002
121900                                       TO MR-AC-INDA (PV-SUB)     12190002
122000             MOVE DP015-RED            TO MR-AC-INDC (PV-SUB)     12200002
122100             MOVE DP015-REVERSE        TO MR-AC-INDH (PV-SUB)     12210002
122200             MOVE -1                   TO MR-AC-INDL (PV-SUB)     12220002
122300         END-IF                                                   12230002
122400* THIS 2ND END IF WAS ADDED 4-15 BY CJK                           12240002
122500*   THIS WAS AN EXISTING LOGIC FLAW IN EDITTING                   12250002
122600         END-IF                                                   12260002
122700                                                                  12270002
122800         IF ASC-SELECT (PV-SUB) = SPACE OR 'S'                    12280002
122900             CONTINUE                                             12290002
123000         ELSE                                                     12300002
123100             SET PS-ERROR                                         12310002
123200                 DP020-MSG-FATAL       TO TRUE                    12320002
123300*            -- BLANK OR S    --                                  12330002
123400             MOVE PC-TSYMSG-00430      TO DP020-MSG-NUMBER        12340002
123500             MOVE DP015-UNP-ALP-BRT-OFF                           12350002
123600                                       TO MR-SELECTA (PV-SUB)     12360002
123700             MOVE DP015-RED            TO MR-SELECTC (PV-SUB)     12370002
123800             MOVE DP015-REVERSE        TO MR-SELECTH (PV-SUB)     12380002
123900             MOVE -1                   TO MR-SELECTL (PV-SUB)     12390002
124000             SET DP030-SET-CURSOR-APPL-1                          12400002
124100                                       TO TRUE                    12410002
124200         END-IF                                                   12420002
124300     END-IF.                                                      12430002
124400*----------------------------------------------------------------*12440007
124500* SELECT ALLOWANCE/CHARGE CODES FOR EXPENSE INVOICES             *12450007
124600*----------------------------------------------------------------*12460007
124700 3055-GET-EI-CHRG-CODES.                                          12470007
124800                                                                  12480007
124900     PERFORM                                                      12490007
125000         WITH TEST AFTER                                          12500007
125100         VARYING PV-RETRY-COUNTER                                 12510007
125200         FROM 1 BY 1                                              12520007
125300         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               12530007
125400                   OR (SQLCODE = ZERO)                            12540007
125500                   OR (SQLCODE = +100))                           12550007
125600                                                                  12560007
125700         EXEC SQL                                                 12570007
125800           SELECT '1'                                             12580099
125900            INTO  :PV-ONE                                         12590099
126000             FROM SYSIBM.SYSDUMMY1 X                              12600099
126100            WHERE EXISTS (SELECT 1                                12610099
126200                           FROM   TACCTYP                         12620099
126300                      WHERE  ALW_CHRG_CDE = :AP053-ALLW-CHRG-CODE 12630099
126400                         AND X.IBMREQD = X.IBMREQD)               12640099
126500         END-EXEC                                                 12650007
126600                                                                  12660007
126700         EVALUATE TRUE                                            12670007
126800             WHEN SQLCODE = ZERO                                  12680007
126900                 SET EI-CHARGE-CODE-VALID                         12690091
127000                                     TO TRUE                      12700091
127100             WHEN SQLCODE = +100                                  12710007
127200                 SET EI-CHARGE-CODE-INVALID                       12720091
127300                                     TO TRUE                      12730091
127400             WHEN SQLCODE = -904                                  12740007
127500             WHEN SQLCODE = -913                                  12750007
127600                 CONTINUE                                         12760007
127700             WHEN SQLWARN0 NOT = SPACES                           12770007
127800             WHEN SQLCODE < ZERO                                  12780007
127900             WHEN SQLCODE > ZERO                                  12790007
128000                 MOVE '3055-GET-EI-CHRG-CODES'                    12800007
128100                                   TO DP013-PARAGRAPH             12810007
128200                 MOVE 'SELECT EI CHRG CODES   '                   12820007
128300                                   TO DP013-MESSAGE-TEXT (1)      12830007
128400                 MOVE SQLCA        TO DP013-SQLCA                 12840007
128500                 MOVE 'TACCTYP'    TO DP013-DB2-TABLE-NAME (1)    12850007
128600                 SET DP013-DB2-ABEND                              12860007
128700                     DP013-XCTL-DISPLAY-RESTART                   12870007
128800                                   TO TRUE                        12880007
128900                 PERFORM DP013-0000-PROCESS-ABEND                 12890007
129000         END-EVALUATE                                             12900007
129100     END-PERFORM.                                                 12910007
129200                                                                  12920007
129300     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        12930007
129400         MOVE '3055-GET-EI-CHRG-CODES'                            12940007
129500                                   TO DP013-PARAGRAPH             12950007
129600         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO SELECT'     12960007
129700                                   TO DP013-MESSAGE-TEXT (1)      12970007
129800         MOVE 'ALLW CHRG CDE'      TO DP013-MESSAGE-TEXT (2)      12980007
129900         MOVE SQLCA                TO DP013-SQLCA                 12990007
130000         MOVE 'TACCTYP'            TO DP013-DB2-TABLE-NAME (1)    13000007
130100         SET DP013-DB2-ABEND                                      13010007
130200             DP013-XCTL-DISPLAY-RESTART                           13020007
130300                                   TO TRUE                        13030007
130400         PERFORM DP013-0000-PROCESS-ABEND                         13040007
130500     END-IF.                                                      13050007
130600                                                                  13060002
130700*----------------------------------------------------------------*13070002
130800* MAKE SURE SOMETHING IS SELECTED BEFORE DOING FUNCTION.         *13080002
130900*----------------------------------------------------------------*13090002
131000 3998-SELECTION-EDITS.                                            13100002
131100                                                                  13110002
131200     SET PS-ERROR                  TO TRUE.                       13120002
131300     PERFORM 3999-LINE-EDITS-SELECT                               13130002
131400         VARYING PV-SUB                                           13140002
131500         FROM PC-MAX-ALLW-CHRG-LINES BY -1                        13150002
131600         UNTIL PV-SUB < +1.                                       13160002
131700                                                                  13170002
131800                                                                  13180002
131900*----------------------------------------------------------------*13190002
132000* MAKE SURE SOMETHING IS SELECTED BEFORE DOING FUNCTION.         *13200002
132100*----------------------------------------------------------------*13210002
132200 3999-LINE-EDITS-SELECT.                                          13220002
132300                                                                  13230002
132400     IF ASC-SELECT (PV-SUB) = 'S'                                 13240002
132500         SET PS-NO-ERROR           TO TRUE                        13250002
132600     END-IF.                                                      13260002
132700                                                                  13270002
132800                                                                  13280002
132900*----------------------------------------------------------------*13290002
133000* MOVE THE DEFAULT ATTRIBUTE VALUES TO THE ENTERABLE FIELDS ON   *13300002
133100* MAP.                                                           *13310002
133200*----------------------------------------------------------------*13320002
133300 3200-RESET-ATTRIBUTES.                                           13330002
133400                                                                  13340002
133500*    MOVE DP015-UNP-ALP-NOR-OFF    TO ATOTCSTA                    13350007
133600*                                     ATOTINVA                    13360007
133700*    MOVE DP015-GREEN              TO ATOTCSTC                    13370007
133800*                                     ATOTINVC                    13380007
133900*    MOVE DP015-UNDERLINE          TO ATOTCSTH                    13390007
134000*                                     ATOTINVH                    13400007
134100*                                                                 13410007
134200*    IF ASC-EXPENSE-INVC                                          13420006
134300*        MOVE DP015-PRO-NOR-OFF    TO ATOTCSTA                    13430007
134400*        MOVE DP015-BLUE           TO ATOTCSTC                    13440007
134500*        MOVE DP015-HL-OFF         TO ATOTCSTH                    13450007
134600*    END-IF                                                       13460006
134700     PERFORM 3210-RESET-LINE-ATTRIBUTES                           13470002
134800         VARYING PV-SUB                                           13480002
134900         FROM 1 BY 1                                              13490002
135000         UNTIL PV-SUB > PC-MAX-ALLW-CHRG-LINES.                   13500002
135100                                                                  13510002
135200                                                                  13520002
135300*----------------------------------------------------------------*13530002
135400* MOVE THE DEFAULT ATTRIBUTE VALUES TO EACH LINE                 *13540002
135500*----------------------------------------------------------------*13550002
135600 3210-RESET-LINE-ATTRIBUTES.                                      13560002
135700                                                                  13570002
135800                                                                  13580002
135900     MOVE DP015-UNP-ALP-NOR-OFF    TO MR-SELECTA (PV-SUB)         13590002
136000                                      MR-AC-INDA (PV-SUB)         13600002
136100                                      MR-AC-CDEA (PV-SUB)         13610002
136200                                      MR-AC-PCTA (PV-SUB)         13620002
136300                                      MR-AC-AMTA (PV-SUB)         13630002
136400                                      MR-SS-CDEA (PV-SUB).        13640002
136500     MOVE DP015-GREEN              TO MR-SELECTC (PV-SUB)         13650002
136600                                      MR-AC-INDC (PV-SUB)         13660002
136700                                      MR-AC-CDEC (PV-SUB)         13670002
136800                                      MR-AC-PCTC (PV-SUB)         13680002
136900                                      MR-AC-AMTC (PV-SUB)         13690002
137000                                      MR-SS-CDEC (PV-SUB).        13700002
137100     MOVE DP015-UNDERLINE          TO MR-SELECTH (PV-SUB)         13710002
137200                                      MR-AC-INDH (PV-SUB)         13720002
137300                                      MR-AC-CDEH (PV-SUB)         13730002
137400                                      MR-AC-PCTH (PV-SUB)         13740002
137500                                      MR-AC-AMTH (PV-SUB)         13750002
137600                                      MR-SS-CDEH (PV-SUB).        13760002
137700     IF ASC-EXPENSE-INVC                                          13770006
137800         MOVE DP015-PRO-NOR-OFF    TO MR-AC-PCTA (PV-SUB)         13780006
137900                                      MR-AC-INDA (PV-SUB)         13790002
138000         MOVE DP015-BLUE           TO MR-AC-PCTC (PV-SUB)         13800006
138100                                      MR-AC-INDC (PV-SUB)         13810002
138200         MOVE DP015-HL-OFF         TO MR-AC-PCTH (PV-SUB)         13820006
138300                                      MR-AC-INDH (PV-SUB)         13830002
138400         MOVE 'C'                  TO MR-AC-IND  (PV-SUB)         13840002
138500     END-IF                                                       13850006
138600     .                                                            13860006
138700                                                                  13870002
138800 3220-PROTECT-ENTRIES.                                            13880002
138900                                                                  13890002
139000*    MOVE DP015-PRO-NOR-OFF        TO ATOTCSTA                    13900002
139100*                                     ATOTINVA                    13910002
139200*    MOVE DP015-BLUE               TO ATOTCSTC                    13920002
139300*                                     ATOTINVC                    13930002
139400*    MOVE DP015-HL-OFF             TO ATOTCSTH                    13940002
139500*                                     ATOTINVH                    13950002
139600                                                                  13960002
139700     PERFORM 3225-RESET-LINE-ATTRIBUTES                           13970002
139800         VARYING PV-SUB                                           13980002
139900         FROM 1 BY 1                                              13990002
140000         UNTIL PV-SUB > PC-MAX-ALLW-CHRG-LINES.                   14000002
140100                                                                  14010002
140200                                                                  14020002
140300*----------------------------------------------------------------*14030002
140400* MOVE THE DEFAULT ATTRIBUTE VALUES TO EACH LINE                 *14040002
140500*----------------------------------------------------------------*14050002
140600 3225-RESET-LINE-ATTRIBUTES.                                      14060002
140700                                                                  14070002
140800                                                                  14080002
140900     MOVE DP015-PRO-NOR-OFF        TO MR-SELECTA (PV-SUB)         14090002
141000                                      MR-AC-INDA (PV-SUB)         14100002
141100                                      MR-AC-CDEA (PV-SUB)         14110002
141200                                      MR-AC-PCTA (PV-SUB)         14120002
141300                                      MR-AC-AMTA (PV-SUB)         14130002
141400                                      MR-SS-CDEA (PV-SUB).        14140002
141500     MOVE DP015-BLUE               TO MR-SELECTC (PV-SUB)         14150002
141600                                      MR-AC-INDC (PV-SUB)         14160002
141700                                      MR-AC-CDEC (PV-SUB)         14170002
141800                                      MR-AC-PCTC (PV-SUB)         14180002
141900                                      MR-AC-AMTC (PV-SUB)         14190002
142000                                      MR-SS-CDEC (PV-SUB).        14200002
142100     MOVE DP015-HL-OFF             TO MR-SELECTH (PV-SUB)         14210002
142200                                      MR-AC-INDH (PV-SUB)         14220002
142300                                      MR-AC-CDEH (PV-SUB)         14230002
142400                                      MR-AC-PCTH (PV-SUB)         14240002
142500                                      MR-AC-AMTH (PV-SUB)         14250002
142600                                      MR-SS-CDEH (PV-SUB).        14260002
142700                                                                  14270002
142800                                                                  14280002
142900*----------------------------------------------------------------*14290002
143000*    BUILD SCREEN WITH DEFAULT DATA.                             *14300002
143100*----------------------------------------------------------------*14310002
143200 4000-BUILD-INITIAL-PANEL.                                        14320002
143300                                                                  14330002
143400     MOVE ASC-SAVE-NET-INVC-AMT    TO ASC-NEW-NET-INVC-AMT        14340002
143500     MOVE ASC-SAVE-GRO-COST-AMT    TO ASC-NEW-GRO-COST-AMT        14350002
143600                                                                  14360002
143700     EXEC SQL                                                     14370002
143800         SET :ASC-CURRENT-TIMESTAMP = CURRENT TIMESTAMP           14380002
143900     END-EXEC                                                     14390002
144000                                                                  14400002
144100     IF ASC-ENT-NAME = SPACE                                      14410002
144200         PERFORM 4001-GET-VEND-INFO                               14420002
144300     END-IF.                                                      14430091
144400     INITIALIZE ASC-SCREEN-DATA.                                  14440002
144500     PERFORM 8100-OPEN-AC-CSR.                                    14450002
144600     SET PS-NOT-END-OF-CSR         TO TRUE.                       14460002
144700     MOVE +0                       TO PV-SUB                      14470002
144800                                      ASC-TOT-CHARGES             14480002
144900                                      ASC-TOT-ALLOWS              14490002
145000                                      PV-TOT-ALLW-AMT.            14500091
145100     PERFORM 8200-PROCESS-AC-CSR                                  14510002
145200         UNTIL PS-END-OF-CSR.                                     14520002
145300     PERFORM 8300-CLOSE-AC-CSR.                                   14530002
145400                                                                  14540002
145500     COMPUTE ASC-SAVE-CALC-INVC-AMT = ASC-NEW-GRO-COST-AMT +      14550002
145600                      ASC-TOT-CHARGES - PV-TOT-ALLW-AMT.          14560091
145700*                                     ASC-TOT-CHARGES             14570002
145800                                                                  14580002
145900     MOVE  ASC-SAVE-CALC-INVC-AMT TO  ASC-NEW-CALC-INVC-AMT       14590002
146000************                                                      14600091
146100     IF ASC-SAVE-INVC-STATUS NOT = 'OB'                           14610091
146200       AND ASC-NEW-NET-INVC-AMT = 0                               14620091
146300         MOVE ASC-SAVE-CALC-INVC-AMT                              14630091
146400                                 TO ASC-SAVE-NET-INVC-AMT         14640091
146500                                    ASC-NEW-NET-INVC-AMT          14650091
146600     END-IF.                                                      14660091
146700***************                                                   14670091
146800                                                                  14680002
146900     PERFORM 4300-CALC-PREQIT-TOT-COST.                           14690002
147000                                                                  14700002
147100     PERFORM 4400-MOVE-COMMAREA-TO-SCREEN.                        14710002
147200                                                                  14720002
147300     IF ASC-NEW-NET-INVC-AMT NOT = ASC-NEW-CALC-INVC-AMT          14730002
147400       AND PS-NO-ERROR                                            14740002
147500         MOVE -1                 TO MR-SELECTL (1)                14750002
147600         MOVE PC-TSYMSG-00931    TO DP020-MSG-NUMBER              14760002
147700         SET DP030-SET-CURSOR-APPL-1                              14770002
147800             DP020-MSG-WARNING   TO TRUE                          14780002
147900     END-IF.                                                      14790002
148000                                                                  14800002
148100     IF ASC-SAVE-INVC-STATUS   = 'DE' OR                          14810002
148200        ASC-SAVE-INVC-STATUS   = 'RL' OR                          14820002
148300        ASC-SAVE-INVC-STATUS   = 'OP' OR                          14830002
148400        ASC-SAVE-INVC-STATUS   = 'PD' OR                          14840002
148500        ASC-SAVE-INVC-STATUS   = 'PJ' OR                          14850099
148600        ASC-SAVE-ENTR-MTHD-CDE = 'ED' OR                          14860002
148700        ASC-SAVE-INVC-TYP-CDE  = 'RI' OR                          14870002
148800        ASC-SAVE-INVC-TYP-CDE  = 'WO'                             14880099
148900            PERFORM 3220-PROTECT-ENTRIES                          14890099
149000            SET ASC-NO-UPDATES-ALLOWED TO TRUE                    14900099
149100            SET ASC-NO-UPDATES-ALLOWED TO TRUE                    14910002
149200            EVALUATE TRUE                                         14920002
149300              WHEN ASC-SAVE-INVC-TYP-CDE = 'RI'                   14930002
149400                MOVE PC-TSYMSG-00970 TO DP020-MSG-NUMBER          14940002
149500              WHEN ASC-SAVE-INVC-TYP-CDE = 'WO'                   14950002
149600                MOVE PC-TSYMSG-01517 TO DP020-MSG-NUMBER          14960002
149700              WHEN ASC-SAVE-ENTR-MTHD-CDE = 'ED'                  14970002
149800                MOVE PC-TSYMSG-00851 TO DP020-MSG-NUMBER          14980002
149900              WHEN OTHER                                          14990002
150000                MOVE PC-TSYMSG-00170 TO DP020-MSG-NUMBER          15000002
150100            END-EVALUATE                                          15010002
150200            SET DP030-SET-CURSOR-TRAILER                          15020002
150300                PS-ERROR                 TO TRUE                  15030002
150400     ELSE                                                         15040002
150500         IF ASC-SAVE-INVC-TYP-CDE  = 'EI'                         15050002
150600             PERFORM 3210-RESET-LINE-ATTRIBUTES                   15060091
150700                 VARYING PV-SUB                                   15070091
150800                 FROM 1 BY 1                                      15080091
150900                 UNTIL PV-SUB > PC-MAX-ALLW-CHRG-LINES            15090091
151000         END-IF                                                   15100091
151100         MOVE 'N'                  TO ASC-CONFIRM-SW              15110002
151200         MOVE -1                   TO MR-SELECTL (1)              15120002
151300         SET DP030-SET-CURSOR-APPL-1                              15130002
151400                                   TO TRUE                        15140002
151500     END-IF.                                                      15150002
151600                                                                  15160002
151700*----------------------------------------------------------------*15170002
151800* SELECT VEND NAME                                               *15180002
151900*----------------------------------------------------------------*15190002
152000 4001-GET-VEND-INFO.                                              15200002
152100                                                                  15210002
152200     PERFORM                                                      15220002
152300         WITH TEST AFTER                                          15230002
152400         VARYING PV-RETRY-COUNTER                                 15240002
152500         FROM 1 BY 1                                              15250002
152600         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               15260002
152700                   OR (SQLCODE = ZERO)                            15270002
152800                   OR (SQLCODE = +100))                           15280002
152900                                                                  15290002
153000         EXEC SQL                                                 15300002
153100             SELECT B.ENT_NAME_DESC                               15310002
153200             INTO   :ENTNME-ENT-NAME-DESC                         15320002
153300             FROM   TEXTENT A,                                    15330002
153400                    TENTNME B                                     15340002
153500*KPC         WHERE  A.DUN_NBR = :PAYREQ-REMIT-TO-DUN-NBR          15350098
153600             WHERE  A.DUN_NBR = :INVOIC-RMIT-VND-ID               15360098
153700               AND  B.ENT_ID = A.ENT_ID                           15370002
153800               AND  B.TYPE_CDE = '01'                             15380002
153900         END-EXEC                                                 15390002
154000                                                                  15400002
154100         EVALUATE TRUE                                            15410002
154200             WHEN SQLCODE = ZERO                                  15420002
154300                 MOVE ENTNME-ENT-NAME-DESC                        15430002
154400                                     TO ASC-ENT-NAME              15440002
154500             WHEN SQLCODE = +100                                  15450002
154600                 MOVE 'NOT FOUND'    TO ASC-ENT-NAME              15460002
154700             WHEN SQLCODE = -904                                  15470002
154800             WHEN SQLCODE = -913                                  15480002
154900                 CONTINUE                                         15490002
155000             WHEN SQLWARN0 NOT = SPACES                           15500002
155100             WHEN SQLCODE < ZERO                                  15510002
155200             WHEN SQLCODE > ZERO                                  15520002
155300                 MOVE '4001-GET-VEND-INFO    '                    15530002
155400                                   TO DP013-PARAGRAPH             15540002
155500                 MOVE 'SELECT VEND NAME       '                   15550002
155600                                   TO DP013-MESSAGE-TEXT (1)      15560002
155700                 MOVE SQLCA        TO DP013-SQLCA                 15570002
155800                 MOVE 'TEXTENT'    TO DP013-DB2-TABLE-NAME (1)    15580007
155900                 MOVE 'TENTNME'    TO DP013-DB2-TABLE-NAME (2)    15590091
156000                 SET DP013-DB2-ABEND                              15600002
156100                     DP013-XCTL-DISPLAY-RESTART                   15610002
156200                                   TO TRUE                        15620002
156300                 PERFORM DP013-0000-PROCESS-ABEND                 15630002
156400         END-EVALUATE                                             15640002
156500     END-PERFORM.                                                 15650002
156600                                                                  15660002
156700     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        15670002
156800         MOVE '4001-GET-VEND-INFO    '                            15680002
156900                                   TO DP013-PARAGRAPH             15690002
157000         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO SELECT'     15700002
157100                                   TO DP013-MESSAGE-TEXT (1)      15710002
157200         MOVE 'VEND NAME    '      TO DP013-MESSAGE-TEXT (2)      15720002
157300         MOVE SQLCA                TO DP013-SQLCA                 15730002
157400         MOVE 'TEXTENT'            TO DP013-DB2-TABLE-NAME (1)    15740091
157500         MOVE 'TENTNME'            TO DP013-DB2-TABLE-NAME (2)    15750002
157600         SET DP013-DB2-ABEND                                      15760002
157700             DP013-XCTL-DISPLAY-RESTART                           15770002
157800                                   TO TRUE                        15780002
157900         PERFORM DP013-0000-PROCESS-ABEND                         15790002
158000     END-IF.                                                      15800002
158100                                                                  15810002
158200*----------------------------------------------------------------*15820002
158300*    FOR TOTAL UNIT COST, WE NEED TO GET THE WEIGHTED AVERAGE    *15830002
158400*----------------------------------------------------------------*15840002
158500 4300-CALC-PREQIT-TOT-COST.                                       15850002
158600                                                                  15860002
158700     MOVE +0 TO PV-TOTAL-PIECES                                   15870002
158800                PV-PER-UNIT-COST                                  15880002
158900                ASC-CALC-PREQIT-COST                              15890002
159000                                                                  15900002
159100     EXEC SQL                                                     15910002
159200         OPEN PREQIT_CSR                                          15920002
159300     END-EXEC.                                                    15930002
159400                                                                  15940002
159500     EVALUATE TRUE                                                15950002
159600         WHEN SQLCODE = +0                                        15960002
159700             CONTINUE                                             15970002
159800         WHEN OTHER                                               15980002
159900             MOVE '4300-...           '                           15990002
160000                               TO DP013-PARAGRAPH                 16000002
160100             MOVE 'OPEN CURSOR'                                   16010002
160200                               TO DP013-MESSAGE-TEXT(1)           16020002
160300             MOVE SQLCA        TO DP013-SQLCA                     16030002
160400             MOVE 'TPREQIT'    TO DP013-DB2-TABLE-NAME (1)        16040002
160500             SET DP013-DB2-ABEND                                  16050002
160600                 DP013-XCTL-DISPLAY-RESTART TO TRUE               16060002
160700             PERFORM DP013-0000-PROCESS-ABEND                     16070002
160800     END-EVALUATE                                                 16080002
160900                                                                  16090002
161000     PERFORM UNTIL SQLCODE = +100                                 16100002
161100                                                                  16110002
161200         EXEC SQL                                                 16120002
161300             FETCH PREQIT_CSR                                     16130002
161400             INTO :PV-TOTAL-PIECES                                16140002
161500                 ,:PV-PER-UNIT-COST                               16150002
161600         END-EXEC                                                 16160002
161700                                                                  16170002
161800         EVALUATE TRUE                                            16180002
161900             WHEN SQLCODE = +0                                    16190002
162000                 COMPUTE ASC-CALC-PREQIT-COST =                   16200002
162100                         ASC-CALC-PREQIT-COST +                   16210002
162200                        (PV-PER-UNIT-COST * PV-TOTAL-PIECES)      16220002
162300             WHEN SQLCODE = +100                                  16230002
162400                 CONTINUE                                         16240002
162500             WHEN OTHER                                           16250002
162600                 MOVE '4300-...           '                       16260002
162700                                   TO DP013-PARAGRAPH             16270002
162800                 MOVE 'FETCH CURSOR'                              16280002
162900                                   TO DP013-MESSAGE-TEXT(1)       16290002
163000                 MOVE SQLCA        TO DP013-SQLCA                 16300002
163100                 MOVE 'TPREQIT'    TO DP013-DB2-TABLE-NAME (1)    16310002
163200                 SET DP013-DB2-ABEND                              16320002
163300                     DP013-XCTL-DISPLAY-RESTART TO TRUE           16330002
163400                 PERFORM DP013-0000-PROCESS-ABEND                 16340002
163500         END-EVALUATE                                             16350002
163600     END-PERFORM.                                                 16360002
163700                                                                  16370002
163800     EXEC SQL                                                     16380002
163900        CLOSE PREQIT_CSR                                          16390002
164000     END-EXEC.                                                    16400002
164100                                                                  16410002
164200     EVALUATE TRUE                                                16420002
164300         WHEN SQLCODE = +0                                        16430002
164400             CONTINUE                                             16440002
164500         WHEN OTHER                                               16450002
164600             MOVE '4300-...           '                           16460002
164700                               TO DP013-PARAGRAPH                 16470002
164800             MOVE 'CLOSE CURSOR'                                  16480002
164900                               TO DP013-MESSAGE-TEXT(1)           16490002
165000             MOVE SQLCA        TO DP013-SQLCA                     16500002
165100             MOVE 'TPREQIT'    TO DP013-DB2-TABLE-NAME (1)        16510002
165200             SET DP013-DB2-ABEND                                  16520002
165300                 DP013-XCTL-DISPLAY-RESTART TO TRUE               16530002
165400             PERFORM DP013-0000-PROCESS-ABEND                     16540002
165500     END-EVALUATE.                                                16550002
165600/                                                                 16560002
165700                                                                  16570002
165800*----------------------------------------------------------------*16580002
165900*    RESTORE THE DATA ON THE SCREEN FROM THE COMM AREA.          *16590002
166000*----------------------------------------------------------------*16600002
166100 4400-MOVE-COMMAREA-TO-SCREEN.                                    16610002
166200                                                                  16620002
166300     MOVE ASC-SAVE-PO-NBR          TO APONUMO.                    16630002
166400     MOVE ASC-SAVE-INVC-ID         TO AINVNBRO.                   16640002
166500     MOVE ASC-ENT-NAME             TO AVENDNMO.                   16650002
166600                                                                  16660002
166700     MOVE ASC-TOT-CHARGES          TO PV-8V99.                    16670002
166800     MOVE PV-8V99-X                TO ATOTCHGO.                   16680002
166900                                                                  16690002
167000     MOVE ASC-TOT-ALLOWS           TO PV-8V99.                    16700002
167100     MOVE PV-8V99-X                TO ATOTALWO.                   16710002
167200                                                                  16720002
167300     IF ASC-ALP-GRO-COST-AMT NUMERIC                              16730002
167400         MOVE ASC-NEW-GRO-COST-AMT  TO PV-8V99                    16740002
167500         MOVE PV-8V99-X             TO ATOTCSTO                   16750002
167600                                       ASC-ALP-GRO-COST-AMT       16760002
167700     ELSE                                                         16770002
167800         MOVE ASC-ALP-GRO-COST-AMT  TO ATOTCSTO                   16780002
167900     END-IF.                                                      16790002
168000                                                                  16800002
168100     IF ASC-ALP-NET-INVC-AMT NUMERIC                              16810002
168200         MOVE ASC-NEW-NET-INVC-AMT  TO PV-8V99                    16820002
168300         MOVE PV-8V99-X             TO ATOTINVO                   16830002
168400                                       ASC-ALP-NET-INVC-AMT       16840002
168500     ELSE                                                         16850002
168600         MOVE ASC-ALP-NET-INVC-AMT  TO ATOTINVO                   16860002
168700     END-IF.                                                      16870002
168800                                                                  16880002
168900     IF ASC-NEW-CALC-INVC-AMT NUMERIC                             16890091
169000         IF ASC-NEW-CALC-INVC-AMT < ZERO                          16900002
169100             MOVE ASC-NEW-CALC-INVC-AMT TO PV-NET-AMT             16910091
169200             MOVE '-'                   TO PV-MINUS               16920002
169300             MOVE PV-NET-AMT-X          TO ACLCINVO               16930002
169400         ELSE                                                     16940091
169500             MOVE ASC-NEW-CALC-INVC-AMT TO PV-8V99                16950002
169600             MOVE PV-8V99-X         TO ACLCINVO                   16960002
169700         END-IF                                                   16970091
169800     END-IF.                                                      16980091
169900                                                                  16990002
170000     MOVE DP015-BLUE                TO ASTATUSC.                  17000002
170100     EVALUATE ASC-SAVE-INVC-STATUS                                17010002
170200         WHEN 'EN'                                                17020002
170300             MOVE 'ENTERED    '     TO ASTATUSO                   17030002
170400         WHEN 'RC'                                                17040002
170500             MOVE 'RECONCILE  '     TO ASTATUSO                   17050002
170600         WHEN 'RL'                                                17060002
170700             MOVE 'RELEASED   '     TO ASTATUSO                   17070002
170800         WHEN 'OP'                                                17080002
170900             MOVE 'OPEN TO PAY'     TO ASTATUSO                   17090002
171000         WHEN 'PD'                                                17100002
171100             MOVE 'PAID       '     TO ASTATUSO                   17110002
171200         WHEN 'PJ'                                                17120099
171300             MOVE 'PENDNG JRNL'     TO ASTATUSO                   17130099
171400         WHEN 'DE'                                                17140099
171500             MOVE 'DELETED    '     TO ASTATUSO                   17150099
171600         WHEN 'OB'                                                17160099
171700             MOVE 'OUT OF BAL '     TO ASTATUSO                   17170099
171800             MOVE DP015-YELLOW      TO ASTATUSC                   17180099
171900         WHEN 'PR'                                                17190099
172000             MOVE 'PENDING RVW'     TO ASTATUSO                   17200099
172100             MOVE DP015-YELLOW      TO ASTATUSC                   17210099
172200         WHEN 'IB'                                                17220099
172300             MOVE 'ITM IMBALNC'     TO ASTATUSO                   17230099
172400             MOVE DP015-YELLOW      TO ASTATUSC                   17240099
172500         WHEN 'BM'                                                17250099
172600             MOVE DP015-YELLOW      TO ASTATUSC                   17260099
172700             MOVE 'BATCH MATCH'     TO ASTATUSO                   17270099
172800     END-EVALUATE.                                                17280099
172900                                                                  17290099
173000     PERFORM 4410-MOVE-LINES-TO-SCREEN                            17300099
173100         VARYING PV-SUB                                           17310099
173200         FROM 1 BY 1                                              17320099
173300         UNTIL PV-SUB > PC-MAX-ALLW-CHRG-LINES.                   17330099
173400                                                                  17340099
173500                                                                  17350099
173600*----------------------------------------------------------------*17360099
173700*    RESTORE THE DATA ON THE SCREEN FROM THE COMM AREA.          *17370099
173800*----------------------------------------------------------------*17380099
173900 4410-MOVE-LINES-TO-SCREEN.                                       17390099
174000                                                                  17400099
174100     MOVE ASC-SELECT (PV-SUB)      TO MR-SELECT (PV-SUB).         17410099
174200     MOVE ASC-AC-IND (PV-SUB)      TO MR-AC-IND (PV-SUB).         17420099
174300     MOVE ASC-AC-CDE (PV-SUB)      TO MR-AC-CDE (PV-SUB).         17430099
174400     MOVE ASC-AC-PCT (PV-SUB)      TO MR-AC-PCT (PV-SUB).         17440099
174500     MOVE ASC-AC-AMT (PV-SUB)      TO MR-AC-AMT (PV-SUB).         17450099
174600     MOVE ASC-SS-CDE (PV-SUB)      TO MR-SS-CDE (PV-SUB).         17460099
174700                                                                  17470099
174800                                                                  17480099
174900*----------------------------------------------------------------*17490099
175000* CONTROLS ADDING OR UPDATING ALLOWANCES/CHARGES                 *17500099
175100*----------------------------------------------------------------*17510099
175200 5000-UPDATE-AC.                                                  17520099
175300                                                                  17530099
175400     PERFORM 5100-UPDATE-AC-LINES                                 17540099
175500         VARYING PV-SUB                                           17550099
175600         FROM 1 BY 1                                              17560099
175700         UNTIL PV-SUB > PC-MAX-ALLW-CHRG-LINES.                   17570099
175800                                                                  17580099
175900     PERFORM 8000-CHECK-INVOIC-STATUS.                            17590099
176000                                                                  17600099
176100*----------------------------------------------------------------*17610099
176200* DETERMINES IF ADD OR UPDATE ALLOWANCES/CHARGES                 *17620099
176300*----------------------------------------------------------------*17630099
176400 5100-UPDATE-AC-LINES.                                            17640099
176500                                                                  17650099
176600     IF ASC-SELECT (PV-SUB) = 'S'                                 17660099
176700         IF ASC-AC-SEQ-NBR (PV-SUB) = ZERO                        17670099
176800             PERFORM 5200-INSERT-TALCHRG                          17680099
176900         ELSE                                                     17690099
177000             PERFORM 5300-UPDATE-TALCHRG                          17700099
177100         END-IF                                                   17710099
177200         IF ASC-AC-IND (PV-SUB) = 'C'                             17720099
177300           AND NOT ASC-EXPENSE-INVC                               17730099
177400             PERFORM 5400-HOLD-CHECK                              17740099
177500         END-IF                                                   17750099
177600     END-IF.                                                      17760099
177700                                                                  17770099
177800                                                                  17780099
177900*----------------------------------------------------------------*17790099
178000* INSERTS RECORD INTO TALCHRG TABLE                              *17800099
178100*----------------------------------------------------------------*17810099
178200 5200-INSERT-TALCHRG.                                             17820099
178300                                                                  17830099
178400     PERFORM 5210-SELECT-MAX-SEQ-NBR.                             17840099
178500     MOVE ASC-SAVE-PO-NBR         TO ALCHRG-PO-NBR.               17850099
178600     MOVE ASC-SAVE-INVC-ID        TO ALCHRG-INVC-ID.              17860099
178700     ADD +1                       TO ALCHRG-ALW-CHRG-SEQ-NBR.     17870099
178800     MOVE ASC-AC-IND (PV-SUB)     TO ALCHRG-ALW-CHRG-TYP-CDE.     17880099
178900     MOVE ASC-AC-CDE (PV-SUB)     TO ALCHRG-ALW-CHRG-CDE.         17890099
179000     COMPUTE ALCHRG-ALW-CHRG-PCT = ASC-AC-PCT-N(PV-SUB) / 100.    17900099
179100     MOVE ASC-AC-AMT-N (PV-SUB)   TO ALCHRG-ALW-CHRG-AMT.         17910099
179200     MOVE ASC-SS-CDE (PV-SUB)     TO ALCHRG-ALW-CHRG-SER-CDE.     17920099
179300                                                                  17930099
179400     PERFORM                                                      17940099
179500         WITH TEST AFTER                                          17950099
179600         VARYING PV-RETRY-COUNTER                                 17960099
179700         FROM 1 BY 1                                              17970099
179800         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               17980099
179900             OR (SQLCODE = +0))                                   17990099
180000                                                                  18000099
180100         EXEC SQL                                                 18010099
180200              INSERT INTO TALCHRG                                 18020099
180300                     ( PO_NBR                                     18030099
180400                      ,INVC_ID                                    18040099
180500                      ,ALW_CHRG_SEQ_NBR                           18050099
180600                      ,ALW_CHRG_TYP_CDE                           18060099
180700                      ,ALW_CHRG_CDE                               18070099
180800                      ,ALW_CHRG_SER_CDE                           18080099
180900                      ,ALW_CHRG_PCT                               18090099
181000                      ,ALW_CHRG_AMT )                             18100099
181100              VALUES ( :ALCHRG-PO-NBR                             18110099
181200                      ,:ALCHRG-INVC-ID                            18120099
181300                      ,:ALCHRG-ALW-CHRG-SEQ-NBR                   18130099
181400                      ,:ALCHRG-ALW-CHRG-TYP-CDE                   18140099
181500                      ,:ALCHRG-ALW-CHRG-CDE                       18150099
181600                      ,:ALCHRG-ALW-CHRG-SER-CDE                   18160099
181700                      ,:ALCHRG-ALW-CHRG-PCT                       18170099
181800                      ,:ALCHRG-ALW-CHRG-AMT )                     18180099
181900         END-EXEC                                                 18190099
182000                                                                  18200099
182100         EVALUATE TRUE                                            18210099
182200             WHEN SQLCODE = +0                                    18220099
182300             WHEN SQLCODE = -904                                  18230099
182400             WHEN SQLCODE = -913                                  18240099
182500                  CONTINUE                                        18250099
182600                                                                  18260099
182700             WHEN SQLWARN0 NOT = SPACES                           18270099
182800             WHEN SQLCODE < +0                                    18280099
182900             WHEN SQLCODE > +0                                    18290099
183000                  MOVE '5200-INSERT-TALCHRG'                      18300099
183100                                  TO DP013-PARAGRAPH              18310099
183200                  MOVE 'UNSUCCESSFUL INSERT FOR TALCHRG'          18320099
183300                                  TO DP013-MESSAGE-TEXT (1)       18330099
183400                  MOVE SQLCA      TO DP013-SQLCA                  18340099
183500                  MOVE 'TALCHRG ' TO DP013-DB2-TABLE-NAME (1)     18350099
183600                  SET DP013-DB2-ABEND                             18360099
183700                      DP013-XCTL-DISPLAY-RESTART                  18370099
183800                                  TO TRUE                         18380099
183900                  PERFORM DP013-0000-PROCESS-ABEND                18390099
184000         END-EVALUATE                                             18400099
184100     END-PERFORM.                                                 18410099
184200                                                                  18420099
184300     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        18430099
184400         MOVE '5200-INSERT-TALCHRG'                               18440099
184500                                  TO DP013-PARAGRAPH              18450099
184600         MOVE 'MAX RETRIES EXCEEDED FOR INSERT ON TALCHRG'        18460099
184700                                  TO DP013-MESSAGE-TEXT (1)       18470099
184800         MOVE SQLCA               TO DP013-SQLCA                  18480099
184900         MOVE 'TALCHRG '          TO DP013-DB2-TABLE-NAME (1)     18490099
185000         SET DP013-DB2-ABEND                                      18500099
185100             DP013-XCTL-DISPLAY-RESTART                           18510099
185200                                  TO TRUE                         18520099
185300         PERFORM DP013-0000-PROCESS-ABEND                         18530099
185400     END-IF.                                                      18540099
185500                                                                  18550099
185600                                                                  18560099
185700*----------------------------------------------------------------*18570099
185800* GETS MAX A/C SEQ NUMBER FOR THIS PAYMENT REQ                   *18580099
185900*----------------------------------------------------------------*18590099
186000 5210-SELECT-MAX-SEQ-NBR.                                         18600099
186100                                                                  18610099
186200     PERFORM                                                      18620099
186300         WITH TEST AFTER                                          18630099
186400         VARYING PV-RETRY-COUNTER                                 18640099
186500         FROM 1 BY 1                                              18650099
186600         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               18660099
186700                   OR (SQLCODE = ZERO)                            18670099
186800                   OR (SQLCODE = -305))                           18680099
186900                                                                  18690099
187000         EXEC SQL                                                 18700099
187100             SELECT MAX(ALW_CHRG_SEQ_NBR)                         18710099
187200             INTO   :ALCHRG-ALW-CHRG-SEQ-NBR                      18720099
187300             FROM   TALCHRG                                       18730099
187400             WHERE  PO_NBR  = :ASC-SAVE-PO-NBR                    18740099
187500               AND  INVC_ID = :ASC-SAVE-INVC-ID                   18750099
187600         END-EXEC                                                 18760099
187700                                                                  18770099
187800         EVALUATE TRUE                                            18780099
187900             WHEN SQLCODE = ZERO                                  18790099
188000                 CONTINUE                                         18800099
188100             WHEN SQLCODE = -305                                  18810099
188200                 MOVE +0             TO ALCHRG-ALW-CHRG-SEQ-NBR   18820099
188300             WHEN SQLCODE = -904                                  18830099
188400             WHEN SQLCODE = -913                                  18840099
188500                 CONTINUE                                         18850099
188600             WHEN SQLWARN0 NOT = SPACES                           18860099
188700             WHEN SQLCODE < ZERO                                  18870099
188800             WHEN SQLCODE > ZERO                                  18880099
188900                 MOVE '5210-SELECT-MAX-SEQ-NBR'                   18890099
189000                                   TO DP013-PARAGRAPH             18900099
189100                 MOVE 'SELECT MAX SEQ NBR     '                   18910099
189200                                   TO DP013-MESSAGE-TEXT (1)      18920099
189300                 MOVE SQLCA        TO DP013-SQLCA                 18930099
189400                 MOVE 'TALCHRG'    TO DP013-DB2-TABLE-NAME (1)    18940099
189500                 SET DP013-DB2-ABEND                              18950099
189600                     DP013-XCTL-DISPLAY-RESTART                   18960099
189700                                   TO TRUE                        18970099
189800                 PERFORM DP013-0000-PROCESS-ABEND                 18980099
189900         END-EVALUATE                                             18990099
190000     END-PERFORM.                                                 19000099
190100                                                                  19010099
190200     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        19020099
190300         MOVE '5210-SELECT-MAX-SEQ-NBR'                           19030099
190400                                   TO DP013-PARAGRAPH             19040099
190500         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO SELECT'     19050099
190600                                   TO DP013-MESSAGE-TEXT (1)      19060099
190700         MOVE 'SEQ NBR      '      TO DP013-MESSAGE-TEXT (2)      19070099
190800         MOVE SQLCA                TO DP013-SQLCA                 19080099
190900         MOVE 'TALCHRG'            TO DP013-DB2-TABLE-NAME (1)    19090099
191000         SET DP013-DB2-ABEND                                      19100099
191100             DP013-XCTL-DISPLAY-RESTART                           19110099
191200                                   TO TRUE                        19120099
191300         PERFORM DP013-0000-PROCESS-ABEND                         19130099
191400     END-IF.                                                      19140099
191500                                                                  19150099
191600                                                                  19160099
191700*----------------------------------------------------------------*19170099
191800* UPDATES TALCHRG TABLE                                          *19180099
191900*----------------------------------------------------------------*19190099
192000 5300-UPDATE-TALCHRG.                                             19200099
192100                                                                  19210099
192200     MOVE ASC-AC-SEQ-NBR (PV-SUB) TO ALCHRG-ALW-CHRG-SEQ-NBR.     19220099
192300     MOVE ASC-AC-IND (PV-SUB)     TO ALCHRG-ALW-CHRG-TYP-CDE.     19230099
192400     MOVE ASC-AC-CDE (PV-SUB)     TO ALCHRG-ALW-CHRG-CDE.         19240099
192500     COMPUTE ALCHRG-ALW-CHRG-PCT = ASC-AC-PCT-N(PV-SUB) / 100.    19250099
192600     MOVE ASC-AC-AMT-N (PV-SUB)   TO ALCHRG-ALW-CHRG-AMT.         19260099
192700     MOVE ASC-SS-CDE (PV-SUB)     TO ALCHRG-ALW-CHRG-SER-CDE.     19270099
192800                                                                  19280099
192900     PERFORM                                                      19290099
193000         WITH TEST AFTER                                          19300099
193100         VARYING PV-RETRY-COUNTER                                 19310099
193200         FROM 1 BY 1                                              19320099
193300         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               19330099
193400             OR (SQLCODE = +0))                                   19340099
193500                                                                  19350099
193600         EXEC SQL                                                 19360099
193700              UPDATE TALCHRG                                      19370099
193800                 SET ALW_CHRG_TYP_CDE = :ALCHRG-ALW-CHRG-TYP-CDE  19380099
193900                    ,ALW_CHRG_CDE = :ALCHRG-ALW-CHRG-CDE          19390099
194000                    ,ALW_CHRG_SER_CDE = :ALCHRG-ALW-CHRG-SER-CDE  19400099
194100                    ,ALW_CHRG_PCT = :ALCHRG-ALW-CHRG-PCT          19410099
194200                    ,ALW_CHRG_AMT = :ALCHRG-ALW-CHRG-AMT          19420099
194300              WHERE PO_NBR           = :ASC-SAVE-PO-NBR           19430099
194400                AND INVC_ID          = :ASC-SAVE-INVC-ID          19440099
194500                AND ALW_CHRG_SEQ_NBR = :ALCHRG-ALW-CHRG-SEQ-NBR   19450099
194600         END-EXEC                                                 19460099
194700                                                                  19470099
194800         EVALUATE TRUE                                            19480099
194900             WHEN SQLCODE = +0                                    19490099
195000             WHEN SQLCODE = -904                                  19500099
195100             WHEN SQLCODE = -913                                  19510099
195200                  CONTINUE                                        19520099
195300                                                                  19530099
195400             WHEN SQLWARN0 NOT = SPACES                           19540099
195500             WHEN SQLCODE < +0                                    19550099
195600             WHEN SQLCODE > +0                                    19560099
195700                  MOVE '5300-UPDATE-TALCHRG'                      19570099
195800                                  TO DP013-PARAGRAPH              19580099
195900                  MOVE 'UNSUCCESSFUL UPDATE OF TALCHRG'           19590099
196000                                  TO DP013-MESSAGE-TEXT (1)       19600099
196100                  MOVE SQLCA      TO DP013-SQLCA                  19610099
196200                  MOVE 'TALCHRG ' TO DP013-DB2-TABLE-NAME (1)     19620099
196300                  SET DP013-DB2-ABEND                             19630099
196400                      DP013-XCTL-DISPLAY-RESTART                  19640099
196500                                  TO TRUE                         19650099
196600                  PERFORM DP013-0000-PROCESS-ABEND                19660099
196700         END-EVALUATE                                             19670099
196800     END-PERFORM.                                                 19680099
196900                                                                  19690099
197000     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        19700099
197100         MOVE '5300-UPDATE-TALCHRG'                               19710099
197200                                  TO DP013-PARAGRAPH              19720099
197300         MOVE 'MAX RETRIES EXCEEDED FOR UPDATE ON TALCHRG'        19730099
197400                                  TO DP013-MESSAGE-TEXT (1)       19740099
197500         MOVE SQLCA               TO DP013-SQLCA                  19750099
197600         MOVE 'TALCHRG '          TO DP013-DB2-TABLE-NAME (1)     19760099
197700         SET DP013-DB2-ABEND                                      19770099
197800             DP013-XCTL-DISPLAY-RESTART                           19780099
197900                                  TO TRUE                         19790099
198000         PERFORM DP013-0000-PROCESS-ABEND                         19800099
198100     END-IF.                                                      19810099
198200                                                                  19820099
198300                                                                  19830099
198400*----------------------------------------------------------------*19840099
198500* CONTROLS PROCESSING TO SEE IF INVOICE SHOULD BE SET ON HOLD    *19850099
198600*----------------------------------------------------------------*19860099
198700 5400-HOLD-CHECK.                                                 19870099
198800                                                                  19880099
198900     PERFORM 5410-SELECT-LIMIT-AMT.                               19890099
199000     IF ALCHRG-ALW-CHRG-AMT > +0                                  19900099
199100         MOVE ALCHRG-ALW-CHRG-AMT TO PV-CHRG-AMT                  19910099
199200     ELSE                                                         19920099
199300         PERFORM 5420-SELECT-GRO-COST-AMT                         19930099
199400         COMPUTE PV-CHRG-AMT =                                    19940099
199500                   ALCHRG-ALW-CHRG-PCT * INVOIC-GRO-COST-AMT      19950099
199600     END-IF.                                                      19960099
199700     IF PV-CHRG-AMT > APCNTL-CHRG-LIMIT-AMT                       19970099
199800         PERFORM 5430-UPDATE-TINVOIC                              19980099
199900     END-IF.                                                      19990099
200000                                                                  20000099
200100                                                                  20010099
200200*----------------------------------------------------------------*20020099
200300* SELECT LIMIT AMT FROM TAPCNTL                                  *20030099
200400*----------------------------------------------------------------*20040099
200500 5410-SELECT-LIMIT-AMT.                                           20050099
200600                                                                  20060099
200700     PERFORM                                                      20070099
200800         WITH TEST AFTER                                          20080099
200900         VARYING PV-RETRY-COUNTER                                 20090099
201000         FROM 1 BY 1                                              20100099
201100         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               20110099
201200                   OR (SQLCODE = ZERO))                           20120099
201300                                                                  20130099
201400         EXEC SQL                                                 20140099
201500             SELECT CHRG_LIMIT_AMT                                20150099
201600             INTO   :APCNTL-CHRG-LIMIT-AMT                        20160099
201700             FROM   TAPCNTL                                       20170099
201800         END-EXEC                                                 20180099
201900                                                                  20190099
202000         EVALUATE TRUE                                            20200099
202100             WHEN SQLCODE = ZERO                                  20210099
202200                 CONTINUE                                         20220099
202300             WHEN SQLCODE = -904                                  20230099
202400             WHEN SQLCODE = -913                                  20240099
202500                 CONTINUE                                         20250099
202600             WHEN SQLWARN0 NOT = SPACES                           20260099
202700             WHEN SQLCODE < ZERO                                  20270099
202800             WHEN SQLCODE > ZERO                                  20280099
202900                 MOVE '5410-SELECT-LIMIT-AMT'                     20290099
203000                                   TO DP013-PARAGRAPH             20300099
203100                 MOVE 'SELECT LIMIT AMT       '                   20310099
203200                                   TO DP013-MESSAGE-TEXT (1)      20320099
203300                 MOVE SQLCA        TO DP013-SQLCA                 20330099
203400                 MOVE 'TAPCNTL'    TO DP013-DB2-TABLE-NAME (1)    20340099
203500                 SET DP013-DB2-ABEND                              20350099
203600                     DP013-XCTL-DISPLAY-RESTART                   20360099
203700                                   TO TRUE                        20370099
203800                 PERFORM DP013-0000-PROCESS-ABEND                 20380099
203900         END-EVALUATE                                             20390099
204000     END-PERFORM.                                                 20400099
204100                                                                  20410099
204200     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        20420099
204300         MOVE '5410-SELECT-LIMIT-AMT   '                          20430099
204400                                   TO DP013-PARAGRAPH             20440099
204500         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO SELECT'     20450099
204600                                   TO DP013-MESSAGE-TEXT (1)      20460099
204700         MOVE 'LIMIT AMT    '      TO DP013-MESSAGE-TEXT (2)      20470099
204800         MOVE SQLCA                TO DP013-SQLCA                 20480099
204900         MOVE 'TAPCNTL'            TO DP013-DB2-TABLE-NAME (1)    20490099
205000         SET DP013-DB2-ABEND                                      20500099
205100             DP013-XCTL-DISPLAY-RESTART                           20510099
205200                                   TO TRUE                        20520099
205300         PERFORM DP013-0000-PROCESS-ABEND                         20530099
205400     END-IF.                                                      20540099
205500                                                                  20550099
205600                                                                  20560099
205700*----------------------------------------------------------------*20570099
205800* SELECT GROSS COST AMOUNT FROM TINVOIC                          *20580099
205900*----------------------------------------------------------------*20590099
206000 5420-SELECT-GRO-COST-AMT.                                        20600099
206100                                                                  20610099
206200     PERFORM                                                      20620099
206300         WITH TEST AFTER                                          20630099
206400         VARYING PV-RETRY-COUNTER                                 20640099
206500         FROM 1 BY 1                                              20650099
206600         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               20660099
206700                   OR (SQLCODE = ZERO))                           20670099
206800                                                                  20680099
206900         EXEC SQL                                                 20690099
207000             SELECT GRO_COST_AMT                                  20700099
207100             INTO   :INVOIC-GRO-COST-AMT                          20710099
207200             FROM   TINVOIC                                       20720099
207300             WHERE  PO_NBR       = :ASC-SAVE-PO-NBR               20730099
207400               AND  INVC_ID      = :ASC-SAVE-INVC-ID              20740099
207500         END-EXEC                                                 20750099
207600                                                                  20760099
207700         EVALUATE TRUE                                            20770099
207800             WHEN SQLCODE = ZERO                                  20780099
207900                 CONTINUE                                         20790099
208000             WHEN SQLCODE = -904                                  20800099
208100             WHEN SQLCODE = -913                                  20810099
208200                 CONTINUE                                         20820099
208300             WHEN SQLWARN0 NOT = SPACES                           20830099
208400             WHEN SQLCODE < ZERO                                  20840099
208500             WHEN SQLCODE > ZERO                                  20850099
208600                 MOVE '5420-SELECT-GRO-COST-AMT'                  20860099
208700                                   TO DP013-PARAGRAPH             20870099
208800                 MOVE 'SELECT GROSS COST AMT  '                   20880099
208900                                   TO DP013-MESSAGE-TEXT (1)      20890099
209000                 MOVE SQLCA        TO DP013-SQLCA                 20900099
209100                 MOVE 'TINVOIC'    TO DP013-DB2-TABLE-NAME (1)    20910099
209200                 SET DP013-DB2-ABEND                              20920099
209300                     DP013-XCTL-DISPLAY-RESTART                   20930099
209400                                   TO TRUE                        20940099
209500                 PERFORM DP013-0000-PROCESS-ABEND                 20950099
209600         END-EVALUATE                                             20960099
209700     END-PERFORM.                                                 20970099
209800                                                                  20980099
209900     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        20990099
210000         MOVE '5420-SELECT-GRO-COST-AMT'                          21000099
210100                                   TO DP013-PARAGRAPH             21010099
210200         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO SELECT'     21020099
210300                                   TO DP013-MESSAGE-TEXT (1)      21030099
210400         MOVE 'GROSS COST AM'      TO DP013-MESSAGE-TEXT (2)      21040099
210500         MOVE SQLCA                TO DP013-SQLCA                 21050099
210600         MOVE 'TINVOIC'            TO DP013-DB2-TABLE-NAME (1)    21060099
210700         SET DP013-DB2-ABEND                                      21070099
210800             DP013-XCTL-DISPLAY-RESTART                           21080099
210900                                   TO TRUE                        21090099
211000         PERFORM DP013-0000-PROCESS-ABEND                         21100099
211100     END-IF.                                                      21110099
211200                                                                  21120099
211300                                                                  21130099
211400*----------------------------------------------------------------*21140099
211500* UPDATES TINVOIC TABLE                                          *21150099
211600*----------------------------------------------------------------*21160099
211700 5430-UPDATE-TINVOIC.                                             21170099
211800                                                                  21180099
211900     MOVE 'Y'                     TO INVOIC-HOLD-IND.             21190099
212000                                                                  21200099
212100     PERFORM                                                      21210099
212200         WITH TEST AFTER                                          21220099
212300         VARYING PV-RETRY-COUNTER                                 21230099
212400         FROM 1 BY 1                                              21240099
212500         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               21250099
212600             OR (SQLCODE = +0))                                   21260099
212700                                                                  21270099
212800         EXEC SQL                                                 21280099
212900              UPDATE TINVOIC                                      21290099
213000                 SET HOLD_IND = :INVOIC-HOLD-IND                  21300099
213100              WHERE  PO_NBR       = :ASC-SAVE-PO-NBR              21310099
213200                AND  INVC_ID      = :ASC-SAVE-INVC-ID             21320099
213300         END-EXEC                                                 21330099
213400                                                                  21340099
213500         EVALUATE TRUE                                            21350099
213600             WHEN SQLCODE = +0                                    21360099
213700             WHEN SQLCODE = -904                                  21370099
213800             WHEN SQLCODE = -913                                  21380099
213900                  CONTINUE                                        21390099
214000                                                                  21400099
214100             WHEN SQLWARN0 NOT = SPACES                           21410099
214200             WHEN SQLCODE < +0                                    21420099
214300             WHEN SQLCODE > +0                                    21430099
214400                  MOVE '5430-UPDATE-TINVOIC'                      21440099
214500                                  TO DP013-PARAGRAPH              21450099
214600                  MOVE 'UNSUCCESSFUL UPDATE OF TINVOIC'           21460099
214700                                  TO DP013-MESSAGE-TEXT (1)       21470099
214800                  MOVE SQLCA      TO DP013-SQLCA                  21480099
214900                  MOVE 'TINVOIC ' TO DP013-DB2-TABLE-NAME (1)     21490099
215000                  SET DP013-DB2-ABEND                             21500099
215100                      DP013-XCTL-DISPLAY-RESTART                  21510099
215200                                  TO TRUE                         21520099
215300                  PERFORM DP013-0000-PROCESS-ABEND                21530099
215400         END-EVALUATE                                             21540099
215500     END-PERFORM.                                                 21550099
215600                                                                  21560099
215700*----------------------------------------------------------------*21570099
215800* UPDATES TINVOIC TABLE                                          *21580099
215900*----------------------------------------------------------------*21590099
216000 5500-UPDATE-TINVOIC.                                             21600099
216100                                                                  21610099
216200     PERFORM                                                      21620099
216300         WITH TEST AFTER                                          21630099
216400         VARYING PV-RETRY-COUNTER                                 21640099
216500         FROM 1 BY 1                                              21650099
216600         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               21660099
216700             OR (SQLCODE = +0))                                   21670099
216800                                                                  21680099
216900         EXEC SQL                                                 21690099
217000              UPDATE TINVOIC                                      21700099
217100                 SET STATUS_CDE   = :INVOIC-STATUS-CDE            21710099
217200                    ,GRO_COST_AMT = :ASC-NEW-GRO-COST-AMT         21720099
217300              WHERE  PO_NBR       = :ASC-SAVE-PO-NBR              21730099
217400                AND  INVC_ID      = :ASC-SAVE-INVC-ID             21740099
217500         END-EXEC                                                 21750099
217600                                                                  21760099
217700         EVALUATE TRUE                                            21770099
217800             WHEN SQLCODE = +0                                    21780099
217900                 SET INVOICE-UPDATED      TO TRUE                 21790099
218000                 MOVE ASC-SAVE-INVC-STATUS TO ASC-OLD-INVC-STATUS 21800099
218100                 MOVE INVOIC-STATUS-CDE   TO ASC-SAVE-INVC-STATUS 21810099
218200                 MOVE ASC-NEW-GRO-COST-AMT                        21820099
218300                                          TO ASC-SAVE-GRO-COST-AMT21830099
218400                 MOVE ASC-NEW-NET-INVC-AMT                        21840099
218500                                          TO ASC-SAVE-NET-INVC-AMT21850099
218600             WHEN SQLCODE = -904                                  21860099
218700             WHEN SQLCODE = -913                                  21870099
218800                  CONTINUE                                        21880099
218900                                                                  21890099
219000             WHEN SQLWARN0 NOT = SPACES                           21900099
219100             WHEN SQLCODE < +0                                    21910099
219200             WHEN SQLCODE > +0                                    21920099
219300                  MOVE '5430-UPDATE-TINVOIC'                      21930099
219400                                  TO DP013-PARAGRAPH              21940099
219500                  MOVE 'UNSUCCESSFUL UPDATE OF TINVOIC'           21950099
219600                                  TO DP013-MESSAGE-TEXT (1)       21960099
219700                  MOVE SQLCA      TO DP013-SQLCA                  21970099
219800                  MOVE 'TINVOIC ' TO DP013-DB2-TABLE-NAME (1)     21980099
219900                  SET DP013-DB2-ABEND                             21990099
220000                      DP013-XCTL-DISPLAY-RESTART                  22000099
220100                                  TO TRUE                         22010099
220200                  PERFORM DP013-0000-PROCESS-ABEND                22020099
220300         END-EVALUATE                                             22030099
220400     END-PERFORM.                                                 22040099
220500                                                                  22050099
220600     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        22060099
220700         MOVE '5430-UPDATE-TINVOIC'                               22070099
220800                                  TO DP013-PARAGRAPH              22080099
220900         MOVE 'MAX RETRIES EXCEEDED FOR UPDATE ON TINVOIC'        22090099
221000                                  TO DP013-MESSAGE-TEXT (1)       22100099
221100         MOVE SQLCA               TO DP013-SQLCA                  22110099
221200         MOVE 'TINVOIC '          TO DP013-DB2-TABLE-NAME (1)     22120099
221300         SET DP013-DB2-ABEND                                      22130099
221400             DP013-XCTL-DISPLAY-RESTART                           22140099
221500                                  TO TRUE                         22150099
221600         PERFORM DP013-0000-PROCESS-ABEND                         22160099
221700     END-IF.                                                      22170099
221800                                                                  22180099
221900 5700-UPDATE-ENTER-DATE.                                          22190099
222000                                                                  22200099
222100     PERFORM                                                      22210099
222200         WITH TEST AFTER                                          22220099
222300         VARYING PV-RETRY-COUNTER                                 22230099
222400         FROM 1 BY 1                                              22240099
222500         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               22250099
222600             OR (SQLCODE = +0))                                   22260099
222700                                                                  22270099
222800         EXEC SQL UPDATE TINVOIC                                  22280099
222900             SET CRE_DTE           = :ASC-CURRENT-DATE            22290099
223000              WHERE  PO_NBR        = :ASC-SAVE-PO-NBR             22300099
223100                AND  INVC_ID       = :ASC-SAVE-INVC-ID            22310099
223200         END-EXEC                                                 22320099
223300                                                                  22330099
223400         EVALUATE TRUE                                            22340099
223500             WHEN SQLCODE = +0                                    22350099
223600             WHEN SQLCODE = -904                                  22360099
223700             WHEN SQLCODE = -913                                  22370099
223800                 CONTINUE                                         22380099
223900                                                                  22390099
224000             WHEN SQLWARN0 NOT = SPACES                           22400099
224100             WHEN SQLCODE < +0                                    22410099
224200             WHEN SQLCODE > +0                                    22420099
224300                 MOVE '5700-UPDATE-ENTER-DATE'                    22430099
224400                                   TO DP013-PARAGRAPH             22440099
224500                 MOVE 'UNSUCCESSFUL UPDATE ON TINVOIC'            22450099
224600                                   TO DP013-MESSAGE-TEXT(1)       22460099
224700                 MOVE SQLCA        TO DP013-SQLCA                 22470099
224800                 MOVE 'TINVOIC'    TO DP013-DB2-TABLE-NAME (1)    22480099
224900                 SET DP013-DB2-ABEND                              22490099
225000                     DP013-XCTL-DISPLAY-RESTART TO TRUE           22500099
225100                 PERFORM DP013-0000-PROCESS-ABEND                 22510099
225200         END-EVALUATE                                             22520099
225300     END-PERFORM.                                                 22530099
225400                                                                  22540099
225500     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        22550099
225600         MOVE '5700-UPDATE-ENTER-DATE' TO DP013-PARAGRAPH         22560099
225700         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING '              22570099
225800                                   TO DP013-MESSAGE-TEXT (1)      22580099
225900         MOVE 'TO UPDATE A TINVOIC ROW'                           22590099
226000                                   TO DP013-MESSAGE-TEXT (2)      22600099
226100         MOVE SQLCA                TO DP013-SQLCA                 22610099
226200         MOVE 'TINVOIC'            TO DP013-DB2-TABLE-NAME (1)    22620099
226300         SET DP013-DB2-ABEND                                      22630099
226400             DP013-XCTL-DISPLAY-RESTART                           22640099
226500                                   TO TRUE                        22650099
226600         PERFORM DP013-0000-PROCESS-ABEND                         22660099
226700     END-IF.                                                      22670099
226800                                                                  22680099
226900                                                                  22690099
227000*----------------------------------------------------------------*22700099
227100* CONTROLS DELETING OF ALLOWANCES/CHARGES                        *22710099
227200*----------------------------------------------------------------*22720099
227300 6000-DELETE-AC.                                                  22730099
227400                                                                  22740099
227500     PERFORM 6100-DELETE-AC-LINES                                 22750099
227600         VARYING PV-SUB                                           22760099
227700         FROM 1 BY 1                                              22770099
227800         UNTIL PV-SUB > PC-MAX-ALLW-CHRG-LINES.                   22780099
227900                                                                  22790099
228000     PERFORM 8000-CHECK-INVOIC-STATUS.                            22800099
228100                                                                  22810099
228200*----------------------------------------------------------------*22820099
228300* IF SELECTED DELETE  ALLOWANCES/CHARGES                         *22830099
228400*----------------------------------------------------------------*22840099
228500 6100-DELETE-AC-LINES.                                            22850099
228600                                                                  22860099
228700     IF ASC-SELECT (PV-SUB) = 'S' AND                             22870099
228800        ASC-AC-SEQ-NBR (PV-SUB) > +0                              22880099
228900         PERFORM 6200-DELETE-TALCHRG                              22890099
229000     END-IF.                                                      22900099
229100                                                                  22910099
229200                                                                  22920099
229300*----------------------------------------------------------------*22930099
229400* DELETES TALCHRG TABLE                                          *22940099
229500*----------------------------------------------------------------*22950099
229600 6200-DELETE-TALCHRG.                                             22960099
229700                                                                  22970099
229800     MOVE ASC-AC-SEQ-NBR (PV-SUB) TO ALCHRG-ALW-CHRG-SEQ-NBR.     22980099
229900                                                                  22990099
230000     PERFORM                                                      23000099
230100         WITH TEST AFTER                                          23010099
230200         VARYING PV-RETRY-COUNTER                                 23020099
230300         FROM 1 BY 1                                              23030099
230400         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               23040099
230500             OR (SQLCODE = +0))                                   23050099
230600                                                                  23060099
230700         EXEC SQL                                                 23070099
230800              DELETE FROM TALCHRG                                 23080099
230900              WHERE PO_NBR           = :ASC-SAVE-PO-NBR           23090099
231000                AND INVC_ID          = :ASC-SAVE-INVC-ID          23100099
231100                AND ALW_CHRG_SEQ_NBR = :ALCHRG-ALW-CHRG-SEQ-NBR   23110099
231200         END-EXEC                                                 23120099
231300                                                                  23130099
231400         EVALUATE TRUE                                            23140099
231500             WHEN SQLCODE = +0                                    23150099
231600             WHEN SQLCODE = -904                                  23160099
231700             WHEN SQLCODE = -913                                  23170099
231800                  CONTINUE                                        23180099
231900                                                                  23190099
232000             WHEN SQLWARN0 NOT = SPACES                           23200099
232100             WHEN SQLCODE < +0                                    23210099
232200             WHEN SQLCODE > +0                                    23220099
232300                  MOVE '6200-DELETE-TALCHRG'                      23230099
232400                                  TO DP013-PARAGRAPH              23240099
232500                  MOVE 'UNSUCCESSFUL DELETE OF TALCHRG'           23250099
232600                                  TO DP013-MESSAGE-TEXT (1)       23260099
232700                  MOVE SQLCA      TO DP013-SQLCA                  23270099
232800                  MOVE 'TALCHRG ' TO DP013-DB2-TABLE-NAME (1)     23280099
232900                  SET DP013-DB2-ABEND                             23290099
233000                      DP013-XCTL-DISPLAY-RESTART                  23300099
233100                                  TO TRUE                         23310099
233200                  PERFORM DP013-0000-PROCESS-ABEND                23320099
233300         END-EVALUATE                                             23330099
233400     END-PERFORM.                                                 23340099
233500                                                                  23350099
233600     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        23360099
233700         MOVE '6200-DELETE-TALCHRG'                               23370099
233800                                  TO DP013-PARAGRAPH              23380099
233900         MOVE 'MAX RETRIES EXCEEDED FOR DELETE ON TALCHRG'        23390099
234000                                  TO DP013-MESSAGE-TEXT (1)       23400099
234100         MOVE SQLCA               TO DP013-SQLCA                  23410099
234200         MOVE 'TALCHRG '          TO DP013-DB2-TABLE-NAME (1)     23420099
234300         SET DP013-DB2-ABEND                                      23430099
234400             DP013-XCTL-DISPLAY-RESTART                           23440099
234500                                  TO TRUE                         23450099
234600         PERFORM DP013-0000-PROCESS-ABEND                         23460099
234700     END-IF.                                                      23470099
234800                                                                  23480099
234900 8000-CHECK-INVOIC-STATUS.                                        23490099
235000                                                                  23500099
235100     SET INVOICE-NOT-UPDATED      TO TRUE                         23510099
235200     MOVE ASC-SAVE-INVC-STATUS TO INVOIC-STATUS-CDE               23520099
235300                                                                  23530099
235400     PERFORM 8100-OPEN-AC-CSR.                                    23540099
235500     SET PS-NOT-END-OF-CSR         TO TRUE.                       23550099
235600     MOVE +0                     TO PV-SUB                        23560099
235700                                    ASC-TOT-CHARGES               23570099
235800                                    ASC-TOT-ALLOWS                23580099
235900                                    PV-TOT-ALLW-AMT.              23590099
236000     PERFORM 8200-PROCESS-AC-CSR                                  23600099
236100         UNTIL PS-END-OF-CSR.                                     23610099
236200     PERFORM 8300-CLOSE-AC-CSR.                                   23620099
236300                                                                  23630099
236400     COMPUTE ASC-SAVE-CALC-INVC-AMT = ASC-NEW-GRO-COST-AMT +      23640099
236500                      ASC-TOT-CHARGES - PV-TOT-ALLW-AMT.          23650099
236600*                                     ASC-TOT-CHARGES             23660099
236700                                                                  23670099
236800     MOVE  ASC-SAVE-CALC-INVC-AMT TO ASC-NEW-CALC-INVC-AMT        23680099
236900                                                                  23690099
237000     IF ASC-NEW-NET-INVC-AMT NOT = ASC-NEW-CALC-INVC-AMT          23700099
237100         MOVE 'OB'               TO INVOIC-STATUS-CDE             23710099
237200     ELSE                                                         23720099
237300         IF ((ASC-NEW-GRO-COST-AMT NOT = ASC-CALC-PREQIT-COST)    23730099
237400                  AND                                             23740099
237500              ASC-CALC-PREQIT-COST > +0 )                         23750099
237600             MOVE 'IB'     TO INVOIC-STATUS-CDE                   23760099
237700         ELSE                                                     23770099
237800             MOVE 'EN'     TO INVOIC-STATUS-CDE                   23780099
237900         END-IF                                                   23790099
238000     END-IF.                                                      23800099
238100                                                                  23810099
238200*    IF THE STATUS CHANGED OR THE GROSS COST AMOUNT CHANGED,      23820099
238300*    UPDATE TINVOIC.                                              23830099
238400                                                                  23840099
238500     IF INVOIC-STATUS-CDE    NOT = ASC-SAVE-INVC-STATUS  OR       23850099
238600        ASC-NEW-GRO-COST-AMT NOT = ASC-SAVE-GRO-COST-AMT          23860099
238700         PERFORM 5500-UPDATE-TINVOIC                              23870099
238800     END-IF.                                                      23880099
238900                                                                  23890099
239000*    FOR EXPENSE INVOICES ONLY, IF THE STATUS IS CHANGED TO 'EN'  23900099
239100*    FROM 'IB' OR 'OB', UPDATE THE CRE_DTE ON TINVOIC TO          23910099
239200*    TODAY'S DATE.                                                23920099
239300                                                                  23930099
239400     IF ASC-EXPENSE-INVC                                          23940099
239500        IF INVOIC-STATUS-CDE     = 'EN' AND                       23950099
239600           (ASC-OLD-INVC-STATUS  = 'IB' OR 'OB')                  23960099
239700            PERFORM 5700-UPDATE-ENTER-DATE                        23970099
239800        END-IF                                                    23980099
239900     END-IF.                                                      23990099
240000                                                                  24000099
240100                                                                  24010099
240200*----------------------------------------------------------------*24020099
240300* OPENS AC CSR                                                   *24030099
240400*----------------------------------------------------------------*24040099
240500 8100-OPEN-AC-CSR.                                                24050099
240600                                                                  24060099
240700     PERFORM                                                      24070099
240800         WITH TEST AFTER                                          24080099
240900         VARYING PV-RETRY-COUNTER                                 24090099
241000         FROM 1 BY 1                                              24100099
241100         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               24110099
241200                   OR (SQLCODE = ZERO))                           24120099
241300             EXEC SQL                                             24130099
241400                  OPEN AC-CSR                                     24140099
241500             END-EXEC                                             24150099
241600                                                                  24160099
241700         EVALUATE TRUE                                            24170099
241800             WHEN SQLCODE = ZERO                                  24180099
241900             WHEN SQLCODE = -904                                  24190099
242000             WHEN SQLCODE = -913                                  24200099
242100                 CONTINUE                                         24210099
242200             WHEN SQLWARN0 NOT = SPACES                           24220099
242300             WHEN SQLCODE < ZERO                                  24230099
242400             WHEN SQLCODE > ZERO                                  24240099
242500                 MOVE '8100-OPEN-AC-CSR'                          24250099
242600                                   TO DP013-PARAGRAPH             24260099
242700                 MOVE 'OPEN AC CURSOR - '                         24270099
242800                                   TO DP013-MESSAGE-TEXT (1)      24280099
242900                 MOVE SQLCA        TO DP013-SQLCA                 24290099
243000                 MOVE 'TALCHRG '   TO DP013-DB2-TABLE-NAME (1)    24300099
243100                 SET DP013-DB2-ABEND                              24310099
243200                     DP013-XCTL-DISPLAY-RESTART TO TRUE           24320099
243300                 PERFORM DP013-0000-PROCESS-ABEND                 24330099
243400         END-EVALUATE                                             24340099
243500     END-PERFORM.                                                 24350099
243600                                                                  24360099
243700     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        24370099
243800         MOVE '8100-OPEN-AC-CSR' TO DP013-PARAGRAPH               24380099
243900         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO OPEN CSR'   24390099
244000                                   TO DP013-MESSAGE-TEXT (1)      24400099
244100         MOVE SQLCA                TO DP013-SQLCA                 24410099
244200         MOVE 'TALCHRG '           TO DP013-DB2-TABLE-NAME (1)    24420099
244300         SET DP013-DB2-ABEND                                      24430099
244400             DP013-XCTL-DISPLAY-RESTART                           24440099
244500                                   TO TRUE                        24450099
244600         PERFORM DP013-0000-PROCESS-ABEND                         24460099
244700     END-IF.                                                      24470099
244800                                                                  24480099
244900                                                                  24490099
245000*----------------------------------------------------------------*24500099
245100* FETCHS ROWS FROM AC CSR                                        *24510099
245200*----------------------------------------------------------------*24520099
245300 8200-PROCESS-AC-CSR.                                             24530099
245400                                                                  24540099
245500     EXEC SQL                                                     24550099
245600          FETCH AC-CSR                                            24560099
245700          INTO  :ALCHRG-ALW-CHRG-SEQ-NBR                          24570099
245800               ,:ALCHRG-ALW-CHRG-TYP-CDE                          24580099
245900               ,:ALCHRG-ALW-CHRG-CDE                              24590099
246000               ,:ALCHRG-ALW-CHRG-SER-CDE                          24600099
246100               ,:ALCHRG-ALW-CHRG-PCT                              24610099
246200               ,:ALCHRG-ALW-CHRG-AMT                              24620099
246300     END-EXEC                                                     24630099
246400                                                                  24640099
246500     EVALUATE TRUE                                                24650099
246600         WHEN SQLCODE = ZERO                                      24660099
246700              ADD +1               TO PV-SUB                      24670099
246800              MOVE ALCHRG-ALW-CHRG-SEQ-NBR                        24680099
246900                                   TO ASC-AC-SEQ-NBR (PV-SUB)     24690099
247000              MOVE ALCHRG-ALW-CHRG-TYP-CDE                        24700099
247100                                   TO ASC-AC-IND (PV-SUB)         24710099
247200              MOVE ALCHRG-ALW-CHRG-CDE                            24720099
247300                                   TO ASC-AC-CDE (PV-SUB)         24730099
247400              MOVE ALCHRG-ALW-CHRG-SER-CDE                        24740099
247500                                   TO ASC-SS-CDE (PV-SUB)         24750099
247600              COMPUTE ASC-AC-PCT-N (PV-SUB)                       24760099
247700                                 = ALCHRG-ALW-CHRG-PCT * 100      24770099
247800              IF ALCHRG-ALW-CHRG-TYP-CDE = 'C'                    24780099
247900                  COMPUTE ASC-TOT-CHARGES =                       24790099
248000                          ((ASC-AC-PCT-N(PV-SUB) *                24800099
248100                            ASC-SAVE-GRO-COST-AMT) * .01)         24810099
248200                          + ALCHRG-ALW-CHRG-AMT + ASC-TOT-CHARGES 24820099
248300              ELSE                                                24830099
248400                  COMPUTE ASC-TOT-ALLOWS =                        24840099
248500                          ((ASC-AC-PCT-N(PV-SUB) *                24850099
248600                            ASC-SAVE-GRO-COST-AMT) * .01)         24860099
248700                          + ALCHRG-ALW-CHRG-AMT + ASC-TOT-ALLOWS  24870099
248800                  ADD ALCHRG-ALW-CHRG-AMT                         24880099
248900                                   TO PV-TOT-ALLW-AMT             24890099
249000              END-IF                                              24900099
249100              MOVE ASC-AC-PCT-N (PV-SUB)                          24910099
249200                                   TO PV-PCT-DIS                  24920099
249300              MOVE PV-PCT-DIS      TO ASC-AC-PCT (PV-SUB)         24930099
249400              MOVE ALCHRG-ALW-CHRG-AMT                            24940099
249500                                   TO ASC-AC-AMT-N (PV-SUB)       24950099
249600                                      PV-AMT-DIS                  24960099
249700              MOVE PV-AMT-DIS      TO ASC-AC-AMT (PV-SUB)         24970099
249800         WHEN SQLCODE = +100                                      24980099
249900             SET PS-END-OF-CSR     TO TRUE                        24990099
250000         WHEN SQLWARN0 NOT = SPACE                                25000099
250100         WHEN SQLCODE NOT = ZERO                                  25010099
250200              MOVE '8200-FETCH-AC-CSR'                            25020099
250300                                   TO DP013-PARAGRAPH             25030099
250400              MOVE 'FETCH AC CURSOR'                              25040099
250500                                   TO DP013-MESSAGE-TEXT (1)      25050099
250600              MOVE SQLCA           TO DP013-SQLCA                 25060099
250700              SET DP013-DB2-ABEND  TO TRUE                        25070099
250800              PERFORM DP013-0000-PROCESS-ABEND                    25080099
250900     END-EVALUATE.                                                25090099
251000                                                                  25100099
251100                                                                  25110099
251200*----------------------------------------------------------------*25120099
251300* CLOSES AC CURSOR                                               *25130099
251400*----------------------------------------------------------------*25140099
251500 8300-CLOSE-AC-CSR.                                               25150099
251600                                                                  25160099
251700     EXEC SQL                                                     25170099
251800         CLOSE AC-CSR                                             25180099
251900     END-EXEC                                                     25190099
252000                                                                  25200099
252100     EVALUATE TRUE                                                25210099
252200         WHEN SQLCODE = ZERO                                      25220099
252300             CONTINUE                                             25230099
252400         WHEN SQLWARN0 NOT = SPACES                               25240099
252500         WHEN SQLCODE < ZERO                                      25250099
252600         WHEN SQLCODE > ZERO                                      25260099
252700             MOVE '8200-CLOSE-AC-CSR'                             25270099
252800                                   TO DP013-PARAGRAPH             25280099
252900             MOVE 'CLOSE AC CURSOR '                              25290099
253000                                   TO DP013-MESSAGE-TEXT (1)      25300099
253100             MOVE SQLCA            TO DP013-SQLCA                 25310099
253200             MOVE 'TALCHRG '       TO DP013-DB2-TABLE-NAME (1)    25320099
253300             SET DP013-DB2-ABEND                                  25330099
253400                 DP013-XCTL-DISPLAY-RESTART TO TRUE               25340099
253500             PERFORM DP013-0000-PROCESS-ABEND                     25350099
253600     END-EVALUATE.                                                25360099
253700                                                                  25370099
253800                                                                  25380099
253900*----------------------------------------------------------------*25390099
254000*    ABEND PROCESSOR MODULE                                      *25400099
254100*----------------------------------------------------------------*25410099
254200                                                                  25420099
254300     COPY DPPD013.                                                25430099
