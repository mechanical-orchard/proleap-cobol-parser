       IDENTIFICATION DIVISION.                                         00010000
       PROGRAM-ID.    MLKUT217.                                         00020002
       AUTHOR.        B.GRAHAM - STRATAGEM.                             00030000
       INSTALLATION.  KOHLS DEPARTMENT STORES.                          00040000
       DATE-WRITTEN.  06-12-08.                                         00050001
       DATE-COMPILED.                                                   00060000
      ******************************************************************00070000
      *                                                                 00080000
      * MLKUT217 - FOR CURR/PREV SKU ATTR DIFFERENCES:                  00090002
      *          - LOOK UP CURR/PREV DKEYS (LWST-ID)                    00100000
      *          - LOOK UP CURR AND PREV INHOUSE NUMBER                 00110001
      *          - LOOK UP EIC AND EIR FROM MLT_DEPT_BRND_VND           00120000
      *          - COMPUTE COST INFO FROM MLT_DEPT_BRND_VND             00130000
      *                                                                 00140000
      *          ADD ON REQUIREMENT                                     00150000
      *          PROVIDE AND OVERRIDE TO USE TUPCPLS INSTEAD OF         00160000
      *          WAREHOUSE FOR RTL AMT.                                 00170000
      ******************** HISTORY OF CHANGES **************************00180000
      * CHG ID/                                                        *00190000
      * WR/PROJ  DATE        DESCRIPTION OF CHANGES                    *00200000
      * -------  ----------  ----------------------------------------  *00210000
      * W34517   07-29-2008  B.GRAHAM - STRATAGEM                       00220042
      *                      INITIAL IMPLEMENTATION                     00230000
      * W34517   09-30-2008  J.SELWITSCHKA                              00231043
      *                      IF DKEY IS NOT FOUND WITHIN THE EFFECTIVE  00232043
      *                      DATES, GET THE DKEY WITH THE MAXIMUM       00233043
      *                      EFF_BEG_DTE.                               00234043
      ******************************************************************00240000
      *                                                                 00250000
       ENVIRONMENT DIVISION.                                            00260000
      *                                                                 00270000
       CONFIGURATION SECTION.                                           00280000
      *                                                                 00290000
       SOURCE-COMPUTER.        IBM-3090.                                00300000
       OBJECT-COMPUTER.        IBM-3090.                                00310000
      *                                                                 00320000
       INPUT-OUTPUT SECTION.                                            00330000
       FILE-CONTROL.                                                    00340000
                                                                        00350000
           SELECT DATE-CONTROL-FILE                                     00360000
               ASSIGN TO INP01.                                         00370000
                                                                        00380000
           SELECT SKU-CURR-PREV-ATTR-FILE                               00390000
               ASSIGN TO INP02.                                         00400000
                                                                        00410000
           SELECT USE-TUPCPLS-CONTROL-FILE                              00420016
               ASSIGN TO INP03.                                         00430000
                                                                        00440000
           SELECT UPD-CURR-PREV-SKU-ATTR-FILE                           00450021
               ASSIGN TO OUT01.                                         00460000
                                                                        00470000
           SELECT ERROR-WARN-FILE                                       00480000
               ASSIGN TO OUT02.                                         00490000
                                                                        00500000
                                                                        00510000
      ******************************************************************00520000
       DATA DIVISION.                                                   00530000
      ******************************************************************00540000
                                                                        00550000
       FILE SECTION.                                                    00560000
                                                                        00570000
       FD  DATE-CONTROL-FILE                                            00580000
           LABEL RECORDS ARE STANDARD                                   00590000
           RECORDING MODE IS F                                          00600000
           BLOCK CONTAINS 0 RECORDS.                                    00610000
       01  DATE-CONTROL-REC            PIC X(80).                       00620000
                                                                        00630000
       FD  SKU-CURR-PREV-ATTR-FILE                                      00640000
           RECORDING MODE F                                             00650000
           LABEL RECORDS OMITTED                                        00660000
           BLOCK CONTAINS  0 RECORDS.                                   00670000
       01  SKU-CURR-PREV-ATTR-REC      PIC X(175).                      00680000
                                                                        00690000
       FD  USE-TUPCPLS-CONTROL-FILE                                     00700016
           LABEL RECORDS ARE STANDARD                                   00710000
           RECORDING MODE IS F                                          00720000
           BLOCK CONTAINS 0 RECORDS.                                    00730000
       01  USE-TUPCPLS-CONTROL-REC     PIC X(80).                       00740016
                                                                        00750000
       FD  UPD-CURR-PREV-SKU-ATTR-FILE                                  00760021
           RECORDING MODE IS F                                          00770000
           LABEL RECORDS ARE STANDARD                                   00780000
           BLOCK CONTAINS 0 RECORDS.                                    00790000
                                                                        00800000
       01  UPD-CURR-PREV-SKU-ATTR-REC PIC X(175).                       00810021
                                                                        00820000
       FD  ERROR-WARN-FILE                                              00830000
           RECORDING MODE IS F                                          00840000
           LABEL RECORDS ARE STANDARD                                   00850000
           BLOCK CONTAINS 0 RECORDS.                                    00860000
                                                                        00870000
       01  ERROR-WARN-REC              PIC X(175).                      00880000
                                                                        00890000
                                                                        00900000
                                                                        00910000
      ******************************************************************00920000
       WORKING-STORAGE SECTION.                                         00930000
      ******************************************************************00940000
                                                                        00950000
      *** INPUT CONTROL RECORD                                          00960000
       01  PV-DATE-CONTROL-REC.                                         00970000
           05  PV-CURR-BOM-DATE        PIC X(10).                       00980000
           05  FILLER                  PIC X(01).                       00990000
           05  PV-PREV-BOM-DATE        PIC X(10).                       01000000
           05  FILLER                  PIC X(01).                       01010000
           05  PV-PREV-EOM-DATE        PIC X(10).                       01020000
           05  FILLER                  PIC X(01).                       01030032
           05  PV-CURR-FSCL-MN-NBR     PIC X(02).                       01031032
           05  FILLER                  PIC X(45).                       01032032
                                                                        01040000
      *** INPUT SKU-CURR-PREV-ATTR RECORD                               01050000
           COPY MLRD556.                                                01060000
                                                                        01070000
                                                                        01080000
       01  PV-USE-TUPCPLS-CONTROL-REC.                                  01090016
           05  PV-USE-TUPCPLS-RTL-AMT-IND                               01100016
                                       PIC X(03).                       01110016
               88  PV-USE-TUPCPLS                   VALUE 'YES'.        01120016
           05  FILLER                  PIC X(77).                       01130016
                                                                        01140016
                                                                        01150016
       EJECT                                                            01160000
       01  PA-PROGRAM-ACCUMULATORS.                                     01170000
           05  PA-SKU-RECS-IN-CNT      PIC 9(09)    VALUE ZERO.         01180000
           05  PA-SKU-RECS-OUT-CNT     PIC 9(09)    VALUE ZERO.         01190000
           05  PA-ERR-CNT              PIC 9(09)    VALUE ZERO.         01200037
           05  PA-WRN-CNT              PIC 9(09)    VALUE ZERO.         01201037
           05  PA-PARTN-SUB            PIC 9(02)    VALUE ZERO.         01210000
                                                                        01240000
       01  PC-PROGRAM-CONSTANTS.                                        01250000
                                                                        01260000
           05  PC-MLKUT217             PIC X(08)    VALUE 'MLKUT217'.   01270002
           05  PC-YES                  PIC X(03)    VALUE 'YES'.        01271020
           05  PC-WLWSTNODTE           PIC X(10)    VALUE 'WLWSTNODTE'. 01272021
           05  PC-ENODBVROW            PIC X(10)    VALUE 'ENODBVROW '. 01272121
           05  PC-ERR-LWST             PIC X(10)    VALUE 'ENOLWSTID '. 01273034
           05  PC-ERR-TUPCPLS          PIC X(10)    VALUE 'ENOTUPCPLS'. 01274034
                                                                        01280000
           05  PC-M                    PIC X(01)    VALUE 'M'.          01320000
           05  PC-W                    PIC X(01)    VALUE 'W'.          01321037
           05  PC-8                    PIC 9(01)    VALUE 8.            01330025
           05  PC-MAX-RETRIES          PIC 9(01)    VALUE 3.            01331019
                                                                        01340000
           05  PC-000-COMP             PIC S9(04) COMP VALUE ZERO.      01350000
           05  PC-03-C                 PIC XX      VALUE '03'.          01360000
           05  PC-ALL-NINES            PIC S9(15)V COMP-3               01370000
                                           VALUE 999999999999999.       01380000
                                                                        01390000
                                                                        01400000
       01  PV-PROGRAM-VARIABLES.                                        01410000
                                                                        01420000
      * TIMESTAMP FORMAT IS CCYY-MM-DD-HH.MM.SS.NNNNNN                  01430000
           05  PV-TMST.                                                 01440000
               10  PV-PREV-DTE         PIC  X(10) VALUE SPACES.         01450000
               10  FILLER              PIC  X(16) VALUE                 01460000
                                                 '-23.59.59.999999'.    01470000
                                                                        01480000
           05  PV-RETRY-COUNT          PIC 9(01)          VALUE ZERO.   01490019
           05  PV-TIMESTAMP            PIC X(26).                       01491019
           05  PV-LOOK-UP-DEPT-NBR     PIC S9(04)V COMP-3 VALUE +0.     01500000
           05  PV-LOOK-UP-ENT-ID       PIC S9(09)  COMP   VALUE +0.     01510000
           05  PV-LOOK-UP-LBL-SEQ-NBR  PIC S9(04)  COMP   VALUE +0.     01520000
           05  PV-LOOK-UP-LWST-ID      PIC S9(09)  COMP   VALUE +0.     01530000
           05  PV-UNT-RTL-AMT          PIC S9(09)V99                    01560000
                                                   COMP-3 VALUE +0.     01570000
                                                                        01580000
           05  PV-FROM-TO-CDE          PIC X(04) VALUE  SPACES.         01590005
                                                                        01600000
           05  PV-CMU-PCT              PIC S9(9)V9(7)  VALUE ZEROES     01601017
                                                       COMP-3.          01602017
           05  PV-SAVE-CMU-PCT         PIC S9(9)V9(7)  VALUE ZEROES     01603017
                                                       COMP-3.          01604017
           05  PV-SAVE-TO-DEPT-NBR     PIC S9(04)V COMP-3 VALUE +0.     01605017
           05  PV-SAVE-TO-ENT-ID       PIC S9(09)  COMP   VALUE +0.     01606017
           05  PV-SAVE-TO-LBL-SEQ-NBR  PIC S9(04)  COMP   VALUE +0.     01607017
           05  PV-SAVE-TO-LWST-ID      PIC S9(09)  COMP   VALUE +0.     01608017
           05  PV-SAVE-FROM-DEPT-NBR   PIC S9(04)V COMP-3 VALUE +0.     01609017
           05  PV-SAVE-FROM-ENT-ID     PIC S9(09)  COMP   VALUE +0.     01609117
           05  PV-SAVE-FROM-LBL-SEQ-NBR                                 01609217
                                       PIC S9(04)  COMP   VALUE +0.     01609317
           05  PV-SAVE-FROM-LWST-ID    PIC S9(09)  COMP   VALUE +0.     01609417
           05  PV-SAVE-IH-TO-DEPT-NBR  PIC S9(04)V COMP-3 VALUE +0.     01609517
           05  PV-SAVE-IH-TO-ENT-ID    PIC S9(09)  COMP   VALUE +0.     01609617
           05  PV-SAVE-IH-TO-NBR       PIC S9(03)V COMP-3.              01609717
           05  PV-SAVE-IH-FROM-DEPT-NBR                                 01609817
                                       PIC S9(04)V COMP-3 VALUE +0.     01609917
           05  PV-SAVE-IH-FROM-ENT-ID  PIC S9(09)  COMP   VALUE +0.     01610017
           05  PV-SAVE-IH-FROM-NBR     PIC S9(03)V COMP-3.              01610217
           05  PV-INHSE-NBR            PIC S9(03)V COMP-3.              01610417
           05  PV-SAVE-FROM-EIR-LWST-ID                                 01610529
                                       PIC S9(09)  COMP   VALUE +0.     01610629
                                                                        01611000
           05  PV-DEPT-NBR-9           PIC  9(04)      VALUE ZERO.      01612017
           05  PV-DEPT-X    REDEFINES PV-DEPT-NBR-9.                    01613017
               10  FILLER              PIC X(01).                       01614017
               10  PV-DEPT-3-CHAR      PIC X(03).                       01615017
           05  PV-IH-ENT-ID            PIC S9(09)  COMP   VALUE +0.     01616017
                                                                        01620000
                                                                        01630000
       01  PS-PROGRAM-SWITCHES.                                         01640000
           05  PS-SKU-ATTR-FILE-AT-END-SW PIC X    VALUE 'N'.           01650000
               88  PS-SKU-ATTR-FILE-AT-END-YES     VALUE 'Y'.           01660000
               88  PS-SKU-ATTR-FILE-AT-END-NO      VALUE 'N'.           01670000
           05  PS-TUPCPLS-STR-FOUND-SW    PIC X    VALUE 'N'.           01710014
               88  PS-TUPCPLS-STR-FOUND-YES        VALUE 'Y'.           01720014
               88  PS-TUPCPLS-STR-FOUND-NO         VALUE 'N'.           01730014
           05  PS-TUPCPLS-000-FOUND-SW    PIC X    VALUE 'N'.           01740014
               88  PS-TUPCPLS-000-FOUND-YES        VALUE 'Y'.           01750014
               88  PS-TUPCPLS-000-FOUND-NO         VALUE 'N'.           01760014
           05  PS-TUPCPLS-ERROR-SW        PIC X    VALUE 'N'.           01760117
               88  PS-TUPCPLS-ERROR-YES            VALUE 'Y'.           01760217
               88  PS-TUPCPLS-ERROR-NO             VALUE 'N'.           01760317
           05  PS-PARTN-MNLY-DONE-SW      PIC X    VALUE 'N'.           01761017
               88  PS-PARTN-MNLY-DONE-YES          VALUE 'Y'.           01762017
               88  PS-PARTN-MNLY-DONE-NO           VALUE 'N'.           01763017
           05  PS-LWST-ID-ERROR-SW        PIC X    VALUE 'N'.           01764017
               88  PS-LWST-ID-ERROR-YES            VALUE 'Y'.           01765017
               88  PS-LWST-ID-ERROR-NO             VALUE 'N'.           01766017
           05  PS-LWST-ID-TO-ERROR-SW     PIC X    VALUE 'N'.           01766117
               88  PS-LWST-ID-TO-ERROR-YES         VALUE 'Y'.           01766217
               88  PS-LWST-ID-TO-ERROR-NO          VALUE 'N'.           01766317
           05  PS-LWST-ID-FROM-ERROR-SW   PIC X    VALUE 'N'.           01766417
               88  PS-LWST-ID-FROM-ERROR-YES       VALUE 'Y'.           01766517
               88  PS-LWST-ID-FROM-ERROR-NO        VALUE 'N'.           01766617
           05  PS-EIR-EIC-2-ERROR-SW      PIC X    VALUE 'N'.           01767017
               88  PS-EIR-EIC-2-ERROR-YES          VALUE 'Y'.           01768017
               88  PS-EIR-EIC-2-ERROR-NO           VALUE 'N'.           01769017
                                                                        01770000
       01  PT-PARTN-NBR-TABLE.                                          01780000
           05  PT-PARTN-NBR-ENTRIES.                                    01790000
               10  PT-PARTN-NBR-1      PIC  S9(4) COMP VALUE +0.        01800000
               10  PT-PARTN-NBR-2      PIC  S9(4) COMP VALUE +0.        01810000
               10  PT-PARTN-NBR-3      PIC  S9(4) COMP VALUE +0.        01820000
               10  PT-PARTN-NBR-4      PIC  S9(4) COMP VALUE +0.        01830000
               10  PT-PARTN-NBR-5      PIC  S9(4) COMP VALUE +0.        01840000
               10  PT-PARTN-NBR-6      PIC  S9(4) COMP VALUE +0.        01850000
               10  PT-PARTN-NBR-7      PIC  S9(4) COMP VALUE +0.        01860000
               10  PT-PARTN-NBR-8      PIC  S9(4) COMP VALUE +0.        01870000
           05  PT-PARTN-NBR-ENTRY REDEFINES PT-PARTN-NBR-ENTRIES        01880000
                                  OCCURS 8 TIMES                        01890000
                                       PIC  S9(4) COMP.                 01900000
       EJECT                                                            01910000
                                                                        01920000
       01 ABEND-AREAS.                                                  01930000
           05 ABEND-CODE               PIC S9(04)  VALUE ZERO           01940000
                                                   COMP SYNC.           01950000
               88  AC-CONTROL-CARD                 VALUE +4001.         01960000
               88  AC-CONTROL-CARD                 VALUE +4002.         01970000
               88  AC-BAD-TUPCPLS-000-STR          VALUE +4003.         01980000
               88  AC-DB2-ERROR                    VALUE +4013.         01990000
           05  AA-ABEND-LIT            PIC X(40)   VALUE                02000000
                 '*****       ABEND'.                                   02010000
           05  AA-PROGRAM-LIT          PIC X(40)   VALUE                02020000
                   '*****   PROGRAM: MLKUT217'.                         02030002
           05  AA-PARAGRAPH-LIT.                                        02040000
               10  FILLER              PIC X(17)   VALUE                02050000
                   '***** PARAGRAPH: '.                                 02060000
               10  AA-PARAGRAPH-NAME   PIC X(35)   VALUE SPACES.        02070000
           05  AA-MESSAGE-LINE.                                         02080000
               10  FILLER              PIC X(06)   VALUE '*****'.       02090000
               10  AA-MESSAGE          PIC X(127)  VALUE SPACES.        02100000
           05  AA-DB2-ERROR-LIT        PIC X(40)   VALUE                02110000
                   '*****    DB2 ERROR'.                                02120000
           05  AA-DB2-OPERATION-LIT.                                    02130000
               10  FILLER              PIC X(17)   VALUE                02140000
                   '***** OPERATION: '.                                 02150000
               10  AA-DB2-OPERATION.                                    02160000
                   15  AA-DB2-OP-1     PIC X(25)   VALUE SPACES.        02170000
                   15  AA-DB2-OP-2     PIC X(25)   VALUE SPACES.        02180000
           05  AA-DB2-TABLE-1          PIC X(08)   VALUE SPACES.        02190000
           05  AA-DB2-TABLE-2          PIC X(08)   VALUE SPACES.        02200000
           05  AA-DB2-TABLE-3          PIC X(08)   VALUE SPACES.        02210000
           05  AA-DB2-TABLE-4          PIC X(08)   VALUE SPACES.        02220000
                                                                        02230000
                                                                        02240000
                                                                        02250000
       EJECT                                                            02260000
                                                                        02270000
      ******************************************************************02280000
      *  DB2 COMMUNICATION AREA                                         02290000
      ******************************************************************02300000
           EXEC SQL                                                     02310000
                INCLUDE SQLCA                                           02320000
           END-EXEC.                                                    02330000
                                                                        02340000
      ******************************************************************02350000
      *  DB2 ERROR MESSAGES FORMAT AREA.                                02360000
      ******************************************************************02370000
           COPY DPWS004.                                                02380000
                                                                        02470000
      ******************************************************************02480000
      *  DB2 MLV00000  MLV_BRND_VND                                     02490000
      ******************************************************************02500000
           EXEC SQL                                                     02510000
                INCLUDE MLV00000                                        02520000
           END-EXEC.                                                    02530000
                                                                        02540000
                                                                        02550000
      ******************************************************************02560011
      *  DB2 - M/L DETAIL LEDGER PARTITION BALANCE TBL (MLT_PARTN_BAL)  02570011
      ******************************************************************02580011
           EXEC SQL                                                     02590011
               INCLUDE MLT00002                                         02600011
           END-EXEC.                                                    02610011
                                                                        02620011
      ******************************************************************02630011
      *  DB2 - M/L DETAIL LEDGER PARTITION CONTROL TBL (MLT_PARTN_CNTL) 02640011
      ******************************************************************02650011
           EXEC SQL                                                     02660011
               INCLUDE MLT00003                                         02670011
           END-EXEC.                                                    02680011
                                                                        02690011
      ******************************************************************02700011
      *  DB2 - M/L DETAIL LEDGER PARTITION CURSOR FOR MLT_DEPT_BRND_VND 02710011
      ******************************************************************02720011
           EXEC SQL                                                     02730011
             DECLARE PARTN-MNLY-CSR CURSOR FOR                          02740011
               SELECT DISTINCT PARTN_NBR                                02750011
               FROM MLT_PARTN_CNTL A,                                   02760011
                    MLT_PARTN_BAL B                                     02770011
               WHERE A.TBL_TM_LVL_CDE = :PC-M                           02780011
                 AND A.FSCL_DTE       = :PV-PREV-EOM-DATE               02790011
                 AND B.TBL_TM_LVL_CDE = A.TBL_TM_LVL_CDE                02800011
                 AND B.EFF_BEG_DTE   <= :PV-PREV-BOM-DATE               02810011
                 AND B.EFF_END_DTE   >= :PV-PREV-EOM-DATE               02820011
                 AND B.DEPT_GP_CDE    = A.DEPT_GP_CDE                   02830011
                                                                        02840011
               WITH UR                                                  02850011
           END-EXEC.                                                    02860011
                                                                        02870012
      ******************************************************************02880012
      *  DB2 - M/L DETAIL LEDGER MLT_DEPT_BRND_VND TBL                  02890012
      ******************************************************************02900012
           EXEC SQL                                                     02910012
               INCLUDE MLT00010                                         02920012
           END-EXEC.                                                    02930012
                                                                        02940014
      ******************************************************************02950014
      *  DB2 TUPCPLS TABLE LAYOUT                                       02960014
      ******************************************************************02970014
           EXEC SQL                                                     02980014
                INCLUDE TUPCPLS                                         02990014
           END-EXEC.                                                    03000014
                                                                        03010011
      ******************************************************************03020011
      *  DB2 - TVNDDPT                                                  03030011
      ******************************************************************03040011
           EXEC SQL                                                     03050011
               INCLUDE TVNDDPT                                          03060011
           END-EXEC.                                                    03070011
                                                                        03080000
      ******************************************************************03090000
       PROCEDURE DIVISION.                                              03100000
      ******************************************************************03110000
                                                                        03120000
                                                                        03130000
      *************************PROGRAM PROCESS**************************03140000
      *  1. INITIALIZATION                                              03150000
      *     A. OPEN FILES                                               03160000
      *     B. GET CONTROL DATE CARD.                                   03170000
      *     C. GET PARTITION NUMBERS FROM PARTN_CNTL, PART_BAL          03180000
      *                                                                 03190000
      *                                                                 03200000
      *  2. READ SKU-CURR-PREV-ATTR FILE                                03210000
      *     A. LOOK-UP CURR/PREV LWST-ID FROM MLV                       03220000
      *     B. LOOK-UP INHOUSE NUMBER                                   03230000
      *     C. GET EIC-2, EIR FROM MLT_DEPT_BRND_VND                    03240000
      *     D. COMPUTE CMU%                                             03250000
      *     E. IF USE TUPCPLS IS INDICATED                              03260000
      *        ACCESS TUPCPLS FOR RTL AMOUNT AND MULTIPLE TIMES         03270000
      *        ON HAND                                                  03280000
      *     F. COMPUTE PADJ COST USING ORIGINAL INPUT OR F AMOUNT.      03290000
      *     G. ANY ERRORS ENCOUNTERED ALONG THE WAY WILL BE WRITTEN     03300011
      *        TO THE ERROR-WARNING FILE.                               03310011
      *  3. WRITE OUT UPDATED SKU CURR PREV ATTR FILE WITH INPUT VALUES 03320000
      *     AND UPDATED VALUES FROM 2 A THROUGH G ABOVE.                03330000
      *                                                                 03340000
      *  4. CLOSE FILES AND DISPLAY COUNTS.                             03350000
      *                                                                 03360000
      *                                                                 03370000
      ******************************************************************03380000
       0000-MAINLINE-MLKUT217.                                          03390002
      ******************************************************************03400000
      *                                                                 03410000
           PERFORM 1000-INITIALIZATION.                                 03420000
                                                                        03430000
           PERFORM 2000-PROCESS-SKU-ATTR-FILE                           03440000
               UNTIL PS-SKU-ATTR-FILE-AT-END-YES.                       03450000
                                                                        03460000
           PERFORM 9000-EOJ.                                            03470000
                                                                        03480000
           STOP RUN.                                                    03490000
                                                                        03500000
       EJECT                                                            03510000
                                                                        03520000
      ******************************************************************03530000
       1000-INITIALIZATION.                                             03540000
      ******************************************************************03550000
      *                                                                 03560000
           OPEN INPUT  DATE-CONTROL-FILE                                03570000
                       USE-TUPCPLS-CONTROL-FILE                         03571017
                       SKU-CURR-PREV-ATTR-FILE                          03580000
                OUTPUT UPD-CURR-PREV-SKU-ATTR-FILE                      03590021
                       ERROR-WARN-FILE.                                 03600000
                                                                        03610000
           PERFORM 1100-READ-CONTROL-FILE.                              03620000
                                                                        03630000
           DISPLAY ' '.                                                 03640000
           DISPLAY '*** CONTROL CARD VALUES FOR MLKUT217 FOLLOW ***'    03650002
           DISPLAY PV-DATE-CONTROL-REC.                                 03660000
                                                                        03670000
           PERFORM 1200-SELECT-PARTITIONS.                              03680000
                                                                        03690000
           PERFORM 1300-READ-TUPCPLS-CONTROL.                           03700017
                                                                        03710000
       EJECT                                                            03720000
      ******************************************************************03730000
       1100-READ-CONTROL-FILE.                                          03740000
      ******************************************************************03750000
                                                                        03760017
           READ DATE-CONTROL-FILE                                       03770019
             INTO PV-DATE-CONTROL-REC                                   03780000
               AT END                                                   03790000
                   MOVE '1100-READ-CONTROL-FILE'                        03800000
                                       TO AA-PARAGRAPH-NAME             03810000
                   MOVE 'DATE CONTROL CARD IS MISSING'                  03820019
                                       TO AA-MESSAGE                    03830000
                   MOVE +4001          TO ABEND-CODE                    03840000
                   PERFORM 9900-COMMON-ABEND-ROUTINE                    03850000
           END-READ.                                                    03860000
                                                                        03870000
      ******************************************************************03880000
       1200-SELECT-PARTITIONS.                                          03890000
      ******************************************************************03900000
                                                                        03910011
           PERFORM 1205-OPEN-PARTN-MNLY-CSR.                            03920011
                                                                        03930011
           PERFORM 1210-FETCH-PARTN-MNLY-CSR                            03940019
               UNTIL PS-PARTN-MNLY-DONE-YES.                            03950011
                                                                        03960011
           PERFORM 1215-CLOSE-PARTN-MNLY-CSR.                           03970011
                                                                        03980011
           IF PA-PARTN-SUB EQUAL ZERO                                   03990019
               MOVE '1200-SELECT-PARTITIONS    ' TO AA-PARAGRAPH-NAME   04000011
               MOVE 'NO SELECTIONS FOUND     ' TO AA-MESSAGE            04010011
               MOVE +4007                     TO ABEND-CODE             04020011
               PERFORM 9900-COMMON-ABEND-ROUTINE                        04030011
           END-IF.                                                      04040011
                                                                        04050000
                                                                        04060011
      ***************************************************************** 04070011
      * 1205-OPEN-PARTN-MNLY-CSR.                                       04080011
      ***************************************************************** 04090011
       1205-OPEN-PARTN-MNLY-CSR.                                        04100011
                                                                        04110011
           PERFORM                                                      04120011
               WITH TEST AFTER                                          04130011
               VARYING PV-RETRY-COUNT FROM 1 BY 1                       04140011
                 UNTIL SQLCODE = +000                                   04150011
                    OR PV-RETRY-COUNT > PC-MAX-RETRIES                  04160011
                                                                        04170011
               EXEC SQL                                                 04180011
                   OPEN PARTN-MNLY-CSR                                  04190011
               END-EXEC                                                 04200011
                                                                        04210011
               EVALUATE TRUE                                            04220011
                   WHEN SQLCODE        = +000                           04230011
                   WHEN SQLCODE        = -911                           04240011
                   WHEN SQLCODE        = -913                           04250011
                       CONTINUE                                         04260011
                   WHEN OTHER                                           04270011
                       MOVE '1205-OPEN-PARTN-MNLY-CSR '                 04280018
                                                TO AA-PARAGRAPH-NAME    04290011
                       MOVE 'PARTN-MNLY-CSR OPEN CURSOR ERROR OCCURRED' 04300011
                                                TO AA-MESSAGE           04310011
                       MOVE 'OPEN PARTITION MONTHLY CURSOR'             04320011
                                                TO AA-DB2-OPERATION     04330011
                       PERFORM 9901-SQL-ERROR                           04340011
               END-EVALUATE                                             04350011
                                                                        04360011
           END-PERFORM.                                                 04370011
                                                                        04380011
           IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          04390011
               MOVE '1205-OPEN-PARTN-MNLY-CSR'   TO AA-PARAGRAPH-NAME   04400011
               MOVE 'PARTN-MNLY-CSR OPEN CURSOR RETRIES EXCEEDED'       04410011
                                                TO AA-MESSAGE           04420011
               MOVE 'OPEN PARTITION MONTHLY CURSOR'                     04430011
                                                TO AA-DB2-OPERATION     04440011
               PERFORM 9901-SQL-ERROR                                   04450011
           END-IF.                                                      04460011
                                                                        04470011
      ***************************************************************** 04480011
      * 1210-FETCH-PARTN-MNLY-CSR.                                      04490011
      ***************************************************************** 04500011
        1210-FETCH-PARTN-MNLY-CSR.                                      04510011
                                                                        04520011
           PERFORM                                                      04530011
               WITH TEST AFTER                                          04540011
               VARYING PV-RETRY-COUNT FROM 1 BY 1                       04550011
                 UNTIL SQLCODE = +000                                   04560011
                    OR SQLCODE = +100                                   04570011
                    OR PV-RETRY-COUNT > PC-MAX-RETRIES                  04580011
                                                                        04590011
               EXEC SQL                                                 04600011
                   FETCH PARTN-MNLY-CSR                                 04610011
                   INTO :MLT00003-PARTN-NBR                             04620011
               END-EXEC                                                 04630011
                                                                        04640011
               EVALUATE TRUE                                            04650011
                   WHEN SQLCODE        = +000                           04660011
                       ADD 1 TO PA-PARTN-SUB                            04661024
                   WHEN SQLCODE = +100                                  04680011
                       SET PS-PARTN-MNLY-DONE-YES TO TRUE               04690011
                   WHEN SQLCODE        = -911                           04700011
                   WHEN SQLCODE        = -913                           04710011
                       CONTINUE                                         04720011
                   WHEN OTHER                                           04730011
                       MOVE '1210-FETCH-PARTN-MNLY-CSR'                 04740011
                                                TO AA-PARAGRAPH-NAME    04750011
                       MOVE 'PARTN-MNLY-CSR FETCH CURSOR ERROR OCCURRED'04760011
                                                TO AA-MESSAGE           04770011
                       MOVE 'FETCH PARTITION MONTHLY CURSOR'            04780011
                                                TO AA-DB2-OPERATION     04790011
                       PERFORM 9901-SQL-ERROR                           04800011
               END-EVALUATE                                             04810011
                                                                        04820011
           END-PERFORM.                                                 04830011
                                                                        04840011
           IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          04850011
               MOVE '1210-FETCH-PARTN-MNLY-CSR'  TO AA-PARAGRAPH-NAME   04860011
               MOVE 'PARTN-MNLY-CSR FETCH CURSOR RETRIES EXCEEDED'      04870011
                                                TO AA-MESSAGE           04880011
               MOVE 'FETCH PARTITION MONTHLY CURSOR'                    04890011
                                                TO AA-DB2-OPERATION     04900011
               PERFORM 9901-SQL-ERROR                                   04910011
           END-IF.                                                      04920011
                                                                        04930011
                                                                        04950011
           IF PA-PARTN-SUB > PC-8                                       04960011
               MOVE '1210-FETCH-PARTN-MNLY-CSR ' TO AA-PARAGRAPH-NAME   04970011
               MOVE 'MORE THAT 8 FOUND       ' TO AA-MESSAGE            04980011
               MOVE +4007                     TO ABEND-CODE             04990011
               PERFORM 9900-COMMON-ABEND-ROUTINE                        05000011
           END-IF.                                                      05010011
                                                                        05020011
           MOVE MLT00003-PARTN-NBR TO PT-PARTN-NBR-ENTRY (PA-PARTN-SUB).05030011
                                                                        05040011
                                                                        05050011
      ***************************************************************** 05060011
      * 1215-CLOSE-PARTN-MNLY-CSR.                                      05070011
      ***************************************************************** 05080011
        1215-CLOSE-PARTN-MNLY-CSR.                                      05090011
                                                                        05100011
           PERFORM                                                      05110011
               WITH TEST AFTER                                          05120011
               VARYING PV-RETRY-COUNT FROM 1 BY 1                       05130011
                 UNTIL SQLCODE = +000                                   05140011
                    OR PV-RETRY-COUNT > PC-MAX-RETRIES                  05150011
                                                                        05160011
               EXEC SQL                                                 05170011
                   CLOSE PARTN-MNLY-CSR                                 05180011
               END-EXEC                                                 05190011
                                                                        05200011
               EVALUATE TRUE                                            05210011
                   WHEN SQLCODE        = +000                           05220011
                   WHEN SQLCODE        = -911                           05230011
                   WHEN SQLCODE        = -913                           05240011
                       CONTINUE                                         05250011
                   WHEN OTHER                                           05260011
                       MOVE '1215-CLOSE-PARTN-MNLY-CSR'                 05270011
                                                TO AA-PARAGRAPH-NAME    05280011
                       MOVE 'PARTN-MNLY-CSR CLOSE CURSOR ERROR OCCURRED'05290011
                                                TO AA-MESSAGE           05300011
                       MOVE 'CLOSE PARTITION MONTHLY CURSOR'            05310011
                                                TO AA-DB2-OPERATION     05320011
                       PERFORM 9901-SQL-ERROR                           05330011
               END-EVALUATE                                             05340011
                                                                        05350011
           END-PERFORM.                                                 05360011
                                                                        05370011
           IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          05380011
               MOVE '1215-CLOSE-PARTN-MNLY-CSR'  TO AA-PARAGRAPH-NAME   05390011
               MOVE 'PARTN-MNLY-CSR CLOSE CURSOR RETRIES EXCEEDED'      05400011
                                                TO AA-MESSAGE           05410011
               MOVE 'CLOSE PARTITION MONTHLY CURSOR'                    05420011
                                                TO AA-DB2-OPERATION     05430011
               PERFORM 9901-SQL-ERROR                                   05440011
           END-IF.                                                      05450011
                                                                        05460011
                                                                        05470000
      ******************************************************************05470117
       1300-READ-TUPCPLS-CONTROL.                                       05471017
      ******************************************************************05472017
                                                                        05473017
           READ USE-TUPCPLS-CONTROL-FILE                                05474017
             INTO PV-USE-TUPCPLS-CONTROL-REC                            05475017
               AT END                                                   05476017
                   MOVE '1300-READ-TUPCPLS-CONTROL'                     05477017
                                       TO AA-PARAGRAPH-NAME             05478017
                   MOVE 'TUPCPLS CONTROL MISSING'                       05479017
                                       TO AA-MESSAGE                    05479117
                   MOVE +4001          TO ABEND-CODE                    05479217
                   PERFORM 9900-COMMON-ABEND-ROUTINE                    05479317
               NOT AT END                                               05479417
                   DISPLAY 'PV-USE-TUPCPLS-CONTROL-REC '                05479517
                                  PV-USE-TUPCPLS-CONTROL-REC            05479617
           END-READ.                                                    05479717
                                                                        05479817
                                                                        05479917
       EJECT                                                            05480000
                                                                        05490000
      ******************************************************************05500000
       2000-PROCESS-SKU-ATTR-FILE.                                      05510020
      ******************************************************************05511020
      *     A. LOOK-UP CURR/PREV LWST-ID FROM MLV                       05520000
      *     B. LOOK-UP INHOUSE NUMBER                                   05530000
      *     C. GET EIC-2, EIR FROM MLT_DEPT_BRND_VND                    05540000
      *     D. COMPUTE CMU%                                             05550000
      *     E. IF USE TUPCPLS IS INDICATED                              05560000
      *        ACCESS TUPCPLS FOR RTL AMOUNT AND MULTIPLE TIMES         05570000
      *        ON HAND                                                  05580000
      *     F. COMPUTE PADJ COST USING ORIGINAL INPUT OR F AMOUNT.      05590000
      *     G. ANY ERRORS ENCOUNTERED ALONG THE WAY WILL BE WRITTEN     05600000
      *        TO THE ERROR-WARNING FILE.                               05610000
      *     H. WRITE OUT UPDATED SKU CURR PREV ATTR FILE                05620000
      *        WITH INPUT VALUES AND UPDATED VALUES FROM 2 A THROUGH    05630000
      *        G ABOVE.                                                 05640000
      *                                                                 05650000
      *     MULTIPLE RECORDS WILL HAVE THE SAME ATTRIBUTES              05660013
      *     (DEPT, ENT-ID, LBL-SEQ-NBR) BUT HAVE A DIFFERENT LOCATION,  05670013
      *     ON HAND AND RETAIL AMT.                                     05680013
      *     SAVE AREAS AND SWITHCES ARE USED SO THAT MULTIPLE CALLS     05690013
      *     FOR THE SAME CRITERIA ARE DONE ONLY ONCE.                   05700013
      *     IN ADDITION, IF A LOOKUP PRODUCED AN ERROR, THAT ERROR      05710013
      *     CONDITION MUST BE APPLIED TO THE NEXT INCOMING RECORD IF    05720013
      *     IT HAS THE SAME ATTRIBUTES.                                 05730013
      *                                                                 05740013
      ******************************************************************05750013
                                                                        05760000
           PERFORM 3000-READ-SKU-ATTR-FILE.                             05770000
                                                                        05780000
           IF PS-SKU-ATTR-FILE-AT-END-NO                                05790000
              PERFORM 4000-LOOKUP-LWST-ID                               05800000
              IF PS-LWST-ID-ERROR-NO                                    05810000
                  PERFORM 4500-LOOKUP-INHOUSE                           05820000
                  PERFORM 5000-LOOKUP-EIR-EIC-2                         05830020
                  IF PS-EIR-EIC-2-ERROR-NO                              05840017
                      IF PV-USE-TUPCPLS-RTL-AMT-IND = PC-YES            05850000
                          PERFORM 6000-GET-TUPCPLS                      05860013
                          IF PS-TUPCPLS-ERROR-NO                        05870000
                              PERFORM 7000-COMPUTE-PADJ-COST            05880013
                              PERFORM 7900-WRITE-UPD-SKU-ATTR-FILE      05890013
                          END-IF                                        05900000
                      ELSE                                              05910000
                          PERFORM 7000-COMPUTE-PADJ-COST                05920013
                          PERFORM 7900-WRITE-UPD-SKU-ATTR-FILE          05930013
                      END-IF                                            05940000
                  END-IF                                                05951033
              END-IF                                                    05961033
           END-IF.                                                      05970000
                                                                        05980000
      ******************************************************************05990000
       3000-READ-SKU-ATTR-FILE.                                         06000000
      ******************************************************************06010000
                                                                        06020000
           READ SKU-CURR-PREV-ATTR-FILE INTO                            06030000
                                    ML556-CURR-PREV-SKU-ATTR-REC        06040000
               AT END                                                   06050000
                  SET PS-SKU-ATTR-FILE-AT-END-YES TO TRUE.              06060000
                                                                        06070000
           IF PS-SKU-ATTR-FILE-AT-END-NO                                06080000
               ADD 1 TO PA-SKU-RECS-IN-CNT                              06090000
           END-IF.                                                      06100000
                                                                        06110000
                                                                        06113039
      ******************************************************************06120000
       4000-LOOKUP-LWST-ID.                                             06130000
      ******************************************************************06140000
      *  ALL LOOKUPS WILL USE CURR-DEPT (BOTH FROM AND TO) BECAUSE      06150000
      *  RECLASS ACTIVITY WAS ALLOWED TO PROCESS AS IT OCCURRED AND     06160000
      *  NOT SAVED UNTIL THE END OF THE MONTH.                          06170000
      *                                                                 06180011
      *  IF A PREVIOUS LOOK UP RETURNED AN ERROR, SUBSEQUENT RECORDS    06190011
      *  WITH THE SAME CRITERIA NEED TO RETURN AN ERROR ALSO.           06200011
      *                                                                 06210011
      ******************************************************************06220000
                                                                        06230000
           PERFORM 4100-LWST-TO-LOOKUP.                                 06240011
                                                                        06250011
           IF PS-LWST-ID-TO-ERROR-NO                                    06260011
               PERFORM 4200-LWST-FROM-LOOKUP                            06270011
           END-IF.                                                      06280011
                                                                        06290011
      ******************************************************************06300011
       4100-LWST-TO-LOOKUP.                                             06310021
      ******************************************************************06320011
                                                                        06330011
           IF ML556-CURR-DEPT-NBR = PV-SAVE-TO-DEPT-NBR                 06340011
             AND ML556-CURR-ENT-ID = PV-SAVE-TO-ENT-ID                  06350011
             AND ML556-CURR-LBL-SEQ-NBR = PV-SAVE-TO-LBL-SEQ-NBR        06360011
                 IF PS-LWST-ID-TO-ERROR-YES                             06370011
                     MOVE PC-ERR-LWST      TO ML556-ERR-WRN-DATA        06380011
                     PERFORM 7800-WRITE-ERR-WRN                         06390011
                 ELSE                                                   06400011
                     MOVE PV-SAVE-TO-LWST-ID                            06410011
                                           TO ML556-CURR-LWST-ID        06420011
                 END-IF                                                 06430011
           ELSE                                                         06440011
               SET PS-LWST-ID-TO-ERROR-NO  TO TRUE                      06450011
               SET PS-LWST-ID-ERROR-NO     TO TRUE                      06460038
               MOVE ML556-CURR-DEPT-NBR    TO PV-LOOK-UP-DEPT-NBR       06470011
               MOVE ML556-CURR-DEPT-NBR    TO PV-SAVE-TO-DEPT-NBR       06480011
               MOVE ML556-CURR-ENT-ID      TO PV-LOOK-UP-ENT-ID         06490011
               MOVE ML556-CURR-ENT-ID      TO PV-SAVE-TO-ENT-ID         06500011
               MOVE ML556-CURR-LBL-SEQ-NBR                              06510011
                                           TO PV-LOOK-UP-LBL-SEQ-NBR    06520011
               MOVE ML556-CURR-LBL-SEQ-NBR                              06530011
                                           TO PV-SAVE-TO-LBL-SEQ-NBR    06540011
               MOVE 'TO  '                 TO PV-FROM-TO-CDE            06550011
               PERFORM 4400-SELECT-LWST-ID                              06560011
               IF PS-LWST-ID-ERROR-YES                                  06570011
                   SET PS-LWST-ID-TO-ERROR-YES TO TRUE                  06580011
                   MOVE PC-ERR-LWST         TO ML556-ERR-WRN-DATA       06590011
                   PERFORM 7800-WRITE-ERR-WRN                           06600011
               ELSE                                                     06610011
                   MOVE PV-LOOK-UP-LWST-ID  TO ML556-CURR-LWST-ID       06620011
                   MOVE PV-LOOK-UP-LWST-ID  TO PV-SAVE-TO-LWST-ID       06630011
               END-IF                                                   06640011
           END-IF.                                                      06650011
                                                                        06660011
      ******************************************************************06670011
       4200-LWST-FROM-LOOKUP.                                           06680021
      ******************************************************************06690011
                                                                        06700011
           IF ML556-CURR-DEPT-NBR = PV-SAVE-FROM-DEPT-NBR               06710011
             AND ML556-PREV-ENT-ID = PV-SAVE-FROM-ENT-ID                06720011
             AND ML556-PREV-LBL-SEQ-NBR = PV-SAVE-FROM-LBL-SEQ-NBR      06730011
                 IF PS-LWST-ID-FROM-ERROR-YES                           06740011
                     MOVE PC-ERR-LWST      TO ML556-ERR-WRN-DATA        06750011
                     PERFORM 7800-WRITE-ERR-WRN                         06760011
                 ELSE                                                   06770011
                     MOVE PV-SAVE-FROM-LWST-ID                          06780011
                                           TO ML556-PREV-LWST-ID        06790011
                 END-IF                                                 06800011
           ELSE                                                         06810011
               SET PS-LWST-ID-FROM-ERROR-NO TO TRUE                     06820011
               SET PS-LWST-ID-ERROR-NO      TO TRUE                     06830011
               MOVE ML556-CURR-DEPT-NBR    TO PV-LOOK-UP-DEPT-NBR       06840011
               MOVE ML556-CURR-DEPT-NBR    TO PV-SAVE-FROM-DEPT-NBR     06850011
               MOVE ML556-PREV-ENT-ID      TO PV-LOOK-UP-ENT-ID         06860011
               MOVE ML556-PREV-ENT-ID      TO PV-SAVE-FROM-ENT-ID       06870011
               MOVE ML556-PREV-LBL-SEQ-NBR                              06880011
                                           TO PV-LOOK-UP-LBL-SEQ-NBR    06890011
               MOVE ML556-PREV-LBL-SEQ-NBR                              06900011
                                           TO PV-SAVE-FROM-LBL-SEQ-NBR  06910011
               MOVE 'FROM'                 TO PV-FROM-TO-CDE            06920011
               PERFORM 4400-SELECT-LWST-ID                              06930011
               IF PS-LWST-ID-ERROR-YES                                  06940011
                   SET PS-LWST-ID-FROM-ERROR-YES TO TRUE                06950011
                   MOVE PC-ERR-LWST         TO ML556-ERR-WRN-DATA       06960011
                   PERFORM 7800-WRITE-ERR-WRN                           06970011
               ELSE                                                     06980011
                   MOVE PV-LOOK-UP-LWST-ID   TO ML556-PREV-LWST-ID      06990011
                   MOVE PV-LOOK-UP-LWST-ID   TO PV-SAVE-FROM-LWST-ID    07000011
               END-IF                                                   07010011
           END-IF.                                                      07020011
                                                                        07030011
      ******************************************************************07040011
       4400-SELECT-LWST-ID.                                             07050011
      ******************************************************************07060011
                                                                        07070011
           EXEC SQL                                                     07080011
               SELECT ML_LO_MDSE_LVL_ID                                 07090011
                 INTO :PV-LOOK-UP-LWST-ID                               07100011
                 FROM MLV_BRND_VND                                      07110011
                 WHERE  DEPT_NBR    = :PV-LOOK-UP-DEPT-NBR              07120011
                 AND    ENT_ID      = :PV-LOOK-UP-ENT-ID                07130011
                 AND    LBL_SEQ_NBR = :PV-LOOK-UP-LBL-SEQ-NBR           07140011
                 AND    EFF_BEG_DTE <= :PV-CURR-BOM-DATE                07150011
                 AND   (EFF_END_DTE >= :PV-CURR-BOM-DATE                07160011
                 OR     EFF_END_DTE IS NULL)                            07170011
               WITH UR                                                  07180011
           END-EXEC.                                                    07190011
                                                                        07200011
           EVALUATE TRUE                                                07210011
               WHEN SQLCODE = 0                                         07220011
                   CONTINUE                                             07230011
               WHEN SQLCODE = 100                                       07240011
                   PERFORM 4450-SELECT-LWST-ID-NO-DATE                  07250011
               WHEN OTHER                                               07260011
                   MOVE ' 4400-SELECT-LWST-ID            '              07270011
                                       TO AA-PARAGRAPH-NAME             07280011
                   MOVE 'BRND_VND VIEW       '                          07290011
                                       TO AA-MESSAGE                    07300011
                   MOVE 'SELECT'       TO AA-DB2-OPERATION              07310011
                   PERFORM 9901-SQL-ERROR                               07320011
           END-EVALUATE.                                                07330011
                                                                        07340011
                                                                        07350011
      ******************************************************************07360011
       4450-SELECT-LWST-ID-NO-DATE.                                     07370011
      ******************************************************************07380011
                                                                        07390011
           EXEC SQL                                                     07400011
               SELECT ML_LO_MDSE_LVL_ID                                 07410011
W34517               ,MAX(EFF_BEG_DTE)                                  07411043
                 INTO :PV-LOOK-UP-LWST-ID                               07420011
W34517               ,:MLV00000-EFF-BEG-DTE                             07421043
                 FROM MLV_BRND_VND                                      07430011
                 WHERE  DEPT_NBR    = :PV-LOOK-UP-DEPT-NBR              07440011
                 AND    ENT_ID      = :PV-LOOK-UP-ENT-ID                07450011
                 AND    LBL_SEQ_NBR = :PV-LOOK-UP-LBL-SEQ-NBR           07460011
W34517         GROUP BY ML_LO_MDSE_LVL_ID                               07461043
               WITH UR                                                  07470011
           END-EXEC.                                                    07480011
                                                                        07490011
           EVALUATE TRUE                                                07500011
               WHEN SQLCODE = 0                                         07510011
               WHEN SQLCODE = -811                                      07520011
                   MOVE PC-WLWSTNODTE      TO ML556-ERR-WRN-DATA        07530021
                   PERFORM 7800-WRITE-ERR-WRN                           07540011
               WHEN SQLCODE = 100                                       07550011
                   SET  PS-LWST-ID-ERROR-YES TO TRUE                    07560011
               WHEN OTHER                                               07570011
                   MOVE ' 4450-SELECT-LWST-ID-NO-DATE    '              07580011
                                       TO AA-PARAGRAPH-NAME             07590011
                   MOVE 'BRND_VND VIEW       '                          07600011
                                       TO AA-MESSAGE                    07610011
                   MOVE 'SELECT'       TO AA-DB2-OPERATION              07620011
                   PERFORM 9901-SQL-ERROR                               07630011
           END-EVALUATE.                                                07640011
                                                                        07650011
                                                                        07660011
      ******************************************************************07670011
       4500-LOOKUP-INHOUSE.                                             07680011
      ******************************************************************07690011
                                                                        07700011
                                                                        07705026
           IF ML556-CURR-DEPT-NBR = PV-SAVE-IH-TO-DEPT-NBR              07710011
              AND ML556-CURR-ENT-ID = PV-SAVE-IH-TO-ENT-ID              07720011
                  MOVE PV-SAVE-IH-TO-NBR TO ML556-CURR-INHOUSE-NBR      07730017
           ELSE                                                         07740011
               MOVE ML556-CURR-DEPT-NBR TO PV-DEPT-NBR-9                07750011
               MOVE ML556-CURR-DEPT-NBR TO PV-SAVE-IH-TO-DEPT-NBR       07760011
               MOVE ML556-CURR-ENT-ID   TO PV-IH-ENT-ID                 07770011
               MOVE ML556-CURR-ENT-ID   TO PV-SAVE-IH-TO-ENT-ID         07780017
               PERFORM 4525-SELECT-INHOUSE                              07790011
               MOVE PV-INHSE-NBR        TO PV-SAVE-IH-TO-NBR            07800017
               MOVE PV-SAVE-IH-TO-NBR   TO ML556-CURR-INHOUSE-NBR       07801027
           END-IF.                                                      07810011
                                                                        07820011
           IF ML556-CURR-DEPT-NBR = PV-SAVE-IH-FROM-DEPT-NBR            07830011
              AND ML556-PREV-ENT-ID = PV-SAVE-IH-FROM-ENT-ID            07840011
                  MOVE PV-SAVE-IH-FROM-NBR TO ML556-PREV-INHOUSE-NBR    07850023
           ELSE                                                         07860011
               MOVE ML556-CURR-DEPT-NBR TO PV-DEPT-NBR-9                07870011
               MOVE ML556-CURR-DEPT-NBR TO PV-SAVE-IH-FROM-DEPT-NBR     07880022
               MOVE ML556-PREV-ENT-ID   TO PV-IH-ENT-ID                 07890011
               MOVE ML556-PREV-ENT-ID   TO PV-SAVE-IH-FROM-ENT-ID       07900022
               PERFORM 4525-SELECT-INHOUSE                              07910011
               MOVE PV-INHSE-NBR        TO PV-SAVE-IH-FROM-NBR          07920022
               MOVE PV-SAVE-IH-FROM-NBR TO ML556-PREV-INHOUSE-NBR       07921027
           END-IF.                                                      07930011
                                                                        07940011
      ******************************************************************07950011
       4525-SELECT-INHOUSE.                                             07960011
      ******************************************************************07970011
                                                                        07980011
           EXEC SQL                                                     07990011
               SELECT INHOUSE_NBR                                       08000011
                 INTO :PV-INHSE-NBR                                     08010011
                 FROM TVNDDPT                                           08020011
               WHERE ENT_ID    = :PV-IH-ENT-ID                          08030011
               AND   DEPT_NBR  = :PV-DEPT-3-CHAR                        08040011
               WITH UR                                                  08050011
           END-EXEC.                                                    08060011
                                                                        08070011
           EVALUATE TRUE                                                08080011
               WHEN SQLCODE = 0                                         08090011
                   CONTINUE                                             08100011
                   CONTINUE                                             08101027
               WHEN SQLCODE = +100                                      08110011
                   MOVE 1        TO PV-INHSE-NBR                        08120011
               WHEN OTHER                                               08130011
                   MOVE '4525-SELECT-INHOUSE                 '          08140011
                                       TO AA-PARAGRAPH-NAME             08150011
                   MOVE 'TVNDDPT TABLES ERROR'                          08160011
                                       TO AA-MESSAGE                    08170011
                   MOVE 'SELECT'       TO AA-DB2-OPERATION              08180011
                   PERFORM 9901-SQL-ERROR                               08190011
           END-EVALUATE.                                                08200011
                                                                        08210011
                                                                        08510011
                                                                        08520011
      ******************************************************************08530012
       5000-LOOKUP-EIR-EIC-2.                                           08540012
      ******************************************************************08550012
                                                                        08567030
           IF ML556-PREV-LWST-ID = PV-SAVE-FROM-EIR-LWST-ID             08570029
              IF PS-EIR-EIC-2-ERROR-NO                                  08580023
                  MOVE PV-SAVE-CMU-PCT TO PV-CMU-PCT                    08590012
              ELSE                                                      08600012
                  MOVE PC-ENODBVROW TO ML556-ERR-WRN-DATA               08610012
                  PERFORM 7800-WRITE-ERR-WRN                            08620012
              END-IF                                                    08630012
           ELSE                                                         08640012
              SET PS-EIR-EIC-2-ERROR-NO TO TRUE                         08650023
              MOVE ML556-PREV-LWST-ID TO PV-SAVE-FROM-EIR-LWST-ID       08660029
              PERFORM 5100-GET-EIR-EIC2                                 08670012
              IF PS-EIR-EIC-2-ERROR-NO                                  08680023
                  MOVE PV-CMU-PCT TO PV-SAVE-CMU-PCT                    08690013
              ELSE                                                      08691039
                  MOVE PC-ENODBVROW TO ML556-ERR-WRN-DATA               08692039
                  PERFORM 7800-WRITE-ERR-WRN                            08693039
              END-IF                                                    08700013
           END-IF.                                                      08710012
                                                                        08720012
                                                                        08730012
      ******************************************************************08740012
       5100-GET-EIR-EIC2.                                               08750012
      ******************************************************************08760012
                                                                        08770012
           EXEC SQL                                                     08780012
               SELECT END_INV_RTL_AMT                                   08790012
                     ,END_INV_COST2_AMT                                 08800012
                 INTO :MLT00010-END-INV-RTL-AMT                         08810012
                     ,:MLT00010-END-INV-COST2-AMT                       08820012
                 FROM MLT_DEPT_BRND_VND                                 08830012
               WHERE (PARTN_NBR = :PT-PARTN-NBR-1 OR                    08840012
                      PARTN_NBR = :PT-PARTN-NBR-2 OR                    08850012
                      PARTN_NBR = :PT-PARTN-NBR-3 OR                    08860012
                      PARTN_NBR = :PT-PARTN-NBR-4 OR                    08870012
                      PARTN_NBR = :PT-PARTN-NBR-5 OR                    08880012
                      PARTN_NBR = :PT-PARTN-NBR-6 OR                    08890012
                      PARTN_NBR = :PT-PARTN-NBR-7 OR                    08900012
                      PARTN_NBR = :PT-PARTN-NBR-8)                      08910012
               AND   (DEPT_NBR  = :ML556-CURR-DEPT-NBR)                 08920018
               AND   (ML_LO_MDSE_LVL_ID = :ML556-PREV-LWST-ID)          08930018
               WITH UR                                                  08940012
           END-EXEC.                                                    08950012
                                                                        08960012
           EVALUATE TRUE                                                08970012
               WHEN SQLCODE = 0                                         08980012
                   PERFORM 5200-COMPUTE-CMU-PCT                         08990013
               WHEN SQLCODE = +100                                      09000012
                   SET PS-EIR-EIC-2-ERROR-YES TO TRUE                   09010021
               WHEN OTHER                                               09020012
                   MOVE ' 5100-GET-EIR-EIC2      '                      09030012
                                       TO AA-PARAGRAPH-NAME             09040012
                   MOVE 'MLT_DEPT_BRND_VND   '                          09050012
                                       TO AA-MESSAGE                    09060012
                   MOVE 'SELECT'       TO AA-DB2-OPERATION              09070012
                   PERFORM 9901-SQL-ERROR                               09080012
           END-EVALUATE.                                                09090012
                                                                        09100012
                                                                        09110000
      ******************************************************************09120013
       5200-COMPUTE-CMU-PCT.                                            09130013
      ******************************************************************09140013
                                                                        09155030
           IF MLT00010-END-INV-RTL-AMT = ZEROS                          09160013
               IF MLT00010-END-INV-COST2-AMT = ZEROS                    09170013
                   MOVE ZEROS TO PV-CMU-PCT                             09180013
               ELSE                                                     09190013
                   MOVE +1    TO PV-CMU-PCT                             09200013
           ELSE                                                         09210013
               COMPUTE PV-CMU-PCT ROUNDED =                             09220013
                       1 -  (MLT00010-END-INV-COST2-AMT                 09230030
                            / MLT00010-END-INV-RTL-AMT)                 09240030
           END-IF.                                                      09250013
                                                                        09260014
                                                                        09265031
      ******************************************************************09270014
       6000-GET-TUPCPLS.                                                09280014
      ******************************************************************09290014
                                                                        09310014
           INITIALIZE DCLTUPCPLS.                                       09320014
                                                                        09330014
           SET PS-TUPCPLS-STR-FOUND-NO TO TRUE.                         09340014
           SET PS-TUPCPLS-000-FOUND-NO TO TRUE.                         09350014
           SET PS-TUPCPLS-ERROR-NO TO TRUE.                             09351021
                                                                        09360014
           PERFORM 6010-SELECT-TUPCPLS-STR-RCD.                         09370014
                                                                        09380014
           IF PS-TUPCPLS-STR-FOUND-NO                                   09390014
               PERFORM 6020-SELECT-TUPCPLS-000-RCD                      09400014
           END-IF.                                                      09410014
                                                                        09420014
           IF PS-TUPCPLS-STR-FOUND-NO                                   09430014
               AND PS-TUPCPLS-000-FOUND-NO                              09440014
                   DISPLAY 'STR 000 NOT FND FOR ITM '                   09450014
                                       ML556-PREV-ITM-NBR               09460017
                   MOVE PC-ERR-TUPCPLS TO ML556-ERR-WRN-DATA            09461035
                   PERFORM 7800-WRITE-ERR-WRN                           09462034
                   MOVE ZEROS        TO PV-UNT-RTL-AMT                  09470014
                   SET PS-TUPCPLS-ERROR-YES TO TRUE                     09471021
           ELSE                                                         09472034
               COMPUTE ML556-EXTD-RTL-AMT                               09474034
                     = PV-UNT-RTL-AMT  *  ML556-ONHAND-QTY              09475034
                                                                        09476034
           END-IF.                                                      09480014
                                                                        09490016
                                                                        09550016
      ******************************************************************09560016
       6010-SELECT-TUPCPLS-STR-RCD.                                     09570016
      ******************************************************************09580016
                                                                        09590016
           MOVE PV-PREV-EOM-DATE       TO PV-PREV-DTE.                  09600021
           MOVE PV-TMST                TO PV-TIMESTAMP.                 09610018
                                                                        09620016
           EXEC SQL                                                     09630016
               SELECT  UNT_RTL_AMT                                      09640016
                 INTO :PV-UNT-RTL-AMT                                   09650016
                 FROM TUPCPLS                                           09660016
                 WHERE  UPC_ID        = :ML556-PREV-INTR-UPC-ID         09670018
                 AND    ITM_NBR       = :ML556-PREV-ITM-NBR             09671017
                 AND    OPERCO_NBR    = :PC-03-C                        09680016
                 AND    STR_NBR       = :ML556-LOC-NBR                  09690016
                 AND    EFF_BEG_TMST <= :PV-TIMESTAMP                   09700018
                 AND   (EFF_END_TMST >= :PV-TIMESTAMP                   09710018
                 OR     EFF_END_TMST IS NULL)                           09720016
               WITH UR                                                  09730016
           END-EXEC.                                                    09740016
                                                                        09750016
           EVALUATE TRUE                                                09760016
               WHEN SQLCODE = 0                                         09770016
                   SET PS-TUPCPLS-STR-FOUND-YES TO TRUE                 09780016
               WHEN SQLCODE = +100                                      09790016
                   CONTINUE                                             09800016
               WHEN OTHER                                               09810016
                   MOVE '6010-SELECT-TUPCPLS-STR-RCD'                   09820016
                                       TO AA-PARAGRAPH-NAME             09830016
                   MOVE 'TUPCPLS TABLES ERROR'                          09840016
                                       TO AA-MESSAGE                    09850016
                   MOVE 'SELECT'       TO AA-DB2-OPERATION              09860016
                   PERFORM 9901-SQL-ERROR                               09870016
           END-EVALUATE.                                                09880016
                                                                        09890016
      ******************************************************************09900016
       6020-SELECT-TUPCPLS-000-RCD.                                     09910016
      ******************************************************************09920016
                                                                        09930016
           MOVE PV-PREV-EOM-DATE       TO PV-PREV-DTE.                  09940021
           MOVE PV-TMST                TO PV-TIMESTAMP.                 09950020
                                                                        09960016
           EXEC SQL                                                     09970016
               SELECT UNT_RTL_AMT                                       09980016
                 INTO :PV-UNT-RTL-AMT                                   09990016
                 FROM TUPCPLS                                           10000016
                 WHERE  UPC_ID        = :ML556-PREV-INTR-UPC-ID         10010018
                 AND    ITM_NBR       = :ML556-PREV-ITM-NBR             10011017
                 AND    OPERCO_NBR    = :PC-03-C                        10020016
                 AND    STR_NBR       = :PC-000-COMP                    10030016
                 AND    EFF_BEG_TMST <= :PV-TIMESTAMP                   10040020
                 AND   (EFF_END_TMST >= :PV-TIMESTAMP                   10050020
                 OR     EFF_END_TMST IS NULL)                           10060016
               WITH UR                                                  10070016
           END-EXEC.                                                    10080016
                                                                        10090016
           EVALUATE TRUE                                                10100016
               WHEN SQLCODE = 0                                         10110016
                   SET PS-TUPCPLS-000-FOUND-YES TO TRUE                 10120016
               WHEN SQLCODE = +100                                      10130016
                   CONTINUE                                             10140016
               WHEN OTHER                                               10150016
                   MOVE '6020-SELECT-TUPCPLS-000-RCD'                   10160016
                                       TO AA-PARAGRAPH-NAME             10170016
                   MOVE 'TUPCPLS TABLES ERROR'                          10180016
                                       TO AA-MESSAGE                    10190016
                   MOVE 'SELECT'       TO AA-DB2-OPERATION              10200016
                   PERFORM 9901-SQL-ERROR                               10210016
           END-EVALUATE.                                                10220016
                                                                        10230013
                                                                        10230117
      ******************************************************************10230217
       7000-COMPUTE-PADJ-COST.                                          10231017
      ******************************************************************10231117
                                                                        10232117
           COMPUTE ML556-EXTD-COST-AMT ROUNDED =                        10233017
                (1 - PV-SAVE-CMU-PCT) * ML556-EXTD-RTL-AMT.             10235017
                                                                        10236017
                                                                        10237017
                                                                        10238017
      ******************************************************************10240000
       7800-WRITE-ERR-WRN.                                              10250011
      ******************************************************************10260000
                                                                        10270000
           WRITE ERROR-WARN-REC  FROM ML556-CURR-PREV-SKU-ATTR-REC.     10280021
                                                                        10290012
           IF ML556-ERR-WRN-TYPE-CDE = PC-W                             10291037
               ADD 1 TO PA-WRN-CNT                                      10300037
           ELSE                                                         10301037
               ADD 1 TO PA-ERR-CNT.                                     10302039
                                                                        10310000
           MOVE SPACES TO ML556-ERR-WRN-DATA.                           10320012
                                                                        10330000
      ******************************************************************10340000
       7900-WRITE-UPD-SKU-ATTR-FILE.                                    10350017
      ******************************************************************10360000
                                                                        10370000
           WRITE UPD-CURR-PREV-SKU-ATTR-REC FROM                        10380021
                                     ML556-CURR-PREV-SKU-ATTR-REC.      10390013
                                                                        10400000
           ADD 1 TO PA-SKU-RECS-OUT-CNT.                                10410017
                                                                        10420000
                                                                        10440000
      ******************************************************************10450000
       9000-EOJ.                                                        10460000
      ******************************************************************10470000
      *                                                                 10480000
                                                                        10490000
           DISPLAY ' '.                                                 10500000
           DISPLAY '  PROGRAM MLKUT217 PROCESSING SUMMARY'.             10510002
           DISPLAY '  -----------------------------------'.             10520000
           DISPLAY ' '.                                                 10530000
           DISPLAY ' PA-SKU-RECS-IN-CNT  '                              10540017
                         PA-SKU-RECS-IN-CNT.                            10550000
           DISPLAY ' PA-SKU-RECS-OUT-CNT '                              10560000
                         PA-SKU-RECS-OUT-CNT.                           10570000
           DISPLAY ' PA-ERR-CNT          '                              10571037
                         PA-ERR-CNT.                                    10572037
           DISPLAY ' PA-WRN-CNT          '                              10573037
                         PA-WRN-CNT.                                    10574037
                                                                        10580000
           CLOSE DATE-CONTROL-FILE                                      10590019
                 SKU-CURR-PREV-ATTR-FILE                                10600000
                 USE-TUPCPLS-CONTROL-FILE                               10601017
                 UPD-CURR-PREV-SKU-ATTR-FILE                            10610021
                 ERROR-WARN-FILE.                                       10620000
                                                                        10630000
       EJECT                                                            10640000
                                                                        10650000
                                                                        10660000
                                                                        10670000
      ******************************************************************10680000
       9900-COMMON-ABEND-ROUTINE.                                       10690000
      ******************************************************************10700000
      *                                                                 10710000
           DISPLAY AA-ABEND-LIT.                                        10720000
           DISPLAY AA-PROGRAM-LIT.                                      10730000
           DISPLAY AA-PARAGRAPH-LIT.                                    10740000
           DISPLAY AA-MESSAGE-LINE.                                     10750000
           DISPLAY ABEND-CODE.                                          10760000
                                                                        10770000
           PERFORM 9999-ABEND.                                          10780000
                                                                        10790000
       EJECT                                                            10800000
                                                                        10810000
      ******************************************************************10820000
       9901-SQL-ERROR.                                                  10830000
      ******************************************************************10840000
      *                                                                 10850000
           CLOSE DATE-CONTROL-FILE                                      10860000
                 SKU-CURR-PREV-ATTR-FILE                                10861017
                 USE-TUPCPLS-CONTROL-FILE                               10870017
                 UPD-CURR-PREV-SKU-ATTR-FILE                            10890021
                 ERROR-WARN-FILE.                                       10900000
                                                                        10910000
           DISPLAY AA-ABEND-LIT.                                        10920000
           DISPLAY AA-DB2-ERROR-LIT.                                    10930000
           DISPLAY AA-PROGRAM-LIT.                                      10940000
           DISPLAY AA-PARAGRAPH-LIT.                                    10950000
           DISPLAY AA-MESSAGE-LINE.                                     10960000
           DISPLAY AA-DB2-OPERATION-LIT.                                10970000
           SET AC-DB2-ERROR TO TRUE.                                    10980000
           MOVE +4013                  TO ABEND-CODE.                   10990000
                                                                        11000000
           COPY DPPD004.                                                11010000
           PERFORM 9999-ABEND.                                          11020000
                                                                        11030000
       9999-ABEND.                                                      11040000
                                                                        11050000
           CALL 'ILBOABN0' USING ABEND-CODE.                            11060000
                                                                        11070000
