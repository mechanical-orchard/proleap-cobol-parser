       IDENTIFICATION DIVISION.                                         00010002
       PROGRAM-ID.    MLKUT970.                                         00020002
       AUTHOR.        B. GRAHAM - STRATAGEM.                            00030002
       INSTALLATION.  KOHLS DEPARTMENT STORES.                          00040002
       DATE-WRITTEN.  07/08/07.                                         00050002
       DATE-COMPILED.                                                   00060002
                                                                        00070002
      ******************************************************************00080002
      * THIS PROGRAM WILL CREATE ADJUSTMENTS TO THE END INV COST        00090002
      * MOVING UNKNOWN VENDOR/BRAND EIC TO LOC 400 AND PRORATING        00100002
      * THE AMOUNTS TO THE KNOWN VENDOR/BRANDS BASED UPON THEIR EIC     00110002
      * PERCENT OF THE TOTAL EIC OF ALL OF THE KNOWNS FOR THAT DEPT.    00120002
      * THIS IS A TWO TIME SHOT (JANUARY AND MAY). NO DATE CHECKS       00130002
      * WERE DONE AGAINST THE UNKNOWN RELATIONSHIP TABLE BECAUSE        00140002
      * NONE OF THE UNKNOWN / UNKNOWN RELATIONSHIPS ARE EXPIRED.        00150002
      ******************************************************************00160002
                                                                        00170002
      ******************************************************************00180002
       ENVIRONMENT DIVISION.                                            00190002
      ******************************************************************00200002
                                                                        00210002
       CONFIGURATION SECTION.                                           00220002
                                                                        00230002
       SOURCE-COMPUTER.        IBM-3090.                                00240002
       OBJECT-COMPUTER.        IMB-3090.                                00250002
                                                                        00260002
       INPUT-OUTPUT SECTION.                                            00270002
                                                                        00280002
       FILE-CONTROL.                                                    00290002
           SELECT CNTL-DATE-FILE                                        00300002
               ASSIGN TO INP01.                                         00310002
           SELECT REVERSAL-OUTPUT-FILE                                  00320002
               ASSIGN TO OUT01.                                         00330002
           SELECT PRORATED-OUTPUT-FILE                                  00340002
               ASSIGN TO OUT02.                                         00350002
           SELECT NO-CANDIDATE-FILE                                     00351002
               ASSIGN TO OUT03.                                         00352002
      ******************************************************************00353002
       DATA DIVISION.                                                   00354002
      ******************************************************************00355002
                                                                        00356002
       FILE SECTION.                                                    00357002
                                                                        00358002
       FD  CNTL-DATE-FILE                                               00359002
           RECORDING  MODE IS F.                                        00360002
       01  CNTL-DATE-REC                    PIC X(80).                  00370002
                                                                        00380002
       FD  REVERSAL-OUTPUT-FILE                                         00390002
           RECORDING  MODE IS F.                                        00400002
       01  REVERSAL-OUTPUT-REC              PIC X(017).                 00410002
                                                                        00420002
       FD  PRORATED-OUTPUT-FILE                                         00430002
           RECORDING  MODE IS F.                                        00440002
       01  PRORATED-OUTPUT-REC              PIC X(017).                 00450002
                                                                        00460002
       FD  NO-CANDIDATE-FILE                                            00470002
           RECORDING  MODE IS F.                                        00480002
       01  NO-CANDIDATE-REC                 PIC X(017).                 00490002
                                                                        00500002
       WORKING-STORAGE SECTION.                                         00510002
                                                                        00520002
       01  ABEND-CODE                        PIC S9(4) VALUE ZEROS      00530002
                                                       COMP SYNC.       00540002
           88  AC-OTHER-ERROR                          VALUE +4003.     00550002
           88  AC-SQL-ERROR                            VALUE +4013.     00560002
                                                                        00570002
       01  PS-PROGRAM-SWITCHES.                                         00580002
           05  PS-CNTL-DATE-FILE-SW          PIC X     VALUE 'N'.       00590002
               88  PS-END-OF-CNTL-DTE-FILE             VALUE 'Y'.       00600002
           05  PS-PARTN-DONE-SW              PIC X     VALUE 'N'.       00610002
               88  PS-PARTN-DONE-YES                   VALUE 'Y'.       00620002
               88  PS-PARTN-DONE-NO                    VALUE 'N'.       00630002
           05  PS-UNK-UNK-VW-CSR-AT-SW       PIC X     VALUE 'N'.       00640002
               88  PS-UNK-UNK-VW-CSR-AT-END-YES        VALUE 'Y'.       00650002
               88  PS-UNK-UNK-VW-CSR-AT-END-NO         VALUE 'N'.       00660002
           05  PS-UNK-MNLY-AT-END-SW         PIC X     VALUE 'N'.       00670002
               88  PS-UNK-MNLY-AT-END-YES              VALUE 'Y'.       00680002
               88  PS-UNK-MNLY-AT-END-NO               VALUE 'N'.       00690002
           05  PS-KNO-MNLY-AT-END-SW         PIC X     VALUE 'N'.       00700002
               88  PS-KNO-MNLY-AT-END-YES              VALUE 'Y'.       00710002
               88  PS-KNO-MNLY-AT-END-NO               VALUE 'N'.       00720002
                                                                        00721002
       01  ABEND-CODE-SQL              PIC S9(04)  VALUE ZERO COMP SYNC.00722002
                                                                        00723002
       01  PC-PROGRAM-CONSTANTS.                                        00724002
           05 PC-PGM-NAME                  PIC X(8)  VALUE 'MLKUT970'.  00725002
           05 PC-MAX-9999                  PIC S9(05)         COMP-3    00726002
                                                      VALUE 9999.       00727002
           05 PC-MAX-RETRIES               PIC S9(03) VALUE 3 COMP-3.   00728002
           05 PC-BV-START-DATE             PIC X(10) VALUE '2004-10-31'.00729002
           05 PC-M                         PIC X(01) VALUE 'M'.         00730002
           05 PC-EIC-ZERO                  PIC S9(11)V9(2) VALUE ZERO   00740002
                                                           COMP-3.      00750002
                                                                        00760002
       01  PV-PROGRAM-VARIABLES.                                        00770002
           05 PV-DATE-FIELDS.                                           00780002
              10 PV-PROCESS-DATE             PIC   X(10).               00790002
           05 PV-MISC.                                                  00800002
              10 PV-RETRY-COUNTER            PIC S9(04) COMP.           00810002
              10 PV-WRITE-COUNT              PIC S9(09) COMP-3 VALUE 0. 00820002
              10 PV-PARAGRAPH-NAME           PIC X(30)  VALUE SPACES.   00830002
              10 PV-DB2-DATE-EXISTS          PIC X(01).                 00840002
              10 PV-PARTN-CNT                PIC 9(01)  VALUE 0.        00850002
              10 PV-DEPT-9                  PIC S9(04)V COMP-3 VALUE 0. 00860002
              10 PV-DISP-MDSE-LVL-ID         PIC 9(09).                 00870002
              10 PV-DISP-DEPT-NBR            PIC 9(05).                 00880002
              10 PV-DISP-PARTN-NBR           PIC 9(04).                 00890002
           05 PV-PRORATION-PCT               PIC S9(3)V9(7) COMP-3.     00900002
           05 PV-SQLCODE                     PIC S9(04) VALUE ZERO.     00910002
           05 PV-TOTALS.                                                00920002
              10  PV-REVERSAL-COUNT          PIC   9(11) VALUE ZEROS.   00930002
              10  PV-PRORATED-COUNT          PIC  9(11) VALUE ZEROS.    00940002
              10  PV-NOCANDID-COUNT          PIC  9(11) VALUE ZEROS.    00950002
              10  PV-TOT-COST-WRITTEN        PIC  S9(11)V9(2) COMP-3    00960002
                                                     VALUE ZERO.        00970002
                                                                        00980002
           05 PV-WORK-FIELDS.                                           00990002
              10  PV-SHARE-AMT                  PIC  S9(11)V9(2) COMP-3 01000002
                                                     VALUE ZERO.        01010002
              10  PV-TOT-SHARE-AMT-WRITTEN      PIC  S9(11)V9(2) COMP-3 01020002
                                                     VALUE ZERO.        01030002
       01  PV-UNK-UNK-VIEW-WORK-AREA.                                   01040002
           10 PV-UUV-LO-MDSE-LVL-ID         PIC   S9(09) COMP           01050002
                                                     VALUE ZERO.        01060002
           10 PV-UUV-DEPT-NBR               PIC   S9(04)V COMP-3        01070002
                                                     VALUE ZERO.        01080002
       01  PV-UNK-UNK-MNLY-WORK-AREA.                                   01090002
           10 PV-UUM-END-INV-COST2-AMT      PIC   S9(11)V99 COMP-3      01100002
                                                     VALUE ZERO.        01110002
       01  PV-KNO-KNO-MNLY-WORK-AREA.                                   01120002
           10 PV-KKM-LO-MDSE-LVL-ID         PIC   S9(09) COMP           01130002
                                                     VALUE ZERO.        01140002
           10 PV-KKM-END-INV-COST2-AMT      PIC   S9(11)V99 COMP-3      01150002
                                                     VALUE ZERO.        01160002
                                                                        01170002
       01  PV-REVERSAL-OUTPUT-REC.                                      01180002
           10 PV-ROR-TYPE-REV VALUE 'REV'   PIC   X(03).                01190002
           10 PV-ROR-DEPT-NBR               PIC   S9(04)V COMP-3.       01200002
           10 PV-ROR-IN-LO-MDSE-LVL-ID      PIC  S9(9) COMP.            01210002
           10 PV-ROR-END-INV-COST2-AMT      PIC  S9(11)V9(2) COMP-3.    01220002
                                                                        01230002
                                                                        01240002
       01  PV-PRORATED-OUTPUT-REC.                                      01250002
           10 PV-POR-TYPE-PRO VALUE 'PRO'   PIC   X(03).                01260002
           10 PV-POR-DEPT-NBR               PIC   S9(04)V COMP-3.       01270002
           10 PV-POR-IN-LO-MDSE-LVL-ID      PIC  S9(9) COMP.            01280002
           10 PV-POR-END-INV-COST2-AMT      PIC  S9(11)V9(2) COMP-3.    01290002
                                                                        01300002
       01  PV-NO-CANDIDATE-REC.                                         01310002
           10 PV-NOC-TYPE-PRO VALUE 'NOC'   PIC   X(03).                01311002
           10 PV-NOC-DEPT-NBR               PIC   S9(04)V COMP-3.       01312002
           10 PV-NOC-IN-LO-MDSE-LVL-ID      PIC  S9(9) COMP.            01313002
           10 PV-NOC-END-INV-COST2-AMT      PIC  S9(11)V9(2) COMP-3.    01314002
                                                                        01315002
                                                                        01316002
       01  PV-PARTN-TBL.                                                01317002
           05  PV-PARTN-NBR-1               PIC  S9(4) COMP VALUE +0.   01318002
           05  PV-PARTN-NBR-2               PIC  S9(4) COMP VALUE +0.   01319002
           05  PV-PARTN-NBR-3               PIC  S9(4) COMP VALUE +0.   01320002
           05  PV-PARTN-NBR-4               PIC  S9(4) COMP VALUE +0.   01330002
           05  PV-PARTN-NBR-5               PIC  S9(4) COMP VALUE +0.   01340002
           05  PV-PARTN-NBR-6               PIC  S9(4) COMP VALUE +0.   01350002
           05  PV-PARTN-NBR-7               PIC  S9(4) COMP VALUE +0.   01360002
           05  PV-PARTN-NBR-8               PIC  S9(4) COMP VALUE +0.   01370002
       01  PV-PARTN-ENTRIES REDEFINES PV-PARTN-TBL.                     01380002
           05  PV-PARTN-ENTRY                                           01390002
                            OCCURS 8 TIMES  PIC  S9(4) COMP.            01400002
                                                                        01410002
      ***************************************************************** 01420002
      *  CONTROL CARD WITH DATE FOR CURSOR.                             01430002
      ***************************************************************** 01440002
       01  CC-CONTROL-CARD.                                             01450002
           05  CC-PROC-DATE-ISO                PIC X(10).               01460002
           05  CC-PROC-DATE-RDF  REDEFINES                              01470002
               CC-PROC-DATE-ISO.                                        01480002
               10  CC-PROC-CC                  PIC X(02).               01490002
               10  CC-PROC-YY                  PIC X(02).               01500002
               10  FILLER                      PIC X(01).               01510002
               10  CC-PROC-MM                  PIC X(02).               01520002
               10  FILLER                      PIC X(01).               01530002
               10  CC-PROC-DD                  PIC X(02).               01540002
           05  FILLER                          PIC X(70).               01550002
                                                                        01560002
      ***************************************************************** 01570002
      *  VENDOR BRAND SUMMARY TABLE                                     01580002
      ***************************************************************** 01590002
       01  PV-VENDOR-BRAND-SUMMARY-TABLE.                               01600002
           05  PV-VB-TOT-END-INV-COST2-AMT     PIC S9(11)V9(2) COMP-3   01610002
                                                      VALUE +0.         01620002
           05  PV-VB-TBL-CNT                   PIC S9(05) VALUE +0.     01630002
           05  PV-VB-TBL-SUB                   PIC S9(05) VALUE +0.     01640002
           05  VB-SUM-ENTRY OCCURS 9999 TIMES.                          01650002
               10  PV-VB-MDSE-LVL-ID           PIC S9(09) COMP          01660002
                                                          VALUE +0.     01670002
               10  PV-VB-END-INV-COST2-AMT     PIC S9(11)V9(2) COMP-3   01680002
                                                          VALUE +0.     01690002
      ******************************************************************01700002
      *  DB2 SQL ERROR MESSAGE FORMAT AREA                              01710002
      ******************************************************************01720002
           COPY DPWS004.                                                01730002
                                                                        01740002
      ******************************************************************01750002
      * MERCHANDISE LEDGER DEPT/BRAND/VENDOR RELATIONSHIP VIEW          01760002
      ******************************************************************01770002
           EXEC SQL                                                     01780002
             INCLUDE MLV00000                                           01790002
           END-EXEC.                                                    01800002
      ******************************************************************01810002
      * DATE ATTRIBUTE TABLE                                            01820002
      ******************************************************************01830002
           EXEC SQL                                                     01840002
             INCLUDE TDTATTR                                            01850002
           END-EXEC.                                                    01860002
      ******************************************************************01870002
      * PARTITION NUMBER TABLE                                          01880002
      ******************************************************************01890002
           EXEC SQL                                                     01900002
             INCLUDE MLT00003                                           01910002
           END-EXEC.                                                    01920002
      ******************************************************************01930002
      * MLT_MNLY_SUM TABLE                                              01940002
      ******************************************************************01950002
           EXEC SQL                                                     01960002
             INCLUDE MLT00004                                           01970002
           END-EXEC.                                                    01980002
      ***************************************************************** 01990002
      *    DB2 AREA FOR COMMUNICATIONS                                * 02000002
      ***************************************************************** 02010002
           EXEC SQL                                                     02020002
                INCLUDE SQLCA                                           02030002
           END-EXEC.                                                    02040002
                                                                        02050002
      ***************************************************************** 02060002
      * CURSOR FOR LIST OF UNKNOWN VENDORS/BRANDS FOR EACH DEPT       * 02070002
      *                                                               * 02080002
      ***************************************************************** 02090002
           EXEC SQL                                                     02100002
                DECLARE UNK_UNK_VIEW_CSR CURSOR WITH HOLD FOR           02110002
                SELECT ML_LO_MDSE_LVL_ID                                02120002
                      ,DEPT_NBR                                         02130002
                FROM MLV_BRND_VND                                       02140002
                WHERE ENT_ID = 5161                                     02150002
                  AND LBL_SEQ_NBR = 2230                                02160002
                ORDER BY DEPT_NBR                                       02170002
                        ,ML_LO_MDSE_LVL_ID                              02180002
                   FOR FETCH ONLY                                       02190002
                   WITH UR                                              02200002
           END-EXEC.                                                    02210002
                                                                        02220002
      ***************************************************************** 02230002
      * CURSOR FOR MNLY_SUM UNKNOWN/UNKNOWN FOR A GIVEN DEPT            02240002
      * THIS WILL BE REVERSED OFF IF THERE ARE KNO/KNO ENTRIES IN       02250002
      * MNLY_SUM                                                        02260002
      ***************************************************************** 02270002
           EXEC SQL                                                     02280002
                DECLARE UNK_UNK_MNLY_CSR CURSOR WITH HOLD FOR           02290002
                SELECT SUM (END_INV_COST2_AMT)                          02300002
                FROM MLT_MNLY_SUM                                       02310002
                WHERE PARTN_NBR IN (:PV-PARTN-NBR-1,                    02320002
                                    :PV-PARTN-NBR-2,                    02330002
                                    :PV-PARTN-NBR-3,                    02340002
                                    :PV-PARTN-NBR-4,                    02350002
                                    :PV-PARTN-NBR-5,                    02360002
                                    :PV-PARTN-NBR-6,                    02370002
                                    :PV-PARTN-NBR-7,                    02380002
                                    :PV-PARTN-NBR-8)                    02390002
                  AND DEPT_NBR = :PV-UUV-DEPT-NBR                       02400002
                  AND ML_LO_MDSE_LVL_ID = :PV-UUV-LO-MDSE-LVL-ID        02410002
                  AND END_INV_COST2_AMT <> :PC-EIC-ZERO                 02420002
                   FOR FETCH ONLY                                       02430002
                   WITH UR                                              02440002
           END-EXEC.                                                    02450002
                                                                        02460002
      ***************************************************************** 02470002
      * CURSOR FOR MNLY_SUM KNOWN/KNOWN/ VENDOR BRANDS FOR A GIVEN DEPT 02480002
      *                                                                 02490002
      ***************************************************************** 02500002
           EXEC SQL                                                     02510002
                DECLARE KNO_KNO_MNLY_CSR CURSOR WITH HOLD FOR           02520002
                SELECT A.ML_LO_MDSE_LVL_ID                              02530002
                  ,SUM (A.END_INV_COST2_AMT)                            02540002
                FROM MLT_MNLY_SUM A,                                    02550002
                     MLV_BRND_VND B                                     02560002
                WHERE A.PARTN_NBR IN (:PV-PARTN-NBR-1,                  02570002
                                      :PV-PARTN-NBR-2,                  02580002
                                      :PV-PARTN-NBR-3,                  02590002
                                      :PV-PARTN-NBR-4,                  02600002
                                      :PV-PARTN-NBR-5,                  02610002
                                      :PV-PARTN-NBR-6,                  02620002
                                      :PV-PARTN-NBR-7,                  02630002
                                      :PV-PARTN-NBR-8)                  02640002
                  AND A.DEPT_NBR = :PV-UUV-DEPT-NBR                     02650002
                  AND A.DEPT_NBR = B.DEPT_NBR                           02660002
                  AND B.ENT_ID      <> 5161                             02670002
                  AND B.LBL_SEQ_NBR <> 2230                             02680002
                  AND A.ML_LO_MDSE_LVL_ID = B.ML_LO_MDSE_LVL_ID         02690002
                  AND A.END_INV_COST2_AMT <> :PC-EIC-ZERO               02700002
                 GROUP BY A.ML_LO_MDSE_LVL_ID                           02710002
                   FOR FETCH ONLY                                       02720002
                   WITH UR                                              02730002
           END-EXEC.                                                    02740002
                                                                        02750002
                                                                        02760002
      ***************************************************************** 02770002
      *    THIS CURSOR RETRIEVES PARTITION NUMBERS FOR ACCESS TO      * 02780002
      *    MLT_MNLY-SUM TABLE                                         * 02790002
      ***************************************************************** 02800002
                                                                        02810002
           EXEC SQL                                                     02820002
                DECLARE PARTN_NBR_CSR CURSOR WITH HOLD FOR              02830002
                SELECT PARTN_NBR                                        02840002
                  FROM MLT_PARTN_CNTL                                   02850002
                 WHERE TBL_TM_LVL_CDE =:PC-M                            02860002
                   AND FSCL_DTE = :PV-PROCESS-DATE                      02870002
                 ORDER BY PARTN_NBR                                     02880002
                   FOR FETCH ONLY                                       02890002
           END-EXEC.                                                    02900002
                                                                        02910002
      ******************************************************************02920002
       PROCEDURE DIVISION.                                              02930002
      ******************************************************************02940002
                                                                        02950002
       0000-MAINLINE.                                                   02960002
                                                                        02970002
           PERFORM 1000-INITIALIZE                                      02980002
                                                                        02990002
           PERFORM 2000-OPEN-UNK-UNK-VIEW-CSR.                          03000002
                                                                        03010002
           SET PS-UNK-UNK-VW-CSR-AT-END-NO TO TRUE.                     03020002
                                                                        03030002
           PERFORM 2020-PROCESS-UNK-UNK-CSR                             03040002
             UNTIL PS-UNK-UNK-VW-CSR-AT-END-YES.                        03050002
                                                                        03060002
           PERFORM 2010-CLOSE-UNK-UNK-VIEW-CSR.                         03070002
                                                                        03080002
           DISPLAY 'PV-REVERSAL-COUNT ' PV-REVERSAL-COUNT.              03090002
           DISPLAY 'PV-PRORATED-COUNT ' PV-PRORATED-COUNT.              03100002
           DISPLAY 'PV-NOCANDID-COUNT ' PV-NOCANDID-COUNT.              03110002
                                                                        03120002
           CLOSE CNTL-DATE-FILE                                         03130002
                 REVERSAL-OUTPUT-FILE                                   03140002
                 PRORATED-OUTPUT-FILE                                   03150002
                 NO-CANDIDATE-FILE.                                     03160002
                                                                        03170002
           STOP RUN.                                                    03180002
                                                                        03190002
      ******************************************************************03200002
      *  PERFORM THE NECESSARY INITIALIZATION STEPS                     03210002
      ******************************************************************03220002
       1000-INITIALIZE.                                                 03230002
                                                                        03240002
           OPEN INPUT  CNTL-DATE-FILE                                   03250002
                OUTPUT REVERSAL-OUTPUT-FILE                             03260002
                       PRORATED-OUTPUT-FILE                             03270002
                       NO-CANDIDATE-FILE.                               03280002
                                                                        03290002
           PERFORM 9000-READ-CNTL-DTE.                                  03300002
                                                                        03310002
           PERFORM 3000-GET-PROCESS-DATE-INFO.                          03320002
                                                                        03330002
           PERFORM 3100-GET-PARTITIONS.                                 03340002
                                                                        03350002
           MOVE PV-PARTN-NBR-1 TO PV-DISP-PARTN-NBR.                    03360002
           DISPLAY 'PARTN-NBR-1 ' PV-DISP-PARTN-NBR.                    03370002
           MOVE PV-PARTN-NBR-2 TO PV-DISP-PARTN-NBR.                    03380002
           DISPLAY 'PARTN-NBR-2 ' PV-DISP-PARTN-NBR.                    03390002
           MOVE PV-PARTN-NBR-3 TO PV-DISP-PARTN-NBR.                    03400002
           DISPLAY 'PARTN-NBR-3 ' PV-DISP-PARTN-NBR.                    03410002
           MOVE PV-PARTN-NBR-4 TO PV-DISP-PARTN-NBR.                    03420002
           DISPLAY 'PARTN-NBR-4 ' PV-DISP-PARTN-NBR.                    03430002
           MOVE PV-PARTN-NBR-5 TO PV-DISP-PARTN-NBR.                    03440002
           DISPLAY 'PARTN-NBR-5 ' PV-DISP-PARTN-NBR.                    03450002
           MOVE PV-PARTN-NBR-6 TO PV-DISP-PARTN-NBR.                    03460002
           DISPLAY 'PARTN-NBR-6 ' PV-DISP-PARTN-NBR.                    03470002
           MOVE PV-PARTN-NBR-7 TO PV-DISP-PARTN-NBR.                    03480002
           DISPLAY 'PARTN-NBR-7 ' PV-DISP-PARTN-NBR.                    03490002
           MOVE PV-PARTN-NBR-8 TO PV-DISP-PARTN-NBR.                    03500002
           DISPLAY 'PARTN-NBR-8 ' PV-DISP-PARTN-NBR.                    03510002
                                                                        03520002
      ******************************************************************03530002
      *  PROCESS UNKNOWN/UNKNOWN ROWS FROM THE VIEW                     03540002
      ******************************************************************03550002
                                                                        03560002
       2000-OPEN-UNK-UNK-VIEW-CSR.                                      03570002
                                                                        03580002
            EXEC SQL                                                    03590002
                OPEN UNK_UNK_VIEW_CSR                                   03600002
            END-EXEC.                                                   03610002
                                                                        03620002
            EVALUATE TRUE                                               03630002
                WHEN SQLCODE = +0                                       03640002
                    CONTINUE                                            03650002
                WHEN SQLWARN NOT = SPACE                                03660002
                WHEN SQLCODE NOT = +0                                   03670002
                    MOVE '2000-OPEN-UNK-UNK-VIEW-CSR '                  03680002
                                                  TO PV-PARAGRAPH-NAME  03690002
                    PERFORM 9999-SQL-ABEND                              03700002
            END-EVALUATE.                                               03710002
                                                                        03720002
       2010-CLOSE-UNK-UNK-VIEW-CSR.                                     03730002
                                                                        03740002
           EXEC SQL                                                     03750002
               CLOSE UNK_UNK_VIEW_CSR                                   03760002
           END-EXEC.                                                    03770002
                                                                        03780002
           EVALUATE TRUE                                                03790002
               WHEN SQLCODE = +0                                        03800002
                   CONTINUE                                             03810002
               WHEN SQLWARN NOT = SPACE                                 03820002
               WHEN SQLCODE NOT = +0                                    03830002
                   MOVE '2010-CLOSE-UNK-UNK-VIEW-CSR '                  03840002
                                                  TO PV-PARAGRAPH-NAME  03850002
                   PERFORM 9999-SQL-ABEND                               03860002
           END-EVALUATE.                                                03870002
                                                                        03880002
       2020-PROCESS-UNK-UNK-CSR.                                        03890002
                                                                        03900002
           PERFORM 2030-FETCH-UNK-UNK-CSR.                              03910002
                                                                        03920002
           IF PS-UNK-UNK-VW-CSR-AT-END-NO                               03930002
              PERFORM 2040-PROCESS-UNK-UNK-VW.                          03940002
                                                                        03950002
       2030-FETCH-UNK-UNK-CSR.                                          03960002
                                                                        03970002
           EXEC SQL                                                     03980002
             FETCH UNK_UNK_VIEW_CSR                                     03990002
                INTO   :PV-UUV-LO-MDSE-LVL-ID                           04000002
                      ,:PV-UUV-DEPT-NBR                                 04010002
           END-EXEC.                                                    04020002
                                                                        04030002
           EVALUATE TRUE                                                04040002
               WHEN SQLCODE = +0                                        04050002
                    MOVE PV-UUV-DEPT-NBR TO PV-DISP-DEPT-NBR            04060002
                    DISPLAY ' IN 2030 PV-UUV-DEPT-NBR '                 04070002
                           PV-DISP-DEPT-NBR                             04080002
                    CONTINUE                                            04090002
               WHEN SQLCODE = +100                                      04100002
                   SET  PS-UNK-UNK-VW-CSR-AT-END-YES TO TRUE            04110002
               WHEN SQLWARN NOT = SPACE                                 04120002
               WHEN SQLCODE NOT = +0                                    04130002
                   MOVE '2030-FETCH-UNK-UNK-CSR'                        04140002
                                                 TO PV-PARAGRAPH-NAME   04150002
                   PERFORM 9999-SQL-ABEND                               04160002
           END-EVALUATE.                                                04170002
                                                                        04180002
       2040-PROCESS-UNK-UNK-VW.                                         04190002
                                                                        04200002
           PERFORM 2100-OPEN-UNK-MNLY-CSR.                              04210002
                                                                        04220002
           SET PS-UNK-MNLY-AT-END-NO TO TRUE.                           04230002
                                                                        04240002
           PERFORM 2120-PROCESS-UNK-MNLY                                04250002
               UNTIL PS-UNK-MNLY-AT-END-YES.                            04260002
                                                                        04270002
           PERFORM 2110-CLOSE-UNK-MNLY-CSR.                             04280002
                                                                        04290002
       2100-OPEN-UNK-MNLY-CSR.                                          04300002
                                                                        04310002
            EXEC SQL                                                    04320002
                OPEN UNK_UNK_MNLY_CSR                                   04330002
            END-EXEC.                                                   04340002
                                                                        04350002
            EVALUATE TRUE                                               04360002
                WHEN SQLCODE = +0                                       04370002
                    CONTINUE                                            04380002
                WHEN SQLWARN NOT = SPACE                                04390002
                WHEN SQLCODE NOT = +0                                   04400002
                    MOVE '2100-OPEN-UNK-MNLY-CSR     '                  04410002
                                                  TO PV-PARAGRAPH-NAME  04420002
                    PERFORM 9999-SQL-ABEND                              04430002
            END-EVALUATE.                                               04440002
                                                                        04450002
       2110-CLOSE-UNK-MNLY-CSR.                                         04460002
                                                                        04470002
           EXEC SQL                                                     04480002
               CLOSE UNK_UNK_MNLY_CSR                                   04490002
           END-EXEC.                                                    04500002
                                                                        04510002
           EVALUATE TRUE                                                04520002
               WHEN SQLCODE = +0                                        04530002
                   CONTINUE                                             04540002
               WHEN SQLWARN NOT = SPACE                                 04550002
               WHEN SQLCODE NOT = +0                                    04560002
                   MOVE '2110-CLOSE-UNK-MNLY-CSR     '                  04570002
                                                  TO PV-PARAGRAPH-NAME  04580002
                   PERFORM 9999-SQL-ABEND                               04590002
           END-EVALUATE.                                                04600002
                                                                        04610002
                                                                        04620002
       2120-PROCESS-UNK-MNLY.                                           04630002
                                                                        04640002
           PERFORM 2130-FETCH-UNK-MNLY.                                 04650002
                                                                        04660002
           IF PS-UNK-MNLY-AT-END-NO                                     04670002
               SET PS-KNO-MNLY-AT-END-NO TO TRUE                        04680002
               PERFORM 2200-OPEN-KNO-KNO-MNLY-CSR                       04690002
               PERFORM 2220-PROCESS-KNO-KNO-MNLY-CSR                    04700002
               PERFORM 2210-CLOSE-KNO-KNO-MNLY-CSR                      04710002
           END-IF.                                                      04720002
                                                                        04730002
       2130-FETCH-UNK-MNLY.                                             04740002
                                                                        04750002
           EXEC SQL                                                     04760002
             FETCH UNK_UNK_MNLY_CSR                                     04770002
                INTO   :PV-UUM-END-INV-COST2-AMT                        04780002
           END-EXEC.                                                    04790002
                                                                        04800002
           EVALUATE TRUE                                                04810002
               WHEN SQLCODE = +0                                        04820002
                   PERFORM 2135-ZERO-CHECK                              04830002
               WHEN SQLCODE = +100                                      04840002
                   SET PS-UNK-MNLY-AT-END-YES TO TRUE                   04850002
               WHEN SQLCODE = -305                                      04860002
                   SET PS-UNK-MNLY-AT-END-YES TO TRUE                   04870002
                   MOVE ZEROS TO PV-UUM-END-INV-COST2-AMT               04880002
               WHEN SQLWARN NOT = SPACE                                 04890002
               WHEN SQLCODE NOT = +0                                    04900002
                   MOVE '2130-FETCH-UNK-MNLY  '                         04910002
                                                 TO PV-PARAGRAPH-NAME   04920002
                   PERFORM 9999-SQL-ABEND                               04930002
           END-EVALUATE.                                                04940002
                                                                        04950002
       2135-ZERO-CHECK.                                                 04960002
                                                                        04970002
            IF PV-UUM-END-INV-COST2-AMT = ZEROS                         04970102
                SET PS-UNK-MNLY-AT-END-YES TO TRUE                      04970202
            END-IF.                                                     04970302
                                                                        04970402
       2200-OPEN-KNO-KNO-MNLY-CSR.                                      04970502
                                                                        04970602
            EXEC SQL                                                    04970702
                OPEN KNO_KNO_MNLY_CSR                                   04970802
            END-EXEC.                                                   04970902
                                                                        04971002
            EVALUATE TRUE                                               04972002
                WHEN SQLCODE = +0                                       04973002
                    CONTINUE                                            04974002
                WHEN SQLWARN NOT = SPACE                                04975002
                WHEN SQLCODE NOT = +0                                   04976002
                    MOVE '2200-OPEN-KNO-KNO-MNLY-CSR '                  04977002
                                                  TO PV-PARAGRAPH-NAME  04978002
                    PERFORM 9999-SQL-ABEND                              04979002
            END-EVALUATE.                                               04980002
                                                                        04990002
       2210-CLOSE-KNO-KNO-MNLY-CSR.                                     05000002
                                                                        05010002
           EXEC SQL                                                     05020002
               CLOSE KNO_KNO_MNLY_CSR                                   05030002
           END-EXEC.                                                    05040002
                                                                        05050002
           EVALUATE TRUE                                                05060002
               WHEN SQLCODE = +0                                        05070002
                   CONTINUE                                             05080002
               WHEN SQLWARN NOT = SPACE                                 05090002
               WHEN SQLCODE NOT = +0                                    05100002
                   MOVE '2210-CLOSE-KNO-KNO-MNLY-CSR '                  05110002
                                                  TO PV-PARAGRAPH-NAME  05120002
                   PERFORM 9999-SQL-ABEND                               05130002
           END-EVALUATE.                                                05140002
                                                                        05150002
       2220-PROCESS-KNO-KNO-MNLY-CSR.                                   05160002
                                                                        05170002
           INITIALIZE PV-VENDOR-BRAND-SUMMARY-TABLE.                    05180002
           MOVE ZEROS TO PV-TOT-SHARE-AMT-WRITTEN.                      05190002
                                                                        05200002
           PERFORM 2225-FETCH-KNO-KNO-CSR                               05210002
               UNTIL PS-KNO-MNLY-AT-END-YES.                            05220002
                                                                        05230002
           IF PV-VB-TBL-CNT = ZEROS                                     05240002
               PERFORM 2222-WRITE-NO-CAND                               05250002
           ELSE                                                         05260002
               PERFORM 2300-DO-REVERSAL                                 05270002
               PERFORM 2400-COMPUTE-PCT-SHARE                           05280002
                   VARYING PV-VB-TBL-SUB FROM 1 BY 1                    05290002
                   UNTIL   PV-VB-TBL-SUB > PV-VB-TBL-CNT                05300002
           END-IF.                                                      05310002
                                                                        05320002
       2222-WRITE-NO-CAND.                                              05330002
                                                                        05340002
           MOVE PV-UUV-DEPT-NBR     TO  PV-NOC-DEPT-NBR.                05350002
           MOVE PV-UUV-LO-MDSE-LVL-ID TO  PV-NOC-IN-LO-MDSE-LVL-ID.     05360002
           MOVE  PV-UUM-END-INV-COST2-AMT TO                            05370002
                                 PV-NOC-END-INV-COST2-AMT.              05380002
           ADD +1 TO PV-NOCANDID-COUNT.                                 05390002
                                                                        05400002
           WRITE NO-CANDIDATE-REC    FROM PV-NO-CANDIDATE-REC.          05410002
                                                                        05420002
       2225-FETCH-KNO-KNO-CSR.                                          05430002
                                                                        05440002
           EXEC SQL                                                     05450002
             FETCH KNO_KNO_MNLY_CSR                                     05460002
                INTO   :PV-KKM-LO-MDSE-LVL-ID                           05470002
                      ,:PV-KKM-END-INV-COST2-AMT                        05480002
           END-EXEC.                                                    05490002
                                                                        05500002
           EVALUATE TRUE                                                05510002
               WHEN SQLCODE = +0                                        05520002
                    PERFORM 2250-PUT-IN-TABLE                           05530002
               WHEN SQLCODE = +100                                      05540002
                   SET PS-KNO-MNLY-AT-END-YES TO TRUE                   05550002
               WHEN SQLWARN NOT = SPACE                                 05560002
               WHEN SQLCODE NOT = +0                                    05570002
                   MOVE '2225-FETCH-KNO-KNO-CSR '                       05580002
                                                 TO PV-PARAGRAPH-NAME   05590002
                   PERFORM 9999-SQL-ABEND                               05600002
           END-EVALUATE.                                                05610002
                                                                        05620002
       2250-PUT-IN-TABLE.                                               05630002
                                                                        05640002
           COMPUTE PV-VB-TBL-SUB = PV-VB-TBL-CNT + 1.                   05650002
                                                                        05660002
           IF PV-VB-TBL-SUB > PC-MAX-9999                               05670002
               DISPLAY ' TABLE OVERFLOW FOR DEPT '                      05680002
           ELSE                                                         05690002
               MOVE PV-VB-TBL-SUB TO PV-VB-TBL-CNT                      05700002
               MOVE PV-KKM-END-INV-COST2-AMT TO                         05710002
                         PV-VB-END-INV-COST2-AMT (PV-VB-TBL-CNT)        05720002
               ADD  PV-KKM-END-INV-COST2-AMT TO                         05730002
                     PV-VB-TOT-END-INV-COST2-AMT                        05740002
               MOVE PV-KKM-LO-MDSE-LVL-ID   TO                          05750002
                         PV-VB-MDSE-LVL-ID      (PV-VB-TBL-CNT)         05760002
           END-IF.                                                      05770002
                                                                        05780002
       2300-DO-REVERSAL.                                                05790002
                                                                        05800002
           MOVE PV-UUV-DEPT-NBR     TO  PV-ROR-DEPT-NBR.                05810002
           MOVE PV-UUV-LO-MDSE-LVL-ID TO  PV-ROR-IN-LO-MDSE-LVL-ID.     05820002
           COMPUTE PV-ROR-END-INV-COST2-AMT =                           05830002
               PV-UUM-END-INV-COST2-AMT * - 1.                          05840002
           ADD +1 TO PV-REVERSAL-COUNT.                                 05850002
                                                                        05860002
           WRITE REVERSAL-OUTPUT-REC FROM PV-REVERSAL-OUTPUT-REC.       05870002
                                                                        05880002
       2400-COMPUTE-PCT-SHARE.                                          05890002
                                                                        05900002
           COMPUTE PV-PRORATION-PCT ROUNDED =                           05910002
               (PV-VB-END-INV-COST2-AMT (PV-VB-TBL-SUB) /               05920002
                                   PV-VB-TOT-END-INV-COST2-AMT).        05930002
           COMPUTE PV-SHARE-AMT ROUNDED =                               05940002
               (PV-PRORATION-PCT * PV-UUM-END-INV-COST2-AMT).           05950002
                                                                        05960002
                                                                        05970002
           MOVE PV-UUV-DEPT-NBR     TO  PV-POR-DEPT-NBR.                05980002
           MOVE PV-VB-MDSE-LVL-ID (PV-VB-TBL-SUB)                       05990002
                                    TO  PV-POR-IN-LO-MDSE-LVL-ID.       06000002
                                                                        06010002
           IF PV-VB-TBL-SUB = PV-VB-TBL-CNT                             06020002
               COMPUTE PV-POR-END-INV-COST2-AMT =                       06030002
                   PV-UUM-END-INV-COST2-AMT - PV-TOT-SHARE-AMT-WRITTEN  06040002
           ELSE                                                         06050002
               MOVE PV-SHARE-AMT    TO  PV-POR-END-INV-COST2-AMT        06060002
               ADD PV-SHARE-AMT     TO PV-TOT-SHARE-AMT-WRITTEN         06070002
           END-IF.                                                      06080002
                                                                        06090002
           IF PV-POR-END-INV-COST2-AMT = ZEROS                          06100002
               CONTINUE                                                 06110002
           ELSE                                                         06120002
               ADD +1 TO PV-PRORATED-COUNT                              06130002
               WRITE PRORATED-OUTPUT-REC                                06140002
                                     FROM PV-PRORATED-OUTPUT-REC        06150002
           END-IF.                                                      06160002
                                                                        06170002
                                                                        06180002
                                                                        06190002
      ****************************************************************  06200002
      * VALIDATE THE PROCESS DATE.                                      06210002
      ****************************************************************  06220002
       3000-GET-PROCESS-DATE-INFO.                                      06230002
           PERFORM                                                      06240002
               WITH TEST AFTER                                          06250002
               VARYING PV-RETRY-COUNTER                                 06260002
               FROM 1 BY 1                                              06270002
               UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               06280002
                         OR (SQLCODE = ZERO)                            06290002
                         OR (SQLCODE = 100))                            06300002
                  EXEC SQL                                              06310002
                      SELECT 'Y'                                        06320002
                        INTO :PV-DB2-DATE-EXISTS                        06330002
                        FROM TDTATTR                                    06340002
                       WHERE KY_DTE = :PV-PROCESS-DATE                  06350002
                  END-EXEC                                              06360002
                                                                        06370002
                  EVALUATE TRUE                                         06380002
                      WHEN SQLCODE = 0                                  06390002
                           DISPLAY 'DATE SELECT: '                      06400002
                                  PV-PROCESS-DATE                       06410002
                                  ' SUCCESSFUL'                         06420002
                           CONTINUE                                     06430002
                      WHEN SQLCODE = -904                               06440002
                      WHEN SQLCODE = -913                               06450002
                           CONTINUE                                     06460002
                      WHEN SQLWARN0 NOT = SPACES                        06470002
                      WHEN SQLCODE < +0                                 06480002
                      WHEN SQLCODE > +0                                 06490002
                           MOVE '3000-GET-PROCESS-DATE-INFO'            06500002
                                 TO PV-PARAGRAPH-NAME                   06510002
                           PERFORM 9999-SQL-ABEND                       06520002
                  END-EVALUATE                                          06530002
           END-PERFORM.                                                 06540002
                                                                        06550002
           IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         06560002
              DISPLAY 'RETRIES EXCEEDED FOR PROCESS DATE '              06570002
           END-IF.                                                      06580002
                                                                        06590002
       3100-GET-PARTITIONS.                                             06600002
                                                                        06610002
           PERFORM 3110-OPEN-PARTN-CSR.                                 06620002
                                                                        06630002
           SET PS-PARTN-DONE-NO TO TRUE.                                06640002
                                                                        06650002
           PERFORM 3120-FETCH-PARTN-CSR                                 06660002
               UNTIL PS-PARTN-DONE-YES.                                 06670002
                                                                        06680002
           PERFORM 3130-CLOSE-PARTN-CSR.                                06690002
                                                                        06700002
       3110-OPEN-PARTN-CSR.                                             06710002
                                                                        06720002
            EXEC SQL                                                    06730002
                OPEN PARTN_NBR_CSR                                      06740002
            END-EXEC.                                                   06750002
                                                                        06760002
            EVALUATE TRUE                                               06770002
                WHEN SQLCODE = +0                                       06780002
                    CONTINUE                                            06790002
                WHEN SQLWARN NOT = SPACE                                06800002
                WHEN SQLCODE NOT = +0                                   06810002
                    MOVE '3110-OPEN-PARTN-CSR   ' TO PV-PARAGRAPH-NAME  06820002
                    PERFORM 9999-SQL-ABEND                              06830002
            END-EVALUATE.                                               06840002
                                                                        06850002
       3120-FETCH-PARTN-CSR.                                            06860002
                                                                        06870002
           EXEC SQL                                                     06880002
             FETCH PARTN_NBR_CSR                                        06890002
                INTO   :MLT00003-PARTN-NBR                              06900002
           END-EXEC.                                                    06910002
                                                                        06920002
           EVALUATE TRUE                                                06930002
               WHEN SQLCODE = +0                                        06940002
                   ADD 1 TO PV-PARTN-CNT                                06950002
                   MOVE MLT00003-PARTN-NBR TO PV-PARTN-ENTRY            06960002
                                                    (PV-PARTN-CNT)      06970002
               WHEN SQLCODE = +100                                      06980002
                   SET PS-PARTN-DONE-YES TO TRUE                        06990002
               WHEN SQLWARN NOT = SPACE                                 07000002
               WHEN SQLCODE NOT = +0                                    07010002
                   MOVE '3120-FETCH-PARTN-CSR   ' TO PV-PARAGRAPH-NAME  07020002
                   PERFORM 9999-SQL-ABEND                               07030002
           END-EVALUATE.                                                07040002
                                                                        07050002
       3130-CLOSE-PARTN-CSR.                                            07060002
                                                                        07070002
            EXEC SQL                                                    07080002
                CLOSE PARTN_NBR_CSR                                     07090002
            END-EXEC.                                                   07100002
                                                                        07110002
            EVALUATE TRUE                                               07120002
                WHEN SQLCODE = +0                                       07130002
                    CONTINUE                                            07140002
                WHEN SQLWARN NOT = SPACE                                07150002
                WHEN SQLCODE NOT = +0                                   07160002
                    MOVE '3130-CLOSE-PARTN-CSR  ' TO PV-PARAGRAPH-NAME  07170002
                    PERFORM 9999-SQL-ABEND                              07180002
            END-EVALUATE.                                               07190002
                                                                        07200002
      ******************************************************************07210002
      * 9000-READ-CNTL-DTE.                                             07220002
      ******************************************************************07230002
       9000-READ-CNTL-DTE.                                              07240002
           READ CNTL-DATE-FILE INTO CC-CONTROL-CARD                     07250002
               AT END                                                   07260002
                   DISPLAY '** PROGRAM ABEND **'                        07270002
                   DISPLAY 'MLKUT970  - CONTROL DATE EMPTY'             07280002
                   SET AC-OTHER-ERROR TO TRUE                           07290002
                   CALL 'ILBOABN0' USING ABEND-CODE.                    07300002
                                                                        07310002
           DISPLAY '** MLKUT970 CONTROL CARD:' CNTL-DATE-REC.           07320002
                                                                        07330002
           MOVE CC-PROC-DATE-ISO TO PV-PROCESS-DATE.                    07340002
                                                                        07350002
      ******************************************************************07360002
      * 9100-WRITE-OUTPUT-REC.                                          07370002
      ******************************************************************07380002
       9100-WRITE-OUTPUT-REC.                                           07390002
           ADD 1 TO PV-WRITE-COUNT                                      07400002
           WRITE PRORATED-OUTPUT-REC                                    07410002
               FROM PV-PRORATED-OUTPUT-REC.                             07420002
                                                                        07430002
      ******************************************************************07440002
      *  STANDARD DB2 ERROR ABEND ROUTINE                               07450002
      *  THIS ROUTINE FORCES AN ABEND DUE TO A DB2 PROBLEM.             07460002
      ******************************************************************07470002
       9999-SQL-ABEND.                                                  07480002
                                                                        07490002
           SET AC-SQL-ERROR           TO TRUE.                          07500002
           DISPLAY '**  ABEND     **'.                                  07510002
           DISPLAY '**  PROGRAM   **  = ' PC-PGM-NAME.                  07520002
           DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            07530002
                                                                        07540002
      *    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE         07550002
      *    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.        07560002
                                                                        07570002
           COPY DPPD004.                                                07580002
                                                                        07590002
           CALL 'ILBOABN0'  USING ABEND-CODE.                           07600002
                                                                        07610002
