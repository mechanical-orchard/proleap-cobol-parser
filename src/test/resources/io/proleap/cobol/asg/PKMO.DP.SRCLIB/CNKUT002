000100******************************************************************00010004
000200 IDENTIFICATION DIVISION.                                         00020004
000300******************************************************************00030004
000400*THIS PROGRAM WAS TRANSFERED TO THE KRIER TEAM AND RENAMED.       00040004
000500*PROGRAM-ID.    FSKUT003.                                         00050004
000600******************************************************************00060004
000700 PROGRAM-ID.    CNKUT002.                                         00070004
000800 AUTHOR.        CHUCK ALBERTY -- EXACTA.                          00080004
000900 INSTALLATION.  KOHLS.                                            00090004
001000 DATE-WRITTEN   DECEMBER, 1991.                                   00100004
001100 DATE-COMPILED.                                                   00110004
001200******************************************************************00120004
001300*  THIS PROGRAM EXTRACTS DATA FROM THE MERCHANDISE BUSINESS       00130004
001400*  STRUCTURE TABLES WHICH IS THEN SORTED AND USED AS INPUT TO     00140004
001500*  A VARIETY OF PROGRAMS.  THIS PROGRAM CAN EXTRACT DATA FROM     00150004
001600*  MBS FOR 'ALL' ROWS OF MBS OR BY SPECIFIC SELECTION OF ANY      00160004
001700*  OF THE FOLLOWING:                                              00170004
001800*      GMM                                                        00180004
001900*      DMM                                                        00190004
002000*      BUYER                                                      00200004
002100*      DEPT                                                       00210004
002200*                                                                 00220004
002300*  BY SELECTING 'ALL', YOU WOULD GET THE FOLLOWING RESULTS:       00230004
002400*      ALL GMM         RECORDS                                    00240004
002500*      ALL DMM         RECORDS                                    00250004
002600*      ALL BUYER       RECORDS                                    00260004
002700*      ALL DEPARTMENT  RECORDS                                    00270004
002800*      ALL MAJOR CLASS RECORDS                                    00280004
002900*      ALL SUB CLASS   RECORDS                                    00290004
003000*                                                                 00300004
003100*  BY SELECTING A SPECIFIC GMM, YOU WOULD GET THE FOLLOWING       00310004
003200*  RESULTS:                                                       00320004
003300*      GMM RECORD                                                 00330004
003400*      DMM'S          WITHIN GMM                                  00340004
003500*      BUYERS         WITHIN DMM'S                                00350004
003600*      DEPARTMENTS    WITHIN BUYERS                               00360004
003700*      MAJOR CLASSES  WITHIN DEPARTMENTS                          00370004
003800*      SUB CLASSES    WITHIN MAJOR CLASSES                        00380004
003900*                                                                 00390004
004000*  BY SELECTING A SPECIFIC DMM, YOU WOULD GET THE FOLLOWING       00400004
004100*  RESULTS:                                                       00410004
004200*      GMM RECORD     FOR DMM                                     00420004
004300*      DMM RECORD                                                 00430004
004400*      BUYERS         WITHIN DMM                                  00440004
004500*      DEPARTMENTS    WITHIN BUYERS                               00450004
004600*      MAJOR CLASSES  WITHIN DEPARTMENTS                          00460004
004700*      SUB CLASSES    WITHIN MAJOR CLASSES                        00470004
004800*                                                                 00480004
004900*  BY SELECTING A SPECIFIC BUYER, YOU WOULD GET THE FOLLOWING     00490004
005000*  RESULTS:                                                       00500004
005100*      GMM RECORD     FOR BUYER                                   00510004
005200*      DMM RECORD     FOR BUYER                                   00520004
005300*      BUYER RECORD                                               00530004
005400*      DEPARTMENTS    WITHIN BUYER                                00540004
005500*      MAJOR CLASSES  WITHIN DEPARTMENTS                          00550004
005600*      SUB CLASSES    WITHIN MAJOR CLASSES                        00560004
005700*                                                                 00570004
005800*  BY SELECTING A SPECIFIC DEPARTMENT, YOU WOULD GET THE FOLLOWING00580004
005900*  RESULTS:                                                       00590004
006000*      GMM RECORD     FOR DEPARTMENT                              00600004
006100*      DMM RECORD     FOR DEPARTMENT                              00610004
006200*      BUYER RECORD   FOR DEPARTMENT                              00620004
006300*      DEPARTMENT RECORD                                          00630004
006400*      MAJOR CLASSES  WITHIN DEPARTMENT                           00640004
006500*      SUB CLASSES    WITHIN MAJOR CLASSES                        00650004
006600******************************************************************00660004
006700*                                                                 00670004
006800*                                                                 00680004
006900******************************************************************00690004
007000 ENVIRONMENT DIVISION.                                            00700004
007100******************************************************************00710004
007200 CONFIGURATION SECTION.                                           00720004
007300*                                                                 00730004
007400 SOURCE-COMPUTER.        IBM-3090.                                00740004
007500 OBJECT-COMPUTER.        IBM-3090.                                00750004
007600*                                                                 00760004
007700 INPUT-OUTPUT SECTION.                                            00770004
007800*                                                                 00780004
007900 FILE-CONTROL.                                                    00790004
008000*                                                                 00800004
008100     SELECT CONTROL-CARD-FILE-IN                                  00810004
008200         ASSIGN TO SYSIN.                                         00820004
008300*                                                                 00830004
008400     SELECT MBS-STRUCTURE-FILE-OUT                                00840004
008500         ASSIGN TO OUT01.                                         00850004
008600*                                                                 00860004
008700*                                                                 00870004
008800******************************************************************00880004
008900 DATA DIVISION.                                                   00890004
009000******************************************************************00900004
009100 FILE SECTION.                                                    00910004
009200*                                                                 00920004
009300 FD  CONTROL-CARD-FILE-IN                                         00930004
009400     RECORDING MODE IS F                                          00940004
009500     BLOCK CONTAINS 0 RECORDS                                     00950004
009600     LABEL RECORDS ARE STANDARD.                                  00960004
009700*                                                                 00970004
009800 01  CONTROL-CARD-RECORD-IN           PIC X(80).                  00980004
009900*                                                                 00990004
010000*                                                                 01000004
010100 FD  MBS-STRUCTURE-FILE-OUT                                       01010004
010200     RECORDING MODE IS F                                          01020004
010300     BLOCK CONTAINS 0 RECORDS                                     01030004
010400     LABEL RECORDS ARE STANDARD.                                  01040004
010500*                                                                 01050004
010600 01  MBS-STRUCTURE-RECORD-OUT        PIC  X(48).                  01060004
010700*                                                                 01070004
010800*                                                                 01080004
010900 WORKING-STORAGE SECTION.                                         01090004
011000*                                                                 01100004
011100 01  PC-PROGRAM-CONSTANTS.                                        01110004
011200     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          01120004
011300         'CNKUT002'.                                              01130004
011400                                                                  01140004
011500     05  PC-CURRENT-OPER-CO          PIC  X(03)    VALUE '03'.    01150004
011600     05  PC-APLSYS-CDE               PIC  X(02)    VALUE 'WF'.    01160005
011610* 08/20/09 - WF IS WAREHOUSE FULFILLMENT                          01161006
011620*            USED TO BE FS BUT SOME DEPARTMENTS DID NOT EXTRACT   01162006
011700     05  PC-MDSELV-GMA               PIC  X(03)    VALUE 'GMA'.   01170004
011800     05  PC-MDSELV-DMA               PIC  X(03)    VALUE 'DMA'.   01180004
011900     05  PC-MDSELV-DPT               PIC  X(03)    VALUE 'DPT'.   01190004
012000     05  PC-MDSELV-MCL               PIC  X(03)    VALUE 'MCL'.   01200004
012100     05  PC-MDSELV-SCL               PIC  X(03)    VALUE 'SCL'.   01210004
012200     05  PC-RSPLVL-CDE-BYR           PIC  X(03)    VALUE 'BYR'.   01220004
012300     05  PC-RSPLVL-CDE-DMM           PIC  X(03)    VALUE 'DMM'.   01230004
012400     05  PC-RSPLVL-CDE-GMM           PIC  X(03)    VALUE 'GMM'.   01240004
012500*                                                                 01250004
012600*                                                                 01260004
012700 01  CC-CONTROL-CARD.                                             01270004
012800     05  CC-1-72.                                                 01280004
012900         10  CC-CONTROL              PIC  X(07)    VALUE SPACES.  01290004
013000             88  CC-CONTROL-VALID                  VALUE          01300004
013100             'CONTROL'.                                           01310004
013200         10  FILLER                  PIC  X(01)    VALUE SPACE.   01320004
013300         10  CC-TYPE                 PIC  X(03)    VALUE SPACES.  01330004
013400             88  CC-TYPE-GMM                       VALUE 'GMM'.   01340004
013500             88  CC-TYPE-DMM                       VALUE 'DMM'.   01350004
013600             88  CC-TYPE-BYR                       VALUE 'BYR'.   01360004
013700             88  CC-TYPE-DPT                       VALUE 'DPT'.   01370004
013800             88  CC-TYPE-ALL                       VALUE 'ALL'.   01380004
013900         10  FILLER                  PIC  X(01)    VALUE SPACE.   01390004
014000         10  CC-NUMBER               PIC  9(03)    VALUE ZERO.    01400004
014100         10  CC-NUMBER-X REDEFINES CC-NUMBER                      01410004
014200                                     PIC  X(03).                  01420004
014300         10  FILLER                  PIC  X(57)    VALUE SPACES.  01430004
014400     05  CC-73-80                    PIC  X(08)    VALUE SPACES.  01440004
014500*                                                                 01450004
014600*                                                                 01460004
014700 01  PS-PROGRAM-SWITCHES.                                         01470004
014800     05  PS-CONTROL-CARD-EOF-SW      PIC  X(03)    VALUE 'BOF'.   01480004
014900         88  PS-CONTROL-CARD-EOF                   VALUE 'EOF'.   01490004
015000     05  PS-CONTROL-CARD-VALID-SW    PIC  X(01)    VALUE SPACE.   01500004
015100         88  PS-CONTROL-CARD-INVALID               VALUE 'N'.     01510004
015200         88  PS-CONTROL-CARD-VALID                 VALUE 'Y'.     01520004
015300*                                                                 01530004
015400*                                                                 01540004
015500 01  PV-PROGRAM-VARIABLES.                                        01550004
015600     05  PV-ABEND-CODE               PIC S9(04)    VALUE ZERO     01560004
015700                                                   COMP.          01570004
015800     05  PV-ABEND-PARAGRAPH          PIC  X(30)    VALUE SPACES.  01580004
015900     05  PV-CC-INPUT-CNT             PIC S9(03)    VALUE ZERO     01590004
016000                                                   COMP-3.        01600004
016100     05  PV-CC-MBS-VALID-CNT         PIC S9(03)    VALUE ZERO     01610004
016200                                                   COMP-3.        01620004
016300     05  PV-CC-MBS-INVALID-CNT       PIC S9(03)    VALUE ZERO     01630004
016400                                                   COMP-3.        01640004
016500     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  01650004
016600                                                                  01660004
016700     05  PV-SAVE-BUYER               PIC  X(03)    VALUE SPACES.  01670004
016800     05  PV-SAVE-DKEY                PIC S9(06)    VALUE ZERO     01680004
016900                                                   COMP-3.        01690004
017000     05  PV-GMM-DMM                  PIC  X(02)    VALUE SPACES.  01700004
017100     05  PV-BYR-DPT                  PIC  X(03)    VALUE SPACES.  01710004
017200*                                                                 01720004
017300*                                                                 01730004
017400 01  PE-PROGRAM-ERROR-MESSAGES.                                   01740004
017500     05  PE-MSG-01                   PIC  X(30)    VALUE          01750004
017600         'OPEN OF ALL_CSR               '.                        01760004
017700     05  PE-MSG-02                   PIC  X(30)    VALUE          01770004
017800         'FETCH OF ALL_CSR              '.                        01780004
017900     05  PE-MSG-03                   PIC  X(30)    VALUE          01790004
018000         'OPEN OF GMM_CSR               '.                        01800004
018100     05  PE-MSG-04                   PIC  X(30)    VALUE          01810004
018200         'FETCH OF GMM_CSR              '.                        01820004
018300     05  PE-MSG-05                   PIC  X(30)    VALUE          01830004
018400         'CLOSE OF GMM_CSR              '.                        01840004
018500     05  PE-MSG-06                   PIC  X(30)    VALUE          01850004
018600         'OPEN OF DMM_CSR               '.                        01860004
018700     05  PE-MSG-07                   PIC  X(30)    VALUE          01870004
018800         'FETCH OF DMM_CSR              '.                        01880004
018900     05  PE-MSG-08                   PIC  X(30)    VALUE          01890004
019000         'CLOSE OF DMM_CSR              '.                        01900004
019100     05  PE-MSG-09                   PIC  X(30)    VALUE          01910004
019200         'OPEN OF BYR_CSR               '.                        01920004
019300     05  PE-MSG-10                   PIC  X(30)    VALUE          01930004
019400         'FETCH OF BYR_CSR              '.                        01940004
019500     05  PE-MSG-11                   PIC  X(30)    VALUE          01950004
019600         'CLOSE OF BYR_CSR              '.                        01960004
019700     05  PE-MSG-12                   PIC  X(30)    VALUE          01970004
019800         'OPEN OF DPT_CSR               '.                        01980004
019900     05  PE-MSG-13                   PIC  X(30)    VALUE          01990004
020000         'FETCH OF DPT_CSR              '.                        02000004
020100     05  PE-MSG-14                   PIC  X(30)    VALUE          02010004
020200         'CLOSE OF DPT_CSR              '.                        02020004
020300*                                                                 02030004
020400*                                                                 02040004
020500******************************************************************02050004
020600*  RECORD LAYOUT FOR MBS STRUCTURE RECORD                         02060004
020700*  RENAMED TO CNWS002 FROM FSRD001O                               02070004
020800******************************************************************02080004
020900     COPY CNWS002.                                                02090004
021000*                                                                 02100004
021100*    COPY FSRD001O.                                               02110004
021200*                                                                 02120004
021300******************************************************************02130004
021400*  COPY BOOK FOR DB2 FORMATTED MESSAGE AREA                       02140004
021500******************************************************************02150004
021600     COPY DPWS004.                                                02160004
021700*                                                                 02170004
021800*                                                                 02180004
021900******************************************************************02190004
022000*  COMMUNICATIONS AREA FOR DB2                                    02200004
022100******************************************************************02210004
022200     EXEC SQL                                                     02220004
022300          INCLUDE SQLCA                                           02230004
022400     END-EXEC.                                                    02240004
022500*                                                                 02250004
022600*                                                                 02260004
022700******************************************************************02270004
022800*  TMDSEAR DCLGEN  (MERCHANDISE AREA TABLE)                       02280004
022900******************************************************************02290004
023000     EXEC SQL                                                     02300004
023100          INCLUDE TMDSEAR                                         02310004
023200     END-EXEC.                                                    02320004
023300*                                                                 02330004
023400*                                                                 02340004
023500******************************************************************02350004
023600*  TAPLAVL DCLGEN  (APPLICATION AVAILABILITY TABLE)               02360004
023700******************************************************************02370004
023800     EXEC SQL                                                     02380004
023900          INCLUDE TAPLAVL                                         02390004
024000     END-EXEC.                                                    02400004
024100*                                                                 02410004
024200*                                                                 02420004
024300******************************************************************02430004
024400*  TRSPBAR DCLGEN  (RESPONSIBILITY AREA TABLE)                    02440004
024500******************************************************************02450004
024600     EXEC SQL                                                     02460004
024700          INCLUDE TRSPBAR                                         02470004
024800     END-EXEC.                                                    02480004
024900*                                                                 02490004
025000*                                                                 02500004
025100******************************************************************02510004
025200**  CURSOR USED TO RETRIEVE SKU AND SKU/STORE COLUMNS FOR ONE     02520004
025300**  SPECIFIC GMM                                                  02530004
025400******************************************************************02540004
025500     EXEC SQL                                                     02550004
025600          DECLARE GMM_CSR CURSOR FOR                              02560004
025700           SELECT GMA_NBR,                                        02570004
025800                  DMA_NBR,                                        02580004
025900                  DEPT_NBR,                                       02590004
026000                  MAJ_CL_NBR,                                     02600004
026100                  SUB_CL_NBR,                                     02610004
026200                  BYR_NBR,                                        02620004
026300                  MDSELV_CDE,                                     02630004
026400                  MDSEAR_DESC,                                    02640004
026500                  A.MDSEAR_DKEY                                   02650004
026600             FROM TMDSEAR A,                                      02660004
026700                  TAPLAVL B                                       02670004
026800            WHERE A.MDSEAR_DKEY = B.MDSEAR_DKEY                   02680004
026900              AND A.OPERCO_NBR  = :PC-CURRENT-OPER-CO             02690004
027000              AND A.OPERCO_NBR  = B.OPERCO_NBR                    02700004
027100              AND (MDSELV_CDE   = :PC-MDSELV-GMA                  02710004
027200                   OR                                             02720004
027300                   MDSELV_CDE   = :PC-MDSELV-DMA                  02730004
027400                   OR                                             02740004
027500                   MDSELV_CDE   = :PC-MDSELV-DPT                  02750004
027600                   OR                                             02760004
027700                   MDSELV_CDE   = :PC-MDSELV-MCL                  02770004
027800                   OR                                             02780004
027900                   MDSELV_CDE   = :PC-MDSELV-SCL)                 02790004
028000              AND GMA_NBR       = :PV-GMM-DMM                     02800004
028100              AND (CURRENT DATE                                   02810004
028200                           BETWEEN CHAR(STRT_DTE,ISO)             02820004
028300                               AND CHAR(END_DTE,ISO))             02830004
028400              AND (CURRENT DATE                                   02840004
028500                           BETWEEN CHAR(B.MDSEAR_STRT_DTE,ISO)    02850004
028600                               AND CHAR(B.MDSEAR_END_DTE,ISO))    02860004
028700              AND B.APLSYS_CDE  = :PC-APLSYS-CDE                  02870005
028800            ORDER BY GMA_NBR,                                     02880004
028900                     DMA_NBR,                                     02890004
029000                     DEPT_NBR,                                    02900004
029100                     MAJ_CL_NBR,                                  02910004
029200                     SUB_CL_NBR                                   02920004
029300     END-EXEC.                                                    02930004
029400*                                                                 02940004
029500*                                                                 02950004
029600******************************************************************02960004
029700**  CURSOR USED TO RETRIEVE SKU AND SKU/STORE COLUMNS FOR ONE     02970004
029800**  SPECIFIC DMM                                                  02980004
029900******************************************************************02990004
030000     EXEC SQL                                                     03000004
030100          DECLARE DMM_CSR CURSOR FOR                              03010004
030200           SELECT GMA_NBR,                                        03020004
030300                  DMA_NBR,                                        03030004
030400                  DEPT_NBR,                                       03040004
030500                  MAJ_CL_NBR,                                     03050004
030600                  SUB_CL_NBR,                                     03060004
030700                  BYR_NBR,                                        03070004
030800                  MDSELV_CDE,                                     03080004
030900                  MDSEAR_DESC,                                    03090004
031000                  A.MDSEAR_DKEY                                   03100004
031100             FROM TMDSEAR A,                                      03110004
031200                  TAPLAVL B                                       03120004
031300            WHERE A.MDSEAR_DKEY = B.MDSEAR_DKEY                   03130004
031400              AND A.OPERCO_NBR  = :PC-CURRENT-OPER-CO             03140004
031500              AND A.OPERCO_NBR  = B.OPERCO_NBR                    03150004
031600              AND (MDSELV_CDE   = :PC-MDSELV-DMA                  03160004
031700                   OR                                             03170004
031800                   MDSELV_CDE   = :PC-MDSELV-DPT                  03180004
031900                   OR                                             03190004
032000                   MDSELV_CDE   = :PC-MDSELV-MCL                  03200004
032100                   OR                                             03210004
032200                   MDSELV_CDE   = :PC-MDSELV-SCL)                 03220004
032300              AND DMA_NBR       = :PV-GMM-DMM                     03230004
032400              AND (CURRENT DATE                                   03240004
032500                           BETWEEN CHAR(STRT_DTE,ISO)             03250004
032600                               AND CHAR(END_DTE,ISO))             03260004
032700              AND (CURRENT DATE                                   03270004
032800                           BETWEEN CHAR(B.MDSEAR_STRT_DTE,ISO)    03280004
032900                               AND CHAR(B.MDSEAR_END_DTE,ISO))    03290004
033000              AND B.APLSYS_CDE  = :PC-APLSYS-CDE                  03300005
033100            ORDER BY DMA_NBR,                                     03310004
033200                     DEPT_NBR,                                    03320004
033300                     MAJ_CL_NBR,                                  03330004
033400                     SUB_CL_NBR                                   03340004
033500     END-EXEC.                                                    03350004
033600*                                                                 03360004
033700*                                                                 03370004
033800******************************************************************03380004
033900**  CURSOR USED TO RETRIEVE SKU AND SKU/STORE COLUMNS FOR ONE     03390004
034000**  SPECIFIC BUYER                                                03400004
034100******************************************************************03410004
034200     EXEC SQL                                                     03420004
034300          DECLARE BYR_CSR CURSOR FOR                              03430004
034400           SELECT GMA_NBR,                                        03440004
034500                  DMA_NBR,                                        03450004
034600                  DEPT_NBR,                                       03460004
034700                  MAJ_CL_NBR,                                     03470004
034800                  SUB_CL_NBR,                                     03480004
034900                  BYR_NBR,                                        03490004
035000                  MDSELV_CDE,                                     03500004
035100                  MDSEAR_DESC,                                    03510004
035200                  A.MDSEAR_DKEY                                   03520004
035300             FROM TMDSEAR A,                                      03530004
035400                  TAPLAVL B                                       03540004
035500            WHERE A.MDSEAR_DKEY = B.MDSEAR_DKEY                   03550004
035600              AND A.OPERCO_NBR  = :PC-CURRENT-OPER-CO             03560004
035700              AND A.OPERCO_NBR  = B.OPERCO_NBR                    03570004
035800              AND (MDSELV_CDE   = :PC-MDSELV-DPT                  03580004
035900                   OR                                             03590004
036000                   MDSELV_CDE   = :PC-MDSELV-MCL                  03600004
036100                   OR                                             03610004
036200                   MDSELV_CDE   = :PC-MDSELV-SCL)                 03620004
036300              AND BYR_NBR       = :PV-BYR-DPT                     03630004
036400              AND (CURRENT DATE                                   03640004
036500                           BETWEEN CHAR(STRT_DTE,ISO)             03650004
036600                               AND CHAR(END_DTE,ISO))             03660004
036700              AND (CURRENT DATE                                   03670004
036800                           BETWEEN CHAR(B.MDSEAR_STRT_DTE,ISO)    03680004
036900                               AND CHAR(B.MDSEAR_END_DTE,ISO))    03690004
037000              AND B.APLSYS_CDE  = :PC-APLSYS-CDE                  03700005
037100            ORDER BY DEPT_NBR,                                    03710004
037200                     MAJ_CL_NBR,                                  03720004
037300                     SUB_CL_NBR                                   03730004
037400     END-EXEC.                                                    03740004
037500*                                                                 03750004
037600*                                                                 03760004
037700******************************************************************03770004
037800**  CURSOR USED TO RETRIEVE SKU AND SKU/STORE COLUMNS FOR ONE     03780004
037900**  SPECIFIC DEPARTMENT                                           03790004
038000******************************************************************03800004
038100     EXEC SQL                                                     03810004
038200          DECLARE DPT_CSR CURSOR FOR                              03820004
038300           SELECT GMA_NBR,                                        03830004
038400                  DMA_NBR,                                        03840004
038500                  DEPT_NBR,                                       03850004
038600                  MAJ_CL_NBR,                                     03860004
038700                  SUB_CL_NBR,                                     03870004
038800                  BYR_NBR,                                        03880004
038900                  MDSELV_CDE,                                     03890004
039000                  MDSEAR_DESC,                                    03900004
039100                  A.MDSEAR_DKEY                                   03910004
039200             FROM TMDSEAR A,                                      03920004
039300                  TAPLAVL B                                       03930004
039400            WHERE A.MDSEAR_DKEY = B.MDSEAR_DKEY                   03940004
039500              AND A.OPERCO_NBR  = :PC-CURRENT-OPER-CO             03950004
039600              AND A.OPERCO_NBR  = B.OPERCO_NBR                    03960004
039700              AND (MDSELV_CDE   = :PC-MDSELV-DPT                  03970004
039800                   OR                                             03980004
039900                   MDSELV_CDE   = :PC-MDSELV-MCL                  03990004
040000                   OR                                             04000004
040100                   MDSELV_CDE   = :PC-MDSELV-SCL)                 04010004
040200              AND DEPT_NBR      = :PV-BYR-DPT                     04020004
040300              AND (CURRENT DATE                                   04030004
040400                           BETWEEN CHAR(STRT_DTE,ISO)             04040004
040500                               AND CHAR(END_DTE,ISO))             04050004
040600              AND (CURRENT DATE                                   04060004
040700                           BETWEEN CHAR(B.MDSEAR_STRT_DTE,ISO)    04070004
040800                               AND CHAR(B.MDSEAR_END_DTE,ISO))    04080004
040900              AND B.APLSYS_CDE  = :PC-APLSYS-CDE                  04090005
041000            ORDER BY DEPT_NBR,                                    04100004
041100                     MAJ_CL_NBR,                                  04110004
041200                     SUB_CL_NBR                                   04120004
041300     END-EXEC.                                                    04130004
041400*                                                                 04140004
041500*                                                                 04150004
041600******************************************************************04160004
041700**  CURSOR USED TO RETRIEVE SKU AND SKU/STORE COLUMNS FOR 'ALL'   04170004
041800**  OF MBS (ALL GMM'S, DMM'S, BUYERS AND DEPARTMENTS)             04180004
041900******************************************************************04190004
042000     EXEC SQL                                                     04200004
042100          DECLARE ALL_CSR CURSOR FOR                              04210004
042200           SELECT GMA_NBR,                                        04220004
042300                  DMA_NBR,                                        04230004
042400                  DEPT_NBR,                                       04240004
042500                  MAJ_CL_NBR,                                     04250004
042600                  SUB_CL_NBR,                                     04260004
042700                  BYR_NBR,                                        04270004
042800                  MDSELV_CDE,                                     04280004
042900                  MDSEAR_DESC,                                    04290004
043000                  A.MDSEAR_DKEY                                   04300004
043100             FROM TMDSEAR A,                                      04310004
043200                  TAPLAVL B                                       04320004
043300            WHERE A.MDSEAR_DKEY = B.MDSEAR_DKEY                   04330004
043400              AND A.OPERCO_NBR  = :PC-CURRENT-OPER-CO             04340004
043500              AND A.OPERCO_NBR  = B.OPERCO_NBR                    04350004
043600              AND (MDSELV_CDE   = :PC-MDSELV-GMA                  04360004
043700                   OR                                             04370004
043800                   MDSELV_CDE   = :PC-MDSELV-DMA                  04380004
043900                   OR                                             04390004
044000                   MDSELV_CDE   = :PC-MDSELV-DPT                  04400004
044100                   OR                                             04410004
044200                   MDSELV_CDE   = :PC-MDSELV-MCL                  04420004
044300                   OR                                             04430004
044400                   MDSELV_CDE   = :PC-MDSELV-SCL)                 04440004
044500              AND (CURRENT DATE                                   04450004
044600                           BETWEEN CHAR(STRT_DTE,ISO)             04460004
044700                               AND CHAR(END_DTE,ISO))             04470004
044800              AND (CURRENT DATE                                   04480004
044900                           BETWEEN CHAR(B.MDSEAR_STRT_DTE,ISO)    04490004
045000                               AND CHAR(B.MDSEAR_END_DTE,ISO))    04500004
045100              AND B.APLSYS_CDE  = :PC-APLSYS-CDE                  04510005
045200            ORDER BY GMA_NBR,                                     04520004
045300                     DMA_NBR,                                     04530004
045400                     BYR_NBR,                                     04540004
045500                     DEPT_NBR,                                    04550004
045600                     MAJ_CL_NBR,                                  04560004
045700                     SUB_CL_NBR                                   04570004
045800     END-EXEC.                                                    04580004
045900*                                                                 04590004
046000*                                                                 04600004
046100******************************************************************04610004
046200 PROCEDURE DIVISION.                                              04620004
046300******************************************************************04630004
046400                                                                  04640004
046500******************************************************************04650004
046600*  CONTROLS THE MAIN PROCESSING OF THE PROGRAM.                   04660004
046700******************************************************************04670004
046800 0000-PROGRAM-MAINLINE.                                           04680004
046900     PERFORM 1000-INITIALIZE.                                     04690004
047000*                                                                 04700004
047100     PERFORM 2000-PROCESS-CONTROL-CARDS                           04710004
047200       UNTIL PS-CONTROL-CARD-EOF.                                 04720004
047300*                                                                 04730004
047400     PERFORM 9000-EOJ-ROUTINE.                                    04740004
047500*                                                                 04750004
047600     STOP RUN.                                                    04760004
047700*                                                                 04770004
047800*                                                                 04780004
047900******************************************************************04790004
048000*  PERFORM PROGRAM INITIALIZATION TASKS:                          04800004
048100*    -- OPEN INPUT  FILE (CONTROL CARD FILE)                      04810004
048200*    -- OPEN OUTPUT FILE (MBS STRUCTURE FILE)                     04820004
048300*    -- PERFORM FIRST READ OF INPUT FILE                          04830004
048400******************************************************************04840004
048500 1000-INITIALIZE.                                                 04850004
048600     OPEN INPUT  CONTROL-CARD-FILE-IN                             04860004
048700          OUTPUT MBS-STRUCTURE-FILE-OUT.                          04870004
048800*                                                                 04880004
048900     PERFORM 8000-READ-CONTROL-CARD.                              04890004
049000*                                                                 04900004
049100*                                                                 04910004
049200******************************************************************04920004
049300*  LOOP THROUGH CONTROL CARD FILE.  PROCESS EACH CONTROL CARD.    04930004
049400*  IF ANY CONTROL CARD IS SET UP AS 'ALL', SET THE END OF FILE    04940004
049500*  SWITCH TO STOP PROCESSING.                                     04950004
049600******************************************************************04960004
049700 2000-PROCESS-CONTROL-CARDS.                                      04970004
049800     PERFORM 2100-VALIDATE-CONTROL-CARD.                          04980004
049900*                                                                 04990004
050000     IF  PS-CONTROL-CARD-VALID                                    05000004
050100         EVALUATE TRUE                                            05010004
050200             WHEN CC-TYPE-ALL                                     05020004
050300                  PERFORM 3000-ALL-PROCESS                        05030004
050400             WHEN CC-TYPE-GMM                                     05040004
050500                  PERFORM 3100-GMM-PROCESS                        05050004
050600             WHEN CC-TYPE-DMM                                     05060004
050700                  PERFORM 3200-DMM-PROCESS                        05070004
050800             WHEN CC-TYPE-BYR                                     05080004
050900                  PERFORM 3300-BYR-PROCESS                        05090004
051000             WHEN CC-TYPE-DPT                                     05100004
051100                  PERFORM 3400-DPT-PROCESS                        05110004
051200         END-EVALUATE                                             05120004
051300     ELSE                                                         05130004
051400         ADD 1                   TO PV-CC-MBS-INVALID-CNT         05140004
051500     END-IF.                                                      05150004
051600                                                                  05160004
051700     IF  CC-TYPE-ALL                                              05170004
051800         CONTINUE                                                 05180004
051900     ELSE                                                         05190004
052000         PERFORM 8000-READ-CONTROL-CARD                           05200004
052100     END-IF.                                                      05210004
052200*                                                                 05220004
052300*                                                                 05230004
052400******************************************************************05240004
052500*  DISPLAY AND VALIDATE THE CONTROL CARD.                         05250004
052600******************************************************************05260004
052700 2100-VALIDATE-CONTROL-CARD.                                      05270004
052800     DISPLAY ' '.                                                 05280004
052900     DISPLAY 'CNKUT002 CONTROL CARD -- ' CC-1-72.                 05290004
053000     ADD 1                       TO PV-CC-INPUT-CNT.              05300004
053100*                                                                 05310004
053200     IF  CC-CONTROL-VALID                                         05320004
053300         SET PS-CONTROL-CARD-VALID                                05330004
053400                                 TO TRUE                          05340004
053500     ELSE                                                         05350004
053600         SET PS-CONTROL-CARD-INVALID TO TRUE                      05360004
053700         DISPLAY 'CONTROL CARD BYPASSED -- '                      05370004
053800                 'CONTROL CONSTANT ENTERED ('                     05380004
053900                  CC-CONTROL                                      05390004
054000                  ') IS INVALID'                                  05400004
054100     END-IF.                                                      05410004
054200*                                                                 05420004
054300     EVALUATE TRUE                                                05430004
054400         WHEN CC-TYPE-ALL                                         05440004
054500              SET PS-CONTROL-CARD-EOF TO TRUE                     05450004
054600              DISPLAY 'TYPE ALL -- END OF PROCESSING FORCED'      05460004
054700         WHEN CC-TYPE-GMM                                         05470004
054800         WHEN CC-TYPE-DMM                                         05480004
054900              MOVE CC-NUMBER     TO PV-GMM-DMM                    05490004
055000              IF  PV-GMM-DMM NUMERIC                              05500004
055100                  CONTINUE                                        05510004
055200              ELSE                                                05520004
055300                  SET PS-CONTROL-CARD-INVALID TO TRUE             05530004
055400                  DISPLAY 'CONTROL CARD BYPASSED -- '             05540004
055500                          'NUMBER ENTERED ('                      05550004
055600                          PV-GMM-DMM                              05560004
055700                          ') IS INVALID'                          05570004
055800              END-IF                                              05580004
055900         WHEN CC-TYPE-BYR                                         05590004
056000         WHEN CC-TYPE-DPT                                         05600004
056100              MOVE CC-NUMBER     TO PV-BYR-DPT                    05610004
056200              IF  PV-BYR-DPT NUMERIC                              05620004
056300                  CONTINUE                                        05630004
056400              ELSE                                                05640004
056500                  SET PS-CONTROL-CARD-INVALID TO TRUE             05650004
056600                  DISPLAY 'CONTROL CARD BYPASSED -- '             05660004
056700                          'NUMBER ENTERED ('                      05670004
056800                          PV-BYR-DPT                              05680004
056900                          ') IS INVALID'                          05690004
057000              END-IF                                              05700004
057100         WHEN OTHER                                               05710004
057200              SET PS-CONTROL-CARD-INVALID TO TRUE                 05720004
057300              DISPLAY 'CONTROL CARD BYPASSED -- TYPE ENTERED ('   05730004
057400                      CC-TYPE                                     05740004
057500                      ') IS INVALID'                              05750004
057600     END-EVALUATE.                                                05760004
057700*                                                                 05770004
057800*                                                                 05780004
057900******************************************************************05790004
058000*  OPEN ALL CURSOR AND DO FIRST FETCH.  PERFORM A LOOP THAT WILL  05800004
058100*  CREATE ALL OUTPUT RECORDS FOR THE ENTIRE MBS STRUCTURE.        05810004
058200******************************************************************05820004
058300 3000-ALL-PROCESS.                                                05830004
058400     PERFORM 7000-OPEN-ALL-CSR.                                   05840004
058500     PERFORM 7010-FETCH-ALL-CSR.                                  05850004
058600*                                                                 05860004
058700     IF  SQLCODE = ZERO                                           05870004
058800         ADD 1                   TO PV-CC-MBS-VALID-CNT           05880004
058900         DISPLAY 'CONTROL CARD PROCESSED'                         05890004
059000         PERFORM 3010-ALL-LOOP                                    05900004
059100           UNTIL SQLCODE = +100                                   05910004
059200     ELSE                                                         05920004
059300         ADD 1                   TO PV-CC-MBS-INVALID-CNT         05930004
059400         DISPLAY 'CONTROL CARD BYPASSED -- ALL ENTERED ('         05940004
059500                 CC-NUMBER-X                                      05950004
059600                 '), BUT NO MBS DATA FOUND'                       05960004
059700     END-IF.                                                      05970004
059800*                                                                 05980004
059900*                                                                 05990004
060000******************************************************************06000004
060100*  CREATE THE 'GMM', 'DMM', 'BYR', 'DPT', 'MCL' AND 'SCL' OUTPUT  06010004
060200*  RECORDS FOR ALL OF MBS.  THIS PARAGRAPH IS A LOOP.             06020004
060300******************************************************************06030004
060400 3010-ALL-LOOP.                                                   06040004
060500     EVALUATE TRUE                                                06050004
060600         WHEN MDSEAR-MDSELV-CDE = PC-MDSELV-GMA                   06060004
060700              PERFORM 3900-FORMAT-GMM-OUTPUT                      06070004
060800         WHEN MDSEAR-MDSELV-CDE = PC-MDSELV-DMA                   06080004
060900              PERFORM 3910-FORMAT-DMM-OUTPUT                      06090004
061000         WHEN MDSEAR-MDSELV-CDE = PC-MDSELV-DPT                   06100004
061100              PERFORM 3920-FORMAT-DPT-OUTPUT                      06110004
061200         WHEN MDSEAR-MDSELV-CDE = PC-MDSELV-MCL                   06120004
061300              PERFORM 3940-FORMAT-MCL-OUTPUT                      06130004
061400         WHEN MDSEAR-MDSELV-CDE = PC-MDSELV-SCL                   06140004
061500              PERFORM 3950-FORMAT-SCL-OUTPUT                      06150004
061600     END-EVALUATE.                                                06160004
061700*                                                                 06170004
061800     WRITE MBS-STRUCTURE-RECORD-OUT                               06180004
061900      FROM CN002-MBS-STRUCTURE-RECORD.                            06190004
062000*                                                                 06200004
062100     PERFORM 7010-FETCH-ALL-CSR.                                  06210004
062200*                                                                 06220004
062300*                                                                 06230004
062400******************************************************************06240004
062500*  OPEN GMM CURSOR AND DO FIRST FETCH.  PERFORM A LOOP THAT WILL  06250004
062600*  WILL CREATE ALL OUTPUT RECORDS FOR THE SELECTED GMM.           06260004
062700******************************************************************06270004
062800 3100-GMM-PROCESS.                                                06280004
062900     PERFORM 7100-OPEN-GMM-CSR.                                   06290004
063000     PERFORM 7110-FETCH-GMM-CSR.                                  06300004
063100*                                                                 06310004
063200     IF  SQLCODE = ZERO                                           06320004
063300         ADD 1                   TO PV-CC-MBS-VALID-CNT           06330004
063400         DISPLAY 'CONTROL CARD PROCESSED'                         06340004
063500         PERFORM 3110-GMM-LOOP                                    06350004
063600           UNTIL SQLCODE = +100                                   06360004
063700     ELSE                                                         06370004
063800         ADD 1                   TO PV-CC-MBS-INVALID-CNT         06380004
063900         DISPLAY 'CONTROL CARD BYPASSED -- GMM ENTERED ('         06390004
064000                 PV-GMM-DMM                                       06400004
064100                 ') NOT FOUND'                                    06410004
064200     END-IF.                                                      06420004
064300*                                                                 06430004
064400     PERFORM 7120-CLOSE-GMM-CSR.                                  06440004
064500*                                                                 06450004
064600*                                                                 06460004
064700******************************************************************06470004
064800*  CREATE THE 'GMM', 'DMM', 'BYR', 'DPT', 'MCL' AND 'SCL' OUTPUT  06480004
064900*  RECORDS FOR THE SELECTED GMM.  THIS PARAGRAPH IS A LOOP.       06490004
065000******************************************************************06500004
065100 3110-GMM-LOOP.                                                   06510004
065200     EVALUATE TRUE                                                06520004
065300         WHEN MDSEAR-MDSELV-CDE = PC-MDSELV-GMA                   06530004
065400              PERFORM 3900-FORMAT-GMM-OUTPUT                      06540004
065500         WHEN MDSEAR-MDSELV-CDE = PC-MDSELV-DMA                   06550004
065600              PERFORM 3910-FORMAT-DMM-OUTPUT                      06560004
065700         WHEN MDSEAR-MDSELV-CDE = PC-MDSELV-DPT                   06570004
065800              PERFORM 3920-FORMAT-DPT-OUTPUT                      06580004
065900         WHEN MDSEAR-MDSELV-CDE = PC-MDSELV-MCL                   06590004
066000              PERFORM 3940-FORMAT-MCL-OUTPUT                      06600004
066100         WHEN MDSEAR-MDSELV-CDE = PC-MDSELV-SCL                   06610004
066200              PERFORM 3950-FORMAT-SCL-OUTPUT                      06620004
066300     END-EVALUATE.                                                06630004
066400*                                                                 06640004
066500     WRITE MBS-STRUCTURE-RECORD-OUT                               06650004
066600      FROM CN002-MBS-STRUCTURE-RECORD.                            06660004
066700*                                                                 06670004
066800     PERFORM 7110-FETCH-GMM-CSR.                                  06680004
066900*                                                                 06690004
067000*                                                                 06700004
067100******************************************************************06710004
067200*  OPEN DMM CURSOR AND DO FIRST FETCH.  BUILD 'GMA' OUTPUT RECORD 06720004
067300*  FOR THE SELECTED DMM.  PERFORM A LOOP THAT WILL CREATE ALL     06730004
067400*  OTHER OUTPUT RECORDS FOR THE SELECTED DMM.                     06740004
067500******************************************************************06750004
067600 3200-DMM-PROCESS.                                                06760004
067700     PERFORM 7200-OPEN-DMM-CSR.                                   06770004
067800     PERFORM 7210-FETCH-DMM-CSR.                                  06780004
067900*                                                                 06790004
068000     IF  SQLCODE = ZERO                                           06800004
068100         ADD 1                   TO PV-CC-MBS-VALID-CNT           06810004
068200         DISPLAY 'CONTROL CARD PROCESSED'                         06820004
068300         MOVE MDSEAR-DKEY        TO PV-SAVE-DKEY                  06830004
068400         PERFORM 4000-SELECT-GMA                                  06840004
068500         MOVE PV-SAVE-DKEY       TO MDSEAR-DKEY                   06850004
068600         PERFORM 3210-DMM-LOOP                                    06860004
068700           UNTIL SQLCODE = +100                                   06870004
068800     ELSE                                                         06880004
068900         ADD 1                   TO PV-CC-MBS-INVALID-CNT         06890004
069000         DISPLAY 'CONTROL CARD BYPASSED -- DMM ENTERED ('         06900004
069100                 PV-GMM-DMM                                       06910004
069200                 ') NOT FOUND'                                    06920004
069300     END-IF.                                                      06930004
069400*                                                                 06940004
069500     PERFORM 7220-CLOSE-DMM-CSR.                                  06950004
069600*                                                                 06960004
069700*                                                                 06970004
069800******************************************************************06980004
069900*  CREATE THE 'DMM', 'BYR', 'DPT', 'MCL' AND 'SCL' OUTPUT         06990004
070000*  RECORDS FOR THE SELECTED DMM.  THIS PARAGRAPH IS A LOOP.       07000004
070100******************************************************************07010004
070200 3210-DMM-LOOP.                                                   07020004
070300     EVALUATE TRUE                                                07030004
070400         WHEN MDSEAR-MDSELV-CDE = PC-MDSELV-DMA                   07040004
070500              PERFORM 3910-FORMAT-DMM-OUTPUT                      07050004
070600         WHEN MDSEAR-MDSELV-CDE = PC-MDSELV-DPT                   07060004
070700              PERFORM 3920-FORMAT-DPT-OUTPUT                      07070004
070800         WHEN MDSEAR-MDSELV-CDE = PC-MDSELV-MCL                   07080004
070900              PERFORM 3940-FORMAT-MCL-OUTPUT                      07090004
071000         WHEN MDSEAR-MDSELV-CDE = PC-MDSELV-SCL                   07100004
071100              PERFORM 3950-FORMAT-SCL-OUTPUT                      07110004
071200     END-EVALUATE.                                                07120004
071300*                                                                 07130004
071400     WRITE MBS-STRUCTURE-RECORD-OUT                               07140004
071500      FROM CN002-MBS-STRUCTURE-RECORD.                            07150004
071600*                                                                 07160004
071700     PERFORM 7210-FETCH-DMM-CSR.                                  07170004
071800*                                                                 07180004
071900*                                                                 07190004
072000******************************************************************07200004
072100*  OPEN BYR CURSOR AND DO FIRST FETCH.  BUILD 'GMA' AND 'DMA'     07210004
072200*  OUTPUT RECORDS FOR THE SELECTED BUYER.  PERFORM A LOOP THAT    07220004
072300*  WILL CREATE ALL OTHER OUTPUT RECORDS FOR THE SELECTED BUYER.   07230004
072400******************************************************************07240004
072500 3300-BYR-PROCESS.                                                07250004
072600     PERFORM 7300-OPEN-BYR-CSR.                                   07260004
072700     PERFORM 7310-FETCH-BYR-CSR.                                  07270004
072800*                                                                 07280004
072900     IF  SQLCODE = ZERO                                           07290004
073000         ADD 1                   TO PV-CC-MBS-VALID-CNT           07300004
073100         DISPLAY 'CONTROL CARD PROCESSED'                         07310004
073200         MOVE MDSEAR-DKEY        TO PV-SAVE-DKEY                  07320004
073300         PERFORM 4000-SELECT-GMA                                  07330004
073400         PERFORM 4100-SELECT-DMA                                  07340004
073500         MOVE PV-SAVE-DKEY       TO MDSEAR-DKEY                   07350004
073600         PERFORM 3310-BUYER-LOOP                                  07360004
073700           UNTIL SQLCODE = +100                                   07370004
073800     ELSE                                                         07380004
073900         ADD 1                   TO PV-CC-MBS-INVALID-CNT         07390004
074000         DISPLAY 'CONTROL CARD BYPASSED -- BUYER ENTERED ('       07400004
074100                 CC-NUMBER-X                                      07410004
074200                 ') NOT FOUND'                                    07420004
074300     END-IF.                                                      07430004
074400*                                                                 07440004
074500     PERFORM 7320-CLOSE-BYR-CSR.                                  07450004
074600*                                                                 07460004
074700*                                                                 07470004
074800******************************************************************07480004
074900*  CREATE THE 'BYR', 'DPT', 'MCL' AND 'SCL' OUTPUT RECORDS FOR    07490004
075000*  THE SELECTED BUYER.  THIS PARAGRAPH IS A LOOP.                 07500004
075100******************************************************************07510004
075200 3310-BUYER-LOOP.                                                 07520004
075300     EVALUATE TRUE                                                07530004
075400         WHEN MDSEAR-MDSELV-CDE = PC-MDSELV-DPT                   07540004
075500              PERFORM 3920-FORMAT-DPT-OUTPUT                      07550004
075600         WHEN MDSEAR-MDSELV-CDE = PC-MDSELV-MCL                   07560004
075700              PERFORM 3940-FORMAT-MCL-OUTPUT                      07570004
075800         WHEN MDSEAR-MDSELV-CDE = PC-MDSELV-SCL                   07580004
075900              PERFORM 3950-FORMAT-SCL-OUTPUT                      07590004
076000     END-EVALUATE.                                                07600004
076100*                                                                 07610004
076200     WRITE MBS-STRUCTURE-RECORD-OUT                               07620004
076300      FROM CN002-MBS-STRUCTURE-RECORD.                            07630004
076400*                                                                 07640004
076500     PERFORM 7310-FETCH-BYR-CSR.                                  07650004
076600*                                                                 07660004
076700*                                                                 07670004
076800******************************************************************07680004
076900*  OPEN DPT CURSOR AND DO FIRST FETCH.  BUILD 'GMA', 'DMA' AND    07690004
077000*  'BYR' OUTPUT RECORDS FOR THE SELECTED BUYER.  PERFORM A LOOP   07700004
077100*  THAT WILL CREATE ALL OTHER OUTPUT RECORDS FOR THE SELECTED     07710004
077200*  DEPARTMENT.                                                    07720004
077300*  RECORDS FOR THE SELECTED DEPARTMENT.                           07730004
077400******************************************************************07740004
077500 3400-DPT-PROCESS.                                                07750004
077600     PERFORM 7400-OPEN-DPT-CSR.                                   07760004
077700     PERFORM 7410-FETCH-DPT-CSR.                                  07770004
077800*                                                                 07780004
077900     IF  SQLCODE = ZERO                                           07790004
078000         ADD 1                   TO PV-CC-MBS-VALID-CNT           07800004
078100         DISPLAY 'CONTROL CARD PROCESSED'                         07810004
078200         MOVE MDSEAR-DKEY        TO PV-SAVE-DKEY                  07820004
078300         PERFORM 4000-SELECT-GMA                                  07830004
078400         PERFORM 4100-SELECT-DMA                                  07840004
078500         MOVE PV-SAVE-DKEY       TO MDSEAR-DKEY                   07850004
078600         PERFORM 3410-DEPT-LOOP                                   07860004
078700           UNTIL SQLCODE = +100                                   07870004
078800     ELSE                                                         07880004
078900         ADD 1                   TO PV-CC-MBS-INVALID-CNT         07890004
079000         DISPLAY 'CONTROL CARD BYPASSED -- DEPT ENTERED ('        07900004
079100                 CC-NUMBER-X                                      07910004
079200                 ') NOT FOUND'                                    07920004
079300     END-IF.                                                      07930004
079400*                                                                 07940004
079500     PERFORM 7420-CLOSE-DPT-CSR.                                  07950004
079600*                                                                 07960004
079700*                                                                 07970004
079800******************************************************************07980004
079900*  CREATE THE 'DPT', 'MCL' AND 'SCL' OUTPUT RECORDS FOR THE       07990004
080000*  SELECTED DEPARTMENT.  THIS PARAGRAPH IS A LOOP.                08000004
080100******************************************************************08010004
080200 3410-DEPT-LOOP.                                                  08020004
080300     EVALUATE TRUE                                                08030004
080400         WHEN MDSEAR-MDSELV-CDE = PC-MDSELV-DPT                   08040004
080500              MOVE MDSEAR-GMA-NBR    TO CN002-GMM                 08050004
080600              MOVE MDSEAR-DMA-NBR    TO CN002-DMM                 08060004
080700              MOVE MDSEAR-BYR-NBR    TO CN002-BUYER               08070004
080800              PERFORM 3930-FORMAT-BYR-OUTPUT                      08080004
080900              MOVE MDSEAR-DEPT-NBR   TO CN002-DEPT                08090004
081000              MOVE SPACES            TO CN002-MAJ-CLASS           08100004
081100                                        CN002-SUB-CLASS           08110004
081200              MOVE MDSEAR-MDSELV-CDE TO CN002-LEVEL               08120004
081300              MOVE MDSEAR-DESC       TO CN002-DESC                08130004
081400         WHEN MDSEAR-MDSELV-CDE = PC-MDSELV-MCL                   08140004
081500              PERFORM 3940-FORMAT-MCL-OUTPUT                      08150004
081600         WHEN MDSEAR-MDSELV-CDE = PC-MDSELV-SCL                   08160004
081700              PERFORM 3950-FORMAT-SCL-OUTPUT                      08170004
081800     END-EVALUATE.                                                08180004
081900*                                                                 08190004
082000     WRITE MBS-STRUCTURE-RECORD-OUT                               08200004
082100      FROM CN002-MBS-STRUCTURE-RECORD.                            08210004
082200*                                                                 08220004
082300     PERFORM 7410-FETCH-DPT-CSR.                                  08230004
082400*                                                                 08240004
082500*                                                                 08250004
082600******************************************************************08260004
082700*  FORMAT 'GMM' OUTPUT RECORD                                     08270004
082800******************************************************************08280004
082900 3900-FORMAT-GMM-OUTPUT.                                          08290004
083000     MOVE MDSEAR-GMA-NBR         TO CN002-GMM.                    08300004
083100     MOVE SPACES                 TO CN002-DMM                     08310004
083200                                    CN002-BUYER                   08320004
083300                                    CN002-DEPT                    08330004
083400                                    CN002-MAJ-CLASS               08340004
083500                                    CN002-SUB-CLASS.              08350004
083600     MOVE MDSEAR-MDSELV-CDE      TO CN002-LEVEL.                  08360004
083700     PERFORM 4200-GET-GMM-NAME.                                   08370004
083800*                                                                 08380004
083900*                                                                 08390004
084000******************************************************************08400004
084100*  FORMAT 'DMM' OUTPUT RECORD                                     08410004
084200******************************************************************08420004
084300 3910-FORMAT-DMM-OUTPUT.                                          08430004
084400     MOVE MDSEAR-GMA-NBR         TO CN002-GMM.                    08440004
084500     MOVE MDSEAR-DMA-NBR         TO CN002-DMM.                    08450004
084600     MOVE SPACES                 TO CN002-BUYER                   08460004
084700                                    CN002-DEPT                    08470004
084800                                    CN002-MAJ-CLASS               08480004
084900                                    CN002-SUB-CLASS.              08490004
085000     MOVE MDSEAR-MDSELV-CDE      TO CN002-LEVEL.                  08500004
085100     PERFORM 4300-GET-DMM-NAME.                                   08510004
085200*                                                                 08520004
085300*                                                                 08530004
085400******************************************************************08540004
085500*  FORMAT 'DPT' OUTPUT RECORD                                     08550004
085600******************************************************************08560004
085700 3920-FORMAT-DPT-OUTPUT.                                          08570004
085800     MOVE MDSEAR-GMA-NBR         TO CN002-GMM.                    08580004
085900     MOVE MDSEAR-DMA-NBR         TO CN002-DMM.                    08590004
086000     MOVE MDSEAR-BYR-NBR         TO CN002-BUYER.                  08600004
086100*                                                                 08610004
086200     IF  MDSEAR-BYR-NBR = PV-SAVE-BUYER                           08620004
086300         CONTINUE                                                 08630004
086400     ELSE                                                         08640004
086500         PERFORM 3930-FORMAT-BYR-OUTPUT                           08650004
086600         MOVE MDSEAR-BYR-NBR     TO PV-SAVE-BUYER                 08660004
086700     END-IF.                                                      08670004
086800*                                                                 08680004
086900     MOVE MDSEAR-DEPT-NBR        TO CN002-DEPT.                   08690004
087000     MOVE SPACES                 TO CN002-MAJ-CLASS               08700004
087100                                    CN002-SUB-CLASS.              08710004
087200     MOVE MDSEAR-MDSELV-CDE      TO CN002-LEVEL.                  08720004
087300     MOVE MDSEAR-DESC            TO CN002-DESC.                   08730004
087400*                                                                 08740004
087500*                                                                 08750004
087600******************************************************************08760004
087700*  FORMAT 'BYR' OUTPUT RECORD                                     08770004
087800******************************************************************08780004
087900 3930-FORMAT-BYR-OUTPUT.                                          08790004
088000     MOVE SPACES                 TO CN002-DEPT                    08800004
088100                                    CN002-MAJ-CLASS               08810004
088200                                    CN002-SUB-CLASS.              08820004
088300     MOVE PC-RSPLVL-CDE-BYR      TO CN002-LEVEL.                  08830004
088400*                                                                 08840004
088500     PERFORM 4400-GET-BUYER-NAME.                                 08850004
088600*                                                                 08860004
088700     WRITE MBS-STRUCTURE-RECORD-OUT                               08870004
088800      FROM CN002-MBS-STRUCTURE-RECORD.                            08880004
088900*                                                                 08890004
089000*                                                                 08900004
089100******************************************************************08910004
089200*  FORMAT 'MCL' OUTPUT RECORD                                     08920004
089300******************************************************************08930004
089400 3940-FORMAT-MCL-OUTPUT.                                          08940004
089500     MOVE MDSEAR-GMA-NBR         TO CN002-GMM.                    08950004
089600     MOVE MDSEAR-DMA-NBR         TO CN002-DMM.                    08960004
089700     MOVE MDSEAR-BYR-NBR         TO CN002-BUYER.                  08970004
089800     MOVE MDSEAR-DEPT-NBR        TO CN002-DEPT.                   08980004
089900     MOVE MDSEAR-MAJ-CL-NBR      TO CN002-MAJ-CLASS.              08990004
090000     MOVE SPACES                 TO CN002-SUB-CLASS.              09000004
090100     MOVE MDSEAR-MDSELV-CDE      TO CN002-LEVEL.                  09010004
090200     MOVE MDSEAR-DESC            TO CN002-DESC.                   09020004
090300*                                                                 09030004
090400*                                                                 09040004
090500******************************************************************09050004
090600*  FORMAT 'SCL' OUTPUT RECORD                                     09060004
090700******************************************************************09070004
090800 3950-FORMAT-SCL-OUTPUT.                                          09080004
090900     MOVE MDSEAR-GMA-NBR         TO CN002-GMM.                    09090004
091000     MOVE MDSEAR-DMA-NBR         TO CN002-DMM.                    09100004
091100     MOVE MDSEAR-BYR-NBR         TO CN002-BUYER.                  09110004
091200     MOVE MDSEAR-DEPT-NBR        TO CN002-DEPT.                   09120004
091300     MOVE MDSEAR-MAJ-CL-NBR      TO CN002-MAJ-CLASS.              09130004
091400     MOVE MDSEAR-SUB-CL-NBR      TO CN002-SUB-CLASS.              09140004
091500     MOVE MDSEAR-MDSELV-CDE      TO CN002-LEVEL.                  09150004
091600     MOVE MDSEAR-DESC            TO CN002-DESC.                   09160004
091700*                                                                 09170004
091800*                                                                 09180004
091900******************************************************************09190004
092000*  BUILD 'GMA' RECORD                                             09200004
092100******************************************************************09210004
092200 4000-SELECT-GMA.                                                 09220004
092300     EXEC SQL                                                     09230004
092400           SELECT MDSEAR_DKEY                                     09240004
092500             INTO :MDSEAR-DKEY                                    09250004
092600             FROM TMDSEAR                                         09260004
092700            WHERE OPERCO_NBR   = :PC-CURRENT-OPER-CO              09270004
092800              AND MDSELV_CDE   = :PC-MDSELV-GMA                   09280004
092900              AND GMA_NBR      = :MDSEAR-GMA-NBR                  09290004
093000              AND (CURRENT DATE                                   09300004
093100                           BETWEEN CHAR(STRT_DTE,ISO)             09310004
093200                               AND CHAR(END_DTE,ISO))             09320004
093300     END-EXEC.                                                    09330004
093400*                                                                 09340004
093500     EVALUATE TRUE                                                09350004
093600         WHEN SQLCODE = ZERO                                      09360004
093700              CONTINUE                                            09370004
093800         WHEN SQLWARN0 NOT = SPACES                               09380004
093900         WHEN SQLCODE < ZERO                                      09390004
094000         WHEN SQLCODE > ZERO                                      09400004
094100              MOVE '4000-SELECT-GMA'                              09410004
094200                                 TO PV-ABEND-PARAGRAPH            09420004
094300              MOVE 'SELECT OF TMDSEAR'                            09430004
094400                                 TO PV-DB2-OPERATION-ATTEMPTED    09440004
094500              PERFORM 9200-SQL-ABEND                              09450004
094600     END-EVALUATE.                                                09460004
094700*                                                                 09470004
094800     MOVE MDSEAR-GMA-NBR             TO CN002-GMM.                09480004
094900     MOVE SPACES                     TO CN002-DMM                 09490004
095000                                        CN002-BUYER               09500004
095100                                        CN002-DEPT                09510004
095200                                        CN002-MAJ-CLASS           09520004
095300                                        CN002-SUB-CLASS.          09530004
095400     MOVE PC-MDSELV-GMA              TO CN002-LEVEL.              09540004
095500     PERFORM 4200-GET-GMM-NAME.                                   09550004
095600     WRITE MBS-STRUCTURE-RECORD-OUT                               09560004
095700      FROM CN002-MBS-STRUCTURE-RECORD.                            09570004
095800*                                                                 09580004
095900*                                                                 09590004
096000******************************************************************09600004
096100*  BUILD 'DMA' RECORD                                             09610004
096200******************************************************************09620004
096300 4100-SELECT-DMA.                                                 09630004
096400     EXEC SQL                                                     09640004
096500           SELECT MDSEAR_DKEY                                     09650004
096600             INTO :MDSEAR-DKEY                                    09660004
096700             FROM TMDSEAR                                         09670004
096800            WHERE OPERCO_NBR   = :PC-CURRENT-OPER-CO              09680004
096900              AND MDSELV_CDE   = :PC-MDSELV-DMA                   09690004
097000              AND GMA_NBR      = :MDSEAR-GMA-NBR                  09700004
097100              AND DMA_NBR      = :MDSEAR-DMA-NBR                  09710004
097200              AND (CURRENT DATE                                   09720004
097300                           BETWEEN CHAR(STRT_DTE,ISO)             09730004
097400                               AND CHAR(END_DTE,ISO))             09740004
097500     END-EXEC.                                                    09750004
097600*                                                                 09760004
097700     EVALUATE TRUE                                                09770004
097800         WHEN SQLCODE = ZERO                                      09780004
097900              CONTINUE                                            09790004
098000         WHEN SQLWARN0 NOT = SPACES                               09800004
098100         WHEN SQLCODE < ZERO                                      09810004
098200         WHEN SQLCODE > ZERO                                      09820004
098300              MOVE '4100-SELECT-DMA'                              09830004
098400                                 TO PV-ABEND-PARAGRAPH            09840004
098500              MOVE 'SELECT OF TMDSEAR'                            09850004
098600                                 TO PV-DB2-OPERATION-ATTEMPTED    09860004
098700              PERFORM 9200-SQL-ABEND                              09870004
098800     END-EVALUATE.                                                09880004
098900*                                                                 09890004
099000     MOVE MDSEAR-GMA-NBR             TO CN002-GMM.                09900004
099100     MOVE MDSEAR-DMA-NBR             TO CN002-DMM.                09910004
099200     MOVE SPACES                     TO CN002-BUYER               09920004
099300                                        CN002-DEPT                09930004
099400                                        CN002-MAJ-CLASS           09940004
099500                                        CN002-SUB-CLASS.          09950004
099600     MOVE PC-MDSELV-DMA              TO CN002-LEVEL.              09960004
099700     PERFORM 4300-GET-DMM-NAME.                                   09970004
099800     WRITE MBS-STRUCTURE-RECORD-OUT                               09980004
099900      FROM CN002-MBS-STRUCTURE-RECORD.                            09990004
100000*                                                                 10000004
100100*                                                                 10010004
100200******************************************************************10020004
100300*  GET THE GMM NAME                                               10030004
100400******************************************************************10040004
100500 4200-GET-GMM-NAME.                                               10050004
100600     MOVE PC-RSPLVL-CDE-GMM      TO RSPBAR-RSPLVL-CDE.            10060004
100700     PERFORM 4500-GET-WORKER-NAME.                                10070004
100800*                                                                 10080004
100900     INITIALIZE CN002-DESC.                                       10090004
101000*                                                                 10100004
101100     EVALUATE TRUE                                                10110004
101200         WHEN SQLCODE = ZERO                                      10120004
101300              STRING RSPBAR-WORKER-FIR-NAME DELIMITED BY '  '     10130004
101400                                      SPACE DELIMITED BY SIZE     10140004
101500                     RSPBAR-WORKER-LAST-NAME DELIMITED BY SIZE    10150004
101600                INTO CN002-DESC                                   10160004
101700              END-STRING                                          10170004
101800         WHEN SQLCODE = +100                                      10180004
101900              MOVE '*** GMM NOT FOUND ***'                        10190004
102000                                 TO CN002-DESC                    10200004
102100         WHEN SQLWARN0 NOT = SPACES                               10210004
102200         WHEN SQLCODE < ZERO                                      10220004
102300         WHEN SQLCODE > ZERO                                      10230004
102400              MOVE '4200-GET-GMM-NAME'                            10240004
102500                                 TO PV-ABEND-PARAGRAPH            10250004
102600              MOVE 'SELECT OF TRSPBAR'                            10260004
102700                                 TO PV-DB2-OPERATION-ATTEMPTED    10270004
102800              PERFORM 9200-SQL-ABEND                              10280004
102900     END-EVALUATE.                                                10290004
103000*                                                                 10300004
103100*                                                                 10310004
103200******************************************************************10320004
103300*  GET THE DMM NAME                                               10330004
103400******************************************************************10340004
103500 4300-GET-DMM-NAME.                                               10350004
103600     MOVE PC-RSPLVL-CDE-DMM      TO RSPBAR-RSPLVL-CDE.            10360004
103700     PERFORM 4500-GET-WORKER-NAME.                                10370004
103800*                                                                 10380004
103900     INITIALIZE CN002-DESC.                                       10390004
104000*                                                                 10400004
104100     EVALUATE TRUE                                                10410004
104200         WHEN SQLCODE = ZERO                                      10420004
104300              STRING RSPBAR-WORKER-FIR-NAME DELIMITED BY '  '     10430004
104400                                      SPACE DELIMITED BY SIZE     10440004
104500                     RSPBAR-WORKER-LAST-NAME DELIMITED BY SIZE    10450004
104600                INTO CN002-DESC                                   10460004
104700              END-STRING                                          10470004
104800         WHEN SQLCODE = +100                                      10480004
104900              MOVE '*** DMM NOT FOUND ***'                        10490004
105000                                 TO CN002-DESC                    10500004
105100         WHEN SQLWARN0 NOT = SPACES                               10510004
105200         WHEN SQLCODE < ZERO                                      10520004
105300         WHEN SQLCODE > ZERO                                      10530004
105400              MOVE '4300-GET-DMM-NAME'                            10540004
105500                                 TO PV-ABEND-PARAGRAPH            10550004
105600              MOVE 'SELECT OF TRSPBAR'                            10560004
105700                                 TO PV-DB2-OPERATION-ATTEMPTED    10570004
105800              PERFORM 9200-SQL-ABEND                              10580004
105900     END-EVALUATE.                                                10590004
106000*                                                                 10600004
106100*                                                                 10610004
106200******************************************************************10620004
106300*  GET THE BUYER NAME                                             10630004
106400******************************************************************10640004
106500 4400-GET-BUYER-NAME.                                             10650004
106600     MOVE PC-RSPLVL-CDE-BYR      TO RSPBAR-RSPLVL-CDE.            10660004
106700     PERFORM 4500-GET-WORKER-NAME.                                10670004
106800*                                                                 10680004
106900     INITIALIZE CN002-DESC.                                       10690004
107000*                                                                 10700004
107100     EVALUATE TRUE                                                10710004
107200         WHEN SQLCODE = ZERO                                      10720004
107300              STRING RSPBAR-WORKER-FIR-NAME DELIMITED BY '  '     10730004
107400                                      SPACE DELIMITED BY SIZE     10740004
107500                     RSPBAR-WORKER-LAST-NAME DELIMITED BY SIZE    10750004
107600                INTO CN002-DESC                                   10760004
107700              END-STRING                                          10770004
107800         WHEN SQLCODE = +100                                      10780004
107900              MOVE '*** BUYER NOT FOUND ***'                      10790004
108000                                 TO CN002-DESC                    10800004
108100         WHEN SQLWARN0 NOT = SPACES                               10810004
108200         WHEN SQLCODE < ZERO                                      10820004
108300         WHEN SQLCODE > ZERO                                      10830004
108400              MOVE '4400-GET-BUYER-NAME'                          10840004
108500                                 TO PV-ABEND-PARAGRAPH            10850004
108600              MOVE 'SELECT OF TRSPBAR'                            10860004
108700                                 TO PV-DB2-OPERATION-ATTEMPTED    10870004
108800              PERFORM 9200-SQL-ABEND                              10880004
108900     END-EVALUATE.                                                10890004
109000*                                                                 10900004
109100     INITIALIZE CN002-DESC.                                       10910004
109200*                                                                 10920004
109300     STRING  RSPBAR-WORKER-FIR-NAME DELIMITED BY '  '             10930004
109400                              SPACE DELIMITED BY SIZE             10940004
109500            RSPBAR-WORKER-LAST-NAME DELIMITED BY SIZE             10950004
109600       INTO CN002-DESC                                            10960004
109700     END-STRING.                                                  10970004
109800*                                                                 10980004
109900*                                                                 10990004
110000******************************************************************11000004
110100*  GET THE WORKER NAME                                            11010004
110200******************************************************************11020004
110300 4500-GET-WORKER-NAME.                                            11030004
110400     EXEC SQL                                                     11040004
110500          SELECT WORKER_FIR_NAME,                                 11050004
110600                 WORKER_LAST_NAME                                 11060004
110700            INTO :RSPBAR-WORKER-FIR-NAME,                         11070004
110800                 :RSPBAR-WORKER-LAST-NAME                         11080004
110900            FROM TRSPBAR                                          11090004
111000           WHERE (MDSEAR_DKEY  = :MDSEAR-DKEY                     11100004
111100                  AND                                             11110004
111200                  (CURRENT DATE                                   11120004
111300                           BETWEEN CHAR(WORKER_STRT_DTE,ISO)      11130004
111400                               AND CHAR(WORKER_END_DTE,ISO))      11140004
111500                  AND                                             11150004
111600                  RSPLVL_CDE   = :RSPBAR-RSPLVL-CDE)              11160004
111700     END-EXEC.                                                    11170004
111800*                                                                 11180004
111900*                                                                 11190004
112000******************************************************************11200004
112100*  OPEN THE ALL_CSR                                               11210004
112200******************************************************************11220004
112300 7000-OPEN-ALL-CSR.                                               11230004
112400     EXEC SQL                                                     11240004
112500          OPEN ALL_CSR                                            11250004
112600     END-EXEC.                                                    11260004
112700*                                                                 11270004
112800     EVALUATE TRUE                                                11280004
112900         WHEN SQLCODE = ZERO                                      11290004
113000              CONTINUE                                            11300004
113100         WHEN OTHER                                               11310004
113200              MOVE '7000-OPEN-ALL-CSR'                            11320004
113300                                 TO PV-ABEND-PARAGRAPH            11330004
113400              MOVE PE-MSG-01     TO PV-DB2-OPERATION-ATTEMPTED    11340004
113500              PERFORM 9200-SQL-ABEND                              11350004
113600     END-EVALUATE.                                                11360004
113700*                                                                 11370004
113800*                                                                 11380004
113900******************************************************************11390004
114000*  FETCH THE NEXT DEPT/CLASS COMBINATION USING THE ALL_CSR        11400004
114100******************************************************************11410004
114200 7010-FETCH-ALL-CSR.                                              11420004
114300     EXEC SQL                                                     11430004
114400          FETCH ALL_CSR                                           11440004
114500           INTO :MDSEAR-GMA-NBR,                                  11450004
114600                :MDSEAR-DMA-NBR,                                  11460004
114700                :MDSEAR-DEPT-NBR,                                 11470004
114800                :MDSEAR-MAJ-CL-NBR,                               11480004
114900                :MDSEAR-SUB-CL-NBR,                               11490004
115000                :MDSEAR-BYR-NBR,                                  11500004
115100                :MDSEAR-MDSELV-CDE,                               11510004
115200                :MDSEAR-DESC,                                     11520004
115300                :MDSEAR-DKEY                                      11530004
115400     END-EXEC.                                                    11540004
115500*                                                                 11550004
115600     EVALUATE TRUE                                                11560004
115700         WHEN SQLCODE = ZERO                                      11570004
115800         WHEN SQLCODE = +100                                      11580004
115900              CONTINUE                                            11590004
116000         WHEN OTHER                                               11600004
116100              MOVE '7010-FETCH-ALL-CSR'                           11610004
116200                                 TO PV-ABEND-PARAGRAPH            11620004
116300              MOVE PE-MSG-02     TO PV-DB2-OPERATION-ATTEMPTED    11630004
116400              PERFORM 9200-SQL-ABEND                              11640004
116500     END-EVALUATE.                                                11650004
116600*                                                                 11660004
116700*                                                                 11670004
116800******************************************************************11680004
116900*  OPEN THE GMM_CSR                                               11690004
117000******************************************************************11700004
117100 7100-OPEN-GMM-CSR.                                               11710004
117200     EXEC SQL                                                     11720004
117300          OPEN GMM_CSR                                            11730004
117400     END-EXEC.                                                    11740004
117500*                                                                 11750004
117600     EVALUATE TRUE                                                11760004
117700         WHEN SQLCODE = ZERO                                      11770004
117800              CONTINUE                                            11780004
117900         WHEN OTHER                                               11790004
118000              MOVE '7100-OPEN-GMM-CSR'                            11800004
118100                                 TO PV-ABEND-PARAGRAPH            11810004
118200              MOVE PE-MSG-03     TO PV-DB2-OPERATION-ATTEMPTED    11820004
118300              PERFORM 9200-SQL-ABEND                              11830004
118400     END-EVALUATE.                                                11840004
118500*                                                                 11850004
118600*                                                                 11860004
118700******************************************************************11870004
118800*  FETCH THE NEXT DEPT/CLASS COMBINATION USING THE GMM_CSR        11880004
118900******************************************************************11890004
119000 7110-FETCH-GMM-CSR.                                              11900004
119100     EXEC SQL                                                     11910004
119200          FETCH GMM_CSR                                           11920004
119300           INTO :MDSEAR-GMA-NBR,                                  11930004
119400                :MDSEAR-DMA-NBR,                                  11940004
119500                :MDSEAR-DEPT-NBR,                                 11950004
119600                :MDSEAR-MAJ-CL-NBR,                               11960004
119700                :MDSEAR-SUB-CL-NBR,                               11970004
119800                :MDSEAR-BYR-NBR,                                  11980004
119900                :MDSEAR-MDSELV-CDE,                               11990004
120000                :MDSEAR-DESC,                                     12000004
120100                :MDSEAR-DKEY                                      12010004
120200     END-EXEC.                                                    12020004
120300*                                                                 12030004
120400     EVALUATE TRUE                                                12040004
120500         WHEN SQLCODE = ZERO                                      12050004
120600         WHEN SQLCODE = +100                                      12060004
120700              CONTINUE                                            12070004
120800         WHEN OTHER                                               12080004
120900              MOVE '7110-FETCH-GMM-CSR'                           12090004
121000                                 TO PV-ABEND-PARAGRAPH            12100004
121100              MOVE PE-MSG-04     TO PV-DB2-OPERATION-ATTEMPTED    12110004
121200              PERFORM 9200-SQL-ABEND                              12120004
121300     END-EVALUATE.                                                12130004
121400*                                                                 12140004
121500*                                                                 12150004
121600******************************************************************12160004
121700*  CLOSE THE GMM_CSR                                              12170004
121800******************************************************************12180004
121900 7120-CLOSE-GMM-CSR.                                              12190004
122000     EXEC SQL                                                     12200004
122100          CLOSE GMM_CSR                                           12210004
122200     END-EXEC.                                                    12220004
122300*                                                                 12230004
122400     EVALUATE TRUE                                                12240004
122500         WHEN SQLCODE = ZERO                                      12250004
122600              CONTINUE                                            12260004
122700         WHEN OTHER                                               12270004
122800              MOVE '7120-CLOSE-GMM-CSR'                           12280004
122900                                 TO PV-ABEND-PARAGRAPH            12290004
123000              MOVE PE-MSG-05     TO PV-DB2-OPERATION-ATTEMPTED    12300004
123100              PERFORM 9200-SQL-ABEND                              12310004
123200     END-EVALUATE.                                                12320004
123300*                                                                 12330004
123400*                                                                 12340004
123500******************************************************************12350004
123600*  OPEN THE DMM_CSR                                               12360004
123700******************************************************************12370004
123800 7200-OPEN-DMM-CSR.                                               12380004
123900     EXEC SQL                                                     12390004
124000          OPEN DMM_CSR                                            12400004
124100     END-EXEC.                                                    12410004
124200*                                                                 12420004
124300     EVALUATE TRUE                                                12430004
124400         WHEN SQLCODE = ZERO                                      12440004
124500              CONTINUE                                            12450004
124600         WHEN OTHER                                               12460004
124700              MOVE '7200-OPEN-DMM-CSR'                            12470004
124800                                 TO PV-ABEND-PARAGRAPH            12480004
124900              MOVE PE-MSG-06     TO PV-DB2-OPERATION-ATTEMPTED    12490004
125000              PERFORM 9200-SQL-ABEND                              12500004
125100     END-EVALUATE.                                                12510004
125200*                                                                 12520004
125300*                                                                 12530004
125400******************************************************************12540004
125500*  FETCH THE NEXT DEPT/CLASS COMBINATION USING THE DMM_CSR        12550004
125600******************************************************************12560004
125700 7210-FETCH-DMM-CSR.                                              12570004
125800     EXEC SQL                                                     12580004
125900          FETCH DMM_CSR                                           12590004
126000           INTO :MDSEAR-GMA-NBR,                                  12600004
126100                :MDSEAR-DMA-NBR,                                  12610004
126200                :MDSEAR-DEPT-NBR,                                 12620004
126300                :MDSEAR-MAJ-CL-NBR,                               12630004
126400                :MDSEAR-SUB-CL-NBR,                               12640004
126500                :MDSEAR-BYR-NBR,                                  12650004
126600                :MDSEAR-MDSELV-CDE,                               12660004
126700                :MDSEAR-DESC,                                     12670004
126800                :MDSEAR-DKEY                                      12680004
126900     END-EXEC.                                                    12690004
127000*                                                                 12700004
127100     EVALUATE TRUE                                                12710004
127200         WHEN SQLCODE = ZERO                                      12720004
127300         WHEN SQLCODE = +100                                      12730004
127400              CONTINUE                                            12740004
127500         WHEN OTHER                                               12750004
127600              MOVE '7210-FETCH-DMM-CSR'                           12760004
127700                                 TO PV-ABEND-PARAGRAPH            12770004
127800              MOVE PE-MSG-07     TO PV-DB2-OPERATION-ATTEMPTED    12780004
127900              PERFORM 9200-SQL-ABEND                              12790004
128000     END-EVALUATE.                                                12800004
128100*                                                                 12810004
128200*                                                                 12820004
128300******************************************************************12830004
128400*  CLOSE THE DMM_CSR                                              12840004
128500******************************************************************12850004
128600 7220-CLOSE-DMM-CSR.                                              12860004
128700     EXEC SQL                                                     12870004
128800          CLOSE DMM_CSR                                           12880004
128900     END-EXEC.                                                    12890004
129000*                                                                 12900004
129100     EVALUATE TRUE                                                12910004
129200         WHEN SQLCODE = ZERO                                      12920004
129300              CONTINUE                                            12930004
129400         WHEN OTHER                                               12940004
129500              MOVE '7220-CLOSE-DMM-CSR'                           12950004
129600                                 TO PV-ABEND-PARAGRAPH            12960004
129700              MOVE PE-MSG-08     TO PV-DB2-OPERATION-ATTEMPTED    12970004
129800              PERFORM 9200-SQL-ABEND                              12980004
129900     END-EVALUATE.                                                12990004
130000*                                                                 13000004
130100*                                                                 13010004
130200******************************************************************13020004
130300*  OPEN THE BYR_CSR                                               13030004
130400******************************************************************13040004
130500 7300-OPEN-BYR-CSR.                                               13050004
130600     EXEC SQL                                                     13060004
130700          OPEN BYR_CSR                                            13070004
130800     END-EXEC.                                                    13080004
130900*                                                                 13090004
131000     EVALUATE TRUE                                                13100004
131100         WHEN SQLCODE = ZERO                                      13110004
131200              CONTINUE                                            13120004
131300         WHEN OTHER                                               13130004
131400              MOVE '7300-OPEN-BYR-CSR'                            13140004
131500                                 TO PV-ABEND-PARAGRAPH            13150004
131600              MOVE PE-MSG-09     TO PV-DB2-OPERATION-ATTEMPTED    13160004
131700              PERFORM 9200-SQL-ABEND                              13170004
131800     END-EVALUATE.                                                13180004
131900*                                                                 13190004
132000*                                                                 13200004
132100******************************************************************13210004
132200*  FETCH THE NEXT DEPT/CLASS COMBINATION USING THE BYR_CSR        13220004
132300******************************************************************13230004
132400 7310-FETCH-BYR-CSR.                                              13240004
132500     EXEC SQL                                                     13250004
132600          FETCH BYR_CSR                                           13260004
132700           INTO :MDSEAR-GMA-NBR,                                  13270004
132800                :MDSEAR-DMA-NBR,                                  13280004
132900                :MDSEAR-DEPT-NBR,                                 13290004
133000                :MDSEAR-MAJ-CL-NBR,                               13300004
133100                :MDSEAR-SUB-CL-NBR,                               13310004
133200                :MDSEAR-BYR-NBR,                                  13320004
133300                :MDSEAR-MDSELV-CDE,                               13330004
133400                :MDSEAR-DESC,                                     13340004
133500                :MDSEAR-DKEY                                      13350004
133600     END-EXEC.                                                    13360004
133700*                                                                 13370004
133800     EVALUATE TRUE                                                13380004
133900         WHEN SQLCODE = ZERO                                      13390004
134000         WHEN SQLCODE = +100                                      13400004
134100              CONTINUE                                            13410004
134200         WHEN OTHER                                               13420004
134300              MOVE '7310-FETCH-BYR-CSR'                           13430004
134400                                 TO PV-ABEND-PARAGRAPH            13440004
134500              MOVE PE-MSG-10     TO PV-DB2-OPERATION-ATTEMPTED    13450004
134600              PERFORM 9200-SQL-ABEND                              13460004
134700     END-EVALUATE.                                                13470004
134800*                                                                 13480004
134900*                                                                 13490004
135000******************************************************************13500004
135100*  CLOSE THE BYR_CSR                                              13510004
135200******************************************************************13520004
135300 7320-CLOSE-BYR-CSR.                                              13530004
135400     EXEC SQL                                                     13540004
135500          CLOSE BYR_CSR                                           13550004
135600     END-EXEC.                                                    13560004
135700*                                                                 13570004
135800     EVALUATE TRUE                                                13580004
135900         WHEN SQLCODE = ZERO                                      13590004
136000              CONTINUE                                            13600004
136100         WHEN OTHER                                               13610004
136200              MOVE '7320-CLOSE-BYR-CSR'                           13620004
136300                                 TO PV-ABEND-PARAGRAPH            13630004
136400              MOVE PE-MSG-11     TO PV-DB2-OPERATION-ATTEMPTED    13640004
136500              PERFORM 9200-SQL-ABEND                              13650004
136600     END-EVALUATE.                                                13660004
136700*                                                                 13670004
136800*                                                                 13680004
136900******************************************************************13690004
137000*  OPEN THE DPT_CSR                                               13700004
137100******************************************************************13710004
137200 7400-OPEN-DPT-CSR.                                               13720004
137300     EXEC SQL                                                     13730004
137400          OPEN DPT_CSR                                            13740004
137500     END-EXEC.                                                    13750004
137600*                                                                 13760004
137700     EVALUATE TRUE                                                13770004
137800         WHEN SQLCODE = ZERO                                      13780004
137900              CONTINUE                                            13790004
138000         WHEN OTHER                                               13800004
138100              MOVE '7400-OPEN-DPT-CSR'                            13810004
138200                                 TO PV-ABEND-PARAGRAPH            13820004
138300              MOVE PE-MSG-12     TO PV-DB2-OPERATION-ATTEMPTED    13830004
138400              PERFORM 9200-SQL-ABEND                              13840004
138500     END-EVALUATE.                                                13850004
138600*                                                                 13860004
138700*                                                                 13870004
138800******************************************************************13880004
138900*  FETCH THE NEXT DEPT/CLASS COMBINATION USING THE DPT_CSR        13890004
139000******************************************************************13900004
139100 7410-FETCH-DPT-CSR.                                              13910004
139200     EXEC SQL                                                     13920004
139300          FETCH DPT_CSR                                           13930004
139400           INTO :MDSEAR-GMA-NBR,                                  13940004
139500                :MDSEAR-DMA-NBR,                                  13950004
139600                :MDSEAR-DEPT-NBR,                                 13960004
139700                :MDSEAR-MAJ-CL-NBR,                               13970004
139800                :MDSEAR-SUB-CL-NBR,                               13980004
139900                :MDSEAR-BYR-NBR,                                  13990004
140000                :MDSEAR-MDSELV-CDE,                               14000004
140100                :MDSEAR-DESC,                                     14010004
140200                :MDSEAR-DKEY                                      14020004
140300     END-EXEC.                                                    14030004
140400*                                                                 14040004
140500     EVALUATE TRUE                                                14050004
140600         WHEN SQLCODE = ZERO                                      14060004
140700         WHEN SQLCODE = +100                                      14070004
140800              CONTINUE                                            14080004
140900         WHEN OTHER                                               14090004
141000              MOVE '7410-FETCH-DPT-CSR'                           14100004
141100                                 TO PV-ABEND-PARAGRAPH            14110004
141200              MOVE PE-MSG-13     TO PV-DB2-OPERATION-ATTEMPTED    14120004
141300              PERFORM 9200-SQL-ABEND                              14130004
141400     END-EVALUATE.                                                14140004
141500*                                                                 14150004
141600*                                                                 14160004
141700******************************************************************14170004
141800*  CLOSE THE DPT_CSR                                              14180004
141900******************************************************************14190004
142000 7420-CLOSE-DPT-CSR.                                              14200004
142100     EXEC SQL                                                     14210004
142200          CLOSE DPT_CSR                                           14220004
142300     END-EXEC.                                                    14230004
142400*                                                                 14240004
142500     EVALUATE TRUE                                                14250004
142600         WHEN SQLCODE = ZERO                                      14260004
142700              CONTINUE                                            14270004
142800         WHEN OTHER                                               14280004
142900              MOVE '7420-CLOSE-DPT-CSR'                           14290004
143000                                 TO PV-ABEND-PARAGRAPH            14300004
143100              MOVE PE-MSG-14     TO PV-DB2-OPERATION-ATTEMPTED    14310004
143200              PERFORM 9200-SQL-ABEND                              14320004
143300     END-EVALUATE.                                                14330004
143400*                                                                 14340004
143500*                                                                 14350004
143600******************************************************************14360004
143700*    READ THE CONTROL CARD FILE.                                  14370004
143800******************************************************************14380004
143900 8000-READ-CONTROL-CARD.                                          14390004
144000     READ CONTROL-CARD-FILE-IN                                    14400004
144100       INTO CC-CONTROL-CARD                                       14410004
144200         AT END SET PS-CONTROL-CARD-EOF TO TRUE.                  14420004
144300*                                                                 14430004
144400*                                                                 14440004
144500******************************************************************14450004
144600*  CLOSE ONE FILES ASSOCIATED WITH THE PROGRAM.                   14460004
144700******************************************************************14470004
144800 9000-EOJ-ROUTINE.                                                14480004
144900     CLOSE CONTROL-CARD-FILE-IN                                   14490004
145000           MBS-STRUCTURE-FILE-OUT.                                14500004
145100                                                                  14510004
145200     DISPLAY ' '.                                                 14520004
145300     DISPLAY 'CONTROL CARDS PROCESSED -- ' PV-CC-INPUT-CNT.       14530004
145400     DISPLAY 'CONTROL CARDS VALID ------ ' PV-CC-MBS-VALID-CNT.   14540004
145500     DISPLAY 'CONTROL CARDS INVALID ---- ' PV-CC-MBS-INVALID-CNT. 14550004
145600                                                                  14560004
145700     IF  PV-CC-MBS-VALID-CNT = ZERO                               14570004
145800         DISPLAY ' '                                              14580004
145900         DISPLAY '** ABEND **'                                    14590004
146000         DISPLAY '** PROGRAM   = ' PC-CURRENT-PROGRAM-NAME        14600004
146100         DISPLAY '** PARAGRAPH = 9000-EOJ-ROUTINE'                14610004
146200         DISPLAY '** NO CONTROL CARDS WERE VALIDLY PROCESSED'     14620004
146300         MOVE +4003              TO PV-ABEND-CODE                 14630004
146400         CALL 'ILBOABN0' USING PV-ABEND-CODE                      14640004
146500     END-IF.                                                      14650004
146600*                                                                 14660004
146700*                                                                 14670004
146800******************************************************************14680004
146900*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    14690004
147000*  ERROR OR WARNING CODE OCCURS.                                  14700004
147100******************************************************************14710004
147200 9200-SQL-ABEND.                                                  14720004
147300     DISPLAY '9200-SQL-ABEND'.                                    14730004
147400     DISPLAY '** ABEND     **'.                                   14740004
147500     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        14750004
147600     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.             14760004
147700     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     14770004
147800*                                                                 14780004
147900*                                                                 14790004
148000******************************************************************14800004
148100* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    14810004
148200* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         14820004
148300* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     14830004
148400* FORMAT.                                                         14840004
148500******************************************************************14850004
148600     COPY DPPD004.                                                14860004
148700                                                                  14870004
148800     IF  SQLCODE NOT = -911                                       14880004
148900         EXEC SQL                                                 14890004
149000              COMMIT                                              14900004
149100         END-EXEC                                                 14910004
149200     END-IF.                                                      14920004
149300                                                                  14930004
149400     MOVE +4013                  TO PV-ABEND-CODE.                14940004
149500     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         14950004
