000110******************************************************************00011001
000120 IDENTIFICATION DIVISION.                                         00012001
000130******************************************************************00013001
000140                                                                  00014001
000150 PROGRAM-ID.    SUKUT128.                                         00015099
000160 AUTHOR.        PAUL JORGENSEN.                                   00016068
000170 INSTALLATION.  KOHLS.                                            00017001
000180 DATE-WRITTEN   FEBRUARY, 2009.                                   00018099
000190 DATE-COMPILED.                                                   00019001
000191                                                                  00019101
000192******************************************************************00019201
000193*  THIS PROGRAM WILL PURGE OUTBOUND TRIP DATA FROM THE            00019399
000194*  TSUOBTR TABLE.                                                 00019499
000196******************************************************************00019602
000197******************************************************************00019702
000198 ENVIRONMENT DIVISION.                                            00019802
000199******************************************************************00019902
000200 CONFIGURATION SECTION.                                           00020015
000201                                                                  00020115
000203 SOURCE-COMPUTER.        IBM-3090.                                00020315
000204 OBJECT-COMPUTER.        IBM-3090.                                00020415
000205                                                                  00020515
000206 INPUT-OUTPUT SECTION.                                            00020615
000207                                                                  00020715
000208 FILE-CONTROL.                                                    00020815
000209*                                                                 00020915
000210     SELECT PURGE-FILE                                            00021099
000211         ASSIGN TO INP01.                                         00021115
000215                                                                  00021515
000216*                                                                 00021615
000218******************************************************************00021802
000219 DATA DIVISION.                                                   00021902
000220******************************************************************00022002
000221*                                                                 00022102
000222 FILE SECTION.                                                    00022215
000223*                                                                 00022315
000231 FD  PURGE-FILE                                                   00023199
000232     RECORDING MODE IS F                                          00023215
000233     RECORD CONTAINS 20 CHARACTERS                                00023399
000234     LABEL RECORDS ARE OMITTED                                    00023415
000235     DATA RECORD IS PURGE-RECORD.                                 00023599
000236 01  PURGE-RECORD                   PIC X(20).                    00023699
000237*                                                                 00023715
000238******************************************************************00024502
000239 WORKING-STORAGE SECTION.                                         00024602
000240******************************************************************00024702
000241*                                                                 00024802
000242******************************************************************00024902
000243*  DB2 FORMATTED MESSAGE AREA                                     00025002
000244******************************************************************00025102
000245     COPY DPWS004.                                                00025202
000246                                                                  00025302
011610*----------------------------------------------------------------*00025499
011620*  DCLGEN LAYOUT FOR THE OUTBOUND TRIP STATUS TABLE              *00025599
011630*----------------------------------------------------------------*00025699
011640     EXEC SQL                                                     00025799
011650         INCLUDE TSUOBTR                                          00025899
011660     END-EXEC.                                                    00025999
000247******************************************************************00026002
000248*    COMMUNICATIONS AREA FOR DB2                                  00026102
000249******************************************************************00026202
000250                                                                  00026302
000251     EXEC SQL                                                     00026402
000252          INCLUDE SQLCA                                           00026502
000253     END-EXEC.                                                    00026602
000254                                                                  00026702
000255******************************************************************00026802
000256*                                                                 00026902
000257 01  ABEND-CODE                      PIC S9(04)    VALUE +0.      00027099
000259                                                                  00027102
000260 01  PS-PROGRAM-SWITCHES.                                         00027202
000261     05  PS-COMMIT-SW                PIC X(03)     VALUE 'N'.     00027399
000262         88  PS-COMMIT-YES                         VALUE 'Y'.     00027499
000262         88  PS-COMMIT-NO                          VALUE 'N'.     00027599
000263     05  PS-FIRST-TIME-SW            PIC X(01)     VALUE 'N'.     00027699
000264         88  PS-FIRST-TIME-YES                     VALUE 'Y'.     00027799
000265         88  PS-FIRST-TIME-NO                      VALUE 'N'.     00027899
000269     05  PS-EOF-PROCESS-SW           PIC  X(01)    VALUE 'N'.     00027999
000270         88  PS-EOF-PROCESS-YES                    VALUE 'Y'.     00028099
000271         88  PS-EOF-PROCESS-NO                     VALUE 'N'.     00028199
000281                                                                  00028220
000282                                                                  00028320
000283 01  PC-PROGRAM-CONSTANTS.                                        00028420
000284     05  PC-ROW-NOT-FOUND            PIC S9(04)    VALUE +100     00028520
000285                                                   COMP SYNC.     00028620
000286     05  PC-PROGRAM-NAME             PIC  X(08)    VALUE          00028723
000287         'SUKUT128'.                                              00028899
000290     05  PC-MAX-RETRIES              PIC S9(04)    VALUE +3       00029020
000291                                                   COMP SYNC.     00029120
000293                                                                  00029320
000294 01  PV-PROGRAM-VARIABLES.                                        00029420
000292     05  PV-DELETE-TMST              PIC  X(26)    VALUE SPACES.  00029599
000295     05  PV-SQL-RETURN-CD            PIC 999-.                    00029620
000296     05  PV-CICS-MSG-AREA            PIC  X(80)    VALUE SPACES.  00029720
000297     05  PV-COMMAREA-LENGTH          PIC S9(04)    VALUE +0       00029820
000298                                                   COMP SYNC.     00029920
000299     05  PV-CICS-RESPONSE            PIC S9(9)     VALUE ZERO     00030020
000300                                                   COMP SYNC.     00030120
000301                                                                  00030220
000306     05  PV-OTBND-TRIP-ID-MSG.                                    00030399
               10  FILLER                  PIC  X(13)    VALUE          00030499
               'OTBND TRIP = '.                                         00030599
000306         10  PV-OTBND-TRIP-ID        PIC  9(15).                  00030699
000312     05  PV-DONE-PROCESSING-SW       PIC  X(01)    VALUE 'N'.     00031520
000313         88  PV-DONE-PROCESSING                    VALUE 'Y'.     00031620
000315     05  PV-ABEND-PARAGRAPH          PIC  X(30)    VALUE SPACE.   00031720
000316     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  00031820
000317     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  00031920
000318                                                                  00032020
000319     05  PV-ABEND-CODE               PIC S9(04)    VALUE ZERO     00032120
000320                                                   COMP SYNC.     00032220
000321     05  PV-ABEND-PARA-NAME          PIC X(30)     VALUE SPACES.  00032320
000322     05  PV-DB2-OPERATION-MSG-1      PIC X(40)     VALUE SPACES.  00032420
000323     05  PV-DB2-OPERATION-MSG-2      PIC X(40)     VALUE SPACES.  00032520
000323     05  PV-DB2-OPERATION-MSG-3      PIC X(40)     VALUE SPACES.  00032699
000324     05  PV-DB2-TABLE-NAME           PIC X(17)     VALUE SPACES.  00032799
000325     05  PV-SQLCODE                  PIC Z(8)9-.                  00032899
014600     05  PV-RETRY-COUNTER            PIC S9(04)    VALUE ZERO     00032999
014700                                                   COMP SYNC.     00033099
000327                                                                  00034020
000344     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             00034547
000345                                                                  00034647
000348     05  PV-RECORDS-READ             PIC S9(07)    COMP-3         00034991
000349                                                   VALUE ZEROS.   00035047
000350     05  PV-ROWS-DELETED             PIC S9(07)    COMP-3         00035399
 00351                                                   VALUE ZEROS.   00035499
000361 01  SD-SYSTEM-DATE.                                              00036247
000362     05  SD-SYSTEM-DATE-YY           PIC  9(02)      VALUE ZERO.  00036347
000363     05  SD-SYSTEM-DATE-MM           PIC  9(02)      VALUE ZERO.  00036447
000364     05  SD-SYSTEM-DATE-DD           PIC  9(02)      VALUE ZERO.  00036547
000365                                                                  00036647
000366 01  ST-SYSTEM-TIME.                                              00036747
000367     05  ST-SYSTEM-HOUR             PIC  9(02)      VALUE ZERO.   00036847
000368     05  ST-SYSTEM-MINUTE           PIC  9(02)      VALUE ZERO.   00036947
000369     05  FILLER                     PIC  9(04)      VALUE ZERO.   00037047
000370                                                                  00037147
000371******************************************************************00037247
000372*    ABEND PROCESSING COPYBOOK.                                   00037347
000373******************************************************************00037447
000374                                                                  00037547
000375     COPY DPWS013.                                                00037647
000376                                                                  00037747
000378******************************************************************00037947
000379*    INPUT RECORD LAYOUT.                                         00038099
000380******************************************************************00038147
000382     COPY SURD054.                                                00038399
000383                                                                  00038447
000449******************************************************************00047727
000450 PROCEDURE DIVISION.                                              00047827
000451******************************************************************00047927
000452*                                                                 00048027
000453******************************************************************00048127
000454* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     00048227
000455*      PROGRAM.                                                   00048327
000456******************************************************************00048427
000457 0000-PROGRAM-MAINLINE.                                           00048527
000458*                                                                 00048627
000459     DISPLAY '*** START OF SUKUT128 - TSUOBTR PURGE ***'.         00048799
000460     DISPLAY ' '.                                                 00048827
000461                                                                  00048927
000462      PERFORM 1000-INITIALIZE                                     00049027
000463      PERFORM 2000-MAIN-PROCESS                                   00049127
000464              UNTIL PS-EOF-PROCESS-YES                            00049299
000465      PERFORM 9000-END-PROCESS.                                   00049327
000466*                                                                 00049427
000467     STOP RUN.                                                    00049527
000468*                                                                 00049627
000469******************************************************************00049727
000470*  DO FIRST TIME PROGRAM INITIALIZATION TASKS.                    00049827
000471*    -- OPEN FILES                                                00049927
000472******************************************************************00050027
000473 1000-INITIALIZE.                                                 00050127
000474                                                                  00050227
000476     OPEN INPUT  PURGE-FILE.                                      00050499
000480                                                                  00050999
000481*READ FIRST INPUT RECORD.                                         00051099
000482     PERFORM 7000-READ-PURGE-FILE.                                00051199
000485*                                                                 00051399
000489 2000-MAIN-PROCESS.                                               00051499
           PERFORM 5000-DELETE-OTBND-TRIP-STATUS                        00062999
                                                                        00064099
000533     PERFORM 7000-READ-PURGE-FILE.                                00065099
                                                                        00065899
040300 5000-DELETE-OTBND-TRIP-STATUS.                                   00084499
040600                                                                  00084599
036700     EXEC SQL                                                     00084699
000448     DELETE                                                       00084799
000448       FROM TSUOBTR                                               00085199
            WHERE OTBND_TRIP_ID =  :SU054-OTBND-TRIP-ID                 00085299
036900     END-EXEC                                                     00085499
037000                                                                  00085699
           EVALUATE TRUE                                                00085799
037110     WHEN SQLCODE = +0                                            00085899
037400         ADD SQLERRD(3)           TO PV-ROWS-DELETED              00085999
               PERFORM 5100-COMMIT                                      00086099
037110     WHEN SQLCODE = +100                                          00086199
               CONTINUE                                                 00086299
000609     WHEN OTHER                                                   00086399
000610         MOVE '5000-DELETE-OTBND-TRIP-STATUS'                     00086499
                                        TO PV-ABEND-PARA-NAME           00086599
               MOVE SU054-OTBND-TRIP-ID TO PV-OTBND-TRIP-ID             00086699
000612         MOVE PV-OTBND-TRIP-ID-MSG                                00086799
000612                                  TO PV-DB2-OPERATION-MSG-1       00086899
000613         MOVE 'TSUOBTR'           TO PV-DB2-TABLE-NAME            00087099
000614         PERFORM 9998-SQL-ABEND                                   00087199
038600     END-EVALUATE.                                                00087299
                                                                        00087399
036300 5100-COMMIT.                                                     00087499
036400                                                                  00087599
036500     EXEC SQL                                                     00087699
036600          COMMIT                                                  00087799
036700     END-EXEC                                                     00087899
036800                                                                  00087999
037000     IF SQLCODE = ZERO                                            00088099
037400         CONTINUE                                                 00088199
000609     ELSE                                                         00088299
               MOVE '5100-COMMIT'       TO PV-ABEND-PARA-NAME           00088399
               MOVE SU054-OTBND-TRIP-ID TO PV-OTBND-TRIP-ID             00088799
000612         MOVE PV-OTBND-TRIP-ID-MSG                                00088899
000612                                  TO PV-DB2-OPERATION-MSG-1       00088999
000613         MOVE 'TSUOBTR'           TO PV-DB2-TABLE-NAME            00089199
000614         PERFORM 9998-SQL-ABEND                                   00089399
038600     END-IF.                                                      00089499
000696*                                                                 00089599
000697 7000-READ-PURGE-FILE.                                            00089699
000698******************************************************************00089799
000702     READ PURGE-FILE INTO SU054-EXTRACT-RECORD                    00089899
000703        AT END                                                    00089999
000704           SET PS-EOF-PROCESS-YES TO TRUE                         00090099
000705        NOT AT END                                                00090199
000708            ADD  +1               TO PV-RECORDS-READ              00090299
000709     END-READ.                                                    00090399
000710*                                                                 00090499
000728                                                                  00090599
000738******************************************************************00090699
000739*     CLOSE FILES.                                              **00090799
000740******************************************************************00090899
000741 9000-END-PROCESS.                                                00090999
000742*                                                                 00091099
000744     CLOSE PURGE-FILE.                                            00091199
000745*                                                                 00091299
           PERFORM 9999-FINAL-DISPLAYS.                                 00091399
000751*                                                                 00091699
000752******************************************************************00091799
000753*     SQL ERROR PROCESSING                                      **00091899
000754******************************************************************00091999
000755 9998-SQL-ABEND.                                                  00092099
           PERFORM 9999-FINAL-DISPLAYS.                                 00092199
000756     MOVE SQLCODE     TO PV-SQLCODE.                              00092299
000757     DISPLAY '** ABEND           ** = SQLABEND'.                  00092399
000758     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          00092499
000759     DISPLAY '** PARAGRAPH       ** = ' PV-ABEND-PARA-NAME        00092599
000760     DISPLAY '** TABLE AFFECTED  ** = ' PV-DB2-TABLE-NAME.        00092699
000761     DISPLAY '** OPERATIONAL MSG ** = ' PV-DB2-OPERATION-MSG-1.   00092799
000762     DISPLAY '** OPERATIONAL MSG ** = ' PV-DB2-OPERATION-MSG-2.   00092899
000763     DISPLAY '** SQLCODE         ** = ' PV-SQLCODE.               00093099
000764     COPY DPPD004.                                                00093199
000765                                                                  00093299
000766     MOVE +4013                  TO PV-ABEND-CODE.                00093399
000767     CALL 'ILBOABN0'   USING PV-ABEND-CODE.                       00093499
000768*                                                                 00094015
       9999-FINAL-DISPLAYS.                                             00095099
000746     DISPLAY '**********************************'.                00097099
000747     DISPLAY '** SUKUT128 SUMMARY **'.                            00098099
           MOVE PV-RECORDS-READ       TO PV-DISPLAY-COUNT               00099099
000748     DISPLAY 'TOTAL INPUT RECORDS         = ' PV-DISPLAY-COUNT.   00099199
           MOVE PV-ROWS-DELETED       TO PV-DISPLAY-COUNT               00099499
000748     DISPLAY 'TOTAL TSUOBTR ROWS DELETED  = ' PV-DISPLAY-COUNT.   00099599
000750     DISPLAY '**********************************'.                00099699
000770                                                                  00100013
