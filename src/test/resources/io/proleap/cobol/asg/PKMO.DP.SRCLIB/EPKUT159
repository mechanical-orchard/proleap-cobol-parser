000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.      EPKUT159.                                       00020000
000300 AUTHOR.          SANDY POTTER.                                   00030000
000400 DATE-WRITTEN.    APRIL 7,2005.                                   00040000
000500                                                                  00050000
000600*-----------------------------------------------------------      00060000
000700*         EXTRACT PLU FULL REFRESH STORE SPECIFIC PRICE DATA      00070000
000800*-----------------------------------------------------------      00080000
000900*  THIS PROGRAM EXTRACTS STORE SPECIFIC PRICING DATA FOR          00090000
001000*  REQUESTED STORE NUMBERS. ALL GLOBAL DATA AND RETURN PRICING    00100000
001100*  DATA FOR THE REQUESTED STORES IS EXTRACTED IN EPKUT158.        00110000
001200*  STORE SPECIFIC PRICING DATA WAS SEPERATED OUT TO ALLOW FOR     00120000
001300*  PARALLEL PROCESSING.                                           00130000
001400*                                                                 00140000
001500*  THESE PRICES WILL OVERRIDE THE GLOBAL PRICE.                   00150000
001600*  THOUGH IT IS PART OF THE FULL FILE PROCESS, THE RECORDS IT     00160000
001700*  CREATES ARE REALLY CHANGE RECORDS.                             00170000
001800*                                                                 00180000
001900*  THIS PROGRAM USES THREE CONTROL CARDS.                         00190000
002000*  ONE CONTROL CARD HAS TOMORROW'S DATE, ONE HAS TODAYS           00200000
002100*  DATE AND THE OTHER ONE HAS THE NUMBER OF DAYS IN ADVANCE       00210000
002200*  OF OPENING BEFORE A NEW STORE SHOULD BE ADDED TO THE           00220000
002300*  DISTRIBUTION LISTS.  THE PROGRAM WILL SAVE THE DATES AND       00230000
002400*  USE THE DAYS IN ADVANCE NUMBER BY ADDING ON TO TODAYS          00240000
002500*  DATE BY CALLING THE CALENDAR ROUTINE.  THIS PROGRAM            00250000
002600*  WILL THEN EXECUTE A REFRESH CURSOR TO PULL ALL THE STORES      00260000
002700*  THAT NEED FULL FILE REFRESHES.                                 00270000
002800*-----------------------------------------------------------      00280000
002900* HISTORY LOG:                                                    00290000
003000*-----------------------------------------------------------      00300000
003100* DATE:  APRIL 2009                                               00310000
003200* WR/IR#: WR35484                                                 00320000
003300* PROGRAMMER: CHUCK HERO                                          00330000
003400* DESCRIPTION: ADD SKU PRICING LAYOUT OUTPUT FILE FOR             00340000
003500*              NEW SQL SERVER STORE PRICING DATABASE              00350000
003600*                                                                 00360000
003700*-----------------------------------------------------------      00370000
003800* DATE:  AUG 03 2009                                              00380000
003900* WR/IR#: CR20162/INC#890237                                      00390000
004000* PROGRAMMER: MEDHA CHOUDHURY                                     00400000
004100* DESCRIPTION: MODIFIED THE POPULATION OF LAST-UPDATE-TMST        00410000
004200*             COMPARE THE UNT-RTL-CGH-DTE WITH UPC-STAT-CHG-DTE   00420000
004300*             MOVE THE LATEST DATE TO THE LAST-UPDATE-TMST        00430000
004400* CHANGES WILL AFFECT ONLY SQL FILES                              00440000
004500*----------------------------------------------------------       00450000
004600 ENVIRONMENT DIVISION.                                            00460000
004700*----------------------------------------------------------       00470000
004800 CONFIGURATION SECTION.                                           00480000
004900 SOURCE-COMPUTER.        IBM-3090.                                00490000
005000 OBJECT-COMPUTER.        IBM-3090.                                00500000
005100                                                                  00510000
005200 INPUT-OUTPUT SECTION.                                            00520000
005300                                                                  00530000
005400 FILE-CONTROL.                                                    00540000
005500                                                                  00550000
005600     SELECT CONTROL-CARD-1                                        00560000
005700            ASSIGN TO INP01.                                      00570000
005800     SELECT CONTROL-CARD-2                                        00580000
005900            ASSIGN TO INP02.                                      00590000
006000     SELECT CONTROL-CARD-3                                        00600000
006100            ASSIGN TO INP03.                                      00610000
006200     SELECT FULL-SKU-PRICING-STORE-FILE                           00620000
006300            ASSIGN TO OUT01.                                      00630011
006400                                                                  00640000
006500 DATA DIVISION.                                                   00650001
006600 FILE SECTION.                                                    00660001
006700                                                                  00670001
006800 FD  CONTROL-CARD-1                                               00680001
006900     RECORDING MODE F                                             00690001
007000     BLOCK CONTAINS 0 RECORDS                                     00700001
007100     LABEL RECORDS ARE OMITTED                                    00710001
007200     DATA RECORD IS CONTROL-CARD-1-RECORD.                        00720001
007300 01  CONTROL-CARD-1-RECORD           PIC X(80).                   00730001
007400                                                                  00740001
007500 FD  CONTROL-CARD-2                                               00750001
007600     RECORDING MODE F                                             00760001
007700     BLOCK CONTAINS 0 RECORDS                                     00770001
007800     LABEL RECORDS ARE OMITTED                                    00780001
007900     DATA RECORD IS CONTROL-CARD-2-RECORD.                        00790001
008000 01  CONTROL-CARD-2-RECORD           PIC X(80).                   00800001
008100                                                                  00810001
008200 FD  CONTROL-CARD-3                                               00820001
008300     RECORDING MODE F                                             00830001
008400     BLOCK CONTAINS 0 RECORDS                                     00840001
008500     LABEL RECORDS ARE OMITTED                                    00850001
008600     DATA RECORD IS CONTROL-CARD-3-RECORD.                        00860001
008700 01  CONTROL-CARD-3-RECORD           PIC X(80).                   00870001
008800                                                                  00880001
008900 FD  FULL-SKU-PRICING-STORE-FILE                                  00890001
009000     RECORDING MODE F                                             00900001
009100     BLOCK CONTAINS 0 RECORDS                                     00910001
009200     LABEL RECORDS ARE OMITTED                                    00920001
009300     DATA RECORD IS FULL-SKU-PRICING-STORE-RECORD.                00930001
009400 01  FULL-SKU-PRICING-STORE-RECORD   PIC X(260).                  00940001
009500                                                                  00950001
009600 WORKING-STORAGE SECTION.                                         00960000
009700*-----------------------------------------------------------      00970000
009800* PS- PROGRAM SWITCHES                                            00980000
009900*-----------------------------------------------------------      00990000
010000 01  PS-PROGRAM-SWITCHES.                                         01000000
010100     05  PS-REFRESH-CSR-SW              PIC X(01) VALUE 'N'.      01010000
010200         88  PS-END-OF-REFRESH-CSR                VALUE 'Y'.      01020000
010300         88  PS-MORE-REFRESH-CSR                  VALUE 'N'.      01030000
010400     05  PS-SKU-STR-CSR-SW              PIC X(01) VALUE 'N'.      01040000
010500         88  PS-END-OF-SKU-STR-CSR                VALUE 'Y'.      01050000
010600         88  PS-MORE-SKU-STR-CSR                  VALUE 'N'.      01060000
010700     05  PS-DATE-ROUTINE-SW             PIC X(01) VALUE 'N'.      01070000
010800         88  PS-DATE-FOUND                        VALUE 'Y'.      01080000
010900         88  PS-DATE-NOT-FOUND                    VALUE 'N'.      01090000
011000                                                                  01100000
011100*-----------------------------------------------------------      01110000
011200* PC- PROGRAM CONSTANTS                                           01120000
011300*-----------------------------------------------------------      01130000
011400 01  PC-PROGRAM-CONSTANTS.                                        01140000
011500     05  PC-CURRENT-PROGRAM-NAME   PIC X(08)  VALUE 'EPKUT159'.   01150000
011600     05  PC-MAX-RETRIES            PIC S9(04) VALUE +5 COMP.      01160000
011700     05  PC-SQLS-START-TIME        PIC X(08)  VALUE '04:00:00'.   01170000
011800     05  PC-ACTIVE-STATUS          PIC X(02)  VALUE '20'.         01180001
011900     05  PC-MIXED-STATUS           PIC X(02)  VALUE '25'.         01190001
012000                                                                  01200001
012100     05  PC-PRIC-EFF-TIME-STD      PIC X(08)  VALUE '03:00:00'.   01210003
012200     05  PC-MDSE-HIER-SKU          PIC X(03)  VALUE 'SKU'.        01220001
012300     05  PC-NULL-CHAR              PIC X(01)  VALUE '~'.          01230001
012400                                                                  01240001
012500*-----------------------------------------------------------      01250001
012600* PV- PROGRAM VARIABLES                                           01260001
012700*-----------------------------------------------------------      01270001
012800 01  PV-PROGRAM-VARIABLES.                                        01280001
012900     05  PV-SQL-SUB                PIC S9(4)  VALUE +0 COMP.      01290001
013000     05  PV-DAYS-AHEAD             PIC 9(05)  VALUE 0.            01300001
013100     05  PV-SAVE-ADDED-DAYS        PIC X(05)  VALUE SPACES.       01310001
013200     05  PV-STRT-DTE               PIC X(10)  VALUE SPACES.       01320001
013300     05  PV-TODAY-DTE              PIC X(10)  VALUE SPACES.       01330001
013400     05  PV-NEW-OPEN-DATE          PIC X(10)  VALUE SPACES.       01340001
013500     05  PV-CONVERT-PRICE          PIC S9(07)V9(02) VALUE +0.     01350001
013600     05  PV-CONVERT-GP-PRIC-ID     PIC S9(11) VALUE +0 COMP.      01360001
013700     05  PV-GP-PRIC-ID-IND         PIC S9(4)  VALUE +0 COMP.      01370001
013800         88  PV-GP-PRIC-ID-NULL               VALUE -1.           01380001
013900     05  PV-GP-RTL-QTY-IND         PIC S9(4)  VALUE +0 COMP.      01390001
014000         88  PV-GP-RTL-QTY-NULL               VALUE -1.           01400001
014100     05  PV-GP-RTL-AMT-IND         PIC S9(4)  VALUE +0 COMP.      01410001
014200         88  PV-GP-RTL-AMT-NULL               VALUE -1.           01420001
014300                                                                  01430001
014400     05  PV-DISPLAY-FIELDS.                                       01440001
014500         10  PV-DISPLAY-STR-NBR    PIC  9(8)  VALUE  0.           01450001
014600                                                                  01460001
014700    05  PV-PRIC-EFF-TMST.                                         01470001
014800        10  PV-PRIC-EFF-DTE               PIC X(10).              01480001
014900        10  FILLER                        PIC X(01) VALUE SPACE.  01490001
015000        10  PV-PRIC-EFF-TIME              PIC X(08).              01500001
015100                                                                  01510001
015200    05  PV-LAST-PRCHG-TMST.                                       01520001
015300        10  PV-LAST-PRCHG-DTE             PIC X(10).              01530001
015400        10  FILLER                        PIC X(01) VALUE SPACE.  01540001
015500        10  PV-LAST-PRCHG-TIME            PIC X(08).              01550001
015600                                                                  01560001
015700    05  PV-PLU-STRT-TMST.                                         01570001
015800        10  PV-PLU-STRT-DTE.                                      01580001
015900            15  PV-PLU-STRT-DTE-CCYY      PIC X(04).              01590001
016000            15  FILLER                    PIC X(01).              01600001
016100            15  PV-PLU-STRT-DTE-MM        PIC X(02).              01610001
016200            15  FILLER                    PIC X(01).              01620001
016300            15  PV-PLU-STRT-DTE-DD        PIC X(02).              01630001
016400        10  FILLER                        PIC X(01) VALUE '-'.    01640001
016500        10  PV-PLU-STRT-TM.                                       01650001
016600            15  PV-PLU-STRT-TM-HH         PIC X(02).              01660001
016700            15  FILLER                    PIC X(01).              01670001
016800            15  PV-PLU-STRT-TM-MM         PIC X(02).              01680001
016900            15  FILLER                    PIC X(01).              01690001
017000            15  PV-PLU-STRT-TM-SS         PIC X(02).              01700001
017100            15  FILLER                    PIC X(01).              01710001
017200            15  PV-PLU-STRT-TM-MMSS       PIC X(06).              01720001
017300                                                                  01730001
017400                                                                  01740001
017500*----------------------------------------------------------       01750001
017600* SKU PRICING STORE FILE LAYOUT - OUTPUT                          01760001
017700*----------------------------------------------------------       01770001
017800     COPY EPRD220.                                                01780001
017900                                                                  01790001
018000*----------------------------------------------------------       01800001
018100* CONTROL CARD LAYOUT FOR TODAY'S DATE                            01810001
018200*----------------------------------------------------------       01820001
018300     COPY EPWS140.                                                01830001
018400                                                                  01840001
018500*----------------------------------------------------------       01850001
018600* CONTROL CARD LAYOUT FOR TOMORROW'S DATE                         01860001
018700*----------------------------------------------------------       01870001
018800     COPY EPWS112.                                                01880001
018900                                                                  01890001
019000*----------------------------------------------------------       01900001
019100* CONTROL CARD LAYOUT FOR DAYS TILL STORE OPEN                    01910001
019200*----------------------------------------------------------       01920001
019300     COPY EPRD045.                                                01930001
019400                                                                  01940001
019500*----------------------------------------------------------       01950001
019600*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             01960001
019700*----------------------------------------------------------       01970001
019800     COPY DPWS500.                                                01980001
019900                                                                  01990001
020000*-----------------------------------------------------------      02000001
020100* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         02010001
020200*-----------------------------------------------------------      02020001
020300     COPY DPWS004.                                                02030001
020400                                                                  02040001
020500*-----------------------------------------------------------      02050001
020600* DB2 ABEND COPYBOOK                                              02060001
020700*-----------------------------------------------------------      02070001
020800     COPY DPWS900.                                                02080001
020900                                                                  02090001
021000*-----------------------------------------------------------      02100001
021100* DB2 MESSAGE AREA                                                02110001
021200*-----------------------------------------------------------      02120001
021300     COPY SQLCA2.                                                 02130001
021400                                                                  02140001
021500*-----------------------------------------------------------      02150001
021600* PC- PROGRAM COUNTERS                                            02160001
021700*-----------------------------------------------------------      02170001
021800 01  PV-PROGRAM-COUNTERS.                                         02180001
021900     05  PV-CNT-REFRESH-CSR           PIC 9(09) VALUE 0.          02190001
022000     05  PV-CNT-SKU-STR-CSR           PIC 9(09) VALUE 0.          02200001
022100     05  PV-CNT-STORE-RECS            PIC 9(09) VALUE 0.          02210001
022200     05  PV-CNT-SKU-PRICG-STR-RECS    PIC 9(09) VALUE 0.          02220001
022300     05  PV-CNT-ALL-RECS              PIC 9(09) VALUE 0.          02230001
022400                                                                  02240001
022500*-----------------------------------------------------------      02250001
022600* ERROR HANDLING                                                  02260001
022700*-----------------------------------------------------------      02270001
022800 01  PV-MISC-ABEND-FIELDS.                                        02280001
022900     05  PV-PARAGRAPH-NAME            PIC X(30) VALUE SPACE.      02290001
023000     05  PV-OPERATION-MSG-1           PIC X(40) VALUE SPACE.      02300001
023100     05  PV-OPERATION-MSG-2           PIC X(40) VALUE SPACE.      02310001
023200     05  PV-DB2-OPERATION             PIC X(30) VALUE SPACE.      02320001
023300 01  ABEND-CODE                  PIC S9(4) VALUE ZEROS COMP SYNC. 02330001
023400     88  ABEND-4003-CTRL-CARD-ERROR        VALUE +4003.           02340001
023500     88  ABEND-4013-DB2-ERROR              VALUE +4013.           02350001
023600     88  ABEND-4019-CAL-SUB-ERROR          VALUE +4019.           02360001
023700     88  ABEND-4020-MQ-ERROR               VALUE +4020.           02370001
023800     88  ABEND-4444-FORCED-ABEND           VALUE +4444.           02380001
023900                                                                  02390001
024000*-----------------------------------------------------------      02400001
024100* DB2 COMMUNICATIONS AREA                                         02410001
024200*-----------------------------------------------------------      02420001
024300     EXEC SQL                                                     02430001
024400          INCLUDE SQLCA                                           02440001
024500     END-EXEC.                                                    02450001
024600                                                                  02460001
024700*-----------------------------------------------------------      02470001
024800* DB2 TABLE EPT00010(EPT_STR_FIL_RFRSH) - STORE FILE REFRESH      02480001
024900*                                              TABLE              02490001
025000*-----------------------------------------------------------      02500001
025100     EXEC SQL                                                     02510001
025200          INCLUDE EPT00010                                        02520001
025300     END-EXEC.                                                    02530001
025400                                                                  02540001
025500*-----------------------------------------------------------      02550001
025600* DB2 TABLE XST00001(XST_LOC) - LOCATION TABLE                    02560001
025700*-----------------------------------------------------------      02570001
025800     EXEC SQL                                                     02580001
025900          INCLUDE XST00001                                        02590001
026000     END-EXEC.                                                    02600001
026100                                                                  02610001
026200*-----------------------------------------------------------      02620001
026300* DB2 TABLE XST00025(XST_LOC_ATTR) - LOCATION ATTRIBUTE TABLE     02630001
026400*-----------------------------------------------------------      02640001
026500     EXEC SQL                                                     02650001
026600          INCLUDE XST00025                                        02660001
026700     END-EXEC.                                                    02670001
026800                                                                  02680001
026900*-----------------------------------------------------------      02690001
027000* DB2 TABLE XST00010(XST_SKU) - SKU TABLE                         02700001
027100*-----------------------------------------------------------      02710001
027200     EXEC SQL                                                     02720001
027300          INCLUDE XST00010                                        02730001
027400     END-EXEC.                                                    02740001
027500                                                                  02750001
027600*-----------------------------------------------------------      02760001
027700* DB2 TABLE XST00011(XST_SKU_ATTR) - SKU ATTRIBUTE TABLE          02770001
027800*-----------------------------------------------------------      02780001
027900     EXEC SQL                                                     02790001
028000          INCLUDE XST00011                                        02800001
028100     END-EXEC.                                                    02810001
028200                                                                  02820001
028300*-----------------------------------------------------------      02830001
028400* DB2 TABLE XST00008(XST_SKU_LOC) - SKU LOCATION TABLE            02840001
028500*-----------------------------------------------------------      02850001
028600     EXEC SQL                                                     02860001
028700          INCLUDE XST00008                                        02870001
028800     END-EXEC.                                                    02880001
028900                                                                  02890001
029000*-----------------------------------------------------------      02900001
029100* DB2 TABLE XST00041(XST_SKU_LOC_ATTR) - SKU LOCATION ATTRIBUTE   02910001
029200*                                               TABLE             02920001
029300*-----------------------------------------------------------      02930001
029400     EXEC SQL                                                     02940001
029500          INCLUDE XST00041                                        02950001
029600     END-EXEC.                                                    02960001
029700                                                                  02970001
032000*-----------------------------------------------------------      03200010
032100* REFRESH-CURSOR WILL FIND ALL THE STORES THAT NEED A FULL        03210010
032200* FILE REFRESH.                                                   03220010
032300*-----------------------------------------------------------      03230010
032400     EXEC SQL                                                     03240010
032500       DECLARE REFRESH-CURSOR CURSOR FOR                          03250010
032600            SELECT  A.STR_NBR                                     03260010
032700              FROM  EPT_STR_FIL_RFRSH A                           03270010
032800                   ,XST_LOC           B                           03280010
032900                   ,XST_LOC_ATTR      C                           03290010
033000             WHERE  A.STR_NBR        = B.LOC_NBR                  03300010
033100               AND  B.LOC_NBR        = C.LOC_NBR                  03310010
033200               AND  A.RFRSH_TYP_CDE  = 'PL'                       03320010
033300               AND (A.RFRSH_DTE      IS NULL                      03330010
033400                OR  A.RFRSH_DTE      = :PV-TODAY-DTE)             03340010
033500               AND  B.LOC_TYP_CDE    = 'DS'                       03350010
033600               AND (C.POS_CAP_LVL_ID = 5                          03360010
033700                OR  C.POS_CAP_LVL_ID > 11)                        03370010
033800               AND ((B.OPN_DTE       >  :PV-STRT-DTE              03380010
033900               AND (B.OPN_DTE        <= :PV-NEW-OPEN-DATE         03390010
034000               AND  B.CLO_DTE        >= :PV-NEW-OPEN-DATE))       03400010
034100                OR (B.OPN_DTE        <= :PV-STRT-DTE              03410010
034200               AND  B.CLO_DTE        >= :PV-STRT-DTE))            03420010
034300           WITH UR                                                03430010
034400     END-EXEC.                                                    03440010
034500                                                                  03450010
034600*-----------------------------------------------------------      03460001
034700* SKU-STR-CURSOR WILL GET ANY STORE SPECIFIC PRICING FOR THE      03470001
034800* STORES RECEIVING REFRESHED FILES.                               03480001
034900*-----------------------------------------------------------      03490001
035000     EXEC SQL                                                     03500001
035100       DECLARE SKU-STR-CURSOR CURSOR FOR                          03510001
035200            SELECT  D.UNT_RTL_AMT                                 03520002
035300                   ,D.LOC_SKU_STAT_CDE                            03530001
035400                   ,D.UPC_STAT_CHG_DTE                            03540001
035500                   ,D.UNT_RTL_CHG_DTE                             03550001
035600                   ,D.GP_PRIC_ID                                  03560001
035700                   ,D.GP_RTL_QTY                                  03570001
035800                   ,D.GP_RTL_AMT                                  03580001
035900                   ,E.PRMPT_FOR_PRIC_IND                          03590012
036000                   ,B.SKU_NBR                                     03600001
036100              FROM  XST_SKU_LOC      D                            03610001
036200                   ,XST_SKU_LOC_ATTR E                            03620012
036300                   ,XST_SKU_ATTR     A                            03630012
036400                   ,XST_SKU          B                            03640001
036500             WHERE  D.LOC_NBR            =  :XST00008-LOC-NBR     03650001
036600               AND  D.LOC_NBR            =  E.LOC_NBR             03660012
036700               AND  D.INTR_UPC_ID        =  A.INTR_UPC_ID         03670012
036800               AND  D.INTR_UPC_ID        =  E.INTR_UPC_ID         03680012
036900               AND  D.INTR_UPC_ID        =  B.INTR_UPC_ID         03690001
037000               AND  D.END_TMST           IS NULL                  03700001
037100               AND  A.PLU_DWNLD_EXCL_IND =  'N'                   03710012
037200           WITH UR                                                03720001
037300     END-EXEC.                                                    03730001
037400                                                                  03740001
037500*----------------------------------------------------------       03750001
037600 PROCEDURE DIVISION.                                              03760001
037700*----------------------------------------------------------       03770001
037800 0000-MAINLINE.                                                   03780001
037900                                                                  03790001
038000     PERFORM 1000-INITIALIZATION.                                 03800001
038100                                                                  03810001
038200     PERFORM 3000-OPEN-REFRESH-CURSOR.                            03820001
038300     PERFORM 3100-FETCH-REFRESH-CURSOR.                           03830001
038400                                                                  03840001
038500     IF PS-END-OF-REFRESH-CSR                                     03850001
038600        DISPLAY 'NO STORES IDENTIFIED TO RECEIVE A REFRESH'       03860001
038700        DISPLAY 'NO REFRESH OF PLU AND XREF DATA TODAY'           03870001
038800     END-IF.                                                      03880001
038900                                                                  03890001
039000     PERFORM 2000-PROCESS-CURSORS                                 03900001
039100        UNTIL PS-END-OF-REFRESH-CSR.                              03910001
039200                                                                  03920001
039300     PERFORM 3200-CLOSE-REFRESH-CURSOR                            03930001
039400     PERFORM 9999-WRAPUP.                                         03940001
039500                                                                  03950001
039600     GOBACK.                                                      03960001
039700                                                                  03970001
039800*0000-EXIT.                                                       03980001
039900                                                                  03990001
040000*----------------------------------------------------------       04000001
040100* 1000-INITIALIZATION.                                            04010001
040200*     INITIALIZATION AREA - INITIALIZES ALL VARIABLES, OPENS      04020001
040300*     FILES, ETC.                                                 04030001
040400*----------------------------------------------------------       04040001
040500 1000-INITIALIZATION.                                             04050001
040600                                                                  04060001
040700     INITIALIZE CC-EPCC112-CONTROL-CARD                           04070001
040800                EP045-ADVDAYS-TO-SND-RECORD                       04080001
040900                CC-EPCC140-CONTROL-CARD.                          04090001
041000                                                                  04100001
041100     OPEN INPUT  CONTROL-CARD-1                                   04110001
041200                 CONTROL-CARD-2                                   04120001
041300                 CONTROL-CARD-3                                   04130001
041400          OUTPUT FULL-SKU-PRICING-STORE-FILE.                     04140011
041500                                                                  04150001
041600     PERFORM 1500-READ-CONTROL-CARD-1.                            04160001
041700     PERFORM 1600-READ-CONTROL-CARD-2.                            04170001
041800     PERFORM 1700-READ-CONTROL-CARD-3.                            04180001
041900                                                                  04190001
042000     MOVE CC-EPCC112-TOMORROW-DATE  TO PV-PLU-STRT-DTE            04200001
042100                                       PV-STRT-DTE                04210001
042200                                       PV-PRIC-EFF-DTE.           04220001
042300     MOVE PC-PRIC-EFF-TIME-STD      TO PV-PRIC-EFF-TIME.          04230003
042400     DISPLAY 'PRIC EFF TMST TO SQLS: ' PV-PRIC-EFF-TMST.          04240001
042500                                                                  04250001
042600     MOVE CC-EPCC140-TODAY-DATE     TO PV-TODAY-DTE.              04260001
042700     MOVE EP045-DAYS-TILL-STORE-OPN TO PV-DAYS-AHEAD.             04270001
042800     MOVE PV-DAYS-AHEAD             TO PV-SAVE-ADDED-DAYS.        04280001
042900     PERFORM 1800-GET-DATE.                                       04290001
043000                                                                  04300001
043100     INITIALIZE PV-CNT-REFRESH-CSR.                               04310001
043200                                                                  04320001
043300     CLOSE CONTROL-CARD-1                                         04330001
043400           CONTROL-CARD-2                                         04340001
043500           CONTROL-CARD-3.                                        04350001
043600                                                                  04360001
043700*1000-EXIT.                                                       04370001
043800                                                                  04380001
043900*----------------------------------------------------------       04390001
044000* 1500-READ-CONTROL-CARD-1.                                       04400001
044100*     READ CONTROL CARD 1.  THIS GETS THE FUTURE DATE THAT        04410001
044200*     NEEDS TO BE PROCESSED.                                      04420001
044300*----------------------------------------------------------       04430001
044400 1500-READ-CONTROL-CARD-1.                                        04440001
044500                                                                  04450001
044600     READ CONTROL-CARD-1 INTO CC-EPCC112-CONTROL-CARD.            04460001
044700                                                                  04470001
044800     IF CC-EPCC112-TOMORROW-DATE     = SPACES                     04480001
044900        DISPLAY 'INVALID CONTROL CARD'                            04490001
045000        DISPLAY 'TOMORROWS DATE: ' CC-EPCC112-TOMORROW-DATE       04500001
045100        MOVE '1500-READ-CONTROL-CARD-1' TO PV-PARAGRAPH-NAME      04510001
045200        MOVE 'CONTROL CARD IS INVALID'  TO PV-OPERATION-MSG-1     04520001
045300        SET ABEND-4003-CTRL-CARD-ERROR  TO TRUE                   04530001
045400        PERFORM 9800-ABEND                                        04540001
045500     ELSE                                                         04550001
045600        DISPLAY 'TOMORROWS DATE: ' CC-EPCC112-TOMORROW-DATE       04560001
045700     END-IF.                                                      04570001
045800                                                                  04580001
045900*1500-EXIT.                                                       04590001
046000                                                                  04600001
046100*----------------------------------------------------------       04610001
046200* 1600-READ-CONTROL-CARD-2.                                       04620001
046300*     READ CONTROL CARD 2.  THIS GETS THE NUMBER OF DAYS          04630001
046400*     FOR WHICH A NEW STORE SHOULD BE ADDED TO THE                04640001
046500*     DISTRIBUTION LIST.                                          04650001
046600*----------------------------------------------------------       04660001
046700 1600-READ-CONTROL-CARD-2.                                        04670001
046800                                                                  04680001
046900     READ CONTROL-CARD-2 INTO EP045-ADVDAYS-TO-SND-RECORD.        04690001
047000                                                                  04700001
047100     IF EP045-DAYS-TILL-STORE-OPN = SPACES                        04710001
047200        DISPLAY 'INVALID CONTROL CARD'                            04720001
047300        DISPLAY 'DAYS TILL STORE OPEN: ' EP045-DAYS-TILL-STORE-OPN04730001
047400        MOVE '1600-READ-CONTROL-CARD-1' TO PV-PARAGRAPH-NAME      04740001
047500        MOVE 'CONTROL CARD IS INVALID'  TO PV-OPERATION-MSG-1     04750001
047600        SET ABEND-4003-CTRL-CARD-ERROR  TO TRUE                   04760001
047700        PERFORM 9800-ABEND                                        04770001
047800     ELSE                                                         04780001
047900        DISPLAY 'DAYS TILL STORE OPEN: ' EP045-DAYS-TILL-STORE-OPN04790001
048000     END-IF.                                                      04800001
048100                                                                  04810001
048200*1600-EXIT.                                                       04820001
048300                                                                  04830001
048400*----------------------------------------------------------       04840001
048500* 1700-READ-CONTROL-CARD-3.                                       04850001
048600*     READ CONTROL CARD 3.  THIS GETS TODAY'S DATE                04860001
048700*     FOR PROCESSING PURPOSES.                                    04870001
048800*----------------------------------------------------------       04880001
048900 1700-READ-CONTROL-CARD-3.                                        04890001
049000                                                                  04900001
049100     READ CONTROL-CARD-3 INTO CC-EPCC140-CONTROL-CARD.            04910001
049200                                                                  04920001
049300     IF CC-EPCC140-TODAY-DATE     = SPACES                        04930001
049400        DISPLAY 'INVALID CONTROL CARD'                            04940001
049500        DISPLAY 'TODAYS DATE: ' CC-EPCC140-TODAY-DATE             04950001
049600        MOVE '1700-READ-CONTROL-CARD-3' TO PV-PARAGRAPH-NAME      04960001
049700        MOVE 'CONTROL CARD IS INVALID'  TO PV-OPERATION-MSG-1     04970001
049800        SET ABEND-4003-CTRL-CARD-ERROR  TO TRUE                   04980001
049900        PERFORM 9800-ABEND                                        04990001
050000     ELSE                                                         05000001
050100        DISPLAY 'TODAYS DATE: ' CC-EPCC140-TODAY-DATE             05010001
050200     END-IF.                                                      05020001
050300                                                                  05030001
050400*1700-EXIT.                                                       05040001
050500                                                                  05050001
050600*----------------------------------------------------------       05060001
050700* 1800-GET-DATE.                                                  05070001
050800*     ADDS THE NUMBER OF DAYS FROM CONTROL CARD 2 TO              05080001
050900*     TODAY'S DATE.                                               05090001
051000*----------------------------------------------------------       05100001
051100 1800-GET-DATE.                                                   05110001
051200                                                                  05120001
051300     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              05130001
051400     MOVE PV-TODAY-DTE                 TO DPG52-LK-DATE-INPUT.    05140001
051500     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   05150001
051600     SET  DPG52-LK-DTE-ISO-FMT         TO TRUE.                   05160001
051700     SET  DPG51-INCREMENT-DATE         TO TRUE.                   05170001
051800     MOVE PV-SAVE-ADDED-DAYS           TO DPG51-INCR-DECR-DAYS-X. 05180001
051900     SET PS-DATE-NOT-FOUND TO TRUE.                               05190001
052000     PERFORM 1810-DATE-ROUTINE.                                   05200001
052100     IF PS-DATE-FOUND                                             05210001
052200        MOVE DPG55-DB2-ISO-DATE-FMT TO PV-NEW-OPEN-DATE           05220001
052300        DISPLAY 'NEW DATE:' PV-NEW-OPEN-DATE                      05230001
052400     END-IF.                                                      05240001
052500                                                                  05250001
052600*1800-EXIT.                                                       05260001
052700                                                                  05270001
052800*----------------------------------------------------------       05280001
052900* 1810-DATE-ROUTINE.                                              05290001
053000*     CALLS KOHL'S DATE ROUTINE.                                  05300001
053100*----------------------------------------------------------       05310001
053200 1810-DATE-ROUTINE.                                               05320001
053300                                                                  05330001
053400     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    05340001
053500                                             DPG54 DPG55 DPG56.   05350001
053600     EVALUATE TRUE                                                05360001
053700         WHEN DPG54-NO-ERROR                                      05370001
053800             DISPLAY ' '                                          05380001
053900             DISPLAY 'RETRIEVING NEW CALCULATED DATE'             05390001
054000             DISPLAY 'DPKUT500 DATE RETRIEVED:'                   05400001
054100                DPG55-DB2-ISO-DATE-FMT                            05410001
054200             SET PS-DATE-FOUND TO TRUE                            05420001
054300         WHEN DPG54-SEVERE-ERROR                                  05430001
054400             DISPLAY ' '                                          05440001
054500             DISPLAY '** ABEND ** IN EPKUT159'                    05450001
054600             DISPLAY '** INVALID RETURN FROM CALENDAR ROUTINE'    05460001
054700             DISPLAY '** CALLED BY 1800-GET-DATE'                 05470001
054800             DISPLAY '** ERROR MESSAGE = '                        05480001
054900                               DPG54-ERROR-MESSAGE                05490001
055000             DISPLAY '** DPG51 = ' DPG51                          05500001
055100             DISPLAY '** DPG52 = ' DPG52                          05510001
055200             DISPLAY '** DPG53 = ' DPG53                          05520001
055300             DISPLAY '** DPG54 = ' DPG54                          05530001
055400             DISPLAY '** DPG55 = ' DPG55                          05540001
055500             DISPLAY '** DPG56 = ' DPG56                          05550001
055600             MOVE '1800-GET-DATE'                                 05560001
055700                                  TO PV-PARAGRAPH-NAME            05570001
055800             MOVE 'ERROR VALIDATING INPUT CARD DATE'              05580001
055900                                  TO PV-OPERATION-MSG-1           05590001
056000             MOVE DPG54-ERROR-MESSAGE  TO PV-OPERATION-MSG-2      05600001
056100             SET ABEND-4019-CAL-SUB-ERROR TO TRUE                 05610001
056200             PERFORM 9800-ABEND                                   05620001
056300     END-EVALUATE.                                                05630001
056400                                                                  05640001
056500*1810-EXIT.                                                       05650001
056600                                                                  05660001
056700*----------------------------------------------------------       05670001
056800* 2000-PROCESS-CURSORS.                                           05680001
056900*     PROCESSES EACH STORE FOR WHICH A REFRESH HAS BEEN REQUESTED,05690001
057000*     FETCHING STORE SPECIFIC PRICES FOR EACH STORE.              05700001
057100*----------------------------------------------------------       05710001
057200 2000-PROCESS-CURSORS.                                            05720001
057300                                                                  05730001
057400     MOVE EPT00010-STR-NBR  TO XST00008-LOC-NBR.                  05740001
057500     MOVE EPT00010-STR-NBR  TO PV-DISPLAY-STR-NBR.                05750001
057600                                                                  05760001
057700     PERFORM 3700-OPEN-SKU-STR-CURSOR.                            05770001
057800     PERFORM 3800-FETCH-SKU-STR-CURSOR.                           05780001
057900                                                                  05790001
058000     PERFORM 2100-PROCESS-STR-FULL-FILE                           05800001
058100        UNTIL PS-END-OF-SKU-STR-CSR.                              05810001
058200                                                                  05820001
058300     PERFORM 3900-CLOSE-SKU-STR-CURSOR.                           05830001
058400                                                                  05840001
058500     DISPLAY '>>> REFRESH STORE '    PV-DISPLAY-STR-NBR           05850001
058600             ' STORE SPECIFIC RECS ' PV-CNT-STORE-RECS.           05860001
058700     INITIALIZE PV-CNT-STORE-RECS.                                05870001
058800                                                                  05880001
058900     PERFORM 3100-FETCH-REFRESH-CURSOR.                           05890001
059000                                                                  05900001
059100*2000-EXIT.                                                       05910001
059200                                                                  05920001
059300*----------------------------------------------------------       05930001
059400* 2100-PROCESS-STR-FULL-FILES.                                    05940001
059500*     PROCESS THE SKU STR PRICING CURSOR TO FIND ANY              05950001
059600*     STORE SPECIFIC DATA FOR THE STORE BEING REFRESHED.          05960001
059700*     CREATES PLU STORE RECORDS.                                  05970001
059800*----------------------------------------------------------       05980001
059900 2100-PROCESS-STR-FULL-FILE.                                      05990001
060000                                                                  06000001
060100     ADD +1 TO PV-CNT-STORE-RECS.                                 06010001
060200     PERFORM 5000-CREATE-STR-SKU-PRICG-RCD.                       06020001
060300                                                                  06030001
060400     PERFORM 3800-FETCH-SKU-STR-CURSOR.                           06040001
060500                                                                  06050001
060600*2100-EXIT.                                                       06060001
060700                                                                  06070001
060800*----------------------------------------------------------       06080001
060900* 3000-OPEN-REFRESH-CURSOR.                                       06090000
061000*     OPEN THE REFRESH CURSOR.                                    06100000
061100*----------------------------------------------------------       06110000
061200 3000-OPEN-REFRESH-CURSOR.                                        06120000
061300                                                                  06130000
061400     PERFORM                                                      06140000
061500         WITH TEST AFTER                                          06150000
061600         VARYING PV-SQL-SUB                                       06160000
061700         FROM 1 BY 1                                              06170000
061800         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 06180000
061900                   OR  SQLCODE = 0)                               06190000
062000                                                                  06200000
062100           EXEC SQL                                               06210000
062200              OPEN REFRESH-CURSOR                                 06220000
062300           END-EXEC                                               06230000
062400                                                                  06240000
062500         EVALUATE TRUE                                            06250000
062600             WHEN SQLCODE = -904                                  06260000
062700             WHEN SQLCODE = -911                                  06270000
062800             WHEN SQLCODE = -913                                  06280000
062900                  CONTINUE                                        06290000
063000             WHEN SQLCODE = 0                                     06300000
063100                  SET PS-MORE-REFRESH-CSR TO TRUE                 06310000
063200             WHEN SQLWARN0 NOT EQUAL SPACE                        06320000
063300             WHEN SQLCODE NOT EQUAL ZERO                          06330000
063400                  MOVE '3000-OPEN-REFRESH-CURSOR'                 06340000
063500                                     TO PV-PARAGRAPH-NAME         06350000
063600                  MOVE 'ERROR ON OPEN OF REFRESH CURSOR'          06360000
063700                                     TO PV-DB2-OPERATION          06370000
063800                  PERFORM 9900-SQL-ABEND-ROUTINE                  06380000
063900         END-EVALUATE                                             06390000
064000     END-PERFORM.                                                 06400000
064100                                                                  06410000
064200     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         06420000
064300        MOVE '3000-OPEN-REFRESH-CURSOR'                           06430000
064400                             TO  PV-PARAGRAPH-NAME                06440000
064500        MOVE 'OPEN RETRIES EXCEEDED'                              06450000
064600                              TO  PV-DB2-OPERATION                06460000
064700        PERFORM 9900-SQL-ABEND-ROUTINE                            06470000
064800     END-IF.                                                      06480000
064900                                                                  06490000
065000*3000-EXIT.                                                       06500000
065100                                                                  06510000
065200*----------------------------------------------------------       06520000
065300* 3100-FETCH-REFRESH-CURSOR.                                      06530000
065400*     FETCH THE REFRESH CURSOR.                                   06540000
065500*----------------------------------------------------------       06550000
065600 3100-FETCH-REFRESH-CURSOR.                                       06560000
065700                                                                  06570000
065800     PERFORM                                                      06580000
065900         WITH TEST AFTER                                          06590000
066000         VARYING PV-SQL-SUB                                       06600000
066100         FROM 1 BY 1                                              06610000
066200         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 06620000
066300                   OR  SQLCODE = 0                                06630000
066400                   OR  SQLCODE = +100)                            06640000
066500                                                                  06650000
066600           EXEC SQL                                               06660000
066700              FETCH REFRESH-CURSOR                                06670000
066800              INTO  :EPT00010-STR-NBR                             06680000
066900           END-EXEC                                               06690000
067000                                                                  06700000
067100          EVALUATE TRUE                                           06710000
067200             WHEN SQLCODE = -904                                  06720000
067300             WHEN SQLCODE = -911                                  06730000
067400             WHEN SQLCODE = -913                                  06740000
067500                  CONTINUE                                        06750000
067600             WHEN SQLCODE = ZERO                                  06760000
067700                  ADD 1 TO PV-CNT-REFRESH-CSR                     06770000
067800             WHEN SQLCODE = +100                                  06780000
067900                  SET PS-END-OF-REFRESH-CSR TO TRUE               06790000
068000             WHEN SQLWARN0 NOT EQUAL SPACE                        06800000
068100             WHEN SQLCODE NOT EQUAL ZERO                          06810000
068200                  MOVE '3100-FETCH-REFRESH-CURSOR'                06820000
068300                                     TO PV-PARAGRAPH-NAME         06830000
068400                  MOVE 'ERROR ON FETCHING REFRESH CURSOR'         06840000
068500                                     TO PV-DB2-OPERATION          06850000
068600                  DISPLAY 'SQLCODE= ' SQLCODE                     06860000
068700                  PERFORM 9900-SQL-ABEND-ROUTINE                  06870000
068800          END-EVALUATE                                            06880000
068900     END-PERFORM.                                                 06890000
069000                                                                  06900000
069100     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        06910000
069200         MOVE '3100-FETCH-REFRESH-CURSOR'                         06920000
069300                               TO  PV-PARAGRAPH-NAME              06930000
069400         MOVE 'FETCH RETRIES EXCEEDED'                            06940000
069500                               TO  PV-DB2-OPERATION               06950000
069600         PERFORM 9900-SQL-ABEND-ROUTINE                           06960000
069700     END-IF.                                                      06970000
069800                                                                  06980000
069900*3100-EXIT.                                                       06990000
070000                                                                  07000000
070100*-----------------------------------------------------------      07010000
070200* 3200-CLOSE-REFRESH-CURSOR.                                      07020000
070300*     CLOSE THE REFRESH CURSOR.                                   07030000
070400*-----------------------------------------------------------      07040000
070500 3200-CLOSE-REFRESH-CURSOR.                                       07050000
070600                                                                  07060000
070700     PERFORM                                                      07070000
070800         WITH TEST AFTER                                          07080000
070900         VARYING PV-SQL-SUB                                       07090000
071000         FROM 1 BY 1                                              07100000
071100         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 07110000
071200                   OR  SQLCODE = 0)                               07120000
071300                                                                  07130000
071400           EXEC SQL                                               07140000
071500              CLOSE REFRESH-CURSOR                                07150000
071600           END-EXEC                                               07160000
071700                                                                  07170000
071800          EVALUATE TRUE                                           07180000
071900             WHEN SQLCODE = -904                                  07190000
072000             WHEN SQLCODE = -911                                  07200000
072100             WHEN SQLCODE = -913                                  07210000
072200             WHEN SQLCODE = 0                                     07220000
072300                  CONTINUE                                        07230000
072400             WHEN SQLWARN0 NOT EQUAL SPACE                        07240000
072500             WHEN SQLCODE NOT EQUAL ZERO                          07250000
072600                  MOVE '3200-CLOSE-REFRESH-CURSOR'                07260000
072700                                      TO PV-PARAGRAPH-NAME        07270000
072800                  MOVE 'ERROR ON CLOSE OF REFRESH CURSOR'         07280000
072900                                      TO PV-DB2-OPERATION         07290000
073000                  PERFORM 9900-SQL-ABEND-ROUTINE                  07300000
073100          END-EVALUATE                                            07310000
073200     END-PERFORM.                                                 07320000
073300                                                                  07330000
073400     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         07340000
073500        MOVE '3200-CLOSE-REFRESH-CURSOR'                          07350000
073600                               TO  PV-PARAGRAPH-NAME              07360000
073700        MOVE 'CLOSE RETRIES EXCEEDED'                             07370000
073800                               TO  PV-DB2-OPERATION               07380000
073900        PERFORM 9900-SQL-ABEND-ROUTINE                            07390000
074000     END-IF.                                                      07400000
074100                                                                  07410000
074200*3200-EXIT.                                                       07420000
074300                                                                  07430001
074400*----------------------------------------------------------       07440001
074500* 3700-OPEN-SKU-STR-CURSOR.                                       07450001
074600*     OPEN THE SKU STORE CURSOR.                                  07460001
074700*----------------------------------------------------------       07470001
074800 3700-OPEN-SKU-STR-CURSOR.                                        07480001
074900                                                                  07490001
075000     PERFORM                                                      07500001
075100         WITH TEST AFTER                                          07510001
075200         VARYING PV-SQL-SUB                                       07520001
075300         FROM 1 BY 1                                              07530001
075400         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 07540001
075500                   OR  SQLCODE = 0)                               07550001
075600                                                                  07560001
075700           EXEC SQL                                               07570001
075800              OPEN SKU-STR-CURSOR                                 07580001
075900           END-EXEC                                               07590001
076000                                                                  07600001
076100         EVALUATE TRUE                                            07610001
076200             WHEN SQLCODE = -904                                  07620001
076300             WHEN SQLCODE = -911                                  07630001
076400             WHEN SQLCODE = -913                                  07640001
076500                  CONTINUE                                        07650001
076600             WHEN SQLCODE = 0                                     07660001
076700                  SET PS-MORE-SKU-STR-CSR TO TRUE                 07670001
076800             WHEN SQLWARN0 NOT EQUAL SPACE                        07680001
076900             WHEN SQLCODE NOT EQUAL ZERO                          07690001
077000                  MOVE '3700-OPEN-SKU-STR-CURSOR'                 07700001
077100                                     TO PV-PARAGRAPH-NAME         07710001
077200                  MOVE 'ERROR ON OPEN OF SKU STR CURSOR'          07720001
077300                                     TO PV-DB2-OPERATION          07730001
077400                  PERFORM 9900-SQL-ABEND-ROUTINE                  07740001
077500         END-EVALUATE                                             07750001
077600     END-PERFORM.                                                 07760001
077700                                                                  07770001
077800     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         07780001
077900        MOVE '3700-OPEN-SKU-STR-CURSOR'                           07790001
078000                             TO  PV-PARAGRAPH-NAME                07800001
078100        MOVE 'OPEN RETRIES EXCEEDED'                              07810001
078200                              TO  PV-DB2-OPERATION                07820001
078300        PERFORM 9900-SQL-ABEND-ROUTINE                            07830001
078400     END-IF.                                                      07840001
078500                                                                  07850001
078600*3700-EXIT.                                                       07860001
078700                                                                  07870001
078800*----------------------------------------------------------       07880001
078900* 3800-FETCH-SKU-STR-CURSOR.                                      07890001
079000*     FETCH THE SKU STORE CURSOR.                                 07900001
079100*----------------------------------------------------------       07910001
079200 3800-FETCH-SKU-STR-CURSOR.                                       07920001
079300                                                                  07930001
079400     PERFORM                                                      07940001
079500         WITH TEST AFTER                                          07950001
079600         VARYING PV-SQL-SUB                                       07960001
079700         FROM 1 BY 1                                              07970001
079800         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 07980001
079900                   OR  SQLCODE = 0                                07990001
080000                   OR  SQLCODE = +100)                            08000001
080100                                                                  08010001
080200           EXEC SQL                                               08020001
080300              FETCH SKU-STR-CURSOR                                08030001
080400              INTO  :XST00008-UNT-RTL-AMT                         08040002
080500                   ,:XST00008-LOC-SKU-STAT-CDE                    08050001
080600                   ,:XST00008-UPC-STAT-CHG-DTE                    08060001
080700                   ,:XST00008-UNT-RTL-CHG-DTE                     08070001
080800                   ,:XST00008-GP-PRIC-ID  :PV-GP-PRIC-ID-IND      08080001
080900                   ,:XST00008-GP-RTL-QTY  :PV-GP-RTL-QTY-IND      08090001
081000                   ,:XST00008-GP-RTL-AMT  :PV-GP-RTL-AMT-IND      08100001
081100                   ,:XST00041-PRMPT-FOR-PRIC-IND                  08110013
081200                   ,:XST00010-SKU-NBR                             08120001
081300           END-EXEC                                               08130001
081400                                                                  08140001
081500          EVALUATE TRUE                                           08150001
081600             WHEN SQLCODE = -904                                  08160001
081700             WHEN SQLCODE = -911                                  08170001
081800             WHEN SQLCODE = -913                                  08180001
081900                  CONTINUE                                        08190001
082000             WHEN SQLCODE = ZERO                                  08200001
082100                  ADD 1 TO PV-CNT-SKU-STR-CSR                     08210001
082200             WHEN SQLCODE = +100                                  08220001
082300                  SET PS-END-OF-SKU-STR-CSR TO TRUE               08230001
082400             WHEN SQLWARN0 NOT EQUAL SPACE                        08240001
082500             WHEN SQLCODE NOT EQUAL ZERO                          08250001
082600                  MOVE '3800-FETCH-SKU-STR-CURSOR'                08260001
082700                                     TO PV-PARAGRAPH-NAME         08270001
082800                  MOVE 'ERROR ON FETCHING SKU STR CURSOR'         08280001
082900                                     TO PV-DB2-OPERATION          08290001
083000                  DISPLAY 'SQLCODE= ' SQLCODE                     08300001
083100                  PERFORM 9900-SQL-ABEND-ROUTINE                  08310001
083200          END-EVALUATE                                            08320001
083300     END-PERFORM.                                                 08330001
083400                                                                  08340001
083500     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        08350001
083600         MOVE '3800-FETCH-SKU-STR-CURSOR'                         08360001
083700                               TO  PV-PARAGRAPH-NAME              08370001
083800         MOVE 'FETCH RETRIES EXCEEDED'                            08380001
083900                               TO  PV-DB2-OPERATION               08390001
084000         PERFORM 9900-SQL-ABEND-ROUTINE                           08400001
084100     END-IF.                                                      08410001
084200                                                                  08420001
084300*3800-EXIT.                                                       08430001
084400                                                                  08440001
084500*-----------------------------------------------------------      08450001
084600* 3900-CLOSE-SKU-STR-CURSOR.                                      08460001
084700*     CLOSE THE SKU STORE CURSOR.                                 08470001
084800*-----------------------------------------------------------      08480001
084900 3900-CLOSE-SKU-STR-CURSOR.                                       08490001
085000                                                                  08500001
085100     PERFORM                                                      08510001
085200         WITH TEST AFTER                                          08520001
085300         VARYING PV-SQL-SUB                                       08530001
085400         FROM 1 BY 1                                              08540001
085500         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 08550001
085600                   OR  SQLCODE = 0)                               08560001
085700                                                                  08570001
085800           EXEC SQL                                               08580001
085900              CLOSE SKU-STR-CURSOR                                08590001
086000           END-EXEC                                               08600001
086100                                                                  08610001
086200          EVALUATE TRUE                                           08620001
086300             WHEN SQLCODE = -904                                  08630001
086400             WHEN SQLCODE = -911                                  08640001
086500             WHEN SQLCODE = -913                                  08650001
086600             WHEN SQLCODE = 0                                     08660001
086700                  CONTINUE                                        08670001
086800             WHEN SQLWARN0 NOT EQUAL SPACE                        08680001
086900             WHEN SQLCODE NOT EQUAL ZERO                          08690001
087000                  MOVE '3900-CLOSE-SKU-STR-CURSOR'                08700001
087100                                      TO PV-PARAGRAPH-NAME        08710001
087200                  MOVE 'ERROR ON CLOSE OF SKU STR CURSOR'         08720001
087300                                      TO PV-DB2-OPERATION         08730001
087400                  PERFORM 9900-SQL-ABEND-ROUTINE                  08740001
087500          END-EVALUATE                                            08750001
087600     END-PERFORM.                                                 08760001
087700                                                                  08770001
087800     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         08780001
087900        MOVE '3900-CLOSE-SKU-STR-CURSOR'                          08790001
088000                               TO  PV-PARAGRAPH-NAME              08800001
088100        MOVE 'CLOSE RETRIES EXCEEDED'                             08810001
088200                               TO  PV-DB2-OPERATION               08820001
088300        PERFORM 9900-SQL-ABEND-ROUTINE                            08830001
088400     END-IF.                                                      08840001
088500                                                                  08850001
088600*3900-EXIT.                                                       08860001
088700                                                                  08870001
088800*----------------------------------------------------------       08880001
088900* 5000-CREATE-STR-SKU-PRICG-RCD.                                  08890001
089000*   POPULATES AND WRITES THE SKU PRICING RECORD FOR SQL SERVER.   08900001
089100*----------------------------------------------------------       08910001
089200 5000-CREATE-STR-SKU-PRICG-RCD.                                   08920001
089300                                                                  08930001
089400     INITIALIZE EP220-XST-SKU-PRICG-RECORD.                       08940001
089500                                                                  08950001
089600     PERFORM 6000-POP-STORE-SKU-PRICG-HDR.                        08960001
089700                                                                  08970001
089800     PERFORM 6100-POPULATE-SKU-PRICG-RCD.                         08980001
089900                                                                  08990001
090000     PERFORM 8100-WRITE-SKU-PRICG-STR-REC.                        09000001
090100                                                                  09010001
090200*5000-EXIT.                                                       09020001
090300*----------------------------------------------------------       09030001
090400* 6000-POP-STORE-SKU-PRICG-HDR.                                   09040001
090500*     POPULATES FULL SKU PRICING STORE RECORD HEADER FIELDS.      09050001
090600*----------------------------------------------------------       09060001
090700 6000-POP-STORE-SKU-PRICG-HDR.                                    09070001
090800                                                                  09080001
090900     MOVE CC-EPCC112-TOMORROW-DATE TO EP220-PRICG-EFFECT-DTE.     09090001
091000     MOVE 05000                    TO EP220-STR-GRP-TYP-CDE.      09100001
091100     MOVE XST00008-LOC-NBR         TO EP220-STR-GRP-ID.           09110001
091200                                                                  09120001
091300     SET EP220-FILE-CHANGE         TO TRUE.                       09130001
091400     SET EP220-APPLY-NIGHTLY       TO TRUE.                       09140001
091500     SET EP220-RECORD-UPDATE       TO TRUE.                       09150001
091600                                                                  09160001
091700*6000-EXIT.                                                       09170001
091800*----------------------------------------------------------       09180001
091900* 6100-POPULATE-SKU-PRICG-RCD.                                    09190001
092000*     POPULATES FULL SKU PRICING RECORD FOR DUMMY RECORD.         09200001
092100*----------------------------------------------------------       09210001
092200 6100-POPULATE-SKU-PRICG-RCD.                                     09220001
092300                                                                  09230001
092400*    SKU_PRICG_ID IS SET AT THE STORE SERVER - DO NOT SEND        09240001
092500     SET EP220-SKU-PRICG-ID-NO         TO TRUE.                   09250001
092600                                                                  09260001
092700*    PRIC_EFF_TMST DATETIME NOT NULL - FORMAT: YYYY-MM-DD HH:MM:SS09270001
092800     SET EP220-PRIC-EFF-TMST-YES       TO TRUE.                   09280001
092900     MOVE PV-PRIC-EFF-TMST         TO EP220-PRIC-EFF-TMST.        09290001
093000                                                                  09300001
093100*    SET MDSE-HIER-CDE TO 'SKU' FOR ALL CURRENT PRICING RECORDS   09310001
093200     SET EP220-MDSE-HIER-CDE-YES       TO TRUE.                   09320001
093300     MOVE PC-MDSE-HIER-SKU         TO EP220-MDSE-HIER-CDE.        09330001
093400                                                                  09340001
093500     SET EP220-DEPT-NBR-NO             TO TRUE.                   09350001
093600     SET EP220-MAJ-CL-NBR-NO           TO TRUE.                   09360001
093700     SET EP220-SUB-CL-NBR-NO           TO TRUE.                   09370001
093800     SET EP220-STYL-ID-NO              TO TRUE.                   09380001
093900                                                                  09390001
094000     SET EP220-EXCL-MDSE-IND-NO        TO TRUE.                   09400001
094100                                                                  09410000
094200*    CURRENT PRICING IS ALWAYS AT SKU LEVEL                       09420000
094300     SET EP220-SKU-NBR-YES             TO TRUE.                   09430000
094400     MOVE XST00010-SKU-NBR         TO EP220-SKU-NBR.              09440000
094500                                                                  09450000
094600     SET EP220-UNT-RTL-AMT-YES         TO TRUE.                   09460001
094700     MOVE XST00008-UNT-RTL-AMT     TO PV-CONVERT-PRICE.           09470001
094800     MOVE PV-CONVERT-PRICE         TO EP220-UNT-RTL-AMT.          09480001
094900                                                                  09490001
095000     SET EP220-LAST-NCLR-RTL-AMT-NO    TO TRUE.                   09500001
095100     SET EP220-N-RCPT-RT-RTL-AMT-N     TO TRUE.                   09510001
095200                                                                  09520001
095300     SET EP220-LO-UNT-RTL-AMT-NO       TO TRUE.                   09530001
095400     SET EP220-HGH-UNT-RTL-AMT-NO      TO TRUE.                   09540001
095500                                                                  09550001
095600     IF PV-GP-PRIC-ID-NULL                                        09560001
095700        SET EP220-GP-RTL-AMT-YES       TO TRUE                    09570001
095800        SET EP220-GP-RTL-QTY-YES       TO TRUE                    09580001
095900        SET EP220-GP-PRIC-ID-YES       TO TRUE                    09590001
096000        MOVE PC-NULL-CHAR          TO EP220-GP-RTL-AMT-NUL        09600001
096100                                      EP220-GP-RTL-QTY-NUL        09610001
096200                                      EP220-GP-PRIC-ID-NUL        09620001
096300     ELSE                                                         09630001
096400        SET EP220-GP-RTL-AMT-YES       TO TRUE                    09640001
096500        MOVE XST00008-GP-RTL-AMT   TO PV-CONVERT-PRICE            09650001
096600        MOVE PV-CONVERT-PRICE      TO EP220-GP-RTL-AMT            09660001
096700        SET EP220-GP-RTL-QTY-YES       TO TRUE                    09670001
096800        MOVE XST00008-GP-RTL-QTY   TO EP220-GP-RTL-QTY            09680001
096900        SET EP220-GP-PRIC-ID-YES       TO TRUE                    09690001
097000        MOVE XST00008-GP-PRIC-ID   TO PV-CONVERT-GP-PRIC-ID       09700001
097100        MOVE PV-CONVERT-GP-PRIC-ID TO EP220-GP-PRIC-ID            09710001
097200     END-IF.                                                      09720001
097300                                                                  09730001
097400     SET EP220-LOC-SKU-STAT-CDE-YES    TO TRUE.                   09740001
097500     IF XST00008-LOC-SKU-STAT-CDE = PC-MIXED-STATUS               09750001
097600        MOVE PC-ACTIVE-STATUS      TO EP220-LOC-SKU-STAT-CDE      09760001
097700     ELSE                                                         09770001
097800        MOVE XST00008-LOC-SKU-STAT-CDE TO EP220-LOC-SKU-STAT-CDE  09780001
097900     END-IF.                                                      09790001
098000                                                                  09800001
098100*    RED TICKET IS OBSOLETE, SO ALL CLEARANCE ITEMS ARE YELLOW    09810001
098200     SET EP220-TKT-CLOR-CDE-YES        TO TRUE.                   09820001
098300     IF XST00008-LOC-SKU-STAT-CDE = '30'                          09830001
098400        MOVE 'Y'                   TO EP220-TKT-CLOR-CDE          09840001
098500     ELSE                                                         09850001
098600        MOVE 'W'                   TO EP220-TKT-CLOR-CDE          09860000
098700     END-IF.                                                      09870000
098800                                                                  09880000
098900     SET EP220-LAST-PRCHG-TMST-YES     TO TRUE.                   09890001
099000*----                                                             09900001
099100*  CR20162 CHANGE 08/03 - B                                       09910001
099200*----                                                             09920001
099300*  COMPARE THE TWO DATES AND MOVE THE LATEST TO LAST-PRCHG-TMST   09930001
099400*-----                                                            09940001
099500                                                                  09950001
099600     IF XST00008-UNT-RTL-CHG-DTE > XST00008-UPC-STAT-CHG-DTE      09960001
099700        MOVE XST00008-UNT-RTL-CHG-DTE TO PV-LAST-PRCHG-DTE        09970001
099800     ELSE                                                         09980001
099900        MOVE XST00008-UPC-STAT-CHG-DTE TO PV-LAST-PRCHG-DTE       09990001
100000     END-IF.                                                      10000001
100100                                                                  10010001
100200*----                                                             10020001
100300*  CR20162 CHANGE 08/03 - E                                       10030001
100400*----                                                             10040001
100500     MOVE PC-SQLS-START-TIME       TO PV-LAST-PRCHG-TIME.         10050001
100600     MOVE PV-LAST-PRCHG-TMST       TO EP220-LAST-PRCHG-TMST.      10060001
100700                                                                  10070001
100800     SET EP220-PRMPT-FOR-PRIC-IND-YES  TO TRUE.                   10080001
100900     MOVE XST00041-PRMPT-FOR-PRIC-IND                             10090001
101000                                   TO EP220-PRMPT-FOR-PRIC-IND.   10100001
101100                                                                  10110001
101200     SET EP220-PERM-PRCHG-DIRN-CDE-NO  TO TRUE.                   10120001
101300                                                                  10130001
101400     SET EP220-MLT-PRPT-IND-YES        TO TRUE.                   10140001
101500     MOVE 'N'                      TO EP220-MLT-PRPT-IND.         10150001
101600                                                                  10160001
101700     SET EP220-PRCHG-APL-TKT-CLR-CD-N  TO TRUE.                   10170001
101800                                                                  10180001
101900*6100-EXIT.                                                       10190001
102000*----------------------------------------------------------       10200001
102100* 8100-WRITE-SKU-PRICG-STR-REC.                                   10210001
102200*     WRITES THE SKU PRICING STORE RECORD OUT TO THE FULL         10220001
102300*     SKU PRICING STORE FILE.                                     10230001
102400*----------------------------------------------------------       10240001
102500 8100-WRITE-SKU-PRICG-STR-REC.                                    10250001
102600                                                                  10260001
102700     WRITE FULL-SKU-PRICING-STORE-RECORD                          10270001
102800         FROM EP220-XST-SKU-PRICG-RECORD.                         10280001
102900                                                                  10290001
103000     ADD 1 TO PV-CNT-SKU-PRICG-STR-RECS                           10300001
103100              PV-CNT-ALL-RECS.                                    10310001
103200                                                                  10320001
103300*8100-EXIT.                                                       10330001
103400*----------------------------------------------------------       10340001
103500* 9800-ABEND.                                                     10350001
103600*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  10360001
103700*----------------------------------------------------------       10370001
103800 9800-ABEND.                                                      10380001
103900                                                                  10390001
104000     DISPLAY '** ABEND           **'.                             10400001
104100     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  10410001
104200     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        10420001
104300     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       10430001
104400     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       10440001
104500     CALL 'ILBOABN0' USING ABEND-CODE.                            10450001
104600                                                                  10460001
104700*9800-EXIT.                                                       10470001
104800                                                                  10480001
104900*----------------------------------------------------------       10490001
105000* 9900-SQL-ABEND-ROUTINE.                                         10500001
105100*     SQL ABEND ROUTINE.                                          10510001
105200*----------------------------------------------------------       10520001
105300 9900-SQL-ABEND-ROUTINE.                                          10530001
105400                                                                  10540001
105500     SET ABEND-4013-DB2-ERROR TO TRUE.                            10550001
105600     DISPLAY '** ABEND     **'.                                   10560001
105700     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        10570001
105800     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              10580001
105900     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               10590001
106000                                                                  10600001
106100     COPY DPPD004.                                                10610001
106200     CALL 'ILBOABN0' USING ABEND-CODE.                            10620001
106300                                                                  10630001
106400*9900-EXIT.                                                       10640001
106500                                                                  10650001
106600*----------------------------------------------------------       10660001
106700* 9999-WRAPUP.                                                    10670001
106800*     END OF PROGRAM ROUTINE.  CLOSES ALL FILES AND DISPLAYS      10680001
106900*     ANY DATA FROM THE PROGRAM.                                  10690001
107000*----------------------------------------------------------       10700001
107100 9999-WRAPUP.                                                     10710001
107200                                                                  10720001
107300     CLOSE FULL-SKU-PRICING-STORE-FILE.                           10730011
107400                                                                  10740001
107500     DISPLAY ' '.                                                 10750001
107600     DISPLAY '*********************************************'.     10760001
107700     DISPLAY 'PROGRAM NAME: ' PC-CURRENT-PROGRAM-NAME.            10770001
107800     DISPLAY '*********************************************'.     10780001
107900     DISPLAY ' '.                                                 10790001
108000     DISPLAY '    NUMBER OF STORES NEEDING REFRESH: '             10800001
108100              PV-CNT-REFRESH-CSR.                                 10810001
108200     DISPLAY '      NUMBER OF SKU STR ROWS FETCHED: '             10820001
108300              PV-CNT-SKU-STR-CSR.                                 10830001
108400     DISPLAY ' '.                                                 10840001
108500     DISPLAY ' '.                                                 10850001
108600     DISPLAY 'NUMBER OF SKU PRICG STR RECS WRITTEN: '             10860001
108700              PV-CNT-SKU-PRICG-STR-RECS.                          10870001
108800     DISPLAY ' '.                                                 10880001
108900     DISPLAY '       NUMBER OF ALL RECORDS WRITTEN: '             10890001
109000              PV-CNT-ALL-RECS.                                    10900001
109100     DISPLAY ' '.                                                 10910001
109200     DISPLAY '*********************************************'.     10920000
109300                                                                  10930000
109400*9999-EXIT.                                                       10940000
