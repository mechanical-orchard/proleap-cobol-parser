000100 TITLE 'DELETE INTRANSIT BALANCE ROWS'.                                   
000200 IDENTIFICATION DIVISION.                                                 
000300 PROGRAM-ID.    PCKUP904.                                                 
000400 AUTHOR.        DENNIS STEFFEN.                                           
000500 DATE-WRITTEN.  FEBRUARY, 2006.                                           
000600                                                                          
000700                                                                          
000800 ENVIRONMENT DIVISION.                                                    
000900 INPUT-OUTPUT SECTION.                                                    
001000 FILE-CONTROL.                                                            
001100     SELECT STORE-EXPECTED-EXTRACT-FILE                                   
001200         ASSIGN TO INP01.                                                 
001300                                                                          
001400 DATA DIVISION.                                                           
001500 FILE SECTION.                                                            
001600                                                                          
001700 FD  STORE-EXPECTED-EXTRACT-FILE                                          
001800     RECORDING MODE IS F                                                  
001900     LABEL RECORDS ARE STANDARD                                           
002000     BLOCK CONTAINS 0 RECORDS.                                            
002100                                                                          
002200 01  STORE-EXPECTED-RECORD               PIC  X(22).                      
002300                                                                          
002400/                                                                         
002500 WORKING-STORAGE SECTION.                                                 
002600                                                                          
002700 01  PS-PROGRAM-SWITCHES.                                                 
002800     05  PS-END-OF-FILE-SW               PIC  X(01)  VALUE 'N'.           
002900         88  PS-END-OF-FILE-YES                      VALUE 'Y'.           
003000     05  PS-DETAIL-FOUND-SW           PIC X(01) VALUE 'N'.                
003100         88  PS-DETAIL-FOUND-YES                     VALUE 'Y'.           
003200         88  PS-DETAIL-FOUND-NO                      VALUE 'N'.           
003300 01  ABEND-CODE                          PIC S9(04)  VALUE ZERO           
003400                                                     COMP SYNC.           
003500 01  PV-PROGRAM-VARIABLES.                                                
003600     05  PV-CKPT-JOB-NAME             PIC X(08) VALUE SPACES.             
003700     05  PV-ABEND-PARAGRAPH              PIC  X(30)  VALUE SPACE.         
003800     05  PV-DB2-OPERATION-ATTEMPTED      PIC  X(30)  VALUE SPACE.         
003900     05  PV-RETRY-COUNTER             PIC S9(04) VALUE ZERO       00940004
004000                                                 COMP SYNC.       00950004
004100                                                                          
004200     05 PV-SKIP-COUNTER               PIC S9(09) COMP-3                   
004300                                                 VALUE ZERO.              
004400     05 PV-DTL-COUNTER                PIC S9(09) COMP-3                   
004500                                                 VALUE ZERO.              
004600     05  PV-DISP-CONTROL              PIC S9(09) COMP-3                   
004700                                              VALUE ZERO.                 
004800     05  PV-TIME                      PIC X(08) VALUE SPACES.             
004900                                                                          
005000                                                                          
005100                                                                          
005200     05 PV-TRAN-INSERT-COUNTER        PIC S9(09) COMP-3                   
005300                                              VALUE ZERO.                 
005400     05 PV-TRAN-DUP-IN-COUNTER        PIC S9(09) COMP-3                   
005500                                              VALUE ZERO.                 
005600     05 PV-READ-COUNTER               PIC S9(09) COMP-3                   
005700                                              VALUE ZERO.                 
005800     05 PV-DISP-NBR                   PIC ZZZ,ZZZ,ZZ9.                    
005900                                                                          
006000     05 PV-QTY-UPDATE-COUNTER         PIC S9(09) COMP-3                   
006100                                              VALUE ZERO.                 
006200     05 PV-QTY-INSERT-COUNTER         PIC S9(09) COMP-3                   
006300                                              VALUE ZERO.                 
006400     05 PV-TRAN-DELETE-COUNTER        PIC S9(09) COMP-3                   
006500                                              VALUE ZERO.                 
006600     05  PV-SQL-CODE                  PIC  -9(04) VALUE ZERO.             
006700     05  PV-UPC-TEN                   PIC  S9(10) COMP                    
006800                                                  VALUE ZERO.             
006900     05  PC-MAX-RETRIES              PIC S9(04)    VALUE  +3      00800004
007000                                                   COMP.          00810004
007100                                                                          
007200 01  PV-DISP-KEY-MSG.                                                     
007300     05  FILLER                      PIC X(14) VALUE                      
007400         'INTR-UPC-ID = '.                                                
007500     05  PV-KEY-INTR-UPC-ID          PIC 9(10) VALUE ZEROES.              
007600                                                                          
007700     05  FILLER                      PIC X(12) VALUE                      
007800         '; LOC-NBR = '.                                                  
007900     05  PV-KEY-LOC-NBR              PIC 9(04) VALUE ZEROES.              
008000     05  FILLER                      PIC X(13) VALUE                      
008100         '; CLSN-CDE = '.                                                 
008200     05  PV-KEY-CLSN-CDE             PIC X(02) VALUE ZEROES.              
008300     05  FILLER                      PIC X(12) VALUE                      
008400         '; BAL QTY = '.                                                  
008500     05  PV-KEY-BAL-QTY              PIC 9(06) VALUE ZEROES.              
008600                                                                          
008700 01  PC-PROGRAM-CONSTANTS.                                                
008800     05  PC-CKPT-PLAN-NAME            PIC X(08) VALUE 'PCKUP904'.         
008900     05  PC-CURRENT-PROGRAM-NAME      PIC X(08)  VALUE                    
009000         'PCKUP904'.                                                      
009100     05  PC-OPEN-FUNC                PIC X(05)     VALUE 'OPEN '.         
009200     05  PC-TRANS-FUNC               PIC X(05)     VALUE 'TRANS'.         
009300     05  PC-CLOSE-FUNC               PIC X(05)     VALUE 'CLOSE'.         
009400     05  PC-RSTRT-FUNC               PIC X(05)     VALUE 'RSTRT'.         
009500                                                                          
009600* TRANSACTION PRESENTATION MODULE PARAMETERS                              
260107     COPY DPWS991.                                                        
015700                                                                          
009700     COPY DPLS001.                                                        
009800         05  WORK-STRG-AREA          PIC X(150).                          
009900                                                                          
010000                                                                          
010100*    CLEANUP RECORDS                                                      
010200     COPY PCRD900.                                                        
010300                                                                          
010400* IN-TRANSIT BALANCE TABLE                                                
010500*                                                                         
010600     EXEC SQL                                                             
010700          INCLUDE PCT00014                                                
010800     END-EXEC.                                                            
010900                                                                          
011000* IN-TRANSIT DETAIL TABLE                                                 
011100*                                                                         
011200     EXEC SQL                                                             
011300          INCLUDE PCT00015                                                
011400     END-EXEC.                                                            
011500                                                                          
011600     COPY DPWS004.                                                        
011700                                                                          
011800     EXEC SQL                                                             
011900         INCLUDE SQLCA                                                    
012000     END-EXEC.                                                            
012100     COPY SQLCA2.                                                         
012200/                                                                         
012300 PROCEDURE DIVISION.                                                      
012400                                                                          
012500     PERFORM 1000-INITIALIZE.                                             
012600                                                                          
012700     PERFORM 2000-PROCESS                                                 
012800             UNTIL PS-END-OF-FILE-YES                                     
012900                                                                          
013000     PERFORM 9000-QUIT.                                                   
013100                                                                          
013200     GOBACK.                                                              
013300                                                                          
013400 1000-INITIALIZE.                                                         
013500                                                                          
013600     ACCEPT PV-CKPT-JOB-NAME FROM SYSIN.                                  
013700     MOVE PC-OPEN-FUNC           TO DP001-FUNC-CODE.                      
013800                                                                          
013900     PERFORM 8000-READ-EXTRACT-FILE.                                      
014000     IF PS-END-OF-FILE-YES                                                
014100         DISPLAY ' INP01 FILE IS EMPTY'                                   
014200     END-IF.                                                              
014300                                                                          
014400     MOVE PC-TRANS-FUNC          TO DP001-FUNC-CODE.                      
014500     DISPLAY SPACES.                                                      
014600                                                                          
014700 2000-PROCESS.                                                            
014800                                                                          
014900     PERFORM 7000-FIND-DETAILS                                            
015000     IF PS-DETAIL-FOUND-NO                                                
015100         PERFORM 7100-DELETE-INTRANSIT-HEADER                             
015200     ELSE                                                                 
015300         DISPLAY 'EXISTING DETAIL FOR ' PV-DISP-KEY-MSG                   
015400                  ' ' PC900-LAST-UPD-DTE                                  
015500     END-IF                                                               
015600                                                                          
015700     PERFORM 8000-READ-EXTRACT-FILE.                                      
015800                                                                          
015900                                                                          
016000 7000-FIND-DETAILS.                                                       
016100     MOVE '7000-FIND-DETAILS'         TO PV-ABEND-PARAGRAPH.              
016200                                                                          
016300     SET PS-DETAIL-FOUND-NO           TO TRUE                             
016400                                                                          
016500     EXEC SQL                                                             
016600         SELECT 'Y'                                                       
016700         INTO                                                             
016800             :PS-DETAIL-FOUND-SW                                          
016900         FROM PCT_TRN_CLSN_DTL                                            
017000                                                                          
017100         WHERE                                                            
017200               INTR_UPC_ID  = :PC900-INTR-UPC-ID                          
017300           AND LOC_NBR      = :PC900-LOC-NBR                              
017400           AND TRN_CLSN_CDE = :PC900-TRN-CLSN-CDE                         
017500         FETCH FIRST 1 ROW ONLY                                           
017600     END-EXEC                                                             
017700                                                                          
017800     EVALUATE TRUE                                                        
017900         WHEN SQLCODE = ZERO                                              
018000             ADD 1                    TO PV-DTL-COUNTER                   
018100         WHEN SQLCODE = +100                                              
018200             CONTINUE                                                     
018300         WHEN SQLCODE = -904                                              
018400         WHEN SQLCODE = -911                                              
018500         WHEN SQLCODE = -913                                              
018600             DISPLAY '**************************************'             
018700             DISPLAY 'DB2 TIMEOUT ERROR                     '             
018800             DISPLAY 'SELECT PCT_TRN_CLSN_DTL               '             
018900             DISPLAY PV-DISP-KEY-MSG                                      
019000             DISPLAY '**************************************'             
019100             PERFORM 9100-SQL-ABEND                                       
019200                                                                          
019300         WHEN SQLCODE < ZERO                                              
019400             DISPLAY '**************************************'             
019500             DISPLAY 'ERROR ISSUED ON                       '             
019600             DISPLAY 'SELECT PCT_TRN_CLSN_DTL               '             
019700             DISPLAY PV-DISP-KEY-MSG                                      
019800             DISPLAY '**************************************'             
019900             PERFORM 9100-SQL-ABEND                                       
020000                                                                          
020100     END-EVALUATE.                                                        
020200                                                                          
020300 7100-DELETE-INTRANSIT-HEADER.                                            
020400     MOVE '7100-DELETE-INTRANSIT-HEADER' TO PV-ABEND-PARAGRAPH.           
020500                                                                          
020600     PERFORM                                                              
020700         WITH TEST AFTER                                                  
020800         VARYING PV-RETRY-COUNTER                                         
020900         FROM 1 BY 1                                                      
021000         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)                       
021100            OR  (SQLCODE = +100)                                          
021200            OR  (SQLCODE = +0))                                           
021300                                                                          
021400     EXEC SQL                                                             
021500                                                                          
021600         DELETE                                                           
021700             FROM                                                         
021800             PCT_TRN_CLSN_BAL                                             
021900                                                                          
022000         WHERE                                                            
022100               INTR_UPC_ID  = :PC900-INTR-UPC-ID                          
022200           AND LOC_NBR      = :PC900-LOC-NBR                              
022300           AND TRN_CLSN_CDE = :PC900-TRN-CLSN-CDE                         
022400     END-EXEC                                                             
022500                                                                          
022600     EVALUATE TRUE                                                        
022700         WHEN SQLCODE = ZERO                                              
022800             ADD +1                   TO PV-QTY-UPDATE-COUNTER            
022900         WHEN SQLCODE = +100                                              
023000             ADD 1                    TO PV-SKIP-COUNTER                  
023100         WHEN SQLCODE = -904                                              
023200         WHEN SQLCODE = -911                                              
023300         WHEN SQLCODE = -913                                              
023400             CONTINUE                                                     
023500                                                                  03340004
023600         WHEN (SQLCODE > ZERO OR SQLWARN0 = 'W')                  03350004
023700             DISPLAY '**************************************'     03360004
023800             DISPLAY 'WARNING ISSUED '                            03370004
023900             DISPLAY 'DELETE PCT_TRN_CLSN_BAL               '             
024000             DISPLAY PV-DISP-KEY-MSG                              03390004
024100             DISPLAY '**************************************'     03400004
024200             PERFORM 9800-SQL-WARNING                             03410004
024300                                                                  03420004
024400         WHEN SQLCODE < ZERO                                              
024500             DISPLAY '**************************************'             
024600             DISPLAY 'ERROR ISSUED ON                       '             
024700             DISPLAY 'DELETE PCT_TRN_CLSN_BAL               '             
024800             DISPLAY PV-DISP-KEY-MSG                                      
024900             DISPLAY '**************************************'             
025000             PERFORM 9100-SQL-ABEND                                       
025100         END-EVALUATE                                                     
025200                                                                          
025300     END-PERFORM.                                                         
025400                                                                          
025500     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                    03540004
025600         SQLCODE NOT = ZERO AND SQLCODE NOT = +100                03550004
025700             DISPLAY '**************************************'             
025800             DISPLAY 'DB2 TIMEOUT ERROR                     '             
025900             DISPLAY 'DELETE PCT_TRN_CLSN_BAL               '             
026000             DISPLAY PV-DISP-KEY-MSG                                      
026100             DISPLAY '**************************************'             
026200             PERFORM 9100-SQL-ABEND                                       
026300     END-IF.                                                      03620004
026400/                                                                         
026500 8000-READ-EXTRACT-FILE.                                                  
026600                                                                          
026700     MOVE LENGTH OF PC900-EXTRACT-RECORD                                  
026800                                     TO DP001-WORK-STRG-LENGTH.           
026900     MOVE PV-CKPT-JOB-NAME           TO DP001-JOB-NAME.                   
027000     MOVE PC-CKPT-PLAN-NAME          TO DP001-PLAN-NAME.                  
027100                                                                          
027200     PERFORM Z900-CALL-TRANS-PRES-MODULE.                                 
027300                                                                          
027400     MOVE DP001-TRANS-RECORD  TO PC900-EXTRACT-RECORD                     
027500                                                                          
027600     IF DP001-PREP-TRANS-EOF                                              
027700         SET PS-END-OF-FILE-YES       TO TRUE                             
027800     ELSE                                                                 
027900         ADD 1                        TO PV-READ-COUNTER                  
028000                                         PV-DISP-CONTROL                  
028100         MOVE PC900-INTR-UPC-ID       TO PV-UPC-TEN                       
028200         MOVE PV-UPC-TEN              TO PV-KEY-INTR-UPC-ID               
028300         MOVE PC900-LOC-NBR           TO PV-KEY-LOC-NBR                   
028400         MOVE PC900-TRN-CLSN-CDE      TO PV-KEY-CLSN-CDE                  
028500         MOVE PC900-TRN-CLSN-QTY      TO PV-KEY-BAL-QTY                   
028600                                                                          
028700         IF PV-DISP-CONTROL > 999999                                      
028800             EXEC SQL                                                     
028900                 SELECT CURRENT TIME                                      
029000                 INTO :PV-TIME                                            
029100                 FROM SYSIBM.SYSDUMMY1                                    
029200             END-EXEC                                                     
029300             MOVE PV-READ-COUNTER     TO PV-DISP-NBR                      
029400             DISPLAY PV-TIME                                              
029500             ' PROCESSING REC # ' PV-DISP-NBR                             
029600             ' / '     PV-DISP-KEY-MSG                                    
029700             MOVE ZERO                TO PV-DISP-CONTROL                  
029800         END-IF                                                           
029900                                                                          
030000     END-IF.                                                              
030100/                                                                         
030200 9000-QUIT.                                                               
030300                                                                          
030400     DISPLAY SPACES.                                                      
030500                                                                          
030600     MOVE PC-CLOSE-FUNC               TO DP001-FUNC-CODE.                 
030700     PERFORM 8000-READ-EXTRACT-FILE.                                      
030800                                                                          
030900     MOVE PV-READ-COUNTER             TO PV-DISP-NBR                      
031000     DISPLAY 'RECORDS READ               = ' PV-DISP-NBR                  
031100                                                                          
031200     MOVE PV-QTY-UPDATE-COUNTER       TO PV-DISP-NBR                      
031300     DISPLAY 'PCT_TRN_CLSN_BAL DELETES   = '  PV-DISP-NBR                 
031400                                                                          
031500     MOVE PV-SKIP-COUNTER          TO PV-DISP-NBR                         
031600     DISPLAY 'DELETES SKIPPED            = '  PV-DISP-NBR.                
031700                                                                          
031800     MOVE PV-DTL-COUNTER              TO PV-DISP-NBR                      
031900     DISPLAY 'BALANCES WITH DETAILS      = '  PV-DISP-NBR.                
032000/                                                                         
032100 9100-SQL-ABEND.                                                          
032200******************************************************************        
032300*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL            
032400*  ERROR OR WARNING CODE OCCURS.                                          
032500******************************************************************        
032600     DISPLAY '9100-SQL-ABEND'.                                            
032700     DISPLAY '** ABEND     **'.                                           
032800     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.                
032900     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.                     
033000     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.             
033100     DISPLAY '** INTR-UPC-ID  = ' PV-KEY-INTR-UPC-ID                      
033200     DISPLAY '** LOC-NBR      ** = ' PV-KEY-LOC-NBR                       
033300     DISPLAY '**              ** = '                                      
033400     MOVE SQLCODE TO PV-SQL-CODE.                                         
033500     DISPLAY '** SQL CODE  ** = ' PV-SQL-CODE.                            
033600     MOVE +4013 TO ABEND-CODE.                                            
033700     CALL 'ILBOABN0' USING ABEND-CODE.                                    
033800/                                                                         
033900                                                                  07710004
034000 9800-SQL-WARNING.                                                07720004
034100                                                                  07730004
034200     MOVE SQLCODE               TO SQLCODE2.                      07740004
034300     MOVE SQLERRD(3)            TO SQLERRD3.                      07750004
034400     DISPLAY '** ABEND **       ** = SQLWARNING'.                 07760004
034500     DISPLAY '** PROGRAM        ** = PCKUP904'.                   07770004
034600     DISPLAY '** PARAGRAPH      ** = ' PV-ABEND-PARAGRAPH.        07780004
034700     DISPLAY '** SQLCODE        ** = ' SQLCODE2.                  07790004
034800     DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                  07800004
034900                                                                  07810004
035000     COPY DPPD004.                                                07820004
035100     MOVE +4013 TO ABEND-CODE.                                            
035200     CALL 'ILBOABN0' USING ABEND-CODE.                            07840004
035300                                                                  07850004
035400*    PRESENTATION MODULE (CHECKPOINT RESTART)                             
035500     COPY DPPD001.                                                        
