000100******************************************************************00080003
000200 IDENTIFICATION DIVISION.                                         00010003
000300******************************************************************00080003
000400 PROGRAM-ID.    XSKUP064.                                         00020003
000500 AUTHOR.        KOHLS DEPARTMENT STORES.                          00030003
000600 INSTALLATION.  SANDY POTTER.                                     00040003
000700 DATE-WRITTEN.  03/20/2003.                                       00050003
000800                                                                  00070003
000900******************************************************************00080003
001000*   THIS PROGRAM IS CALLED FROM XSKUT012 TO UPDATE AND/OR INSERT  00110003
001100*   TO THE TABLE (XST_SKU_LOC) WHEN A COST CHANGE (070) MESSAGE   00120003
001100*   IS READ FROM THE XS DOMAIN ITEM QUEUE.                        00120003
001200******************************************************************00150003
001300                                                                  00160003
001400******************************************************************00150003
001500 ENVIRONMENT DIVISION.                                            00170003
001600******************************************************************00150003
001700 CONFIGURATION SECTION.                                           00180003
001800 SOURCE-COMPUTER.  IBM-3090.                                      00190003
001900 OBJECT-COMPUTER.  IBM-3090.                                      00200003
002000 DATA DIVISION.                                                   00210003
002100                                                                  00220003
002200 WORKING-STORAGE SECTION.                                         00230003
002300******************************************************************00240003
002400*    PROGRAM SWITCHES.                                            00250003
002500******************************************************************00260003
002600 01  PS-PROGRAM-SWITCHES.                                         00270003
002700     05  PS-CONTINUE-SW               PIC  X(01) VALUE 'Y'.       00280003
002800         88  PS-CONTINUE                         VALUE 'Y'.       00290003
002900         88  PS-STOP                             VALUE 'N'.       00300003
003000     05  PS-ACTION-IND                PIC  9(02) VALUE 00.        00310003
003100         88  PS-ACTION-REVERSE                   VALUE 01.        00320003
003200         88  PS-ACTION-NOTHING                   VALUE 02.        00340003
002700     05  PS-SKULOC-UPDATE-SW          PIC  X(01) VALUE 'N'.       00280003
002900         88  PS-NO-SKULOC-UPDATE                 VALUE 'N'.       00300003
002800         88  PS-FUTURE-UPDATE                    VALUE 'F'.       00290003
002800         88  PS-SKULOC-UPDATE                    VALUE 'U'.       00290003
002800         88  PS-SKULOC-INSERT                    VALUE 'I'.       00290003
002700     05  PS-SKULOC-CSR-SW             PIC  X(01) VALUE 'N'.       00280003
002800         88  PS-MORE-SKULOC-CSR                  VALUE 'Y'.       00290003
002900         88  PS-END-OF-SKULOC-CSR                VALUE 'N'.       00300003
003300                                                                  00350003
003400******************************************************************00350003
003500*    PROGRAM CONSTANTS.                                           00360003
003600******************************************************************00370003
003700 01  PC-PROGRAM-VARIABLES.                                        00380003
003800     05  PC-MAX-RETRIES               PIC  9(01) VALUE 3.         00390003
003800     05  PC-YES                       PIC  X(01) VALUE 'Y'.       00390003
003800     05  PC-NO                        PIC  X(01) VALUE 'N'.       00390003
003900                                                                  00400003
004000******************************************************************00350003
004100*    PROGRAM VARIABLES.                                           00360003
004200******************************************************************00370003
004300     05  PV-RETRY-CNT                 PIC  9(01) VALUE ZEROS.     00400003
004400     05  PV-PARAGRAPH-NAME            PIC  X(30) VALUE SPACE.     00450003
003000     05  PV-END-TMST-IND              PIC S9(04) VALUE +0 COMP.   00310003
003100         88  PV-END-TMST-NULL                    VALUE -1.        00320003
003000     05  PV-GP-PRICE-IND              PIC S9(04) VALUE +0 COMP.   00310003
003000     05  PV-GP-QTY-IND                PIC S9(04) VALUE +0 COMP.   00310003
003000     05  PV-GP-AMT-IND                PIC S9(04) VALUE +0 COMP.   00310003
003000     05  PV-MKDN-CDE-IND              PIC S9(04) VALUE +0 COMP.   00310003
003000     05  PV-ORIG-CLR-DTE-IND          PIC S9(04) VALUE +0 COMP.   00310003
           05  PV-RETURN-SQLCODE            PIC S9(04) VALUE ZEROS.     SQLCA2  
004700     05  PV-CONVERT-UPC-ID            PIC S9(10) COMP VALUE ZEROS.        
004800                                                                  00350003
004700     05  PV-SAVE-MSG-DATA.                                        00520003
004700         10 PV-MSG-INTR-UPC-ID        PIC S9(09) COMP.                    
004700         10 PV-MSG-UNT-COST-AMT       PIC S9(7)V9(3) COMP-3.              
004700         10 PV-MSG-BEG-TMST           PIC  X(26).                         
004700         10 PV-MSG-SOR-LAST-MSG-TMST  PIC  X(26).                         
                                                                        01360003
004700     05  PV-SAVE-FETCH-DATA.                                      00520003
004700         10 PV-INTR-UPC-ID            PIC S9(09) COMP.                    
004700         10 PV-LOC-NBR                PIC S9(04) COMP.                    
004700         10 PV-BEG-TMST               PIC  X(26).                         
004700         10 PV-END-TMST               PIC  X(26).                         
004700         10 PV-UNT-RTL-AMT            PIC S9(7)V9(2) COMP-3.              
004700         10 PV-UNT-COST-AMT           PIC S9(7)V9(3) COMP-3.              
004700         10 PV-LOC-SKU-STAT-CDE       PIC  X(02).                         
004700         10 PV-UPC-STAT-CHG-DTE       PIC  X(10).                         
004700         10 PV-UNT-RTL-CHG-DTE        PIC  X(10).                         
004700         10 PV-GP-PRIC-ID             PIC S9(09) COMP.                    
004700         10 PV-GP-RTL-QTY             PIC S9(04) COMP.                    
004700         10 PV-GP-RTL-AMT             PIC S9(7)V9(2) COMP-3.              
004700         10 PV-LAST-UPD-TMST          PIC  X(26).                         
004700         10 PV-SOR-LAST-MSG-TMST      PIC  X(26).                         
004700         10 PV-MKDN-CDE               PIC  X(01).                         
004700         10 PV-ORIG-CLR-DTE           PIC  X(10).                         
004800                                                                  00350003
004900******************************************************************00530003
005000*    ABEND COPYBOOKS                                              00540003
005100******************************************************************00550003
005200     COPY DPWS004.                                                00570003
005300                                                                  00580003
005400******************************************************************00530003
005500*    DB2 MESSAGE AREA                                             00540003
005600******************************************************************00550003
005700     COPY SQLCA2.                                                 00590003
005800                                                                  00600003
005900******************************************************************00530003
006000*    ITEM COPYBOOK                                                00540003
006100******************************************************************00550003
006200     COPY IMRD008.                                                00610003
006300                                                                  00600003
006400******************************************************************00620003
006500*    DB2 COMMUNICATION AREA                                       00630003
006600******************************************************************00640003
006700     EXEC SQL                                                     00660003
006800          INCLUDE SQLCA                                           00670003
006900     END-EXEC.                                                    00680003
007000                                                                  00690003
007100******************************************************************00620003
007200*    XST_SKU_LOC TABLE                                            00630003
007300******************************************************************00640003
007400     EXEC SQL                                                     00700003
007500         INCLUDE XST00008                                         00710003
007600     END-EXEC.                                                    00720003
021796                                                                          
007100******************************************************************00620003
007200*    CURSOR FOR SELECTING THE SKU LOCATION ROW IN EFFECT WHEN THIS00630003
007200*    COST CHANGE TAKES EFFECT, BUT NOT TAKING EFFECT AT EXACTLY   00630003
007200*    THE SAME TIME AS THIS CHANGE.  IF THERE IS RCP, MANY ROWS    00630003
007200*    MAY BE FETCHED.  A COST CHANGE IMPACTS CORPORATE PRICING     00630003
007200*    AND ANY STORE SPECIFIC PRICING.                              00630003
007300******************************************************************00640003
021801*-----------------------------------------------------------              
021802     EXEC SQL                                                             
021803       DECLARE SKULOC-CSR CURSOR FOR                                      
013600           SELECT INTR_UPC_ID                                     01390003
013600                 ,LOC_NBR                                         01390003
013600                 ,BEG_TMST                                        01390003
013600                 ,END_TMST                                        01390003
013600                 ,UNT_RTL_AMT                                     01390003
013600                 ,UNT_COST_AMT                                    01390003
013600                 ,LOC_SKU_STAT_CDE                                01390003
013600                 ,UPC_STAT_CHG_DTE                                01390003
013600                 ,UNT_RTL_CHG_DTE                                 01390003
013600                 ,GP_PRIC_ID                                      01390003
013600                 ,GP_RTL_QTY                                      01390003
013600                 ,GP_RTL_AMT                                      01390003
013600                 ,LAST_UPD_TMST                                   01390003
013600                 ,SOR_LAST_MSG_TMST                               01390003
013600                 ,MKDN_CDE                                        01390003
013600                 ,ORIG_CLR_DTE                                    01390003
013600             FROM XST_SKU_LOC                                     01390003
013700            WHERE INTR_UPC_ID = :PV-MSG-INTR-UPC-ID               01400003
013700              AND BEG_TMST    < :PV-MSG-BEG-TMST                  01400003
013700              AND (END_TMST  IS NULL                              01400003
013700               OR  END_TMST  >= :PV-MSG-BEG-TMST)                 01400003
021858***         WITH UR                                                       
021859     END-EXEC.                                                            
007700                                                                  00730003
007800******************************************************************00750003
007900 LINKAGE SECTION.                                                 00740003
008000******************************************************************00770003
008100 01  LV-IMRD008-RECORD                PIC  X(450).                00780003
008200 01  LV-RETURN-CODE                   PIC S9(04).                 00790003
008300 01  LV-ACTION-IND                    PIC  9(02).                 00800003
008400 01  LV-CURRENT-TIMESTAMP             PIC  X(26).                 00810003
008500                                                                  00820003
008600******************************************************************00870003
008700 PROCEDURE DIVISION USING LV-IMRD008-RECORD,                      00830003
008800                          LV-RETURN-CODE,                         00840003
008900                          LV-ACTION-IND,                          00850003
009000                          LV-CURRENT-TIMESTAMP.                   00860003
009100******************************************************************00870003
009200 0000-MAINLINE.                                                   00880003
009300                                                                  00890003
009400      PERFORM 1000-INITIALIZATION.                                00900003
009500                                                                  00890003
009600      PERFORM 2000-PROCESS-MESSAGE.                               00910003
009800                                                                  00890003
009900      PERFORM 9999-WRAPUP.                                        00930003
010000                                                                  00940003
010100***************************************************************** 00950003
010200 1000-INITIALIZATION.                                             00980003
010400***************************************************************** 00970003
010500                                                                  00990003
010600     SET PS-CONTINUE                   TO TRUE.                   01020003
010600     SET PS-NO-SKULOC-UPDATE           TO TRUE.                   01020003
010700                                                                  00990003
010800     INITIALIZE PV-RETRY-CNT                                      01030003
010800                PV-RETURN-SQLCODE                                 01030003
010800                PV-SAVE-FETCH-DATA                                01030003
010800                PV-SAVE-MSG-DATA                                  01030003
010800                DCLXST00008.                                      01030003
010900                                                                  01040003
011000     MOVE LV-IMRD008-RECORD            TO IMRD008-RECORD.         01050003
                                                                                
      *    * MOVE TO CONVERT FIELD FIRST BECAUSE OF COMP CONVERSION *           
      *    * ISSUES WITH THE COBOL COMPILER.                        *           
011300     MOVE IM008-ITEM-KEY-INTR-UPC-ID   TO PV-CONVERT-UPC-ID.      01080003
011300     MOVE PV-CONVERT-UPC-ID            TO XST00008-INTR-UPC-ID.   01080003
013300     MOVE IM008-LAND-COST-LAND-COST-N  TO XST00008-UNT-COST-AMT.  01360003
013300     MOVE IM008-LAND-COST-EFF-BEG-TMST TO XST00008-BEG-TMST.      01360003
013300     MOVE IM008-CRE-TMST               TO                         01360003
                XST00008-SOR-LAST-MSG-TMST.                             01360003
                                                                                
011300     MOVE PV-CONVERT-UPC-ID            TO PV-MSG-INTR-UPC-ID.     01080003
013300     MOVE IM008-LAND-COST-LAND-COST-N  TO PV-MSG-UNT-COST-AMT.    01360003
013300     MOVE IM008-LAND-COST-EFF-BEG-TMST TO PV-MSG-BEG-TMST.        01360003
013300     MOVE IM008-CRE-TMST               TO                         01360003
                PV-MSG-SOR-LAST-MSG-TMST.                               01360003
011100                                                                  01060003
011800***************************************************************** 01170003
011900 2000-PROCESS-MESSAGE.                                            01200003
011900*     IF ANY UNACCEPTABLE SQL CODE IS ENCOUNTERED, A SWITCH IS    01200003
011900*     SET SO THAT SUBSEQUENT PROCESSING CAN BE BYPASSED.  THIS    01200003
011900*     IS WHY EACH STEP IS ENCLOSED IN AN 'IF CONTINUE' STATEMENT. 01200003
012100***************************************************************** 01190003
012200                                                                  01210003
           PERFORM 2100-UPDATE-FUTURE.                                          
                                                                                
           IF PS-CONTINUE                                                       
              SET PS-MORE-SKULOC-CSR TO TRUE                                    
              PERFORM 3000-OPEN-SKULOC-CSR                                      
           END-IF.                                                              
                                                                                
           IF PS-CONTINUE                                                       
              PERFORM 3100-FETCH-SKULOC-CSR                                     
           END-IF.                                                              
                                                                                
           IF PS-CONTINUE                                                       
025900        PERFORM 2200-PROCESS-SKULOC                                       
026000                UNTIL PS-END-OF-SKULOC-CSR                                
                      OR PS-STOP                                                
           END-IF.                                                              
                                                                                
           IF PS-CONTINUE                                                       
              PERFORM 3200-CLOSE-SKULOC-CSR                                     
           END-IF.                                                      01240003
                                                                                
      *    * IF NO UPDATE OR INSERT WAS PERFORMED, BUT THERE WAS NOT A *01200003
      *    * BAD SQLCODE, FORCE THE RETURN SQLCODE TO BE 999 BECAUSE   *01200003
      *    * NO ACTION WAS ACTUALLY PERFORMED FOR THIS MESSAGE.        *01200003
           IF PS-CONTINUE  AND                                                  
              PS-NO-SKULOC-UPDATE                                               
              SET PS-STOP                 TO TRUE                               
              MOVE 999                    TO PV-RETURN-SQLCODE                  
              MOVE '2000-PROCESS-MESSAGE' TO PV-PARAGRAPH-NAME                  
           END-IF.                                                      01240003
                                                                                
      *    * IF A BAD SQLCODE WAS ENCOUNTERED, DISPLAY MESSAGES TO AID *01200003
      *    * TROUBLESHOOTING BEFORE RETURNING TO THE CALLING PROGRAM. * 01200003
           IF PS-STOP                                                           
              DISPLAY 'XSKUP064 RETURNING NON-ZERO SQLCODE FOR '                
                      IM008-ITEM-KEY-INTR-UPC-ID                                
              DISPLAY 'FROM PARAGRAPH ' PV-PARAGRAPH-NAME                       
           END-IF.                                                      01240003
015400                                                                  01570003
012500***************************************************************** 01270003
013100 2100-UPDATE-FUTURE.                                              01330003
012600*     UPDATES THE UNIT COST AMOUNT FOR ANY FUTURE PRICE CHANGES   01280003
012600*     (FUTURE MEANING EFFECTIVE LATER TODAY OR TOMORROW).  IF     01280003
012600*     A PRICE CHANGE ALREADY EXISTS IN THE TABLE WITH THE EXACT   01280003
012600*     SAME BEGIN TIMESTAMP, THIS UPDATES THE UNIT COST AMOUNT ON  01280003
012600*     THAT ROW AS WELL.                                           01280003
013000***************************************************************** 01320003
013200                                                                  01350003
013500     PERFORM                                                      01380003
013500        WITH TEST AFTER                                           01380003
013500        VARYING PV-RETRY-CNT                                      01380003
013500        FROM 1 BY 1                                               01380003
013500        UNTIL PS-STOP                                             01380003
013500           OR SQLCODE = ZERO                                      01380003
013500           OR SQLCODE = +100                                      01380003
013600                                                                  01390003
013500        EXEC SQL                                                  01380003
013600           UPDATE XST_SKU_LOC                                     01390003
013300              SET UNT_COST_AMT      = :XST00008-UNT-COST-AMT      01360003
013600                 ,LAST_UPD_TMST     = CURRENT TIMESTAMP           01390003
013600                 ,SOR_LAST_MSG_TMST = :XST00008-SOR-LAST-MSG-TMST 01390003
013700            WHERE INTR_UPC_ID       = :XST00008-INTR-UPC-ID       01400003
013700             AND  BEG_TMST         >= :XST00008-BEG-TMST          01400003
013700             AND (END_TMST         IS NULL                        01400003
013700              OR  END_TMST          > :XST00008-BEG-TMST)         01400003
013800        END-EXEC                                                  01410003
013900                                                                  01420003
014000        EVALUATE TRUE                                             01430003
014200           WHEN SQLCODE = ZERO                                    01450003
                    SET PS-FUTURE-UPDATE    TO TRUE                             
014500           WHEN SQLCODE = +100                                    01480003
014300              CONTINUE                                            01460003
014500           WHEN SQLCODE = -904                                    01480003
014500           WHEN SQLCODE = -911                                    01480003
014500           WHEN SQLCODE = -913                                    01480003
014600              IF PV-RETRY-CNT >= PC-MAX-RETRIES                   01490003
014700                 SET PS-STOP          TO TRUE                     01500003
014700                 MOVE SQLCODE         TO PV-RETURN-SQLCODE        01500003
013300                 MOVE '2100-UPDATE-FUTURE'                        01360003
013300                                      TO PV-PARAGRAPH-NAME        01360003
015000              END-IF                                              01530003
015100           WHEN OTHER                                             01540003
014700              SET PS-STOP             TO TRUE                     01500003
014700              MOVE SQLCODE            TO PV-RETURN-SQLCODE        01500003
013300              MOVE '2100-UPDATE-FUTURE'                           01360003
013300                                      TO PV-PARAGRAPH-NAME        01360003
015300        END-EVALUATE                                              01560003
015300     END-PERFORM.                                                 01560003
015400                                                                  01570003
012500***************************************************************** 01270003
025900 2200-PROCESS-SKULOC.                                                     
012500***************************************************************** 01270003
013200                                                                  01350003
013600     MOVE DCLXST00008  TO PV-SAVE-FETCH-DATA.                     01390003
                                                                                
           PERFORM 2300-UPDATE-FETCHED-SKULOC.                                  
                                                                                
           IF PS-CONTINUE                                                       
              PERFORM 2400-INSERT-NEW-SKULOC                                    
           END-IF.                                                              
                                                                                
           IF PS-CONTINUE                                                       
              PERFORM 3100-FETCH-SKULOC-CSR                                     
           END-IF.                                                              
                                                                                
012500***************************************************************** 01270003
013100 2300-UPDATE-FETCHED-SKULOC.                                      01330003
012600*     PERFORM AN UPDATE TO END THE CURRENT ROW IN SKU LOCATION    01280003
012600*     TABLE.                                                      01280003
013000***************************************************************** 01320003
013200                                                                  01350003
013500     MOVE PV-MSG-SOR-LAST-MSG-TMST    TO                          01380003
013500          XST00008-SOR-LAST-MSG-TMST.                             01380003
013200                                                                  01350003
013500     PERFORM                                                      01380003
013500        WITH TEST AFTER                                           01380003
013500        VARYING PV-RETRY-CNT                                      01380003
013500        FROM 1 BY 1                                               01380003
013500        UNTIL PS-STOP                                             01380003
013500          OR  SQLCODE = ZERO                                      01380003
013600                                                                  01390003
013500        EXEC SQL                                                  01380003
013600           UPDATE XST_SKU_LOC                                     01390003
013600              SET END_TMST          = TIMESTAMP                   01390003
013600                  (:PV-MSG-BEG-TMST) - 1 MICROSECOND              01390003
013600                 ,LAST_UPD_TMST     = CURRENT TIMESTAMP           01390003
013600                 ,SOR_LAST_MSG_TMST = :XST00008-SOR-LAST-MSG-TMST 01390003
013700            WHERE INTR_UPC_ID = :XST00008-INTR-UPC-ID             01400003
013700              AND LOC_NBR     = :XST00008-LOC-NBR                 01400003
013700              AND BEG_TMST    = :XST00008-BEG-TMST                01400003
013800        END-EXEC                                                  01410003
013900                                                                  01420003
014000        EVALUATE TRUE                                             01430003
014200           WHEN SQLCODE = ZERO                                    01450003
                    SET PS-SKULOC-UPDATE    TO TRUE                             
014500           WHEN SQLCODE = -904                                    01480003
014500           WHEN SQLCODE = -911                                    01480003
014500           WHEN SQLCODE = -913                                    01480003
014600              IF PV-RETRY-CNT >= PC-MAX-RETRIES                   01490003
014700                 SET PS-STOP          TO TRUE                     01500003
014700                 MOVE SQLCODE         TO PV-RETURN-SQLCODE        01500003
013300                 MOVE '2300-UPDATE-FETCHED-SKULOC'                01360003
013300                                      TO PV-PARAGRAPH-NAME        01360003
015000              END-IF                                              01530003
015100           WHEN OTHER                                             01540003
014700              SET PS-STOP             TO TRUE                     01500003
014700              MOVE SQLCODE            TO PV-RETURN-SQLCODE        01500003
013300              MOVE '2300-UPDATE-FETCHED-SKULOC'                   01360003
013300                                      TO PV-PARAGRAPH-NAME        01360003
015300        END-EVALUATE                                              01560003
015300     END-PERFORM.                                                 01560003
015400                                                                  01570003
012500***************************************************************** 01270003
013100 2400-INSERT-NEW-SKULOC.                                          01330003
012600*     INSERT A NEW ROW INTO SKU LOCATION TABLE.                   01280003
013000***************************************************************** 01320003
013200                                                                  01350003
013300     MOVE PV-SAVE-FETCH-DATA          TO DCLXST00008.             01360003
013500     MOVE PV-MSG-UNT-COST-AMT         TO XST00008-UNT-COST-AMT.   01380003
013500     MOVE PV-MSG-BEG-TMST             TO XST00008-BEG-TMST.       01380003
013500     MOVE PV-MSG-SOR-LAST-MSG-TMST    TO                          01380003
013500          XST00008-SOR-LAST-MSG-TMST.                             01380003
013300                                                                  01360003
013500     PERFORM                                                      01380003
013500        WITH TEST AFTER                                           01380003
013500        VARYING PV-RETRY-CNT                                      01380003
013500        FROM 1 BY 1                                               01380003
013500        UNTIL PS-STOP                                             01380003
013500          OR  SQLCODE = ZERO                                      01380003
013600                                                                  01390003
013500        EXEC SQL                                                  01380003
013600           INSERT INTO XST_SKU_LOC                                01390003
013600              ( INTR_UPC_ID                                       01390003
013700               ,LOC_NBR                                           01400003
013700               ,BEG_TMST                                          01400003
013700               ,END_TMST                                          01400003
013700               ,UNT_RTL_AMT                                       01400003
013800               ,UNT_COST_AMT                                      01410003
013800               ,LOC_SKU_STAT_CDE                                  01410003
013800               ,UPC_STAT_CHG_DTE                                  01410003
013800               ,UNT_RTL_CHG_DTE                                   01410003
013800               ,GP_PRIC_ID                                        01410003
013900               ,GP_RTL_QTY                                        01420003
013900               ,GP_RTL_AMT                                        01420003
013900               ,LAST_UPD_TMST                                     01420003
013900               ,SOR_LAST_MSG_TMST                                 01420003
013900               ,MKDN_CDE                                          01420003
013900               ,ORIG_CLR_DTE)                                     01420003
013900           VALUES                                                 01420003
013600              ( :XST00008-INTR-UPC-ID                             01390003
013700               ,:XST00008-LOC-NBR                                 01400003
013700               ,:XST00008-BEG-TMST                                01400003
013700               ,:XST00008-END-TMST :PV-END-TMST-IND               01400003
013700               ,:XST00008-UNT-RTL-AMT                             01400003
013800               ,:XST00008-UNT-COST-AMT                            01410003
013800               ,:XST00008-LOC-SKU-STAT-CDE                        01410003
013800               ,:XST00008-UPC-STAT-CHG-DTE                        01410003
013800               ,:XST00008-UNT-RTL-CHG-DTE                         01410003
013800               ,:XST00008-GP-PRIC-ID :PV-GP-PRICE-IND             01410003
013900               ,:XST00008-GP-RTL-QTY :PV-GP-QTY-IND               01420003
013900               ,:XST00008-GP-RTL-AMT :PV-GP-AMT-IND               01420003
013900               ,CURRENT TIMESTAMP                                 01420003
013900               ,:XST00008-SOR-LAST-MSG-TMST                       01420003
013900               ,:XST00008-MKDN-CDE     :PV-MKDN-CDE-IND           01420003
013900               ,:XST00008-ORIG-CLR-DTE :PV-ORIG-CLR-DTE-IND)      01420003
014000        END-EXEC                                                  01430003
014000                                                                  01430003
014000        EVALUATE TRUE                                             01430003
014200           WHEN SQLCODE = ZERO                                    01450003
                    SET PS-SKULOC-INSERT    TO TRUE                             
014500           WHEN SQLCODE = -904                                    01480003
014500           WHEN SQLCODE = -911                                    01480003
014500           WHEN SQLCODE = -913                                    01480003
014600              IF PV-RETRY-CNT >= PC-MAX-RETRIES                   01490003
014700                 SET PS-STOP          TO TRUE                     01500003
014700                 MOVE SQLCODE         TO PV-RETURN-SQLCODE        01500003
013300                 MOVE '2400-INSERT-NEW-SKULOC'                    01360003
013300                                      TO PV-PARAGRAPH-NAME        01360003
015000              END-IF                                              01530003
015100           WHEN OTHER                                             01540003
014700              SET PS-STOP             TO TRUE                     01500003
014700              MOVE SQLCODE            TO PV-RETURN-SQLCODE        01500003
013300              MOVE '2400-INSERT-NEW-SKULOC'                       01360003
013300                                      TO PV-PARAGRAPH-NAME        01360003
015300        END-EVALUATE                                              01560003
015300     END-PERFORM.                                                 01560003
015400                                                                  01570003
012500***************************************************************** 01270003
013100 3000-OPEN-SKULOC-CSR.                                            01330003
012600*     OPENS THE SKULOC CURSOR.                                    01280003
013000***************************************************************** 01320003
028389                                                                          
028390     PERFORM                                                              
028391        WITH TEST AFTER                                                   
028392        VARYING PV-RETRY-CNT                                              
028393        FROM 1 BY 1                                                       
028394        UNTIL PS-STOP                                                     
028395          OR  SQLCODE = ZERO                                              
028396                                                                          
028397        EXEC SQL                                                          
028398           OPEN SKULOC-CSR                                                
028399        END-EXEC                                                          
028400                                                                          
028401        EVALUATE TRUE                                                     
028402           WHEN SQLCODE = -904                                            
028403           WHEN SQLCODE = -911                                            
028404           WHEN SQLCODE = -913                                            
028418              IF PV-RETRY-CNT       >= PC-MAX-RETRIES                     
014700                 SET PS-STOP        TO TRUE                       01500003
014700                 MOVE SQLCODE       TO PV-RETURN-SQLCODE          01500003
028419                 MOVE '3000-OPEN-SKULOC-CSR'                              
028419                                    TO PV-PARAGRAPH-NAME                  
028424              END-IF                                                      
028406           WHEN SQLCODE = 0                                               
028407              CONTINUE                                                    
028409           WHEN SQLCODE NOT EQUAL ZERO                                    
014700              SET PS-STOP          TO TRUE                        01500003
014700              MOVE SQLCODE         TO PV-RETURN-SQLCODE           01500003
028410              MOVE '3000-OPEN-SKULOC-CSR'                                 
028411                                   TO PV-PARAGRAPH-NAME                   
028415        END-EVALUATE                                                      
028416     END-PERFORM.                                                         
028428                                                                          
012500***************************************************************** 01270003
028433 3100-FETCH-SKULOC-CSR.                                                   
028431*     FETCH A ROW FROM THE SKULOC-CSR                                     
012500***************************************************************** 01270003
028434                                                                          
028435     PERFORM                                                              
028436        WITH TEST AFTER                                                   
028437        VARYING PV-RETRY-CNT                                              
028438        FROM 1 BY 1                                                       
028439        UNTIL PS-STOP                                                     
028440          OR  SQLCODE = 0                                                 
028441          OR  SQLCODE = +100                                              
028442                                                                          
028443        EXEC SQL                                                          
028444           FETCH SKULOC-CSR                                               
013600            INTO :XST00008-INTR-UPC-ID                            01390003
013600                ,:XST00008-LOC-NBR                                01390003
013600                ,:XST00008-BEG-TMST                               01390003
013600                ,:XST00008-END-TMST :PV-END-TMST-IND              01390003
013600                ,:XST00008-UNT-RTL-AMT                            01390003
013600                ,:XST00008-UNT-COST-AMT                           01390003
013600                ,:XST00008-LOC-SKU-STAT-CDE                       01390003
013600                ,:XST00008-UPC-STAT-CHG-DTE                       01390003
013600                ,:XST00008-UNT-RTL-CHG-DTE                        01390003
013600                ,:XST00008-GP-PRIC-ID :PV-GP-PRICE-IND            01390003
013600                ,:XST00008-GP-RTL-QTY :PV-GP-QTY-IND              01390003
013600                ,:XST00008-GP-RTL-AMT :PV-GP-AMT-IND              01390003
013600                ,:XST00008-LAST-UPD-TMST                          01390003
013600                ,:XST00008-SOR-LAST-MSG-TMST                      01390003
013600                ,:XST00008-MKDN-CDE     :PV-MKDN-CDE-IND          01390003
013600                ,:XST00008-ORIG-CLR-DTE :PV-ORIG-CLR-DTE-IND      01390003
028452        END-EXEC                                                          
028453                                                                          
028454        EVALUATE TRUE                                                     
028455           WHEN SQLCODE = -904                                            
028456           WHEN SQLCODE = -911                                            
028457           WHEN SQLCODE = -913                                            
028474              IF  PV-RETRY-CNT >= PC-MAX-RETRIES                          
014700                 SET PS-STOP           TO TRUE                    01500003
014700                 MOVE SQLCODE          TO PV-RETURN-SQLCODE       01500003
028475                 MOVE '3100-FETCH-SKULOC-CSR'                             
028475                                       TO PV-PARAGRAPH-NAME               
028480              END-IF                                                      
028459           WHEN SQLCODE = ZERO                                            
028460              CONTINUE                                                    
028461           WHEN SQLCODE = +100                                            
028462              SET PS-END-OF-SKULOC-CSR TO TRUE                            
028464           WHEN SQLCODE NOT EQUAL ZERO                                    
014700              SET PS-STOP              TO TRUE                    01500003
014700              MOVE SQLCODE             TO PV-RETURN-SQLCODE       01500003
028465              MOVE '3100-FETCH-SKULOC-CSR'                                
028466                                       TO PV-PARAGRAPH-NAME               
028471        END-EVALUATE                                                      
028472     END-PERFORM.                                                         
028484                                                                          
012500***************************************************************** 01270003
028489 3200-CLOSE-SKULOC-CSR.                                                   
028487*     CLOSE THE SKULOC CURSOR.                                            
012500***************************************************************** 01270003
028490                                                                          
028491     PERFORM                                                              
028492        WITH TEST AFTER                                                   
028493        VARYING PV-RETRY-CNT                                              
028494        FROM 1 BY 1                                                       
028495        UNTIL PS-STOP                                                     
028496          OR  SQLCODE = 0                                                 
028497                                                                          
028498        EXEC SQL                                                          
028499           CLOSE SKULOC-CSR                                               
028500        END-EXEC                                                          
028501                                                                          
028502        EVALUATE TRUE                                                     
028503           WHEN SQLCODE = -904                                            
028504           WHEN SQLCODE = -911                                            
028505           WHEN SQLCODE = -913                                            
028518              IF PV-RETRY-CNT >= PC-MAX-RETRIES                           
014700                 SET PS-STOP            TO TRUE                   01500003
014700                 MOVE SQLCODE           TO PV-RETURN-SQLCODE      01500003
028519                 MOVE '3200-CLOSE-SKULOC-CSR'                             
028520                                        TO  PV-PARAGRAPH-NAME             
028524              END-IF                                                      
028506           WHEN SQLCODE = 0                                               
028507              CONTINUE                                                    
028509           WHEN SQLCODE NOT EQUAL ZERO                                    
014700              SET PS-STOP         TO TRUE                         01500003
014700              MOVE SQLCODE        TO PV-RETURN-SQLCODE            01500003
028510              MOVE '3200-CLOSE-SKULOC-CSR'                                
028511                                  TO PV-PARAGRAPH-NAME                    
028515        END-EVALUATE                                                      
028516     END-PERFORM.                                                         
028517                                                                          
015400                                                                  01570003
015500******************************************************************01590003
015800 9999-WRAPUP.                                                     01620003
015600*     MOVE RETURN CODE TO LINKAGE VARIABLE AND EXIT MODULE        01600003
015700******************************************************************01610003
015900                                                                  01630003
016200     MOVE PV-RETURN-SQLCODE TO LV-RETURN-CODE.                    01660003
016300     MOVE PS-ACTION-IND     TO LV-ACTION-IND.                     01670003
016400                                                                  01680003
016500     EXIT PROGRAM.                                                01690003
016600                                                                  01700003
