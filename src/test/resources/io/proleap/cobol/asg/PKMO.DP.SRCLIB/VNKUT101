000100 IDENTIFICATION DIVISION.                                         00010001
000200 PROGRAM-ID.     VNKUT101.                                        00020001
000300 AUTHOR.         BRIAN HASSLINGER.                                00030001
000400 DATE-WRITTEN.   JULY 2002.                                       00040001
000500*************************************************************     00050001
000600*    COBOL 2                                                *     00060001
000700*                                                           *     00070001
000800*  THE PURPOSE OF THIS PROGRAM IS TO PRODUCE AN EXTRACT FILE*     00080014
000900*  THAT INCLUDES INFORMATION FROM THE VENDOR DEPT TABLE AND *     00090011
001000*  THE VENDOR AGREEMENT TABLE.  IT WILL BE USED BY          *     00100011
001100*  ANYONE THAT WANTS TO REPRODUCE THE VENDOR DEPT/AGREEMENT *     00110014
001200*  TABLE DATA OUTSIDE THE FINANCIAL DOMAIN.                 *     00120016
001300*                                                           *     00130001
001400*************************************************************     00140001
001500*                                                           *     00150001
001600* DB2 TABLES:                                               *     00160001
001700*  1. VENDOR DEPARTMENT TABLE        (TVNDDPT)              *     00170014
001800*  2. VENDOR AGREEMENT TABLE         (TVNDAGR)              *     00180014
001900*                                                           *     00190001
002000* OUTPUT:                                                   *     00200001
002100*  1. VENDOR DEPARTMENT EXTRACT FILE (VNRD101)              *     00210014
002200*************************************************************     00220001
002300* CHANGE LOG:                                               *     00230001
002400*                                                           *     00240001
002500* 07/22/02    CHANGE: INTIAL VERSION                        *     00250014
002600*             BY: BRIAN HASSLINGER          WR/IR#: WR23862 *     00260018
002700*************************************************************     00270001
002800                                                                  00280001
002900 ENVIRONMENT DIVISION.                                            00290001
003000                                                                  00300001
003100 INPUT-OUTPUT SECTION.                                            00310001
003200                                                                  00320001
003300 FILE-CONTROL.                                                    00330001
003400     SELECT VNDR-DEPT-EXTRACT-FILE        ASSIGN TO OUT01.        00340009
003500                                                                  00350001
003600 DATA DIVISION.                                                   00360001
003700                                                                  00370001
003800 FILE SECTION.                                                    00380001
003900 FD  VNDR-DEPT-EXTRACT-FILE                                       00390009
004000     RECORDING MODE IS F                                          00400001
004100     LABEL RECORDS ARE STANDARD                                   00410001
004200     DATA RECORD IS VNDR-DEPT-EXTRACT-REC.                        00420009
004300 01  VNDR-DEPT-EXTRACT-REC        PIC  X(100).                    00430009
004400*                                                                 00440001
004500                                                                  00450001
004600/                                                                 00460001
004700 WORKING-STORAGE SECTION.                                         00470001
004800                                                                  00480001
004900 01  FILLER                        PIC X(25)  VALUE               00490001
005000                             'WS FOR VNKUT101 BEGINS==>'.         00500001
005100                                                                  00510001
005200 01  WS-RETRY-COUNTER              PIC S9(4)  COMP VALUE ZERO.    00520001
005300 01  WS-RETRY-MAX                  PIC S9(4)  COMP VALUE 3.       00530001
005400                                                                  00540001
005500 01  PS-SWITCH-AREA.                                              00550001
005600     05  WS-END-OF-CURSOR-SW           PIC X(1)   VALUE 'N'.      00560016
005700         88  WS-END-OF-VENDOR-DEPT-CSR            VALUE 'Y'.      00570016
005800                                                                  00580001
005900 01  WS-PROGRAM-COUNTERS.                                         00590001
006000     05  WS-VNDR-REC-ROWS-FETCHED  PIC  9(09) VALUE ZEROS.        00600001
006100     05  WS-VNDR-REC-WRITTEN       PIC  9(09) VALUE ZEROS.        00610001
006200                                                                  00620001
006300                                                                  00630001
006400*---------------------------------------------------------------* 00640001
006500* SQLA MESSAGE MODULE                                             00650001
006600*---------------------------------------------------------------* 00660001
006700     COPY DPWS004.                                                00670021
006800                                                                  00680001
006900*---------------------------------------------------------------* 00690001
007000*  OUTPUT FILE COPY BOOK                                          00700001
007100*---------------------------------------------------------------* 00710001
007200     COPY VNRD101.                                                00720021
007300                                                                  00730001
007400 01  WS-ABEND-FIELDS.                                             00740001
007500     05  WS-ABEND-PROGRAM          PIC X(8)   VALUE 'VNKUT101'.   00750001
007600     05  WS-ABEND-PARAGRAPH        PIC X(50)  VALUE SPACES.       00760001
007700     05  WS-ABEND-OPERATION        PIC X(50)  VALUE SPACES.       00770001
007800     05  WS-ABEND-STRUCTURE-1      PIC X(8)   VALUE SPACES.       00780001
007900     05  WS-ABEND-STRUCTURE-2      PIC X(8)   VALUE SPACES.       00790001
008000     05  WS-ABEND-STATUS           PIC XX     VALUE SPACES.       00800001
008100                                                                  00810001
008200 01  ABEND-CODE                    PIC S9(4)  COMP SYNC           00820001
008300                                              VALUE ZEROS.        00830001
008400     88 AP-TABLE-FULL              VALUE +4004.                   00840001
008500     88 AP-EMPTY-FILE              VALUE +4005.                   00850001
008600     88 AP-DB2-ERROR               VALUE +4013.                   00860001
008700                                                                  00870001
008800*---------------------------------------------------------------* 00880016
008900*  COMMUNICATIONS AREA2 FOR DB2                                   00890001
009000*---------------------------------------------------------------* 00900016
009100     COPY SQLCA2.                                                 00910021
009200                                                                  00920001
009300*---------------------------------------------------------------* 00930001
009400* SQL COMMUNICATIONS AREA DCLGEN                                  00940001
009500*---------------------------------------------------------------* 00950001
009600     EXEC SQL                                                     00960001
009700          INCLUDE SQLCA                                           00970001
009800     END-EXEC.                                                    00980001
009900                                                                  00990001
010000*---------------------------------------------------------------* 01000001
010100* VENDOR AGREEMENT TABLE                                          01010016
010200*---------------------------------------------------------------* 01020001
010300     EXEC SQL                                                     01030001
010400          INCLUDE TVNDAGR                                         01040001
010500     END-EXEC.                                                    01050001
010600                                                                  01060001
010700*---------------------------------------------------------------* 01070001
010800* VENDOR DEPARTMENT TABLE                                         01080016
010900*---------------------------------------------------------------* 01090001
011000     EXEC SQL                                                     01100001
011100          INCLUDE TVNDDPT                                         01110001
011200     END-EXEC.                                                    01120001
011300                                                                  01130001
011400                                                                  01140001
011500                                                                  01150001
011510*---------------------------------------------------------------* 01151017
011700*   THIS IS THE CURSOR THAT RETRIEVES THE VENDOR/DEPT DATA      * 01170017
011900*   NEEDED FOR THE EXTRACT FILE                                 * 01190017
011910*---------------------------------------------------------------* 01191017
012200     EXEC SQL                                                     01220001
012300        DECLARE VENDOR_DEPT_CSR CURSOR FOR                        01230016
012400          SELECT A.ENT_ID                                         01240001
012500                ,A.DEPT_NBR                                       01250001
012600                ,A.VEND_TYP_IND                                   01260001
012700                ,A.VND_DEPT_STAT_CD                               01270001
012800                ,B.RTV_RA_REQD_IND                                01280001
012900                ,B.RTV_NO_RA_REQD_IND                             01290001
013000                ,B.DEBIT_DESTROY_IND                              01300001
013100                ,B.MARKOUT_IND                                    01310001
013200                ,B.EFFECTIVE_DATE                                 01320001
013300                ,B.EXPIRATION_DATE                                01330001
013400          FROM TVNDDPT A                                          01340002
013500              ,TVNDAGR B                                          01350002
013600          WHERE A.ENT_ID       = B.ENT_ID                         01360001
013700            AND A.DEPT_NBR     = B.DEPT_NBR                       01370001
013800            AND B.AGRMT_TYP_ID = '3'                              01380001
013900          ORDER BY A.ENT_ID                                       01390001
014000     END-EXEC.                                                    01400001
014100                                                                  01410001
014200 01  FILLER                        PIC X(25) VALUE                01420001
014300          '<====WS FOR VNKUT101 ENDS'.                            01430001
014400                                                                  01440001
014700                                                                  01470001
014800 PROCEDURE DIVISION.                                              01480001
014900                                                                  01490001
015500 A100-MAINLINE.                                                   01550001
015600                                                                  01560001
015700     PERFORM B100-INITIALIZATION.                                 01570016
015800                                                                  01580001
015900     PERFORM B200-CREATE-VENDOR-DEPT-EXT                          01590020
016000       UNTIL WS-END-OF-VENDOR-DEPT-CSR.                           01600016
016100                                                                  01610001
016200     PERFORM B300-END-OF-JOB.                                     01620001
016300                                                                  01630001
016400     GOBACK.                                                      01640017
016500        EJECT                                                     01650001
016600                                                                  01660001
016700*                                                                 01670001
016800***************************************************************** 01680001
016900*  INITIALIZATION AND FETCH THE FIRST ROW FROM THE                01690016
017000*  VENDOR DEPT CURSOR                                             01700016
017100***************************************************************** 01710001
017200*                                                                 01720001
017300 B100-INITIALIZATION.                                             01730016
017400                                                                  01740001
017500     DISPLAY '**********************************'                 01750001
017600     DISPLAY '*   STARTING PROGRAM VNKUT101    *'                 01760001
017700     DISPLAY '**********************************'                 01770001
017800                                                                  01780001
017900     OPEN OUTPUT VNDR-DEPT-EXTRACT-FILE.                          01790009
018000                                                                  01800001
018100     INITIALIZE DCLTVNDDPT                                        01810001
018200                DCLTVNDAGR.                                       01820001
018300                                                                  01830001
018400     PERFORM Y100-OPEN-VENDOR-DEPT-CSR.                           01840016
018500                                                                  01850001
018600     PERFORM R100-FETCH-VENDOR-DEPT-CSR.                          01860016
018700                                                                  01870001
018800     IF WS-END-OF-VENDOR-DEPT-CSR                                 01880016
018900        DISPLAY '**********************************'              01890001
019000        DISPLAY '*      PROGRAM = VNKUT101        *'              01900016
019100        DISPLAY '**********************************'              01910001
019200        DISPLAY '* NO ROWS WERE SELECTED FROM     *'              01920001
019300        DISPLAY '* THE VENDOR DEPARTMENT CURSOR.  *'              01930016
019400        DISPLAY '**********************************'              01940001
019500     END-IF.                                                      01950001
019600                                                                  01960001
019700*                                                                 01970001
019800***************************************************************** 01980001
019900*  PROCESS VENDOR CURSOR RESULTS. MOVES RETRIEVED INFORMATION     01990012
020000*  TO THE COPY BOOK USED TO WRITE THE OUTPUT FILE.                02000012
020100***************************************************************** 02010001
020200*                                                                 02020001
020300 B200-CREATE-VENDOR-DEPT-EXT.                                     02030020
020400                                                                  02040001
020500     MOVE VNDDPT-ENT-ID             TO VN101-ENT-ID.              02050009
020600     MOVE VNDDPT-DEPT-NBR           TO VN101-DEPT-NBR.            02060009
020700     MOVE VNDDPT-VEND-TYP-IND       TO VN101-VEND-TYP-IND.        02070009
020800     MOVE VNDDPT-VND-DEPT-STAT-CD   TO VN101-VND-DEPT-STAT-CD.    02080009
020900     MOVE VNDAGR-RTV-RA-REQD-IND    TO VN101-RTV-RA-REQD-IND.     02090009
021000     MOVE VNDAGR-RTV-NO-RA-REQD-IND TO VN101-RTV-NO-RA-REQD-IND.  02100009
021100     MOVE VNDAGR-DEBIT-DESTROY-IND  TO VN101-DEBIT-DESTROY-IND.   02110009
021200     MOVE VNDAGR-MARKOUT-IND        TO VN101-MARKOUT-IND.         02120009
021300     MOVE VNDAGR-EFFECTIVE-DATE     TO VN101-PRCHS-AGMNT-EFF-DTE. 02130009
021400     MOVE VNDAGR-EXPIRATION-DATE    TO VN101-PRCHS-AGMNT-EXP-DTE. 02140009
021500                                                                  02150001
021600     PERFORM W100-WRITE-VNDR-EXTRACT-REC.                         02160013
021700                                                                  02170001
021800     PERFORM R100-FETCH-VENDOR-DEPT-CSR.                          02180016
021900                                                                  02190001
022000*                                                                 02200001
022100***************************************************************** 02210001
022200*  END OF PROGRAM PROCESSING.                                     02220001
022300***************************************************************** 02230001
022400*                                                                 02240001
022500 B300-END-OF-JOB.                                                 02250001
022600                                                                  02260001
022700     PERFORM Y200-CLOSE-VNDR-DEPT-AGR-CSR.                        02270015
022800                                                                  02280001
022900     CLOSE VNDR-DEPT-EXTRACT-FILE.                                02290009
023000                                                                  02300001
023100     DISPLAY 'VENDOR ROWS FETCHED = ' WS-VNDR-REC-ROWS-FETCHED.   02310016
023200     DISPLAY 'VENDOR RECORDS WRITTEN = ' WS-VNDR-REC-WRITTEN.     02320016
023300                                                                  02330001
023400     DISPLAY 'PROGRAM VNKUT101 ENDS NORMALLY '.                   02340016
023500                                                                  02350001
023600*                                                                 02360001
023700***************************************************************** 02370001
023800*  FETCH THE VENDOR REFERENCE INFO FROM THE VENDOR DEPARTMENT     02380012
023900*  AGREEMENT CURSOR.                                              02390012
024000***************************************************************** 02400001
024100*                                                                 02410001
024200 R100-FETCH-VENDOR-DEPT-CSR.                                      02420016
024300                                                                  02430001
024400        EXEC SQL                                                  02440001
024500            FETCH VENDOR_DEPT_CSR                                 02450016
024600             INTO :VNDDPT-ENT-ID                                  02460009
024700                 ,:VNDDPT-DEPT-NBR                                02470009
024800                 ,:VNDDPT-VEND-TYP-IND                            02480009
024900                 ,:VNDDPT-VND-DEPT-STAT-CD                        02490009
025000                 ,:VNDAGR-RTV-RA-REQD-IND                         02500009
025100                 ,:VNDAGR-RTV-NO-RA-REQD-IND                      02510009
025200                 ,:VNDAGR-DEBIT-DESTROY-IND                       02520009
025300                 ,:VNDAGR-MARKOUT-IND                             02530009
025400                 ,:VNDAGR-EFFECTIVE-DATE                          02540009
025500                 ,:VNDAGR-EXPIRATION-DATE                         02550009
025600        END-EXEC.                                                 02560001
025700                                                                  02570001
025800        EVALUATE TRUE                                             02580001
025900            WHEN SQLCODE = ZERO                                   02590001
026000                 ADD 1 TO WS-VNDR-REC-ROWS-FETCHED                02600001
026100            WHEN SQLCODE = +100                                   02610001
026200                  SET WS-END-OF-VENDOR-DEPT-CSR TO TRUE           02620016
026600            WHEN SQLWARN0 NOT = SPACES                            02660001
026700            WHEN SQLCODE  NOT = ZERO                              02670001
026800              MOVE 'R100-FETCH-VENDOR-DEPT-CSR        '           02680016
026900                              TO WS-ABEND-PARAGRAPH               02690001
027000              MOVE 'UNSUCCESSFUL FETCH '                          02700001
027100                              TO WS-ABEND-OPERATION               02710001
027200              MOVE 'TVNDDPT'  TO WS-ABEND-STRUCTURE-1             02720001
027300              MOVE 'TVNDAGR ' TO WS-ABEND-STRUCTURE-2             02730001
027400              PERFORM Z999-SQL-ERROR                              02740001
027500        END-EVALUATE.                                             02750001
027600                                                                  02760001
027700                                                                  02770001
027800*                                                                 02780001
027900***************************************************************** 02790001
028000*  WRITE RETRIEVED INFORMATION TO THE VENDOR DEPT EXTRACT RECORD  02800012
028100***************************************************************** 02810001
028200*                                                                 02820001
028300 W100-WRITE-VNDR-EXTRACT-REC.                                     02830013
028400                                                                  02840001
028500     WRITE VNDR-DEPT-EXTRACT-REC FROM VN101-VENDOR-DEPT-EXTR.     02850009
028600                                                                  02860001
028700     ADD 1 TO WS-VNDR-REC-WRITTEN.                                02870001
028800                                                                  02880001
028900*                                                                 02890001
029000***************************************************************** 02900001
029100*  OPEN VENDOR DEPARTMENT AGREEMENT CURSOR.                       02910012
029200***************************************************************** 02920001
029300*                                                                 02930001
029400 Y100-OPEN-VENDOR-DEPT-CSR.                                       02940016
029500                                                                  02950001
029600     PERFORM WITH TEST AFTER                                      02960001
029700        VARYING WS-RETRY-COUNTER FROM 1 BY 1                      02970016
029800          UNTIL WS-RETRY-COUNTER > WS-RETRY-MAX                   02980016
029900             OR SQLCODE = ZERO                                    02990016
030000                                                                  03000001
030100         EXEC SQL                                                 03010016
030200            OPEN VENDOR_DEPT_CSR                                  03020016
030300         END-EXEC                                                 03030016
030400                                                                  03040001
030500         EVALUATE TRUE                                            03050016
030600             WHEN SQLCODE = ZERO                                  03060016
030700                  CONTINUE                                        03070016
030800             WHEN SQLCODE = -904                                  03080016
030900             WHEN SQLCODE = -913                                  03090016
031000                  CONTINUE                                        03100016
031100             WHEN SQLWARN0 NOT = SPACES                           03110016
031200             WHEN SQLCODE  NOT = ZERO                             03120016
031300                  MOVE 'Y100-OPEN-VENDOR-DEPT-CSR'                03130016
031400                                           TO WS-ABEND-PARAGRAPH  03140016
031500                  MOVE 'UNSUCCESSFUL OPEN' TO WS-ABEND-OPERATION  03150016
031600                  MOVE 'TVNDDPT' TO WS-ABEND-STRUCTURE-1          03160016
031700                  MOVE 'TVNDAGR' TO WS-ABEND-STRUCTURE-2          03170016
031800                  PERFORM Z999-SQL-ERROR                          03180016
031900         END-EVALUATE                                             03190016
032000     END-PERFORM.                                                 03200001
032100                                                                  03210001
032200     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           03220001
032300         MOVE 'Y100-OPEN-VENDOR-DEPT-CSR' TO WS-ABEND-PARAGRAPH   03230016
032400         MOVE 'MAX RETRIES EXCEEDED ON OPEN' TO WS-ABEND-OPERATION03240016
032500         PERFORM Z999-SQL-ERROR.                                  03250001
032600                                                                  03260001
032700*                                                                 03270001
032800***************************************************************** 03280001
032900*  CLOSE VENDOR DEPARTMENT AGREEMENT CURSOR                       03290012
033000***************************************************************** 03300001
033100*                                                                 03310001
033200 Y200-CLOSE-VNDR-DEPT-AGR-CSR.                                    03320015
033300                                                                  03330001
033400         EXEC SQL                                                 03340016
033500            CLOSE VENDOR_DEPT_CSR                                 03350016
033600         END-EXEC.                                                03360016
033700                                                                  03370001
033800         EVALUATE TRUE                                            03380016
033900             WHEN SQLCODE = ZERO                                  03390016
034000                  CONTINUE                                        03400016
034100             WHEN SQLWARN0 NOT = SPACES                           03410016
034200             WHEN SQLCODE  NOT = ZERO                             03420016
034300                  MOVE 'Y200-CLOSE-VNDR-DEPT-AGR-CSR         '    03430016
034400                                  TO WS-ABEND-PARAGRAPH           03440016
034500                  MOVE 'UNSUCCESSFUL CLOSE ' TO WS-ABEND-OPERATION03450016
034600                  MOVE 'TVNDAGR'  TO WS-ABEND-STRUCTURE-1         03460016
034700                  MOVE 'TVNDDPT ' TO WS-ABEND-STRUCTURE-2         03470016
034800                  PERFORM Z999-SQL-ERROR                          03480016
034900         END-EVALUATE.                                            03490016
035000                                                                  03500001
035100*                                                                 03510001
035200***************************************************************** 03520001
035300*  PROCESS DB2 ABENDS.                                            03530001
035400***************************************************************** 03540001
035500*                                                                 03550001
035600 Z999-SQL-ERROR.                                                  03560001
035700                                                                  03570001
035800     DISPLAY '*** DB2 ERROR '.                                    03580001
035900     DISPLAY '*** PROGRAM   = ' WS-ABEND-PROGRAM.                 03590001
036000     DISPLAY '*** PARAGRAPH = ' WS-ABEND-PARAGRAPH.               03600001
036100     DISPLAY '*** OPERATION = ' WS-ABEND-OPERATION.               03610001
036200     DISPLAY '*** TABLE 1   = ' WS-ABEND-STRUCTURE-1.             03620001
036300     IF WS-ABEND-STRUCTURE-2 > SPACES                             03630001
036400         DISPLAY '*** TABLE 2   = ' WS-ABEND-STRUCTURE-2.         03640001
036500                                                                  03650001
036600     SET AP-DB2-ERROR              TO TRUE.                       03660001
036700                                                                  03670001
036800     COPY DPPD004.                                                03680021
036900     CALL 'ILBOABN0' USING ABEND-CODE.                            03690001
