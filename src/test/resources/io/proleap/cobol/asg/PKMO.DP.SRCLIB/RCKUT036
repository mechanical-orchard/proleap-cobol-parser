000100******************************************************************02/19/96
000200 IDENTIFICATION DIVISION.                                         RCK00189
000300******************************************************************   LV010
000400                                                                     CL**3
000500 PROGRAM-ID.    RCKUT036.                                            CL**3
000600 AUTHOR.        MARY SARDINA.                                        CL**3
000700 INSTALLATION.  KOHLS.                                               CL**3
000800 DATE-WRITTEN   JANUARY, 1996.                                       CL**3
000900 DATE-COMPILED.                                                      CL**3
001000                                                                     CL**3
001100******************************************************************   CL**3
001200*  THIS PROGRAM DELETES ROWS FROM THE RECEIPT ITEM AUDIT TABLE.      CL**3
001300******************************************************************   CL**3
001400                                                                     CL**3
001500******************************************************************   CL**3
001600 ENVIRONMENT DIVISION.                                               CL**3
001700******************************************************************   CL**3
001800                                                                     CL**3
001900 CONFIGURATION SECTION.                                              CL**3
002000                                                                     CL**3
002100 SOURCE-COMPUTER.        IBM-3090.                                   CL**3
002200 OBJECT-COMPUTER.        IBM-3090.                                   CL**3
002300                                                                     CL**3
002400 INPUT-OUTPUT SECTION.                                               CL**3
002500                                                                     CL**3
002600 FILE-CONTROL.                                                       CL**3
002700                                                                     CL**3
002800                                                                     CL**3
002900     SELECT TIMESTAMP-FILE                                           CL**3
003000         ASSIGN TO IN01.                                             CL**3
003100                                                                     CL**3
003200******************************************************************   CL**3
003300 DATA DIVISION.                                                      CL**3
003400******************************************************************   CL**3
003500                                                                     CL**3
003600 FILE SECTION.                                                       CL**3
003700                                                                     CL**3
003800 FD  TIMESTAMP-FILE                                                  CL**3
003900     RECORDING MODE IS F                                             CL**3
004000     LABEL RECORDS ARE STANDARD                                      CL**3
004100     BLOCK CONTAINS 0 RECORDS.                                       CL**3
004200                                                                     CL**3
004300 01  TIMESTAMP-RECORD           PIC  X(50).                          CL**3
004400                                                                     CL**3
004500*                                                                    CL**3
004600******************************************************************   CL**3
004700 WORKING-STORAGE SECTION.                                            CL**3
004800******************************************************************   CL**3
004900*                                                                    CL**3
005000*                                                                    CL**3
005500*                                                                    CL**3
005600*                                                                    CL**3
005700******************************************************************   CL**3
005800*  RECORD LAYOUT FOR THE TIMESTAMP FILE.                             CL**3
005900******************************************************************   CL**3
006000     COPY RCRD011.                                                   CL**3
006100*                                                                    CL**3
006200******************************************************************   CL**3
006300*  DB2 FORMATTED MESSAGE AREA                                        CL**3
006400******************************************************************   CL**3
006500     COPY DPWS004.                                                   CL**3
006600*                                                                    CL**3
006700*                                                                    CL**3
006800     COPY SQLCA2.                                                    CL**3
006900*                                                                    CL**3
007000******************************************************************   CL**3
007100*  COMMUNICATIONS AREA FOR DB2                                       CL**3
007200******************************************************************   CL**3
007300*                                                                    CL**3
007400     EXEC SQL                                                        CL**3
007500          INCLUDE SQLCA                                              CL**3
007600     END-EXEC.                                                       CL**3
007700*                                                                    CL**3
007800*                                                                    CL**3
007900******************************************************************   CL**3
008000*  COBOL DECLARATION AND DCLGEN MEMBER FOR THE RECEIVER AUDIT        CL**3
008100*  TABLE                                                             CL**3
008200******************************************************************   CL**3
008300     EXEC SQL                                                        CL**3
008400          INCLUDE TAURECI                                            CL**3
008500     END-EXEC.                                                       CL**3
008600*                                                                    CL**3
008700 01  ABEND-CODE                      PIC S9(04)    VALUE +0          CL**3
008800                                                   COMP SYNC.        CL**3
008900                                                                     CL**3
009000 01  PS-PROGRAM-SWITCHES.                                            CL**3
009100     05  PS-USE-SHIPPED-ITEM-SW      PIC  X(01)    VALUE SPACE.      CL**3
009200         88  PS-USE-SHIPPED-ITEM                   VALUE 'Y'.        CL**3
009300     05  PS-EOF-AUDIT-RECI-CSR-SW    PIC  X(01)    VALUE SPACE.      CL**3
009400         88  PS-EOF-AUDIT-RECI-CSR                 VALUE 'Y'.        CL**3
009500                                                                     CL**3
009600                                                                     CL**3
009700 01  PC-PROGRAM-CONSTANTS.                                           CL**3
009800     05  PC-ROW-NOT-FOUND            PIC S9(04)    VALUE +100        CL**3
009900                                                   COMP SYNC.        CL**3
010000     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE             CL**3
010100         'RCKUT036'.                                                 CL**6
010200     05  PC-CURRENT-OPERATING-COMPANY                                CL**3
010300                                     PIC  X(02)    VALUE '03'.       CL**3
010400     05  PC-MAX-RETRIES              PIC S9(04)    VALUE +3          CL**3
010500                                                   COMP SYNC.        CL**3
010600     05  PC-CURRENT-TIMESTAMP        PIC  X(26)    VALUE SPACES.     CL**3
010700                                                                     CL**3
010800                                                                     CL**3
010900     05  PC-COMMIT-DEL-COUNT         PIC 9(09)     VALUE ZERO.       CL**3
011000                                                                     CL**3
011100     05  PC-COMMIT-HOLD              PIC 9(3)      VALUE 099.        CL*10
011200                                                                     CL**3
011300 01  PV-PROGRAM-VARIABLES.                                           CL**3
011400     05  PV-ITEM-NBR                 PIC  9(15)    VALUE ZERO.       CL**3
011500     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.     CL**3
011600     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.     CL**3
011700     05  PV-OPEN-COUNTER             PIC S9(04)    VALUE ZERO        CL**3
011800                                                   COMP SYNC.        CL**3
011900     05  PV-CLOSE-COUNTER            PIC S9(04)    VALUE ZERO        CL**3
012000                                                   COMP SYNC.        CL**3
012100     05  PV-FETCH-COUNTER            PIC S9(04)    VALUE ZERO        CL**3
012200                                                   COMP SYNC.        CL**3
012300     05  PV-WRITE-COUNTER            PIC S9(04)    VALUE ZERO        CL**3
012400                                                   COMP SYNC.        CL**3
012500     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.                CL**3
012600                                                                     CL**3
012700     05  PV-DB2-COUNT                PIC S9(09)    VALUE ZERO        CL**3
012800                                                   COMP-3.           CL**3
012900     05  PV-OPER-UNT-ID              PIC 9(04)     VALUE ZERO.       CL**3
013000                                                                     CL**3
013100     05  PV-RECI-SEQ-NBR             PIC 9(03)     VALUE ZERO.       CL**3
013200                                                                     CL**3
013300     05  PV-PO-NBR                   PIC S9(08)    VALUE ZERO.       CL**3
013400                                                                     CL**3
013500     05  PV-PO-LNE-NBR               PIC 9(03)     VALUE ZERO.       CL**3
013600                                                                     CL**3
013700     05  PV-DELETE-COUNTER           PIC S9(04)  VALUE +0            CL**3
013800                                                    COMP SYNC.       CL**3
013900     05  PV-DELETE-COUNT             PIC S9(09)  VALUE +0            CL**3
014000                                                    COMP SYNC.       CL**3
014100     05  PV-COMMIT-COUNT             PIC S9(09)  VALUE +0            CL**3
014200                                                    COMP SYNC.       CL**3
014300     05  PV-COMMIT-COUNTER           PIC 9(03)     VALUE ZERO.       CL**3
014400                                                                     CL**3
014500 01  PV-COMMIT-INFO.                                                 CL**3
014600     05  FILLER                      PIC X(23) VALUE                 CL**3
014700        ' ORD /SEQ/TIMESTAMP: '.                                     CL**3
014800     05  PV-COMMIT-KEY.                                              CL**3
014900         10  PV-COMMIT-ORD-NBR       PIC X(09).                      CL**8
015000         10  FILLER                  PIC X(01) VALUE SPACE.          CL**8
015100         10  PV-COMMIT-SEQ-NBR       PIC X(09).                      CL**8
015200         10  FILLER                  PIC X(01) VALUE SPACE.          CL**8
015300         10  PV-COMMIT-TIMESTAMP     PIC X(26).                      CL**3
015400     05  FILLER                      PIC X(12) VALUE                 CL**3
015500        ' AUDIT CDE: '.                                              CL**3
015600     05  PV-AUDIT-CODE               PIC X(01).                      CL**9
015700     05  FILLER                      PIC X(24) VALUE SPACE.          CL**8
015800     05  FILLER                      PIC X(22) VALUE                 CL**8
015900        ' # RECS DELETED     : '.                                    CL**3
016000     05  PV-RECS-DELETED-COUNT       PIC 9(7)  VALUE 0.              CL**3
016100*                                                                    CL**3
016200*                                                                    CL**3
016300 01  SD-SYSTEM-DATE.                                                 CL**3
016400     05  SD-SYSTEM-DATE-YY           PIC  9(02)      VALUE ZERO.     CL**3
016500     05  SD-SYSTEM-DATE-MM           PIC  9(02)      VALUE ZERO.     CL**3
016600     05  SD-SYSTEM-DATE-DD           PIC  9(02)      VALUE ZERO.     CL**3
016700                                                                     CL**3
016800*                                                                    CL**3
016900*  CURSOR DECLARATION FOR ALL EXCEPTION ACTIVITY ON THE              CL**3
017000*  UPC CERTIFICATION ACTIVITY LOG TABLE                              CL**3
017100*                                                                    CL**3
017200                                                                     CL**3
017300     EXEC SQL                                                        CL**3
017400          DECLARE AUDIT_RECI_CURSOR CURSOR WITH HOLD FOR             CL**3
017500           SELECT                                                    CL**3
017600             ORD_NBR                                                 CL**3
017700            ,ORD_LNE_NBR                                             CL**3
017800            ,REC_SEQ_NBR                                             CL**3
017900            ,OPER_UNT_ID                                             CL**3
018000            ,FCLTY_ID                                                CL**3
018100            ,CRE_TMST                                                CL**3
018200            ,CRE_UID                                                 CL**3
018300            ,PO_VER_NBR                                              CL**3
018400            ,ITM_NBR                                                 CL**3
018500            ,PRE_TKT_IND                                             CL**3
018600            ,TKT_FMT_ID                                              CL**3
018700            ,RTV_IND                                                 CL**3
018800            ,STATUS_CDE                                              CL**3
018900            ,VER_STATUS_CDE                                          CL**3
019000            ,PKSL_ITM_QTY                                            CL**3
019100            ,DTL_CK_ITM_QTY                                          CL**3
019200            ,INNR_PACK_QTY                                           CL**3
019300            ,CASE_PACK_QTY                                           CL**3
019400            ,RTV_QTY                                                 CL**3
019500            ,EXPTED_CART_CNT                                         CL**3
019600            ,ACTL_CART_CNT                                           CL**3
019700            ,MKING_APRON_TMST                                        CL**3
019800            ,UNT_COST_AMT                                            CL**3
019900            ,COLOR_DESC                                              CL**3
020000            ,SIZE_DESC                                               CL**3
020100            ,VEND_STYL_NAME                                          CL**3
020200            ,VEND_DESC                                               CL**3
020300            ,VERFYD_TMST                                             CL**3
020400            ,PKSL_NBR                                                CL**3
020500            ,REC_INV_LNE_NBR                                         CL**3
020600            ,DMG_ITM_QTY                                             CL**3
020700            ,UPD_TMST                                                CL**3
020800            ,UPD_UID                                                 CL**3
020900            ,UPD_PGM_ID                                              CL**3
021000            ,AUD_TYP_CDE                                             CL**3
021100            ,AUD_FUNC_CDE                                            CL**3
021200            ,NOTIF_NBR                                               CL**7
021210            ,VRFD_USR_ID                                                  
021220            ,LAST_TRSCP_TMST                                              
021230            ,LAST_TRSCP_USR_ID                                            
021240            ,ROW_CRER_PGM_ID                                              
021250            ,ROW_CRER_USR_ID                                              
021260            ,ROW_CREN_TMST                                                
                  ,PREPK_ID                                                     
                  ,PREPK_RATO_QTY                                               
                  ,PREPK_ODD_UNT_QTY                                            
                  ,PREPK_DRV_LNE_CDE                                            
021300             FROM TAURECI                                            CL**3
021310            WHERE ROW_CREN_TMST = :PC-CURRENT-TIMESTAMP                   
021320               OR ROW_CREN_TMST < :PC-CURRENT-TIMESTAMP                   
021600                                                                     CL**3
021700     END-EXEC.                                                       CL**3
021800                                                                     CL**3
021900                                                                     CL**3
022000******************************************************************   CL**3
022100 PROCEDURE DIVISION.                                                 CL**3
022200******************************************************************   CL**3
022300                                                                     CL**3
022400 0000-PROGRAM-MAINLINE.                                              CL**3
022500******************************************************************   CL**3
022600* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE        CL**3
022700*      PROGRAM.                                                      CL**3
022800******************************************************************   CL**3
022900                                                                     CL**3
023000     PERFORM 1000-INITIALIZE.                                        CL**3
023100     PERFORM 2000-PROCESS-AUDIT-REC-ITEMS                            CL**3
023200       UNTIL PS-EOF-AUDIT-RECI-CSR.                                  CL**3
023300     PERFORM 9000-EOJ-ROUTINE.                                       CL**3
023400                                                                     CL**3
023500     STOP RUN.                                                       CL**3
023600*0000-EXIT.                                                          CL**3
023700*                                                                    CL**3
023800*                                                                    CL**3
023900 1000-INITIALIZE.                                                    CL**3
024000******************************************************************   CL**3
024100*  DO FIRST TIME PROGRAM INITIALIZATION TASKS.                       CL**3
024200*    -- OPEN CURSOR                                                  CL**3
024300*    -- FETCH CURSOR                                                 CL**3
024400******************************************************************   CL**3
024500*                                                                    CL**3
024600     ACCEPT SD-SYSTEM-DATE FROM DATE.                                CL**3
024700* *  MOVE SD-SYSTEM-DATE-YY      TO DP105-DATE1M-YY.                 CL**3
024800* *  MOVE SD-SYSTEM-DATE-MM      TO DP105-DATE1M-MM.                 CL**3
024900* *  MOVE SD-SYSTEM-DATE-DD      TO DP105-DATE1M-DD.                 CL**3
025000*                                                                    CL**3
025100     OPEN INPUT  TIMESTAMP-FILE.                                     CL**3
025200                                                                     CL**3
025300     PERFORM 1100-READ-TIMESTAMP-FILE.                               CL**3
025400                                                                     CL**3
025500     MOVE +0 TO PV-COMMIT-COUNTER                                    CL**3
025600                                                                     CL**3
025700     PERFORM 7000-OPEN-AUDIT-RECI-CURSOR.                            CL**3
025800                                                                     CL**3
025900     PERFORM 7100-FETCH-AUDIT-RECI-CURSOR.                           CL**3
026000*1000-EXIT.                                                          CL**3
026100*                                                                    CL**3
026200                                                                     CL**3
026300 1100-READ-TIMESTAMP-FILE.                                           CL**3
026400******************************************************************   CL**3
026500*  READ   THE CONTROL CARD.                                          CL**3
026600******************************************************************   CL**3
026700      READ TIMESTAMP-FILE INTO                                       CL**3
026800          RC011-CONTROL-RECORD.                                      CL**3
026900      MOVE RC011-CONTROL-TMST TO PC-CURRENT-TIMESTAMP.               CL**3
027000     DISPLAY 'RCKUT036 CONTROL CARD -- ' RC011-CONTROL-TMST.         CL**6
027100     DISPLAY 'TAURECI TABLE'.                                        CL**9
027200*                                                                    CL**3
027300*1100-EXIT.                                                          CL**3
027400*                                                                    CL**3
027500 2000-PROCESS-AUDIT-REC-ITEMS.                                       CL**5
027600******************************************************************   CL**3
027700*  PROCESS THE CERTIFICATION REQUESTS (LOOP THROUGH THE RESULTS      CL**3
027800*  TABLE).  FORMAT THE OUTPUT RECORD.  WRITE THE RECORDS THAT        CL**3
027900*  MEET THE CRITERIA.                                                CL**3
028000******************************************************************   CL**3
028100                                                                     CL**3
028200     PERFORM 8000-DELETE-AUDIT-RECI-RECORD.                          CL**3
028300                                                                     CL**3
028400     ADD +1 TO PV-COMMIT-COUNTER.                                    CL**3
028500                                                                     CL**3
028600     IF PV-COMMIT-COUNTER > PC-COMMIT-HOLD                           CL**3
028700         EXEC SQL                                                    CL**3
028800            COMMIT                                                   CL**3
028900         END-EXEC                                                    CL**3
029000                                                                     CL**3
029100         IF SQLCODE NOT = +0                                         CL**3
029200             DISPLAY '### COMMIT FAILED ! ###'                       CL**3
029300             PERFORM 9100-SQL-ABEND                                  CL**3
029400         END-IF                                                      CL**3
029500                                                                     CL**3
029600         ADD PV-COMMIT-COUNTER           TO PV-COMMIT-COUNT          CL**3
029700         MOVE AURECI-ORD-NBR             TO PV-COMMIT-ORD-NBR        CL**3
029800         MOVE AURECI-REC-SEQ-NBR         TO PV-COMMIT-SEQ-NBR        CL**3
029900         MOVE AURECI-UPD-TMST            TO PV-COMMIT-TIMESTAMP      CL**3
030000         MOVE AURECI-AUD-TYP-CDE         TO PV-AUDIT-CODE            CL**3
030100                                                                     CL**3
030200         MOVE PV-COMMIT-COUNT    TO PV-RECS-DELETED-COUNT            CL**3
030300         DISPLAY 'COMMIT TAKEN: ' PV-COMMIT-INFO                     CL**3
030400                                                                     CL**3
030500         MOVE +0 TO PV-COMMIT-COUNTER                                CL**3
030600     END-IF.                                                         CL**3
030700                                                                     CL**3
030800     PERFORM 7100-FETCH-AUDIT-RECI-CURSOR.                           CL**3
030900     EJECT                                                           CL**3
031000*2000-EXIT.                                                          CL**3
031100                                                                     CL**3
031200*                                                                    CL**3
031300 7000-OPEN-AUDIT-RECI-CURSOR.                                        CL**3
031400******************************************************************   CL**3
031500*  OPEN THE CURSOR.                                                  CL**3
031600******************************************************************   CL**3
031700     PERFORM WITH TEST AFTER                                         CL**3
031800       VARYING PV-OPEN-COUNTER FROM 1 BY 1                           CL**3
031900         UNTIL (PV-OPEN-COUNTER > PC-MAX-RETRIES                     CL**3
032000                OR                                                   CL**3
032100                SQLCODE = ZERO)                                      CL**3
032200                                                                     CL**3
032300         EXEC SQL                                                    CL**3
032400              OPEN AUDIT_RECI_CURSOR                                 CL**3
032500         END-EXEC                                                    CL**3
032600                                                                     CL**3
032700         EVALUATE TRUE                                               CL**3
032800             WHEN SQLCODE = -904                                     CL**3
032900             WHEN SQLCODE = -911                                     CL**3
033000                 CONTINUE                                            CL**3
033100             WHEN SQLWARN0 NOT = SPACES                              CL**3
033200             WHEN SQLCODE < ZERO                                     CL**3
033300             WHEN SQLCODE > ZERO                                     CL**3
033400                 MOVE '7000-OPEN-AUDIT-RECI-CURSOR    '              CL**3
033500                                 TO PV-PARAGRAPH-NAME                CL**3
033600                 MOVE 'OPEN THE AUDIT_RECI_CURSOR    '               CL**3
033700                                 TO PV-DB2-OPERATION-ATTEMPTED       CL**3
033800                 PERFORM 9100-SQL-ABEND                              CL**3
033900             WHEN SQLCODE = ZERO                                     CL**3
034000                 CONTINUE                                            CL**3
034100         END-EVALUATE                                                CL**3
034200     END-PERFORM.                                                    CL**3
034300                                                                     CL**3
034400     IF PV-OPEN-COUNTER > PC-MAX-RETRIES                             CL**3
034500         MOVE '7000-OPEN-AUDIT-RECI-CURSOR   '                       CL**3
034600                                 TO PV-PARAGRAPH-NAME                CL**3
034700         MOVE 'OPEN MAX RETRIES EXCEEDED     '                       CL**3
034800                                 TO PV-DB2-OPERATION-ATTEMPTED       CL**3
034900         PERFORM 9100-SQL-ABEND                                      CL**3
035000     END-IF.                                                         CL**3
035100*7000-EXIT.                                                          CL**3
035200*                                                                    CL**3
035300*                                                                    CL**3
035400 7100-FETCH-AUDIT-RECI-CURSOR.                                       CL**3
035500******************************************************************   CL**3
035600*  FETCH THE ROW FROM THE RESULTS TABLE USING THE CURSOR.            CL**3
035700******************************************************************   CL**3
035800     EXEC SQL                                                        CL**3
035900          FETCH AUDIT_RECI_CURSOR                                    CL**3
036000           INTO :AURECI-ORD-NBR,                                     CL**3
036100                :AURECI-ORD-LNE-NBR,                                 CL**3
036200                :AURECI-REC-SEQ-NBR,                                 CL**3
036300                :AURECI-OPER-UNT-ID,                                 CL**3
036400                :AURECI-FCLTY-ID,                                    CL**3
036500                :AURECI-CRE-TMST,                                    CL**3
036600                :AURECI-CRE-UID,                                     CL**3
036700                :AURECI-PO-VER-NBR,                                  CL**3
036800                :AURECI-ITM-NBR,                                     CL**3
036900                :AURECI-PRE-TKT-IND,                                 CL**3
037000                :AURECI-TKT-FMT-ID,                                     *3
037100                :AURECI-RTV-IND,                                     CL**3
037200                :AURECI-STATUS-CDE,                                  CL**3
037300                :AURECI-VER-STATUS-CDE,                              CL**3
037400                :AURECI-PKSL-ITM-QTY,                                CL**3
037500                :AURECI-DTL-CK-ITM-QTY,                              CL**3
037600                :AURECI-INNR-PACK-QTY,                               CL**3
037700                :AURECI-CASE-PACK-QTY,                               CL**3
037800                :AURECI-RTV-QTY,                                     CL**3
037900                :AURECI-EXPTED-CART-CNT,                             CL**3
038000                :AURECI-ACTL-CART-CNT,                               CL**3
038100                :AURECI-MKING-APRON-TMST,                            CL**3
038200                :AURECI-UNT-COST-AMT,                                CL**3
038300                :AURECI-COLOR-DESC,                                  CL**3
038400                :AURECI-SIZE-DESC,                                   CL**3
038500                :AURECI-VEND-STYL-NAME,                              CL**3
038600                :AURECI-VEND-DESC,                                   CL**3
038700                :AURECI-VERFYD-TMST,                                 CL**3
038800                :AURECI-PKSL-NBR,                                    CL**3
038900                :AURECI-REC-INV-LNE-NBR,                             CL**3
039000                :AURECI-DMG-ITM-QTY,                                 CL**3
039100                :AURECI-UPD-TMST,                                    CL**3
039200                :AURECI-UPD-UID,                                     CL**3
039300                :AURECI-UPD-PGM-ID,                                  CL**3
039400                :AURECI-AUD-TYP-CDE,                                 CL**3
039500                :AURECI-AUD-FUNC-CDE,                                CL**3
039600                :AURECI-NOTIF-NBR,                                   CL**7
039610                :AURECI-VRFD-USR-ID,                                      
039620                :AURECI-LAST-TRSCP-TMST,                                  
039630                :AURECI-LAST-TRSCP-USR-ID,                                
039640                :AURECI-ROW-CRER-PGM-ID,                                  
039650                :AURECI-ROW-CRER-USR-ID,                                  
039660                :AURECI-ROW-CREN-TMST,                                    
                      :AURECI-PREPK-ID,                                         
                      :AURECI-PREPK-RATO-QTY,                                   
                      :AURECI-PREPK-ODD-UNT-QTY,                                
                      :AURECI-PREPK-DRV-LNE-CDE                                 
039700     END-EXEC.                                                       CL**3
039800                                                                     CL**3
039900     EVALUATE TRUE                                                   CL**3
040000         WHEN SQLCODE = ZERO                                         CL**3
040100             CONTINUE                                                CL**3
040200         WHEN SQLCODE = +100                                         CL**3
040300             SET PS-EOF-AUDIT-RECI-CSR                               CL**3
040400                                 TO TRUE                             CL**3
040500         WHEN SQLWARN0 NOT = SPACES                                  CL**3
040600         WHEN SQLCODE < ZERO                                         CL**3
040700         WHEN SQLCODE > ZERO                                         CL**3
040800             MOVE '7100-FETCH-AUDIT-RECI-CURSOR  '                   CL**3
040900                                 TO PV-PARAGRAPH-NAME                CL**3
041000             MOVE 'FETCH THE AUDIT-RECI-CURSOR   '                   CL**3
041100                                 TO PV-DB2-OPERATION-ATTEMPTED       CL**3
041200             PERFORM 9100-SQL-ABEND                                  CL**3
041300     END-EVALUATE.                                                   CL**3
041400*7100-EXIT.                                                          CL**3
041500*                                                                    CL**3
041600 8000-DELETE-AUDIT-RECI-RECORD.                                      CL**3
041700******************************************************************   CL**3
041800*  DELETE THE ROW FORM THE RECEIVER AUDIT TABLE                      CL**3
041900******************************************************************   CL**3
042000                                                                     CL**3
042100     PERFORM                                                         CL**3
042200         WITH TEST AFTER                                             CL**3
042300         VARYING PV-DELETE-COUNTER                                   CL**3
042400         FROM 1 BY 1                                                 CL**3
042500         UNTIL (PV-DELETE-COUNTER > PC-MAX-RETRIES                   CL**3
042600                   OR SQLCODE = 0                                    CL**3
042700                   OR SQLCODE = +100)                                CL**3
042800                                                                     CL**3
042900         EXEC SQL                                                    CL**3
043000             DELETE                                                  CL**3
043100                 FROM  TAURECI                                       CL**3
043200                 WHERE CURRENT OF AUDIT_RECI_CURSOR                  CL**3
043300         END-EXEC                                                    CL**3
043400                                                                     CL**3
043500         EVALUATE TRUE                                               CL**3
043600             WHEN SQLCODE = 0                                        CL**3
043700                 ADD +1           TO PV-DELETE-COUNT                 CL**3
043800             WHEN SQLCODE = -904                                     CL**3
043900             WHEN SQLCODE = -913                                     CL**3
044000             WHEN SQLCODE = +100                                     CL**3
044100                 CONTINUE                                            CL**3
044200             WHEN SQLCODE < 0                                        CL**3
044300             WHEN SQLCODE > 0                                        CL**3
044400             WHEN SQLWARN0 = 'W'                                     CL**3
044500                 MOVE '8000-DELETE-AUDIT-RECEIV-REC'                 CL**3
044600                             TO PV-PARAGRAPH-NAME                    CL**3
044700                 MOVE 'DELETE OF TAURECI'                            CL**3
044800                             TO PV-DB2-OPERATION-ATTEMPTED           CL**3
044900                 PERFORM 9100-SQL-ABEND                              CL**3
045000         END-EVALUATE                                                CL**3
045100     END-PERFORM.                                                    CL**3
045200                                                                     CL**3
045300     IF PV-DELETE-COUNTER > PC-MAX-RETRIES                           CL**3
045400         MOVE '8000-DELETE-AUDIT-RECIEV-REC'                         CL**3
045500             TO PV-PARAGRAPH-NAME                                    CL**3
045600         MOVE 'DEADLOCK * DELETE TAURCEV'                            CL**3
045700             TO PV-DB2-OPERATION-ATTEMPTED                           CL**3
045800         PERFORM 9100-SQL-ABEND                                      CL**3
045900     END-IF.                                                         CL**3
046000                                                                     CL**3
046100*8000-EXIT.                                                          CL**3
046200*                                                                    CL**3
046300*                                                                    CL**3
046400 9000-EOJ-ROUTINE.                                                   CL**3
046500******************************************************************   CL**3
046600*  CLOSE OUTPUT FILE.  CLOSE THE CURSOR.                             CL**3
046700******************************************************************   CL**3
046800     CLOSE TIMESTAMP-FILE.                                           CL**3
046900     DISPLAY 'TOTAL RECORDS DELETED: '  PV-DELETE-COUNT.             CL**3
047000     PERFORM WITH TEST AFTER                                         CL**3
047100       VARYING PV-CLOSE-COUNTER FROM 1 BY 1                          CL**3
047200         UNTIL (PV-CLOSE-COUNTER > PC-MAX-RETRIES                    CL**3
047300                OR                                                   CL**3
047400                SQLCODE = ZERO)                                      CL**3
047500                                                                     CL**3
047600         EXEC SQL                                                    CL**3
047700              CLOSE AUDIT_RECI_CURSOR                                CL**3
047800         END-EXEC                                                    CL**3
047900                                                                     CL**3
048000         EVALUATE TRUE                                               CL**3
048100             WHEN SQLCODE = -904                                     CL**3
048200             WHEN SQLCODE = -911                                     CL**3
048300                 CONTINUE                                            CL**3
048400             WHEN SQLWARN0 NOT = SPACES                              CL**3
048500             WHEN SQLCODE < ZERO                                     CL**3
048600             WHEN SQLCODE > ZERO                                     CL**3
048700                 MOVE '9000-EOJ-ROUTINE               '              CL**3
048800                                 TO PV-PARAGRAPH-NAME                CL**3
048900                 MOVE 'CLOSE THE AUDIT_RECI_CURSOR    '              CL**3
049000                                 TO PV-DB2-OPERATION-ATTEMPTED       CL**3
049100                 PERFORM 9100-SQL-ABEND                              CL**3
049200             WHEN SQLCODE = ZERO                                     CL**3
049300                 CONTINUE                                            CL**3
049400         END-EVALUATE                                                CL**3
049500     END-PERFORM.                                                    CL**3
049600                                                                     CL**3
049700     IF PV-CLOSE-COUNTER > PC-MAX-RETRIES                            CL**3
049800         MOVE '9000-EOJ-ROUTINE               '                      CL**3
049900                                 TO PV-PARAGRAPH-NAME                CL**3
050000         MOVE 'CLOSE MAX RETRIES EXCEEDED     '                      CL**3
050100                                 TO PV-DB2-OPERATION-ATTEMPTED       CL**3
050200         PERFORM 9100-SQL-ABEND                                      CL**3
050300     END-IF.                                                         CL**3
050400*9000-EXIT.                                                          CL**3
050500*                                                                    CL**3
050600*                                                                    CL**3
050700 9100-SQL-ABEND.                                                     CL**3
050800******************************************************************   CL**3
050900*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL       CL**3
051000*  ERROR OR WARNING CODE OCCURS.                                     CL**3
051100******************************************************************   CL**3
051200     DISPLAY '9100-SQL-ABEND'.                                       CL**3
051300     DISPLAY '** ABEND     **'.                                      CL**3
051400     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.           CL**3
051500     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.                 CL**3
051600     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.        CL**3
051700     DISPLAY '***'                                                   CL**3
051800     DISPLAY '*** LAST COMMIT TAKEN **' PV-COMMIT-INFO               CL**3
051900     DISPLAY '***'                                                   CL**3
052000     DISPLAY '*** COMMITTED DELETE COUNTS FOLLOW: ***'               CL**3
052100     DISPLAY '***'                                                   CL**3
052200     EXEC SQL                                                        CL**3
052300          ROLLBACK                                                   CL**3
052400     END-EXEC.                                                       CL**3
052500******************************************************************   CL**3
052600* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-       CL**3
052700* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE            CL**3
052800* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE        CL**3
052900* FORMAT.                                                            CL**3
053000******************************************************************   CL**3
053100     COPY DPPD004.                                                   CL**3
053200                                                                     CL**3
053300     MOVE +4013                  TO ABEND-CODE.                      CL**3
053400     CALL 'ILBOABN0' USING ABEND-CODE.                               CL**3
053500*9100-EXIT.                                                          CL**3
053600*9100-SQL-ABEND.                                                     CL**3
053700******************************************************************   CL**3
053800*  ABEND ON DB2 ERROR.                                               CL**3
053900******************************************************************   CL**3
054000*    MOVE SQLCODE                    TO SQLCODE2.                    CL**3
054100*    MOVE SQLERRD(3)                 TO SQLERRD3.                    CL**3
054200*                                                                    CL**3
054300*    DISPLAY '** ABEND          **  IN RCKUT036'.                    CL**6
054400*    DISPLAY '** SQLERROR       **'.                                 CL**3
054500*    DISPLAY '** SQLCODE        ** ' SQLCODE2.                       CL**3
054600*    DISPLAY '** ROWS PROCESSED ** ' SQLERRD3.                       CL**3
054700*    DISPLAY '** SQLERRM        ** ' SQLERRM.                        CL**3
054800*    DISPLAY '** SQLERRMC       ** ' SQLERRMC.                       CL**3
054900*                                                                    CL**3
055000*    EXEC SQL                                                        CL**3
055100*         ROLLBACK                                                   CL**3
055200*    END-EXEC.                                                       CL**3
055300*                                                                    CL**3
055400*    MOVE 4013                       TO ABEND-CODE.                  CL**3
055500*    CALL 'ILBOABN0' USING ABEND-CODE.                               CL**3
055600*                                                                    CL**3
055700*                                                                    CL**3
