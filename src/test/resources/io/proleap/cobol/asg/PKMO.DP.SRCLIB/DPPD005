000100***************************************************************** 00010000
000200*      THIS PROCEDURE DIVISION COPY BOOK IS USED TO FORMAT THE    00020000
000300*  MESSAGE LINE FOR PROGRAMS UNDER THE NEW CICS ARCHITECTURE.     00030000
000400*  REQUIRED COPYBOOKS: DPWS006, DPWS020, DPRD507I                 00040000
000401*                                                                 00040100
000402*  LAST UPDATE: 1/28/97  (TKMA025)                                00040200
000403*   ALLOW MESSAGE VARIABLES WITH EMBEDDED BLANKS.                 00040300
000404*  LAST UPDATE: 1/31/97  (TKMA025)                                00040400
000405*   PUT BOUNDS CHECKING IN THE VARIABLE SUBSTITUTION.             00040500
000410***************************************************************** 00040600
000500                                                                  00040700
000600 DP005-0000-FORMAT-MSG-LINES.                                     00040800
000700     IF  DP020-MSG-NUMBER-X IS NUMERIC                            00040900
000800         IF  DP020-MSG-NUMBER > ZERO                              00041000
000900             MOVE DP020-MSG-NUMBER  TO DP507I-MSG-NUMBER          00042000
001000             PERFORM DP005-1000-FORMAT-SYS-MESSAGE                00043000
001100         ELSE                                                     00044000
001200             IF  DP020-MSG-TEXT = SPACE                           00045000
001300                 MOVE SPACE     TO DP020-MSG-MESSAGE              00046000
001400             END-IF                                               00047000
001500         END-IF                                                   00048000
001600     END-IF.                                                      00049000
001700*                                                                 00050000
001800     MOVE DP020-MSG-MESSAGE     TO AMSGO.                         00060000
001900     MOVE DP015-PRO-BRT-OFF     TO AMSGA.                         00070000
002000     MOVE DP015-HL-OFF          TO AMSGH.                         00080000
002100     EVALUATE TRUE                                                00090000
002200         WHEN DP020-MSG-INFORMATIONAL                             00100000
002300             MOVE DP015-BLUE    TO AMSGC                          00110000
002400         WHEN DP020-MSG-WARNING                                   00120000
002500             MOVE DP015-YELLOW  TO AMSGC                          00130000
002600         WHEN DP020-MSG-FATAL                                     00140000
002700             MOVE DP015-RED     TO AMSGC                          00150000
002800     END-EVALUATE.                                                00160000
002900                                                                  00170000
003000     MOVE SPACE                 TO DP020-MSG-MESSAGE              00180000
003100                                   DP020-MSG-SEVERITY-IND.        00190000
003300*                                                                 00200000
003400*                                                                 00210000
003500 DP005-1000-FORMAT-SYS-MESSAGE.                                   00220000
003600     PERFORM DP005-1100-READ-SYSTEM-MESSAGE.                      00230000
003601     MOVE ZERO                 TO DP006-MSG-CHAR-CNT.             00240000
003610     INSPECT DP507I-MSG-TEXT                                      00250000
003620         TALLYING DP006-MSG-CHAR-CNT                              00260000
003630         FOR ALL  DP006-MSG-VAR-SYMBOLIC                          00270000
003700     IF  DP006-MSG-CHAR-CNT > ZERO                                00280000
003800         PERFORM DP005-1200-SUBSTITUTE-MSG-VAR                    00290000
003900     ELSE                                                         00300000
004000         MOVE DP507I-MSG-TEXT  TO DP020-MSG-TEXT                  00310000
004100     END-IF.                                                      00320000
004200     SET DP020-MSG-DASH-1                                         00330000
004300         DP020-MSG-DASH-2 TO TRUE.                                00340000
004400*                                                                 00350000
004500     EVALUATE TRUE                                                00360000
004600         WHEN DP020-MSG-INFORMATIONAL                             00370000
004700             MOVE 'I'           TO DP020-MSG-LEVEL                00380000
004800         WHEN DP020-MSG-WARNING                                   00390000
004900             MOVE 'W'           TO DP020-MSG-LEVEL                00400000
005000         WHEN DP020-MSG-FATAL                                     00410000
005100             MOVE 'E'           TO DP020-MSG-LEVEL                00420000
005200     END-EVALUATE.                                                00430000
005400*                                                                 00440000
005500******************************************************************00450000
005600**   READ A SYSTEM MESSAGE RECORD                               **00460000
005700******************************************************************00470000
005800 DP005-1100-READ-SYSTEM-MESSAGE.                                  00480000
005900     EXEC CICS READ                                               00490000
006000               DATASET ('DPSYSMSG')                               00500000
006100               RIDFLD  (DP507I-MSG-NUMBER)                        00510000
006200               INTO    (DP507I-MESSAGES-INPUT-RECORD)             00520000
006300               RESP    (PV-CICS-RESPONSE)                         00530000
006400     END-EXEC.                                                    00540000
006500*                                                                 00550000
006600     IF  PV-CICS-RESPONSE NOT = DFHRESP(NORMAL)                   00560000
006700         SET DP013-LINK-RETURN  TO TRUE                           00570000
006800         SET DP013-CICS-ABEND   TO TRUE                           00580000
006900         SET DP013-NO-ROLLBACK  TO TRUE                           00590000
007000         MOVE 'DP005-1100-READ-SYSTEM-MESSAGE'                    00600000
007100                                TO DP013-PARAGRAPH                00610000
007200         MOVE 'ATTEMPTING TO READ THE SYSTEM MESSAGES FILE FOR THE00620000
007300-             ' FOLLOWING MESSAGE NUMBER: '                       00630000
007400                                TO DP013-MESSAGE-TEXT (1)         00640000
007500         MOVE DP507I-MSG-NUMBER TO DP013-MESSAGE-TEXT (2)         00650000
007600         PERFORM DP013-0000-PROCESS-ABEND                         00660000
007700     END-IF.                                                      00670000
007801******************************************************************00680000
007802** THIS PARAGRAPH WILL SUBSTITUTE '&VAR' FOUND IN MESSAGE TEXT  **00690000
007803** WITH THE TEXT ENTERED IN DP020-MSG-TEXT.  FIRST UNSTRING THE **00700000
007804** THE SYSTEM MESSAGE TEXT UNTIL THE SYMBOLIC IS FOUND, THEN    **00710000
007805** PUT IN THE DATA FROM DP020-MSG-TEXT AND THEN TACK ON THE     **00720000
007806** REMAINDER OF THE SYSTEM MESSAGE.                             **00730000
007810******************************************************************00740000
007900*                                                                 00750000
008000 DP005-1200-SUBSTITUTE-MSG-VAR.                                   00760000
008010     MOVE +1             TO DP006-MSG-VAR-LEAD-SPACE.             00770000
008100     MOVE DP020-MSG-TEXT TO DP006-MSG-VAR-SAVE.                   00780000
008200     INITIALIZE DP020-MSG-TEXT                                    00790000
008300                DP006-MSG-VAR-IND                                 00800000
008400                DP006-MSG-STRING-PTR                              00810000
008500                DP006-MSG-REMAINDER.                              00820000
008600*                                                                 00830000
008700     UNSTRING DP507I-MSG-TEXT DELIMITED BY DP006-MSG-VAR-SYMBOLIC 00840000
008800         INTO DP020-MSG-TEXT                                      00850000
008900                 DELIMITER IN DP006-MSG-VAR-IND                   00860000
009000                 COUNT     IN DP006-MSG-STRING-PTR                00870000
009100              DP006-MSG-REMAINDER                                 00880000
009200     END-UNSTRING.                                                00890000
009300*                                                                 00900000
009400     IF  DP006-MSG-STRING-PTR > ZERO                              00910000
009500         ADD +1            TO DP006-MSG-STRING-PTR                00920000
009700     ELSE                                                         00930000
009800         MOVE +1           TO DP006-MSG-STRING-PTR                00940000
009900     END-IF.                                                      00950000
010000*                                                                 00960000
010002** IF THE MSG VARIABLE HAS SOMETHING OTHER THAN SPACES IN IT, BUT 00970000
010003** THERE IS A SPACE IN THE FIRST POSITION, FIND OUT HOW MANY      00980000
010004** SPACES THERE ARE AND MOVE FIELDS IN ACCORDINGLY.               00990000
010010*                                                                 01000000
010011     IF  DP006-MSG-VAR-SAVE > SPACE                               01001000
010012         IF  DP006-MSG-VAR-SAVE(1:1) > SPACE                      01001100
010013             CONTINUE                                             01001200
010014         ELSE                                                     01001300
010015             INSPECT DP006-MSG-VAR-SAVE                           01001400
010016                 TALLYING DP006-MSG-VAR-LEAD-SPACE                01001500
010017                 FOR LEADING SPACE                                01001600
010018         END-IF                                                   01001700
010019     ELSE                                                         01001800
010020         MOVE '?'      TO DP006-MSG-VAR-SAVE                      01001900
010021     END-IF.                                                      01002000
010022*> FIND THE LAST NON-BLANK CHARACTER OF THE MSG VAR.              01002100
010023     MOVE LENGTH OF DP006-MSG-VAR-SAVE                            01002200
010024                       TO DP006-MSG-VAR-LEN.                      01002300
010025     PERFORM                                                      01002400
010026         VARYING DP006-CHAR-POS                                   01002500
010027         FROM DP006-MSG-VAR-LEN                                   01002600
010028         BY -1                                                    01002700
010029         UNTIL DP006-CHAR-POS < 1                                 01002800
010030            OR DP006-MSG-VAR-SAVE(DP006-CHAR-POS:1) > SPACE       01002900
010031              CONTINUE                                            01003000
010032     END-PERFORM.                                                 01003100
010033*> DETERMINE THE LENGTH OF THE VARIABLE TO BE PUT IN THE MSG.     01003200
010034     COMPUTE DP006-MSG-VAR-LEN =                                  01003300
010035         DP006-CHAR-POS - DP006-MSG-VAR-LEAD-SPACE + 1.           01003400
010036*> MOVE THE MSG VARIABLE INTO THE MESSAGE.                        01003500
010037     IF  DP006-MSG-STRING-PTR < LENGTH OF DP020-MSG-TEXT          01003600
010038         MOVE DP006-MSG-VAR-SAVE                                  01003700
010039             (DP006-MSG-VAR-LEAD-SPACE:DP006-MSG-VAR-LEN)         01003800
010040                       TO DP020-MSG-TEXT(DP006-MSG-STRING-PTR:)   01003900
010041     END-IF.                                                      01004000
010042     ADD DP006-MSG-VAR-LEN TO DP006-MSG-STRING-PTR.               01004100
010043*> MOVE THE REMAINDER OF THE MESSAGE IN.                          01004200
010044     IF  DP006-MSG-STRING-PTR < LENGTH OF DP020-MSG-TEXT          01004300
010045         MOVE DP006-MSG-REMAINDER                                 01004400
010046                       TO DP020-MSG-TEXT(DP006-MSG-STRING-PTR:)   01004500
010047     END-IF.                                                      01004600
