000100 IDENTIFICATION DIVISION.                                         00010000
000200                                                                  00020000
000300 PROGRAM-ID.      DFKUT021.                                       00030001
000400 AUTHOR.          STEVEN NOWAK.                                   00040001
000500 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00050001
000600 DATE-WRITTEN.    12/15/09.                                       00060001
000700 DATE-COMPILED.                                                   00070001
000800                                                                  00080000
000900******************************************************************00090000
001000*  DAILY EXTRACT OF XSTW_DF_LOC_HIER FOR CLOSED STORES THAT HAVE  00100008
001100*  BEEN REPLACED IN THE LAST 4 YEARS.                             00110000
001200*=================================================================00120000
001300* CLOSED STORES THAT HAVE BEEN REPLACED NEVER HAVE THEIR HIERARCH-00130000
001400* IAL DATA UPDATED ONCE THEY ARE CLOSED. THE HISTORICAL SALES     00140008
001500* APPLICATION NEEDS THIS DATA TO BE KEPT IN SYNC WITH THE STORE   00150000
001600* THAT REPLACED THEM SO THAT THE PAST SALES DATA WILL BE REPORTED 00160000
001700* IN THE SAME HIERARCHIAL STRUCTURE AS THE REPLACEMENT STORE.     00170000
001800******************************************************************00180000
001900                                                                  00190000
002000 ENVIRONMENT DIVISION.                                            00200000
002100 CONFIGURATION SECTION.                                           00210000
002200                                                                  00220000
002300 SOURCE-COMPUTER.        IBM-3090.                                00230000
002400 OBJECT-COMPUTER.        IBM-3090.                                00240000
002500                                                                  00250000
002600 INPUT-OUTPUT SECTION.                                            00260000
002700 FILE-CONTROL.                                                    00270000
002800                                                                  00280000
002900     SELECT OUTPUT-FILE ASSIGN TO OUT01.                          00290001
003000                                                                  00300000
003100 DATA DIVISION.                                                   00310000
003200 FILE SECTION.                                                    00320000
003300                                                                  00330000
003400 FD  OUTPUT-FILE                                                  00340001
003500     RECORDING MODE IS F                                          00350000
003600     BLOCK CONTAINS 0 RECORDS                                     00360000
003700     LABEL RECORDS ARE STANDARD.                                  00370000
003800                                                                  00380000
003900 01  OUTPUT-REC                       PIC  X(182).                00390004
004000                                                                  00400000
004100******************************************************************00410000
004200*                       WORKING STORAGE                           00420000
004300******************************************************************00430000
004400 WORKING-STORAGE SECTION.                                         00440000
004500                                                                  00450000
004600 01  W-START                          PIC  X(40)                  00460000
004700     VALUE 'EPKUT170 - WORKING STORAGE BEGINS HERE'.              00470000
004800                                                                  00480000
004900***************************************************************** 00490000
005000*                         SWITCHES                                00500000
005100***************************************************************** 00510000
005200 01  PS-PROGRAM-SWITCHES.                                         00520000
005300     05  PS-END-OF-CURSOR-SW          PIC  X(01) VALUE 'N'.       00530001
005400         88  PS-END-OF-CURSOR                    VALUE 'Y'.       00540001
005500     05  PS-HIERARCHY-SW              PIC  X(01) VALUE 'Y'.       00550001
005600         88  PS-HIERARCHY-FOUND                  VALUE 'Y'.       00560001
005700         88  PS-HIERARCHY-NOT-FOUND              VALUE 'N'.       00570001
005800                                                                  00580000
005900***************************************************************** 00590000
006000*                       ACCUMULATORS                              00600000
006100***************************************************************** 00610000
006200 01 PA-ACCUMS.                                                    00620001
006300     05  PA-WRITTEN                   PIC  9(11) VALUE ZEROS.     00630001
006300     05  PA-NULL                      PIC  9(11) VALUE ZEROS.     00631002
006300     05  PA-REPLACE                   PIC  9(11) VALUE ZEROS.     00632002
006400                                                                  00640001
006500******************************************************************00650000
006600*                        CONSTANTS                                00660000
006700******************************************************************00670000
006800 01 PC-CONSTANTS.                                                 00680000
006900     05  PC-PGM-NAME                  PIC  X(08) VALUE 'DFKUT021'.00690001
007000     05  PV-PARAGRAPH-NAME            PIC  X(30) VALUE SPACE.     00700001
007100                                                                  00710000
007200******************************************************************00720000
007300*                      PROGRAM VARIABLES                          00730000
007400******************************************************************00740000
007500 01  PV-PROGRAM-VARIABLES.                                        00750000
007600     05  PV-SAVE-STR                  PIC S9(04) VALUE ZEROS.     00760001
007700     05  PV-DB2-OPERATION             PIC  X(30) VALUE SPACES.    00770001
007800     05  PV-SAVE-CLSD                 PIC  9(04) VALUE ZEROS.     00780001
007900     05  PV-SAVE-REPLT                PIC  9(04) VALUE ZEROS.     00790001
008000     05  PV-SAVE-CLO-DTE              PIC  X(10) VALUE SPACES.    00800001
008100     05  PV-CURRENT-DATE              PIC  X(10) VALUE SPACES.    00810001
008200                                                                  00820000
008300******************************************************************00830000
008400*                       WORK AREA                                 00840000
008500******************************************************************00850000
008600 01  PV-FETCH-INFO.                                               00860000
008700     05  PV-FETCH-CLSD-STR            PIC S9(04) VALUE +0 COMP.   00870001
008800     05  PV-FETCH-RPLC-STR            PIC S9(04) VALUE +0 COMP.   00880001
008900                                                                  00890001
009000     05  PV-FETCH-DIST-NBR            PIC S9(04)V VALUE +0 COMP-3.00900001
009100     05  PV-FETCH-DIST-NM             PIC  X(20)  VALUE SPACES.   00910001
009200     05  PV-FETCH-REGN-NBR            PIC S9(04)V VALUE +0 COMP-3.00920001
009300     05  PV-FETCH-REGN-NM             PIC  X(20)  VALUE SPACES.   00930001
009400     05  PV-FETCH-TERR-NBR            PIC S9(04)V VALUE +0 COMP-3.00940001
009500     05  PV-FETCH-TERR-NM             PIC  X(20)  VALUE SPACES.   00950001
009600     05  PV-FETCH-METRO-ID            PIC S9(04)  VALUE +0 COMP.  00960001
009700     05  PV-FETCH-METRO-NM            PIC  X(30)  VALUE SPACES.   00970001
009800     05  PV-FETCH-GEO-ID              PIC S9(04)  VALUE +0 COMP.  00980001
009900     05  PV-FETCH-GEO-NM              PIC  X(30)  VALUE SPACES.   00990001
010000     05  PV-FETCH-CLMT-ID             PIC S9(04)  VALUE +0 COMP.  01000001
010100     05  PV-FETCH-CLMT-NM             PIC  X(30)  VALUE SPACES.   01010001
010200                                                                  01020000
010300******************************************************************01030000
010400*               SYSTEM TIME AND DATE VARIABLES                    01040000
010500******************************************************************01050000
010600 01  SYS-DATE-TIME.                                               01060000
010700     05  SYS-DATE                     PIC  X(08) VALUE SPACES.    01070000
010800     05  SYS-TIME                     PIC  X(08) VALUE SPACES.    01080000
010900                                                                  01090000
011000 01  ST-BEG-TIME.                                                 01100000
011100     05  ST-BEG-HR                    PIC  9(02) VALUE ZEROS.     01110000
011200     05  FILLER                       PIC  X(01) VALUE ':'.       01120000
011300     05  ST-BEG-MN                    PIC  9(02) VALUE ZEROS.     01130000
011400                                                                  01140000
011500 01  ST-END-TIME.                                                 01150000
011600     05  ST-END-HR                    PIC  9(02) VALUE ZEROS.     01160000
011700     05  FILLER                       PIC  X(01) VALUE ':'.       01170000
011800     05  ST-END-MN                    PIC  9(02) VALUE ZEROS.     01180000
011900                                                                  01190000
012000 01  SD-EDIT-DATE.                                                01200000
012100     05  SD-MONTH                     PIC  9(02) VALUE ZEROS.     01210000
012200     05  FILLER                       PIC  X(01) VALUE '-'.       01220000
012300     05  SD-DAY                       PIC  9(02) VALUE ZEROS.     01230000
012400     05  FILLER                       PIC  X(01) VALUE '-'.       01240000
012500     05  SD-CENT                      PIC  9(02) VALUE ZEROS.     01250000
012600     05  SD-YEAR                      PIC  9(02) VALUE ZEROS.     01260000
012700                                                                  01270000
012800******************************************************************01280000
012900*                        ERROR HANDLING                           01290000
013000******************************************************************01300000
013100 01  ABEND-CODE                       PIC S9(04) VALUE ZERO       01310000
013200                                                 COMP SYNC.       01320000
013400     88  AC-DB2-ERROR                      VALUE +4013.           01340000
013600                                                                  01360000
013700                                                                  01370000
013800******************************************************************01380000
013900* OUTPUT COPYBOOK                                                 01390001
014000******************************************************************01400000
014100     COPY DFRD018.                                                01410009
014200                                                                  01420000
014300******************************************************************01430001
014400* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         01440001
014500******************************************************************01450001
014600     COPY DPWS004.                                                01460001
014700                                                                  01470001
014800******************************************************************01480000
014900* DB2 MESSAGE AREA                                                01490000
015000******************************************************************01500000
015100     COPY SQLCA2.                                                 01510000
015200                                                                  01520000
015300******************************************************************01530000
015400*  DB2 COMMUNICATION AREA                                         01540000
015500******************************************************************01550000
015600     EXEC SQL                                                     01560000
015700        INCLUDE SQLCA                                             01570000
015800     END-EXEC.                                                    01580000
015900                                                                  01590000
016000******************************************************************01600000
016100*  DCLGEN FOR DAILY FLASH LOCATION HIERARCHY TBL- XSTW_DF_LOC_HIER01610000
016200******************************************************************01620000
016300     EXEC SQL                                                     01630000
016400        INCLUDE XST00125                                          01640000
016500     END-EXEC.                                                    01650000
016600                                                                  01660000
016700******************************************************************01670000
016800*  DCLGEN FOR THE LOCATION TABLE - XST_LOC                        01680000
016900******************************************************************01690000
017000     EXEC SQL                                                     01700000
017100        INCLUDE XST00001                                          01710000
017200     END-EXEC.                                                    01720000
017300                                                                  01730000
017400******************************************************************01740000
017500*  DCLGEN FOR THE LOCATION DISTRICT TABLE - XST_LOC_DIST          01750000
017600******************************************************************01760000
017700     EXEC SQL                                                     01770000
017800        INCLUDE XST00002                                          01780000
017900     END-EXEC.                                                    01790000
018000                                                                  01800000
018100******************************************************************01810000
018200*  DCLGEN FOR THE DISTRICT TABLE - XST_DIST                       01820000
018300******************************************************************01830000
018400     EXEC SQL                                                     01840000
018500        INCLUDE XST00003                                          01850000
018600     END-EXEC.                                                    01860000
018700                                                                  01870000
018800******************************************************************01880000
018900*  DCLGEN FOR THE DISTRICT REGION TABLE - XST_DIST_REGN           01890000
019000******************************************************************01900000
019100     EXEC SQL                                                     01910000
019200        INCLUDE XST00004                                          01920000
019300     END-EXEC.                                                    01930000
019400                                                                  01940000
019500******************************************************************01950000
019600*  DCLGEN FOR THE REGION TABLE - XST_REGN                         01960000
019700******************************************************************01970000
019800     EXEC SQL                                                     01980000
019900        INCLUDE XST00005                                          01990000
020000     END-EXEC.                                                    02000000
020100                                                                  02010000
020200******************************************************************02020000
020300*  DCLGEN FOR THE REGION TERRITORY TABLE - XST_REGN_TERR          02030000
020400******************************************************************02040000
020500     EXEC SQL                                                     02050000
020600        INCLUDE XST00006                                          02060000
020700     END-EXEC.                                                    02070000
020800                                                                  02080000
020900******************************************************************02090000
021000*  DCLGEN FOR THE TERRITORY TABLE - XST_TERR                      02100000
021100******************************************************************02110000
021200     EXEC SQL                                                     02120000
021300        INCLUDE XST00007                                          02130000
021400     END-EXEC.                                                    02140000
021500                                                                  02150000
021600******************************************************************02160000
021700*  DCLGEN FOR THE STORE GROUP TABLE - XST_STR_GP                  02170000
021800******************************************************************02180000
021900     EXEC SQL                                                     02190000
022000        INCLUDE XST00022                                          02200000
022100     END-EXEC.                                                    02210000
022200                                                                  02220000
022300******************************************************************02230000
022400*  DCLGEN FOR THE STORE GROUP MEMBERSHIP TABLE - XST_STR_GP_MBSHP 02240000
022500******************************************************************02250000
022600     EXEC SQL                                                     02260000
022700        INCLUDE XST00023                                          02270000
022800     END-EXEC.                                                    02280000
022900                                                                  02290000
023000******************************************************************02300000
023100*   CURSOR TO RETRIEVE CLOSED STORES THAT HAVE BEEN REPLACED      02310000
023200*   IN THE LAST 4 YEARS.                                          02320000
023300******************************************************************02330000
023400     EXEC SQL                                                     02340000
023500       DECLARE XST-CSR CURSOR FOR                                 02350000
023600           SELECT LOC_NBR                                         02360000
023700                 ,REPLT_STR_NBR                                   02370001
023800                 ,CLO_DTE                                         02380001
023900                                                                  02390000
024000        FROM XST_LOC                                              02400000
024100                                                                  02410000
024200        WHERE ((CLO_DTE <> '9999-09-09')                          02420000
024300          AND (CLO_DTE >= CURRENT_DATE - 4 YEARS))                02430000
024400          AND ((REPLT_STR_NBR IS NOT NULL)                        02440000
024500          AND (REPLT_STR_NBR <> 0))                               02450000
024600          AND LOC_TYP_CDE ='DS'                                   02460000
024700                                                                  02470000
024800        WITH UR                                                   02480000
024900     END-EXEC.                                                    02490000
025000                                                                  02500000
025100                                                                  02510000
025200                                                                  02520000
025300 PROCEDURE DIVISION.                                              02530000
025400******************************************************************02540000
025500* MAINLINE                                                        02550000
025600******************************************************************02560000
025700 0000-MAINLINE.                                                   02570000
025800                                                                  02580000
025900     PERFORM 1000-INITIALIZE.                                     02590000
026000                                                                  02600000
026100     PERFORM 2000-PROCESS-CLOSED-STORE                            02610000
026200       UNTIL PS-END-OF-CURSOR.                                    02620000
026300                                                                  02630000
026400     PERFORM 5200-CLOSE-CURSOR.                                   02640001
026500                                                                  02650000
026600     PERFORM 9900-END-OF-JOB-ROUTINE.                             02660001
026700                                                                  02670001
026800     GOBACK.                                                      02680000
026900                                                                  02690000
027000                                                                  02700000
027100******************************************************************02710001
027200* PREFORMS TASK INITIATION                                        02720001
027300******************************************************************02730001
027400 1000-INITIALIZE.                                                 02740001
027500                                                                  02750001
027600     OPEN OUTPUT OUTPUT-FILE.                                     02760001
027700                                                                  02770001
027800     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 02780001
027900                                                                  02790001
028000     MOVE SYS-TIME (1:2) TO ST-BEG-HR.                            02800001
028100     MOVE SYS-TIME (3:2) TO ST-BEG-MN.                            02810001
028200                                                                  02820001
028300     MOVE SYS-DATE (1:2) TO SD-CENT.                              02830001
028400     MOVE SYS-DATE (3:2) TO SD-YEAR.                              02840001
028500     MOVE SYS-DATE (5:2) TO SD-MONTH.                             02850001
028600     MOVE SYS-DATE (7:2) TO SD-DAY.                               02860001
028700                                                                  02870001
028800     PERFORM 1100-GET-CURRENT-DTE.                                02880001
028900                                                                  02890001
029100     DISPLAY '               '.                                   02891003
029200                                                                  02892003
029000     PERFORM 5000-OPEN-CURSOR.                                    02900001
029100     PERFORM 5100-FETCH-CURSOR.                                   02910001
029200                                                                  02920001
029300                                                                  02930001
029400******************************************************************02940000
029500* GET THE CURRENT DATE                                            02950001
029600******************************************************************02960000
029700 1100-GET-CURRENT-DTE.                                            02970001
029800                                                                  02980000
029900     EXEC SQL                                                     02990000
030000          SELECT CURRENT DATE                                     03000000
030100          INTO  :PV-CURRENT-DATE                                  03010000
030200          FROM   SYSIBM.SYSDUMMY1                                 03020000
030300     END-EXEC.                                                    03030000
030400                                                                  03040000
030500      EVALUATE TRUE                                               03050000
030600          WHEN SQLCODE = ZERO                                     03060000
030700              CONTINUE                                            03070000
030800                                                                  03080001
030900          WHEN OTHER                                              03090000
031000              MOVE '1000-INITIALIZE' TO  PV-DB2-OPERATION         03100000
031100              PERFORM 9000-SQL-ABEND                              03110000
031200      END-EVALUATE.                                               03120000
031300                                                                  03130000
031400                                                                  03140001
031500******************************************************************03150000
031600* PROCESSES THE CLOSED STORE WHICH HAS BEEN REPLACED              03160000
031700******************************************************************03170000
031800 2000-PROCESS-CLOSED-STORE.                                       03180000
031900                                                                  03190000
032000     IF  PV-SAVE-CLO-DTE > PV-CURRENT-DATE                        03202005
032100         PERFORM 8000-WRITE-REPLT-STORE                           03210001
032200                                                                  03220001
032300     ELSE                                                         03230000
032400         PERFORM 3000-GET-HIERARCHY-INFO                          03240001
032500                                                                  03250000
032600         IF  PS-HIERARCHY-FOUND                                   03260001
032700             PERFORM 8100-WRITE-LOC-HIER                          03270001
032800                                                                  03280000
032900         END-IF                                                   03290000
033000     END-IF.                                                      03300000
033100                                                                  03310000
033200     PERFORM 5100-FETCH-CURSOR.                                   03320001
033300                                                                  03330000
033400                                                                  03340000
033500******************************************************************03350001
033600* SELECT THE HIERARCHY DATA FOR THE REPLACEMENT STORE.            03360001
033700******************************************************************03370001
033800 3000-GET-HIERARCHY-INFO.                                         03380001
033900                                                                  03390001
034000      EXEC SQL                                                    03400001
034100          SELECT                                                  03410001
034200              DIST.DIST_NBR                                       03420001
034300             ,DIST.DIST_NM                                        03430001
034400             ,REGN.REGN_NBR                                       03440001
034500             ,REGN.REGN_NM                                        03450001
034600             ,TERR.TERR_NBR                                       03460001
034700             ,TERR.TERR_NM                                        03470001
034800             ,SG2.STR_GP_ID                                       03480001
034900             ,SG2.STR_GP_NM                                       03490001
035000             ,SG.STR_GP_ID                                        03500001
035100             ,SG.STR_GP_NM                                        03510001
035200             ,SG1.STR_GP_ID                                       03520001
035300             ,SG1.STR_GP_NM                                       03530001
035400                                                                  03540001
035500          INTO                                                    03550001
035600              :PV-FETCH-DIST-NBR                                  03560001
035700             ,:PV-FETCH-DIST-NM                                   03570001
035800             ,:PV-FETCH-REGN-NBR                                  03580001
035900             ,:PV-FETCH-REGN-NM                                   03590001
036000             ,:PV-FETCH-TERR-NBR                                  03600001
036100             ,:PV-FETCH-TERR-NM                                   03610001
036200             ,:PV-FETCH-METRO-ID                                  03620001
036300             ,:PV-FETCH-METRO-NM                                  03630001
036400             ,:PV-FETCH-GEO-ID                                    03640001
036500             ,:PV-FETCH-GEO-NM                                    03650001
036600             ,:PV-FETCH-CLMT-ID                                   03660001
036700             ,:PV-FETCH-CLMT-NM                                   03670001
036800                                                                  03680001
036900          FROM                                                    03690001
037000               XST_LOC             LOC                            03700001
037100              ,XST_LOC_DIST        LD                             03710001
037200              ,XST_DIST            DIST                           03720001
037300              ,XST_DIST_REGN       DR                             03730001
037400              ,XST_REGN            REGN                           03740001
037500              ,XST_REGN_TERR       RT                             03750001
037600              ,XST_TERR            TERR                           03760001
037700              ,XST_STR_GP_MBSHP    SGM                            03770001
037800              ,XST_STR_GP          SG                             03780001
037900              ,XST_STR_GP_MBSHP    SGM1                           03790001
038000              ,XST_STR_GP          SG1                            03800001
038100              ,XST_STR_GP_MBSHP    SGM2                           03810001
038200              ,XST_STR_GP          SG2                            03820001
038300                                                                  03830001
038400          WHERE  LOC.LOC_TYP_CDE = 'DS'                           03840001
038500            AND LOC.LOC_NBR  = :XST00001-REPLT-STR-NBR            03850001
038600            AND LOC.OPN_DTE <= CURRENT DATE                       03860001
038700            AND LOC.CLO_DTE >= CURRENT DATE - 4 YEARS             03870001
038800                                                                  03880001
038900            AND LOC.MN_SLS_INCL_DTE  IS NOT NULL                  03890001
039000            AND LOC.QTR_SLS_INCL_DTE IS NOT NULL                  03900001
039100            AND LOC.SEA_SLS_INCL_DTE IS NOT NULL                  03910001
039200            AND LOC.YR_SLS_INCL_DTE  IS NOT NULL                  03920001
039300            AND LOC.LOC_NBR = LD.LOC_NBR                          03930001
039400                                                                  03940001
039500            AND LD.BEG_DTE  <= CURRENT DATE                       03950001
039600            AND (LD.END_DTE >= CURRENT DATE - 1 DAY               03960001
039700             OR LD.END_DTE IS NULL)                               03970001
039800                                                                  03980001
039900            AND LD.DIST_NBR   = DIST.DIST_NBR                     03990001
040000            AND DIST.DIST_NBR = DR.DIST_NBR                       04000001
040100                                                                  04010001
040200            AND DR.BEG_DTE  <= CURRENT DATE                       04020001
040300            AND (DR.END_DTE >= CURRENT DATE - 1 DAY               04030001
040400             OR DR.END_DTE IS NULL)                               04040001
040500                                                                  04050001
040600            AND DR.REGN_NBR   = REGN.REGN_NBR                     04060001
040700            AND REGN.REGN_NBR = RT.REGN_NBR                       04070001
040800                                                                  04080001
040900            AND RT.BEG_DTE  <= CURRENT DATE                       04090001
041000            AND (RT.END_DTE >= CURRENT DATE - 1 DAY               04100001
041100             OR RT.END_DTE IS NULL)                               04110001
041200                                                                  04120001
041300            AND RT.TERR_NBR = TERR.TERR_NBR                       04130001
041400            AND LOC.LOC_NBR = SGM2.STR_NBR                        04140001
041500            AND SGM2.STR_GP_TYP_CDE = 2000                        04150001
041600                                                                  04160001
041700            AND SGM2.EFF_BEG_DTE  <= CURRENT DATE                 04170001
041800            AND (SGM2.EFF_END_DTE >= CURRENT DATE - 1 DAY         04180001
041900              OR SGM2.EFF_END_DTE IS NULL)                        04190001
042000                                                                  04200001
042100            AND SGM2.STR_GP_TYP_CDE = SG2.STR_GP_TYP_CDE          04210001
042200            AND SGM2.STR_GP_ID      = SG2.STR_GP_ID               04220001
042300            AND LOC.LOC_NBR         = SGM.STR_NBR                 04230001
042400            AND SGM.STR_GP_TYP_CDE  = 8000                        04240001
042500                                                                  04250001
042600            AND SGM.EFF_BEG_DTE  <= CURRENT DATE                  04260001
042700            AND (SGM.EFF_END_DTE >= CURRENT DATE - 1 DAY          04270001
042800              OR SGM.EFF_END_DTE IS NULL)                         04280001
042900                                                                  04290001
043000            AND SGM.STR_GP_TYP_CDE  = SG.STR_GP_TYP_CDE           04300001
043100            AND SGM.STR_GP_ID       = SG.STR_GP_ID                04310001
043200            AND LOC.LOC_NBR         = SGM1.STR_NBR                04320001
043300            AND SGM1.STR_GP_TYP_CDE = 7000                        04330001
043400                                                                  04340001
043500            AND SGM1.EFF_BEG_DTE  <= CURRENT DATE                 04350001
043600            AND (SGM1.EFF_END_DTE >= CURRENT DATE - 1 DAY         04360001
043700             OR SGM1.EFF_END_DTE IS NULL)                         04370001
043800                                                                  04380001
043900            AND SGM1.STR_GP_TYP_CDE = SG1.STR_GP_TYP_CDE          04390001
044000            AND SGM1.STR_GP_ID      = SG1.STR_GP_ID               04400001
044100                                                                  04410001
044200      END-EXEC.                                                   04420001
044300                                                                  04430001
044400      EVALUATE TRUE                                               04440001
044500          WHEN SQLCODE = ZERO                                     04450001
044600              SET PS-HIERARCHY-FOUND TO TRUE                      04460001
044700                                                                  04470001
044800          WHEN SQLCODE = +100                                     04480001
044900              SET PS-HIERARCHY-NOT-FOUND TO TRUE                  04490001
045000                                                                  04500001
045100          WHEN OTHER                                              04510001
045200              DISPLAY '3000-GET-HIERARCHY-INFO'                   04520001
045300                      ' STR NBR= ' PV-SAVE-CLSD                   04530001
045400                      ' RPL NBR= ' PV-SAVE-REPLT                  04540001
045500              MOVE '3000-GET-HIERARCHY-INFO' TO  PV-DB2-OPERATION 04550001
045600              PERFORM 9000-SQL-ABEND                              04560001
045700      END-EVALUATE.                                               04570001
045800                                                                  04580001
045900                                                                  04590001
046000******************************************************************04600001
046100* OPEN CURSOR                                                     04610001
046200******************************************************************04620001
046300 5000-OPEN-CURSOR.                                                04630001
046400                                                                  04640001
046500     EXEC SQL                                                     04650001
046600          OPEN XST-CSR                                            04660001
046700     END-EXEC.                                                    04670001
046800                                                                  04680001
046900     EVALUATE TRUE                                                04690001
047000         WHEN SQLCODE = +0                                        04700001
047100         WHEN SQLCODE = +100                                      04710001
047200              CONTINUE                                            04720001
047300                                                                  04730001
047400         WHEN OTHER                                               04740001
047500             MOVE '1000-INITIALIZE'          TO PV-PARAGRAPH-NAME 04750001
047600             MOVE 'ERROR ON OPEN OF XST-CSR' TO PV-DB2-OPERATION  04760001
047700                                                                  04770001
047800             PERFORM 9000-SQL-ABEND                               04780001
047900     END-EVALUATE.                                                04790001
048000                                                                  04800001
048300                                                                  04830001
048400******************************************************************04840001
048500* FETCH CURSOR                                                    04850001
048600******************************************************************04860001
048700 5100-FETCH-CURSOR.                                               04870001
048800                                                                  04880001
048900     EXEC SQL                                                     04890001
049000         FETCH XST-CSR                                            04900001
049100          INTO   :XST00001-LOC-NBR,                               04910001
049200                 :XST00001-REPLT-STR-NBR                          04920001
049300                ,:XST00001-CLO-DTE                                04930001
049400     END-EXEC.                                                    04940001
049500                                                                  04950001
049600     EVALUATE TRUE                                                04960001
049700         WHEN SQLCODE = +0                                        04970001
049800             MOVE XST00001-LOC-NBR       TO PV-SAVE-CLSD          04980001
049900             MOVE XST00001-REPLT-STR-NBR TO PV-SAVE-REPLT         04990001
050000             MOVE XST00001-CLO-DTE       TO PV-SAVE-CLO-DTE       05000001
050100                                                                  05010001
050200             DISPLAY '5100-FETCH-CURSOR'                          05020001
050300                     ' STR NBR= ' PV-SAVE-CLSD                    05030001
050400                     ' RPL NBR= ' PV-SAVE-REPLT                   05040001
050500                     ' CLO DTE= ' PV-SAVE-CLO-DTE                 05050001
050600                                                                  05060001
050700         WHEN SQLCODE = +100                                      05070001
050800             MOVE 'Y' TO PS-END-OF-CURSOR-SW                      05080001
050900                                                                  05090001
051000         WHEN OTHER                                               05100001
051100             MOVE '5100-FETCH-CURSOR'       TO PV-PARAGRAPH-NAME  05110001
051200             MOVE 'ERROR ON FETCH XST-CSR'  TO PV-DB2-OPERATION   05120001
051300             PERFORM 9000-SQL-ABEND                               05130001
051400     END-EVALUATE.                                                05140001
051500                                                                  05150001
051600                                                                  05160001
051700******************************************************************05170000
051800* CLOSE CURSOR                                                    05180000
051900******************************************************************05190000
052000 5200-CLOSE-CURSOR.                                               05200001
052100                                                                  05210000
052200     EXEC SQL                                                     05220000
052300          CLOSE XST-CSR                                           05230000
052400     END-EXEC.                                                    05240000
052500                                                                  05250000
052600     EVALUATE TRUE                                                05260000
052700         WHEN SQLCODE = +0                                        05270000
052800              CONTINUE                                            05280000
052900                                                                  05290000
053000         WHEN OTHER                                               05300000
053100             MOVE '5200-CLOSE-CURSOR'         TO PV-PARAGRAPH-NAME05310001
053200             MOVE 'ERROR ON CLOSE OF XST-CSR' TO PV-DB2-OPERATION 05320000
053300             PERFORM 9000-SQL-ABEND                               05330000
053400     END-EVALUATE.                                                05340000
053500                                                                  05350000
053600                                                                  05360000
053700******************************************************************05370001
053800* WRITE OUTPUT FOR REPLACEMENT STORE NUMBER INDICATING NULL       05380001
053900******************************************************************05390001
054000 8000-WRITE-REPLT-STORE.                                          05400001
054100                                                                  05410001
054200     INITIALIZE DF018-UPDT-REC.                                   05420009
054300                                                                  05430001
054400     MOVE 'N'                    TO DF018-NULL-IND.               05440009
054500     MOVE XST00001-LOC-NBR       TO DF018-LOC-NBR.                05450009
056000     MOVE XST00001-REPLT-STR-NBR TO DF018-REPLT-STR.              05451009
056000     MOVE XST00001-CLO-DTE       TO DF018-CLO-DTE.                05452009
054600                                                                  05460001
054700     WRITE OUTPUT-REC FROM DF018-UPDT-REC.                        05470009
054800                                                                  05480001
054900     ADD 1 TO PA-NULL                                             05490002
054900              PA-WRITTEN.                                         05491002
055000                                                                  05500001
055100                                                                  05510001
055200******************************************************************05520001
055300* WRITE OUTPUT FOR THE REPLACEMENT STORE HIERARCHY INFO           05530001
055400******************************************************************05540001
055500 8100-WRITE-LOC-HIER.                                             05550001
055600                                                                  05560001
055700     INITIALIZE DF018-UPDT-REC.                                   05570009
055800                                                                  05580001
055900     MOVE SPACE                  TO DF018-NULL-IND.               05590009
055800                                                                  05591004
056000     MOVE XST00001-LOC-NBR       TO DF018-LOC-NBR.                05600009
056000     MOVE XST00001-REPLT-STR-NBR TO DF018-REPLT-STR.              05601009
056000     MOVE XST00001-CLO-DTE       TO DF018-CLO-DTE.                05602009
055800                                                                  05603004
056100     MOVE PV-FETCH-DIST-NBR      TO DF018-DIST-NBR.               05610009
056200     MOVE PV-FETCH-DIST-NM       TO DF018-DIST-NM.                05620009
056300     MOVE PV-FETCH-REGN-NBR      TO DF018-REGN-NBR.               05630009
056400     MOVE PV-FETCH-REGN-NM       TO DF018-REGN-NM.                05640009
056500     MOVE PV-FETCH-TERR-NBR      TO DF018-TERR-NBR.               05650009
056600     MOVE PV-FETCH-TERR-NM       TO DF018-TERR-NM.                05660009
056700     MOVE PV-FETCH-METRO-ID      TO DF018-METRO-ID.               05670009
056800     MOVE PV-FETCH-METRO-NM      TO DF018-METRO-NM.               05680009
056900     MOVE PV-FETCH-GEO-ID        TO DF018-GEO-ID.                 05690009
057000     MOVE PV-FETCH-GEO-NM        TO DF018-GEO-NM.                 05700009
057100     MOVE PV-FETCH-CLMT-ID       TO DF018-CLMT-ID.                05710009
057200     MOVE PV-FETCH-CLMT-NM       TO DF018-CLMT-NM.                05720009
057300                                                                  05730001
057400     WRITE OUTPUT-REC FROM DF018-UPDT-REC.                        05740009
057500                                                                  05750001
057600     ADD 1 TO PA-REPLACE                                          05760002
057600              PA-WRITTEN.                                         05761002
057700                                                                  05770001
057800                                                                  05780001
057900***************************************************************** 05790000
058000*   ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.  05800000
058100***************************************************************** 05810000
058200 9000-SQL-ABEND.                                                  05820000
058300                                                                  05830000
058400     PERFORM 9900-END-OF-JOB-ROUTINE.                             05840001
058500                                                                  05850001
058600     DISPLAY '** ABEND     **'.                                   05860000
058700     DISPLAY '** PROGRAM   ** = ' PC-PGM-NAME.                    05870000
058800     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              05880001
058900     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               05890000
059000     DISPLAY '** SQLCODE   ** = ' SQLCODE.                        05900001
059100                                                                  05910000
059200******************************************************************05920001
059300* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     05930001
059400* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      05940001
059500******************************************************************05950001
059600     COPY DPPD004.                                                05960001
059700                                                                  05970001
059800     SET AC-DB2-ERROR TO TRUE.                                    05980000
059900                                                                  05990000
060000     CALL 'ILBOABN0' USING ABEND-CODE.                            06000000
060100                                                                  06010000
060200                                                                  06020000
060300******************************************************************06030001
060400* PREFORMS TASK TERMINATION PROCESSING                            06040001
060500******************************************************************06050001
060600 9900-END-OF-JOB-ROUTINE.                                         06060001
060700                                                                  06070001
060800     CLOSE OUTPUT-FILE.                                           06080001
060900                                                                  06090001
061000     PERFORM 9999-CONTROLS.                                       06100001
061100                                                                  06110001
061200                                                                  06120001
061300******************************************************************06130001
061400* DISPLAY CONTROLS FROM THE PROGRAM                               06140001
061500******************************************************************06150001
061600 9999-CONTROLS.                                                   06160001
061700                                                                  06170001
061800     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 06180001
061900                                                                  06190001
062000     MOVE SYS-TIME (1:2) TO ST-END-HR.                            06200001
062100     MOVE SYS-TIME (3:2) TO ST-END-MN.                            06210001
062200                                                                  06220001
062300     DISPLAY '                    '.                              06230001
062400     DISPLAY '**********************'.                            06240001
062500     DISPLAY '   DFKUT021 CONTROLS  '.                            06250001
062600     DISPLAY '**********************'.                            06260001
062700     DISPLAY 'RUN DATE  = ' SD-EDIT-DATE.                         06270001
062800     DISPLAY 'BEG TIME  = ' ST-BEG-TIME.                          06280001
062900     DISPLAY 'END TIME  = ' ST-END-TIME.                          06290001
063000     DISPLAY '======================'.                            06300001
063100     DISPLAY 'WRITTEN = ' PA-WRITTEN.                             06310002
063100     DISPLAY '  NULL STR    = ' PA-NULL.                          06321002
063100     DISPLAY '  REPLACEMENT = ' PA-REPLACE.                       06321102
063200     DISPLAY '                '.                                  06322002
063300                                                                  06330001
063400                                                                  06340001
