000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.    XSKUP062.                                         00020000
000300 AUTHOR.        BARB ERTL.                                        00030000
000400 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00040000
000500 DATE-WRITTEN.  11/29/2002.                                       00050000
000600 DATE-COMPILED.                                                   00060000
000700******************************************************************00070000
000800**       METRO PRICE DATA MESSAGE TO POPULATE XST_STR_GP          00080000
000900******************************************************************00090000
001000**THIS IS A CALLED MODULE FOR LOCATION TABLES.  THIS PROGRAM      00100000
001100**     WILL PERFORM UPDATES/INSERTS/DELETES FOR THE               00110000
001200**     XST_STR_GP TABLE.  IT DOES THE FOLLOWING WITH              00120000
001300**     THESE RETURN CODES:                                        00130000
001400**     0000 - END PROGRAM                                         00140000
001500**    -0530 - END PROGRAM                                         00150000
001600**    -0803 - END PROGRAM                                         00160000
001700**    -0911 - RETRY INSERT UP TO 5 TIMES AND THEN END PROGRAM     00170000
001800******************************************************************00180000
001900 ENVIRONMENT DIVISION.                                            00190000
002000 CONFIGURATION SECTION.                                           00200000
002100 SOURCE-COMPUTER.  IBM-3090.                                      00210000
002200 OBJECT-COMPUTER.  IBM-3090.                                      00220000
002300 DATA DIVISION.                                                   00230000
002400                                                                  00240000
002500 WORKING-STORAGE SECTION.                                         00250000
002600******************************************************************00260000
002700**PROGRAM SWITCHES                                                00270000
002800******************************************************************00280000
002900 01  PS-PROGRAM-SWITCHES.                                         00290000
003000     05  PS-PROCESS-CONTINUE-SW      PIC X(01)  VALUE 'Y'.        00300000
003100         88  PS-PROCESS-CONTINUE                VALUE 'Y'.        00310000
003200         88  PS-PROCESS-COMPLETE                VALUE 'N'.        00320000
003300******************************************************************00330000
003400**PROGRAM CONSTANTS                                               00340000
003500******************************************************************00350000
003600 01  PC-PROGRAM-CONSTANTS.                                        00360000
003700     05  PC-RETRY-MAX                PIC 9(01)  VALUE 5.          00370000
003800******************************************************************00380000
003900**PROGRAM VARIABLES                                               00390000
004000******************************************************************00400000
004100 01  PV-PROGRAM-VARIABLES.                                        00410000
004200     05  PV-RETRY-COUNTER            PIC 9(01)  VALUE ZEROS.      00420000
004300     05  PV-RETURN-CODE              PIC S9(04) VALUE 0.          00430000
004400     05  PV-STR-GP-IND               PIC X(01)  VALUE SPACES.     00440000
004500******************************************************************00450000
004600**COPYBOOKS                                                       00460000
004700******************************************************************00470000
004800***DB2 MESSAGE AREA                                               00480000
004900     COPY SQLCA2.                                                 00490007
005000***MESSAGE COPYBOOK                                               00500000
005100     COPY HORD100.                                                00510007
005200******************************************************************00520000
005300**TABLE INCLUSIONS                                                00530000
005400******************************************************************00540000
005500***DB2 COMMUNICATIONS AREA                                        00550000
005600     EXEC SQL                                                     00560000
005700          INCLUDE SQLCA                                           00570000
005800     END-EXEC.                                                    00580000
005900* ------------------------------------------------------------- * 00590000
006000*  SQL AND COBOL DECLARATIONS FOR STORE GROUP TABLE               00600000
006100*  XST_STR_GP                                                     00610000
006200* ------------------------------------------------------------- * 00620000
006300     EXEC SQL                                                     00630000
006400         INCLUDE XST00022                                         00640000
006500     END-EXEC.                                                    00650000
006600                                                                  00660000
006700* ------------------------------------------------------------- * 00670000
006800*  SQL AND COBOL DECLARATIONS FOR STORE GROUP MEMBERSHIP TABLE    00680000
006900*  XST_STR_GP_MBSHP                                               00690000
007000* ------------------------------------------------------------- * 00700000
007100     EXEC SQL                                                     00710000
007200         INCLUDE XST00023                                         00720000
007300     END-EXEC.                                                    00730000
007400                                                                  00740000
007500 LINKAGE SECTION.                                                 00750000
007600******************************************************************00760000
007700**LINKAGE VARIABLES                                               00770000
007800******************************************************************00780000
007900 01  LV-LINKAGE-VARIABLES.                                        00790000
008000     05  LV-HORD100-RECORD               PIC X(500).              00800000
008100     05  LV-RETURN-CODE                  PIC S9(04).              00810000
008200                                                                  00820000
008300 PROCEDURE DIVISION USING LV-LINKAGE-VARIABLES.                   00830000
008400******************************************************************00840000
008500 0000-MAINLINE.                                                   00850000
008600                                                                  00860000
008700      PERFORM 1000-INITIALIZATION.                                00870000
008800      PERFORM 2000-PROCESS-MESSAGE                                00880000
008900              UNTIL PS-PROCESS-COMPLETE.                          00890000
009000      PERFORM 9999-WRAPUP.                                        00900000
009100                                                                  00910000
009200***************************************************************** 00920000
009300**INITIALIZATION AREA - ALL MOVES TO UPDATE/INSERT                00930000
009400***************************************************************** 00940000
009500 1000-INITIALIZATION.                                             00950000
009600                                                                  00960000
009700     INITIALIZE PV-RETRY-COUNTER                                  00970000
009800                PV-RETURN-CODE                                    00980000
009900                PV-STR-GP-IND.                                    00990000
010000                                                                  01000000
010100     SET PS-PROCESS-CONTINUE         TO TRUE.                     01010000
010200                                                                  01020000
010300     MOVE LV-HORD100-RECORD          TO HORD100-RECORD.           01030000
010400                                                                  01040000
010500     MOVE HO100-METRO-GROUP-ID       TO XST00022-STR-GP-TYP-CDE.  01050002
010600     MOVE HO100-METRO-ZONE-ID        TO XST00022-STR-GP-ID.       01060002
010700     MOVE HO100-METRO-DESCRIPTION    TO XST00022-STR-GP-NM.       01070002
010800     MOVE HO100-METRO-ST-CDE         TO XST00022-ST-CDE.          01080002
010900     MOVE HO100-METRO-RPT-FLSH-SLS-IND                            01090002
011000                                     TO XST00022-RPT-FLSH-SLS-IND.01100000
011100***************************************************************** 01110000
011200**MAIN PROGRAM LOGIC - READS ACTION TYPE ON HORD100 RECORD        01120000
011300***************************************************************** 01130000
011400 2000-PROCESS-MESSAGE.                                            01140000
011500                                                                  01150000
011600     EVALUATE TRUE                                                01160000
011700        WHEN HO100-ACTN-TYP-INSERT                                01170000
011800             PERFORM 2100-INSERT-DATA                             01180000
011900             IF PS-PROCESS-CONTINUE                               01190006
012000                 PERFORM 2200-UPDATE-DATA                         01200006
012100             END-IF                                               01210006
012200        WHEN HO100-ACTN-TYP-UPDATE                                01220000
012300             PERFORM 2200-UPDATE-DATA                             01230000
012400        WHEN HO100-ACTN-TYP-DELETE                                01240000
012500             PERFORM 2400-CHECK-STR-GP-MBSHP                      01250000
012600             IF PS-PROCESS-CONTINUE                               01260000
012700                 PERFORM 2300-DELETE-DATA                         01270000
012800             END-IF                                               01280000
012900     END-EVALUATE.                                                01290000
013000                                                                  01300000
013100     IF HO100-ACTN-TYP-DELETE                                     01310008
013200         IF SQLCODE = +100                                        01320008
013300             MOVE ZERO TO PV-RETURN-CODE                          01330008
013400         ELSE                                                     01340008
013500             MOVE SQLCODE TO PV-RETURN-CODE                       01350008
013600         END-IF                                                   01360008
013700     ELSE                                                         01370008
013800         MOVE SQLCODE TO PV-RETURN-CODE                           01380008
013900     END-IF.                                                      01390008
014000                                                                  01400000
014100***************************************************************** 01410000
014200**INSERT ACTION TYPE                                              01420000
014300***************************************************************** 01430000
014400 2100-INSERT-DATA.                                                01440000
014500                                                                  01450000
014600     PERFORM                                                      01460001
014700         WITH TEST AFTER                                          01470001
014800         VARYING PV-RETRY-COUNTER                                 01480001
014900         FROM 1 BY 1                                              01490001
015000         UNTIL PV-RETRY-COUNTER > PC-RETRY-MAX                    01500001
015100            OR SQLCODE = 0                                        01510001
015200            OR SQLCODE = -803                                     01520006
015300            OR PS-PROCESS-COMPLETE                                01530001
015400                                                                  01540001
015500         EXEC SQL                                                 01550001
015600             INSERT INTO XST_STR_GP                               01560001
015700                 (STR_GP_TYP_CDE                                  01570001
015800                , STR_GP_ID                                       01580001
015900                , STR_GP_NM                                       01590001
016000                , ST_CDE                                          01600001
016100                , RPT_FLSH_SLS_IND)                               01610001
016200             VALUES (: XST00022-STR-GP-TYP-CDE                    01620001
016300                   , : XST00022-STR-GP-ID                         01630001
016400                   , : XST00022-STR-GP-NM                         01640001
016500                   , : XST00022-ST-CDE                            01650001
016600                   , : XST00022-RPT-FLSH-SLS-IND)                 01660001
016700         END-EXEC                                                 01670001
016800                                                                  01680000
016900         EVALUATE TRUE                                            01690001
017000             WHEN SQLCODE = -911                                  01700001
017100             WHEN SQLCODE = -913                                  01710001
017200             WHEN SQLCODE = 0                                     01720001
017300             WHEN SQLCODE = -803                                  01730006
017400                 CONTINUE                                         01740001
017500             WHEN SQLWARN0 NOT = SPACE                            01750001
017600             WHEN SQLCODE NOT =  ZERO                             01760001
017700                 SET PS-PROCESS-COMPLETE TO TRUE                  01770001
017800         END-EVALUATE                                             01780001
017900     END-PERFORM.                                                 01790001
018000                                                                  01800001
018100     EVALUATE TRUE                                                01810000
018200        WHEN SQLCODE = -913                                       01820000
018300        WHEN SQLCODE = -911                                       01830000
018400             IF  PV-RETRY-COUNTER >= PC-RETRY-MAX                 01840000
018500                 SET PS-PROCESS-COMPLETE TO TRUE                  01850000
018600             ELSE                                                 01860000
018700                 ADD +1                  TO PV-RETRY-COUNTER      01870000
018800             END-IF                                               01880000
018900        WHEN SQLCODE = -803                                       01890006
019000             CONTINUE                                             01900006
019100        WHEN OTHER                                                01910000
019200             SET PS-PROCESS-COMPLETE     TO TRUE                  01920000
019300     END-EVALUATE.                                                01930000
019400                                                                  01940000
019500******************************************************************01950000
019600**UPDATE ACTION TYPE                                              01960000
019700******************************************************************01970000
019800 2200-UPDATE-DATA.                                                01980000
019900                                                                  01990000
020000     PERFORM                                                      02000001
020100         WITH TEST AFTER                                          02010001
020200         VARYING PV-RETRY-COUNTER                                 02020001
020300         FROM 1 BY 1                                              02030001
020400         UNTIL PV-RETRY-COUNTER > PC-RETRY-MAX                    02040001
020500            OR SQLCODE = 0                                        02050001
020600            OR PS-PROCESS-COMPLETE                                02060001
020700                                                                  02070001
020800         EXEC SQL                                                 02080001
020900             UPDATE XST_STR_GP                                    02090001
021000                SET STR_GP_NM        = : XST00022-STR-GP-NM       02100003
021100                   ,ST_CDE           = : XST00022-ST-CDE          02110005
021200                   ,RPT_FLSH_SLS_IND =                            02120005
021300                                 : XST00022-RPT-FLSH-SLS-IND      02130004
021400              WHERE STR_GP_TYP_CDE = : XST00022-STR-GP-TYP-CDE    02140001
021500                AND STR_GP_ID      = : XST00022-STR-GP-ID         02150001
021600         END-EXEC                                                 02160001
021700                                                                  02170000
021800         EVALUATE TRUE                                            02180001
021900             WHEN SQLCODE = -911                                  02190001
022000             WHEN SQLCODE = -913                                  02200001
022100             WHEN SQLCODE = 0                                     02210001
022200                 CONTINUE                                         02220001
022300             WHEN SQLWARN0 NOT = SPACE                            02230001
022400             WHEN SQLCODE NOT =  ZERO                             02240001
022500                 SET PS-PROCESS-COMPLETE TO TRUE                  02250001
022600         END-EVALUATE                                             02260001
022700     END-PERFORM.                                                 02270001
022800                                                                  02280001
022900     EVALUATE TRUE                                                02290000
023000        WHEN SQLCODE = -911                                       02300000
023100             IF  PV-RETRY-COUNTER >= PC-RETRY-MAX                 02310000
023200                 SET PS-PROCESS-COMPLETE TO TRUE                  02320000
023300             ELSE                                                 02330000
023400                 ADD +1                  TO PV-RETRY-COUNTER      02340000
023500             END-IF                                               02350000
023600        WHEN OTHER                                                02360000
023700             SET PS-PROCESS-COMPLETE     TO TRUE                  02370000
023800     END-EVALUATE.                                                02380000
023900                                                                  02390000
024000******************************************************************02400000
024100**DELETE TYPE ACTION                                              02410000
024200******************************************************************02420000
024300 2300-DELETE-DATA.                                                02430000
024400                                                                  02440000
024500     PERFORM                                                      02450001
024600         WITH TEST AFTER                                          02460001
024700         VARYING PV-RETRY-COUNTER                                 02470001
024800         FROM 1 BY 1                                              02480001
024900         UNTIL PV-RETRY-COUNTER > PC-RETRY-MAX                    02490001
025000            OR SQLCODE = 0                                        02500001
025100            OR PS-PROCESS-COMPLETE                                02510001
025200                                                                  02520001
025300         EXEC SQL                                                 02530001
025400             DELETE FROM XST_STR_GP                               02540001
025500             WHERE STR_GP_TYP_CDE = : XST00022-STR-GP-TYP-CDE     02550001
025600               AND STR_GP_ID      = : XST00022-STR-GP-ID          02560001
025700         END-EXEC                                                 02570001
025800                                                                  02580000
025900         EVALUATE TRUE                                            02590001
026000             WHEN SQLCODE = -911                                  02600001
026100             WHEN SQLCODE = -913                                  02610001
026200             WHEN SQLCODE = 0                                     02620001
026300             WHEN SQLCODE = +100                                  02630007
026400                 CONTINUE                                         02640001
026500             WHEN SQLWARN0 NOT = SPACE                            02650001
026600             WHEN SQLCODE NOT =  ZERO                             02660001
026700                 SET PS-PROCESS-COMPLETE TO TRUE                  02670001
026800         END-EVALUATE                                             02680001
026900     END-PERFORM.                                                 02690001
027000                                                                  02700001
027100     EVALUATE TRUE                                                02710000
027200        WHEN SQLCODE = -911                                       02720000
027300        WHEN SQLCODE = -913                                       02730000
027400             IF  PV-RETRY-COUNTER >= PC-RETRY-MAX                 02740000
027500                 SET PS-PROCESS-COMPLETE TO TRUE                  02750000
027600             ELSE                                                 02760000
027700                 ADD +1                  TO PV-RETRY-COUNTER      02770000
027800             END-IF                                               02780000
027900        WHEN OTHER                                                02790000
028000             SET PS-PROCESS-COMPLETE     TO TRUE                  02800000
028100     END-EVALUATE.                                                02810000
028200                                                                  02820000
028300* ------------------------------------------------------------- * 02830000
028400* READ XST_STR_GP MBSHP TO BE SURE STR_GP_ID IS NOT BEING USED    02840000
028500*  BEFORE DELETING THE ROW ON THE STR_GP TABLE.                   02850000
028600* ------------------------------------------------------------- * 02860000
028700 2400-CHECK-STR-GP-MBSHP.                                         02870000
028800                                                                  02880000
028900     EXEC SQL                                                     02890000
029000       SELECT 'Y'                                                 02900000
029100         INTO :PV-STR-GP-IND                                      02910000
029200         FROM XST_STR_GP_MBSHP                                    02920000
029300        WHERE  STR_GP_TYP_CDE = :XST00022-STR-GP-TYP-CDE          02930000
029400          AND  STR_GP_ID      = :XST00022-STR-GP-ID               02940000
029500     END-EXEC                                                     02950000
029600                                                                  02960000
029700     EVALUATE TRUE                                                02970000
029800        WHEN SQLCODE = -911                                       02980000
029900        WHEN SQLCODE = -913                                       02990000
030000             IF  PV-RETRY-COUNTER >= PC-RETRY-MAX                 03000000
030100                 SET PS-PROCESS-COMPLETE TO TRUE                  03010000
030200             ELSE                                                 03020000
030300                 ADD +1                  TO PV-RETRY-COUNTER      03030000
030400             END-IF                                               03040000
030500        WHEN SQLCODE = +100                                       03050000
030600             CONTINUE                                             03060000
030700        WHEN SQLCODE = ZERO                                       03070000
030800        WHEN SQLCODE = -811                                       03080000
030900             DISPLAY 'STR-GP-TYP-CD/STR-GP-ID '                   03090000
031000             HO100-PZ-GROUP-ID '/' HO100-PZ-ZONE-ID               03100000
031100             ' IN USE'                                            03110000
031200        WHEN OTHER                                                03120000
031300             SET PS-PROCESS-COMPLETE     TO TRUE                  03130000
031400     END-EVALUATE.                                                03140000
031500                                                                  03150000
031600******************************************************************03160000
031700**PASS SQLCODE TO CALLING AND EXIT PROGRAM                        03170000
031800******************************************************************03180000
031900 9999-WRAPUP.                                                     03190000
032000                                                                  03200000
032100     MOVE PV-RETURN-CODE TO LV-RETURN-CODE.                       03210000
032200                                                                  03220000
032300     EXIT PROGRAM.                                                03230000
