000100***************************************************************** 00010034
000200 IDENTIFICATION DIVISION.                                         00020034
000300***************************************************************** 00030034
000400 PROGRAM-ID.    PCKUT012.                                         00040034
000500 AUTHOR.        DENISE HAHN.                                      00050034
000600 INSTALLATION.  KOHLS.                                            00060034
000700 DATE-WRITTEN   OCTOBER 2000.                                     00070034
000800 DATE-COMPILED.                                                   00080034
000900***************************************************************** 00090034
001000*  THIS BATCH DB2 PROGRAM READS A FILE CONTAINING ASN PACKSLIP  * 00100034
001100*  INFORMATION, CREATES A TEMPORARY FILE THAT WILL BE USED BY   * 00110034
001200*  PCKUT013 WITH ALL OF THE CARTON COMBINATIONS FROM UCC128     * 00120034
001300*  DATA. (TSHPSUM WILL BE USED BY ONLINE CASEPACK SPLIT APPL)   * 00130034
001400***************************************************************** 00140034
      * DAVE WELLER 10/07/2014                                          00140135
      *     PO-NBR IN PCRD007 AND RCRD052 WERE EXPANDED FROM 7 TO 9     00140235
001400***************************************************************** 00141035
001500 ENVIRONMENT DIVISION.                                            00150034
001600 INPUT-OUTPUT SECTION.                                            00160034
001700                                                                  00170034
001800 FILE-CONTROL.                                                    00180034
001900                                                                  00190034
002000     SELECT INPUT-FILE     ASSIGN TO UT-S-INP01.                  00200034
002100     SELECT OUTPUT-FILE    ASSIGN TO UT-S-OUT01.                  00210034
002200                                                                  00220034
002300***************************************************************** 00230034
002400 DATA DIVISION.                                                   00240034
002500***************************************************************** 00250034
002600 FILE SECTION.                                                    00260034
002700                                                                  00270034
002800 FD  INPUT-FILE                                                   00280034
002900     RECORDING MODE IS F                                          00290034
003000     LABEL RECORDS ARE STANDARD                                   00300034
003100     RECORD CONTAINS 150                                          00310034
003200     BLOCK CONTAINS 0 RECORDS                                     00320034
003300     DATA RECORD IS INPUT-RECORD.                                 00330034
003400 01  INPUT-RECORD                PIC X(150).                      00340034
003500                                                                  00350034
003600 FD  OUTPUT-FILE                                                  00360034
003700     RECORDING MODE IS F                                          00370034
003800     LABEL RECORDS ARE STANDARD                                   00380034
003900     RECORD CONTAINS 330                                          00390034
004000     BLOCK CONTAINS 0 RECORDS                                     00400034
004100     DATA RECORD IS OUTPUT-RECORD.                                00410034
004200 01  OUTPUT-RECORD               PIC X(330).                      00420034
004300                                                                  00430034
004400***************************************************************** 00440034
004500 WORKING-STORAGE SECTION.                                         00450034
004600                                                                  00460034
004700 01  PS-PROGRAM-SWITCHES.                                         00470034
004800     05  PS-EOF-INPUT-SW              PIC X(01)  VALUE 'N'.       00480034
004900         88  PS-EOF-INPUT-YES                    VALUE 'Y'.       00490034
005000         88  PS-EOF-INPUT-NO                     VALUE 'N'.       00500034
005100     05  PS-ERROR-SW                  PIC X(01)  VALUE 'N'.       00510034
005200         88  PS-ERROR-YES                        VALUE 'Y'.       00520034
005300         88  PS-ERROR-NO                         VALUE 'N'.       00530034
005400     05  PS-EOF-CARTON-CSR-SW         PIC X(01)  VALUE 'N'.       00540034
005500         88  PS-EOF-CARTON-CSR                   VALUE 'Y'.       00550034
005600         88  PS-NOT-EOF-CARTON-CSR               VALUE 'N'.       00560034
005700                                                                  00570034
005800 01  PC-PROGRAM-CONSTANTS.                                        00580034
005900     05  PC-PROGRAM-NAME              PIC  X(08) VALUE 'PCKUT012'.00590034
006000     05  PC-ZERO                      PIC S9(04) VALUE ZERO COMP. 00600034
006100                                                                  00610034
006200 01  PV-PROGRAM-VARIABLES.                                        00620034
006300     05  PV-DISP-PO                   PIC 9(09).                  00630034
006400     05  PV-DISP-SEQ                  PIC 9(04).                  00640034
006500     05  PV-DISP-RCVR-SEQ             PIC 9(09).                  00650034
006600     05  PV-DISP-ENT-ID               PIC 9(09).                  00660034
006700     05  PV-SQLCODE                   PIC S9(9)  VALUE +0.        00670034
006800     05  PV-DISP-SQLCODE              PIC ZZZZZZ9-.               00680034
006900     05  PV-PREV-PO-NBR               PIC 9(09).                  00690034
007000     05  PV-PREV-SEQ-NBR              PIC 9(04).                  00700034
007100     05  PV-PREV-SHIPT-UNT-ID         PIC 9(18).                  00710034
007200     05  PV-TSHPSUM-COUNT             PIC S9(09) COMP.            00720034
007300     05  PV-TDISTHD-COUNT             PIC S9(09) COMP.            00730034
007400                                                                  00740034
007500     05  PV-RECORDS-READ              PIC  9(9)  VALUE ZERO.      00750034
007600     05  PV-RECORDS-WRITTEN           PIC  9(9)  VALUE ZERO.      00760034
007610     05  PV-CARTONS-BYPASSED          PIC  9(9)  VALUE ZERO.      00761034
007620                                                                  00762034
007630 01  DK-DATABASE-KEYS.                                            00763034
007640     05  DK-PO-NBR                    PIC S9(9)  VALUE +0 COMP.   00764034
007650     05  DK-SEQ-NBR                   PIC S9(4)  VALUE +0 COMP.   00765034
007660     05  DK-RCVR-SEQ-NBR              PIC S9(8)  VALUE +0 COMP.   00766034
007670                                                                  00767034
007680 01  PV-ABEND-FIELDS.                                             00768034
007690     05  PV-ABEND-CODE                PIC  S9(4) VALUE +0         00769034
007700                                                 COMP SYNC.       00770034
007800     05  PV-ABEND-PROGRAM             PIC  X(08) VALUE 'PCKUT012'.00780034
007900     05  PV-ABEND-PARAGRAPH           PIC  X(50) VALUE SPACES.    00790034
008000     05  PV-ABEND-OPERATION           PIC  X(50) VALUE SPACES.    00800034
008100     05  PV-ABEND-STRUCTURE-1         PIC  X(08) VALUE SPACES.    00810034
008200     05  PV-ABEND-STRUCTURE-2         PIC  X(08) VALUE SPACES.    00820034
008300     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    00830034
008400     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    00840034
008500     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    00850034
008600                                                                  00860034
008700                                                                  00870034
008800***********************************************************       00880034
008900*  COPYBOOK USED FOR THE INPUT FILE.                      *       00890034
009000***********************************************************       00900034
009100     COPY RCRD052.                                                00910034
009200                                                                  00920034
009300***********************************************************       00930034
009400*  COPYBOOK USED FOR THE OUTPUT FILE.                     *       00940034
009500***********************************************************       00950034
009600     COPY PCRD007.                                                00960034
009700                                                                  00970034
009800***********************************************************       00980034
009900*  USED FOR DB2 ERROR MESSAGE BUILDING                    *       00990034
010000***********************************************************       01000034
010100     COPY DPWS004.                                                01010034
010200                                                                  01020034
010300***********************************************************       01030034
010400*  DB2 SQL COMMUNICATION AREA                             *       01040034
010500***********************************************************       01050034
010600     EXEC SQL                                                     01060034
010700          INCLUDE SQLCA                                           01070034
010800     END-EXEC.                                                    01080034
010900                                                                  01090034
011000***********************************************************       01100034
011100*  RC-PACK SLIP                                           *       01110034
011200***********************************************************       01120034
011300     EXEC SQL                                                     01130034
011400          INCLUDE TPKSLIP                                         01140034
011500     END-EXEC.                                                    01150034
011600                                                                  01160034
011700***********************************************************       01170034
011800*  PO-PURCHASE TABLE                                      *       01180034
011900***********************************************************       01190034
012000     EXEC SQL                                                     01200034
012100          INCLUDE TPURCHS                                         01210034
012200     END-EXEC.                                                    01220034
012300                                                                  01230034
012400***********************************************************       01240034
012500*  EX-EXTERNAL ENTERPRISE                                 *       01250034
012600***********************************************************       01260034
012700     EXEC SQL                                                     01270034
012800          INCLUDE TEXTENT                                         01280034
012900     END-EXEC.                                                    01290034
013000                                                                  01300034
013100***********************************************************       01310034
013200*  DC-DISTRIBUTION TRANSACTION HEADER                     *       01320034
013300***********************************************************       01330034
013400     EXEC SQL                                                     01340034
013500          INCLUDE TDISTHD                                         01350034
013600     END-EXEC.                                                    01360034
013700                                                                  01370034
013800***********************************************************       01380034
013900*  SU-INBOUND EDI PACKLIST/VENDOR SHIPMENT UNIT ASSOCIATN *       01390034
014000***********************************************************       01400034
014100     EXEC SQL                                                     01410034
014200          INCLUDE TINPKSU                                         01420034
014300     END-EXEC.                                                    01430034
014400                                                                  01440034
014500***********************************************************       01450034
014600*  SU-SHIPMENT UNIT/UPC ASSOCIATION                       *       01460034
014700***********************************************************       01470034
014800     EXEC SQL                                                     01480034
014900          INCLUDE TSHUUPC                                         01490034
015000     END-EXEC.                                                    01500034
015100                                                                  01510034
015200***********************************************************       01520034
015300*  SU-SHIPMENT CARTON SUMMARY                             *       01530034
015400***********************************************************       01540034
015500     EXEC SQL                                                     01550034
015600          INCLUDE TSHPSUM                                         01560034
015700     END-EXEC.                                                    01570034
015800                                                                  01580034
015900******************************************************************01590034
016000* CARTON CURSOR                                                  *01600034
016100******************************************************************01610034
016200     EXEC SQL                                                     01620034
016300       DECLARE CARTON-CSR CURSOR FOR                              01630034
016400         SELECT B.SHIPT_UNT_ID                                    01640034
016500              , B.TRN_LNE_NBR                                     01650034
016600              , SUM(B.SHPD_QTY)                                   01660034
016700           FROM TINPKSU A                                         01670034
016800              , TSHUUPC B                                         01680034
016900          WHERE A.PO_NBR        = :DK-PO-NBR                      01690034
017000            AND A.SEQ_NBR       = :DK-SEQ-NBR                     01700034
017100            AND A.SHIPT_UNT_ID  = B.SHIPT_UNT_ID                  01710034
017200       GROUP BY B.SHIPT_UNT_ID                                    01720034
017300              , B.TRN_LNE_NBR                                     01730034
017400       ORDER BY 1,2,3                                             01740034
017500     END-EXEC.                                                    01750034
017600                                                                  01760034
017700                                                                  01770034
017800***************************************************************** 01780034
017900 PROCEDURE DIVISION.                                              01790034
018000***************************************************************** 01800034
018100     DISPLAY '**** BEGINNING PCKUT012 ****'.                      01810034
018200     DISPLAY ' '.                                                 01820034
018300                                                                  01830034
018400     OPEN INPUT  INPUT-FILE                                       01840034
018500          OUTPUT OUTPUT-FILE                                      01850034
018600                                                                  01860034
018700     PERFORM 1000-READ-INPUT-FILE.                                01870034
018800                                                                  01880034
018810     MOVE  RC052-PO-NBR      TO  PV-PREV-PO-NBR.                  01881034
018820     MOVE  RC052-SEQ-NBR     TO  PV-PREV-SEQ-NBR.                 01882034
018830     PERFORM 2000-PROCESS-INPUT-FILE                              01883034
018840       UNTIL PS-EOF-INPUT-YES.                                    01884034
018850                                                                  01885034
018860     CLOSE INPUT-FILE                                             01886034
018870           OUTPUT-FILE.                                           01887034
018880                                                                  01888034
018890     DISPLAY ' '.                                                 01889034
018900     DISPLAY '  INPUT RECORDS READ       = ' PV-RECORDS-READ.     01890034
019000     DISPLAY '  SUMMARY RECORDS WRITTEN  = ' PV-RECORDS-WRITTEN.  01900034
019100     DISPLAY '  CARTON RECORDS BYPASSED  = ' PV-CARTONS-BYPASSED. 01910034
019200     DISPLAY ' '.                                                 01920034
019300     DISPLAY '****  END OF  PCKUT012  ****'.                      01930034
019400                                                                  01940034
019500     GOBACK.                                                      01950034
019600                                                                  01960034
019700                                                                  01970034
019800***************************************************************** 01980034
019900*                                                               * 01990034
020000***************************************************************** 02000034
020100 1000-READ-INPUT-FILE.                                            02010034
020200                                                                  02020034
020300     MOVE '1000-READ-INPUT-FILE    ' TO PV-ABEND-PARAGRAPH.       02030034
020400                                                                  02040034
020500     READ INPUT-FILE                                              02050034
020600          INTO RC052-ASN-RECVR-PKSLIP-RECORD                      02060034
020700            AT END                                                02070034
020800               SET PS-EOF-INPUT-YES TO TRUE                       02080034
020900                                                                  02090034
021000            NOT AT END                                            02100034
021100               SET PS-EOF-INPUT-NO  TO TRUE                       02110034
021200               ADD +1 TO PV-RECORDS-READ                          02120034
021300     END-READ.                                                    02130034
021400                                                                  02140034
021500                                                                  02150034
021600***************************************************************** 02160034
021700*                                                               * 02170034
021800***************************************************************** 02180034
021900 2000-PROCESS-INPUT-FILE.                                         02190034
022000                                                                  02200034
022100     MOVE '2000-PROCESS-INPUT-FILE ' TO PV-ABEND-PARAGRAPH.       02210034
022200                                                                  02220034
022300     MOVE  RC052-PO-NBR      TO  DK-PO-NBR                        02230034
022400                                 PV-DISP-PO.                      02240034
022500     MOVE  RC052-SEQ-NBR     TO  DK-SEQ-NBR                       02250034
022600                                 PV-DISP-SEQ                      02260034
022700     SET   PS-ERROR-NO       TO  TRUE.                            02270034
022800                                                                  02280034
022900     PERFORM 2010-VALIDATE-PACKSLIP.                              02290034
023000                                                                  02300034
023100     IF  PS-ERROR-NO                                              02310034
023200         PERFORM 2020-PACK-BY-STORE                               02320034
023300     END-IF.                                                      02330034
023400                                                                  02340034
023500* DMH DELETE - 1/24/02 - BEGIN                                    02350034
023600*    IF  PS-ERROR-NO                                              02360034
023700*        PERFORM 2030-VALIDATE-VENDOR                             02370034
023800*    END-IF.                                                      02380034
023900* DMH DELETE - 1/24/02 - BEGIN                                    02390034
024000                                                                  02400034
024100     IF  PS-ERROR-NO                                              02410034
024200         IF  RC052-PO-NBR     =  PV-PREV-PO-NBR  AND              02420034
024300             RC052-SEQ-NBR    =  PV-PREV-SEQ-NBR AND              02430034
024400             PV-RECORDS-READ  > 1                                 02440034
024500             CONTINUE                                             02450034
024600         ELSE                                                     02460034
024700                                                                  02470034
024800             PERFORM 2040-CHECK-TSHPSUM                           02480034
024900             IF  PV-TSHPSUM-COUNT     >  0                        02490034
025000                 IF  PKSLIP-REC-SEQ-NBR  >  0                     02500034
025100                     MOVE PKSLIP-REC-SEQ-NBR  TO DK-RCVR-SEQ-NBR  02510034
025200                     PERFORM 2050-CHECK-DISTRO-TBL                02520034
025300                 ELSE                                             02530034
025400                     PERFORM 2060-DELETE-TSHPSUM                  02540034
025500                 END-IF                                           02550034
025600             END-IF                                               02560034
025700             MOVE RC052-PO-NBR   TO PV-PREV-PO-NBR                02570034
025800             MOVE RC052-SEQ-NBR  TO PV-PREV-SEQ-NBR               02580034
025900         END-IF                                                   02590034
026000     END-IF.                                                      02600034
026100                                                                  02610034
026200     IF  PS-ERROR-NO                                              02620034
026300         SET  PS-NOT-EOF-CARTON-CSR  TO  TRUE                     02630034
026400         PERFORM 2070-CARTON-SUMMARY                              02640034
026500           UNTIL PS-EOF-CARTON-CSR                                02650034
026600              OR PS-ERROR-YES                                     02660034
026700     END-IF.                                                      02670034
026800                                                                  02680034
026900     PERFORM 1000-READ-INPUT-FILE.                                02690034
027000                                                                  02700034
027100                                                                  02710034
027200***************************************************************** 02720034
027300* CHECK FOR VALID PACKSLIP - +100 MEANS DOES NOT EXIST OF IS NO * 02730034
027400* LONGER ACTIVE                                                 * 02740034
027500***************************************************************** 02750034
027600 2010-VALIDATE-PACKSLIP.                                          02760034
027700                                                                  02770034
027800     MOVE '2010-VALIDATE-PACKSLIP  ' TO PV-ABEND-PARAGRAPH.       02780034
027900                                                                  02790034
028000     EXEC SQL                                                     02800034
028100       SELECT  PO_NBR                                             02810034
028200             , SEQ_NBR                                            02820034
028300             , REC_SEQ_NBR                                        02830034
028400         INTO :PKSLIP-PO-NBR                                      02840034
028500             ,:PKSLIP-SEQ-NBR                                     02850034
028600             ,:PKSLIP-REC-SEQ-NBR                                 02860034
028700         FROM TPKSLIP                                             02870034
028800        WHERE PO_NBR         = :DK-PO-NBR                         02880034
028900          AND SEQ_NBR        = :DK-SEQ-NBR                        02890034
029000          AND VER_STAT_CDE   = 'A'                                02900034
029100     END-EXEC.                                                    02910034
029200                                                                  02920034
029300     EVALUATE TRUE                                                02930034
029400         WHEN SQLCODE = +0                                        02940034
029500             CONTINUE                                             02950034
029600                                                                  02960034
029700         WHEN SQLCODE = +100                                      02970034
029800             SET PS-ERROR-YES TO TRUE                             02980034
029900                                                                  02990034
030000         WHEN SQLWARN0 NOT = SPACE                                03000034
030100         WHEN SQLWARN0 NOT = +0                                   03010034
030200             MOVE '2010-VALIDATE-PACKSLIP'                        03020034
030300                                        TO PV-ABEND-PARAGRAPH     03030034
030400             STRING ' VALIDATE PACKSLIP '  DELIMITED BY SIZE      03040034
030500                    '  PO-'                DELIMITED BY SIZE      03050034
030600                    PV-DISP-PO             DELIMITED BY SIZE      03060034
030700                    '  PKSLIP SEQ-'        DELIMITED BY SIZE      03070034
030800                    PV-DISP-SEQ            DELIMITED BY SIZE      03080034
030900                                      INTO PV-ABEND-OPERATION     03090034
031000             MOVE 'TPKSLIP'             TO PV-ABEND-STRUCTURE-1   03100034
031100             PERFORM Z999-SQL-ABEND                               03110034
031200     END-EVALUATE.                                                03120034
031300                                                                  03130034
031400                                                                  03140034
031500***************************************************************** 03150034
031600* CHECK FOR NON PACK-BY-STORE                                   * 03160034
031700*   PACKAGING CODE VALUES:  SPACE  = PACK-BY-STORE (PBS)        * 03170034
031800*                           B      = BULK                       * 03180034
031900*                           M OR I = PRE-PACK                   * 03190034
032000*                           S      = SINGLE SKU PRE-PACK        * 03200034
032100*                           C      = CASEPACK                   * 03210034
032200***************************************************************** 03220034
032300 2020-PACK-BY-STORE.                                              03230034
032400                                                                  03240034
032500     MOVE '2020-PACK-BY-STORE      ' TO PV-ABEND-PARAGRAPH.       03250034
032600                                                                  03260034
032700     EXEC SQL                                                     03270034
032800       SELECT  PO_NBR                                             03280034
032900             , PKGNG_CDE                                          03290034
033000             , ENT_ID                                             03300034
033100         INTO :PURCHS-PO-NBR                                      03310034
033200             ,:PURCHS-PKGNG-CDE                                   03320034
033300             ,:PURCHS-ENT-ID                                      03330034
033400         FROM TPURCHS A                                           03340034
033500        WHERE PO_NBR         = :DK-PO-NBR                         03350034
033600          AND VER_STATUS_CDE = 'A'                                03360034
033700          AND PKGNG_CDE     <> ' '                                03370034
033800     END-EXEC.                                                    03380034
033900                                                                  03390034
034000     EVALUATE TRUE                                                03400034
034100         WHEN SQLCODE = +0                                        03410034
034200             CONTINUE                                             03420034
034300                                                                  03430034
034400         WHEN SQLCODE = +100                                      03440034
034500             SET PS-ERROR-YES TO TRUE                             03450034
034600                                                                  03460034
034700         WHEN SQLWARN0 NOT = SPACE                                03470034
034800         WHEN SQLCODE  NOT = +0                                   03480034
034900             MOVE '2020-PACK-BY-STORE'  TO PV-ABEND-PARAGRAPH     03490034
035000             STRING ' CHECK NON PBS     '  DELIMITED BY SIZE      03500034
035100                    '  PO-'                DELIMITED BY SIZE      03510034
035200                    PV-DISP-PO             DELIMITED BY SIZE      03520034
035300                    '  PKSLIP SEQ-'        DELIMITED BY SIZE      03530034
035400                    PV-DISP-SEQ            DELIMITED BY SIZE      03540034
035500                                      INTO PV-ABEND-OPERATION     03550034
035600             MOVE 'TPURCHS'             TO PV-ABEND-STRUCTURE-1   03560034
035700             PERFORM Z999-SQL-ABEND                               03570034
035800     END-EVALUATE.                                                03580034
035900                                                                  03590034
036000                                                                  03600034
036100***************************************************************** 03610034
036200* CHECK FOR VALID UCC128 VENDOR                                 * 03620034
036300***************************************************************** 03630034
036400* DMH DELETE - THIS PARAGRAPH IS NO LONGER NECESSARY.  THE DATA   03640034
036410* IN THE INPUT FILE HAS ALREADY BEEN VALIDATED BY VENDOR IN PROC  03641034
036420* RCK010. 01/24/02                                                03642034
036430*2030-VALIDATE-VENDOR.                                            03643034
036440*                                                                 03644034
036450*    MOVE '2030-VALIDATE-VENDOR    ' TO PV-ABEND-PARAGRAPH.       03645034
036460*                                                                 03646034
036470*    EXEC SQL                                                     03647034
036480*      SELECT  VLD_CART_LBL_IND                                   03648034
036490*        INTO :EXTENT-VLD-CART-LBL-IND                            03649034
036500*        FROM TEXTENT                                             03650034
036600*       WHERE ENT_ID            = :PURCHS-ENT-ID                  03660034
036700*         AND VLD_CART_LBL_IND  = 'Y'                             03670034
036800*    END-EXEC.                                                    03680034
036900*                                                                 03690034
037000*    EVALUATE TRUE                                                03700034
037100*        WHEN SQLCODE = +0                                        03710034
037200*            CONTINUE                                             03720034
037300*                                                                 03730034
037400*        WHEN SQLCODE = +100                                      03740034
037500*            SET PS-ERROR-YES TO TRUE                             03750034
037600*                                                                 03760034
037700*        WHEN SQLWARN0 NOT = SPACE                                03770034
037800*        WHEN SQLCODE  NOT = +0                                   03780034
037900*            MOVE PURCHS-ENT-ID           TO PV-DISP-ENT-ID       03790034
038000*            MOVE '2030-VALIDATE-VENDOR'  TO PV-ABEND-PARAGRAPH   03800034
038100*            STRING ' CHECK UCC128 VENDOR' DELIMITED BY SIZE      03810034
038200*                   '  PO-'                DELIMITED BY SIZE      03820034
038300*                   PV-DISP-PO             DELIMITED BY SIZE      03830034
038400*                   '  PKSLIP SEQ-'        DELIMITED BY SIZE      03840034
038500*                   PV-DISP-SEQ            DELIMITED BY SIZE      03850034
038600*                   '  ENT-ID-'            DELIMITED BY SIZE      03860034
038700*                   PV-DISP-ENT-ID         DELIMITED BY SIZE      03870034
038800*                                     INTO PV-ABEND-OPERATION     03880034
038900*            MOVE 'TEXTENT'             TO PV-ABEND-STRUCTURE-1   03890034
039000*            PERFORM Z999-SQL-ABEND                               03900034
039100*    END-EVALUATE.                                                03910034
039200                                                                  03920034
039300                                                                  03930034
039400***************************************************************** 03940034
039500* CHECK TO SEE IF PO/PACKSLIP IS ALREADY ON SUMMARY TABLE       * 03950034
039600***************************************************************** 03960034
039700 2040-CHECK-TSHPSUM.                                              03970034
039800                                                                  03980034
039900     MOVE '2040-CHECK-TSHPSUM      ' TO PV-ABEND-PARAGRAPH.       03990034
040000                                                                  04000034
040100     EXEC SQL                                                     04010034
040200       SELECT  COUNT(*)                                           04020034
040300         INTO :PV-TSHPSUM-COUNT                                   04030034
040400         FROM TSHPSUM                                             04040034
040500        WHERE PO_NBR        = :DK-PO-NBR                          04050034
040600          AND PKSL_SEQ_NBR  = :DK-SEQ-NBR                         04060034
040700     END-EXEC.                                                    04070034
040800                                                                  04080034
040900     EVALUATE TRUE                                                04090034
041000         WHEN SQLCODE = +0                                        04100034
041100         WHEN SQLCODE = +100                                      04110034
041200             CONTINUE                                             04120034
041300                                                                  04130034
041400         WHEN SQLWARN0 NOT = SPACE                                04140034
041500         WHEN SQLCODE  NOT = +0                                   04150034
041600             MOVE '2040-CHECK-TSHPSUM  '  TO PV-ABEND-PARAGRAPH   04160034
041700             STRING ' CHECK ALREADY SUMRY' DELIMITED BY SIZE      04170034
041800                    '  PO-'                DELIMITED BY SIZE      04180034
041900                    PV-DISP-PO             DELIMITED BY SIZE      04190034
042000                    '  PKSLIP SEQ-'        DELIMITED BY SIZE      04200034
042100                    PV-DISP-SEQ            DELIMITED BY SIZE      04210034
042200                                      INTO PV-ABEND-OPERATION     04220034
042300             MOVE 'TSHPSUM'             TO PV-ABEND-STRUCTURE-1   04230034
042400             PERFORM Z999-SQL-ABEND                               04240034
042500     END-EVALUATE.                                                04250034
042600                                                                  04260034
042700                                                                  04270034
042800***************************************************************** 04280034
042900* IF PKSLIP-REC-SEQ-NBR > 0 THEN THE PACKSKIP IS ATTACHED TO A  * 04290034
043000* RECEIVER.  CHECK TO SEE IF THERE ARE ANY ACTIVE LINES FOR THE * 04300034
043100* PO/RCVR DOWNLOADED TO THE DISTRO TABLES USING UCC128 DATA.    * 04310034
043200***************************************************************** 04320034
043300 2050-CHECK-DISTRO-TBL.                                           04330034
043400                                                                  04340034
043500     MOVE '2050-CHECK-DISTRO-TBL   ' TO PV-ABEND-PARAGRAPH.       04350034
043600                                                                  04360034
043700     EXEC SQL                                                     04370034
043800       SELECT  COUNT(*)                                           04380034
043900         INTO :PV-TDISTHD-COUNT                                   04390034
044000         FROM  TDISTHD                                            04400034
044100        WHERE  ORD_NBR             = :DK-PO-NBR                   04410034
044200          AND  RCVR_SEQ_NBR        = :DK-RCVR-SEQ-NBR             04420034
044300          AND  UCC128_DAT_USG_CDE  = 'U'                          04430034
044400          AND (FCSE_CART_CNT       >  0  OR                       04440034
044500               P2L_CART_CNT        >  0  OR                       04450034
044600               INPK_CART_CNT       >  0  OR                       04460034
044700               TOT_CART_CNT        >  0)                          04470034
044800     END-EXEC.                                                    04480034
044900                                                                  04490034
045000     EVALUATE TRUE                                                04500034
045100         WHEN SQLCODE = +0                                        04510034
045200              IF  PV-TDISTHD-COUNT  >  0                          04520034
045300                  SET  PS-ERROR-YES  TO  TRUE                     04530034
045400              ELSE                                                04540034
045500                  PERFORM 2060-DELETE-TSHPSUM                     04550034
045600              END-IF                                              04560034
045700                                                                  04570034
045800         WHEN SQLCODE = +100                                      04580034
045900              PERFORM 2060-DELETE-TSHPSUM                         04590034
046000                                                                  04600034
046100         WHEN SQLWARN0 NOT = SPACE                                04610034
046200         WHEN SQLCODE  NOT = +0                                   04620034
046300             MOVE '2050-CHECK-DISTRO-TBL' TO PV-ABEND-PARAGRAPH   04630034
046400             MOVE DK-RCVR-SEQ-NBR  TO PV-DISP-RCVR-SEQ            04640034
046500             STRING ' CHECK DISTHD UCC128' DELIMITED BY SIZE      04650034
046600                    '  PO-'                DELIMITED BY SIZE      04660034
046700                    PV-DISP-PO             DELIMITED BY SIZE      04670034
046800                    '  RCVR SEQ-'          DELIMITED BY SIZE      04680034
046900                    PV-DISP-RCVR-SEQ       DELIMITED BY SIZE      04690034
047000                                      INTO PV-ABEND-OPERATION     04700034
047100             MOVE 'TDISTHD'             TO PV-ABEND-STRUCTURE-1   04710034
047200             PERFORM Z999-SQL-ABEND                               04720034
047300     END-EVALUATE.                                                04730034
047400                                                                  04740034
047500                                                                  04750034
047600***************************************************************** 04760034
047700* IF PKSLIP-REC-SEQ-NBR = 0 THEN THE PACKSKIP IS NOT ATTACHED   * 04770034
047800* TO A RECEIVER - DELETE ROWS IN TSHPSUM TABLE                  * 04780034
047900***************************************************************** 04790034
048000 2060-DELETE-TSHPSUM.                                             04800034
048100                                                                  04810034
048200     MOVE '2060-DELETE-TSHPSUM     ' TO PV-ABEND-PARAGRAPH.       04820034
048300                                                                  04830034
048400     EXEC SQL                                                     04840034
048500          DELETE FROM TSHPSUM                                     04850034
048600           WHERE PO_NBR          = :DK-PO-NBR                     04860034
048700             AND PKSL_SEQ_NBR    = :DK-SEQ-NBR                    04870034
048800     END-EXEC.                                                    04880034
048900                                                                  04890034
049000     EVALUATE TRUE                                                04900034
049100         WHEN SQLCODE = +0                                        04910034
049200              EXEC SQL                                            04920034
049300                   COMMIT                                         04930034
049400              END-EXEC                                            04940034
049500                                                                  04950034
049600         WHEN SQLWARN0 NOT = SPACE                                04960034
049700         WHEN SQLCODE  NOT = +0                                   04970034
049800             MOVE '2060-DELETE-TSHPSUM' TO PV-ABEND-PARAGRAPH     04980034
049900             STRING ' DELETE TSHPSUM  '    DELIMITED BY SIZE      04990034
050000                    '  PO-'                DELIMITED BY SIZE      05000034
050100                    PV-DISP-PO             DELIMITED BY SIZE      05010034
050200                    '  PKSLIP SEQ-'        DELIMITED BY SIZE      05020034
050300                    PV-DISP-SEQ            DELIMITED BY SIZE      05030034
050400                                      INTO PV-ABEND-OPERATION     05040034
050500             MOVE 'TSHPSUM'             TO PV-ABEND-STRUCTURE-1   05050034
050600             PERFORM Z999-SQL-ABEND                               05060034
050700     END-EVALUATE.                                                05070034
050800                                                                  05080034
050900                                                                  05090034
051000***************************************************************** 05100034
051100* CREATE CURSOR WITH ALL CARTONS ATTACHED TO THE PO/PACKSLIP SEQ* 05110034
051200***************************************************************** 05120034
051300 2070-CARTON-SUMMARY.                                             05130034
051400                                                                  05140034
051500     PERFORM 2100-OPEN-CARTON-CSR.                                05150034
051600                                                                  05160034
051700     PERFORM 2110-FETCH-CARTON-CSR.                               05170034
051800                                                                  05180034
051900     MOVE SHUUPC-SHIPT-UNT-ID  TO  PV-PREV-SHIPT-UNT-ID.          05190034
052000                                                                  05200034
052100     IF  PS-NOT-EOF-CARTON-CSR                                    05210034
052200         PERFORM 2130-PROCESS-CARTON-CSR                          05220034
052300           UNTIL PS-EOF-CARTON-CSR                                05230034
052400              OR PS-ERROR-YES                                     05240034
052500     END-IF.                                                      05250034
052600                                                                  05260034
052700     PERFORM 2120-CLOSE-CARTON-CSR.                               05270034
052800                                                                  05280034
052900                                                                  05290034
053000***************************************************************** 05300034
053100*                                                               * 05310034
053200***************************************************************** 05320034
053300 2100-OPEN-CARTON-CSR.                                            05330034
053400                                                                  05340034
053500     MOVE '2100-OPEN-CARTON-CSR    ' TO PV-ABEND-PARAGRAPH.       05350034
053600                                                                  05360034
053700     EXEC SQL                                                     05370034
053800         OPEN CARTON-CSR                                          05380034
053900     END-EXEC                                                     05390034
054000                                                                  05400034
054100     EVALUATE TRUE                                                05410034
054200         WHEN SQLCODE = ZERO                                      05420034
054300             SET PS-NOT-EOF-CARTON-CSR  TO TRUE                   05430034
054400                                                                  05440034
054500         WHEN OTHER                                               05450034
054600             PERFORM Z999-SQL-ABEND                               05460034
054700     END-EVALUATE.                                                05470034
054800                                                                  05480034
054900                                                                  05490034
055000***************************************************************** 05500034
055100*                                                               * 05510034
055200***************************************************************** 05520034
055300 2110-FETCH-CARTON-CSR.                                           05530034
055400                                                                  05540034
055500     MOVE '2110-FETCH-CARTON-CSR   ' TO PV-ABEND-PARAGRAPH.       05550034
055600                                                                  05560034
055700     EXEC SQL                                                     05570034
055800         FETCH CARTON-CSR                                         05580034
055900          INTO :SHUUPC-SHIPT-UNT-ID                               05590034
056000             , :SHUUPC-TRN-LNE-NBR                                05600034
056100             , :SHUUPC-SHPD-QTY                                   05610034
056200     END-EXEC.                                                    05620034
056300                                                                  05630034
056400     EVALUATE TRUE                                                05640034
056500         WHEN SQLCODE = +0                                        05650034
056600             SET PS-NOT-EOF-CARTON-CSR TO TRUE                    05660034
056700                                                                  05670034
056800         WHEN SQLCODE = +100                                      05680034
056900             MOVE ZEROES TO SHUUPC-TRN-LNE-NBR                    05690034
057000                            SHUUPC-SHPD-QTY                       05700034
057100             SET PS-EOF-CARTON-CSR     TO TRUE                    05710034
057200                                                                  05720034
057300         WHEN SQLWARN0 NOT = SPACE                                05730034
057400         WHEN SQLCODE  NOT = +0                                   05740034
057500             MOVE '2110-FETCH-CARTON-CSR' TO PV-ABEND-PARAGRAPH   05750034
057600             MOVE PV-DISP-PO              TO PV-ABEND-OPERATION   05760034
057700             MOVE 'FETCH CARTON CURSOR'   TO PV-ABEND-STRUCTURE-1 05770034
057800             MOVE 'TSHUUPC'               TO PV-ABEND-STRUCTURE-2 05780034
057900             PERFORM Z999-SQL-ABEND                               05790034
058000     END-EVALUATE.                                                05800034
058100                                                                  05810034
058200                                                                  05820034
058300***************************************************************** 05830034
058400*                                                               * 05840034
058500***************************************************************** 05850034
058600 2120-CLOSE-CARTON-CSR.                                           05860034
058700                                                                  05870034
058800     MOVE '2120-CLOSE-CARTON-CSR   ' TO PV-ABEND-PARAGRAPH.       05880034
058900                                                                  05890034
059000     EXEC SQL                                                     05900034
059100         CLOSE CARTON-CSR                                         05910034
059200     END-EXEC                                                     05920034
059300                                                                  05930034
059400     EVALUATE TRUE                                                05940034
059500         WHEN SQLCODE = ZERO                                      05950034
059600              CONTINUE                                            05960034
059700         WHEN OTHER                                               05970034
059800              PERFORM Z999-SQL-ABEND                              05980034
059900     END-EVALUATE.                                                05990034
060000                                                                  06000034
060100                                                                  06010034
060200***************************************************************** 06020034
060300*                                                               * 06030034
060400***************************************************************** 06040034
060500 2130-PROCESS-CARTON-CSR.                                         06050034
060600                                                                  06060034
060700     PERFORM VARYING CRTN-IDX                                     06070034
060800                FROM 1 BY 1                                       06080034
060900               UNTIL CRTN-IDX  >  PC007-MAX-ENTRIES               06090034
061000                  OR PS-EOF-CARTON-CSR                            06100034
061100                  OR PS-ERROR-YES                                 06110034
061200                     MOVE PV-PREV-PO-NBR                          06120034
061300                       TO PC007-PO-NBR                            06130034
061400                     MOVE PV-PREV-SEQ-NBR                         06140034
061500                       TO PC007-SEQ-NBR                           06150034
061600                     MOVE SHUUPC-TRN-LNE-NBR                      06160034
061700                       TO PC007-TBL-LNE-NBR (CRTN-IDX)            06170034
061800                     MOVE SHUUPC-SHPD-QTY                         06180034
061900                       TO PC007-TBL-QTY (CRTN-IDX)                06190034
062000                     ADD  1  TO  PC007-TABLE-ENTRIES              06200034
062100                     PERFORM 2110-FETCH-CARTON-CSR                06210034
062200                     IF  (SHUUPC-SHIPT-UNT-ID                     06220034
062300                          NOT = PV-PREV-SHIPT-UNT-ID)  OR         06230034
062400                         PS-EOF-CARTON-CSR                        06240034
062500                         MOVE PV-PREV-PO-NBR  TO PC007-PO-NBR     06250034
062600                         MOVE PV-PREV-SEQ-NBR TO PC007-SEQ-NBR    06260034
062700                         PERFORM 2140-WRITE-OUTPUT                06270034
062800                         SET CRTN-IDX TO PC-ZERO                  06280034
062900                         INITIALIZE  PC007-CRTN-SUM-RECORD        06290034
063000                         MOVE SHUUPC-SHIPT-UNT-ID                 06300034
063100                           TO  PV-PREV-SHIPT-UNT-ID               06310034
063200                     END-IF                                       06320034
063300     END-PERFORM.                                                 06330034
063400                                                                  06340034
063500     IF  CRTN-IDX  >  PC007-MAX-ENTRIES                           06350034
063600         MOVE DK-PO-NBR   TO  PV-DISP-PO                          06360034
063700         MOVE DK-SEQ-NBR  TO  PV-DISP-SEQ                         06370034
063800         DISPLAY ' '                                              06380034
063900         DISPLAY 'TABLE OVERFLOW ON PC007-CRTN-SUM-RECORD'        06390034
064000                 '  OVER - 50 LINE ENTRIES  CARTON BYPASSED '     06400034
064100         DISPLAY '   PO - '           PV-DISP-PO                  06410034
064200                 '   PACKSLIP SEQ - ' PV-DISP-SEQ                 06420034
064300                 '   SHUUPC-SHIPT-UNT-ID - ' SHUUPC-SHIPT-UNT-ID  06430034
064400         SET  PS-ERROR-YES  TO  TRUE                              06440034
064500         ADD  1  TO  PV-CARTONS-BYPASSED                          06450034
064600     END-IF.                                                      06460034
064700                                                                  06470034
064800                                                                  06480034
064900***************************************************************** 06490034
065000*                                                               * 06500034
065100***************************************************************** 06510034
065200 2140-WRITE-OUTPUT.                                               06520034
065300                                                                  06530034
065400     WRITE OUTPUT-RECORD                                          06540034
065500      FROM PC007-CRTN-SUM-RECORD.                                 06550034
065600      ADD  1  TO  PV-RECORDS-WRITTEN.                             06560034
065700                                                                  06570034
065800                                                                  06580034
065900                                                                  06590034
066000***************************************************************** 06600034
066100*                                                               * 06610034
066200***************************************************************** 06620034
066300 Z999-SQL-ABEND.                                                  06630034
066400                                                                  06640034
066500     MOVE SQLCODE            TO PV-SQLCODE.                       06650034
066600     MOVE PV-SQLCODE         TO PV-DISP-SQLCODE.                  06660034
066700     DISPLAY '*** DB2 ERROR '.                                    06670034
066800     DISPLAY '*** SQLCODE   = ' PV-DISP-SQLCODE.                  06680034
066900     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 06690034
067000     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               06700034
067100     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               06710034
067200     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       06720034
067300     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.       06730034
067400     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-3.       06740034
067500     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.             06750034
067600                                                                  06760034
067700     IF PV-ABEND-STRUCTURE-2 > SPACES                             06770034
067800         DISPLAY '*** TABLE 2   = ' PV-ABEND-STRUCTURE-2          06780034
067900     END-IF.                                                      06790034
068000                                                                  06800034
068100     COPY DPPD004.                                                06810034
068200                                                                  06820034
068300     MOVE +4013         TO PV-ABEND-CODE.                         06830034
068400     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         06840034
068500                                                                  06850034
068600                                                                  06860034
068700 9999-ABORT.                                                      06870034
068800                                                                  06880034
068900      DISPLAY 'PV-ABEND-CODE = ' PV-ABEND-CODE                    06890034
069000      CALL 'ILBOABN0'   USING PV-ABEND-CODE.                      06900034
069100                                                                  06910034
