000300 IDENTIFICATION DIVISION.                                         00030001
000400 PROGRAM-ID.         AHKUP051.                                    00040001
000500 AUTHOR.             PATRICK BURKE.                               00050001
000600 DATE-WRITTEN.       MAY 2000.                                    00060001
000700 DATE-COMPILED.                                                   00070001
000800*************************************************************     00080001
000900*    COBOL 2 WITH SQL                                       *     00090001
001000*                                                           *     00100001
001100*   AHKUP051 - ARCHIVE HISTORY DATA DELETION - TPKSLIP      *     00110001
001200*                                                           *     00120001
001300*   PROGRAM OVERVIEW:                                       *     00130001
001400*                                                           *     00140001
001500*  THIS PROGRAM DELETES "OLD" ROWS FROM DB2 TABLE TPKSLIP.  *     00150001
001600*  ROWS DELETED ARE THOSE PREVIOUSLY - IDENTIFIED/EXTRACTED *     00160001
001700*  WITHIN THE ARCHIVE/HISTORY SYSTEM.                       *     00170001
001800*                                                           *     00180001
001900*  THE EXTRACT FILE USED AS INPUT WILL BE SORTED BY THE     *     00190001
002000*  CLUSTERING INDEX COLUMNS TO SPEED THE DELETION PROCESS.  *     00200001
002100*  THESE COLUMNS ARE PO_NBR, SEQ_NBR, CRE_TMST.             *     00210001
002200*                                                           *     00220001
002300*                                                           *     00230001
002400*   INPUT:                                                  *     00240001
002500*                                                           *     00250001
002600*     1. TPKSLIP DELETION FILE  COPYBOOK DCLTPKSLIP         *     00260001
002700*                                                           *     00270001
002800*   DB2 TABLES:                                             *     00280001
002900*                                                           *     00290001
003000*        TPKSLIP - RECEIVING HEADER TABLE                   *     00300001
003100*        TCKRSTIN - CHECKPOINT/RESTART INFO TABLE           *     00310001
003200*        TCKRSTCN - CHECKPOINT/RESTART CONTROL TABLE        *     00320001
003300*                                                           *     00330001
003400*************************************************************     00340001
003500*                                                           *     00350001
003600*************************************************************     00360001
003700 EJECT                                                            00370001
003800 ENVIRONMENT DIVISION.                                            00380001
003900 CONFIGURATION SECTION.                                           00390001
004000 SOURCE-COMPUTER.        IBM-370.                                 00400001
004100 OBJECT-COMPUTER.        IBM-370.                                 00410001
004200                                                                  00420001
004300 INPUT-OUTPUT SECTION.                                            00430001
004400 FILE-CONTROL.                                                    00440001
004500     SELECT TPKSLIP-EXTRACT-FILE ASSIGN TO INP01.                 00450001
004600                                                                  00460001
004700 DATA DIVISION.                                                   00470001
004800 FILE SECTION.                                                    00480001
004900 FD  TPKSLIP-EXTRACT-FILE                                         00490001
005000     RECORDING MODE IS F                                          00500001
005100     LABEL RECORDS ARE STANDARD                                   00510001
005200     BLOCK CONTAINS 0 RECORDS                                     00520001
005300     RECORD CONTAINS 169 CHARACTERS                               00530009
005400     DATA RECORD IS TPKSLIP-EXTRACT-DATA.                         00540001
005500 01  TPKSLIP-EXTRACT-DATA       PIC X(169).                       00550009
005600                                                                  00560001
005700                                                                  00570001
005800 EJECT                                                            00580001
005900 WORKING-STORAGE SECTION.                                         00590001
006000                                                                  00600001
006100 01  FILLER                       PIC X(58)     VALUE             00610001
006200     '************WORKING STORAGE STARTS HERE*******************'.00620001
006300                                                                  00630001
006400 01  PV-PROGRAM-VARIABLES.                                        00640001
006500     05  PV-PROGRAM-NAME          PIC X(08)    VALUE 'AHKUP051'.  00650001
006600     05  PV-CKPT-STAT-CODE        PIC X(01)    VALUE SPACE.       00660001
006700     05  PV-CURRENT-PARAGRAPH     PIC X(50)    VALUE SPACES.      00670001
006800     05  PV-CURRENT-TMST          PIC X(26)    VALUE SPACES.      00680001
006900                                                                  00690001
007000     05  PV-TPKSLIP-INPUT-COUNT   PIC 9(09)    VALUE ZERO         00700001
007100                                               COMP-3.            00710001
007200     05  PV-TPKSLIP-DELETE-COUNT  PIC 9(09)    VALUE ZERO         00720001
007300                                               COMP-3.            00730001
007400     05  PV-SQL-DELETE-COUNT      PIC 9(09)    VALUE ZERO         00740001
007500                                               COMP-3.            00750001
007600     05  PV-SQLERRD3              PIC S9(09)   VALUE ZERO         00760001
007700                                               COMP-3.            00770001
007800     05  PV-DISP-PO-NBR           PIC X(09)    VALUE SPACES.      00780003
007900     05  PV-DISP-SEQ-NBR          PIC X(09)    VALUE SPACES.      00790003
008000     05  PV-DISP-CRE-TMST         PIC X(10)    VALUE SPACES.      00800006
008300 01  PC-PROGRAM-CONSTANTS.                                        00830001
008400     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          00840001
008500                                                COMP SYNC.        00850001
008600     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      00860001
008700     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00870001
008800     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00880001
008900                                                                  00890001
009000 01  PS-PROGRAM-SWITCHES.                                         00900001
009100     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.        00910001
009200         88  COMMITS-TAKEN                      VALUE 'T'.        00920001
009300         88  NO-COMMITS-TAKEN                   VALUE 'N'.        00930001
009400     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.        00940001
009500         88  MORE-EXTRACT                       VALUE 'M'.        00950001
009600         88  END-OF-EXTRACT                     VALUE 'E'.        00960001
009700     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        00970001
009800         88  NORMAL-RUN                         VALUE '0'.        00980001
009900         88  RESTART-RUN                        VALUE '9'.        00990001
010000                                                                  01000001
010100 01  WS-COUNTER.                                                  01010001
010200     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.     01020001
010300     05  WS-TMST                  PIC X(26)     VALUE SPACES.     01030001
010400                                                                  01040001
010500 01  CKPT-RESTART-INFO.                                           01050001
010600     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.       01060001
010700                                                                  01070001
010800*----------------------------------------------------------------*01080001
010900*  ABEND DATA AREAS                                              *01090001
011000*----------------------------------------------------------------*01100001
011100 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01110001
011200                                             COMP SYNC.           01120001
011300     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         01130001
011400     88  AC-BAD-DATA                         VALUE +4008.         01140001
011500     88  AC-DB2-ERROR                        VALUE +4013.         01150001
011600     88  AC-DATE-ERROR                       VALUE +4019.         01160001
011700                                                                  01170001
011800                                                                  01180001
011900 01  ABEND-AREAS.                                                 01190001
012000     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01200001
012100             '*****       ABEND'.                                 01210001
012200     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01220001
012300             '*****   PROGRAM: AHKUP051'.                         01230001
012400     05  AA-PARAGRAPH-LIT.                                        01240001
012500         10  FILLER              PIC  X(17)  VALUE                01250001
012600             '***** PARAGRAPH: '.                                 01260001
012700         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01270001
012800     05  AA-MESSAGE-LINE-1.                                       01280001
012900         10  FILLER              PIC  X(06)  VALUE '*****'.       01290001
013000         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01300001
013100     05  AA-MESSAGE-LINE-2.                                       01310001
013200         10  FILLER              PIC  X(06)  VALUE '*****'.       01320001
013300         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01330001
013400     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01340001
013500             '*****    DB2 ERROR'.                                01350001
013600     05  AA-DB2-OPERATION-LIT.                                    01360001
013700         10  FILLER              PIC  X(17)  VALUE                01370001
013800             '***** OPERATION: '.                                 01380001
013900         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01390001
014000     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01400001
014100     EJECT                                                        01410001
014200                                                                  01420001
014300     COPY DPWS004.                                                01430001
014400     EJECT                                                        01440001
014500*----------------------------------------------------------------*01450001
014600*      TPKSLIP TABLE LAYOUT                                       01460001
014700*----------------------------------------------------------------*01470001
014800         EXEC SQL                                                 01480001
014900             INCLUDE TPKSLIP                                      01490001
015000         END-EXEC.                                                01500001
015100                                                                  01510001
015200*----------------------------------------------------------------*01520001
015300*      TCKRSTCNTL TABLE LAYOUT                                    01530001
015400*----------------------------------------------------------------*01540001
015500         EXEC SQL                                                 01550001
015600             INCLUDE TCKRSTCN                                     01560001
015700         END-EXEC.                                                01570001
015800                                                                  01580001
015900*----------------------------------------------------------------*01590001
016000*      TCKRSTINF TABLE LAYOUT                                     01600001
016100*----------------------------------------------------------------*01610001
016200         EXEC SQL                                                 01620001
016300             INCLUDE TCKRSTIN                                     01630001
016400         END-EXEC.                                                01640001
016500 EJECT                                                            01650001
016600*----------------------------------------------------------------*01660001
016700*  DB2 COMMUNICATION AREA                                         01670001
016800*----------------------------------------------------------------*01680001
016900*                                                                 01690001
017000     EXEC SQL                                                     01700001
017100         INCLUDE SQLCA                                            01710001
017200     END-EXEC.                                                    01720001
017300                                                                  01730001
017400*----------------------------------------------------------------*01740001
017500*  DB2 COMMUNICATION AREA2                                        01750001
017600*----------------------------------------------------------------*01760001
017700*                                                                 01770001
017800     COPY SQLCA2.                                                 01780001
017900     EJECT                                                        01790001
018000 PROCEDURE DIVISION.                                              01800001
018100 A100-MAINLINE-ROUTINE.                                           01810001
018200                                                                  01820001
018300     PERFORM B100-INITIALIZATION.                                 01830001
018400                                                                  01840001
018500     PERFORM B200-TPKSLIP-EXTRACT-PROCESS                         01850001
018600       UNTIL END-OF-EXTRACT.                                      01860001
018700                                                                  01870001
018800     PERFORM B300-EOJ-PROCESSING.                                 01880001
018900                                                                  01890001
019000     GOBACK.                                                      01900001
019100 EJECT                                                            01910001
019200 B100-INITIALIZATION.                                             01920001
019300                                                                  01930001
019400     EXEC SQL                                                     01940001
019500         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 01950001
019600     END-EXEC.                                                    01960001
019700                                                                  01970001
019800     PERFORM X300-GET-CHECKPOINT-CNTL.                            01980001
019900     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    01990001
020000                                                                  02000001
020100     OPEN INPUT TPKSLIP-EXTRACT-FILE.                             02010001
020200                                                                  02020001
020300     IF RESTART-RUN                                               02030001
020400         PERFORM X200-CHECKPOINT-RESTART                          02040001
020500     ELSE                                                         02050001
020600         PERFORM R100-READ-EXTRACT-FILE                           02060001
020700     END-IF.                                                      02070001
020800                                                                  02080001
020900     PERFORM X500-SET-CHECKPOINT-TIME.                            02090001
021000                                                                  02100001
021100                                                                  02110001
021200     EJECT                                                        02120001
021300 B200-TPKSLIP-EXTRACT-PROCESS.                                    02130001
021400                                                                  02140001
021500     MOVE PKSLIP-PO-NBR             TO PV-DISP-PO-NBR.            02150001
021600     MOVE PKSLIP-SEQ-NBR            TO PV-DISP-SEQ-NBR.           02160001
021700     MOVE PKSLIP-CRE-TMST           TO PV-DISP-CRE-TMST.          02170001
022000                                                                  02200001
022100     PERFORM D100-DELETE-TPKSLIP.                                 02210001
022200                                                                  02220001
022300     PERFORM X100-CHECKPOINT-CHECK.                               02230001
022400                                                                  02240001
022500     PERFORM R100-READ-EXTRACT-FILE.                              02250001
022600     EJECT                                                        02260001
022700                                                                  02270001
022800                                                                  02280001
022900 B300-EOJ-PROCESSING.                                             02290001
023000                                                                  02300001
023100     DISPLAY '** AHKUP051 SUMMARY **'.                            02310001
023200     DISPLAY '** TPKSLIP INPUT COUNT = ' PV-TPKSLIP-INPUT-COUNT.  02320004
023300     DISPLAY '** TPKSLIP DELETE COUNT = ' PV-TPKSLIP-DELETE-COUNT.02330004
023400     DISPLAY '** SQL DELETE COUNT = ' PV-SQL-DELETE-COUNT.        02340001
023500                                                                  02350001
023600     CLOSE  TPKSLIP-EXTRACT-FILE.                                 02360001
023700                                                                  02370001
023800     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02380001
023900     PERFORM X600-UPDATE-TCKRSTCNTL.                              02390001
024000                                                                  02400001
024100     EJECT                                                        02410001
024200*----------------------------------------------------------------*02420001
024300*    DELETES FROM THE TPKSLIP TABLE. NO OTHER TABLES REFERENCE   *02430001
024400*    THIS TABLE.                                                 *02440001
024500*----------------------------------------------------------------*02450001
024600 D100-DELETE-TPKSLIP.                                             02460001
024700                                                                  02470001
024800     MOVE 'D100-DELETE-TPKSLIP' TO PV-CURRENT-PARAGRAPH.          02480001
024900                                                                  02490001
025000     PERFORM WITH TEST AFTER                                      02500001
025100        VARYING PC-RETRY-COUNT FROM 1 BY 1                        02510001
025200          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                     02520001
025300             OR SQLCODE = ZERO                                    02530001
025400                                                                  02540001
025500         EXEC SQL                                                 02550001
025600              DELETE                                              02560001
025700                FROM TPKSLIP                                      02570001
025800               WHERE PO_NBR      = :PKSLIP-PO-NBR                 02580001
025900                 AND SEQ_NBR     = :PKSLIP-SEQ-NBR                02590001
026000                 AND CRE_TMST    = :PKSLIP-CRE-TMST               02600001
026300         END-EXEC                                                 02630001
026400                                                                  02640001
026500         EVALUATE TRUE                                            02650001
026600             WHEN SQLCODE = ZERO                                  02660001
026700                 ADD 1 TO PV-TPKSLIP-DELETE-COUNT                 02670001
026800                 MOVE SQLERRD(3) TO PV-SQLERRD3                   02680010
026900                 ADD PV-SQLERRD3 TO PV-SQL-DELETE-COUNT           02690001
027000                                                                  02700001
027100             WHEN SQLCODE = -904                                  02710001
027200             WHEN SQLCODE = -913                                  02720001
027300                  CONTINUE                                        02730001
027400                                                                  02740001
027500             WHEN SQLCODE = +100                                  02750001
027600                 MOVE PV-CURRENT-PARAGRAPH                        02760001
027700                                     TO AA-PARAGRAPH-NAME         02770001
027800                 DISPLAY '******** PO NBR:'                       02780001
027900                          PV-DISP-PO-NBR                          02790001
028000                 DISPLAY '******** SEQ NBR:'                      02800001
028100                          PV-DISP-SEQ-NBR                         02810001
028200                 DISPLAY '******** CRE TMST:'                     02820001
028300                          PV-DISP-CRE-TMST                        02830001
028600                 MOVE 'ROW NOT ON TABLE ********'                 02860001
028700                          TO AA-MESSAGE-1                         02870001
028800                 MOVE SPACES TO AA-MESSAGE-2                      02880001
028900                 MOVE 'UNSUCCESSFUL DELETE'                       02890001
029000                          TO AA-DB2-OPERATION                     02900001
029100                 MOVE 'TPKSLIP'  TO AA-DB2-TABLE                  02910001
029200                 PERFORM Z999-DB2-ABEND                           02920001
029300             WHEN SQLWARN0 NOT = SPACES                           02930001
029400             WHEN SQLCODE  NOT = ZERO                             02940001
029500                 MOVE PV-CURRENT-PARAGRAPH                        02950001
029600                                     TO AA-PARAGRAPH-NAME         02960001
029700                 DISPLAY '******** PO NBR:'                       02970001
029800                          PV-DISP-PO-NBR                          02980001
029900                 DISPLAY '******** SEQ NBR:'                      02990001
030000                          PV-DISP-SEQ-NBR                         03000001
030100                 DISPLAY '******** CRE TMST:'                     03010001
030200                          PV-DISP-CRE-TMST                        03020001
030500                 MOVE SPACES TO AA-MESSAGE-1                      03050001
030600                                AA-MESSAGE-2                      03060001
030700                 MOVE 'UNSUCCESSFUL DELETE'                       03070001
030800                                     TO AA-DB2-OPERATION          03080001
030900                 MOVE 'TPKSLIP'      TO AA-DB2-TABLE              03090001
031000                 PERFORM Z999-DB2-ABEND                           03100001
031100         END-EVALUATE                                             03110001
031200     END-PERFORM.                                                 03120001
031300                                                                  03130001
031400     IF PC-RETRY-COUNT > PC-RETRY-MAX                             03140001
031500         MOVE PV-CURRENT-PARAGRAPH                                03150001
031600                             TO AA-PARAGRAPH-NAME                 03160001
031700         DISPLAY '******** PO NBR:'                               03170001
031800                          PV-DISP-PO-NBR                          03180001
031900         DISPLAY '******** SEQ NBR:'                              03190001
032000                          PV-DISP-SEQ-NBR                         03200001
032100         DISPLAY '******** CRE TMST:'                             03210001
032200                          PV-DISP-CRE-TMST                        03220001
032700         MOVE SPACES TO AA-MESSAGE-1                              03270001
032800                        AA-MESSAGE-2                              03280001
032900         MOVE 'MAX RETRIES EXCEEDED ON DELETE'                    03290001
033000                             TO AA-DB2-OPERATION                  03300001
033100         MOVE 'TPKSLIP'      TO AA-DB2-TABLE                      03310001
033200         PERFORM Z999-DB2-ABEND                                   03320001
033300     END-IF.                                                      03330001
033400                                                                  03340001
033500     EJECT                                                        03350001
033600 R100-READ-EXTRACT-FILE.                                          03360001
033700                                                                  03370001
033800     READ TPKSLIP-EXTRACT-FILE                                    03380001
033900          INTO DCLTPKSLIP                                         03390001
034000          AT END SET END-OF-EXTRACT TO TRUE.                      03400001
034100                                                                  03410001
034200     IF MORE-EXTRACT                                              03420001
034300         ADD 1 TO PV-TPKSLIP-INPUT-COUNT                          03430001
034400     END-IF.                                                      03440001
034500                                                                  03450001
034600                                                                  03460001
034700     EJECT                                                        03470001
034800*----------------------------------------------------------------*03480001
034900*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03490001
035000*----------------------------------------------------------------*03500001
035100 X100-CHECKPOINT-CHECK.                                           03510001
035200                                                                  03520001
035300     MOVE 'X100-CHECKPOINT-CHECK' TO PV-CURRENT-PARAGRAPH.        03530001
035400                                                                  03540001
035500     EXEC SQL                                                     03550001
035600       SET :WS-TMST = CURRENT TIMESTAMP                           03560001
035700     END-EXEC.                                                    03570001
035800                                                                  03580001
035900     IF SQLCODE = +0                                              03590001
036000         CONTINUE                                                 03600001
036100     ELSE                                                         03610001
036200         MOVE PV-CURRENT-PARAGRAPH                                03620001
036300                             TO AA-PARAGRAPH-NAME                 03630001
036400         MOVE SPACES TO AA-MESSAGE-1                              03640001
036500                        AA-MESSAGE-2                              03650001
036600         MOVE 'BAD SET COMMAND'                                   03660001
036700                             TO AA-DB2-OPERATION                  03670001
036800         MOVE SPACES             TO AA-DB2-TABLE                  03680001
036900         PERFORM Z999-DB2-ABEND                                   03690001
037000     END-IF.                                                      03700001
037100                                                                  03710001
037200     IF WS-TMST > WS-HOLD-TMST                                    03720001
037300         IF NO-COMMITS-TAKEN                                      03730001
037400             MOVE PC-IN-PROCESS-CODE TO PV-CKPT-STAT-CODE         03740001
037500             PERFORM X600-UPDATE-TCKRSTCNTL                       03750001
037600             SET COMMITS-TAKEN TO TRUE                            03760001
037700         END-IF                                                   03770001
037800         PERFORM X700-UPDATE-TCKRSTINF                            03780001
037900         PERFORM Y100-COMMIT                                      03790001
038000         PERFORM X500-SET-CHECKPOINT-TIME                         03800001
038100     END-IF.                                                      03810001
038200                                                                  03820001
038300 EJECT                                                            03830001
038400*----------------------------------------------------------------*03840001
038500*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03850001
038600*----------------------------------------------------------------*03860001
038700 X200-CHECKPOINT-RESTART.                                         03870001
038800                                                                  03880001
038900     MOVE 'X200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.      03890001
039000                                                                  03900001
039100     PERFORM X400-GET-CHECKPOINT-INFO.                            03910001
039200     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     03920001
039300                                                                  03930001
039400     DISPLAY '** AHKUP051 CHECKPOINT RESTART **'                  03940001
039500     DISPLAY '** EXTRACT RECS BYPASSED ON RESTART = '             03950001
039600              CR-EXTRACT-RECS-WORKED.                             03960001
039700     DISPLAY '***********************************************'    03970001
039800                                                                  03980001
039900     PERFORM R100-READ-EXTRACT-FILE                               03990001
040000         CR-EXTRACT-RECS-WORKED TIMES.                            04000001
040100     PERFORM R100-READ-EXTRACT-FILE.                              04010001
040200 EJECT                                                            04020001
040300*----------------------------------------------------------------*04030001
040400*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *04040001
040500*----------------------------------------------------------------*04050001
040600 X300-GET-CHECKPOINT-CNTL.                                        04060001
040700                                                                  04070001
040800     MOVE 'X300-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     04080001
040900                                                                  04090001
041000     PERFORM WITH TEST AFTER                                      04100001
041100             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04110001
041200             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04120001
041300                     SQLCODE = ZERO                               04130001
041400                                                                  04140001
041500             EXEC SQL                                             04150001
041600              SELECT CKPT_STAT_CODE                               04160001
041700               INTO :PV-CKPT-STAT-CODE                            04170001
041800               FROM TCKRSTCNTL                                    04180001
041900               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04190001
042000             END-EXEC                                             04200001
042100                                                                  04210001
042200             EVALUATE TRUE                                        04220001
042300                 WHEN SQLCODE = ZERO                              04230001
042400                 WHEN SQLCODE = -904                              04240001
042500                 WHEN SQLCODE = -913                              04250001
042600                      CONTINUE                                    04260001
042700                                                                  04270001
042800                 WHEN SQLWARN0 NOT = SPACES                       04280001
042900                 WHEN SQLCODE  NOT = ZERO                         04290001
043000                     MOVE PV-CURRENT-PARAGRAPH                    04300001
043100                                         TO AA-PARAGRAPH-NAME     04310001
043200                     DISPLAY '******** PLAN_NAME:'                04320001
043300                              PV-PROGRAM-NAME                     04330001
043400                     MOVE SPACES TO AA-MESSAGE-1                  04340001
043500                                    AA-MESSAGE-2                  04350001
043600                     MOVE 'UNSUCCESSFUL SELECT'                   04360001
043700                                         TO AA-DB2-OPERATION      04370001
043800                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          04380001
043900                     PERFORM Z999-DB2-ABEND                       04390001
044000             END-EVALUATE                                         04400001
044100     END-PERFORM.                                                 04410001
044200                                                                  04420001
044300     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04430001
044400         MOVE PV-CURRENT-PARAGRAPH                                04440001
044500                             TO AA-PARAGRAPH-NAME                 04450001
044600         DISPLAY '******** PLAN_NAME:'                            04460001
044700                  PV-PROGRAM-NAME                                 04470001
044800         MOVE SPACES TO AA-MESSAGE-1                              04480001
044900                        AA-MESSAGE-2                              04490001
045000         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    04500001
045100                             TO AA-DB2-OPERATION                  04510001
045200         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      04520001
045300         PERFORM Z999-DB2-ABEND                                   04530001
045400     END-IF.                                                      04540001
045500                                                                  04550001
045600 EJECT                                                            04560001
045700*----------------------------------------------------------------*04570001
045800*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *04580001
045900*----------------------------------------------------------------*04590001
046000 X400-GET-CHECKPOINT-INFO.                                        04600001
046100                                                                  04610001
046200     MOVE 'X400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     04620001
046300                                                                  04630001
046400     PERFORM WITH TEST AFTER                                      04640001
046500             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04650001
046600             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04660001
046700                     SQLCODE = ZERO                               04670001
046800                                                                  04680001
046900             EXEC SQL                                             04690001
047000              SELECT WORK_STRG_DESC                               04700001
047100               INTO :TCKRSTINF-WORK-STRG-DESC                     04710001
047200               FROM TCKRSTINF                                     04720001
047300               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04730001
047400             END-EXEC                                             04740001
047500                                                                  04750001
047600             EVALUATE TRUE                                        04760001
047700                 WHEN SQLCODE = ZERO                              04770001
047800                 WHEN SQLCODE = -904                              04780001
047900                 WHEN SQLCODE = -913                              04790001
048000                      CONTINUE                                    04800001
048100                                                                  04810001
048200                 WHEN SQLWARN0 NOT = SPACES                       04820001
048300                 WHEN SQLCODE  NOT = ZERO                         04830001
048400                     MOVE PV-CURRENT-PARAGRAPH                    04840001
048500                                         TO AA-PARAGRAPH-NAME     04850001
048600                     DISPLAY '******** PLAN_NAME:'                04860001
048700                              PV-PROGRAM-NAME                     04870001
048800                     MOVE SPACES TO AA-MESSAGE-1                  04880001
048900                                    AA-MESSAGE-2                  04890001
049000                     MOVE 'UNSUCCESSFUL SELECT'                   04900001
049100                                         TO AA-DB2-OPERATION      04910001
049200                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          04920001
049300                     PERFORM Z999-DB2-ABEND                       04930001
049400             END-EVALUATE                                         04940001
049500     END-PERFORM.                                                 04950001
049600                                                                  04960001
049700     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04970001
049800         MOVE PV-CURRENT-PARAGRAPH                                04980001
049900                             TO AA-PARAGRAPH-NAME                 04990001
050000         DISPLAY '******** PLAN_NAME:'                            05000001
050100                  PV-PROGRAM-NAME                                 05010001
050200         MOVE SPACES TO AA-MESSAGE-1                              05020001
050300                        AA-MESSAGE-2                              05030001
050400         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05040001
050500                             TO AA-DB2-OPERATION                  05050001
050600         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      05060001
050700         PERFORM Z999-DB2-ABEND                                   05070001
050800     END-IF.                                                      05080001
050900                                                                  05090001
051000 EJECT                                                            05100001
051100*----------------------------------------------------------------*05110001
051200*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *05120001
051300*----------------------------------------------------------------*05130001
051400 X500-SET-CHECKPOINT-TIME.                                        05140001
051500                                                                  05150001
051600     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-CURRENT-PARAGRAPH.     05160001
051700                                                                  05170001
051800     PERFORM WITH TEST AFTER                                      05180001
051900             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05190001
052000             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05200001
052100                     SQLCODE = ZERO                               05210001
052200                                                                  05220001
052300             EXEC SQL                                             05230001
052400              SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)05240001
052500               INTO :WS-HOLD-TMST                                 05250001
052600               FROM TCKRSTCNTL                                    05260001
052700               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05270001
052800             END-EXEC                                             05280001
052900                                                                  05290001
053000             EVALUATE TRUE                                        05300001
053100                 WHEN SQLCODE = ZERO                              05310001
053200                 WHEN SQLCODE = -904                              05320001
053300                 WHEN SQLCODE = -913                              05330001
053400                      CONTINUE                                    05340001
053500                                                                  05350001
053600                 WHEN SQLWARN0 NOT = SPACES                       05360001
053700                 WHEN SQLCODE  NOT = ZERO                         05370001
053800                     MOVE PV-CURRENT-PARAGRAPH                    05380001
053900                                         TO AA-PARAGRAPH-NAME     05390001
054000                     DISPLAY '******** PLAN_NAME:'                05400001
054100                              PV-PROGRAM-NAME                     05410001
054200                     MOVE SPACES TO AA-MESSAGE-1                  05420001
054300                                    AA-MESSAGE-2                  05430001
054400                     MOVE 'UNSUCCESSFUL SELECT'                   05440001
054500                                         TO AA-DB2-OPERATION      05450001
054600                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05460001
054700                     PERFORM Z999-DB2-ABEND                       05470001
054800             END-EVALUATE                                         05480001
054900     END-PERFORM.                                                 05490001
055000                                                                  05500001
055100     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05510001
055200         MOVE PV-CURRENT-PARAGRAPH                                05520001
055300                             TO AA-PARAGRAPH-NAME                 05530001
055400         DISPLAY '******** PLAN_NAME:'                            05540001
055500                  PV-PROGRAM-NAME                                 05550001
055600         MOVE SPACES TO AA-MESSAGE-1                              05560001
055700                        AA-MESSAGE-2                              05570001
055800         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05580001
055900                             TO AA-DB2-OPERATION                  05590001
056000         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05600001
056100         PERFORM Z999-DB2-ABEND                                   05610001
056200     END-IF.                                                      05620001
056300                                                                  05630001
056400 EJECT                                                            05640001
056500*----------------------------------------------------------------*05650001
056600*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *05660001
056700*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *05670001
056800*----------------------------------------------------------------*05680001
056900 X600-UPDATE-TCKRSTCNTL.                                          05690001
057000                                                                  05700001
057100     MOVE 'X600-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       05710001
057200                                                                  05720001
057300     PERFORM WITH TEST AFTER                                      05730001
057400             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05740001
057500             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05750001
057600                     SQLCODE = ZERO                               05760001
057700                                                                  05770001
057800             EXEC SQL                                             05780001
057900                 UPDATE TCKRSTCNTL                                05790001
058000                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          05800001
058100                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          05810001
058200             END-EXEC                                             05820001
058300                                                                  05830001
058400             EVALUATE TRUE                                        05840001
058500                 WHEN SQLCODE = ZERO                              05850001
058600                 WHEN SQLCODE = -904                              05860001
058700                 WHEN SQLCODE = -913                              05870001
058800                      CONTINUE                                    05880001
058900                                                                  05890001
059000                 WHEN SQLWARN0 NOT = SPACES                       05900001
059100                 WHEN SQLCODE  NOT = ZERO                         05910001
059200                     MOVE PV-CURRENT-PARAGRAPH                    05920001
059300                                         TO AA-PARAGRAPH-NAME     05930001
059400                     DISPLAY '******** PLAN_NAME:'                05940001
059500                              PV-PROGRAM-NAME                     05950001
059600                     MOVE SPACES TO AA-MESSAGE-1                  05960001
059700                                    AA-MESSAGE-2                  05970001
059800                     MOVE 'UNSUCCESSFUL UPDATE'                   05980001
059900                                         TO AA-DB2-OPERATION      05990001
060000                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          06000001
060100                     PERFORM Z999-DB2-ABEND                       06010001
060200             END-EVALUATE                                         06020001
060300     END-PERFORM.                                                 06030001
060400                                                                  06040001
060500     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06050001
060600         MOVE PV-CURRENT-PARAGRAPH                                06060001
060700                             TO AA-PARAGRAPH-NAME                 06070001
060800         DISPLAY '******** PLAN_NAME:'                            06080001
060900                  PV-PROGRAM-NAME                                 06090001
061000         MOVE SPACES TO AA-MESSAGE-1                              06100001
061100                        AA-MESSAGE-2                              06110001
061200         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06120001
061300                             TO AA-DB2-OPERATION                  06130001
061400         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06140001
061500         PERFORM Z999-DB2-ABEND                                   06150001
061600     END-IF.                                                      06160001
061700                                                                  06170001
061800     EJECT                                                        06180001
061900*----------------------------------------------------------------*06190001
062000*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *06200001
062100*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *06210001
062200*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *06220001
062300*----------------------------------------------------------------*06230001
062400 X700-UPDATE-TCKRSTINF.                                           06240001
062500                                                                  06250001
062600     MOVE 'X700-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        06260001
062700                                                                  06270001
062800     MOVE PV-TPKSLIP-INPUT-COUNT TO CR-EXTRACT-RECS-WORKED.       06280007
062900     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   06290001
063000     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    06300001
063100                                                                  06310001
063200     PERFORM WITH TEST AFTER                                      06320001
063300             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06330001
063400             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06340001
063500                     SQLCODE = ZERO                               06350001
063600                                                                  06360001
063700             EXEC SQL                                             06370001
063800                 UPDATE TCKRSTINF                                 06380001
063900                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 06390001
064000                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06400001
064100             END-EXEC                                             06410001
064200                                                                  06420001
064300             EVALUATE TRUE                                        06430001
064400                 WHEN SQLCODE = ZERO                              06440001
064500                 WHEN SQLCODE = -904                              06450001
064600                 WHEN SQLCODE = -913                              06460001
064700                      CONTINUE                                    06470001
064800                                                                  06480001
064900                 WHEN SQLWARN0 NOT = SPACES                       06490001
065000                 WHEN SQLCODE  NOT = ZERO                         06500001
065100                     MOVE PV-CURRENT-PARAGRAPH                    06510001
065200                                         TO AA-PARAGRAPH-NAME     06520001
065300                     DISPLAY '******** PLAN_NAME:'                06530001
065400                              PV-PROGRAM-NAME                     06540001
065500                     MOVE SPACES TO AA-MESSAGE-1                  06550001
065600                                    AA-MESSAGE-2                  06560001
065700                     MOVE 'UNSUCCESSFUL UPDATE'                   06570001
065800                                         TO AA-DB2-OPERATION      06580001
065900                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          06590001
066000                     PERFORM Z999-DB2-ABEND                       06600001
066100             END-EVALUATE                                         06610001
066200     END-PERFORM.                                                 06620001
066300                                                                  06630001
066400     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06640001
066500         MOVE PV-CURRENT-PARAGRAPH                                06650001
066600                             TO AA-PARAGRAPH-NAME                 06660001
066700         DISPLAY '******** PLAN_NAME:'                            06670001
066800                  PV-PROGRAM-NAME                                 06680001
066900         MOVE SPACES TO AA-MESSAGE-1                              06690001
067000                        AA-MESSAGE-2                              06700001
067100         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06710001
067200                             TO AA-DB2-OPERATION                  06720001
067300         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      06730001
067400         PERFORM Z999-DB2-ABEND                                   06740001
067500     END-IF.                                                      06750001
067600                                                                  06760001
067700 EJECT                                                            06770001
067800                                                                  06780001
067900*----------------------------------------------------------------*06790001
068000*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *06800001
068100*----------------------------------------------------------------*06810001
068200 Y100-COMMIT.                                                     06820001
068300                                                                  06830001
068400     MOVE 'Y100-COMMIT'    TO PV-CURRENT-PARAGRAPH.               06840001
068500                                                                  06850001
068600     EXEC SQL                                                     06860001
068700         COMMIT                                                   06870001
068800     END-EXEC.                                                    06880001
068900                                                                  06890001
069000     EVALUATE TRUE                                                06900001
069100         WHEN SQLCODE = ZEROS                                     06910001
069200             CONTINUE                                             06920001
069300         WHEN OTHER                                               06930001
069400             MOVE PV-CURRENT-PARAGRAPH                            06940001
069500                                 TO AA-PARAGRAPH-NAME             06950001
069600             MOVE SPACES TO AA-MESSAGE-1                          06960001
069700                            AA-MESSAGE-2                          06970001
069800             MOVE 'UNSUCCESSFUL COMMIT'                           06980001
069900                                 TO AA-DB2-OPERATION              06990001
070000             MOVE SPACES         TO AA-DB2-TABLE                  07000001
070100             PERFORM Z999-DB2-ABEND                               07010001
070200     END-EVALUATE.                                                07020001
070300 EJECT                                                            07030001
070400 Z900-PROCESS-ABEND.                                              07040001
070500                                                                  07050001
070600     DISPLAY '*** ABEND'.                                         07060001
070700     DISPLAY '*** PROGRAM   = AHKUP051'.                          07070001
070800     DISPLAY '*** PARAGRAPH = ' PV-CURRENT-PARAGRAPH.             07080001
070900     DISPLAY AA-MESSAGE-LINE-1.                                   07090001
071000     DISPLAY AA-MESSAGE-LINE-2.                                   07100001
071100     COPY DPPD004.                                                07110001
071200     CALL 'ILBOABN0' USING ABEND-CODE.                            07120001
071300                                                                  07130001
071400                                                                  07140001
071500                                                                  07150001
071600 Z999-DB2-ABEND.                                                  07160001
071700                                                                  07170001
071800     DISPLAY AA-ABEND-LIT.                                        07180001
071900     DISPLAY AA-DB2-ERROR-LIT.                                    07190001
072000     DISPLAY AA-PROGRAM-LIT.                                      07200001
072100     DISPLAY AA-PARAGRAPH-LIT.                                    07210001
072200     DISPLAY AA-DB2-OPERATION-LIT.                                07220001
072300     DISPLAY AA-DB2-TABLE.                                        07230001
072400     SET AC-DB2-ERROR TO TRUE.                                    07240001
072500                                                                  07250001
072600     COPY DPPD004.                                                07260001
072700                                                                  07270001
072800     CALL 'ILBOABN0' USING ABEND-CODE.                            07280001
