000100 IDENTIFICATION DIVISION.                                         00010001
000200 PROGRAM-ID.         AUKUT004.                                    00020001
000300 AUTHOR.             BARB ERTL.                                   00030001
000400 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00040001
000500 DATE-WRITTEN.       FEBRUARY 2008.                               00050001
000600 DATE-COMPILED.                                                   00060001
000700                                                                  00070001
000800******************************************************************00080001
000900* THIS PROGRAM EXTRACTS THE DAILY 3RD PARTY GIFT CARD ACTIVITY   *00090001
001000* ACTIVITY FROM TABLE AUT_GFT_CRD_TRN.  IT EXTRACTS ALL ROWS     *00100001
001100* THAT HAVE NOT PREVIOUSLY BEEN RECONCILED.                      *00110001
001200******************************************************************00120001
001300                                                                  00130001
001400******************************************************************00140001
001500 ENVIRONMENT DIVISION.                                            00150001
001600******************************************************************00160001
001700                                                                  00170001
001800 CONFIGURATION SECTION.                                           00180001
001900                                                                  00190001
002000 SOURCE-COMPUTER.    IBM-3090.                                    00200001
002100 OBJECT-COMPUTER.    IBM-3090.                                    00210001
002200                                                                  00220001
002300 INPUT-OUTPUT SECTION.                                            00230001
002400                                                                  00240001
002500 FILE-CONTROL.                                                    00250001
002600                                                                  00260001
002700     SELECT DAILY-ACTIVITY       ASSIGN TO OUT01.                 00270001
002800                                                                  00280001
002900******************************************************************00290001
003000 DATA DIVISION.                                                   00300001
003100******************************************************************00310001
003200                                                                  00320001
003300 FILE SECTION.                                                    00330001
003400                                                                  00340001
003500 FD  DAILY-ACTIVITY                                               00350001
003600     RECORDING MODE IS F                                          00360001
003700     BLOCK CONTAINS 0 RECORDS                                     00370001
003800     LABEL RECORDS ARE OMITTED.                                   00380001
003900                                                                  00390001
004000 01  DAILY-RECORD                PIC  X(80).                      00400003
004100                                                                  00410001
004200 WORKING-STORAGE SECTION.                                         00420001
004300                                                                  00430001
004400 01  ABEND-CODE                  PIC S9(04)     VALUE +0  COMP.   00440001
004500                                                                  00450001
004600******************************************************************00460001
004700*    PC-PROGRAM CONSTANTS                                        *00470001
004800******************************************************************00480001
004900 01  PC-PROGRAM-CONSTANTS.                                        00490001
005000     05  PC-PROGRAM-NAME         PIC X(08)      VALUE 'AUKUT004'. 00500001
005100                                                                  00510001
005200******************************************************************00520001
005300*    PV-PROGRAM VARIABLES                                        *00530001
005400******************************************************************00540001
005500 01  PV-PROGRAM-VARIABLES.                                        00550001
005600     05  PV-PARAGRAPH-NAME            PIC  X(30)     VALUE SPACES.00560001
005700     05  PV-DB2-OPERATION-ATTEMPTED   PIC  X(30)     VALUE SPACES.00570001
005800                                                                  00580001
005900******************************************************************00590001
006000*    PS-PROGRAM SWITCHES                                         *00600001
006100******************************************************************00610001
006200 01  PS-PROGRAM-SWITCHES.                                         00620001
006300     05  PS-END-OF-ACTIVITY-CSR-SW    PIC  X(01)     VALUE 'N'.   00630001
006400         88  PS-END-OF-ACTIVITY-CURSOR               VALUE 'Y'.   00640001
006500                                                                  00650001
006600******************************************************************00660001
006700*    PA-PROGRAM ACCUMULATORS                                     *00670001
006800******************************************************************00680001
006900 01  PA-PROGRAM-ACCUMULATORS.                                     00690001
007000     05  PA-ACTIVITY-ROWS-FETCHED     PIC S9(11)     COMP-3       00700001
007100                                                     VALUE ZEROES.00710001
007200     05  PA-ACTIVITY-ROWS-WRITTEN     PIC S9(11)     COMP-3       00720001
007300                                                     VALUE ZEROES.00730001
007400                                                                  00740001
007500******************************************************************00750001
007600*        DAILY EXTRACT RECORD LAYOUT                             *00760001
007700******************************************************************00770001
007800     COPY AURD012.                                                00780001
007900                                                                  00790001
008000******************************************************************00800001
008100*    VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004     *00810001
008200******************************************************************00820001
008300     COPY DPWS004.                                                00830001
008400                                                                  00840001
008500******************************************************************00850001
008600*    3RD PARTY GIFT CARD TRANSACTION TABLE                       *00860001
008700******************************************************************00870001
008800     EXEC SQL                                                     00880001
008900         INCLUDE GCT00002                                         00890001
009000     END-EXEC.                                                    00900001
009100                                                                  00910001
009200******************************************************************00920001
009300*    3RD PARTY GIFT CARD RECONCILE TABLE                         *00930001
009400******************************************************************00940001
009500     EXEC SQL                                                     00950001
009600         INCLUDE GCT00001                                         00960001
009700     END-EXEC.                                                    00970001
009800                                                                  00980001
009900******************************************************************00990001
010000*    STANDARD LAYOUT FOR THE SQL COMMUNCATIONS AREA              *01000001
010100******************************************************************01010001
010200     EXEC SQL                                                     01020001
010300         INCLUDE SQLCA                                            01030001
010400     END-EXEC.                                                    01040001
010500                                                                  01050001
010600     COPY SQLCA2.                                                 01060001
010700                                                                  01070001
010800******************************************************************01080001
010900*    CURSOR DECLARATION FOR ACTIVITY CURSOR                      *01090001
011000******************************************************************01100001
011100     EXEC SQL                                                     01110001
011200         DECLARE  ACTVY_CURSOR CURSOR FOR                         01120001
011300          SELECT  A.CRD_ACCT_NBR                                  01130005
011400                 ,A.SLS_DTE                                       01140005
011500                 ,A.STR_NBR                                       01150005
011600                 ,A.RGST_ID                                       01160005
011700                 ,A.TRN_NBR                                       01170005
011800                 ,A.STRT_TM                                       01180005
011900                 ,A.LNE_ITM_SEQ_NBR                               01190005
012000                 ,A.UPC_NUMBER                                    01200005
012100                 ,A.CUST_CHRGD_AMT                                01210005
012200            FROM  GCT_GFT_CRD_TRN A                               01220001
012300           WHERE  NOT EXISTS (SELECT 'Y'                          01230001
012400                  FROM GCT_GFT_CRD_RECNCL B                       01240001
012500                 WHERE A.CRD_ACCT_NBR = B.CRD_ACCT_NBR)           01250001
012600           WITH UR                                                01260001
012700     END-EXEC.                                                    01270001
012800                                                                  01280001
012900 PROCEDURE DIVISION.                                              01290001
013000                                                                  01300001
013100******************************************************************01310001
013200 0000-MAINLINE.                                                   01320001
013300******************************************************************01330001
013400                                                                  01340001
013500     PERFORM 1000-INITIALIZE.                                     01350001
013600                                                                  01360001
013700     PERFORM 2000-PROCESS-CARD-ACTIVITY                           01370001
013800         UNTIL PS-END-OF-ACTIVITY-CURSOR.                         01380001
013900                                                                  01390001
014000     PERFORM 3000-EOJ-ROUTINE.                                    01400001
014100                                                                  01410001
014200     GOBACK.                                                      01420001
014300******************************************************************01430001
014400*     1000-INITIALIZE                                            *01440001
014500* ==> PROCESSES:                                                 *01450001
014600*     -OPEN OUTPUT FILE                                          *01460001
014700*     -OPEN CURSOR                                               *01470001
014800*     -FETCH FIRST ROW OF CURSOR                                 *01480001
014900* ==> PERFORMED FROM: 0000-MAINLINE                              *01490001
015000******************************************************************01500001
015100 1000-INITIALIZE.                                                 01510001
015200                                                                  01520001
015300     OPEN OUTPUT DAILY-ACTIVITY.                                  01530001
015400     PERFORM 7000-OPEN-ACTIVITY-CURSOR.                           01540001
015500     PERFORM 7100-FETCH-ACTIVITY-CURSOR.                          01550001
015600                                                                  01560001
015700******************************************************************01570001
015800*     2000-PROCESS-CARD-ACTIVITY                                 *01580001
015900* ==> PROCESSES:                                                 *01590001
016000*     -PROCESS ROW FETCHED FROM THE CURSOR                       *01600001
016100*     -FETCHES THE NEXT ROW FROM THE CURSOR                      *01610001
016200* ==> PERFORMED FROM: 0000-MAINLINE                              *01620001
016300******************************************************************01630001
016400 2000-PROCESS-CARD-ACTIVITY.                                      01640001
016500                                                                  01650001
016600     PERFORM 2100-WRITE-GCT00002-ACTIVITY.                        01660001
016700     PERFORM 7100-FETCH-ACTIVITY-CURSOR.                          01670001
016800                                                                  01680001
016900******************************************************************01690001
017000*     2100-WRITE-GCT00002-ACTIVITY                               *01700001
017100* ==> PROCESSES:                                                 *01710001
017200*     -FORMATS AND WRITES THE OUTPUT RECORD                      *01720001
017300* ==> PERFORMED FROM:  2000-PROCESS-CARD-ACTIVITY                *01730001
017400******************************************************************01740001
017500 2100-WRITE-GCT00002-ACTIVITY.                                    01750001
017600                                                                  01760001
017700     INITIALIZE AU012-DETAIL-TRANS.                               01770001
017800                                                                  01780001
017900     MOVE GCT00002-CRD-ACCT-NBR     TO AU012-GIFT-CARD-NBR.       01790010
018000     MOVE GCT00002-SLS-DTE          TO AU012-SLS-DTE.             01800006
018100     MOVE GCT00002-STR-NBR          TO AU012-STR-NBR.             01810006
018200     MOVE GCT00002-RGST-ID          TO AU012-RGST-ID.             01820006
018300     MOVE GCT00002-TRN-NBR          TO AU012-TRN-NBR.             01830006
018400     MOVE GCT00002-STRT-TM          TO AU012-STRT-TM.             01840006
018500     MOVE GCT00002-LNE-ITM-SEQ-NBR  TO AU012-LNE-ITM-SEQ-NBR.     01850006
018600     MOVE GCT00002-CUST-CHRGD-AMT   TO AU012-TRANSACTION-AMT.     01860006
018700     MOVE GCT00002-UPC-NUMBER       TO AU012-UPC-NBR.             01870006
018800                                                                  01880001
018900     WRITE DAILY-RECORD                                           01890001
019000         FROM AU012-DETAIL-TRANS.                                 01900001
019100                                                                  01910001
019200     ADD +1 TO PA-ACTIVITY-ROWS-WRITTEN.                          01920001
019300                                                                  01930001
019400******************************************************************01940001
019500*     3000-EOJ-ROUTINE                                           *01950001
019600* ==> PROCESSES:                                                 *01960001
019700*     -CLOSES THE KMC ACTIVITY CURSOR                            *01970001
019800* ==> PERFORMED FROM: 0000-MAINLINE                              *01980001
019900******************************************************************01990001
020000 3000-EOJ-ROUTINE.                                                02000001
020100                                                                  02010001
020200     PERFORM 7200-CLOSE-ACTIVITY-CURSOR                           02020001
020300                                                                  02030001
020400     CLOSE DAILY-ACTIVITY.                                        02040001
020500                                                                  02050001
020600     DISPLAY ' '.                                                 02060001
020700     DISPLAY PC-PROGRAM-NAME                                      02070001
020800             '  ROWS FETCHED FROM GCT_GFT_CRD_TRN    '            02080001
020900                                        PA-ACTIVITY-ROWS-FETCHED. 02090001
021000     DISPLAY PC-PROGRAM-NAME '  ROWS WRITTEN TO OUTPUT FILE:  '   02100001
021100                                        PA-ACTIVITY-ROWS-WRITTEN. 02110001
021200     DISPLAY ' '.                                                 02120001
021300                                                                  02130001
021400******************************************************************02140001
021500*     7000-OPEN-ACTIVITY-CURSOR.                                 *02150001
021600* ==> PROCESSES:                                                 *02160001
021700*     -OPENS THE ACTIVITY CURSOR                                 *02170001
021800* ==> PERFORMED FROM: 1000-INITIALIZE                            *02180001
021900******************************************************************02190001
022000 7000-OPEN-ACTIVITY-CURSOR.                                       02200001
022100                                                                  02210001
022200     EXEC SQL                                                     02220001
022300         OPEN ACTVY_CURSOR                                        02230001
022400     END-EXEC.                                                    02240001
022500                                                                  02250001
022600     EVALUATE TRUE                                                02260001
022700         WHEN SQLCODE = +0                                        02270001
022800             CONTINUE                                             02280001
022900         WHEN OTHER                                               02290001
023000             MOVE '7000-OPEN-ACTIVITY-CURSOR       '              02300001
023100                               TO PV-PARAGRAPH-NAME               02310001
023200             MOVE 'OPEN ACTIVITY CURSOR      '                    02320001
023300                               TO PV-DB2-OPERATION-ATTEMPTED      02330001
023400             PERFORM 9999-SQL-ABEND                               02340001
023500     END-EVALUATE.                                                02350001
023600                                                                  02360001
023700******************************************************************02370001
023800*     7100-FETCH-ACTIVITY-CURSOR.                                *02380001
023900* ==> PROCESSES:                                                 *02390001
024000*     -FETCHES A ROW FROM THE ACTIVITY CURSOR                    *02400001
024100* ==> PERFORMED FROM: 1000-INITIALIZE                            *02410001
024200*                     2000-PROCESS-CARD-ACTIVITY                 *02420001
024300******************************************************************02430001
024400 7100-FETCH-ACTIVITY-CURSOR.                                      02440001
024500                                                                  02450001
024600     EXEC SQL                                                     02460001
024700         FETCH  ACTVY_CURSOR                                      02470001
024800          INTO  :GCT00002-CRD-ACCT-NBR                            02480001
024900               ,:GCT00002-SLS-DTE                                 02490001
025000               ,:GCT00002-STR-NBR                                 02500001
025100               ,:GCT00002-RGST-ID                                 02510002
025200               ,:GCT00002-TRN-NBR                                 02520001
025300               ,:GCT00002-STRT-TM                                 02530001
025400               ,:GCT00002-LNE-ITM-SEQ-NBR                         02540001
025500               ,:GCT00002-UPC-NUMBER                              02550002
025600               ,:GCT00002-CUST-CHRGD-AMT                          02560002
025700     END-EXEC.                                                    02570001
025800                                                                  02580001
025900     EVALUATE TRUE                                                02590001
026000         WHEN SQLCODE = +0                                        02600001
026100             ADD +1 TO PA-ACTIVITY-ROWS-FETCHED                   02610001
026200         WHEN SQLCODE = +100                                      02620001
026300             SET PS-END-OF-ACTIVITY-CURSOR                        02630001
026400                               TO TRUE                            02640001
026500         WHEN OTHER                                               02650001
026600             MOVE '7100-FETCH-ACTIVITY-CURSOR      '              02660001
026700                               TO PV-PARAGRAPH-NAME               02670001
026800             MOVE 'FETCH ACTIVITY CURSOR     '                    02680001
026900                               TO PV-DB2-OPERATION-ATTEMPTED      02690001
027000             PERFORM 9999-SQL-ABEND                               02700001
027100     END-EVALUATE.                                                02710001
027200                                                                  02720001
027300******************************************************************02730001
027400*     7200-CLOSE-ACTIVITY-CURSOR.                                *02740001
027500* ==> PROCESSES:                                                 *02750001
027600*     -CLOSES THE ACTIVITY CURSOR                                *02760001
027700* ==> PERFORMED FROM: 3000-EOJ-ROUTINE                           *02770001
027800******************************************************************02780001
027900 7200-CLOSE-ACTIVITY-CURSOR.                                      02790001
028000                                                                  02800001
028100     EXEC SQL                                                     02810001
028200         CLOSE ACTVY_CURSOR                                       02820001
028300     END-EXEC.                                                    02830001
028400                                                                  02840001
028500     EVALUATE TRUE                                                02850001
028600         WHEN SQLCODE = +0                                        02860001
028700             CONTINUE                                             02870001
028800         WHEN OTHER                                               02880001
028900             MOVE '7200-CLOSE-ACTIVITY-CURSOR      '              02890001
029000                               TO PV-PARAGRAPH-NAME               02900001
029100             MOVE 'CLOSE ACTIVITY CURSOR     '                    02910001
029200                               TO PV-DB2-OPERATION-ATTEMPTED      02920001
029300             PERFORM 9999-SQL-ABEND                               02930001
029400     END-EVALUATE.                                                02940001
029500                                                                  02950001
029600******************************************************************02960001
029700*     9999-SQL-ABEND                                             *02970001
029800* ==> PROCESSES:                                                 *02980001
029900*     -PERFORMS ABEND PROCESSING FOR SQL ERRORS.                 *02990001
030000* ==> PERFORMED FROM:                                            *03000001
030100******************************************************************03010001
030200 9999-SQL-ABEND.                                                  03020001
030300                                                                  03030001
030400     DISPLAY '9999-SQL-ABEND'.                                    03040001
030500     DISPLAY '**  ABEND     **'.                                  03050001
030600     DISPLAY '**  PROGRAM   ** = ' PC-PROGRAM-NAME.               03060001
030700     DISPLAY '**  PARAGRAPH ** = ' PV-PARAGRAPH-NAME.             03070001
030800     DISPLAY '**  OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.    03080001
030900                                                                  03090001
031000******************************************************************03100001
031100* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *03110001
031200* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *03120001
031300* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *03130001
031400* FORMAT.                                                        *03140001
031500******************************************************************03150001
031600     COPY DPPD004.                                                03160001
031700                                                                  03170001
031800     MOVE +4013 TO ABEND-CODE.                                    03180001
031900     CALL 'ILBOABN0' USING ABEND-CODE.                            03190001
