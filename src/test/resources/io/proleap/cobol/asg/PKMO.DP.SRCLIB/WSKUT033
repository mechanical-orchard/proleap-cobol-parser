000100 IDENTIFICATION DIVISION.                                         00010001
000200 PROGRAM-ID.         WSKUT033.                                    00020001
000300 AUTHOR.             RENGIN SIRVANCI.                             00030001
000400 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00040001
000500 DATE-WRITTEN.       MAY 2007.                                    00050001
000600                                                                  00060001
000700****************************************************************  00070001
000800* This program will be used to re-send PIX previously extracted   00080001
000900* by WSKUT032.  It will put the information that is on a flat     00090001
001000* file into XML format.                                           00100001
001100* PIXCUBISCN -  cubiscan queue                                    00110001
001200* PIXFASHION -  fashion sales queue                               00120001
001500* PIXTRLRUPD -  rc/su queue                                       00130001
001501*                                                                 00140001
001502****************************************************************  00150001
001503*                                                                 00150101
001504* 2011-01-18  Christine Twiehaus WR38972                          00150201
001505*             PIXCUBISCN need to be written to 2 queues           00150301
001506*             added processing of cursor, order by QUE_NM desc    00150401
001507*             open, put and close added for new queue             00150501
001508*                                                                 00150601
001600****************************************************************  00150701
001700 ENVIRONMENT DIVISION.                                            00150801
001800******************************************************************00150901
001900 CONFIGURATION SECTION.                                           00151001
002000 SOURCE-COMPUTER.        IBM-3090.                                00152001
002100 OBJECT-COMPUTER.        IBM-3090.                                00153001
002200                                                                  00154001
002300 INPUT-OUTPUT SECTION.                                            00155001
002400 FILE-CONTROL.                                                    00156001
002500     SELECT PIX-FILE-IN                                           00157001
002600         ASSIGN TO INP01.                                         00158001
002700                                                                  00159001
002800****************************************************************  00160001
002900 DATA DIVISION.                                                   00170001
003000****************************************************************  00180001
003100 FILE SECTION.                                                    00190001
003200                                                                  00200001
003300 FD  PIX-FILE-IN                                                  00210001
003400     RECORDING MODE IS F                                          00220001
003500     LABEL RECORDS ARE STANDARD                                   00230001
003600     RECORD CONTAINS 700 CHARACTERS                               00240001
003700     BLOCK CONTAINS 0 RECORDS.                                    00250001
003800 01  PIX-REC-IN                   PIC X(700).                     00260001
003900                                                                  00270001
004000******************************************************************00280001
004100 WORKING-STORAGE SECTION.                                         00290001
004200******************************************************************00300001
004300 01  PS-PROGRAM-SWITCHES.                                         00310001
004400     05  PS-MQPUT-SUCCESSFUL-IND     PIC X(01) VALUE SPACES.      00320001
004500         88  PS-MQPUT-SUCCESSFUL               VALUE 'Y'.         00330001
004600     05  PS-END-OF-INPUT-SW          PIC X(01) VALUE 'N'.         00340001
004700         88  PS-END-OF-INPUT-YES               VALUE 'Y'.         00350001
004800         88  PS-END-OF-INPUT-NO                VALUE 'N'.         00360001
004810* CLT 2011-01-18 WR38972 start                                    00370001
004820     05  PS-END-OF-MQCUR-SW              PIC X(01) VALUE 'N'.     00380001
004830         88  PS-END-OF-MQCUR-YES                   VALUE 'Y'.     00390001
004840         88  PS-END-OF-MQCUR-NO                    VALUE 'N'.     00400001
004841     05  PV-1ST-FETCH                    PIC X(01) VALUE 'Y'.     00410001
004842         88  PV-1ST-FETCH-YES                      VALUE 'Y'.     00420001
004843         88  PV-1ST-FETCH-NO                       VALUE 'N'.     00430001
004850* CLT 2011-01-18 WR38972 END                                      00440001
004900                                                                  00450001
005000 01  PA-PROGRAM-ACCUMULATORS.                                     00460001
005100     05  PA-TOTAL-RECORDS-IN         PIC S9(9) VALUE +0 COMP-3.   00470001
005200     05  PA-TOTAL-MQ-MSGS-SENT       PIC S9(9) VALUE +0 COMP-3.   00480001
005300     05  PA-TOTAL-ERRORS-PROCESSED   PIC S9(09) VALUE +0 COMP-3.  00490001
005400                                                                  00500001
005500 01  PA-QUEUE-MSG-TABLE.                                          00510001
005600     05  PA-INDIV-QUEUE OCCURS 6 INDEXED BY PV-INDX.              00520001
005700         10  PA-QUEUE-NAME           PIC X(10) VALUE SPACES.      00530001
005800         10  PA-QUEUE-MESG-COUNT     PIC S9(9) VALUE +0 COMP.     00540001
005900                                                                  00550001
006000 01  PV-PROGRAM-VARIABLES.                                        00560001
006100     05  N                           PIC 9(05) VALUE ZEROES.      00570001
006200     05  K                           PIC 9(02) VALUE ZEROES.      00580001
006300     05  PC-MQPUT-RETRY-COUNTER      PIC 9(3)  VALUE ZERO.        00590001
006400     05  PV-NO-OF-QUES               PIC  9(2) VALUE  0.          00600001
006410     05  PV-RETRY-COUNTER            PIC S9(4) VALUE +0 COMP SYNC.00610001
006500     05  PV-PARAGRAPH                PIC X(48) VALUE SPACES.      00620001
006600     05  PV-MSG-LENGTH               PIC S9(9) BINARY.            00630001
006700     05  PV-MSG-LENGTH-DISPLAY       PIC S9(9).                   00640001
006800     05  PV-HOLD-COMPLETION-CODE     PIC S9(9) BINARY.            00650001
006900     05  PV-HOLD-REASON              PIC S9(9) BINARY.            00660001
007000     05  PV-HOLD-PROCESS-TYPE        PIC X(16) VALUE SPACES.      00670001
007100     05  PV-SAVE-PROCESS-TYPE        PIC X(16).                   00680001
007200     05  PV-ACTION                   PIC X(60) VALUE SPACES.      00690001
007300                                                                  00700001
007400 01  PV-ABEND-VARIABLES.                                          00710001
007500     05  PV-SQLCODE                  PIC S9(9).                   00720001
007600     05  PV-DISPLAY-SQLCODE          PIC -------999.              00730001
007700     05  PV-ABEND-PROGRAM            PIC X(08) VALUE 'WSKUT033'.  00740001
007800     05  PV-ABEND-PARAGRAPH          PIC X(25) VALUE SPACES.      00750001
007900     05  PV-ABEND-OPERATION          PIC X(20) VALUE SPACES.      00760001
008000     05  PV-ABEND-STRUCTURE-1        PIC X(08) VALUE SPACES.      00770001
008100     05  PV-DB2-OPERATION-MESSAGE-1  PIC X(79) VALUE SPACES.      00780001
008200     05  PV-ABEND-CODE               PIC S9(4) VALUE +0 COMP SYNC.00790001
008300 01  PV-HOLD-MSGBUFFER.                                           00800001
008400     05  PV-MSGBUFFER-CHAR OCCURS 999999 TIMES                    00810001
008500                                     PIC X(01).                   00820001
008600                                                                  00830001
008700 01  PV-MSG.                                                      00840001
008800     05  PV-MQC-CONTROL-RECORD.                                   00850001
008900         10  PV-MQC-PROCESS-TYPE     PIC X(10) VALUE SPACES.      00860001
009000         10  PV-MQC-GROUP-ID-X       PIC X(06) VALUE SPACES.      00870001
009100         10  PV-MQC-GROUP-ID     REDEFINES                        00880001
009200             PV-MQC-GROUP-ID-X       PIC 9(06).                   00890001
009300         10  PV-MQC-STR-NBR-X        PIC X(04) VALUE SPACES.      00900001
009400         10  PV-MQC-STR-NBR      REDEFINES                        00910001
009500             PV-MQC-STR-NBR-X        PIC 9(04).                   00920001
009600     05  PV-DTL                      PIC X(10) VALUE SPACES.      00930001
009700******************************************************************00940001
009800 01  PE-MQ-ABEND-VARIABLES.                                       00950001
009900     05  PE-MQ-QMANAGER              PIC X(05) VALUE SPACES.      00960001
010000     05  PE-MQ-QMANAGER-REMOTE       PIC X(30) VALUE SPACES.      00970001
010100     05  PE-MQ-QNAME                 PIC X(48) VALUE SPACES.      00980001
010200     05  PE-MQ-COMPLETION-CODE       PIC 9(04) VALUE ZEROES.      00990001
010300     05  PE-MQ-REASON-CODE           PIC 9(04) VALUE ZEROES.      01000001
010400                                                                  01010001
010500******************************************************************01020001
010600 01  PV-XML-FIELDS.                                               01030001
010700     05  PV-XML-BANNER               PIC X(39) VALUE              01040001
010800*        '<?xml version="1.0" encoding="UTF-8" ?>'.               01050001
010900         '<?xml version="1.0"                  ?>'.               01060001
011000                                                                  01070001
011100                                                                  01080001
011200******************************************************************01090001
011300* INPUT PIX RECORD LAYOUT.                                        01100001
011400******************************************************************01110001
011500     COPY WSRD045.                                                01120001
011600                                                                  01130001
011700******************************************************************01140001
011800* OUTPUT PIX RECORD LAYOUT.                                       01150001
011900******************************************************************01160001
012000     COPY WSRD032.                                                01170001
012100                                                                  01180001
012200***************************************************************   01190001
012300* The field names specified will be used as the tag names in      01200001
012400* the generated XML and the case will be used.                    01210001
012500*                                                                 01220001
012600* Note that redefines and FILLER are ignored in generating        01230001
012700* the XML.                                                        01240001
012800***************************************************************   01250001
012900*                                                                 01260001
013000**** This is how big the incoming XML field can be.  Try to choose01270001
013100**** a more realistic size to prevent allocating too much memory. 01280001
013200*01  PV-XML                      PIC X(16777215) VALUE SPACES.    01290001
013300 01  PV-XML                      PIC X(99999)    VALUE SPACES.    01300001
013400 01  PV-BEFORE                   PIC X(99999).                    01310001
013500 01  PV-AFTER                    PIC X(99999).                    01320001
013600 01  PV-BEFORE-CNT               PIC 9(09)       VALUE ZERO.      01330001
013700 01  PV-AFTER-CNT                PIC 9(09)       VALUE ZERO.      01340001
013800 01  PV-EMPTY-TAG                PIC X(5000)     VALUE SPACES.    01350001
013900 01  PV-EMPTY-TAG-LENGTH         PIC 9(06)       VALUE ZERO.      01360001
014000                                                                  01370001
014100 01  PV-DESC                     PIC X(132)      VALUE SPACES.    01380001
014200 01  PV-DISPLAY                  PIC X(132)      VALUE SPACES.    01390001
014300                                                                  01400001
014400 01  XML-LENGTH                  PIC 9(7)    COMP.                01410001
014500                                                                  01420001
014600 01  ABEND-CODE                  PIC S9(04)  VALUE +0             01430001
014700                                             COMP SYNC.           01440001
014800                                                                  01450001
014900     COPY ISWS002.                                                01460001
015000     COPY ISWS007.                                                01470001
015100     COPY ISWS008.                                                01480001
015200     COPY ISWS009.                                                01490001
015300                                                                  01500001
015400******************************************************************01510001
015500*  DB2 FORMATTED MESSAGE AREA                                     01520001
015600******************************************************************01530001
015700     COPY DPWS004.                                                01540001
015800                                                                  01550001
015900******************************************************************01560001
016000*  COMMUNICATIONS AREA FOR DB2                                    01570001
016100******************************************************************01580001
016200     EXEC SQL                                                     01590001
016300          INCLUDE SQLCA                                           01600001
016400     END-EXEC.                                                    01610001
016500                                                                  01620001
016600******************************************************************01630001
016700*  DB2 DECLARATION - WMOS - PROVIDER QUEUE INFORMATION (PUT/WRITE)01640001
016800*      TABLE (WSV_PRVDR_QUE)                                      01650001
016900******************************************************************01660001
017000     EXEC SQL                                                     01670001
017100         INCLUDE WSV00005                                         01680001
017200     END-EXEC.                                                    01690001
017300                                                                  01700001
017400****************************************************************  01710001
017500**                                                            **  01720001
017600**     M Q   S E R I E S    W O R K I N G   S T O R A G E     **  01730001
017700**                                                            **  01740001
017800**                  M  Q    C O P Y B O O K S                 **  01750001
017900**                                                            **  01760001
018000****************************************************************  01770001
018100 01  MQM-OBJECT-DESCRIPTOR.                                       01780001
018200     COPY CMQODV.                                                 01790001
018300                                                                  01800001
018400 01  MQM-MESSAGE-DESCRIPTOR.                                      01810001
018500     COPY CMQMDV.                                                 01820001
018600                                                                  01830001
018700 01  MQM-PUT-MESSAGE-OPTIONS.                                     01840001
018800     COPY CMQPMOV.                                                01850001
018900                                                                  01860001
019000 01  MQM-GET-MESSAGE-OPTIONS.                                     01870001
019100     COPY CMQGMOV.                                                01880001
019200                                                                  01890001
019300 01  MQM-CONSTANTS.                                               01900001
019400     COPY CMQV.                                                   01910001
019500                                                                  01920001
019600****************************************************************  01930001
019700**** PROGRAM VARIABLES FOR QUEUE MANAGER AND QUEUE NAMES.         01940001
019800****************************************************************  01950001
019900 01  PV-Q-MANAGER-VARIABLES.                                      01960001
020000     05  PV-QMGR-NAME-PIX             PIC X(48).                  01970001
020010*  CLT 2011-01-18 start                                           01980001
020100     05  PV-QUE-NAME-PIX-1            PIC X(48).                  01990001
020110     05  PV-QUE-NAME-PIX-2            PIC X(48).                  02000001
020120*  CLT 2011-01-18 end                                             02010001
020200     05  PV-QUEUE                     PIC X(48).                  02020001
020210* CLT 2011-01-18 WR38972 start                                    02021001
020300     05  PV-HANDLE-PIX-1         PIC S9(9) BINARY VALUE 0.        02022001
020310     05  PV-HANDLE-PIX-2         PIC S9(9) BINARY VALUE 0.        02023001
020320* CLT 2011-01-18 WR38972 END                                      02024001
020400     05  PV-HCONN                PIC S9(9) BINARY VALUE 0.        02025001
020500                                                                  02026001
020600****************************************************************  02027001
020700** MQ SERIES CONSTANTS FOR CALLING MODULES SUCH AS GET AND    **  02028001
020800*  OPEN, CONNECT, DISCONNECT.                                     02029001
020900****************************************************************  02030001
021000 01  MQ-WORKING-STORAGE.                                          02040001
021100     05  PC-PGM-NAME                 PIC X(08) VALUE 'WSKUT033'.  02050001
021200     05  PC-MQCONN                   PIC X(08) VALUE 'CSQBCONN'.  02060001
021300     05  PC-MQOPEN                   PIC X(08) VALUE 'CSQBOPEN'.  02070001
021400     05  PC-MQINQ                    PIC X(08) VALUE 'CSQBINQ'.   02080001
021500     05  PC-MQPUT                    PIC X(08) VALUE 'CSQBPUT'.   02090001
021600     05  PC-MQGET                    PIC X(08) VALUE 'CSQBGET'.   02100001
021700     05  PC-MQCMIT                   PIC X(08) VALUE 'CSQBCOMM'.  02110001
021800     05  PC-MQBACK                   PIC X(08) VALUE 'CSQBBACK'.  02120001
021900     05  PC-MQCLOSE                  PIC X(08) VALUE 'CSQBCLOS'.  02130001
022000     05  PC-MQDISC                   PIC X(08) VALUE 'CSQBDISC'.  02140001
022100     05  PC-QMGR-NAME                PIC X(04) VALUE SPACES.      02150001
022200         88  PC-PROD-QMGR-NAME                 VALUE 'QKSP'.      02160001
022300         88  PC-ACCEPT-QMGR-NAME               VALUE 'QKSQ'.      02170001
022400         88  PC-TEST-QMGR-NAME                 VALUE 'QKST'.      02180001
022500     05  PC-TRANS-QNAME              PIC X(48) VALUE SPACES.      02190001
022600     05  PC-DELAY-INTERVAL.                                       02200001
022700         10  FILLER                  PIC X(2)  VALUE SPACES.      02210001
022800         10  PC-DELAY-TIME           PIC 9(8)  VALUE 3000.        02220001
022900                                                                  02230001
023000****************************************************************  02240001
023100* ERROR PROCESSING VARIABLES                                      02250001
023200* CODES FROM CALLS ARE STORED HERE                                02260001
023300****************************************************************  02270001
023400 01 PV-MQ-PROGRAM-VARIABLES.                                      02280001
023500     05  PV-COMPLETION-CODE          PIC S9(9) BINARY.            02290001
023600     05  PV-REASON                   PIC S9(9) BINARY.            02300001
023700     05  PV-CON-REASON               PIC S9(9) BINARY.            02310001
023800     05  PV-MQCHECK                  PIC X(08) VALUE 'MQR2C'.     02320001
023900     05  PV-ERROR-MESSAGE            PIC X(48) VALUE SPACES.      02330001
024000     05  PV-OPEN-OPTIONS             PIC S9(9) BINARY.            02340001
024100     05  PV-MQ-REASON-TEXT           PIC X(30) VALUE SPACES.      02350001
024200     05  PV-MSGBUFFER.                                            02360001
024300         10  PV-MSGBUFFER-BANNER     PIC X(39) VALUE SPACES.      02370001
024400         10  PV-MSGBUFFER-DATA       PIC X(999999) VALUE SPACES.  02380001
024500                                                                  02390001
024600****************************************************************  02400001
024700* RETURN CODES ARE EVALUATED AND THIS SWITCH IS USED TO           02410001
024800* INDICATE ANY ERRORS (FROM WHAT I'VE SEEN THIS SWITCH IS         02420001
024900* USELESS SINCE THE PROGRAM ABENDS BEFORE IT IS USED ANYWHERE) *  02430001
025000****************************************************************  02440001
025100 01 PV-MQ-PROGRAM-SWITCHES.                                       02450001
025200     05  PS-MQ-ERROR-SW              PIC X(01) VALUE 'N'.         02460001
025300         88  PS-NO-MQ-ERROR                    VALUE 'N'.         02470001
025400         88  PS-MQ-ERROR                       VALUE 'Y'.         02480001
025410* CLT 2011-01-18 WR38972 start                                **  02490001
      *     There are two cubiscan queues and we want                   02500001
      *     to use WS.OUTBOUND.WMOS.CUBISCN.                            02510001
      *     That is why ORDER BY QUE_NM  DESC   and                     02520001
      *     only one fetch                                              02530001
025420**************************************************                02540001
025430*  DB2  MQCUR CURSOR                                              02541001
025440**************************************************                02542001
025450                                                                  02543001
025460     EXEC SQL                                                     02544001
025470          DECLARE MQCUR  CURSOR FOR                               02545001
025480          SELECT LCL_QUE_MGR                                      02546001
025490                ,QUE_NM                                           02547001
025491            FROM WSV_PRVDR_QUE                                    02548001
025492           WHERE INTGRTN_TYP_CDE = :PV-QUEUE                      02549002
025494          ORDER BY QUE_NM  DESC                                   02549101
025495          WITH UR                                                 02549201
025496     END-EXEC.                                                    02549301
025497                                                                  02549401
025498* CLT 2011-01-18 WR38972 end                                      02549501
025500****************************************************************  02549601
025600**                     E N D   O F   M Q                      **  02549701
025700****************************************************************  02549801
025800                                                                  02549901
025900 PROCEDURE DIVISION.                                              02550001
026000                                                                  02560001
026100 0000-PROGRAM-MAINLINE.                                           02570001
026200     DISPLAY '**** START OF WSKUT033 ****'.                       02580001
026300                                                                  02590001
026400     PERFORM 1000-INITIALIZATION.                                 02600001
026500     PERFORM 1200-MQ-CONNECT.                                     02610001
026510* CLT 2011-01-18 WR38972 start                                    02620001
026600     PERFORM 1300-MQ-OPEN-PIX-QUE-1.                              02630001
026510* CLT 2011-01-18 WR38972 end                                      02640001
026700                                                                  02650001
026800     IF PS-END-OF-INPUT-YES                                       02660001
026900        DISPLAY '                                 '               02670001
027000        DISPLAY '*********************************'               02680001
027100        DISPLAY 'NO DATA FOUND IN INPUT FILE INP01'               02690001
027200        DISPLAY '*********************************'               02700001
027300     ELSE                                                         02710001
027400        PERFORM 2000-PROCESS-TRANSACTION                          02720001
027500          UNTIL PS-END-OF-INPUT-YES                               02730001
027600     END-IF.                                                      02740001
027700                                                                  02750001
027800     PERFORM 8000-MQ-CLEANUP.                                     02760001
027900     PERFORM 9900-EOJ-ROUTINE.                                    02770001
028000                                                                  02780001
028100     GOBACK.                                                      02790001
028200                                                                  02800001
028300******************************************************************02810001
028400* INITIALIZATION                                                 *02820001
028500*     OPENS FILES                                                *02830001
028600*     INITIALIZES VARIABLES                                      *02840001
028700*     PROCESSES PARMS                                            *02850001
028800******************************************************************02860001
028900 1000-INITIALIZATION.                                             02870001
029000     DISPLAY 'WSKUT033 - 1000-INITIALIZATION.          '.         02880001
029100                                                                  02890001
029200     OPEN INPUT  PIX-FILE-IN.                                     02900001
029300                                                                  02910001
029400     SET PS-END-OF-INPUT-NO    TO TRUE.                           02920001
029500     SET PV-INDX               TO 1.                              02930001
029600                                                                  02940001
029700     INITIALIZE WS045-PIX-REP-REC                                 02950001
029800                PA-TOTAL-RECORDS-IN                               02960001
029900                PA-TOTAL-MQ-MSGS-SENT                             02970001
030000                PA-TOTAL-ERRORS-PROCESSED                         02980001
030100                PA-QUEUE-MSG-TABLE                                02990001
030200                DCLWSV00005.                                      03000001
030300                                                                  03010001
030400     PERFORM 2100-READ-PIX-FILE-IN.                               03020001
030500     MOVE WS045-QUEUE TO PV-QUEUE.                                03030001
030600     MOVE WS045-QUEUE TO PA-QUEUE-NAME(1).                        03040001
030700     PERFORM 1100-GET-MQ-INFO-PIX.                                03050001
030800                                                                  03060001
030900******************************************************************03070001
031000* GETS MQ INFO FROM WSV_PRVDR_QUE (PUT/WRITE) - PIX TRANSACTIONS. 03080001
031100******************************************************************03090001
031200 1100-GET-MQ-INFO-PIX.                                            03100001
031210* CLT 2011-01-18 WR38972 start                                    03110001
031220                                                                  03120001
031230     PERFORM 1110-OPEN-MQCUR.                                     03121001
031240     PERFORM 1120-FETCH-MQCUR UNTIL                               03122001
031241         PS-END-OF-MQCUR-YES.                                     03123001
031250     PERFORM 1130-CLOSE-MQCUR.                                    03124001
031260                                                                  03125001
031270 1110-OPEN-MQCUR.                                                 03126001
031280     EXEC SQL                                                     03127001
031290         OPEN MQCUR                                               03128001
031292     END-EXEC.                                                    03129001
031293                                                                  03129101
031294     EVALUATE TRUE                                                03129201
031295         WHEN SQLCODE = ZERO                                      03129301
031296            CONTINUE                                              03129401
031297         WHEN OTHER                                               03129501
031298            MOVE '1110-OPEN-MQCUR' TO PV-PARAGRAPH                03129601
031299            DISPLAY SQLCODE                                       03129701
031300            PERFORM 9200-MQ-ABEND                                 03129801
031301     END-EVALUATE.                                                03129901
031302                                                                  03130001
031303 1120-FETCH-MQCUR.                                                03130101
031304     INITIALIZE WSV00005-LCL-QUE-MGR-TEXT.                        03130201
031305     INITIALIZE WSV00005-QUE-NM-TEXT.                             03130301
031306                                                                  03130401
031307     EXEC SQL                                                     03130501
031308         FETCH MQCUR                                              03130601
031309          INTO :WSV00005-LCL-QUE-MGR                              03130701
031310              ,:WSV00005-QUE-NM                                   03130801
031311     END-EXEC.                                                    03130901
031312                                                                  03131001
031313* CLT 2011-01-18 WR38972 end                                      03131101
031314                                                                  03131201
032700       DISPLAY ' PIX QMGR:' WSV00005-LCL-QUE-MGR                  03131301
032800       DISPLAY ' PIX QUE :' WSV00005-QUE-NM                       03131401
032900       DISPLAY ' SQL CDE :' SQLCODE                               03131501
033000                                                                  03131601
033100       EVALUATE TRUE                                              03131701
033200           WHEN SQLCODE = 0                                       03131801
033300             INITIALIZE PV-QMGR-NAME-PIX                          03131901
033400             MOVE WSV00005-LCL-QUE-MGR-TEXT TO                    03132001
033500                PV-QMGR-NAME-PIX                                  03133001
033600             DISPLAY PC-PGM-NAME                                  03134001
033700                'MQ INFO: '                                       03135001
033800                PV-QMGR-NAME-PIX                                  03136001
033810* CLT 2011-01-18 WR38972 start                                    03137001
033820             IF PV-1ST-FETCH-YES                                  03138001
033900                 INITIALIZE PV-QUE-NAME-PIX-1                     03139001
034000                 MOVE WSV00005-QUE-NM-TEXT TO                     03140001
034100                    PV-QUE-NAME-PIX-1                             03150001
034200                 DISPLAY PC-PGM-NAME                              03160001
034300                    'MQ INFO: '                                   03170001
034400                    PV-QUE-NAME-PIX-1                             03180001
034401                 MOVE 'N' TO PV-1ST-FETCH                         03190001
034402             ELSE                                                 03200001
034403                 INITIALIZE PV-QUE-NAME-PIX-2                     03210001
034404                 MOVE WSV00005-QUE-NM-TEXT TO                     03220001
034405                    PV-QUE-NAME-PIX-2                             03230001
034406                 DISPLAY PC-PGM-NAME                              03240001
034407                    'MQ INFO: '                                   03250001
034408                    PV-QUE-NAME-PIX-2                             03260001
034409                 MOVE 2 TO PV-NO-OF-QUES                          03270001
034410             END-IF                                               03280001
034500                                                                  03290001
034600           WHEN SQLCODE = +100                                    03300001
034601               SET PS-END-OF-MQCUR-YES TO TRUE                    03310001
034602                                                                  03320001
034603* CLT 2011-01-18 WR38972 end                                      03330001
034604                                                                  03340001
034610           WHEN OTHER                                             03350001
034700             DISPLAY PC-PGM-NAME                                  03360001
034800                ' - Q OR QMGR ERROR IN: ' PV-QUEUE                03370001
034900             MOVE 'Q OR QMGR ERROR IN GETTING QUEUE INFO' TO      03380001
035000                PV-ERROR-MESSAGE                                  03390001
035100             PERFORM 9001-MQSERIES-ERROR                          03400001
035200       END-EVALUATE.                                              03410001
035300                                                                  03420001
035301* CLT 2011-01-18 WR38972 START                                    03430001
035423                                                                  03440001
035425 1130-CLOSE-MQCUR.                                                03450001
035426                                                                  03460001
035427     EXEC SQL                                                     03470001
035428         CLOSE MQCUR                                              03480001
035429     END-EXEC.                                                    03490001
035430                                                                  03500001
035431     EVALUATE TRUE                                                03510001
035432         WHEN SQLCODE = ZERO                                      03520001
035433            CONTINUE                                              03530001
035434         WHEN OTHER                                               03540001
035435            MOVE '1130-CLOSE-MQCUR' TO PV-PARAGRAPH               03541001
035436            DISPLAY SQLCODE ' SQLCODE'                            03542001
035437            PERFORM 9200-MQ-ABEND                                 03543001
035438     END-EVALUATE.                                                03543101
035439                                                                  03543201
035441* CLT 2011-01-18 WR38972 end                                      03543301
035450******************************************************************03543401
035500* CONNECT TO PIX QUEUE MANAGER.                                   03543501
035600******************************************************************03543601
035700 1200-MQ-CONNECT.                                                 03543701
035800     DISPLAY 'WSKUT033 - 1200-MQ-CONNECT.        '.               03543801
035900                                                                  03543901
036000     CALL PC-MQCONN USING PV-QMGR-NAME-PIX                        03544001
036100                          PV-HCONN                                03545001
036200                          PV-COMPLETION-CODE                      03546001
036300                          PV-REASON.                              03547001
036400                                                                  03548001
036500*    IF CONNECTION FAILED THEN DISPLAY ERROR MESSAGE              03549001
036600*    AND EXIT                                                     03550001
036700                                                                  03560001
036800     MOVE PV-REASON TO PV-CON-REASON.                             03570001
036900     IF PV-COMPLETION-CODE = MQCC-OK THEN                         03580001
037000         CONTINUE                                                 03590001
037100     ELSE                                                         03600001
037200         STRING 'CONNECT - ' PV-QMGR-NAME-PIX                     03610001
037300           DELIMITED BY SIZE INTO PV-ACTION                       03620001
037400           ADD +1 TO PA-TOTAL-ERRORS-PROCESSED                    03630001
037500           PERFORM 9001-MQSERIES-ERROR                            03640001
037600     END-IF.                                                      03650001
037700                                                                  03660001
037800***************************************************************** 03670001
037900*** OPEN THE ITEM QUEUE FOR PUTS DEPENDING ON THE QUEUE NAME      03680001
038000*** FROM THE INPUT FILE.                                          03690001
038100***************************************************************** 03700001
038200 1300-MQ-OPEN-PIX-QUE-1.                                          03710001
038300     DISPLAY 'WSKUT033 - 1300-MQ-OPEN-PIX-QUE-1.           '.     03720001
038400                                                                  03730001
038500     COMPUTE PV-OPEN-OPTIONS        = MQOO-OUTPUT                 03740001
038600                                    + MQOO-SET-IDENTITY-CONTEXT   03750001
038700                                    + MQOO-FAIL-IF-QUIESCING.     03760001
038800     MOVE MQOT-Q                   TO MQOD-OBJECTTYPE.            03770001
038900     MOVE PV-QMGR-NAME-PIX         TO MQOD-OBJECTQMGRNAME.        03780001
038910* CLT 2011-01-18 WR38972 start                                **  03790001
039000     MOVE PV-QUE-NAME-PIX-1        TO MQOD-OBJECTNAME.            03800001
039010* CLT 2011-01-18 WR38972 end                                  **  03810001
039100                                                                  03820001
039200     DISPLAY "  MQOD-OBJECTQMGRNAME = " MQOD-OBJECTQMGRNAME.      03830001
039300     DISPLAY "  MQOD-OBJECTNAME = " MQOD-OBJECTNAME.              03840001
039400                                                                  03850001
039500     CALL PC-MQOPEN USING PV-HCONN                                03860001
039600                          MQM-OBJECT-DESCRIPTOR                   03870001
039700                          PV-OPEN-OPTIONS                         03880001
039800                          PV-HANDLE-PIX-1                         03890001
039900                          PV-COMPLETION-CODE                      03900001
040000                          PV-REASON.                              03910001
040100                                                                  03920001
040200*    IF OPEN FAILED THEN DISPLAY ERROR MESSAGE AND EXIT.          03930001
040300                                                                  03940001
040310* CLT 2011-01-18 WR38972 START                                **  03950001
040400     IF PV-COMPLETION-CODE = MQCC-OK                              03960001
040410        IF PV-NO-OF-QUES = 2                                      03970001
040500            PERFORM 1310-MQ-OPEN-PIX-QUE-2                        03980001
040501        END-IF                                                    03990001
040502        CONTINUE                                                  04000001
040510* CLT 2011-01-18 WR38972 END                                  **  04010001
040600     ELSE                                                         04020001
040700         STRING 'OPEN - ' PV-QUE-NAME-PIX-1                       04030001
040800           DELIMITED BY SIZE INTO PV-ACTION                       04040001
040900         ADD +1 TO PA-TOTAL-ERRORS-PROCESSED                      04050001
041000         PERFORM 9001-MQSERIES-ERROR                              04060001
041100     END-IF.                                                      04070001
041200                                                                  04080001
041201* CLT 2011-01-18 WR38972 START                                **  04090001
041210 1310-MQ-OPEN-PIX-QUE-2.                                          04100001
041220     DISPLAY 'WSKUT033 - 1310-MQ-OPEN-PIX-QUE-2.'           .     04110001
041230                                                                  04120001
041240     COMPUTE PV-OPEN-OPTIONS        = MQOO-OUTPUT                 04121001
041250                                    + MQOO-SET-IDENTITY-CONTEXT   04122001
041260                                    + MQOO-FAIL-IF-QUIESCING.     04123001
041270     MOVE MQOT-Q                   TO MQOD-OBJECTTYPE.            04124001
041280     MOVE PV-QMGR-NAME-PIX         TO MQOD-OBJECTQMGRNAME.        04125001
041291     MOVE PV-QUE-NAME-PIX-2        TO MQOD-OBJECTNAME.            04126001
041293                                                                  04127001
041294     DISPLAY "  MQOD-OBJECTQMGRNAME = " MQOD-OBJECTQMGRNAME.      04128001
041295     DISPLAY "  MQOD-OBJECTNAME = " MQOD-OBJECTNAME.              04129001
041296                                                                  04129101
041297     CALL PC-MQOPEN USING PV-HCONN                                04129201
041298                          MQM-OBJECT-DESCRIPTOR                   04129301
041299                          PV-OPEN-OPTIONS                         04129401
041300                          PV-HANDLE-PIX-2                         04129501
041301                          PV-COMPLETION-CODE                      04129601
041302                          PV-REASON.                              04129701
041303                                                                  04129801
041304*    IF OPEN FAILED THEN DISPLAY ERROR MESSAGE AND EXIT.          04129901
041305                                                                  04130001
041306     IF PV-COMPLETION-CODE = MQCC-OK THEN                         04130101
041308         CONTINUE                                                 04130201
041310     ELSE                                                         04130301
041311         STRING 'OPEN - ' PV-QUE-NAME-PIX-2                       04130401
041312           DELIMITED BY SIZE INTO PV-ACTION                       04130501
041313         ADD +1 TO PA-TOTAL-ERRORS-PROCESSED                      04130601
041314         PERFORM 9001-MQSERIES-ERROR                              04130701
041315     END-IF.                                                      04130801
041316                                                                  04130901
041317* CLT 2011-01-18 WR38972 END                                  **  04131001
041320******************************************************************04131101
041400 2000-PROCESS-TRANSACTION.                                        04131201
041500     DISPLAY 'WSKUT033 - 2000-PROCESS-TRANSACTION      '.         04131301
041600                                                                  04131401
041700     PERFORM 3000-FILL-PIX-MESG-INFO.                             04131501
041800     PERFORM 4000-GENERATE-XML-PIX.                               04131601
041900     PERFORM 5200-CREATE-MSGS.                                    04131701
042000                                                                  04131801
042100     PERFORM 2100-READ-PIX-FILE-IN.                               04131901
042200                                                                  04132001
042300***************************************************************** 04133001
042400* READ INPUT FILE                                                 04134001
042500***************************************************************** 04135001
042600 2100-READ-PIX-FILE-IN.                                           04136001
042700     DISPLAY 'WSKUT033 - 2100-READ-PIX-FILE-IN         '.         04137001
042800                                                                  04138001
042900     READ PIX-FILE-IN                                             04139001
043000        INTO WS045-PIX-REP-REC                                    04140001
043100        AT END                                                    04150001
043200            SET PS-END-OF-INPUT-YES TO TRUE                       04160001
043300            SUBTRACT +1 FROM PA-TOTAL-RECORDS-IN                  04170001
043400     END-READ.                                                    04180001
043500     ADD +1 TO PA-TOTAL-RECORDS-IN.                               04190001
043600     DISPLAY 'PIX REC IN:' WS045-PIX-REP-REC.                     04200001
043700                                                                  04210001
043800******************************************************************04220001
043900*  COMMIT MQ PROCESSING SINCE THE POINT OF THE LAST COMMIT        04230001
044000******************************************************************04240001
044100 2300-MQ-COMMIT.                                                  04250001
044200                                                                  04260001
044300     CALL PC-MQCMIT USING PV-HCONN                                04270001
044400                          PV-COMPLETION-CODE                      04280001
044500                          PV-REASON.                              04290001
044600                                                                  04300001
044700     IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        04310001
044800        CALL PV-MQCHECK USING PV-REASON                           04320001
044900                              PV-MQ-REASON-TEXT                   04330001
045000        MOVE '2300-COMMIT-MQ'   TO PV-PARAGRAPH                   04340001
045100        MOVE 'MQCMIT ERROR'     TO PV-ERROR-MESSAGE               04350001
045200        MOVE PV-COMPLETION-CODE TO PV-HOLD-COMPLETION-CODE        04360001
045300                                   PE-MQ-COMPLETION-CODE          04370001
045400        MOVE PV-REASON          TO PV-HOLD-REASON                 04380001
045500                                   PE-MQ-REASON-CODE              04390001
045600        PERFORM 5100-BACK-OUT-MQ                                  04400001
045700        MOVE PV-HOLD-COMPLETION-CODE TO PV-COMPLETION-CODE        04410001
045800        MOVE PV-HOLD-REASON          TO PV-REASON                 04420001
045900        PERFORM 9200-MQ-ABEND                                     04430001
046000     END-IF.                                                      04440001
046100                                                                  04450001
046200                                                                  04460001
046300                                                                  04470001
046400******************************************************************04480001
046500*  FILL PIX FIELDS FROM THE INPUT FILE.                           04490001
046600*  IF THE NEW RECORD HAS A DIFFERENT QUEUE, CLOSE THE PREVIOUS    04500001
046700*  QUEUE BEFORE POPULATING THE VARIABLE QUEUE FIELDS.             04510001
046800******************************************************************04520001
046900 3000-FILL-PIX-MESG-INFO.                                         04530001
047000     DISPLAY 'WSKUT033 - 3000-FILL-PIX-MESG-INFO       '.         04540001
047100                                                                  04550001
047200     IF WS045-QUEUE                 =  PV-QUEUE                   04560001
047300        ADD +1             TO  PA-QUEUE-MESG-COUNT(PV-INDX)       04570001
047400     ELSE                                                         04580001
047410* clt 2011-01-18 start                                            04590001
047500        PERFORM 8200-MQ-CLOSE-PIX-QUE-1                           04600001
047501        IF PV-NO-OF-QUES = 2                                      04610001
047502            PERFORM 8210-MQ-CLOSE-PIX-QUE-2                       04620001
047503        END-IF                                                    04630001
047510* clt 2011-01-18 start                                            04640001
047600        MOVE WS045-QUEUE         TO  PV-QUEUE                     04650001
047700        SET PV-INDX UP BY 1                                       04660001
047800        MOVE WS045-QUEUE         TO  PA-QUEUE-NAME(PV-INDX)       04670001
047900        MOVE +1             TO PA-QUEUE-MESG-COUNT(PV-INDX)       04680001
048000        PERFORM 1100-GET-MQ-INFO-PIX                              04690001
048100        PERFORM 1300-MQ-OPEN-PIX-QUE-1                            04700001
048200     END-IF.                                                      04710001
048300                                                                  04720001
048400     MOVE WS045-TransactionType       TO  TransactionType.        04730001
048500     MOVE WS045-TransactionCode       TO  TransactionCode.        04740001
048600     MOVE WS045-TransactionNumber     TO  TransactionNumber.      04750001
048700     MOVE WS045-SequenceNumber        TO  SequenceNUmber.         04760001
048800     MOVE WS045-Company               TO  Company.                04770001
048900     MOVE WS045-Divisio1              TO  Divisio1.               04780001
049000     MOVE WS045-StyleSuffix           TO  StyleSuffix.            04790001
049100     MOVE WS045-SkuID                 TO  SkuID.                  04800001
049200     MOVE WS045-InventoryType         TO  InventoryType.          04810001
049300     MOVE WS045-ProductStatus         TO  ProductStatus.          04820001
049400     MOVE WS045-BatchNumber           TO  BatchNumber.            04830001
049500     MOVE WS045-SKUAttribute1         TO  SKUAttribute1.          04840001
049600     MOVE WS045-SKUAttribute2         TO  SKUAttribute2.          04850001
049700     MOVE WS045-SKUAttribute3         TO  SKUAttribute3.          04860001
049800     MOVE WS045-SKUAttribute4         TO  SKUAttribute4.          04870001
049900     MOVE WS045-SKUAttribute5         TO  SKUAttribute5.          04880001
050000     MOVE WS045-CountryOfOrgin        TO  CountryOfOrgin.         04890001
050100     MOVE WS045-DateCreated           TO  DateCreated.            04900001
050200     MOVE WS045-CaseNumber            TO  CaseNumber.             04910001
050300     MOVE WS045-InvAdjustmentQty      TO  InvAdjustmentQty.       04920001
050400     MOVE WS045-UnitOfMeasure         TO  UnitOfMeasure.          04930001
050500     MOVE WS045-InvAdjustmentType     TO  InvAdjustmentType.      04940001
050600     MOVE WS045-ReceivedFrom          TO  ReceivedFrom.           04950001
050700     MOVE WS045-Warehouse             TO  Warehouse.              04960001
050800     MOVE WS045-DCNumber              TO  DCNumber.               04970001
050900     MOVE WS045-As400UserID           TO  As400UserID.            04980001
051000     MOVE WS045-ReferenceWhse         TO  ReferenceWhse.          04990001
051100     MOVE WS045-TransReasonCode       TO  TransReasonCode.        05000001
051200     MOVE WS045-ReceiptsVariance      TO  ReceiptsVariance.       05010001
051300     MOVE WS045-Weight                TO  Weight.                 05020001
051400     MOVE WS045-ReceiptsCompleted     TO  ReceiptsCompleted.      05030001
051500     MOVE WS045-CasesShipped          TO  CasesShipped.           05040001
051600     MOVE WS045-UnitsShipped          TO  UnitsShipped.           05050001
051700     MOVE WS045-CasesReceived         TO  CasesReceived.          05060001
051800     MOVE WS045-UnitsReceived         TO  UnitsReceived.          05070001
051900     MOVE WS045-ReferenceCode1        TO  ReferenceCode1.         05080001
052000     MOVE WS045-Reference1            TO  Reference1.             05090001
052100     MOVE WS045-ReferenceCode2        TO  ReferenceCode2.         05100001
052200     MOVE WS045-Reference2            TO  Reference2.             05110001
052300     MOVE WS045-ReferenceCode3        TO  ReferenceCode3.         05120001
052400     MOVE WS045-Reference3            TO  Reference3.             05130001
052500     MOVE WS045-ReferenceCode4        TO  ReferenceCode4.         05140001
052600     MOVE WS045-Reference4            TO  Reference4.             05150001
052700     MOVE WS045-ReferenceCode5        TO  ReferenceCode5.         05160001
052800     MOVE WS045-Reference5            TO  Reference5.             05170001
052900     MOVE WS045-ReferenceCode6        TO  ReferenceCode6.         05180001
053000     MOVE WS045-ReferenceField6       TO  Reference6.             05190001
053100     MOVE WS045-ReferenceCode7        TO  ReferenceCode7.         05200001
053200     MOVE WS045-ReferenceField7       TO  Reference7.             05210001
053300     MOVE WS045-ReferenceCode8        TO  ReferenceCode8.         05220001
053400     MOVE WS045-ReferenceField8       TO  Reference8.             05230001
053500     MOVE WS045-ReferenceField9       TO  Reference9.             05240001
053600     MOVE WS045-ReferenceCode9        TO  Referencecode9.         05250001
053700     MOVE WS045-ReferenceField10      TO  Reference10.            05260001
053800     MOVE WS045-ReferenceCode10       TO  ReferenceCode10.        05270001
053900     MOVE WS045-ActionCode            TO  ActionCode.             05280001
054000     MOVE WS045-CustomReference       TO  CustomReference.        05290001
054100     MOVE WS045-ErrorComment          TO  ErrorComment.           05300001
054200     MOVE WS045-WeightAdjustmentQuantity  TO                      05310001
054300                                      WeightAdjustmentQuantity.   05320001
054400     MOVE WS045-WeightAdjustmentType  TO  WeightAdjustmentType.   05330001
054500*    MOVE WS045-INSERT-TMST           TO  InsertTmst.             05340001
054600                                                                  05350001
054700******************************************************************05360001
054800*  GENERATE XML WITH THE POPULATED FIELDS FROM WS045.             05370001
054900******************************************************************05380001
055000 4000-GENERATE-XML-PIX.                                           05390001
055100     DISPLAY 'WSKUT033 - 4000-GENERATE-XML-PIX       '.           05400001
055200                                                                  05410001
055300     MOVE SPACES TO PV-XML.                                       05420001
055400                                                                  05430001
055500     XML GENERATE PV-XML                                          05440001
055600         FROM PIXBridge                                           05450001
055700         COUNT IN XML-LENGTH                                      05460001
055800         ON EXCEPTION                                             05470001
055900             PERFORM 5000-XML-ERROR                               05480001
056000         NOT ON EXCEPTION                                         05490001
056100             PERFORM 5020-REPLACE-TAG-NAME                        05500001
056200             PERFORM 5050-XML-SUCCESS                             05510001
056300     END-XML.                                                     05520001
056400                                                                  05530001
056500******************************************************************05540001
056600*  XML ERROR.                                                     05550001
056700******************************************************************05560001
056800 5000-XML-ERROR.                                                  05570001
056900     DISPLAY 'WSKUT033 - 5000-XML-ERROR     '.                    05580001
057000                                                                  05590001
057100     PERFORM 9000-EXPLAIN-XML-RESPONSE                            05600001
057200     PERFORM  VARYING XML-LINE-IDX FROM 1 BY 1                    05610001
057300                UNTIL XML-LINE-IDX > XML-RESPONSE-LINES           05620001
057400         DISPLAY XML-MSG(XML-LINE-IDX)                            05630001
057500     END-PERFORM.                                                 05640001
057600     MOVE +4018         TO ABEND-CODE.                            05650001
057700     CALL 'ILBOABN0' USING ABEND-CODE.                            05660001
057800                                                                  05670001
057900******************************************************************05680001
058000*  REPLACE Divisio1 BY Division.                                  05690001
058100******************************************************************05700001
058200 5020-REPLACE-TAG-NAME.                                           05710001
058300     DISPLAY 'WSKUT033 - 5020-REPLACE-TAG-NAME '.                 05720001
058400                                                                  05730001
058500     DISPLAY ' '.                                                 05740001
058600     DISPLAY 'XML before REPLACING command:'.                     05750001
058700     MOVE PV-XML(1:XML-LENGTH) TO XML-UNFORMATTED-MSG.            05760001
058800     PERFORM 9554-DISPLAY-FORMATTED-XML.                          05770001
058900                                                                  05780001
059000*  INSPECT ... REPLACING command to change the tag.               05790001
059100     INSPECT PV-XML REPLACING ALL 'Divisio1' BY 'Division'.       05800001
059200                                                                  05810001
059300******************************************************************05820001
059400*  XML SUCCESS.                                                   05830001
059500******************************************************************05840001
059600 5050-XML-SUCCESS.                                                05850001
059700     DISPLAY 'WSKUT033 - 5050-XML-SUCCESS   '.                    05860001
059800                                                                  05870001
059900* This code makes the CR-MI field optional.                       05880001
060000* The XML Generator will create a tag even if the field is blank. 05890001
060100                                                                  05900001
060200     DISPLAY 'XML document was successfully generated'.           05910001
060300     DISPLAY ' '.                                                 05920001
060400     DISPLAY 'The generated XML is ' XML-LENGTH                   05930001
060500             ' characters long.'.                                 05940001
060600     DISPLAY ' '.                                                 05950001
060700     DISPLAY PV-XML(1:XML-LENGTH).                                05960001
060800                                                                  05970001
060900     DISPLAY ' '.                                                 05980001
061000     DISPLAY 'FORMATTED:'.                                        05990001
061100     DISPLAY PV-XML-BANNER.                                       06000001
061200     MOVE PV-XML(1:XML-LENGTH) TO XML-UNFORMATTED-MSG             06010001
061300     PERFORM 9554-DISPLAY-FORMATTED-XML.                          06020001
061400                                                                  06030001
061500                                                                  06040001
061600     COPY ISPD002.                                                06050001
061700     COPY ISPD007.                                                06060001
061800     COPY ISPD008.                                                06070001
061900     COPY ISPD009.                                                06080001
062000                                                                  06090001
062100******************************************************************06100001
062200* SEND THE XML MESSAGE TO THE PROPER QUEUE. **********************06110001
062300******************************************************************06120001
062400 5200-CREATE-MSGS.                                                06130001
062500     DISPLAY 'WSKUT033 - 5200-CREATE-MSGS   '.                    06140001
062600                                                                  06150001
062700     MOVE 'PIXPROCESS'               TO PV-MQC-PROCESS-TYPE.      06160001
062800     MOVE PV-XML-BANNER              TO PV-MSGBUFFER-BANNER.      06170001
062900     MOVE PV-XML(1:XML-LENGTH)       TO PV-MSGBUFFER-DATA.        06180001
063000     COMPUTE PV-MSG-LENGTH = XML-LENGTH                           06190001
063100                           + LENGTH OF PV-XML-BANNER.             06200001
063200     MOVE PV-MSG-LENGTH TO PV-MSG-LENGTH-DISPLAY.                 06210001
063300     MOVE PV-MQC-CONTROL-RECORD      TO MQMD-APPLIDENTITYDATA.    06220001
063400                                                                  06230001
063500     INITIALIZE PS-MQPUT-SUCCESSFUL-IND                           06240001
063600                PC-MQPUT-RETRY-COUNTER.                           06250001
063700     PERFORM 5150-MQ-PUT-TO-QUEUE                                 06260001
063800       UNTIL PS-MQPUT-SUCCESSFUL.                                 06270001
063900                                                                  06280001
064000     INITIALIZE WS045-PIX-REP-REC                                 06290001
064100                DCLWSV00005.                                      06300001
064200                                                                  06310001
064300******************************************************************06320001
064400*                                                                *06330001
064500*             5 0 0 0 - P U T   M Q   M E S S A G E              *06340001
064600*                                                                *06350001
064700******************************************************************06360001
064800 5150-MQ-PUT-TO-QUEUE.                                            06370001
064900     DISPLAY 'WSKUT033 - 5150-MQ-PUT-TO-QUEUE'.                   06380001
065000                                                                  06390001
065100     MOVE MQMI-NONE    TO MQMD-MSGID.                             06400001
065200     MOVE MQCI-NONE    TO MQMD-CORRELID.                          06410001
065300     MOVE MQFMT-STRING TO MQMD-FORMAT.                            06420001
065400                                                                  06430001
065500     MOVE MQPER-PERSISTENT TO MQMD-PERSISTENCE.                   06440001
065600     COMPUTE MQPMO-OPTIONS  = MQPMO-SYNCPOINT                     06450001
065700                            + MQPMO-SET-IDENTITY-CONTEXT.         06460001
065800                                                                  06470001
065900     CALL PC-MQPUT USING PV-HCONN                                 06480001
065910* clt 2011-01-18 start                                            06490001
066000                         PV-HANDLE-PIX-1                          06500001
066010* clt 2011-01-18 END                                              06510001
066100                         MQM-MESSAGE-DESCRIPTOR                   06520001
066200                         MQM-PUT-MESSAGE-OPTIONS                  06530001
066300                         PV-MSG-LENGTH                            06540001
066400                         PV-MSGBUFFER                             06550001
066500                         PV-COMPLETION-CODE                       06560001
066600                         PV-REASON.                               06570001
066700                                                                  06580001
066701* clt 2011-01-18 start                                            06590001
066702     IF PV-NO-OF-QUES = 2                                         06600001
066710         CALL PC-MQPUT USING PV-HCONN                             06610001
066730                             PV-HANDLE-PIX-2                      06620001
066750                             MQM-MESSAGE-DESCRIPTOR               06630001
066760                             MQM-PUT-MESSAGE-OPTIONS              06640001
066770                             PV-MSG-LENGTH                        06650001
066780                             PV-MSGBUFFER                         06660001
066790                             PV-COMPLETION-CODE                   06670001
066791                             PV-REASON                            06671001
066792     END-IF.                                                      06672001
066793* clt 2011-01-18 END                                              06673001
066794                                                                  06674001
066800*IF PUT FAILED THEN DISPLAY ERROR MESSAGE                         06675001
066900     IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        06676001
067000         IF (PV-REASON NOT = MQRC-PAGESET-FULL                    06677001
067100           AND PV-REASON NOT = MQRC-Q-FULL                        06678001
067200           AND PV-REASON NOT = MQRC-Q-SPACE-NOT-AVAILABLE )       06679001
067300             CALL PV-MQCHECK USING PV-REASON                      06680001
067400                                   PV-MQ-REASON-TEXT              06690001
067500             DISPLAY 'MQ MESSAGE = ' PV-MSGBUFFER                 06700001
067600             MOVE '5150-MQ-PUT-TO-QUEUE'  TO PV-PARAGRAPH         06710001
067700             MOVE 'MQPUT FAILED'          TO PV-ERROR-MESSAGE     06720001
067800             MOVE PV-COMPLETION-CODE  TO PV-HOLD-COMPLETION-CODE  06730001
067900                                         PE-MQ-COMPLETION-CODE    06740001
068000             MOVE PV-REASON               TO PV-HOLD-REASON       06750001
068100                                             PE-MQ-REASON-CODE    06760001
068200             PERFORM 5100-BACK-OUT-MQ                             06770001
068300             MOVE PV-HOLD-COMPLETION-CODE TO PV-COMPLETION-CODE   06780001
068400             MOVE PV-HOLD-REASON          TO PV-REASON            06790001
068500             PERFORM 9200-MQ-ABEND                                06800001
068600         ELSE                                                     06810001
068700             ADD 1 TO PC-MQPUT-RETRY-COUNTER                      06820001
068800             IF PC-MQPUT-RETRY-COUNTER >= 60                      06830001
068900                 DISPLAY 'MQ MESSAGE = ' PV-MSGBUFFER             06840001
069000                 MOVE '5150-MQ-PUT-TO-QUEUE' TO PV-PARAGRAPH      06850001
069100                 MOVE 'MQPUT ERROR- RETRY > 60 '                  06860001
069200                      TO PV-ERROR-MESSAGE                         06870001
069300                 MOVE PV-COMPLETION-CODE                          06880001
069400                      TO PV-HOLD-COMPLETION-CODE                  06890001
069500                 MOVE PV-REASON TO PV-HOLD-REASON                 06900001
069600                 PERFORM 5100-BACK-OUT-MQ                         06910001
069700                 MOVE PV-HOLD-COMPLETION-CODE                     06920001
069800                      TO PV-COMPLETION-CODE                       06930001
069900                 MOVE PV-HOLD-REASON TO PV-REASON                 06940001
070000                 PERFORM 9200-MQ-ABEND                            06950001
070100             ELSE                                                 06960001
070200*WAIT FOR 30 SECONDS AND TRY AGAIN                                06970001
070300                 CALL 'SYSWAIT' USING PC-DELAY-INTERVAL           06980001
070400             END-IF                                               06990001
070500         END-IF                                                   07000001
070600     ELSE                                                         07010001
070700         ADD 1 TO PA-TOTAL-MQ-MSGS-SENT                           07020001
070800         SET PS-MQPUT-SUCCESSFUL TO TRUE                          07030001
070900     END-IF.                                                      07040001
071000                                                                  07050001
071100******************************************************************07060001
071200* BACK OUT MQ PROCESSING SINCE THE POINT OF THE LAST COMMIT       07070001
071300******************************************************************07080001
071400 5100-BACK-OUT-MQ.                                                07090001
071500     DISPLAY 'WSKUT033 - 5100-BACK-OUT-MQ    '.                   07100001
071600                                                                  07110001
071700     CALL PC-MQBACK USING PV-HCONN                                07120001
071800                          PV-COMPLETION-CODE                      07130001
071900                          PV-REASON.                              07140001
072000                                                                  07150001
072100     IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        07160001
072200        CALL PV-MQCHECK USING PV-REASON                           07170001
072300                              PV-MQ-REASON-TEXT                   07180001
072400        MOVE '5100-BACK-OUT-MQ'  TO PV-PARAGRAPH                  07190001
072500        MOVE 'MQBACK ERROR'    TO PV-ERROR-MESSAGE                07200001
072600        PERFORM 9200-MQ-ABEND                                     07210001
072700     END-IF.                                                      07220001
072800                                                                  07230001
072900***************************************************************** 07240001
073000* MQ SERIES WRAP-UP.                                              07250001
073100***************************************************************** 07260001
073200 8000-MQ-CLEANUP.                                                 07270001
073300     DISPLAY 'WSKUT033 - 8000-MQ-CLEANUP.              '.         07280001
073400                                                                  07290001
073410* CLT 2011-01-18 START                                            07300001
073500     PERFORM 8200-MQ-CLOSE-PIX-QUE-1.                             07310001
073501     IF PV-NO-OF-QUES = 2                                         07320001
073510         PERFORM 8210-MQ-CLOSE-PIX-QUE-2                          07330001
073511     END-IF.                                                      07340001
073520* CLT 2011-01-18 END                                              07350001
073600     PERFORM 8400-MQ-DISCONNECT.                                  07351001
073700                                                                  07352001
073800***************************************************************** 07353001
073900* MQ SERIES CLOSE QUEUE FOR THE PREVIOUS PIX TRANSACTIONS.        07354001
074000***************************************************************** 07355001
074100 8200-MQ-CLOSE-PIX-QUE-1.                                         07356001
074200     DISPLAY 'WSKUT033 - 8200-MQ-CLOSE-PIX-QUE-1.      '.         07357001
074300                                                                  07358001
074400     MOVE PV-QUEUE                  TO PV-QUE-NAME-PIX-1.         07359001
074500     MOVE PV-QUE-NAME-PIX-1         TO MQOD-OBJECTNAME.           07360001
074600     MOVE PV-QMGR-NAME-PIX          TO MQOD-OBJECTQMGRNAME.       07370001
074700                                                                  07380001
074800     CALL PC-MQCLOSE USING PV-HCONN                               07390001
074900                           PV-HANDLE-PIX-1                        07400001
075000                           MQCO-NONE                              07410001
075100                           PV-COMPLETION-CODE                     07420001
075200                           PV-REASON.                             07430001
075300                                                                  07440001
075400*    IF MQ CLOSE FAILED THEN DISPLAY ERROR MESSAGE                07450001
075500*    AND EXIT                                                     07460001
075600                                                                  07470001
075700     IF PV-COMPLETION-CODE = MQCC-OK THEN                         07480001
075800         CONTINUE                                                 07490001
075900     ELSE                                                         07500001
076000         STRING 'CLOSE - ' PV-QUE-NAME-PIX-1                      07510001
076100           DELIMITED BY SIZE INTO PV-ACTION                       07520001
076200         PERFORM 9001-MQSERIES-ERROR                              07530001
076300     END-IF.                                                      07540001
076400                                                                  07550001
076410* CLT 2011-01-18 START                                            07560001
076420 8210-MQ-CLOSE-PIX-QUE-2.                                         07570001
076430     DISPLAY 'WSKUT033 - 8210-MQ-CLOSE-PIX-QUE-2.      '.         07580001
076440                                                                  07590001
076450     MOVE PV-QUEUE                  TO PV-QUE-NAME-PIX-2.         07600001
076460     MOVE PV-QUE-NAME-PIX-2         TO MQOD-OBJECTNAME.           07610001
076470     MOVE PV-QMGR-NAME-PIX          TO MQOD-OBJECTQMGRNAME.       07620001
076480                                                                  07630001
076490     CALL PC-MQCLOSE USING PV-HCONN                               07640001
076491                           PV-HANDLE-PIX-2                        07641001
076492                           MQCO-NONE                              07642001
076493                           PV-COMPLETION-CODE                     07643001
076494                           PV-REASON.                             07644001
076495                                                                  07645001
076496*    IF MQ CLOSE FAILED THEN DISPLAY ERROR MESSAGE                07646001
076497*    AND EXIT                                                     07647001
076498                                                                  07648001
076499     IF PV-COMPLETION-CODE = MQCC-OK THEN                         07649001
076501         CONTINUE                                                 07650001
076502     ELSE                                                         07650101
076503         STRING 'CLOSE - ' PV-QUE-NAME-PIX-2                      07650201
076504           DELIMITED BY SIZE INTO PV-ACTION                       07650301
076505         PERFORM 9001-MQSERIES-ERROR                              07650401
076506     END-IF.                                                      07650501
076507                                                                  07650601
076508* CLT 2011-01-18 END                                              07650701
076510***************************************************************** 07650801
076600* DISCONNECT FROM QUEUE MANAGER.                                  07650901
076700***************************************************************** 07651001
076800 8400-MQ-DISCONNECT.                                              07652001
076900     DISPLAY 'WSKUT033 - 8400-MQ-DISCONNECT.           '.         07653001
077000                                                                  07654001
077100     MOVE '4500-MQ-DISCONNECT'    TO PV-PARAGRAPH.                07655001
077200                                                                  07656001
077300     IF PV-CON-REASON NOT = MQRC-ALREADY-CONNECTED                07657001
077400         CALL PC-MQDISC USING PV-HCONN                            07658001
077500                              PV-COMPLETION-CODE                  07659001
077600                              PV-REASON                           07660001
077700                                                                  07670001
077800*    IF MQ DISCONNECT FAILED THEN DISPLAY ERROR MESSAGE           07680001
077900*    AND EXIT                                                     07690001
078000                                                                  07700001
078100     IF PV-COMPLETION-CODE = MQCC-OK THEN                         07710001
078200         CONTINUE                                                 07720001
078300     ELSE                                                         07730001
078400         STRING 'DISCONNECT - ' PV-QMGR-NAME-PIX                  07740001
078500           DELIMITED BY SIZE INTO PV-ACTION                       07750001
078600         PERFORM 9001-MQSERIES-ERROR                              07760001
078700     END-IF.                                                      07770001
078800                                                                  07780001
078900******************************************************************07790001
079000* DISPLAY STATISTICS FOR THE PROGRAM                              07800001
079100******************************************************************07810001
079200 9900-EOJ-ROUTINE.                                                07820001
079300     DISPLAY 'WSKUT033 - 9900-EOJ-ROUTINE    '.                   07830001
079400                                                                  07840001
079500     DISPLAY ' '                                                  07850001
079600     DISPLAY ' ********************************************'      07860001
079700     DISPLAY '     * WSKUT033 SUMMARY STATISTICS *         '      07870001
079800     DISPLAY ' '                                                  07880001
079900     DISPLAY '   TOTAL INPUT RECORDS READ: '                      07890001
080000                                    PA-TOTAL-RECORDS-IN           07900001
080100     DISPLAY '   TOTAL MQ MESSAGES SENT:   '                      07910001
080200                                    PA-TOTAL-MQ-MSGS-SENT         07920001
080300     DISPLAY '   TOTAL ERRORS PROCESSED:   '                      07930001
080400                        PA-TOTAL-ERRORS-PROCESSED.                07940001
080500     DISPLAY ' '                                                  07950001
080600     PERFORM                                                      07960001
080700       VARYING K FROM 1 BY 1                                      07970001
080800         UNTIL K > PV-INDX                                        07980001
080900          DISPLAY '   ' PA-QUEUE-NAME(K) '  '                     07990001
081000                                    PA-QUEUE-MESG-COUNT(K)        08000001
081100     END-PERFORM.                                                 08010001
081200                                                                  08020001
081300     DISPLAY ' '                                                  08030001
081400     DISPLAY ' ********************************************'.     08040001
081500                                                                  08050001
081600****************************************************************  08060001
081700** PERFORM MQ-SERIES ABEND PROCESSING                             08070001
081800****************************************************************  08080001
081900 9200-MQ-ABEND.                                                   08090001
082000                                                                  08100001
082100     DISPLAY '****************** A B E N D ******************'.   08110001
082200     DISPLAY '** MQSERIES ERROR **'.                              08120001
082300     DISPLAY '** PROGRAM:    ', PC-PGM-NAME.                      08130001
082400     DISPLAY '** ABEND CODE: ', PV-ABEND-CODE.                    08140001
082500     DISPLAY '** PARAGRAPH:  ', PV-PARAGRAPH.                     08150001
082600     DISPLAY '** MESSAGE:    ', PV-ERROR-MESSAGE.                 08160001
082700     DISPLAY '** COMP CODE:  ', PE-MQ-COMPLETION-CODE.            08170001
082800     DISPLAY '** RSN CODE:   ', PE-MQ-REASON-CODE.                08180001
082900     DISPLAY '** RSN TEXT:   ', PV-MQ-REASON-TEXT.                08190001
083000     DISPLAY '***********************************************'.   08200001
083100     MOVE +4013 TO ABEND-CODE.                                    08210001
083200     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         08220001
083300                                                                  08230001
083400******************************************************************08240001
083500* 9900-DB2-ABEND - PERFORMS THE ABEND FOR THE PROGRAM IN THE      08250001
083600* EVENT THAT AN SQL ERROR OR WARNING CODE OCCURS.                 08260001
083700******************************************************************08270001
083800 9900-DB2-ABEND.                                                  08280001
083900                                                                  08290001
084000     MOVE SQLCODE    TO PV-SQLCODE.                               08300001
084100     MOVE PV-SQLCODE TO PV-DISPLAY-SQLCODE.                       08310001
084200     DISPLAY '*** DB2 ERROR ***'.                                 08320001
084300     DISPLAY '*** SQLCODE   = ' PV-DISPLAY-SQLCODE.               08330001
084400     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 08340001
084500     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               08350001
084600     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               08360001
084700     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       08370001
084800     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.             08380001
084900                                                                  08390001
085000******************************************************************08400001
085100* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    08410001
085200* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         08420001
085300* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     08430001
085400* FORMAT.                                                         08440001
085500******************************************************************08450001
085600     COPY DPPD004.                                                08460001
085700                                                                  08470001
085800     IF SQLCODE NOT = -911                                        08480001
085900         EXEC SQL                                                 08490001
086000             ROLLBACK                                             08500001
086100         END-EXEC                                                 08510001
086200     END-IF.                                                      08520001
086300                                                                  08530001
086400     MOVE +4013         TO PV-ABEND-CODE.                         08540001
086500     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         08550001
086600******************************************************************08560001
086700                                                                  08570001
