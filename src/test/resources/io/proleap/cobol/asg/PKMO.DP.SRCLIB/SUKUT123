000100 TITLE 'EXTRACT PURGE RECORDS FOR TSUCDOT'.                               
000200 IDENTIFICATION DIVISION.                                                 
000300 PROGRAM-ID.    SUKUT123.                                                 
000400 AUTHOR.        DENNIS STEFFEN.                                           
000500 INSTALLATION.  KOHLS DEPARTMENT STORES.                                  
000600 DATE-WRITTEN   DECEMBER 2008.                                            
000700 DATE-COMPILED.                                                           
000800 ENVIRONMENT DIVISION.                                                    
000900 CONFIGURATION SECTION.                                                   
001000 SOURCE-COMPUTER.        IBM-3090.                                        
001100 OBJECT-COMPUTER.        IBM-3090.                                        
001200                                                                          
001300 INPUT-OUTPUT SECTION.                                                    
001400 FILE-CONTROL.                                                            
001500                                                                          
001600     SELECT INPUT-FILE                                                    
001700         ASSIGN TO INP01.                                                 
001800                                                                          
001900     SELECT UNLOAD-FILE                                                   
002000         ASSIGN TO OUT01.                                                 
002100                                                                          
002200******************************************************************        
002300 DATA DIVISION.                                                           
002400 FILE SECTION.                                                            
002500                                                                          
002600 FD  INPUT-FILE                                                           
002700     RECORDING MODE IS F                                                  
002800     LABEL RECORDS ARE STANDARD                                           
002900     BLOCK CONTAINS 0 RECORDS.                                            
003000                                                                          
003100 01  INPUT-REC                        PIC X(020).                         
003200*                                                                         
003300 FD  UNLOAD-FILE                                                          
003400     RECORDING MODE IS F                                                  
003500     LABEL RECORDS ARE STANDARD                                           
003600     BLOCK CONTAINS 0 RECORDS.                                            
003700                                                                          
003800*                                                                         
003900 01  UNLOAD-REC                       PIC X(130).                         
004000*                                                                         
004100/                                                                         
004200 WORKING-STORAGE SECTION.                                                 
004300                                                                          
004400*    DRIVER FILE FROM SUKUT127.                                           
004500     COPY SURD054.                                                        
004600                                                                          
004700*    OUTPUT FILE                                                          
004800     COPY SURD082.                                                        
004900                                                                          
005000     COPY DPWS004.                                                        
005100*                                                                         
005200     EXEC SQL                                                             
005300         INCLUDE TSUCDOT                                                  
005400     END-EXEC.                                                            
005500                                                                          
005600     EXEC SQL                                                             
005700          INCLUDE SQLCA                                                   
005800     END-EXEC.                                                            
005900                                                                          
006000 01  ABEND-CODE                      PIC S9(04)    VALUE +0               
006100                                                   COMP SYNC.             
006200                                                                          
006300 01  PS-PROGRAM-SWITCHES.                                                 
006400     05  PS-END-INPUT-SW              PIC  X(01) VALUE 'N'.               
006500         88  PS-END-INPUT-YES                    VALUE 'Y'.               
006600         88  PS-END-INPUT-NO                     VALUE 'N'.               
006700     05  PS-END-OF-DRIVE-CSR-SW       PIC  X(01) VALUE 'N'.               
006800         88  PS-END-DRIVE-CSR-YES                VALUE 'Y'.               
006900         88  PS-END-DRIVE-CSR-NO                 VALUE 'N'.               
007000                                                                          
007100 01  PC-PROGRAM-CONSTANTS.                                                
007200     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08) VALUE 'SUKUT123'.         
007300                                                                          
007400 01  DK-DB2-VARIABLES.                                                    
007500     05  DK-PURGE-DATE                PIC X(10).                          
007600                                                                          
007700 01  PV-PROGRAM-VARIABLES.                                                
007800                                                                          
007900     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.          
008000     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.          
008100     05  PV-READ-COUNTER             PIC  S9(9) COMP.                     
008200     05  PV-WRITE-COUNTER            PIC  S9(9) COMP.                     
008300     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.                     
008400     05  PV-FUNC-QTY                 PIC  S9(4) COMP.                     
008500/                                                                         
008600     EXEC SQL                                                             
008700                                                                          
008800         DECLARE DRIVE-CSR CURSOR FOR                                     
008900         SELECT                                                           
009000             OTBND_TRIP_ID                                                
009100            ,OPER_UNT_ID                                                  
009200            ,DOOR_ID                                                      
009300            ,STRT_DIVERT_TMST                                             
009400            ,END_DIVERT_TMST                                              
009500            ,STRT_SCN_TMST                                                
009600            ,STRT_SCN_USR_ID                                              
009700            ,END_SCN_TMST                                         ULT     
009800            ,END_SCN_USR_ID                                               
009900          FROM  TSUCDOT                                                   
010000         WHERE  OTBND_TRIP_ID = :SU054-OTBND-TRIP-ID                      
010100     END-EXEC.                                                            
010200/                                                                         
010300 PROCEDURE DIVISION.                                                      
010400                                                                          
010500     PERFORM 1000-INITIALIZE.                                             
010600                                                                          
010700     PERFORM 2000-PROCESS-DRIVE-CSR                                       
010800             UNTIL PS-END-INPUT-YES                                       
010900                                                                          
011000     PERFORM 9000-EOJ-ROUTINE.                                            
011100                                                                          
011200     GOBACK.                                                              
011300/                                                                         
011400 1000-INITIALIZE.                                                         
011500                                                                          
011600     OPEN OUTPUT UNLOAD-FILE                                              
011700          INPUT INPUT-FILE                                                
011800                                                                          
011900     DISPLAY '* * * * * * * * * * * * '.                                  
012000     DISPLAY 'CURRENT PROGRAM ' PC-CURRENT-PROGRAM-NAME.                  
012010     DISPLAY '*** TSUCDOT EXTRACT ***'.                                   
012020     DISPLAY '* * * * * * * * * * * * '.                                  
012100                                                                          
012200     PERFORM 8000-READ-SURD054-REC.                                       
012300                                                                          
012400                                                                          
012500 2000-PROCESS-DRIVE-CSR.                                                  
012600                                                                          
012700     PERFORM 7000-OPEN-DRIVE-CSR.                                         
012800                                                                          
012900     PERFORM 7010-FETCH-DRIVE-CSR.                                        
013000                                                                          
013100     PERFORM 2100-WRITE-THE-STUFF UNTIL PS-END-DRIVE-CSR-YES              
013200                                                                          
013300     PERFORM 7020-CLOSE-DRIVE-CSR.                                        
013400                                                                          
013500     SET PS-END-DRIVE-CSR-NO          TO TRUE                             
013600     PERFORM 8000-READ-SURD054-REC.                                       
013700                                                                          
013800 2100-WRITE-THE-STUFF.                                                    
013900                                                                          
014000     PERFORM 3000-BUILD-SU082-REC.                                        
014100                                                                          
014200     PERFORM 8100-WRITE-SU082-REC.                                        
014300                                                                          
014400     PERFORM 7010-FETCH-DRIVE-CSR.                                        
014500                                                                          
014600 3000-BUILD-SU082-REC.                                                    
014700                                                                          
014800     MOVE SUCDOT-OTBND-TRIP-ID        TO SU082-OTBND-TRIP-ID              
014900     MOVE SUCDOT-OPER-UNT-ID          TO SU082-OPER-UNT-ID                
015000     MOVE SUCDOT-DOOR-ID              TO SU082-DOOR-ID                    
015100     MOVE SUCDOT-STRT-DIVERT-TMST     TO SU082-STRT-DIVERT-TMST           
015200     MOVE SUCDOT-END-DIVERT-TMST      TO SU082-END-DIVERT-TMST            
015300     MOVE SUCDOT-STRT-SCN-TMST        TO SU082-STRT-SCN-TMST              
015400     MOVE SUCDOT-STRT-SCN-USR-ID      TO SU082-STRT-SCN-USR-ID            
015500     MOVE SUCDOT-END-SCN-TMST         TO SU082-END-SCN-TMST               
015600     MOVE SUCDOT-END-SCN-USR-ID       TO SU082-END-SCN-USR-ID.            
015700                                                                          
015800 7000-OPEN-DRIVE-CSR.                                                     
015900                                                                          
016000     MOVE '7000-OPEN-DRIVE-CSR'       TO PV-PARAGRAPH-NAME.               
016100                                                                          
016200     EXEC SQL                                                             
016300         OPEN DRIVE-CSR                                                   
016400     END-EXEC.                                                            
016500                                                                          
016600     EVALUATE TRUE                                                        
016700         WHEN SQLCODE = ZERO                                              
016800             SET PS-END-DRIVE-CSR-NO  TO TRUE                             
016900         WHEN SQLWARN0 NOT = SPACES                                       
017000         WHEN SQLCODE < ZERO                                              
017100         WHEN SQLCODE > ZERO                                              
017200             MOVE 'OPEN CURSOR ' TO PV-DB2-OPERATION-ATTEMPTED            
017300             PERFORM 9100-SQL-ABEND                                       
017400     END-EVALUATE.                                                        
017500                                                                          
017600 7010-FETCH-DRIVE-CSR.                                                    
017700                                                                          
017800     MOVE '7010-FETCH-DRIVE-CSR'      TO PV-PARAGRAPH-NAME.               
017900     INITIALIZE DCLTSUCDOT.                                               
018000                                                                          
018100     EXEC SQL                                                             
018200         FETCH DRIVE-CSR                                                  
018300         INTO                                                             
018400             :SUCDOT-OTBND-TRIP-ID                                        
018500         ,   :SUCDOT-OPER-UNT-ID                                          
018600         ,   :SUCDOT-DOOR-ID                                              
018700         ,   :SUCDOT-STRT-DIVERT-TMST                                     
018800         ,   :SUCDOT-END-DIVERT-TMST                                      
018900         ,   :SUCDOT-STRT-SCN-TMST                                        
019000         ,   :SUCDOT-STRT-SCN-USR-ID                                      
019100         ,   :SUCDOT-END-SCN-TMST                                         
019200         ,   :SUCDOT-END-SCN-USR-ID                                       
019300     END-EXEC.                                                            
019400                                                                          
019500     EVALUATE TRUE                                                        
019600         WHEN SQLCODE = ZERO                                              
019700             CONTINUE                                                     
019800         WHEN SQLCODE = +100                                              
019900             SET PS-END-DRIVE-CSR-YES TO TRUE                             
020000         WHEN SQLWARN0 NOT = SPACES                                       
020100         WHEN SQLCODE < ZERO                                              
020200         WHEN SQLCODE > ZERO                                              
020300             MOVE 'FETCH CURSOR ' TO PV-DB2-OPERATION-ATTEMPTED           
020400             PERFORM 9100-SQL-ABEND                                       
020500     END-EVALUATE.                                                        
020600                                                                          
020700 7020-CLOSE-DRIVE-CSR.                                                    
020800                                                                          
020900     MOVE '7020-CLOSE-DRIVE-CSR' TO PV-PARAGRAPH-NAME                     
021000     EXEC SQL                                                             
021100         CLOSE DRIVE-CSR                                                  
021200     END-EXEC                                                             
021300                                                                          
021400     EVALUATE TRUE                                                        
021500         WHEN SQLCODE = ZERO                                              
021600             CONTINUE                                                     
021700         WHEN SQLWARN0 NOT = SPACES                                       
021800         WHEN SQLCODE < ZERO                                              
021900         WHEN SQLCODE > ZERO                                              
022000             MOVE 'CLOSE CURSOR ' TO PV-DB2-OPERATION-ATTEMPTED           
022100             PERFORM 9100-SQL-ABEND                                       
022200     END-EVALUATE.                                                        
022300                                                                          
022400 8000-READ-SURD054-REC.                                                   
022500                                                                          
022600     READ INPUT-FILE INTO                                                 
022700         SU054-EXTRACT-RECORD                                             
022800     AT END                                                               
022900         SET PS-END-INPUT-YES         TO TRUE                             
023000     NOT AT END                                                           
023100         ADD +1                       TO PV-READ-COUNTER                  
023200     END-READ.                                                            
023300                                                                          
023400 8100-WRITE-SU082-REC.                                                    
023500     WRITE UNLOAD-REC FROM                                                
023600         SU082-TSUCDOT-RECORD.                                            
023700     ADD +1                           TO PV-WRITE-COUNTER.                
023800/                                                                         
023900 9000-EOJ-ROUTINE.                                                        
024000                                                                          
024100     CLOSE INPUT-FILE                                                     
024200           UNLOAD-FILE                                                    
024300                                                                          
024400     MOVE PV-READ-COUNTER             TO PV-DISPLAY-COUNT.                
024500     DISPLAY 'TOTAL RECORDS READ             = ' PV-DISPLAY-COUNT.        
024600                                                                          
024700                                                                          
024800     MOVE PV-WRITE-COUNTER            TO PV-DISPLAY-COUNT.                
024900     DISPLAY 'DELETE KEY RECORDS WRITTEN     = ' PV-DISPLAY-COUNT.        
025000                                                                          
025100     DISPLAY '* * * * * * * * * * * '.                                    
025200                                                                          
025300 9100-SQL-ABEND.                                                          
025400     DISPLAY '9100-SQL-ABEND'.                                            
025500     DISPLAY '** ABEND     **'.                                           
025600     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.                
025700     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.                      
025800     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.             
025900                                                                          
026000     COPY DPPD004.                                                        
026100                                                                          
026200     MOVE +4013                  TO ABEND-CODE.                           
026300     CALL 'ILBOABN0' USING ABEND-CODE.                                    
026400                                                                          
