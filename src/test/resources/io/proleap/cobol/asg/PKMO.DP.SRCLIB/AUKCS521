000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300 PROGRAM-ID.        AUKCS521.                                     00030076
000400 AUTHOR.            J ZIMBAL.                                     00040077
000500 INSTALLATION.      KOHLS.                                        00050077
000600 DATE-WRITTEN       05/17/2012.                                   00060077
000700 DATE-COMPILED.                                                   00070077
000800                                                                  00080077
000900******************************************************************00090077
001000*  CICS PROGRAM - AUKCS521 - A521                                *00100077
001100*                                                                *00110077
001200*  INCOMM - KOHLS GIFT CARD AUTHORIZATION PROCESSOR.             *00120077
001300*                                                                *00130077
001400*  RECEIVE GIFT CARD AUTHORIZATION REQUESTS FROM THE TCP/IP      *00140077
001500*  LISTENER PROGRAM AUKCS519, PERFORM THE AUTHORIZATION, AND     *00150077
001600*  SEND RESPONSE TO TEMP STORAGE QUEUE TO BE PICKED UP BY THE    *00160077
001700*  LISTENER PROGRAM.                                             *00170077
001800*  THE KMC ACTIVITY TABLE WILL BE UPDATED WITH ANY APPROVED      *00180077
001900*  RESPONSES.                                                    *00190077
002000*  THIS PROGRAM IS STARTED BY THE LISTENER AUKCS519.             *00200077
002100*                                                                *00210077
002200*  THIS PROGRAM WAS WRITTEN USING AUKCS502 AS A BASE.            *00220077
002300*                                                                *00230077
002400*  Note: This program must be compiled with DB2 option on.       *00240077
002500******************************************************************00250077
002600*   09-20-2018 - Jim Hunter      CHG0208819                       00260077
002700*   MAINFRAME REFACTORING - REPLACE CGU042MC WITH DPWS036.        00270077
002800******************************************************************00280077
002910*   03-05-2020 - TY HOPP         CHG0240835                       00291079
002920*   MULTIPLY FIELD BY 100 TO RETURN CENTS ON RESPONSE MESSAGE.    00292079
002921*   DIVIDE SAME FIELD BY 100 TO SHOW CENTS CORRECTLY ON CICS LOG  00292179
002922*   MESSAGE.  CHANGES MARKED TDH001.                              00292278
002930******************************************************************00293078
002940                                                                  00294078
003000******************************************************************00300077
003100 ENVIRONMENT DIVISION.                                            00310077
003200******************************************************************00320000
003300                                                                  00330000
003400******************************************************************00340000
003500 DATA DIVISION.                                                   00350000
003600******************************************************************00360000
003700                                                                  00370000
003800 WORKING-STORAGE SECTION.                                         00380000
003900                                                                  00390000
004000*                                                                 00400000
004100*  LISTENER QUEUE NAMES                                           00410000
004200*                                                                 00420000
004300     COPY AUWS013.                                                00430000
004400                                                                  00440000
004500*                                                                 00450000
004600*  RECORD LAYOUT BEING TRANSMITTED FROM THE REQUESTING PLATFORM   00460000
004700*                                                                 00470000
004800     COPY AURD017.                                                00480000
004900                                                                  00490000
005000*                                                                 00500000
005100*  RECORD LAYOUT BEING TRANSMITTED TO THE REQUESTING PLATFORM     00510000
005200*                                                                 00520000
005300     COPY AURD018.                                                00530000
005400*                                                                 00540000
005500*  WORKING-STORAGE VARIABLES REQUIRED FOR THE USE OF THE          00550000
005600*  LOG MESSAGE ROUTING (EPPD000).                                 00560000
005700*                                                                 00570000
005800     COPY EPWS000.                                                00580000
005900                                                                  00590000
006000*----------------------------------------------------------       00600000
006100* BIT LAYOUT FOR BITMAPPING                                       00610000
006200*----------------------------------------------------------       00620000
006300     COPY DPWS170.                                                00630000
006400                                                                  00640000
006500*                                                                 00650000
006600* STORED VALUE CONSTANTS                                          00660000
006700*                                                                 00670000
006800     COPY SVWS004.                                                00680000
006900*                                                                 00690000
007000* INCOMM BITMAP LAYOUT                                            00700000
007100*                                                                 00710000
007200     COPY AUWS014.                                                00720000
007300*                                                                 00730000
007400* INCOMM FIELDS LAYOUT                                            00740000
007500*                                                                 00750000
007600     COPY AUWS015.                                                00760000
007700*                                                                 00770000
007800                                                                  00780000
007900 01  PS-PROGRAM-SWITCHES.                                         00790000
008000     05  PS-SYSTEM-ERROR-IND     PIC X(1)     VALUE 'N'.          00800000
008100         88  PS-SYSTEM-ERROR-DETECTED         VALUE 'Y'.          00810000
008200         88  PS-NO-SYSTEM-ERROR-DETECTED      VALUE 'N'.          00820000
008300     05  PS-ERROR-TYPE           PIC X(1).                        00830000
008400         88  PS-DB2-ERROR                     VALUE 'D'.          00840000
008500         88  PS-AUTH-MESSAGE-ERROR            VALUE 'M'.          00850000
008600         88  PS-SYSTEM-ERROR                  VALUE 'S'.          00860000
008700                                                                  00870000
008800 01  PC-PROGRAM-CONSTANTS.                                        00880000
008900     05  PC-CURRENT-PROGRAM-NAME PIC X(8)     VALUE 'AUKCS521'.   00890000
009000     05  PC-COMMUNICATIONS-IN-LENGTH                              00900000
009100                                 PIC S9(4)    VALUE +9999         00910000
009200                                 COMP SYNC.                       00920000
009300     05  PC-MAXIMUM-RETRY-COUNT  PIC S9(4)    VALUE +2            00930000
009400                                 COMP SYNC.                       00940000
009500     05  PC-ONE                  PIC S9(1)    VALUE  +1.          00950000
009600                                                                  00960000
009700     05  PC-TEST-GIFT-1000000321 PIC  9(10)   VALUE 1000000321.   00970000
009800     05  PC-TEST-GIFT-1000000107 PIC  9(10)   VALUE 1000000107.   00980000
009900     05  PC-TEST-GIFT-1000000370 PIC  9(10)   VALUE 1000000370.   00990000
010000     05  PC-TEST-GIFT-1000000388 PIC  9(10)   VALUE 1000000388.   01000000
010100     05  PC-TEST-GIFT-1000000396 PIC  9(10)   VALUE 1000000396.   01010000
010200***************************************************************   01020000
010300* NOTE, IF STATE CODE IS NOT FOUND IN TSTATE TABLE, THEN          01030000
010400* THE DEFAULT STATE IS DELAWARE, THE KOHLS INCORPORATION          01040000
010500* STATE. PER JOE JESTER TAX DEPT ON 1/10/2005                     01050000
010600***************************************************************   01060000
010700     05  PC-DEFAULT-STATE-CD     PIC  X(2)    VALUE 'DE'.         01070000
010800*                                                                 01080000
010900                                                                  01090000
011000 01  PV-PROGRAM-VARIABLES.                                        01100000
011100     05  PV-CICS-RESPONSE        PIC S9(9)   VALUE ZERO COMP SYNC.01110000
011200     05  PV-CICS-RESPONSE-DISP   PIC ZZZZZ9999-.                  01120000
011300     05  PV-RETRY-COUNT          PIC S9(4)   VALUE ZERO COMP SYNC.01130000
011400     05  PV-STATE-CD             PIC X(2)     VALUE SPACES.       01140000
011500     05  PV-DIV-ID               PIC X(16)     VALUE SPACES.      01150028
011600     05  PV-KMC-AMT              PIC 9(7)V99 COMP-3 VALUE ZERO.   01160000
011700     05  PV-KMC-ID               PIC  9(12)        VALUE 0.       01170000
011800         88 PV-TEST-GIFT-CARD-ACCOUNTS             VALUE          01180000
011900         1000000321, 1000000107, 1000000370, 1000000388,          01190000
012000         1000000396.                                              01200000
012100     05  PV-INCOMM-RESPONSE-CODES PIC 9(2)   VALUE ZERO.          01210000
012200         88  PV-SRC-UNKNOWN-ACCOUNT           VALUE 3.            01220000
012300         88  PV-SRC-ALREADY-ACTIVE            VALUE 8.            01230000
012400         88  PV-SRC-GENERIC-DENIAL            VALUE 35.           01240000
012500                                                                  01250000
012600     05 PV-REQUEST-TYPE-INFO.                                     01260000
012700        10 PV-REVERSAL-IND       PIC S9(1) COMP-3.                01270000
012800           88 PV-NORMAL          VALUE  0.                        01280000
012900           88 PV-REVERSAL        VALUE  1.                        01290000
013000        10 PV-REQUEST-TYPE       PIC S9(1) COMP-3.                01300000
013100           88 PV-BALANCE-INQUIRY       VALUE 0.                   01310000
013200           88 PV-ISSUANCE-AS-KMRC      VALUE 1.                   01320000
013300           88 PV-ISSUANCE-AS-GIFT-CARD VALUE 2.                   01330000
013400           88 PV-TENDER                VALUE 3.                   01340000
013500           88 PV-INVALID-REQUEST-TYPE  VALUE 9.                   01350000
013600     05 PV-SCAN-SOURCE-CODE      PIC X(02).                       01360000
013700        88  PV-KMC-KEY-ENTERED                VALUE '00'.         01370000
013800        88  PV-KMC-SCANNED                    VALUE '02'.         01380000
013900     05 PV-INCOMM-PROCESSING-CODE   PIC X(1).                     01390000
014000        88  PV-SPC-ONLINE-NORMAL              VALUE 'N'.          01400000
014100        88  PV-SPC-OFFLINE-SAF                VALUE 'S'.          01410000
014200                                                                  01420052
014300     05  PV-STAN-SW                PIC  X(1).                     01430052
014400          88  PV-STAN-FOUND                     VALUE 'Y'.        01440052
014500          88  PV-STAN-NOT-FOUND                 VALUE 'N'.        01450052
014600                                                                  01460049
014700     05 PV-ELEMENT-AMT    PIC Z,ZZZ,ZZZ.99.                       01470007
014800     05 PV-TRAN-AMTDIV                      PIC 9(9) VALUE ZEROS. 01480007
014900     05 PV-REMAINDER                        PIC 9(4) VALUE ZEROS. 01490007
015000     05 PV-APPROVAL-NBR          PIC 9(6).                        01500000
015100     05 PV-DISPLAY-ACCT-LENGTH   PIC  9(3).                       01510000
015200     05  PV-TSQ-DATA-RECORD.                                      01520000
015300         10  PV-TSQ-DATA-PORTION         PIC X(9998) VALUE SPACE. 01530000
015400                                                                  01540000
015500     05  PV-ITEM-NBR                     PIC S9(04)  VALUE ZEROS  01550000
015600                                                     COMP SYNC.   01560000
015700     05  PV-TSQ-LENGTH                   PIC S9(04)  VALUE ZEROS  01570000
015800                                                     COMP SYNC.   01580000
015900     05  PV-TSQ-NAME                     PIC  X(08)  VALUE SPACES.01590000
016000                                                                  01600000
016100     05  PV-TCPIPPRQ-RECORD1.                                     01610000
016200         10  PV-NEXT-RECORD             PIC  9(08)   VALUE ZEROS. 01620000
016300         10  PV-TOTAL-RECORDS           PIC  9(08)   VALUE ZEROS. 01630000
016400         10  FILLER                     PIC X(9984) VALUE SPACES. 01640000
016500                                                                  01650000
016600     05  PV-E-BUS-IND                    PIC X(1)    VALUE 'N'.   01660000
016700         88  PV-E-ECOMMERCE-STORE             VALUE 'Y'.          01670000
016800         88  PV-E-NON-ECOMM-STORE             VALUE 'N'.          01680000
016900     05  PV-WS-CTR                       PIC 9(04)   VALUE ZEROS. 01690000
017000     05  PV-MSG-LEN-WHDR                 PIC 9(04)   VALUE ZEROS. 01700000
017100     05  PV-MSG-LEN-WOHDR                PIC 9(04)   VALUE ZEROS. 01710000
017200     05  PV-HEX-BINARY                   PIC 9(04) BINARY.        01720000
017300     05  PV-HEX-CHAR REDEFINES PV-HEX-BINARY.                     01730000
017400         10  PV-HEX-LENGTH               PIC X(02).               01740000
017500     05  PV-POS-ENTR-CDE                 PIC 9(3).                01750000
017600     05  PV-TRACK2-LEN                   PIC 9(2).                01760000
017700     05  PV-DATA-POSITION                PIC 9(4).                01770000
017800     05  PV-REST-OF-DATA-LEN             PIC 9(6).                01780000
017900     05  PV-TRAN-SIZE                    PIC 9(6) VALUE ZEROES.   01790000
018000     05  PV-RESPONSE-LEN                 PIC 9(6).                01800000
018100     05  PV-RESPONSE-LEN2                PIC 9(6).                01810000
018200                                                                  01820000
018300   05 WS-BIT-START                  PIC 9(4)  VALUE ZEROES COMP.  01830000
018400   05 WS-START                      PIC S9(8)  VALUE ZEROES COMP. 01840000
018500   05 PV-POS                        PIC S9(4)  VALUE ZEROES COMP. 01850000
018600   05 PV-POS-REV                    PIC S9(4)  VALUE ZEROES COMP. 01860000
018700   05 PV-FIELD-INDX                 PIC 9(4)  VALUE ZEROES COMP.  01870000
018800   05 PV-FIELD-IND-DISP             PIC 9(2)  VALUE ZEROES.       01880000
018900   05 PV-BIT-CNT                    PIC S9(4)  VALUE ZEROES COMP. 01890000
019000   05 PV-BIT-HOLD                   PIC S9(4)  VALUE ZEROES COMP. 01900000
019100   05 PV-BITMAP-INDX                PIC S9(4)  VALUE ZEROES COMP. 01910000
019200   05 PV-BIT-INDX                   PIC S9(4)  VALUE ZEROES COMP. 01920000
019300   05 PV-BITR-INDX                   PIC S9(4)  VALUE ZEROES COMP.01930000
019400                                                                  01940000
019500   05  PV-NO-TABLE-LOCK-IND    PIC X(1)     VALUE 'Y'.            01950000
019600       88  PV-TABLE-LOCK                    VALUE 'Y'.            01960000
019700       88  PV-NO-TABLE-LOCK                 VALUE 'N'.            01970000
019800                                                                  01980000
019900   05  PV-BITMAP-SECOND-IND    PIC X(1)     VALUE 'N'.            01990000
020000       88  PV-BITMAP-SECOND-EXISTS          VALUE 'Y'.            02000000
020100       88  PV-BITMAP-SECOND-NO-EXISTS       VALUE 'N'.            02010000
020200                                                                  02020000
020300   05  PV-BITMAP-RET                PIC X(8).                     02030000
020400                                                                  02040000
020500   05  PV-BITMAP                    PIC X(8).                     02050000
020600   05  FILLER REDEFINES PV-BITMAP.                                02060000
020700     10  PV-BITMAP-TABLE             OCCURS 8 TIMES               02070000
020800                                 INDEXED BY PV-BITMAP-IDX.        02080000
020900       15  PV-BITMAP-BYTE                  PIC X(01).             02090000
021000                                                                  02100000
021100   05  PV-BITMAP2                   PIC X(8).                     02110000
021200   05  FILLER REDEFINES PV-BITMAP2.                               02120000
021300     10  PV-BITMAP2-TABLE             OCCURS 8 TIMES              02130000
021400                                 INDEXED BY PV-BITMAP2-IDX.       02140000
021500       15  PV-BITMAP2-BYTE                  PIC X(01).            02150000
021600                                                                  02160000
021700                                                                  02170000
021800   05  PV-BITMAP-FULL                   PIC X(64).                02180000
021900                                                                  02190000
022000   05  PV-BITMAP2-FULL                   PIC X(64).               02200000
022100                                                                  02210000
022200   05  PV-BITMAP-FULL-REVERSE           PIC X(64).                02220000
022300   05  FILLER REDEFINES PV-BITMAP-FULL-REVERSE.                   02230000
022400     10  PV-BITMAP-FULLR-TABLE          OCCURS 8 TIMES            02240000
022500                                INDEXED BY PV-BITFULR-IDX.        02250000
022600        15  PV-BITMAP-BITS-REVERSE          PIC X(08).            02260000
022700                                                                  02270000
022800   05  PV-BITMAP2-FULL-REVERSE           PIC X(64).               02280000
022900   05  FILLER REDEFINES PV-BITMAP2-FULL-REVERSE.                  02290000
023000     10  PV-BITMAP2-FULLR-TABLE          OCCURS 8 TIMES           02300000
023100                                INDEXED BY PV-BITFULR2-IDX.       02310000
023200        15  PV-BITMAP2-BITS-REVERSE          PIC X(08).           02320000
023300                                                                  02330000
023400                                                                  02340000
023500 01  PV-BITMAP-TABLE.                                             02350000
023600     05  PV-BITMAP-ENTRY         OCCURS 5000 TIMES                02360000
023700                                 INDEXED BY AUD-INDX.             02370000
023800         10  ADT-SYSTEM-DTE      PIC X(10).                       02380000
023900         10  ADT-STORE-NBR       PIC 9(08).                       02390000
024000         10  ADT-CATEGORY-CDE    PIC X(03).                       02400000
024100         10  ADT-SETTLEMNT-AMT   PIC S9(9)V99                     02410000
024200                                 SIGN IS LEADING SEPARATE.        02420000
024300*                                                                 02430000
024400 01  BC-BCD-CONVERSION-AREA.                                      02440000
024500     05  BC-BCD-BYTES            PIC S9(4)    VALUE ZEROS         02450000
024600                                              COMP SYNC.          02460000
024700     05  BC-BCD-POSITION         PIC S9(4)    VALUE ZEROS         02470000
024800                                              COMP SYNC.          02480000
024900     05  BC-BCD-FIELD            PIC X(8)     VALUE LOW-VALUES.   02490000
025000     05  BC-EBCDIC-BYTES         PIC S9(4)    VALUE ZEROS         02500000
025100                                              COMP SYNC.          02510000
025200     05  BC-EBCDIC-POSITION      PIC S9(4)    VALUE ZEROS         02520000
025300                                              COMP SYNC.          02530000
025400     05  BC-EBCDIC-FIELD         PIC X(16)    VALUE SPACES.       02540000
025500     05  BC-MAXIMUM-NIBBLES      PIC S9(4)    VALUE +2            02550000
025600                                              COMP SYNC.          02560000
025700     05  BC-NIBBLE-COUNT         PIC S9(4)    VALUE +1            02570000
025800                                              COMP SYNC.          02580000
025900     05  BC-NIBBLE-SHIFT         PIC S9(4)    VALUE +16           02590000
026000                                              COMP SYNC.          02600000
026100     05  BC-ZONE-F               PIC S9(4)    VALUE +240          02610000
026200                                              COMP SYNC.          02620000
026300     05  BC-ZONE-C               PIC S9(4)    VALUE +183          02630000
026400                                              COMP SYNC.          02640000
026500     05  BC-EBCDIC-CHAR-COMP     PIC S9(4)    VALUE ZEROS         02650000
026600                                              COMP SYNC.          02660000
026700         88  BC-EBCDIC-CHAR-0-9               VALUES 240 THRU 249.02670000
026800         88  BC-EBCDIC-CHAR-A-F               VALUES 193 THRU 198.02680000
026900         88  BC-BCD-NIBBLE-0-9                VALUES 0 THRU 9.    02690002
027000         88  BC-BCD-NIBBLE-A-F                VALUES 10 THRU 15.  02700002
027100     05  FILLER                  REDEFINES BC-EBCDIC-CHAR-COMP.   02710000
027200         10  FILLER              PIC X(1).                        02720000
027300         10  BC-EBCDIC-CHAR      PIC X(1).                        02730000
027400     05  BC-EBCDIC-CHAR-HIGH-ORDER                                02740000
027500                                 PIC S9(4)    VALUE ZEROS         02750000
027600                                              COMP SYNC.          02760000
027700     05  BC-BCD-BYTE-COMP        PIC S9(4)    VALUE ZEROS         02770000
027800                                              COMP SYNC.          02780000
027900     05  FILLER                  REDEFINES BC-BCD-BYTE-COMP.      02790000
028000         10  BC-HIGH-ORDER-BYTE  PIC X(1).                        02800000
028100         10  BC-BCD-BYTE-CHAR    PIC X(1).                        02810000
028200     05  BC-HIGH-ORDER-BYTE-HOLD PIC X(1).                        02820002
028300     05  BC-LOW-ORDER-BYTE-HOLD  PIC X(1).                        02830002
028400                                                                  02840000
028500 01  INCOMM-BITMAP-AREA.                                          02850048
028600   05  RCS-DECIMAL    PIC  9(08) VALUE ZEROES.                    02860000
028700   05  FILLER REDEFINES RCS-DECIMAL.                              02870000
028800       10 RCS-DECIMALX   PIC  X(08).                              02880000
028900   05  RCS-FULL       PIC  X(08) VALUE SPACES.                    02890000
029000   05 RCS-HEX-VALUE  PIC X(2)    VALUE SPACES.                    02900000
029100   05 WS-POS         PIC 9(1)    VALUE ZEROES.                    02910000
029200   05 RCS-REST       PIC 9(2)    VALUE ZEROES.                    02920000
029300   05 RCS-INTEGER    PIC 9(5)V99 VALUE ZEROES.                    02930000
029400   05 FILLER REDEFINES RCS-INTEGER.                               02940000
029500       15 RCS-INTEGER-WHOLE PIC 9(5).                             02950000
029600       15 RCS-INTEGER-REMAIN PIC 9(2).                            02960000
029700                                                                  02970000
029800 01  MISCELLANEOUS-WORK-AREA.                                     02980000
029900     05  WS-COMP-FIELD         PIC S9(4) COMP                     02990000
030000                                         VALUE 15.                03000000
030100     05  FILLER  REDEFINES  WS-COMP-FIELD.                        03010000
030200         10  FILLER            PIC X.                             03020000
030300         10  WS-HEX-0F         PIC X.                             03030000
030400     05  WS-FROM-FIELD.                                           03040000
030500         10  WS-FROM-8         PIC X(8).                          03050000
030600         10  WS-FROM-1         PIC X.                             03060000
030700     05  WS-TO-FIELD.                                             03070000
030800         10  WS-TO-16          PIC X(16).                         03080000
030900         10  WS-TO-2           PIC XX.                            03090000
031000     05  WS-EBCDIC-16-AND-ZERO.                                   03100000
031100         10  WS-EBCDIC-16      PIC X(16).                         03110000
031200         10  WS-EBCDIC-16-ZERO PIC X.                             03120000
031300     05  WS-EBCDIC-16-NUMERIC  REDEFINES  WS-EBCDIC-16-AND-ZERO   03130000
031400                               PIC 9(17).                         03140000
031500     05  WS-EBCDIC-16-TO-BCD   PIC 9(17) COMP-3.                  03150000
031600     05  FILLER  REDEFINES  WS-EBCDIC-16-TO-BCD.                  03160000
031700         10  WS-BCD-16         PIC X(8).                          03170000
031800         10  WS-BCD-16-ZERO    PIC X.                             03180000
031900     05  WS-SECONDARY-BITMAP   PIC X(16).                         03190000
032000                                                                  03200000
032100                                                                  03210000
032200*---------------------------------------------------------        03220000
032300 01  LM-LOG-MESSAGE.                                              03230000
032400     05  LM-MESSAGE-NUMBER            PIC X(02) VALUE '99'.       03240000
032500     05  LM-LOG-DISPLAY-MESSAGE.                                  03250000
032600         10  LM-DM-AUTH-TYPE          PIC X(3)  VALUE 'SV '.      03260000
032700         10  FILLER                   PIC X(3)  VALUE SPACES.     03270000
032800             88  LM-DM-REQ                      VALUE 'REQ'.      03280000
032900             88  LM-DM-RSP                      VALUE 'RSP'.      03290000
033000         10  FILLER                   PIC X(1)  VALUE SPACES.     03300000
033100         10  FILLER                   PIC X(3)  VALUE SPACES.     03310000
033200             88  LM-DM-BALINQ                   VALUE 'BAL'.      03320000
033300             88  LM-DM-TENDER                   VALUE 'TND'.      03330000
033400             88  LM-DM-PREAUTH                  VALUE 'PRE'.      03340000
033500             88  LM-DM-ISSUE                    VALUE 'ISS'.      03350000
033600             88  LM-DM-NETWORK                  VALUE 'NET'.      03360000
033700             88  LM-DM-REVERSAL                 VALUE 'REV'.      03370000
033800             88  LM-DM-UNKNOWN                  VALUE '???'.      03380000
033900             88  LM-DM-VOID-ISSUE               VALUE 'VIS'.      03390000
034000             88  LM-DM-VOID-TENDER              VALUE 'VTN'.      03400000
034100         10  FILLER                   PIC X(1)  VALUE SPACES.     03410000
034200         10  FILLER                   PIC X(3)  VALUE SPACES.     03420000
034300             88  LM-DM-KMRC-MSG                 VALUE 'KC '.      03430000
034400             88  LM-DM-GC-MSG                   VALUE 'GC '.      03440000
034500             88  LM-DM-REQUEST-MSG              VALUE SPACES.     03450000
034600         10  FILLER                   PIC X(3)  VALUE SPACES.     03460000
034700             88  LM-DM-RC-DISPLAY               VALUE 'RC:'.      03470000
034800         10  LM-DM-RESP-CD            PIC X(2)  VALUE SPACES.     03480000
034900         10  FILLER                   PIC X(1)  VALUE SPACES.     03490000
035000         10  LM-DM-STORE-NBR          PIC X(4)  VALUE SPACES.     03500000
035100         10  FILLER                   PIC X(1)  VALUE '/'.        03510000
035200         10  LM-DM-TERM-NBR           PIC X(4)  VALUE SPACES.     03520000
035300         10  FILLER                   PIC X(1)  VALUE '/'.        03530000
035400         10  LM-DM-TRAN-NBR           PIC X(4)  VALUE SPACES.     03540000
035500         10  FILLER                   PIC X(1)  VALUE SPACES.     03550000
035600         10  LM-DM-ACCOUNT-NBR        PIC X(19) VALUE SPACES.     03560000
035700         10  FILLER                   PIC X(8)  VALUE             03570000
035800                                                ' TRNAMT='.       03580000
035900         10  LM-DM-TRAN-AMOUNT       PIC -Z(3)9.99 VALUE ZERO.    03590000
036000         10  FILLER                   PIC X(10)  VALUE            03600000
036100                                                ' APRVAMT='.      03610000
036200         10  LM-DM-APPROVE-AMOUNT    PIC -Z(3)9.99 VALUE ZERO.    03620000
036300         10  FILLER                   PIC X(5)  VALUE             03630000
036400                                                ' BAL='.          03640000
036500         10  LM-DM-BALANCE           PIC -Z(3)9.99 VALUE ZERO.    03650000
036600                                                                  03660000
036700 01  FW-FIELD-WORK-AREA.                                          03670000
036800     05  FW-KMC-ID-INT           PIC 9(19) VALUE ZEROS.           03680000
036900                                                                  03690000
037000 01  CD-CURRENT-DATE-AREA.                                        03700000
037100     05  CD-CURRENT-DATE-YYYYMMDD-X.                              03710000
037200         10  CD-CURRENT-YEAR     PIC 9(4)     VALUE ZERO.         03720000
037300         10  CD-CURRENT-MONTH    PIC 9(2)     VALUE ZERO.         03730000
037400         10  CD-CURRENT-DAY      PIC 9(2)     VALUE ZERO.         03740000
037500     05  CD-DB2-DATE-FORMAT.                                      03750000
037600         10  CD-YYYY             PIC 9(4)     VALUE ZEROS.        03760000
037700         10  FILLER              PIC X(1)     VALUE '-'.          03770000
037800         10  CD-MM               PIC 9(2)     VALUE ZEROS.        03780000
037900         10  FILLER              PIC X(1)     VALUE '-'.          03790000
038000         10  CD-DD               PIC 9(2)     VALUE ZEROS.        03800000
038100     05  PV-AUTH-TIME.                                            03810000
038200         10  PV-AUTH-TIME-HH     PIC  X(2)    VALUE ZEROS.        03820000
038300         10  PV-AUTH-TIME-MM     PIC  X(2)    VALUE ZEROS.        03830000
038400         10  PV-AUTH-TIME-SS     PIC  X(2)    VALUE ZEROS.        03840000
038500                                                                  03850000
038600 01  AM-AUTH-MESSAGE-ERROR-MESSAGE.                               03860000
038700     05  FILLER                  PIC X(21)    VALUE               03870000
038800         'AUTHORIZATION MSG = ('.                                 03880000
038900     05  AM-POS-INQ-REMOTE-AUTH-MSG                               03890000
039000                                 PIC X(85)    VALUE SPACES.       03900000
039100     05  FILLER                  PIC X(1)     VALUE ')'.          03910000
039200                                                                  03920000
039300 01  DE-DB2-ERROR-MESSAGE.                                        03930000
039400     05  FILLER                  PIC X(11)    VALUE               03940000
039500         'SQLCODE = ('.                                           03950000
039600     05  DE-SQLCODE              PIC Z(8)9-   VALUE ZERO.         03960000
039700     05  FILLER                  PIC X(21)    VALUE               03970000
039800         ')  ROWS PROCESSED = ('.                                 03980000
039900     05  DE-ROWS-PROCESSED       PIC Z(8)9-   VALUE ZERO.         03990000
040000     05  FILLER                  PIC X(25)    VALUE ')'.          04000000
040100                                                                  04010000
040200 01  DW-DB2-WARNING-MESSAGE.                                      04020000
040300     05  FILLER                  PIC X(11)    VALUE               04030000
040400         'SQLCODE = ('.                                           04040000
040500     05  DW-SQLCODE              PIC Z(8)9-   VALUE ZERO.         04050000
040600     05  FILLER                  PIC X(21)    VALUE               04060000
040700         ')  ROWS PROCESSED = ('.                                 04070000
040800     05  DW-ROWS-PROCESSED       PIC Z(8)9-   VALUE ZERO.         04080000
040900     05  FILLER                  PIC X(14)    VALUE               04090000
041000         ')  SQLWARN = ('.                                        04100000
041100     05  DW-SQLWARN              PIC X(8)     VALUE ZERO.         04110000
041200     05  FILLER                  PIC X(3)     VALUE ')'.          04120000
041300                                                                  04130000
041400 01  DS-DB2-SQLERRMC-MESSAGE.                                     04140000
041500     05  FILLER                  PIC X(11)    VALUE               04150000
041600         'SQLERRMC = '.                                           04160000
041700     05  DS-SQLERRMC             PIC X(66)    VALUE SPACES.       04170000
041800                                                                  04180000
041900 01  AA-ATTEMPTED-ACTION-MESSAGE.                                 04190000
042000     05  FILLER                  PIC X(14)    VALUE               04200000
042100         'ATTEMPTING TO '.                                        04210000
042200     05  AA-ATTEMPTED-ACTION     PIC X(90)    VALUE SPACES.       04220000
042300                                                                  04230000
042400*                                                                 04240000
042500*  SQL AND COBOL DECLARATIONS FOR THE STORED VALUE ACTIVITY TABLE 04250000
042600*                                                                 04260000
042700     EXEC SQL                                                     04270000
042800         INCLUDE SVT00002                                         04280000
042900     END-EXEC.                                                    04290000
043000                                                                  04300000
043100*                                                                 04310000
043200*  STORED VALUE LOCK TABLE                                        04320000
043300*                                                                 04330000
043400     EXEC SQL                                                     04340000
043500         INCLUDE SVT00004                                         04350000
043600     END-EXEC.                                                    04360000
043700*                                                                 04370000
043800*  STORED VALUE CARD TABLE                                        04380000
043900*                                                                 04390000
044000     EXEC SQL                                                     04400000
044100         INCLUDE SVT00001                                         04410000
044200     END-EXEC.                                                    04420000
044300*                                                                 04430000
044400*  STORED VALUE CONTROL TABLE                                     04440000
044500*                                                                 04450000
044600     EXEC SQL                                                     04460000
044700         INCLUDE SVT00000                                         04470000
044800     END-EXEC.                                                    04480000
044900                                                                  04490000
045000*                                                                 04500000
045100*  STORED VALUE card stock denomination table                     04510000
045200*                                                                 04520000
045300     EXEC SQL                                                     04530000
045400         INCLUDE SVT00008                                         04540000
045500     END-EXEC.                                                    04550000
045600                                                                  04560000
045700*                                                                 04570000
045800*  STORED VALUE 3rd Party Transaction Info Table                  04580000
045900*                                                                 04590000
046000     EXEC SQL                                                     04600000
046100         INCLUDE SVT00015                                         04610000
046200     END-EXEC.                                                    04620000
046300                                                                  04630000
046400*                                                                 04640000
046500*  STATE TABLE Used for verifying state code                      04650000
046600*                                                                 04660000
046700     EXEC SQL                                                     04670000
046800         INCLUDE TSTATE                                           04680000
046900     END-EXEC.                                                    04690000
047000                                                                  04700000
047100*  STANDARD LAYOUT FOR THE SQL COMMUNICATION AREA.                04710000
047200                                                                  04720000
047300     EXEC SQL                                                     04730000
047400         INCLUDE SQLCA                                            04740000
047500     END-EXEC.                                                    04750000
047600                                                                  04760000
047700                                                                  04770000
047800* DATA AREA USED BY SV005-A100-MAINLINE.                          04780000
047900     COPY SVWS005.                                                04790000
048000                                                                  04800000
048100* DATA AREA USED BY SV006-A100-MAINLINE.                          04810000
048200     COPY SVWS006.                                                04820000
048300                                                                  04830000
048400*----------------------------------------------------------------*04840000
048500* CONVERT CARD NUMBER WORKING STORAGE AREA                       *04850000
048600*----------------------------------------------------------------*04860000
048700     COPY SVWS007.                                                04870000
048800                                                                  04880000
048900* DATA AREA USED BY THE CHECK DIGIT ROUTINE IN SVPD006.           04890000
049000     COPY DPWS036.                                                04900076
049100                                                                  04910000
049200*----------------------------------------------------------------*04920000
049300 LINKAGE SECTION.                                                 04930000
049400******************************************************************04940000
049500 PROCEDURE DIVISION.                                              04950000
049600******************************************************************04960000
049700 0000-MAINLINE.                                                   04970000
049800                                                                  04980000
049900     PERFORM 1000-INITIALIZE.                                     04990000
050000                                                                  05000000
050100*   IF THIS IS A GIFT CARD ISSUE REQUEST, THEN AUTHORIZE          05010000
050200*   IT. OTHERWISE IT MUST BE A NETWORK ECHO MESSAGE.              05020000
050300                                                                  05030000
050400     IF AURD017-MID-0100 OR AURD017-MID-0200 OR AURD017-MID-0400  05040000
050500         PERFORM 2000-AUTHORIZE-REQUEST                           05050000
050600     END-IF.                                                      05060000
050700                                                                  05070000
050800*  FORMAT AND SEND AN AUTHORIZATION RESPONSE TO THE ISP.          05080000
050900*  CHECK FOR AUTH INQUIRY OR NETWORK MESSAGE TYPE                 05090000
051000*                                                                 05100000
051100*  RESPONSES ARE ONLY SENT FOR APPROVALS AND DECLINES,            05110000
051200*  ANY SYSTEM ERROR DOES NOT SEND A RESPONSE SO THAT              05120000
051300*  INCOMM WILL TIME OUT AND STORE-AND-FORWARD THE TRANSACTION.    05130000
051400     IF AURD017-MID-0100 OR AURD017-MID-0200 OR AURD017-MID-0400  05140000
051500         IF SV005-APPROVE OR SV005-HARD-DECLINE                   05150000
051600             IF AURD017-MID-0100                                  05160000
051700                 PERFORM 5000-FORMAT-0110-PRE-AUTH-RESP           05170000
051800             ELSE                                                 05180000
051900               IF AURD017-MID-0200                                05190000
052000                  PERFORM 5100-FORMAT-0210-AUTH-RESP              05200000
052100               ELSE                                               05210000
052200                   IF AURD017-MID-0400                            05220000
052300                         PERFORM 5200-FORMAT-0400-RVSL-RESP       05230000
052400                   END-IF                                         05240000
052500               END-IF                                             05250000
052600             END-IF                                               05260000
052700         END-IF                                                   05270000
052800*   * AT END OF THE TRANSACTION (WHETHER IT                       05280000
052900*   * COMPLETES SUCCESSFULLY OR NOT), THE SVT_CRD_ACCT_LCK ROW    05290000
053000*   * MUST STILL BE DELETED.                                      05300000
053100        IF PV-TABLE-LOCK                                          05310000
053200         PERFORM 4500-DELETE-KMC-LOCK-TABLE                       05320000
053300        END-IF                                                    05330000
053400     ELSE                                                         05340000
053500         PERFORM 5300-FORMAT-0810-NETMGMT-RESP                    05350000
053600     END-IF.                                                      05360000
053700*                                                                 05370000
053800*  COMMIT ALL CHANGES BEFORE  TERMINATING THE TRANSACTION.        05380000
053900*                                                                 05390000
054000     EXEC CICS                                                    05400000
054100         SYNCPOINT                                                05410000
054200     END-EXEC.                                                    05420000
054300                                                                  05430000
054400* DISPLAY EPCL RESPONSE LOG MESSAGE                               05440000
054500     SET LM-DM-RSP TO TRUE.                                       05450000
054600     PERFORM 8500-MESSAGE-MONITORING.                             05460000
054700                                                                  05470000
054800     GOBACK.                                                      05480000
054900                                                                  05490000
055000*----------------------------------------------------------------*05500000
055100* INITIALIZE                                                     *05510000
055200*----------------------------------------------------------------*05520000
055300 1000-INITIALIZE.                                                 05530000
055400     INITIALIZE SV005-KMC-AUTH-PARAMETERS.                        05540000
055500                                                                  05550000
055600     PERFORM EP000-0000-INITIALIZE.                               05560000
055700                                                                  05570000
055800     MOVE EP000-DT-CURR-DATE-YYYYMMDD                             05580000
055900         TO CD-CURRENT-DATE-YYYYMMDD-X.                           05590000
056000     MOVE CD-CURRENT-YEAR   TO  CD-YYYY.                          05600000
056100     MOVE CD-CURRENT-MONTH  TO  CD-MM.                            05610000
056200     MOVE CD-CURRENT-DAY    TO  CD-DD.                            05620000
056300                                                                  05630000
056400     SET SV005-PS-TENDER-W-NO-ISSUE TO TRUE.                      05640003
056500     SET SV005-PS-NOT-ADD-ON        TO TRUE.                      05650047
056600     SET SV005-DEACTIVATION-NO      TO TRUE.                      05660047
056700     SET SV005-DEACT-REV-NO         TO TRUE.                      05670047
056800     SET SV005-VALID-DEACT-NO       TO TRUE.                      05680047
056900     SET SV005-DEACTIVATION-NO      TO TRUE.                      05690047
057000     SET SV005-PS-INACTIVE-NO       TO TRUE.                      05700047
057100     SET PV-TABLE-LOCK              TO TRUE.                      05710047
057200                                                                  05720000
057300     PERFORM 7000-RETRIEVE-AUTH-REQUEST.                          05730000
057400     PERFORM 7100-IDENTIFY-FIELDS.                                05740000
057500     PERFORM 1100-DETERMINE-MSG-TYPE.                             05750000
057600                                                                  05760000
057700*----------------------------------------------------------------*05770000
057800* DETERMINE MESSAGE TYPE                                         *05780000
057900* The message can either be a PreAuthorization (100),            *05790000
058000* Authorization (200), Reversals (400) and Network Management  *  05800000
058100* Request (800).                                                 *05810000
058200*----------------------------------------------------------------*05820000
058300 1100-DETERMINE-MSG-TYPE.                                         05830000
058400     EVALUATE TRUE                                                05840000
058500       WHEN AURD017-MID-0100                                      05850000
058600       WHEN AURD017-MID-0200                                      05860000
058700         PERFORM 1200-VERIFY-AUTH-REQUEST-MSG                     05870000
058800       WHEN AURD017-MID-0400                                      05880000
058900         PERFORM 1300-VERIFY-0400-RVSL-REQ-MSG                    05890000
059000       WHEN OTHER                                                 05900000
059100         SET PV-INVALID-REQUEST-TYPE TO TRUE                      05910000
059200     END-EVALUATE.                                                05920000
059300                                                                  05930000
059400*---------------------------------------------------------------* 05940000
059500*  VERIFY 0100 REQUEST MESSAGE                                  * 05950000
059600*  VERIFY 0200 REQUEST MESSAGE                                  * 05960000
059700* MOVE DATA FROM INPUT MESSAGE INTO WORKING FIELDS.             * 05970000
059800* VERIFY THAT DATA IS VALID.                                    * 05980000
059900*---------------------------------------------------------------* 05990000
060000 1200-VERIFY-AUTH-REQUEST-MSG.                                    06000000
060100     MOVE AU015-B2-ACCOUNT-NBR TO FW-KMC-ID-INT                   06010000
060200     MOVE FW-KMC-ID-INT TO LM-DM-ACCOUNT-NBR.                     06020000
060300                                                                  06030000
060400* SET PROCESSING CODE TO ONLINE                                   06040000
060500     SET  PV-SPC-ONLINE-NORMAL TO TRUE.                           06050000
060600                                                                  06060000
060700* MOVE STORE NUMBER                                               06070000
060800     MOVE SV004-INCOMM-LOCATION TO SV005-STORE-NBR.               06080000
060900                                                                  06090000
061000* MOVE TERMINAL NUMBER                                            06100000
061100     INSPECT AU015-B41-STORE-NBR REPLACING LEADING " " BY "0"     06110000
061200     IF AU015-B41-STORE-NBR-N NUMERIC                             06120027
061300         MOVE AU015-B41-STORE-NBR TO SV005-TERMINAL-NBR           06130027
061400     ELSE                                                         06140027
061500         MOVE ZEROES              TO SV005-TERMINAL-NBR           06150027
061600     END-IF.                                                      06160027
061700                                                                  06170000
061800* MOVE TRANSACTION NUMBER                                         06180000
061900     INSPECT AU015-B41-TERMINAL-ID REPLACING LEADING " " BY "0"   06190000
062000     IF AU015-B41-TERM-ID-N  NUMERIC                              06200027
062100         MOVE AU015-B41-TERMINAL-ID TO SV005-TRANSACTION-NBR      06210027
062200     ELSE                                                         06220027
062300         MOVE ZEROES                TO SV005-TRANSACTION-NBR      06230027
062400     END-IF.                                                      06240027
062500                                                                  06250000
062600* DETERMINE TRANSACTION TYPE AND CARD TYPE                        06260000
062700     IF (AU015-B3-PROCESSING-CODE IS NUMERIC)                     06270000
062800       IF (AU015-CARD-ACTIVATION) OR                              06280000
062900          (AU015-VAR-CARD-ISSUE) OR                               06290000
063000          (AU015-CARD-DEACTIVE)                                   06300000
063100          SET PV-ISSUANCE-AS-GIFT-CARD TO TRUE                    06310000
063200       ELSE                                                       06320000
063300          SET SV005-HARD-DECLINE TO TRUE                          06330000
063400          SET AU015-NOT-SUPP     TO TRUE                          06340000
063500          SET PV-NO-TABLE-LOCK   TO TRUE                          06350000
063600       END-IF                                                     06360000
063700     ELSE                                                         06370000
063800          SET SV005-HARD-DECLINE TO TRUE                          06380000
063900          SET AU015-NOT-SUPP     TO TRUE                          06390000
064000          SET PV-NO-TABLE-LOCK   TO TRUE                          06400000
064100     END-IF.                                                      06410000
064200                                                                  06420000
064300* SET REVERSAL-IND                                                06430000
064400                                                                  06440000
064500     SET PV-NORMAL TO TRUE.                                       06450000
064600                                                                  06460000
064700     IF (AU015-CARD-DEACTIVE)                                     06470000
064800        SET PV-REVERSAL TO TRUE                                   06480000
064900        SET SV005-DEACTIVATION   TO TRUE                          06490022
065000     END-IF.                                                      06500000
065100                                                                  06510000
065200* MOVE TRANSACTION AMOUNT                                         06520000
065300                                                                  06530007
065400     IF AU015-B4-TRANSACTION-AMOUNT NUMERIC                       06540000
065500         MOVE AU015-B4-TRANSACTION-AMOUNT TO PV-KMC-AMT           06550009
065600                                           PV-ELEMENT-AMT         06560007
065700     ELSE                                                         06570000
065800         MOVE ZEROES                      TO PV-KMC-AMT           06580000
065900                                           PV-ELEMENT-AMT         06590007
066000     END-IF.                                                      06600000
066100                                                                  06610000
066200* MOVE STATE ID                                                   06620007
066300     MOVE SPACES TO PV-STATE-CD.                                  06630068
066400                                                                  06640000
066500* DETERMINE KEYED OR SWIPED.  NOT ALL MERCHANTS USE THIS FIELD    06650000
066600* SO IF THEY DON'T HAVE IT SET WE WILL DEFAULT TO SCANNED.        06660000
066700                                                                  06670000
066800     IF AU014-PRI-BITF-22 = "Y"                                   06680000
066900       IF AU015-MAG-STRIPE-READ OR AU015-BARCODE                  06690000
067000          SET PV-KMC-SCANNED TO TRUE                              06700000
067100       ELSE                                                       06710000
067200        IF AU015-KEY-ENTERED                                      06720065
067300          SET PV-KMC-KEY-ENTERED TO TRUE                          06730000
067400          SET SV005-HARD-DECLINE TO TRUE                          06740000
067500          SET AU015-INV-TRAN     TO TRUE                          06750000
067600          SET PV-NO-TABLE-LOCK   TO TRUE                          06760000
067700        ELSE                                                      06770065
067800          SET PV-KMC-KEY-ENTERED TO TRUE                          06780000
067900          SET SV005-HARD-DECLINE TO TRUE                          06790000
068000          SET AU015-INV-TRAN     TO TRUE                          06800000
068100          SET PV-NO-TABLE-LOCK   TO TRUE                          06810000
068200        END-IF                                                    06820065
068300       END-IF                                                     06830000
068400     ELSE                                                         06840000
068500        SET PV-KMC-SCANNED TO TRUE                                06850000
068600     END-IF.                                                      06860000
068700                                                                  06870000
068800* CONVERT CARD NUMBER                                             06880021
068900     PERFORM 1500-CONVERT-CARD-NBR.                               06890021
069000     MOVE PV-KMC-ID              TO SV005-KMC-ID.                 06900023
069100                                                                  06910021
069200     IF (AU014-PRI-BITF-42 = "Y")                                 06920029
069300        MOVE AU015-B42-CAT-ID-CDE      TO PV-DIV-ID               06930029
069400     ELSE                                                         06940028
069500        MOVE SPACES                    TO PV-DIV-ID               06950028
069600     END-IF.                                                      06960028
069700**THE STAN (SYS TRAN AUDIT NUM) MUST BE FILLED OR WILL DECLINE    06970000
069800                                                                  06980000
069900     IF AU014-PRI-BITF-11 = "Y"                                   06990000
070000        IF AU015-B11-SYS-AUDIT-NUM NUMERIC                        07000000
070100           IF AU015-B11-SYS-AUDIT-NUM > 0                         07010000
070200             MOVE AU015-B11-SYS-AUDIT-NUM TO                      07020000
070300                                  SV005-PV-STAN-NBR9              07030000
070400           ELSE                                                   07040000
070500             SET SV005-HARD-DECLINE TO TRUE                       07050000
070600             SET AU015-INV-TRAN     TO TRUE                       07060000
070700             SET PV-NO-TABLE-LOCK   TO TRUE                       07070000
070800           END-IF                                                 07080000
070900        ELSE                                                      07090000
071000          SET SV005-HARD-DECLINE TO TRUE                          07100000
071100          SET AU015-INV-TRAN     TO TRUE                          07110000
071200          SET PV-NO-TABLE-LOCK   TO TRUE                          07120000
071300        END-IF                                                    07130000
071400     ELSE                                                         07140000
071500        SET SV005-HARD-DECLINE TO TRUE                            07150000
071600        SET AU015-INV-TRAN     TO TRUE                            07160000
071700        SET PV-NO-TABLE-LOCK   TO TRUE                            07170000
071800     END-IF.                                                      07180000
071900                                                                  07190000
072000     IF (AU014-PRI-BITF-49 = "Y") AND                             07200000
072100        (AU015-B49-CURRENCY-CODE = "USD")                         07210000
072200             CONTINUE                                             07220000
072300     ELSE                                                         07230000
072400        SET SV005-HARD-DECLINE TO TRUE                            07240000
072500        SET AU015-INV-TRAN     TO TRUE                            07250000
072600        SET PV-NO-TABLE-LOCK   TO TRUE                            07260000
072700     END-IF.                                                      07270000
072800                                                                  07280000
072900* MOVE LOCAL DATE                                                 07290000
073000* IF LOCAL DATE IS NOT ZEROS, MOVE TO POS DATE.                   07300000
073100* IF IT IS ZEROS, THEN POS DATE WILL BE THE CURRENT DATE.         07310000
073200* (CURRENT DATE IS DEFAULTED AND MOVED IN PARAG 1000-INIT)        07320000
073300     IF AU015-B13-LOCAL-TRANS-DATE NUMERIC                        07330000
073400       IF AU015-B13-LOCAL-TRANS-DATE NOT = ZEROS                  07340000
073500         MOVE AU015-B13-LOCAL-TRANS-DATE(7:2)  TO CD-DD           07350000
073600         MOVE AU015-B13-LOCAL-TRANS-DATE(5:2)  TO CD-MM           07360000
073700         MOVE AU015-B13-LOCAL-TRANS-DATE(1:4)  TO CD-YYYY         07370000
073800       END-IF                                                     07380000
073900     END-IF.                                                      07390000
074000                                                                  07400000
074100     MOVE CD-DB2-DATE-FORMAT     TO SV005-POS-DATE.               07410000
074200                                                                  07420000
074300* DISPLAY EPCL REQUEST LOG MESSAGE                                07430000
074400     SET LM-DM-REQ TO TRUE.                                       07440000
074500     PERFORM 8500-MESSAGE-MONITORING.                             07450000
074600                                                                  07460000
074700*---------------------------------------------------------------* 07470000
074800*  VERIFY 0400 REVERSAL REQUEST MESSAGE                           07480000
074900* MOVE DATA FROM INPUT MESSAGE INTO WORKING FIELDS.             * 07490000
075000* VERIFY THAT DATA IS VALID.                                    * 07500000
075100*---------------------------------------------------------------* 07510000
075200 1300-VERIFY-0400-RVSL-REQ-MSG.                                   07520000
075300                                                                  07530000
075400     MOVE AU015-B2-ACCOUNT-NBR TO FW-KMC-ID-INT                   07540000
075500     MOVE FW-KMC-ID-INT TO LM-DM-ACCOUNT-NBR.                     07550000
075600                                                                  07560000
075700* SET PROCESSING CODE TO ONLINE                                   07570000
075800     SET  PV-SPC-ONLINE-NORMAL TO TRUE.                           07580000
075900                                                                  07590000
076000* MOVE STORE NUMBER                                               07600000
076100     MOVE SV004-INCOMM-LOCATION TO SV005-STORE-NBR.               07610000
076200                                                                  07620000
076300* MOVE TERMINAL NUMBER                                            07630000
076400     INSPECT AU015-B41-STORE-NBR REPLACING LEADING " " BY "0"     07640033
076500     IF AU015-B41-STORE-NBR-N NUMERIC                             07650033
076600         MOVE AU015-B41-STORE-NBR TO SV005-TERMINAL-NBR           07660033
076700     ELSE                                                         07670033
076800         MOVE ZEROES              TO SV005-TERMINAL-NBR           07680033
076900     END-IF.                                                      07690033
077000                                                                  07700033
077100* MOVE TRANSACTION NUMBER                                         07710033
077200     INSPECT AU015-B41-TERMINAL-ID REPLACING LEADING " " BY "0"   07720033
077300     IF AU015-B41-TERM-ID-N  NUMERIC                              07730033
077400         MOVE AU015-B41-TERMINAL-ID TO SV005-TRANSACTION-NBR      07740033
077500     ELSE                                                         07750033
077600         MOVE ZEROES                TO SV005-TRANSACTION-NBR      07760033
077700     END-IF.                                                      07770033
077800                                                                  07780033
077900                                                                  07790000
078000* DETERMINE TRANSACTION TYPE AND CARD TYPE                        07800000
078100     IF (AU015-B3-PROCESSING-CODE IS NUMERIC)                     07810000
078200       IF (AU015-CARD-ACTIVATION) OR                              07820000
078300          (AU015-VAR-CARD-ISSUE) OR                               07830000
078400          (AU015-CARD-DEACTIVE)                                   07840000
078500          SET PV-ISSUANCE-AS-GIFT-CARD TO TRUE                    07850000
078600       ELSE                                                       07860000
078700          SET SV005-HARD-DECLINE TO TRUE                          07870000
078800          SET AU015-NOT-SUPP     TO TRUE                          07880000
078900          SET PV-NO-TABLE-LOCK   TO TRUE                          07890000
079000       END-IF                                                     07900000
079100     ELSE                                                         07910000
079200          SET SV005-HARD-DECLINE TO TRUE                          07920000
079300          SET AU015-NOT-SUPP     TO TRUE                          07930000
079400          SET PV-NO-TABLE-LOCK   TO TRUE                          07940000
079500     END-IF.                                                      07950000
079600                                                                  07960000
079700* SET REVERSAL-IND                                                07970000
079800                                                                  07980000
079900     SET PV-REVERSAL TO TRUE                                      07990000
080000                                                                  08000000
080100     IF (AU015-CARD-DEACTIVE)                                     08010022
080200        SET SV005-DEACT-REV          TO TRUE                      08020022
080300     END-IF.                                                      08030022
080400                                                                  08040000
080500                                                                  08050000
080600* MOVE TRANSACTION AMOUNT                                         08060000
080700     IF AU015-B4-TRANSACTION-AMOUNT NUMERIC                       08070007
080800         MOVE AU015-B4-TRANSACTION-AMOUNT TO PV-KMC-AMT           08080009
080900                                           PV-ELEMENT-AMT         08090007
081000     ELSE                                                         08100007
081100         MOVE ZEROES                      TO PV-KMC-AMT           08110007
081200                                           PV-ELEMENT-AMT         08120007
081300     END-IF.                                                      08130007
081400                                                                  08140007
081500                                                                  08150000
081600* MOVE STATE ID                                                   08160000
081700     MOVE SPACES TO PV-STATE-CD.                                  08170068
081800                                                                  08180000
081900* DETERMINE KEYED OR SWIPED.  NOT ALL MERCHANTS USE THIS FIELD    08190000
082000* SO IF THEY DON'T HAVE IT SET WE WILL DEFAULT TO SCANNED.        08200000
082100                                                                  08210000
082200     IF AU014-PRI-BITF-22 = "Y"                                   08220000
082300       IF AU015-MAG-STRIPE-READ OR AU015-BARCODE                  08230000
082400          SET PV-KMC-SCANNED TO TRUE                              08240000
082500       ELSE                                                       08250000
082600        IF AU015-KEY-ENTERED                                      08260065
082700          SET PV-KMC-KEY-ENTERED TO TRUE                          08270000
082800             SET SV005-HARD-DECLINE TO TRUE                       08280000
082900             SET AU015-INV-TRAN     TO TRUE                       08290000
083000             SET PV-NO-TABLE-LOCK   TO TRUE                       08300000
083100        ELSE                                                      08310065
083200          SET PV-KMC-KEY-ENTERED TO TRUE                          08320000
083300             SET SV005-HARD-DECLINE TO TRUE                       08330000
083400             SET AU015-INV-TRAN     TO TRUE                       08340000
083500             SET PV-NO-TABLE-LOCK   TO TRUE                       08350000
083600        END-IF                                                    08360065
083700       END-IF                                                     08370000
083800     ELSE                                                         08380000
083900        SET PV-KMC-SCANNED TO TRUE                                08390000
084000     END-IF.                                                      08400000
084100                                                                  08410000
084200* CONVERT CARD NUMBER                                             08420021
084300     PERFORM 1500-CONVERT-CARD-NBR.                               08430021
084400     MOVE PV-KMC-ID              TO SV005-KMC-ID.                 08440023
084500                                                                  08450021
084600     IF (AU014-PRI-BITF-42 = "Y")                                 08460029
084700        MOVE AU015-B42-CAT-ID-CDE      TO PV-DIV-ID               08470029
084800     ELSE                                                         08480029
084900        MOVE SPACES                    TO PV-DIV-ID               08490029
085000     END-IF.                                                      08500029
085100**THE STAN (SYS TRAN AUDIT NUM) MUST BE FILLED OR WILL DECLINE    08510000
085200                                                                  08520000
085300     IF AU014-PRI-BITF-11 = "Y"                                   08530000
085400        IF AU015-B11-SYS-AUDIT-NUM NUMERIC                        08540000
085500           IF AU015-B11-SYS-AUDIT-NUM > 0                         08550000
085600             MOVE AU015-B11-SYS-AUDIT-NUM TO                      08560000
085700                                  SV005-PV-STAN-NBR9              08570000
085800             PERFORM 7900-INCOMM-FIND-STAN                        08580012
085900             IF PV-STAN-FOUND                                     08590049
086000                 CONTINUE                                         08600012
086100             ELSE                                                 08610015
086200                SET SV005-HARD-DECLINE TO TRUE                    08620015
086300                SET AU015-INV-TRAN     TO TRUE                    08630015
086400                SET PV-NO-TABLE-LOCK   TO TRUE                    08640015
086500             END-IF                                               08650012
086600           ELSE                                                   08660000
086700             SET SV005-HARD-DECLINE TO TRUE                       08670000
086800             SET AU015-INV-TRAN     TO TRUE                       08680000
086900             SET PV-NO-TABLE-LOCK   TO TRUE                       08690000
087000           END-IF                                                 08700000
087100        ELSE                                                      08710000
087200          SET SV005-HARD-DECLINE TO TRUE                          08720000
087300          SET AU015-INV-TRAN     TO TRUE                          08730000
087400          SET PV-NO-TABLE-LOCK   TO TRUE                          08740000
087500        END-IF                                                    08750000
087600     ELSE                                                         08760000
087700        SET SV005-HARD-DECLINE TO TRUE                            08770000
087800        SET AU015-INV-TRAN     TO TRUE                            08780000
087900        SET PV-NO-TABLE-LOCK   TO TRUE                            08790000
088000     END-IF.                                                      08800000
088100                                                                  08810000
088200     IF (AU014-PRI-BITF-49 = "Y") AND                             08820000
088300        (AU015-B49-CURRENCY-CODE = "USD")                         08830000
088400             CONTINUE                                             08840000
088500     ELSE                                                         08850000
088600        SET SV005-HARD-DECLINE TO TRUE                            08860000
088700        SET AU015-INV-TRAN     TO TRUE                            08870000
088800        SET PV-NO-TABLE-LOCK   TO TRUE                            08880000
088900     END-IF.                                                      08890000
089000                                                                  08900000
089100* MOVE LOCAL DATE                                                 08910000
089200* IF LOCAL DATE IS NOT ZEROS, MOVE TO POS DATE.                   08920000
089300* IF IT IS ZEROS, THEN POS DATE WILL BE THE CURRENT DATE.         08930000
089400* (CURRENT DATE IS DEFAULTED AND MOVED IN PARAG 1000-INIT)        08940000
089500     IF AU015-B13-LOCAL-TRANS-DATE NUMERIC                        08950000
089600       IF AU015-B13-LOCAL-TRANS-DATE NOT = ZEROS                  08960000
089700         MOVE AU015-B13-LOCAL-TRANS-DATE(7:2)     TO CD-DD        08970000
089800         MOVE AU015-B13-LOCAL-TRANS-DATE(5:2)     TO CD-MM        08980000
089900         MOVE AU015-B13-LOCAL-TRANS-DATE(1:4)     TO CD-YYYY      08990000
090000       END-IF                                                     09000000
090100     END-IF.                                                      09010000
090200                                                                  09020000
090300     MOVE CD-DB2-DATE-FORMAT     TO SV005-POS-DATE.               09030000
090400                                                                  09040000
090500* DISPLAY EPCL REQUEST LOG MESSAGE                                09050000
090600     SET LM-DM-REQ TO TRUE.                                       09060000
090700     PERFORM 8500-MESSAGE-MONITORING.                             09070000
090800                                                                  09080000
090900                                                                  09090000
091000*----------------------------------------------------------------*09100000
091100*  CONVERT-CARD-NBR                                              *09110000
091200*  CONVERT CARD FROM 19 DIGITS TO THE STANDARD LENGTH            *09120000
091300*----------------------------------------------------------------*09130000
091400 1500-CONVERT-CARD-NBR.                                           09140000
091500* VERIFY ACCOUNT NUMBER                                           09150000
091600* Routine SV007-FORMAT-CARD is used to get 12-digit               09160000
091700* card number that is used on database.                           09170000
091800*    SET SV003-INCOMM-AUTH-PGM TO TRUE                            09180000
091900     MOVE SV004-PC-INCOMM-CRD-LGTH TO SV007-CARD-NUMBER-LENGTH.   09190000
092000     MOVE FW-KMC-ID-INT TO SV007-CARD-NUMBER-IN.                  09200000
092100     PERFORM SV007-FORMAT-CARD.                                   09210000
092200                                                                  09220000
092300* IF CARD IS INVALID LENGTH, SEND A DECLINE.                      09230000
092400     IF SV007-CARD-NBR > 0                                        09240000
092500         MOVE SV007-CARD-NBR TO PV-KMC-ID                         09250000
092600     ELSE                                                         09260000
092700         SET PS-AUTH-MESSAGE-ERROR                                09270000
092800             SV005-HARD-DECLINE                                   09280000
092900             AU015-INV-CARDNO                                     09290000
093000             PV-NO-TABLE-LOCK                                     09300000
093100             EP000-SL-ERROR  TO TRUE                              09310000
093200         MOVE AURD017-DATA-BUF TO                                 09320000
093300                   AM-POS-INQ-REMOTE-AUTH-MSG                     09330000
093400         MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                09340000
093500         MOVE AM-AUTH-MESSAGE-ERROR-MESSAGE                       09350000
093600             TO   EP000-MD-SYSTEM-LOG-MESSAGE                     09360000
093700                     (EP000-MESSAGE-LINE-COUNTER)                 09370000
093800         ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                 09380000
093900         MOVE SV007-CARD-NUMBER-LENGTH TO                         09390000
094000              PV-DISPLAY-ACCT-LENGTH                              09400000
094100         STRING                                                   09410000
094200             'ACCOUNT '                                           09420000
094300              FW-KMC-ID-INT                                       09430000
094400              ' IS INVALID LENGTH: '                              09440000
094500              PV-DISPLAY-ACCT-LENGTH                              09450000
094600            DELIMITED BY SIZE                                     09460000
094700            INTO EP000-MD-SYSTEM-LOG-MESSAGE                      09470000
094800                     (EP000-MESSAGE-LINE-COUNTER)                 09480000
094900         PERFORM EP000-1000-POST-MESSAGE                          09490000
095000     END-IF.                                                      09500000
095100                                                                  09510000
095200*                                                                 09520000
095300*---------------------------------------------------------------* 09530000
095400* AUTHORIZE REQUEST                                             * 09540000
095500*  AUTHORIZE THE STORED VALUE REQUEST                           * 09550000
095600*---------------------------------------------------------------* 09560000
095700 2000-AUTHORIZE-REQUEST.                                          09570000
095800                                                                  09580000
095900     EVALUATE TRUE                                                09590000
096000        WHEN (NOT SV005-APPROVE)                                  09600000
096100            MOVE ZEROS              TO SV005-APPROVED-TENDER-AMT  09610000
096200            MOVE PV-KMC-AMT         TO SV005-TRANS-AMT            09620000
096300            MOVE ZEROS              TO SV005-KMC-REMAINING-BALANCE09630000
096400            SET SV005-GIFT-CRD      TO TRUE                       09640000
096500                                                                  09650000
096600        WHEN OTHER                                                09660000
096700            PERFORM 2100-AUTHORIZE-KMC                            09670000
096800                                                                  09680004
096900                                                                  09690007
097000* WE DO NOT WANT TO UPDATE THE TABLE FOR A PRE-AUTH 100           09700000
097100         IF (PV-TEST-GIFT-CARD-ACCOUNTS) OR                       09710053
097200               (AURD017-MID-0100)                                 09720000
097300               CONTINUE                                           09730000
097400            ELSE                                                  09740000
097500              EVALUATE TRUE                                       09750000
097600               WHEN SV005-REFERRAL                                09760000
097700               WHEN SV005-PGM-ABEND                               09770000
097800                    SET PS-AUTH-MESSAGE-ERROR                     09780000
097900                        EP000-SL-ERROR TO TRUE                    09790000
098000                    MOVE AURD017-DATA-BUF           TO            09800000
098100                                       AM-POS-INQ-REMOTE-AUTH-MSG 09810000
098200                    MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER     09820000
098300                    MOVE AM-AUTH-MESSAGE-ERROR-MESSAGE            09830000
098400                        TO  EP000-MD-SYSTEM-LOG-MESSAGE           09840000
098500                                (EP000-MESSAGE-LINE-COUNTER)      09850000
098600                    IF SV005-MESSAGE-1 = SPACE AND                09860000
098700                        SV005-MESSAGE-2 = SPACE                   09870000
098800                        ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER  09880000
098900                        MOVE 'UNEXPECTED ABEND IN SVPD005 '       09890000
099000                            TO  EP000-MD-SYSTEM-LOG-MESSAGE       09900000
099100                                    (EP000-MESSAGE-LINE-COUNTER)  09910000
099200                    ELSE                                          09920000
099300                        ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER  09930000
099400                        MOVE SV005-MESSAGE-1                      09940000
099500                            TO  EP000-MD-SYSTEM-LOG-MESSAGE       09950000
099600                                    (EP000-MESSAGE-LINE-COUNTER)  09960000
099700                        ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER  09970000
099800                        MOVE SV005-MESSAGE-2                      09980000
099900                            TO  EP000-MD-SYSTEM-LOG-MESSAGE       09990000
100000                                    (EP000-MESSAGE-LINE-COUNTER)  10000000
100100                    END-IF                                        10010000
100200                    PERFORM EP000-1000-POST-MESSAGE               10020000
100300                                                                  10030000
100400               WHEN SV005-APPROVE                                 10040000
100500                                                                  10050000
100600                   PERFORM 3000-SET-COLUMNS                       10060000
100700                   IF PV-REVERSAL                                 10070000
100800                       IF SV005-DEACT-REV                         10080031
100900                           INITIALIZE PV-RETRY-COUNT              10090034
101000                           PERFORM 7950-INCOMM-FIND-LAST-ACT      10100059
101100                           PERFORM 4400-UPDATE-KMC-ACT-DEACT-REV  10110034
101200                            WITH TEST AFTER                       10120034
101300                            UNTIL ((SQLCODE = ZERO) OR            10130034
101400                                 (PV-RETRY-COUNT >                10140034
101500                                   PC-MAXIMUM-RETRY-COUNT))       10150034
101600                             IF ((SQLCODE = -904) OR              10160034
101700                                 (SQLCODE = -913))                10170034
101800                              MOVE 'UPDATE A ROW (SVT00002)'      10180034
101900                                           TO  AA-ATTEMPTED-ACTION10190034
102000                              PERFORM 9100-DB2-ERROR              10200034
102100                              PERFORM 9999-RETURN-TO-NATIVE-CICS  10210034
102200                             END-IF                               10220034
102300                                                                  10230059
102400                             EXEC SQL                             10240059
102500                                SELECT CURRENT TIMESTAMP          10250059
102600                                   INTO  :SVT00002-TRN-AUTH-TMST  10260059
102700                                   FROM  SYSIBM.SYSDUMMY1         10270059
102800                             END-EXEC                             10280059
102900                             MOVE SVT00002-TRN-AUTH-TMST          10290070
103000                                       TO SVT00015-TRN-AUTH-TMST  10300069
103100                                                                  10310069
103200                       ELSE                                       10320030
103300                         IF SV005-DEACTIVATION                    10330030
103400                           INITIALIZE PV-RETRY-COUNT              10340034
103500                           PERFORM 4300-UPDATE-KMC-ACTIVITY-DEACT 10350030
103600                            WITH TEST AFTER                       10360030
103700                            UNTIL ((SQLCODE = ZERO) OR            10370030
103800                                 (PV-RETRY-COUNT >                10380030
103900                                   PC-MAXIMUM-RETRY-COUNT))       10390030
104000                             IF ((SQLCODE = -904) OR              10400030
104100                                 (SQLCODE = -913))                10410030
104200                              MOVE 'UPDATE A ROW (SVT00002)'      10420030
104300                                           TO  AA-ATTEMPTED-ACTION10430030
104400                              PERFORM 9100-DB2-ERROR              10440030
104500                              PERFORM 9999-RETURN-TO-NATIVE-CICS  10450030
104600                             END-IF                               10460030
104700                         ELSE                                     10470030
104800                           INITIALIZE PV-RETRY-COUNT              10480034
104900                           PERFORM 4200-UPDATE-KMC-ACTIVITY-TABLE 10490030
105000                            WITH TEST AFTER                       10500030
105100                            UNTIL ((SQLCODE = ZERO) OR            10510030
105200                                 (PV-RETRY-COUNT >                10520000
105300                                   PC-MAXIMUM-RETRY-COUNT))       10530030
105400                             IF ((SQLCODE = -904) OR              10540030
105500                                 (SQLCODE = -913))                10550030
105600                              MOVE 'UPDATE A ROW (SVT00002)'      10560030
105700                                           TO  AA-ATTEMPTED-ACTION10570000
105800                              PERFORM 9100-DB2-ERROR              10580030
105900                              PERFORM 9999-RETURN-TO-NATIVE-CICS  10590030
106000                             END-IF                               10600030
106100                         END-IF                                   10610030
106200                       END-IF                                     10620030
106300                                                                  10630030
106400**-------------------------------------------------------------***10640067
106500** TRANS     VOID IND   REVERSAL IND    AMOUNT                 ***10650067
106600** -----     ---------  -------------   -------                ***10660067
106700** DEACT         Y          0            NEGATIVE              ***10670067
106800** DEACT REV     Y          1            POSITIVE              ***10680067
106900** REVERSAL      Y          1            NEGATIVE              ***10690067
107000**                                                             ***10700067
107100**-------------------------------------------------------------***10710067
107200                     IF (SV005-DEACT-REV)                         10720034
107300                       SET SV005-REVERSAL TO TRUE                 10730034
107400                       MOVE SV005-REVERSAL-CODE                   10740034
107500                                        TO SVT00002-TRN-RVRSL-CDE 10750034
107600                       MOVE SV004-VOID-TRANS                      10760034
107700                                        TO SVT00002-TRN-VOID-IND  10770034
107800                     ELSE                                         10780034
107900                       IF (SV005-DEACTIVATION)                    10790034
108000                          SET SV005-NORMAL   TO TRUE              10800038
108100                          MOVE SV005-REVERSAL-CODE                10810038
108200                                        TO SVT00002-TRN-RVRSL-CDE 10820038
108300                          MOVE SV004-VOID-TRANS                   10830038
108400                                        TO SVT00002-TRN-VOID-IND  10840038
108500                          MULTIPLY -1  BY                         10850039
108600                                       SV005-APPROVED-TENDER-AMT  10860039
108700                          MOVE SV005-APPROVED-TENDER-AMT          10870039
108800                                   TO SVT00002-APP-AUTH-AMT       10880039
108900                                      SVT00002-ORIG-AUTH-AMT      10890039
109000                       ELSE                                       10900034
109100                          SET SV005-REVERSAL TO TRUE              10910034
109200                          MOVE SV005-REVERSAL-CODE                10920034
109300                                        TO SVT00002-TRN-RVRSL-CDE 10930034
109400                          MOVE SV004-VOID-TRANS                   10940034
109500                                        TO SVT00002-TRN-VOID-IND  10950034
109600                          MOVE SV005-REVERSAL-AMT                 10960034
109700                                        TO SVT00002-APP-AUTH-AMT  10970034
109800                       END-IF                                     10980000
109900                     END-IF                                       10990034
110000                   END-IF                                         11000000
110100                                                                  11010000
110200                                                                  11020000
110300                   INITIALIZE PV-RETRY-COUNT                      11030000
110400                   PERFORM 4000-INSERT-KMC-ACTIVITY-TABLE         11040000
110500                                                                  11050000
110600                      WITH TEST AFTER                             11060000
110700                      UNTIL ((SQLCODE = ZERO) OR                  11070000
110800                             (PV-RETRY-COUNT >                    11080000
110900                              PC-MAXIMUM-RETRY-COUNT))            11090000
111000                   IF ((SQLCODE = -904) OR                        11100000
111100                        (SQLCODE = -913))                         11110000
111200                        MOVE                                      11120000
111300                       'INSERT A ROW (SVT00002)'                  11130000
111400                                  TO       AA-ATTEMPTED-ACTION    11140000
111500                      PERFORM 9100-DB2-ERROR                      11150000
111600                      PERFORM 9999-RETURN-TO-NATIVE-CICS          11160000
111700                   END-IF                                         11170000
111800                   INITIALIZE PV-RETRY-COUNT                      11180000
111900                   PERFORM 4100-INSERT-KMC-3RD-PRTY-TABLE         11190000
112000                        WITH TEST AFTER                           11200000
112100                          UNTIL ((SQLCODE = ZERO) OR              11210000
112200                             (PV-RETRY-COUNT >                    11220000
112300                              PC-MAXIMUM-RETRY-COUNT))            11230000
112400                   IF ((SQLCODE = -904) OR   (SQLCODE = -913))    11240000
112500                       MOVE  'INSERT A ROW (SVT00015)'            11250000
112600                                          TO   AA-ATTEMPTED-ACTION11260000
112700                       PERFORM 9100-DB2-ERROR                     11270000
112800                       PERFORM 9999-RETURN-TO-NATIVE-CICS         11280000
112900                   END-IF                                         11290000
113000            END-EVALUATE                                          11300000
113100         END-IF                                                   11310000
113200     END-EVALUATE.                                                11320000
113300                                                                  11330000
113400*----------------------------------------------------------------*11340000
113500*  PERFORM THE AUTHORIZATION AGAINST THE SV DATABASE             *11350000
113600*----------------------------------------------------------------*11360000
113700 2100-AUTHORIZE-KMC.                                              11370000
113800                                                                  11380000
113900     MOVE PV-KMC-ID              TO SV005-KMC-ID.                 11390000
114000     MOVE PV-REQUEST-TYPE        TO SV005-ACTIVITY-TYPE.          11400000
114100     MOVE PV-REVERSAL-IND        TO SV005-REVERSAL-CODE.          11410000
114200     MOVE PV-KMC-AMT             TO SV005-TRANS-AMT.              11420000
114300     SET  PV-E-NON-ECOMM-STORE   TO TRUE.                         11430000
114400                                                                  11440000
114500** WE HAVE TO TREAT DEACT REVERSALS DIFFERNT THEN REVERSAL        11450004
114600                                                                  11460018
114700                                                                  11470000
114800     MOVE PV-E-BUS-IND           TO SV005-E-BUS-LOC-IND.          11480000
114900     IF AURD017-MID-0400                                          11490000
115000         SET SV005-VOID          TO TRUE                          11500000
115100     ELSE                                                         11510000
115200       IF AU015-CARD-DEACTIVE                                     11520016
115300         SET SV005-VOID          TO TRUE                          11530000
115400       ELSE                                                       11540004
115500         SET SV005-NOT-VOID      TO TRUE                          11550000
115600       END-IF                                                     11560004
115700     END-IF.                                                      11570000
115800                                                                  11580000
115900     SET SV005-GIFT-CRD          TO TRUE.                         11590000
116000                                                                  11600000
116100     SET SV005-PV-FROM-AUKCS521 TO TRUE.                          11610000
116200                                                                  11620000
116300     IF (PV-TEST-GIFT-CARD-ACCOUNTS)                              11630000
116400                                                                  11640000
116500* TEST ACCOUNTS GET FIXED RESPONSES                               11650000
116600       IF EP000-PV-KOHLS-PROD-SYSTEM                              11660000
116700           MOVE 7      TO SV005-RESPONSE-CODE                     11670000
116800           MOVE 0      TO SV005-TRANS-AMT                         11680000
116900       ELSE                                                       11690000
117000           PERFORM 2200-TEST-ACCOUNTS                             11700000
117100       END-IF                                                     11710000
117200     ELSE                                                         11720000
117300* NON-TEST ACCOUNTS GET REAL DATABASE AUTHORIZATIONS              11730000
117400* NOTE: KEY-ENTERED SALES ARE NOT ALLOWED FOR INCOMM              11740000
117500          IF SV005-HARD-DECLINE                                   11750000
117600             MOVE 0      TO SV005-TRANS-AMT                       11760000
117700          ELSE                                                    11770000
117800             MOVE ZEROES TO XST00025-POS-CAP-LVL-ID               11780000
117900             PERFORM SV005-A100-MAINLINE                          11790000
118000          END-IF                                                  11800000
118100     END-IF.                                                      11810000
118200                                                                  11820000
118300*----------------------------------------------------------------*11830000
118400* POS TEST ACCOUNT RESPONSES                                     *11840000
118500* STANDARD TEST RESPONSES USED BY POS SYSTEM TESTING             *11850000
118600* RESPONSES ARE THE SAME NO MATTER WHAT TRANSACTION AMOUNT IS.   *11860000
118700*----------------------------------------------------------------*11870000
118800 2200-TEST-ACCOUNTS.                                              11880000
118900*  GIFT CARD ISSUE APPROVALS                                      11890000
119000     IF (PV-KMC-ID = PC-TEST-GIFT-1000000321)                     11900000
119100        MOVE 0              TO SV005-RESPONSE-CODE                11910000
119200        MOVE PV-KMC-AMT     TO SV005-TRANS-AMT                    11920000
119300     END-IF.                                                      11930000
119400*  GIFT CARD ISSUE DECLINES                                       11940000
119500     IF (PV-KMC-ID = PC-TEST-GIFT-1000000107)                     11950000
119600        MOVE 7      TO SV005-RESPONSE-CODE                        11960000
119700        MOVE 0      TO SV005-TRANS-AMT                            11970000
119800     END-IF.                                                      11980000
119900                                                                  11990000
120000*  GIFT CARD ISSUE REFERAL                                        12000000
120100     IF (PV-KMC-ID = PC-TEST-GIFT-1000000370)                     12010000
120200        MOVE 8      TO SV005-RESPONSE-CODE                        12020000
120300        MOVE 0      TO SV005-TRANS-AMT                            12030000
120400     END-IF.                                                      12040000
120500                                                                  12050000
120600*  GIFT CARD ISSUE PGM ABEND                                      12060000
120700     IF (PV-KMC-ID = PC-TEST-GIFT-1000000388)                     12070000
120800        MOVE 9      TO SV005-RESPONSE-CODE                        12080000
120900        MOVE 0      TO SV005-TRANS-AMT                            12090000
121000     END-IF.                                                      12100000
121100                                                                  12110000
121200*  GIFT CARD ISSUE REFERAL                                        12120000
121300     IF (PV-KMC-ID = PC-TEST-GIFT-1000000396)                     12130000
121400        SET SV005-REFERRAL TO TRUE                                12140000
121500        MOVE 0      TO SV005-TRANS-AMT                            12150000
121600     END-IF.                                                      12160000
121700                                                                  12170000
121800*----------------------------------------------------------------*12180000
121900* SET-COLUMNS                                                    *12190000
122000* POPULATE DATABASE VARIABLES                                    *12200000
122100*----------------------------------------------------------------*12210000
122200 3000-SET-COLUMNS.                                                12220000
122300     MOVE SV005-KMC-ID            TO SVT00002-CRD-NBR             12230000
122400                                     SVT00015-CRD-NBR.            12240000
122500     EXEC SQL                                                     12250000
122600         SELECT  CURRENT TIMESTAMP                                12260000
122700           INTO  :SVT00002-TRN-AUTH-TMST                          12270000
122800           FROM  SYSIBM.SYSDUMMY1                                 12280000
122900     END-EXEC.                                                    12290000
123000     MOVE SVT00002-TRN-AUTH-TMST  TO SVT00015-TRN-AUTH-TMST.      12300000
123100     MOVE SPACES                  TO SVT00002-DRV-LIC-NBR         12310000
123200                                                                  12320000
123300     IF (AU015-CARD-DEACTIVE) AND                                 12330000
123400        (AURD017-MID-0400)                                        12340000
123500          SET SV005-REVERSAL TO TRUE                              12350000
123600     END-IF.                                                      12360000
123700                                                                  12370000
123800     MOVE SV005-REVERSAL-CODE     TO SVT00002-TRN-RVRSL-CDE.      12380000
123900     MOVE 'N'                     TO SVT00002-TRN-VOID-IND.       12390000
124000     MOVE SV005-ACTIVITY-TYPE     TO SVT00002-ACTVY-TYP-CDE.      12400000
124100     MOVE SV005-POS-DATE          TO SVT00002-POS-DTE.            12410000
124200     MOVE SV005-STORE-NBR         TO SVT00002-STR-NBR.            12420000
124300     MOVE SV005-TERMINAL-NBR      TO SVT00002-POS-TRMNL-NBR.      12430000
124400     MOVE SV005-TRANSACTION-NBR   TO SVT00002-POS-TRN-NBR.        12440000
124500     MOVE SV004-DEFAULT-TIMESTAMP TO SVT00002-TRN-PSTD-TMST.      12450000
124600                                                                  12460034
124700     IF SV005-DEACT-REV                                           12470034
124800         MOVE SV005-APPROVED-TENDER-AMT                           12480034
124900                    TO SVT00002-APP-AUTH-AMT                      12490034
125000                       SVT00002-ORIG-AUTH-AMT                     12500034
125100     ELSE                                                         12510034
125200         EVALUATE TRUE                                            12520000
125300             WHEN SV005-NORMAL                                    12530000
125400               IF PV-TENDER                                       12540000
125500                  MULTIPLY -1 BY  SV005-APPROVED-TENDER-AMT       12550000
125600               END-IF                                             12560000
125700             WHEN PV-REVERSAL                                     12570000
125800                 MULTIPLY -1  BY  SV005-APPROVED-TENDER-AMT       12580000
125900         END-EVALUATE                                             12590000
126000     END-IF.                                                      12600034
126100     MOVE SV005-APPROVED-TENDER-AMT TO SVT00002-APP-AUTH-AMT      12610000
126200                                       SVT00002-ORIG-AUTH-AMT.    12620000
126300     MOVE ZEROS                   TO SVT00002-POS-OPRT-ID.        12630000
126400     MOVE 'INCOMM'                TO SVT00002-APVL-USR-ID.        12640000
126500     MOVE SV004-STAT-AUTH-RECEIVED-CD                             12650000
126600                                 TO SVT00002-ACTVY-STAT-CDE.      12660000
126700     MOVE PV-STATE-CD            TO SVT00002-ST-CDE.              12670000
126800     IF SV005-APPROVED-TENDER-AMT < ZERO                          12680000
126900         MULTIPLY -1  BY    SV005-APPROVED-TENDER-AMT             12690000
127000     END-IF.                                                      12700000
127100     MOVE SPACES                 TO SVT00015-SELR-PSTL-CDE        12710000
127200                                    SVT00015-SELR-TRN-ID.         12720000
127300     MOVE PV-INCOMM-PROCESSING-CODE                               12730000
127400                                 TO SVT00015-PRCG-CDE.            12740000
127500     MOVE SV005-KMC-APPROVAL-NBR TO SVT00015-KOHLS-AUTH-CDE.      12750000
127600                                                                  12760000
127700                                                                  12770000
127800        INSPECT AU015-B7-TRANS-DATE-TIME REPLACING LEADING " "    12780000
127900                   BY "0"                                         12790000
128000        MOVE AU015-B7-TRANS-DATE-TIME TO                          12800000
128100                                    SVT00015-TRSM-DTE-TM-TXT      12810000
128200        MOVE ZEROES                       TO                      12820068
128300                                    SVT00015-AUD-NBR              12830000
128400        INSPECT AU015-B12-TRANS-TIME REPLACING LEADING " "        12840000
128500                   BY "0"                                         12850000
128600        MOVE AU015-B12-TRANS-TIME   TO                            12860000
128700                                    SVT00015-SELR-TRN-TM-TXT      12870000
128800        INSPECT AU015-B13-LOCAL-TRANS-DATE                        12880000
128900                                 REPLACING LEADING " " BY "0"     12890000
129000        MOVE AU015-B13-LOCAL-TRANS-DATE TO                        12900000
129100                                    SVT00015-SELR-TRN-DTE-TXT     12910000
129200                                                                  12920063
129300        IF AU014-PRI-BITF-22 = "Y"                                12930063
129400          MOVE AU015-B22-POS-ENTRY-MODE TO SVT00015-POS-ENTR-CDE  12940063
129500        ELSE                                                      12950063
129600          MOVE ZEROES                   TO SVT00015-POS-ENTR-CDE  12960063
129700        END-IF.                                                   12970063
129800        IF AU014-PRI-BITF-25 = "Y"                                12980063
129900           MOVE AU015-B25-POS-COND-CODE  TO                       12990063
130000                                    SVT00015-POS-CND-CDE          13000000
130100        ELSE                                                      13010063
130200           MOVE ZEROES                   TO                       13020063
130300                                    SVT00015-POS-CND-CDE          13030063
130400        END-IF.                                                   13040063
130500        MOVE AU015-B11-SYS-AUDIT-NUM  TO                          13050000
130600                                    SVT00015-POS-REF-NBR          13060000
130700        IF AU014-PRI-BITF-41 = "Y"                                13070063
130800            MOVE AU015-B41-STORE-NBR      TO                      13080063
130900                                    SVT00015-SELR-STR-NBR         13090000
131000        ELSE                                                      13100063
131100            MOVE SPACES                   TO                      13110063
131200                                    SVT00015-SELR-STR-NBR         13120063
131300        END-IF.                                                   13130063
131400        IF AU014-PRI-BITF-41 = "Y"                                13140063
131500           MOVE AU015-B41-TERMINAL-ID    TO                       13150063
131600                                    SVT00015-SELR-TRMNL-ID        13160000
131700        ELSE                                                      13170063
131800           MOVE SPACES                   TO                       13180063
131900                                    SVT00015-SELR-TRMNL-ID        13190063
132000        END-IF.                                                   13200063
132100        MOVE SPACES                    TO                         13210064
132200                                    SVT00015-DIV-ID.              13220064
132300        IF AU014-PRI-BITF-41 = "Y"                                13230063
132400           MOVE AU015-B41-STORE-NBR      TO                       13240063
132500                                    SVT00015-CMNT-TXT             13250000
132600        ELSE                                                      13260063
132700           MOVE SPACES                   TO                       13270063
132800                                    SVT00015-CMNT-TXT             13280063
132900        END-IF.                                                   13290063
133000        IF AU014-PRI-BITF-42 = "Y"                                13300063
133100            MOVE AU015-B42-CAT-ID-CDE      TO                     13310063
133200                                    SVT00015-SELR-NM              13320000
133300        ELSE                                                      13330063
133400            MOVE SPACES                    TO                     13340063
133500                                    SVT00015-SELR-NM              13350063
133600        END-IF.                                                   13360063
133700        MOVE SPACES                    TO                         13370000
133800                                    SVT00015-SELR-CTY-NM          13380000
133900        IF AU015-B49-CURRENCY-CODE = "USD"                        13390000
134000           MOVE "US"                   TO                         13400000
134100                                    SVT00015-SELR-CNTRY-CDE       13410000
134200        ELSE                                                      13420000
134300           MOVE SPACES       TO     SVT00015-SELR-CNTRY-CDE       13430000
134400        END-IF.                                                   13440000
134500                                                                  13450000
134600        IF AU014-PRI-BITF-42 = "Y"                                13460063
134700           MOVE AU015-B42-CAT-ID-CDE       TO                     13470063
134800                                    SVT00015-TRMNL-DIV-ID         13480063
134900        ELSE                                                      13490063
135000           MOVE SPACES                     TO                     13500063
135100                                    SVT00015-TRMNL-DIV-ID         13510063
135200        END-IF.                                                   13520063
135300                                                                  13530000
135400*----------------------------------------------------------------*13540000
135500* INSERT-KMC-ACTIVITY-TABLE                                      *13550000
135600* INSERT THE TRANSACTION INTO THE SVT_KOHLS_CRD_TXN TABLE        *13560000
135700*----------------------------------------------------------------*13570000
135800 4000-INSERT-KMC-ACTIVITY-TABLE.                                  13580000
135900                                                                  13590000
136000     EXEC SQL INSERT                                              13600000
136100              INTO SVT_KOHLS_CRD_TXN                              13610000
136200                  (CRD_NBR                                        13620000
136300                  ,TRN_AUTH_TMST                                  13630000
136400                  ,DRV_LIC_NBR                                    13640000
136500                  ,TRN_RVRSL_CDE                                  13650000
136600                  ,TRN_VOID_IND                                   13660000
136700                  ,ACTVY_TYP_CDE                                  13670000
136800                  ,POS_DTE                                        13680000
136900                  ,STR_NBR                                        13690000
137000                  ,POS_TRMNL_NBR                                  13700000
137100                  ,POS_TRN_NBR                                    13710000
137200                  ,TRN_PSTD_TMST                                  13720000
137300                  ,APP_AUTH_AMT                                   13730000
137400                  ,POS_OPRT_ID                                    13740000
137500                  ,APVL_USR_ID                                    13750000
137600                  ,ACTVY_STAT_CDE                                 13760000
137700                  ,ORIG_AUTH_AMT                                  13770000
137800                  ,ST_CDE)                                        13780000
137900           VALUES                                                 13790000
138000              (:SVT00002-CRD-NBR                                  13800000
138100              ,:SVT00002-TRN-AUTH-TMST                            13810000
138200              ,:SVT00002-DRV-LIC-NBR                              13820000
138300              ,:SVT00002-TRN-RVRSL-CDE                            13830000
138400              ,:SVT00002-TRN-VOID-IND                             13840000
138500              ,:SVT00002-ACTVY-TYP-CDE                            13850000
138600              ,:SVT00002-POS-DTE                                  13860000
138700              ,:SVT00002-STR-NBR                                  13870000
138800              ,:SVT00002-POS-TRMNL-NBR                            13880000
138900              ,:SVT00002-POS-TRN-NBR                              13890000
139000              ,:SVT00002-TRN-PSTD-TMST                            13900000
139100              ,:SVT00002-APP-AUTH-AMT                             13910000
139200              ,:SVT00002-POS-OPRT-ID                              13920000
139300              ,:SVT00002-APVL-USR-ID                              13930000
139400              ,:SVT00002-ACTVY-STAT-CDE                           13940000
139500              ,:SVT00002-ORIG-AUTH-AMT                            13950000
139600              ,:SVT00002-ST-CDE)                                  13960000
139700      END-EXEC.                                                   13970000
139800                                                                  13980000
139900      EVALUATE TRUE                                               13990000
140000               WHEN SQLCODE = -904                                14000000
140100               WHEN SQLCODE = -913                                14010000
140200                    ADD 1 TO PV-RETRY-COUNT                       14020000
140300               WHEN SQLCODE < 0                                   14030000
140400                    MOVE 'INSERT KMC ACTIVITY ROW (SVT00002)'     14040000
140500                                 TO AA-ATTEMPTED-ACTION           14050000
140600                    PERFORM 9100-DB2-ERROR                        14060000
140700                    PERFORM 9999-RETURN-TO-NATIVE-CICS            14070000
140800               WHEN SQLCODE > 0                                   14080000
140900               WHEN SQLWARN0 NOT = SPACES                         14090000
141000                    MOVE 'INSERT KMC ACTIVITY ROW (SVT00002)'     14100000
141100                                 TO AA-ATTEMPTED-ACTION           14110000
141200                    PERFORM 9200-DB2-WARNING                      14120000
141300                    PERFORM 9999-RETURN-TO-NATIVE-CICS            14130000
141400               WHEN OTHER                                         14140000
141500                    CONTINUE                                      14150000
141600      END-EVALUATE.                                               14160000
141700                                                                  14170000
141800*----------------------------------------------------------------*14180000
141900* INSERT-KMC-3RD-PRTY-TABLE                                      *14190000
142000* INSERT THE TRANSACTION INTO THE SVT_3RD_PTY_TRN TABLE          *14200000
142100*----------------------------------------------------------------*14210000
142200 4100-INSERT-KMC-3RD-PRTY-TABLE.                                  14220000
142300                                                                  14230000
142400     EXEC SQL INSERT                                              14240000
142500              INTO SVT_3RD_PTY_TRN                                14250000
142600                  (CRD_NBR                                        14260000
142700                  ,TRN_AUTH_TMST                                  14270000
142800                  ,TRSM_DTE_TM_TXT                                14280000
142900                  ,AUD_NBR                                        14290000
143000                  ,SELR_TRN_TM_TXT                                14300000
143100                  ,SELR_TRN_DTE_TXT                               14310000
143200                  ,POS_ENTR_CDE                                   14320000
143300                  ,POS_CND_CDE                                    14330000
143400                  ,POS_REF_NBR                                    14340000
143500                  ,SELR_STR_NBR                                   14350000
143600                  ,SELR_TRMNL_ID                                  14360000
143700                  ,DIV_ID                                         14370000
143800                  ,CMNT_TXT                                       14380000
143900                  ,SELR_NM                                        14390000
144000                  ,SELR_CTY_NM                                    14400000
144100                  ,SELR_PSTL_CDE                                  14410000
144200                  ,SELR_CNTRY_CDE                                 14420000
144300                  ,TRMNL_DIV_ID                                   14430000
144400                  ,KOHLS_AUTH_CDE                                 14440000
144500                  ,PRCG_CDE                                       14450000
144600                  ,SELR_TRN_ID)                                   14460000
144700           VALUES                                                 14470000
144800              (:SVT00015-CRD-NBR                                  14480000
144900              ,:SVT00015-TRN-AUTH-TMST                            14490000
145000              ,:SVT00015-TRSM-DTE-TM-TXT                          14500000
145100              ,:SVT00015-AUD-NBR                                  14510000
145200              ,:SVT00015-SELR-TRN-TM-TXT                          14520000
145300              ,:SVT00015-SELR-TRN-DTE-TXT                         14530000
145400              ,:SVT00015-POS-ENTR-CDE                             14540000
145500              ,:SVT00015-POS-CND-CDE                              14550000
145600              ,:SVT00015-POS-REF-NBR                              14560000
145700              ,:SVT00015-SELR-STR-NBR                             14570000
145800              ,:SVT00015-SELR-TRMNL-ID                            14580000
145900              ,:SVT00015-DIV-ID                                   14590000
146000              ,:SVT00015-CMNT-TXT                                 14600000
146100              ,:SVT00015-SELR-NM                                  14610000
146200              ,:SVT00015-SELR-CTY-NM                              14620000
146300              ,:SVT00015-SELR-PSTL-CDE                            14630000
146400              ,:SVT00015-SELR-CNTRY-CDE                           14640000
146500              ,:SVT00015-TRMNL-DIV-ID                             14650000
146600              ,:SVT00015-KOHLS-AUTH-CDE                           14660000
146700              ,:SVT00015-PRCG-CDE                                 14670000
146800              ,:SVT00015-SELR-TRN-ID)                             14680000
146900      END-EXEC.                                                   14690000
147000                                                                  14700000
147100      EVALUATE TRUE                                               14710000
147200               WHEN SQLCODE = -904                                14720000
147300               WHEN SQLCODE = -913                                14730000
147400                    ADD 1 TO PV-RETRY-COUNT                       14740000
147500               WHEN SQLCODE < 0                                   14750000
147600                    MOVE 'INSERT KMC ACTIVITY ROW (SVT00015)'     14760000
147700                                 TO AA-ATTEMPTED-ACTION           14770000
147800                    PERFORM 9100-DB2-ERROR                        14780000
147900                    PERFORM 9999-RETURN-TO-NATIVE-CICS            14790000
148000               WHEN SQLCODE > 0                                   14800000
148100               WHEN SQLWARN0 NOT = SPACES                         14810000
148200                    MOVE 'INSERT KMC ACTIVITY ROW (SVT00015)'     14820000
148300                                 TO AA-ATTEMPTED-ACTION           14830000
148400                    PERFORM 9200-DB2-WARNING                      14840000
148500                    PERFORM 9999-RETURN-TO-NATIVE-CICS            14850000
148600               WHEN OTHER                                         14860000
148700                    CONTINUE                                      14870000
148800      END-EVALUATE.                                               14880000
148900                                                                  14890000
149000*----------------------------------------------------------------*14900000
149100* DELETE-KMC-LOCK-TABLE                                          *14910000
149200*----------------------------------------------------------------*14920000
149300 4500-DELETE-KMC-LOCK-TABLE.                                      14930000
149400                                                                  14940000
149500     EXEC SQL DELETE                                              14950000
149600              FROM SVT_CRD_ACCT_LCK                               14960000
149700         WHERE CRD_NBR       = :SV005-KMC-ID                      14970000
149800     END-EXEC.                                                    14980000
149900                                                                  14990000
150000     EVALUATE TRUE                                                15000000
150100              WHEN SQLCODE = 0                                    15010000
150200              WHEN SQLCODE = +100                                 15020000
150300              WHEN SQLCODE = -310                                 15030000
150400              WHEN SQLCODE = -904                                 15040000
150500              WHEN SQLCODE = -913                                 15050000
150600                  CONTINUE                                        15060000
150700              WHEN SQLCODE < 0                                    15070000
150800                   MOVE 'DELETE KMC LOCK ROW (SVT00004)'          15080000
150900                                TO AA-ATTEMPTED-ACTION            15090000
151000                   PERFORM 9100-DB2-ERROR                         15100000
151100                   PERFORM 9999-RETURN-TO-NATIVE-CICS             15110000
151200              WHEN SQLCODE > 0                                    15120000
151300              WHEN SQLWARN0 NOT = SPACES                          15130000
151400                   MOVE 'DELETE KMC LOCK ROW (SVT00004)'          15140000
151500                                TO AA-ATTEMPTED-ACTION            15150000
151600                   PERFORM 9200-DB2-WARNING                       15160000
151700                   PERFORM 9999-RETURN-TO-NATIVE-CICS             15170000
151800              WHEN OTHER                                          15180000
151900                   CONTINUE                                       15190000
152000     END-EVALUATE.                                                15200000
152100                                                                  15210000
152200*----------------------------------------------------------------*15220000
152300* UPDATE TRANSACTION IN TABLE FOR REVERSAL                       *15230000
152400*    THE EXISTING ROW ON THE ACTIVITY DATABASE THAT IS BEING     *15240067
152500*    REVERSED    WILL HAVE THE VOID INDICATOR SET TO 'Y'.        *15250067
152600*----------------------------------------------------------------*15260000
152700 4200-UPDATE-KMC-ACTIVITY-TABLE.                                  15270000
152800                                                                  15280000
152900     SET SV005-NORMAL TO TRUE                                     15290000
153000     MOVE SV005-REVERSAL-CODE TO SVT00002-TRN-RVRSL-CDE.          15300000
153100     COMPUTE SVT00002-APP-AUTH-AMT = SVT00002-APP-AUTH-AMT        15310000
153200                                       * -1.                      15320000
153300                                                                  15330000
153400     EXEC SQL                                                     15340000
153500         UPDATE SVT_KOHLS_CRD_TXN                                 15350000
153600           SET TRN_VOID_IND  = :SV004-VOID-TRANS                  15360000
153700         WHERE CRD_NBR       = :SVT00002-CRD-NBR                  15370000
153800           AND TRN_AUTH_TMST = :SV005-PV-TMST-DATE                15380030
153900           AND TRN_RVRSL_CDE = :SVT00002-TRN-RVRSL-CDE            15390000
154000           AND TRN_VOID_IND  = :SV004-NOT-VOID-TRANS              15400030
154100           AND ACTVY_TYP_CDE = :SVT00002-ACTVY-TYP-CDE            15410000
154200           AND POS_DTE       = :SVT00002-POS-DTE                  15420030
154300           AND STR_NBR       = :SVT00002-STR-NBR                  15430000
154400           AND APP_AUTH_AMT  = :SVT00002-APP-AUTH-AMT             15440000
154500     END-EXEC.                                                    15450000
154600                                                                  15460000
154700     EVALUATE TRUE                                                15470000
154800         WHEN SQLCODE = -904                                      15480000
154900         WHEN SQLCODE = -913                                      15490000
155000             ADD 1 TO PV-RETRY-COUNT                              15500000
155100         WHEN SQLCODE < 0                                         15510000
155200             MOVE 'UPDATE KMC ACTIVITY ROW (SVT00002)'            15520000
155300                                           TO AA-ATTEMPTED-ACTION 15530000
155400             PERFORM 9100-DB2-ERROR                               15540000
155500             PERFORM 9999-RETURN-TO-NATIVE-CICS                   15550000
155600         WHEN SQLCODE > 0                                         15560000
155700         WHEN SQLWARN0 NOT = SPACES                               15570000
155800              MOVE 'UPDATE KMC ACTIVITY ROW (SVT00002)'           15580000
155900                                            TO AA-ATTEMPTED-ACTION15590000
156000              PERFORM 9200-DB2-WARNING                            15600000
156100              PERFORM 9999-RETURN-TO-NATIVE-CICS                  15610000
156200         WHEN OTHER                                               15620000
156300              CONTINUE                                            15630000
156400     END-EVALUATE.                                                15640000
156500                                                                  15650000
156600*----------------------------------------------------------------*15660030
156700* UPDATE TRANSACTION IN TABLE FOR DEACTIVATION                   *15670067
156800*    THE EXISTING ROW ON THE ACTIVITY DATABASE THAT IS BEING     *15680067
156900*    DEACTIVATED WILL HAVE THE VOID INDICATOR SET TO 'Y'.        *15690067
157000*                                                                *15700067
157100*----------------------------------------------------------------*15710030
157200 4300-UPDATE-KMC-ACTIVITY-DEACT.                                  15720030
157300                                                                  15730030
157400     SET SV005-NORMAL TO TRUE                                     15740030
157500     MOVE SV005-REVERSAL-CODE TO SVT00002-TRN-RVRSL-CDE.          15750030
157600                                                                  15760044
157700     IF SV005-APPROVED-TENDER-AMT < ZERO                          15770044
157800         MULTIPLY -1  BY    SV005-APPROVED-TENDER-AMT             15780044
157900     END-IF.                                                      15790044
158000                                                                  15800044
158100     MOVE SV005-APPROVED-TENDER-AMT TO SVT00002-APP-AUTH-AMT      15810044
158200                                                                  15820044
158300                                                                  15830044
158400     EXEC SQL                                                     15840030
158500         UPDATE SVT_KOHLS_CRD_TXN                                 15850030
158600           SET TRN_VOID_IND  = :SV004-VOID-TRANS                  15860030
158700         WHERE CRD_NBR       = :SVT00002-CRD-NBR                  15870030
158800           AND TRN_RVRSL_CDE = :SVT00002-TRN-RVRSL-CDE            15880030
158900           AND TRN_VOID_IND  = :SV004-NOT-VOID-TRANS              15890030
159000           AND ACTVY_TYP_CDE = :SVT00002-ACTVY-TYP-CDE            15900030
159100           AND STR_NBR       = :SVT00002-STR-NBR                  15910030
159200           AND APP_AUTH_AMT  = :SVT00002-APP-AUTH-AMT             15920030
159300     END-EXEC.                                                    15930030
159400                                                                  15940030
159500     EVALUATE TRUE                                                15950030
159600         WHEN SQLCODE = -904                                      15960030
159700         WHEN SQLCODE = -913                                      15970030
159800             ADD 1 TO PV-RETRY-COUNT                              15980030
159900         WHEN SQLCODE < 0                                         15990030
160000             MOVE 'UPDATE KMC ACTIVITY DEA (SVT00002)'            16000030
160100                                           TO AA-ATTEMPTED-ACTION 16010030
160200             PERFORM 9100-DB2-ERROR                               16020030
160300             PERFORM 9999-RETURN-TO-NATIVE-CICS                   16030030
160400         WHEN SQLCODE > 0                                         16040030
160500         WHEN SQLWARN0 NOT = SPACES                               16050030
160600              MOVE 'UPDATE KMC ACTIVITY DEA (SVT00002)'           16060030
160700                                            TO AA-ATTEMPTED-ACTION16070030
160800              PERFORM 9200-DB2-WARNING                            16080030
160900              PERFORM 9999-RETURN-TO-NATIVE-CICS                  16090030
161000         WHEN OTHER                                               16100030
161100              CONTINUE                                            16110030
161200     END-EVALUATE.                                                16120030
161300                                                                  16130030
161400*----------------------------------------------------------------*16140034
161500* UPDATE TRANSACTION IN TABLE FOR DEACT REVERSAL                 *16150067
161600*                                                                 16160067
161700*  FOR DEACT REVERSALS:                                           16170067
161800*    - THE MOST RECENT ACTIVATION WILL HAVE THEIR VOID INDICATOR  16180067
161900*      SET TO "Y".                                                16190067
162000*                                                                 16200067
162100*----------------------------------------------------------------*16210034
162200 4400-UPDATE-KMC-ACT-DEACT-REV.                                   16220034
162300                                                                  16230034
162400     EXEC SQL                                                     16240034
162500         UPDATE SVT_KOHLS_CRD_TXN                                 16250034
162600           SET TRN_VOID_IND  = :SV004-NOT-VOID-TRANS              16260034
162700         WHERE CRD_NBR       = :SVT00002-CRD-NBR                  16270034
162800           AND TRN_AUTH_TMST = :SV005-PV-TMST-DATE                16280056
162900     END-EXEC.                                                    16290034
163000                                                                  16300034
163100     EVALUATE TRUE                                                16310034
163200         WHEN SQLCODE = -904                                      16320034
163300         WHEN SQLCODE = -913                                      16330034
163400             ADD 1 TO PV-RETRY-COUNT                              16340034
163500         WHEN SQLCODE < 0                                         16350034
163600             MOVE 'UPDATE KMC ACTIVITY DER (SVT00002)'            16360034
163700                                           TO AA-ATTEMPTED-ACTION 16370034
163800             PERFORM 9100-DB2-ERROR                               16380034
163900             PERFORM 9999-RETURN-TO-NATIVE-CICS                   16390034
164000         WHEN SQLCODE > 0                                         16400034
164100         WHEN SQLWARN0 NOT = SPACES                               16410034
164200              MOVE 'UPDATE KMC ACTIVITY DER (SVT00002)'           16420034
164300                                            TO AA-ATTEMPTED-ACTION16430034
164400              PERFORM 9200-DB2-WARNING                            16440034
164500              PERFORM 9999-RETURN-TO-NATIVE-CICS                  16450034
164600         WHEN OTHER                                               16460034
164700              CONTINUE                                            16470034
164800     END-EVALUATE.                                                16480034
164900                                                                  16490034
165000*----------------------------------------------------------------*16500034
165100*  FORMAT-0110-PRE-AUTH-RESP                                      16510000
165200*  FORMAT THE 0110 ONLINE PRE-AUTH RESPONSE MESSAGE, WHICH WILL   16520000
165300*  BE SENT BACK TO THE STORE ISP.                                *16530000
165400*----------------------------------------------------------------*16540000
165500 5000-FORMAT-0110-PRE-AUTH-RESP.                                  16550000
165600     INITIALIZE AURD018-TOT-REC-LENGTH                            16560000
165700                AURD018-MATCHING-NBR-FIELD.                       16570000
165800                                                                  16580000
165900     SET AURD018-MID-0110               TO TRUE.                  16590000
166000     MOVE AURD017-MATCHING-NBR-FIELD    TO                        16600000
166100                                      AURD018-MATCHING-NBR-FIELD. 16610000
166200                                                                  16620000
166300     MOVE ZEROES TO   AU015-B38-AUTH-ID-RESPONSE.                 16630000
166400     IF (NOT PV-TEST-GIFT-CARD-ACCOUNTS)                          16640000
166500       IF SV005-APPROVE                                           16650000
166600           MOVE SV005-KMC-APPROVAL-NBR TO                         16660000
166700                AU015-B38-AUTH-ID-RESPONSE                        16670000
166800       END-IF                                                     16680000
166900     ELSE                                                         16690000
167000        IF SV005-TRANS-AMT NUMERIC                                16700000
167100         MULTIPLY SV005-TRANS-AMT BY 100                          16710000
167200                                GIVING PV-APPROVAL-NBR            16720000
167300         MOVE PV-APPROVAL-NBR TO                                  16730000
167400           AU015-B38-AUTH-ID-RESPONSE                             16740000
167500        END-IF                                                    16750000
167600     END-IF.                                                      16760000
167700                                                                  16770000
167800                                                                  16780000
167900     PERFORM 5500-GET-RESPONSE-CODES.                             16790000
168000                                                                  16800000
168100** FILL THE DATA BUFFER RESPONSE MESSAGE TO BE SENT               16810000
168200                                                                  16820000
168300     MOVE 1 TO PV-RESPONSE-LEN.                                   16830000
168400     MOVE 1      TO WS-START.                                     16840000
168500     MOVE SPACES TO AU014-BITMAP16.                               16850000
168600                                                                  16860004
168700     IF PV-BITMAP-SECOND-EXISTS                                   16870000
168800         PERFORM 5400-RESET-SECOND-BITMAP                         16880000
168900     END-IF.                                                      16890000
169000                                                                  16900000
169100     PERFORM VARYING PV-FIELD-INDX FROM 1 BY 1                    16910000
169200       UNTIL PV-FIELD-INDX  > 64                                  16920000
169300                                                                  16930000
169400       MOVE PV-FIELD-INDX TO PV-FIELD-IND-DISP                    16940000
169500       MOVE PV-FIELD-IND-DISP TO AU014-RES110-BIT-VALIDATION      16950000
169600                                                                  16960000
169700       IF (PV-RES110-REQUIRED)                                    16970000
169800           PERFORM 7800-STRING-FIELDS                             16980000
169900           MOVE 'Y' TO AU014-PRI-BITFLD-RESET(PV-FIELD-INDX:1)    16990000
170000       ELSE                                                       17000000
170100         IF (AU014-PRI-BITFLD-SETTINGS(PV-FIELD-INDX:1) = "Y") AND17010000
170200          ((PV-RES110-REQ-ECHO) OR                                17020000
170300           (PV-RES110-OPT-ECHO))                                  17030000
170400           PERFORM 7800-STRING-FIELDS                             17040000
170500           MOVE 'Y' TO AU014-PRI-BITFLD-RESET(PV-FIELD-INDX:1)    17050000
170600         ELSE                                                     17060000
170700           MOVE 'N' TO AU014-PRI-BITFLD-RESET(PV-FIELD-INDX:1)    17070000
170800         END-IF                                                   17080000
170900       END-IF                                                     17090000
171000                                                                  17100000
171100                                                                  17110000
171200     END-PERFORM.                                                 17120000
171300                                                                  17130000
171400     MOVE 1      TO WS-START.                                     17140000
171500                                                                  17150000
171600     PERFORM 5600-SET-PRIMARY-BITMAP.                             17160001
171700                                                                  17170004
171800                                                                  17180000
171900     SUBTRACT 1 FROM PV-RESPONSE-LEN.                             17190000
172000     COMPUTE PV-TRAN-SIZE = 22 + PV-RESPONSE-LEN                  17200000
172100     MOVE 1 TO PV-RESPONSE-LEN2.                                  17210000
172200     STRING AURD018-DATA-LEN-HEX,                                 17220000
172300            AURD018-MESSAGE-ID,                                   17230000
172400            AURD018-BITMAP-PRIMARY,                               17240000
172500            AURD018-DATA (1:PV-RESPONSE-LEN)                      17250000
172600            DELIMITED BY SIZE                                     17260073
172700            INTO AURD018-RESPONSE-MESSAGE                         17270000
172800            WITH POINTER PV-RESPONSE-LEN2                         17280000
172900     END-STRING.                                                  17290000
173000     SUBTRACT 1 FROM PV-RESPONSE-LEN2.                            17300000
173100                                                                  17310000
173200** THE TOTAL MESSAGE LENGTH TO BE SENT BACK INCLUDES THE          17320000
173300** HEADER.                                                        17330000
173400     MOVE PV-RESPONSE-LEN2  TO PV-HEX-BINARY.                     17340000
173500                                                                  17350000
173600     MOVE PV-HEX-LENGTH TO AURD018-DATA-LEN-HEX.                  17360000
173700                                                                  17370000
173800     COMPUTE AURD018-TOT-REC-LENGTH = PV-RESPONSE-LEN2 + 2.       17380000
173900                                                                  17390000
174000                                                                  17400000
174100* SEND DATA TO LISTENER                                           17410000
174200     PERFORM 8000-SEND-DATA-TO-LISTENER.                          17420000
174300                                                                  17430000
174400*----------------------------------------------------------------*17440000
174500*  FORMAT-0210-AUTH-RESP                                          17450000
174600*  FORMAT THE 0110 ONLINE AUTH RESPONSE MESSAGE, WHICH WILL       17460000
174700*  BE SENT BACK TO THE STORE ISP.                                *17470000
174800*----------------------------------------------------------------*17480000
174900 5100-FORMAT-0210-AUTH-RESP.                                      17490000
175000                                                                  17500000
175100     INITIALIZE AURD018-TOT-REC-LENGTH                            17510000
175200                AURD018-MATCHING-NBR-FIELD.                       17520000
175300                                                                  17530000
175400     SET AURD018-MID-0210               TO TRUE.                  17540000
175500     MOVE AURD017-MATCHING-NBR-FIELD    TO                        17550000
175600                                      AURD018-MATCHING-NBR-FIELD. 17560000
175700                                                                  17570000
175800     MOVE ZEROES TO   AU015-B38-AUTH-ID-RESPONSE.                 17580000
175900     IF (NOT PV-TEST-GIFT-CARD-ACCOUNTS)                          17590000
176000       IF SV005-APPROVE                                           17600000
176100           MOVE SV005-KMC-APPROVAL-NBR TO                         17610000
176200                AU015-B38-AUTH-ID-RESPONSE                        17620000
176300       END-IF                                                     17630000
176400     ELSE                                                         17640000
176500        IF SV005-TRANS-AMT NUMERIC                                17650000
176600         MULTIPLY SV005-TRANS-AMT BY 100                          17660000
176700                                GIVING PV-APPROVAL-NBR            17670000
176800         MOVE PV-APPROVAL-NBR TO                                  17680000
176900           AU015-B38-AUTH-ID-RESPONSE                             17690000
177000        END-IF                                                    17700000
177100     END-IF.                                                      17710000
177200                                                                  17720000
177300                                                                  17730000
177400     PERFORM 5500-GET-RESPONSE-CODES.                             17740000
177500                                                                  17750000
177600** FILL THE DATA BUFFER RESPONSE MESSAGE TO BE SENT               17760000
177700     MOVE 1 TO PV-RESPONSE-LEN.                                   17770000
177800     MOVE 1      TO WS-START.                                     17780000
177900     MOVE SPACES TO AU014-BITMAP16.                               17790000
178000                                                                  17800000
178100     IF PV-BITMAP-SECOND-EXISTS                                   17810000
178200         PERFORM 5400-RESET-SECOND-BITMAP                         17820000
178300     END-IF.                                                      17830000
178400                                                                  17840000
178500                                                                  17850000
178600     PERFORM VARYING PV-FIELD-INDX FROM 1 BY 1                    17860000
178700       UNTIL PV-FIELD-INDX  > 64                                  17870000
178800                                                                  17880000
178900       MOVE PV-FIELD-INDX TO PV-FIELD-IND-DISP                    17890000
179000       MOVE PV-FIELD-IND-DISP TO AU014-RES210-BIT-VALIDATION      17900000
179100                                                                  17910000
179200       IF (PV-RES210-REQUIRED)                                    17920000
179300           PERFORM 7800-STRING-FIELDS                             17930000
179400           MOVE 'Y' TO AU014-PRI-BITFLD-RESET(PV-FIELD-INDX:1)    17940000
179500       ELSE                                                       17950000
179600         IF (AU014-PRI-BITFLD-SETTINGS(PV-FIELD-INDX:1) = "Y") AND17960000
179700          ((PV-RES210-REQ-ECHO) OR                                17970000
179800           (PV-RES210-OPT-ECHO))                                  17980000
179900           PERFORM 7800-STRING-FIELDS                             17990000
180000           MOVE 'Y' TO AU014-PRI-BITFLD-RESET(PV-FIELD-INDX:1)    18000000
180100         ELSE                                                     18010000
180200           MOVE 'N' TO AU014-PRI-BITFLD-RESET(PV-FIELD-INDX:1)    18020000
180300         END-IF                                                   18030000
180400       END-IF                                                     18040000
180500                                                                  18050000
180600                                                                  18060000
180700     END-PERFORM.                                                 18070000
180800                                                                  18080000
180900     PERFORM 5600-SET-PRIMARY-BITMAP.                             18090001
181000                                                                  18100004
181100                                                                  18110004
181200     SUBTRACT 1 FROM PV-RESPONSE-LEN.                             18120000
181300     COMPUTE PV-TRAN-SIZE = 22 + PV-RESPONSE-LEN                  18130000
181400     MOVE 1 TO PV-RESPONSE-LEN2.                                  18140000
181500     STRING AURD018-DATA-LEN-HEX,                                 18150000
181600            AURD018-MESSAGE-ID,                                   18160000
181700            AURD018-BITMAP-PRIMARY,                               18170000
181800            AURD018-DATA (1:PV-RESPONSE-LEN)                      18180000
181900            DELIMITED BY SIZE                                     18190073
182000            INTO AURD018-RESPONSE-MESSAGE                         18200000
182100            WITH POINTER PV-RESPONSE-LEN2                         18210000
182200     END-STRING.                                                  18220000
182300     SUBTRACT 1 FROM PV-RESPONSE-LEN2.                            18230000
182400                                                                  18240000
182500** THE TOTAL MESSAGE LENGTH TO BE SENT BACK INCLUDES THE          18250000
182600** HEADER.                                                        18260000
182700     MOVE PV-RESPONSE-LEN2  TO PV-HEX-BINARY.                     18270000
182800                                                                  18280000
182900     MOVE PV-HEX-LENGTH TO AURD018-DATA-LEN-HEX.                  18290000
183000                                                                  18300000
183100     COMPUTE AURD018-TOT-REC-LENGTH = PV-RESPONSE-LEN2 + 2.       18310000
183200                                                                  18320000
183300                                                                  18330000
183400* SEND DATA TO LISTENER                                           18340000
183500     PERFORM 8000-SEND-DATA-TO-LISTENER.                          18350000
183600                                                                  18360000
183700*----------------------------------------------------------------*18370000
183800*  FORMAT-0410-AUTH-RESP                                          18380000
183900*  FORMAT THE 0110 ONLINE AUTH RESPONSE MESSAGE, WHICH WILL       18390000
184000*  BE SENT BACK TO THE STORE ISP.                                *18400000
184100*----------------------------------------------------------------*18410000
184200 5200-FORMAT-0400-RVSL-RESP.                                      18420000
184300                                                                  18430000
184400     INITIALIZE AURD018-TOT-REC-LENGTH                            18440000
184500                AURD018-MATCHING-NBR-FIELD.                       18450000
184600                                                                  18460000
184700     SET AURD018-MID-0410               TO TRUE.                  18470000
184800     MOVE AURD017-MATCHING-NBR-FIELD    TO                        18480000
184900                                      AURD018-MATCHING-NBR-FIELD. 18490000
185000                                                                  18500000
185100     MOVE ZEROES TO   AU015-B38-AUTH-ID-RESPONSE.                 18510000
185200     IF (NOT PV-TEST-GIFT-CARD-ACCOUNTS)                          18520000
185300       IF SV005-APPROVE                                           18530000
185400           MOVE SV005-KMC-APPROVAL-NBR TO                         18540000
185500                AU015-B38-AUTH-ID-RESPONSE                        18550000
185600       END-IF                                                     18560000
185700     ELSE                                                         18570000
185800        IF SV005-TRANS-AMT NUMERIC                                18580000
185900         MULTIPLY SV005-TRANS-AMT BY 100                          18590000
186000                                GIVING PV-APPROVAL-NBR            18600000
186100         MOVE PV-APPROVAL-NBR TO                                  18610000
186200           AU015-B38-AUTH-ID-RESPONSE                             18620000
186300        END-IF                                                    18630000
186400     END-IF.                                                      18640000
186500                                                                  18650000
186600     PERFORM 5500-GET-RESPONSE-CODES.                             18660000
186700                                                                  18670000
186800** FILL THE DATA BUFFER RESPONSE MESSAGE TO BE SENT               18680000
186900     MOVE 1 TO PV-RESPONSE-LEN.                                   18690000
187000     MOVE 1      TO WS-START.                                     18700000
187100     MOVE SPACES TO AU014-BITMAP16.                               18710000
187200                                                                  18720000
187300     IF PV-BITMAP-SECOND-EXISTS                                   18730000
187400         PERFORM 5400-RESET-SECOND-BITMAP                         18740000
187500     END-IF.                                                      18750000
187600                                                                  18760000
187700                                                                  18770000
187800     PERFORM VARYING PV-FIELD-INDX FROM 1 BY 1                    18780000
187900       UNTIL PV-FIELD-INDX  > 64                                  18790000
188000                                                                  18800000
188100       MOVE PV-FIELD-INDX TO PV-FIELD-IND-DISP                    18810000
188200       MOVE PV-FIELD-IND-DISP TO AU014-RES410-BIT-VALIDATION      18820000
188300                                                                  18830000
188400       IF (PV-RES410-REQUIRED)                                    18840000
188500           PERFORM 7800-STRING-FIELDS                             18850000
188600           MOVE 'Y' TO AU014-PRI-BITFLD-RESET(PV-FIELD-INDX:1)    18860000
188700       ELSE                                                       18870000
188800         IF (AU014-PRI-BITFLD-SETTINGS(PV-FIELD-INDX:1) = "Y") AND18880000
188900          ((PV-RES410-REQ-ECHO) OR                                18890000
189000           (PV-RES410-OPT-ECHO))                                  18900000
189100           PERFORM 7800-STRING-FIELDS                             18910000
189200           MOVE 'Y' TO AU014-PRI-BITFLD-RESET(PV-FIELD-INDX:1)    18920000
189300         ELSE                                                     18930000
189400           MOVE 'N' TO AU014-PRI-BITFLD-RESET(PV-FIELD-INDX:1)    18940000
189500         END-IF                                                   18950000
189600       END-IF                                                     18960000
189700                                                                  18970000
189800                                                                  18980000
189900     END-PERFORM.                                                 18990000
190000                                                                  19000000
190100     PERFORM 5600-SET-PRIMARY-BITMAP.                             19010001
190200                                                                  19020004
190300     SUBTRACT 1 FROM PV-RESPONSE-LEN.                             19030000
190400     COMPUTE PV-TRAN-SIZE = 22 + PV-RESPONSE-LEN                  19040000
190500     MOVE 1 TO PV-RESPONSE-LEN2.                                  19050000
190600     STRING AURD018-DATA-LEN-HEX,                                 19060000
190700            AURD018-MESSAGE-ID,                                   19070000
190800            AURD018-BITMAP-PRIMARY,                               19080000
190900            AURD018-DATA (1:PV-RESPONSE-LEN)                      19090005
191000            DELIMITED BY SIZE                                     19100073
191100            INTO AURD018-RESPONSE-MESSAGE                         19110000
191200            WITH POINTER PV-RESPONSE-LEN2                         19120000
191300     END-STRING.                                                  19130000
191400     SUBTRACT 1 FROM PV-RESPONSE-LEN2.                            19140000
191500                                                                  19150000
191600** THE TOTAL MESSAGE LENGTH TO BE SENT BACK INCLUDES THE          19160000
191700** HEADER.                                                        19170000
191800     MOVE PV-RESPONSE-LEN2  TO PV-HEX-BINARY.                     19180000
191900                                                                  19190000
192000     MOVE PV-HEX-LENGTH TO AURD018-DATA-LEN-HEX.                  19200000
192100                                                                  19210000
192200     COMPUTE AURD018-TOT-REC-LENGTH = PV-RESPONSE-LEN2 + 2.       19220000
192300                                                                  19230000
192400                                                                  19240000
192500* SEND DATA TO LISTENER                                           19250000
192600     PERFORM 8000-SEND-DATA-TO-LISTENER.                          19260000
192700                                                                  19270000
192800*----------------------------------------------------------------*19280000
192900*  FORMAT-NETWORK-MGMT-RESP                                      *19290000
193000*  FORMAT THE NETWORK MANAGEMENT RESPONSE MESSAGE                *19300000
193100*----------------------------------------------------------------*19310000
193200 5300-FORMAT-0810-NETMGMT-RESP.                                   19320000
193300                                                                  19330000
193400     INITIALIZE AURD018-TOT-REC-LENGTH                            19340000
193500                AURD018-MATCHING-NBR-FIELD.                       19350000
193600                                                                  19360000
193700     MOVE 1 TO PV-RESPONSE-LEN.                                   19370000
193800     MOVE 1      TO WS-START.                                     19380000
193900     MOVE SPACES TO AU014-BITMAP16.                               19390000
194000     IF PV-BITMAP-SECOND-EXISTS                                   19400000
194100         PERFORM 5400-RESET-SECOND-BITMAP                         19410000
194200     END-IF.                                                      19420000
194300                                                                  19430000
194400                                                                  19440000
194500                                                                  19450000
194600     SET AU015-SUCCESS                  TO TRUE.                  19460000
194700     SET AU015-NET-MGMT-RESPONSE        TO TRUE.                  19470000
194800                                                                  19480000
194900     PERFORM VARYING PV-FIELD-INDX FROM 1 BY 1                    19490000
195000       UNTIL PV-FIELD-INDX  > 64                                  19500000
195100                                                                  19510000
195200       MOVE PV-FIELD-INDX TO PV-FIELD-IND-DISP                    19520000
195300       MOVE PV-FIELD-IND-DISP TO AU014-RES810-BIT-VALIDATION      19530000
195400                                                                  19540000
195500       IF (PV-RES810-REQUIRED)                                    19550000
195600           PERFORM 7800-STRING-FIELDS                             19560000
195700           MOVE 'Y' TO AU014-PRI-BITFLD-RESET(PV-FIELD-INDX:1)    19570000
195800       ELSE                                                       19580000
195900         IF (AU014-PRI-BITFLD-SETTINGS(PV-FIELD-INDX:1) = "Y") AND19590000
196000          ((PV-RES810-REQ-ECHO) OR                                19600000
196100           (PV-RES810-OPT-ECHO))                                  19610000
196200           PERFORM 7800-STRING-FIELDS                             19620000
196300           MOVE 'Y' TO AU014-PRI-BITFLD-RESET(PV-FIELD-INDX:1)    19630000
196400         ELSE                                                     19640000
196500           MOVE 'N' TO AU014-PRI-BITFLD-RESET(PV-FIELD-INDX:1)    19650000
196600         END-IF                                                   19660000
196700       END-IF                                                     19670000
196800                                                                  19680000
196900                                                                  19690000
197000     END-PERFORM.                                                 19700000
197100                                                                  19710000
197200     PERFORM 5600-SET-PRIMARY-BITMAP.                             19720001
197300                                                                  19730004
197400     SUBTRACT 1 FROM PV-RESPONSE-LEN.                             19740000
197500     COMPUTE PV-TRAN-SIZE = 22 + PV-RESPONSE-LEN                  19750000
197600     MOVE 1 TO PV-RESPONSE-LEN2.                                  19760000
197700     STRING AURD018-DATA-LEN-HEX,                                 19770000
197800            AURD018-MESSAGE-ID,                                   19780000
197900            AURD018-BITMAP-PRIMARY,                               19790000
198000            AURD018-DATA (1:PV-RESPONSE-LEN)                      19800000
198100            DELIMITED BY SIZE                                     19810073
198200            INTO AURD018-RESPONSE-MESSAGE                         19820000
198300            WITH POINTER PV-RESPONSE-LEN2                         19830000
198400     END-STRING.                                                  19840000
198500     SUBTRACT 1 FROM PV-RESPONSE-LEN2.                            19850000
198600                                                                  19860000
198700** THE TOTAL MESSAGE LENGTH TO BE SENT BACK INCLUDES THE          19870000
198800** HEADER.                                                        19880000
198900     MOVE PV-RESPONSE-LEN2  TO PV-HEX-BINARY.                     19890000
199000                                                                  19900000
199100     MOVE PV-HEX-LENGTH TO AURD018-DATA-LEN-HEX.                  19910000
199200                                                                  19920000
199300     COMPUTE AURD018-TOT-REC-LENGTH = PV-RESPONSE-LEN2 + 2.       19930000
199400                                                                  19940000
199500* SEND DATA TO LISTENER                                           19950000
199600     PERFORM 8000-SEND-DATA-TO-LISTENER.                          19960000
199700                                                                  19970000
199800*----------------------------------------------------------------*19980000
199900*  RESET THE SECONDARY BITMAP                                    *19990000
200000*  THIS WILL SET THE SECONDARY BITMAP TO ALL "N", EXCEPT         *20000000
200100*  WHEN IT IS A TRANSACTION 810, BECAUSE 810 NEEDS TO SEND BIT 70*20010000
200200*----------------------------------------------------------------*20020000
200300 5400-RESET-SECOND-BITMAP.                                        20030000
200400                                                                  20040000
200500      IF (AU014-SEC-BITF-70 = "Y")                                20050000
200600         INSPECT AU014-SEC-BITFLD-SETTINGS                        20060004
200700                REPLACING ALL "Y" BY "N"                          20070004
200800         MOVE 'Y'         TO AU014-SEC-BIT-SETTINGS(3:1)          20080004
200900      ELSE                                                        20090000
201000         INSPECT AU014-SEC-BITFLD-SETTINGS                        20100000
201100                            REPLACING ALL "Y" BY "N"              20110000
201200      END-IF.                                                     20120000
201300                                                                  20130004
201400     MOVE ZEROES TO WS-BIT-START                                  20140004
201500                                                                  20150004
201600     PERFORM VARYING PV-FIELD-INDX FROM 1 BY 8                    20160004
201700       UNTIL PV-FIELD-INDX  > 64                                  20170004
201800                                                                  20180004
201900        COMPUTE WS-BIT-START = 1 + WS-BIT-START                   20190001
202000        MOVE AU014-SEC-BITFLD-SETTINGS(PV-FIELD-INDX:8)           20200004
202100                                   TO DP170-BITS                  20210004
202200        MOVE 'C'                      TO DP170-ACTION-CODE        20220004
202300        CALL 'DPKUT170' USING DP170-BYTE                          20230004
202400                           DP170-BITS                             20240004
202500                           DP170-ACTION-CODE                      20250004
202600                           DP170-RETURN-CODE                      20260004
202700        MOVE DP170-BYTE                                           20270004
202800                     TO AU014-SEC-BITFLD-RESET(WS-BIT-START:1)    20280004
202900                                                                  20290004
203000     END-PERFORM.                                                 20300004
203100                                                                  20310004
203200*  THIS WILL TAKE THE 8 BYTE FIELD AND CONVERT TO 16              20320004
203300*  INCOMM NEEDS THE 16 BYTES FOR THEIR RESPONSE MESSAGE           20330004
203400                                                                  20340004
203500      MOVE AU014-SEC-BITFLD-RESET TO BC-BCD-FIELD.                20350004
203600      PERFORM 9050-UNPACK-BCD-TO-EBCDIC.                          20360004
203700      MOVE BC-EBCDIC-FIELD TO AU015-BIT-MAP-SECONDARY.            20370004
203800                                                                  20380004
203900*----------------------------------------------------------------*20390000
204000*  THIS WILL SET ALL OF THE RESPONSE CODES FOR THE TRANSACTIONS  *20400000
204100*----------------------------------------------------------------*20410000
204200 5500-GET-RESPONSE-CODES.                                         20420000
204300                                                                  20430000
204400                                                                  20440025
204500* TRANSLATE KOHL'S RESPONSE CODES TO INCOMM RESPONSE CODES        20450000
204600     EVALUATE SV005-RESPONSE-CODE                                 20460000
204700       WHEN 0                                                     20470000
204800         SET AU015-SUCCESS           TO TRUE                      20480000
204900       WHEN 7                                                     20490000
205000         IF SV005-DUPLICATE                                       20500000
205100            IF ((AU015-CARD-ACTIVATION) OR                        20510045
205200               (AU015-VAR-CARD-ISSUE)) AND                        20520045
205300               (PV-NORMAL)                                        20530045
205400               SET AU015-ACTIVE  TO TRUE                          20540045
205500            ELSE                                                  20550045
205600              IF (SV005-DEACT-REV)                                20560046
205700                SET AU015-ACTIVE  TO TRUE                         20570046
205800              ELSE                                                20580046
205900                IF ((AU015-CARD-ACTIVATION) OR                    20590054
206000                   (AU015-VAR-CARD-ISSUE))                        20600054
206100                  SET AU015-INACTIVE     TO TRUE                  20610046
206200                ELSE                                              20620046
206300                  SET AU015-DUP-TRANS       TO TRUE               20630046
206400                END-IF                                            20640046
206500              END-IF                                              20650046
206600            END-IF                                                20660045
206700         ELSE                                                     20670000
206800           IF (AU015-INV-CARDNO) OR (AU015-INV-TRAN) OR           20680000
206900              (AU015-NOT-SUPP)                                    20690000
207000                 CONTINUE                                         20700000
207100           ELSE                                                   20710000
207200             IF (SV005-TRAN-DLR-OVER-LIM-ADD-ON) OR               20720000
207300                (SV005-CARD-PRE-DENOM-ADD-ON) OR                  20730000
207400                (SV005-CARD-BAL-OVER-LIM-ADD-ON)                  20740000
207500                SET AU015-INV-AMT TO TRUE                         20750000
207600             ELSE                                                 20760000
207700               IF SV005-PS-TENDER-W-ISSUE                         20770000
207800                  SET AU015-CARD-REDEEMED TO TRUE                 20780000
207900               ELSE                                               20790000
208000                 IF SV005-TRAN-DAY-OVER-LIM-ADD-ON                20800000
208100                   SET AU015-ACTIVE  TO TRUE                      20810000
208200                 ELSE                                             20820013
208300                   IF SV005-PS-INACTIVE                           20830043
208400                      SET AU015-INACTIVE     TO TRUE              20840043
208500                   ELSE                                           20850043
208600                     IF (SV005-CARD-STAT-INV-ISSUE) OR            20860061
208700                        (SV005-CARD-STAT-INV-ADD-ON) OR           20870062
208800                        (SV005-CARD-ID-INVALID-ADD-ON) OR         20880065
208900                        (SV005-CARD-ID-INVALID-ISSUE) OR          20890065
209000                        (SV005-CARD-STOCK-INV-ADD-ON)             20900062
209100                        SET AU015-INV-CARDNO TO TRUE              20910054
209200                     ELSE                                         20920054
209300                         SET AU015-INV-TRAN    TO TRUE            20930062
209400                     END-IF                                       20940054
209500                   END-IF                                         20950043
209600                 END-IF                                           20960000
209700               END-IF                                             20970000
209800             END-IF                                               20980000
209900           END-IF                                                 20990000
210000         END-IF                                                   21000000
210100       WHEN OTHER                                                 21010000
210200         SET AU015-INV-TRAN           TO TRUE                     21020000
210300     END-EVALUATE.                                                21030000
210400                                                                  21040000
210500*----------------------------------------------------------------*21050000
210600*  SET THE PRIMARY BITMAP                                        *21060000
210700*  THIS WILL SET THE PRIMARY BITMAP OF ALL THE FIELDS WE ARE     *21070000
210800*  SENDING BACK "Y" AND NOT SENDING "N".                         *21080000
210900*----------------------------------------------------------------*21090000
211000 5600-SET-PRIMARY-BITMAP.                                         21100000
211100                                                                  21110000
211200     MOVE ZEROES TO WS-BIT-START.                                 21120000
211300     PERFORM VARYING PV-FIELD-INDX FROM 1 BY 8                    21130001
211400       UNTIL PV-FIELD-INDX  > 64                                  21140001
211500                                                                  21150000
211600        COMPUTE WS-BIT-START = 1 + WS-BIT-START                   21160000
211700                                                                  21170000
211800        MOVE AU014-PRI-BITFLD-RESET(PV-FIELD-INDX:8)              21180000
211900                                   TO DP170-BITS                  21190000
212000        MOVE 'C'                      TO DP170-ACTION-CODE        21200000
212100        CALL 'DPKUT170' USING DP170-BYTE                          21210000
212200                           DP170-BITS                             21220000
212300                           DP170-ACTION-CODE                      21230000
212400                           DP170-RETURN-CODE                      21240000
212500        MOVE DP170-BYTE                                           21250000
212600                       TO PV-BITMAP-RET(WS-BIT-START:1)           21260000
212700                                                                  21270000
212800     END-PERFORM.                                                 21280000
212900                                                                  21290068
213000      MOVE PV-BITMAP-RET TO BC-BCD-FIELD.                         21300001
213100      PERFORM 9050-UNPACK-BCD-TO-EBCDIC.                          21310004
213200      MOVE BC-EBCDIC-FIELD TO AURD018-BITMAP-PRIMARY.             21320001
213300                                                                  21330000
213400                                                                  21340004
213500*----------------------------------------------------------------*21350000
213600* RETRIEVE AUTH REQUEST                                          *21360000
213700*  RETRIEVE THE AUTHORIZATION REQUEST FROM THE LISTENER.         *21370000
213800*   ERROR CHECKING:                                              *21380000
213900*  IF A CONDITION OTHER THAN END-OF-DATA (RECEIVED DATA WAS LESS *21390000
214000*  THAN EXPLICITYLY STATED LENGTH, WHICH IS NORMAL), AN ERROR    *21400000
214100*  WILL BE POSTED, AND THE TRANSACTION WILL BE TERMINATED,       *21410000
214200*  WITHOUT A RESPONSE TO THE ISP.  BECAUSE THERE IS NO RESPONSE, *21420000
214300*  FLOOR LIMITS WILL THEN BE USED BY THE ISP, AFTER THE REQUEST  *21430000
214400*  TIMES OUT.                                                    *21440000
214500*----------------------------------------------------------------*21450000
214600 7000-RETRIEVE-AUTH-REQUEST.                                      21460000
214700                                                                  21470000
214800     EXEC CICS                                                    21480000
214900         RETRIEVE                                                 21490000
215000             INTO    (AURD017-GC-AUTH-REQ-RECORD)                 21500000
215100             LENGTH  (PC-COMMUNICATIONS-IN-LENGTH)                21510000
215200             RESP    (PV-CICS-RESPONSE)                           21520000
215300     END-EXEC.                                                    21530000
215400                                                                  21540000
215500             MOVE PV-CICS-RESPONSE TO PV-CICS-RESPONSE-DISP       21550000
215600                                                                  21560000
215700     EVALUATE TRUE                                                21570000
215800         WHEN PV-CICS-RESPONSE NOT = DFHRESP(NORMAL)              21580000
215900               AND PV-CICS-RESPONSE NOT = DFHRESP(EOC)            21590000
216000                      AND PV-CICS-RESPONSE NOT = DFHRESP(LENGERR) 21600000
216100             SET EP000-SL-ERROR TO TRUE                           21610000
216200             MOVE PV-CICS-RESPONSE TO PV-CICS-RESPONSE-DISP       21620000
216300             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            21630000
216400             STRING 'ERROR RETRIEVING RESPONSE MESSAGE '          21640000
216500                                         DELIMITED BY SIZE        21650000
216600                ' - CICS RESPONSE = '    DELIMITED BY SIZE        21660000
216700                PV-CICS-RESPONSE-DISP    DELIMITED BY SIZE        21670000
216800                 INTO  EP000-MD-SYSTEM-LOG-MESSAGE                21680000
216900                           (EP000-MESSAGE-LINE-COUNTER)           21690000
217000             PERFORM EP000-1000-POST-MESSAGE                      21700000
217100             PERFORM 9999-RETURN-TO-NATIVE-CICS                   21710000
217200     END-EVALUATE.                                                21720000
217300     MOVE AURD017-LISTENER-CODE TO AUWS013-QUEUE-PARM.            21730000
217400                                                                  21740000
217500* CHECK FOR VALID PARM, AND FILL IN TSQ NAME.                     21750000
217600     IF  AUWS013-VALID-PARM                                       21760000
217700         MOVE AUWS013-QUEUE-NAME(AUWS013-QUEUE-PARM-N)            21770000
217800                TO PV-TSQ-NAME                                    21780000
217900     ELSE                                                         21790000
218000         MOVE AUWS013-QUEUE-NAME(AUWS013-QUEUE-PARM-N)            21800000
218100                TO PV-TSQ-NAME                                    21810000
218200                                                                  21820000
218300             SET EP000-SL-ERROR TO TRUE                           21830000
218400             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            21840000
218500             STRING '7000-RETRIEVE-AUTH-REQUEST '                 21850000
218600                                         DELIMITED BY SIZE        21860000
218700                'INVALID PARM VALUE= '   DELIMITED BY SIZE        21870000
218800                AURD017-LISTENER-CODE      DELIMITED BY SIZE      21880000
218900                 INTO  EP000-MD-SYSTEM-LOG-MESSAGE                21890000
219000                           (EP000-MESSAGE-LINE-COUNTER)           21900000
219100             PERFORM EP000-1000-POST-MESSAGE                      21910000
219200             PERFORM 9999-RETURN-TO-NATIVE-CICS                   21920000
219300     END-IF.                                                      21930000
219400                                                                  21940000
219500*----------------------------------------------------------------*21950000
219600* THIS WILL IDENTIFY WHICH FIELDS ARE ON THE REQUEST FILE BY     *21960000
219700* LOOKING AT THE BIT MAP PRIMARY FIELD.  THIS IS A 64 BIT FIELD  *21970004
219800* EACH BIT ON THE 64 BIT FIELD WILL IDENTIFY WHICH FIELD IS ON    21980000
219900* THE REQUEST.  SO IF BIT 1 = 0, THEN THE BIT 1 FIELD IS NOT ON   21990000
220000* THE REQUEST.  IF BIT 1 = 1, THEN THE BIT 1 FIELD IS ON THE      22000000
220100* REQUEST.  IF THE FIELD IS ON THE REQUEST WE WILL MOVE IT OVER   22010000
220200* TO A TEMPORARY FIELD SO IT CAN BE PROCESSED.                    22020000
220300*----------------------------------------------------------------*22030000
220400                                                                  22040000
220500 7100-IDENTIFY-FIELDS.                                            22050000
220600                                                                  22060000
220700     PERFORM 7200-CHECK-BIT-SWITCH.                               22070000
220800                                                                  22080000
220900     PERFORM 7300-GET-PRIMARY-FIELDS.                             22090000
221000                                                                  22100000
221100     IF PV-BITMAP-SECOND-EXISTS                                   22110000
221200        PERFORM 7400-CHECK-SEC-BIT-SWITCH                         22120004
221300        PERFORM 7500-GET-SECONDARY-FIELDS                         22130004
221400     END-IF.                                                      22140000
221500                                                                  22150000
221600                                                                  22160000
221700*----------------------------------------------------------------*22170000
221800* THIS WILL TAKE THE PRIMARY BIT FIELD AND IDENTIFY WHICH SWITCHES22180000
221900* ARE ON. THIS WILL TAKE THE 64 BIT FILE AND IDENTIFY WHICH FIELD*22190000
222000* IS ON.                                                          22200000
222100* SO IF BIT 1 = 0, THEN THE BIT 1 FIELD IS NOT ON THE REQUEST     22210000
222200*    IF BIT 1 = 1, THEN THE BIT 1 FIELD IS ON THE REQUEST         22220000
222300*                                                                 22230004
222400* THIS WILL TAKE A 16 BYTE FIELD AND MAKE IT INTO A 8 BYTES       22240004
222500* THE DPKUT170 WILL READ IN EACH BYTE OF THE 8 BYTE FIELD         22250004
222600* AND IDENTIFY WHICH BITS ARE ON.  THE RETURN FIELD WILL REPRESENT22260004
222700* 1 BYTE = 8 BITS.  IF N, THEN IT IS OFF AND Y, THEN IT IS ON.    22270004
222800*                                                                 22280004
222900*----------------------------------------------------------------*22290000
223000*                                                                 22300000
223100 7200-CHECK-BIT-SWITCH.                                           22310000
223200                                                                  22320000
223300     MOVE AURD017-BITMAP-PRIMARY TO BC-EBCDIC-FIELD.              22330004
223400                                                                  22340000
223500     PERFORM 9000-PACK-EBCDIC-TO-BCD.                             22350000
223600                                                                  22360000
223700     MOVE BC-BCD-FIELD TO PV-BITMAP.                              22370000
223800                                                                  22380000
223900     MOVE 1      TO WS-BIT-START                                  22390000
224000                                                                  22400000
224100     PERFORM VARYING PV-BITMAP-IDX FROM 1 BY 1                    22410004
224200       UNTIL PV-BITMAP-IDX  > 8                                   22420004
224300                                                                  22430000
224400**  THIS WILL TAKE 1 BYTE AND DETERMINE IF BITS 1 - 8             22440004
224500**  ARE ON OR OFF                                                 22450004
224600**  THIS WILL GO THROUGH ALL 8 BYTES                              22460004
224700                                                                  22470000
224800        MOVE PV-BITMAP-BYTE(PV-BITMAP-IDX)  TO DP170-BYTE         22480000
224900        MOVE 'D'           TO DP170-ACTION-CODE                   22490000
225000        CALL 'DPKUT170' USING DP170-BYTE                          22500000
225100                              DP170-BITS                          22510000
225200                              DP170-ACTION-CODE                   22520000
225300                              DP170-RETURN-CODE                   22530000
225400        MOVE DP170-BITS    TO                                     22540000
225500                        PV-BITMAP-FULL(WS-BIT-START:8)            22550000
225600                                                                  22560000
225700        COMPUTE WS-BIT-START = 8 + WS-BIT-START                   22570000
225800                                                                  22580000
225900                                                                  22590000
226000     END-PERFORM.                                                 22600000
226100                                                                  22610000
226200*----------------------------------------------------------------*22620048
226300 7300-GET-PRIMARY-FIELDS.                                         22630048
226400*----------------------------------------------------------------*22640048
226500                                                                  22650048
226600     MOVE PV-BITMAP-FULL         TO AU014-PRI-BITFLD-SETTINGS.    22660048
226700     MOVE 1                      TO WS-START.                     22670048
226800     SET  PV-BITMAP-SECOND-NO-EXISTS    TO TRUE.                  22680048
226900                                                                  22690048
227000* THIS WILL GO THROUGH EACH OF THE BITS.  IF THEY ARE ON "Y",     22700048
227100* THEN IT WILL MOVE THE CORRECT BIT INTO THE CORRECT FIELD        22710048
227200                                                                  22720048
227300     PERFORM VARYING PV-FIELD-INDX FROM 1 BY 1                    22730048
227400       UNTIL PV-FIELD-INDX  > 64                                  22740048
227500                                                                  22750048
227600       IF AU014-PRI-BITFLD-SETTINGS(PV-FIELD-INDX:1) = "Y"        22760048
227700          PERFORM 7600-IDENTIFY-FIELDS                            22770048
227800       END-IF                                                     22780048
227900                                                                  22790048
228000                                                                  22800048
228100     END-PERFORM.                                                 22810048
228200                                                                  22820048
228300                                                                  22830000
228400*----------------------------------------------------------------*22840004
228500* THIS WILL TAKE THE SECOND  BIT FIELD AND IDENTIFY WHICH SWITCHES22850004
228600* ARE ON. THIS WILL TAKE THE 64 BIT FILE AND IDENTIFY WHICH FIELD*22860004
228700* IS ON.                                                          22870004
228800*  THIS WILL ONLY LOOK FOR TWO BYTES, BECAUSE WE ARE ONLY         22880004
228900*  USING 1 FIELD FROM THE SECONDARY AND THAT IS BIT 70.           22890004
229000*                                                                 22900004
229100* SO IF BIT 1 = 0, THEN THE BIT 1 FIELD IS NOT ON THE REQUEST     22910004
229200*    IF BIT 1 = 1, THEN THE BIT 1 FIELD IS ON THE REQUEST         22920004
229300*                                                                 22930004
229400* THIS WILL TAKE A 16 BYTE FIELD AND MAKE IT INTO A 8 BYTES       22940004
229500* THE DPKUT170 WILL READ IN EACH BYTE OF THE 8 BYTE FIELD         22950004
229600* AND IDENTIFY WHICH BITS ARE ON.  THE RETURN FIELD WILL REPRESENT22960004
229700* 1 BYTE = 8 BITS.  IF N, THEN IT IS OFF AND Y, THEN IT IS ON.    22970004
229800*                                                                 22980004
229900*----------------------------------------------------------------*22990000
230000 7400-CHECK-SEC-BIT-SWITCH.                                       23000004
230100*----------------------------------------------------------------*23010000
230200                                                                  23020000
230300     MOVE AU015-BIT-MAP-SECONDARY  TO BC-EBCDIC-FIELD.            23030004
230400                                                                  23040000
230500     PERFORM 9000-PACK-EBCDIC-TO-BCD.                             23050000
230600                                                                  23060000
230700     MOVE BC-BCD-FIELD TO PV-BITMAP2.                             23070000
230800                                                                  23080000
230900     MOVE 1 TO WS-BIT-START                                       23090000
231000                                                                  23100000
231100     PERFORM VARYING PV-BITMAP2-IDX FROM 1 BY 1                   23110004
231200       UNTIL PV-BITMAP2-IDX  > 8                                  23120004
231300                                                                  23130000
231400                                                                  23140000
231500        MOVE PV-BITMAP2-BYTE(PV-BITMAP2-IDX)  TO DP170-BYTE       23150004
231600        MOVE 'D'           TO DP170-ACTION-CODE                   23160004
231700        CALL 'DPKUT170' USING DP170-BYTE                          23170004
231800                              DP170-BITS                          23180004
231900                              DP170-ACTION-CODE                   23190004
232000                              DP170-RETURN-CODE                   23200004
232100        MOVE DP170-BITS    TO                                     23210004
232200                        PV-BITMAP2-FULL(WS-BIT-START:8)           23220000
232300        COMPUTE WS-BIT-START = 8 + WS-BIT-START                   23230000
232400     END-PERFORM.                                                 23240004
232500                                                                  23250000
232600*----------------------------------------------------------------*23260000
232700 7500-GET-SECONDARY-FIELDS.                                       23270004
232800*----------------------------------------------------------------*23280000
232900*                                                                 23290000
233000     MOVE PV-BITMAP2-FULL         TO AU014-SEC-BITFLD-SETTINGS.   23300000
233100                                                                  23310000
233200      IF AU014-SEC-BITF-70 = "Y"                                  23320000
233300                                                                  23330000
233400         MOVE AURD017-DATA(WS-START:3) TO                         23340000
233500                             AU015-B70-INF-CODE-NET               23350000
233600                                                                  23360000
233700         COMPUTE WS-START = WS-START + 3                          23370000
233800                                                                  23380000
233900      END-IF.                                                     23390000
234000                                                                  23400000
234100                                                                  23410000
234200*----------------------------------------------------------------*23420000
234300 7600-IDENTIFY-FIELDS.                                            23430004
234400*----------------------------------------------------------------*23440000
234500                                                                  23450000
234600          EVALUATE PV-FIELD-INDX                                  23460000
234700            WHEN 1                                                23470000
234800               MOVE AURD017-DATA(WS-START:16) TO                  23480000
234900                             AU015-BIT-MAP-SECONDARY              23490000
235000                                                                  23500000
235100               COMPUTE WS-START = WS-START + 16                   23510000
235200                                                                  23520000
235300               MOVE AURD017-DATA(WS-START:1) TO                   23530000
235400                             AU015-B1-BIT-MAP-EXTENDER            23540000
235500                                                                  23550000
235600               COMPUTE WS-START = WS-START + 1                    23560000
235700                                                                  23570000
235800               SET  PV-BITMAP-SECOND-EXISTS    TO TRUE            23580000
235900                                                                  23590000
236000            WHEN 2                                                23600000
236100                                                                  23610000
236200               MOVE AURD017-DATA(WS-START:2) TO                   23620000
236300                             AU015-B2-LENGTH                      23630000
236400                                                                  23640000
236500               COMPUTE WS-START = WS-START + 2                    23650000
236600                                                                  23660000
236700               MOVE AURD017-DATA(WS-START:AU015-B2-LENGTH) TO     23670000
236800                             AU015-B2-ACCOUNT-NBR                 23680000
236900                                                                  23690000
237000               COMPUTE WS-START = WS-START + AU015-B2-LENGTH      23700000
237100            WHEN 3                                                23710000
237200                                                                  23720000
237300               MOVE AURD017-DATA(WS-START:6) TO                   23730000
237400                             AU015-B3-PROCESSING-CODE             23740000
237500                                                                  23750000
237600               COMPUTE WS-START = WS-START + 6                    23760000
237700                                                                  23770000
237800            WHEN 4                                                23780000
237900                                                                  23790000
238000               MOVE AURD017-DATA(WS-START:12) TO                  23800000
238100                             AU015-TRANS-AMOUNT-CENTS             23810000
238200                                                                  23820000
238300               COMPUTE WS-START = WS-START + 12                   23830000
238400                                                                  23840000
238500            WHEN 5                                                23850000
238600                                                                  23860000
238700               MOVE AURD017-DATA(WS-START:12) TO                  23870000
238800                             AU015-PROD-BAL-AMT-CENTS             23880000
238900                                                                  23890000
239000               COMPUTE WS-START = WS-START + 12                   23900000
239100                                                                  23910000
239200            WHEN 6                                                23920000
239300                                                                  23930000
239400               MOVE AURD017-DATA(WS-START:12) TO                  23940000
239500                             AU015-B6-BILLING-AMT                 23950000
239600                                                                  23960000
239700               COMPUTE WS-START = WS-START + 12                   23970000
239800                                                                  23980000
239900            WHEN 7                                                23990000
240000                                                                  24000000
240100               MOVE AURD017-DATA(WS-START:16) TO                  24010000
240200                             AU015-B7-TRANS-DATE-TIME             24020000
240300                                                                  24030000
240400               COMPUTE WS-START = WS-START + 16                   24040000
240500                                                                  24050000
240600            WHEN 11                                               24060000
240700                                                                  24070000
240800               MOVE AURD017-DATA(WS-START:12) TO                  24080000
240900                             AU015-B11-SYS-AUDIT-NUM              24090000
241000                                                                  24100000
241100               COMPUTE WS-START = WS-START + 12                   24110000
241200                                                                  24120000
241300            WHEN 12                                               24130000
241400                                                                  24140000
241500               MOVE AURD017-DATA(WS-START:11) TO                  24150000
241600                             AU015-B12-TRANS-TIME                 24160000
241700                                                                  24170000
241800               COMPUTE WS-START = WS-START + 11                   24180000
241900                                                                  24190000
242000            WHEN 13                                               24200000
242100                                                                  24210000
242200               MOVE AURD017-DATA(WS-START:8) TO                   24220000
242300                             AU015-B13-LOCAL-TRANS-DATE           24230000
242400                                                                  24240000
242500               COMPUTE WS-START = WS-START + 8                    24250000
242600                                                                  24260000
242700            WHEN 14                                               24270000
242800                                                                  24280000
242900               MOVE AURD017-DATA(WS-START:4) TO                   24290000
243000                             AU015-B14-EXPIRATION-DATE            24300000
243100                                                                  24310000
243200               COMPUTE WS-START = WS-START + 4                    24320000
243300                                                                  24330000
243400            WHEN 22                                               24340000
243500                                                                  24350000
243600               MOVE AURD017-DATA(WS-START:3) TO                   24360000
243700                             AU015-B22-POS-ENTRY-MODE             24370000
243800                                                                  24380000
243900               COMPUTE WS-START = WS-START + 3                    24390000
244000                                                                  24400000
244100            WHEN 25                                               24410000
244200                                                                  24420000
244300               MOVE AURD017-DATA(WS-START:2) TO                   24430000
244400                             AU015-B25-POS-COND-CODE              24440000
244500                                                                  24450000
244600               COMPUTE WS-START = WS-START + 2                    24460000
244700                                                                  24470000
244800            WHEN 32                                               24480000
244900                                                                  24490000
245000               MOVE AURD017-DATA(WS-START:2) TO                   24500000
245100                             AU015-B32-LENGTH                     24510000
245200                                                                  24520000
245300               COMPUTE WS-START = WS-START + 2                    24530000
245400                                                                  24540000
245500               MOVE AURD017-DATA(WS-START:AU015-B32-LENGTH) TO    24550000
245600                             AU015-B32-ID-CODE-ACQ-INS            24560000
245700                                                                  24570000
245800               COMPUTE WS-START = WS-START + AU015-B32-LENGTH     24580000
245900                                                                  24590000
246000            WHEN 35                                               24600000
246100                                                                  24610000
246200               MOVE AURD017-DATA(WS-START:2) TO                   24620000
246300                             AU015-B35-LENGTH                     24630000
246400                                                                  24640000
246500               COMPUTE WS-START = WS-START + 2                    24650000
246600                                                                  24660000
246700               MOVE AURD017-DATA(WS-START:AU015-B35-LENGTH) TO    24670000
246800                             AU015-B35-INC-TRACK2-DATA            24680000
246900                                                                  24690000
247000               COMPUTE WS-START = WS-START + AU015-B35-LENGTH     24700000
247100                                                                  24710000
247200                                                                  24720000
247300            WHEN 37                                               24730000
247400                                                                  24740000
247500               MOVE AURD017-DATA(WS-START:12) TO                  24750000
247600                             AU015-B37-RETR-REF-NBR               24760000
247700                                                                  24770000
247800               COMPUTE WS-START = WS-START + 12                   24780000
247900                                                                  24790000
248000                                                                  24800000
248100            WHEN 38                                               24810000
248200                                                                  24820000
248300               MOVE AURD017-DATA(WS-START:20) TO                  24830000
248400                             AU015-B38-AUTH-ID-RESPONSE           24840000
248500                                                                  24850000
248600               COMPUTE WS-START = WS-START + 20                   24860000
248700                                                                  24870000
248800            WHEN 39                                               24880000
248900                                                                  24890000
249000               MOVE AURD017-DATA(WS-START:2) TO                   24900000
249100                             AU015-B39-RESPONSE-CODE              24910000
249200                                                                  24920000
249300               COMPUTE WS-START = WS-START + 2                    24930000
249400                                                                  24940000
249500            WHEN 41                                               24950000
249600                                                                  24960000
249700               MOVE AURD017-DATA(WS-START:8) TO                   24970000
249800                             AU015-B41-CARD-ACCEPT-TERM           24980000
249900                                                                  24990000
250000               COMPUTE WS-START = WS-START + 8                    25000000
250100                                                                  25010000
250200            WHEN 42                                               25020000
250300                                                                  25030000
250400               MOVE AURD017-DATA(WS-START:15) TO                  25040000
250500                             AU015-B42-CAT-ID-CDE                 25050000
250600                                                                  25060000
250700               COMPUTE WS-START = WS-START + 15                   25070000
250800                                                                  25080000
250900            WHEN 44                                               25090000
251000                                                                  25100000
251100               MOVE AURD017-DATA(WS-START:2) TO                   25110000
251200                             AU015-B44-LENGTH                     25120000
251300                                                                  25130000
251400               COMPUTE WS-START = WS-START + 2                    25140000
251500                                                                  25150000
251600               MOVE AURD017-DATA(WS-START:AU015-B44-LENGTH) TO    25160000
251700                             AU015-B44-ADDTL-RESP                 25170000
251800                                                                  25180000
251900               COMPUTE WS-START = WS-START + AU015-B44-LENGTH     25190000
252000                                                                  25200000
252100            WHEN 45                                               25210000
252200                                                                  25220000
252300               MOVE AURD017-DATA(WS-START:2) TO                   25230000
252400                             AU015-B45-LENGTH                     25240000
252500                                                                  25250000
252600               COMPUTE WS-START = WS-START + 2                    25260000
252700                                                                  25270000
252800               MOVE AURD017-DATA(WS-START:AU015-B45-LENGTH) TO    25280000
252900                             AU015-B45-TRACK-1-DATA               25290000
253000                                                                  25300000
253100               COMPUTE WS-START = WS-START + AU015-B45-LENGTH     25310000
253200                                                                  25320000
253300            WHEN 46                                               25330000
253400                                                                  25340000
253500               MOVE AURD017-DATA(WS-START:4) TO                   25350000
253600                             AU015-B46-LENGTH                     25360000
253700                                                                  25370000
253800               COMPUTE WS-START = WS-START + 4                    25380000
253900                                                                  25390000
254000               MOVE AURD017-DATA(WS-START:AU015-B46-LENGTH) TO    25400000
254100                             AU015-B46-TXT-FASTPIN                25410000
254200                                                                  25420000
254300               COMPUTE WS-START = WS-START + AU015-B46-LENGTH     25430000
254400                                                                  25440000
254500            WHEN 47                                               25450000
254600                                                                  25460000
254700               MOVE AURD017-DATA(WS-START:4) TO                   25470000
254800                             AU015-B47-LENGTH                     25480000
254900                                                                  25490000
255000               COMPUTE WS-START = WS-START + 4                    25500000
255100                                                                  25510000
255200               MOVE AURD017-DATA(WS-START:AU015-B47-LENGTH) TO    25520000
255300                             AU015-B47-PROMO                      25530000
255400                                                                  25540000
255500               COMPUTE WS-START = WS-START + AU015-B47-LENGTH     25550000
255600                                                                  25560000
255700            WHEN 48                                               25570000
255800                                                                  25580000
255900               MOVE AURD017-DATA(WS-START:4) TO                   25590000
256000                             AU015-B48-LENGTH                     25600000
256100                                                                  25610000
256200               COMPUTE WS-START = WS-START + 4                    25620000
256300                                                                  25630000
256400               MOVE AURD017-DATA(WS-START:AU015-B48-LENGTH) TO    25640000
256500                             AU015-B48-TXT                        25650000
256600                                                                  25660000
256700               COMPUTE WS-START = WS-START + AU015-B48-LENGTH     25670000
256800                                                                  25680000
256900            WHEN 49                                               25690000
257000                                                                  25700000
257100               MOVE AURD017-DATA(WS-START:3) TO                   25710000
257200                             AU015-B49-CURRENCY-CODE              25720000
257300                                                                  25730000
257400               COMPUTE WS-START = WS-START + 3                    25740000
257500                                                                  25750000
257600            WHEN 53                                               25760000
257700                                                                  25770000
257800               MOVE AURD017-DATA(WS-START:16) TO                  25780000
257900                             AU015-B53-SEC-REL-CTRL               25790000
258000                                                                  25800000
258100               COMPUTE WS-START = WS-START + 16                   25810000
258200                                                                  25820000
258300            WHEN 54                                               25830000
258400                                                                  25840000
258500               MOVE AURD017-DATA(WS-START:3) TO                   25850000
258600                             AU015-B54-LENGTH                     25860000
258700                                                                  25870000
258800               COMPUTE WS-START = WS-START + 16                   25880000
258900                                                                  25890000
259000               MOVE AURD017-DATA(WS-START:AU015-B54-LENGTH) TO    25900000
259100                             AU015-B54-ADDTL-PROD-DATA            25910000
259200                                                                  25920000
259300               COMPUTE WS-START = WS-START + 16                   25930000
259400                                                                  25940000
259500                                                                  25950000
259600            WHEN 59                                               25960000
259700                                                                  25970000
259800               MOVE AURD017-DATA(WS-START:3) TO                   25980000
259900                             AU015-B59-LENGTH                     25990000
260000                                                                  26000000
260100               COMPUTE WS-START = WS-START + 3                    26010000
260200                                                                  26020000
260300               MOVE AURD017-DATA(WS-START:AU015-B59-LENGTH) TO    26030000
260400                             AU015-B59-RESERVE-NATL               26040000
260500                                                                  26050000
260600               COMPUTE WS-START = WS-START + AU015-B59-LENGTH     26060000
260700                                                                  26070000
260800            WHEN 63                                               26080000
260900                                                                  26090000
261000               MOVE AURD017-DATA(WS-START:3) TO                   26100000
261100                             AU015-B63-LENGTH                     26110000
261200                                                                  26120000
261300               COMPUTE WS-START = WS-START + 3                    26130000
261400                                                                  26140000
261500               MOVE AURD017-DATA(WS-START:AU015-B63-LENGTH) TO    26150000
261600                             AU015-B63-RESERVE-PRIV               26160000
261700                                                                  26170000
261800               COMPUTE WS-START = WS-START + AU015-B63-LENGTH     26180000
261900                                                                  26190000
262000            WHEN OTHER                                            26200000
262100               SET PS-AUTH-MESSAGE-ERROR                          26210000
262200                   SV005-HARD-DECLINE                             26220000
262300                   AU015-INV-TRAN                                 26230061
262400                   PV-NO-TABLE-LOCK                               26240000
262500                   EP000-SL-ERROR  TO TRUE                        26250000
262600               MOVE AURD017-DATA-BUF TO                           26260000
262700                   AM-POS-INQ-REMOTE-AUTH-MSG                     26270000
262800               MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER          26280000
262900               MOVE AM-AUTH-MESSAGE-ERROR-MESSAGE                 26290000
263000                  TO   EP000-MD-SYSTEM-LOG-MESSAGE                26300000
263100                     (EP000-MESSAGE-LINE-COUNTER)                 26310000
263200               ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER           26320000
263300               MOVE PV-FIELD-INDX            TO                   26330000
263400                        PV-DISPLAY-ACCT-LENGTH                    26340000
263500             STRING                                               26350000
263600             'INVALID BIT CODE:  '                                26360000
263700              PV-DISPLAY-ACCT-LENGTH                              26370000
263800            DELIMITED BY SIZE                                     26380000
263900            INTO EP000-MD-SYSTEM-LOG-MESSAGE                      26390000
264000                     (EP000-MESSAGE-LINE-COUNTER)                 26400000
264100             PERFORM EP000-1000-POST-MESSAGE                      26410000
264200          END-EVALUATE.                                           26420000
264300                                                                  26430000
264400*----------------------------------------------------------------*26440000
264500*                                                                 26450000
264600*----------------------------------------------------------------*26460000
264700 7800-STRING-FIELDS.                                              26470000
264800                                                                  26480000
264900          EVALUATE PV-FIELD-INDX                                  26490000
265000            WHEN 1                                                26500000
265100             STRING AU015-BIT-MAP-SECONDARY                       26510000
265200                DELIMITED BY SIZE                                 26520000
265300                  INTO AURD018-DATA                               26530000
265400                   WITH POINTER PV-RESPONSE-LEN                   26540000
265500                                                                  26550000
265600               STRING AU015-B1-BIT-MAP-EXTENDER                   26560000
265700                DELIMITED BY SIZE                                 26570000
265800                  INTO AURD018-DATA                               26580000
265900                   WITH POINTER PV-RESPONSE-LEN                   26590000
266000                                                                  26600000
266100            WHEN 2                                                26610000
266200                 STRING AU015-B2-LENGTH                           26620000
266300                DELIMITED BY SIZE                                 26630000
266400                  INTO AURD018-DATA                               26640000
266500                   WITH POINTER PV-RESPONSE-LEN                   26650000
266600                                                                  26660000
266700                 STRING AU015-B2-ACCOUNT-NBR                      26670000
266800                DELIMITED BY SIZE                                 26680074
266900                  INTO AURD018-DATA                               26690000
267000                   WITH POINTER PV-RESPONSE-LEN                   26700000
267100                                                                  26710000
267200            WHEN 3                                                26720004
267300                                                                  26730000
267400                 STRING AU015-B3-PROCESSING-CODE                  26740000
267500                DELIMITED BY SIZE                                 26750000
267600                  INTO AURD018-DATA                               26760000
267700                   WITH POINTER PV-RESPONSE-LEN                   26770000
267800                                                                  26780000
267900            WHEN 4                                                26790000
268000                                                                  26800000
268100                 STRING AU015-TRANS-AMOUNT-CENTS                  26810000
268200                    DELIMITED BY SIZE                             26820000
268300                  INTO AURD018-DATA                               26830000
268400                   WITH POINTER PV-RESPONSE-LEN                   26840000
268500                                                                  26850000
268600            WHEN 5                                                26860000
268700** THIS GETS MOVED TO PROVIDE THE BALANCE ON THE RECEIPT          26870000
268800                 IF SV005-KMC-REMAINING-BALANCE NUMERIC           26880000
268801* TDH001 MULTIPLY BY 100 TO SOLVE TRUNCATION                      26880178
268810                    COMPUTE SV005-KMC-REMAINING-BALANCE =         26881077
268820                            SV005-KMC-REMAINING-BALANCE * 100     26882077
268821* TDH001 MULTIPLY BY 100 TO SOLVE TRUNCATION                      26882178
268900                    MOVE SV005-KMC-REMAINING-BALANCE              26890000
269000                      TO AU015-PROD-BAL-AMT-CENTS                 26900000
269100                 ELSE                                             26910000
269200                    MOVE 0                           TO           26920000
269300                      AU015-PROD-BAL-AMT-CENTS                    26930000
269400                 END-IF                                           26940000
269500                                                                  26950000
269600                 STRING AU015-PROD-BAL-AMT-CENTS                  26960000
269700                    DELIMITED BY SIZE                             26970000
269800                  INTO AURD018-DATA                               26980000
269900                   WITH POINTER PV-RESPONSE-LEN                   26990000
270000                                                                  27000000
270100            WHEN 6                                                27010000
270200                                                                  27020000
270300                 STRING AU015-B6-BILLING-AMT                      27030000
270400                    DELIMITED BY SIZE                             27040000
270500                  INTO AURD018-DATA                               27050000
270600                   WITH POINTER PV-RESPONSE-LEN                   27060000
270700                                                                  27070000
270800            WHEN 7                                                27080000
270900                                                                  27090000
271000                 STRING AU015-B7-TRANS-DATE-TIME                  27100000
271100                    DELIMITED BY SIZE                             27110000
271200                  INTO AURD018-DATA                               27120000
271300                   WITH POINTER PV-RESPONSE-LEN                   27130000
271400                                                                  27140000
271500            WHEN 11                                               27150000
271600                                                                  27160000
271700                 STRING AU015-B11-SYS-AUDIT-NUM                   27170000
271800                    DELIMITED BY SIZE                             27180000
271900                  INTO AURD018-DATA                               27190000
272000                   WITH POINTER PV-RESPONSE-LEN                   27200000
272100                                                                  27210000
272200            WHEN 12                                               27220000
272300                                                                  27230000
272400                 STRING AU015-B12-TRANS-TIME                      27240000
272500                    DELIMITED BY SIZE                             27250000
272600                  INTO AURD018-DATA                               27260000
272700                   WITH POINTER PV-RESPONSE-LEN                   27270000
272800            WHEN 13                                               27280000
272900                 STRING AU015-B13-LOCAL-TRANS-DATE                27290000
273000                    DELIMITED BY SIZE                             27300000
273100                  INTO AURD018-DATA                               27310000
273200                   WITH POINTER PV-RESPONSE-LEN                   27320000
273300            WHEN 14                                               27330000
273400                 STRING AU015-B14-EXPIRATION-DATE                 27340000
273500                    DELIMITED BY SIZE                             27350000
273600                  INTO AURD018-DATA                               27360000
273700                   WITH POINTER PV-RESPONSE-LEN                   27370000
273800            WHEN 22                                               27380000
273900                 STRING AU015-B22-POS-ENTRY-MODE                  27390000
274000                    DELIMITED BY SIZE                             27400000
274100                  INTO AURD018-DATA                               27410000
274200                   WITH POINTER PV-RESPONSE-LEN                   27420000
274300            WHEN 25                                               27430000
274400                 STRING AU015-B25-POS-COND-CODE                   27440000
274500                    DELIMITED BY SIZE                             27450000
274600                  INTO AURD018-DATA                               27460000
274700                   WITH POINTER PV-RESPONSE-LEN                   27470000
274800            WHEN 32                                               27480000
274900                                                                  27490000
275000                 STRING AU015-B32-LENGTH                          27500000
275100                    DELIMITED BY SIZE                             27510000
275200                  INTO AURD018-DATA                               27520000
275300                   WITH POINTER PV-RESPONSE-LEN                   27530000
275400                                                                  27540000
275500                STRING                                            27550000
275600                 AU015-B32-ID-CODE-ACQ-INS(1:AU015-B32-LENGTH)    27560000
275700                    DELIMITED BY AU015-B32-LENGTH                 27570000
275800                  INTO AURD018-DATA                               27580000
275900                   WITH POINTER PV-RESPONSE-LEN                   27590000
276000                                                                  27600000
276100            WHEN 35                                               27610000
276200                                                                  27620000
276300                 STRING AU015-B35-LENGTH                          27630000
276400                    DELIMITED BY SIZE                             27640000
276500                  INTO AURD018-DATA                               27650000
276600                   WITH POINTER PV-RESPONSE-LEN                   27660000
276700                                                                  27670000
276800                STRING                                            27680000
276900                  AU015-B35-INC-TRACK2-DATA(1:AU015-B35-LENGTH)   27690000
277000                    DELIMITED BY SIZE                             27700074
277100                  INTO AURD018-DATA                               27710000
277200                   WITH POINTER PV-RESPONSE-LEN                   27720000
277300                                                                  27730000
277400            WHEN 37                                               27740000
277500                 STRING AU015-B37-RETR-REF-NBR                    27750000
277600                    DELIMITED BY SIZE                             27760000
277700                  INTO AURD018-DATA                               27770000
277800                   WITH POINTER PV-RESPONSE-LEN                   27780000
277900                                                                  27790000
278000            WHEN 38                                               27800000
278100                 STRING AU015-B38-AUTH-ID-RESPONSE                27810000
278200                    DELIMITED BY SIZE                             27820000
278300                  INTO AURD018-DATA                               27830000
278400                   WITH POINTER PV-RESPONSE-LEN                   27840000
278500                                                                  27850000
278600            WHEN 39                                               27860000
278700                                                                  27870000
278800                 STRING AU015-B39-RESPONSE-CODE                   27880000
278900                    DELIMITED BY SIZE                             27890000
279000                  INTO AURD018-DATA                               27900000
279100                   WITH POINTER PV-RESPONSE-LEN                   27910000
279200                                                                  27920000
279300            WHEN 41                                               27930000
279400                                                                  27940000
279500                 STRING AU015-B41-CARD-ACCEPT-TERM                27950000
279600                    DELIMITED BY SIZE                             27960000
279700                  INTO AURD018-DATA                               27970000
279800                   WITH POINTER PV-RESPONSE-LEN                   27980000
279900            WHEN 42                                               27990000
280000                                                                  28000000
280100                 STRING AU015-B42-CAT-ID-CDE                      28010000
280200                    DELIMITED BY SIZE                             28020000
280300                  INTO AURD018-DATA                               28030000
280400                   WITH POINTER PV-RESPONSE-LEN                   28040000
280500            WHEN 44                                               28050000
280600                                                                  28060000
280700                 STRING AU015-B44-LENGTH                          28070000
280800                    DELIMITED BY SIZE                             28080000
280900                  INTO AURD018-DATA                               28090000
281000                   WITH POINTER PV-RESPONSE-LEN                   28100000
281100                                                                  28110000
281200                 STRING AU015-B44-ADDTL-RESP(1:AU015-B44-LENGTH)  28120000
281300                    DELIMITED BY AU015-B44-LENGTH                 28130000
281400                  INTO AURD018-DATA                               28140000
281500                   WITH POINTER PV-RESPONSE-LEN                   28150000
281600                                                                  28160000
281700            WHEN 45                                               28170000
281800                                                                  28180000
281900                 STRING AU015-B45-LENGTH                          28190000
282000                    DELIMITED BY SIZE                             28200000
282100                  INTO AURD018-DATA                               28210000
282200                   WITH POINTER PV-RESPONSE-LEN                   28220000
282300                                                                  28230000
282400                 STRING AU015-B45-TRACK-1-DATA(1:AU015-B45-LENGTH)28240000
282500                    DELIMITED BY AU015-B45-LENGTH                 28250000
282600                  INTO AURD018-DATA                               28260000
282700                   WITH POINTER PV-RESPONSE-LEN                   28270000
282800                                                                  28280000
282900            WHEN 46                                               28290000
283000                                                                  28300000
283100                 STRING AU015-B46-LENGTH                          28310000
283200                    DELIMITED BY SIZE                             28320000
283300                  INTO AURD018-DATA                               28330000
283400                   WITH POINTER PV-RESPONSE-LEN                   28340000
283500                                                                  28350000
283600                 STRING AU015-B46-TXT-FASTPIN(1:AU015-B46-LENGTH) 28360000
283700                    DELIMITED BY AU015-B46-LENGTH                 28370000
283800                  INTO AURD018-DATA                               28380000
283900                   WITH POINTER PV-RESPONSE-LEN                   28390000
284000                                                                  28400000
284100            WHEN 47                                               28410000
284200                                                                  28420000
284300                 STRING AU015-B47-LENGTH                          28430000
284400                    DELIMITED BY SIZE                             28440000
284500                  INTO AURD018-DATA                               28450000
284600                   WITH POINTER PV-RESPONSE-LEN                   28460000
284700                                                                  28470000
284800                 STRING AU015-B47-PROMO(1:AU015-B47-LENGTH)       28480000
284900                    DELIMITED BY AU015-B47-LENGTH                 28490000
285000                  INTO AURD018-DATA                               28500000
285100                   WITH POINTER PV-RESPONSE-LEN                   28510000
285200                                                                  28520000
285300            WHEN 48                                               28530000
285400                                                                  28540000
285500                 STRING AU015-B48-LENGTH                          28550000
285600                    DELIMITED BY SIZE                             28560000
285700                  INTO AURD018-DATA                               28570000
285800                   WITH POINTER PV-RESPONSE-LEN                   28580000
285900                                                                  28590000
286000                 STRING AU015-B48-TXT(1:AU015-B48-LENGTH)         28600000
286100                    DELIMITED BY AU015-B48-LENGTH                 28610000
286200                  INTO AURD018-DATA                               28620000
286300                   WITH POINTER PV-RESPONSE-LEN                   28630000
286400            WHEN 49                                               28640000
286500                                                                  28650000
286600                 STRING AU015-B49-CURRENCY-CODE                   28660000
286700                    DELIMITED BY SIZE                             28670000
286800                  INTO AURD018-DATA                               28680000
286900                   WITH POINTER PV-RESPONSE-LEN                   28690000
287000            WHEN 53                                               28700000
287100                                                                  28710000
287200                 STRING AU015-B53-SEC-REL-CTRL                    28720000
287300                    DELIMITED BY SIZE                             28730000
287400                  INTO AURD018-DATA                               28740000
287500                   WITH POINTER PV-RESPONSE-LEN                   28750000
287600                                                                  28760000
287700            WHEN 54                                               28770000
287800                                                                  28780000
287900                 STRING AU015-B54-LENGTH                          28790000
288000                    DELIMITED BY SIZE                             28800000
288100                  INTO AURD018-DATA                               28810000
288200                   WITH POINTER PV-RESPONSE-LEN                   28820000
288300                                                                  28830000
288400                 STRING                                           28840000
288500                  AU015-B54-ADDTL-PROD-DATA(1:AU015-B54-LENGTH)   28850000
288600                    DELIMITED BY AU015-B54-LENGTH                 28860000
288700                  INTO AURD018-DATA                               28870000
288800                   WITH POINTER PV-RESPONSE-LEN                   28880000
288900                                                                  28890000
289000            WHEN 59                                               28900000
289100                                                                  28910000
289200                 STRING AU015-B59-LENGTH                          28920000
289300                    DELIMITED BY SIZE                             28930000
289400                  INTO AURD018-DATA                               28940000
289500                   WITH POINTER PV-RESPONSE-LEN                   28950000
289600                                                                  28960000
289700                 STRING                                           28970000
289800                 AU015-B59-RESERVE-NATL(1:AU015-B59-LENGTH)       28980000
289900                    DELIMITED BY AU015-B59-LENGTH                 28990000
290000                  INTO AURD018-DATA                               29000000
290100                   WITH POINTER PV-RESPONSE-LEN                   29010000
290200                                                                  29020000
290300            WHEN 63                                               29030000
290400                                                                  29040000
290500                 STRING AU015-B63-LENGTH                          29050000
290600                    DELIMITED BY SIZE                             29060000
290700                  INTO AURD018-DATA                               29070000
290800                   WITH POINTER PV-RESPONSE-LEN                   29080000
290900                                                                  29090000
291000                STRING AU015-B63-RESERVE-PRIV(1:AU015-B63-LENGTH) 29100000
291100                    DELIMITED BY AU015-B63-LENGTH                 29110000
291200                  INTO AURD018-DATA                               29120000
291300                   WITH POINTER PV-RESPONSE-LEN                   29130000
291400          END-EVALUATE.                                           29140000
291500                                                                  29150000
291600******************************************************************29160012
291700*     7800-INCOMM-FIND-STAN                                     * 29170012
291800* ==> PROCESSES:                                                 *29180012
291900*     -CHECKS THE 3RD PARTY TABLE FOR MATCHING STAN              *29190012
292000*     -IF STAN MATCHES, THEN NEED TO CHECK TO SEE IF IT WAS       29200012
292100*      BEEN REVERSED                                              29210012
292200*     -IF IT WAS REVERSED, THEN WE DON'T WANT TO DEACTIVATE       29220012
292300*     -IF IT WAS NOT REVERSED, THEN WE WANT TO ACTIVATE.          29230012
292400* ==> PERFORMED FROM:                                            *29240012
292500******************************************************************29250012
292600 7900-INCOMM-FIND-STAN.                                           29260012
292700                                                                  29270012
292800     SET PV-STAN-NOT-FOUND TO TRUE                                29280049
292900     MOVE SPACES TO SV005-PV-TMST-DATE                            29290021
293000                                                                  29300012
293100     EXEC SQL                                                     29310012
293200         SELECT  MAX(TRN_AUTH_TMST)                               29320037
293300           INTO  :SVT00015-TRN-AUTH-TMST                          29330012
293400           FROM  SVT_3RD_PTY_TRN                                  29340012
293500          WHERE  CRD_NBR          = :SV005-KMC-ID                 29350023
293600            AND  POS_REF_NBR      = :SV005-PV-STAN-NBR            29360012
293700     END-EXEC.                                                    29370012
293800                                                                  29380012
293900     EVALUATE TRUE                                                29390012
294000         WHEN SQLCODE = 0                                         29400012
294100             SET PV-STAN-FOUND TO TRUE                            29410049
294200             MOVE SVT00015-TRN-AUTH-TMST TO SV005-PV-TMST-DATE    29420014
294300         WHEN SQLCODE = +100                                      29430012
294400         WHEN SQLCODE = -305                                      29440073
294500             SET PV-STAN-NOT-FOUND TO TRUE                        29450049
294600                                                                  29460012
294700         WHEN OTHER                                               29470012
294800             SET PV-STAN-NOT-FOUND TO TRUE                        29480049
294900                                                                  29490012
295000             MOVE '7900-INCOMM-FIND-STAN'                         29500012
295100                                TO AA-ATTEMPTED-ACTION            29510012
295200             PERFORM 9100-DB2-ERROR                               29520012
295300     END-EVALUATE.                                                29530012
295400                                                                  29540012
295500                                                                  29550000
295600******************************************************************29560056
295700*     7950-INCOMM-FIND-LAST-ACT                                 * 29570056
295800* ==> PROCESSES:                                                 *29580056
295900*     -CHECKS THE ACTIVITY TABLE FOR THE LAST CARD THAT WAS      *29590067
296000*      ACTIVATED.  THIS IS SO THAT WE REVERSE  THE DEACTIVATION   29600067
296100*      WE WANT TO MAKE SURE THAT WE ACTIVATE THE MOST RECENT      29610067
296200*      ACTIVATION.                                                29620067
296300*    - WE NEED TO GET THE TIMESTAMP FROM HERE SO WE CAN UPDATE    29630067
296400*      THE CORRECT ROW ON THE ACTIVITY TABLE.                     29640067
296500* ==> PERFORMED FROM: 2000-AUTHORIZE-REQUEST                     *29650067
296600******************************************************************29660056
296700 7950-INCOMM-FIND-LAST-ACT.                                       29670056
296800                                                                  29680056
296900     SET SV005-NORMAL TO TRUE                                     29690060
297000     MOVE SV005-REVERSAL-CODE TO SVT00002-TRN-RVRSL-CDE.          29700060
297100                                                                  29710056
297200     MOVE SPACES                 TO SV005-PV-TMST-DATE            29720056
297300                                                                  29730056
297400     EXEC SQL                                                     29740056
297500         SELECT  MAX(TRN_AUTH_TMST)                               29750056
297600           INTO  :SVT00002-TRN-AUTH-TMST                          29760056
297700           FROM  SVT_KOHLS_CRD_TXN                                29770056
297800         WHERE CRD_NBR       = :SVT00002-CRD-NBR                  29780056
297900           AND TRN_RVRSL_CDE = :SVT00002-TRN-RVRSL-CDE            29790056
298000           AND ACTVY_TYP_CDE = :SVT00002-ACTVY-TYP-CDE            29800056
298100           AND STR_NBR       = :SVT00002-STR-NBR                  29810056
298200           AND APP_AUTH_AMT  = :SVT00002-APP-AUTH-AMT             29820056
298300     END-EXEC.                                                    29830056
298400                                                                  29840056
298500     EVALUATE TRUE                                                29850056
298600         WHEN SQLCODE = 0                                         29860056
298700             MOVE SVT00002-TRN-AUTH-TMST TO SV005-PV-TMST-DATE    29870058
298800         WHEN SQLCODE = +100 OR -310                              29880058
298900             CONTINUE                                             29890056
299000                                                                  29900056
299100         WHEN OTHER                                               29910056
299200             MOVE '7950-INCOMM-FIND-LAST-ACT'                     29920056
299300                                TO AA-ATTEMPTED-ACTION            29930056
299400             PERFORM 9100-DB2-ERROR                               29940056
299500     END-EVALUATE.                                                29950056
299600                                                                  29960056
299700                                                                  29970056
299800*----------------------------------------------------------------*29980056
299900* SEND DATA TO LISTENER.                                         *29990000
300000* PUT THE RESPONSE ON THE TEMP STORAGE QUEUE TO BE READ BY       *30000000
300100* BY THE LISTENER PROGRAM.                                       *30010000
300200*  QUEUE FORMAT:                                                 *30020000
300300*  LINE 1: # OF NEXT RECORD TO BE WRITTEN TO THE QUEUE BY THE    *30030000
300400*          CHILD PROGRAM, FOLLOWED BY THE TOTAL NUMBER OF        *30040000
300500*          POSSIBLE ENTRIES IN THE QUEUE (100)                   *30050000
300600*  LINE 2: # OF NEXT RECORD TO BE READ BY LISTENER FOLLOWED BY   *30060000
300700*          TOTAL NUMBER OF POSSIBLE ENTRIES IN THE QUEUE (100)   *30070000
300800*          (ONLY USED BY LISTENER)                               *30080000
300900*  LINES 3 TO 100: RESPONSES FROM CHILD PROGRAMS IN FORMAT       *30090000
301000*                  TCP-BUF-OUT                                   *30100000
301100*----------------------------------------------------------------*30110000
301200 8000-SEND-DATA-TO-LISTENER.                                      30120000
301300     PERFORM 8110-ENQ-TCPIPPRQ.                                   30130000
301400     PERFORM 8120-READQ-TCPIPPRQ-RECORD1.                         30140000
301500                                                                  30150000
301600     PERFORM 8140-REWRITE-TCPIPPRQ-NEXT-REC.                      30160000
301700     ADD 1 TO PV-NEXT-RECORD.                                     30170000
301800                                                                  30180000
301900     IF PV-NEXT-RECORD > PV-TOTAL-RECORDS                         30190000
302000         MOVE 3 TO PV-NEXT-RECORD                                 30200000
302100     END-IF.                                                      30210000
302200                                                                  30220000
302300     PERFORM 8150-REWRITE-TCPIPPRQ-RECORD1.                       30230000
302400     PERFORM 8160-DEQ-TCPIPPRQ.                                   30240000
302500                                                                  30250000
302600*----------------------------------------------------------------*30260000
302700 8110-ENQ-TCPIPPRQ.                                               30270000
302800     EXEC CICS                                                    30280000
302900         ENQ                                                      30290000
303000             RESOURCE  (PV-TSQ-NAME)                              30300000
303100             RESP      (PV-CICS-RESPONSE)                         30310000
303200     END-EXEC.                                                    30320000
303300                                                                  30330000
303400     EVALUATE TRUE                                                30340000
303500         WHEN PV-CICS-RESPONSE = DFHRESP (NORMAL)                 30350000
303600             CONTINUE                                             30360000
303700         WHEN OTHER                                               30370000
303800             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            30380000
303900             SET EP000-SL-ERROR TO TRUE                           30390000
304000             STRING '8110-ENQ-TCPIPPRQ'                           30400000
304100                    ' ERROR ON ENQ TEMP STORAGE QUEUE: '          30410000
304200                     PV-TSQ-NAME                                  30420000
304300                     ' RESP:'                                     30430000
304400                     PV-CICS-RESPONSE-DISP                        30440000
304500                       DELIMITED BY SIZE                          30450000
304600                       INTO EP000-MD-SYSTEM-LOG-MESSAGE           30460000
304700                                (EP000-MESSAGE-LINE-COUNTER)      30470000
304800             PERFORM EP000-1000-POST-MESSAGE                      30480000
304900             PERFORM 9999-RETURN-TO-NATIVE-CICS                   30490000
305000     END-EVALUATE.                                                30500000
305100                                                                  30510000
305200*----------------------------------------------------------------*30520000
305300 8120-READQ-TCPIPPRQ-RECORD1.                                     30530000
305400     MOVE LENGTH OF PV-TCPIPPRQ-RECORD1 TO PV-TSQ-LENGTH.         30540000
305500                                                                  30550000
305600     EXEC CICS                                                    30560000
305700         READQ TS                                                 30570000
305800             QUEUE   (PV-TSQ-NAME)                                30580000
305900             INTO    (PV-TCPIPPRQ-RECORD1)                        30590000
306000             LENGTH  (PV-TSQ-LENGTH)                              30600000
306100             ITEM    (1)                                          30610000
306200             RESP    (PV-CICS-RESPONSE)                           30620000
306300     END-EXEC.                                                    30630000
306400                                                                  30640000
306500     EVALUATE TRUE                                                30650000
306600         WHEN PV-CICS-RESPONSE = DFHRESP (NORMAL)                 30660000
306700             CONTINUE                                             30670000
306800         WHEN OTHER                                               30680000
306900             SET EP000-SL-ERROR         TO TRUE                   30690000
307000             MOVE PV-CICS-RESPONSE TO PV-CICS-RESPONSE-DISP       30700000
307100             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            30710000
307200             STRING '8120-READQ-TCPIPPRQ-RECORD1'                 30720000
307300                    ' ERROR ON READ TEMP STORAGE QUEUE: '         30730000
307400                     PV-TSQ-NAME                                  30740000
307500                     ' RESP:'                                     30750000
307600                     PV-CICS-RESPONSE-DISP                        30760000
307700                       DELIMITED BY SIZE                          30770000
307800                       INTO EP000-MD-SYSTEM-LOG-MESSAGE           30780000
307900                                (EP000-MESSAGE-LINE-COUNTER)      30790000
308000             PERFORM EP000-1000-POST-MESSAGE                      30800000
308100             PERFORM 9999-RETURN-TO-NATIVE-CICS                   30810000
308200     END-EVALUATE.                                                30820000
308300                                                                  30830000
308400*----------------------------------------------------------------*30840000
308500 8140-REWRITE-TCPIPPRQ-NEXT-REC.                                  30850000
308600                                                                  30860000
308700     INITIALIZE   PV-TSQ-DATA-RECORD.                             30870000
308800     MOVE +9998                        TO  PV-TSQ-LENGTH.         30880000
308900     MOVE AURD018-GC-RESP-TSQ-RECORD   TO  PV-TSQ-DATA-PORTION.   30890000
309000     MOVE PV-NEXT-RECORD               TO  PV-ITEM-NBR.           30900000
309100                                                                  30910000
309200     EXEC CICS                                                    30920000
309300         WRITEQ TS                                                30930000
309400             QUEUE   (PV-TSQ-NAME)                                30940000
309500             FROM    (PV-TSQ-DATA-RECORD)                         30950000
309600             LENGTH  (PV-TSQ-LENGTH)                              30960000
309700             ITEM    (PV-ITEM-NBR)                                30970000
309800                 REWRITE                                          30980000
309900             RESP    (PV-CICS-RESPONSE)                           30990000
310000     END-EXEC.                                                    31000000
310100                                                                  31010000
310200     EVALUATE TRUE                                                31020000
310300         WHEN PV-CICS-RESPONSE = DFHRESP (NORMAL)                 31030000
310400             CONTINUE                                             31040000
310500         WHEN OTHER                                               31050000
310600             SET EP000-SL-ERROR         TO TRUE                   31060000
310700             MOVE PV-CICS-RESPONSE TO PV-CICS-RESPONSE-DISP       31070000
310800             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            31080000
310900             STRING '8140-REWRITE-TCPIPPRQ-NEXT-REC'              31090000
311000                    ' ERROR WRITING TO TEMP STORAGE QUEUE: '      31100000
311100                     PV-TSQ-NAME                                  31110000
311200                     ' RESP:'                                     31120000
311300                     PV-CICS-RESPONSE-DISP                        31130000
311400                       DELIMITED BY SIZE                          31140000
311500                       INTO EP000-MD-SYSTEM-LOG-MESSAGE           31150000
311600                                (EP000-MESSAGE-LINE-COUNTER)      31160000
311700             PERFORM EP000-1000-POST-MESSAGE                      31170000
311800             PERFORM 9999-RETURN-TO-NATIVE-CICS                   31180000
311900     END-EVALUATE.                                                31190000
312000                                                                  31200000
312100*----------------------------------------------------------------*31210000
312200 8150-REWRITE-TCPIPPRQ-RECORD1.                                   31220000
312300     MOVE LENGTH OF PV-TCPIPPRQ-RECORD1 TO PV-TSQ-LENGTH.         31230000
312400     MOVE +1 TO PV-ITEM-NBR.                                      31240000
312500                                                                  31250000
312600     EXEC CICS                                                    31260000
312700         WRITEQ TS                                                31270000
312800             QUEUE   (PV-TSQ-NAME)                                31280000
312900             FROM    (PV-TCPIPPRQ-RECORD1)                        31290000
313000             LENGTH  (PV-TSQ-LENGTH)                              31300000
313100             ITEM    (PV-ITEM-NBR)                                31310000
313200                 REWRITE                                          31320000
313300             RESP    (PV-CICS-RESPONSE)                           31330000
313400     END-EXEC.                                                    31340000
313500                                                                  31350000
313600     EVALUATE TRUE                                                31360000
313700         WHEN PV-CICS-RESPONSE = DFHRESP (NORMAL)                 31370000
313800             CONTINUE                                             31380000
313900         WHEN OTHER                                               31390000
314000             SET EP000-SL-ERROR         TO TRUE                   31400000
314100             MOVE PV-CICS-RESPONSE TO PV-CICS-RESPONSE-DISP       31410000
314200             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            31420000
314300             STRING '8140-REWRITE-TCPIPPRQ-RECORD1'               31430000
314400                    ' ERROR WRITING TO TEMP STORAGE QUEUE: '      31440000
314500                     PV-TSQ-NAME                                  31450000
314600                     ' RESP:'                                     31460000
314700                     PV-CICS-RESPONSE-DISP                        31470000
314800                       DELIMITED BY SIZE                          31480000
314900                       INTO EP000-MD-SYSTEM-LOG-MESSAGE           31490000
315000                                (EP000-MESSAGE-LINE-COUNTER)      31500000
315100             PERFORM EP000-1000-POST-MESSAGE                      31510000
315200             PERFORM 9999-RETURN-TO-NATIVE-CICS                   31520000
315300     END-EVALUATE.                                                31530000
315400                                                                  31540000
315500*----------------------------------------------------------------*31550000
315600 8160-DEQ-TCPIPPRQ.                                               31560000
315700     EXEC CICS                                                    31570000
315800         DEQ                                                      31580000
315900             RESOURCE  (PV-TSQ-NAME)                              31590000
316000             RESP      (PV-CICS-RESPONSE)                         31600000
316100     END-EXEC.                                                    31610000
316200                                                                  31620000
316300     EVALUATE TRUE                                                31630000
316400         WHEN PV-CICS-RESPONSE = DFHRESP (NORMAL)                 31640000
316500             CONTINUE                                             31650000
316600         WHEN OTHER                                               31660000
316700             SET EP000-SL-ERROR         TO TRUE                   31670000
316800             MOVE PV-CICS-RESPONSE TO PV-CICS-RESPONSE-DISP       31680000
316900             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            31690000
317000             STRING '8160-DEQ-TCPIPPRQ'                           31700000
317100                    ' ERROR ON DEQ TEMP STORAGE QUEUE: '          31710000
317200                     PV-TSQ-NAME                                  31720000
317300                     ' RESP:'                                     31730000
317400                     PV-CICS-RESPONSE-DISP                        31740000
317500                       DELIMITED BY SIZE                          31750000
317600                       INTO EP000-MD-SYSTEM-LOG-MESSAGE           31760000
317700                                (EP000-MESSAGE-LINE-COUNTER)      31770000
317800             PERFORM EP000-1000-POST-MESSAGE                      31780000
317900             PERFORM 9999-RETURN-TO-NATIVE-CICS                   31790000
318000     END-EVALUATE.                                                31800000
318100                                                                  31810000
318200*----------------------------------------------------------------*31820000
318300* MESSAGE MONITORING                                             *31830000
318400* DISPLAY A MESSAGE TO THE EPCL LOG                              *31840000
318500*----------------------------------------------------------------*31850000
318600 8500-MESSAGE-MONITORING.                                         31860000
318700                                                                  31870000
318800     SET EP000-SL-INFORMATION TO  TRUE.                           31880000
318900     MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER.      31890000
319000                                                                  31900000
319100     IF AURD017-MID-0100                                          31910000
319200       SET LM-DM-PREAUTH     TO TRUE                              31920000
319300     ELSE                                                         31930000
319400       IF AURD017-MID-0200                                        31940000
319500         SET LM-DM-ISSUE       TO TRUE                            31950000
319600       ELSE                                                       31960000
319700         IF AURD017-MID-0800                                      31970000
319800           SET LM-DM-NETWORK   TO TRUE                            31980000
319900         ELSE                                                     31990000
320000           IF AURD017-MID-0400                                    32000000
320100             SET LM-DM-REVERSAL  TO TRUE                          32010000
320200           ELSE                                                   32020000
320300             SET LM-DM-UNKNOWN   TO TRUE                          32030000
320400           END-IF                                                 32040000
320500         END-IF                                                   32050000
320600       END-IF                                                     32060000
320700     END-IF.                                                      32070000
320800     SET LM-DM-REQUEST-MSG TO TRUE.                               32080000
320900                                                                  32090000
321000     IF SV005-CARD-TYPE NOT = ZERO                                32100000
321100       EVALUATE TRUE                                              32110000
321200         WHEN SV005-KMRC-CRD                                      32120000
321300           SET LM-DM-KMRC-MSG TO  TRUE                            32130000
321400         WHEN SV005-GIFT-CRD                                      32140000
321500           SET LM-DM-GC-MSG TO  TRUE                              32150000
321600       END-EVALUATE                                               32160000
321700     END-IF.                                                      32170000
321800                                                                  32180000
321900     MOVE ZERO TO LM-DM-APPROVE-AMOUNT.                           32190000
322000     MOVE ZERO TO LM-DM-BALANCE.                                  32200000
322100     IF LM-DM-RSP                                                 32210000
322200       SET LM-DM-RC-DISPLAY TO TRUE                               32220000
322300       MOVE AU015-B39-RESPONSE-CODE     TO LM-DM-RESP-CD          32230068
322400       MOVE SV005-APPROVED-TENDER-AMT   TO LM-DM-APPROVE-AMOUNT   32240000
322410* TDH001 DIVIDE BY 100 FOR LOG DISPLAY                            32241078
322420       COMPUTE SV005-KMC-REMAINING-BALANCE =                      32242077
322430               SV005-KMC-REMAINING-BALANCE / 100                  32243077
322431* TDH001 DIVIDE BY 100 FOR LOG DISPLAY                            32243178
322500       MOVE SV005-KMC-REMAINING-BALANCE TO LM-DM-BALANCE          32250000
322600     END-IF.                                                      32260000
322700     MOVE SV005-STORE-NBR        TO  LM-DM-STORE-NBR.             32270000
322800     MOVE SV005-TERMINAL-NBR     TO  LM-DM-TERM-NBR.              32280000
322900     MOVE SV005-TRANSACTION-NBR  TO  LM-DM-TRAN-NBR.              32290000
323000     MOVE PV-KMC-AMT             TO  LM-DM-TRAN-AMOUNT.           32300000
323100                                                                  32310000
323200     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   32320000
323300     MOVE LM-LOG-DISPLAY-MESSAGE                                  32330000
323400         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          32340000
323500                 (EP000-MESSAGE-LINE-COUNTER).                    32350000
323600     PERFORM EP000-1000-POST-MESSAGE.                             32360000
323700                                                                  32370000
323800*----------------------------------------------------------------*32380004
323900*  CONVERTING 16 DIGITS TO PACKED 8 NON NUMERIC.                 *32390004
324000*----------------------------------------------------------------*32400004
324100 9000-PACK-EBCDIC-TO-BCD.                                         32410004
324200     INITIALIZE BC-BCD-FIELD.                                     32420004
324300     MOVE +1 TO BC-BCD-POSITION                                   32430004
324400                BC-NIBBLE-COUNT.                                  32440004
324500     PERFORM                                                      32450004
324600             VARYING BC-EBCDIC-POSITION                           32460004
324700             FROM 1 BY 1                                          32470004
324800             UNTIL BC-EBCDIC-POSITION >                           32480004
324900                       (LENGTH OF BC-EBCDIC-FIELD)                32490004
325000         MOVE BC-EBCDIC-FIELD (BC-EBCDIC-POSITION:1) TO           32500004
325100                   BC-EBCDIC-CHAR                                 32510004
325200         EVALUATE TRUE                                            32520004
325300             WHEN BC-EBCDIC-CHAR-0-9                              32530004
325400                 SUBTRACT BC-ZONE-F FROM BC-EBCDIC-CHAR-COMP      32540004
325500             WHEN BC-EBCDIC-CHAR-A-F                              32550004
325600                 SUBTRACT BC-ZONE-C FROM BC-EBCDIC-CHAR-COMP      32560004
325700             WHEN OTHER                                           32570004
325800                 INITIALIZE BC-EBCDIC-CHAR-COMP                   32580004
325900         END-EVALUATE                                             32590004
326000         IF BC-NIBBLE-COUNT < BC-MAXIMUM-NIBBLES                  32600004
326100             COMPUTE BC-EBCDIC-CHAR-HIGH-ORDER =                  32610004
326200                       (BC-EBCDIC-CHAR-COMP *                     32620004
326300                       BC-NIBBLE-SHIFT)                           32630004
326400             ADD +1 TO BC-NIBBLE-COUNT                            32640004
326500         ELSE                                                     32650004
326600             COMPUTE BC-BCD-BYTE-COMP =                           32660004
326700                       (BC-EBCDIC-CHAR-HIGH-ORDER +               32670004
326800                       BC-EBCDIC-CHAR-COMP)                       32680004
326900             MOVE BC-BCD-BYTE-CHAR TO                             32690004
327000                       BC-BCD-FIELD (BC-BCD-POSITION:1)           32700004
327100             ADD +1 TO   BC-BCD-POSITION                          32710004
327200             MOVE +1 TO BC-NIBBLE-COUNT                           32720004
327300         END-IF                                                   32730004
327400     END-PERFORM.                                                 32740004
327500                                                                  32750004
327600                                                                  32760004
327700*----------------------------------------------------------------*32770004
327800*  THIS WILL UNPACK THE 8 BYTE AND MAKE 16.                   S  *32780004
327900*----------------------------------------------------------------*32790004
328000 9050-UNPACK-BCD-TO-EBCDIC.                                       32800004
328100     INITIALIZE BC-EBCDIC-FIELD                                   32810004
328200                BC-EBCDIC-CHAR-COMP.                              32820004
328300     MOVE +1 TO BC-EBCDIC-POSITION.                               32830004
328400     PERFORM                                                      32840004
328500             VARYING BC-BCD-POSITION                              32850004
328600             FROM 1 BY 1                                          32860004
328700             UNTIL BC-BCD-POSITION > (LENGTH OF BC-BCD-FIELD)     32870004
328800         MOVE BC-BCD-FIELD (BC-BCD-POSITION:1) TO                 32880004
328900                   BC-BCD-BYTE-CHAR                               32890004
329000         COMPUTE BC-BCD-BYTE-COMP =                               32900004
329100                   (BC-BCD-BYTE-COMP *                            32910004
329200                   BC-NIBBLE-SHIFT)                               32920004
329300         MOVE BC-HIGH-ORDER-BYTE TO BC-HIGH-ORDER-BYTE-HOLD       32930004
329400         MOVE LOW-VALUES TO BC-HIGH-ORDER-BYTE                    32940004
329500         COMPUTE BC-BCD-BYTE-COMP =                               32950004
329600                   (BC-BCD-BYTE-COMP /                            32960004
329700                   BC-NIBBLE-SHIFT)                               32970004
329800         MOVE BC-BCD-BYTE-CHAR TO BC-LOW-ORDER-BYTE-HOLD          32980004
329900         MOVE BC-HIGH-ORDER-BYTE-HOLD TO BC-EBCDIC-CHAR           32990004
330000         IF BC-BCD-NIBBLE-0-9                                     33000004
330100             ADD BC-ZONE-F TO BC-EBCDIC-CHAR-COMP                 33010004
330200         ELSE                                                     33020004
330300             ADD BC-ZONE-C TO BC-EBCDIC-CHAR-COMP                 33030004
330400         END-IF                                                   33040004
330500         MOVE BC-EBCDIC-CHAR TO                                   33050004
330600                   BC-EBCDIC-FIELD (BC-EBCDIC-POSITION:1)         33060004
330700         ADD +1 TO BC-EBCDIC-POSITION                             33070004
330800         MOVE BC-LOW-ORDER-BYTE-HOLD TO BC-EBCDIC-CHAR            33080004
330900         IF BC-BCD-NIBBLE-0-9                                     33090004
331000             ADD BC-ZONE-F TO BC-EBCDIC-CHAR-COMP                 33100004
331100         ELSE                                                     33110004
331200             ADD BC-ZONE-C TO BC-EBCDIC-CHAR-COMP                 33120004
331300         END-IF                                                   33130004
331400         MOVE BC-EBCDIC-CHAR TO                                   33140004
331500                   BC-EBCDIC-FIELD (BC-EBCDIC-POSITION:1)         33150004
331600         ADD +1 TO BC-EBCDIC-POSITION                             33160004
331700     END-PERFORM.                                                 33170004
331800                                                                  33180004
331900*----------------------------------------------------------------*33190000
332000*  FORMAT AND POST INFORMATION RELATIVE TO A DB2 ERROR.  ROLL    *33200000
332100*  BACK ALL RESOURCES.                                           *33210000
332200*----------------------------------------------------------------*33220000
332300 9100-DB2-ERROR.                                                  33230000
332400     SET PS-DB2-ERROR                                             33240000
332500         EP000-SL-ERROR TO TRUE.                                  33250000
332600                                                                  33260000
332700     MOVE SQLCODE TO DE-SQLCODE.                                  33270000
332800     MOVE SQLERRD(3) TO DE-ROWS-PROCESSED.                        33280000
332900     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                    33290000
333000     MOVE DE-DB2-ERROR-MESSAGE                                    33300000
333100         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          33310000
333200                 (EP000-MESSAGE-LINE-COUNTER).                    33320000
333300                                                                  33330000
333400     MOVE SQLERRMC TO DS-SQLERRMC.                                33340000
333500     ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                     33350000
333600     MOVE DS-DB2-SQLERRMC-MESSAGE                                 33360000
333700         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          33370000
333800                 (EP000-MESSAGE-LINE-COUNTER).                    33380000
333900                                                                  33390000
334000     ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                     33400000
334100     MOVE AA-ATTEMPTED-ACTION-MESSAGE                             33410000
334200         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          33420000
334300                 (EP000-MESSAGE-LINE-COUNTER).                    33430000
334400                                                                  33440000
334500     PERFORM EP000-1000-POST-MESSAGE.                             33450000
334600                                                                  33460000
334700     EXEC CICS                                                    33470000
334800         SYNCPOINT                                                33480000
334900             ROLLBACK                                             33490000
335000     END-EXEC.                                                    33500000
335100                                                                  33510000
335200*----------------------------------------------------------------*33520000
335300*  FORMAT AND POST INFORMATION RELATIVE TO A DB2 WARNING.  ROLL  *33530000
335400*  BACK ALL RESOURCES.                                           *33540000
335500*----------------------------------------------------------------*33550000
335600 9200-DB2-WARNING.                                                33560000
335700     SET PS-DB2-ERROR                                             33570000
335800         EP000-SL-ERROR TO TRUE.                                  33580000
335900                                                                  33590000
336000     MOVE SQLCODE TO DW-SQLCODE.                                  33600000
336100     MOVE SQLERRD(3) TO DW-ROWS-PROCESSED.                        33610000
336200     MOVE SQLWARN TO DW-SQLWARN.                                  33620000
336300     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                    33630000
336400     MOVE DW-DB2-WARNING-MESSAGE                                  33640000
336500         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          33650000
336600                 (EP000-MESSAGE-LINE-COUNTER)                     33660000
336700                                                                  33670000
336800     MOVE SQLERRMC TO DS-SQLERRMC.                                33680000
336900     ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                     33690000
337000     MOVE DS-DB2-SQLERRMC-MESSAGE                                 33700000
337100         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          33710000
337200                 (EP000-MESSAGE-LINE-COUNTER)                     33720000
337300                                                                  33730000
337400     ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                     33740000
337500     MOVE AA-ATTEMPTED-ACTION-MESSAGE                             33750000
337600         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          33760000
337700                 (EP000-MESSAGE-LINE-COUNTER)                     33770000
337800                                                                  33780000
337900     PERFORM EP000-1000-POST-MESSAGE.                             33790000
338000                                                                  33800000
338100     EXEC CICS                                                    33810000
338200         SYNCPOINT                                                33820000
338300             ROLLBACK                                             33830000
338400     END-EXEC.                                                    33840000
338500                                                                  33850000
338600                                                                  33860000
338700*----------------------------------------------------------------*33870000
338800*  TERMINATE THE TRANSACTION.                                    *33880000
338900*----------------------------------------------------------------*33890000
339000 9999-RETURN-TO-NATIVE-CICS.                                      33900000
339100     EXEC CICS                                                    33910000
339200         RETURN                                                   33920000
339300     END-EXEC.                                                    33930000
339400                                                                  33940000
339500*----------------------------------------------------------------*33950000
339600     COPY SVPD005.                                                33960011
339700                                                                  33970000
339800*----------------------------------------------------------------*33980000
339900*    CONVERSION OF CARD NUMBER                                   *33990000
340000*----------------------------------------------------------------*34000000
340100     COPY SVPD007.                                                34010000
340200                                                                  34020000
340300*----------------------------------------------------------------*34030000
340400*  POST ALERT/ERROR ROUTINE.                                      34040000
340500*----------------------------------------------------------------*34050000
340600     COPY EPPD000.                                                34060000
340700                                                                  34070000
340800                                                                  34080000
