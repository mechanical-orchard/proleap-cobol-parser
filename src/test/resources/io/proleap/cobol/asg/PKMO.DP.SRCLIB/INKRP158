       IDENTIFICATION DIVISION.                                                 
       PROGRAM-ID.              INKRP158.                                       
       AUTHOR.                  BOB FORD.                                       
       INSTALLATION.            KOHLS DEPARTMENT STORES.                        
       DATE-WRITTEN.            12/23/2004.                                     
       DATE-COMPILED.                                                           
      ******************************************************************        
      *                                                                *        
      *  CUTOFF DB DATA INTEGRITY/VERIFICATION.                        *        
      *                                                                *        
      *  THIS PROGRAM IS ORIGINALLY NAMED INKUT158 AND IS RENAMED TO   *        
      *  INKRP158 WHEN THE ADDITION OF CUTOFF ON-HAND VERIFICATION.    *        
      *                                                                *        
      *  THE ORIGINAL PROGRAM VERIFIES THAT THE CUMULATIVE POST-FLUSH  *        
      *  ADJUSTMENTS ARE POST CORRECTLY TO THE POST-FLUSH BUCKET.      *        
      *                                                                *        
      *  FOR INVENTORYING STORES THAT HAVE NOT PASSED THEIR INVENTORY  *        
      *  DATE, THIS PROGRAM WILL VERIFY THAT FS ON-HAND MATCH UP WITH  *        
      *  THE CUTOFF DB CUTOFF ON-HAND.                                 *        
      *                                                                *        
      ******************** HISTORY OF CHANGES **************************        
      * CHG ID/                                                        *        
      * WR/PROJ  DATE        DESCRIPTION OF CHANGES                    *        
      * -------  ----------  ----------------------------------------  *        
      * WR26600  2004-12-23  INITIAL PROGRAM INSTALL                   *        
      * WR28543  2005-06-08  RENAME AND ADD CUTOFF ON-HAND CHECK       *        
      *                      - V. LEE YANG                             *        
      * WR27808  2005-06-16  RECOMPILE FOR MANIFEST - V. LEE YANG      *        
W28545* WR28545  2006-08-31  DEPARTMENT LEVEL INVENTORY. INCORPORATE   *        
W28545*                      INVENTORY ID.                             *        
W28545*                      - J. SELWITSCHKA                          *        
W33304* WR33304  2008-04-08  HOLD INVENTORY LEDGER OPEN ACROSS PERIODS *        
W33304*                      - CHUCK EBERT - STRATAGEM                 *        
      ******************************************************************        
                                                                                
       ENVIRONMENT DIVISION.                                                    
       CONFIGURATION SECTION.                                                   
       INPUT-OUTPUT SECTION.                                                    
       FILE-CONTROL.                                                            
                                                                                
           SELECT CTOFF-ADJ-EXTR-FILE                                           
               ASSIGN TO INP01.                                                 
                                                                                
           SELECT CTOFF-CONSOLIDATED-FILE                                       
               ASSIGN TO INP02.                                                 
                                                                                
           SELECT CTOFF-ADJ-RPT                                                 
               ASSIGN TO RPT01.                                                 
                                                                                
           SELECT CTOFF-OH-RPT                                                  
               ASSIGN TO RPT02.                                                 
                                                                                
       DATA DIVISION.                                                           
       FILE SECTION.                                                            
                                                                                
       FD  CTOFF-ADJ-EXTR-FILE                                                  
           RECORDING MODE IS F                                                  
           LABEL RECORDS ARE STANDARD                                           
           BLOCK CONTAINS 0 RECORDS.                                            
       01  CTOFF-ADJ-EXTR-REC              PIC X(48).                           
                                                                                
       FD  CTOFF-CONSOLIDATED-FILE                                              
           RECORDING MODE IS F                                                  
           LABEL RECORDS ARE STANDARD                                           
           BLOCK CONTAINS 0 RECORDS.                                            
       01  CTOFF-CONSOLIDATED-REC          PIC X(56).                           
                                                                                
       FD  CTOFF-ADJ-RPT                                                        
           RECORDING MODE IS F                                                  
           LABEL RECORDS ARE OMITTED                                            
           RECORD CONTAINS 132 CHARACTERS                                       
           DATA RECORD IS CTOFF-ADJ-LINE.                                       
       01  CTOFF-ADJ-LINE                  PIC X(132).                          
                                                                                
       FD  CTOFF-OH-RPT                                                         
           RECORDING MODE IS F                                                  
           LABEL RECORDS ARE OMITTED                                            
           RECORD CONTAINS 132 CHARACTERS                                       
           DATA RECORD IS CTOFF-OH-LINE.                                        
       01  CTOFF-OH-LINE                   PIC X(132).                          
                                                                                
       EJECT                                                                    
       WORKING-STORAGE SECTION.                                                 
                                                                                
       01  FILLER                          PIC X(40)       VALUE                
           '*** WORKING STORAGE AREA BEGIN ***'.                                
                                                                                
      ******************************************************************        
      *  CUTOFF DATABASE CONSOLIDATED EXTRACT                                   
      ******************************************************************        
      *01  IN050-CTOFF-CON-EXTR-RECORD.                                         
           COPY INRD050.                                                        
                                                                                
      ******************************************************************        
      *  CUTOFF DATABASE ADJUSTMENT EXTRACT                                     
      ******************************************************************        
      *01  IN051-CTOFF-ADJ-EXTR-RECORD.                                         
           COPY INRD051.                                                        
                                                                                
       01  FILLER                          PIC X(40)       VALUE                
           '*** REPORT DATA LAYOUT ***'.                                        
                                                                                
      ******************************************************************        
      *  HEADER LINE                                                            
      ******************************************************************        
      *01  DP132O-STANDRD-HEADER-132-COLS.                                      
      *01  01  DP132O-CNFDL-HDR-132-COLS.                                       
           COPY DPWS132O.                                                       
                                                                                
       01  RP-REPORT-TITLE-1.                                                   
           05  FILLER                      PIC X(43)       VALUE SPACES.        
           05  FILLER                      PIC X(46)       VALUE SPACES.        
               88  RP-CTOFF-ADJ-ERR-RPT                    VALUE                
                   'CUT-OFF INVENTORY ADJUSTMENT MISMATCHES REPORT'.            
               88  RP-CTOFF-OH-ERR-RPT                     VALUE                
                   '  CUT-OFF INVENTORY ON-HAND MISMATCHES REPORT '.            
           05  FILLER                      PIC X(43)       VALUE SPACES.        
                                                                                
       01  RP-REPORT-HEADER-1.                                                  
           05  FILLER                      PIC X(01)       VALUE SPACES.        
           05  FILLER                      PIC X(05)       VALUE                
               'STORE'.                                                         
           05  FILLER                      PIC X(01)       VALUE SPACES.        
           05  FILLER                      PIC X(08)       VALUE                
               '   SKU  '.                                                      
           05  FILLER                      PIC X(01)       VALUE SPACES.        
           05  FILLER                      PIC X(13)       VALUE SPACES.        
               88  RP-FILE-QTY-HEADER                      VALUE                
                   '    FILE QTY'.                                              
               88  RP-FS-QTY-HEADER                        VALUE                
                   ' FASHION QTY'.                                              
           05  FILLER                      PIC X(01)       VALUE SPACES.        
           05  FILLER                      PIC X(13)       VALUE                
               'CTOFF DB QTY'.                                                  
           05  FILLER                      PIC X(02)       VALUE SPACES.        
           05  FILLER                      PIC X(40)       VALUE                
               'MESSAGE                                 '.                      
           05  FILLER                      PIC X(47)       VALUE SPACES.        
                                                                                
       01  RP-REPORT-HEADER-2.                                                  
           05  FILLER                      PIC X(01)       VALUE SPACES.        
           05  FILLER                      PIC X(05)      VALUE ALL '-'.        
           05  FILLER                      PIC X(01)       VALUE SPACES.        
           05  FILLER                      PIC X(08)      VALUE ALL '-'.        
           05  FILLER                      PIC X(01)       VALUE SPACES.        
           05  FILLER                      PIC X(13)      VALUE ALL '-'.        
           05  FILLER                      PIC X(01)       VALUE SPACES.        
           05  FILLER                      PIC X(13)      VALUE ALL '-'.        
           05  FILLER                      PIC X(02)       VALUE SPACES.        
           05  FILLER                      PIC X(40)      VALUE ALL '-'.        
           05  FILLER                      PIC X(47)       VALUE SPACES.        
                                                                                
       01  RP-REPORT-DETAIL.                                                    
           05  FILLER                      PIC X(01)       VALUE SPACES.        
           05  RP-LOC-NBR-9                PIC Z9999       VALUE ZEROES.        
           05  RP-LOC-NBR-X REDEFINES RP-LOC-NBR-9                              
                                           PIC X(05).                           
           05  FILLER                      PIC X(01)       VALUE SPACES.        
           05  RP-SKU-X                    PIC X(08)       VALUE SPACES.        
           05  RP-SKU-9 REDEFINES RP-SKU-X PIC 9(08).                           
           05  FILLER                      PIC X(01)       VALUE SPACES.        
           05  RP-FILE-QTY                 PIC ZZZZZZZZZZZ9-                    
                                                           VALUE ZEROES.        
           05  FILLER                      PIC X(01)       VALUE SPACES.        
           05  RP-DATABASE-QTY             PIC ZZZZZZZZZZZ9-                    
                                                           VALUE ZEROES.        
           05  FILLER                      PIC X(02)       VALUE SPACES.        
           05  RP-ERR-MESSAGE              PIC X(40)       VALUE SPACES.        
               88  RP-MISMATCH-ERR                         VALUE                
                   'QUANTITY MISMATCH BETWEEN THE SOURCES   '.                  
               88  RP-NOT-ON-FILE-ERR                      VALUE                
                   'LOC/SKU NOT FOUND ON INPUT FILE         '.                  
               88  RP-NOT-ON-DB-ERR                        VALUE                
                   'LOC/SKU NOT FOUND ON DATABASE           '.                  
               88  RP-NOT-ON-FS-ERR                        VALUE                
                   'LOC/SKU NOT FOUND ON FASHION SALES      '.                  
               88  RP-INVALID-CTOFF-IND                    VALUE                
                   'INVALID CUT-OFF ITEM INDICATOR          '.                  
           05  FILLER                      PIC X(47)       VALUE SPACES.        
                                                                                
       01  RP-REPORT-END.                                                       
           05  FILLER                      PIC X(46)       VALUE SPACES.        
           05  FILLER                      PIC X(39)       VALUE                
               '*****  E N D   O F   R E P O R T  *****'.                       
                                                                                
       01  FILLER                          PIC X(40)       VALUE                
           '*** PROGRAMMING CONSTANT BEGIN ***'.                                
                                                                                
       01  PC-PROGRAM-CONSTANTS-AREA.                                           
           05  PC-PRINT-LINE-MAX           PIC S9(04)      VALUE +57            
                               COMP.                                            
           05  PC-COMPANY                  PIC X(02)       VALUE '03'.          
           05  PC-INCOMPLETE-DTE           PIC X(10)       VALUE                
                                                           '9999-09-09'.        
           05  PC-Y                        PIC X           VALUE 'Y'.           
           05  PC-N                        PIC X           VALUE 'N'.           
                                                                                
       01  FILLER                          PIC X(40)       VALUE                
           '*** PROGRAMMING SWITCHES BEGIN ***'.                                
                                                                                
       01  PS-SWITCHES-AREA.                                                    
           05  PS-END-OF-POST-FLUSH        PIC X           VALUE 'N'.           
               88  END-OF-POST-FLUSH                       VALUE 'Y'.           
               88  NOT-END-OF-POST-FLUSH                   VALUE 'N'.           
           05  PS-END-OF-CTOFF-ADJ         PIC X           VALUE 'N'.           
               88  END-OF-CTOFF-ADJ                        VALUE 'Y'.           
               88  NOT-END-OF-CTOFF-ADJ                    VALUE 'N'.           
           05  PS-END-OF-CTOFF-CON         PIC X           VALUE 'N'.           
               88  END-OF-CTOFF-CON                        VALUE 'Y'.           
               88  NOT-END-OF-CTOFF-CON                    VALUE 'N'.           
                                                                                
       01  FILLER                          PIC X(40)       VALUE                
           '*** REPORT REQUEST CONTROL REC ***'.                                
                                                                                
       01  RQ-RPT-CNTL-AREA.                                                    
           05  RQ-RUN-DATE                 PIC X(10)       VALUE SPACES.        
           05  FILLER REDEFINES RQ-RUN-DATE.                                    
               10  RQ-RUN-DATE-CCYY        PIC X(04).                           
               10  FILLER                  PIC X(01).                           
                   88  RQ-VALID-RQ-RUN-DATE-DASH-1         VALUE '-'.           
               10  RQ-RUN-DATE-MM          PIC X(02).                           
               10  FILLER                  PIC X(01).                           
                   88  RQ-VALID-RQ-RUN-DATE-DASH-2         VALUE '-'.           
               10  RQ-RUN-DATE-DD          PIC X(02).                           
           05  FILLER                      PIC X(70)       VALUE SPACE.         
                                                                                
       01  FILLER                          PIC X(40)       VALUE                
           '*** PROGRAMMING VARIABLE BEGIN ***'.                                
                                                                                
       01  PV-PROGRAM-VARIABLES-AREA.                                           
           05  PV-MATCH-ADJ-COUNT          PIC S9(13)      VALUE ZEROES         
                               COMP-3.                                          
           05  PV-ADJ-MISMATCH-COUNT       PIC S9(13)      VALUE ZEROES         
                               COMP-3.                                          
           05  PV-ADJ-NOT-ON-FILE-COUNT    PIC S9(13)      VALUE ZEROES         
                               COMP-3.                                          
           05  PV-ADJ-NOT-ON-DB-COUNT      PIC S9(13)      VALUE ZEROES         
                               COMP-3.                                          
           05  PV-ADJ-READ-COUNT           PIC S9(13)      VALUE ZEROES         
                               COMP-3.                                          
           05  PV-POST-FLUSH-COUNT         PIC S9(13)      VALUE ZEROES         
                               COMP-3.                                          
           05  PV-CON-READ-COUNT           PIC S9(13)      VALUE ZEROES         
                               COMP-3.                                          
           05  PV-MATCH-CON-COUNT          PIC S9(13)      VALUE ZEROES         
                               COMP-3.                                          
           05  PV-CON-MISMATCH-COUNT       PIC S9(13)      VALUE ZEROES         
                               COMP-3.                                          
           05  PV-CON-NOT-ON-FS-COUNT      PIC S9(13)      VALUE ZEROES         
                               COMP-3.                                          
           05  PV-ZERO-NOT-ON-FS-COUNT     PIC S9(13)      VALUE ZEROES         
                               COMP-3.                                          
           05  PV-CON-NOT-ON-DB-COUNT      PIC S9(13)      VALUE ZEROES         
                               COMP-3.                                          
           05  PV-CON-OTHER-ERR-COUNT      PIC S9(13)      VALUE ZEROES         
                               COMP-3.                                          
           05  PV-PAGE-COUNT               PIC S9(05)      VALUE ZEROES         
                               COMP.                                            
           05  PV-PRINT-LINE-COUNT         PIC S9(04)      VALUE ZEROES         
                               COMP.                                            
           05  PV-ADVANCE-LINE             PIC S9(04)      VALUE ZEROES         
                               COMP.                                            
           05  PV-OPER-ATTEMPTED           PIC X(25)       VALUE SPACES.        
           05  PV-PROCESSING-DATE          PIC X(10)       VALUE SPACES.        
           05  PV-PROCESSING-DATE-RDF REDEFINES PV-PROCESSING-DATE.             
               10  PV-PROCESSING-CC        PIC X(02).                           
               10  PV-PROCESSING-YY        PIC X(02).                           
               10  PV-PROC-DSH1            PIC X(01).                           
               10  PV-PROCESSING-MM        PIC X(02).                           
               10  PV-PROC-DSH2            PIC X(01).                           
               10  PV-PROCESSING-DD        PIC X(02).                           
           05  PV-TODAYS-DATE.                                                  
               10  PV-TODAYS-DATE-YY       PIC 9(02)       VALUE ZEROES.        
               10  PV-TODAYS-DATE-MM       PIC 9(02)       VALUE ZEROES.        
               10  PV-TODAYS-DATE-DD       PIC 9(02)       VALUE ZEROES.        
           05  PV-TODAYS-TIME.                                                  
               10  PV-TODAYS-TIME-HR       PIC 9(02)       VALUE ZEROES.        
               10  PV-TODAYS-TIME-MIN      PIC 9(02)       VALUE ZEROES.        
               10  PV-TODAYS-TIME-SEC      PIC 9(02)       VALUE ZEROES.        
               10  FILLER                  PIC 9(02)       VALUE ZEROES.        
                                                                                
       01  FILLER                          PIC X(40)       VALUE                
           '*** SQL WORK AREA BEGIN ***'.                                       
                                                                                
      *****************************************************************         
      *  SQL ABEND ROUTINE WORKING STORAGE                                      
      *****************************************************************         
      *01  DP004-DB2-ERROR-FIELDS.                                              
           COPY DPWS004.                                                        
                                                                                
       01  ABEND-CODE                      PIC S9(04)      VALUE ZEROES         
                               COMP SYNC.                                       
           88  ABEND-4003                                  VALUE +4003.         
                                                                                
           EXEC SQL                                                             
               INCLUDE SQLCA                                                    
           END-EXEC.                                                            
                                                                                
      *---------------------------------------------------------------* INKCS046
      *    TINVPAR - PHYSICAL INVENTORY PARAMETER TABLE               * INKCS046
      *---------------------------------------------------------------* INKCS046
           EXEC SQL                                                     INKCS046
               INCLUDE TINVPAR                                          INKCS046
           END-EXEC.                                                    INKCS046
                                                                        INKCS046
W28545*---------------------------------------------------------------* INKCS046
W28545*    TINCNTL - PHYSICAL INVENTORY CYCLE CONTROL TABLE           * INKCS046
W28545*---------------------------------------------------------------* INKCS046
W28545     EXEC SQL                                                     INKCS046
W28545         INCLUDE TINCNTL                                          INKCS046
W28545     END-EXEC.                                                    INKCS046
W28545                                                                  INKCS046
      *---------------------------------------------------------------* INKCS046
      *    INT_INV_CTOFF - INVENTORY CUTOFF TABLE                     * INKCS046
      *---------------------------------------------------------------* INKCS046
           EXEC SQL                                                     INKCS046
               INCLUDE INT00000                                         INKCS046
           END-EXEC.                                                    INKCS046
                                                                        INKCS046
      *---------------------------------------------------------------*         
      *    POST-FLUSH CURSOR OF LOCATION/SKU FOR A GIVEN RUN DATE     *         
      *---------------------------------------------------------------*         
           EXEC SQL   DECLARE POST-FLUSH-CSR CURSOR FOR                         
               SELECT A.LOC_NBR                                         INKCS046
                     ,A.SKU_NBR                                                 
                     ,A.POST_FSH_RCPT_QTY                                       
               FROM                                                     INKCS046
                     INT_INV_CTOFF A                                            
               WHERE                                                            
                     A.LOC_NBR IN                                               
                         (SELECT B.LOC_NBR                              INKCS046
                            FROM                                        INKCS046
                                 TINVPAR B                                      
W28545                          ,TINCNTL C                                      
                            WHERE                                               
                                  B.ACTL_DC_CTOFF_DTE  < :RQ-RUN-DATE           
W28545                        AND B.INV_ID           = C.INV_ID                 
W28545                        AND C.ACTV_IND         = 'Y'                      
                              AND B.ACTL_FIN_BK_DTE  = '9999-09-09'             
W33304                        AND B.SCHD_PHY_CNT_CDE = 'PI'                     
W33304                        AND B.LOC_INV_STAT_CDE = 'IN'                     
                              AND B.SCAN_INV_IND     = 'Y')                     
                 AND POST_FSH_RCPT_QTY <> 0                                     
               ORDER BY                                                 INKCS046
                        A.LOC_NBR                                       INKCS046
                       ,A.SKU_NBR                                               
           END-EXEC.                                                            
                                                                                
       01  FILLER                          PIC X(40)       VALUE                
           '*** WORKING STORAGE END ***'.                                       
                                                                                
       EJECT                                                                    
       PROCEDURE DIVISION.                                                      
                                                                                
       A100-MAIN-MODULE.                                                        
      ******************************************************************        
      *  MAIN RPOCESSING.                                                       
      ******************************************************************        
                                                                                
           PERFORM B100-HOUSEKEEPING.                                           
                                                                                
           SET RP-CTOFF-ADJ-ERR-RPT                                             
               RP-FILE-QTY-HEADER      TO TRUE.                                 
           MOVE 1                      TO DP132O-REPORT-NUMBER.                 
           MOVE ZEROES                 TO PV-PAGE-COUNT                         
                                          PV-PRINT-LINE-COUNT.                  
           PERFORM B200-PROCESS-CTOFF-ADJ                                       
               UNTIL END-OF-POST-FLUSH                                          
                   AND END-OF-CTOFF-ADJ.                                        
           MOVE 2 TO PV-ADVANCE-LINE.                                           
           MOVE RP-REPORT-END              TO RP-REPORT-DETAIL.                 
           PERFORM Z500-PRINT-ADJ-DETAIL.                                       
                                                                                
           SET RP-CTOFF-OH-ERR-RPT                                              
               RP-FS-QTY-HEADER        TO TRUE.                                 
           MOVE 2                      TO DP132O-REPORT-NUMBER.                 
           MOVE ZEROES                 TO PV-PAGE-COUNT                         
                                          PV-PRINT-LINE-COUNT.                  
           PERFORM B300-PROCESS-CTOFF-CON                                       
               UNTIL END-OF-CTOFF-CON.                                          
           MOVE 2 TO PV-ADVANCE-LINE.                                           
           MOVE RP-REPORT-END              TO RP-REPORT-DETAIL.                 
           PERFORM Z600-PRINT-CON-DETAIL.                                       
                                                                                
           PERFORM B400-FINALIZE.                                               
                                                                                
           STOP RUN.                                                            
                                                                                
      ******************************************************************        
      * GET THE SYSTEM TIME AND MOVE IT TO THE REPORT HEADING. SET              
      * THE REPORT NAME AND NUMBER.                                             
      ******************************************************************        
       B100-HOUSEKEEPING.                                                       
                                                                                
           ACCEPT PV-TODAYS-DATE FROM DATE.                                     
           ACCEPT PV-TODAYS-TIME FROM TIME.                                     
                                                                                
           MOVE PV-TODAYS-DATE-YY TO PV-PROCESSING-YY.                          
           MOVE PV-TODAYS-DATE-MM TO PV-PROCESSING-MM.                          
           MOVE PV-TODAYS-DATE-DD TO PV-PROCESSING-DD.                          
                                                                                
           MOVE '-' TO PV-PROC-DSH1.                                            
           MOVE '-' TO PV-PROC-DSH2.                                            
                                                                                
           IF PV-TODAYS-DATE-YY > '80'                                          
               MOVE '19' TO PV-PROCESSING-CC                                    
           ELSE                                                                 
               MOVE '20' TO PV-PROCESSING-CC                                    
           END-IF.                                                              
                                                                                
           MOVE PV-TODAYS-DATE-MM  TO DP132O-RUN-MONTH.                         
           MOVE PV-TODAYS-DATE-DD  TO DP132O-RUN-DAY.                           
           MOVE PV-TODAYS-DATE-YY  TO DP132O-RUN-YEAR.                          
           MOVE PV-TODAYS-TIME-HR  TO DP132O-RUN-HOUR.                          
           MOVE PV-TODAYS-TIME-MIN TO DP132O-RUN-MINUTE.                        
           MOVE 'INKRP158'         TO DP132O-PROGRAM-NAME.                      
                                                                                
           OPEN INPUT  CTOFF-ADJ-EXTR-FILE                                      
                       CTOFF-CONSOLIDATED-FILE                                  
                OUTPUT CTOFF-OH-RPT                                             
                       CTOFF-ADJ-RPT.                                           
           SET NOT-END-OF-CTOFF-ADJ                                             
               NOT-END-OF-CTOFF-CON    TO TRUE.                                 
                                                                                
           ACCEPT RQ-RPT-CNTL-AREA FROM SYSIN.                                  
           IF RQ-RUN-DATE NOT = SPACES                                          
               AND RQ-RUN-DATE-CCYY NUMERIC                                     
               AND RQ-RUN-DATE-MM NUMERIC                                       
               AND RQ-RUN-DATE-DD NUMERIC                                       
               AND RQ-VALID-RQ-RUN-DATE-DASH-1                                  
               AND RQ-VALID-RQ-RUN-DATE-DASH-2                                  
               CONTINUE                                                         
           ELSE                                                                 
               DISPLAY '*** DEFAULT RUN/REQUEST DATE TO '                       
                       PV-PROCESSING-DATE                                       
               MOVE PV-PROCESSING-DATE TO RQ-RUN-DATE                           
           END-IF.                                                              
                                                                                
           EXEC SQL                                                             
               OPEN POST-FLUSH-CSR                                              
           END-EXEC.                                                            
                                                                                
           IF SQLCODE = +0                                                      
               SET NOT-END-OF-POST-FLUSH     TO TRUE                            
               PERFORM Z100-FETCH-POST-FLUSH                                    
           ELSE                                                                 
               DISPLAY 'REQUESTED DATE ' RQ-RUN-DATE                            
               MOVE 'OPEN POST-FLUSH-CSR   ' TO PV-OPER-ATTEMPTED               
               PERFORM Z999-SQL-ABEND                                           
           END-IF.                                                              
                                                                                
           PERFORM Z200-READ-CTOFF-ADJ.                                         
           PERFORM Z300-READ-CTOFF-CON.                                         
                                                                                
           MOVE SPACES     TO RP-REPORT-DETAIL.                                 
                                                                                
      ******************************************************************        
      *    PROCESS CUT-OFF ADJUSTMENTS                                          
      ******************************************************************        
       B200-PROCESS-CTOFF-ADJ.                                                  
                                                                                
           IF NOT-END-OF-CTOFF-ADJ AND NOT-END-OF-POST-FLUSH                    
               AND IN051-LOC-NBR      = INT00000-LOC-NBR                        
               AND IN051-SKU-NBR = INT00000-SKU-NBR                             
               IF IN051-QUANTITY = INT00000-POST-FSH-RCPT-QTY                   
                   ADD +1 TO PV-MATCH-ADJ-COUNT                                 
               ELSE                                                             
                   PERFORM C100-ADJ-MISMATCH                                    
               END-IF                                                           
               PERFORM Z100-FETCH-POST-FLUSH                                    
               PERFORM Z200-READ-CTOFF-ADJ                                      
           ELSE                                                                 
               IF END-OF-CTOFF-ADJ                                              
                   OR (IN051-LOC-NBR         > INT00000-LOC-NBR                 
                       OR (IN051-LOC-NBR = INT00000-LOC-NBR AND                 
                           IN051-SKU-NBR > INT00000-SKU-NBR))                   
                   PERFORM C200-ADJ-NOT-ON-FILE                                 
                   PERFORM Z100-FETCH-POST-FLUSH                                
               ELSE                                                             
                   PERFORM C300-ADJ-NOT-ON-DB                                   
                   PERFORM Z200-READ-CTOFF-ADJ                                  
               END-IF                                                           
           END-IF.                                                              
                                                                                
      ******************************************************************        
      *    PROCESS CUT-OFF CONSOLIDATED EXTRACT                                 
      ******************************************************************        
       B300-PROCESS-CTOFF-CON.                                                  
                                                                                
           MOVE IN050-LOC-NBR              TO RP-LOC-NBR-9.                     
           MOVE IN050-SKU-NBR              TO RP-SKU-9.                         
                                                                                
           EVALUATE TRUE                                                        
               WHEN IN050-ITEM-CTOFF-TAKEN                                      
                   MOVE IN050-CTOFF-OH-QTY         TO RP-FILE-QTY               
                   MOVE IN050-OLD-CTOFF-OH-QTY     TO RP-DATABASE-QTY           
                   IF IN050-CTOFF-OH-QTY = IN050-OLD-CTOFF-OH-QTY               
                       ADD +1        TO PV-MATCH-CON-COUNT                      
                   ELSE                                                         
                       ADD 1         TO PV-CON-MISMATCH-COUNT                   
                       SET RP-MISMATCH-ERR             TO TRUE                  
                   END-IF                                                       
               WHEN IN050-ITEM-CTOFF-NOT-TAKEN                                  
                   MOVE IN050-CTOFF-OH-QTY         TO RP-FILE-QTY               
                   ADD +1        TO PV-CON-NOT-ON-DB-COUNT                      
                   SET RP-NOT-ON-DB-ERR            TO TRUE                      
               WHEN IN050-ITEM-CTOFF-EXISTS                                     
                   MOVE IN050-OLD-CTOFF-OH-QTY     TO RP-DATABASE-QTY           
                   ADD +1        TO PV-CON-NOT-ON-FS-COUNT                      
                   IF IN050-OLD-CTOFF-OH-QTY = ZEROES                           
                       ADD +1        TO PV-ZERO-NOT-ON-FS-COUNT                 
                   ELSE                                                         
                       SET RP-NOT-ON-FS-ERR            TO TRUE                  
                   END-IF                                                       
               WHEN OTHER                                                       
                   MOVE IN050-CTOFF-OH-QTY         TO RP-FILE-QTY               
                   MOVE IN050-OLD-CTOFF-OH-QTY     TO RP-DATABASE-QTY           
                   ADD +1        TO PV-CON-OTHER-ERR-COUNT                      
                   SET RP-INVALID-CTOFF-IND        TO TRUE                      
           END-EVALUATE.                                                        
                                                                                
           IF RP-ERR-MESSAGE = SPACES                                           
               MOVE SPACES     TO RP-REPORT-DETAIL                              
           ELSE                                                                 
               PERFORM Z600-PRINT-CON-DETAIL                                    
           END-IF.                                                              
                                                                                
           PERFORM Z300-READ-CTOFF-CON.                                         
                                                                                
      ******************************************************************        
      *    FINALIZE THE REPORT AND CLOSE OUT FILES                              
      ******************************************************************        
       B400-FINALIZE.                                                           
                                                                                
           EXEC SQL                                                             
                CLOSE POST-FLUSH-CSR                                            
           END-EXEC                                                             
           IF SQLCODE NOT = +0                                                  
               MOVE 'CLOSE POST-FLUSH-CSR' TO PV-OPER-ATTEMPTED                 
               PERFORM Z999-SQL-ABEND                                           
           END-IF.                                                              
                                                                                
           DISPLAY ' '.                                                         
           DISPLAY ' ADJUSTMENT RECORD IN:   ' PV-ADJ-READ-COUNT.               
           DISPLAY ' POST-FLUSH FROM DB:     ' PV-POST-FLUSH-COUNT.             
           DISPLAY '   MATCH COUNT:          ' PV-MATCH-ADJ-COUNT.              
           DISPLAY '   MISMATCH COUNT:       ' PV-ADJ-MISMATCH-COUNT.           
           DISPLAY '   NOT ON FILE COUNT:    ' PV-ADJ-NOT-ON-FILE-COUNT.        
           DISPLAY '   NOT ON DB COUNT:      ' PV-ADJ-NOT-ON-DB-COUNT.          
           DISPLAY ' '.                                                         
           DISPLAY ' CONSOLIDATED RECORD IN: ' PV-CON-READ-COUNT.               
           DISPLAY '   MATCH COUNT:          ' PV-MATCH-CON-COUNT.              
           DISPLAY '   MISMATCH COUNT:       ' PV-CON-MISMATCH-COUNT.           
           DISPLAY '   NOT ON FS COUNT:      ' PV-CON-NOT-ON-FS-COUNT.          
           DISPLAY '   NOT ON FS W/ZERO:     ' PV-ZERO-NOT-ON-FS-COUNT.         
           DISPLAY '   NOT ON DB COUNT:      ' PV-CON-NOT-ON-DB-COUNT.          
           DISPLAY '   OTHER ISSUE COUNT:    ' PV-CON-OTHER-ERR-COUNT.          
                                                                                
           CLOSE   CTOFF-ADJ-EXTR-FILE                                          
                   CTOFF-CONSOLIDATED-FILE                                      
                   CTOFF-OH-RPT                                                 
                   CTOFF-ADJ-RPT.                                               
                                                                                
      ******************************************************************        
      *    CREATE REPORT OF MISMATCHED ADJUSTMENTS.                             
      ******************************************************************        
       C100-ADJ-MISMATCH.                                                       
                                                                                
           ADD 1         TO PV-ADJ-MISMATCH-COUNT.                              
                                                                                
           SET RP-MISMATCH-ERR             TO TRUE.                             
           MOVE IN051-LOC-NBR              TO RP-LOC-NBR-9.                     
           MOVE IN051-SKU-NBR              TO RP-SKU-9.                         
           MOVE IN051-QUANTITY             TO RP-FILE-QTY.                      
           MOVE INT00000-POST-FSH-RCPT-QTY TO RP-DATABASE-QTY.                  
                                                                                
           PERFORM Z500-PRINT-ADJ-DETAIL.                                       
                                                                                
      ******************************************************************        
      *    CREATE REPORT OF ADJUSTMENTS NOT ON EXTRACT FILE                     
      ******************************************************************        
       C200-ADJ-NOT-ON-FILE.                                                    
                                                                                
           ADD 1         TO PV-ADJ-NOT-ON-FILE-COUNT.                           
                                                                                
           SET RP-NOT-ON-FILE-ERR          TO TRUE.                             
           MOVE INT00000-LOC-NBR           TO RP-LOC-NBR-9.                     
           MOVE INT00000-SKU-NBR           TO RP-SKU-9.                         
           MOVE INT00000-POST-FSH-RCPT-QTY TO RP-DATABASE-QTY.                  
                                                                                
           PERFORM Z500-PRINT-ADJ-DETAIL.                                       
                                                                                
      ******************************************************************        
      *    CREATE REPORT OF ADJUSTMENTS NOT ON DATABASE                         
      ******************************************************************        
       C300-ADJ-NOT-ON-DB.                                                      
                                                                                
           ADD 1         TO PV-ADJ-NOT-ON-DB-COUNT.                             
                                                                                
           SET RP-NOT-ON-DB-ERR            TO TRUE.                             
           MOVE IN051-LOC-NBR              TO RP-LOC-NBR-9.                     
           MOVE IN051-SKU-NBR              TO RP-SKU-9.                         
           MOVE IN051-QUANTITY             TO RP-FILE-QTY.                      
                                                                                
           PERFORM Z500-PRINT-ADJ-DETAIL.                                       
                                                                                
      ******************************************************************        
      *    FETCH THE NEXT RECORD FROM POST-FLUSH-CSR                            
      ******************************************************************        
       Z100-FETCH-POST-FLUSH.                                                   
                                                                                
           EXEC SQL FETCH POST-FLUSH-CSR                                        
              INTO :INT00000-LOC-NBR                                            
                  ,:INT00000-SKU-NBR                                            
                  ,:INT00000-POST-FSH-RCPT-QTY                                  
           END-EXEC.                                                            
                                                                                
           EVALUATE SQLCODE                                                     
               WHEN +0                                                          
                   ADD 1 TO PV-POST-FLUSH-COUNT                                 
               WHEN +100                                                        
                   SET END-OF-POST-FLUSH       TO TRUE                          
                   MOVE 9999                   TO INT00000-LOC-NBR              
                   MOVE 99999999               TO INT00000-SKU-NBR              
               WHEN OTHER                                                       
                   MOVE 'FETCH POST-FLUSH-CSR' TO  PV-OPER-ATTEMPTED            
                   PERFORM Z999-SQL-ABEND                                       
           END-EVALUATE.                                                        
                                                                                
      ******************************************************************        
      *    READ CUTOFF ADJUSTMENT EXTRACT/FILE                                  
      ******************************************************************        
       Z200-READ-CTOFF-ADJ.                                                     
                                                                                
           READ CTOFF-ADJ-EXTR-FILE                                             
               INTO IN051-CTOFF-ADJ-EXTR-RECORD                                 
               AT END                                                           
                   SET END-OF-CTOFF-ADJ    TO TRUE                              
                   MOVE 9999               TO IN051-LOC-NBR                     
                   MOVE 99999999           TO IN051-SKU-NBR                     
               NOT AT END                                                       
                   ADD 1 TO PV-ADJ-READ-COUNT.                                  
                                                                                
      ******************************************************************        
      *    READ CUTOFF CONSOLIDATED EXTRACT/FILE                                
      ******************************************************************        
       Z300-READ-CTOFF-CON.                                                     
                                                                                
           READ CTOFF-CONSOLIDATED-FILE                                         
               INTO IN050-CTOFF-CON-EXTR-RECORD                                 
               AT END                                                           
                   SET END-OF-CTOFF-CON    TO TRUE                              
               NOT AT END                                                       
                   ADD 1 TO PV-CON-READ-COUNT.                                  
                                                                                
      ******************************************************************        
      *    PRINT CUT-OFF ADJUSTMENT DETAIL LINE                                 
      ******************************************************************        
       Z500-PRINT-ADJ-DETAIL.                                                   
                                                                                
           IF PV-PRINT-LINE-COUNT > PC-PRINT-LINE-MAX                           
               OR PV-PAGE-COUNT   = ZEROES                                      
               PERFORM Z550-PRINT-ADJ-HEADINGS                                  
           END-IF.                                                              
                                                                                
           WRITE CTOFF-ADJ-LINE FROM RP-REPORT-DETAIL                           
               AFTER ADVANCING PV-ADVANCE-LINE LINES.                           
                                                                                
           ADD  PV-ADVANCE-LINE TO PV-PRINT-LINE-COUNT.                         
           MOVE 1               TO PV-ADVANCE-LINE.                             
           MOVE SPACES TO RP-REPORT-DETAIL.                                     
                                                                                
      ******************************************************************        
      *    PRINT ADJUSTMENT REPORT HEADINGS                                     
      ******************************************************************        
       Z550-PRINT-ADJ-HEADINGS.                                                 
                                                                                
           ADD 1 TO PV-PAGE-COUNT.                                              
           MOVE PV-PAGE-COUNT TO DP132O-PAGE-NUMBER.                            
           WRITE CTOFF-ADJ-LINE FROM DP132O-STANDRD-HEADER-132-COLS             
               AFTER ADVANCING PAGE.                                            
                                                                                
           WRITE CTOFF-ADJ-LINE FROM RP-REPORT-TITLE-1.                         
                                                                                
           WRITE CTOFF-ADJ-LINE FROM RP-REPORT-HEADER-1                         
               AFTER ADVANCING 2 LINES.                                         
           WRITE CTOFF-ADJ-LINE FROM RP-REPORT-HEADER-2.                        
                                                                                
           MOVE 6 TO PV-PRINT-LINE-COUNT.                                       
           MOVE 2 TO PV-ADVANCE-LINE.                                           
                                                                                
      ******************************************************************        
      *    PRINT CUT-OFF CONSOLIDATED DETAIL LINE                               
      ******************************************************************        
       Z600-PRINT-CON-DETAIL.                                                   
                                                                                
           IF PV-PRINT-LINE-COUNT > PC-PRINT-LINE-MAX                           
               OR PV-PAGE-COUNT   = ZEROES                                      
               PERFORM Z650-PRINT-CON-HEADINGS                                  
           END-IF.                                                              
                                                                                
           WRITE CTOFF-OH-LINE FROM RP-REPORT-DETAIL                            
               AFTER ADVANCING PV-ADVANCE-LINE LINES.                           
                                                                                
           ADD  PV-ADVANCE-LINE TO PV-PRINT-LINE-COUNT.                         
           MOVE 1               TO PV-ADVANCE-LINE.                             
           MOVE SPACES TO RP-REPORT-DETAIL.                                     
                                                                                
      ******************************************************************        
      *    PRINT CONSOLIDATED REPORT HEADINGS                                   
      ******************************************************************        
       Z650-PRINT-CON-HEADINGS.                                                 
                                                                                
           ADD 1 TO PV-PAGE-COUNT.                                              
           MOVE PV-PAGE-COUNT TO DP132O-PAGE-NUMBER.                            
           WRITE CTOFF-OH-LINE FROM DP132O-STANDRD-HEADER-132-COLS              
               AFTER ADVANCING PAGE.                                            
                                                                                
           WRITE CTOFF-OH-LINE FROM RP-REPORT-TITLE-1.                          
                                                                                
           WRITE CTOFF-OH-LINE FROM RP-REPORT-HEADER-1                          
               AFTER ADVANCING 2 LINES.                                         
           WRITE CTOFF-OH-LINE FROM RP-REPORT-HEADER-2.                         
                                                                                
           MOVE 6 TO PV-PRINT-LINE-COUNT.                                       
           MOVE 2 TO PV-ADVANCE-LINE.                                           
                                                                                
      ******************************************************************        
      *    SQL ERROR - ABEND                                                    
      ******************************************************************        
       Z999-SQL-ABEND.                                                          
                                                                                
           MOVE +4013                 TO ABEND-CODE.                            
           DISPLAY '**  ABEND     **'.                                          
           DISPLAY '**  PROGRAM   **  =  INKRP158'.                             
           DISPLAY '**  OPERATION **  = '  PV-OPER-ATTEMPTED                    
                                                                                
      *    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE                 
      *    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.                
                                                                                
           COPY DPPD004.                                                        
                                                                                
           CALL 'ILBOABN0'  USING ABEND-CODE.                                   
