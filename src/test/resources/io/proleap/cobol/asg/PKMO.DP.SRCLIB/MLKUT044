000100******************************************************************00010002
000200 IDENTIFICATION DIVISION.                                         00020002
000300******************************************************************00030002
000400*                                                                 00040002
000500 PROGRAM-ID.    MLKUT044.                                         00050002
000600 AUTHOR.        CINDY ROMENESKO.                                  00060002
000700 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00070002
000800 DATE-WRITTEN.  MAY 27,1997.                                      00080002
000900 DATE-COMPILED.                                                   00090002
001000*                                                                 00100002
001100******************************************************************00110002
001200*  THIS PROGRAM WILL CREATE THE FORMATED MARKDOWN DATA FOR       *00120002
001300*  FINANCE DOWNLOAD.                                             *00130002
      *                                                                 00140004
      *CHANGE HISTORY:                                                  00150009
      * WR/PROJ     DATE       PGMR        DESCRIPTION OF CHANGES       00160018
      * -------     ---------- ----------- ---------------------------- 00170018
      * 03/12/02    23511                  MARKDOWN/MARKUP TRUNCATION   00180018
W26603* W26603      03-08-2004 ROD JANSSEN MERCH LEDGER STORE EXPANSION 00190018
C41875*                                                                 00200017
C41875* C41875      03-08-2013 COGNIZANT   INCREASED INTERNAL TABLE SIZE00210018
207210* CHG0207210  08-22-2018 JIM HUNTER  RENAME KDM2810 TO MLWS051    00220020
00006 ******************************************************************00230007
                                                                        00240009
001500 ENVIRONMENT DIVISION.                                            00250002
001800 CONFIGURATION SECTION.                                           00260002
001900 SOURCE-COMPUTER.    IBM-3090.                                    00270002
002000 OBJECT-COMPUTER.    IBM-3090.                                    00280002
002100*                                                                 00290002
002200 INPUT-OUTPUT SECTION.                                            00300002
002300 FILE-CONTROL.                                                    00310002
002400*                                                                 00320002
002700*                                                                 00330002
002800     SELECT SORTED-MARKDOWN-FILE                                  00340002
002900         ASSIGN TO INP01.                                         00350002
003000*                                                                 00360002
002800     SELECT FINANCE-DOWNLOAD-FILE                                 00370002
002900         ASSIGN TO OUT01.                                         00380002
003000*                                                                 00390002
003100*                                                                 00400002
003200******************************************************************00410002
003300 DATA DIVISION.                                                   00420002
003400******************************************************************00430002
003500*                                                                 00440002
003600 FILE SECTION.                                                    00450002
003700*                                                                 00460002
003800 FD  SORTED-MARKDOWN-FILE                                         00470002
003900     RECORDING MODE IS F                                          00480002
004000     LABEL RECORDS ARE STANDARD                                   00490002
004100     BLOCK CONTAINS 0 RECORDS.                                    00500002
004200 01  INPUT-SORTED-MARKDOWN-RECORD    PIC X(100).                  00510002
004300*                                                                 00520002
003800 FD  FINANCE-DOWNLOAD-FILE                                        00530002
003900     RECORDING MODE IS F                                          00540002
004000     LABEL RECORDS ARE STANDARD                                   00550002
004100     BLOCK CONTAINS 0 RECORDS.                                    00560002
W26603 01  FINANCE-DOWNLOAD-RECORD       PIC X(4205).                   00570009
                                                                        00580002
      ******************************************************************00590002
      *WORKING-STORAGE SECTION.                                         00600002
      ******************************************************************00610002
       WORKING-STORAGE SECTION.                                         00620002
                                                                        00630002
      *    COPYBOOK FOR THE INPUT FILE.                                 00640002
207210     COPY MLWS051.                                                00650020
                                                                        00660002
           COPY DPWS004.                                                00670002
                                                                        00680002
           EXEC SQL                                                     00690002
                INCLUDE SQLCA                                           00700002
           END-EXEC.                                                    00710002
                                                                        00720002
           EXEC SQL                                                     00730002
                INCLUDE TMDSEAR                                         00740002
           END-EXEC.                                                    00750002
                                                                        00760002
           EXEC SQL                                                     00770002
                DECLARE ACTIVE_DEPT_CURSOR CURSOR FOR                   00780002
                SELECT DEPT_NBR                                         00790002
                FROM TMDSEAR                                            00800002
                WHERE MDSELV_CDE = 'DPT'      AND                       00810002
                     STRT_DTE <= CURRENT_DATE AND                       00820002
                     END_DTE > CURRENT_DATE                             00830002
                ORDER BY DEPT_NBR                                       00840002
           END-EXEC.                                                    00850002
                                                                        00860002
       01  MISC-WORK-FIELDS.                                            00870002
                                                                        00880002
           05  WS-NBR-DEPTS                PIC S9(9) COMP VALUE +0.     00890002
23511      05  WS-CUMM-MARKD-AMT           PIC S9(13)V99  VALUE 0.      00900006
23511      05  WS-MARKD-QTY                PIC S9(9)      VALUE ZERO.   00910006
23511      05  WS-MARKDOWN                 PIC S9(13)V99  VALUE ZERO.   00920006
           05  WS-DIFFERENCE               PIC S9(7)V99 VALUE ZERO.     00930002
                                                                        00940002
                                                                        00950002
           05  HOLD-DEPT                   PIC X(03).                   00960002
W26603     05  HOLD-STORE                  PIC X(05).                   00970008
                                                                        00980002
           05  WS-ABEND-CODE               PIC X(04).                   00990002
           05  WS-ABEND-PARAGRAPH          PIC X(20).                   01000002
           05  WS-DB2-OPERATION-ATTEMPTED  PIC X(30).                   01010002
                                                                        01020002
       01  WS-PROGRAM-ERROR-MESSAGES.                                   01030002
           05  PE-MSG-1                    PIC  X(30)    VALUE          01040002
               'OPEN ACTIVE_DEPT CURSOR       '.                        01050002
           05  PE-MSG-2                    PIC  X(30)    VALUE          01060002
               'FETCH OF ACTIVE_DEPT CURSOR   '.                        01070002
           05  PE-MSG-3                    PIC  X(30)    VALUE          01080002
               '                              '.                        01090002
           05  PE-MSG-4                    PIC  X(30)    VALUE          01100002
               'CLOSE ACTIVE_DEPT CURSOR      '.                        01110002
                                                                        01120002
       01  CONSTANTS.                                                   01130002
           05  C-HEADER-RECORD.                                         01140002
               10  FILLER                  PIC X(6)    VALUE            01150002
                   'STORES'.                                            01160002
               10  FILLER                  PIC X(01)   VALUE ','.       01170002
               10  FILLER                  PIC X(11)   VALUE            01180002
                   'DEPARTMENTS'.                                       01190002
                                                                        01200002
       01  SWITCHES.                                                    01210002
           05  SW-MORE-MARKD-RECORDS       PIC X(1)     VALUE 'Y'.      01220002
               88  SW-NO-MORE-MARKD-RECORDS             VALUE 'N'.      01230002
                                                                        01240002
           05  SW-MORE-ACTIVE-DEPTS        PIC X(1)     VALUE 'Y'.      01250002
               88  SW-NO-MORE-ACTIVE-DEPTS              VALUE 'N'.      01260002
                                                                        01270002
       01  TABLES.                                                      01280002
                                                                        01290002
           05  T-STORE-DATA-TABLE.                                      01300002
W26603         10  T-STORE-NUMBER        PIC X(4)    VALUE SPACES.      01310008
               10  FILLER                PIC X       VALUE ','.         01320002
               10  T-DEPT-MARKD-TABLE OCCURS 600 TIMES                  01330011
                      INDEXED BY T-MRKD-IDX.                            01340002
                   15  T-DEPT-MARKD      PIC +999999999.99  VALUE       01350004
                                                          SPACES.       01360002
                   15  FILLER            PIC X       VALUE ','.         01370002
                                                                        01380002
           05  T-DEPT-HEADER-RECORD.                                    01390002
               10  FILLER                   PIC X(2) VALUE ' ,'.        01400002
               10  T-DEPT-COLUMNS OCCURS 600 TIMES                      01410016
                      ASCENDING T-DEPARTMENT-NUMBER                     01420002
                      INDEXED BY T-DEPT-IDX.                            01430002
                   15  T-DEPARTMENT-NUMBER  PIC X(3) VALUE HIGH-VALUES. 01440002
                   15  FILLER               PIC X    VALUE ','.         01450002
                                                                        01460002
      ******************************************************************01470002
      *   PROCEDURE DIVISION.                                           01480002
      ******************************************************************01490002
                                                                        01500002
           EJECT                                                        01510002
       PROCEDURE DIVISION.                                              01520002
                                                                        01530002
       A000-MAINLINE-PROCESSING.                                        01540002
      ******************************************************************01550002
      * MAIN PROCESSING ROUTINE                                        *01560002
      ******************************************************************01570002
                                                                        01580002
           OPEN INPUT  SORTED-MARKDOWN-FILE                             01590002
                OUTPUT FINANCE-DOWNLOAD-FILE.                           01600002
                                                                        01610002
           PERFORM 1000-INITIALIZATION.                                 01620002
                                                                        01630002
           PERFORM 2000-FORMAT-MARKDOWNS                                01640002
             UNTIL SW-NO-MORE-MARKD-RECORDS.                            01650002
                                                                        01660002
      **** LAST RECORD PROCESSING                                       01670002
           PERFORM 2400-LOAD-DEPT-WITH-MARKDOWN.                        01680002
           WRITE FINANCE-DOWNLOAD-RECORD FROM T-STORE-DATA-TABLE.       01690002
                                                                        01700002
           CLOSE SORTED-MARKDOWN-FILE                                   01710002
                 FINANCE-DOWNLOAD-FILE.                                 01720002
                                                                        01730002
                                                                        01740002
           GOBACK.                                                      01750002
                                                                        01760002
           EJECT                                                        01770002
                                                                        01780002
       1000-INITIALIZATION.                                             01790002
                                                                        01800002
                                                                        01810002
           EXEC SQL                                                     01820002
               OPEN ACTIVE_DEPT_CURSOR                                  01830002
           END-EXEC.                                                    01840002
                                                                        01850002
           EVALUATE TRUE                                                01860002
               WHEN SQLCODE = ZERO                                      01870002
                    CONTINUE                                            01880002
               WHEN OTHER                                               01890002
                    MOVE '1000-INITIALIZATION'                          01900002
                                       TO WS-ABEND-PARAGRAPH            01910002
                    MOVE PE-MSG-1      TO WS-DB2-OPERATION-ATTEMPTED    01920002
                    PERFORM 9200-SQL-ABEND                              01930002
           END-EVALUATE.                                                01940002
                                                                        01950002
           PERFORM 1900-FETCH-ACTIVE-DEPT.                              01960002
                                                                        01970002
           SET T-DEPT-IDX    TO +1.                                     01980002
           PERFORM 1800-LOAD-DEPT-TABLES                                01990002
              UNTIL SW-NO-MORE-ACTIVE-DEPTS.                            02000002
                                                                        02010002
           WRITE FINANCE-DOWNLOAD-RECORD FROM C-HEADER-RECORD.          02020002
           WRITE FINANCE-DOWNLOAD-RECORD FROM T-DEPT-HEADER-RECORD.     02030002
                                                                        02040002
           PERFORM 2100-READ-MARKDOWN-REC.                              02050002
                                                                        02060002
           MOVE D090-DEPT-40             TO HOLD-DEPT.                  02070002
W26603     MOVE D090-STORE-40(2:4)       TO T-STORE-NUMBER              02080008
W26603     MOVE D090-STORE-40            TO HOLD-STORE.                 02090008
                                                                        02100002
       1800-LOAD-DEPT-TABLES.                                           02110002
                                                                        02120002
            MOVE MDSEAR-DEPT-NBR  TO  T-DEPARTMENT-NUMBER(T-DEPT-IDX)   02130002
                                                                        02140002
            PERFORM 1900-FETCH-ACTIVE-DEPT.                             02150002
                                                                        02160002
            SET T-DEPT-IDX UP BY +1.                                    02170002
                                                                        02180002
       1900-FETCH-ACTIVE-DEPT.                                          02190002
                                                                        02200002
           EXEC SQL                                                     02210002
                FETCH ACTIVE_DEPT_CURSOR                                02220002
                INTO :MDSEAR-DEPT-NBR                                   02230002
           END-EXEC.                                                    02240002
                                                                        02250002
           EVALUATE TRUE                                                02260002
               WHEN SQLCODE = ZERO                                      02270002
                    CONTINUE                                            02280015
               WHEN SQLCODE = +100                                      02290002
                    SET SW-NO-MORE-ACTIVE-DEPTS TO TRUE                 02300002
               WHEN OTHER                                               02310002
                    MOVE '1900-FETCH-ACTIVE-DPT'                        02320002
                                       TO WS-ABEND-PARAGRAPH            02330002
                    MOVE PE-MSG-2      TO WS-DB2-OPERATION-ATTEMPTED    02340002
                    PERFORM 9200-SQL-ABEND                              02350002
           END-EVALUATE.                                                02360002
                                                                        02370002
       2000-FORMAT-MARKDOWNS.                                           02380002
                                                                        02390002
W26603     IF D090-STORE-40              = HOLD-STORE                   02400008
              IF D090-DEPT-40            = HOLD-DEPT                    02410002
                 PERFORM 2200-CALCULATE-MARKDOWN                        02420002
                 ADD  WS-MARKDOWN       TO WS-CUMM-MARKD-AMT            02430002
              ELSE                                                      02440002
                 PERFORM 2400-LOAD-DEPT-WITH-MARKDOWN                   02450002
                 PERFORM 2200-CALCULATE-MARKDOWN                        02460002
                 MOVE WS-MARKDOWN       TO WS-CUMM-MARKD-AMT            02470002
                 MOVE D090-DEPT-40      TO HOLD-DEPT                    02480002
           ELSE                                                         02490002
              PERFORM 2400-LOAD-DEPT-WITH-MARKDOWN                      02500002
              WRITE FINANCE-DOWNLOAD-RECORD FROM T-STORE-DATA-TABLE     02510002
              INITIALIZE T-STORE-DATA-TABLE                             02520002
W26603        MOVE D090-STORE-40(2:4)   TO T-STORE-NUMBER               02530008
W26603        MOVE D090-STORE-40        TO HOLD-STORE                   02540008
              MOVE D090-DEPT-40         TO HOLD-DEPT                    02550002
              PERFORM 2200-CALCULATE-MARKDOWN                           02560002
              MOVE WS-MARKDOWN          TO WS-CUMM-MARKD-AMT.           02570002
                                                                        02580002
           PERFORM 2100-READ-MARKDOWN-REC.                              02590002
                                                                        02600002
           EJECT                                                        02610002
                                                                        02620002
       2100-READ-MARKDOWN-REC.                                          02630002
                                                                        02640002
           READ SORTED-MARKDOWN-FILE INTO D090-MKDWN-REC                02650002
             AT END                                                     02660002
                SET SW-NO-MORE-MARKD-RECORDS  TO TRUE.                  02670002
                                                                        02680002
       2200-CALCULATE-MARKDOWN.                                         02690002
                                                                        02700002
                                                                        02710002
           MOVE D090-MKDWN-QTY        TO WS-MARKD-QTY.                  02720002
                                                                        02730002
                                                                        02740002
           COMPUTE WS-MARKDOWN =                                        02750002
                   ((D090-MKDWN-OPRICE - D090-MKDWN-NPRICE) *           02760002
                         WS-MARKD-QTY).                                 02770002
                                                                        02780002
                                                                        02790002
       2400-LOAD-DEPT-WITH-MARKDOWN.                                    02800002
                                                                        02810002
           SEARCH ALL T-DEPT-COLUMNS                                    02820002
              AT END                                                    02830002
                  DISPLAY 'DEPARTMENT NUMBER NOT FOUND'                 02840002
                  DISPLAY 'DEPARTMENT NUMBER = ' HOLD-DEPT              02850002
                  PERFORM 9400-PROGRAM-ABEND                            02860002
              WHEN T-DEPARTMENT-NUMBER(T-DEPT-IDX) = HOLD-DEPT          02870002
                   SET T-MRKD-IDX          TO  T-DEPT-IDX               02880002
                   MOVE WS-CUMM-MARKD-AMT  TO  T-DEPT-MARKD(T-MRKD-IDX) 02890002
           END-SEARCH.                                                  02900002
                                                                        02910002
       9200-SQL-ABEND.                                                  02920002
      ******************************************************************02930002
      *  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    02940002
      *  ERROR OR WARNING CODE OCCURS.                                  02950002
      ******************************************************************02960002
           DISPLAY '***************************'.                       02970002
           DISPLAY '**       ABEND           **'.                       02980002
           DISPLAY '**  IN PROGRAM MLKUT044  **'.                       02990002
           DISPLAY '***************************'.                       03000002
           DISPLAY '** PARAGRAPH ** = ' WS-ABEND-PARAGRAPH.             03010002
           DISPLAY '** OPERATION ** = ' WS-DB2-OPERATION-ATTEMPTED.     03020002
                                                                        03030002
      ******************************************************************03040002
      *  THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   03050002
      *  MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        03060002
      *  'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    03070002
      *  FORMAT.                                                        03080002
      ******************************************************************03090002
           COPY DPPD004.                                                03100002
                                                                        03110002
           EXEC SQL                                                     03120002
                COMMIT                                                  03130002
           END-EXEC.                                                    03140002
                                                                        03150002
           MOVE +4013                  TO WS-ABEND-CODE.                03160002
           CALL 'ILBOABN0' USING WS-ABEND-CODE.                         03170002
      ******************************************************************03180002
      *  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN        03190002
      *  ERROR OCCURS.                                                  03200002
      ******************************************************************03210002
                                                                        03220002
       9400-PROGRAM-ABEND.                                              03230002
           DISPLAY 'MLKUT044- ABORTING'.                                03240002
           MOVE 4004 TO WS-ABEND-CODE.                                  03250002
           CALL 'ILBOABN0' USING WS-ABEND-CODE.                         03260002
                                                                        03270002
