000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400*                                                                 00040000
000500 PROGRAM-ID.             EPKUP107.                                00050000
000600 AUTHOR.                 GERMAN BANDA.                            00060000
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070000
000800 DATE-WRITTEN.           APRIL 2020.                              00080000
000900 DATE-COMPILED.                                                   00090000
001000*                                                                 00100000
001100***************************************************************** 00110000
001200* THIS PROGRAM WILL BE USED TO DELETE ROWS FROM THE LOWEST UNIT   00120000
001300* RETAIL TABLE (EPT_LO_RTL).                                      00130000
001400***************************************************************** 00140000
001500 ENVIRONMENT DIVISION.                                            00150000
001600***************************************************************** 00160000
001700 CONFIGURATION SECTION.                                           00170000
001800 SOURCE-COMPUTER.                        IBM-3090.                00180000
001900 OBJECT-COMPUTER.                        IBM-3090.                00190000
002000 INPUT-OUTPUT SECTION.                                            00200000
002100 FILE-CONTROL.                                                    00210000
002200                                                                  00220000
002300     SELECT EXTRACT-FILE                                          00230000
002400         ASSIGN TO INP01.                                         00240000
002500/                                                                 00250000
002600***************************************************************** 00260000
002700 DATA DIVISION.                                                   00270000
002800***************************************************************** 00280000
002900 FILE SECTION.                                                    00290000
003000                                                                  00300000
003100 FD  EXTRACT-FILE                                                 00310000
003200     RECORDING MODE IS F                                          00320000
003300     LABEL RECORDS ARE STANDARD                                   00330000
003400     BLOCK CONTAINS 0 RECORDS.                                    00340000
003500 01  EXTRACT-RECORD                   PIC X(18).                  00350000
003600/                                                                 00360000
003700***************************************************************** 00370000
003800 WORKING-STORAGE SECTION.                                         00380000
003900***************************************************************** 00390000
004000                                                                  00400000
004100 01  PS-SWITCHES.                                                 00410000
004200     05  PS-END-OF-INPUT-FILE-SW      PIC X(01) VALUE 'N'.        00420000
004300         88  PS-END-OF-INPUT                    VALUE 'Y'.        00430000
004400         88  PS-NOT-END-OF-INPUT                VALUE 'N'.        00440000
004500                                                                  00450000
004600 01  PV-VARIABLES.                                                00460000
004700     05  PV-COUNT                     PIC  9(09) VALUE ZERO.      00470000
004800     05  PV-COMMIT-CNT                PIC  9(09) VALUE ZERO.      00480000
004900     05  PV-READ-CNT                  PIC  9(09) VALUE ZERO.      00490000
005000     05  PV-RETAIL-DELETE-CNT         PIC  9(09) VALUE ZERO.      00500000
005100     05  PV-RETAIL-NOT-FND-CNT        PIC  9(09) VALUE ZERO.      00510000
005200     05  PV-DISPLAY-CNT               PIC  ZZZ,ZZZ,ZZ9.           00520000
005300     05  PV-DISP-SML                  PIC  9(18) VALUE ZERO.      00530000
005310     05  PV-DISP-INTR-UPC-ID          PIC  9(09) VALUE ZERO.      00531000
005320     05  PV-DISP-STR-GP-TYP-CDE       PIC  9(04) VALUE ZERO.      00532000
005321     05  PV-DISP-STR-GP-ID            PIC  9(04) VALUE ZERO.      00532100
005322     05  PV-DISP-SLS-WK-BEG-DTE       PIC  X(10) VALUE SPACE.     00532200
005330                                                                  00533000
005340******************************************************************00534000
005350 01  PV-ABEND-FIELDS.                                             00535000
005360     05  PV-ABEND-CODE                PIC S9(04) VALUE +0         00536000
005370                                                 COMP SYNC.       00537000
005380     05  PV-ABEND-PROGRAM             PIC  X(08) VALUE 'EPKUP107'.00538000
005390     05  PV-ABEND-PARAGRAPH           PIC  X(50) VALUE SPACES.    00539000
005400     05  PV-ABEND-OPERATION           PIC  X(51) VALUE SPACES.    00540000
005500     05  PV-ABEND-STRUCTURE-1         PIC  X(08) VALUE SPACES.    00550000
005600     05  PV-ABEND-STRUCTURE-2         PIC  X(08) VALUE SPACES.    00560000
005700     05  PV-ABEND-STRUCTURE-3         PIC  X(08) VALUE SPACES.    00570000
005800     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    00580000
005900     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    00590000
006000     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    00600000
006100     05  PV-DB2-FUNCTION              PIC  X(50) VALUE SPACES.    00610000
006200/                                                                 00620000
006300 01  PC-CONSTANTS.                                                00630000
006400     05  PC-CURRENT-PROGRAM-NAME      PIC X(08) VALUE 'EPKUP107'. 00640000
006500     05  PC-COMMIT-HOLD               PIC 9(4)  VALUE 1000.       00650001
006600     05  PC-COUNT-HOLD                PIC 9(9)  VALUE 100000.     00660000
006700                                                                  00670000
006800******************************************************************00680000
006900*  LAYOUT FOR EXTRACT FILE                                        00690000
007000******************************************************************00700000
007100     COPY EPRD120.                                                00710000
007200*                                                                 00720000
007300******************************************************************00730000
007400*  DB2 FORMATTED MESSAGE AREA                                     00740000
007500******************************************************************00750000
007600     COPY DPWS004.                                                00760000
007700                                                                  00770000
007800******************************************************************00780000
007900*   DB2 SQL COMMUNICATION AREA                                    00790000
008000******************************************************************00800000
008100     EXEC SQL                                                     00810000
008200         INCLUDE SQLCA                                            00820000
008300     END-EXEC.                                                    00830000
008400*                                                                 00840000
008500     COPY SQLCA2.                                                 00850000
008600*                                                                 00860000
008700******************************************************************00870000
008800*   EP-LOWEST UNIT RETAIL - EPT_LO_RTL                            00880000
008900******************************************************************00890000
009000*                                                                 00900000
009100     EXEC SQL                                                     00910000
009200         INCLUDE EPT00011                                         00920000
009300     END-EXEC.                                                    00930000
009400*                                                                 00940000
009500******************************************************************00950000
009600 PROCEDURE DIVISION.                                              00960000
009700******************************************************************00970000
009800 0000-MAINLINE.                                                   00980000
009900                                                                  00990000
010000     PERFORM 1000-INITIALIZE.                                     01000000
010100                                                                  01010000
010200     PERFORM 2000-PROCESS-EXTRACT                                 01020000
010300         UNTIL PS-END-OF-INPUT.                                   01030000
010400                                                                  01040000
010500     PERFORM 9000-EOJ.                                            01050000
010600                                                                  01060000
010700      GOBACK.                                                     01070000
010800                                                                  01080000
010900******************************************************************01090000
011000*  INITIALIZATION TASKS.                                          01100000
011100*    -- OPEN INPUT FILE                                           01110000
011200*    -- READ FILE                                                 01120000
011300******************************************************************01130000
011400 1000-INITIALIZE.                                                 01140000
011500                                                                  01150000
011600     OPEN INPUT  EXTRACT-FILE.                                    01160000
011700                                                                  01170000
011800     PERFORM 2100-READ-EXTRACT.                                   01180000
011801                                                                  01180100
011810     DISPLAY 'SALES-WK-BEG-DTE  ' EP120-SLS-WK-BEG-DTE.           01181000
011900/                                                                 01190000
012000******************************************************************01200000
012100 2000-PROCESS-EXTRACT.                                            01210000
012200******************************************************************01220000
012300*                                                                 01230000
012400     IF  PV-COUNT  <  PC-COUNT-HOLD                               01240000
012500         CONTINUE                                                 01250000
012600     ELSE                                                         01260000
012700         MOVE PV-READ-CNT  TO  PV-DISPLAY-CNT                     01270000
012800         DISPLAY 'READ:  '     PV-DISPLAY-CNT                     01280000
012900         MOVE  ZEROES  TO      PV-COUNT                           01290000
013000     END-IF.                                                      01300000
013100                                                                  01310000
013200     PERFORM 8100-DELETE-LWST-RTL.                                01320000
013300     ADD +1 TO PV-COMMIT-CNT                                      01330000
013400                                                                  01340000
013500     IF PV-COMMIT-CNT > PC-COMMIT-HOLD                            01350000
013600         PERFORM 2200-COMMIT-DELETE                               01360000
013700     END-IF.                                                      01370000
013800                                                                  01380000
013900     PERFORM 2100-READ-EXTRACT.                                   01390000
014000                                                                  01400000
014100                                                                  01410000
014200*                                                                 01420000
014300******************************************************************01430000
014400*  READ NEXT INPUT FILE RECORD.                                   01440000
014500******************************************************************01450000
014600 2100-READ-EXTRACT.                                               01460000
014700                                                                  01470000
014800     READ EXTRACT-FILE INTO EP120-LWST-W13-WK-DEL-RCD             01480000
014900        AT END                                                    01490000
015000           SET PS-END-OF-INPUT TO TRUE                            01500000
015100        NOT AT END                                                01510000
015200           ADD +1                   TO PV-READ-CNT                01520000
015300                                       PV-COUNT                   01530000
015400     END-READ.                                                    01540000
015500*                                                                 01550000
015600******************************************************************01560000
015700* COMMIT THE DELETE FROM ERROR TABLE                              01570000
015800******************************************************************01580000
015900 2200-COMMIT-DELETE.                                              01590000
016000                                                                  01600000
016100      EXEC SQL                                                    01610000
016200         COMMIT                                                   01620000
016300      END-EXEC                                                    01630000
016400                                                                  01640000
016500      MOVE +0 TO PV-COMMIT-CNT.                                   01650000
016600                                                                  01660000
016700******************************************************************01670000
016800* DELETE THE OUTBOUND DATABASE                                    01680000
016900******************************************************************01690000
017000 8100-DELETE-LWST-RTL.                                            01700000
017100                                                                  01710000
017200     EXEC SQL                                                     01720000
017300          DELETE                                                  01730000
017400            FROM EPT_LO_RTL                                       01740004
017500           WHERE INTR_UPC_ID    = :EP120-INTR-UPC-ID              01750000
017600             AND STR_GP_TYP_CDE = :EP120-STR-GP-TYP-CDE           01760000
017700             AND STR_GP_ID      = :EP120-STR-GP-ID                01770000
017800             AND SLS_WK_BEG_DTE = :EP120-SLS-WK-BEG-DTE           01780000
018300     END-EXEC.                                                    01830000
018400                                                                  01840000
018500     EVALUATE TRUE                                                01850000
018600         WHEN SQLCODE = 0                                         01860000
018700             ADD +1           TO PV-RETAIL-DELETE-CNT             01870000
018800         WHEN SQLCODE = +100                                      01880000
018900             ADD +1           TO PV-RETAIL-NOT-FND-CNT            01890000
019000         WHEN SQLCODE < 0                                         01900000
019100         WHEN SQLCODE > 0                                         01910000
019200         WHEN SQLWARN0 = 'W'                                      01920000
019300             MOVE '8100-DELETE-LWST-RTL  '                        01930000
019400                         TO PV-ABEND-PARAGRAPH                    01940000
019500             MOVE 'DELETE OF EPT_LO_RTL    '                      01950000
019600                         TO PV-DB2-FUNCTION                       01960000
019700             PERFORM 9200-SQL-ABEND                               01970000
019800     END-EVALUATE.                                                01980000
019900                                                                  01990000
020000******************************************************************02000000
020100*CLOSE INPUT FILE.                                                02010000
020200******************************************************************02020000
020300 9000-EOJ.                                                        02030000
020400*                                                                 02040000
020500     CLOSE EXTRACT-FILE.                                          02050000
020600                                                                  02060000
020700     MOVE PV-READ-CNT           TO PV-DISPLAY-CNT.                02070000
020800     DISPLAY 'READ:               ' PV-DISPLAY-CNT.               02080003
020900                                                                  02090000
021000     MOVE PV-RETAIL-DELETE-CNT  TO PV-DISPLAY-CNT.                02100000
021100     DISPLAY 'LOWEST-RETL DELETE: ' PV-DISPLAY-CNT.               02110000
021200                                                                  02120000
021300     MOVE PV-RETAIL-NOT-FND-CNT TO PV-DISPLAY-CNT.                02130000
021400     DISPLAY 'LOWEST-RETL NOT FD: ' PV-DISPLAY-CNT.               02140000
021500                                                                  02150000
021600                                                                  02160000
021700******************************************************************02170000
021800 9200-SQL-ABEND.                                                  02180000
021900******************************************************************02190000
022000                                                                  02200000
022100     MOVE SQLCODE                     TO SQLCODE2.                02210000
022200     MOVE SQLERRD(3)                  TO SQLERRD3.                02220000
022300                                                                  02230000
022500     MOVE EP120-INTR-UPC-ID           TO PV-DISP-INTR-UPC-ID.     02250000
022600     MOVE EP120-STR-GP-TYP-CDE        TO PV-DISP-STR-GP-TYP-CDE.  02260000
022610     MOVE EP120-STR-GP-ID             TO PV-DISP-STR-GP-ID.       02261000
022620     MOVE EP120-SLS-WK-BEG-DTE        TO PV-DISP-SLS-WK-BEG-DTE.  02262000
022700                                                                  02270000
022800     DISPLAY '** ABEND **         ** = SQLERROR'.                 02280000
022900     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        02290000
023000     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.             02300000
023100     DISPLAY '** OPERATION ** = ' PV-DB2-FUNCTION.                02310000
023200     DISPLAY '*** INTR-UPC-ID = ' PV-DISP-INTR-UPC-ID.            02320001
023300     DISPLAY '*** STR-GP-TYP-CDE' PV-DISP-STR-GP-TYP-CDE.         02330001
023400     DISPLAY '*** STR-GP-ID     ' PV-DISP-STR-GP-ID.              02340001
023410     DISPLAY '*** SLS-WK-BEG-DTE' PV-DISP-SLS-WK-BEG-DTE.         02341001
023500                                                                  02350000
023600     DISPLAY '** SQLCODE          ** = ' SQLCODE2.                02360000
023700     DISPLAY '** ROWS PROCESSED   ** = ' SQLERRD3.                02370000
023800     DISPLAY '** SQLERRM          ** = ' SQLERRM.                 02380000
023900     DISPLAY '** SQLERRMC         ** = ' SQLERRMC.                02390000
024000                                                                  02400000
024100                                                                  02410000
024200     MOVE +4013                       TO PV-ABEND-CODE.           02420000
024300     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         02430000
024400                                                                  02440000
