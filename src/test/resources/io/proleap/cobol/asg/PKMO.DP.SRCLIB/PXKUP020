000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.      PXKUP020.                                       00020000
000300 AUTHOR.          MARGARET MORRISON.                              00030000
000400 DATE-WRITTEN.    MARCH 2007.                                     00040000
000500                                                                  00050000
000600*--------------------------------------------------------------*  00060000
000700*                                                              *  00070000
000800* DESCRIPTION:                                                 *  00080000
000900*      PERFORMS PURGE PROCESS FOR MARK OUT OF STOCK SKU/STORE  *  00090000
001000*      DATA. **********DELETE DATE IS CALCULATED USING CURRENT *  00100010
001100*      DATE MINUS 7 DAYS.                                      *  00110010
001800*                                                              *  00180000
001900* INPUTS:                                                      *  00190010
002000*      NONE                                                    *  00200010
002300*                                                              *  00230000
002400* OUTPUTS:                                                     *  00240000
002500*      NONE                                                    *  00250000
002600*                                                              *  00260000
002700*--------------------------------------------------------------*  00270000
002800*--------------------------------------------------------------*  00280000
002900* HISTORY LOG:                                                    00290000
003000*--------------------------------------------------------------*  00300000
003100* DATE:        03/19/2007                                         00310000
003200* WR/IR#:      WR30069 (MARK OUT OF STOCK)                        00320000
003300* PROGRAMMER:  MARGARET MORRISON                                  00330000
003400* DESCRIPTION: INITIAL PROGRAM WRITE.                             00340016
003700*--------------------------------------------------------------*  00370000
004680* DATE:                                                           00468000
004690* WR/IR#:                                                         00469000
004700* PROGRAMMER:                                                     00470000
004710* DESCRIPTION:                                                    00471000
004800*--------------------------------------------------------------*  00480000
004900 ENVIRONMENT DIVISION.                                            00490000
005000*--------------------------------------------------------------*  00500000
005100 CONFIGURATION SECTION.                                           00510000
005200 SOURCE-COMPUTER.        IBM-3090.                                00520000
005300 OBJECT-COMPUTER.        IBM-3090.                                00530000
005400                                                                  00540000
005500 INPUT-OUTPUT SECTION.                                            00550000
005600                                                                  00560000
005700 FILE-CONTROL.                                                    00570000
006400                                                                  00640000
006800 DATA DIVISION.                                                   00680000
006900 FILE SECTION.                                                    00690000
008400                                                                  00840000
009200 WORKING-STORAGE SECTION.                                         00920000
009300*--------------------------------------------------------------*  00930000
009400* PS - PROGRAM SWITCHES                                           00940000
009500*--------------------------------------------------------------*  00950000
009600 01  PS-PROGRAM-SWITCHES.                                         00960000
011200     05  PS-DELETE-MOS-CSR-SW         PIC  X(001).                01120010
011300         88  MORE-DELETE-MOS                      VALUE 'Y'.      01130010
011400         88  NO-MORE-DELETE-MOS                   VALUE 'N'.      01140010
011500                                                                  01150000
011600*--------------------------------------------------------------*  01160000
011700* PROGRAM CONSTANTS                                               01170000
011800*--------------------------------------------------------------*  01180000
011900 01  PC-PROGRAM-CONSTANTS.                                        01190000
012000     05  PC-PROGRAM-NAME          PIC X(08) VALUE 'PXKUP020'.     01200000
012100     05  PC-MAX-RETRIES           PIC 9(9)  VALUE 5.              01210000
012200**** 05  PC-COMMIT-MAX            PIC 9(9)  VALUE  99.            01220000
012300     05  PC-COMMIT-MAX            PIC 9(9)  VALUE 9999.           01230000
012310     05  PC-7                     PIC 9(9)  VALUE 7.              01231006
012400                                                                  01240000
012500*--------------------------------------------------------------*  01250000
012600* PV- PROGRAM VARIABLES                                           01260000
012700*--------------------------------------------------------------*  01270000
012800 01  PV-PROGRAM-VARAIBLES.                                        01280000
012900     05  PV-PARAGRAPH-NAME        PIC X(40)   VALUE SPACES.       01290000
013000     05  PD-DB2-OPERATION         PIC X(15)   VALUE SPACES.       01300000
013100                                                                  01310000
013200     05  PV-SQL-SUB               PIC S9(09)  VALUE 0  COMP.      01320000
013300     05  PV-RETRY                 PIC 9999    VALUE 0  COMP.      01330000
013400     05  PV-ABEND-CODE            PIC 9999    VALUE 0  COMP.      01340000
013500     05  PV-CALC-DB2-DATE         PIC  X(10)  VALUE SPACES.       01350000
013600     05  PV-CALC-NBR-DAYS         PIC  9(05)  VALUE 0.            01360000
014000                                                                  01400000
014010     05  PV-CURRENT-TMST          PIC X(26).                      01401015
014030     05  PV-PURGE-DATE            PIC X(10)   VALUE SPACES.       01403015
015000                                                                  01500000
015600*--------------------------------------------------------------*  01560000
015700* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         01570000
015800*--------------------------------------------------------------*  01580000
015900     COPY DPWS004.                                                01590000
016000                                                                  01600000
016100*--------------------------------------------------------------*  01610000
016200* DATE ROUTINE COPY MEMBERS                                       01620000
016300*--------------------------------------------------------------*  01630000
016400     COPY DPWS500.                                                01640000
016500                                                                  01650000
016600*--------------------------------------------------------------*  01660000
016700* DB2 ABEND COPYBOOK                                              01670000
016800*--------------------------------------------------------------*  01680000
016900     COPY DPWS900.                                                01690000
017000                                                                  01700000
017100*--------------------------------------------------------------*  01710000
017200* DB2 MESSAGE AREA                                                01720000
017300*--------------------------------------------------------------*  01730000
017400     COPY SQLCA2.                                                 01740000
017500                                                                  01750000
017600*--------------------------------------------------------------*  01760000
017700* PROGRAM COUNTERS                                                01770000
017800*--------------------------------------------------------------*  01780000
017900 01  PV-PROGRAM-COUNTERS         COMP-3.                          01790000
018000     05  PV-NUMBER-OF-RETRIES     PIC 9(9) VALUE 0.               01800000
018100     05  PV-TOTAL-FETCH-CNT       PIC 9(9) VALUE 0.               01810000
019300     05  PV-DELETE-CNT            PIC 9(9) VALUE 0.               01930000
020200     05  PV-CNT-SINCE-COMMIT      PIC 9(9) VALUE 0.               02020000
020300                                                                  02030000
020400*--------------------------------------------------------------*  02040000
020500* ERROR HANDLING                                                  02050000
020600*--------------------------------------------------------------*  02060000
020700 01  PV-MISC-ABEND-FIELDS.                                        02070000
020800     05  PV-OPERATION-MSG-1      PIC X(40) VALUE SPACES.          02080000
020900     05  PV-OPERATION-MSG-2      PIC X(40) VALUE SPACES.          02090000
021000     05  PV-DB2-OPERATION        PIC X(30) VALUE SPACES.          02100000
021100                                                                  02110000
021200 01  ABEND-CODE                  PIC S9(4) VALUE 0  COMP SYNC.    02120000
021300     88  ABEND-4003-CTRL-CARD-ERROR        VALUE +4003.           02130000
021400     88  ABEND-4013-DB2-ERROR              VALUE +4013.           02140000
021500     88  ABEND-4019-CAL-SUB-ERROR          VALUE +4019.           02150000
021600     88  ABEND-4020-MQ-ERROR               VALUE +4020.           02160000
021700     88  ABEND-4444-FORCED-ABEND           VALUE +4444.           02170000
021800     88  ABEND-4008                        VALUE +4008.           02180000
021900     88  ABEND-4005                        VALUE +4005.           02190000
022000                                                                  02200000
022100*--------------------------------------------------------------*  02210000
022200* DB2 COMMUNICATIONS AREA                                         02220000
022300*--------------------------------------------------------------*  02230000
022400     EXEC SQL                                                     02240000
022500       INCLUDE SQLCA                                              02250000
022600     END-EXEC.                                                    02260000
022700                                                                  02270000
022800*--------------------------------------------------------------*  02280000
022900* DB2 TABLE PXT00003 (PXT_MOS_SKU_STR) MOS SKU/STORE TABLE        02290002
023000*--------------------------------------------------------------*  02300000
023100     EXEC SQL                                                     02310000
023200       INCLUDE PXT00003                                           02320011
023300     END-EXEC.                                                    02330000
023400                                                                  02340000
034300******************************************************************03430000
034310* MOS-SKU-STR-CSR CURSOR FINDS ALL ROWS WITH AN EFFECTIVE END     03431004
034400* DATE EQUAL TO THE CURRENT DATE MINUS 7 DAYS SO THAT THEY CAN BE 03440004
034500* DELETED.                                                        03450004
034700******************************************************************03470000
034710                                                                  03471000
034720     EXEC SQL                                                     03472000
034730       DECLARE MOS-SKU-STR-CSR CURSOR WITH HOLD FOR               03473004
034740              SELECT A.SKU_NBR                                    03474005
034750                   , A.STR_NBR                                    03475005
034760                   , A.EFF_END_DTE                                03476005
034791                FROM PXT_MOS_SKU_STR  A                           03479105
034793               WHERE A.EFF_END_DTE < :PV-PURGE-DATE               03479325
034796                 AND A.EFF_END_DTE IS NOT NULL                    03479619
034806                ORDER BY A.SKU_NBR                                03480605
034807                        ,A.STR_NBR                                03480705
034809     END-EXEC.                                                    03480900
034810                                                                  03481000
039400 LINKAGE SECTION.                                                 03940000
039500                                                                  03950000
039600*--------------------------------------------------------------*  03960000
039700 PROCEDURE DIVISION.                                              03970000
039800*--------------------------------------------------------------*  03980000
039900 0000-MAINLINE.                                                   03990000
040000                                                                  04000000
040100     PERFORM 1000-INITIALIZATION.                                 04010000
040500                                                                  04050000
040600     PERFORM 2000-PROCESS-DELETE-MOS.                             04060007
040700     PERFORM 9000-COMMIT.                                         04070015
040800                                                                  04080000
041100     PERFORM 9999-WRAPUP.                                         04110000
041200                                                                  04120000
041300     GOBACK.                                                      04130000
041400                                                                  04140000
041500*0000-EXIT.                                                       04150000
041600                                                                  04160000
041700*--------------------------------------------------------------*  04170000
041800* 1000-INITIALIZATION.                                            04180000
041900*     INITIALIZATION AREA - INITIALIZES ALL VARIABLES, OPENS      04190000
042000*     FILES, READS CONTROL CARDS, AND PROCESSES ANY INPUT FILE    04200000
042100*     PARAMETERS IT MAY NEED.                                     04210000
042200*--------------------------------------------------------------*  04220000
042300 1000-INITIALIZATION.                                             04230000
042400     DISPLAY ' '.                                                 04240000
042500     DISPLAY '*********************************************'.     04250000
042600     DISPLAY '   START OF PROGRAM NAME: ' PC-PROGRAM-NAME.        04260000
042700     DISPLAY '*********************************************'.     04270000
042800     DISPLAY ' '.                                                 04280000
042900                                                                  04290000
043000     PERFORM 1020-RETRIEVE-TMST.                                  04300006
043100                                                                  04310006
043800*    * CALCULATE PURGE DATE AS CURRENT DATE - 7 DAYS *            04380006
043900     MOVE PV-CURRENT-TMST(1:10)   TO PV-CALC-DB2-DATE.            04390006
044000     MOVE PC-7                    TO PV-CALC-NBR-DAYS.            04400006
044100     PERFORM 1060-DATE-ROUTINE.                                   04410000
044200                                                                  04420000
044300     MOVE DPG55-DB2-ISO-DATE-FMT  TO PV-PURGE-DATE.               04430006
044400     DISPLAY '    CALCULATED PURGE DATE ----> '                   04440006
044500              PV-PURGE-DATE.                                      04450006
045800                                                                  04580000
046300*1000-EXIT.                                                       04630000
046400                                                                  04640000
052210******************************************************************05221005
052220* RETRIEVE CURRENT TIMESTAMP.                                    *05222006
052230******************************************************************05223005
052240 1020-RETRIEVE-TMST.                                              05224006
052250                                                                  05225015
052260          EXEC SQL                                                05226005
052270              SET :PV-CURRENT-TMST = CURRENT TIMESTAMP            05227005
052280          END-EXEC                                                05228005
052290                                                                  05229005
052291         EVALUATE TRUE                                            05229105
052292             WHEN SQLCODE = ZERO                                  05229205
052293                 CONTINUE                                         05229305
052294                                                                  05229405
052295             WHEN SQLWARN0 NOT EQUAL SPACE                        05229505
052296             WHEN SQLCODE NOT EQUAL ZERO                          05229605
052297                 DISPLAY '**************************************' 05229705
052298                 DISPLAY '** ABEND                            **' 05229805
052299                 DISPLAY '** PROGRAM = PXKUP020               **' 05229906
052300                 DISPLAY '** PARAGRAPH = 1020-RETRIEVE-TMST   **' 05230006
052301                 DISPLAY '** RETRIEVE CURRENT TIMESTAMP       **' 05230106
052302                 DISPLAY '** CURRENT TMST   = ' PV-CURRENT-TMST   05230205
052303                 DISPLAY '**************************************' 05230305
052304                 PERFORM 9900-SQL-ABEND                           05230406
052305         END-EVALUATE.                                            05230505
052306                                                                  05230605
055300*--------------------------------------------------------------*  05530000
055400* USE DATE ROUTINE TO DETERMINE DATE A NUMBER OF DAYS PRIOR TO    05540000
055500* TODAY'S DATE.                                                   05550000
055600*--------------------------------------------------------------*  05560000
055700 1060-DATE-ROUTINE.                                               05570000
055800                                                                  05580000
055900     INITIALIZE DPG51 DPG52 DPG53                                 05590000
056000                DPG54 DPG55 DPG56.                                05600000
056100                                                                  05610000
056200     MOVE PV-CALC-DB2-DATE    TO DPG52-DB2-ISO-DATE-FMT.          05620000
056300     MOVE PV-CALC-NBR-DAYS    TO DPG51-INCR-DECR-DAYS-9.          05630000
056400                                                                  05640000
056500     PERFORM 1070-CALL-DATE-ROUTINE.                              05650000
056600                                                                  05660000
056700     DISPLAY '  CALCULATED DATE FROM DATE ROUTINE ---> '          05670000
056800              DPG55-DB2-ISO-DATE-FMT.                             05680000
056900                                                                  05690000
057000*--------------------------------------------------------------*  05700000
057100* 1070-CALL-DATE-ROUTINE.                                         05710000
057200*                                                                 05720000
057300*--------------------------------------------------------------*  05730000
057400 1070-CALL-DATE-ROUTINE.                                          05740000
057500                                                                  05750000
057600     SET DPG51-FISCAL-454-CALENDAR  TO TRUE.                      05760000
057700     SET DPG51-DECREMENT-DATE       TO TRUE.                      05770000
057800     SET DPG52-LK-DTE-ISO-FMT       TO TRUE.                      05780000
057900                                                                  05790000
058000     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    05800000
058100                                             DPG54 DPG55 DPG56.   05810000
058200                                                                  05820000
058300     IF DPG54-SEVERE-ERROR OR DPG54-DATE-INVALID                  05830000
058400       DISPLAY '**       ABEND         **'                        05840000
058500       DISPLAY '** PROGRAM = PXKUP020  **'                        05850015
058600       DISPLAY 'DATE = '                                          05860000
058700                DPG52-DB2-ISO-DATE-FMT                            05870000
058800       DISPLAY DPG54-ERROR-MESSAGE                                05880000
058900       MOVE 4019 TO PV-ABEND-CODE                                 05890000
059000       CALL 'ILBOABN0' USING PV-ABEND-CODE                        05900000
059100     END-IF.                                                      05910000
059200                                                                  05920000
090140*--------------------------------------------------------------*  09014000
090200* 2000-PROCESS-DELETE-MOS.                                     *  09020007
090300*  DELETE MOS SKU/STORE DATA BASED ON THE PURGE DATE           *  09030008
090500*--------------------------------------------------------------*  09050000
090600 2000-PROCESS-DELETE-MOS.                                         09060007
090700                                                                  09070000
090800     SET MORE-DELETE-MOS TO TRUE.                                 09080007
090900     PERFORM 3800-OPEN-MOS-CSR.                                   09090007
091000     PERFORM 3850-FETCH-MOS-CSR.                                  09100007
091100                                                                  09110000
091200     IF NO-MORE-DELETE-MOS                                        09120007
091300        DISPLAY '* NO MARK OUT OF STOCK ROWS DELETED *'           09130007
091400     ELSE                                                         09140000
091500        PERFORM 2800-PROCESS-DELETE-MOS                           09150007
091600          UNTIL NO-MORE-DELETE-MOS                                09160007
091700        DISPLAY '* MARK OUT OF STOCK ROWS DELETED*'               09170011
091800     END-IF.                                                      09180000
091900                                                                  09190000
092000     PERFORM 3890-CLOSE-MOS-CSR.                                  09200007
092100                                                                  09210000
092200     IF PV-CNT-SINCE-COMMIT > 0                                   09220000
092300         PERFORM 9000-COMMIT                                      09230000
092400     END-IF.                                                      09240000
092500                                                                  09250000
092800*--------------------------------------------------------------*  09280000
092900* 2800-PROCESS-DELETE-MOS                                         09290007
093000*--------------------------------------------------------------*  09300000
093100 2800-PROCESS-DELETE-MOS.                                         09310007
093200                                                                  09320000
093300     PERFORM 5100-DELETE-MOS.                                     09330007
093400                                                                  09340000
093500     IF PV-CNT-SINCE-COMMIT > PC-COMMIT-MAX                       09350000
093600         PERFORM 9000-COMMIT                                      09360000
093700     END-IF.                                                      09370000
093800                                                                  09380000
093900     PERFORM 3850-FETCH-MOS-CSR.                                  09390007
094000                                                                  09400000
158600******************************************************************15860000
158700* 3800-OPEN-MOS-CSR.                                              15870007
158800******************************************************************15880000
158900 3800-OPEN-MOS-CSR.                                               15890007
159000                                                                  15900000
159100     DISPLAY 'OPENING MOS CSR'.                                   15910007
159200                                                                  15920000
159300     EXEC SQL                                                     15930000
159400          OPEN MOS-SKU-STR-CSR                                    15940007
159500     END-EXEC.                                                    15950000
159600                                                                  15960000
159700     EVALUATE TRUE                                                15970000
159800         WHEN SQLCODE = ZERO                                      15980000
159900             CONTINUE                                             15990000
160000         WHEN OTHER                                               16000000
160100             MOVE '3800-OPEN-MOS-CSR'                             16010007
160200                  TO PV-PARAGRAPH-NAME                            16020000
160300             MOVE 'ERROR ON OPEN OF MOS-CSR'                      16030007
160400                  TO PV-DB2-OPERATION                             16040000
160500             PERFORM 9900-SQL-ABEND                               16050000
160600     END-EVALUATE.                                                16060000
160700                                                                  16070000
160800******************************************************************16080000
160900* 3850-FETCH-MOS-CSR.                                             16090007
161000******************************************************************16100000
161100 3850-FETCH-MOS-CSR.                                              16110007
161200                                                                  16120000
161300     PERFORM                                                      16130000
161400        WITH TEST AFTER                                           16140000
161500        VARYING PV-RETRY  FROM 1 BY 1                             16150000
161600          UNTIL (PV-RETRY > PC-MAX-RETRIES                        16160000
161700             OR (SQLCODE = +100 OR +0))                           16170000
161800     EXEC SQL                                                     16180000
161900          FETCH MOS-SKU-STR-CSR                                   16190007
162000           INTO :PXT00003-SKU-NBR                                 16200007
162010               ,:PXT00003-STR-NBR                                 16201007
162020               ,:PXT00003-EFF-END-DTE                             16202007
162100     END-EXEC                                                     16210000
162200                                                                  16220000
162300       MOVE SQLCODE TO PV-SQL-SUB                                 16230000
162400     EVALUATE TRUE                                                16240000
162500         WHEN SQLCODE = ZERO                                      16250000
162600             ADD +1 TO PV-TOTAL-FETCH-CNT                         16260000
162800         WHEN SQLCODE = -904                                      16280000
162900         WHEN SQLCODE = -911                                      16290000
163000         WHEN SQLCODE = -913                                      16300000
163100             CONTINUE                                             16310000
163200         WHEN SQLCODE = +100                                      16320000
163300             SET NO-MORE-DELETE-MOS TO TRUE                       16330007
163400         WHEN OTHER                                               16340000
163500              DISPLAY '*3850 BLOWING UP ON BAD SQL-'              16350000
163600                 '* FETCH KEY-',                                  16360000
163700                  PXT00003-SKU-NBR,                               16370007
163800                 ' SQL CODE -', PV-SQL-SUB, '**'                  16380000
163900              MOVE '3850-FETCH-MOS-CSR'                           16390007
164000                  TO PV-PARAGRAPH-NAME                            16400000
164100             MOVE 'ERROR ON FETCH OF MOS CSR'                     16410007
164200                  TO PV-DB2-OPERATION                             16420000
164300             PERFORM 9900-SQL-ABEND                               16430000
164400         END-EVALUATE                                             16440000
164500     END-PERFORM.                                                 16450000
164600                                                                  16460000
164700     IF PV-RETRY GREATER PC-MAX-RETRIES                           16470000
164800       DISPLAY '*3850 BLOWING UP ON RETRIES-'                     16480000
164900        PV-RETRY '**'                                             16490000
165000               '* FETCH KEY-',                                    16500000
165100                PXT00003-SKU-NBR,                                 16510007
165200               ' SQL CODE -', PV-SQL-SUB, '**'                    16520000
165300        MOVE '3850-FETCH-MOS-CSR'                                 16530007
165400                 TO PV-PARAGRAPH-NAME                             16540000
165500        MOVE 'ERROR ON FETCH OF MOS CSR'                          16550007
165600                 TO PV-DB2-OPERATION                              16560000
165700        PERFORM 9900-SQL-ABEND                                    16570000
165800     END-IF.                                                      16580000
165900                                                                  16590000
166000******************************************************************16600000
166100* 3890-CLOSE-MOS-CSR.                                             16610007
166200******************************************************************16620000
166300 3890-CLOSE-MOS-CSR.                                              16630007
166400                                                                  16640000
166500     EXEC SQL                                                     16650000
166600          CLOSE MOS-SKU-STR-CSR                                   16660011
166700     END-EXEC.                                                    16670000
166800                                                                  16680000
166900     EVALUATE TRUE                                                16690000
167000         WHEN SQLCODE = ZERO                                      16700000
167100             CONTINUE                                             16710000
167200         WHEN OTHER                                               16720000
167300             MOVE '3890-CLOSE-MOS-CSR'                            16730007
167400                  TO PV-PARAGRAPH-NAME                            16740000
167500             MOVE 'ERROR ON CLOSE OF MOS CSR'                     16750007
167600                  TO PV-DB2-OPERATION                             16760000
167700             PERFORM 9900-SQL-ABEND                               16770000
167800     END-EVALUATE.                                                16780000
167900                                                                  16790000
196700*--------------------------------------------------------------*  19670000
196800* 5100-DELETE-MOS                                              *  19680007
196900*   DELETE MARK OUT OF STOCK DATA                              *  19690007
197000*--------------------------------------------------------------*  19700000
197100 5100-DELETE-MOS.                                                 19710007
197200                                                                  19720000
197300     MOVE '5100-DELETE-MOS' TO PV-PARAGRAPH-NAME.                 19730007
197400                                                                  19740000
197500     PERFORM                                                      19750000
197600         WITH TEST AFTER                                          19760000
197700         VARYING PV-NUMBER-OF-RETRIES                             19770000
197800         FROM 1 BY 1                                              19780000
197900         UNTIL (PV-NUMBER-OF-RETRIES GREATER PC-MAX-RETRIES       19790000
198000                OR SQLCODE = 0)                                   19800000
198100                                                                  19810000
198200         EXEC SQL                                                 19820000
198300             DELETE                                               19830000
198400               FROM PXT_MOS_SKU_STR  A                            19840014
198510              WHERE A.SKU_NBR = :PXT00003-SKU-NBR                 19851014
198520                AND A.STR_NBR = :PXT00003-STR-NBR                 19852014
198530                AND A.EFF_END_DTE = :PXT00003-EFF-END-DTE         19853014
198600         END-EXEC                                                 19860000
199100                                                                  19910000
199200         EVALUATE TRUE                                            19920000
199300             WHEN SQLCODE = -904                                  19930000
199400             WHEN SQLCODE = -911                                  19940000
199500             WHEN SQLCODE = -913                                  19950000
199510             WHEN SQLCODE = +100                                  19951014
199600                 CONTINUE                                         19960000
199700             WHEN SQLCODE = 0                                     19970000
199800                 ADD +1 TO PV-DELETE-CNT                          19980000
200000                 ADD +1 TO PV-CNT-SINCE-COMMIT                    20000000
200100             WHEN OTHER                                           20010000
200200                DISPLAY '>>> 5100 DELETE PROBLEM ON MOS   '       20020007
200300                     PXT00003-SKU-NBR,  '-',                      20030007
200400                     '<<<'                                        20040000
200500                 MOVE 'ERROR ON DELETE OF MOS ' TO                20050007
200600                      PV-DB2-OPERATION                            20060000
200700                 PERFORM 9900-SQL-ABEND                           20070000
200800         END-EVALUATE                                             20080000
200900     END-PERFORM.                                                 20090000
201000                                                                  20100000
201100     IF PV-NUMBER-OF-RETRIES GREATER PC-MAX-RETRIES               20110000
201200         MOVE 'DELETE RETRIES EXCEEDED' TO PV-DB2-OPERATION       20120000
201300         PERFORM 9900-SQL-ABEND                                   20130000
201400     END-IF.                                                      20140000
201500                                                                  20150000
201600*--------------------------------------------------------------*  20160000
201700* 9000-COMMIT.                                                    20170000
201800*--------------------------------------------------------------*  20180000
201900 9000-COMMIT.                                                     20190000
202000                                                                  20200000
202100     MOVE '9000-COMMIT' TO PV-PARAGRAPH-NAME.                     20210000
202200                                                                  20220000
202300     PERFORM                                                      20230000
202400         WITH TEST AFTER                                          20240000
202500         VARYING PV-NUMBER-OF-RETRIES                             20250000
202600         FROM 1 BY 1                                              20260000
202700         UNTIL (PV-NUMBER-OF-RETRIES GREATER PC-MAX-RETRIES       20270000
202800                OR SQLCODE = 0)                                   20280000
202900                                                                  20290000
203000         EXEC SQL                                                 20300000
203100             COMMIT                                               20310000
203200         END-EXEC                                                 20320000
203300                                                                  20330000
203400         EVALUATE TRUE                                            20340000
203500           WHEN SQLCODE = -904                                    20350000
203600           WHEN SQLCODE = -911                                    20360000
203700           WHEN SQLCODE = -913                                    20370000
203800             CONTINUE                                             20380000
203900           WHEN SQLCODE = 0                                       20390000
204000**           DISPLAY ' COMMIT CNT-', PV-CNT-SINCE-COMMIT,         20400000
204100**                   ' WORKING ON-',                              20410000
204200**                         XST00064-STR-GP-TYP-CDE                20420000
204300**                   '-',  XST00064-STR-GP-ID                     20430000
204400**                   ' FOR PRCHG-', XST00064-PRCHG-ID, '*'        20440000
204500             MOVE ZERO TO PV-CNT-SINCE-COMMIT                     20450000
204600           WHEN OTHER                                             20460000
204700             MOVE 'ERROR ON COMMMIT' TO                           20470000
204800                  PV-DB2-OPERATION                                20480000
204900             PERFORM 9900-SQL-ABEND                               20490000
205000         END-EVALUATE                                             20500000
205100     END-PERFORM.                                                 20510000
205200                                                                  20520000
205300     IF PV-NUMBER-OF-RETRIES GREATER PC-MAX-RETRIES               20530000
205400         MOVE 'COMMIT RETRIES EXCEEDED' TO PV-DB2-OPERATION       20540000
205500         PERFORM 9900-SQL-ABEND                                   20550000
205600     END-IF.                                                      20560000
205700                                                                  20570000
205800*--------------------------------------------------------------*  20580000
205900* 9900-SQL-ABEND.                                                 20590000
206000*     SQL ABEND ROUTINE.                                          20600000
206100*--------------------------------------------------------------*  20610000
206200 9900-SQL-ABEND.                                                  20620000
206300                                                                  20630000
206400     DISPLAY '** ABEND     **'.                                   20640000
206500     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                20650000
206600     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              20660000
206700     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               20670000
206800                                                                  20680000
206900     COPY DPPD004.                                                20690000
207000     SET ABEND-4013-DB2-ERROR TO TRUE.                            20700000
207100     CALL 'ILBOABN0' USING ABEND-CODE.                            20710000
207200                                                                  20720000
207300*9900-EXIT.                                                       20730000
207400                                                                  20740000
207500*--------------------------------------------------------------*  20750000
207600* 9999-WRAPUP.                                                    20760000
207700*     END OF PROGRAM ROUTINE.  CLOSES ALL FILES AND DISPLAYS      20770000
207800*     DATA COUNTS FROM THE PROGRAM.                               20780000
207900*--------------------------------------------------------------*  20790000
208000 9999-WRAPUP.                                                     20800000
208100                                                                  20810000
208200     DISPLAY '   '.                                               20820000
208300     DISPLAY '*************************************************'. 20830010
208310     DISPLAY '*SUMMARY OF PXKUP020 - MARK OUT OF STOCK DELETES*'. 20831010
208320     DISPLAY '*************************************************'. 20832010
208500     DISPLAY 'TOTAL ROWS FETCHED: '                               20850018
208600             PV-TOTAL-FETCH-CNT.                                  20860000
210300     DISPLAY '   '.                                               21030000
210400     DISPLAY 'TOTAL ROWS DELETED: '                               21040018
210500             PV-DELETE-CNT.                                       21050000
211700                                                                  21170000
211800     DISPLAY '   '.                                               21180000
211900                                                                  21190000
212000     DISPLAY '*********************************************'.     21200000
212100     DISPLAY '       END OF PROGRAM: ' PC-PROGRAM-NAME.           21210000
212200     DISPLAY '*********************************************'.     21220000
212300     DISPLAY ' '.                                                 21230000
212400                                                                  21240000
212500*9999-EXIT.                                                       21250000
