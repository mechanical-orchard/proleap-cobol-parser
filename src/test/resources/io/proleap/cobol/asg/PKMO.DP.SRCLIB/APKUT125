000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.      APKUT125.                                       00020000
000300 AUTHOR.          NANCY EILBES.                                   00030000
000400 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00040000
000500 DATE-WRITTEN.    04/21/2004.                                     00050000
000600*----------------------------------------------------------------*00060000
000700*   CREATE QUARTERLY BUYER CREDITS FOR BROADCAST AGREEMENTS AND  *00070000
000800*   EXPENSE REDUCTIONS FOR BRIDAL AGREEMENTS.                    *00080000
000900*   COBOL390 WITH DB2 SQL                                        *00090000
001000*----------------------------------------------------------------*00100000
001100*   THIS PROGRAM WILL READ AN EXTRACT FILE OF VENDOR AGREEMENT   *00110000
001200*   PURCHASE ACTIVITY AND GENERATE ADJUSTMENTS.  THE ADJUSTMENTS *00120000
001300*   FOR THE BROADCAST OPTIMIZATION PROGRAM WILL CREDIT THE       *00130000
001400*   BUYER'S DEPARTMENT WITH THE EARNED AMOUNT FOR THE QUARTER.   *00140000
001500*   THE ADJUSTMENTS FOR THE BRIDAL REGISTRY PROGRAM WILL CREDIT  *00150000
001600*   THE BRIDAL EXPENSE ACCOUNT.                                  *00160000
001700*                                                                *00170000
001800*   THE INPUT FILE WILL BE SORTED BY TRANCODE, YEAR, QUARTER,    *00180000
001900*   VENDOR, DEPARTMENT AND THERE WILL BE MULTIPLE RECORDS FOR    *00190000
002000*   EACH OF THESE SORT KEYS.  WHEN THE TRANSACTIONS ARE CREATED, *00200000
002100*   IF THE KEY FIELDS HAVE NOT CHANGED, THE SAME DOC NUMBER WILL *00210000
002200*   BE ASSIGNED SO THAT THE DETAILS WILL BE ROLLED UP UNDER ONE  *00220000
002300*   ADJUSTMENT BEFORE BEING LOADED INTO THE DATABASE.            *00230000
002400*----------------------------------------------------------------*00240000
002500*                                                                *00250000
002600* DB2 TABLES:                                                    *00260000
002700*  1. ACCOUNTS PAYABLE CONTROL TABLE  (TAPCNTL TABLE)            *00270000
002800*  2. AP TRANCODE MASTER TABLE        (TTRNCDE TABLE)            *00280000
002900*  3. VENDOR ANAYLSIS BY DEPARTMENT   (TVADPT  TABLE)            *00290000
003000*  4. APPLICATION AVAILABILITY TABLE  (TAPLAVL TABLE)            *00300000
003100*  5. ML PARTITION BALANCE TABLE      (MLT00002 TABLE)           *00310000
003200*  6. ML PARTITION CONTROL TABLE      (MLT00003 TABLE)           *00320000
003300*  7. ML MONTHLY SUMMARY TABLE        (MLT00004 TABLE)           *00330000
003400*                                                                *00340000
003500* INPUT FILE:                                                    *00350000
003600*  1. VENDOR AGREEMENT ACTIVITY FILE  (COPYBOOK APRD081)         *00360000
003700*                                                                *00370000
003800* OUTPUT FILE:                                                   *00380000
003900*  1. ADJUSTMENT DETAILS              (COPYBOOK APRD045)         *00390000
004000*                                                                *00400000
004100*----------------------------------------------------------------*00410000
004200* CHANGE LOG:                                                    *00420000
004300*   DATE  04/21/2004                                             *00430000
004400*       CHANGE MADE: INITIAL VERSION.                            *00440000
004500*       MADE BY: NANCY EILBES            WR/IR #: WR26677        *00450000
004600*                                                                *00460000
004700*   DATE  04/19/2005                                             *00470000
004800*       CHANGE MADE: CHANGING BUYER CREDITS TO BE DISTRIBUTED    *00480000
004900*       TO A SUBCLASS LEVEL.  ADDED ML TABLES TO ACCESS THE      *00490000
005000*       MONTHLY RECEIPTS AT A VENDOR/DEPT/SUBCLASS LEVEL TO      *00500000
005100*       CALCULATE A PERCENT TO TOTAL.  THIS PERCENT WILL BE      *00510000
005200*       APPLIED TO THE ESTIMATED EARNED AMOUNT FROM THE INPUT    *00520000
005300*       AND MULTIPLE DETAIL RECORDS WILL BE CREATED FOR EACH     *00530000
005400*       BUYER CREDIT INSTEAD OF JUST ONE.  REMOVED TMDSEAR.      *00540000
005500*       MADE BY: NANCY EILBES            WR/IR #: WR28143        *00550000
004600*                                                                *00551000
004700*   DATE  12/13/2005                                             *00552000
004800*       CHANGE MADE: JOIN THE DEPARTMENT, BRAND, VENDOR RELATION-*00553000
004900*       SHIP TABLE, IMT_DEPT_BRND_VEND TO THE MLT_MNLY_SUM BY THE*00554000
005000*       DATALESS KEY, IMT_DEPT_BRND_VND_ID.                      *00555000
005500*       MADE BY: CAROLE MCCAMMON         WR/IR #: WR28582        *00559100
005600*                                                                *00560000
004700*   DATE  02/21/2023                                             *00561002
004800*       CHANGE MADE: CHANGE THE CALL TO DPKUP151 FROM STATIC TO  *00562002
004900*                    DYNAMIC                                     *00563002
005500*       MADE BY: JEAN KURK               WR/IR #: CHG0282641     *00565002
005700*----------------------------------------------------------------*00570000
005800                                                                  00580000
005900 ENVIRONMENT DIVISION.                                            00590000
006000                                                                  00600000
006100 CONFIGURATION SECTION.                                           00610000
006200 SOURCE-COMPUTER. IBM-3090.                                       00620000
006300 OBJECT-COMPUTER. IBM-3090.                                       00630000
006400                                                                  00640000
006500 INPUT-OUTPUT SECTION.                                            00650000
006600 FILE-CONTROL.                                                    00660000
006700     SELECT VNDAGR-ACTVTY-FILE ASSIGN TO INP01.                   00670000
006800     SELECT ADJUST-JRNL-FILE ASSIGN TO OUT01.                     00680000
006900                                                                  00690000
007000 DATA DIVISION.                                                   00700000
007100                                                                  00710000
007200 FILE SECTION.                                                    00720000
007300                                                                  00730000
007400 FD  VNDAGR-ACTVTY-FILE                                           00740000
007500     RECORDING MODE IS F                                          00750000
007600     LABEL RECORDS ARE STANDARD                                   00760000
007700     BLOCK CONTAINS 0 RECORDS                                     00770000
007800     DATA RECORD IS INPUT-EXP-INV-RECORD.                         00780000
007900                                                                  00790000
008000 01  VNDAGR-ACTVTY-RECORD       PIC X(250).                       00800000
008100                                                                  00810000
008200 FD  ADJUST-JRNL-FILE                                             00820000
008300     RECORDING MODE F                                             00830000
008400     LABEL RECORDS ARE STANDARD                                   00840000
008500     DATA RECORD IS ADJUST-JRNL-RECORD.                           00850000
008600 01  ADJUST-JRNL-RECORD         PIC X(500).                       00860000
008700                                                                  00870000
008800                                                                  00880000
008900 WORKING-STORAGE SECTION.                                         00890000
009000                                                                  00900000
009100 01  PV-PROGRAM-VARIABLES.                                        00910000
009200     05  PV-CURR-TMST               PIC X(26) VALUE SPACES.       00920000
009300     05  PV-ENTR-DTE                PIC X(10) VALUE SPACES.       00930000
009400     05  PV-MIN-CAL-DTE             PIC X(10) VALUE SPACES.       00940000
009500     05  PV-MAX-CAL-DTE             PIC X(10) VALUE SPACES.       00950000
009600     05  PV-MIN-FSCL-DTE            PIC X(10) VALUE SPACES.       00960000
009700     05  PV-MAX-FSCL-DTE            PIC X(10) VALUE SPACES.       00970000
009800     05  PV-SQL-MIN-DTE             PIC X(10) VALUE SPACES.       00980000
009900     05  PV-SQL-MAX-DTE             PIC X(10) VALUE SPACES.       00990000
010000     05  PV-MIN-MN-NBR              PIC X(02) VALUE SPACES.       01000000
010100     05  PV-MAX-MN-NBR              PIC X(02) VALUE SPACES.       01010000
010200     05  SAVE-AP-TRN-CDE            PIC X(02) VALUE SPACES.       01020000
010300     05  SAVE-VENDOR-NBR            PIC X(09) VALUE SPACES.       01030000
010400     05  SAVE-DEPT-NBR              PIC X(03) VALUE SPACES.       01040000
010500     05  PV-NUM-DEPT                PIC 9(03) VALUE ZERO.         01050000
010600     05  PV-NUM-SCL                 PIC 9(02) VALUE ZERO.         01060000
010700     05  MATCH-AP-TRN-CDE           PIC X(02) VALUE SPACES.       01070000
010800     05  WS-RVRS-TRN-CDE            PIC X(02) VALUE SPACES.       01080000
010900     05  WS-VND-DEDUCT-TRN-CDE      PIC X(02) VALUE SPACES.       01090000
011000     05  PV-ACTVTY-AMT              PIC S9(7)V99 COMP-3 VALUE +0. 01100000
011100     05  PV-DISTRO-AMT              PIC S9(11)V99 COMP-3 VALUE +0.01110000
011200     05  PV-DPT-RCPT-AMT            PIC S9(11)V99 COMP-3 VALUE +0.01120000
011300     05  PV-SCL-RCPT-AMT            PIC S9(11)V99 COMP-3 VALUE +0.01130000
011400     05  PV-SCL-DISTRO-AMT          PIC S9(11)V99 COMP-3 VALUE +0.01140000
011500     05  PV-SCL-PERCENT             PIC S9V9(9) COMP-3 VALUE +0.  01150000
011510     05  DISPLAY-PERCENT            PIC Z.ZZZZZZZZZ.              01151000
011520     05  DISPLAY-AMOUNT             PIC ZZZZZZZZZZ.99.            01152000
011600                                                                  01160000
011700 01  WS-COUNTERS-AND-CONSTANTS.                                   01170000
011800     05  INPUT-COUNT                  PIC 9(09) VALUE 0.          01180000
011900     05  OUT-ADJUSTMENT-COUNT         PIC 9(09) VALUE 0.          01190000
012000     05  PC-PROGRAM-NAME              PIC X(08) VALUE 'APKUT125'. 01200000
011600                                                                  01201002
012200 01  PS-PROGRAM-SWITCHES.                                         01220000
012300     05  PS-ACTVTY-EOF                PIC X(01)      VALUE 'N'.   01230000
012400         88  ACTVTY-EOF                              VALUE 'Y'.   01240000
012500     05  PS-TRANCODE-CSR-SW           PIC X(01)      VALUE ' '.   01250000
012600         88  END-OF-TRANCODES                        VALUE 'Y'.   01260000
012700     05  PS-SUBCLASS-CSR-SW           PIC X(01)      VALUE ' '.   01270000
012800         88  END-OF-SUBCLASS                         VALUE 'Y'.   01280000
012900     05  PS-FISCAL-QTR-IND            PIC X(01)      VALUE 'N'.   01290000
013000         88  END-OF-FISCAL-QTR                       VALUE 'Y'.   01300000
013100     05  PS-FREQUENCY-CDE             PIC X(01)      VALUE 'N'.   01310000
013200         88  FISCAL-AGREEMENT                        VALUE 'F'.   01320000
013300         88  CALENDAR-AGREEMENT                      VALUE 'C'.   01330000
013400                                                                  01340000
013500 01  WS-ABEND-FIELDS.                                             01350000
013600     05  WS-ABEND-LITERAL          PIC  X(40)   VALUE             01360000
013700             '*****       ABEND'.                                 01370000
013800     05  WS-ABEND-PROGRAM-MSG.                                    01380000
013900         10  FILLER                PIC X(17)    VALUE             01390000
014000             '*****   PROGRAM: '.                                 01400000
014100         10  WS-ABEND-PROGRAM      PIC X(8)   VALUE 'APKUT125'.   01410000
014200     05  WS-ABEND-PARAGRAPH-MSG.                                  01420000
014300         10  FILLER                PIC  X(17)   VALUE             01430000
014400             '***** PARAGRAPH: '.                                 01440000
014500         10  WS-ABEND-PARAGRAPH    PIC X(35)  VALUE SPACES.       01450000
014600     05  WS-ABEND-OPERATION-MSG.                                  01460000
014700         10  FILLER                PIC  X(17)   VALUE             01470000
014800             '***** OPERATION: '.                                 01480000
014900         10  WS-ABEND-OPERATION    PIC X(50)  VALUE SPACES.       01490000
015000     05  WS-ABEND-TABLE1-MSG.                                     01500000
015100         10  FILLER                PIC  X(15)   VALUE             01510000
015200             '***** TABLE 1: '.                                   01520000
015300         10  WS-ABEND-STRUCTURE-1  PIC X(8)   VALUE SPACES.       01530000
015400     05  WS-ABEND-TABLE2-MSG.                                     01540000
015500         10  FILLER                PIC  X(15)   VALUE             01550000
015600             '***** TABLE 2: '.                                   01560000
015700         10  WS-ABEND-STRUCTURE-2  PIC X(8)   VALUE SPACES.       01570000
015800     05  WS-ABEND-STATUS           PIC XX     VALUE SPACES.       01580000
015900     05  WS-MESSAGE-LINE-1.                                       01590000
016000         10  FILLER                PIC  X(06)   VALUE '*****'.    01600000
016100         10  WS-MESSAGE-1          PIC  X(80)   VALUE SPACES.     01610000
016200     05  WS-MESSAGE-LINE-2.                                       01620000
016300         10  FILLER                PIC  X(06)   VALUE '*****'.    01630000
016400         10  WS-MESSAGE-2          PIC  X(80)   VALUE SPACES.     01640000
016500                                                                  01650000
016600 01  ABEND-CODE                    PIC S9(4)  COMP SYNC           01660000
016700                                              VALUE ZEROS.        01670000
016800     88 AP-TABLE-FULL              VALUE +4004.                   01680000
016900     88 AP-EMPTY-FILE              VALUE +4005.                   01690000
017000     88 AP-TABLE-NOTFND            VALUE +4006.                   01700000
017100     88 AC-BAD-DATA                VALUE +4008.                   01710000
017200     88 AP-DB2-ERROR               VALUE +4013.                   01720000
017300                                                                  01730000
017400 01  AP-TRANCODES.                                                01740000
017500     05  AP-TRANCODE-TBL OCCURS 25 TIMES INDEXED BY TRN-INDEX.    01750000
017600         10  TBL-AP-TRN-CDE             PIC X(2).                 01760000
017700         10  TBL-PSTG-TYP-CDE           PIC X(2).                 01770000
017800         10  TBL-TRN-TYP-CDE            PIC X(3).                 01780000
017900         10  TBL-AUTO-OFFST-TRN-CDE     PIC X(2).                 01790000
018000         10  TBL-GL-ACCT-NBR            PIC X(6).                 01800000
018100         10  TBL-BTCH-SRC-CDE           PIC X(3).                 01810000
018200         10  TBL-ADJUST-TRN-CDE         PIC X(2).                 01820000
018300                                                                  01830000
018400*----------------------------------------------------------------*01840000
018500* DB2 SQL ERROR MESSAGE FORMAT AREA                               01850000
018600*----------------------------------------------------------------*01860000
018700                                                                  01870000
018800     COPY DPWS004.                                                01880000
018900                                                                  01890000
019000*----------------------------------------------------------------*01900000
019100* VENDOR AGREEMENT ACTIVITY EXTRACT FILE LAYOUT (INPUT)           01910000
019200*----------------------------------------------------------------*01920000
019300                                                                  01930000
019400     COPY APRD081.                                                01940000
019500                                                                  01950000
019600*----------------------------------------------------------------*01960000
019700* ADJUSTMENT JOURNAL DETAIL TRANSACTION RESULTS FILE LAYOUT       01970000
019800*----------------------------------------------------------------*01980000
019900                                                                  01990000
020000     COPY APRD045.                                                02000000
020100                                                                  02010000
020200*---------------------------------------------------------------- 02020000
020300*  WORKING STORAGE AREA FOR DPKUP151                              02030000
020400*---------------------------------------------------------------- 02040000
020500     COPY APWS151.                                                02050000
020500     COPY DPWS951.                                                02051003
020600                                                                  02060000
020700*----------------------------------------------------------------*02070000
020800* ACCOUNTS PAYABLE CONTROL TABLE                                  02080000
020900*----------------------------------------------------------------*02090000
021000                                                                  02100000
021100     EXEC SQL                                                     02110000
021200         INCLUDE TAPCNTL                                          02120000
021300     END-EXEC.                                                    02130000
021400                                                                  02140000
021500*----------------------------------------------------------------*02150000
021600* AP TRANCODE MASTER TABLE                                        02160000
021700*----------------------------------------------------------------*02170000
021800                                                                  02180000
021900     EXEC SQL                                                     02190000
022000         INCLUDE TTRNCDE                                          02200000
022100     END-EXEC.                                                    02210000
022200                                                                  02220000
022300*----------------------------------------------------------------*02230000
022400* DATE ATTRIBUTE TABLE                                            02240000
022500*----------------------------------------------------------------*02250000
022600                                                                  02260000
022700     EXEC SQL                                                     02270000
022800         INCLUDE TDTATTR                                          02280000
022900     END-EXEC.                                                    02290000
023000                                                                  02300000
023100                                                                  02310000
023200*----------------------------------------------------------------*02320000
023300* VENDOR ANALYSIS DEPARTMENT TABLE                                02330000
023400*----------------------------------------------------------------*02340000
023500                                                                  02350000
023600     EXEC SQL                                                     02360000
023700         INCLUDE TVADPT                                           02370000
023800     END-EXEC.                                                    02380000
023900                                                                  02390000
024000                                                                  02400000
024100*----------------------------------------------------------------*02410000
024200* MERCHANDISE LEDGER PARTITION BALANCE TABLE                      02420000
024300*----------------------------------------------------------------*02430000
024400                                                                  02440000
024500     EXEC SQL                                                     02450000
024600         INCLUDE MLT00002                                         02460000
024700     END-EXEC.                                                    02470000
024800                                                                  02480000
024900                                                                  02490000
025000*----------------------------------------------------------------*02500000
025100* MERCHANDISE LEDGER PARTITION CONTROL TABLE                      02510000
025200*----------------------------------------------------------------*02520000
025300                                                                  02530000
025400     EXEC SQL                                                     02540000
025500         INCLUDE MLT00003                                         02550000
025600     END-EXEC.                                                    02560000
025700                                                                  02570000
025800                                                                  02580000
025900*----------------------------------------------------------------*02590000
026000* MERCHANDISE LEDGER MONTHLY SUMMARY TABLE                        02600000
026100*----------------------------------------------------------------*02610000
026200                                                                  02620000
026300     EXEC SQL                                                     02630000
026400         INCLUDE MLT00004                                         02640000
026500     END-EXEC.                                                    02650000
026600                                                                  02660000
026700                                                                  02670000
026701*----------------------------------------------------------------*02671000
026702* DEPARTMENT BRAND VENDOR RELATIONSHIP TABLE                      02672000
026703*----------------------------------------------------------------*02673000
026704                                                                  02674000
026705     EXEC SQL                                                     02675000
026706         INCLUDE MLV00000                                         02676000
026707     END-EXEC.                                                    02677000
026708                                                                  02678000
026709                                                                  02679000
026800*----------------------------------------------------------------*02680000
026900* DB2 COMMUNICATION AREA                                          02690000
027000*----------------------------------------------------------------*02700000
027100                                                                  02710000
027200     EXEC SQL                                                     02720000
027300         INCLUDE SQLCA                                            02730000
027400     END-EXEC.                                                    02740000
027500                                                                  02750000
027600*----------------------------------------------------------------*02760000
027700* DB2 COMMUNICATION AREA2                                         02770000
027800*----------------------------------------------------------------*02780000
027900                                                                  02790000
028000     COPY SQLCA2.                                                 02800000
028100                                                                  02810000
028200*----------------------------------------------------------------*02820000
028300* TRANCODE CURSOR RETURNS ALL VENDOR AGREEMENT TRANCODES         *02830000
028400*----------------------------------------------------------------*02840000
028500                                                                  02850000
028600     EXEC SQL                                                     02860000
028700       DECLARE TRANCODE_CSR CURSOR FOR                            02870000
028800         SELECT AP_TRN_CDE                                        02880000
028900              , PSTG_TYP_CDE                                      02890000
029000              , TRN_TYP_CDE                                       02900000
029100              , AUTO_OFFST_TRN_CDE                                02910000
029200              , GL_ACCT_NBR                                       02920000
029300           FROM TTRNCDE                                           02930000
029400          WHERE BTCH_SRC_CDE IN ('VAA','VDA')                     02940000
029500            AND CURRENT DATE BETWEEN EFF_STRT_DTE                 02950000
029600                                 AND EFF_END_DTE                  02960000
029700     END-EXEC.                                                    02970000
029800                                                                  02980000
029900*----------------------------------------------------------------*02990000
030000* SUBCLASS CURSOR RETURNS TOTAL RECEIPTS FOR THE QTR BY SCL      *03000000
030100* FOR THE VENDOR AND DEPT BEING PROCESSED.                       *03010000
030200*----------------------------------------------------------------*03020000
030300                                                                  03030000
030400     EXEC SQL                                                     03040000
030500       DECLARE SUBCLASS_CSR CURSOR FOR                            03050000
030600         SELECT B.SUB_CL_NBR                                      03060000
030700              , SUM(B.RCPT_GRO_COST_AMT)                          03070000
030800           FROM MLT_PARTN_CNTL A                                  03080000
030900              , MLT_MNLY_SUM B                                    03090000
031000              , MLT_PARTN_BAL C                                   03100000
W28582              , MLV_BRND_VND D                                    03101000
031100          WHERE A.TBL_TM_LVL_CDE  = 'M'                           03110000
031200            AND A.TBL_TM_LVL_CDE  = C.TBL_TM_LVL_CDE              03120000
031300            AND A.FSCL_DTE        BETWEEN :PV-SQL-MIN-DTE         03130000
031400                                      AND :PV-SQL-MAX-DTE         03140000
031500            AND A.FSCL_DTE        BETWEEN C.EFF_BEG_DTE           03150000
031600                                      AND C.EFF_END_DTE           03160000
031700            AND A.DEPT_GP_CDE     = C.DEPT_GP_CDE                 03170000
031800            AND B.PARTN_NBR       = A.PARTN_NBR                   03180000
031900            AND C.DEPT_NBR        = :MLT00004-DEPT-NBR            03190000
032000            AND C.DEPT_NBR        = B.DEPT_NBR                    03200000
W28582            AND D.DEPT_NBR        = B.DEPT_NBR                    03201000
W28582            AND D.ML_LO_MDSE_LVL_ID = B.ML_LO_MDSE_LVL_ID         03210000
W28582            AND D.ENT_ID          = :MLV00000-ENT-ID              03210100
W28582**          AND B.ENT_ID          = :MLT00004-ENT-ID              03211000
032200            AND B.FSCL_MN_END_DTE BETWEEN :PV-SQL-MIN-DTE         03220000
032300                                      AND :PV-SQL-MAX-DTE         03230000
032400    GROUP BY B.SUB_CL_NBR                                         03240000
032500        HAVING SUM(RCPT_NET_COST_AMT) ^= 0                        03250000
032600      WITH UR                                                     03260000
032700     END-EXEC.                                                    03270000
032800                                                                  03280000
032900 PROCEDURE DIVISION.                                              03290000
033000                                                                  03300000
033100 A100-PROGRAM-MAINLINE.                                           03310000
033200                                                                  03320000
033300     PERFORM B100-HOUSEKEEPING.                                   03330000
033400                                                                  03340000
033500     PERFORM B200-PROCESS-ACTVTY-REC                              03350000
033600         UNTIL ACTVTY-EOF.                                        03360000
033700                                                                  03370000
033800     PERFORM B300-END-OF-JOB.                                     03380000
033900                                                                  03390000
034000     GOBACK.                                                      03400000
034100                                                                  03410000
034200*----------------------------------------------------------------*03420000
034300*  B100-HOUSEKEEPING  OPEN FILES, INITIALIZE THE NECESSARY        03430000
034400*  FIELDS, PROCESS THE INVOICE FILE FOR THE FIRST RECORD, AND     03440000
034500*  OPENS THE CURSOR FOR THE FIRST RECORD.                         03450000
034600*----------------------------------------------------------------*03460000
034700                                                                  03470000
034800 B100-HOUSEKEEPING.                                               03480000
034900                                                                  03490000
035000     OPEN INPUT  VNDAGR-ACTVTY-FILE                               03500000
035100          OUTPUT ADJUST-JRNL-FILE.                                03510000
035200                                                                  03520000
035300     INITIALIZE AP045-TRANSACTION-FILE.                           03530000
035400                                                                  03540000
035500     PERFORM S400-SELECT-DATES.                                   03550000
035600     DISPLAY '*** DATE CONTROLS SELECTED FOR THIS RUN ***'        03560000
035700     DISPLAY 'BATCH PROCESS DATE   = ' APCNTL-BTCH-PRC-DTE.       03570000
035800     DISPLAY 'PS-FISCAL-QTR-IND    = ' PS-FISCAL-QTR-IND.         03580000
035900     DISPLAY 'FISCAL MIN DATE      = ' PV-MIN-FSCL-DTE.           03590000
036000     DISPLAY 'FISCAL MAX DATE      = ' PV-MAX-FSCL-DTE.           03600000
036100     DISPLAY 'CALENDAR MIN DATE    = ' PV-MIN-CAL-DTE.            03610000
036200     DISPLAY 'CALENDAR MAX DATE    = ' PV-MAX-CAL-DTE.            03620000
036300     DISPLAY '****** END OF DATE CONTROLS DISPLAY *******'.       03630000
036400                                                                  03640000
036500     PERFORM S500-SET-CURRENT-TMST.                               03650000
036600     PERFORM D200-LOAD-TRANCODES.                                 03660000
036700                                                                  03670000
036800     PERFORM R100-READ-VNDAGR-ACTVTY-FILE.                        03680000
036900                                                                  03690000
037000*---------------------------------------------------------------* 03700000
037100*  B200-PROCESS-ACTVTY-REC                                      * 03710000
037200*  PROCESSES RECORDS FROM THE EXTRACT FILE.                     * 03720000
037300*---------------------------------------------------------------* 03730000
037400                                                                  03740000
037500 B200-PROCESS-ACTVTY-REC.                                         03750000
037600                                                                  03760000
037700     IF  AP081-EST-EARNED-AMT = 0                                 03770000
037800     OR  AP081-EST-EARNED-AMT < 0                                 03780000
037900         CONTINUE                                                 03790000
038000     ELSE                                                         03800000
038100         EVALUATE TRUE                                            03810000
038200             WHEN AP081-POST-FSCL-MNTH                            03820000
038300             WHEN AP081-POST-FSCL-QTR                             03830000
038400             WHEN AP081-POST-FSCL-SEMI-ANNL                       03840000
038500             WHEN AP081-POST-FSCL-ANNL                            03850000
038600                  IF  AP081-FSCL-QTR-NBR = DTATTR-FSCL-QTR-NBR    03860000
038700                  AND AP081-FSCL-YR-NBR = DTATTR-FSCL-YR-NBR      03870000
038800                      SET FISCAL-AGREEMENT TO TRUE                03880000
038900                      PERFORM C100-CREATE-ADJUSTMENT-DETAIL       03890000
039000                  END-IF                                          03900000
039100             WHEN AP081-POST-CAL-QTR                              03910000
039200             WHEN AP081-POST-CAL-SEMI-ANNL                        03920000
039300             WHEN AP081-POST-CAL-ANNL                             03930000
039400                  IF  AP081-CAL-QTR-NBR = DTATTR-FSCL-QTR-NBR     03940000
039500                  AND AP081-CAL-YR-NBR  = DTATTR-FSCL-YR-NBR      03950000
039600                      SET CALENDAR-AGREEMENT TO TRUE              03960000
039700                      PERFORM C100-CREATE-ADJUSTMENT-DETAIL       03970000
039800                  END-IF                                          03980000
039900         END-EVALUATE                                             03990000
040000     END-IF.                                                      04000000
040100                                                                  04010000
040200     PERFORM R100-READ-VNDAGR-ACTVTY-FILE.                        04020000
040300                                                                  04030000
040400*---------------------------------------------------------------* 04040000
040500*  CLOSE FILES AND PERFORM FINAL DISPLAYS.                        04050000
040600*---------------------------------------------------------------* 04060000
040700 B300-END-OF-JOB.                                                 04070000
040800                                                                  04080000
040900     CLOSE VNDAGR-ACTVTY-FILE                                     04090000
041000           ADJUST-JRNL-FILE.                                      04100000
041100                                                                  04110000
041200     DISPLAY 'ACTIVITY RECORDS READ = ' INPUT-COUNT.              04120000
041300     DISPLAY 'ADJUSTMENT RECORDS WRITTEN = ' OUT-ADJUSTMENT-COUNT.04130000
041400                                                                  04140000
041500*----------------------------------------------------------------*04150000
041600*  FORMAT THE ADJUSTMENT DETAIL RECORD FROM THE DATA ON THE INPUT*04160000
041700*  RECORD TO CREATE THE VENDOR DEDUCTION.  MANY FIELDS ARE       *04170000
041800*  LOADED FROM TTRNCDE TABLE VALUES, SO THE TRANCODE TABLE IS    *04180000
041900*  SEARCHED FOR THE VENDOR DEDUCT TRANCODE THAT GOES WITH THE    *04190000
042000*  INPUT TRANCODE BEING PROCESSED.                               *04200000
042100*----------------------------------------------------------------*04210000
042200 C100-CREATE-ADJUSTMENT-DETAIL.                                   04220000
042300                                                                  04230000
042400     INITIALIZE AP045-KEY-FIELDS                                  04240000
042500                AP045-COMMON-FIELDS                               04250000
042600                AP045-DETAIL-FIELDS.                              04260000
042700                                                                  04270000
042800     IF AP081-VENDOR-NBR = SAVE-VENDOR-NBR                        04280000
042900     AND AP081-DEPT-NBR = SAVE-DEPT-NBR                           04290000
043000     AND AP081-AGR-AP-TRN-CDE = SAVE-AP-TRN-CDE                   04300000
043100         CONTINUE                                                 04310000
043200     ELSE                                                         04320000
043300         MOVE AP081-VENDOR-NBR TO SAVE-VENDOR-NBR                 04330000
043400         MOVE AP081-DEPT-NBR   TO SAVE-DEPT-NBR                   04340000
043500         PERFORM S100-GET-NEXT-DOC-NBR                            04350000
043600     END-IF.                                                      04360000
043700                                                                  04370000
043800     IF AP081-AGR-AP-TRN-CDE = SAVE-AP-TRN-CDE                    04380000
043900        CONTINUE                                                  04390000
044000     ELSE                                                         04400000
044100         MOVE AP081-AGR-AP-TRN-CDE TO SAVE-AP-TRN-CDE             04410000
044200                                      MATCH-AP-TRN-CDE            04420000
044300         PERFORM D100-FIND-TRANCODE-ENTRY                         04430000
044400         MOVE TBL-ADJUST-TRN-CDE(TRN-INDEX)                       04440000
044500                                     TO WS-VND-DEDUCT-TRN-CDE     04450000
044600     END-IF.                                                      04460000
044700                                                                  04470000
044800     MOVE WS-VND-DEDUCT-TRN-CDE TO MATCH-AP-TRN-CDE.              04480000
044900     PERFORM D100-FIND-TRANCODE-ENTRY.                            04490000
045000                                                                  04500000
045100     MOVE AP081-VENDOR-NBR              TO AP045-VND-NBR.         04510000
045200     MOVE WS151-NEXT-DOC-NBR            TO AP045-DOC-NBR.         04520000
045300     MOVE APCNTL-BTCH-PRC-DTE           TO AP045-DOC-DTE          04530000
045400                                           AP045-ENTR-DTE.        04540000
045500     MOVE WS-VND-DEDUCT-TRN-CDE         TO AP045-AP-TRN-CDE.      04550000
045600     SET AP045-DETAIL-RECORD            TO TRUE.                  04560000
045700                                                                  04570000
045800     MOVE TBL-TRN-TYP-CDE(TRN-INDEX)    TO AP045-TRN-TYP-CDE.     04580000
045900     MOVE TBL-PSTG-TYP-CDE(TRN-INDEX)   TO AP045-PSTG-TYP-CDE.    04590000
046000                                                                  04600000
046100     MOVE PV-CURR-TMST                  TO AP045-ENTR-TMST.       04610000
046200     MOVE PC-PROGRAM-NAME               TO AP045-ENTR-ID.         04620000
046300     SET  AP045-ORGN-ADJUST             TO TRUE.                  04630000
046400     MOVE APCNTL-BTCH-PRC-DTE           TO AP045-INV-CUTOFF-DTE   04640000
046500                                           AP045-PS-BTCH-DTE.     04650000
046600     MOVE 'ADJ'                         TO AP045-PS-BTCH-SRC-CDE. 04660000
046700     MOVE '00'                          TO AP045-PS-BTCH-SEQ-NBR. 04670000
046800                                                                  04680000
046900     MOVE AP081-ENT-ID                  TO AP045-ENT-ID.          04690000
047000     MOVE AP081-VENDOR-NAME             TO AP045-ENT-NME-DESC.    04700000
047100                                                                  04710000
047200     IF  APCNTL-MULT-PSTG-PER-IND = 'Y'                           04720000
047300         MOVE APCNTL-PREV-PSTG-FYR-NBR  TO AP045-PSTG-FYR-NBR     04730000
047400         MOVE APCNTL-PREV-PSTG-FMN-NBR  TO AP045-PSTG-FMN-NBR     04740000
047500         MOVE APCNTL-PREV-PSTG-FWK-NBR  TO AP045-PSTG-FWK-NBR     04750000
047600     ELSE                                                         04760000
047700         MOVE APCNTL-CURR-PSTG-FYR-NBR  TO AP045-PSTG-FYR-NBR     04770000
047800         MOVE APCNTL-CURR-PSTG-FMN-NBR  TO AP045-PSTG-FMN-NBR     04780000
047900         MOVE APCNTL-CURR-PSTG-FWK-NBR  TO AP045-PSTG-FWK-NBR     04790000
048000     END-IF.                                                      04800000
048100                                                                  04810000
048200     IF AP045-MERCHANDISE                                         04820000
048300        MOVE 85                         TO AP045-STR-NBR          04830000
048400        MOVE AP081-DEPT-NBR             TO AP045-DEPT-NBR         04840000
048500        MOVE AP081-EST-EARNED-AMT       TO PV-DISTRO-AMT          04850000
048600        PERFORM D300-SUBCLASS-DISTRO                              04860000
048700     ELSE                                                         04870000
048800        MOVE 90                         TO AP045-STR-NBR          04880000
048900        MOVE TBL-GL-ACCT-NBR(TRN-INDEX) TO AP045-GL-ACCT-NBR      04890000
049000        MOVE AP081-EST-EARNED-AMT       TO AP045-GRO-COST-AMT     04900000
049100        IF AP045-CREDIT                                           04910000
049200           COMPUTE AP045-GRO-COST-AMT = AP045-GRO-COST-AMT * -1   04920000
049300        END-IF                                                    04930000
049400        MOVE AP045-GRO-COST-AMT         TO AP045-NET-COST-AMT     04940000
049500        PERFORM W200-WRITE-OUTPUT-JRNL-REC                        04950000
049600     END-IF.                                                      04960000
049700                                                                  04970000
049800*----------------------------------------------------------------*04980000
049900*  SEARCHES TRANCODE TABLE FOR THE TRANCODE BEING PROCESSED.     *04990000
050000*----------------------------------------------------------------*05000000
050100 D100-FIND-TRANCODE-ENTRY.                                        05010000
050200                                                                  05020000
050300     IF  MATCH-AP-TRN-CDE = SPACES                                05030000
050400         MOVE 'D100-FIND-TRANCODE-ENTRY' TO WS-ABEND-PARAGRAPH    05040000
050500         SET AP-TABLE-NOTFND TO TRUE                              05050000
050600         DISPLAY 'AP-TRN-CDE = ' AP081-AGR-AP-TRN-CDE             05060000
050700         MOVE 'NO OFFSET OR VENDOR DEDUCT TRNCODE AVAILABLE'      05070000
050800                                                  TO WS-MESSAGE-1 05080000
050900         PERFORM Z998-ABEND                                       05090000
051000     END-IF.                                                      05100000
051100                                                                  05110000
051200     PERFORM VARYING TRN-INDEX FROM 1 BY 1                        05120000
051300       UNTIL TBL-AP-TRN-CDE(TRN-INDEX) = MATCH-AP-TRN-CDE         05130000
051400          OR TRN-INDEX > 25                                       05140000
051500     END-PERFORM.                                                 05150000
051600                                                                  05160000
051700     IF  TRN-INDEX > 25                                           05170000
051800         MOVE 'D100-FIND-TRANCODE-ENTRY' TO WS-ABEND-PARAGRAPH    05180000
051900         SET AP-TABLE-NOTFND TO TRUE                              05190000
052000         DISPLAY 'AP-TRN-CDE = ' MATCH-AP-TRN-CDE                 05200000
052100         MOVE 'TRANCODE TABLE ENTRY NOT FOUND' TO WS-MESSAGE-1    05210000
052200         PERFORM Z998-ABEND                                       05220000
052300     END-IF.                                                      05230000
052400*----------------------------------------------------------------*05240000
052500*  OPENS THE TRANCODE CURSOR AND FETCHES UNTIL END, LOADING EACH *05250000
052600*  ENTRY INTO THE TRANCODE TABLE IN WORKING STORAGE.             *05260000
052700*----------------------------------------------------------------*05270000
052800 D200-LOAD-TRANCODES.                                             05280000
052900                                                                  05290000
053000     PERFORM X100-OPEN-TRANCODE-CSR.                              05300000
053100                                                                  05310000
053200     SET TRN-INDEX TO 1.                                          05320000
053300     PERFORM S300-FETCH-TRANCODE-CSR.                             05330000
053400                                                                  05340000
053500     PERFORM UNTIL END-OF-TRANCODES OR TRN-INDEX > 15             05350000
053600        MOVE TRNCDE-AP-TRN-CDE   TO TBL-AP-TRN-CDE(TRN-INDEX)     05360000
053700        MOVE TRNCDE-PSTG-TYP-CDE TO TBL-PSTG-TYP-CDE(TRN-INDEX)   05370000
053800        MOVE TRNCDE-TRN-TYP-CDE  TO TBL-TRN-TYP-CDE(TRN-INDEX)    05380000
053900        MOVE TRNCDE-AUTO-OFFST-TRN-CDE                            05390000
054000                              TO TBL-AUTO-OFFST-TRN-CDE(TRN-INDEX)05400000
054100        MOVE TRNCDE-GL-ACCT-NBR  TO TBL-GL-ACCT-NBR(TRN-INDEX)    05410000
054200        IF TRNCDE-AP-TRN-CDE = '88'                               05420000
054300           MOVE '50'         TO TBL-ADJUST-TRN-CDE(TRN-INDEX)     05430000
054400        END-IF                                                    05440000
054500        IF TRNCDE-AP-TRN-CDE = '89'                               05450000
054600           MOVE '94'         TO TBL-ADJUST-TRN-CDE(TRN-INDEX)     05460000
054700        END-IF                                                    05470000
054800        SET TRN-INDEX UP BY 1                                     05480000
054900        PERFORM S300-FETCH-TRANCODE-CSR                           05490000
055000     END-PERFORM.                                                 05500000
055100                                                                  05510000
055200     PERFORM X200-CLOSE-TRANCODE-CSR.                             05520000
055300                                                                  05530000
055400     IF  TRN-INDEX > 15                                           05540000
055500     AND NOT END-OF-TRANCODES                                     05550000
055600         MOVE 'D200-LOAD-TRANCODES' TO WS-ABEND-PARAGRAPH         05560000
055700         SET AP-TABLE-FULL TO TRUE                                05570000
055800         MOVE 'MAX NUMBER OF ENTRIES EXCEEDED ON TRANCODE TABLE'  05580000
055900                                    TO WS-MESSAGE-1               05590000
056000         MOVE 'QUERY TTRNCDE FOR BTCH SRC = VDA AND EXPAND LIMIT' 05600000
056100                                    TO WS-MESSAGE-2               05610000
056200         PERFORM Z998-ABEND                                       05620000
056300     END-IF.                                                      05630000
056400                                                                  05640000
056500*----------------------------------------------------------------*05650000
056600*  DETERMINES WHICH SUBCLASS CURSOR TO USE - CALENDAR OR FISCAL  *05660000
056700*  OPENS THE APPROPRIATE CURSOR AND PROCESSES A DETAIL RECORD    *05670000
056800*  WITH THE AMOUNT BEING THE PERCENT OF AP081-EST-EARNED-AMT     *05680000
056900*  BASED ON THE SUBCLASS PERCENT TO TOTAL FOR THE QUARTER.       *05690000
057000*----------------------------------------------------------------*05700000
057100 D300-SUBCLASS-DISTRO.                                            05710000
057200                                                                  05720000
057300     MOVE AP081-ENT-ID        TO VADPT-ENT-ID                     05730000
W28582                                 MLV00000-ENT-ID.                 05740000
W28582***                              MLT00004-ENT-ID.                 05741000
057500     MOVE AP081-DEPT-NBR      TO PV-NUM-DEPT                      05750000
057600                                 VADPT-DEPT-NBR.                  05760000
057700     MOVE PV-NUM-DEPT         TO MLT00004-DEPT-NBR.               05770000
057800                                                                  05780000
057900     IF  FISCAL-AGREEMENT                                         05790000
058000         MOVE PV-MIN-FSCL-DTE TO PV-SQL-MIN-DTE                   05800000
058100         MOVE PV-MAX-FSCL-DTE TO PV-SQL-MAX-DTE                   05810000
058200     ELSE                                                         05820000
058300         MOVE PV-MIN-CAL-DTE TO PV-SQL-MIN-DTE                    05830000
058400         MOVE PV-MAX-CAL-DTE TO PV-SQL-MAX-DTE                    05840000
058500     END-IF.                                                      05850000
058600                                                                  05860000
058700     PERFORM S200-SELECT-DEPT-TOTAL.                              05870000
058800                                                                  05880000
058900     INITIALIZE PS-SUBCLASS-CSR-SW.                               05890000
059000     PERFORM X300-OPEN-SUBCLASS-CSR.                              05900000
059100                                                                  05910000
059200     PERFORM UNTIL END-OF-SUBCLASS                                05920000
059300        OR PV-DISTRO-AMT = ZERO                                   05930000
059400           PERFORM S600-FETCH-SUBCLASS-CSR                        05940000
059500           COMPUTE PV-SCL-PERCENT =                               05950000
059600                   PV-SCL-RCPT-AMT / PV-DPT-RCPT-AMT              05960000
059700           COMPUTE PV-SCL-DISTRO-AMT =                            05970000
059800                   AP081-EST-EARNED-AMT * PV-SCL-PERCENT          05980000
059900           IF PV-SCL-DISTRO-AMT < PV-DISTRO-AMT                   05990000
060000              MOVE PV-SCL-DISTRO-AMT TO AP045-GRO-COST-AMT        06000000
060100              SUBTRACT PV-SCL-DISTRO-AMT FROM PV-DISTRO-AMT       06010000
060200           ELSE                                                   06020000
060300              MOVE PV-DISTRO-AMT TO AP045-GRO-COST-AMT            06030000
060400              MOVE ZERO TO PV-DISTRO-AMT                          06040000
060500           END-IF                                                 06050000
060600           IF AP045-CREDIT                                        06060000
060700              COMPUTE AP045-GRO-COST-AMT = AP045-GRO-COST-AMT * -106070000
060800           END-IF                                                 06080000
060900           MOVE AP045-GRO-COST-AMT         TO AP045-NET-COST-AMT  06090000
061000           MOVE MLT00004-SUB-CL-NBR        TO PV-NUM-SCL          06100000
061100           MOVE PV-NUM-SCL                 TO AP045-CL-NBR        06110000
061101           MOVE PV-SCL-RCPT-AMT TO DISPLAY-AMOUNT                 06110100
061110           DISPLAY 'SCL TOTAL FOR ' AP081-VENDOR-NAME '  '        06111000
061120                   AP045-CL-NBR '  = ' DISPLAY-AMOUNT             06112000
061121           MOVE PV-SCL-PERCENT TO DISPLAY-PERCENT                 06112100
061130           DISPLAY 'PERCENT = ' DISPLAY-PERCENT                   06113000
061200           PERFORM W200-WRITE-OUTPUT-JRNL-REC                     06120000
061300     END-PERFORM.                                                 06130000
061400                                                                  06140000
061500     IF  PV-DISTRO-AMT > ZERO                                     06150000
061600     AND NOT END-OF-SUBCLASS                                      06160000
061700         DISPLAY 'AMOUNT UNDISTRIBUTED FOR VENDOR = '             06170000
061800                  AP081-VENDOR-NAME ' DEPT = ' AP081-DEPT-NBR     06180000
061900                  ' AMOUNT = ' PV-DISTRO-AMT                      06190000
062000         MOVE PV-DISTRO-AMT TO AP045-GRO-COST-AMT                 06200000
062100         MOVE ZERO          TO PV-DISTRO-AMT                      06210000
062200         IF AP045-CREDIT                                          06220000
062300            COMPUTE AP045-GRO-COST-AMT = AP045-GRO-COST-AMT * -1  06230000
062400         END-IF                                                   06240000
062500         MOVE AP045-GRO-COST-AMT         TO AP045-NET-COST-AMT    06250000
062600         MOVE MLT00004-SUB-CL-NBR        TO PV-NUM-SCL            06260000
062700         MOVE PV-NUM-SCL                 TO AP045-CL-NBR          06270000
062800         PERFORM W200-WRITE-OUTPUT-JRNL-REC                       06280000
062900     END-IF.                                                      06290000
063000                                                                  06300000
063100     PERFORM X400-CLOSE-SUBCLASS-CSR.                             06310000
063200     EJECT                                                        06320000
063300*----------------------------------------------------------------*06330000
063400*  R100-READ-VNDAGR-ACTVTY-FILE                                  *06340000
063500*  READS THE INPUT FILE INTO THE APRD081 COPYBOOK.               *06350000
063600*----------------------------------------------------------------*06360000
063700                                                                  06370000
063800 R100-READ-VNDAGR-ACTVTY-FILE.                                    06380000
063900                                                                  06390000
064000     READ VNDAGR-ACTVTY-FILE INTO AP081-VNDAGR-EXTRACT            06400000
064100         AT END                                                   06410000
064200            SET ACTVTY-EOF TO TRUE.                               06420000
064300                                                                  06430000
064400     IF NOT ACTVTY-EOF                                            06440000
064500        ADD 1 TO INPUT-COUNT                                      06450000
064600     END-IF.                                                      06460000
064700                                                                  06470000
064800                                                                  06480000
064900*----------------------------------------------------------------*06490000
065000*  S100-GET-NEXT-DOC-NBR                                         *06500000
065100*  SELECT THE NEXT AVAILABLE DOC NUMBER FROM THE TAPCNTL TABLE.  *06510000
065200*----------------------------------------------------------------*06520000
065300                                                                  06530000
065400 S100-GET-NEXT-DOC-NBR.                                           06540000
065500                                                                  06550000
065600     CALL DP951-AJ-NEXT-DOC-NBR-ROUTINE                           06560003
065600                     USING WS151-DOC-NBR-PARAMETERS.              06561002
065700                                                                  06570000
065800     IF WS151-ERRORS-FOUND                                        06580000
065900        SET AC-BAD-DATA TO TRUE                                   06590000
066000        MOVE 'S100-GET-NEXT-DOC-NBR     '                         06600000
066100                                   TO WS-ABEND-PARAGRAPH          06610000
066200        MOVE WS151-ERROR-MESSAGE   TO WS-MESSAGE-1                06620000
066300        MOVE WS151-SQLCODE         TO WS-MESSAGE-2                06630000
066400        PERFORM Z998-ABEND                                        06640000
066500     END-IF.                                                      06650000
066600                                                                  06660000
066700                                                                  06670000
066800*----------------------------------------------------------------*06680000
066900* THIS SELECT WILL RETURN THE TOTAL RECEIPT AMOUNT FOR THE       *06690000
067000* VENDOR/DEPT BEING PROCESSED.  THIS AMOUNT WILL BE THE TOTAL    *06700000
067100* USED IN THE PERCENT TO TOTAL CALCULATION WITH THE SUBCLASS AMT.*06710000
067200*----------------------------------------------------------------*06720000
067300 S200-SELECT-DEPT-TOTAL.                                          06730000
067400                                                                  06740000
067500     EXEC SQL                                                     06750000
067600         SELECT SUM(RCPT_GRO_COST_AMT)                            06760000
067700           INTO :PV-DPT-RCPT-AMT                                  06770000
067800           FROM TVADPT                                            06780000
067900          WHERE ENT_ID          = :VADPT-ENT-ID                   06790000
068000            AND DEPT_NBR        = :VADPT-DEPT-NBR                 06800000
068100            AND FSCL_MN_END_DTE BETWEEN :PV-SQL-MIN-DTE           06810000
068200                                    AND :PV-SQL-MAX-DTE           06820000
068300     END-EXEC.                                                    06830000
068400                                                                  06840000
068500     EVALUATE TRUE                                                06850000
068600         WHEN SQLCODE = ZERO                                      06860000
068601             MOVE PV-DPT-RCPT-AMT TO DISPLAY-AMOUNT               06860100
068610             DISPLAY 'DEPT TOTAL FOR ' AP081-VENDOR-NAME '  '     06861000
068620                      AP081-DEPT-NBR ' = ' DISPLAY-AMOUNT         06862000
068700             CONTINUE                                             06870000
068800         WHEN SQLWARN0 NOT = SPACES                               06880000
068900         WHEN SQLCODE  NOT = ZERO                                 06890000
069000             DISPLAY 'ENT ID BEING PROCESSED = ' AP081-ENT-ID     06900000
069100                     '   DEPT-NBR = ' AP081-DEPT-NBR              06910000
069200             MOVE 'S200-SELECT-DEPT-TOTAL'                        06920000
069300                                 TO WS-ABEND-PARAGRAPH            06930000
069400             MOVE 'UNSUCCESSFUL SELECT OF DEPT TOTAL '            06940000
069500                                 TO WS-ABEND-OPERATION            06950000
069600             MOVE 'TVADPT '      TO WS-ABEND-STRUCTURE-1          06960000
069700             PERFORM Z999-SQL-ERROR                               06970000
069800     END-EVALUATE.                                                06980000
069900                                                                  06990000
070000*----------------------------------------------------------------*07000000
070100*  S300-FETCH-TRANCODE-CSR                                       *07010000
070200*----------------------------------------------------------------*07020000
070300 S300-FETCH-TRANCODE-CSR.                                         07030000
070400                                                                  07040000
070500     EXEC SQL                                                     07050000
070600          FETCH TRANCODE_CSR                                      07060000
070700           INTO :TRNCDE-AP-TRN-CDE                                07070000
070800              , :TRNCDE-PSTG-TYP-CDE                              07080000
070900              , :TRNCDE-TRN-TYP-CDE                               07090000
071000              , :TRNCDE-AUTO-OFFST-TRN-CDE                        07100000
071100              , :TRNCDE-GL-ACCT-NBR                               07110000
071200     END-EXEC.                                                    07120000
071300                                                                  07130000
071400     EVALUATE TRUE                                                07140000
071500         WHEN SQLCODE = +0                                        07150000
071600              CONTINUE                                            07160000
071700         WHEN SQLCODE = +100                                      07170000
071800              SET END-OF-TRANCODES TO TRUE                        07180000
071900                                                                  07190000
072000         WHEN SQLWARN0 NOT = SPACES                               07200000
072100         WHEN SQLCODE < +0                                        07210000
072200         WHEN SQLCODE > +0                                        07220000
072300              MOVE 'S300-FETCH-TRANCODE-CSR'                      07230000
072400                                TO WS-ABEND-PARAGRAPH             07240000
072500              MOVE 'UNSUCCESSFUL FETCH ON TRANCODE CSR'           07250000
072600                                TO WS-ABEND-OPERATION             07260000
072700              MOVE 'TTRNCDE '   TO WS-ABEND-STRUCTURE-1           07270000
072800              MOVE SPACES       TO WS-ABEND-STRUCTURE-2           07280000
072900              PERFORM Z999-SQL-ERROR                              07290000
073000     END-EVALUATE.                                                07300000
073100                                                                  07310000
073200*----------------------------------------------------------------*07320000
073300*  SELECT BATCH PROCESS DATE, PREVIOUS  POSTING FISCAL YEAR,     *07330000
073400*  PREVIOUS  POSTING FISCAL MONTH, AND PREVIOUS  POSTING FISCAL  *07340000
073500*  WEEK FROM THE TAPCNTL TABLE.  THE WHERE CONDITION STATING     *07350000
073600*  MULT-PSTG-PER-IND = 'Y' ENSURES THAT THIS PROGRAM WILL ONLY   *07360000
073700*  BE RUN DURING MERCHANDISE CLOSE WEEK.                         *07370000
073800*----------------------------------------------------------------*07380000
073900 S400-SELECT-DATES.                                               07390000
074000                                                                  07400000
074100     EXEC SQL                                                     07410000
074200          SELECT A.BTCH_PRC_DTE                                   07420000
074300               , A.CURR_PSTG_FYR_NBR                              07430000
074400               , A.CURR_PSTG_FMN_NBR                              07440000
074500               , A.CURR_PSTG_FWK_NBR                              07450000
074600               , A.PREV_PSTG_FYR_NBR                              07460000
074700               , A.PREV_PSTG_FMN_NBR                              07470000
074800               , A.PREV_PSTG_FWK_NBR                              07480000
074900               , A.MULT_PSTG_PER_IND                              07490000
075000               , B.FSCL_MN_NBR                                    07500000
075100               , B.FSCL_YR_NBR                                    07510000
075200               , B.FSCL_QTR_NBR                                   07520000
075300            INTO :APCNTL-BTCH-PRC-DTE                             07530000
075400               , :APCNTL-CURR-PSTG-FYR-NBR                        07540000
075500               , :APCNTL-CURR-PSTG-FMN-NBR                        07550000
075600               , :APCNTL-CURR-PSTG-FWK-NBR                        07560000
075700               , :APCNTL-PREV-PSTG-FYR-NBR                        07570000
075800               , :APCNTL-PREV-PSTG-FMN-NBR                        07580000
075900               , :APCNTL-PREV-PSTG-FWK-NBR                        07590000
076000               , :APCNTL-MULT-PSTG-PER-IND                        07600000
076100               , :DTATTR-FSCL-MN-NBR                              07610000
076200               , :DTATTR-FSCL-YR-NBR                              07620000
076300               , :DTATTR-FSCL-QTR-NBR                             07630000
076400******      FROM TKMA244.TAPCNTL A                                07640000
076500            FROM TAPCNTL A                                        07650000
076600               , TDTATTR B                                        07660000
076700           WHERE A.PREV_WK_END_DTE = B.KY_DTE                     07670000
076800     END-EXEC.                                                    07680000
076900                                                                  07690000
077000     EVALUATE TRUE                                                07700000
077100         WHEN SQLCODE = +0                                        07710000
077200              EVALUATE TRUE                                       07720000
077300                 WHEN DTATTR-FSCL-MN-NBR = '03'                   07730000
077400                 WHEN DTATTR-FSCL-MN-NBR = '06'                   07740000
077500                 WHEN DTATTR-FSCL-MN-NBR = '09'                   07750000
077600                 WHEN DTATTR-FSCL-MN-NBR = '12'                   07760000
077700                      SET END-OF-FISCAL-QTR       TO TRUE         07770000
077800                 WHEN OTHER                                       07780000
077900                    MOVE 'S400-SELECT-DATES' TO WS-ABEND-PARAGRAPH07790000
078000                    MOVE 'NOT PROCESSING END OF QUARTER'          07800000
078100                                             TO WS-MESSAGE-LINE-1 07810000
078200                    SET AC-BAD-DATA TO TRUE                       07820000
078300                    PERFORM Z998-ABEND                            07830000
078400              END-EVALUATE                                        07840000
078500         WHEN SQLWARN0 NOT = SPACES                               07850000
078600         WHEN SQLCODE < +0                                        07860000
078700         WHEN SQLCODE > +0                                        07870000
078800              MOVE 'S400-SELECT-DATES' TO WS-ABEND-PARAGRAPH      07880000
078900              MOVE 'UNSUCCESSFUL SELECT DATES'                    07890000
079000                                       TO WS-ABEND-OPERATION      07900000
079100              MOVE 'TAPCNTL '          TO WS-ABEND-STRUCTURE-1    07910000
079200              MOVE 'TDTATTR '          TO WS-ABEND-STRUCTURE-2    07920000
079300              PERFORM Z999-SQL-ERROR                              07930000
079400     END-EVALUATE.                                                07940000
079500                                                                  07950000
079600     EXEC SQL                                                     07960000
079700          SELECT MIN(FSCL_MN_NBR)                                 07970000
079800               , MAX(FSCL_MN_NBR)                                 07980000
079900            INTO :PV-MIN-MN-NBR                                   07990000
080000               , :PV-MAX-MN-NBR                                   08000000
080100            FROM TDTATTR                                          08010000
080200           WHERE FSCL_QTR_NBR = :DTATTR-FSCL-QTR-NBR              08020000
080300     END-EXEC.                                                    08030000
080400                                                                  08040000
080500     EVALUATE TRUE                                                08050000
080600         WHEN SQLCODE = +0                                        08060000
080700              CONTINUE                                            08070000
080800         WHEN SQLWARN0 NOT = SPACES                               08080000
080900         WHEN SQLCODE < +0                                        08090000
081000         WHEN SQLCODE > +0                                        08100000
081100              MOVE 'S400-SELECT-DATES' TO WS-ABEND-PARAGRAPH      08110000
081200              MOVE 'SELECTING MONTH NUMBERS'                      08120000
081300                                       TO WS-ABEND-OPERATION      08130000
081400              MOVE 'TDTATTR '          TO WS-ABEND-STRUCTURE-1    08140000
081500              MOVE SPACE               TO WS-ABEND-STRUCTURE-2    08150000
081600              PERFORM Z999-SQL-ERROR                              08160000
081700     END-EVALUATE.                                                08170000
081800                                                                  08180000
081900     EXEC SQL                                                     08190000
082000          SELECT MIN(FSCL_MN_END_DTE)                             08200000
082100               , MAX(FSCL_MN_END_DTE)                             08210000
082200            INTO :PV-MIN-FSCL-DTE                                 08220000
082300               , :PV-MAX-FSCL-DTE                                 08230000
082400            FROM TDTATTR                                          08240000
082500           WHERE FSCL_YR_NBR = :DTATTR-FSCL-YR-NBR                08250000
082600             AND FSCL_MN_NBR BETWEEN :PV-MIN-MN-NBR               08260000
082700                                 AND :PV-MAX-MN-NBR               08270000
082800     END-EXEC.                                                    08280000
082900                                                                  08290000
083000     EVALUATE TRUE                                                08300000
083100         WHEN SQLCODE = +0                                        08310000
083200              CONTINUE                                            08320000
083300         WHEN SQLWARN0 NOT = SPACES                               08330000
083400         WHEN SQLCODE < +0                                        08340000
083500         WHEN SQLCODE > +0                                        08350000
083600              MOVE 'S400-SELECT-DATES' TO WS-ABEND-PARAGRAPH      08360000
083700              MOVE 'SELECTING FISCAL DATES'                       08370000
083800                                       TO WS-ABEND-OPERATION      08380000
083900              MOVE 'TDTATTR '          TO WS-ABEND-STRUCTURE-1    08390000
084000              MOVE SPACE               TO WS-ABEND-STRUCTURE-2    08400000
084100              PERFORM Z999-SQL-ERROR                              08410000
084200     END-EVALUATE.                                                08420000
084300                                                                  08430000
084400     EXEC SQL                                                     08440000
084500          SELECT MIN(FSCL_MN_END_DTE)                             08450000
084600               , MAX(FSCL_MN_END_DTE)                             08460000
084700            INTO :PV-MIN-CAL-DTE                                  08470000
084800               , :PV-MAX-CAL-DTE                                  08480000
084900            FROM TDTATTR                                          08490000
085000           WHERE (CAL_MN_NBR   = :PV-MIN-MN-NBR                   08500000
085001        AND YEAR(FSCL_MN_END_DTE) = SMALLINT(:DTATTR-FSCL-YR-NBR))08500100
085010              OR (CAL_MN_NBR      > :PV-MIN-MN-NBR                08501000
085100                  AND CAL_MN_NBR  <= :PV-MAX-MN-NBR               08510000
085200                  AND FSCL_YR_NBR = :DTATTR-FSCL-YR-NBR)          08520000
085400     END-EXEC.                                                    08540000
085500                                                                  08550000
085600     EVALUATE TRUE                                                08560000
085700         WHEN SQLCODE = +0                                        08570000
085800              CONTINUE                                            08580000
085900         WHEN SQLWARN0 NOT = SPACES                               08590000
086000         WHEN SQLCODE < +0                                        08600000
086100         WHEN SQLCODE > +0                                        08610000
086200              MOVE 'S400-SELECT-DATES' TO WS-ABEND-PARAGRAPH      08620000
086300              MOVE 'SELECTING CALENDAR DATES'                     08630000
086400                                       TO WS-ABEND-OPERATION      08640000
086500              MOVE 'TDTATTR '          TO WS-ABEND-STRUCTURE-1    08650000
086600              MOVE SPACE               TO WS-ABEND-STRUCTURE-2    08660000
086700              PERFORM Z999-SQL-ERROR                              08670000
086800     END-EVALUATE.                                                08680000
086900                                                                  08690000
087000                                                                  08700000
087100*----------------------------------------------------------------*08710000
087200*  S500-SET-CURENT-TMST  GETS THE CURRENT TIMESTAMP FROM DB2.    *08720000
087300*----------------------------------------------------------------*08730000
087400                                                                  08740000
087500 S500-SET-CURRENT-TMST.                                           08750000
087600                                                                  08760000
087700                                                                  08770000
087800     EXEC SQL                                                     08780000
087900          SET :PV-CURR-TMST = CURRENT TIMESTAMP                   08790000
088000     END-EXEC.                                                    08800000
088100                                                                  08810000
088200     EVALUATE TRUE                                                08820000
088300         WHEN SQLCODE = +0                                        08830000
088400              CONTINUE                                            08840000
088500         WHEN SQLWARN0 NOT = SPACES                               08850000
088600         WHEN SQLCODE < +0                                        08860000
088700         WHEN SQLCODE > +0                                        08870000
088800              MOVE 'S500-SET-CURRENT-TMST' TO WS-ABEND-PARAGRAPH  08880000
088900              MOVE 'UNSUCCESSFUL SET TMST' TO WS-ABEND-OPERATION  08890000
089000              MOVE SPACES TO WS-ABEND-STRUCTURE-1                 08900000
089100                             WS-ABEND-STRUCTURE-2                 08910000
089200              PERFORM Z999-SQL-ERROR                              08920000
089300     END-EVALUATE.                                                08930000
089400                                                                  08940000
089500*----------------------------------------------------------------*08950000
089600*  S600-FETCH-SUBCLASS-CSR                                       *08960000
089700*----------------------------------------------------------------*08970000
089800 S600-FETCH-SUBCLASS-CSR.                                         08980000
089900                                                                  08990000
090000     EXEC SQL                                                     09000000
090100          FETCH SUBCLASS_CSR                                      09010000
090200           INTO :MLT00004-SUB-CL-NBR                              09020000
090300              , :PV-SCL-RCPT-AMT                                  09030000
090400     END-EXEC.                                                    09040000
090500                                                                  09050000
090600     EVALUATE TRUE                                                09060000
090700         WHEN SQLCODE = +0                                        09070000
090800              CONTINUE                                            09080000
090900         WHEN SQLCODE = +100                                      09090000
091000              SET END-OF-SUBCLASS TO TRUE                         09100000
091100                                                                  09110000
091200         WHEN SQLWARN0 NOT = SPACES                               09120000
091300         WHEN SQLCODE < +0                                        09130000
091400         WHEN SQLCODE > +0                                        09140000
091500              MOVE 'S600-FETCH-SUBCLASS-CSR'                      09150000
091600                                TO WS-ABEND-PARAGRAPH             09160000
091700              MOVE 'UNSUCCESSFUL FETCH ON SUBCLASS CSR'           09170000
091800                                TO WS-ABEND-OPERATION             09180000
091900              MOVE 'MLT00003'   TO WS-ABEND-STRUCTURE-1           09190000
092000              MOVE 'MLT00004'   TO WS-ABEND-STRUCTURE-2           09200000
092100              PERFORM Z999-SQL-ERROR                              09210000
092200     END-EVALUATE.                                                09220000
092300                                                                  09230000
092400*----------------------------------------------------------------*09240000
092500*  W200-WRITE-OUTPUT-JRNL-REC                                    *09250000
092600*  WRITES TO THE JOURNALIZED OUTPUT FILE.                        *09260000
092700*----------------------------------------------------------------*09270000
092800                                                                  09280000
092900 W200-WRITE-OUTPUT-JRNL-REC.                                      09290000
093000                                                                  09300000
093100     WRITE ADJUST-JRNL-RECORD FROM AP045-TRANSACTION-FILE.        09310000
093200                                                                  09320000
093300     ADD 1 TO OUT-ADJUSTMENT-COUNT.                               09330000
093400                                                                  09340000
093500*----------------------------------------------------------------*09350000
093600*  OPEN TRANCODE CURSOR.                                         *09360000
093700*----------------------------------------------------------------*09370000
093800 X100-OPEN-TRANCODE-CSR.                                          09380000
093900                                                                  09390000
094000     EXEC SQL                                                     09400000
094100         OPEN TRANCODE_CSR                                        09410000
094200     END-EXEC.                                                    09420000
094300                                                                  09430000
094400     EVALUATE TRUE                                                09440000
094500         WHEN SQLCODE = ZERO                                      09450000
094600              CONTINUE                                            09460000
094700         WHEN SQLWARN0 NOT = SPACES                               09470000
094800         WHEN SQLCODE  NOT = ZERO                                 09480000
094900              MOVE 'X100-OPEN-TRANCODE-CSR' TO WS-ABEND-PARAGRAPH 09490000
095000              MOVE 'UNSUCCESSFUL OPEN ON TRANCODE_CSR'            09500000
095100                                       TO WS-ABEND-OPERATION      09510000
095200              MOVE 'TTRNCDE '          TO WS-ABEND-STRUCTURE-1    09520000
095300              MOVE SPACE               TO WS-ABEND-STRUCTURE-2    09530000
095400              PERFORM Z999-SQL-ERROR                              09540000
095500     END-EVALUATE.                                                09550000
095600                                                                  09560000
095700*----------------------------------------------------------------*09570000
095800*  CLOSE TRANCODE CURSOR.                                        *09580000
095900*----------------------------------------------------------------*09590000
096000 X200-CLOSE-TRANCODE-CSR.                                         09600000
096100                                                                  09610000
096200     EXEC SQL                                                     09620000
096300         CLOSE TRANCODE_CSR                                       09630000
096400     END-EXEC.                                                    09640000
096500                                                                  09650000
096600     EVALUATE TRUE                                                09660000
096700         WHEN SQLCODE = ZERO                                      09670000
096800              CONTINUE                                            09680000
096900         WHEN SQLWARN0 NOT = SPACES                               09690000
097000         WHEN SQLCODE  NOT = ZERO                                 09700000
097100              MOVE 'X200-CLOSE-TRANCODE-CSR' TO WS-ABEND-PARAGRAPH09710000
097200              MOVE 'UNSUCCESSFUL CLOSE ON TRANCODE_CSR'           09720000
097300                                       TO WS-ABEND-OPERATION      09730000
097400              MOVE 'TTRNCDE '          TO WS-ABEND-STRUCTURE-1    09740000
097500              MOVE SPACE               TO WS-ABEND-STRUCTURE-2    09750000
097600              PERFORM Z999-SQL-ERROR                              09760000
097700     END-EVALUATE.                                                09770000
097800                                                                  09780000
097900*----------------------------------------------------------------*09790000
098000*  OPEN SUBCLASS CURSOR.                                         *09800000
098100*----------------------------------------------------------------*09810000
098200 X300-OPEN-SUBCLASS-CSR.                                          09820000
098300                                                                  09830000
098400     EXEC SQL                                                     09840000
098500         OPEN SUBCLASS_CSR                                        09850000
098600     END-EXEC.                                                    09860000
098700                                                                  09870000
098800     EVALUATE TRUE                                                09880000
098900         WHEN SQLCODE = ZERO                                      09890000
099000              CONTINUE                                            09900000
099100         WHEN SQLWARN0 NOT = SPACES                               09910000
099200         WHEN SQLCODE  NOT = ZERO                                 09920000
099300              MOVE 'X300-OPEN-SUBCLASS-CSR' TO WS-ABEND-PARAGRAPH 09930000
099400              MOVE 'UNSUCCESSFUL OPEN ON SUBCLASS_CSR'            09940000
099500                                       TO WS-ABEND-OPERATION      09950000
099600              MOVE 'MLT00003'          TO WS-ABEND-STRUCTURE-1    09960000
099700              MOVE 'MLT00004'          TO WS-ABEND-STRUCTURE-2    09970000
099800              PERFORM Z999-SQL-ERROR                              09980000
099900     END-EVALUATE.                                                09990000
100000                                                                  10000000
100100*----------------------------------------------------------------*10010000
100200*  CLOSE SUBCLASS CURSOR.                                        *10020000
100300*----------------------------------------------------------------*10030000
100400 X400-CLOSE-SUBCLASS-CSR.                                         10040000
100500                                                                  10050000
100600     EXEC SQL                                                     10060000
100700         CLOSE SUBCLASS_CSR                                       10070000
100800     END-EXEC.                                                    10080000
100900                                                                  10090000
101000     EVALUATE TRUE                                                10100000
101100         WHEN SQLCODE = ZERO                                      10110000
101200              CONTINUE                                            10120000
101300         WHEN SQLWARN0 NOT = SPACES                               10130000
101400         WHEN SQLCODE  NOT = ZERO                                 10140000
101500              MOVE 'X400-CLOSE-SUBCLASS-CSR' TO WS-ABEND-PARAGRAPH10150000
101600              MOVE 'UNSUCCESSFUL CLOSE ON SUBCLASS_CSR'           10160000
101700                                       TO WS-ABEND-OPERATION      10170000
101800              MOVE 'MLT00003'          TO WS-ABEND-STRUCTURE-1    10180000
101900              MOVE 'MLT00004'          TO WS-ABEND-STRUCTURE-2    10190000
102000              PERFORM Z999-SQL-ERROR                              10200000
102100     END-EVALUATE.                                                10210000
102200                                                                  10220000
102300*----------------------------------------------------------------*10230000
102400*  GENERAL ABEND ROUTINE                                         *10240000
102500*----------------------------------------------------------------*10250000
102600 Z998-ABEND.                                                      10260000
102700                                                                  10270000
102800     DISPLAY WS-ABEND-LITERAL.                                    10280000
102900     DISPLAY WS-ABEND-PROGRAM-MSG.                                10290000
103000     DISPLAY WS-ABEND-PARAGRAPH-MSG.                              10300000
103100     DISPLAY WS-MESSAGE-LINE-1.                                   10310000
103200     DISPLAY WS-MESSAGE-LINE-2.                                   10320000
103300                                                                  10330000
103400     CALL 'ILBOABN0' USING ABEND-CODE.                            10340000
103500                                                                  10350000
103600*----------------------------------------------------------------*10360000
103700*  PROCESS DB2 ABENDS.                                           *10370000
103800*----------------------------------------------------------------*10380000
103900 Z999-SQL-ERROR.                                                  10390000
104000                                                                  10400000
104100     DISPLAY '*** DB2 ERROR '.                                    10410000
104200     DISPLAY WS-ABEND-PROGRAM-MSG.                                10420000
104300     DISPLAY WS-ABEND-PARAGRAPH-MSG.                              10430000
104400     DISPLAY WS-ABEND-OPERATION-MSG.                              10440000
104500     DISPLAY WS-ABEND-TABLE1-MSG.                                 10450000
104600     IF WS-ABEND-STRUCTURE-2 > SPACES                             10460000
104700         DISPLAY WS-ABEND-TABLE2-MSG.                             10470000
104800                                                                  10480000
104900     SET AP-DB2-ERROR              TO TRUE.                       10490000
105000                                                                  10500000
105100     COPY DPPD004.                                                10510000
105200     CALL 'ILBOABN0' USING ABEND-CODE.                            10520000
