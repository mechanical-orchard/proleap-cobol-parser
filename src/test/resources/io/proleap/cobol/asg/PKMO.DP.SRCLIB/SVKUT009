000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400                                                                  00040000
000500 PROGRAM-ID.             SVKUT009.                                00050000
000600 AUTHOR.                 GREG SHEFF.                              00060000
000700 INSTALLATION.           KOHLS.                                   00070000
000800 DATE-WRITTEN            JULY 2000.                               00080000
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100***************************************************************** 00110000
001200                                                                  00120000
001300*  KOHL'S CASH OFFICE SALES AUDIT (COSA) PROJECT.                 00130000
001400                                                                  00140000
001500***************************************************************** 00150000
001600                                                                  00160000
001700*  THIS PROGRAM CREATES A DAILY FILE OF SV TRANSACTIONS.  IT      00170000
001800*  REPLACES RDKUT007.  IT USES THE COSA DATABASE TABLES AS INPUT, 00180000
001900*  INSTEAD OF THE DAILY SALES FILE.                               00190000
002000*                                                                 00200000
002100*  TABLES TEPTRN AND TEPDKEY ARE USED TO EXTRACT ALL THE DATA FOR 00210000
002200*  THE DAY.  ISSUES OF GIFT CARDS ARE IN TABLE TEPITM WHERE       00220000
002300*  DEPT_NBR = '983'.  ISSUES AND TENDERS OF SV CARDS ARE IN       00230000
002400*  TABLE TEPTND WHERE TNDR_TYP_CDE = '02'.  TENDERS OF GIFT CARDS 00240000
002500*  ARE IN TABLE TEPTND WHERE TNDR_TYP_CDE = '13'.  TABLE TEPSVC   00250000
002600*  IS USED TO GET THE REQ_TYP_CDE (ISSUE, TENDER), AND TABLE      00260000
002700*  TEPPART IS USED TO GET THE PART_NBR.                           00270000
002800*                                                                 00280000
002900***************************************************************** 00290000
003000*                                                                 00300000
003100*   INPUT: INP01 - CONTAINS POS DATE, WHICH IS USED AS THE        00310000
003200*                  PROCESSING DATE FOR GENERATING THE FILE.       00320000
003300*                                                                 00330000
003400*  OUTPUT: OUT02 - MERCHANDISE RETURN CREDIT EXTRACT FILE.        00340000
003500*                                                                 00350000
003600***************************************************************** 00360000
003700*                                                                 00370000
003800*  THE PROGRAM READS A CONTROL CARD FILE TO GET THE POS DATE.     00380000
003900*                                                                 00390000
004000*  THIS DATE IS PASSED TO THE KOHLS CALENDAR ROUTINE.  THE DATE   00400000
004100*  IS VALIDATED AND RETURNED IN DB2 DATE FORMAT.  THE REFORMATTED 00410000
004200*  DATE (PROCESS DATE) IS USED TO SELECT THE ROW FROM DB2 TABLE   00420000
004300*  TEPPART, WHERE SLS_DTE IS EQUAL TO THE PROCESS DATE.           00430000
004400*                                                                 00440000
004500*  THE PARTN_NBR SELECTED IS USED IN CURSORS TO SELECT            00450000
004600*  TRANSACTIONAL DATA FROM DB2 TABLES.                            00460000
004700*                                                                 00470000
004800*  THE "MAIN PROCESS" CURSOR DRIVING THE CREATION OF THE DAILY    00480000
004900*  SALES FILE IS TEPTRN-CURSOR, WHICH SELECTS ROWS FROM TEPTRN.   00490000
005000*  THE TEPTRN DATA IS INTERROGATED TO DETERMINE WHAT OTHER TABLES 00500000
005100*  MUST BE READ TO COLLECT ALL THE TRANSACTION DATA.              00510000
005200*  THE INPUT OF ONE TEPTRN ROW MAY RESULT IN THE OUTPUT OF:       00520000
005300*   1. ONE OR MORE ITEM RECORDS.                                  00530000
005400*   2. ONE OR MORE TENDER RECORDS.                                00540000
005500*  AS THE CURSOR IS PROCESSED, THE FILE IS BUILT UNTIL THE END OF 00550000
005600*  CURSOR.                                                        00560000
005700*                                                                 00570000
005800*  A SECONDARY "MAIN PROCESS" CURSOR, TEPDKEY-CURSOR, IS USED     00580000
005900*  TO BUILD DAILY SALES RECORDS BASED ON TRANSACTION KEYS STORED  00590000
006000*  IN THE TEPDKEY TABLE. THE TEPDKEY-CURSOR IS A JOIN OF THE      00600000
006100*  TEPDKEY AND TEPTRN TABLES. AFTER TEPTRN-CURSOR PROCESSING HAS  00610000
006200*  COMPLETED, THE TEPDKEY-CURSOR IS OPENED TO SELECT ALL ROWS     00620000
006300*  FROM TEPDKEY THAT HAVE A VALID TEPTRN ROW. THE DATA SELECTED   00630000
006400*  IS PROCESSED THE SAME AS DESCRIBED ABOVE FOR THE TEPTRN-CURSOR.00640000
006500*                                                                 00650000
006600******************************************************************00660000
006700                                                                  00670000
006800*  THE DAILY P.O.S. SALES DATA THAT WAS SELECTED IS USED TO       00680000
006900*  CREATE A KOHL'S MERCHANDISE RETURN CREDIT EXTRACT FILE.        00690000
007000                                                                  00700000
007100*  ONE EXTRACT RECORD IS CREATED FOR EACH NORMAL TENDER OCCURANCE.00710000
007200*  VOIDED OR ABORTED (VOID AFTER OR VOID DURING) SITUATIONS WILL  00720000
007300*  RESULT IN TWO RECORDS BEING CREATED - ONE FOR THE ORIGINAL     00730000
007400*  TENDERING, AND ONE FOR THE VOID OF THAT TENDERING OCCURANCE.   00740000
007500*                                                                 00750000
007600*  AT THE END OF THE PROGRAM, A SYSOUT REPORT IS DISPLAYED        00760000
007700*  SHOWING THE PROCESSING TOTALS.                                 00770000
007800                                                                  00780000
007801*---------------------------------------------------------------* 00790000
007802*  11/17/2009  ADDED 'L' TO THE TEPTRN-CURSOR AND TEPITM-CURSOR * 00800000
007803*    CURSORS.  ALSO MOVED THE TEPTRN-TRN-STAT-CDE TO THE OUTPUT * 00810000
007804*    FILE - SVRD021.                                            * 00820000
007805*  MADE BY: BARB SCHULTZ                WR#: WR37510            * 00830000
007900***************************************************************** 00840000
007802*  11/14/2011  ADDED TEPORD TABLE AND MOVED THE ORD-NBR TO      * 00850000
007803*    SV021-ASSOC-ID.  ONLY ECOMM TRANSACTIONS WILL HAVE AN ORDER* 00860000
007804*    NUMBER.                                                    * 00870000
007805*  MADE BY: BARB SCHULTZ                     INC000001892813    * 00880000
007805*                                            PBI000000015839    * 00890000
CHG015***************************************************************** 00900000
CHG015*  02/20/2014  CHANGES TO RESET THE STORE NUMBER TO 873         * 00910000
CHG015*              AND POS-OPER-ID WITH ORDER NUMBER FROM TEPORD    * 00920000
CHG015*              FOR SFS TRANSACTIONS.                            * 00930000
CHG015*  MADE BY: COGNIZANT                        CHG0077015         * 00940000
007900***************************************************************** 00950000
BOPUS *  06/04/2014  ADDED THE OMNI-CHNL-FFLMT-TYP-CDE TO SVRD021     * 00951000
BOPUS *              FILE.  THIS WILL BE USED TO NOT ROLL UP BPS      * 00952000
BOPUS *              TRANSACTIONS IN SVKUT096. SFS HAS BEEN CHANGED   * 00953000
BOPUS *              TO AFS FOR THE SORT SVSR064 AND THE ROLLUP       * 00953100
BOPUS *              PROGRAM SVKUT096.  AFS WILL GET CHANGED BACK IN  * 00953200
BOPUS *              PROGRAM SVKRP024 TO SFS.  ALSO CORRECTED THE      *00953300
BOPUS *              ORDER NUMBER SO 10 CHARACTERS CAN BE MOVED IF    * 00953500
BOPUS *              IT IS 10 CHARACTERS LONG.                        * 00953600
BOPUS *  MADE BY: BARB SCHULTZ                     CHG0094005         * 00953700
007900***************************************************************** 00953800
P10237*  06/08/2015  CHANGES TO DE-TOKENIZE THE GIFT CARD NUMBER      * 00954000
P10237*              AND TO ACCOMMODATE THE ENCRYPTED DL# AND TO      * 00954138
P10237*              REMOVE THE LEADING ZEROS OMIT LOGIC IN DL#       * 00954238
P10237*              AS PART OF COSA DATA SECURITY PROJECT.           * 00954338
P10237*  MADE BY: COGNIZANT                   WR#: CHG0104429         * 00954438
P10237***************************************************************** 00954538
P12431*  09/03/2018  MODIFIED THE OUTPUT FILES RECORD LENGTH TO       * 00954647
P12431*              ACCOMODATE THE INCREASED ORD_NBR FIELD.          * 00954747
P12431*  MADE BY: COGNIZANT                   WR#: CHG0208643         * 00955048
P12431***************************************************************** 00955147
050222*  05/02/2022 DAN PAYNTER                                        *00955250
050222*  CHG0268732                                                    *00955350
050222*  OMIT SEPHORA GIFT CARDS                                       *00955450
050222******************************************************************00955550
008000                                                                  00955647
008100 ENVIRONMENT DIVISION.                                            00955747
008200                                                                  00955847
008300***************************************************************** 00955947
008400                                                                  00956047
008500 CONFIGURATION SECTION.                                           00956147
008600                                                                  00956247
008700 SOURCE-COMPUTER.        IBM-3090.                                00956300
008800 OBJECT-COMPUTER.        IBM-3090.                                00957000
008900                                                                  00958000
009000 INPUT-OUTPUT SECTION.                                            00959000
009100                                                                  00960000
009200 FILE-CONTROL.                                                    00970000
009300                                                                  00980000
009400                                                                  00990000
009500     SELECT POS-DATE-CARD-FILE                                    01000000
009600         ASSIGN TO INP01.                                         01010000
009700                                                                  01020000
009800     SELECT SV-ACTIVITY-EXTR-FILE                                 01030000
009900         ASSIGN TO OUT01.                                         01040000
010000                                                                  01050000
010100******************************************************************01060000
010200 DATA DIVISION.                                                   01070000
010300******************************************************************01080000
010400                                                                  01090000
010500 FILE SECTION.                                                    01100000
010600                                                                  01110000
010700 FD  POS-DATE-CARD-FILE                                           01120000
010800     RECORDING MODE IS F                                          01130000
010900     BLOCK CONTAINS 0 RECORDS                                     01140000
011000     LABEL RECORDS ARE STANDARD.                                  01150000
011100                                                                  01160000
011200 01  POS-DATE-CARD-RECORD            PIC X(80).                   01170000
011300                                                                  01180000
011400 FD  SV-ACTIVITY-EXTR-FILE                                        01190000
011500     RECORDING MODE IS F                                          01200000
011600     LABEL RECORDS ARE STANDARD                                   01210000
011700     BLOCK CONTAINS 0 RECORDS                                     01220000
P12431     RECORD CONTAINS 179 CHARACTERS                               01230046
011900     DATA RECORDS IS SV-ACTIVITY-EXTR-RECORD.                     01240000
012000                                                                  01250000
012100 01  SV-ACTIVITY-EXTR-RECORD                                      01260000
P12431                                 PIC X(179).                      01270046
012300                                                                  01280000
012400******************************************************************01290000
012500 WORKING-STORAGE SECTION.                                         01300000
012600******************************************************************01310000
012700 01  FILLER                            PIC X(50)  VALUE           01320000
012800     ' *** WORKING STORAGE STARTS HERE FOR SVKUT009 *** '.        01330000
012900                                                                  01340000
013000*                                                                 01350000
013100*  SV ACTIVITY EXTRACT FILE RECORD LAYOUT                         01360000
013200*                                                                 01370000
013300                                                                  01380000
013400     COPY SVRD021.                                                01390000
013500                                                                  01400000
013600*                                                                 01410000
013700*  KMC WORKING STORAGE CONSTANTS                                  01420000
013800*                                                                 01430000
013900                                                                  01440000
014000     COPY SVWS004.                                                01450000
014100*----------------------------------------------------------------*01460000
014200** WORKING STORAGE FOR CONVERSION TO CARD NUMBER                 *01470000
014300*----------------------------------------------------------------*01480000
014400     COPY SVWS007.                                                01490000
014500                                                                  01500000
P10237*----------------------------------------------------------------*01501000
P10237* LAYOUT FOR THE PARAMETERS NEEDED TO INVOKE PROTEGRITY MODULE   *01502000
P10237*----------------------------------------------------------------*01503000
P10237     COPY PTYCCSIP.                                               01504100
P10237                                                                  01504200
P10237*----------------------------------------------------------------*01504300
P10237* LAYOUT FOR THE WORKING VARIABLES TO INVOKE PROTEGRITY MODULE   *01504400
P10237*----------------------------------------------------------------*01504500
P10237     COPY DPWS031.                                                01504640
014500                                                                  01505000
014600******************************************************************01510000
014700*    CR-CONTROL RECORD                                           *01520000
014800******************************************************************01530000
014900 01  CR-CONTROL-RECORD.                                           01540000
015000     05  CR-CONTROL-DATE.                                         01550000
015100         10  CR-CONTROL-DATE-CC       PIC  X(02)    VALUE SPACES. 01560000
015200         10  CR-CONTROL-DATE-YY       PIC  X(02)    VALUE SPACES. 01570000
015300         10  FILLER                   PIC  X(01)    VALUE SPACES. 01580000
015400         10  CR-CONTROL-DATE-MM       PIC  X(02)    VALUE SPACES. 01590000
015500         10  FILLER                   PIC  X(01)    VALUE SPACES. 01600000
015600         10  CR-CONTROL-DATE-DD       PIC  X(02)    VALUE SPACES. 01610000
015700     05  FILLER                       PIC  X(70)    VALUE SPACES. 01620000
015800                                                                  01630000
015900 01  PC-PROGRAM-CONSTANTS.                                        01640000
016900     05  PV-SUB                  PIC 9(2)       VALUE ZERO.       01740042
016900     05  PV-MAX-STORE            PIC 9(2)       VALUE ZERO.       01750042
016900     05  PV-STORE-NBR            PIC S9(4) COMP VALUE ZERO.       01760000
016900     05  PV-CRD-NBR              PIC 9(12)      VALUE ZERO.       01770000
BOPUS      05  PV-HOLD-OMNI-CHNL       PIC X(03)      VALUE SPACES.     01771000
087900     05  PV-ORDER-NBR-TEXT       PIC X(40)      VALUE SPACES.     01780000
087900     05  PV-ORDER-NBR.                                            01790000
BOPUS          10  PV-ORD-NBR-N        PIC 9(09)      VALUE ZEROES.     01800000
BOPUS          10  PV-ORD-NBR-1        PIC 9(01)      VALUE ZEROES.     01810000
BOPUS          10  PV-ORD-NBR-2        PIC 9(01)      VALUE ZEROES.     01820000
BOPUS      05  PV-HOLD-ORD-NBR.                                         01830000
BOPUS          10  PV-HOLD-ORD-1       PIC 9(09)      VALUE ZEROES.     01840000
BOPUS          10  PV-HOLD-ORD-2       PIC 9(01)      VALUE ZEROES.     01850000
BOPUS      05  PV-HOLD-ORD-NBRN REDEFINES PV-HOLD-ORD-NBR PIC 9(10).    01860000
CHG015     05  PV-SV-ORDER-NBR         PIC S9(11)V   COMP-3.            01870000
CHG015     05  PV-SFS-DFLT-STR-NBR     PIC S9(04)  COMP VALUE  0873.    01880000
087900     05  PV-LENGTH               PIC 9(02)      VALUE ZEROES.     01890000
016900     05  PV-ECOMM-STORES OCCURS 99 TIMES.                         01900000
016900         10  PV-ECOMM-STR   PIC S9(4) COMP      VALUE ZERO.       01910000
016900                                                                  01920000
017000 01  PT-PROGRAM-TOTALS.                                           01930000
017100     05  PT-SV-EXTRACT-RCDS-WRITTEN                               01940000
017200                                 PIC S9(11)   VALUE ZEROS         01950000
017300                                              COMP-3.             01960000
017400                                                                  01970000
017500 01  TD-TOTAL-DISPLAY-MESSAGE.                                    01980000
017600     05  TD-TOTAL-ID             PIC X(51)    VALUE SPACES.       01990000
017700         88  TD-SV-EXTRACT-FILE-RCDS-ID     VALUE                 02000000
017800             'SV ACTIVITY EXTRACT RECORDS WRITTEN  . . . . . '.   02010000
017900     05  TD-TOTAL-AMOUNT         PIC ZZ,ZZZ,ZZZ,ZZ9               02020000
018000                                              VALUE ZEROS.        02030000
018100******************************************************************02040000
018200*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             02050000
018300******************************************************************02060000
018400     COPY DPWS500.                                                02070000
018500                                                                  02080000
018600 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      02090000
018700                                                  COMP SYNC.      02100000
018800     88  AC-CONTROL-CARD-ERROR                    VALUE +4003.    02110000
018900     88  AC-DB2-ERROR                             VALUE +4013.    02120000
019000     88  AC-CALENDAR-ROUTINE-ERROR                VALUE +4019.    02130000
019100                                                                  02140000
P10237 01  ABEND-CODE                        PIC S9(04) VALUE +0  COMP. 02141041
004900                                                                  02142041
019200 01  PS-PROGRAM-SWITCHES.                                         02150000
019300     05  PS-END-OF-TEPTRN-CSR-SW       PIC X(01)  VALUE 'N'.      02160000
019400         88  PS-END-OF-TEPTRN-CSR                 VALUE 'Y'.      02170000
019500         88  PS-NOT-END-OF-TEPTRN-CSR             VALUE 'N'.      02180000
019600     05  PS-END-OF-TEPITM-CSR-SW       PIC X(01)  VALUE 'N'.      02190000
019700         88  PS-END-OF-TEPITM-CSR                 VALUE 'Y'.      02200000
019800         88  PS-NOT-END-OF-TEPITM-CSR             VALUE 'N'.      02210000
019900     05  PS-END-OF-TEPDKEY-CSR-SW      PIC X(01)  VALUE 'N'.      02220000
020000         88  PS-END-OF-TEPDKEY-CSR                VALUE 'Y'.      02230000
020100         88  PS-NOT-END-OF-TEPDKEY-CSR            VALUE 'N'.      02240000
020200     05  PS-END-OF-TEPDKEY-ITM-CSR-SW  PIC X(01)  VALUE 'N'.      02250000
020300         88  PS-END-OF-TEPDKEY-ITM-CSR            VALUE 'Y'.      02260000
020400         88  PS-NOT-END-OF-TEPDKEY-ITM-CSR        VALUE 'N'.      02270000
020200     05  PS-END-OF-XSTR-CSR-SW         PIC X(01)  VALUE 'N'.      02280000
020300         88  PS-NOT-END-OF-XSTR-CSR               VALUE 'N'.      02290000
020400         88  PS-END-OF-XSTR-CSR                   VALUE 'Y'.      02300000
020500     05  PS-END-OF-CARD-FILE-SW        PIC X(01)  VALUE 'N'.      02310000
020600         88  PS-END-OF-CARD-FILE                  VALUE 'Y'.      02320000
020700     05  PS-REFUND-AUTH-PRESENT-SW     PIC X(01)  VALUE 'N'.      02330000
020800         88  PS-REFUND-AUTH-PRESENT               VALUE 'Y'.      02340000
020900         88  PS-REFUND-AUTH-NOT-PRESENT           VALUE 'N'.      02350000
021000     05  PS-NOT-FOUND-IS-ABEND-SW      PIC X(01)  VALUE 'N'.      02360000
021100         88  PS-NOT-FOUND-IS-ABEND                VALUE 'Y'.      02370000
021200         88  PS-NOT-FOUND-IS-OK                   VALUE 'N'.      02380000
021300     05  PS-ECOMM-STR-SW               PIC X(01)  VALUE 'N'.      02390000
021300         88  PS-ECOMM-STR                         VALUE 'Y'.      02400000
021300         88  PS-NOT-ECOMM-STR                     VALUE 'N'.      02410000
CHG015     05  PS-OMNI-CHNL-SW               PIC X(01)  VALUE 'N'.      02420000
CHG015         88  PS-OMNI-CHNL-YES                     VALUE 'Y'.      02430000
CHG015         88  PS-OMNI-CHNL-NO                      VALUE 'N'.      02440000
CHG015     05  PS-NULL-IND6                  PIC S9(4)  COMP            02450000
CHG015                                                  VALUE ZERO.     02460000
CHG015         88 PS-IND6-IS-NULL                       VALUE -1.       02470000
021300                                                                  02480000
021400 01  PC-CONSTANTS.                                                02490000
021500     05  PC-ROW-NOT-FOUND            PIC S9(04)    VALUE +100     02500000
021600                                                   COMP SYNC.     02510000
021700     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          02520000
021800                                                   'SVKUT009'.    02530000
021900 01  PV-MISC-FIELDS.                                              02540000
022000     05  PV-PARAGRAPH-NAME.                                       02550000
022100         10  PV-PARA-NBR             PIC  X(04)    VALUE SPACE.   02560000
022200         10  FILLER                  PIC  X(26)    VALUE SPACE.   02570000
022300     05  PV-OPERATION-MSG-1          PIC  X(40)    VALUE SPACE.   02580000
022400     05  PV-OPERATION-MSG-2          PIC  X(40)    VALUE SPACE.   02590000
022500     05  PV-DB2-OPERATION            PIC  X(40)    VALUE SPACE.   02600000
022600     05  PV-DISPLAY-NBR-4            PIC  9(04)    VALUE ZERO.    02610000
022700     05  PV-DISPLAY-SIGNED-4         PIC ----9     VALUE ZERO.    02620000
087900     05  PV-ORD-NBR-VAR.                                          02630000
087900         10  PV-ORD-NBR               PIC 9(11).                  02640000
087900         10  FILLER                   PIC X(29).                  02650000
087900     05  PV-ORD-NBR-9                 PIC 9(11)    VALUE ZERO.    02660000
022800                                                                  02670000
022900 01  PV-DATE-AND-TIME-FIELDS.                                     02680000
023000     05  PV-DB2-CCYY-MM-DD           PIC X(10)     VALUE SPACE.   02690000
023100                                                                  02700000
023200******************************************************************02710000
023300*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            02720000
023400******************************************************************02730000
023500     COPY DPWS004.                                                02740000
023600                                                                  02750000
023700******************************************************************02760000
023800*  DB2 COMMUNICATION AREA.                                        02770000
023900******************************************************************02780000
024000     EXEC SQL                                                     02790000
024100          INCLUDE SQLCA                                           02800000
024200     END-EXEC.                                                    02810000
024300******************************************************************02820000
024400*  DB2 TABLE DB2PDBA.TEPPART - PARTITION CONTROL TABLE            02830000
024500******************************************************************02840000
024600     EXEC SQL                                                     02850000
024700          INCLUDE TEPPART                                         02860000
024800     END-EXEC.                                                    02870000
024900******************************************************************02880000
025000*  DB2 TABLE DB2PDBA.TEPDKEY - CURRENT PROCESSING DAY KEY TABLE   02890000
025100******************************************************************02900000
025200     EXEC SQL                                                     02910000
025300          INCLUDE TEPDKEY                                         02920000
025400     END-EXEC.                                                    02930000
025500******************************************************************02940000
025600*  DB2 TABLE DB2PDBA.TEPTRN - TRANSACTION TABLE                   02950000
025700******************************************************************02960000
025800     EXEC SQL                                                     02970000
025900          INCLUDE TEPTRN                                          02980000
026000     END-EXEC.                                                    02990000
026100******************************************************************03000000
026200*  DB2 TABLE DB2PDBA.TEPTND - TENDER TABLE                        03010000
026300******************************************************************03020000
026400     EXEC SQL                                                     03030000
026500          INCLUDE TEPTND                                          03040000
026600     END-EXEC.                                                    03050000
026700******************************************************************03060000
026800*  DB2 TABLE DB2PDBA.TEPSVC - STORED VALUE CARD TENDER TABLE      03070000
026900******************************************************************03080000
027000     EXEC SQL                                                     03090000
027100          INCLUDE TEPSVC                                          03100000
027200     END-EXEC.                                                    03110000
027300******************************************************************03120000
027400*  DB2 TABLE DB2PDBA.TEPITM - ITEM TABLE                          03130000
027500******************************************************************03140000
027600     EXEC SQL                                                     03150000
027700          INCLUDE TEPITM                                          03160000
027800     END-EXEC.                                                    03170000
027300******************************************************************03180000
027400*  DB2 TABLE DB2PDBA.TEPORD - ORDER TABLE                         03190000
027500******************************************************************03200000
027600     EXEC SQL                                                     03210000
027700          INCLUDE TEPORD                                          03220000
027800     END-EXEC.                                                    03230000
027900******************************************************************03240000
028000*  DB2 TABLE DB2PDBA.TEPRFA - REFUND AUTHORIZATION TABLE          03250000
028100******************************************************************03260000
028200     EXEC SQL                                                     03270000
028300          INCLUDE TEPRFA                                          03280000
028400     END-EXEC.                                                    03290000
027900******************************************************************03300000
028000*       KOHL'S DOMAIN LOCATION TABLE                             *03310000
028100******************************************************************03320000
028200     EXEC SQL                                                     03330000
028300         INCLUDE XST00001                                         03340000
028400     END-EXEC.                                                    03350000
028400                                                                  03360000
028500******************************************************************03370000
028600*  CURSOR TO DRIVE CREATION OF THE DAILY STORED VALUE TENDERS.    03380000
028700******************************************************************03390000
028800     EXEC SQL                                                     03400000
028900       DECLARE TEPTRN-CURSOR CURSOR FOR                           03410000
029000            SELECT  B.PARTN_NBR                                   03420000
029100                   ,B.STR_NBR                                     03430000
029200                   ,B.RGST_ID                                     03440000
029300                   ,B.TRN_NBR                                     03450000
029400                   ,B.STRT_TM                                     03460000
029500                   ,B.SLS_CORR_SEQ_NBR                            03470000
029600                   ,B.VOID_ABRT_CDE                               03480000
029700                   ,B.TRN_STAT_CDE                                03490000
029800                   ,B.SLS_DTE                                     03500000
029900                   ,B.ASSOC_ID                                    03510000
CHG015                   ,B.OMNI_CHNL_FFLMT_TYP_CDE                     03520000
030000                   ,C.TNDR_SEQ_NBR                                03530000
030100                   ,C.TNDR_TYP_CDE                                03540000
030200                   ,C.TNDR_ID                                     03550000
030300                   ,C.TNDR_AMT                                    03560000
030400                   ,C.TNDR_ID_LEN_NBR                             03570000
030500            FROM  TEPPART A                                       03580000
030600                 ,TEPTRN B                                        03590000
030700                 ,TEPTND C                                        03600000
030800            WHERE A.PARTN_NBR      =  B.PARTN_NBR                 03610000
030900              AND A.PARTN_NBR      =  C.PARTN_NBR                 03620000
031000              AND B.STR_NBR        =  C.STR_NBR                   03630000
031100              AND B.RGST_ID        =  C.RGST_ID                   03640000
031200              AND B.TRN_NBR        =  C.TRN_NBR                   03650000
031300              AND B.STRT_TM        =  C.STRT_TM                   03660000
031400              AND B.SLS_CORR_SEQ_NBR = C.SLS_CORR_SEQ_NBR         03670000
031500              AND A.SLS_DTE        = :PV-DB2-CCYY-MM-DD           03680000
031600              AND B.TRN_STAT_CDE IN ('Z','L')                     03690000
031700              AND C.TNDR_TYP_CDE IN ('02','13')                   03700000
050222              AND C.TNDR_ID_SRC_CDE <> '14'                       03701050
031800              AND C.TNDR_VOID_IND = 'N'                           03710000
RPTFIX              AND C.TNDR_AMT <> 0                                 03711043
031900              WITH UR                                             03720000
032000     END-EXEC.                                                    03730000
032100                                                                  03740000
032200******************************************************************03750000
032300* CURSOR TO DRIVE CREATION OF THE DAILY GIFT CARD ISSUANCES       03760000
032400******************************************************************03770000
032500     EXEC SQL                                                     03780000
032600       DECLARE TEPITM-CURSOR CURSOR FOR                           03790000
032700            SELECT  B.PARTN_NBR                                   03800000
032800                   ,B.STR_NBR                                     03810000
032900                   ,B.RGST_ID                                     03820000
033000                   ,B.TRN_NBR                                     03830000
033100                   ,B.STRT_TM                                     03840000
033200                   ,B.SLS_CORR_SEQ_NBR                            03850000
033300                   ,B.VOID_ABRT_CDE                               03860000
033400                   ,B.TRN_STAT_CDE                                03870000
033500                   ,B.SLS_DTE                                     03880000
033600                   ,B.ASSOC_ID                                    03890000
CHG015                   ,B.OMNI_CHNL_FFLMT_TYP_CDE                     03900000
033700                   ,C.MDSE_ID                                     03910000
033800                   ,C.CUST_CHRGD_AMT                              03920000
033900            FROM  TEPPART A                                       03930000
034000                 ,TEPTRN B                                        03940000
034100                 ,TEPITM C                                        03950000
034200            WHERE A.PARTN_NBR      =  B.PARTN_NBR                 03960000
034300              AND A.PARTN_NBR      =  C.PARTN_NBR                 03970000
034400              AND B.STR_NBR        =  C.STR_NBR                   03980000
034500              AND B.RGST_ID        =  C.RGST_ID                   03990000
034600              AND B.TRN_NBR        =  C.TRN_NBR                   04000000
034700              AND B.STRT_TM        =  C.STRT_TM                   04010000
034800              AND B.SLS_CORR_SEQ_NBR = C.SLS_CORR_SEQ_NBR         04020000
034900              AND A.SLS_DTE        = :PV-DB2-CCYY-MM-DD           04030000
035000              AND B.TRN_STAT_CDE   IN ('Z','L')                   04040000
035100              AND C.DEPT_NBR         = '983'                      04050000
035200              AND C.LIV_RSLU_CDE     = '+'                        04060000
RPTFIX              AND C.CUST_CHRGD_AMT    <> 0                        04061045
035300            WITH UR                                               04070000
035400     END-EXEC.                                                    04080000
035500                                                                  04090000
035600******************************************************************04100000
035700*  CURSOR TO DRIVE CREATION OF STORED VALUE TENDERS FROM LATES AND04110000
035800*  CORRECTIONS.                                                   04120000
035900******************************************************************04130000
036000     EXEC SQL                                                     04140000
036100       DECLARE TEPDKEY-CURSOR CURSOR FOR                          04150000
036200            SELECT  B.PARTN_NBR                                   04160000
036300                   ,B.STR_NBR                                     04170000
036400                   ,B.RGST_ID                                     04180000
036500                   ,B.TRN_NBR                                     04190000
036600                   ,B.STRT_TM                                     04200000
036700                   ,B.SLS_CORR_SEQ_NBR                            04210000
036800                   ,B.VOID_ABRT_CDE                               04220000
036900                   ,B.TRN_STAT_CDE                                04230000
037000                   ,A.SLS_DTE                                     04240000
037100                   ,B.ASSOC_ID                                    04250000
CHG015                   ,B.OMNI_CHNL_FFLMT_TYP_CDE                     04260000
037200                   ,D.TNDR_SEQ_NBR                                04270000
037300                   ,D.TNDR_TYP_CDE                                04280000
037400                   ,D.TNDR_ID                                     04290000
037500                   ,D.TNDR_AMT                                    04300000
037600                   ,D.TNDR_ID_LEN_NBR                             04310000
037700            FROM  TEPDKEY A                                       04320000
037800                 ,TEPTRN B                                        04330000
037900                 ,TEPPART C                                       04340000
038000                 ,TEPTND D                                        04350000
038100            WHERE   A.SLS_DTE          = C.SLS_DTE                04360000
038200              AND   B.PARTN_NBR        = C.PARTN_NBR              04370000
038300              AND   A.STR_NBR          = B.STR_NBR                04380000
038400              AND   A.RGST_ID          = B.RGST_ID                04390000
038500              AND   A.TRN_NBR          = B.TRN_NBR                04400000
038600              AND   A.STRT_TM          = B.STRT_TM                04410000
038700              AND   A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR       04420000
038800              AND   B.PARTN_NBR        = D.PARTN_NBR              04430000
038900              AND   B.STR_NBR          = D.STR_NBR                04440000
039000              AND   B.RGST_ID          = D.RGST_ID                04450000
039100              AND   B.TRN_NBR          = D.TRN_NBR                04460000
039200              AND   B.STRT_TM          = D.STRT_TM                04470000
039300              AND   B.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR       04480000
039400              AND   A.PRCG_DTE         = :EPDKEY-PRCG-DTE         04490000
039500              AND   B.VOID_ABRT_CDE IN ('N','V','B','I')          04500000
039600              AND   B.TRN_STAT_CDE  IN ('Z','V','R','L')          04510000
039700              AND   D.TNDR_TYP_CDE IN ('02','13')                 04520000
050222              AND   D.TNDR_ID_SRC_CDE <> '14'                     04521050
039800              AND   D.TNDR_VOID_IND = 'N'                         04530000
039900              WITH UR                                             04540000
040000     END-EXEC.                                                    04550000
040100                                                                  04560000
040200******************************************************************04570000
040300*  CURSOR TO DRIVE CREATION OF GIFT CARD ISSUANCES FROM LATES AND 04580000
040400*  CORRECTIONS.                                                   04590000
040500******************************************************************04600000
040600     EXEC SQL                                                     04610000
040700       DECLARE TEPDKEY-ITM-CURSOR CURSOR FOR                      04620000
040800            SELECT  B.PARTN_NBR                                   04630000
040900                   ,B.STR_NBR                                     04640000
041000                   ,B.RGST_ID                                     04650000
041100                   ,B.TRN_NBR                                     04660000
041200                   ,B.STRT_TM                                     04670000
041300                   ,B.SLS_CORR_SEQ_NBR                            04680000
041400                   ,B.VOID_ABRT_CDE                               04690000
041500                   ,B.TRN_STAT_CDE                                04700000
041600                   ,A.SLS_DTE                                     04710000
041700                   ,B.ASSOC_ID                                    04720000
CHG015                   ,B.OMNI_CHNL_FFLMT_TYP_CDE                     04730000
041800                   ,D.MDSE_ID                                     04740000
041900                   ,D.CUST_CHRGD_AMT                              04750000
042000            FROM  TEPDKEY A                                       04760000
042100                 ,TEPTRN B                                        04770000
042200                 ,TEPPART C                                       04780000
042300                 ,TEPITM D                                        04790000
042400            WHERE   A.SLS_DTE          = C.SLS_DTE                04800000
042500              AND   B.PARTN_NBR        = C.PARTN_NBR              04810000
042600              AND   A.STR_NBR          = B.STR_NBR                04820000
042700              AND   A.RGST_ID          = B.RGST_ID                04830000
042800              AND   A.TRN_NBR          = B.TRN_NBR                04840000
042900              AND   A.STRT_TM          = B.STRT_TM                04850000
043000              AND   A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR       04860000
043100              AND   B.PARTN_NBR        = D.PARTN_NBR              04870000
043200              AND   B.STR_NBR          = D.STR_NBR                04880000
043300              AND   B.RGST_ID          = D.RGST_ID                04890000
043400              AND   B.TRN_NBR          = D.TRN_NBR                04900000
043500              AND   B.STRT_TM          = D.STRT_TM                04910000
043600              AND   B.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR       04920000
043700              AND   A.PRCG_DTE         = :EPDKEY-PRCG-DTE         04930000
043800              AND   B.VOID_ABRT_CDE IN ('N','V','B','I')          04940000
043900              AND   B.TRN_STAT_CDE  IN ('Z','V','R','L')          04950000
044000              AND   D.DEPT_NBR         = '983'                    04960000
044100              AND   D.LIV_RSLU_CDE     = '+'                      04970000
BOPUS               AND   D.MDSE_ID          > 0                        04980000
044200              WITH UR                                             04990000
044300     END-EXEC.                                                    05000000
044400*---------------------------------------------------------------* 05010000
044400*    CURSOR TO EXTRACT ALL ECOMMERCE STORE NUMBERS FROM XST00001* 05020000
044400*---------------------------------------------------------------* 05030000
044400                                                                  05040000
044400     EXEC SQL                                                     05050000
044400        DECLARE XSTR-CSR CURSOR                                   05060000
044400        FOR SELECT LOC_NBR                                        05070000
044400              FROM XST_LOC                                        05080000
044400            WHERE  E_BUS_IND    = 'Y'                             05090000
044400              AND  LOC_TYP_CDE  = 'DS'                            05100000
044400     END-EXEC.                                                    05110000
044500***************************************************************** 05120000
044600* PROCEDURE DIVISION.                                           * 05130000
044700***************************************************************** 05140000
044800 PROCEDURE DIVISION.                                              05150000
044900                                                                  05160000
045000******************************************************************05170000
045100* 0000-MAINLINE-PARAGRAPH                                         05180000
045200*      PRODUCE DAILY SALES FILE                                   05190000
045300******************************************************************05200000
045400 0000-MAINLINE-PARAGRAPH.                                         05210000
045500                                                                  05220000
045600     PERFORM 1000-INITIALIZE-PROGRAM.                             05230000
045700     PERFORM 2000-CREATE-DAILY-SALES-FILE.                        05240000
045800     PERFORM 3000-PRINT-SYSOUT-TOTALS.                            05250000
045900                                                                  05260000
046000     STOP RUN.                                                    05270000
046100                                                                  05280000
046200******************************************************************05290000
046300* 1000-INITIALIZE-PROGRAM                                         05300000
046400*     OPEN FILES, PROCESS CONTROL CARD, FORMAT REPORT HEADINGS,   05310000
046500*     SELECT PARTN-NBR FROM TEPPART                               05320000
046600*     OPEN TEPTRN-CURSOR, ATTEMPT FIRST FETCH OF CURSOR.          05330000
046700******************************************************************05340000
046800 1000-INITIALIZE-PROGRAM.                                         05350000
046900                                                                  05360000
047000     OPEN INPUT  POS-DATE-CARD-FILE                               05370000
047100          OUTPUT SV-ACTIVITY-EXTR-FILE.                           05380000
047200                                                                  05390000
P10237     MOVE PC-CURRENT-PROGRAM-NAME TO DP031-PROGRAM-NAME.          05391040
047300     PERFORM 1100-PROCESS-CONTROL-CARD.                           05400000
047400                                                                  05410000
047400     PERFORM 1050-OPEN-XSTR-CSR.                                  05420000
047400     PERFORM 1060-FETCH-XSTR-CSR UNTIL PS-END-OF-XSTR-CSR.        05430000
047400     PERFORM 1070-CLOSE-XSTR-CSR.                                 05440000
047400                                                                  05450000
047500     PERFORM 7000-OPEN-TEPTRN-CURSOR.                             05460000
047600     PERFORM 7010-FETCH-TEPTRN-CURSOR.                            05470000
047700     IF PS-END-OF-TEPTRN-CSR                                      05480000
047800         DISPLAY '*** NO TRANSACTION DATA PRESENT ON TEPTRN FOR ' 05490000
047900                 PV-DB2-CCYY-MM-DD ' ***'                         05500000
048000     END-IF.                                                      05510000
048100*---------------------------------------------------------------- 05520000
048100* OPEN THE XST00001 CURSOR                                        05530000
048100*---------------------------------------------------------------- 05540000
048100 1050-OPEN-XSTR-CSR.                                              05550000
048100     EXEC SQL                                                     05560000
048100         OPEN XSTR-CSR                                            05570000
048100     END-EXEC.                                                    05580000
048100     EVALUATE TRUE                                                05590000
048100        WHEN SQLCODE = ZERO                                       05600000
048100             CONTINUE                                             05610000
048100        WHEN OTHER                                                05620000
048100             MOVE '1050-OPEN-XSTR-CSR'                            05630000
048100                               TO PV-PARAGRAPH-NAME               05640000
048100             MOVE 'OPEN E STORE CURSOR - '                        05650000
048100                               TO PV-DB2-OPERATION                05660000
091800             PERFORM 9100-SQL-ABEND                               05670000
048100     END-EVALUATE.                                                05680000
048100                                                                  05690000
048100******************************************************************05700000
048100*     1060-FETCH-XSTR-CSR                                        *05710000
048100* ==> PROCESSES:                                                 *05720000
048100*     - CHECK THE LOCATION DOMAIN TABLE FOR ECOMMERCE STORES     *05730000
048100******************************************************************05740000
048100 1060-FETCH-XSTR-CSR.                                             05750000
048100     EXEC SQL                                                     05760000
048100          FETCH XSTR-CSR                                          05770000
048100          INTO :XST00001-LOC-NBR                                  05780000
048100     END-EXEC.                                                    05790000
048100                                                                  05800000
048100     EVALUATE SQLCODE                                             05810000
048100         WHEN ZERO                                                05820000
048100             ADD +1 TO PV-SUB                                     05830000
048100             MOVE XST00001-LOC-NBR TO PV-ECOMM-STR(PV-SUB)        05840000
048100         WHEN +100                                                05850000
048100             SET PS-END-OF-XSTR-CSR   TO TRUE                     05860000
048100             MOVE PV-SUB              TO PV-MAX-STORE             05870000
048100         WHEN OTHER                                               05880000
048100             MOVE '1060-FETCH-XSTR-CSR'                           05890000
048100                               TO PV-PARAGRAPH-NAME               05900000
048100             MOVE 'FETCH E STORE CURSOR - '                       05910000
048100                               TO PV-DB2-OPERATION                05920000
091800             PERFORM 9100-SQL-ABEND                               05930000
048100     END-EVALUATE.                                                05940000
048100                                                                  05950000
048100******************************************************************05960000
048100*     1070-CLOSE-XSTR-CSR                                        *05970000
048100* ==> PROCESSES:                                                 *05980000
048100*     - CLOSE THE E STORE CURSOR                                 *05990000
048100******************************************************************06000000
048100 1070-CLOSE-XSTR-CSR.                                             06010000
048100     EXEC SQL                                                     06020000
048100         CLOSE XSTR-CSR                                           06030000
048100     END-EXEC.                                                    06040000
048100                                                                  06050000
048100     EVALUATE TRUE                                                06060000
048100         WHEN SQLCODE = ZERO                                      06070000
048100            CONTINUE                                              06080000
048100         WHEN OTHER                                               06090000
048100             MOVE '1070-CLOSE-XSTR-CSR'                           06100000
048100                               TO PV-PARAGRAPH-NAME               06110000
048100             MOVE 'CLOSE E STORE CURSOR - '                       06120000
048100                               TO PV-DB2-OPERATION                06130000
091800             PERFORM 9100-SQL-ABEND                               06140000
048100     END-EVALUATE.                                                06150000
048100                                                                  06160000
048200******************************************************************06170000
048300* 1100-PROCESS-CONTROL-CARD                                       06180000
048400*     READ CONTROL CARD TO GET POS DATE IN MMDDYY FORMAT.  CALL   06190000
048500*     DATE ROUTINE TO CONVERT DATE TO A CCYY-MM-DD PROCESS DATE.  06200000
048600******************************************************************06210000
048700 1100-PROCESS-CONTROL-CARD.                                       06220000
048800                                                                  06230000
048900     PERFORM 1110-READ-POS-DATE-CARD-FILE.                        06240000
049000     CLOSE POS-DATE-CARD-FILE.                                    06250000
049100     IF PS-END-OF-CARD-FILE                                       06260000
049200         MOVE '1100-PROCESS-CONTROL-CARD'  TO PV-PARAGRAPH-NAME   06270000
049300         MOVE 'NO CONTROL CARD TO PROCESS' TO PV-OPERATION-MSG-1  06280000
049400         SET AC-CONTROL-CARD-ERROR TO TRUE                        06290000
049500         PERFORM 9999-ABEND                                       06300000
049600     END-IF.                                                      06310000
049700     DISPLAY PC-CURRENT-PROGRAM-NAME                              06320000
049800             ' - CONTROL CARD = (' CR-CONTROL-DATE          ')'.  06330000
049900     PERFORM 1115-CONVERT-INPUT-DATE.                             06340000
050000******************************************************************06350000
050100* 1110-READ-POS-DATE-CARD-FILE                                    06360000
050200*     READ DATE CONTROL CARD.                                     06370000
050300******************************************************************06380000
050400 1110-READ-POS-DATE-CARD-FILE.                                    06390000
050500     READ POS-DATE-CARD-FILE INTO CR-CONTROL-RECORD               06400000
050600        AT END                                                    06410000
050700           SET PS-END-OF-CARD-FILE TO TRUE.                       06420000
050800                                                                  06430000
050900******************************************************************06440000
051000* 1115-CONVERT-INPUT-DATE                                         06450000
051100*     CALL KOHLS CALENDAR ROUTINE:                                06460000
051200*         PASS: CONTROL CARD POS DATE (MMDDYY FORMAT).            06470000
051300*       RETURN: ACTUAL CALENDAR DB2 ISO DATE (CCYY-MM-DD FORMAT). 06480000
051400******************************************************************06490000
051500 1115-CONVERT-INPUT-DATE.                                         06500000
051600                                                                  06510000
051700     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              06520000
051800                                                                  06530000
051900     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   06540000
052000     SET  DPG52-LK-DTE-ISO-FMT         TO TRUE.                   06550000
052100     MOVE CR-CONTROL-DATE              TO DPG52-LK-DATE-INPUT.    06560000
052200     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    06570000
052300                                             DPG54 DPG55 DPG56.   06580000
052400     EVALUATE TRUE                                                06590000
052500         WHEN DPG54-SEVERE-ERROR                                  06600000
052600         WHEN DPG54-DATE-INVALID                                  06610000
052700             MOVE '1115-CONVERT-INPUT-DATE'                       06620000
052800                                           TO PV-PARAGRAPH-NAME   06630000
052900             MOVE 'ERROR CONVERTING INPUT CARD DATE'              06640000
053000                                           TO PV-OPERATION-MSG-1  06650000
053100             SET AC-CALENDAR-ROUTINE-ERROR TO TRUE                06660000
053200             MOVE DPG54-ERROR-MESSAGE      TO PV-OPERATION-MSG-2  06670000
053300             PERFORM 9999-ABEND                                   06680000
053400     END-EVALUATE.                                                06690000
053500                                                                  06700000
053600     MOVE DPG55-DB2-ISO-DATE-FMT       TO PV-DB2-CCYY-MM-DD       06710000
053700                                          EPDKEY-PRCG-DTE.        06720000
053800                                                                  06730000
053900******************************************************************06740000
054000*  DISPLAY PROGRAM RECORD I/O TOTALS.                            *06750000
054100******************************************************************06760000
054200                                                                  06770000
054300 1500-DISPLAY-PROGRAM-TOTALS.                                     06780000
054400                                                                  06790000
054500     SET TD-SV-EXTRACT-FILE-RCDS-ID TO TRUE.                      06800000
054600     MOVE PT-SV-EXTRACT-RCDS-WRITTEN TO TD-TOTAL-AMOUNT.          06810000
054700     DISPLAY PC-CURRENT-PROGRAM-NAME  ' - '                       06820000
054800               TD-TOTAL-DISPLAY-MESSAGE.                          06830000
054900*1500-EXIT.                                                       06840000
055000                                                                  06850000
055100******************************************************************06860000
055200* 2000-CREATE-DAILY-SALES-FILE                                    06870000
055300*     PROCESS THE TEPTRN-CURSOR AND TEPDKEY-CURSOR.               06880000
055400*                                                                 06890000
055500******************************************************************06900000
055600 2000-CREATE-DAILY-SALES-FILE.                                    06910000
055700                                                                  06920000
055800     PERFORM                                                      06930000
055900       UNTIL PS-END-OF-TEPTRN-CSR                                 06940000
056000         IF EPTRN-VOID-ABRT-CDE = 'A'                             06950000
056100             CONTINUE                                             06960000
056200         ELSE                                                     06970000
056300             PERFORM 7625-SELECT-TEPRFA-ROW                       06980000
056400             PERFORM 2100-BUILD-TENDER-RECORDS                    06990000
056500         END-IF                                                   07000000
056600         PERFORM 7010-FETCH-TEPTRN-CURSOR                         07010000
056700     END-PERFORM.                                                 07020000
056800                                                                  07030000
056900     PERFORM 7020-CLOSE-TEPTRN-CURSOR                             07040000
057000                                                                  07050000
057100     PERFORM 7100-OPEN-TEPITM-CURSOR.                             07060000
057200     PERFORM 7110-FETCH-TEPITM-CURSOR.                            07070000
057300     PERFORM                                                      07080000
057400         UNTIL PS-END-OF-TEPITM-CSR                               07090000
057500           IF EPITM-CUST-CHRGD-AMT NOT = 0                        07100000
057600               PERFORM 5100-BUILD-GIFT-ISU-ACTV-EXT               07110000
057700           END-IF                                                 07120000
057800           PERFORM 7110-FETCH-TEPITM-CURSOR                       07130000
057900     END-PERFORM.                                                 07140000
058000                                                                  07150000
058100     PERFORM 7120-CLOSE-TEPITM-CURSOR.                            07160000
058200                                                                  07170000
058300     PERFORM 7030-OPEN-TEPDKEY-CURSOR.                            07180000
058400     PERFORM 7040-FETCH-TEPDKEY-CURSOR.                           07190000
058500     IF PS-END-OF-TEPDKEY-CSR                                     07200000
058600        DISPLAY '*** NO TRANSACTION DATA PRESENT ON TEPDKEY ***'  07210000
058700     END-IF.                                                      07220000
058800     PERFORM                                                      07230000
058900       UNTIL PS-END-OF-TEPDKEY-CSR                                07240000
059000         IF EPTRN-VOID-ABRT-CDE = 'A'                             07250000
059100             CONTINUE                                             07260000
059200         ELSE                                                     07270000
059300             PERFORM 7625-SELECT-TEPRFA-ROW                       07280000
059400             PERFORM 2100-BUILD-TENDER-RECORDS                    07290000
059500         END-IF                                                   07300000
059600         PERFORM 7040-FETCH-TEPDKEY-CURSOR                        07310000
059700     END-PERFORM.                                                 07320000
059800                                                                  07330000
059900     PERFORM 7050-CLOSE-TEPDKEY-CURSOR.                           07340000
060000                                                                  07350000
060100     PERFORM 7060-OPEN-TEPDKEY-ITM-CURSOR.                        07360000
060200     PERFORM 7070-FETCH-TEPDKEY-ITM-CURSOR.                       07370000
060300     IF PS-END-OF-TEPDKEY-ITM-CSR                                 07380000
060400        DISPLAY '*** NO TRANSACTION DATA PRESENT ON TEPDKEY IT***'07390000
060500     END-IF.                                                      07400000
060600     PERFORM                                                      07410000
060700       UNTIL PS-END-OF-TEPDKEY-ITM-CSR                            07420000
060800         IF EPITM-CUST-CHRGD-AMT NOT = 0                          07430000
060900             PERFORM 5100-BUILD-GIFT-ISU-ACTV-EXT                 07440000
061000         END-IF                                                   07450000
061100         PERFORM 7070-FETCH-TEPDKEY-ITM-CURSOR                    07460000
061200     END-PERFORM.                                                 07470000
061300                                                                  07480000
061400     PERFORM 7080-CLOSE-TEPDKEY-ITM-CURSOR.                       07490000
061500                                                                  07500000
061600******************************************************************07510000
061700* 2100-BUILD-TENDER-RECORDS                                       07520000
061800* CURSOR SELECTS ONLY TNDR-TYP-CDES 02 AND 13                     07530000
061900*                                                                 07540000
062000******************************************************************07550000
062100 2100-BUILD-TENDER-RECORDS.                                       07560000
062200                                                                  07570000
062300     IF EPTND-TNDR-TYP-CDE = '02'                                 07580000
P10237         IF EPTND-TNDR-ID NOT EQUAL SPACES                        07580100
P10237          AND EPTND-TNDR-ID-LEN-NBR >= 7                          07580200
P10237            INITIALIZE CSI-PARAMETERS                             07581000
P10237                       DP031-PROTEG-PGM-PARAMETERS                07584040
P10237            MOVE 'KMRC NUMBER'          TO DP031-FIELD            07585140
P10237            PERFORM 2110-DETOKENIZE-TID                           07585250
P10237         END-IF                                                   07585700
062400         PERFORM 4000-BUILD-KMRC-ACTV-EXTRACT                     07590000
062500     ELSE                                                         07600000
062600         IF EPTND-TNDR-ID-LEN-NBR < 10                            07610000
062700             CONTINUE                                             07620000
062800         ELSE                                                     07630000
P10237             IF EPTND-TNDR-ID NOT EQUAL SPACES                    07630100
P10237              AND EPTND-TNDR-ID-LEN-NBR >= 7                      07630200
P10237                INITIALIZE CSI-PARAMETERS                         07631000
P10237                           DP031-PROTEG-PGM-PARAMETERS            07634040
P10237                MOVE 'GIFT CARD#'        TO DP031-FIELD           07636040
P10237                PERFORM 2110-DETOKENIZE-TID                       07636150
P10237             END-IF                                               07638000
062900             PERFORM 5000-BUILD-GIFT-TNDR-ACTV-EXT                07640000
063000         END-IF                                                   07650000
063100     END-IF.                                                      07660000
063200                                                                  07670000
P10237******************************************************************07680000
P10237* 2110-DETOKENIZE-TID                                             07690000
P10237*     DETOKENIZE THE TENDER ID FIELD                              07700000
P10237******************************************************************07730000
P10237 2110-DETOKENIZE-TID.                                             07740000
P10237                                                                  07750000
P10237     SET CSI-DECRYPT-FUNCTION     TO TRUE.                        07750100
P10237     SET DP031-ACCTNBR            TO TRUE.                        07750240
P10237     MOVE EPTND-TNDR-ID           TO DP031-CIPHER-TEXT.           07750340
P10237     MOVE EPTND-TNDR-ID-LEN-NBR   TO DP031-INPUT-LEN.             07750440
P10237     PERFORM DP031-0000-PROTG-TOKEN-DETOKEN.                      07750540
P10237     IF CSI-RETURN-CODE NOT = ZERO                                07750600
P10237        DISPLAY 'ABEND IN THE FOLLOWING RECORD'                   07750700
P10237        DISPLAY 'PARTITION NUMBER     - ' EPTRN-PARTN-NBR         07750800
P10237        DISPLAY 'STORE NUMBER         - ' EPTRN-STR-NBR           07750900
P10237        DISPLAY 'REGISTER-ID          - ' EPTRN-RGST-ID           07751000
P10237        DISPLAY 'TRANSACTION NUMBER   - ' EPTRN-TRN-NBR           07751100
P10237        DISPLAY 'TOKENIZED TENDER-ID  - ' EPTND-TNDR-ID           07751300
P10237        DISPLAY 'TENDER-ID LENGTH NBR - ' EPTND-TNDR-ID-LEN-NBR   07751400
P10237        PERFORM DP031-9999-ABEND                                  07751540
P10237     ELSE                                                         07751600
P10237        MOVE DP031-CLEAR-TEXT     TO EPTND-TNDR-ID                07751740
P10237     END-IF.                                                      07751800
P10237                                                                  07751900
063300******************************************************************07752000
063400* 3000-PRINT-SYSOUT-TOTALS                                        07752100
063500*     CLOSE TEPDKEY CURSOR,                                       07753000
063600*     PRINT REPORT TOTALS (IF DATA WAS PRESENT & REPORT CREATED), 07754000
063700*     CLOSE REPORT FILE.                                          07755000
063800******************************************************************07756000
063900 3000-PRINT-SYSOUT-TOTALS.                                        07757000
064000                                                                  07758000
064100     PERFORM 1500-DISPLAY-PROGRAM-TOTALS.                         07760000
064200                                                                  07770000
064300     CLOSE SV-ACTIVITY-EXTR-FILE.                                 07780000
064400                                                                  07790000
064500******************************************************************07800000
064600*  BUILD AND WRITE KOHL'S MERCHANDISE RETURN CREDIT ACTIVITY     *07810000
064700*  EXTRACT RECORD(S) FOR AN ISSUANCE OR TENDER OCCURRANCE.       *07820000
065100******************************************************************07860000
065200                                                                  07870000
065300 4000-BUILD-KMRC-ACTV-EXTRACT.                                    07880000
065400     INITIALIZE SV021-POS-ACTIVITY-RECORD.                        07890000
065500                                                                  07900000
065600     SET SV021-CRD-TYP-KMRC         TO TRUE.                      07910000
065700     PERFORM 5660-MOVE-TNDR-ID.                                   07920000
065800     MOVE SV007-CARD-NBR TO SV021-CRD-NBR                         07930000
065800                            PV-CRD-NBR.                           07940000
065900     MOVE EPTRN-SLS-DTE   TO SV021-POS-DTE.                       07950000
066000     MOVE EPTRN-STR-NBR      TO SV021-STR-NBR.                    07960000
066100     MOVE EPTRN-RGST-ID   TO SV021-TRMNL-NBR.                     07970000
066200     MOVE EPTRN-TRN-NBR TO SV021-TRN-NBR.                         07980000
066210     MOVE EPTRN-TRN-STAT-CDE TO SV021-TRN-STAT-CDE.               07990000
066300     COMPUTE SV021-APP-AUTH-AMT = EPTND-TNDR-AMT * -1.            08000000
066400     MOVE SV021-APP-AUTH-AMT   TO SV021-ORIG-AUTH-AMT.            08010000
066500                                                                  08020000
066600     EVALUATE EPTRN-VOID-ABRT-CDE                                 08030000
066700         WHEN 'N'                                                 08040000
066800             IF EPTRN-TRN-STAT-CDE = 'R'                          08050000
066900                 SET SV021-TRN-VOID TO TRUE                       08060000
067000             ELSE                                                 08070000
067100                 SET SV021-TRN-NOT-VOID TO TRUE                   08080000
067200             END-IF                                               08090000
067300         WHEN OTHER                                               08100000
067400             SET SV021-TRN-NOT-VOID TO TRUE                       08110000
067500     END-EVALUATE.                                                08120000
067600                                                                  08130000
067700     MOVE ZERO             TO SV021-TRN-RVRSL-CDE.                08140000
067800     PERFORM 5650-GET-SV-CARD-TENDER-DATA.                        08150000
067900     IF EPSVC-REQ-TYP-CDE = 'I'                                   08160000
068000         IF PS-REFUND-AUTH-PRESENT                                08170000
P10237             MOVE EPRFA-DRV-LIC-NBR     TO SV021-DRV-LIC-NBR      08180000
070100         ELSE                                                     08380000
070200             MOVE SPACES                TO SV021-DRV-LIC-NBR      08390000
070300         END-IF                                                   08400000
070400     ELSE                                                         08410000
070500         MOVE SPACES                TO SV021-DRV-LIC-NBR          08420000
070600     END-IF.                                                      08430000
070700*                                                                 08440000
070800*  ACTIVITY STATUS CANNOT BE DETERMINED UNTIL POSTING.            08450000
070900*                                                                 08460000
071000     IF EPSVC-REQ-TYP-CDE = 'I'                                   08470000
071100         MOVE 1 TO SV021-ACTVY-TYP-CDE                            08480000
071200     ELSE                                                         08490000
071300         IF EPSVC-REQ-TYP-CDE = 'T'                               08500000
071400             MOVE 3 TO SV021-ACTVY-TYP-CDE                        08510000
071500         ELSE                                                     08520000
071600             IF SV021-APP-AUTH-AMT < 0                            08530000
071700                 MOVE 3 TO SV021-ACTVY-TYP-CDE                    08540000
071800             ELSE                                                 08550000
071900                 MOVE 1 TO SV021-ACTVY-TYP-CDE                    08560000
072000             END-IF                                               08570000
072100         END-IF                                                   08580000
072200     END-IF.                                                      08590000
087900                                                                  08600000
072400     MOVE EPTRN-ASSOC-ID TO SV021-POS-OPER-ID.                    08610000
087900     PERFORM 5500-TEPORD-PROCESSING                               08620000
072600                                                                  08630000
BOPUS *    AFS STANDS FOR SFS AND THIS WILL BE CHANGED BACK IN SVKRP024 08631000
BOPUS *    IT IS NEEDED FOR SORTING PURPOSES IN SVSR064 AND THE ROLLUP  08632000
BOPUS      IF PS-OMNI-CHNL-YES                                          08640000
BOPUS         MOVE EPTRN-OMNI-CHNL-FFLMT-TYP-CDE                        08650000
BOPUS                               TO PV-HOLD-OMNI-CHNL                08651000
BOPUS         IF PV-HOLD-OMNI-CHNL = 'SFS'                              08652000
BOPUS            MOVE 'AFS'              TO SV021-OMNI-CHNL-FFLMT       08660000
BOPUS         ELSE                                                      08660200
BOPUS            MOVE PV-HOLD-OMNI-CHNL  TO SV021-OMNI-CHNL-FFLMT       08660300
BOPUS         END-IF                                                    08661000
BOPUS      ELSE                                                         08670000
BOPUS         MOVE SPACES      TO SV021-OMNI-CHNL-FFLMT                 08680000
BOPUS      END-IF.                                                      08681000
BOPUS      SET PS-OMNI-CHNL-NO TO TRUE.                                 08681100
072500     SET SV021-NOT-OVER TO TRUE.                                  08682000
072600                                                                  08683000
072700     PERFORM 8000-WRITE-SV-EXTRACT-RECORD.                        08684000
072800                                                                  08685000
072900     IF  (EPTRN-VOID-ABRT-CDE = 'N'                               08686000
073000             OR  EPTRN-TRN-STAT-CDE = 'V' OR 'R' OR 'L')          08687000
073100         CONTINUE                                                 08688000
073200     ELSE                                                         08689000
073300         COMPUTE SV021-APP-AUTH-AMT =                             08690000
073400                   (SV021-APP-AUTH-AMT * (-1))                    08700000
073500         COMPUTE SV021-ORIG-AUTH-AMT =                            08710000
073600                   (SV021-ORIG-AUTH-AMT * (-1))                   08720000
073700         SET SV021-TRN-VOID TO TRUE                               08730000
073800         PERFORM 8000-WRITE-SV-EXTRACT-RECORD                     08740000
073900     END-IF.                                                      08750000
074000*4000-EXIT.                                                       08760000
074100                                                                  08770000
074200******************************************************************08780000
074300*  BUILD AND WRITE KOHL'S GIFT CARD ACTIVITY EXTRACT RECORD(S)   *08790000
074400*  FOR A TENDER OCCURANCE.                                       *08800000
074500*                                                                *08810000
074600******************************************************************08820000
074700                                                                  08830000
074800 5000-BUILD-GIFT-TNDR-ACTV-EXT.                                   08840000
074900     INITIALIZE SV021-POS-ACTIVITY-RECORD.                        08850000
075000                                                                  08860000
075100     SET SV021-CRD-TYP-GIFT         TO TRUE.                      08870000
075200     PERFORM 5660-MOVE-TNDR-ID.                                   08880000
075300     MOVE SV007-CARD-NBR TO SV021-CRD-NBR                         08890000
065800                            PV-CRD-NBR.                           08900000
075400     MOVE EPTRN-SLS-DTE   TO SV021-POS-DTE.                       08910000
075500     MOVE EPTRN-STR-NBR      TO SV021-STR-NBR.                    08920000
075600     MOVE EPTRN-RGST-ID   TO SV021-TRMNL-NBR.                     08930000
075700     MOVE EPTRN-TRN-NBR TO SV021-TRN-NBR.                         08940000
075800     COMPUTE SV021-APP-AUTH-AMT = EPTND-TNDR-AMT * -1.            08950000
075900     MOVE SV021-APP-AUTH-AMT   TO SV021-ORIG-AUTH-AMT.            08960000
075910     MOVE EPTRN-TRN-STAT-CDE   TO SV021-TRN-STAT-CDE.             08970000
076000     EVALUATE EPTRN-VOID-ABRT-CDE                                 08980000
076100         WHEN 'N'                                                 08990000
076200             IF EPTRN-TRN-STAT-CDE = 'R'                          09000000
076300                 SET SV021-TRN-VOID TO TRUE                       09010000
076400             ELSE                                                 09020000
076500                 SET SV021-TRN-NOT-VOID TO TRUE                   09030000
076600             END-IF                                               09040000
076700         WHEN OTHER                                               09050000
076800             SET SV021-TRN-NOT-VOID TO TRUE                       09060000
076900     END-EVALUATE.                                                09070000
077000     MOVE ZERO             TO SV021-TRN-RVRSL-CDE.                09080000
077100     MOVE SPACES               TO SV021-DRV-LIC-NBR.              09090000
077200*                                                                 09100000
077300*  ACTIVITY STATUS CANNOT BE DETERMINED UNTIL POSTING.            09110000
077400*                                                                 09120000
077500*    TENDER REQUEST TYPE SHOULD BE A 3 FOR A TENDER OF A GIFT CARD09130000
077600     PERFORM 5650-GET-SV-CARD-TENDER-DATA.                        09140000
077700     IF EPSVC-REQ-TYP-CDE = 'I'                                   09150000
077800         MOVE 1 TO SV021-ACTVY-TYP-CDE                            09160000
077900     ELSE                                                         09170000
078000         IF EPSVC-REQ-TYP-CDE = 'T'                               09180000
078100             MOVE 3 TO SV021-ACTVY-TYP-CDE                        09190000
078200         ELSE                                                     09200000
078300             IF SV021-APP-AUTH-AMT < 0                            09210000
078400                 MOVE 3 TO SV021-ACTVY-TYP-CDE                    09220000
078500             ELSE                                                 09230000
078600                 MOVE 1 TO SV021-ACTVY-TYP-CDE                    09240000
078700             END-IF                                               09250000
078800         END-IF                                                   09260000
078900     END-IF.                                                      09270000
079000                                                                  09280000
072400     MOVE EPTRN-ASSOC-ID TO SV021-POS-OPER-ID.                    09290000
079000                                                                  09300000
065300     PERFORM 5500-TEPORD-PROCESSING.                              09310000
079300                                                                  09320000
BOPUS *    AFS STANDS FOR SFS AND THIS WILL BE CHANGED BACK IN SVKRP024 09320100
BOPUS *    IT IS NEEDED FOR SORTING PURPOSES IN SVSR064 AND THE ROLLUP  09320200
BOPUS      IF PS-OMNI-CHNL-YES                                          09321000
BOPUS         MOVE EPTRN-OMNI-CHNL-FFLMT-TYP-CDE                        09321100
BOPUS                               TO PV-HOLD-OMNI-CHNL                09321200
BOPUS         IF PV-HOLD-OMNI-CHNL = 'SFS'                              09321400
BOPUS            MOVE 'AFS'              TO SV021-OMNI-CHNL-FFLMT       09321500
BOPUS         ELSE                                                      09321700
BOPUS            MOVE PV-HOLD-OMNI-CHNL  TO SV021-OMNI-CHNL-FFLMT       09321800
BOPUS         END-IF                                                    09322000
BOPUS      ELSE                                                         09322100
BOPUS         MOVE SPACES      TO SV021-OMNI-CHNL-FFLMT                 09322200
BOPUS      END-IF.                                                      09326000
BOPUS      SET PS-OMNI-CHNL-NO TO TRUE.                                 09326100
BOPUS                                                                   09327000
079200     SET SV021-NOT-OVER TO TRUE.                                  09330000
079300                                                                  09340000
079400     PERFORM 8000-WRITE-SV-EXTRACT-RECORD.                        09350000
079500                                                                  09360000
079600     IF  (EPTRN-VOID-ABRT-CDE = 'N'                               09370000
079700             OR  EPTRN-TRN-STAT-CDE = 'V' OR 'R' OR 'L')          09380000
079800         CONTINUE                                                 09390000
079900     ELSE                                                         09400000
080000         COMPUTE SV021-APP-AUTH-AMT =                             09410000
080100                   (SV021-APP-AUTH-AMT * (-1))                    09420000
080200         COMPUTE SV021-ORIG-AUTH-AMT =                            09430000
080300                   (SV021-ORIG-AUTH-AMT * (-1))                   09440000
080400         SET SV021-TRN-VOID TO TRUE                               09450000
080500         PERFORM 8000-WRITE-SV-EXTRACT-RECORD                     09460000
080600     END-IF.                                                      09470000
080700*5000-EXIT.                                                       09480000
080800******************************************************************09490000
080900*  BUILD AND WRITE KOHL'S GIFT CARD ACTIVITY EXTRACT RECORD(S)   *09500000
081000*  FOR AN ISSUANCE OCCURANCE.                                    *09510000
081100*                                                                *09520000
081200******************************************************************09530000
081300                                                                  09540000
081400 5100-BUILD-GIFT-ISU-ACTV-EXT.                                    09550000
081500     INITIALIZE SV021-POS-ACTIVITY-RECORD.                        09560000
081600     SET SV021-CRD-TYP-GIFT         TO TRUE.                      09570000
081700     MOVE EPITM-MDSE-ID             TO SV007-CARD-NUMBER-IN.      09580000
081800     MOVE 0                         TO SV007-CARD-NUMBER-LENGTH.  09590000
081900     PERFORM SV007-FORMAT-CARD.                                   09600000
082000     MOVE SV007-CARD-NBR            TO SV021-CRD-NBR              09610000
082000                                       PV-CRD-NBR.                09620000
082100     MOVE EPTRN-SLS-DTE             TO SV021-POS-DTE.             09630000
082200     MOVE EPTRN-STR-NBR             TO SV021-STR-NBR.             09640000
082300     MOVE EPTRN-RGST-ID             TO SV021-TRMNL-NBR.           09650000
082400     MOVE EPTRN-TRN-NBR                TO SV021-TRN-NBR.          09660000
082500     MOVE EPITM-CUST-CHRGD-AMT           TO SV021-APP-AUTH-AMT    09670000
082600                                         SV021-ORIG-AUTH-AMT.     09680000
082610     MOVE EPTRN-TRN-STAT-CDE        TO SV021-TRN-STAT-CDE.        09690000
082700     EVALUATE EPTRN-VOID-ABRT-CDE                                 09700000
082800         WHEN 'N'                                                 09710000
082900             IF EPTRN-TRN-STAT-CDE = 'R'                          09720000
083000                 SET SV021-TRN-VOID TO TRUE                       09730000
083100             ELSE                                                 09740000
083200                 SET SV021-TRN-NOT-VOID TO TRUE                   09750000
083300             END-IF                                               09760000
083400         WHEN OTHER                                               09770000
083500             SET SV021-TRN-NOT-VOID TO TRUE                       09780000
083600     END-EVALUATE.                                                09790000
083700                                                                  09800000
083800     MOVE SV004-REV-CDE-NORMAL TO SV021-TRN-RVRSL-CDE.            09810000
083900                                                                  09820000
084000     MOVE SPACES                      TO SV021-DRV-LIC-NBR.       09830000
084100*                                                                 09840000
084200*  ACTIVITY STATUS CANNOT BE DETERMINED UNTIL POSTING.            09850000
084300*                                                                 09860000
084400*    ISSUE REQUEST TYPE SHOULD BE A 2 FOR AN ISSUE OF A GIFT CARD 09870000
084500     MOVE SV004-ISSUE-GIFT-CRD-ACT-TYP-N TO SV021-ACTVY-TYP-CDE.  09880000
084600     MOVE EPTRN-ASSOC-ID                 TO SV021-POS-OPER-ID.    09890000
084700     SET SV021-NOT-OVER TO TRUE.                                  09900000
084800                                                                  09910000
065300     PERFORM 5500-TEPORD-PROCESSING.                              09920000
084800                                                                  09930000
BOPUS *    AFS STANDS FOR SFS AND THIS WILL BE CHANGED BACK IN SVKRP024 09930100
BOPUS *    IT IS NEEDED FOR SORTING PURPOSES IN SVSR064 AND THE ROLLUP  09930200
BOPUS      IF PS-OMNI-CHNL-YES                                          09931000
BOPUS         MOVE EPTRN-OMNI-CHNL-FFLMT-TYP-CDE                        09931100
BOPUS                               TO PV-HOLD-OMNI-CHNL                09931200
BOPUS         IF PV-HOLD-OMNI-CHNL = 'SFS'                              09931400
BOPUS            MOVE 'AFS'              TO SV021-OMNI-CHNL-FFLMT       09931500
BOPUS         ELSE                                                      09931700
BOPUS            MOVE PV-HOLD-OMNI-CHNL  TO SV021-OMNI-CHNL-FFLMT       09931800
BOPUS         END-IF                                                    09932000
BOPUS      ELSE                                                         09932100
BOPUS         MOVE SPACES      TO SV021-OMNI-CHNL-FFLMT                 09932200
BOPUS      END-IF.                                                      09936000
BOPUS      SET PS-OMNI-CHNL-NO TO TRUE.                                 09936100
BOPUS                                                                   09937000
084900     PERFORM 8000-WRITE-SV-EXTRACT-RECORD.                        09940000
085000                                                                  09950000
085100     IF  (EPTRN-VOID-ABRT-CDE = 'N'                               09960000
085200             OR  EPTRN-TRN-STAT-CDE = 'V' OR 'R' OR 'L')          09970000
085300         CONTINUE                                                 09980000
085400     ELSE                                                         09990000
085500         COMPUTE SV021-APP-AUTH-AMT =                             10000000
085600                   (SV021-APP-AUTH-AMT * (-1))                    10010000
085700         COMPUTE SV021-ORIG-AUTH-AMT =                            10020000
085800                   (SV021-ORIG-AUTH-AMT * (-1))                   10030000
085900         SET SV021-TRN-VOID TO TRUE                               10040000
086000         PERFORM 8000-WRITE-SV-EXTRACT-RECORD                     10050000
086100     END-IF.                                                      10060000
086200*5100-EXIT.                                                       10070000
086300                                                                  10080000
086400******************************************************************10090000
065000*  IF THE ASSOC-ID IS 12345678, 0 OR 1600 GET THE ORDER NUMBER   *10100000
065000*  FROM TEPORD.                                                  *10110000
065100******************************************************************10120000
065300 5500-TEPORD-PROCESSING.                                          10130000
CHG015                                                                  10140000
CHG015     IF PS-IND6-IS-NULL                                           10150000
CHG015         SET PS-OMNI-CHNL-NO      TO TRUE                         10160000
CHG015     ELSE                                                         10170000
CHG015         SET PS-OMNI-CHNL-YES     TO TRUE                         10180000
CHG015     END-IF.                                                      10190000
CHG015                                                                  10200000
087900     MOVE +1 TO PV-SUB.                                           10210000
087900     SET PS-NOT-ECOMM-STR TO TRUE.                                10220000
087900     MOVE SV021-STR-NBR TO PV-STORE-NBR.                          10230000
087900     PERFORM 8100-ECOMM-STR UNTIL PV-SUB > PV-MAX-STORE.          10240000
CHG015     IF PS-ECOMM-STR OR PS-OMNI-CHNL-YES                          10250000
087900        MOVE SPACES         TO PV-ORD-NBR-VAR                     10260000
087900                               PV-ORDER-NBR-TEXT                  10270000
087900        MOVE ZEROES         TO PV-ORDER-NBR                       10280000
BOPUS                                PV-HOLD-ORD-NBR                    10290000
087900        PERFORM 7640-SELECT-TEPORD-ROW                            10300000
087900        IF SQLCODE = +0                                           10310000
087900           MOVE EPORD-ORD-NBR-TEXT                                10320000
087900                              TO PV-ORDER-NBR-TEXT                10330000
087900           STRING                                                 10340000
087900                PV-ORDER-NBR-TEXT          DELIMITED BY SIZE      10350000
087900                  INTO PV-ORDER-NBR                               10360000
087900           MOVE PV-ORDER-NBR TO PV-ORD-NBR                        10370000
BOPUS            IF PV-ORD-NBR-1 NOT NUMERIC                            10380000
BOPUS               MOVE PV-ORD-NBR-N TO SV021-ORD-NBR                  10390000
BOPUS            ELSE                                                   10400000
BOPUS               MOVE PV-ORD-NBR-N TO PV-HOLD-ORD-1                  10410000
BOPUS               MOVE PV-ORD-NBR-1 TO PV-HOLD-ORD-2                  10420000
BOPUS               MOVE PV-HOLD-ORD-NBRN TO SV021-ORD-NBR              10421000
BOPUS            END-IF                                                 10422000
CHG015           IF PS-OMNI-CHNL-YES                                    10423000
CHG015              MOVE PV-SFS-DFLT-STR-NBR TO SV021-STR-NBR           10424000
CHG015           END-IF                                                 10425000
087900        END-IF                                                    10426000
087900     END-IF.                                                      10427000
CHG015                                                                  10428000
CHG015                                                                  10429000
086400******************************************************************10430000
086500* 5650-GET-SV-CARD-TENDER-DATA                                    10440000
086600* GIFT CERTIFICATE TENDER TYPE COULD BE A GIFT CARD.              10450000
086700*  1. SEE IF A ROW EXISTS ON THE STORED VALUE CARD TENDER TABLE.  10460000
086800* NOTE: MERCHANDISE CARD TENDER TYPE MUST HAVE A TEPSVC ROW       10470000
086900******************************************************************10480000
087000 5650-GET-SV-CARD-TENDER-DATA.                                    10490000
087100                                                                  10500000
087200     EVALUATE TRUE                                                10510000
087300         WHEN EPTND-TNDR-TYP-CDE = '02'                           10520000
087400             SET PS-NOT-FOUND-IS-ABEND TO TRUE                    10530000
087500         WHEN EPTND-TNDR-TYP-CDE = '13'                           10540000
087600             SET PS-NOT-FOUND-IS-OK    TO TRUE                    10550000
087700     END-EVALUATE.                                                10560000
087800                                                                  10570000
087900     PERFORM 7630-SELECT-TEPSVC-ROW.                              10580000
088000                                                                  10590000
088100******************************************************************10600000
088200* 5660-MOVE-TNDR-ID                                               10610000
088300*  IN THE COSA DATABASE:                                          10620000
088400*  1. TENDER ID IS LEFT JUSTIFIED.                                10630000
088500*  2. TENDER ID LENGTH IS ACTUAL NUMBER OF SIGNIFICANT DIGITS.    10640000
088600* EXTRACT TENDER ID FOR CARD NUMBER CONVERSION                    10650000
088700*************************************************************     10660000
088800 5660-MOVE-TNDR-ID.                                               10670000
088900                                                                  10680000
089000     IF EPTND-TNDR-ID-LEN-NBR = 16                                10690000
089100         MOVE EPTND-TNDR-ID(2:15) TO SV007-CARD-NUMBER-IN         10700000
089200     ELSE                                                         10710000
089300         MOVE EPTND-TNDR-ID(1:EPTND-TNDR-ID-LEN-NBR)              10720000
089400                                  TO SV007-CARD-NUMBER-IN         10730000
089500     END-IF.                                                      10740000
089600                                                                  10750000
089700     MOVE EPTND-TNDR-ID-LEN-NBR TO SV007-CARD-NUMBER-LENGTH.      10760000
089800                                                                  10770000
089900     PERFORM SV007-FORMAT-CARD.                                   10780000
090000                                                                  10790000
090100******************************************************************10800000
090200* 7000-OPEN-TEPTRN-CURSOR                                         10810000
090300******************************************************************10820000
090400 7000-OPEN-TEPTRN-CURSOR.                                         10830000
090500     EXEC SQL                                                     10840000
090600          OPEN TEPTRN-CURSOR                                      10850000
090700     END-EXEC.                                                    10860000
090800                                                                  10870000
090900     EVALUATE TRUE                                                10880000
091000         WHEN SQLCODE = ZERO                                      10890000
091100              CONTINUE                                            10900000
091200         WHEN SQLWARN0 NOT EQUAL SPACE                            10910000
091300         WHEN SQLCODE NOT EQUAL ZERO                              10920000
091400             MOVE '7000-OPEN-TEPTRN-CURSOR'                       10930000
091500                                            TO PV-PARAGRAPH-NAME  10940000
091600             MOVE 'ERROR ON OPEN OF TEPTRN-CURSOR'                10950000
091700                                            TO PV-DB2-OPERATION   10960000
091800             PERFORM 9100-SQL-ABEND                               10970000
091900     END-EVALUATE.                                                10980000
092000                                                                  10990000
092100******************************************************************11000000
092200* 7010-FETCH-TEPTRN-CURSOR                                        11010000
092300******************************************************************11020000
092400 7010-FETCH-TEPTRN-CURSOR.                                        11030000
CHG015                                                                  11040000
CHG015     MOVE 0 TO PS-NULL-IND6.                                      11050000
CHG015     MOVE SPACES TO EPTRN-OMNI-CHNL-FFLMT-TYP-CDE.                11060000
CHG015                                                                  11070000
092500     EXEC SQL                                                     11080000
092600          FETCH TEPTRN-CURSOR                                     11090000
092700           INTO :EPTRN-PARTN-NBR                                  11100000
092800               ,:EPTRN-STR-NBR                                    11110000
092900               ,:EPTRN-RGST-ID                                    11120000
093000               ,:EPTRN-TRN-NBR                                    11130000
093100               ,:EPTRN-STRT-TM                                    11140000
093200               ,:EPTRN-SLS-CORR-SEQ-NBR                           11150000
093300               ,:EPTRN-VOID-ABRT-CDE                              11160000
093400               ,:EPTRN-TRN-STAT-CDE                               11170000
093500               ,:EPTRN-SLS-DTE                                    11180000
093600               ,:EPTRN-ASSOC-ID                                   11190000
CHG015               ,:EPTRN-OMNI-CHNL-FFLMT-TYP-CDE :PS-NULL-IND6      11200000
093700               ,:EPTND-TNDR-SEQ-NBR                               11210000
093800               ,:EPTND-TNDR-TYP-CDE                               11220000
093900               ,:EPTND-TNDR-ID                                    11230000
094000               ,:EPTND-TNDR-AMT                                   11240000
094100               ,:EPTND-TNDR-ID-LEN-NBR                            11250000
094200     END-EXEC.                                                    11260000
094300                                                                  11270000
094400     EVALUATE TRUE                                                11280000
094500         WHEN SQLCODE = ZERO                                      11290000
094600             CONTINUE                                             11300000
094700         WHEN SQLCODE = PC-ROW-NOT-FOUND                          11310000
094800             SET PS-END-OF-TEPTRN-CSR TO TRUE                     11320000
094900         WHEN SQLWARN0 NOT EQUAL SPACE                            11330000
095000         WHEN SQLCODE NOT EQUAL ZERO                              11340000
095100             MOVE '7010-FETCH-TEPTRN-CURSOR'                      11350000
095200                                         TO PV-PARAGRAPH-NAME     11360000
095300             MOVE 'ERROR ON FETCH OF TEPTRN-CURSOR'               11370000
095400                                         TO PV-DB2-OPERATION      11380000
095500             PERFORM 9100-SQL-ABEND                               11390000
095600     END-EVALUATE.                                                11400000
095700                                                                  11410000
095800******************************************************************11420000
095900* 7020-CLOSE-TEPTRN-CURSOR                                        11430000
096000******************************************************************11440000
096100 7020-CLOSE-TEPTRN-CURSOR.                                        11450000
096200                                                                  11460000
096300     EXEC SQL                                                     11470000
096400          CLOSE TEPTRN-CURSOR                                     11480000
096500     END-EXEC.                                                    11490000
096600                                                                  11500000
096700     EVALUATE TRUE                                                11510000
096800         WHEN SQLCODE = ZERO                                      11520000
096900              CONTINUE                                            11530000
097000         WHEN SQLWARN0 NOT EQUAL SPACE                            11540000
097100         WHEN SQLCODE NOT EQUAL ZERO                              11550000
097200             MOVE '7020-CLOSE-TEPTRN-CURSOR'                      11560000
097300                                            TO PV-PARAGRAPH-NAME  11570000
097400             MOVE 'ERROR ON CLOSE OF TEPTRN-CURSOR'               11580000
097500                                            TO PV-DB2-OPERATION   11590000
097600             PERFORM 9100-SQL-ABEND                               11600000
097700     END-EVALUATE.                                                11610000
097800                                                                  11620000
097900******************************************************************11630000
098000* 7030-OPEN-TEPDKEY-CURSOR                                        11640000
098100******************************************************************11650000
098200 7030-OPEN-TEPDKEY-CURSOR.                                        11660000
098300     EXEC SQL                                                     11670000
098400          OPEN TEPDKEY-CURSOR                                     11680000
098500     END-EXEC.                                                    11690000
098600                                                                  11700000
098700     EVALUATE TRUE                                                11710000
098800         WHEN SQLCODE = ZERO                                      11720000
098900              CONTINUE                                            11730000
099000         WHEN SQLWARN0 NOT EQUAL SPACE                            11740000
099100         WHEN SQLCODE NOT EQUAL ZERO                              11750000
099200             MOVE '7030-OPEN-TEPDKEY-CURSOR'                      11760000
099300                                            TO PV-PARAGRAPH-NAME  11770000
099400             MOVE 'ERROR ON OPEN OF TEPDKEY-CURSOR'               11780000
099500                                            TO PV-DB2-OPERATION   11790000
099600             PERFORM 9100-SQL-ABEND                               11800000
099700     END-EVALUATE.                                                11810000
099800                                                                  11820000
099900******************************************************************11830000
100000* 7040-FETCH-TEPDKEY-CURSOR                                       11840000
100100******************************************************************11850000
100200 7040-FETCH-TEPDKEY-CURSOR.                                       11860000
CHG015                                                                  11870000
CHG015     MOVE 0 TO PS-NULL-IND6.                                      11880000
CHG015     MOVE SPACES TO EPTRN-OMNI-CHNL-FFLMT-TYP-CDE.                11890000
CHG015                                                                  11900000
100300     EXEC SQL                                                     11910000
100400          FETCH TEPDKEY-CURSOR                                    11920000
100500           INTO :EPTRN-PARTN-NBR                                  11930000
100600               ,:EPTRN-STR-NBR                                    11940000
100700               ,:EPTRN-RGST-ID                                    11950000
100800               ,:EPTRN-TRN-NBR                                    11960000
100900               ,:EPTRN-STRT-TM                                    11970000
101000               ,:EPTRN-SLS-CORR-SEQ-NBR                           11980000
101100               ,:EPTRN-VOID-ABRT-CDE                              11990000
101200               ,:EPTRN-TRN-STAT-CDE                               12000000
101300               ,:EPTRN-SLS-DTE                                    12010000
101400               ,:EPTRN-ASSOC-ID                                   12020000
CHG015               ,:EPTRN-OMNI-CHNL-FFLMT-TYP-CDE :PS-NULL-IND6      12030000
101500               ,:EPTND-TNDR-SEQ-NBR                               12040000
101600               ,:EPTND-TNDR-TYP-CDE                               12050000
101700               ,:EPTND-TNDR-ID                                    12060000
101800               ,:EPTND-TNDR-AMT                                   12070000
101900               ,:EPTND-TNDR-ID-LEN-NBR                            12080000
102000     END-EXEC.                                                    12090000
102100                                                                  12100000
102200     EVALUATE TRUE                                                12110000
102300         WHEN SQLCODE = ZERO                                      12120000
102400             CONTINUE                                             12130000
102500         WHEN SQLCODE = PC-ROW-NOT-FOUND                          12140000
102600             SET PS-END-OF-TEPDKEY-CSR TO TRUE                    12150000
102700         WHEN SQLWARN0 NOT EQUAL SPACE                            12160000
102800         WHEN SQLCODE NOT EQUAL ZERO                              12170000
102900             MOVE '7040-FETCH-TEPDKEY-CURSOR'                     12180000
103000                                         TO PV-PARAGRAPH-NAME     12190000
103100             MOVE 'ERROR ON FETCH OF TEPDKEY-CURSOR'              12200000
103200                                         TO PV-DB2-OPERATION      12210000
103300             PERFORM 9100-SQL-ABEND                               12220000
103400     END-EVALUATE.                                                12230000
103500                                                                  12240000
103600******************************************************************12250000
103700* 7050-CLOSE-TEPDKEY-CURSOR                                       12260000
103800******************************************************************12270000
103900 7050-CLOSE-TEPDKEY-CURSOR.                                       12280000
104000                                                                  12290000
104100     EXEC SQL                                                     12300000
104200          CLOSE TEPDKEY-CURSOR                                    12310000
104300     END-EXEC.                                                    12320000
104400                                                                  12330000
104500     EVALUATE TRUE                                                12340000
104600         WHEN SQLCODE = ZERO                                      12350000
104700              CONTINUE                                            12360000
104800         WHEN SQLWARN0 NOT EQUAL SPACE                            12370000
104900         WHEN SQLCODE NOT EQUAL ZERO                              12380000
105000             MOVE '7050-CLOSE-TEPDKEY-CURSOR'                     12390000
105100                                            TO PV-PARAGRAPH-NAME  12400000
105200             MOVE 'ERROR ON CLOSE OF TEPDKEY-CURSOR'              12410000
105300                                            TO PV-DB2-OPERATION   12420000
105400             PERFORM 9100-SQL-ABEND                               12430000
105500     END-EVALUATE.                                                12440000
105600                                                                  12450000
105700******************************************************************12460000
105800* 7060-OPEN-TEPDKEY-ITM-CURSOR                                    12470000
105900******************************************************************12480000
106000 7060-OPEN-TEPDKEY-ITM-CURSOR.                                    12490000
106100     EXEC SQL                                                     12500000
106200          OPEN TEPDKEY-ITM-CURSOR                                 12510000
106300     END-EXEC.                                                    12520000
106400                                                                  12530000
106500     EVALUATE TRUE                                                12540000
106600         WHEN SQLCODE = ZERO                                      12550000
106700              CONTINUE                                            12560000
106800         WHEN SQLWARN0 NOT EQUAL SPACE                            12570000
106900         WHEN SQLCODE NOT EQUAL ZERO                              12580000
107000             MOVE '7060-OPEN-TEPDKEY-ITM-CURSOR'                  12590000
107100                                            TO PV-PARAGRAPH-NAME  12600000
107200             MOVE 'ERROR ON OPEN OF TEPDKEY-ITM-CURSOR'           12610000
107300                                            TO PV-DB2-OPERATION   12620000
107400             PERFORM 9100-SQL-ABEND                               12630000
107500     END-EVALUATE.                                                12640000
107600                                                                  12650000
107700******************************************************************12660000
107800* 7070-FETCH-TEPDKEY-ITM-CURSOR                                   12670000
107900******************************************************************12680000
108000 7070-FETCH-TEPDKEY-ITM-CURSOR.                                   12690000
CHG015                                                                  12700000
CHG015     MOVE 0 TO PS-NULL-IND6.                                      12710000
CHG015     MOVE SPACES TO EPTRN-OMNI-CHNL-FFLMT-TYP-CDE.                12720000
CHG015                                                                  12730000
108100     EXEC SQL                                                     12740000
108200          FETCH TEPDKEY-ITM-CURSOR                                12750000
108300           INTO :EPTRN-PARTN-NBR                                  12760000
108400               ,:EPTRN-STR-NBR                                    12770000
108500               ,:EPTRN-RGST-ID                                    12780000
108600               ,:EPTRN-TRN-NBR                                    12790000
108700               ,:EPTRN-STRT-TM                                    12800000
108800               ,:EPTRN-SLS-CORR-SEQ-NBR                           12810000
108900               ,:EPTRN-VOID-ABRT-CDE                              12820000
109000               ,:EPTRN-TRN-STAT-CDE                               12830000
109100               ,:EPTRN-SLS-DTE                                    12840000
109200               ,:EPTRN-ASSOC-ID                                   12850000
CHG015               ,:EPTRN-OMNI-CHNL-FFLMT-TYP-CDE :PS-NULL-IND6      12860000
109300               ,:EPITM-MDSE-ID                                    12870000
109400               ,:EPITM-CUST-CHRGD-AMT                             12880000
109500     END-EXEC.                                                    12890000
109600                                                                  12900000
109700     EVALUATE TRUE                                                12910000
109800         WHEN SQLCODE = ZERO                                      12920000
109900             CONTINUE                                             12930000
110000         WHEN SQLCODE = PC-ROW-NOT-FOUND                          12940000
110100             SET PS-END-OF-TEPDKEY-ITM-CSR TO TRUE                12950000
110200         WHEN SQLWARN0 NOT EQUAL SPACE                            12960000
110300         WHEN SQLCODE NOT EQUAL ZERO                              12970000
110400             MOVE '7070-FETCH-TEPDKEY-ITM-CURSOR'                 12980000
110500                                         TO PV-PARAGRAPH-NAME     12990000
110600             MOVE 'ERROR ON FETCH OF TEPDKEY-ITM-CURSOR'          13000000
110700                                         TO PV-DB2-OPERATION      13010000
110800             PERFORM 9100-SQL-ABEND                               13020000
110900     END-EVALUATE.                                                13030000
111000                                                                  13040000
111100******************************************************************13050000
111200* 7080-CLOSE-TEPDKEY-ITM-CURSOR                                   13060000
111300******************************************************************13070000
111400 7080-CLOSE-TEPDKEY-ITM-CURSOR.                                   13080000
111500                                                                  13090000
111600     EXEC SQL                                                     13100000
111700          CLOSE TEPDKEY-ITM-CURSOR                                13110000
111800     END-EXEC.                                                    13120000
111900                                                                  13130000
112000     EVALUATE TRUE                                                13140000
112100         WHEN SQLCODE = ZERO                                      13150000
112200              CONTINUE                                            13160000
112300         WHEN SQLWARN0 NOT EQUAL SPACE                            13170000
112400         WHEN SQLCODE NOT EQUAL ZERO                              13180000
112500             MOVE '7080-CLOSE-TEPDKEY-ITM-CURSOR'                 13190000
112600                                            TO PV-PARAGRAPH-NAME  13200000
112700             MOVE 'ERROR ON CLOSE OF TEPDKEY-ITM-CURSOR'          13210000
112800                                            TO PV-DB2-OPERATION   13220000
112900             PERFORM 9100-SQL-ABEND                               13230000
113000     END-EVALUATE.                                                13240000
113100                                                                  13250000
113200******************************************************************13260000
113300* 7100-OPEN-TEPITM-CURSOR                                         13270000
113400******************************************************************13280000
113500 7100-OPEN-TEPITM-CURSOR.                                         13290000
113600     EXEC SQL                                                     13300000
113700          OPEN TEPITM-CURSOR                                      13310000
113800     END-EXEC.                                                    13320000
113900                                                                  13330000
114000     EVALUATE TRUE                                                13340000
114100         WHEN SQLCODE = ZERO                                      13350000
114200              CONTINUE                                            13360000
114300         WHEN SQLWARN0 NOT EQUAL SPACE                            13370000
114400         WHEN SQLCODE NOT EQUAL ZERO                              13380000
114500             MOVE '7100-OPEN-TEPITM-CURSOR' TO PV-PARAGRAPH-NAME  13390000
114600             MOVE 'ERROR ON OPEN OF TEPITM-CURSOR'                13400000
114700                                            TO PV-DB2-OPERATION   13410000
114800             PERFORM 9100-SQL-ABEND                               13420000
114900     END-EVALUATE.                                                13430000
115000                                                                  13440000
115100******************************************************************13450000
115200* 7110-FETCH-TEPITM-CURSOR                                        13460000
115300******************************************************************13470000
115400 7110-FETCH-TEPITM-CURSOR.                                        13480000
CHG015                                                                  13490000
CHG015     MOVE 0 TO PS-NULL-IND6.                                      13500000
CHG015     MOVE SPACES TO EPTRN-OMNI-CHNL-FFLMT-TYP-CDE.                13510000
CHG015                                                                  13520000
115500     EXEC SQL                                                     13530000
115600          FETCH TEPITM-CURSOR                                     13540000
115700           INTO :EPTRN-PARTN-NBR                                  13550000
115800               ,:EPTRN-STR-NBR                                    13560000
115900               ,:EPTRN-RGST-ID                                    13570000
116000               ,:EPTRN-TRN-NBR                                    13580000
116100               ,:EPTRN-STRT-TM                                    13590000
116200               ,:EPTRN-SLS-CORR-SEQ-NBR                           13600000
116300               ,:EPTRN-VOID-ABRT-CDE                              13610000
116400               ,:EPTRN-TRN-STAT-CDE                               13620000
116500               ,:EPTRN-SLS-DTE                                    13630000
116600               ,:EPTRN-ASSOC-ID                                   13640000
CHG015               ,:EPTRN-OMNI-CHNL-FFLMT-TYP-CDE :PS-NULL-IND6      13650000
116700               ,:EPITM-MDSE-ID                                    13660000
116800               ,:EPITM-CUST-CHRGD-AMT                             13670000
116900     END-EXEC.                                                    13680000
117000                                                                  13690000
117100     EVALUATE TRUE                                                13700000
117200         WHEN SQLCODE = ZERO                                      13710000
117300             CONTINUE                                             13720000
117400         WHEN SQLCODE = PC-ROW-NOT-FOUND                          13730000
117500             SET PS-END-OF-TEPITM-CSR TO TRUE                     13740000
117600         WHEN SQLWARN0 NOT EQUAL SPACE                            13750000
117700         WHEN SQLCODE NOT EQUAL ZERO                              13760000
117800             MOVE '7110-FETCH-TEPITM-CURSOR'                      13770000
117900                                         TO PV-PARAGRAPH-NAME     13780000
118000             MOVE 'ERROR ON FETCH OF TEPITM-CURSOR'               13790000
118100                                         TO PV-DB2-OPERATION      13800000
118200             PERFORM 9100-SQL-ABEND                               13810000
118300     END-EVALUATE.                                                13820000
118400******************************************************************13830000
118500* 7120-CLOSE-TEPITM-CURSOR                                        13840000
118600******************************************************************13850000
118700 7120-CLOSE-TEPITM-CURSOR.                                        13860000
118800                                                                  13870000
118900     EXEC SQL                                                     13880000
119000          CLOSE TEPITM-CURSOR                                     13890000
119100     END-EXEC.                                                    13900000
119200                                                                  13910000
119300     EVALUATE TRUE                                                13920000
119400         WHEN SQLCODE = ZERO                                      13930000
119500              CONTINUE                                            13940000
119600         WHEN SQLWARN0 NOT EQUAL SPACE                            13950000
119700         WHEN SQLCODE NOT EQUAL ZERO                              13960000
119800             MOVE '7120-CLOSE-TEPITM-CURSOR'                      13970000
119900                                            TO PV-PARAGRAPH-NAME  13980000
120000             MOVE 'ERROR ON CLOSE OF TEPITM-CURSOR'               13990000
120100                                            TO PV-DB2-OPERATION   14000000
120200             PERFORM 9100-SQL-ABEND                               14010000
120300     END-EVALUATE.                                                14020000
120400                                                                  14030000
120500******************************************************************14040000
120600* 7625-SELECT-TEPRFA-ROW                                          14050000
120700*     REFUND AUTHORIZATION                                        14060000
120800******************************************************************14070000
120900 7625-SELECT-TEPRFA-ROW.                                          14080000
121000                                                                  14090000
121100     SET PS-REFUND-AUTH-NOT-PRESENT TO TRUE.                      14100000
121200                                                                  14110000
121300     EXEC SQL                                                     14120000
121400          SELECT DRV_LIC_NBR                                      14130000
121500          INTO  :EPRFA-DRV-LIC-NBR                                14140000
121600          FROM  TEPRFA                                            14150000
121700          WHERE PARTN_NBR        = :EPTRN-PARTN-NBR               14160000
121800            AND STR_NBR          = :EPTRN-STR-NBR                 14170000
121900            AND RGST_ID          = :EPTRN-RGST-ID                 14180000
122000            AND TRN_NBR          = :EPTRN-TRN-NBR                 14190000
122100            AND STRT_TM          = :EPTRN-STRT-TM                 14200000
122200            AND SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR        14210000
122300          WITH UR                                                 14220000
122400     END-EXEC.                                                    14230000
122500     EVALUATE TRUE                                                14240000
122600         WHEN SQLCODE = ZERO                                      14250000
122700             SET PS-REFUND-AUTH-PRESENT TO TRUE                   14260000
122800         WHEN SQLCODE = PC-ROW-NOT-FOUND                          14270000
122900             CONTINUE                                             14280000
123000         WHEN SQLWARN0 NOT EQUAL SPACE                            14290000
123100         WHEN SQLCODE NOT EQUAL ZERO                              14300000
123200             MOVE '7625-SELECT-TEPRFA-ROW'                        14310000
123300                                        TO PV-PARAGRAPH-NAME      14320000
123400             MOVE 'ERROR ON SELECT FROM TEPRFA  '                 14330000
123500                                        TO PV-DB2-OPERATION       14340000
123600             PERFORM 9100-SQL-ABEND                               14350000
123700     END-EVALUATE.                                                14360000
123800                                                                  14370000
123900******************************************************************14380000
124000******************************************************************14390000
124100* 7630-SELECT-TEPSVC-ROW                                          14400000
124200*                                                                 14410000
124300*     SELECT STORED VALUE CARD TENDER                             14420000
124400******************************************************************14430000
124500 7630-SELECT-TEPSVC-ROW.                                          14440000
124600                                                                  14450000
124700     EXEC SQL                                                     14460000
124800          SELECT REQ_TYP_CDE                                      14470000
124900          INTO  :EPSVC-REQ-TYP-CDE                                14480000
125000          FROM  TEPSVC                                            14490000
125100          WHERE PARTN_NBR        = :EPTRN-PARTN-NBR               14500000
125200            AND STR_NBR          = :EPTRN-STR-NBR                 14510000
125300            AND RGST_ID          = :EPTRN-RGST-ID                 14520000
125400            AND TRN_NBR          = :EPTRN-TRN-NBR                 14530000
125500            AND STRT_TM          = :EPTRN-STRT-TM                 14540000
125600            AND SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR        14550000
125700            AND TNDR_SEQ_NBR     = :EPTND-TNDR-SEQ-NBR            14560000
125800          WITH UR                                                 14570000
125900     END-EXEC.                                                    14580000
126000     EVALUATE TRUE                                                14590000
126100         WHEN SQLCODE = ZERO                                      14600000
126200             CONTINUE                                             14610000
126300         WHEN SQLCODE = PC-ROW-NOT-FOUND                          14620000
126400             IF PS-NOT-FOUND-IS-OK                                14630000
126500                 CONTINUE                                         14640000
126600             ELSE                                                 14650000
126700                 MOVE '7630-SELECT-TEPSVC-ROW'                    14660000
126800                                        TO PV-PARAGRAPH-NAME      14670000
126900                 MOVE 'ERROR ON SELECT FROM TEPSVC  '             14680000
127000                                        TO PV-DB2-OPERATION       14690000
127100                 PERFORM 9100-SQL-ABEND                           14700000
127200             END-IF                                               14710000
127300         WHEN SQLWARN0 NOT EQUAL SPACE                            14720000
127400         WHEN SQLCODE NOT EQUAL ZERO                              14730000
127500             MOVE '7630-SELECT-TEPSVC-ROW'                        14740000
127600                                        TO PV-PARAGRAPH-NAME      14750000
127700             MOVE 'ERROR ON SELECT FROM TEPSVC  '                 14760000
127800                                        TO PV-DB2-OPERATION       14770000
127900             PERFORM 9100-SQL-ABEND                               14780000
128000     END-EVALUATE.                                                14790000
128100                                                                  14800000
124000******************************************************************14810000
124100* 7640-SELECT-TEPORD-ROW                                          14820000
124200*                                                                 14830000
124300*     SELECT STORED VALUE CARD ORDER NUMBER IF ECOMM              14840000
124400******************************************************************14850000
124500 7640-SELECT-TEPORD-ROW.                                          14860000
124600     MOVE SPACES TO EPORD-ORD-NBR.                                14870000
124600                                                                  14880000
124700     EXEC SQL                                                     14890000
124800          SELECT ORD_NBR                                          14900000
124900          INTO  :EPORD-ORD-NBR                                    14910000
125000          FROM  TEPORD                                            14920000
125100          WHERE PARTN_NBR        = :EPTRN-PARTN-NBR               14930000
125200            AND STR_NBR          = :EPTRN-STR-NBR                 14940000
125300            AND RGST_ID          = :EPTRN-RGST-ID                 14950000
125400            AND TRN_NBR          = :EPTRN-TRN-NBR                 14960000
125500            AND STRT_TM          = :EPTRN-STRT-TM                 14970000
125600            AND SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR        14980000
125800          WITH UR                                                 14990000
125900     END-EXEC.                                                    15000000
126000     EVALUATE SQLCODE                                             15010000
126100         WHEN ZERO                                                15020000
126200             CONTINUE                                             15030000
126300         WHEN +100                                                15040000
126200             CONTINUE                                             15050000
127400         WHEN OTHER                                               15060000
127500             MOVE '7640-SELECT-TEPORD-ROW'                        15070000
127600                                        TO PV-PARAGRAPH-NAME      15080000
127700             MOVE 'ERROR ON SELECT FROM TEPORD  '                 15090000
127800                                        TO PV-DB2-OPERATION       15100000
127900             PERFORM 9100-SQL-ABEND                               15110000
128000     END-EVALUATE.                                                15120000
128100                                                                  15130000
128200******************************************************************15140000
128300*  WRITE A KOHL'S MERCHANDISE RETURN CREDIT ACTIVITY EXTRACT     *15150000
128400*  RECORD.                                                       *15160000
128500******************************************************************15170000
128600                                                                  15180000
128700 8000-WRITE-SV-EXTRACT-RECORD.                                    15190000
128800     WRITE SV-ACTIVITY-EXTR-RECORD                                15200000
128900         FROM SV021-POS-ACTIVITY-RECORD.                          15210000
129000                                                                  15220000
129100     ADD +1 TO PT-SV-EXTRACT-RCDS-WRITTEN.                        15230000
128900*    INITIALIZE SV021-POS-ACTIVITY-RECORD.                        15240000
129000                                                                  15250000
129200*8000-EXIT.                                                       15260000
129300******************************************************************15270000
129300*    SEARCHES THROUGH THE ECOMMERCE STORE TABLE                  *15280000
129300******************************************************************15290000
129300 8100-ECOMM-STR.                                                  15300000
129300     IF PV-STORE-NBR = PV-ECOMM-STR (PV-SUB)                      15310000
129300         SET PS-ECOMM-STR TO TRUE                                 15320000
129300     END-IF.                                                      15330000
129300     ADD +1 TO PV-SUB.                                            15340000
129300                                                                  15350000
129400******************************************************************15360000
129500******************************************************************15370000
129600* 9100-SQL-ABEND                                                  15380000
129700*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.15390000
129800******************************************************************15400000
129900 9100-SQL-ABEND.                                                  15410000
130000     DISPLAY '** ABEND        **'.                                15420000
130100     DISPLAY '** PROGRAM      ** = ' PC-CURRENT-PROGRAM-NAME.     15430000
130200     DISPLAY '** PARAGRAPH    ** = ' PV-PARAGRAPH-NAME.           15440000
130300     DISPLAY '** OPERATION    ** = ' PV-DB2-OPERATION.            15450000
130400     PERFORM 9110-DISPLAY-KEY-FIELDS.                             15460000
130500                                                                  15470000
130600******************************************************************15480000
130700* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     15490000
130800* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      15500000
130900******************************************************************15510000
131000     COPY DPPD004.                                                15520000
131100                                                                  15530000
131200     SET AC-DB2-ERROR TO TRUE.                                    15540000
131300     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         15550000
131400                                                                  15560000
131500******************************************************************15570000
131600* 9110-DISPLAY-KEY-FIELDS                                         15580000
131700*                                                                 15590000
131800******************************************************************15600000
131900 9110-DISPLAY-KEY-FIELDS.                                         15610000
132000                                                                  15620000
132100     DISPLAY ' '.                                                 15630000
132200     DISPLAY '** KEY FIELDS:  **   '.                             15640000
132300                                                                  15650000
132400     EVALUATE PV-PARA-NBR                                         15660000
132500         WHEN '1200'                                              15670000
132600             DISPLAY 'SLS_DTE  = ' PV-DB2-CCYY-MM-DD              15680000
132700         WHEN OTHER                                               15690000
132800             DISPLAY 'PARTN_NBR           = ' EPTRN-PARTN-NBR     15700000
132900             DISPLAY 'STR_NBR             = ' EPTRN-STR-NBR       15710000
133000             DISPLAY 'RGST_ID             = ' EPTRN-RGST-ID       15720000
133100             DISPLAY 'TRN_NBR             = ' EPTRN-TRN-NBR       15730000
133200             DISPLAY 'STRT_TM             = ' EPTRN-STRT-TM       15740000
133300             MOVE EPTRN-SLS-CORR-SEQ-NBR   TO PV-DISPLAY-SIGNED-4 15750000
133400             DISPLAY 'SLS_CORR_SEQ_NBR    = ' PV-DISPLAY-SIGNED-4 15760000
133500             EVALUATE PV-PARA-NBR                                 15770000
133600                 WHEN '7625'                                      15780000
133700                     MOVE EPTND-TNDR-SEQ-NBR TO PV-DISPLAY-NBR-4  15790000
133800                     DISPLAY 'TNDR_SEQ_NBR    = '                 15800000
133900                                                PV-DISPLAY-NBR-4  15810000
134000             END-EVALUATE                                         15820000
134100     END-EVALUATE.                                                15830000
134200                                                                  15840000
134300*---------------------------------------------------------------  15850000
134400**  CONVERSION OF CARD NUMBER                                     15860000
134500*---------------------------------------------------------------  15870000
134600     COPY SVPD007.                                                15880000
134700******************************************************************15895000
134800* 9999-ABEND                                                      15900000
134900*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  15910000
135000******************************************************************15920000
135100 9999-ABEND.                                                      15930000
135200     DISPLAY '** ABEND           **'.                             15940000
135300     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  15950000
135400     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        15960000
135500     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       15970000
135600     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       15980000
135700     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         15990000
P10237*---------------------------------------------------------------  15991000
P10237** COPY MEMBER DPPD031 CONTAINS STATEMENTS NEEDED TO INVOKE       15992040
P10237** PROTEGRITY MODULE FOR PROTECTION / UNPROTECTION                15993000
P10237*---------------------------------------------------------------  15994000
P10237     COPY DPPD031.                                                15995040
135800******************************************************************16000000
