000110******************************************************************00011001
000120 IDENTIFICATION DIVISION.                                         00012001
000130******************************************************************00013001
000140                                                                  00014001
000150 PROGRAM-ID.    PCKUT014.                                         00015001
000160 AUTHOR.        PATRICK BURKE.                                    00016001
000170 INSTALLATION.  KOHLS.                                            00017001
000180 DATE-WRITTEN   NOVEMBER, 2000.                                   00018001
000190 DATE-COMPILED.                                                   00019001
000191                                                                  00019101
000192******************************************************************00019201
000193*  THIS PROGRAM WILL CREATE A TEMPORARY FILE CONTAINING THE       00019302
000194*  ORDER/PACKSLIP SEQUENCE NUMBER TO BE DELETED FROM THE TSHPSUM  00019402
000195*  TABLE.                                                         00019502
000196******************************************************************00019602
000197******************************************************************00019702
000198 ENVIRONMENT DIVISION.                                            00019802
000199******************************************************************00019902
000200 CONFIGURATION SECTION.                                           00020015
000201                                                                  00020115
000203 SOURCE-COMPUTER.        IBM-3090.                                00020315
000204 OBJECT-COMPUTER.        IBM-3090.                                00020415
000205                                                                  00020515
000206 INPUT-OUTPUT SECTION.                                            00020615
000207                                                                  00020715
000208 FILE-CONTROL.                                                    00020815
000209*                                                                 00020915
000210     SELECT SUMMARY-FILE                                          00021015
000211         ASSIGN TO INP01.                                         00021115
000212                                                                  00021215
000213     SELECT REPORT-FILE                                           00021315
000214         ASSIGN TO OUT01.                                         00021415
000215                                                                  00021515
000216*                                                                 00021615
000218******************************************************************00021802
000219 DATA DIVISION.                                                   00021902
000220******************************************************************00022002
000221*                                                                 00022102
000222 FILE SECTION.                                                    00022215
000223*                                                                 00022315
000224 FD  SUMMARY-FILE                                                 00022415
000225     RECORDING MODE IS F                                          00022515
000226     RECORD CONTAINS 253 CHARACTERS                               00022651
000227     LABEL RECORDS ARE STANDARD                                   00022715
000228     DATA RECORD IS SUMMARY-RECORD.                               00022815
000229 01  EXTRACT-RECORD                 PIC X(253).                   00022951
000230                                                                  00023015
000231 FD  REPORT-FILE                                                  00023115
000232     RECORDING MODE IS F                                          00023215
000233     RECORD CONTAINS 25 CHARACTERS                                00023339
000234     LABEL RECORDS ARE OMITTED                                    00023415
000235     DATA RECORD IS REPORT-RECORD.                                00023515
000236 01  REPORT-RECORD                  PIC X(25).                    00023639
000237*                                                                 00023715
000238******************************************************************00023802
000239 WORKING-STORAGE SECTION.                                         00023902
000240******************************************************************00024002
000241*                                                                 00024102
000242******************************************************************00024202
000243*  DB2 FORMATTED MESSAGE AREA                                     00024302
000244******************************************************************00024402
000245     COPY DPWS004.                                                00024502
000246                                                                  00024602
000247******************************************************************00024702
000248*    COMMUNICATIONS AREA FOR DB2                                  00024802
000249******************************************************************00024902
000250                                                                  00025002
000251     EXEC SQL                                                     00025102
000252          INCLUDE SQLCA                                           00025202
000253     END-EXEC.                                                    00025302
000254                                                                  00025402
000255******************************************************************00025502
000256*                                                                 00025602
000257 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00025702
000258                                                   COMP SYNC.     00025802
000259                                                                  00025902
000260 01  PS-PROGRAM-SWITCHES.                                         00026002
000261     05  PS-END-OF-FILE-SW           PIC X(03)     VALUE 'N'.     00026120
000262         88  PS-END-OF-FILE                        VALUE 'Y'.     00026220
000263     05  PS-FIRST-TIME-SW            PIC X(01)     VALUE 'N'.     00026320
000264         88  PS-FIRST-TIME-YES                     VALUE 'Y'.     00026420
000265         88  PS-FIRST-TIME-NO                      VALUE 'N'.     00026520
000266     05  PS-EOF-SHPSUM-CSR-SW       PIC  X(01)    VALUE 'N'.      00026618
000267         88  PS-EOF-SHPSUM-CSR                     VALUE 'Y'.     00026718
000268         88  PS-MORE-SHPSUM-CSR                    VALUE 'N'.     00026818
000269     05  PS-EOF-PROCESS-SW          PIC  X(01)    VALUE 'N'.      00026902
000270         88  PS-EOF-PROCESS                        VALUE 'Y'.     00027002
000271         88  PS-EOF-PROCESS-NO                     VALUE 'N'.     00027102
000272     05  PS-PACKSLIP-FOUND-SW       PIC  X(01)    VALUE 'N'.      00027220
000273         88  PS-PACKSLIP-FOUND                     VALUE 'Y'.     00027320
000274         88  PS-PACKSLIP-FOUND-NO                  VALUE 'N'.     00027425
000275     05  PS-EOF-TKRPRPM-SW          PIC  X(01)    VALUE 'N'.      00027520
000276         88  PS-EOF-TKRPRPM                        VALUE 'Y'.     00027620
000277         88  PS-EOF-TKRPRPM-NO                     VALUE 'N'.     00027720
000278     05  PS-EOF-SUMMARY-SW          PIC  X(01)    VALUE 'N'.      00027820
000279         88  PS-EOF-SUMMARY-FILE                   VALUE 'Y'.     00027920
000280         88  PS-EOF-SUMMARY-FILE-NO                VALUE 'N'.     00028020
000281     05  PS-ACTIVE-RCVR-SW          PIC  X(01)     VALUE 'N'.     00028157
000282         88  PS-ACTIVE-RCVR                        VALUE 'Y'.     00028257
000283         88  PS-ACTIVE-RCVR-NO                     VALUE 'N'.     00028357
000284                                                                  00028420
000285                                                                  00028520
000286 01  PC-PROGRAM-CONSTANTS.                                        00028620
000287     05  PC-ROW-NOT-FOUND            PIC S9(04)    VALUE +100     00028720
000288                                                   COMP SYNC.     00028820
000289     05  PC-PROGRAM-NAME             PIC  X(08)    VALUE          00028923
000290         'PCKUT014'.                                              00029020
000291     05  PC-CURRENT-OPERATING-COMPANY                             00029120
000292                                     PIC  X(02)    VALUE '03'.    00029220
000293     05  PC-MAX-RETRIES              PIC S9(04)    VALUE +3       00029320
000294                                                   COMP SYNC.     00029420
000295     05  PC-CURRENT-TIMESTAMP        PIC  X(26)    VALUE SPACES.  00029520
000296                                                                  00029620
000297 01  PV-PROGRAM-VARIABLES.                                        00029720
000298     05  PV-SQL-RETURN-CD            PIC 999-.                    00029820
000299     05  PV-CICS-MSG-AREA            PIC  X(80)    VALUE SPACES.  00029920
000300     05  PV-COMMAREA-LENGTH          PIC S9(04)    VALUE +0       00030020
000301                                                   COMP SYNC.     00030120
000302     05  PV-CICS-RESPONSE            PIC S9(9)     VALUE ZERO     00030220
000303                                                   COMP SYNC.     00030320
000304                                                                  00030420
000305     05  PV-MFST-NBR                 PIC  S9(09)   VALUE ZERO     00030520
000306                                                   COMP SYNC.     00030620
000307     05  PV-STR-NBR                  PIC  S9(04)   VALUE ZERO     00030720
000308                                                   COMP.          00030820
000309     05  PV-PO-NBR                   PIC  S9(09)   VALUE ZERO     00030920
000310                                                   COMP.          00031020
000311     05  PV-REC-SEQ-NBR              PIC  S9(09)   VALUE ZERO     00031120
000312                                                   COMP.          00031220
000313     05  PV-NO-OF-LBLS               PIC  S9(04)   VALUE ZERO     00031320
000314                                                   COMP SYNC.     00031420
000315     05  PV-DONE-PROCESSING-SW       PIC  X(01)    VALUE 'N'.     00031520
000316         88  PV-DONE-PROCESSING                    VALUE 'Y'.     00031620
000317     05  PV-ITEM-NBR                 PIC  9(15)    VALUE ZERO.    00031720
000318     05  PV-ABEND-PARAGRAPH          PIC  X(30)    VALUE SPACE.   00031820
000319     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  00031920
000320     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  00032020
000321                                                                  00032120
000322     05  PV-ABEND-CODE               PIC S9(04)    VALUE ZERO     00032220
000323                                                   COMP SYNC.     00032320
000324     05  PV-ABEND-PARA-NAME          PIC X(30)     VALUE SPACES.  00032420
000325     05  PV-DB2-OPERATION-MSG-1      PIC X(40)     VALUE SPACES.  00032520
000326     05  PV-DB2-OPERATION-MSG-2      PIC X(40)     VALUE SPACES.  00032620
000327     05  PV-DB2-TABLE-NAME           PIC X(12)     VALUE SPACES.  00032720
000328     05  PV-SQLCODE                  PIC Z(8)9-.                  00032820
000329                                                                  00032920
000330                                                                  00033020
000331     05  PV-DAYS-TO-DELETE           PIC S9(04)    COMP.          00033129
000332     05  PV-DAYS-TO-DELETE-DSPLY     PIC  9(04).                  00033247
000333                                                                  00033360
000334     05  PV-TSHPSUM-INP-CNT          PIC S9(09)    VALUE ZERO.    00033461
000335     05  PV-TSHPSUM-OUT-CNT          PIC S9(09)    VALUE ZERO.    00033561
000336     05  PV-TSHPSUM-BYP-CNT          PIC S9(09)    VALUE ZERO.    00033661
000337     05  PV-DISP-COUNT               PIC ZZZ,ZZZ,ZZ9.             00033761
000338                                                                  00033860
000339     05  PV-OUTPUT-COUNTER           PIC S9(09)    VALUE ZERO     00033960
000340                                                   COMP SYNC.     00034060
000341     05  PV-OPEN-COUNTER             PIC S9(04)    VALUE ZERO     00034160
000342                                                   COMP SYNC.     00034260
000343     05  PV-CLOSE-COUNTER            PIC S9(04)    VALUE ZERO     00034360
000344                                                   COMP SYNC.     00034460
000345     05  PV-FETCH-COUNTER            PIC S9(04)    VALUE ZERO     00034560
000346                                                   COMP SYNC.     00034660
000347     05  PV-COMMIT-COUNTER           PIC S9(04)    VALUE ZERO     00034760
000348                                                   COMP SYNC.     00034860
000349     05  PV-INSERT-COUNTER           PIC S9(09)    VALUE ZERO     00034960
000350                                                   COMP SYNC.     00035060
000351     05  PV-RETRY-COUNTER           PIC S9(09)    VALUE ZERO      00035160
000352                                                   COMP SYNC.     00035260
000353     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             00035360
000354     05  PV-DISP-PO                  PIC Z(08)9.                  00035460
000355     05  PV-DISP-PKSLP-SEQ           PIC Z(03)9.                  00035560
000356                                                                  00035660
000357     05  PV-DB2-COUNT                PIC S9(09)    VALUE ZERO     00035760
000358                                                   COMP-3.        00035860
000360     05  PV-RECORDS-READ-QTY         PIC S9(07)    COMP-3         00036060
000361                                                   VALUE ZEROS.   00036160
000362     05  PV-RECORDS-WRITE-QTY        PIC S9(07)    COMP-3         00036260
000363                                                   VALUE ZEROS.   00036360
000364     05  PV-FORMAT-DATE.                                          00036460
000365         10  PV-YEAR                 PIC X(4)      VALUE '1999'.  00036560
000366         10  FILLER                  PIC X(1)      VALUE '-'.     00036660
000367         10  PV-MONTH                PIC X(2)      VALUE SPACES.  00036760
000368         10  FILLER                  PIC X(1)      VALUE '-'.     00036860
000369         10  PV-DAY                  PIC X(2)      VALUE SPACES.  00036960
000370                                                                  00037060
000371     05 PV-PREV-DISTHD-ORD-NBR       PIC S9(9) COMP VALUE ZEROS.  00037160
000372     05 PV-ACTV-RCVR                 PIC S9(9) COMP.              00037260
000373                                                                  00037360
000374 01  SD-SYSTEM-DATE.                                              00037460
000375     05  SD-SYSTEM-DATE-YY           PIC  9(02)      VALUE ZERO.  00037560
000376     05  SD-SYSTEM-DATE-MM           PIC  9(02)      VALUE ZERO.  00037660
000377     05  SD-SYSTEM-DATE-DD           PIC  9(02)      VALUE ZERO.  00037760
000378                                                                  00037860
000379 01  ST-SYSTEM-TIME.                                              00037960
000380     05  ST-SYSTEM-HOUR             PIC  9(02)      VALUE ZERO.   00038060
000381     05  ST-SYSTEM-MINUTE           PIC  9(02)      VALUE ZERO.   00038160
000382     05  FILLER                     PIC  9(04)      VALUE ZERO.   00038260
000383                                                                  00038360
000384******************************************************************00038460
000385*    ABEND PROCESSING COPYBOOK.                                   00038560
000386******************************************************************00038660
000387                                                                  00038760
000388     COPY DPWS013.                                                00038860
000389                                                                  00038960
000390     EJECT                                                        00039060
000391******************************************************************00039160
000392*    OUTPUT RECORD LAYOUT.                                        00039260
000393******************************************************************00039360
000394                                                                  00039460
000395     COPY PCRD008.                                                00039560
000396                                                                  00039660
000397******************************************************************00039760
000398*    DB2 AREA FOR THE DC-DISTRIBUTION TRANSACTION HEADER TABLE.   00039860
000399******************************************************************00039960
000400                                                                  00040060
000401     EXEC SQL                                                     00040160
000402         INCLUDE TDISTHD                                          00040260
000403     END-EXEC.                                                    00040360
000404                                                                  00040460
000405******************************************************************00040560
000406*    DB2 AREA FOR THE PARAMETER TABLE.                            00040660
000407******************************************************************00040760
000408                                                                  00040860
000409     EXEC SQL                                                     00040960
000410         INCLUDE TKRPRPM                                          00041060
000411     END-EXEC.                                                    00041160
000412                                                                  00041260
000413******************************************************************00041360
000414*    DB2 AREA FOR THE PACKSLIP TABLE.                             00041460
000415******************************************************************00041560
000416                                                                  00041660
000417     EXEC SQL                                                     00041760
000418         INCLUDE TPKSLIP                                          00041860
000419     END-EXEC.                                                    00041960
000420                                                                  00042060
000421******************************************************************00042160
000422*    DB2 AREA FOR THE TSHPSUM TABLE                               00042260
000423******************************************************************00042360
000424                                                                  00042460
000425     EXEC SQL                                                     00042560
000426         INCLUDE TSHPSUM                                          00042660
000427     END-EXEC.                                                    00042760
000428                                                                  00042860
000429******************************************************************00042960
000430*    DB2 AREA FOR THE TPURCHS TABLE                               00043060
000431******************************************************************00043160
000432                                                                  00043260
000433     EXEC SQL                                                     00043360
000434         INCLUDE TPURCHS                                          00043460
000435     END-EXEC.                                                    00043560
000436                                                                  00043660
000437******************************************************************00043760
000438*    DB2 AREA FOR THE TRECEIV TABLE                               00043860
000439******************************************************************00043960
000440                                                                  00044060
000441     EXEC SQL                                                     00044160
000442         INCLUDE TRECEIV                                          00044260
000443     END-EXEC.                                                    00044360
000444                                                                  00044460
000445******************************************************************00044560
000446*    DECLARATION FOR CURSOR SELECTING ROWS FROM TSHPSUM THAT;     00044660
000447*    - CREATE TIMESTAMP IS <= CURRENT DATE - PV-DAYS-TO-DELETE    00044760
000448*    - PUCHASE ORDER IS COMPLETE.                                 00044860
000449******************************************************************00044960
000450                                                                  00045060
000451     EXEC SQL                                                     00045160
000452         DECLARE  SHPSUM_CSR CURSOR FOR                           00045260
000453          SELECT  DISTINCT                                        00045360
000454                  B.PO_NBR                                        00045460
000455                 ,B.PKSL_SEQ_NBR                                  00045560
000456            FROM  TPURCHS A                                       00045660
000457                 ,TSHPSUM B                                       00045760
000458           WHERE  A.PO_NBR       =  B.PO_NBR                      00045860
000459             AND  A.STATUS_CDE  IN  ('CA','CM')                   00045960
000460             AND  A.VER_STATUS_CDE  = 'A'                         00046060
000461             AND  DATE(B.CRE_TMST) <=                             00046160
000462                     (CURRENT DATE - :PV-DAYS-TO-DELETE DAYS)     00046260
000463           ORDER BY B.PO_NBR                                      00046360
000464                  , B.PKSL_SEQ_NBR                                00046460
000465     END-EXEC.                                                    00046560
000466                                                                  00046660
000467******************************************************************00046760
000468 PROCEDURE DIVISION.                                              00046860
000469******************************************************************00046960
000470*                                                                 00047060
000471******************************************************************00047160
000472* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     00047260
000473*      PROGRAM.                                                   00047360
000474******************************************************************00047460
000475 0000-PROGRAM-MAINLINE.                                           00047560
000476*                                                                 00047660
000477     DISPLAY '**** START OF PCKUT014 ****'.                       00047760
000478     DISPLAY ' '.                                                 00047860
000479                                                                  00047960
000480      PERFORM 1000-INITIALIZE                                     00048060
000481      PERFORM 2000-MAIN-PROCESS                                   00048160
000482              UNTIL PS-EOF-PROCESS                                00048260
000483      PERFORM 9000-END-PROCESS.                                   00048360
000484*                                                                 00048460
000485     STOP RUN.                                                    00048560
000486*                                                                 00048660
000487******************************************************************00048760
000488*  DO FIRST TIME PROGRAM INITIALIZATION TASKS.                    00048860
000489*    -- OPEN FILES                                                00048960
000490******************************************************************00049060
000491 1000-INITIALIZE.                                                 00049160
000492                                                                  00049260
000493     OPEN INPUT  SUMMARY-FILE                                     00049360
000494         OUTPUT  REPORT-FILE.                                     00049460
000495                                                                  00049560
000496     ACCEPT SD-SYSTEM-DATE FROM DATE.                             00049660
000497     ACCEPT ST-SYSTEM-TIME FROM TIME.                             00049760
000498                                                                  00049860
000499*READ FIRST INPUT RECORD.                                         00049960
000500     PERFORM 7000-READ-SUMMARY-FILE.                              00050060
000501                                                                  00050160
000502*                                                                 00050260
000503******************************************************************00050360
000504* 2000-MAIN-PROCESS                                               00050460
000505******************************************************************00050560
000506 2000-MAIN-PROCESS.                                               00050660
000507*                                                                 00050760
000508        PERFORM 2100-PROCESS-INPUT-FILE                           00050860
000509           UNTIL PS-EOF-SUMMARY-FILE.                             00050960
000510*                                                                 00051060
000511     DISPLAY '**** END OF INPUT FILE ****'.                       00051160
000512     DISPLAY ' '.                                                 00051260
000513*                                                                 00051360
000514                                                                  00051460
000515        IF PS-EOF-SUMMARY-FILE                                    00051560
000516            PERFORM 3300-SELECT-DAYS-TO-DELETE                    00051660
000517            PERFORM 3310-OPEN-SHPSUM-CURSOR                       00051760
000518            PERFORM 2200-PROCESS-TSHPSUM-CSR                      00051860
000519              UNTIL PS-EOF-SHPSUM-CSR                             00051960
000520            PERFORM 3330-CLOSE-SHPSUM-CURSOR                      00052060
000521            SET PS-EOF-PROCESS TO TRUE                            00052160
000522        END-IF.                                                   00052260
000523*                                                                 00052360
000524******************************************************************00052460
000525* 2100-PROCESS-INPUT-FILE.                                        00052560
000526******************************************************************00052660
000527 2100-PROCESS-INPUT-FILE.                                         00052760
000528*                                                                 00052860
000529        SET  PS-PACKSLIP-FOUND-NO  TO TRUE.                       00052960
000530                                                                  00053060
000531        IF  DISTHD-ORD-NBR  =  PV-PREV-DISTHD-ORD-NBR             00053160
000532            CONTINUE                                              00053260
000533        ELSE                                                      00053360
000534            PERFORM 3000-SELECT-TSHPSUM                           00053460
000535            IF  PS-PACKSLIP-FOUND                                 00053560
000536                PERFORM 7100-BUILD-OUTPUT-RECORD                  00053660
000537                PERFORM 7200-WRITE-SUMMARY-RECORD                 00053760
000538            ELSE                                                  00053860
000539                SET PS-PACKSLIP-FOUND-NO TO TRUE                  00053960
000540            END-IF                                                00054060
000541        END-IF.                                                   00054160
000542                                                                  00054260
000543        MOVE  DISTHD-ORD-NBR  TO  PV-PREV-DISTHD-ORD-NBR.         00054360
000544                                                                  00054460
000545        PERFORM 7000-READ-SUMMARY-FILE.                           00054560
000546*                                                                 00054660
000547******************************************************************00054760
000548* 2200-PROCESS-TSHPSUM-CSR.                                       00054860
000549******************************************************************00054960
000550 2200-PROCESS-TSHPSUM-CSR.                                        00055060
000551                                                                  00055160
000552     PERFORM 3320-FETCH-SHPSUM-CURSOR                             00055260
000553                                                                  00055360
000554     IF  PS-EOF-SHPSUM-CSR                                        00055460
000555         CONTINUE                                                 00055560
000556     ELSE                                                         00055660
000557         SET  PS-ACTIVE-RCVR-NO  TO  TRUE                         00055760
000558         PERFORM 3340-CHECK-ACTIVE-RCVR                           00055860
000559         IF  PS-ACTIVE-RCVR                                       00055960
000560             ADD  1  TO  PV-TSHPSUM-BYP-CNT                       00056060
000561         ELSE                                                     00056160
000562             ADD  1  TO  PV-TSHPSUM-OUT-CNT                       00056260
000563             PERFORM 7100-BUILD-OUTPUT-RECORD                     00056360
000564             PERFORM 7200-WRITE-SUMMARY-RECORD                    00056460
000565         END-IF                                                   00056560
000566     END-IF.                                                      00056660
000567                                                                  00056760
000568******************************************************************00056860
000569*  CHECK TO SEE IF THERE IS AN ENTRY ON THE TSHPSUM TABLE FOR THE 00056960
000570*  PO/RCVR BEING DELETED FROM TDISTHD TABLE.                      00057060
000571******************************************************************00057160
000572 3000-SELECT-TSHPSUM.                                             00057260
000573                                                                  00057360
000574     EXEC SQL                                                     00057460
000575          SELECT  B.PO_NBR                                        00057560
000576                 ,B.PKSL_SEQ_NBR                                  00057660
000577            INTO  :SHPSUM-PO-NBR                                  00057760
000578                 ,:SHPSUM-PKSL-SEQ-NBR                            00057860
000579            FROM  TPKSLIP A                                       00057960
000580                 ,TSHPSUM B                                       00058060
000581           WHERE  A.PO_NBR       = :DISTHD-ORD-NBR                00058160
000582             AND  A.REC_SEQ_NBR  = :DISTHD-RCVR-SEQ-NBR           00058260
000583             AND  A.VER_STAT_CDE = 'A'                            00058360
000584             AND  A.PO_NBR       = B.PO_NBR                       00058460
000585             AND  A.SEQ_NBR      = B.PKSL_SEQ_NBR                 00058560
000586                                                                  00058660
000587     END-EXEC.                                                    00058760
000588                                                                  00058860
000589     EVALUATE TRUE                                                00058960
000590         WHEN SQLCODE = ZERO                                      00059060
000591         WHEN SQLCODE = -811                                      00059160
000592             SET PS-PACKSLIP-FOUND TO TRUE                        00059260
000593         WHEN SQLCODE = +100                                      00059360
000594             SET PS-PACKSLIP-FOUND-NO TO TRUE                     00059460
000595         WHEN OTHER                                               00059560
000596           MOVE '3000-SELECT-TSHPSUM' TO PV-ABEND-PARA-NAME       00059660
000597           MOVE 'SQL ERROR SELECT TSHPSUM' TO                     00059760
000598                            PV-DB2-OPERATION-MSG-1                00059860
000599                                                                  00059960
000600           PERFORM 9998-SQL-ABEND                                 00060060
000601     END-EVALUATE.                                                00060160
000602                                                                  00060260
000603******************************************************************00060360
000604*  3300-SELECT-DAYS-TO-DELETE.                                    00060460
000605******************************************************************00060560
000606 3300-SELECT-DAYS-TO-DELETE.                                      00060660
000607                                                                  00060760
000608     EXEC SQL                                                     00060860
000609          SELECT  FUNC_QTY                                        00060960
000610            INTO  :PV-DAYS-TO-DELETE                              00061060
000611            FROM  TKRPRPM                                         00061160
000612           WHERE  LOC_ID            = 90                          00061260
000613             AND  INTFC_SYS_CDE     = 'KHL'                       00061360
000614             AND  SYS_PRC_FUNC_CDE  = 'CSUCSM'                    00061460
000615             AND  FUNC_PRC_STAT_CDE = 'AC'                        00061560
000616     END-EXEC.                                                    00061660
000617                                                                  00061760
000618     EVALUATE TRUE                                                00061860
000619         WHEN SQLCODE = ZERO                                      00061960
000620              MOVE PV-DAYS-TO-DELETE  TO PV-DAYS-TO-DELETE-DSPLY  00062060
000621              DISPLAY ' '                                         00062160
000622              DISPLAY '**** DAYS TO DELETE - '                    00062260
000623                      PV-DAYS-TO-DELETE-DSPLY                     00062360
000624              DISPLAY ' '                                         00062460
000625         WHEN SQLCODE = +100                                      00062560
000626              SET PS-EOF-TKRPRPM  TO TRUE                         00062660
000627         WHEN OTHER                                               00062760
000628           MOVE '3300-SELECT-DAYS-TO-DELETE'                      00062860
000629                                    TO PV-ABEND-PARA-NAME         00062960
000630           MOVE 'SQL ERROR SELECT DAYS TO BE DELETED' TO          00063060
000631                                     PV-DB2-OPERATION-MSG-1       00063160
000632                                                                  00063260
000633           PERFORM 9998-SQL-ABEND                                 00063360
000634     END-EVALUATE.                                                00063460
000635                                                                  00063560
000636******************************************************************00063660
000637*  3310-OPEN-SHPSUM-CURSOR.                                       00063760
000638******************************************************************00063860
000639 3310-OPEN-SHPSUM-CURSOR.                                         00063960
000640                                                                  00064060
000641     EXEC SQL                                                     00064160
000642         OPEN SHPSUM_CSR                                          00064260
000643     END-EXEC.                                                    00064360
000644                                                                  00064460
000645     EVALUATE TRUE                                                00064560
000646         WHEN SQLCODE = ZERO                                      00064660
000647             CONTINUE                                             00064760
000648         WHEN OTHER                                               00064860
000649           MOVE '3310-OPEN-SHPSUM-CURSOR'                         00064960
000650                                    TO PV-ABEND-PARA-NAME         00065060
000651           MOVE 'SQL ERROR OPENING CSR' TO                        00065160
000652                                     PV-DB2-OPERATION-MSG-1       00065260
000653                                                                  00065360
000654           PERFORM 9998-SQL-ABEND                                 00065460
000655     END-EVALUATE.                                                00065560
000656                                                                  00065660
000657 3320-FETCH-SHPSUM-CURSOR.                                        00065760
000658******************************************************************00065860
000659*  3320-FETCH-SHPSUM-CURSOR.                                      00065960
000660******************************************************************00066060
000661                                                                  00066160
000662     EXEC SQL                                                     00066260
000663         FETCH SHPSUM_CSR                                         00066360
000664          INTO :SHPSUM-PO-NBR                                     00066460
000665              ,:SHPSUM-PKSL-SEQ-NBR                               00066560
000666     END-EXEC.                                                    00066660
000667                                                                  00066760
000668     EVALUATE TRUE                                                00066860
000669         WHEN SQLCODE = ZERO                                      00066960
000670              ADD  1     TO  PV-TSHPSUM-INP-CNT                   00067061
000672         WHEN SQLCODE = +100                                      00067260
000673              SET PS-EOF-SHPSUM-CSR  TO TRUE                      00067360
000674         WHEN OTHER                                               00067460
000675           MOVE '3320-FETCH-SHPSUM-CURSOR' TO PV-ABEND-PARA-NAME  00067560
000676           MOVE 'SQL ERROR FETCHING DATA' TO                      00067660
000677                            PV-DB2-OPERATION-MSG-1                00067760
000678           PERFORM 9998-SQL-ABEND                                 00067860
000679                                                                  00067913
000680     END-EVALUATE.                                                00068013
000681                                                                  00068113
000682******************************************************************00068219
000683*   CLOSE SHPSUM CURSOR.                                          00068319
000684******************************************************************00068419
000685 3330-CLOSE-SHPSUM-CURSOR.                                        00068526
000686*                                                                 00068619
000687     EXEC SQL                                                     00068719
000688         CLOSE SHPSUM_CSR                                         00068831
000689     END-EXEC.                                                    00068919
000690                                                                  00069019
000691     EVALUATE TRUE                                                00069119
000692         WHEN SQLCODE = ZERO                                      00069219
000693             CONTINUE                                             00069319
000694         WHEN OTHER                                               00069419
000695           MOVE '3330-CLOSE-SHPSUM-CSR' TO PV-ABEND-PARA-NAME     00069519
000696           MOVE 'SQL ERROR CLOSING CURSOR' TO                     00069619
000697                            PV-DB2-OPERATION-MSG-1                00069719
000698             PERFORM 9998-SQL-ABEND                               00069819
000699     END-EVALUATE.                                                00069919
000700                                                                  00070055
000701                                                                  00070155
000702******************************************************************00070255
000703*  CHECK TO SEE IF THERE IS AN ACTIVE RECEIVER FOR THE PACKSLIP   00070355
000704*  SEQUENCE.  IF THERE IS AN ACTIVE PO-RCVR THEN BYPASS THE       00070455
000705*  RECORD.  THIS SHOULD NOT BE DELETED.CVR THEN BYPASS THE        00070555
000706******************************************************************00070655
000707 3340-CHECK-ACTIVE-RCVR.                                          00070755
000708                                                                  00070855
000709     SET  PS-ACTIVE-RCVR-NO    TO TRUE.                           00070955
000710     MOVE ZEROES               TO PV-ACTV-RCVR.                   00071055
000711     MOVE SHPSUM-PO-NBR        TO PKSLIP-PO-NBR.                  00071155
000712     MOVE SHPSUM-PKSL-SEQ-NBR  TO PKSLIP-SEQ-NBR.                 00071255
000713                                                                  00071355
000714     EXEC SQL                                                     00071455
000715          SELECT  COUNT(*)                                        00071555
000716            INTO  :PV-ACTV-RCVR                                   00071655
000717            FROM TPKSLIP A                                        00071755
000718               , TRECEIV B                                        00071855
000719           WHERE A.PO_NBR            = :PKSLIP-PO-NBR             00071955
000720             AND A.SEQ_NBR           = :PKSLIP-SEQ-NBR            00072055
000721             AND A.VER_STAT_CDE      = 'A'                        00072155
000722             AND A.PKSL_STAT_CDE     = 'AC'                       00072255
000723             AND A.PO_NBR            =  B.ORD_NBR                 00072355
000724             AND A.REC_SEQ_NBR       =  B.REC_SEQ_NBR             00072455
000725             AND B.STATUS_CDE       IN ('IP','CM')                00072555
000726           FETCH FIRST 1 ROW ONLY                                 00072655
000727            WITH UR                                               00072755
000728     END-EXEC.                                                    00072855
000729                                                                  00072955
000730     EVALUATE TRUE                                                00073055
000731         WHEN SQLCODE = ZERO                                      00073155
000732              IF  PV-ACTV-RCVR  > 0                               00073255
000733                  SET  PS-ACTIVE-RCVR  TO TRUE                    00073355
000734                  MOVE PKSLIP-PO-NBR   TO PV-DISP-PO              00073455
000735                  MOVE PKSLIP-SEQ-NBR  TO PV-DISP-PKSLP-SEQ       00073555
000736                  DISPLAY ' ROW NOT SELECTED FOR DELETE-'         00073655
000737                          ' HAS ACTIVE RECEIVER: '                00073755
000738                          '  PO-'        PV-DISP-PO               00073855
000739                          '  PKSLP-SEQ-' PV-DISP-PKSLP-SEQ        00073955
000740              END-IF                                              00074055
000741         WHEN SQLCODE = +100                                      00074155
000742              CONTINUE                                            00074255
000743         WHEN OTHER                                               00074355
000744           MOVE '3340-CHECK-ACTIVE-RCVR   '                       00074455
000745                                    TO PV-ABEND-PARA-NAME         00074555
000746           MOVE 'CHECK FOR ACTIVE RECEIVER '                      00074655
000747                                TO   PV-DB2-OPERATION-MSG-1       00074758
000748           MOVE PKSLIP-PO-NBR   TO PV-DISP-PO                     00074855
000749           MOVE PKSLIP-SEQ-NBR  TO PV-DISP-PKSLP-SEQ              00074955
000750           INITIALIZE PV-DB2-OPERATION-MSG-2                      00075055
000751           STRING '  PO-'          PV-DISP-PO                     00075155
000752                  '  PKSLP-SEQ-'   PV-DISP-PKSLP-SEQ              00075255
000753                                   DELIMITED BY SIZE              00075355
000754                              INTO PV-DB2-OPERATION-MSG-2         00075455
000755           PERFORM 9998-SQL-ABEND                                 00075555
000756     END-EVALUATE.                                                00075655
000757                                                                  00075755
000760                                                                  00076055
000761 7000-READ-SUMMARY-FILE.                                          00076155
000762******************************************************************00076255
000763*  READ SUMMARY FILE.                                             00076355
000764******************************************************************00076455
000765*                                                                 00076555
000766     READ SUMMARY-FILE INTO DCLTDISTHD                            00076655
000767        AT END                                                    00076755
000768           SET PS-EOF-SUMMARY-FILE     TO TRUE                    00076855
000769        NOT AT END                                                00076955
000770            MOVE DISTHD-ORD-NBR        TO PV-PO-NBR               00077055
000771            MOVE DISTHD-RCVR-SEQ-NBR   TO PV-REC-SEQ-NBR          00077155
000772            ADD  +1                    TO PV-RECORDS-READ-QTY     00077255
000773     END-READ.                                                    00077355
000774*                                                                 00077455
000775******************************************************************00077555
000776*   BUILD OUTPUT RECORD                                          *00077655
000777******************************************************************00077755
000778 7100-BUILD-OUTPUT-RECORD.                                        00077855
000779*                                                                 00077955
000780     INITIALIZE PC008-CRTN-SUM-RECORD.                            00078055
000781*                                                                 00078155
000782     MOVE SHPSUM-PO-NBR           TO PC008-PO-NBR                 00078255
000783     MOVE SHPSUM-PKSL-SEQ-NBR     TO PC008-SEQ-NBR.               00078355
000784                                                                  00078455
000785******************************************************************00078555
000786*  WRITE SUMMARY RECORD                                          *00078655
000787******************************************************************00078755
000788 7200-WRITE-SUMMARY-RECORD.                                       00078855
000789*                                                                 00078955
000790     WRITE REPORT-RECORD                                          00079055
000791         FROM PC008-CRTN-SUM-RECORD                               00079155
000792                                                                  00079255
000793*    DISPLAY '**********************************'.                00079355
000794*    DISPLAY 'PURCHASE ORDER         = ' PC008-PO-NBR.            00079455
000795*    DISPLAY 'PACKSLIP SEQUENCE NBR  = ' PC008-SEQ-NBR.           00079555
000796*    DISPLAY '**********************************'.                00079655
000797                                                                  00079755
000798     ADD 1                        TO PV-RECORDS-WRITE-QTY.        00079855
000799*                                                                 00079955
000800                                                                  00080055
000801******************************************************************00080155
000802*     CLOSE FILES.                                              **00080255
000803******************************************************************00080355
000804 9000-END-PROCESS.                                                00080455
000805*                                                                 00080555
000806     CLOSE SUMMARY-FILE                                           00080655
000807           REPORT-FILE.                                           00080755
000808                                                                  00080860
000811*                                                                 00081155
000812     DISPLAY '**********************************'.                00081255
000813     DISPLAY '** PCKUT014 SUMMARY **'.                            00081355
000814     DISPLAY 'TOTAL INPUT RECS       = ' PV-RECORDS-READ-QTY.     00081455
000815     DISPLAY 'TOTAL RECS WRITTEN     = ' PV-RECORDS-WRITE-QTY.    00081555
000816     DISPLAY '                         '                          00081660
000817                                                                  00081760
000818     MOVE  PV-TSHPSUM-INP-CNT  TO  PV-DISP-COUNT.                 00081861
000819     DISPLAY 'TSHPSUM CURSOR COUNT   = ' PV-DISP-COUNT.           00081961
000820     MOVE  PV-TSHPSUM-OUT-CNT  TO  PV-DISP-COUNT.                 00082061
000821     DISPLAY 'TSHPSUM OUTPUT COUNT   = ' PV-DISP-COUNT.           00082161
000822     MOVE  PV-TSHPSUM-BYP-CNT  TO  PV-DISP-COUNT.                 00082260
000823     DISPLAY 'TSHPSUM BYPASS COUNT   = ' PV-DISP-COUNT.           00082360
000824     DISPLAY '**********************************'.                00082460
000825*                                                                 00082560
000826******************************************************************00082660
000827*     SQL ERROR PROCESSING                                      **00082760
000828******************************************************************00082860
000829 9998-SQL-ABEND.                                                  00082960
000830     MOVE SQLCODE     TO PV-SQLCODE.                              00083060
000831     DISPLAY '** ABEND           ** = SQLABEND'.                  00083160
000832     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          00083260
000833     DISPLAY '** PARAGRAPH       ** = ' PV-ABEND-PARA-NAME        00083360
000834     DISPLAY '** TABLE AFFECTED  ** = ' PV-DB2-TABLE-NAME.        00083460
000835     DISPLAY '** OPERATION       ** = ' PV-DB2-OPERATION-MSG-1.   00083560
000836     DISPLAY '**                 ** = ' PV-DB2-OPERATION-MSG-2.   00083660
000837     DISPLAY '** SQLCODE         ** = ' PV-SQLCODE.               00083760
000838     COPY DPPD004.                                                00083860
000839                                                                  00083960
000840     MOVE +4013                  TO PV-ABEND-CODE.                00084060
000841     CALL 'ILBOABN0'   USING PV-ABEND-CODE.                       00084160
000850*                                                                 00085055
000900                                                                  00090054
