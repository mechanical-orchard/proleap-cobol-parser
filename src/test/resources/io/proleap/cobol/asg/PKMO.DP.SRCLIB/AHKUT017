000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.    AHKUT017.                                         00020000
000300 AUTHOR.        CHERI MASTEL.                                     00030000
000400 INSTALLATION.  KOHLS.                                            00040000
000500 DATE-WRITTEN   AUG, 1997.                                        00050000
000600 DATE-COMPILED.                                                   00060000
000700                                                                  00070000
000800******************************************************************00080010
000900*   AHKUT017.  "ARCHIVE HISTORY" PROJECT.  EXTRACT PROGRAM.      *00090010
001000*                                                                *00100010
001100*   PURPOSE:                                                     *00110010
001200*   THIS PROGRAM CREATES AN EXTRACT FILE FROM: TALCHRG.          *00120010
001300*   THIS EXTRACT FILE CONSISTS OF ROWS ELIGIBLE TO BE:           *00130010
001400*   1) LOADED TO THE "ARCHIVE/HISTORY" VERSIONS OF THE TABLES.   *00140010
001500*   2) DELETED FROM THE OPERATIONAL VERSIONS OF THE TABLES.      *00150010
001600*                                                                *00160010
001700*   PROCESSING OVERVIEW:                                         *00170010
001800*   THIS PROGRAM READS A "DRIVER" FILE. FOR EACH RECORD READ,    *00180010
001900*   1) INCREMENT COUNT OF RECORDS READ.                          *00190010
002000*   2) ATTEMPT TO FIND RELATED ROW(S) ON THE TABLE.              *00200010
002100*      2.A) IF NO MATCH(ES):                                     *00210010
002200*           2.A.1) PROCESSING CONTINUES                          *00220010
002300*           2.A.2) DO NOT PERFORM ERROR/REPORTING ROUTINES;      *00230010
002400*                  THIS SYSTEM DOES NOT CLEANSE DATA NOR REPORT  *00240010
002500*                  ON UNCLEAN DATA.  IT SIMPLY MIGRATES          *00250010
002600*                  CONDITIONS OCCURRING IN OPERATIONAL           *00260010
002700*                  TABLES OVER TO THE ARCHIVE/HISTORY TABLES.    *00270010
002800*      2.B) IF MATCH(ES):                                        *00280010
002900*           2.B.1) INCREMENT COUNT OF ROW(S) FOUND.              *00290010
003000*           2.B.2) WRITE THESE ROW(S) TO THE EXTRACT FILE.       *00300010
003100*           2.B.3) INCREMENT COUNT OF RECORDS WRITTEN.           *00310010
003200*           2.B.4) DO NOT REMOVE THE ROW(S) FROM THE TABLE       *00320010
003300*                  AT THIS TIME.  THEY WILL BE REMOVED IN OTHER  *00330010
003400*                  PROCESSING, AFTER HAVING BEEN LOADED TO THE   *00340010
003500*                  ARCHIVE/HISTORY TABLE.                        *00350010
003600*   3) EVERY NTH RECORD (IE: INITIAL SETTING 1000), REPORT       *00360010
003700*      RECORD COUNT AND CURRENT DATE/TIME.  THIS WILL ASSIST     *00370010
003800*      WITH RUN-TIME ESTIMATE OF TIME REMAINING TO COMPLETE.     *00380010
003810*----------------------------------------------------------------*00381013
003820*  CHANGE LOG:                                                   *00382013
003830* 06/19/07                                                       *00383016
003840*     MATCH BY DC PROJECT.                                       *00384013
003850*     INCREASED SIZE OF INPUT FILE FROM 186 TO 189.  THIS WAS    *00385013
003860*     NEEDED TO ALLOW FOR THE 2 NEW FIELDS IN THE AHRD001        *00386013
003870*     COPYBOOK: DC-NBR AND MTCH-LVL-CDE.                         *00387013
003880* MADE BY: MICHELE RINDFLEISCH                 WR# 32804         *00388015
003890*----------------------------------------------------------------*00389013
003900******************************************************************00390010
004000 ENVIRONMENT DIVISION.                                            00400000
004100 CONFIGURATION SECTION.                                           00410000
004200 SOURCE-COMPUTER.        IBM-3090.                                00420000
004300 OBJECT-COMPUTER.        IBM-3090.                                00430000
004400                                                                  00440000
004500 INPUT-OUTPUT SECTION.                                            00450000
004600 FILE-CONTROL.                                                    00460000
004700                                                                  00470000
004800     SELECT IN-DRIVER-FILE                ASSIGN TO IN01.         00480000
004900     SELECT OUT-EXTRACT-FILE              ASSIGN TO OUT01.        00490000
005000                                                                  00500000
005100******************************************************************00510000
005200 DATA DIVISION.                                                   00520000
005300 FILE SECTION.                                                    00530000
005400                                                                  00540000
005500 FD  IN-DRIVER-FILE                                               00550000
005600     RECORDING MODE IS F                                          00560000
005700     LABEL RECORDS ARE STANDARD                                   00570000
005800     BLOCK CONTAINS 0 RECORDS.                                    00580000
005900 01  IN-DRIVER-RECORD                PIC  X(189).                 00590013
006000                                                                  00600000
006100**** TALCHRG:                                                     00610000
006200 FD  OUT-EXTRACT-FILE                                             00620000
006300     RECORDING MODE IS F                                          00630000
006400     LABEL RECORDS ARE STANDARD                                   00640000
006500     BLOCK CONTAINS 0 RECORDS.                                    00650000
006600 01  OUT-EXTRACT-RECORD              PIC  X(051).                 00660012
006700                                                                  00670000
006800                                                                  00680000
006900                                                                  00690000
007000 WORKING-STORAGE SECTION.                                         00700000
007100                                                                  00710000
007200 01  PC-PROGRAM-CONSTANTS.                                        00720000
007300     05  PC-CURRENT-PROGRAM-NAME     PIC X(08) VALUE 'AHKUT017'.  00730000
007400     05  PC-PGM-PROGRESS-DESC.                                    00740000
007500         10  PC-BEGINNING            PIC X(09) VALUE 'BEGINNING'. 00750000
007600         10  PC-CONTINUING           PIC X(10) VALUE              00760000
007700                                               'CONTINUING'.      00770000
007800         10  PC-ENDING               PIC X(06) VALUE 'ENDING'.    00780000
007900         10  PC-ABENDING             PIC X(08) VALUE 'ABENDING'.  00790000
008000     05  PC-ABEND-INFO.                                           00800000
008100         10  PC-ABEND                PIC X(11) VALUE              00810000
008200                                               '** ABEND **'.     00820000
008300         10  PC-ABEND-MSG-PARA       PIC X(15) VALUE              00830000
008400                                               '- PARA       : '. 00840000
008500         10  PC-ABEND-MSG-DISPLAY-PARA                            00850000
008600                                     PIC X(15) VALUE              00860000
008700                                               '  CALLED PARA: '. 00870000
008800         10  PC-ABEND-MSG-NUMBER     PIC X(15) VALUE              00880000
008900                                               '  FOR ABEND# : '. 00890000
009000         10  PC-ABEND-MSG-DESC       PIC X(15) VALUE              00900000
009100                                               '- ERROR IS   : '. 00910000
009200         10  PC-ABEND-MSG-INDENT-15  PIC X(15) VALUE SPACES.      00920000
009300         10  PC-ABEND-MSG-ACTION     PIC X(15) VALUE              00930000
009400                                               '- ACTION     : '. 00940000
009500     05  PC-HOW-OFTEN-TO-DISPLAY     PIC 9(9)  VALUE 100000.      00950004
009600                                                                  00960000
009700 01  PS-PROGRAM-SWITCHES.                                         00970000
009800     05  PS-IN-DRIVER-EOF-SW         PIC X(01) VALUE 'N'.         00980000
009900         88  PS-IN-DRIVER-EOF                  VALUE 'Y'.         00990000
010000         88  PS-IN-DRIVER-NOT-EOF              VALUE 'N'.         01000000
010100     05  PS-CURSOR-HAS-DATA-SW       PIC X(01) VALUE 'N'.         01010000
010200         88  PS-CURSOR-HAS-DATA                VALUE 'Y'.         01020000
010300         88  PS-CURSOR-HAS-NO-DATA             VALUE 'N'.         01030000
010400     05  PS-TABLE-LOOP-DONE-SW       PIC X(01) VALUE 'N'.         01040000
010500         88  PS-TABLE-LOOP-DONE                VALUE 'Y'.         01050000
010600         88  PS-TABLE-LOOP-NOT-DONE            VALUE 'N'.         01060000
010700                                                                  01070000
010800 01  PV-PROGRAM-VARIABLES.                                        01080000
010900     05  PV-PAYT-REQ-SEQ-NBR-COMP    PIC S9(9) VALUE 0 COMP.      01090000
011000     05  PV-PAYT-REQ-SEQ-NBR-NUM     PIC  9(9) VALUE 0.           01100002
011100     05  PV-IN-DRIVER-RECS-READ-CNT  PIC  9(9) VALUE 0.           01110000
011200     05  PV-RECS-WITH-MATCHES-CNT    PIC  9(9) VALUE 0.           01120000
011300     05  PV-TABLE-ROW-SELECT-CNT     PIC  9(9) VALUE 0.           01130000
011400     05  PV-EXTRACT-WRITTEN-CNT      PIC  9(9) VALUE 0.           01140000
011500                                                                  01150000
011600     05  PV-PARAGRAPH-NAME           PIC X(30) VALUE SPACES.      01160000
011700     05  PV-DB2-OPERATION-MSG-1      PIC X(79) VALUE SPACES.      01170000
011800     05  PV-DB2-TABLE-NAME           PIC X(18) VALUE SPACES.      01180000
011900     05  PV-DISPLAY-NTH-MULTIPLE     PIC 9(9)  VALUE 0.           01190000
012000     05  PV-DISPLAY-NTH-REMAINDER    PIC 9(9)  VALUE 0.           01200000
012100     05  PV-SQLCODE                  PIC +999  VALUE ZERO.        01210000
012200                                                                  01220000
012300     05  PV-TMST                     PIC X(26) VALUE SPACES.      01230000
012400     05  PV-TIMESTAMP-DETAIL                                      01240000
012500         REDEFINES                                                01250000
012600         PV-TMST.                                                 01260000
012700         10  PV-TIMESTAMP-19.                                     01270000
012800             15  PV-TMS-DATE.                                     01280000
012900                 20  PV-TMS-YEAR.                                 01290000
013000                     25  PV-TMS-CC   PIC X(02).                   01300000
013100                     25  PV-TMS-YY   PIC X(02).                   01310000
013200                 20  FILLER          PIC X(01).                   01320000
013300                 20  PV-TMS-MONTH    PIC X(02).                   01330000
013400                 20  FILLER          PIC X(01).                   01340000
013500                 20  PV-TMS-DAY      PIC X(02).                   01350000
013600             15  FILLER              PIC X(01).                   01360000
013700             15  PV-TMS-HOUR         PIC X(02).                   01370000
013800             15  FILLER              PIC X(01).                   01380000
013900             15  PV-TMS-MINUTE       PIC X(02).                   01390000
014000             15  FILLER              PIC X(01).                   01400000
014100             15  PV-TMS-SECOND       PIC X(02).                   01410000
014200         10  FILLER                  PIC X(01).                   01420000
014300         10  PV-TMS-MSECOND          PIC X(06).                   01430000
014400                                                                  01440000
014500 01  DM-DISPLAY-MESSAGE.                                          01450000
014600     05  DM-01-10.                                                01460000
014700         10  DM-PROGRAM              PIC X(08) VALUE SPACE.       01470000
014800         10  FILLER                  PIC X(02) VALUE ': '.        01480000
014900     05  DM-11-80.                                                01490000
015000         10  FILLER                  PIC X(37) VALUE              01500000
015100                        'SELECT ROWS MATCHING TO DRIVER FILE, '.  01510000
015200         10  FILLER                  PIC X(30) VALUE              01520000
015300                        'CREATING TALCHRG EXTRACT FILE.'.         01530000
015400         10  FILLER                  PIC X(01) VALUE SPACE.       01540000
015500         10  FILLER                  PIC X(01) VALUE ALL '*'.     01550000
015600     05  DM-81-120.                                               01560000
015700         10  FILLER                  PIC X(40) VALUE ALL '*'.     01570000
015800                                                                  01580000
015900 01  DP-DISPLAY-PROGRESS-MSG.                                     01590000
016000     05  DP-PROGRAM                  PIC X(08) VALUE SPACE.       01600000
016100     05  FILLER                      PIC X(02) VALUE SPACE.       01610000
016200     05  DP-STATUS-DESCRIPTION       PIC X(10) VALUE SPACE.       01620000
016300     05  FILLER                      PIC X(04) VALUE ' AT '.      01630000
016400     05  DP-TIMESTAMP-19             PIC X(19) VALUE SPACE.       01640000
016500     05  FILLER                      PIC X(03) VALUE '.  '.       01650000
016600     05  FILLER                      PIC X(03) VALUE              01660000
016700                                         'IN:'.                   01670000
016800     05  DP-IN-CNT                   PIC ZZZ,ZZZ,ZZ9              01680000
016900                                               VALUE ZERO.        01690000
017000     05  FILLER                      PIC X(02) VALUE ', '.        01700000
017100*    05  FILLER                      PIC X(16) VALUE              01710000
017200*                                        'DRIVER W/ROW(S):'.      01720000
017300*    05  DP-MATCHES-FOUND-CNT        PIC ZZZ,ZZZ,ZZ9              01730000
017400*                                              VALUE ZERO.        01740000
017500*    05  FILLER                      PIC X(02) VALUE ', '.        01750000
017600     05  FILLER                      PIC X(14) VALUE              01760000
017700                                         'ROWS SELECTED:'.        01770000
017800     05  DP-ROWS-SELECTED-CNT        PIC ZZZ,ZZZ,ZZ9              01780000
017900                                               VALUE ZERO.        01790000
018000     05  FILLER                      PIC X(02) VALUE ', '.        01800000
018100     05  FILLER                      PIC X(04) VALUE              01810000
018200                                         'OUT:'.                  01820000
018300     05  DP-OUT-CNT                  PIC ZZZ,ZZZ,ZZ9              01830000
018400                                               VALUE ZERO.        01840000
018500     05  FILLER                      PIC X(01) VALUE '.'.         01850000
018600                                                                  01860000
018700 01  ABEND-CODE                      PIC S9(04)                   01870000
018800                                               VALUE ZEROES       01880000
018900                                               COMP SYNC.         01890000
019000                                                                  01900000
019100*---------------------------------------------------------------* 01910000
019200*  DB2 FORMATTED MESSAGE AREA                                     01920000
019300*---------------------------------------------------------------* 01930000
019400     COPY DPWS004.                                                01940000
019500                                                                  01950000
019600                                                                  01960000
019700*---------------------------------------------------------------* 01970000
019800*  AHRD001  - RECORD LAYOUT FOR DRIVER FILE, INPUT.             * 01980007
019900*---------------------------------------------------------------* 01990000
020000     COPY AHRD001.                                                02000007
020100                                                                  02010000
020200                                                                  02020000
020300*---------------------------------------------------------------* 02030000
020400*    DB2 AREA FOR TALCHRG                                       * 02040000
020500*---------------------------------------------------------------* 02050000
020600     EXEC SQL                                                     02060000
020700          INCLUDE TALCHRG                                         02070000
020800     END-EXEC.                                                    02080000
020900                                                                  02090000
021000*---------------------------------------------------------------* 02100000
021100*    DB2 AREA FOR COMMUNICATIONS                                * 02110000
021200*---------------------------------------------------------------* 02120000
021300     EXEC SQL                                                     02130000
021400          INCLUDE SQLCA                                           02140000
021500     END-EXEC.                                                    02150000
021600                                                                  02160000
021700*---------------------------------------------------------------* 02170000
021800*    DEFINE CURSOR FOR TALCHRG :                                * 02180000
021900*    PULL ALL AVAILABLE COLUMNS, SO EXTRACT FILE WILL CONTAIN   * 02190000
022000*    ALL DATA TO POPULATE "ARCHIVE HISTORY" COPY OF THIS TABLE. * 02200000
022100*---------------------------------------------------------------* 02210000
022200     EXEC SQL                                                     02220000
022300          DECLARE TABLE-CURSOR CURSOR FOR                         02230000
022400           SELECT                                                 02240000
022500                  PO_NBR                                          02250012
022600                 ,INVC_ID                                         02260012
022700                 ,ALW_CHRG_SEQ_NBR                                02270012
022800                 ,ALW_CHRG_TYP_CDE                                02280000
022900                 ,ALW_CHRG_CDE                                    02290000
023000                 ,ALW_CHRG_SER_CDE                                02300000
023100                 ,ALW_CHRG_PCT                                    02310000
023200                 ,ALW_CHRG_AMT                                    02320000
023300           FROM   TALCHRG                                         02330000
023400          WHERE   PO_NBR  = :AH001-B-PO-NBR                       02340012
023500            AND   INVC_ID = :AH001-B-INVC-ID                      02350012
023600            FOR  FETCH ONLY                                       02360000
023700           WITH  UR                                               02370000
023800     END-EXEC.                                                    02380000
023900                                                                  02390000
024000                                                                  02400000
024100 PROCEDURE DIVISION.                                              02410000
024200                                                                  02420000
024300 0000-PROGRAM-MAINLINE.                                           02430000
024400                                                                  02440000
024500     PERFORM 1000-INITIALIZE.                                     02450000
024600                                                                  02460000
024700     SET PS-IN-DRIVER-NOT-EOF TO TRUE.                            02470000
024800     PERFORM 2000-PROCESS-DRIVER-FILE                             02480000
024900         UNTIL PS-IN-DRIVER-EOF.                                  02490000
025000                                                                  02500000
025100     PERFORM 6000-EOJ-ROUTINE.                                    02510000
025200     STOP RUN.                                                    02520000
025300                                                                  02530000
025400                                                                  02540000
025500******************************************************************02550010
025600*   INITIALIZATIONS                                              *02560010
025700******************************************************************02570010
025800 1000-INITIALIZE.                                                 02580000
025900                                                                  02590000
026000     MOVE PC-CURRENT-PROGRAM-NAME TO DM-PROGRAM.                  02600000
026100     DISPLAY DM-DISPLAY-MESSAGE.                                  02610000
026200                                                                  02620000
026300     MOVE PC-BEGINNING              TO DP-STATUS-DESCRIPTION.     02630000
026400     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           02640000
026500                                                                  02650000
026600     PERFORM 9000-OPEN-IN-DRIVER-FILE.                            02660000
026700     PERFORM 9700-OPEN-OUT-EXTRACT-FILE.                          02670000
026800                                                                  02680000
026900                                                                  02690000
027000******************************************************************02700010
027100*   1) GET NEXT RECORD FROM DRIVER FILE, AND                     *02710010
027200*      1A- POPULATE KEY (WHERE CLAUSE) FOR TABLE CURSOR          *02720010
027300*      1B- OPEN TABLE CURSOR                                     *02730010
027400*      1C- LOOP THRU TABLE CURSOR TO EXTRACT ALL                 *02740010
027500*          ROWS FOR THIS INPUT DRIVER RECORD                     *02750010
027600*      2) FOR EACH ROW,                                          *02760010
027700*         2A- INCREMENT COUNTS                                   *02770010
027800*         2B- WRITE EXTRACT RECORD                               *02780010
027900*      1D- CLOSE TABLE CURSOR                                    *02790010
028000******************************************************************02800010
028100 2000-PROCESS-DRIVER-FILE.                                        02810000
028200                                                                  02820000
028300     PERFORM 9050-READ-IN-DRIVER-FILE.                            02830000
028400     IF PS-IN-DRIVER-EOF                                          02840000
028500         CONTINUE                                                 02850000
028600     ELSE                                                         02860000
028700         PERFORM 2100-CHECK-PGM-PROGRESS                          02870000
028800         SET PS-TABLE-LOOP-NOT-DONE   TO TRUE                     02880000
028900         SET PS-CURSOR-HAS-NO-DATA    TO TRUE                     02890000
029000         PERFORM 9100-OPEN-TABLE-CURSOR                           02900000
029100         PERFORM 3000-EXTRACT-ROWS-FROM-TABLE                     02910000
029200             UNTIL PS-TABLE-LOOP-DONE                             02920000
029300         PERFORM 9190-CLOSE-TABLE-CURSOR                          02930000
029400     END-IF.                                                      02940000
029500                                                                  02950000
029600                                                                  02960000
029700******************************************************************02970010
029800*      EVERY NTH RECORD (IE: INITIAL SETTING 1000), REPORT       *02980010
029900*      RECORD COUNT AND CURRENT DATE/TIME.  THIS WILL ASSIST     *02990010
030000*      WITH RUN-TIME ESTIMATE OF TIME REMAINING TO COMPLETE.     *03000010
030100******************************************************************03010010
030200 2100-CHECK-PGM-PROGRESS.                                         03020000
030300     DIVIDE    PV-IN-DRIVER-RECS-READ-CNT                         03030000
030400         BY        PC-HOW-OFTEN-TO-DISPLAY                        03040001
030500         GIVING    PV-DISPLAY-NTH-MULTIPLE                        03050001
030600         REMAINDER PV-DISPLAY-NTH-REMAINDER.                      03060001
030700                                                                  03070000
030800     IF PV-DISPLAY-NTH-REMAINDER = ZERO                           03080000
030900         MOVE PC-CONTINUING         TO DP-STATUS-DESCRIPTION      03090000
031000         PERFORM 6200-DISPLAY-PGM-PROGRESS                        03100000
031100     END-IF.                                                      03110000
031200                                                                  03120000
031300                                                                  03130000
031400******************************************************************03140010
031500*   EXTRACT ROWS FROM TABLE, FOR THE CURRENT DRIVER RECORD       *03150010
031600******************************************************************03160010
031700 3000-EXTRACT-ROWS-FROM-TABLE.                                    03170000
031800     INITIALIZE DCLTALCHRG.                                       03180000
031900     PERFORM 9150-FETCH-TABLE-CURSOR.                             03190000
032000     IF PS-TABLE-LOOP-DONE                                        03200000
032100         CONTINUE                                                 03210000
032200     ELSE                                                         03220000
032300         PERFORM 9750-WRITE-EXTRACT-RECORD                        03230000
032400     END-IF.                                                      03240000
032500                                                                  03250000
032600                                                                  03260000
032700******************************************************************03270010
032800*   DISPLAY END OF RUN MESSAGE, CLOSE THE OUTPUT FILES           *03280010
032900******************************************************************03290010
033000 6000-EOJ-ROUTINE.                                                03300000
033100                                                                  03310000
033200     PERFORM 9090-CLOSE-IN-DRIVER-FILE.                           03320000
033300     PERFORM 9790-CLOSE-OUT-EXTRACT-FILE.                         03330000
033400                                                                  03340000
033500     MOVE PC-ENDING                 TO DP-STATUS-DESCRIPTION.     03350000
033600     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           03360000
033700                                                                  03370000
033800                                                                  03380000
033900******************************************************************03390010
034000*   DISPLAY PROGRAM PROGRESS.                                    *03400010
034100******************************************************************03410010
034200 6200-DISPLAY-PGM-PROGRESS.                                       03420000
034300                                                                  03430000
034400     EXEC SQL                                                     03440000
034500          SET :PV-TMST = CURRENT TIMESTAMP                        03450000
034600     END-EXEC.                                                    03460000
034700                                                                  03470000
034800     MOVE PC-CURRENT-PROGRAM-NAME   TO DP-PROGRAM.                03480000
034900     MOVE PV-TIMESTAMP-19           TO DP-TIMESTAMP-19.           03490000
035000     MOVE PV-IN-DRIVER-RECS-READ-CNT                              03500000
035100                                    TO DP-IN-CNT.                 03510000
035200*    MOVE PV-RECS-WITH-MATCHES-CNT  TO DP-MATCHES-FOUND-CNT.      03520000
035300     MOVE PV-TABLE-ROW-SELECT-CNT   TO DP-ROWS-SELECTED-CNT.      03530000
035400     MOVE PV-EXTRACT-WRITTEN-CNT    TO DP-OUT-CNT.                03540000
035500                                                                  03550000
035600     DISPLAY DP-DISPLAY-PROGRESS-MSG.                             03560000
035700                                                                  03570000
035800                                                                  03580000
035900******************************************************************03590010
036000*   FILE AND DB2 TABLE ACCESS PARAGRAPHS.                        *03600010
036100*   90XX- INPUT:  DRIVER FILE                                    *03610010
036200*   91XX- INPUT:  TABLE CURSOR                                   *03620010
036300*   97XX- OUTPUT: TABLE EXTRACT                                  *03630010
036400******************************************************************03640010
036500                                                                  03650000
036600******************************************************************03660010
036700*   OPEN  INPUT DRIVER FILE                                      *03670010
036800******************************************************************03680010
036900 9000-OPEN-IN-DRIVER-FILE.                                        03690000
037000     OPEN  INPUT  IN-DRIVER-FILE.                                 03700000
037100                                                                  03710000
037200                                                                  03720000
037300******************************************************************03730010
037400*   READ  INPUT DRIVER FILE OF ELIGIBLE DATA TO EXTRACT          *03740010
037500******************************************************************03750010
037600 9050-READ-IN-DRIVER-FILE.                                        03760000
037700     READ IN-DRIVER-FILE                                          03770000
037800          INTO AH001-DRIVER-RECORD-LAYOUT                         03780007
037900          AT END                                                  03790000
038000              SET PS-IN-DRIVER-EOF TO TRUE.                       03800000
038100                                                                  03810000
038200     IF PS-IN-DRIVER-EOF                                          03820000
038300         CONTINUE                                                 03830000
038400     ELSE                                                         03840000
038500         ADD +1 TO PV-IN-DRIVER-RECS-READ-CNT                     03850000
038600     END-IF.                                                      03860000
038700                                                                  03870000
038800                                                                  03880000
038900******************************************************************03890010
039000*   CLOSE INPUT DRIVER FILE                                      *03900010
039100******************************************************************03910010
039200 9090-CLOSE-IN-DRIVER-FILE.                                       03920000
039300     CLOSE IN-DRIVER-FILE.                                        03930000
039400                                                                  03940000
039500                                                                  03950000
039600******************************************************************03960010
039700*   OPEN  TABLE CURSOR                                           *03970010
039800******************************************************************03980010
039900 9100-OPEN-TABLE-CURSOR.                                          03990000
040000     EXEC SQL                                                     04000000
040100          OPEN TABLE-CURSOR                                       04010000
040200     END-EXEC.                                                    04020000
040300                                                                  04030000
040400     EVALUATE TRUE                                                04040000
040500         WHEN SQLCODE = ZERO                                      04050000
040600              ADD +1 TO PV-RECS-WITH-MATCHES-CNT                  04060000
040700              SET PS-CURSOR-HAS-DATA TO TRUE                      04070000
040800         WHEN SQLCODE = +100                                      04080000
040900              SET PS-TABLE-LOOP-DONE TO TRUE                      04090000
041000         WHEN SQLWARN0 NOT EQUAL SPACE                            04100000
041100         WHEN SQLCODE  NOT EQUAL ZERO                             04110000
041200              MOVE '9100-OPEN-TABLE-CURSOR'                       04120000
041300                                 TO PV-PARAGRAPH-NAME             04130000
041400              MOVE 'OPEN TABLE CURSOR'                            04140000
041500                                 TO PV-DB2-OPERATION-MSG-1        04150000
041600              MOVE 'TALCHRG'     TO PV-DB2-TABLE-NAME             04160000
041700              PERFORM 9999-DB2-ABEND                              04170000
041800     END-EVALUATE.                                                04180000
041900                                                                  04190000
042000                                                                  04200000
042100******************************************************************04210010
042200*   FETCH TABLE CURSOR                                           *04220010
042300******************************************************************04230010
042400 9150-FETCH-TABLE-CURSOR.                                         04240000
042500     EXEC SQL                                                     04250000
042600         FETCH TABLE-CURSOR                                       04260000
042700          INTO  :ALCHRG-PO-NBR                                    04270012
042800               ,:ALCHRG-INVC-ID                                   04280012
042900               ,:ALCHRG-ALW-CHRG-SEQ-NBR                          04290012
043000               ,:ALCHRG-ALW-CHRG-TYP-CDE                          04300012
043100               ,:ALCHRG-ALW-CHRG-CDE                              04310012
043200               ,:ALCHRG-ALW-CHRG-SER-CDE                          04320012
043300               ,:ALCHRG-ALW-CHRG-PCT                              04330012
043400               ,:ALCHRG-ALW-CHRG-AMT                              04340012
043500     END-EXEC.                                                    04350012
043600                                                                  04360012
043700     EVALUATE TRUE                                                04370012
043800         WHEN SQLCODE = ZERO                                      04380012
043900              ADD +1                 TO PV-TABLE-ROW-SELECT-CNT   04390012
044000              SET PS-CURSOR-HAS-DATA TO TRUE                      04400012
044100         WHEN SQLCODE = +100                                      04410012
044200              SET PS-TABLE-LOOP-DONE TO TRUE                      04420012
044300         WHEN SQLWARN0 NOT EQUAL SPACE                            04430012
044400         WHEN SQLCODE NOT EQUAL ZERO                              04440012
044500              MOVE '9150-FETCH-TABLE-CURSOR'                      04450012
044600                                 TO PV-PARAGRAPH-NAME             04460012
044700              MOVE 'FETCH TABLE CURSOR'                           04470012
044800                                 TO PV-DB2-OPERATION-MSG-1        04480012
044900              MOVE 'TALCHRG'     TO PV-DB2-TABLE-NAME             04490012
045000              PERFORM 9999-DB2-ABEND                              04500012
045100     END-EVALUATE.                                                04510012
045200                                                                  04520012
045300                                                                  04530012
045400******************************************************************04540012
045500*   CLOSE TABLE CURSOR                                           *04550012
045600******************************************************************04560012
045700 9190-CLOSE-TABLE-CURSOR.                                         04570012
045800     EXEC SQL                                                     04580012
045900          CLOSE TABLE-CURSOR                                      04590012
046000     END-EXEC.                                                    04600012
046100                                                                  04610012
046200     EVALUATE TRUE                                                04620012
046300         WHEN SQLCODE = ZERO                                      04630012
046400              CONTINUE                                            04640012
046500         WHEN SQLWARN0 NOT EQUAL SPACE                            04650012
046600         WHEN SQLCODE NOT EQUAL ZERO                              04660012
046700              MOVE '9190-CLOSE-TABLE-CURSOR'                      04670012
046800                                 TO PV-PARAGRAPH-NAME             04680012
046900              MOVE 'CLOSE TABLE CURSOR'                           04690012
047000                                 TO PV-DB2-OPERATION-MSG-1        04700012
047100              MOVE 'TALCHRG'     TO PV-DB2-TABLE-NAME             04710012
047200              PERFORM 9999-DB2-ABEND                              04720012
047300     END-EVALUATE.                                                04730012
047400                                                                  04740012
047500                                                                  04750012
047600******************************************************************04760012
047700*   OPEN OUTPUT EXTRACT FILE                                     *04770012
047800******************************************************************04780012
047900 9700-OPEN-OUT-EXTRACT-FILE.                                      04790012
048000     OPEN OUTPUT OUT-EXTRACT-FILE.                                04800012
048100                                                                  04810012
048200                                                                  04820012
048300******************************************************************04830012
048400*   WRITE A RECORD TO THE TABLE EXTRACT FILE                     *04840012
048500******************************************************************04850012
048600 9750-WRITE-EXTRACT-RECORD.                                       04860012
048700     WRITE  OUT-EXTRACT-RECORD  FROM  DCLTALCHRG.                 04870012
048800     ADD +1 TO PV-EXTRACT-WRITTEN-CNT.                            04880012
048900                                                                  04890012
049000                                                                  04900012
049100******************************************************************04910012
049200*   CLOSE OUTPUT EXTRACT FILE                                    *04920012
049300******************************************************************04930012
049400 9790-CLOSE-OUT-EXTRACT-FILE.                                     04940012
049500     CLOSE OUT-EXTRACT-FILE.                                      04950012
049600                                                                  04960012
049700                                                                  04970012
049800******************************************************************04980012
049900*   DISPLAY INFORMATION NEEDED FOR DEBUGGING/MAINTENANCE/SUPPORT *04990012
050000*   AND CALL THE ABEND PROCESSOR IN THE EVENT THAT AN            *05000012
050100*   SQL ERROR OR WARNING CODE OCCURS.                            *05010012
050200******************************************************************05020012
050300 9999-DB2-ABEND.                                                  05030012
050400                                                                  05040012
050500     DISPLAY PC-CURRENT-PROGRAM-NAME                              05050012
050600             ' 9999-DB2-ABEND'.                                   05060012
050700     DISPLAY PC-CURRENT-PROGRAM-NAME                              05070012
050800             ' ** ABEND           **'.                            05080012
050900     DISPLAY PC-CURRENT-PROGRAM-NAME                              05090012
051000             ' ** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.       05100012
051100     DISPLAY PC-CURRENT-PROGRAM-NAME                              05110012
051200             ' ** TABLES AFFECTED ** = ' PV-DB2-TABLE-NAME.       05120012
051300     DISPLAY PC-CURRENT-PROGRAM-NAME                              05130012
051400             ' ** OPERATION       ** = ' PV-DB2-OPERATION-MSG-1.  05140012
051500                                                                  05150012
051600     DISPLAY PC-CURRENT-PROGRAM-NAME                              05160012
051700             ' ** SQLCODE         ** = ' SQLCODE.                 05170012
051800     MOVE SQLCODE TO PV-SQLCODE.                                  05180012
051900     DISPLAY PC-CURRENT-PROGRAM-NAME                              05190012
052000             ' ** PV-SQLCODE      ** = ' PV-SQLCODE '.'.          05200012
052100                                                                  05210012
052200     DISPLAY PC-CURRENT-PROGRAM-NAME                              05220012
052300             ' ** SQLWARN0        ** = ' SQLWARN0 '.'.            05230012
052400                                                                  05240012
052500                                                                  05250012
052600*----------------------------------------------------------------*05260012
052700* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *05270012
052800* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *05280012
052900* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *05290012
053000* FORMAT.                                                        *05300012
053100*----------------------------------------------------------------*05310012
053200     COPY DPPD004.                                                05320012
053300                                                                  05330012
053400     MOVE PC-ABENDING               TO DP-STATUS-DESCRIPTION.     05340012
053500     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           05350012
053600     PERFORM 9090-CLOSE-IN-DRIVER-FILE.                           05360012
053700     PERFORM 9790-CLOSE-OUT-EXTRACT-FILE.                         05370012
053800                                                                  05380012
053900*----------------------------------------------------------------*05390012
054000* CALL ABEND                                                     *05400012
054100*----------------------------------------------------------------*05410012
054200     MOVE +4013                  TO ABEND-CODE.                   05420012
054300     CALL 'ILBOABN0' USING ABEND-CODE.                            05430012
054400*                                                                 05440012
