000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400 PROGRAM-ID.         SVKUP014.                                    00040000
000500 AUTHOR.             KARI SUTTON.                                 00050000
000600 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00060000
000700 DATE-WRITTEN.       MAY 1996.                                    00070000
000800 DATE-COMPILED.                                                   00080000
000900                                                                  00090000
001000******************************************************************00100000
001100* THIS PROGRAM UPDATES (OR VERIFIES) THE ACTIVITY STATUS CODE    *00110000
001200* ON THE SVT_KOHLS_CRD_TXN ROW.                                   00120000
001300*                      IT ALSO INSERTS A ROW IF THE TRANSACTION  *00130000
001400* IS MISSING FROM THE SVT_KOHLS_CRD_TXN TABLE.                   *00140000
001500*                                                                *00150000
001600* THERE ARE ONLY TWO TYPES OF ROWS THAT THIS PROGRAM CURRENTLY   *00160000
001700* INSERTS, THEY ARE MISSING VOID TRANSACTIONS AND THE ORIGINAL   *00170000
001800* TRANSACTION FOR A VOID IF IT IS MISSING.  PROGRAM SVKUT029     *00180000
001900* DETERMINES WHETHER A VOID IS MISSING FROM SVT_KOHLS_CRD_TXN.   *00190000
002000*                                                     THIS       *00200000
002100* PROGRAM DETERMINES WHETHER THE ORIGINAL TRANSACTION IS MISSING *00210000
002200* FOR THE VOID.                                                  *00220000
002300*                                                                *00230000
002400* INPUT FILES:   UPDATE POSTING FILE       DDNAME = INP01        *00240000
002500*                                                                *00250000
002600* OUTPUT FILES:  N/A                                             *00260000
002700*                                                                *00270000
002800******************************************************************00280000
P10237* 06/15/2015  COSA DATA SECURITY PROJECT                         *00281000
P10237*             CHANGES TO DECRYPT THE DL# FROM INPUT FILE AND TO  *00282031
P10237*             ADD A LOGIC TO OMIT THE LEADING ZEROS IN DECRYPTED *00282131
P10237*             DL# AND INSERT IT INTO THE SVT TABLE AND TO REMOVE *00282233
P10237*             THE CARD# DISPLAY.                                 *00282336
P10237* MADE BY: COGNIZANT                   WR#: CHG0104429           *00283000
P10237******************************************************************00284000
P12431* 08/27/2018  MODIFIED THE PROGRAM TO HANDLE NEWLY ADDED         *00284144
P12431*             ORD_NBR FIELD IN THE SVT TABLES.                   *00284244
P12431* MADE BY: COGNIZANT                   WR#: CHG0208643           *00284344
P12431******************************************************************00285044
260107* CHG0260107   JIM HUNTER   08-19-21   ADD COPYBOOK DPWS991 TO    00286045
260107*                                      MAKE DPKUT901 CALL DYNAMIC.00287045
003000******************************************************************00300000
003100 ENVIRONMENT DIVISION.                                            00310000
003200******************************************************************00320000
003300                                                                  00330000
003400 CONFIGURATION SECTION.                                           00340000
003500                                                                  00350000
003600 SOURCE-COMPUTER.    IBM-3090.                                    00360000
003700 OBJECT-COMPUTER.    IBM-3090.                                    00370000
003800                                                                  00380000
003900 INPUT-OUTPUT SECTION.                                            00390000
004000                                                                  00400000
004100 FILE-CONTROL.                                                    00410000
004200                                                                  00420000
004300******************************************************************00430000
004400 DATA DIVISION.                                                   00440000
004500******************************************************************00450000
004600                                                                  00460000
004700 WORKING-STORAGE SECTION.                                         00470000
004800                                                                  00480000
004900 01  ABEND-CODE                  PIC S9(04)     VALUE +0  COMP.   00490000
005000                                                                  00500000
005100******************************************************************00510000
005200*PC - PROGRAM CONSTANTS                                           00520000
005300******************************************************************00530000
005400 01  PROGRAM-CONSTANTS.                                           00540000
005500     05  PC-MAX-RETRIES          PIC S9(04)     VALUE +3          00550000
005600                                                COMP SYNC.        00560000
005700     05  PC-MAX-DEADLOCKS        PIC S9(04)     VALUE +3          00570000
005800                                                COMP SYNC.        00580000
005900     05  PC-CKPT-JOB-NAME        PIC  X(08)     VALUE 'SVK065  '. 00590000
006000     05  PC-CKPT-PLAN-NAME       PIC  X(08)     VALUE 'SVKUP014'. 00600000
006100     05  PC-CURRENT-PROGRAM-NAME PIC  X(08)     VALUE 'SVKUP014'. 00610000
P10237     05  PC-DPKUT052             PIC  X(08)     VALUE 'DPKUT052'. 00611035
006200                                                                  00620000
006300     05  PC-TRAN-PRES-FUNC-CODES.                                 00630000
006400         10  PC-TRAN-PRES-FUNC-OPEN   PIC  X(05)  VALUE 'OPEN '.  00640000
006500         10  PC-TRAN-PRES-FUNC-TRANS  PIC  X(05)  VALUE 'TRANS'.  00650000
006600         10  PC-TRAN-PRES-FUNC-RSTRT  PIC  X(05)  VALUE 'RSTRT'.  00660000
006700         10  PC-TRAN-PRES-FUNC-CLOSE  PIC  X(05)  VALUE 'CLOSE'.  00670000
006800                                                                  00680000
006900     05  PC-MINUS-ONE            PIC S9(01)     VALUE -1.         00690000
007000     05  PC-SYSTEM               PIC  X(08)     VALUE 'SYSTEM  '. 00700000
P10237     05  PC-MAX-DL-LENGTH        PIC  9(2)      VALUE 48.         00701027
007100                                                                  00710000
007200******************************************************************00720000
007300*PV - PROGRAM VARIABLES                                           00730000
007400******************************************************************00740000
007500 01  PROGRAM-VARIABLES.                                           00750000
007600     05  PV-SQL-SUB                   PIC  9(03)   VALUE ZERO.    00760000
007700     05  PV-DEADLOCK-COUNTER          PIC  9(03)   VALUE ZERO.    00770000
007800     05  PV-PARAGRAPH-NAME            PIC  X(30)   VALUE SPACE.   00780000
007900     05  PV-DB2-OPER-ATTEMPTED        PIC  X(30)   VALUE SPACE.   00790000
P12431     05  PV-ORD-NBR-NULL-IND          PIC S9(04)  COMP VALUE ZERO.00791038
P12431     05  PV-ORD-COUNT                 PIC S9(04)   VALUE +0       00792043
P12431                                                  COMP SYNC.      00793043
008000     05  PV-ST-CDE                    PIC  X(02)   VALUE SPACES.  00800000
008100     05  PV-CARD-NUMBER               PIC  9(12)   VALUE ZERO.    00810000
P10237     05  PV-DL-LENGTH                 PIC  9(09)   VALUE ZEROES.  00811033
P10237     05  PV-INPUT-TEXT                PIC  X(48).                 00812000
P10237     05  PV-OUTPUT-TEXT               PIC  X(34)   VALUE SPACES.  00813000
P10237     05  PV-DRV-LIC-NBR.                                          00814028
P10237         10  PV-LIC-CHAR              OCCURS 48 TIMES             00815028
P10237                                      INDEXED BY PV-LIC-IDX       00816028
P10237                                      PIC  X(01).                 00817028
P10237     05  PV-LEFT-DRV-LIC-NBR.                                     00818028
P10237         10  PV-LEFT-LIC-CHAR         OCCURS 48 TIMES             00819028
P10237                                      INDEXED BY PV-LEFT-LIC-IDX  00819128
P10237                                      PIC  X(01).                 00819228
008200                                                                  00820000
008300******************************************************************00830000
008400*PS - PROGRAM SWITCHES                                            00840000
008500******************************************************************00850000
008600 01  PROGRAM-SWITCHES.                                            00860000
008700     05  PS-RESTART-REQUIRED-SW  PIC X(01)      VALUE 'N'.        00870000
008800         88  PS-RESTART-REQUIRED                VALUE 'Y'.        00880000
008900         88  PS-RESTART-NOT-REQUIRED            VALUE 'N'.        00890000
009000                                                                  00900000
P10237******************************************************************00901000
P10237* LK52- EBCDIC/ASCII DATA FORMAT CONVERSION AREA.                *00902000
P10237******************************************************************00903000
P10237 01  LK52-DPKUT052-SUBRTN-WORK-AREA.                              00903100
P10237     05  LK52-CONVERSION-TYPE         PIC  X(01).                 00903232
P10237         88  EBCDIC-TO-ASCII                       VALUE '1'.     00903332
P10237         88  ASCII-TO-EBCDIC                       VALUE '2'.     00903432
P10237     05  LK52-LENGTH                  PIC S9(03)   COMP-3.        00903532
P10237     05  LK52-FROM-AREA               PIC  X(50)   VALUE SPACES.  00903632
P10237     05  LK52-TO-AREA                 PIC  X(50)   VALUE SPACES.  00903732
P10237     05  LK52-RETURN-CODE             PIC  X(02)   VALUE '00'.    00903832
P10237         88  GOOD-LK52-RET-CODE                    VALUE '00'.    00903932
P10237                                                                  00911000
009100******************************************************************00912000
009200*  KMC UPDATE POSTING RECORD LAYOUT                              *00920000
009300******************************************************************00930000
009400     COPY SVRD018.                                                00940000
009500                                                                  00950000
009600******************************************************************00960000
009700*  STORED VALUE CARD CONSTANTS                                   *00970000
009800******************************************************************00980000
009900     COPY SVWS004.                                                00990000
010000                                                                  01000000
P10237******************************************************************01000100
P10237*  VARIABLES TO CONVERT FROM BASE64 TO BINARY & VICE VERSA        01000200
P10237******************************************************************01000300
P10237     COPY DPWS022.                                                01000400
P10237                                                                  01000500
P10237******************************************************************01001000
P10237* LAYOUT THAT DEFINES THE PARAMETERS NEEDED TO INVOKE PROTEGRITY *01002000
P10237* MODULE                                                         *01003000
P10237******************************************************************01004000
P10237     COPY PTYCCSIP.                                               01005000
P10237                                                                  01006000
P10237******************************************************************01007000
P10237* LAYOUT THAT DEFINES THE WORKING VARIABLES TO INVOKE PROTEGRITY *01008000
P10237* MODULE                                                         *01009000
P10237******************************************************************01009100
P10237     COPY DPWS031.                                                01009233
P10237                                                                  01009300
010100******************************************************************01010000
010200*  DCLGEN FOR KOHL'S MERCHANDISE CARD ACTIVITY TABLE             *01020000
010300******************************************************************01030000
010400     EXEC SQL                                                     01040000
010500         INCLUDE SVT00002                                         01050000
010600     END-EXEC.                                                    01060000
010700                                                                  01070000
010800******************************************************************01080000
010900*  DCLGEN FOR XST00001 TABLE - LOCATION MASTER TABLE             *01090000
011000******************************************************************01100000
011100     EXEC SQL                                                     01110000
011200         INCLUDE XST00001                                         01120000
011300     END-EXEC.                                                    01130000
011400                                                                  01140000
011500******************************************************************01150000
011600*  SQL COMMUNICATIONS WORK AREA                                  *01160000
011700******************************************************************01170000
011800     COPY SQLCA2.                                                 01180000
011900                                                                  01190000
012000******************************************************************01200000
012100*  DB2 FORMATTED ERROR MESSAGE                                   *01210000
012200******************************************************************01220000
012300     COPY DPWS004.                                                01230000
012400                                                                  01240000
012500******************************************************************01250000
012600*  TRANSACTION PREPARATION MODULE COMMUNICATIONS AREA            *01260000
012700******************************************************************01270000
260107     COPY DPWS991.                                                01280045
012800                                                                  01281045
012800     COPY DPLS001.                                                01282045
012900     05  WORK-STORAGE-PASSED.                                     01290000
013000******************************************************************01300000
013100*PA - PROGRAM ACCUMULATORS                                        01310000
013200******************************************************************01320000
013300         10  PROGRAM-ACCUMULATORS.                                01330000
013400             15  PA-CRD-TXN-ROWS-UPDATED   PIC S9(11)  VALUE ZERO 01340000
013500                                                       COMP-3.    01350000
013600             15  PA-CRD-TXN-ORIG-INSERTED  PIC S9(11)  VALUE ZERO 01360000
013700                                                       COMP-3.    01370000
013800             15  PA-CRD-TXN-VOIDS-INSERTED PIC S9(11)  VALUE ZERO 01380000
013900                                                       COMP-3.    01390000
014000                                                                  01400000
014100 01  FILLER                          PIC X(4096)  VALUE SPACE.    01410000
014200******************************************************************01420000
014300*  COMMUNICATIONS AREA FOR DB2                                   *01430000
014400******************************************************************01440000
014500     EXEC SQL                                                     01450000
014600         INCLUDE SQLCA                                            01460000
014700     END-EXEC.                                                    01470000
014800                                                                  01480000
014900******************************************************************01490000
015000 PROCEDURE DIVISION.                                              01500000
015100******************************************************************01510000
015200 A100-MAINLINE.                                                   01520000
015300                                                                  01530000
015400     PERFORM B100-INITIALIZE.                                     01540000
015500                                                                  01550000
015600     PERFORM B200-PROCESS-UPDATE-RECORDS                          01560000
015700         UNTIL DP001-PREP-TRANS-EOF.                              01570000
015800                                                                  01580000
015900     PERFORM B300-EOJ-ROUTINE.                                    01590000
016000                                                                  01600000
016100     GOBACK.                                                      01610000
016200                                                                  01620000
016300******************************************************************01630000
016400*     B100-INITIALIZE                                            *01640000
016500* ==> PROCESSES:                                                 *01650000
016600* ==> PERFORMED FROM: A100-MAINLINE                              *01660000
016700******************************************************************01670000
016800 B100-INITIALIZE.                                                 01680000
016900                                                                  01690000
P10237     MOVE PC-CURRENT-PROGRAM-NAME TO DP031-PROGRAM-NAME.          01691033
017000     MOVE PC-TRAN-PRES-FUNC-OPEN TO DP001-FUNC-CODE.              01700000
017100     PERFORM Z100-BUILD-COMM-AREA-TRAN-PRES.                      01710000
017200                                                                  01720000
017300******************************************************************01730000
017400*     B200-PROCESS-UPDATE-RECORDS                                *01740000
017500* ==> PROCESSES:                                                 *01750000
017600* ==> PERFORMED FROM: A100-MAINLINE                              *01760000
017700******************************************************************01770000
017800 B200-PROCESS-UPDATE-RECORDS.                                     01780000
017900                                                                  01790000
018000     SET PS-RESTART-NOT-REQUIRED TO TRUE.                         01800000
P12431                                                                  01810039
P12431     IF SV018-ORD-NBR = SPACES                                    01811038
P12431        MOVE -1                 TO PV-ORD-NBR-NULL-IND            01812143
P12431     ELSE                                                         01812243
P12431        INITIALIZE PV-ORD-COUNT                                   01812343
P12431        INSPECT FUNCTION REVERSE(SV018-ORD-NBR)                   01812443
P12431            TALLYING PV-ORD-COUNT FOR LEADING SPACES              01812543
P12431        COMPUTE SVT00002-ORD-NBR-LEN = LENGTH OF SV018-ORD-NBR    01812643
P12431                                       - PV-ORD-COUNT             01812743
P12431        MOVE SV018-ORD-NBR      TO SVT00002-ORD-NBR-TEXT          01812843
P12431        MOVE 0                  TO PV-ORD-NBR-NULL-IND            01812943
P12431     END-IF.                                                      01813343
P12431                                                                  01813443
018200     IF SV018-UPDATE-REC                                          01820000
018300         PERFORM C100-VERIFY-CRD-TXN-RECORD                       01830000
018400     ELSE                                                         01840000
018500** FOR A MISSING VOID                                             01850000
018500         IF SV018-DRIVERS-LICENSE NOT = SPACES                    01851000
018500           PERFORM B210-BASE64-BINARY                             01851100
018500           PERFORM B220-DECRYPT-DL                                01851200
018500           PERFORM B230-ASCII-EBCDIC                              01852000
018500           PERFORM B240-PROCESS-DL                                01852127
018500         END-IF                                                   01853000
018600         PERFORM C200-SELECT-ORIGINAL-TRANS                       01860000
018700         PERFORM C300-INSERT-VOID-TRANS                           01870000
018800     END-IF.                                                      01880000
018900                                                                  01890000
019000*----------------------------------------------------------------*01900000
019100*  IF A RESTART IS REQUIRED, ISSUE A RESTART CALL RATHER THAN A  *01910000
019200*  TRANS CALL.  THIS WILL ALLOW PROCESSING TO RESUME WITH THE    *01920000
019300*  FIRST TRANSACTION AFTER THE LAST COMMIT.                      *01930000
019400*----------------------------------------------------------------*01940000
019500     IF PS-RESTART-REQUIRED                                       01950000
019600         MOVE PC-TRAN-PRES-FUNC-RSTRT TO DP001-FUNC-CODE          01960000
019700     ELSE                                                         01970000
019800         MOVE PC-TRAN-PRES-FUNC-TRANS TO DP001-FUNC-CODE          01980000
019900     END-IF.                                                      01990000
020000                                                                  02000000
020100     PERFORM Z100-BUILD-COMM-AREA-TRAN-PRES.                      02010000
020200                                                                  02020000
P10237******************************************************************02021000
P10237*     B210-BASE64-BINARY                                         *02022000
P10237* ==> PROCESSES: CONVERTS THE DL# FROM BASE64 TO BINARY FORMAT.  *02022100
P10237* ==> PERFORMED FROM: B200-PROCESS-UPDATE-RECORDS                *02022200
P10237******************************************************************02023000
P10237 B210-BASE64-BINARY.                                              02024000
P10237                                                                  02025000
P10237     INITIALIZE PV-INPUT-TEXT                                     02026000
P10237                PV-OUTPUT-TEXT                                    02027000
P10237                PV-DL-LENGTH.                                     02027100
P10237                                                                  02027200
P10237     MOVE SV018-DRIVERS-LICENSE TO PV-INPUT-TEXT.                 02028000
P10237     INSPECT SV018-DRIVERS-LICENSE TALLYING PV-DL-LENGTH          02029000
P10237                FOR CHARACTERS BEFORE INITIAL SPACE.              02029100
P10237     MOVE PV-DL-LENGTH          TO DP022-INLEN.                   02029433
P10237     MOVE 34                    TO DP022-OUTLEN-IN.               02029533
P10237     CALL  DP022-MGCXR2B  USING DP022-PARMS,                      02029600
P10237                                PV-INPUT-TEXT,                    02029700
P10237                                PV-OUTPUT-TEXT.                   02029800
P10237     IF RETURN-CODE NOT EQUAL 0                                   02029900
P10237        DISPLAY 'ERROR WHILE CONVERTING DL# TO BINARY'            02030134
P10237        DISPLAY 'RETURN CODE     - ' RETURN-CODE                  02030237
P10237        DISPLAY 'STORE-NBR       - ' SV018-STORE-NBR              02030334
P10237        DISPLAY 'POS-DATE        - ' SV018-POS-DATE               02030434
P10237        DISPLAY 'TERMINAL-NBR    - ' SV018-TERMINAL-NBR           02030534
P10237        DISPLAY 'TRANSACTION-NBR - ' SV018-TRANSACTION-NBR        02030634
P10237        DISPLAY 'ENCRYPTED DL#   - ' SV018-DRIVERS-LICENSE        02030734
P10237        DISPLAY 'INPUT DL LENGTH - ' PV-DL-LENGTH                 02030834
P10237        MOVE +4008 TO ABEND-CODE                                  02030934
P10237        CALL 'ILBOABN0' USING ABEND-CODE                          02031034
P10237     END-IF.                                                      02031134
P10237                                                                  02031234
P10237******************************************************************02031334
P10237*     B220-DECRYPT-DL                                            *02031434
P10237* ==> PROCESSES: CALLS THE PROTEGRITY MODULE TO DECRYPT THE DL#. *02031534
P10237*                RETURNED DL# WILL BE IN ASCII FORMAT.           *02031634
P10237* ==> PERFORMED FROM: B200-PROCESS-UPDATE-RECORDS                *02031734
P10237******************************************************************02031834
P10237 B220-DECRYPT-DL.                                                 02031934
P10237                                                                  02032034
P10237     INITIALIZE CSI-PARAMETERS                                    02032134
P10237                DP031-PROTEG-PGM-PARAMETERS.                      02032234
P10237     MOVE 'DRIVER LICENSE'        TO DP031-FIELD.                 02032334
P10237     SET CSI-DECRYPT-FUNCTION     TO TRUE.                        02032434
P10237     SET DP031-IDNBR              TO TRUE.                        02032534
P10237     MOVE DP022-OUTLEN-OUT        TO CSI-CIPHER-TEXT-LENGTH.      02032634
P10237     MOVE 28                      TO CSI-CLEAR-TEXT-LENGTH.       02032734
P10237     MOVE PV-OUTPUT-TEXT          TO DP031-CIPHER-TEXT.           02032834
P10237     PERFORM DP031-1000-PROTG-ENCRYP-DECRYP.                      02032934
P10237     IF CSI-RETURN-CODE NOT = ZERO                                02033034
P10237        DISPLAY 'ABEND IN THE FOLLOWING RECORD'                   02033134
P10237        DISPLAY 'STORE-NBR       - ' SV018-STORE-NBR              02033234
P10237        DISPLAY 'POS-DATE        - ' SV018-POS-DATE               02033334
P10237        DISPLAY 'TERMINAL-NBR    - ' SV018-TERMINAL-NBR           02033434
P10237        DISPLAY 'TRANSACTION-NBR - ' SV018-TRANSACTION-NBR        02033534
P10237        DISPLAY 'ENCRYPTED DL#   - ' SV018-DRIVERS-LICENSE        02033634
P10237        DISPLAY 'INPUT DL LENGTH - ' PV-DL-LENGTH                 02033734
P10237        PERFORM DP031-9999-ABEND                                  02033834
P10237     END-IF.                                                      02033934
P10237                                                                  02034034
P10237******************************************************************02034134
P10237*     B230-ASCII-EBCDIC                                          *02034234
P10237* ==> PROCESSES: CONVERTS THE DL# FROM ASCII TO EBCDIC FORMAT.   *02034334
P10237* ==> PERFORMED FROM: B200-PROCESS-UPDATE-RECORDS                *02034434
P10237******************************************************************02034534
P10237 B230-ASCII-EBCDIC.                                               02034634
P10237                                                                  02034734
P10237     INITIALIZE LK52-DPKUT052-SUBRTN-WORK-AREA.                   02034834
P10237                                                                  02034934
P10237     SET  ASCII-TO-EBCDIC       TO TRUE.                          02035034
P10237     MOVE DP031-CLEAR-TEXT      TO LK52-FROM-AREA.                02035134
P10237     MOVE CSI-CLEAR-TEXT-LENGTH TO LK52-LENGTH.                   02035234
P10237                                                                  02035334
P10237     CALL PC-DPKUT052       USING LK52-CONVERSION-TYPE            02035434
P10237                                  LK52-LENGTH                     02035534
P10237                                  LK52-FROM-AREA                  02035634
P10237                                  LK52-TO-AREA                    02035734
P10237                                  LK52-RETURN-CODE.               02035834
P10237     IF GOOD-LK52-RET-CODE                                        02035934
P10237        MOVE LK52-TO-AREA       TO PV-DRV-LIC-NBR                 02036034
P10237     ELSE                                                         02036134
P10237        DISPLAY 'ERROR WHILE CONVERTING DL# TO EBCDIC'            02036334
P10237        DISPLAY 'RETURN CODE     - ' LK52-RETURN-CODE             02036437
P10237        DISPLAY 'STORE-NBR       - ' SV018-STORE-NBR              02036534
P10237        DISPLAY 'POS-DATE        - ' SV018-POS-DATE               02036634
P10237        DISPLAY 'TERMINAL-NBR    - ' SV018-TERMINAL-NBR           02036734
P10237        DISPLAY 'TRANSACTION-NBR - ' SV018-TRANSACTION-NBR        02036834
P10237        DISPLAY 'ENCRYPTED DL#   - ' SV018-DRIVERS-LICENSE        02036934
P10237        DISPLAY 'INPUT DL LENGTH - ' PV-DL-LENGTH                 02037034
P10237        MOVE +4008 TO ABEND-CODE                                  02037134
P10237        CALL 'ILBOABN0' USING ABEND-CODE                          02037234
P10237     END-IF.                                                      02037334
P10237                                                                  02037434
P10237******************************************************************02037534
P10237*     B240-PROCESS-DL                                            *02037634
P10237* ==> PROCESSES: REMOVES THE LEADING ZEROES IN DL FIELD.         *02037734
P10237* ==> PERFORMED FROM: B200-PROCESS-UPDATE-RECORDS                *02037834
P10237******************************************************************02037934
P10237 B240-PROCESS-DL.                                                 02038034
P10237                                                                  02038134
P10237     MOVE SPACES                TO PV-LEFT-DRV-LIC-NBR.           02038234
P10237     SET PV-LEFT-LIC-IDX        TO 1.                             02038334
P10237     PERFORM                                                      02038434
P10237       VARYING PV-LIC-IDX                                         02038534
P10237       FROM 1 BY 1                                                02038634
P10237       UNTIL (PV-LIC-CHAR (PV-LIC-IDX) > ZERO)                    02038734
P10237          OR (PV-LIC-IDX > PC-MAX-DL-LENGTH)                      02038834
P10237     END-PERFORM.                                                 02038934
P10237     PERFORM                                                      02039034
P10237       VARYING PV-LIC-IDX                                         02039134
P10237       FROM PV-LIC-IDX BY 1                                       02039234
P10237       UNTIL (PV-LIC-IDX > PC-MAX-DL-LENGTH)                      02039334
P10237          OR (PV-LEFT-LIC-IDX > PC-MAX-DL-LENGTH)                 02039434
P10237          MOVE PV-LIC-CHAR (PV-LIC-IDX)                           02039534
P10237                         TO PV-LEFT-LIC-CHAR (PV-LEFT-LIC-IDX)    02039634
P10237          SET PV-LEFT-LIC-IDX UP BY 1                             02039734
P10237     END-PERFORM.                                                 02039834
P10237     MOVE PV-LEFT-DRV-LIC-NBR   TO SV018-DRIVERS-LICENSE.         02039934
P10237                                                                  02040034
020300******************************************************************02040227
020400*     B300-EOJ-ROUTINE                                           *02041027
020500* ==> PROCESSES:                                                 *02050000
020600* ==> PERFORMED FROM: A100-MAINLINE                              *02060000
020700******************************************************************02070000
020800 B300-EOJ-ROUTINE.                                                02080000
020900                                                                  02090000
021000     MOVE PC-TRAN-PRES-FUNC-CLOSE TO DP001-FUNC-CODE.             02100000
021100     PERFORM Z100-BUILD-COMM-AREA-TRAN-PRES.                      02110000
021200                                                                  02120000
021300******************************************************************02130000
021400*     Z100-BUILD-COMM-AREA-TRAN-PRES                             *02140000
021500* ==> PROCESSES:                                                 *02150000
021600*     - BUILD THE COMMUNICATION AREA FOR A CALL TO THE           *02160000
021700*       TRANSACTION PRESENTATION MODULE.                         *02170000
021800* ==> PERFORMED FROM:                                            *02180000
021900******************************************************************02190000
022000 Z100-BUILD-COMM-AREA-TRAN-PRES.                                  02200000
022100                                                                  02210000
022200     MOVE LENGTH OF WORK-STORAGE-PASSED                           02220000
022300                                       TO DP001-WORK-STRG-LENGTH. 02230000
022400     MOVE PC-CKPT-JOB-NAME             TO DP001-JOB-NAME.         02240000
022500     MOVE PC-CKPT-PLAN-NAME            TO DP001-PLAN-NAME.        02250000
022600     PERFORM Z900-CALL-TRANS-PRES-MODULE.                         02260000
022700     MOVE DP001-TRANS-RECORD   TO SV018-UPDATE-POSTING-RECORD.    02270000
022800     IF DP001-CKPT-TAKEN                                          02280000
022900         INITIALIZE PV-DEADLOCK-COUNTER                           02290000
023000     END-IF.                                                      02300000
023100                                                                  02310000
023200******************************************************************02320000
023300*     C100-VERIFY-CRD_TXN-RECORD                                 *02330000
023400* ==> PROCESSES:                                                 *02340000
023500*     - UPDATES THE ACTIVITY STATUS CODE TO BE VERIFIED          *02350000
023600*       (SV004-STAT-VERIFIED-CD)                                 *02360000
023700* ==> PERFORMED FROM:  B200-PROCESS-UPDATE-RECORDS               *02370000
023800******************************************************************02380000
023900 C100-VERIFY-CRD-TXN-RECORD.                                      02390000
024000                                                                  02400000
024100     PERFORM WITH TEST AFTER                                      02410000
024200         VARYING PV-SQL-SUB                                       02420000
024300         FROM 1 BY 1                                              02430000
024400         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       02440000
024500                OR SQLCODE = -911                                 02450000
024600                OR SQLCODE = +100                                 02460000
024700                OR SQLCODE = 0)                                   02470000
024800                                                                  02480000
024900         EXEC SQL                                                 02490000
025000             UPDATE SVT_KOHLS_CRD_TXN                             02500000
025100             SET  ACTVY_STAT_CDE  = :SV018-UPDATED-ACTIVITY       02510000
025200                 ,TRN_PSTD_TMST   = CURRENT TIMESTAMP             02520000
025300             WHERE CRD_NBR       = :SV018-KMC-CRD-NBR             02530000
025400               AND TRN_AUTH_TMST = :SV018-TRN-AUTH-TMST           02540000
025500         END-EXEC                                                 02550000
025600                                                                  02560000
025700         EVALUATE TRUE                                            02570000
025800             WHEN SQLCODE = 0                                     02580000
025900                 ADD +1 TO PA-CRD-TXN-ROWS-UPDATED                02590000
026000             WHEN SQLCODE = +100                                  02600000
P10237                 CONTINUE                                         02610000
026300             WHEN SQLCODE = -911                                  02630000
026400                 ADD +1 TO PV-DEADLOCK-COUNTER                    02640000
026500                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        02650000
026600                     MOVE 'C100-VERIFY-CRD-TXN-RECORD           ' 02660000
026700                                      TO PV-PARAGRAPH-NAME        02670000
026800                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        02680000
026900                                      TO PV-DB2-OPER-ATTEMPTED    02690000
027000                     PERFORM Z900-SQL-ABEND                       02700000
027100                 ELSE                                             02710000
027200                     SET PS-RESTART-REQUIRED TO TRUE              02720000
027300                 END-IF                                           02730000
027400             WHEN OTHER                                           02740000
027500                 MOVE SV018-KMC-CRD-NBR TO PV-CARD-NUMBER         02750000
027600                 DISPLAY 'UPDATE ABENDED ON CARD ' PV-CARD-NUMBER 02760000
027700                 MOVE 'C100-VERIFY-CRD-TXN-RECORD           '     02770000
027800                                      TO PV-PARAGRAPH-NAME        02780000
027900                 MOVE 'UPDATE SVT_KOHLS_CRD_TXN      '            02790000
028000                                      TO PV-DB2-OPER-ATTEMPTED    02800000
028100                 PERFORM Z900-SQL-ABEND                           02810000
028200         END-EVALUATE                                             02820000
028300     END-PERFORM.                                                 02830000
028400                                                                  02840000
028500     IF SQLCODE = +100                                            02850000
028800         MOVE 'C100-VERIFY-CRD-TXN-RECORD'                        02880000
028900                                      TO PV-PARAGRAPH-NAME        02890000
029000         MOVE 'UPDATE SVT_KOHLS_CRD_TXN'                          02900000
029100                                      TO PV-DB2-OPER-ATTEMPTED    02910000
029200         PERFORM Z900-SQL-ABEND                                   02920000
029300     END-IF.                                                      02930000
029400                                                                  02940000
029500     IF PV-SQL-SUB > PC-MAX-RETRIES                               02950000
029600         MOVE 'C100-VERIFY-CRD-TXN-RECORD           '             02960000
029700                                      TO PV-PARAGRAPH-NAME        02970000
029800         MOVE 'VERIFY RETRIES EXCEEDED       '                    02980000
029900                                      TO PV-DB2-OPER-ATTEMPTED    02990000
030000         PERFORM Z900-SQL-ABEND                                   03000000
030100     END-IF.                                                      03010000
030200                                                                  03020000
030300     IF SV018-TRANS-VOID-IND = 'Y' AND                            03030000
030400        SV018-REVERSAL-IND   =  1                                 03040000
030500            PERFORM C150-UPDATE-ORIGINAL-TRAN                     03050000
030600     END-IF.                                                      03060000
030700                                                                  03070000
030800******************************************************************03080000
030900*     C150-UPDATE-ORIGINAL-TRAN                        *          03090000
031000* ==> PROCESSES:                                                 *03100000
031100*     - UPDATES THE ACTIVITY STATUS CODE TO BE VERIFIED          *03110000
031200*       (SV004-STAT-VERIFIED-CD) ON THE EITHER THE ORIGNAL       *03120000
031300*       VOID RECORD OR THE REVERSAL OF THE VOID.                 *03130000
031400* ==> PERFORMED FROM:  C100-VERIFY-CRD-TXN-RECORD                *03140000
031500******************************************************************03150000
031600 C150-UPDATE-ORIGINAL-TRAN.                                       03160000
031700                                                                  03170000
031800     COMPUTE SVT00002-APP-AUTH-AMT  = SV018-APPROVED-TRAN-AMT     03180000
031900                                    * -1.                         03190000
032000     COMPUTE SVT00002-ORIG-AUTH-AMT = SV018-ORIGINAL-AUTH-AMT     03200000
032100                                    * -1.                         03210000
032200                                                                  03220000
032300     EXEC SQL                                                     03230000
032400         UPDATE SVT_KOHLS_CRD_TXN                                 03240000
032500         SET  ACTVY_STAT_CDE  = :SV018-UPDATED-ACTIVITY           03250000
032600             ,TRN_PSTD_TMST   = CURRENT TIMESTAMP                 03260000
032700         WHERE CRD_NBR        = :SV018-KMC-CRD-NBR                03270000
032800           AND ACTVY_TYP_CDE  = :SV018-TRANS-TYPE                 03280000
032900           AND STR_NBR        = :SV018-STORE-NBR                  03290000
033000           AND POS_TRMNL_NBR  = :SV018-TERMINAL-NBR               03300000
033100           AND POS_TRN_NBR    = :SV018-TRANSACTION-NBR            03310000
033200           AND APP_AUTH_AMT   = :SVT00002-APP-AUTH-AMT            03320000
033300           AND ORIG_AUTH_AMT  = :SVT00002-ORIG-AUTH-AMT           03330000
033400           AND TRN_VOID_IND   = 'Y'                               03340000
033500           AND TRN_RVRSL_CDE  = 0                                 03350000
033600           AND ACTVY_STAT_CDE = 1                                 03360000
033700     END-EXEC.                                                    03370000
033800                                                                  03380000
033900     EVALUATE TRUE                                                03390000
034000         WHEN SQLCODE = 0                                         03400000
034100            ADD +1 TO PA-CRD-TXN-ROWS-UPDATED                     03410000
034200         WHEN SQLCODE = +100                                      03420000
P10237            CONTINUE                                              03430000
034500         WHEN SQLCODE = -911                                      03450000
034600            PERFORM Z900-SQL-ABEND                                03460000
034700         WHEN OTHER                                               03470000
034800            MOVE 'C150-UPDATE-ORIGINAL-TRAN            '          03480000
034900                                  TO PV-PARAGRAPH-NAME            03490000
035000            MOVE 'UPDATE SVT_KOHLS_CRD_TXN      '                 03500000
035100                                  TO PV-DB2-OPER-ATTEMPTED        03510000
035200            PERFORM Z900-SQL-ABEND                                03520000
035300     END-EVALUATE.                                                03530000
035400                                                                  03540000
035500******************************************************************03550000
035600*     C200-SELECT-ORIGINAL-TRANS                                 *03560000
035700* ==> PROCESSES:                                                 *03570000
035800*     - TRIES TO SELECT THE ORIGINAL TRANSACTION FOR THE MISSING *03580000
035900*       VOID.                                                    *03590000
036000*     - IF THE ORIGINAL TRANSACTION IS FOUND, THE ACTIVITY STATUS*03600000
036100*       AND VOID INDICATOR ARE CHECKED AND UPDATED IF NECESSARY. *03610000
036200*     - IF THE ORIGINAL TRANSACTION IS NOT FOUND, THE ROW IS     *03620000
036300*       INSERTED WITH THE ACTIVITY STATUS VERIFIED AND THE VOID  *03630000
036400*       INDICATOR SET TO 'Y'.                                    *03640000
036500* ==> PERFORMED FROM:  B200-PROCESS-UPDATE-RECORDS               *03650000
036600******************************************************************03660000
036700 C200-SELECT-ORIGINAL-TRANS.                                      03670000
036800                                                                  03680000
036900     COMPUTE SVT00002-APP-AUTH-AMT =                              03690000
037000         SV018-APPROVED-TRAN-AMT * PC-MINUS-ONE.                  03700000
037100                                                                  03710000
037200     COMPUTE SVT00002-ORIG-AUTH-AMT =                             03720000
037300         SV018-ORIGINAL-AUTH-AMT * PC-MINUS-ONE.                  03730000
037400                                                                  03740000
037500     PERFORM WITH TEST AFTER                                      03750000
037600         VARYING PV-SQL-SUB                                       03760000
037700         FROM 1 BY 1                                              03770000
037800         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       03780000
037900                OR SQLCODE = -911                                 03790000
038000                OR SQLCODE = 0)                                   03800000
038100                                                                  03810000
038200         EXEC SQL                                                 03820000
038300            SELECT  TRN_VOID_IND                                  03830000
038400                   ,ACTVY_STAT_CDE                                03840000
038500                   ,DRV_LIC_NBR                                   03850000
038600                   ,ST_CDE                                        03860000
038700                   ,TRN_AUTH_TMST                                 03870000
038800              INTO  :SVT00002-TRN-VOID-IND                        03880000
038900                   ,:SVT00002-ACTVY-STAT-CDE                      03890000
039000                   ,:SVT00002-DRV-LIC-NBR                         03900000
039100                   ,:SVT00002-ST-CDE                              03910000
039200                   ,:SVT00002-TRN-AUTH-TMST                       03920000
039300              FROM  SVT_KOHLS_CRD_TXN                             03930000
039400             WHERE CRD_NBR       = :SV018-KMC-CRD-NBR             03940000
039500               AND TRN_RVRSL_CDE = :SV004-REV-CDE-NORMAL          03950000
039600               AND ACTVY_TYP_CDE = :SV018-TRANS-TYPE              03960000
039700               AND STR_NBR       = :SV018-STORE-NBR               03970000
039800               AND POS_TRMNL_NBR = :SV018-TERMINAL-NBR            03980000
039900               AND POS_TRN_NBR   = :SV018-TRANSACTION-NBR         03990000
040000               AND APP_AUTH_AMT  = :SVT00002-APP-AUTH-AMT         04000000
040100               AND ORIG_AUTH_AMT = :SVT00002-ORIG-AUTH-AMT        04010000
040200               AND POS_DTE       = :SV018-POS-DATE                04020000
040300         END-EXEC                                                 04030000
040400                                                                  04040000
040500         EVALUATE TRUE                                            04050000
040600             WHEN SQLCODE = 0                                     04060000
040700                 MOVE SVT00002-ST-CDE TO PV-ST-CDE                04070000
040800                 IF SVT00002-TRN-VOID-IND = SV004-NOT-VOID-TRANS  04080000
040900                 OR SVT00002-ACTVY-STAT-CDE NOT =                 04090000
041000                       SV004-STAT-VERIFIED-CD                     04100000
041100                     PERFORM D100-UPDATE-ORIGINAL-TRANS           04110000
041200                 END-IF                                           04120000
041300             WHEN SQLCODE = +100                                  04130000
041400                 PERFORM C250-SELECT-XST00001-TABLE               04140000
041500                 PERFORM D200-INSERT-ORIGINAL-TRANS               04150000
041600             WHEN SQLCODE = -911                                  04160000
041700                 ADD +1 TO PV-DEADLOCK-COUNTER                    04170000
041800                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        04180000
041900                     MOVE 'C200-SELECT-ORIGINAL-TRANS    '        04190000
042000                                      TO PV-PARAGRAPH-NAME        04200000
042100                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        04210000
042200                                      TO PV-DB2-OPER-ATTEMPTED    04220000
042300                     PERFORM Z900-SQL-ABEND                       04230000
042400                 ELSE                                             04240000
042500                     SET PS-RESTART-REQUIRED TO TRUE              04250000
042600                 END-IF                                           04260000
042700             WHEN OTHER                                           04270000
042800                 MOVE 'C200-SELECT-ORIGINAL-TRANS    '            04280000
042900                                      TO PV-PARAGRAPH-NAME        04290000
043000                 MOVE 'SELECT ORIGINAL TRANS CRD-TXN '            04300000
043100                                      TO PV-DB2-OPER-ATTEMPTED    04310000
043200                 PERFORM Z900-SQL-ABEND                           04320000
043300         END-EVALUATE                                             04330000
043400     END-PERFORM.                                                 04340000
043500                                                                  04350000
043600     IF PV-SQL-SUB > PC-MAX-RETRIES                               04360000
043700         MOVE 'C200-SELECT-ORIGINAL-TRANS    '                    04370000
043800                                      TO PV-PARAGRAPH-NAME        04380000
043900         MOVE 'VERIFY RETRIES EXCEEDED       '                    04390000
044000                                      TO PV-DB2-OPER-ATTEMPTED    04400000
044100         PERFORM Z900-SQL-ABEND                                   04410000
044200     END-IF.                                                      04420000
044300                                                                  04430000
044400******************************************************************04440000
044500*     C250-SELECT-XST00001-TABLE                                 *04450000
044600* ==> PROCESSES:                                                 *04460000
044700*     - SELECT THE STATE CODE USING THE STORE NUMBER.            *04470000
044800* ==> PERFORMED FROM:  B200-PROCESS-UPDATE-RECORDS               *04480000
044900******************************************************************04490000
045000 C250-SELECT-XST00001-TABLE.                                      04500000
045100                                                                  04510000
045200     EXEC SQL                                                     04520000
045300         SELECT ST_CDE                                            04530000
045400           INTO :XST00001-ST-CDE                                  04540000
045500           FROM XST_LOC                                           04550000
045600         WHERE LOC_NBR = :SV018-STORE-NBR                         04560000
045700         WITH UR                                                  04570000
045800     END-EXEC.                                                    04580000
045900                                                                  04590000
046000     EVALUATE TRUE                                                04600000
046100         WHEN SQLCODE = 0                                         04610000
046200             MOVE XST00001-ST-CDE TO PV-ST-CDE                    04620000
046300         WHEN OTHER                                               04630000
046400             MOVE 'C250-SELECT-XST00001-TABLE'                    04640000
046500                                  TO PV-PARAGRAPH-NAME            04650000
046600             MOVE 'SELECT FROM XST00001        '                  04660000
046700                                  TO PV-DB2-OPER-ATTEMPTED        04670000
046800             PERFORM Z900-SQL-ABEND                               04680000
046900     END-EVALUATE.                                                04690000
047000                                                                  04700000
047100******************************************************************04710000
047200*     C300-INSERT-VOID-TRANS                                     *04720000
047300* ==> PROCESSES:                                                 *04730000
047400*     - INSERTS THE MISSING VOID ROW INTO THE CRD-TXN TABLE.     *04740000
047500* ==> PERFORMED FROM:  B200-PROCESS-UPDATE-RECORDS               *04750000
047600******************************************************************04760000
047700 C300-INSERT-VOID-TRANS.                                          04770000
047800                                                                  04780000
047900     PERFORM WITH TEST AFTER                                      04790000
048000         VARYING PV-SQL-SUB                                       04800000
048100         FROM 1 BY 1                                              04810000
048200         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       04820000
048300                OR SQLCODE = -911                                 04830000
048400                OR SQLCODE = 0)                                   04840000
048500                                                                  04850000
048600         EXEC SQL                                                 04860000
048700             INSERT INTO SVT_KOHLS_CRD_TXN                        04870000
048800                    (CRD_NBR                                      04880000
048900                    ,TRN_AUTH_TMST                                04890000
049000                    ,DRV_LIC_NBR                                  04900000
049100                    ,TRN_RVRSL_CDE                                04910000
049200                    ,TRN_VOID_IND                                 04920000
049300                    ,ACTVY_TYP_CDE                                04930000
049400                    ,POS_DTE                                      04940000
049500                    ,STR_NBR                                      04950000
049600                    ,POS_TRMNL_NBR                                04960000
049700                    ,POS_TRN_NBR                                  04970000
049800                    ,TRN_PSTD_TMST                                04980000
049900                    ,APP_AUTH_AMT                                 04990000
050000                    ,POS_OPRT_ID                                  05000000
050100                    ,APVL_USR_ID                                  05010000
050200                    ,ACTVY_STAT_CDE                               05020000
050300                    ,ORIG_AUTH_AMT                                05030000
050400                    ,ST_CDE                                       05040044
P12431                    ,ORD_NBR)                                     05041039
050500             VALUES                                               05050000
050600                    (:SV018-KMC-CRD-NBR                           05060000
050700                    ,CURRENT TIMESTAMP                            05070000
050800                    ,:SV018-DRIVERS-LICENSE                       05080000
050900                    ,:SV018-REVERSAL-IND                          05090000
051000                    ,:SV018-TRANS-VOID-IND                        05100000
051100                    ,:SV018-TRANS-TYPE                            05110000
051200                    ,:SV018-POS-DATE                              05120000
051300                    ,:SV018-STORE-NBR                             05130000
051400                    ,:SV018-TERMINAL-NBR                          05140000
051500                    ,:SV018-TRANSACTION-NBR                       05150000
051600                    ,CURRENT TIMESTAMP                            05160000
051700                    ,:SV018-APPROVED-TRAN-AMT                     05170000
051800                    ,:SV018-POS-OPERATOR-ID                       05180000
051900                    ,:PC-SYSTEM                                   05190000
052000                    ,:SV018-UPDATED-ACTIVITY                      05200000
052100                    ,:SV018-ORIGINAL-AUTH-AMT                     05210000
052200                    ,:PV-ST-CDE                                   05220044
P12431                    ,:SV018-ORD-NBR :PV-ORD-NBR-NULL-IND)         05221039
052300         END-EXEC                                                 05230000
052400                                                                  05240000
052500         EVALUATE TRUE                                            05250000
052600             WHEN SQLCODE = 0                                     05260000
052700                 ADD +1 TO PA-CRD-TXN-VOIDS-INSERTED              05270000
052800             WHEN SQLCODE = -911                                  05280000
052900                 ADD +1 TO PV-DEADLOCK-COUNTER                    05290000
053000                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        05300000
053100                     MOVE 'C300-INSERT-VOID-TRANS        '        05310000
053200                                      TO PV-PARAGRAPH-NAME        05320000
053300                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        05330000
053400                                      TO PV-DB2-OPER-ATTEMPTED    05340000
053500                     PERFORM Z900-SQL-ABEND                       05350000
053600                 ELSE                                             05360000
053700                     SET PS-RESTART-REQUIRED TO TRUE              05370000
053800                 END-IF                                           05380000
053900             WHEN OTHER                                           05390000
054000                 MOVE 'C300-INSERT-VOID-TRANS        '            05400000
054100                                  TO PV-PARAGRAPH-NAME            05410000
054200                 MOVE 'INSERT TO CRD-TXN - VOID TRANS'            05420000
054300                                  TO PV-DB2-OPER-ATTEMPTED        05430000
054400                 PERFORM Z900-SQL-ABEND                           05440000
054500         END-EVALUATE                                             05450000
054600     END-PERFORM.                                                 05460000
054700                                                                  05470000
054800     IF PV-SQL-SUB > PC-MAX-RETRIES                               05480000
054900         MOVE 'C300-INSERT-VOID-TRANS        '                    05490000
055000                                      TO PV-PARAGRAPH-NAME        05500000
055100         MOVE 'VERIFY RETRIES EXCEEDED       '                    05510000
055200                                      TO PV-DB2-OPER-ATTEMPTED    05520000
055300         PERFORM Z900-SQL-ABEND                                   05530000
055400     END-IF.                                                      05540000
055500                                                                  05550000
055600                                                                  05560000
055700******************************************************************05570000
055800*     D100-UPDATE-ORIGINAL-TRANS                                 *05580000
055900* ==> PROCESSES:                                                 *05590000
056000*     - UPDATES THE ORIGINAL TRANSACTION FOR THE MISSING VOID,   *05600000
056100*       SO THE ACTIVITY STATUS CODE IS VERIFIED AND THE VOID     *05610000
056200*       INDICATOR IS 'Y'.  THE TRANSACTION POSTING TIMESTAMP     *05620000
056300*       IS ALSO UPDATED.                                         *05630000
056400* ==> PERFORMED FROM:  C200-SELECT-ORIGINAL-TRANS                *05640000
056500******************************************************************05650000
056600 D100-UPDATE-ORIGINAL-TRANS.                                      05660000
056700                                                                  05670000
056800     PERFORM WITH TEST AFTER                                      05680000
056900         VARYING PV-SQL-SUB                                       05690000
057000         FROM 1 BY 1                                              05700000
057100         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       05710000
057200                OR SQLCODE = +100                                 05720000
057300                OR SQLCODE = 0)                                   05730000
057400                                                                  05740000
057500         EXEC SQL                                                 05750000
057600             UPDATE SVT_KOHLS_CRD_TXN                             05760000
057700             SET  ACTVY_STAT_CDE  = :SV004-STAT-VERIFIED-CD       05770000
057800                 ,TRN_VOID_IND    = :SV004-VOID-TRANS             05780000
057900                 ,TRN_PSTD_TMST   = CURRENT TIMESTAMP             05790000
058000             WHERE CRD_NBR        = :SV018-KMC-CRD-NBR            05800000
058100               AND TRN_AUTH_TMST  = :SVT00002-TRN-AUTH-TMST       05810000
058200         END-EXEC                                                 05820000
058300                                                                  05830000
058400         EVALUATE TRUE                                            05840000
058500             WHEN SQLCODE = 0                                     05850000
058600                 CONTINUE                                         05860000
058700             WHEN SQLCODE = +100                                  05870000
P10237                 CONTINUE                                         05880000
059000             WHEN SQLCODE = -911                                  05900000
059100                 ADD +1 TO PV-DEADLOCK-COUNTER                    05910000
059200                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        05920000
059300                     MOVE 'D100-UPDATE-ORIGINAL-TRANS    '        05930000
059400                                      TO PV-PARAGRAPH-NAME        05940000
059500                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        05950000
059600                                      TO PV-DB2-OPER-ATTEMPTED    05960000
059700                     PERFORM Z900-SQL-ABEND                       05970000
059800                 ELSE                                             05980000
059900                     SET PS-RESTART-REQUIRED TO TRUE              05990000
060000                 END-IF                                           06000000
060100             WHEN OTHER                                           06010000
060200                 MOVE 'D100-UPDATE-ORIGINAL-TRANS    '            06020000
060300                                      TO PV-PARAGRAPH-NAME        06030000
060400                 MOVE 'UPDATE ORIGINAL TRANS CRD-TXN '            06040000
060500                                      TO PV-DB2-OPER-ATTEMPTED    06050000
060600                 PERFORM Z900-SQL-ABEND                           06060000
060700         END-EVALUATE                                             06070000
060800     END-PERFORM.                                                 06080000
060900                                                                  06090000
061000     IF PV-SQL-SUB > PC-MAX-RETRIES                               06100000
061100         MOVE 'D100-UPDATE-ORIGINAL-TRANS    '                    06110000
061200                                      TO PV-PARAGRAPH-NAME        06120000
061300         MOVE 'VERIFY RETRIES EXCEEDED       '                    06130000
061400                                      TO PV-DB2-OPER-ATTEMPTED    06140000
061500         PERFORM Z900-SQL-ABEND                                   06150000
061600     END-IF.                                                      06160000
061700                                                                  06170000
061800******************************************************************06180000
061900*     D200-INSERT-ORIGINAL-TRANS                                 *06190000
062000* ==> PROCESSES:                                                 *06200000
062100*     -  INSERTS THE ORIGINAL TRANSACTION INTO THE CRD-TXN TABLE *06210000
062200*        IF IT IS NOT FOUND.  THE TRANSACTION AND POSTING        *06220000
062300*        TIMESTAMPS ARE CURRENT, THE VOID INDICATOR IS SET TO    *06230000
062400*        'Y', AND THE ACTIVITY STATUS CODE IS VERIFIED.          *06240000
062500* ==> PERFORMED FROM:  C200-SELECT-ORIGINAL-TRANS                *06250000
062600******************************************************************06260000
062700 D200-INSERT-ORIGINAL-TRANS.                                      06270000
062800                                                                  06280000
062900     PERFORM WITH TEST AFTER                                      06290000
063000         VARYING PV-SQL-SUB                                       06300000
063100         FROM 1 BY 1                                              06310000
063200         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       06320000
063300                OR SQLCODE = -911                                 06330000
063400                OR SQLCODE = 0)                                   06340000
063500                                                                  06350000
063600         EXEC SQL                                                 06360000
063700             INSERT INTO SVT_KOHLS_CRD_TXN                        06370000
063800                    (CRD_NBR                                      06380000
063900                    ,TRN_AUTH_TMST                                06390000
064000                    ,DRV_LIC_NBR                                  06400000
064100                    ,TRN_RVRSL_CDE                                06410000
064200                    ,TRN_VOID_IND                                 06420000
064300                    ,ACTVY_TYP_CDE                                06430000
064400                    ,POS_DTE                                      06440000
064500                    ,STR_NBR                                      06450000
064600                    ,POS_TRMNL_NBR                                06460000
064700                    ,POS_TRN_NBR                                  06470000
064800                    ,TRN_PSTD_TMST                                06480000
064900                    ,APP_AUTH_AMT                                 06490000
065000                    ,POS_OPRT_ID                                  06500000
065100                    ,APVL_USR_ID                                  06510000
065200                    ,ACTVY_STAT_CDE                               06520000
065300                    ,ORIG_AUTH_AMT                                06530000
065400                    ,ST_CDE                                       06540044
P12431                    ,ORD_NBR)                                     06541039
065500             VALUES                                               06550000
065600                    (:SV018-KMC-CRD-NBR                           06560000
065700                    ,CURRENT TIMESTAMP                            06570000
065800                    ,:SV018-DRIVERS-LICENSE                       06580000
065900                    ,:SV004-REV-CDE-NORMAL                        06590000
066000                    ,:SV018-TRANS-VOID-IND                        06600000
066100                    ,:SV018-TRANS-TYPE                            06610000
066200                    ,:SV018-POS-DATE                              06620000
066300                    ,:SV018-STORE-NBR                             06630000
066400                    ,:SV018-TERMINAL-NBR                          06640000
066500                    ,:SV018-TRANSACTION-NBR                       06650000
066600                    ,CURRENT TIMESTAMP                            06660000
066700                    ,:SVT00002-APP-AUTH-AMT                       06670000
066800                    ,:SV018-POS-OPERATOR-ID                       06680000
066900                    ,:PC-SYSTEM                                   06690000
067000                    ,:SV004-STAT-VERIFIED-CD                      06700000
067100                    ,:SVT00002-ORIG-AUTH-AMT                      06710000
067200                    ,:PV-ST-CDE                                   06720040
P12431                    ,:SV018-ORD-NBR :PV-ORD-NBR-NULL-IND)         06721039
067300         END-EXEC                                                 06730000
067400                                                                  06740000
067500         EVALUATE TRUE                                            06750000
067600             WHEN SQLCODE = 0                                     06760000
067700                 ADD +1 TO PA-CRD-TXN-ORIG-INSERTED               06770000
067800             WHEN SQLCODE = -911                                  06780000
067900                 ADD +1 TO PV-DEADLOCK-COUNTER                    06790000
068000                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        06800000
068100                     MOVE 'D200-INSERT-ORIGINAL-TRANS    '        06810000
068200                                      TO PV-PARAGRAPH-NAME        06820000
068300                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        06830000
068400                                      TO PV-DB2-OPER-ATTEMPTED    06840000
068500                     PERFORM Z900-SQL-ABEND                       06850000
068600                 ELSE                                             06860000
068700                     SET PS-RESTART-REQUIRED TO TRUE              06870000
068800                 END-IF                                           06880000
068900             WHEN OTHER                                           06890000
069000                 MOVE 'D200-INSERT-ORIGINAL-TRANS    '            06900000
069100                                  TO PV-PARAGRAPH-NAME            06910000
069200                 MOVE 'INSERT TO SVT_KOHLS_CRD_TXN - ORIG TRANS'  06920000
069300                                  TO PV-DB2-OPER-ATTEMPTED        06930000
069400                 PERFORM Z900-SQL-ABEND                           06940000
069500         END-EVALUATE                                             06950000
069600                                                                  06960000
069700     END-PERFORM.                                                 06970000
069800                                                                  06980000
069900     IF PV-SQL-SUB > PC-MAX-RETRIES                               06990000
070000         MOVE 'D200-INSERT-ORIGINAL-TRANS    '                    07000000
070100                                      TO PV-PARAGRAPH-NAME        07010000
070200         MOVE 'VERIFY RETRIES EXCEEDED       '                    07020000
070300                                      TO PV-DB2-OPER-ATTEMPTED    07030000
070400         PERFORM Z900-SQL-ABEND                                   07040000
070500     END-IF.                                                      07050000
070600                                                                  07060000
070700******************************************************************07070000
070800*  ABEND THE PROGRAM IN THE EVENT THAT A SQL ERROR OR WARNING    *07080000
070900*  CODE OCCURS.                                                  *07090000
071000******************************************************************07100000
071100 Z900-SQL-ABEND.                                                  07110000
071200                                                                  07120000
071300     DISPLAY '** ABEND     **'.                                   07130000
071400     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        07140000
071500     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              07150000
071600     DISPLAY '** OPERATION ** = ' PV-DB2-OPER-ATTEMPTED.          07160000
071700                                                                  07170000
071800******************************************************************07180000
071900*  THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-  *07190000
072000*  MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE       *07200000
072100*  'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE   *07210000
072200*  FORMAT.                                                       *07220000
072300******************************************************************07230000
072400     COPY DPPD004.                                                07240000
072500                                                                  07250000
072600     MOVE +4013 TO ABEND-CODE.                                    07260000
072700     CALL 'ILBOABN0' USING ABEND-CODE.                            07270000
072800                                                                  07280000
072900******************************************************************07290000
073000*  THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-  *07300000
073100*  MENTS THAT ARE REQUIRED TO INVOKE THE TRANSACTION PRESENTATION*07310000
073200*  MODULE (DPKUT901) OF THE DB2 CHECKPOINT RESTART SYSTEM.       *07320000
073300******************************************************************07330000
073400     COPY DPPD001.                                                07340000
P10237                                                                  07350000
P10237******************************************************************07360000
P10237* COPY MEMBER DPPD031 CONTAINS STATEMENTS NEEDED TO INVOKE       *07370033
P10237* PROTEGRITY MODULE FOR PROTECTION / UNPROTECTION                *07380026
P10237******************************************************************07390000
P10237     COPY DPPD031.                                                07400033
P10237                                                                  07410000
