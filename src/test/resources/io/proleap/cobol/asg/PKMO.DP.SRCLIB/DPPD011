000100******************************************************************00010000
000200** THIS PROCEDURE DIVISION COPYBOOK RETRIEVES AND FORMATS THE   **00020000
000300** SYSTEM MESSAGE FOR NON-CICS ARCHITECTURE PROGRAMS.  THE      **00030000
000400** LOGIC IS VERY SIMILAR TO THAT IN DPPD005 AND DPKCS030.       **00040000
000500**                                                              **00050000
000600** ALSO COPY INTO YOUR PROGRAM: DPWS011, DPRD507I, DPPD014 AND  **00060000
000700**                              DPWS013                         **00070000
000800**                                                              **00080000
000900** TO USE THIS PROCEDURE, FILL DP011-MSG-NUMBER WITH THE NUMBER **00090000
001000** OF THE SYSTEM MESSAGE YOU DESIRE.  IF THERE IS A VARIABLE    **00100000
001100** IN THE MESSAGE, THE VALUE TO BE USED FOR THE VARIABLE SHOULD **00110000
001200** BE PUT IN DP011-MSG-VAR-IN.  SET DP011-MSG-LEVEL USING ONE   **00120000
001300** OF THE CONDITION NAMES AND THEN PERFORM                      **00130000
001400** DP011-0000-FORMAT-MSG-LINES.  A COMPLETELY FORMATTED MESSAGE **00140000
001500** WILL BE IN DP011-MSG-MESSAGE.                                **00150000
001600**                                                              **00160000
001700******************************************************************00170000
001800                                                                  00180000
001900 DP011-0000-FORMAT-MSG-LINES.                                     00190000
002000     IF  DP011-MSG-NUMBER-X IS NUMERIC                            00200000
002100         IF  DP011-MSG-NUMBER > ZERO                              00210000
002200             MOVE DP011-MSG-NUMBER  TO DP507I-MSG-NUMBER          00220000
002300             PERFORM DP011-1000-FORMAT-SYS-MESSAGE                00230000
002400         ELSE                                                     00240000
002500             IF  DP011-MSG-TEXT = SPACE                           00250000
002600                 MOVE SPACE     TO DP011-MSG-MESSAGE              00260000
002700             END-IF                                               00270000
002800         END-IF                                                   00280000
002900     END-IF.                                                      00290000
003000*                                                                 00300000
003100******************************************************************00310000
003200**  THIS PARAGRAPH DOES THE OVERALL FORMATTING OF THE MESSAGE.  **00320000
003300******************************************************************00330000
003400 DP011-1000-FORMAT-SYS-MESSAGE.                                   00340000
003500     PERFORM DP011-1100-READ-SYSTEM-MESSAGE.                      00350000
003510     INSPECT DP507I-MSG-TEXT                                      00351005
003520         TALLYING DP011-MSG-CHAR-CNT                              00352005
003530         FOR ALL DP011-MSG-VAR-SYMBOLIC                           00353005
003600     IF  DP011-MSG-CHAR-CNT > ZERO                                00360005
003700         PERFORM DP011-1200-SUBSTITUTE-MSG-VAR                    00370000
003800     ELSE                                                         00380000
003900         MOVE DP507I-MSG-TEXT  TO DP011-MSG-TEXT                  00390000
004000     END-IF.                                                      00400000
004100     SET DP011-MSG-DASH-1                                         00410000
004200         DP011-MSG-DASH-2 TO TRUE.                                00420000
004300******************************************************************00430000
004400**   READ A SYSTEM MESSAGE RECORD                               **00440000
004500******************************************************************00450000
004600 DP011-1100-READ-SYSTEM-MESSAGE.                                  00460000
004700     EXEC CICS READ                                               00470000
004800               DATASET ('DPSYSMSG')                               00480000
004900               RIDFLD  (DP507I-MSG-NUMBER)                        00490000
005000               INTO    (DP507I-MESSAGES-INPUT-RECORD)             00500000
005100               RESP    (PV-CICS-RESPONSE)                         00510000
005200     END-EXEC.                                                    00520000
005300*                                                                 00530000
005400     IF  PV-CICS-RESPONSE NOT = DFHRESP(NORMAL)                   00540000
005500         MOVE ' ** ABEND **   UNABLE TO TRANSLATE MESSAGE NUMBER' 00550000
005600                                TO DP507I-MSG-TEXT                00560000
005700         SET DP013-LINK-RETURN  TO TRUE                           00570000
005800         SET DP013-CICS-ABEND   TO TRUE                           00580000
005900         SET DP013-NO-ROLLBACK  TO TRUE                           00590000
006000         MOVE 'DP011-1100-READ-SYSTEM-MESSAGE'                    00600000
006100                                TO DP013-PARAGRAPH                00610000
006200         MOVE 'ATTEMPTING TO READ THE SYSTEM MESSAGES FILE FOR THE00620000
006300-             ' FOLLOWING MESSAGE NUMBER: '                       00630000
006400                                TO DP013-MESSAGE-TEXT (1)         00640000
006500         MOVE DP507I-MSG-NUMBER TO DP013-MESSAGE-TEXT (2)         00650000
006600*        PERFORM DP013-0000-PROCESS-ABEND                         00660000
006700     END-IF.                                                      00670000
006800***************************************************************** 00680000
006900** IF A VARIABLE WAS PASSED IN, SEARCH THE MESSAGE FOR THE     ** 00690000
007000** VARIABLE PLACE-HOLDER AND REPLACE IT WITH THE VARIABLE      ** 00700000
007100** PASSED IN.                                                  ** 00710000
007200***************************************************************** 00720000
007300 DP011-1200-SUBSTITUTE-MSG-VAR.                                   00730000
007310     MOVE +1             TO DP011-MSG-VAR-LEAD-SPACE.             00731002
007400     MOVE DP011-MSG-TEXT TO DP011-MSG-VAR-SAVE.                   00740000
007500                                                                  00750000
007600     INITIALIZE DP011-MSG-TEXT                                    00760000
007700                DP011-MSG-VAR-IND                                 00770000
007800                DP011-MSG-CHAR-CNT                                00780000
007900                DP011-MSG-REMAINDER.                              00790000
008000*                                                                 00800000
008100     UNSTRING DP507I-MSG-TEXT DELIMITED BY DP011-MSG-VAR-SYMBOLIC 00810000
008200         INTO DP011-MSG-TEXT                                      00820000
008300                 DELIMITER IN DP011-MSG-VAR-IND                   00830000
008400                 COUNT     IN DP011-MSG-STRING-PTR                00840005
008500              DP011-MSG-REMAINDER                                 00850000
008600     END-UNSTRING.                                                00860000
008700*                                                                 00870000
008800     IF  DP011-MSG-STRING-PTR > ZERO                              00880005
008900         ADD +1         TO DP011-MSG-STRING-PTR                   00890005
009100     ELSE                                                         00910000
009200         MOVE +1        TO DP011-MSG-STRING-PTR                   00920004
009300     END-IF.                                                      00930000
009400*                                                                 00940000
009401** IF THE MSG VARIABLE HAS SOMETHING OTHER THAN SPACES IN IT, BUT 00940101
009402** THERE IS A SPACE IN THE FIRST POSITION, FIND OUT HOW MANY      00940201
009403** SPACES THERE ARE AND MOVE FIELDS IN ACCORDINGLY.               00940301
009405*                                                                 00940501
009410     IF  DP011-MSG-VAR-SAVE > SPACE                               00941001
009420         IF  DP011-MSG-VAR-SAVE(1:1) > SPACE                      00942001
009430             CONTINUE                                             00943001
009810         ELSE                                                     00981001
009814             INSPECT DP011-MSG-VAR-SAVE                           00981401
009815                 TALLYING DP011-MSG-VAR-LEAD-SPACE                00981502
009816                 FOR LEADING SPACE                                00981601
009817         END-IF                                                   00981701
009818     ELSE                                                         00981801
009819         MOVE '?'       TO DP011-MSG-VAR-SAVE                     00981903
009820     END-IF.                                                      00982001
009821*> FIND THE LAST NON-BLANK CHARACTER IN THE MSG VARIABLE.         00982103
009822     MOVE LENGTH OF DP011-MSG-VAR-SAVE                            00982203
009823                        TO DP011-MSG-VAR-LEN.                     00982303
009824     PERFORM                                                      00982403
009825         VARYING DP011-CHAR-POS                                   00982503
009826         FROM DP011-MSG-VAR-LEN                                   00982603
009827         BY -1                                                    00982703
009828         UNTIL DP011-CHAR-POS < 1                                 00982803
009829            OR DP011-MSG-VAR-SAVE(DP011-CHAR-POS:1) > SPACE       00982903
009830              CONTINUE                                            00983003
009831     END-PERFORM.                                                 00983103
009832     COMPUTE DP011-MSG-VAR-LEN =                                  00983203
009833         DP011-CHAR-POS - DP011-MSG-VAR-LEAD-SPACE + 1.           00983303
009834*> MOVE THE VARIABLE                                              00983403
009835     IF  DP011-MSG-STRING-PTR < LENGTH OF DP011-MSG-TEXT          00983505
009836         MOVE DP011-MSG-VAR-SAVE                                  00983605
009837                    (DP011-MSG-VAR-LEAD-SPACE:DP011-MSG-VAR-LEN)  00983703
009838                        TO DP011-MSG-TEXT(DP011-MSG-STRING-PTR:)  00983805
009839     END-IF.                                                      00983905
009840     ADD DP011-MSG-VAR-LEN TO DP011-MSG-STRING-PTR.               00984003
009841*> MOVE THE REST OF THE MESSAGE                                   00984103
009842     IF  DP011-MSG-STRING-PTR < LENGTH OF DP011-MSG-TEXT          00984205
009843         MOVE DP011-MSG-REMAINDER                                 00984305
009850                        TO DP011-MSG-TEXT (DP011-MSG-STRING-PTR:) 00985005
009860     END-IF.                                                      00986005
