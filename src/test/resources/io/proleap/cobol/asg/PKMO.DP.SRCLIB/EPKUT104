000100******************************************************************00010015
000200 IDENTIFICATION DIVISION.                                         00020001
000300******************************************************************00030001
000400 PROGRAM-ID.    EPKUT104.                                         00040001
000500 AUTHOR.        CHRIS CLARK                                       00050001
000600 DATE-WRITTEN.  JANUARY, 2003.                                    00060001
000700                                                                  00070001
000800******************************************************************00080001
000900* THIS PROGRAM EXTRACTS CHANGES TO XREF DATA SINCE THE LAST RUN   00090006
001000* ALL RECORDS ARE GLOBAL. A LIST ON THE MID-TIER WILL CAUSE THE   00100006
001100* FILE TO BE DISTRIBUTED TO THE APPROPRIATE STORES.  CHANGES ARE  00110015
001200* EITHER ADDS OR DELETES.  NOTHING CAN CHANGE AT THE STORE, SO    00120006
001300* UPDATE IS NOT A VALID ACTION CODE.  THIS PROGRAM RUNS NIGHTLY   00130006
001400* AS PART OF THE PLU AND XREF EXTRACT PROCESS.                    00140006
001500******************************************************************00150001
001600* HISTORY LOG:                                                    00160001
001700*                                                                 00170001
001800* DATE: 07 JUNE 2011                                              00180062
001900* WR/IR#: PKE#8048                                                00190063
002000* PROGRAMMER: COGNIZANT                                           00200063
002100* DESCRIPTION:CHANGED THE CHANGES CURSOR TO ALSO CHECK THE LAST   00210063
002200*             UPDATED TIMESTAMP WITH CURRENT EXTRACT RUN          00220063
002300*             TIMESTAMP.                                          00230063
002400*                                                                 00240060
002500* DATE: 02/14/2023                                                00250066
002600* WR/IR#: CHG0281369                                              00260066
002700* PROGRAMMER: JEAN KURK                                           00270066
002800* DESCRIPTION: CHANGE CALL OF UPC CHECK DIGIT ROUTINE TO DYNAMIC  00280068
003000******************************************************************00300001
003100 ENVIRONMENT DIVISION.                                            00310001
003200******************************************************************00320001
003300 CONFIGURATION SECTION.                                           00330001
003400 SOURCE-COMPUTER. IBM-3090.                                       00340001
003500 OBJECT-COMPUTER. IBM-3090.                                       00350001
003600                                                                  00360001
003700 INPUT-OUTPUT SECTION.                                            00370001
003800                                                                  00380001
003900 FILE-CONTROL.                                                    00390001
004000                                                                  00400001
004100     SELECT CC-DATE-FILE                                          00410001
004200       ASSIGN TO INP01.                                           00420001
004300                                                                  00430001
004400     SELECT CC-TIME-STMP-FILE                                     00440002
004500       ASSIGN TO INP02.                                           00450002
004600                                                                  00460002
004700     SELECT XREF-REACTIVATED-FILE                                 00470013
004800       ASSIGN TO INP03.                                           00480002
004900                                                                  00490001
005000     SELECT XREF-DUMMY-FILE                                       00500013
005100       ASSIGN TO INP04.                                           00510013
005200                                                                  00520013
005300     SELECT XREF-SQLS-OUTPUT-FILE                                 00530053
005400       ASSIGN TO OUT01.                                           00540063
005500                                                                  00550053
005600******************************************************************00560001
005700 DATA DIVISION.                                                   00570001
005800******************************************************************00580001
005900 FILE SECTION.                                                    00590001
006000                                                                  00600001
006100 FD  CC-DATE-FILE                                                 00610001
006200     RECORDING MODE IS F                                          00620001
006300     BLOCK CONTAINS 0 RECORDS                                     00630001
006400     LABEL RECORDS ARE STANDARD.                                  00640001
006500                                                                  00650001
006600 01  CC-DATE-RECORD                         PIC  X(80).           00660001
006700                                                                  00670001
006800 FD  CC-TIME-STMP-FILE                                            00680002
006900     RECORDING MODE IS F                                          00690002
007000     BLOCK CONTAINS 0 RECORDS                                     00700002
007100     LABEL RECORDS ARE STANDARD.                                  00710002
007200                                                                  00720002
007300 01  CC-TIME-STMP-RECORD                    PIC  X(80).           00730002
007400                                                                  00740002
007500 FD  XREF-REACTIVATED-FILE                                        00750013
007600     RECORDING MODE IS F                                          00760001
007700     LABEL RECORDS ARE STANDARD                                   00770001
007800     RECORD CONTAINS 50 CHARACTERS                                00780036
007900     DATA RECORD IS XREF-REACTIVATED-RECORD.                      00790013
008000 01  XREF-REACTIVATED-RECORD                PIC  X(50).           00800036
008100                                                                  00810001
008200 FD  XREF-DUMMY-FILE                                              00820013
008300     RECORDING MODE IS F                                          00830013
008400     LABEL RECORDS ARE STANDARD                                   00840013
008500     RECORD CONTAINS 50 CHARACTERS                                00850036
008600     DATA RECORD IS XREF-DUMMY-RECORD.                            00860013
008700 01  XREF-DUMMY-RECORD                      PIC  X(50).           00870036
008800                                                                  00880013
008900 FD  XREF-SQLS-OUTPUT-FILE                                        00890053
009000     RECORDING MODE IS F                                          00900053
009100     BLOCK CONTAINS 0 RECORDS                                     00910053
009200     LABEL RECORDS ARE STANDARD.                                  00920053
009300 01  XREF-SQLS-OUTPUT-RECORD                PIC  X(80).           00930053
009400                                                                  00940053
009500******************************************************************00950001
009600 WORKING-STORAGE SECTION.                                         00960001
009700******************************************************************00970001
009800                                                                  00980001
009900******************************************************************00990001
010000* PC- PROGRAM CONSTANTS                                           01000001
010100******************************************************************01010001
010200 01  PC-PROGRAM-CONSTANTS.                                        01020001
010300   05  PC-CURRENT-PROGRAM-NAME        PIC  X(008)                 01030001
010400        VALUE 'EPKUT104'.                                         01040053
010500   05  PC-STR-GRP-TYP-CDE-CORP      PIC 9(05)  VALUE 1000.        01050053
010600   05  PC-STR-GRP-ID-CORP           PIC 9(10)  VALUE 0000000001.  01060053
010700                                                                  01070001
010800 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      01080001
010900                                                  COMP SYNC.      01090001
011000     88  AC-INVALID-DATA                          VALUE +4002.    01100065
011100     88  AC-CONTROL-CARD-ERROR                    VALUE +4003.    01110065
011200     88  AC-DATE-CARD-ERROR                       VALUE +4003.    01120001
011300     88  AC-TABLE-ERROR                           VALUE +4004.    01130001
011400     88  AC-DB2-ERROR                             VALUE +4013.    01140001
011500     88  AC-CALENDAR-ROUTINE-ERROR                VALUE +4019.    01150001
011600                                                                  01160001
011700******************************************************************01170001
011800* PS- PROGRAM SWITCHES                                            01180001
011900******************************************************************01190001
012000 01  PS-PROGRAM-SWITCHES.                                         01200001
012100     05  PS-EOF-DATE-FILE-SW              PIC  X(01) VALUE 'N'.   01210001
012200         88  PS-EOF-DATE-FILE-Y                      VALUE 'Y'.   01220001
012300     05  PS-EOF-TIME-STMP-FILE-SW         PIC  X(01) VALUE 'N'.   01230010
012400         88  PS-EOF-TIME-STMP-FILE-Y                 VALUE 'Y'.   01240010
012500     05  PS-EOF-REACTIVATED-FILE-SW       PIC  X(01) VALUE 'N'.   01250016
012600         88  PS-EOF-REACTIVATED-FILE-Y               VALUE 'Y'.   01260021
012700     05  PS-EOF-DUMMY-FILE-SW             PIC  X(01) VALUE 'N'.   01270014
012800         88  PS-EOF-DUMMY-FILE-Y                     VALUE 'Y'.   01280021
012900     05  PS-END-OF-CHANGES-CSR-SW         PIC  X(01) VALUE 'N'.   01290018
013000         88  PS-END-OF-CHANGES-CSR-Y                 VALUE 'Y'.   01300018
013100     05  PS-END-OF-REACTIVATED-CSR-SW     PIC  X(01) VALUE 'N'.   01310018
013200         88  PS-END-OF-REACTIVATED-CSR               VALUE 'Y'.   01320051
013300         88  PS-MORE-REACTIVATED-CSR                 VALUE 'N'.   01330051
013400     05  PS-ANY-REACTIVATED-SW            PIC  X(01) VALUE 'N'.   01340035
013500         88  PS-ANY-REACTIVATED-Y                    VALUE 'Y'.   01350035
013600         88  PS-ANY-REACTIVATED-N                    VALUE 'N'.   01360035
013700******************************************************************01370001
013800* PV- PROGRAM WORKING VARIABLES                                   01380001
013900******************************************************************01390001
014000 01  PV-MISC-FIELDS.                                              01400001
014100     05  PV-OPERATION-MSG-1           PIC  X(40)  VALUE SPACE.    01410001
014200     05  PV-OPERATION-MSG-2           PIC  X(40)  VALUE SPACE.    01420001
014300     05  PV-PARAGRAPH-NAME            PIC  X(30)  VALUE SPACE.    01430001
014400     05  PV-DB2-OPERATION             PIC  X(30)  VALUE SPACE.    01440001
014500     05  PV-INTERNAL-UPC-ID-TMP       PIC S9(10) COMP VALUE ZEROS.01450007
014600     05  PV-INTERNAL-UPC-ID           PIC S9(9)  COMP VALUE ZEROS.01460007
014700     05  PV-REACTIVE-READ-CNT         PIC  9(9)  VALUE ZEROS.     01470049
014800     05  PV-DUMMY-READ-CNT            PIC  9(9)  VALUE ZEROS.     01480049
014900     05  PV-MERCH-UPDATE-CNT          PIC  9(9)  VALUE ZEROS.     01490053
015000     05  PV-REACT-SQLS-WRITE-CNT      PIC  9(9)  VALUE ZEROS.     01500053
015100     05  PV-DUMMY-SQLS-WRITE-CNT      PIC  9(9)  VALUE ZEROS.     01510053
015200     05  PV-MERCH-SQLS-WRITE-CNT      PIC  9(9)  VALUE ZEROS.     01520053
015300     05  PV-MERCH-SQLS-DEL-CNT        PIC  9(9)  VALUE ZEROS.     01530053
015400     05  PV-MERCH-SQLS-ADD-CNT        PIC  9(9)  VALUE ZEROS.     01540053
015500     05  PV-TOTAL-SQLS-WRITE-CNT      PIC  9(9)  VALUE ZEROS.     01550053
015600                                                                  01560001
015700******************************************************************01570002
015800* COPY BOOK FOR CALLING PROGRAM UPC CHECK DIGIT ROUTINE.          01580068
015900******************************************************************01590002
016000     COPY DPWS040I.                                               01600002
016100                                                                  01610002
016200******************************************************************01620056
016300* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         01630056
016400******************************************************************01640056
016500     COPY DPWS004.                                                01650056
016600                                                                  01660056
016700******************************************************************01670056
016800* DB2 ABEND COPYBOOK                                              01680056
016900******************************************************************01690056
017000     COPY DPWS900.                                                01700056
017100                                                                  01710056
017200******************************************************************01720001
017300* FULL XREF DRIVER FILE LAYOUT.                                   01730001
017400******************************************************************01740001
017500     COPY EPRD074.                                                01750001
017600                                                                  01760001
017700******************************************************************01770017
017800* XREF SKU CHANGED FILE LAYOUT.                                   01780017
017900******************************************************************01790017
018000     COPY EPRD075.                                                01800017
018100                                                                  01810017
018200******************************************************************01820059
018300* SQL SERVER UPC/SKU XREF FILE LAYOUT.                            01830059
018400******************************************************************01840059
018500     COPY EPRD218.                                                01850059
018600                                                                  01860059
018700******************************************************************01870002
018800* PERM XREF EXTRACT FILE LAYOUT.                                  01880002
018900******************************************************************01890002
019000     COPY EPWS105.                                                01900002
019100                                                                  01910002
019200******************************************************************01920009
019300* PERM XREF EFFECTIVE DATE CONTROL CARD LAYOUT.                   01930009
019400******************************************************************01940009
019500     COPY EPWS112.                                                01950009
019600                                                                  01960009
019700******************************************************************01970001
019800*  DB2 COMMUNICATION AREA.                                        01980001
019900******************************************************************01990001
020000     EXEC SQL                                                     02000001
020100          INCLUDE SQLCA                                           02010001
020200     END-EXEC.                                                    02020001
020300                                                                  02030001
020400******************************************************************02040001
020500*  DB2 TABLE DB2PDBA.XST_UPC - UPC XREF TABLE                     02050001
020600******************************************************************02060001
020700     EXEC SQL                                                     02070001
020800          INCLUDE XST00012                                        02080001
020900     END-EXEC.                                                    02090001
021000                                                                  02100001
021100******************************************************************02110053
021200*  DB2 TABLE DB2PDBA.XST_SKU - SKU TABLE                          02120053
021300******************************************************************02130053
021400     EXEC SQL                                                     02140053
021500          INCLUDE XST00010                                        02150053
021600     END-EXEC.                                                    02160053
021700                                                                  02170053
021800******************************************************************02180031
021900*  DB2 TABLE DB2PDBA.XST_SKU_LOC                                  02190031
022000******************************************************************02200031
022100     EXEC SQL                                                     02210031
022200          INCLUDE XST00008                                        02220031
022300     END-EXEC.                                                    02230031
022400                                                                  02240031
022500******************************************************************02250031
022600*  DB2 TABLE DB2PDBA.XST_SKU_ATTR                                 02260031
022700******************************************************************02270031
022800     EXEC SQL                                                     02280031
022900          INCLUDE XST00011                                        02290031
023000     END-EXEC.                                                    02300031
023100                                                                  02310031
023200******************************************************************02320001
023300*  CHANGES CURSOR.                                                02330007
023400******************************************************************02340001
023500     EXEC SQL                                                     02350001
023600        DECLARE CHANGES-CSR CURSOR FOR                            02360002
023700         SELECT  U.UPC_NBR                                        02370064
023800                ,U.LAST_ACTN_CDE                                  02380063
023900                ,S.SKU_NBR                                        02390063
024000           FROM XST_UPC   U                                       02400030
024100               ,XST_SKU   S                                       02410053
024200          WHERE U.LAST_UPD_TMST      > :CC-EPCC105-PREV-TIMESTAMP 02420030
024300            AND U.LAST_UPD_TMST     <= :CC-EPCC105-CRNT-TIMESTAMP 02430061
024400            AND S.INTR_UPC_ID = U.INTR_UPC_ID                     02440060
024500            AND EXISTS                                            02450002
024600                (SELECT 1                                         02460002
024700                   FROM XST_SKU_LOC L                             02470002
024800                  WHERE L.INTR_UPC_ID          = U.INTR_UPC_ID    02480030
024900                    AND L.LOC_NBR              = 0                02490007
025000                    AND L.END_TMST            IS NULL)            02500012
025100            AND EXISTS                                            02510005
025200                (SELECT 1                                         02520005
025300                   FROM XST_SKU_ATTR A                            02530005
025400                  WHERE A.INTR_UPC_ID          = U.INTR_UPC_ID    02540030
025500                    AND A.PLU_DWNLD_EXCL_IND  <> 'Y')             02550030
025600                WITH UR                                           02560001
025700     END-EXEC.                                                    02570001
025800                                                                  02580001
025900******************************************************************02590007
026000*  RE-ACTIVATED SKU CURSOR                                        02600007
026100******************************************************************02610007
026200     EXEC SQL                                                     02620007
026300        DECLARE REACTIVATED-CSR CURSOR FOR                        02630018
026400         SELECT U.UPC_NBR                                         02640053
026500               ,S.SKU_NBR                                         02650053
026600           FROM XST_UPC   U                                       02660053
026700               ,XST_SKU   S                                       02670053
026800          WHERE U.INTR_UPC_ID        = :PV-INTERNAL-UPC-ID        02680053
026900            AND U.LAST_UPD_TMST     <= :CC-EPCC105-PREV-TIMESTAMP 02690053
027000            AND U.LAST_ACTN_CDE     <> 'D'                        02700053
027100            AND S.INTR_UPC_ID        = U.INTR_UPC_ID              02710053
027200                WITH UR                                           02720007
027300     END-EXEC.                                                    02730007
027400                                                                  02740007
027500******************************************************************02750001
027600 PROCEDURE DIVISION.                                              02760001
027700******************************************************************02770001
027800 0000-MAINLINE.                                                   02780001
027900                                                                  02790001
028000     PERFORM 1000-INITIALIZE.                                     02800001
028100     PERFORM 2000-PROCESS-CHANGES.                                02810010
028200                                                                  02820049
028300     PERFORM 2100-PROCESS-RE-ACTIVATED.                           02830013
028400                                                                  02840049
028500     PERFORM 2200-PROCESS-DUMMY.                                  02850013
028600                                                                  02860049
028700     PERFORM 9200-CLOSE-FILES.                                    02870057
028800     PERFORM 9900-DISPLAY-COUNTS.                                 02880057
028900                                                                  02890001
029000     STOP RUN.                                                    02900001
029100*0000-EXIT.                                                       02910001
029200                                                                  02920001
029300******************************************************************02930001
029400* 1000-INITIALIZE-PROGRAM                                         02940001
029500*     OPEN FILES, PROCESS CONTROL CARD                            02950007
029600******************************************************************02960001
029700 1000-INITIALIZE.                                                 02970001
029800                                                                  02980001
029900     OPEN INPUT  CC-DATE-FILE                                     02990001
030000                 CC-TIME-STMP-FILE                                03000007
030100                 XREF-REACTIVATED-FILE                            03010013
030200                 XREF-DUMMY-FILE                                  03020013
030300          OUTPUT XREF-SQLS-OUTPUT-FILE.                           03030063
030400                                                                  03040054
030500     PERFORM 1100-READ-DATE-FILE.                                 03050001
030600     DISPLAY '*** EPKUT104 ***'.                                  03060049
030700     DISPLAY 'EPCC112 TOMORROW CONTROL CARD: '                    03070049
030800             CC-EPCC112-TOMORROW-DATE.                            03080049
030900                                                                  03090049
031000     PERFORM 1200-READ-TIME-STMP-FILE.                            03100008
031100     DISPLAY 'EPCC105 PREV TIMESTAMP CONTROL CARD: '              03110049
031200             CC-EPCC105-PREV-TIMESTAMP.                           03120049
031300                                                                  03130001
031400******************************************************************03140001
031500* 1100-READ-DATE-FILE                                             03150001
031600*     READ DATE CONTROL CARD.                                     03160001
031700******************************************************************03170001
031800 1100-READ-DATE-FILE.                                             03180001
031900                                                                  03190001
032000     READ CC-DATE-FILE INTO CC-EPCC112-CONTROL-CARD               03200010
032100        AT END                                                    03210001
032200           SET PS-EOF-DATE-FILE-Y TO TRUE                         03220001
032300     END-READ.                                                    03230001
032400                                                                  03240001
032500 EJECT                                                            03250001
032600******************************************************************03260008
032700* 1200-READ-TIME-STMP-FILE                                        03270008
032800*     READ TIME STAMP CONTROL CARD.                               03280008
032900******************************************************************03290008
033000 1200-READ-TIME-STMP-FILE.                                        03300008
033100                                                                  03310008
033200     READ CC-TIME-STMP-FILE INTO CC-EPCC105-CONTROL-CARD          03320010
033300        AT END                                                    03330008
033400           SET PS-EOF-TIME-STMP-FILE-Y TO TRUE                    03340008
033500     END-READ.                                                    03350008
033600                                                                  03360008
033700 EJECT                                                            03370008
033800******************************************************************03380001
033900* 2000-PROCESS-CHANGES.                                           03390010
034000******************************************************************03400001
034100 2000-PROCESS-CHANGES.                                            03410010
034200                                                                  03420001
034300     PERFORM 4000-OPEN-CHANGES-CURSOR.                            03430010
034400     PERFORM 4100-FETCH-CHANGES-CURSOR                            03440010
034500         UNTIL PS-END-OF-CHANGES-CSR-Y.                           03450018
034600     PERFORM 4200-CLOSE-CHANGES-CURSOR.                           03460010
034700                                                                  03470001
034800******************************************************************03480010
034900* 2100-PROCESS-RE-ACTIVATED.                                      03490013
035000******************************************************************03500010
035100 2100-PROCESS-RE-ACTIVATED.                                       03510013
035200                                                                  03520010
035300     READ XREF-REACTIVATED-FILE INTO EP075-XREF-SKU-CHG-REC       03530018
035400        AT END                                                    03540010
035500           SET PS-EOF-REACTIVATED-FILE-Y   TO TRUE.               03550016
035600                                                                  03560010
035700     PERFORM 3000-PROCESS-REACTIVATED-FILE                        03570016
035800        UNTIL PS-EOF-REACTIVATED-FILE-Y.                          03580016
035900                                                                  03590010
036000******************************************************************03600013
036100* 2200-PROCESS-DUMMY.                                             03610013
036200******************************************************************03620013
036300 2200-PROCESS-DUMMY.                                              03630013
036400                                                                  03640013
036500     READ XREF-DUMMY-FILE INTO EP074-XREF-DRIVE-RECORD            03650013
036600        AT END                                                    03660013
036700           SET PS-EOF-DUMMY-FILE-Y   TO TRUE.                     03670014
036800                                                                  03680013
036900     PERFORM 3100-PROCESS-DUMMY-FILE                              03690021
037000        UNTIL PS-EOF-DUMMY-FILE-Y.                                03700014
037100                                                                  03710013
037200******************************************************************03720001
037300* 3000-PROCESS-REACTIVATED-FILE.                                  03730016
037400******************************************************************03740001
037500 3000-PROCESS-REACTIVATED-FILE.                                   03750016
037600                                                                  03760049
037700     ADD +1 TO PV-REACTIVE-READ-CNT.                              03770049
037800                                                                  03780001
037900     SET PS-MORE-REACTIVATED-CSR      TO TRUE.                    03790051
038000     MOVE EP075-INTERNAL-UPC-ID       TO PV-INTERNAL-UPC-ID-TMP.  03800028
038100     MOVE PV-INTERNAL-UPC-ID-TMP      TO PV-INTERNAL-UPC-ID.      03810028
038200                                                                  03820028
038300     PERFORM 4300-OPEN-REACTIVATED-CURSOR.                        03830018
038400     PERFORM 4400-FETCH-REACTIVATED-CURSOR                        03840018
038500         UNTIL PS-END-OF-REACTIVATED-CSR.                         03850051
038600     PERFORM 4500-CLOSE-REACTIVATED-CURSOR.                       03860018
038700     SET PS-ANY-REACTIVATED-N TO TRUE.                            03870035
038800                                                                  03880018
038900     READ XREF-REACTIVATED-FILE INTO EP075-XREF-SKU-CHG-REC       03890018
039000        AT END                                                    03900001
039100           SET PS-EOF-REACTIVATED-FILE-Y   TO TRUE.               03910016
039200                                                                  03920001
039300******************************************************************03930014
039400* 3100-PROCESS-DUMMY-FILE.                                        03940014
039500******************************************************************03950014
039600 3100-PROCESS-DUMMY-FILE.                                         03960014
039700                                                                  03970049
039800     ADD +1 TO PV-DUMMY-READ-CNT.                                 03980049
039900                                                                  03990014
040000     PERFORM 6200-FORMAT-SQLS-DUMMY-DATA.                         04000053
040100                                                                  04010014
040200     READ XREF-DUMMY-FILE INTO EP074-XREF-DRIVE-RECORD            04020014
040300        AT END                                                    04030014
040400           SET PS-EOF-DUMMY-FILE-Y   TO TRUE.                     04040014
040500                                                                  04050014
040600******************************************************************04060001
040700* 4000-OPEN-CHANGES-CURSOR.                                       04070010
040800*     OPEN CHANGES CURSOR                                         04080010
040900******************************************************************04090001
041000 4000-OPEN-CHANGES-CURSOR.                                        04100010
041100                                                                  04110001
041200     EXEC SQL                                                     04120001
041300          OPEN CHANGES-CSR                                        04130010
041400     END-EXEC.                                                    04140001
041500                                                                  04150001
041600     EVALUATE TRUE                                                04160001
041700         WHEN SQLCODE = ZERO                                      04170001
041800              CONTINUE                                            04180001
041900         WHEN SQLWARN0 NOT EQUAL SPACE                            04190001
042000         WHEN SQLCODE NOT EQUAL ZERO                              04200001
042100             MOVE '4000-OPEN-CHANGES-CURSOR'                      04210010
042200                                   TO PV-PARAGRAPH-NAME           04220001
042300             MOVE 'ERROR ON OPEN OF CHANGES-CSR CURSOR'           04230010
042400                                   TO PV-DB2-OPERATION            04240001
042500             PERFORM 9100-SQL-ABEND                               04250001
042600     END-EVALUATE.                                                04260001
042700 EJECT                                                            04270001
042800                                                                  04280001
042900******************************************************************04290001
043000* 4100-FETCH-CHANGES-CURSOR                                       04300010
043100******************************************************************04310001
043200 4100-FETCH-CHANGES-CURSOR.                                       04320010
043300                                                                  04330001
043400     EXEC SQL                                                     04340001
043500          FETCH CHANGES-CSR                                       04350010
043600           INTO :XST00012-UPC-NBR                                 04360063
043700               ,:XST00012-LAST-ACTN-CDE                           04370010
043800               ,:XST00010-SKU-NBR                                 04380059
043900     END-EXEC.                                                    04390001
044000                                                                  04400001
044100     EVALUATE TRUE                                                04410001
044200         WHEN SQLCODE = ZERO                                      04420001
044300             PERFORM 6000-FORMAT-SQLS-OUTPUT-DATA                 04430059
044400         WHEN SQLCODE = +100                                      04440001
044500             SET PS-END-OF-CHANGES-CSR-Y  TO TRUE                 04450022
044600         WHEN SQLWARN0 NOT EQUAL SPACE                            04460001
044700         WHEN SQLCODE NOT EQUAL ZERO                              04470001
044800             MOVE '4100-FETCH-CHANGES-CURSOR'                     04480010
044900                                   TO PV-PARAGRAPH-NAME           04490001
045000             MOVE 'ERROR ON FETCH OF CHANGES-CSR CURSOR'          04500010
045100                                   TO PV-DB2-OPERATION            04510001
045200             PERFORM 9100-SQL-ABEND                               04520001
045300     END-EVALUATE.                                                04530001
045400 EJECT                                                            04540001
045500                                                                  04550001
045600******************************************************************04560001
045700* 4200-CLOSE-CHANGES-CURSOR                                       04570010
045800******************************************************************04580001
045900 4200-CLOSE-CHANGES-CURSOR.                                       04590010
046000                                                                  04600001
046100     EXEC SQL                                                     04610001
046200          CLOSE CHANGES-CSR                                       04620010
046300     END-EXEC.                                                    04630001
046400                                                                  04640001
046500     EVALUATE TRUE                                                04650001
046600         WHEN SQLCODE = ZERO                                      04660001
046700              CONTINUE                                            04670001
046800         WHEN SQLWARN0 NOT EQUAL SPACE                            04680001
046900         WHEN SQLCODE NOT EQUAL ZERO                              04690001
047000             MOVE '4200-CLOSE-CHANGES-CURSOR'                     04700010
047100                                   TO PV-PARAGRAPH-NAME           04710001
047200             MOVE 'ERROR ON CLOSE OF CHANGES-CSR CURSOR'          04720010
047300                                   TO PV-DB2-OPERATION            04730001
047400             PERFORM 9100-SQL-ABEND                               04740001
047500     END-EVALUATE.                                                04750001
047600 EJECT                                                            04760001
047700                                                                  04770001
047800******************************************************************04780018
047900* 4300-OPEN-REACTIVATED-CURSOR.                                   04790018
048000*     OPEN REACTIVATED-CURSOR                                     04800018
048100******************************************************************04810018
048200 4300-OPEN-REACTIVATED-CURSOR.                                    04820018
048300                                                                  04830018
048400     EXEC SQL                                                     04840018
048500          OPEN REACTIVATED-CSR                                    04850018
048600     END-EXEC.                                                    04860018
048700                                                                  04870018
048800     EVALUATE TRUE                                                04880018
048900         WHEN SQLCODE = ZERO                                      04890018
049000              CONTINUE                                            04900018
049100         WHEN SQLWARN0 NOT EQUAL SPACE                            04910018
049200         WHEN SQLCODE NOT EQUAL ZERO                              04920018
049300             MOVE '4300-OPEN-REACTIVATED-CURSOR'                  04930018
049400                                   TO PV-PARAGRAPH-NAME           04940018
049500             MOVE 'ERROR ON OPEN OF REACTIVATED-CSR CURSOR'       04950018
049600                                   TO PV-DB2-OPERATION            04960018
049700             PERFORM 9100-SQL-ABEND                               04970018
049800     END-EVALUATE.                                                04980018
049900 EJECT                                                            04990018
050000                                                                  05000018
050100******************************************************************05010018
050200* 4400-FETCH-REACTIVATED-CURSOR                                   05020018
050300******************************************************************05030018
050400 4400-FETCH-REACTIVATED-CURSOR.                                   05040018
050500                                                                  05050018
050600     EXEC SQL                                                     05060018
050700          FETCH REACTIVATED-CSR                                   05070018
050800           INTO :XST00012-UPC-NBR                                 05080018
050900               ,:XST00010-SKU-NBR                                 05090059
051000     END-EXEC.                                                    05100018
051100                                                                  05110018
051200     EVALUATE TRUE                                                05120018
051300         WHEN SQLCODE = ZERO                                      05130018
051400             SET PS-ANY-REACTIVATED-Y TO TRUE                     05140035
051500             PERFORM 6100-FORMAT-SQLS-REACTIV-DATA                05150059
051600         WHEN SQLCODE = +100                                      05160018
051700             SET PS-END-OF-REACTIVATED-CSR    TO TRUE             05170051
051800             IF PS-ANY-REACTIVATED-N                              05180035
051900                MOVE '4400-FETCH-REACTIVATED-CURSOR'              05190035
052000                                      TO PV-PARAGRAPH-NAME        05200035
052100                MOVE 'ERROR ON FETCH OF REACTIVATED-CSR CURSOR'   05210035
052200                                      TO PV-DB2-OPERATION         05220035
052300                PERFORM 9100-SQL-ABEND                            05230035
052400             END-IF                                               05240035
052500         WHEN SQLWARN0 NOT EQUAL SPACE                            05250018
052600         WHEN SQLCODE NOT EQUAL ZERO                              05260018
052700             MOVE '4400-FETCH-REACTIVATED-CURSOR'                 05270018
052800                                   TO PV-PARAGRAPH-NAME           05280018
052900             MOVE 'ERROR ON FETCH OF REACTIVATED-CSR CURSOR'      05290018
053000                                   TO PV-DB2-OPERATION            05300018
053100             PERFORM 9100-SQL-ABEND                               05310018
053200     END-EVALUATE.                                                05320018
053300 EJECT                                                            05330018
053400                                                                  05340018
053500******************************************************************05350018
053600* 4500-CLOSE-REACTIVATED-CURSOR                                   05360018
053700******************************************************************05370018
053800 4500-CLOSE-REACTIVATED-CURSOR.                                   05380018
053900                                                                  05390018
054000     EXEC SQL                                                     05400018
054100          CLOSE REACTIVATED-CSR                                   05410018
054200     END-EXEC.                                                    05420018
054300                                                                  05430018
054400     EVALUATE TRUE                                                05440018
054500         WHEN SQLCODE = ZERO                                      05450018
054600              CONTINUE                                            05460018
054700         WHEN SQLWARN0 NOT EQUAL SPACE                            05470018
054800         WHEN SQLCODE NOT EQUAL ZERO                              05480018
054900             MOVE '4500-CLOSE-REACTIVATED-CURSOR'                 05490018
055000                                   TO PV-PARAGRAPH-NAME           05500018
055100             MOVE 'ERROR ON CLOSE OF REACTIVATED-CSR CURSOR'      05510018
055200                                   TO PV-DB2-OPERATION            05520018
055300             PERFORM 9100-SQL-ABEND                               05530018
055400     END-EVALUATE.                                                05540018
055500 EJECT                                                            05550018
055600                                                                  05560018
055700******************************************************************05570053
055800* 6000-FORMAT-SQLS-OUTPUT-DATA.                                   05580053
055900******************************************************************05590053
056000 6000-FORMAT-SQLS-OUTPUT-DATA.                                    05600053
056100                                                                  05610053
056200     MOVE CC-EPCC112-TOMORROW-DATE TO EP218-XREF-EFFECT-DTE.      05620053
056300     MOVE PC-STR-GRP-TYP-CDE-CORP  TO EP218-STR-GRP-TYP-CDE.      05630053
056400     MOVE PC-STR-GRP-ID-CORP       TO EP218-STR-GRP-ID.           05640053
056500     SET  EP218-FILE-CHANGE        TO TRUE.                       05650053
056600     SET  EP218-APPLY-NIGHTLY      TO TRUE.                       05660053
056700     MOVE XST00012-UPC-NBR         TO EP218-UPC-NBR.              05670053
056800     IF XST00012-LAST-ACTN-CDE = 'A'                              05680053
056900        SET EP218-RECORD-ADD       TO TRUE                        05690053
057000        ADD +1                     TO PV-MERCH-SQLS-ADD-CNT       05700053
057100     ELSE                                                         05710053
057200        IF XST00012-LAST-ACTN-CDE = 'D'                           05720053
057300           SET EP218-RECORD-DELETE TO TRUE                        05730053
057400           ADD +1                  TO PV-MERCH-SQLS-DEL-CNT       05740053
057500        ELSE                                                      05750053
057600           IF XST00012-LAST-ACTN-CDE = 'U'                        05760053
057700              ADD +1                  TO PV-MERCH-UPDATE-CNT      05770053
057800              SET EP218-RECORD-DELETE TO TRUE                     05780053
057900              MOVE ZERO               TO EP218-SKU-NBR            05790053
058000              PERFORM 7100-WRITE-XREF-SQLS-RECORD                 05800053
058100              ADD +1                  TO PV-MERCH-SQLS-DEL-CNT    05810053
058200              SET EP218-RECORD-ADD    TO TRUE                     05820053
058300              ADD +1                  TO PV-MERCH-SQLS-ADD-CNT    05830053
058400           END-IF                                                 05840053
058500        END-IF                                                    05850053
058600     END-IF.                                                      05860053
058700                                                                  05870053
058800     MOVE XST00010-SKU-NBR       TO EP218-SKU-NBR.                05880053
058900                                                                  05890053
059000     PERFORM 7100-WRITE-XREF-SQLS-RECORD.                         05900053
059100                                                                  05910053
059200     ADD +1 TO PV-MERCH-SQLS-WRITE-CNT.                           05920053
059300                                                                  05930053
059400******************************************************************05940053
059500* 6100-FORMAT-SQLS-REACTIV-DATA.                                  05950053
059600******************************************************************05960053
059700 6100-FORMAT-SQLS-REACTIV-DATA.                                   05970053
059800                                                                  05980053
059900     MOVE CC-EPCC112-TOMORROW-DATE TO EP218-XREF-EFFECT-DTE.      05990053
060000     MOVE PC-STR-GRP-TYP-CDE-CORP  TO EP218-STR-GRP-TYP-CDE.      06000053
060100     MOVE PC-STR-GRP-ID-CORP       TO EP218-STR-GRP-ID.           06010053
060200     SET  EP218-FILE-CHANGE        TO TRUE.                       06020053
060300     SET  EP218-APPLY-NIGHTLY      TO TRUE.                       06030053
060400     SET  EP218-RECORD-ADD         TO TRUE                        06040053
060500                                                                  06050053
060600     MOVE XST00012-UPC-NBR         TO EP218-UPC-NBR.              06060053
060700     MOVE XST00010-SKU-NBR         TO EP218-SKU-NBR.              06070053
060800                                                                  06080053
060900     PERFORM 7100-WRITE-XREF-SQLS-RECORD.                         06090053
061000                                                                  06100053
061100     ADD +1 TO PV-REACT-SQLS-WRITE-CNT.                           06110053
061200                                                                  06120053
061300******************************************************************06130053
061400* 6200-FORMAT-SQLS-DUMMY-DATA.                                    06140053
061500******************************************************************06150053
061600 6200-FORMAT-SQLS-DUMMY-DATA.                                     06160053
061700                                                                  06170053
061800     SET  DP040I-GEN-INTERNAL-UPC-OPTION TO TRUE.                 06180053
061900     MOVE EP074-SKU-NBR           TO DP040I-SKU-NUMBER.           06190053
062000     CALL DP040I-UPC-CHECK-DIGIT-WO-IUPC                          06200067
062000                     USING DP040I-UPC-CHECK-DIGIT-PARMS.          06201066
062100                                                                  06210053
062200     IF DP040I-NO-ERROR-DETECTED                                  06220065
062300         CONTINUE                                                 06230065
062400     ELSE                                                         06240065
062500         DISPLAY 'INTL UPC FORMAT ERROR ' DP040I-ERROR-INDICATOR  06250065
062600         MOVE '6200-FORMAT-SQLS-DUMMY-DATA' TO PV-PARAGRAPH-NAME  06260065
062700         SET AC-INVALID-DATA TO TRUE                              06270065
062800     END-IF.                                                      06280065
062900                                                                  06290065
063000     MOVE CC-EPCC112-TOMORROW-DATE TO EP218-XREF-EFFECT-DTE.      06300053
063100     MOVE PC-STR-GRP-TYP-CDE-CORP  TO EP218-STR-GRP-TYP-CDE.      06310053
063200     MOVE PC-STR-GRP-ID-CORP       TO EP218-STR-GRP-ID.           06320053
063300     SET  EP218-FILE-CHANGE        TO TRUE.                       06330053
063400     SET  EP218-APPLY-NIGHTLY      TO TRUE.                       06340053
063500     SET  EP218-RECORD-ADD         TO TRUE                        06350053
063600     MOVE DP040I-UPC-CODE          TO EP218-UPC-NBR.              06360053
063700     MOVE EP074-SKU-NBR            TO EP218-SKU-NBR.              06370053
063800                                                                  06380053
063900     PERFORM 7100-WRITE-XREF-SQLS-RECORD.                         06390053
064000                                                                  06400053
064100     ADD +1 TO PV-DUMMY-SQLS-WRITE-CNT.                           06410053
064200                                                                  06420053
064300******************************************************************06430053
064400* 7100-WRITE-XREF-SQLS-RECORD.                                    06440053
064500******************************************************************06450053
064600 7100-WRITE-XREF-SQLS-RECORD.                                     06460053
064700                                                                  06470053
064800     WRITE XREF-SQLS-OUTPUT-RECORD                                06480053
064900           FROM EP218-UPC-SKU-XREF-RECORD.                        06490053
065000                                                                  06500053
065100     ADD +1       TO PV-TOTAL-SQLS-WRITE-CNT.                     06510053
065200                                                                  06520053
065300***************************************************************** 06530057
065400* 9100-SQL-ABEND                                                  06540057
065500*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.06550057
065600***************************************************************** 06560057
065700 9100-SQL-ABEND.                                                  06570057
065800                                                                  06580057
065900     PERFORM 9200-CLOSE-FILES.                                    06590057
066000     PERFORM 9900-DISPLAY-COUNTS.                                 06600057
066100                                                                  06610057
066200     DISPLAY '** ABEND     **'.                                   06620057
066300     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        06630057
066400     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              06640057
066500     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               06650057
066600                                                                  06660057
066700     COPY DPPD004.                                                06670057
066800     SET AC-DB2-ERROR TO TRUE.                                    06680057
066900     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         06690057
067000                                                                  06700057
067100*9100-EXIT.                                                       06710057
067200***************************************************************** 06720065
067300* 9150-ABEND                                                      06730065
067400*     ABEND PROGRAM WHEN AN ERROR OCCURS.                         06740065
067500***************************************************************** 06750065
067600 9150-ABEND.                                                      06760065
067700                                                                  06770065
067800     PERFORM 9200-CLOSE-FILES.                                    06780065
067900     PERFORM 9900-DISPLAY-COUNTS.                                 06790065
068000                                                                  06800065
068100     DISPLAY '** ABEND     **'.                                   06810065
068200     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        06820065
068300     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              06830065
068400                                                                  06840065
068500     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         06850065
068600                                                                  06860065
068700*9100-EXIT.                                                       06870065
068800******************************************************************06880065
068900* 9200-CLOSE-FILES.                                               06890057
069000******************************************************************06900057
069100 9200-CLOSE-FILES.                                                06910057
069200                                                                  06920057
069300     CLOSE CC-DATE-FILE                                           06930057
069400           CC-TIME-STMP-FILE                                      06940057
069500           XREF-REACTIVATED-FILE                                  06950057
069600           XREF-DUMMY-FILE                                        06960057
069700           XREF-SQLS-OUTPUT-FILE.                                 06970057
069800                                                                  06980057
069900******************************************************************06990049
070000* 9900-DISPLAY-COUNTS.                                            07000057
070100******************************************************************07010049
070200 9900-DISPLAY-COUNTS.                                             07020057
070300                                                                  07030049
070400     DISPLAY '*** EPKUT104 TOTAL COUNTS ***'.                     07040049
070500     DISPLAY ' REACTIVATED SKUS READ CNT: ' PV-REACTIVE-READ-CNT. 07050049
070600     DISPLAY '    DUMMY DRIVERS READ CNT: ' PV-DUMMY-READ-CNT.    07060049
070700     DISPLAY '    MERCH MAINT UPDATE CNT: ' PV-MERCH-UPDATE-CNT.  07070053
070800     DISPLAY '***********************************************'.   07080053
070900     DISPLAY '*** EPKUT104 SQL SERVER OUTPUT TOTAL COUNTS ***'.   07090053
071000     DISPLAY '*REACTIVATED XREF SQLS WRITE CNT: '                 07100053
071100                                         PV-REACT-SQLS-WRITE-CNT. 07110053
071200     DISPLAY '*      DUMMY XREF SQLS WRITE CNT: '                 07120053
071300                                         PV-DUMMY-SQLS-WRITE-CNT. 07130053
071400     DISPLAY '*MERCH MAINT XREF SQLS WRITE CNT: '                 07140053
071500                                         PV-MERCH-SQLS-WRITE-CNT. 07150053
071600     DISPLAY '   MERCH MAINT XREF SQLS DEL REC CNT: '             07160053
071700                                         PV-MERCH-SQLS-DEL-CNT.   07170053
071800     DISPLAY '   MERCH MAINT XREF SQLS ADD REC CNT: '             07180053
071900                                         PV-MERCH-SQLS-ADD-CNT.   07190053
072000     DISPLAY '*      TOTAL XREF SQLS WRITE CNT: '                 07200053
072100                                         PV-TOTAL-SQLS-WRITE-CNT. 07210053
072200     DISPLAY '***********************************************'.   07220053
072300                                                                  07230001
072400                                                                  07240001
