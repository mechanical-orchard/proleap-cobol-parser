000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400 PROGRAM-ID.    DLKUT036.                                         00040000
000500 AUTHOR.        GERMAN BANDA.                                     00050000
000600 INSTALLATION.  KOHLS.                                            00060000
000700 DATE-WRITTEN   MAY 2015.                                         00070000
000800 DATE-COMPILED.                                                   00080000
000900***************************************************************** 00090000
001000* THIS PROGRAM WILL COMPARE A PREVIOUS FILE OF USER ID TO A       00100000
001100* PREVIOUS USER ID FILE.  IF THE TK DOES NOT EXIST ON THE CURRENT 00110000
001200* (NEW) TK FILE, A RECORD IS WRITTEN AND A CLOCK IN RECORD NEEDS  00120000
001300* TO BE CREATED.                                                  00130000
001400***************************************************************** 00140000
001500                                                                  00150000
001600***************************************************************** 00160000
001700 ENVIRONMENT DIVISION.                                            00170000
001800***************************************************************** 00180000
001900 INPUT-OUTPUT SECTION.                                            00190000
002000                                                                  00200000
002100 FILE-CONTROL.                                                    00210000
002200     SELECT EXPORT-CLOCK-IN-FILE-NEW                              00220000
002300         ASSIGN TO INP01.                                         00230000
002400     SELECT EXPORT-CLOCK-IN-FILE-OLD                              00240000
002500         ASSIGN TO INP02.                                         00250000
002600     SELECT EXPORT-CLOCK-IN-FILE-RCYCL                            00260000
002700         ASSIGN TO OUT01.                                         00270000
002800     SELECT CLOCK-IN-JOB-FILE-OUT                                 00280000
002900         ASSIGN TO OUT02.                                         00290000
003000                                                                  00300000
003100***************************************************************** 00310000
003200 DATA DIVISION.                                                   00320000
003300***************************************************************** 00330000
003400 FILE SECTION.                                                    00340000
003500*                                                                 00350000
003600 FD  EXPORT-CLOCK-IN-FILE-NEW                                     00360000
003700     RECORDING MODE IS F                                          00370000
003800     LABEL RECORDS ARE STANDARD                                   00380000
003900     BLOCK CONTAINS 0 RECORDS.                                    00390000
004000 01  EXPORT-CLOCK-IN-RECORD-NEW        PIC X(100).                00400000
004100*                                                                 00410000
004200 FD  EXPORT-CLOCK-IN-FILE-OLD                                     00420000
004300     RECORDING MODE IS F                                          00430000
004400     LABEL RECORDS ARE STANDARD                                   00440000
004500     BLOCK CONTAINS 0 RECORDS.                                    00450000
004600 01  EXPORT-CLOCK-IN-RECORD-OLD        PIC X(100).                00460000
004700*                                                                 00470000
004800 FD  EXPORT-CLOCK-IN-FILE-RCYCL                                   00480000
004900     RECORDING MODE IS F                                          00490000
005000     LABEL RECORDS ARE STANDARD                                   00500000
005100     BLOCK CONTAINS 0 RECORDS.                                    00510000
005200 01  EXPORT-CLOCK-IN-RECORD-RCYCL      PIC X(100).                00520000
005300*                                                                 00530000
005400 FD  CLOCK-IN-JOB-FILE-OUT                                        00540000
005500     RECORDING MODE IS F                                          00550000
005600     LABEL RECORDS ARE STANDARD                                   00560000
005700     RECORD CONTAINS 512                                          00570000
005800     BLOCK CONTAINS 0 RECORDS                                     00580000
005900     DATA RECORD IS CLOCK-IN-JOB-RECORD.                          00590000
006000                                                                  00600000
006100 01  CLOCK-IN-JOB-RECORD       PIC  X(512).                       00610000
006200                                                                  00620000
006300***************************************************************** 00630000
006400 WORKING-STORAGE SECTION.                                         00640000
006500                                                                  00650000
006600 01  PS-PROGRAM-SWITCHES.                                         00660000
006700     05  PS-EOF-EXTRACT-SW            PIC X(01)  VALUE 'N'.       00670000
006800         88  PS-EOF-EXTRACT                      VALUE 'Y'.       00680000
006900         88  PS-NOT-EOF-EXTRACT                  VALUE 'N'.       00690000
007000     05  PS-EOF-EXTRACT-OLD-SW        PIC X(01)  VALUE 'N'.       00700000
007100         88  PS-EOF-EXTRACT-OLD                  VALUE 'Y'.       00710000
007200         88  PS-NOT-EOF-EXTRACT-OLD              VALUE 'N'.       00720000
007300     05  PS-VALID-RECORD-SW           PIC X(01)  VALUE 'N'.       00730000
007400         88  PS-VALID-RECORD                     VALUE 'Y'.       00740000
007500         88  PS-NOT-VALID-RECORD                 VALUE 'N'.       00750000
007600     05  PS-CLOCK-IN-UPDATE-SW        PIC X(01)  VALUE 'N'.       00760000
007700         88  PS-CLOCK-IN-UPDATE-YES              VALUE 'Y'.       00770000
007800         88  PS-CLOCK-IN-UPDATE-NO               VALUE 'N'.       00780000
007810*                                                                 00781000
007820 01  PV-PROGRAM-VARIABLES.                                        00782000
007830                                                                  00783000
007840     05  PV-PO-NBR                    PIC S9(09).                 00784000
007850     05  PV-SCAC-CDE                  PIC X(04).                  00785000
007860     05  PV-PREV-USER-ID              PIC X(08).                  00786000
007870     05  PV-DISPLAY-OPER-UNT-ID       PIC 9(04) VALUE ZEROS.      00787000
007880                                                                  00788000
007890     05  PV-TOTAL-INPUT-READ          PIC S9(09) VALUE ZERO       00789000
007900                                                  COMP SYNC.      00790000
008000     05  PV-TOTAL-INPUT-READ-RCY      PIC S9(09) VALUE ZERO       00800000
008100                                                  COMP SYNC.      00810000
008200     05  PV-RECS-WRITTEN              PIC S9(09) VALUE ZERO       00820000
008300                                                  COMP SYNC.      00830000
008400     05  PV-RECS-WRITTEN-RCY          PIC S9(09) VALUE ZERO       00840000
008500                                                  COMP SYNC.      00850000
008600     05  PV-RECS-WRITTEN-UPD          PIC S9(09) VALUE ZERO       00860000
008700                                                  COMP SYNC.      00870000
008710     05  PV-RECS-DROPPED-RCY          PIC S9(09) VALUE ZERO       00871002
008720                                                  COMP SYNC.      00872002
008800                                                                  00880000
008900     05  PV-INPUT-TMST-EVENT.                                     00890000
009000         10 PV-INPUT-TMST-DATE-EVNT.                              00900000
009100             15 PV-INPUT-TMST-EVNT-YR PIC 9(04).                  00910000
009200             15 FILLER                PIC X.                      00920000
009300             15 PV-INPUT-TMST-EVNT-MO PIC 9(02).                  00930000
009400             15 FILLER                PIC X.                      00940000
009500             15 PV-INPUT-TMST-EVNT-DA PIC 9(02).                  00950000
009600         10 FILLER                    PIC X(16).                  00960000
009700*                                                                 00970000
009800     05  PV-INPUT-TMST.                                           00980000
009900         10 PV-INPUT-TMST-DATE.                                   00990000
010000             15 PV-INPUT-TMST-YR      PIC 9(04).                  01000000
010100             15 FILLER                PIC X.                      01010000
010200             15 PV-INPUT-TMST-MO      PIC 9(02).                  01020000
010300             15 FILLER                PIC X.                      01030000
010400             15 PV-INPUT-TMST-DA      PIC 9(02).                  01040000
010500         10 FILLER                    PIC X.                      01050000
010600         10 PV-INPUT-TMST-TIME.                                   01060000
010700             15 PV-INPUT-TMST-HR      PIC 9(02).                  01070000
010800             15 FILLER                PIC X.                      01080000
010900             15 PV-INPUT-TMST-MN      PIC 9(02).                  01090000
011000             15 FILLER                PIC X.                      01100000
011100             15 PV-INPUT-TMST-SS      PIC 9(02).                  01110000
011200         10 FILLER                PIC X.                          01120000
011300         10 FILLER                PIC X(06).                      01130000
011400     05  PV-COMPARE-TMST              PIC X(26).                  01140000
011500     05  PV-COMPR-TMST-DEL            PIC X(26).                  01150000
011600     05  PV-ADJUST-DATE-TMST          PIC X(26).                  01160000
011700     05  PV-SHIFT-TMST                PIC X(26).                  01170000
011800     05  PV-SHIFT-END-TMST            PIC X(26).                  01180000
011900     05  PV-FUNC-QTY                  PIC S9(09) COMP.            01190000
012000     05  PV-TIME-QTY                  PIC S9(09) COMP.            01200000
012100     05  PV-DEL-QTY                   PIC S9(09) COMP.            01210000
012200                                                                  01220000
012300     05  PV-START-DATE.                                           01230000
012400         10 PV-START-DATE-MO          PIC 9(02).                  01240000
012500         10 PV-START-DATE-DA          PIC 9(02).                  01250000
012600         10 PV-START-DATE-YR          PIC 9(04).                  01260000
012700                                                                  01270000
012800     05  PV-PLAN-DATE.                                            01280000
012900         10 PV-PLAN-DATE-MO           PIC 9(02).                  01290000
013000         10 PV-PLAN-DATE-DA           PIC 9(02).                  01300000
013100         10 PV-PLAN-DATE-YR           PIC 9(04).                  01310000
013200                                                                  01320000
013300     05  PV-START-TIME.                                           01330000
013400         10 PV-START-TIME-HR          PIC 9(02).                  01340000
013500         10 PV-START-TIME-MN          PIC 9(02).                  01350000
013600         10 PV-START-TIME-SS          PIC 9(02).                  01360000
013700*GB 8/15/15                                                       01370000
013800     05  PV-SHIFT-BEGIN-TME.                                      01380000
013900         10 FILLER                    PIC X(11).                  01390000
013901         10 PV-SHIFT-BEGIN-TIME       PIC X(15).                  01390100
013902     05  PV-SHIFT-END-TME.                                        01390200
013903         10 FILLER                    PIC X(11).                  01390300
013904         10 PV-SHIFT-END-TIME         PIC X(15).                  01390400
013905     05  PV-SHIFT-INPUT-TME.                                      01390500
013906         10 FILLER                    PIC X(11).                  01390600
013907         10 PV-SHIFT-INPUT-TIME       PIC X(15).                  01390700
013908                                                                  01390800
013909                                                                  01390900
013910 01  PV-ASSOC-STRT-REC-LAYOUT.                                    01391000
013920     05  PV-DC-NUMBER-OLD             PIC  9(04).                 01392000
013930     05  PV-CRE-BY-USR-ID-OLD         PIC  X(08).                 01393000
013940     05  PV-EVENT-DB-CRE-TMST-OLD     PIC  X(26).                 01394000
013950     05  PV-FILLER                    PIC  X(62).                 01395000
013960                                                                  01396000
013970 01  PV-ASSOC-STRT-REC-LAYOUT-RCYCL.                              01397000
013980     05  PV-DC-NUMBER-RCYCL           PIC  9(04).                 01398000
013990     05  PV-CRE-BY-USR-ID-RCYCL       PIC  X(08).                 01399000
014000     05  PV-EVENT-DB-CRE-TMST-RCYCL   PIC  X(26).                 01400000
014100     05  PV-FILLER-1                  PIC  X(62).                 01410000
014200                                                                  01420000
014300 01 PC-PROGRAM-CONSTANTS.                                         01430000
014400     05 PC-PROGRAM-NAME              PIC X(08)  VALUE 'DLKUT036'. 01440000
014500     05  PC-DEFAULT-CC-DATE          PIC X(10) VALUE '9999-09-09'.01450000
014600     05  PC-SHIFT-TIME-24            PIC X(15) VALUE              01460000
014700                                     '24.00.00.000000'.           01470000
014800                                                                  01480000
014900 01  PV-ABEND-FIELDS.                                             01490000
015000     05  PV-ABEND-PROGRAM             PIC  X(08) VALUE 'DLKUT036'.01500000
015100     05  PV-ABEND-CODE                PIC  S9(4) VALUE +0         01510000
015200                                                 COMP SYNC.       01520000
015300     05  PV-SQLCODE                   PIC  Z(08)9-.               01530000
015400     05  PV-ABEND-PARAGRAPH           PIC  X(50) VALUE SPACES.    01540000
015500     05  PV-ABEND-OPERATION           PIC  X(50) VALUE SPACES.    01550000
015600     05  PV-ABEND-STRUCTURE-1         PIC  X(08) VALUE SPACES.    01560000
015700     05  PV-ABEND-STRUCTURE-2         PIC  X(08) VALUE SPACES.    01570000
015800     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    01580000
015900     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    01590000
016000     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    01600000
016100     05  PV-DB2-TABLE-NAME            PIC X(12)  VALUE SPACE.     01610000
016200                                                                  01620000
016300 01  DK-DB-KEYS.                                                  01630000
016400     05 DK-OPER-UNT-ID                PIC S9(04) COMP.            01640000
016500******************************************************************01650000
016600*  USED FOR DB2 ERROR MESSAGE BUILDING                            01660000
016700******************************************************************01670000
016800     COPY DPWS004.                                                01680000
016900                                                                  01690000
017000***********************************************************       01700000
017100*  COPYBOOK USED IN CREATING EXTRACT FILE.                *       01710000
017200***********************************************************       01720000
017300     COPY DLRD017.                                                01730000
017400                                                                  01740000
017500******************************************************************01750000
017600*  COPYBOOK DLRD001 (JOB0100 OUTPUT FILE LAYOUT)                  01760000
017700******************************************************************01770000
017800     COPY DLRD001.                                                01780000
017900*                                                                 01790000
018000******************************************************************01800000
018100*    TKRPRPM TABLE                                                01810000
018200******************************************************************01820000
018300     EXEC SQL                                                     01830000
018400          INCLUDE TKRPRPM                                         01840000
018500     END-EXEC.                                                    01850000
018600******************************************************************01860000
018700*  SQL AND COBOL DECLARATIONS FOR WST_INTGRTN_TYP                 01870000
018800******************************************************************01880000
018900     EXEC SQL                                                     01890000
019000          INCLUDE WST00008                                        01900000
019100     END-EXEC.                                                    01910000
019200******************************************************************01920000
019300*  SQL AND COBOL DECLARATIONS FOR WST_ATTR_DEFN                   01930000
019400******************************************************************01940000
019500     EXEC SQL                                                     01950000
019600          INCLUDE WST00009                                        01960000
019700     END-EXEC.                                                    01970000
019800******************************************************************01980000
019900*  SQL AND COBOL DECLARATIONS FOR WST_ATTR_ELEM                   01990000
020000******************************************************************02000000
020100     EXEC SQL                                                     02010000
020200          INCLUDE WST00010                                        02020000
020300     END-EXEC.                                                    02030000
020400                                                                  02040000
020500*                                                                 02050000
020600     EXEC SQL                                                     02060000
020700          INCLUDE SQLCA                                           02070000
020800     END-EXEC.                                                    02080000
020900                                                                  02090000
021000******************************************************************02100000
021100 EJECT                                                            02110000
021200***********************************************************       02120000
021300 PROCEDURE DIVISION.                                              02130000
021400***********************************************************       02140000
021500 0000-PROGRAM-MAINLINE.                                           02150000
021600*                                                                 02160000
021700     PERFORM 1000-INITIALIZATION.                                 02170000
021800*                                                                 02180000
021900     IF PS-EOF-EXTRACT-OLD                                        02190000
022000        PERFORM 1500-PROCESS-EMPTY-RCYCL-FILE                     02200000
022100            UNTIL PS-EOF-EXTRACT                                  02210000
022200     END-IF.                                                      02220000
022300                                                                  02230000
022400     PERFORM 2000-PROCESS-CLOCK-IN-FILE                           02240000
022500         UNTIL PS-EOF-EXTRACT AND                                 02250000
022600               PS-EOF-EXTRACT-OLD                                 02260000
022700*                                                                 02270000
022800     PERFORM 9000-EOJ-ROUTINE.                                    02280000
022900*                                                                 02290000
023000     GOBACK.                                                      02300000
023100*                                                                 02310000
023200******************************************************************02320000
023300*  DO FIRST TIME PROGRAM INITIALIZATION TASKS.                    02330000
023400******************************************************************02340000
023500 1000-INITIALIZATION.                                             02350000
023600*                                                                 02360000
023700     OPEN INPUT  EXPORT-CLOCK-IN-FILE-NEW                         02370000
023800                 EXPORT-CLOCK-IN-FILE-OLD.                        02380000
023900     OPEN OUTPUT EXPORT-CLOCK-IN-FILE-RCYCL                       02390000
024000                 CLOCK-IN-JOB-FILE-OUT.                           02400000
024100     MOVE +0    TO PV-RECS-WRITTEN-UPD                            02410000
024200                   PV-RECS-WRITTEN-RCY.                           02420000
024300     MOVE +3    TO PV-DEL-QTY.                                    02430008
024400     PERFORM 8000-READ-CLOCK-IN-FILE.                             02440000
024500     PERFORM 8100-READ-CLOCK-IN-FILE-OLD.                         02450000
024600     MOVE SPACE TO PV-PREV-USER-ID.                               02460000
024700     IF  PS-EOF-EXTRACT                                           02470000
024800        DISPLAY 'CLOCK-IN FILE INP01 IS EMPTY'                    02480000
024900     END-IF.                                                      02490000
025000     IF  PS-EOF-EXTRACT-OLD                                       02500000
025100        DISPLAY 'RECYCLE FILE INP02 IS EMPTY'                     02510000
025200     END-IF.                                                      02520000
025300*                                                                 02530000
025400 1500-PROCESS-EMPTY-RCYCL-FILE.                                   02540000
025500      PERFORM 3200-SELECT-SHIFT-BEG                               02550000
025600      PERFORM 5000-BUILD-JOB0100                                  02560000
025700      PERFORM 8300-WRITE-JOB-RECORD                               02570000
025800      PERFORM 8400-WRITE-UPDATE-RECORD                            02580000
025900      PERFORM 8000-READ-CLOCK-IN-FILE.                            02590000
026000*                                                                 02600000
026100***************************************************************** 02610000
026200 2000-PROCESS-CLOCK-IN-FILE.                                      02620000
026300***************************************************************** 02630000
026400*                                                                 02640000
026500     IF DL017-CRE-BY-USR-ID = PV-CRE-BY-USR-ID-OLD                02650000
026600        PERFORM 3000-GET-TKRPRPM-TIME-INTER                       02660000
026700        PERFORM 3100-COMPARE-LAST-TMST                            02670000
026800        IF PS-CLOCK-IN-UPDATE-YES                                 02680000
026900           PERFORM 3200-SELECT-SHIFT-BEG                          02690000
027000           PERFORM 5000-BUILD-JOB0100                             02700000
027100           PERFORM 8300-WRITE-JOB-RECORD                          02710000
027200        END-IF                                                    02720000
027300        PERFORM 8400-WRITE-UPDATE-RECORD                          02730000
027400        PERFORM 8000-READ-CLOCK-IN-FILE                           02740000
027500        PERFORM 8100-READ-CLOCK-IN-FILE-OLD                       02750000
027600     ELSE                                                         02760000
027700        IF DL017-CRE-BY-USR-ID < PV-CRE-BY-USR-ID-OLD             02770000
027800           IF PS-NOT-EOF-EXTRACT                                  02780000
027900             PERFORM 5500-PROCESS-JOB-RECORD                      02790000
028000             PERFORM 6000-PROCESS-CLOCK-IN-NEW                    02800000
028100           ELSE                                                   02810000
028200             PERFORM 8100-READ-CLOCK-IN-FILE-OLD                  02820000
028300             IF PS-NOT-EOF-EXTRACT-OLD                            02830000
028400                PERFORM 7900-CHECK-OLD-RECYCL-RECORDS             02840000
028500             END-IF                                               02850000
028600           END-IF                                                 02860000
028700        ELSE                                                      02870000
028800           IF PS-NOT-EOF-EXTRACT-OLD                              02880000
028900             PERFORM 7900-CHECK-OLD-RECYCL-RECORDS                02890000
029000             PERFORM 6200-PROCESS-CLOCK-IN-OLD                    02900000
029100           ELSE                                                   02910000
029200             IF DL017-CRE-BY-USR-ID > PV-CRE-BY-USR-ID-OLD        02920000
029300                PERFORM 3200-SELECT-SHIFT-BEG                     02930000
029400                PERFORM 5000-BUILD-JOB0100                        02940000
029500                PERFORM 8300-WRITE-JOB-RECORD                     02950000
029600                PERFORM 8400-WRITE-UPDATE-RECORD                  02960000
029700                PERFORM 8000-READ-CLOCK-IN-FILE                   02970000
029800             END-IF                                               02980000
029900           END-IF                                                 02990000
030000       END-IF                                                     03000000
030100     END-IF.                                                      03010000
030200                                                                  03020000
030300***************************************************************** 03030000
030400******************************************************************03040000
030500 3000-GET-TKRPRPM-TIME-INTER.                                     03050000
030600                                                                  03060000
030700       MOVE DL017-DC-NUMBER   TO DK-OPER-UNT-ID.                  03070000
030800                                                                  03080000
030900       EXEC SQL                                                   03090000
031000           SELECT FUNC_QTY                                        03100000
031100             INTO :PV-TIME-QTY                                    03110000
031200             FROM TKRPRPM                                         03120000
031300            WHERE LOC_ID           = :DK-OPER-UNT-ID              03130000
031400              AND INTFC_SYS_CDE    = 'DLX'                        03140000
031500              AND SYS_PRC_FUNC_CDE = 'DRSTTM'                     03150000
031600              AND FUNC_PRC_STAT_CDE = 'AC'                        03160000
031700       END-EXEC                                                   03170000
031800                                                                  03180000
031900       EVALUATE TRUE                                              03190000
032000           WHEN SQLCODE = +0                                      03200000
032100           WHEN SQLCODE = -904                                    03210000
032200           WHEN SQLCODE = -913                                    03220000
032300           WHEN SQLCODE = -911                                    03230000
032400               CONTINUE                                           03240000
032500           WHEN SQLCODE = +100                                    03250000
032600               MOVE 0                       TO PV-TIME-QTY        03260000
032700           WHEN OTHER                                             03270000
032800               MOVE 0                       TO PV-TIME-QTY        03280000
032900               DISPLAY '5000-GET-TKRPRPM-TIME-INTERVAL ERROR'     03290000
033000               MOVE DK-OPER-UNT-ID  TO PV-DISPLAY-OPER-UNT-ID     03300000
033100               DISPLAY ' OPER UNIT   - '                          03310000
033200                       PV-DISPLAY-OPER-UNT-ID                     03320000
033300               PERFORM 9999-SQL-ABEND                             03330000
033400       END-EVALUATE.                                              03340000
033500                                                                  03350000
033600***************************************************************** 03360000
033700* USING PARM FROM 3000- CHECK TO SEE IF LAST CLOCK WAS GREATER    03370000
033800* THAN PV-TIME-QTY HOURS THAN THE CURRENT RECORD.  IF SO          03380000
033900* CREATE A NEW CLOCK-IN RECORD.                                   03390000
034000***************************************************************** 03400000
034100 3100-COMPARE-LAST-TMST.                                          03410000
034200     EXEC SQL                                                     03420000
034300      SET :PV-COMPARE-TMST = (TIMESTAMP(:DL017-EVENT-DB-CRE-TMST) 03430000
034400                             -  :PV-TIME-QTY HOURS)               03440000
034500     END-EXEC.                                                    03450000
034600                                                                  03460000
034700     IF  PV-EVENT-DB-CRE-TMST-OLD   >= PV-COMPARE-TMST            03470000
034800           SET PS-CLOCK-IN-UPDATE-NO TO TRUE                      03480000
034900     ELSE                                                         03490000
035000         SET PS-CLOCK-IN-UPDATE-YES TO TRUE                       03500000
035100     END-IF.                                                      03510000
035200                                                                  03520000
035300***************************************************************** 03530000
035400* CHECK SHIFT BEGIN AND END SHIFT TIMES TO SET CLOCK IN AT        03540000
035500* BEGINNING OF SHIFT                                              03550000
035600* CREATE A NEW CLOCK-IN RECORD.                                   03560000
035700***************************************************************** 03570000
035800 3200-SELECT-SHIFT-BEG.                                           03580000
035900                                                                  03590000
036000       MOVE  DL017-DC-NUMBER TO DK-OPER-UNT-ID                    03600000
036100                                                                  03610000
036200       EXEC SQL                                                   03620000
036300        SELECT  E.ATTR_ELEM_TMST                                  03630000
036400             ,  F.ATTR_ELEM_TMST                                  03640000
036500          INTO  :PV-SHIFT-TMST                                    03650000
036600              , :PV-SHIFT-END-TMST                                03660000
036700          FROM                                                    03670000
036800                WST_INTGRTN_TYP  A                                03680000
036900             ,  WST_ATTR_DEFN    B                                03690000
037000             ,  WST_ATTR_ELEM    C                                03700000
037100             ,  WST_ATTR_ELEM    D                                03710000
037200             ,  WST_ATTR_ELEM    E                                03720000
037300             ,  WST_ATTR_ELEM    F                                03730000
037400             ,  WST_ATTR_ELEM    G                                03740000
037500             ,  WST_ATTR_ELEM    H                                03750000
037600          WHERE                                                   03760000
037700                A.INTGRTN_TYP_CDE   = 'LMSRDCSHFT'                03770000
037800            AND A.INTGRTN_TYP_CDE   = B.INTGRTN_TYP_CDE           03780000
037900            AND B.ATTR_DEFN_SEQ_NBR = 1                           03790000
038000            AND B.INTGRTN_TYP_CDE   = C.INTGRTN_TYP_CDE           03800000
038100            AND C.ATTR_DEFN_SEQ_NBR = 1                           03810000
038200            AND B.INTGRTN_TYP_CDE   = D.INTGRTN_TYP_CDE           03820000
038300            AND D.ATTR_DEFN_SEQ_NBR = 2                           03830000
038400            AND B.INTGRTN_TYP_CDE   = E.INTGRTN_TYP_CDE           03840000
038500            AND E.ATTR_DEFN_SEQ_NBR = 3                           03850000
038600            AND B.INTGRTN_TYP_CDE   = F.INTGRTN_TYP_CDE           03860000
038700            AND F.ATTR_DEFN_SEQ_NBR = 4                           03870000
038800            AND B.INTGRTN_TYP_CDE   = G.INTGRTN_TYP_CDE           03880000
038900            AND G.ATTR_DEFN_SEQ_NBR = 5                           03890000
039000            AND B.INTGRTN_TYP_CDE   = H.INTGRTN_TYP_CDE           03900000
039100            AND H.ATTR_DEFN_SEQ_NBR = 6                           03910000
039200            AND C.ATTR_ELEM_SEQ_NBR = D.ATTR_ELEM_SEQ_NBR         03920000
039300            AND C.ATTR_ELEM_SEQ_NBR = E.ATTR_ELEM_SEQ_NBR         03930000
039400            AND C.ATTR_ELEM_SEQ_NBR = F.ATTR_ELEM_SEQ_NBR         03940000
039500            AND C.ATTR_ELEM_SEQ_NBR = G.ATTR_ELEM_SEQ_NBR         03950000
039600            AND C.ATTR_ELEM_SEQ_NBR = H.ATTR_ELEM_SEQ_NBR         03960000
039700            AND C.ATTR_ELEM_NBR     = :DK-OPER-UNT-ID             03970000
039800            AND (                                                 03980000
039900                 ((TIME(E.ATTR_ELEM_TMST)                         03990000
040000                     <= (TIME(:DL017-EVENT-DB-CRE-TMST))) AND     04000000
040100                  (TIME(F.ATTR_ELEM_TMST)                         04010000
040200                     >= (TIME(:DL017-EVENT-DB-CRE-TMST)))         04020000
040300                 )                                                04030000
040400             OR  ((TIME(F.ATTR_ELEM_TMST)                         04040000
040500                     >= (TIME(:DL017-EVENT-DB-CRE-TMST))) AND     04050000
040600                  (TIME(E.ATTR_ELEM_TMST)                         04060000
040700                      > TIME(F.ATTR_ELEM_TMST))                   04070000
040800                 )                                                04080000
040900             OR  ((TIME(E.ATTR_ELEM_TMST)                         04090000
041000                     <= (TIME(:DL017-EVENT-DB-CRE-TMST))) AND     04100000
041100                  (TIME(E.ATTR_ELEM_TMST)                         04110000
041200                      > TIME(F.ATTR_ELEM_TMST))                   04120000
041300                 )                                                04130000
041400                )                                                 04140000
041500            AND ((:DL017-EVENT-DB-CRE-TMST)                       04150000
041600                     BETWEEN G.ATTR_ELEM_TMST                     04160000
041700                         AND H.ATTR_ELEM_TMST                     04170000
041800                )                                                 04180000
041900         WITH UR                                                  04190000
042000       END-EXEC                                                   04200000
042100                                                                  04210000
042200       EVALUATE TRUE                                              04220000
042300           WHEN SQLCODE = +0                                      04230000
042400               CONTINUE                                           04240000
042500           WHEN SQLCODE = +100                                    04250000
042600           WHEN SQLCODE = -811                                    04260000
042700               MOVE DL017-EVENT-DB-CRE-TMST TO PV-SHIFT-TMST      04270000
042800           WHEN OTHER                                             04280000
042900               DISPLAY '3200-SELECT-SHIFT-BEG '                   04290000
043000               DISPLAY 'DL017-EVENT-DB-CRE-TMST'                  04300000
043100                       DL017-EVENT-DB-CRE-TMST                    04310000
043200               MOVE DK-OPER-UNT-ID  TO PV-DISPLAY-OPER-UNT-ID     04320000
043300               DISPLAY ' OPER UNIT   - '                          04330000
043400                       PV-DISPLAY-OPER-UNT-ID                     04340000
043500               PERFORM 9999-SQL-ABEND                             04350000
043600       END-EVALUATE.                                              04360000
043700                                                                  04370000
043800       IF SQLCODE = -811                                          04380000
043900          DISPLAY '3200-SELECT-SHIFT-BEG '                        04390000
044000          DISPLAY 'SQLCODE = -811'                                04400000
044100          DISPLAY 'DL017-EVENT-DB-CRE-TMST'                       04410000
044110                  DL017-EVENT-DB-CRE-TMST                         04411000
044120          MOVE DK-OPER-UNT-ID  TO PV-DISPLAY-OPER-UNT-ID          04412000
044130          DISPLAY ' OPER UNIT   - '                               04413000
044140                  PV-DISPLAY-OPER-UNT-ID                          04414000
044150        END-IF.                                                   04415000
044160 5000-BUILD-JOB0100.                                              04416000
044170                                                                  04417000
044180     INITIALIZE DL001-RECORD.                                     04418000
044190     MOVE 'JOB0100'             TO DL001-JOB0100-RECORDTYPE.      04419000
044200     MOVE 'CLOCKI'              TO DL001-JOB0100-JOBCODEID.       04420000
044300                                                                  04430000
044400     MOVE DL017-CRE-BY-USR-ID   TO DL001-JOB0100-USR-ID.          04440000
044500                                                                  04450000
044600** GB 8/17/15 CHECK TO SET CORRECT DATE ON CLOCKIN RECORD         04460000
044700** GB COMPARE SHIFT BEGIN AND SHIFT END TIMES                     04470000
044800     EXEC SQL                                                     04480000
044900      SET :PV-ADJUST-DATE-TMST =                                  04490000
045000                         (TIMESTAMP(:DL017-EVENT-DB-CRE-TMST)     04500000
045010                             -  1 DAY)                            04501000
045020     END-EXEC                                                     04502000
045030     MOVE PV-SHIFT-TMST        TO PV-SHIFT-BEGIN-TME              04503000
045040     MOVE PV-SHIFT-END-TMST    TO PV-SHIFT-END-TME                04504000
045050     MOVE PV-ADJUST-DATE-TMST  TO PV-SHIFT-INPUT-TME              04505000
045060     IF PV-SHIFT-BEGIN-TIME > PV-SHIFT-END-TIME                   04506000
045070        IF (PV-SHIFT-INPUT-TIME >= PV-SHIFT-BEGIN-TIME ) AND      04507000
045071           (PV-SHIFT-INPUT-TIME < PC-SHIFT-TIME-24 )              04507100
045072            CONTINUE                                              04507200
045073        ELSE                                                      04507300
045074            MOVE PV-ADJUST-DATE-TMST  TO DL017-EVENT-DB-CRE-TMST  04507400
045075        END-IF                                                    04507500
045076     END-IF                                                       04507600
045077                                                                  04507700
045078** GB 8/17 END                                                    04507800
045079     MOVE DL017-EVENT-DB-CRE-TMST TO PV-INPUT-TMST-EVENT.         04507900
045080     MOVE PV-SHIFT-TMST           TO PV-INPUT-TMST.               04508000
045090                                                                  04509000
045100     MOVE PV-INPUT-TMST-EVNT-YR TO PV-PLAN-DATE-YR.               04510000
045200     MOVE PV-INPUT-TMST-EVNT-MO TO PV-PLAN-DATE-MO.               04520000
045300     MOVE PV-INPUT-TMST-EVNT-DA TO PV-PLAN-DATE-DA.               04530000
045400**                                                                04540000
045500     MOVE PV-INPUT-TMST-HR      TO PV-START-TIME-HR.              04550000
045600     MOVE PV-INPUT-TMST-MN      TO PV-START-TIME-MN.              04560000
045700     MOVE PV-INPUT-TMST-SS      TO PV-START-TIME-SS.              04570000
045800     MOVE PV-START-TIME         TO DL001-JOB0100-START-TIME.      04580000
045900     MOVE PV-PLAN-DATE          TO DL001-JOB0100-PLAN-DATE.       04590000
046000                                                                  04600000
046100 5500-PROCESS-JOB-RECORD.                                         04610000
046200      IF PS-NOT-EOF-EXTRACT                                       04620000
046300         PERFORM 3200-SELECT-SHIFT-BEG                            04630000
046400         PERFORM 5000-BUILD-JOB0100                               04640007
046500         PERFORM 8300-WRITE-JOB-RECORD                            04650007
046600         IF DL017-CRE-BY-USR-ID = PV-CRE-BY-USR-ID-OLD            04660006
046700            CONTINUE                                              04670000
046800         ELSE                                                     04680000
046900            PERFORM 8400-WRITE-UPDATE-RECORD                      04690000
047000         END-IF                                                   04700000
047100      END-IF.                                                     04710000
047200 6000-PROCESS-CLOCK-IN-NEW.                                       04720000
047220      PERFORM                                                     04722000
047230          UNTIL ((DL017-CRE-BY-USR-ID > PV-CRE-BY-USR-ID-OLD)  OR 04723000
047240                 (DL017-CRE-BY-USR-ID = PV-CRE-BY-USR-ID-OLD)) OR 04724000
047250                PS-EOF-EXTRACT                                    04725000
047260            PERFORM 8000-READ-CLOCK-IN-FILE                       04726000
047270            PERFORM 5500-PROCESS-JOB-RECORD                       04727000
047280      END-PERFORM.                                                04728000
047290                                                                  04729000
047300 6200-PROCESS-CLOCK-IN-OLD.                                       04730000
047400      PERFORM                                                     04740000
047500          UNTIL ((DL017-CRE-BY-USR-ID < PV-CRE-BY-USR-ID-OLD) OR  04750000
047600                (DL017-CRE-BY-USR-ID = PV-CRE-BY-USR-ID-OLD)) OR  04760000
047700                PS-EOF-EXTRACT-OLD                                04770000
047800            PERFORM 8100-READ-CLOCK-IN-FILE-OLD                   04780000
047900            IF DL017-CRE-BY-USR-ID = PV-CRE-BY-USR-ID-OLD         04790000
048000               CONTINUE                                           04800000
048100            ELSE                                                  04810000
048200               IF PS-NOT-EOF-EXTRACT-OLD                          04820000
048300                  PERFORM 7900-CHECK-OLD-RECYCL-RECORDS           04830000
048400               END-IF                                             04840000
048500            END-IF                                                04850000
048600      END-PERFORM.                                                04860000
048700                                                                  04870000
048800 7900-CHECK-OLD-RECYCL-RECORDS.                                   04880000
048900     EXEC SQL                                                     04890000
049000          SET :PV-COMPR-TMST-DEL =                                04900000
049100              (CURRENT TIMESTAMP - :PV-DEL-QTY DAYS)              04910000
049200     END-EXEC.                                                    04920000
049300                                                                  04930000
049400     IF  PV-COMPR-TMST-DEL   > PV-EVENT-DB-CRE-TMST-OLD           04940000
049500         ADD +1 TO   PV-RECS-DROPPED-RCY                          04950008
049600     ELSE                                                         04960000
049700         PERFORM 8500-WRITE-UPD-REC-FROM-OLD                      04970000
049710     END-IF.                                                      04971000
049720                                                                  04972000
049730***************************************************************** 04973000
049740 8000-READ-CLOCK-IN-FILE.                                         04974000
049750***************************************************************** 04975000
049760       READ EXPORT-CLOCK-IN-FILE-NEW                              04976000
049770            INTO DL017-ASSOC-STRT-REC-LAYOUT                      04977000
049780       AT END                                                     04978000
049790           SET PS-EOF-EXTRACT           TO TRUE                   04979000
049791       NOT AT END                                                 04979100
049792           ADD +1 TO PV-TOTAL-INPUT-READ                          04979200
049793       END-READ.                                                  04979300
049794       IF PS-EOF-EXTRACT                                          04979400
049795          MOVE SPACE TO DL017-ASSOC-STRT-REC-LAYOUT               04979500
049796       END-IF.                                                    04979600
049797*                                                                 04979700
049798***************************************************************** 04979800
049799 8100-READ-CLOCK-IN-FILE-OLD.                                     04979900
049800***************************************************************** 04980000
049900*                                                                 04990000
050000        READ EXPORT-CLOCK-IN-FILE-OLD                             05000000
050100             INTO PV-ASSOC-STRT-REC-LAYOUT                        05010000
050200        AT END                                                    05020000
050300            SET PS-EOF-EXTRACT-OLD       TO TRUE                  05030000
050400        NOT AT END                                                05040000
050500           ADD +1 TO PV-TOTAL-INPUT-READ-RCY                      05050000
050600        END-READ.                                                 05060000
050700                                                                  05070000
050800        IF PS-EOF-EXTRACT-OLD                                     05080000
050900          MOVE SPACE TO PV-ASSOC-STRT-REC-LAYOUT                  05090000
051000        END-IF.                                                   05100000
051100                                                                  05110000
051200***************************************************************** 05120000
051300 8300-WRITE-JOB-RECORD.                                           05130000
051400***************************************************************** 05140000
051500*                                                                 05150000
051600     WRITE CLOCK-IN-JOB-RECORD                                    05160000
051700         FROM DL001-RECORD.                                       05170000
051800     ADD 1                            TO PV-RECS-WRITTEN.         05180000
051900*                                                                 05190000
052000***************************************************************** 05200000
052100 8400-WRITE-UPDATE-RECORD.                                        05210000
052200***************************************************************** 05220000
052300*                                                                 05230000
052400     WRITE EXPORT-CLOCK-IN-RECORD-RCYCL                           05240000
052500         FROM DL017-ASSOC-STRT-REC-LAYOUT.                        05250000
052600     ADD 1                         TO PV-RECS-WRITTEN-UPD.        05260000
052700*                                                                 05270000
052800***************************************************************** 05280000
052900 8500-WRITE-UPD-REC-FROM-OLD.                                     05290000
053000***************************************************************** 05300000
053100*                                                                 05310000
053200     WRITE EXPORT-CLOCK-IN-RECORD-RCYCL                           05320000
053300         FROM PV-ASSOC-STRT-REC-LAYOUT.                           05330000
053400     ADD 1                         TO PV-RECS-WRITTEN-RCY.        05340000
053500*                                                                 05350000
053600***************************************************************** 05360000
053700 9000-EOJ-ROUTINE.                                                05370000
053800***************************************************************** 05380000
053900*                                                                 05390000
054000     CLOSE EXPORT-CLOCK-IN-FILE-NEW                               05400000
054100           EXPORT-CLOCK-IN-FILE-OLD                               05410000
054200           EXPORT-CLOCK-IN-FILE-RCYCL                             05420000
054300           CLOCK-IN-JOB-FILE-OUT.                                 05430000
054400                                                                  05440000
054500     DISPLAY '**********************************'.                05450000
054600     DISPLAY '** DLKUT036 SUMMARY **'.                            05460000
054700     DISPLAY 'TOTAL NEW CLOCK REC READ = ' PV-TOTAL-INPUT-READ.   05470000
054800     DISPLAY 'TOTAL RECS WRITTEN       = ' PV-RECS-WRITTEN.       05480000
054900     DISPLAY '*************************************************'. 05490000
055000     DISPLAY 'TOTAL RECYCL RECS READ  = ' PV-TOTAL-INPUT-READ-RCY.05500000
055100     DISPLAY 'TOTAL RECYCL RECS RWRTN = ' PV-RECS-WRITTEN-RCY.    05510000
055200     DISPLAY 'TOTAL RECYCL RECS UPDATD= ' PV-RECS-WRITTEN-UPD.    05520000
055210     DISPLAY 'TOTAL RECYCL RECS DROPPED=' PV-RECS-DROPPED-RCY.    05521002
055300     DISPLAY '**************************************************'.05530000
055400*                                                                 05540000
055500******************************************************************05550000
055600* ABEND PROCEDURE                                                *05560000
055700******************************************************************05570000
055800 9999-SQL-ABEND.                                                  05580000
055900     DISPLAY '** ABEND           ** = SQLABEND'.                  05590000
056000     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          05600000
056100     DISPLAY '** PARAGRAPH       ** = ' PV-ABEND-PARAGRAPH.       05610000
056200     DISPLAY '** TABLE AFFECTED  ** = ' PV-DB2-TABLE-NAME.        05620000
056300     DISPLAY '** OPERATION       ** = ' PV-DB2-OPERATION-MESSAGE-105630000
056400     DISPLAY '**                 ** = ' PV-DB2-OPERATION-MESSAGE-205640000
056500     DISPLAY '** SQLCODE         ** = ' PV-SQLCODE.               05650000
056600     COPY DPPD004.                                                05660000
056700     MOVE +4013                  TO PV-ABEND-CODE.                05670000
056800     CALL 'ILBOABN0'   USING PV-ABEND-CODE.                       05680000
056900                                                                  05690000
