       IDENTIFICATION DIVISION.                                         00010001
       PROGRAM-ID.           PXKUT033.                                  00020001
       AUTHOR.               D. WELLER                                  00030001
       INSTALLATION.         KOHLS DEPARTMENT STORES.                   00040001
       DATE-WRITTEN          03/07/2007.                                00050001
       DATE-COMPILED.                                                   00060001
                                                                        00070001
      ******************************************************************00080001
      *   PXKUT033 - FORMAT FILE FOR ORACLE                             00090001
      *                                                                 00100001
      *   THIS PROGRAM SEQUENTIALLY READS AN INPUT FILE (PXRD040)       00110001
      *   AND CREATES A DATA OUTPUT FILE (PXRD042) FOR UNIX             00120003
      *   AND A COUNT OUTPUT FILE (PXRD045) FOR UNIX.                   00130003
      ******************** HISTORY OF CHANGES **************************00143001
      * CHG ID/                                                        *00144001
      * WR/PROJ  DATE        DESCRIPTION OF CHANGES                    *00145001
      * -------  ----------  ----------------------------------------  *00146001
      * WR39649  03/28/2011  ADD DB2 CHECK TO XST_LOC FOR PXRD040-STR- *00146126
      *                      NBR FOR E_BUS_IND = 'N' NOT ECOM STORE    *00146213
      * KAREN GIVENS         CONTINUE PROCESS RECORD, IF = 'Y' ECOM    *00146313
      *                      STORE SKIP RECORD.                        *00146413
      ******************************************************************00147001
258879* CHG ID/                                                        *00147160
258879* WR/PROJ  DATE        DESCRIPTION OF CHANGES                    *00147260
258879* -------  ----------  ----------------------------------------  *00147360
258879* SEPHORA  06/30/2021  ADD THE DB2 TABLE TMDSEAR TO CHECK IF THE *00147460
258879* CHG0258879           RECORD IS FROM A SEPHORA DEPT. IF IT IS,  *00147560
258879* BARB SCHULTZ         THE RECORD WILL NOT BE WRITTEN OUT FOR    *00147660
258879*                      BOTH OUTPUT FILES. ADDED COUNTS FOR THE   *00147761
258879*                      ECOMMERCE STORE RECORDS AND THE SEPHORA   *00147861
258879*                      RECORDS THAT ARE NOT WRITTEN OUT.         *00147961
258879******************************************************************00148061
                                                                        00148161
       ENVIRONMENT DIVISION.                                            00149001
                                                                        00150001
       CONFIGURATION SECTION.                                           00160001
                                                                        00170001
       SOURCE-COMPUTER. IBM-3090.                                       00180001
       OBJECT-COMPUTER. IBM-3090.                                       00190001
                                                                        00200001
       INPUT-OUTPUT SECTION.                                            00210001
       FILE-CONTROL.                                                    00220001
                                                                        00230001
           SELECT EXTRACT-FILE                                          00240001
               ASSIGN TO INP01.                                         00250001
                                                                        00260001
           SELECT DATA-FILE                                             00270003
               ASSIGN TO OUT01.                                         00280001
                                                                        00281003
           SELECT COUNT-FILE                                            00282003
               ASSIGN TO OUT02.                                         00283003
                                                                        00290001
       DATA DIVISION.                                                   00300001
                                                                        00310001
       FILE SECTION.                                                    00320001
       FD  EXTRACT-FILE                                                 00330001
           LABEL RECORDS ARE STANDARD                                   00340001
           RECORDING MODE IS F                                          00350001
           BLOCK CONTAINS 0 RECORDS.                                    00360001
       01  EXTRACT-RECORD                  PIC X(213).                  00370009
                                                                        00380001
       FD  DATA-FILE                                                    00390003
           LABEL RECORDS ARE STANDARD                                   00400001
           RECORDING MODE IS F                                          00410001
           BLOCK CONTAINS 0 RECORDS.                                    00420001
       01  DATA-RECORD                     PIC X(80).                   00430004
                                                                        00431003
       FD  COUNT-FILE                                                   00432003
           LABEL RECORDS ARE STANDARD                                   00433003
           RECORDING MODE IS F                                          00434003
           BLOCK CONTAINS 0 RECORDS.                                    00435003
       01  COUNT-RECORD                    PIC X(80).                   00436003
                                                                        00440001
       WORKING-STORAGE SECTION.                                         00450001
                                                                        00460001
      ***************************************************************** 00470001
      *  EXTRACT RECORD LAYOUT                                          00480001
      ***************************************************************** 00490001
      *01  PXRD040-EXTRACT-RECORD.                                      00500001
           COPY PXRD040.                                                00510001
                                                                        00520001
      ***************************************************************** 00530001
      *  DATA RECORD LAYOUT                                             00540003
      ***************************************************************** 00550001
      *01  PXRD042-DATA-RECORD.                                         00560003
           COPY PXRD042.                                                00570002
                                                                        00571003
      ***************************************************************** 00572003
      *  COUNT RECORD LAYOUT                                            00573003
      ***************************************************************** 00574003
      *01  PXRD045-COUNT-RECORD.                                        00575003
           COPY PXRD045.                                                00576003
                                                                        00578020
W39649*----------------------------------------------------------*      00579021
W39649* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         00579121
W39649*----------------------------------------------------------*      00579221
W39649     COPY DPWS004.                                                00579321
W39649                                                                  00579421
W39649*----------------------------------------------------------*      00580021
W39649* DB2 MESSAGE AREA                                                00580121
W39649*----------------------------------------------------------*      00580221
W39649     COPY SQLCA2.                                                 00580321
W39649                                                                  00580421
W39649*----------------------------------------------------------*      00580521
W39649* DB2 COMMUNICATIONS AREA                                         00580621
W39649*----------------------------------------------------------*      00580721
W39649     EXEC SQL                                                     00580821
W39649       INCLUDE SQLCA                                              00580921
W39649     END-EXEC.                                                    00581021
W39649                                                                  00581121
W39649*----------------------------------------------------------*      00581221
W39649* DB2 TABLE XST_LOC                                               00581321
W39649*----------------------------------------------------------*      00581421
W39649     EXEC SQL                                                     00581521
W39649       INCLUDE XST00001                                           00581621
W39649     END-EXEC.                                                    00581721
W39649                                                                  00581821
258879*----------------------------------------------------------*      00581960
258879* DB2 TABLE TMDSEAR                                               00582060
258879*----------------------------------------------------------*      00582160
258879     EXEC SQL                                                     00582260
258879       INCLUDE TMDSEAR                                            00582360
258879     END-EXEC.                                                    00582460
258879                                                                  00582560
                                                                        00583027
      ***************************************************************** 00590001
      *  PROGRAM'S CONSTANTS                                          * 00600001
      ***************************************************************** 00610001
       01  PC-PROGRAM-CONSTANTS.                                        00620001
           05  PC-PROGRAM-NAME             PIC X(08)       VALUE        00630001
               'PXKUT033'.                                              00640001
                                                                        00650001
      ***************************************************************** 00660001
      *  PROGRAM'S SWITCHES                                           * 00670001
      ***************************************************************** 00680001
       01  PS-PROGRAM-SWITCHES.                                         00690001
           05  PS-END-OF-INPUT-FILE-SW     PIC X(01)       VALUE 'N'.   00700001
               88  PS-END-OF-INPUT-FILE                    VALUE 'Y'.   00710001
               88  PS-NOT-END-OF-INPUT-FILE                VALUE 'N'.   00720001
W39649     05  PS-STORE-NBR-CHECK-SW       PIC X(01)       VALUE 'N'.   00721021
W39649         88  PS-STORE-NBR-FOUND-YES                  VALUE 'Y'.   00722021
W39649         88  PS-STORE-NBR-FOUND-NO                   VALUE 'N'.   00723021
258879     05  PS-SEPHORA-DEPT-NBR-SW      PIC X(01)       VALUE 'N'.   00723460
258879         88  PS-SEPHORA-DEPT-NBR-YES                 VALUE 'Y'.   00723560
258879         88  PS-SEPHORA-DEPT-NBR-NO                  VALUE 'N'.   00723660
                                                                        00730001
      ***************************************************************** 00740001
      *  PROGRAM'S VARIABLES                                          * 00750001
      ***************************************************************** 00760001
       01  PV-PROGRAM-VARIABLES.                                        00770001
           05  PV-PARAGRAPH-NAME           PIC X(40)       VALUE SPACES.00780001
           05  PV-RECORDS-READ             PIC 9(10)       VALUE 0.     00790003
           05  PV-RECORDS-WRITTEN          PIC 9(10)       VALUE 0.     00800003
258879     05  PV-SEPHORA-RECORD           PIC 9(10)       VALUE 0.     00800160
258879     05  PV-ECOMM-STR-RECORD         PIC 9(10)       VALUE 0.     00800260
258879     05  PV-PXRD040-DEPT-N           PIC 9(03)       VALUE 0.     00800360
258879     05  PV-PXRD040-DEPT-NBR         PIC X(03)       VALUE SPACES.00800460
W39649     05  PV-PXRD040-STR-NBR          PIC S9(4) COMP  VALUE 0.     00801021
258879     05  PV-PXRD040-STR-NBR-N        PIC S9(4)       VALUE 0.     00801160
W39649     05  PV-STR-NBR-PREV             PIC S9(4) COMP  VALUE 0.     00801255
258879     05  PV-DEPT-NBR-PREV            PIC S9(4) COMP-3 VALUE 0.    00801360
W39649     05  PV-SQL-CODE                 PIC S9(6) COMP-3             00802021
W39649                                                     VALUE 0.     00805021
                                                                        00810001
      ***************************************************************** 00820001
      *  ABEND CODE AREA                                              * 00830001
      ***************************************************************** 00840001
       01  PV-ABEND-CODE                   PIC S9(04)      VALUE ZEROES 00850001
                               COMP SYNC.                               00860001
           88  ABEND-4001-INV-WRITE-KEY                    VALUE +4001. 00870001
           88  ABEND-4002-INV-READ-KEY                     VALUE +4002. 00880001
           88  ABEND-4003-CNTL-CARD-ERRORS                 VALUE +4003. 00890001
           88  ABEND-4004-SEQUENCE-ERROR                   VALUE +4004. 00900001
           88  ABEND-4005-OPEN-FILE-ERROR                  VALUE +4005. 00910001
           88  ABEND-4006-CLOSE-FILE-ERROR                 VALUE +4006. 00920001
           88  ABEND-4007-SEQUENCE-ERROR                   VALUE +4007. 00930001
           88  ABEND-4009-INVALID-DATA                     VALUE +4009. 00940001
           88  ABEND-4012-BAD-INTR-SORT                    VALUE +4012. 00950001
           88  ABEND-4013-DB-ERROR                         VALUE +4013. 00960001
                                                                        00970001
       01  WS-MSG-TEXT                     PIC X(512)      VALUE SPACES.00980001
       01  WS-MAX-SIZE                     PIC S9(09)      VALUE +512   00990001
                               COMP.                                    01000001
       01  WS-MSG-LENGTH                   PIC S9(09)      VALUE ZEROES 01010001
                               COMP.                                    01020013
                                                                        01032001
       PROCEDURE DIVISION.                                              01040001
                                                                        01050001
      ******************************************************************01060001
      *    MAINLINE LOGIC                                              *01070001
      ******************************************************************01080001
                                                                        01090001
       0000-MAINLINE.                                                   01100001
                                                                        01110001
           PERFORM 1000-INITIALIZATION.                                 01120001
                                                                        01130001
           PERFORM 2000-PROCESS-INPUT                                   01140001
               UNTIL PS-END-OF-INPUT-FILE.                              01150001
                                                                        01160001
           PERFORM 9900-EOJ-LOGIC.                                      01170001
                                                                        01180001
           GOBACK.                                                      01190001
                                                                        01200001
      ******************************************************************01210001
      *    LOGON TO ORACLE, AND DECLARE THE ORACLE CURSORS.            *01220001
      ******************************************************************01230001
       1000-INITIALIZATION.                                             01240001
                                                                        01250001
           OPEN INPUT  EXTRACT-FILE.                                    01270003
           OPEN OUTPUT DATA-FILE.                                       01290003
           OPEN OUTPUT COUNT-FILE.                                      01291003
                                                                        01300001
           PERFORM 6100-READ-EXTRACT-FILE.                              01320001
           IF PS-END-OF-INPUT-FILE                                      01330001
               DISPLAY ' *** NOTHING TO PROCESS ***'                    01340001
               DISPLAY ' '                                              01350001
W39649     ELSE                                                         01351023
W39649         MOVE ZEROES            TO PV-STR-NBR-PREV                01352025
258879                                   PV-DEPT-NBR-PREV               01353060
           END-IF.                                                      01360001
                                                                        01370001
      ******************************************************************01380001
      *    2000-PROCESS-INPUT                                          *01390001
      *      THIS IS PERFORMED ONLY VIA THE 0000-MAINLINE              *01400001
      *      PURPOSE: READ AND PROCESS THE PURCHASE ADJUSTMENT FILE    *01410001
      *               TO UPDATE THE DAT_AVL_VND_FUND TABLE             *01420001
      ******************************************************************01430001
       2000-PROCESS-INPUT.                                              01440001
W39649                                                                  01451021
W39649     IF PXRD040-STR-NBR = PV-STR-NBR-PREV                         01451123
258879        IF PXRD040-DEPT-NBR = PV-DEPT-NBR-PREV                    01451260
258879           PERFORM 2050-PROCESS                                   01451460
258879        ELSE                                                      01452060
258879           PERFORM 8000-FIND-IF-SEPHORA-DEPT                      01452160
258879           PERFORM 2050-PROCESS                                   01452260
258879           MOVE PXRD040-DEPT-NBR  TO PV-DEPT-NBR-PREV             01452860
258879        END-IF                                                    01452960
258879     ELSE                                                         01453160
W39649         PERFORM 2100-CHECK-STORE-NBR                             01453340
W39649         IF PS-STORE-NBR-FOUND-YES                                01453540
258879            IF PXRD040-DEPT-NBR = PV-DEPT-NBR-PREV                01453660
258879               PERFORM 2050-PROCESS                               01453760
258879            ELSE                                                  01454460
258879               PERFORM 8000-FIND-IF-SEPHORA-DEPT                  01454560
258879               PERFORM 2050-PROCESS                               01454660
258879               MOVE PXRD040-DEPT-NBR  TO PV-DEPT-NBR-PREV         01455260
258879            END-IF                                                01455360
W39649            MOVE PXRD040-STR-NBR   TO PV-STR-NBR-PREV             01455454
W39649         END-IF                                                   01456640
W39649     END-IF.                                                      01457039
                                                                        01470001
           PERFORM 6100-READ-EXTRACT-FILE.                              01480001
                                                                        01490001
258879******************************************************************01490160
258879*    2050-PROCESS                                                *01490260
258879*      THIS IS PERFORMED ONLY VIA THE 2100-PROCESS-INPUT         *01490360
258879*      PURPOSE: PROCESS THE PURCHASE ADJUSTMENT FILE             *01490460
258879******************************************************************01490660
258879 2050-PROCESS.                                                    01490760
258879                                                                  01490960
258879     IF PS-SEPHORA-DEPT-NBR-YES                                   01491060
258879         ADD +1 TO PV-SEPHORA-RECORD                              01491760
258879     ELSE                                                         01491960
258879         PERFORM 7000-PROCESS-INPUT                               01492060
258879     END-IF.                                                      01492160
258879                                                                  01492260
W39649******************************************************************01492356
W39649*     2100-CHECK-STORE-NBR                                       *01493021
W39649*      THIS IS PERFORMED TO SEE IF STORE NUMBER IS ECOM OR       *01493121
W39649*      BRICK AND MORTAR. IF E_BUS_IND ='N', CONTINUE PROCESSING  *01493221
W39649*      AND IF E_BUS_IND = 'Y', SKIP RECORD.                      *01493321
W39649******************************************************************01494021
W39649 2100-CHECK-STORE-NBR.                                            01495021
W39649                                                                  01496046
W39649      SET PS-STORE-NBR-FOUND-NO  TO TRUE.                         01499421
W39649      MOVE PXRD040-STR-NBR       TO PV-PXRD040-STR-NBR.           01499521
W39649                                                                  01499621
W39649      EXEC SQL                                                    01499821
W39649        SELECT LOC_NBR                                            01499923
W39649          INTO :XST00001-LOC-NBR                                  01500023
W39649         FROM  XST_LOC                                            01500121
W39649        WHERE  LOC_NBR      = :PV-PXRD040-STR-NBR                 01500321
W39649          AND  LOC_TYP_CDE  = 'DS'                                01500421
W39649          AND  E_BUS_IND    = 'N'                                 01500523
W39649      END-EXEC                                                    01500623
W39649                                                                  01500723
W39649      EVALUATE TRUE                                               01500823
W39649           WHEN SQLCODE = +0                                      01501121
W39649             SET PS-STORE-NBR-FOUND-YES TO TRUE                   01501221
W39649           WHEN SQLCODE = +100                                    01501421
W39649             SET PS-STORE-NBR-FOUND-NO  TO TRUE                   01501521
258879             ADD +1 TO PV-ECOMM-STR-RECORD                        01501660
W39649           WHEN OTHER                                             01501958
W39649             SET PS-STORE-NBR-FOUND-NO  TO TRUE                   01502058
W39649     END-EVALUATE.                                                01502921
W39649                                                                  01503021
W39649                                                                  01504021
      ******************************************************************01505001
      *  READ EXTRACT FILE                                              01510001
      ******************************************************************01520001
       6100-READ-EXTRACT-FILE.                                          01530001
                                                                        01540001
           READ EXTRACT-FILE INTO PXRD040-EXTRACT-RECORD                01550001
               AT END SET PS-END-OF-INPUT-FILE TO TRUE.                 01560001
                                                                        01570001
           IF PS-NOT-END-OF-INPUT-FILE                                  01580001
               ADD 1 TO PV-RECORDS-READ                                 01590001
           END-IF.                                                      01600001
                                                                        01610001
      ******************************************************************01620001
      *  WRITE OUT DATA RECORD                                          01630003
      ******************************************************************01640001
       6300-WRITE-DATA-FILE.                                            01650003
                                                                        01660001
           WRITE DATA-RECORD FROM PXRD042-DATA-RECORD.                  01670003
           ADD 1 TO PV-RECORDS-WRITTEN.                                 01671003
                                                                        01680001
      ******************************************************************01681003
      *  WRITE OUT COUNT RECORD                                         01682003
      ******************************************************************01683003
       6400-WRITE-COUNT-FILE.                                           01684003
                                                                        01685003
           MOVE PV-RECORDS-WRITTEN     TO PXRD045-COUNT.                01685103
           WRITE COUNT-RECORD FROM PXRD045-COUNT-RECORD.                01686003
                                                                        01688003
      ******************************************************************01690001
      *  PROCESS INPUT                                                  01700001
      ******************************************************************01710001
       7000-PROCESS-INPUT.                                              01720001
                                                                        01730001
           MOVE '7000-PROCESS-INPUT'   TO PV-PARAGRAPH-NAME.            01740001
                                                                        01750001
           MOVE PXRD040-EVNT-CTG-CDE   TO PXRD042-EVNT-CTG-CDE.         01751004
           MOVE PXRD040-PRCHG-TYP-CDE  TO PXRD042-PRCHG-TYP-CDE.        01752004
           MOVE PXRD040-EFF-DATE       TO PXRD042-EFF-DATE.             01753004
           MOVE PXRD040-STR-NBR        TO PXRD042-STR-NBR.              01754004
           MOVE PXRD040-SKU-NBR        TO PXRD042-SKU-NBR.              01755004
           IF PXRD040-STR-EXPTED-QTY < 0 THEN                           01755112
               MOVE ZEROES             TO PXRD042-STR-EXPTED-QTY        01755212
           ELSE                                                         01755312
               MOVE PXRD040-STR-EXPTED-QTY                              01756012
                                       TO PXRD042-STR-EXPTED-QTY        01757012
           END-IF.                                                      01758012
           MOVE PXRD040-PRCHG-ID       TO PXRD042-PRCHG-ID.             01760002
           MOVE PXRD040-UNT-RTL-AMT    TO PXRD042-NEW-UNT-RTL-AMT.      01921005
           IF PXRD040-GP-RTL-QTY-NULL-IND = X'6F'                       01922011
               MOVE ZEROES             TO PXRD042-NW-GP-RTL-QTY         01922311
           ELSE                                                         01922411
               MOVE PXRD040-GP-RTL-QTY TO PXRD042-NW-GP-RTL-QTY         01922511
           END-IF.                                                      01922611
           IF PXRD040-GP-RTL-AMT-NULL-IND = X'6F'                       01923111
               MOVE ZEROES             TO PXRD042-NW-GP-RTL-AMT         01923207
           ELSE                                                         01923307
               MOVE PXRD040-GP-RTL-AMT TO PXRD042-NW-GP-RTL-AMT         01923507
           END-IF.                                                      01923607
                                                                        01960001
           PERFORM 6300-WRITE-DATA-FILE.                                01970003
                                                                        01980001
258879******************************************************************01981060
258879*  FIND IF THE RECORD HAS A SEPHORA DEPT                          01982060
258879******************************************************************01983060
258879 8000-FIND-IF-SEPHORA-DEPT.                                       01984060
258879                                                                  01984260
258879     SET PS-SEPHORA-DEPT-NBR-NO TO TRUE.                          01984460
258879     MOVE PXRD040-DEPT-NBR      TO PV-PXRD040-DEPT-N.             01984660
258879     MOVE PV-PXRD040-DEPT-N     TO PV-PXRD040-DEPT-NBR.           01984760
258879                                                                  01985260
258879     EXEC SQL                                                     01985360
258879        SELECT DEPT_NBR                                           01985460
258879           INTO :MDSEAR-DEPT-NBR                                  01985560
258879        FROM TMDSEAR                                              01985660
258879        WHERE DMA_NBR    = '50'                                   01985760
258879          AND MDSELV_CDE = 'DPT'                                  01985860
258879          AND DEPT_NBR   = :PV-PXRD040-DEPT-NBR                   01985960
258879          AND STRT_DTE  <= CURRENT DATE                           01986060
258879          AND END_DTE   >= CURRENT DATE                           01986160
258879     END-EXEC.                                                    01986260
258879                                                                  01986360
258879     EVALUATE TRUE                                                01990160
258879        WHEN SQLCODE = +0                                         01990260
258879             SET PS-SEPHORA-DEPT-NBR-YES TO TRUE                  01990360
258879        WHEN SQLCODE = +100                                       01991060
258879             SET PS-SEPHORA-DEPT-NBR-NO  TO TRUE                  01991160
258879        WHEN OTHER                                                01991460
258879             SET PS-SEPHORA-DEPT-NBR-NO  TO TRUE                  01991560
258879     END-EVALUATE.                                                01991660
258879                                                                  01991760
      ******************************************************************01992001
      *    9900-EOJ-LOGIC.                                              02000001
      *      THIS IS PERFORMED AT END OF INPUT FILE.                    02010001
      *      PURPOSE: CLOSE INPUT FILE,                                 02020001
      *      DISPLAY RECORD COUNTS.                                     02030001
      ******************************************************************02040001
       9900-EOJ-LOGIC.                                                  02050001
                                                                        02060001
           PERFORM 6400-WRITE-COUNT-FILE.                               02070003
           CLOSE EXTRACT-FILE.                                          02080003
           CLOSE DATA-FILE.                                             02090003
           CLOSE COUNT-FILE.                                            02091003
                                                                        02100001
           DISPLAY ' '.                                                 02110001
           DISPLAY 'RECORDS READ       ' PV-RECORDS-READ.               02120001
           DISPLAY 'PARAMETERS WRITTEN ' PV-RECORDS-WRITTEN.            02130001
258879     DISPLAY 'SEPHORA RECORD NOT WRITTEN ' PV-SEPHORA-RECORD.     02130160
258879     DISPLAY 'ECOMM STR RECORD NOT WRITTEN ' PV-ECOMM-STR-RECORD. 02130260
           DISPLAY '**------ END ' PC-PROGRAM-NAME ' ------**'.         02140001
                                                                        02150001
      ******************************************************************02160001
      * PROGRAM ABEND PARAGRAPH                                         02170001
      ******************************************************************02180001
       9999-ABEND.                                                      02190001
                                                                        02200001
           CALL 'ILBOABN0'  USING PV-ABEND-CODE.                        02210001
                                                                        02220001
      ******************************************************************02230001
      *    END OF SOURCE CODE FOR PXKUT033                             *02240001
      ******************************************************************02250001
