000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400 PROGRAM-ID.    RCKUT173.                                         00040000
000500 AUTHOR.        GERMAN BANDA.                                     00050000
000600 INSTALLATION.  KOHLS.                                            00060000
000700 DATE-WRITTEN   MAY, 2021.                                        00070000
000800 DATE-COMPILED.                                                   00080000
000900******************************************************************00090000
001000*   THIS PROGRAM WILL READ IN A FILE THAT CONTAINS A BEGIN        00100000
001100*   AND END TIMESTAMP. THE TIMESTAMPS WILL BE USED IN THE DRIVING 00110000
001200*   CURSOR TO DETERMINE THE RMS_PO_UPD_TMST RANGE. THE CURSOR     00120000
001300*   WILL RETURN PURCHASE ORDERS FOR THE RANGE.  THE UNION OF THE  00130000
001400*   CURSOR WILL READ A WST CONFIGURATION PARAMETER, WHERE SPECIFIC00140000
001500*   PO'S CAN BE KEYED BY USER IN ORDER TO PROCESS SPECIFIC PO'S.  00150000
001600******************************************************************00160000
001700 ENVIRONMENT DIVISION.                                            00170000
001800 CONFIGURATION SECTION.                                           00180000
001900                                                                  00190000
002000 SOURCE-COMPUTER.        IBM-3090.                                00200000
002100 OBJECT-COMPUTER.        IBM-3090.                                00210000
002200                                                                  00220000
002300 INPUT-OUTPUT SECTION.                                            00230000
002400 FILE-CONTROL.                                                    00240000
002500                                                                  00250000
002600     SELECT TIMESTAMP-FILE                                        00260000
002700         ASSIGN TO INP01.                                         00270000
002800                                                                  00280000
002900     SELECT SKU-SORT-FILE-OUT                                     00290000
003000         ASSIGN TO OUT01.                                         00300000
003100                                                                  00310000
003200******************************************************************00320000
003300 DATA DIVISION.                                                   00330000
003400 FILE SECTION.                                                    00340000
003500                                                                  00350000
003600 FD  TIMESTAMP-FILE                                               00360000
003700     RECORDING MODE IS F                                          00370000
003800     LABEL RECORDS ARE STANDARD                                   00380000
003900     BLOCK CONTAINS 0 RECORDS.                                    00390000
004000                                                                  00400000
004100 01  TIMESTAMP-RECORD                   PIC  X(80).               00410000
004200                                                                  00420000
004300 FD  SKU-SORT-FILE-OUT                                            00430000
004400     RECORDING MODE IS F                                          00440000
004500     LABEL RECORDS ARE STANDARD                                   00450000
004600     BLOCK CONTAINS 0 RECORDS.                                    00460000
004700                                                                  00470000
004800 01  SKU-SORT-RECORD-OUT                PIC  X(100).              00480000
004900*                                                                 00490000
005000******************************************************************00500000
005100 WORKING-STORAGE SECTION.                                         00510000
005200******************************************************************00520000
005300*  SKU SORT RECORD COPYBOOK                                       00530000
005400******************************************************************00540000
005500     COPY RCRD103.                                                00550000
005600                                                                  00560000
005700 01  PS-PROGRAM-SWITCHES.                                         00570000
005800     05  PS-END-OF-FILE-SW           PIC  X(01)    VALUE 'N'.     00580000
005900         88  PS-END-OF-FILE                        VALUE 'Y'.     00590000
006000         88  PS-NOT-END-OF-FILE                    VALUE 'N'.     00600000
006100                                                                  00610000
006200     05  PS-END-OF-CURSOR-SW         PIC  X(01)    VALUE 'N'.     00620000
006300         88  PS-END-OF-CURSOR                      VALUE 'Y'.     00630000
006400         88  PS-NOT-END-OF-CURSOR                  VALUE 'N'.     00640000
006500     05  PS-END-OF-DC-CURSOR-SW      PIC  X(01)    VALUE 'N'.     00650000
006600         88  PS-END-OF-DC-CURSOR                   VALUE 'Y'.     00660000
006700         88  PS-NOT-END-OF-DC-CURSOR               VALUE 'N'.     00670000
006800     05  PS-SKU-SORT-OPER-SW         PIC  X(01)    VALUE 'N'.     00680000
006900         88  PS-SKU-SORT-OPER-YES                  VALUE 'Y'.     00690000
007000         88  PS-SKU-SORT-OPER-NO                   VALUE 'N'.     00700000
007100                                                                  00710000
007200     05  PS-SKU-SORT-DEPT-SW         PIC  X(01)    VALUE 'N'.     00720000
007300         88  PS-SKU-SORT-DEPT-YES                  VALUE 'Y'.     00730000
007400         88  PS-SKU-SORT-DEPT-NO                   VALUE 'N'.     00740000
007500                                                                  00750000
007600 01  PC-PROGRAM-CONSTANTS.                                        00760000
007700     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08) VALUE 'RCKUT173'. 00770000
007800                                                                  00780000
007900 01  PV-PROGRAM-VARIABLES.                                        00790000
008000     05  PV-RECORDS-FETCHED          PIC  9(9) COMP VALUE ZEROS.  00800000
008100     05  PV-TOTAL-WRITE-COUNT        PIC  9(9) COMP VALUE ZEROS.  00810000
008200     05  PV-DISPLAY-COUNT            PIC  ZZZ,ZZZ,ZZ9.            00820000
008300     05  PV-DISPLAY-SQLCODE          PIC  +999  VALUE ZEROES.     00830000
008400     05  PV-DISPLAY-STORE            PIC  9999  VALUE ZEROES.     00840000
008500     05  PV-DISPLAY-OPER             PIC  9999.                   00850000
008600     05  PV-PREV-STORE               PIC S9(4)  COMP VALUE ZEROS. 00860000
008700     05  PV-PO-NBR                   PIC  S9(9) COMP.             00870000
008800     05  PV-PO-NBR-DISP              PIC  X(10) VALUE SPACES.     00880000
008900     05  PV-HOLD-PO-NBR              PIC  S9(9) COMP.             00890000
009000     05  PV-HOLD-OPER-UNT-ID         PIC  S9(4) COMP.             00900000
009100     05  PV-FROM-TIMESTAMP           PIC X(26)     VALUE SPACES.  00910000
009200     05  PV-TO-TIMESTAMP             PIC X(26)     VALUE SPACES.  00920000
009300     05  PV-VENDOR-PO                PIC  X(10).                  00930000
009400     05  PV-VENDOR-PO-N  REDEFINES  PV-VENDOR-PO.                 00940000
009500         10 FILLER                       PIC  9(01).              00950000
009600         10 PV-VENDOR-PO-R               PIC  9(09).              00960000
009700                                                                  00970000
009800                                                                  00980000
009900 01  PV-TIMESTAMP-RECORD.                                         00990000
010000     05  PV-FROM-TMST-RECORD         PIC X(26)     VALUE SPACES.  01000000
010100     05  FILLER                      PIC X(01)     VALUE SPACES.  01010000
010200     05  PV-TO-TMST-RECORD           PIC X(26)     VALUE SPACES.  01020000
010300     05  FILLER                      PIC X(27)     VALUE SPACES.  01030000
010310                                                                  01031000
010320 01  PV-ABEND-CODE                    PIC S9(04)   VALUE ZERO     01032000
010330                                                   COMP SYNC.     01033000
010340 01  PV-ABEND-FIELDS.                                             01034000
010350     05  PV-ABEND-PROGRAM             PIC X(8)   VALUE 'RCKUT173'.01035000
010360     05  PV-ABEND-PARAGRAPH           PIC X(50)  VALUE SPACES.    01036000
010370     05  PV-ABEND-OPERATION           PIC X(50)  VALUE SPACES.    01037000
010380     05  PV-ABEND-STATUS              PIC XX     VALUE SPACES.    01038000
010390     05  PV-ABEND-TABLE-1            PIC X(19) VALUE SPACES.      01039000
010400     05  PV-ABEND-TABLE-2            PIC X(19) VALUE SPACES.      01040000
010500     05  PV-ABEND-TABLE-3            PIC X(19) VALUE SPACES.      01050000
010600     05  PV-ABEND-TABLE-4            PIC X(19) VALUE SPACES.      01060000
010700     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    01070000
010800     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    01080000
010900     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    01090000
011000     05  PV-DB2-OPERATION-MESSAGE-4   PIC  X(79) VALUE SPACES.    01100000
011100*  USED FOR DB2 ERROR MESSAGE BUILDING                            01110000
011200     COPY DPWS004.                                                01120000
011300                                                                  01130000
011400******************************************************************01140000
011500*  COMMUNICATIONS AREA FOR DB2                                    01150000
011600******************************************************************01160000
011700     EXEC SQL                                                     01170000
011800          INCLUDE SQLCA                                           01180000
011900     END-EXEC.                                                    01190000
012000                                                                  01200000
012100******************************************************************01210000
012200*  PURCHASE ORDER TABLE                                           01220000
012300******************************************************************01230000
012400     EXEC SQL                                                     01240000
012500          INCLUDE TPURCHS                                         01250000
012600     END-EXEC.                                                    01260000
012700                                                                  01270000
012800******************************************************************01280000
012900*  PARAMATER TABLE                                                01290000
013000******************************************************************01300000
013100     EXEC SQL                                                     01310000
013200          INCLUDE TKRPRPM                                         01320000
013300     END-EXEC.                                                    01330000
013400                                                                  01340000
013500***************************************************************** 01350000
013600*    WST_INTGRTN_TYP TABLE                                        01360000
013700***************************************************************** 01370000
013800     EXEC SQL                                                     01380000
013900          INCLUDE WST00008                                        01390000
014000     END-EXEC.                                                    01400000
014100                                                                  01410000
014200***************************************************************** 01420000
014300*    WST_ATTR_ELEM TABLE                                          01430000
014400***************************************************************** 01440000
014500     EXEC SQL                                                     01450000
014600          INCLUDE WST00009                                        01460000
014700     END-EXEC.                                                    01470000
014800                                                                  01480000
014900***************************************************************** 01490000
015000*    WST_ATTR_DEFN TABLE                                          01500000
015100***************************************************************** 01510000
015200     EXEC SQL                                                     01520000
015300          INCLUDE WST00010                                        01530000
015400     END-EXEC.                                                    01540000
015500                                                                  01550000
015600***************************************************************** 01560000
015700*    PO ALLOCATION TABLE                                          01570000
015800***************************************************************** 01580000
015900     EXEC SQL                                                     01590000
016000          INCLUDE TALLPLN                                         01600000
016100     END-EXEC.                                                    01610000
016200                                                                  01620000
016300***************************************************************** 01630000
016400*    PO INSTRUCTION CODE TABLE                                    01640000
016500***************************************************************** 01650000
016600     EXEC SQL                                                     01660000
016700          INCLUDE TINSTCD                                         01670000
016800     END-EXEC.                                                    01680000
016900                                                                  01690000
017000***************************************************************** 01700000
017100*    PO INSTRUCTION TABLE                                         01710000
017110***************************************************************** 01711000
017120     EXEC SQL                                                     01712000
017130          INCLUDE TPOINST                                         01713000
017140     END-EXEC.                                                    01714000
017150                                                                  01715000
017160******************************************************************01716000
017170* CURSOR TO RETURN PO'S WITHIN THE TIME FRAME AND KEYED PO'S      01717000
017180* ON THE INTEGRATION PARAMTER                                     01718000
017190******************************************************************01719000
017200     EXEC SQL                                                     01720000
017300      DECLARE PO-CSR  CURSOR FOR                                  01730000
017400        SELECT  G.PO_NBR                                          01740000
017500              , G.DEPT_NBR                                        01750000
017600          FROM WST_INTGRTN_TYP A                                  01760000
017700             , WST_ATTR_DEFN B                                    01770000
017800             , WST_ATTR_ELEM C  -- DEPARTMENT                     01780000
017900             , WST_ATTR_ELEM D  -- AC/IN    ACTIVE/INA            01790000
017910             , WST_ATTR_ELEM E  -- BEGIN TMST                     01791000
017920             , WST_ATTR_ELEM F  -- END TMST                       01792000
017921             , TPURCHS G                                          01792100
017922        WHERE A.INTGRTN_TYP_CDE   = 'SKUSORTDPT'                  01792200
017923          AND A.INTGRTN_TYP_CDE   = B.INTGRTN_TYP_CDE             01792300
017924          AND B.ATTR_DEFN_SEQ_NBR = 1                             01792400
017925          AND B.INTGRTN_TYP_CDE   = C.INTGRTN_TYP_CDE             01792500
017926          AND C.ATTR_DEFN_SEQ_NBR = 1                             01792600
017927          AND B.INTGRTN_TYP_CDE   = D.INTGRTN_TYP_CDE             01792700
017928          AND D.ATTR_DEFN_SEQ_NBR = 2                             01792800
017929          AND B.INTGRTN_TYP_CDE   = E.INTGRTN_TYP_CDE             01792900
017930          AND E.ATTR_DEFN_SEQ_NBR = 3                             01793000
017931          AND B.INTGRTN_TYP_CDE   = F.INTGRTN_TYP_CDE             01793100
017932          AND F.ATTR_DEFN_SEQ_NBR = 4                             01793200
017933          AND C.ATTR_ELEM_SEQ_NBR = D.ATTR_ELEM_SEQ_NBR           01793300
017934          AND C.ATTR_ELEM_SEQ_NBR = E.ATTR_ELEM_SEQ_NBR           01793400
017935          AND C.ATTR_ELEM_SEQ_NBR = F.ATTR_ELEM_SEQ_NBR           01793500
017936          AND D.ATTR_ELEM_TXT     = 'AC'                          01793600
017937          AND E.ATTR_ELEM_TMST   <= CURRENT TIMESTAMP             01793700
017938          AND F.ATTR_ELEM_TMST   >= CURRENT TIMESTAMP             01793800
017939                                                                  01793900
017940          AND G.VER_STATUS_CDE = 'A'                              01794000
017941          AND C.ATTR_ELEM_TXT    = G.DEPT_NBR                     01794100
017943          AND RMS_PO_UPD_TMST >= :PV-FROM-TIMESTAMP               01794303
017944          AND RMS_PO_UPD_TMST <  :PV-TO-TIMESTAMP                 01794403
017945     UNION ALL                                                    01794502
017946       SELECT  C.ATTR_ELEM_NBR  AS PO_NBR                         01794602
017947              ,H.DEPT_NBR                                         01794702
017948         FROM WST_INTGRTN_TYP A                                   01794802
017949            , WST_ATTR_DEFN B                                     01794902
017950            , WST_ATTR_ELEM C  -- PO NUMBER                       01795002
017951            , WST_ATTR_ELEM D  -- Y/N                             01795102
017952            , WST_ATTR_ELEM E  -- BEGIN TMST                      01795202
017953            , WST_ATTR_ELEM F  -- USER ID                         01795302
017954            , WST_ATTR_ELEM G  -- REASON                          01795402
017955            , TPURCHS H        -- REASON                          01795502
017956          WHERE A.INTGRTN_TYP_CDE   = 'SKUSORTPOP'                01795602
017957            AND A.INTGRTN_TYP_CDE   = B.INTGRTN_TYP_CDE           01795702
017958            AND B.ATTR_DEFN_SEQ_NBR = 1                           01795802
017959            AND B.INTGRTN_TYP_CDE   = C.INTGRTN_TYP_CDE           01795902
017960            AND C.ATTR_DEFN_SEQ_NBR = 1                           01796002
017961            AND B.INTGRTN_TYP_CDE   = D.INTGRTN_TYP_CDE           01796102
017962            AND D.ATTR_DEFN_SEQ_NBR = 2                           01796202
017963            AND B.INTGRTN_TYP_CDE   = E.INTGRTN_TYP_CDE           01796302
017964            AND E.ATTR_DEFN_SEQ_NBR = 3                           01796402
017965            AND B.INTGRTN_TYP_CDE   = F.INTGRTN_TYP_CDE           01796502
017966            AND F.ATTR_DEFN_SEQ_NBR = 4                           01796602
017967            AND B.INTGRTN_TYP_CDE   = G.INTGRTN_TYP_CDE           01796702
017968            AND G.ATTR_DEFN_SEQ_NBR = 5                           01796802
017969            AND C.ATTR_ELEM_SEQ_NBR = D.ATTR_ELEM_SEQ_NBR         01796902
017970            AND C.ATTR_ELEM_SEQ_NBR = E.ATTR_ELEM_SEQ_NBR         01797002
017971            AND C.ATTR_ELEM_SEQ_NBR = F.ATTR_ELEM_SEQ_NBR         01797102
017972            AND C.ATTR_ELEM_SEQ_NBR = G.ATTR_ELEM_SEQ_NBR         01797202
017973            AND D.ATTR_ELEM_TXT     = 'Y'                         01797302
017974            AND E.ATTR_ELEM_TMST   <= CURRENT TIMESTAMP           01797402
017975            AND C.ATTR_ELEM_NBR     = H.PO_NBR                    01797502
017976            AND H.VER_STATUS_CDE    = 'A'                         01797602
017977         WITH UR                                                  01797702
017978     END-EXEC.                                                    01797802
017979******************************************************************01797902
017980* CURSOR TO TAKE PO'S RETURNED FROM THE PO_CSR AND RETURN THE     01798002
017981* RDC LOCATIONS THAT ARE ALLOCATED                                01798102
017990******************************************************************01799000
017991     EXEC SQL                                                     01799100
017992      DECLARE DC-CSR  CURSOR FOR                                  01799200
017993        SELECT DISTINCT                                           01799300
017994               PO_NBR                                             01799400
017995              ,DEST_NBR                                           01799500
017996        FROM TALLPLN A                                            01799600
017997            ,TKRPRPM B                                            01799700
017998        WHERE PO_NBR = :PURCHS-PO-NBR                             01799800
017999          AND  A.DEST_NBR  =    B.LOC_ID                          01799900
018000          AND  B.INTFC_SYS_CDE     = 'KHL'                        01800000
018100          AND  B.SYS_PRC_FUNC_CDE  = 'SKUSRT'                     01810000
018200          AND  B.FUNC_PRC_STAT_CDE = 'AC'                         01820000
018210          AND  B.FUNC_TXT          = 'Y'                          01821000
018220         WITH UR                                                  01822000
018230     END-EXEC.                                                    01823000
018240******************************************************************01824000
018250******************************************************************01825000
018260 PROCEDURE DIVISION.                                              01826000
018270******************************************************************01827000
018280******************************************************************01828000
018290* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     01829000
018300*      PROGRAM.                                                   01830000
018400******************************************************************01840000
018500 0000-PROGRAM-MAINLINE.                                           01850000
018600                                                                  01860000
018700     DISPLAY ' '.                                                 01870000
018800     DISPLAY '***** RCKUT173 STARTED *****'.                      01880000
018900                                                                  01890000
019000     PERFORM 1000-INITIALIZE.                                     01900000
019100                                                                  01910000
019200     SET  PS-NOT-END-OF-CURSOR   TO  TRUE.                        01920000
019300     PERFORM 2000-OPEN-PO-CSR.                                    01930000
019400                                                                  01940000
019500     PERFORM 2100-FETCH-PO-CSR                                    01950000
019600              UNTIL PS-END-OF-CURSOR                              01960000
019700                                                                  01970000
019800     PERFORM 2800-CLOSE-PO-CSR.                                   01980000
019900                                                                  01990000
020000     PERFORM 9000-EOJ-ROUTINE.                                    02000000
020100                                                                  02010000
020200     GOBACK.                                                      02020000
020300                                                                  02030000
020400******************************************************************02040000
020500******************************************************************02050000
020600 1000-INITIALIZE.                                                 02060000
020700                                                                  02070000
020800     OPEN INPUT  TIMESTAMP-FILE                                   02080000
020900          OUTPUT SKU-SORT-FILE-OUT.                               02090000
021000                                                                  02100000
021100     MOVE 'N'  TO PS-END-OF-FILE-SW.                              02110000
021200     PERFORM 1200-READ-INPUT-FILE.                                02120000
021300                                                                  02130000
021400     MOVE   PV-FROM-TMST-RECORD  TO  PV-FROM-TIMESTAMP.           02140000
021500     MOVE   PV-TO-TMST-RECORD    TO  PV-TO-TIMESTAMP.             02150000
021600                                                                  02160000
021700                                                                  02170000
021800     IF PS-END-OF-FILE                                            02180000
021900         DISPLAY ' '                                              02190000
022000         DISPLAY ' *** EMPTY TIMESTAMP FILE  ***'                 02200000
022100         DISPLAY ' '                                              02210000
022200     END-IF.                                                      02220000
022300                                                                  02230000
022400******************************************************************02240000
022500*  READ INPUT FILE                                                02250000
022600******************************************************************02260000
022700 1200-READ-INPUT-FILE.                                            02270000
022800                                                                  02280000
022900     READ TIMESTAMP-FILE                                          02290000
023000         INTO PV-TIMESTAMP-RECORD                                 02300000
023100             AT END                                               02310000
023200                 MOVE 'Y' TO PS-END-OF-FILE-SW.                   02320000
023300                                                                  02330000
023400******************************************************************02340000
023500*  OPEN PO CURSOR                                                 02350000
023600******************************************************************02360000
023700*---------------------------------------------------------------* 02370000
023800* OPEN PO CURSOR                                                  02380000
023900*---------------------------------------------------------------* 02390000
024000 2000-OPEN-PO-CSR.                                                02400000
024100                                                                  02410000
024200         EXEC SQL                                                 02420000
024300              OPEN PO-CSR                                         02430000
024400         END-EXEC                                                 02440000
024500                                                                  02450000
024600         EVALUATE TRUE                                            02460000
024700             WHEN SQLCODE = +0                                    02470000
024800             WHEN SQLCODE = -904                                  02480000
024900             WHEN SQLCODE = -911                                  02490000
025000             WHEN SQLCODE = -913                                  02500000
025100                 CONTINUE                                         02510000
025200             WHEN SQLWARN0 NOT EQUAL SPACE                        02520000
025300             WHEN SQLCODE NOT EQUAL ZERO                          02530000
025400                 MOVE '2000-OPEN-PO-CSR'                          02540000
025500                                      TO PV-ABEND-PARAGRAPH       02550000
025600                 MOVE 'ERROR OPENING ASN CURSOR'                  02560000
025700                                TO PV-DB2-OPERATION-MESSAGE-1     02570000
025800                 STRING PV-FROM-TIMESTAMP '-'                     02580000
025900                        PV-TO-TIMESTAMP  DELIMITED BY SIZE        02590000
026000                            INTO PV-DB2-OPERATION-MESSAGE-1       02600000
026100                 MOVE 'TPURCHS'       TO PV-ABEND-TABLE-1         02610000
026200                 MOVE 'WST_ATTR'      TO PV-ABEND-TABLE-2         02620000
026300                 PERFORM 9100-SQL-ABEND                           02630000
026400         END-EVALUATE.                                            02640000
026500                                                                  02650000
026600                                                                  02660000
026700*---------------------------------------------------------------* 02670000
026800* FETCH A ROW FROM THE AUDIT CONTROL GROUP CURSOR.               *02680000
026900*---------------------------------------------------------------* 02690000
027000 2100-FETCH-PO-CSR.                                               02700000
027100                                                                  02710000
027200     EXEC SQL                                                     02720000
027300          FETCH PO-CSR                                            02730000
027400           INTO :PURCHS-PO-NBR                                    02740000
027500              , :PURCHS-DEPT-NBR                                  02750000
027600     END-EXEC.                                                    02760000
027700                                                                  02770000
027800     EVALUATE TRUE                                                02780000
027900       WHEN SQLCODE = ZERO                                        02790000
028000            ADD +1  TO PV-RECORDS-FETCHED                         02800000
028100            PERFORM 2200-PROCESS-DC-CURSOR                        02810000
028200       WHEN SQLCODE = +100                                        02820000
028300           SET PS-END-OF-CURSOR      TO TRUE                      02830000
028400                                                                  02840000
028500       WHEN SQLWARN0 NOT EQUAL SPACE                              02850000
028600       WHEN SQLCODE NOT EQUAL ZERO                                02860000
028700           MOVE '2100-FETCH-PO-CSR'                               02870000
028800                                     TO PV-ABEND-PARAGRAPH        02880000
028900           MOVE 'FETCH PO CURSOR ROW'                             02890000
029000                                     TO PV-DB2-OPERATION-MESSAGE-102900000
029100           STRING PV-FROM-TIMESTAMP '-'                           02910000
029200                  PV-TO-TIMESTAMP       DELIMITED BY SIZE         02920000
029300                                   INTO PV-DB2-OPERATION-MESSAGE-202930000
029400           MOVE 'TPURCHS'            TO PV-ABEND-TABLE-1          02940000
029500           MOVE 'WST_ATTR'           TO PV-ABEND-TABLE-2          02950000
029600           PERFORM 9100-SQL-ABEND                                 02960000
029700     END-EVALUATE.                                                02970000
029800                                                                  02980000
029900                                                                  02990000
030000******************************************************************03000000
030100 2200-PROCESS-DC-CURSOR.                                          03010000
030200     SET PS-NOT-END-OF-DC-CURSOR TO TRUE.                         03020000
030300                                                                  03030000
030400     PERFORM 3000-OPEN-DC-CSR.                                    03040000
030500                                                                  03050000
030600     PERFORM 3200-FETCH-DC-CSR                                    03060000
030700              UNTIL PS-END-OF-DC-CURSOR                           03070000
030800                                                                  03080000
030900     PERFORM 3500-CLOSE-DC-CSR.                                   03090000
031000******************************************************************03100000
031100*---------------------------------------------------------------* 03110000
031200* CLOSE THE CONVEYOR VENDOR CURSOR                                03120000
031300*---------------------------------------------------------------* 03130000
031400 2800-CLOSE-PO-CSR.                                               03140000
031500                                                                  03150000
031600         EXEC SQL                                                 03160000
031700             CLOSE PO-CSR                                         03170000
031800         END-EXEC                                                 03180000
031900                                                                  03190000
032000         EVALUATE TRUE                                            03200000
032100             WHEN SQLCODE = +0                                    03210000
032200             WHEN SQLCODE = -904                                  03220000
032300             WHEN SQLCODE = -911                                  03230000
032400             WHEN SQLCODE = -913                                  03240000
032500                 CONTINUE                                         03250000
032600             WHEN SQLWARN0 NOT EQUAL SPACE                        03260000
032700             WHEN SQLCODE NOT EQUAL ZERO                          03270000
032800                 MOVE '2800-CLOSE-PO-CSR'                         03280000
032900                                      TO PV-ABEND-PARAGRAPH       03290000
033000                 MOVE 'ERROR CLOSING ASN CURSOR'                  03300000
033100                                  TO PV-DB2-OPERATION-MESSAGE-1   03310000
033200                 STRING PV-FROM-TIMESTAMP '-'                     03320000
033300                        PV-TO-TIMESTAMP  DELIMITED BY SIZE        03330000
033400                              INTO PV-DB2-OPERATION-MESSAGE-2     03340000
033500                 MOVE 'TPURCHS'       TO PV-ABEND-TABLE-1         03350000
033600                 MOVE 'WST_ATTR'      TO PV-ABEND-TABLE-2         03360000
033700                 PERFORM 9100-SQL-ABEND                           03370000
033800         END-EVALUATE.                                            03380000
033900                                                                  03390000
034000*---------------------------------------------------------------* 03400000
034100* OPEN PO CURSOR                                                  03410000
034200*---------------------------------------------------------------* 03420000
034300 3000-OPEN-DC-CSR.                                                03430000
034400                                                                  03440000
034500         EXEC SQL                                                 03450000
034600              OPEN DC-CSR                                         03460000
034700         END-EXEC                                                 03470000
034800                                                                  03480000
034900         EVALUATE TRUE                                            03490000
035000             WHEN SQLCODE = +0                                    03500000
035100             WHEN SQLCODE = -904                                  03510000
035200             WHEN SQLCODE = -911                                  03520000
035300             WHEN SQLCODE = -913                                  03530000
035400                 CONTINUE                                         03540000
035500             WHEN SQLWARN0 NOT EQUAL SPACE                        03550000
035600             WHEN SQLCODE NOT EQUAL ZERO                          03560000
035700                 MOVE '3000-OPEN-DC-CSR'                          03570000
035800                                      TO PV-ABEND-PARAGRAPH       03580000
035900                 MOVE 'ERROR OPENING DC CURSOR'                   03590000
036000                                TO PV-DB2-OPERATION-MESSAGE-1     03600000
036100                 MOVE PURCHS-PO-NBR  TO PV-PO-NBR-DISP            03610000
036200                 STRING 'PO NUMBER' '-' PV-PO-NBR-DISP            03620000
036300                  DELIMITED BY SIZE                               03630000
036400                            INTO PV-DB2-OPERATION-MESSAGE-2       03640000
036500                 MOVE 'TPURCHS'       TO PV-ABEND-TABLE-1         03650000
036600                 PERFORM 9100-SQL-ABEND                           03660000
036700         END-EVALUATE.                                            03670000
036800                                                                  03680000
036900                                                                  03690000
037000*---------------------------------------------------------------* 03700000
037100* FETCH A ROW FROM THE DC CURSOR.                               * 03710000
037200*---------------------------------------------------------------* 03720000
037300 3200-FETCH-DC-CSR.                                               03730000
037400                                                                  03740000
037500     EXEC SQL                                                     03750000
037600          FETCH DC-CSR                                            03760000
037700           INTO :ALLPLN-PO-NBR                                    03770000
037800              , :ALLPLN-DEST-NBR                                  03780000
037900     END-EXEC.                                                    03790000
038000                                                                  03800000
038100     EVALUATE TRUE                                                03810000
038200       WHEN SQLCODE = ZERO                                        03820000
038300            PERFORM 3400-PROCESS-DC-RECORDS                       03830000
038400       WHEN SQLCODE = +100                                        03840000
038500           SET PS-END-OF-DC-CURSOR   TO TRUE                      03850000
038600                                                                  03860000
038700       WHEN SQLWARN0 NOT EQUAL SPACE                              03870000
038800       WHEN SQLCODE NOT EQUAL ZERO                                03880000
038900           MOVE '3200-FETCH-DC-CSR'                               03890000
039000                                     TO PV-ABEND-PARAGRAPH        03900000
039100           MOVE 'FETCH PO CURSOR ROW'                             03910000
039200                                     TO PV-DB2-OPERATION-MESSAGE-103920000
039300           MOVE PURCHS-PO-NBR  TO PV-PO-NBR-DISP                  03930000
039400                 STRING 'PO NUMBER' '-' PV-PO-NBR-DISP            03940000
039500                 DELIMITED BY SIZE                                03950000
039600                            INTO PV-DB2-OPERATION-MESSAGE-2       03960000
039700           MOVE 'TPURCHS'            TO PV-ABEND-TABLE-1          03970000
039800           PERFORM 9100-SQL-ABEND                                 03980000
039900     END-EVALUATE.                                                03990000
040000                                                                  04000000
040100                                                                  04010000
040200******************************************************************04020000
040300 3400-PROCESS-DC-RECORDS.                                         04030000
040400      PERFORM 3450-SELECT-VNDR-PO.                                04040000
040500                                                                  04050000
040600      INITIALIZE RC103-ASN-SKU-SORT-REC.                          04060000
040700      MOVE ALLPLN-PO-NBR      TO RC103-KOHLS-ORD-NBR.             04070000
040800      MOVE INSTCD-INSTR-DESC(1:10)  TO PV-VENDOR-PO               04080000
040900      MOVE PV-VENDOR-PO             TO RC103-VEND-ORD-NBR.        04090000
041000      MOVE ALLPLN-DEST-NBR          TO RC103-DC-NBR.              04100000
041100      MOVE PURCHS-DEPT-NBR          TO RC103-DEPT-NBR.            04110000
041200                                                                  04120000
041300      PERFORM 8000-WRITE-SKU-SORT-RECORD.                         04130000
041400                                                                  04140000
041500 3450-SELECT-VNDR-PO.                                             04150000
041600                                                                  04160000
041700     EXEC SQL                                                     04170000
041800          SELECT RTRIM(SUBSTR(INSTR_DESC,13,10))                  04180000
041900            INTO :INSTCD-INSTR-DESC                               04190000
042000            FROM TINSTCD A                                        04200000
042100          ,      TPOINST B                                        04210000
042200          WHERE UPPER(A.INSTR_DESC) LIKE 'SEPHORA PO #%'          04220000
042300          AND B.INSTR_NBR = A.INSTR_NBR                           04230000
042400          AND B.RECIP_CDE = 'VN'                                  04240000
042500          AND B.PO_NBR = :ALLPLN-PO-NBR                           04250000
042600     END-EXEC                                                     04260000
042700                                                                  04270000
042800     EVALUATE TRUE                                                04280000
042900         WHEN SQLCODE = ZERO                                      04290000
043000             CONTINUE                                             04300000
043100         WHEN SQLCODE = +100                                      04310000
043200             MOVE SPACES TO INSTCD-INSTR-DESC                     04320000
043300         WHEN OTHER                                               04330000
043400             MOVE  SQLCODE         TO PV-DISPLAY-SQLCODE          04340000
043500             MOVE  '3450-SELECT-VNDR-PO '                         04350000
043600                                   TO PV-ABEND-PARAGRAPH          04360000
043700             MOVE 'SELECT OF VENDOR PO '                          04370000
043800                                   TO PV-ABEND-OPERATION          04380000
043900             MOVE 'CHECKING VENDOR PO FROM TINSTCD '              04390000
044000                                   TO PV-DB2-OPERATION-MESSAGE-1  04400000
044100             MOVE 'TINSTCD'        TO PV-ABEND-TABLE-1            04410000
044200             MOVE 'TPOINST'        TO PV-ABEND-TABLE-2            04420000
044300             PERFORM 9100-SQL-ABEND                               04430000
044400     END-EVALUATE.                                                04440000
044500*---------------------------------------------------------------* 04450000
044600* CLOSE THE DC CURSOR                                             04460000
044700*---------------------------------------------------------------* 04470000
044800 3500-CLOSE-DC-CSR.                                               04480000
044900                                                                  04490000
045000         EXEC SQL                                                 04500000
045100             CLOSE DC-CSR                                         04510000
045200         END-EXEC                                                 04520000
045300                                                                  04530000
045400         EVALUATE TRUE                                            04540000
045500             WHEN SQLCODE = +0                                    04550000
045600             WHEN SQLCODE = -904                                  04560000
045700             WHEN SQLCODE = -911                                  04570000
045800             WHEN SQLCODE = -913                                  04580000
045900                 CONTINUE                                         04590000
046000             WHEN SQLWARN0 NOT EQUAL SPACE                        04600000
046100             WHEN SQLCODE NOT EQUAL ZERO                          04610000
046200                 MOVE '3500-CLOSE-DC-CSR'                         04620000
046300                                      TO PV-ABEND-PARAGRAPH       04630000
046400                 MOVE 'ERROR CLOSING DC CURSOR'                   04640000
046500                                  TO PV-DB2-OPERATION-MESSAGE-1   04650000
046600                 MOVE PURCHS-PO-NBR  TO PV-PO-NBR-DISP            04660000
046700                 STRING 'PO NUMBER' '-' PV-PO-NBR-DISP            04670000
046800                 DELIMITED BY SIZE                                04680000
046900                            INTO PV-DB2-OPERATION-MESSAGE-2       04690000
047000                 MOVE 'TPURCHS'       TO PV-ABEND-TABLE-1         04700000
047100                 PERFORM 9100-SQL-ABEND                           04710000
047200         END-EVALUATE.                                            04720000
047300                                                                  04730000
047400******************************************************************04740000
047500*  WRITE ASN SKU SORT OUTPUT FILE.                                04750000
047600******************************************************************04760000
047700 8000-WRITE-SKU-SORT-RECORD.                                      04770000
047800                                                                  04780000
047900     WRITE SKU-SORT-RECORD-OUT                                    04790000
048000      FROM RC103-ASN-SKU-SORT-REC.                                04800000
048100                                                                  04810000
048200     ADD +1 TO PV-TOTAL-WRITE-COUNT.                              04820000
048300                                                                  04830000
048400                                                                  04840000
048500******************************************************************04850000
048600*  CLOSE OUTPUT FILES.  DISPLAY COUNTS.                           04860000
048700******************************************************************04870000
048800 9000-EOJ-ROUTINE.                                                04880000
048900     CLOSE TIMESTAMP-FILE                                         04890000
049000           SKU-SORT-FILE-OUT.                                     04900000
049100                                                                  04910000
049200     DISPLAY 'BEGIN TIMESTAMP '  PV-FROM-TIMESTAMP                04920000
049300     DISPLAY 'END TIMESTAMP   '  PV-TO-TIMESTAMP                  04930000
049400                                                                  04940000
049500     DISPLAY '                         '.                         04950000
049600     MOVE PV-TOTAL-WRITE-COUNT         TO  PV-DISPLAY-COUNT.      04960000
049700     DISPLAY 'TOTAL RECORDS WRITTEN..: '   PV-DISPLAY-COUNT.      04970000
049800     DISPLAY '                       '.                           04980000
049900     DISPLAY '*****  RCKUT173 ENDED  *****'.                      04990000
050000                                                                  05000000
050100                                                                  05010000
050200******************************************************************05020000
050300*  FORMAT DB2 ABEND MESSAGES AND ABEND.                           05030000
050400******************************************************************05040000
050500 9100-SQL-ABEND.                                                  05050000
050600                                                                  05060000
050700     DISPLAY '*** DB2 ERROR '.                                    05070000
050800     DISPLAY '*** SQLCODE   = ' PV-DISPLAY-SQLCODE                05080000
050900     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM                  05090000
051000     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               05100000
051100     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               05110000
051200     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       05120000
051300     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.       05130000
051400     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-3.       05140000
051500     DISPLAY '*** TABLE 1   = ' PV-ABEND-TABLE-1                  05150000
051600     DISPLAY '*** TABLE 2   = ' PV-ABEND-TABLE-2                  05160000
051700                                                                  05170000
051800     COPY DPPD004.                                                05180000
051900                                                                  05190000
052000     MOVE +4013                  TO PV-ABEND-CODE.                05200000
052100     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         05210000
052200                                                                  05220000
