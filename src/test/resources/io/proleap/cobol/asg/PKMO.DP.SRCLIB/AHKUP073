000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400                                                                  00040000
000500 PROGRAM-ID.    AHKUP073.                                         00050000
000600 AUTHOR.        DENISE HAHN.                                      00060000
000700 INSTALLATION.  KOHLS.                                            00070000
000800 DATE-WRITTEN   APRIL, 2020.                                      00080000
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100******************************************************************00110000
001200*  THIS PROGRAM DELETES ALL ROWS FROM RCT_RECDIS_ORIG TABLE FROM *00120000
001300*  ALL RECORDS FOUND IN THE EXTRACT FILE.  THE EXTRACT FILE IS   *00130000
001400*  CREATED BY AHKUT073.                                          *00140000
001500******************************************************************00150000
001600                                                                  00160000
001700******************************************************************00170000
001800 ENVIRONMENT DIVISION.                                            00180000
001900******************************************************************00190000
002000                                                                  00200000
002100 CONFIGURATION SECTION.                                           00210000
002200                                                                  00220000
002300 SOURCE-COMPUTER.        IBM-3090.                                00230000
002400 OBJECT-COMPUTER.        IBM-3090.                                00240000
002500                                                                  00250000
002600 INPUT-OUTPUT SECTION.                                            00260000
002700                                                                  00270000
002800 FILE-CONTROL.                                                    00280000
002900                                                                  00290000
003000     SELECT RCT00013-FILE                                         00300000
003100         ASSIGN TO INP01.                                         00310000
003200                                                                  00320000
003300******************************************************************00330000
003400 DATA DIVISION.                                                   00340000
003500******************************************************************00350000
003600                                                                  00360000
003700 FILE SECTION.                                                    00370000
003800                                                                  00380000
003900 FD  RCT00013-FILE                                                00390000
004000     RECORDING MODE IS F                                          00400000
004100     LABEL RECORDS ARE STANDARD                                   00410000
004200     BLOCK CONTAINS 0 RECORDS.                                    00420000
004300                                                                  00430000
004400 01  RCT00013-RECORD            PIC  X(50).                       00440001
004500                                                                  00450000
004600                                                                  00460000
004700******************************************************************00470000
004800 WORKING-STORAGE SECTION.                                         00480000
004900******************************************************************00490000
005000                                                                  00500000
005100                                                                  00510000
005200******************************************************************00520000
005300** DB2 FORMATTED MESSAGE AREA                                   **00530000
005400******************************************************************00540000
005500     COPY DPWS004.                                                00550000
005600                                                                  00560000
005700                                                                  00570000
005800******************************************************************00580000
005900** COMMUNICATIONS AREA FOR DB2                                  **00590000
006000******************************************************************00600000
006100     EXEC SQL                                                     00610000
006200          INCLUDE SQLCA                                           00620000
006300     END-EXEC.                                                    00630000
006400                                                                  00640000
006500                                                                  00650000
006600******************************************************************00660000
006700** RCT_RECDIS_ORIG                                              **00670000
006800******************************************************************00680000
006900     EXEC SQL                                                     00690000
007000          INCLUDE RCT00013                                        00700000
007100     END-EXEC.                                                    00710000
007200                                                                  00720000
007300                                                                  00730000
007400 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00740000
007500                                                   COMP SYNC.     00750000
007600                                                                  00760000
007700 01  PS-PROGRAM-SWITCHES.                                         00770000
007800     05  PS-EOF-RCT00013-FILE-SW     PIC  X(01)    VALUE 'N'.     00780000
007900         88  PS-EOF-RCT00013-FILE                  VALUE 'Y'.     00790000
008000         88  PS-NOT-EOF-RCT00013-FILE              VALUE 'N'.     00800000
008100                                                                  00810000
008200                                                                  00820000
008300 01  PC-PROGRAM-CONSTANTS.                                        00830000
008400     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00840000
008500         'AHKUP073'.                                              00850000
008600     05  PC-MAX-RETRIES              PIC S9(04)    VALUE +3       00860000
008700                                                   COMP SYNC.     00870000
008800                                                                  00880000
008900 01  PV-PROGRAM-VARIABLES.                                        00890000
009000     05  PV-SQLERRD3                 PIC S9(09)    VALUE ZERO     00900000
009100                                                   COMP-3.        00910000
009200     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  00920000
009300     05  PV-DB2-TABLE-NAME-1         PIC  X(30)    VALUE SPACES.  00930000
009400     05  PV-DB2-TABLE-NAME-2         PIC  X(30)    VALUE SPACES.  00940000
009500     05  PV-DB2-OPERATION-MESSAGE    PIC  X(50)    VALUE SPACES.  00950000
009600     05  PV-RETRY-COUNTER            PIC S9(04)    VALUE ZERO     00960000
009700                                                   COMP SYNC.     00970000
009800     05  PV-INPUT-COUNTER            PIC S9(09)    VALUE ZERO     00980005
009900                                                   COMP-3.        00990000
010000     05  PV-DELETE-COUNTER           PIC S9(09)    VALUE ZERO     01000005
010100                                                   COMP-3.        01010000
010200     05  PV-COMMIT-COUNTER           PIC S9(09)    VALUE ZERO     01020005
010300                                                   COMP-3.        01030000
010400     05  PV-COMMIT-COUNT             PIC S9(09)    VALUE ZERO     01040005
010500                                                   COMP-3.        01050000
010600     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             01060000
010700                                                                  01070000
010800     05  PV-DB2-COUNT                PIC S9(09)    VALUE ZERO     01080000
010900                                                   COMP-3.        01090000
011000     05  PV-OPER-UNT-ID              PIC 9(04)     VALUE ZERO.    01100000
011100     05  PV-RECV-SEQ-NBR             PIC 9(03)     VALUE ZERO.    01110000
011200     05  PV-PO-NBR                   PIC S9(08)    VALUE ZERO.    01120000
011300     05  PV-PO-LNE-NBR               PIC 9(03)     VALUE ZERO.    01130000
011400     05  PV-CURRENT-TIMESTAMP        PIC X(26)     VALUE SPACES.  01140000
011500     05  PV-COMMIT-TIME-AND-RCVR.                                 01150000
011600         10  FILLER                  PIC X(15)     VALUE          01160000
011700         'RECEIVER/LINE: '.                                       01170000
011800         10  PV-COMMIT-ORD-NBR       PIC 9(08)     VALUE ZEROS.   01180000
011900         10  FILLER                  PIC X(01)     VALUE '-'.     01190000
012000         10  PV-COMMIT-SEQ-NBR       PIC 9(04)     VALUE ZEROS.   01200000
012100         10  FILLER                  PIC X(01)     VALUE '-'.     01210000
012200         10  PV-COMMIT-LINE-NBR      PIC 9(04)     VALUE ZEROS.   01220000
012300         10  FILLER                  PIC X(20)     VALUE          01230000
012400         '      COMMIT COUNT: '.                                  01240000
012500         10  PV-RCT00013-DELETED     PIC ZZZ,ZZZ,ZZZ.             01250000
012600     05  PV-COMMIT-COUNTS.                                        01260000
012700         10  FILLER                  PIC X(25)     VALUE          01270003
012800         'RCT_RECDIS_ORIG DELETED: '.                             01280000
012900         10  PV-RCT00013-ROWS-DEL    PIC ZZZ,ZZZ,ZZ9.             01290005
013000                                                                  01300000
013100                                                                  01310000
013200******************************************************************01320000
013300 PROCEDURE DIVISION.                                              01330000
013400******************************************************************01340000
013500                                                                  01350000
013600******************************************************************01360000
013700* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     01370000
013800*      PROGRAM.                                                   01380000
013900******************************************************************01390000
014000 0000-PROGRAM-MAINLINE.                                           01400000
014100                                                                  01410000
014200     PERFORM 1000-INITIALIZE.                                     01420000
014300                                                                  01430000
014400     SET PS-NOT-EOF-RCT00013-FILE TO TRUE.                        01440000
014500     PERFORM 7000-READ-RCT00013-FILE.                             01450000
014600                                                                  01460000
014700     PERFORM 2000-PROCESS-RCT00013-RECORDS                        01470000
014800        UNTIL PS-EOF-RCT00013-FILE.                               01480000
014900                                                                  01490000
015000     CLOSE RCT00013-FILE.                                         01500000
015100                                                                  01510000
015200     MOVE PV-INPUT-COUNTER TO PV-DISPLAY-COUNT.                   01520000
015300     DISPLAY 'TOTAL RCT00013 ROWS READ...: ' PV-DISPLAY-COUNT.    01530000
015400                                                                  01540000
015500     MOVE PV-DELETE-COUNTER TO PV-DISPLAY-COUNT.                  01550000
015600     DISPLAY 'TOTAL RCT00013 ROWS DELETED: ' PV-DISPLAY-COUNT.    01560000
015700                                                                  01570000
015800     MOVE PV-COMMIT-COUNT        TO PV-DISPLAY-COUNT.             01580000
015900     DISPLAY 'TOTAL COMMITS TAKEN: ' PV-DISPLAY-COUNT.            01590000
016000                                                                  01600000
016100     STOP RUN.                                                    01610000
016200                                                                  01620000
016300                                                                  01630000
016400******************************************************************01640000
016500*                                                                 01650000
016600******************************************************************01660000
016700 1000-INITIALIZE.                                                 01670000
016800                                                                  01680000
016900     INITIALIZE PV-INPUT-COUNTER                                  01690000
017000                PV-DELETE-COUNTER                                 01700000
017100                PV-COMMIT-COUNTER                                 01710000
017200                PV-COMMIT-COUNT.                                  01720000
017300                                                                  01730000
017400     OPEN INPUT RCT00013-FILE.                                    01740000
017500                                                                  01750000
017600                                                                  01760000
017700******************************************************************01770000
017800*  PROCESS THE RCT_RECDIS_ORIG ROWS THAT ARE IN THE EXTRACT FILE. 01780000
017900*  DELETE THE ROW FROM THE RCT_RECDIS_ORIG TABLE.                 01790000
018000******************************************************************01800000
018100 2000-PROCESS-RCT00013-RECORDS.                                   01810000
018200                                                                  01820000
018300     ADD +1 TO PV-INPUT-COUNTER.                                  01830000
018400                                                                  01840000
018500     PERFORM 2100-DELETE-RCT00013.                                01850000
018600                                                                  01860000
018700     IF PV-COMMIT-COUNTER   > 1000                                01870000
018800         PERFORM 2200-COMMIT-CHANGES                              01880000
018900         MOVE 0     TO PV-COMMIT-COUNTER                          01890000
019000     END-IF.                                                      01900000
019100                                                                  01910000
019200     PERFORM 7000-READ-RCT00013-FILE.                             01920000
019300                                                                  01930000
019400                                                                  01940000
019500******************************************************************01950000
019600*  DELETE THE CURRENT ROW FROM THE RCT_RECDIS_ORIG TABLE.         01960000
019700*  IF THE RCT_RECDIS_ORIG ROW IS NOT FOUND, THAT IS OK.           01970000
019800*  THIS CONDITION HAPPENS, WE ARE IN A RESTART MODE AND THE       01980000
019900*  ROW WAS DELETED IN THE ORIGINAL RUN.                           01990000
020000******************************************************************02000000
020100 2100-DELETE-RCT00013.                                            02010000
020200                                                                  02020000
020300     PERFORM WITH TEST AFTER                                      02030000
020400       VARYING PV-RETRY-COUNTER FROM 1 BY 1                       02040000
020500         UNTIL (PV-RETRY-COUNTER > PC-MAX-RETRIES  OR             02050000
020600                SQLCODE = ZERO                     OR             02060000
020700                SQLCODE = +100)                                   02070000
020800                                                                  02080000
020900         EXEC SQL                                                 02090000
021000              DELETE FROM RCT_RECDIS_ORIG                         02100006
021100               WHERE ORD_NBR          = :RCT00013-ORD-NBR         02110000
021200                 AND ORD_LNE_NBR      = :RCT00013-ORD-LNE-NBR     02120000
021300                 AND REC_SEQ_NBR      = :RCT00013-REC-SEQ-NBR     02130000
021400                 AND OPER_UNT_ID      = :RCT00013-OPER-UNT-ID     02140000
021500                 AND FCLTY_ID         = :RCT00013-FCLTY-ID        02150000
021600                 AND STR_NBR          = :RCT00013-STR-NBR         02160002
021700                 AND STR_FCLTY_ID     = :RCT00013-STR-FCLTY-ID    02170002
021800         END-EXEC                                                 02180000
021900                                                                  02190000
022000         EVALUATE TRUE                                            02200000
022100             WHEN SQLCODE = ZERO                                  02210000
022200                  MOVE SQLERRD(3) TO PV-SQLERRD3                  02220000
022300                  ADD PV-SQLERRD3 TO PV-DELETE-COUNTER            02230000
022400                                     PV-COMMIT-COUNTER            02240000
022500             WHEN SQLCODE = +100                                  02250000
022600             WHEN SQLCODE = -904                                  02260000
022700             WHEN SQLCODE = -911                                  02270000
022800                 CONTINUE                                         02280000
022900             WHEN SQLWARN0 NOT = SPACES                           02290000
023000             WHEN SQLCODE < ZERO                                  02300000
023100             WHEN SQLCODE > ZERO                                  02310000
023200                 MOVE '2100-DELETE-RCT00013           '           02320000
023300                                      TO PV-PARAGRAPH-NAME        02330000
023400                 MOVE 'ERROR DELETING ROW FROM RCT00013 TABLE'    02340000
023500                                      TO PV-DB2-OPERATION-MESSAGE 02350000
023600                 MOVE 'RCT_RECDIS_ORIG' TO PV-DB2-TABLE-NAME-1    02360000
023700                 PERFORM 9100-SQL-ABEND                           02370000
023800         END-EVALUATE                                             02380000
023900     END-PERFORM.                                                 02390000
024000                                                                  02400000
024100     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         02410000
024200         MOVE '2100-DELETE-RCT00013          '                    02420000
024300                                 TO PV-PARAGRAPH-NAME             02430000
024400         MOVE '** DEADLOCK ENCOUNTERED ON THE DELETE **'          02440000
024500                                 TO PV-DB2-OPERATION-MESSAGE      02450000
024600         MOVE 'RCT_RECDIS_ORIG'  TO PV-DB2-TABLE-NAME-1           02460000
024700         PERFORM 9100-SQL-ABEND                                   02470000
024800     END-IF.                                                      02480000
024900                                                                  02490000
025000                                                                  02500000
025100******************************************************************02510000
025200*  COMMIT THE CHANGES                                             02520000
025300******************************************************************02530000
025400 2200-COMMIT-CHANGES.                                             02540000
025500                                                                  02550000
025600     EXEC SQL                                                     02560000
025700          COMMIT                                                  02570000
025800     END-EXEC.                                                    02580000
025900                                                                  02590000
026000     EVALUATE TRUE                                                02600000
026100         WHEN SQLCODE = ZERO                                      02610000
026200             ADD +1    TO PV-COMMIT-COUNT                         02620000
026300             MOVE RCT00013-ORD-NBR     TO PV-COMMIT-ORD-NBR       02630000
026400             MOVE RCT00013-ORD-LNE-NBR TO PV-COMMIT-SEQ-NBR       02640000
026500             MOVE RCT00013-REC-SEQ-NBR TO PV-COMMIT-LINE-NBR      02650000
026600             MOVE PV-DELETE-COUNTER    TO PV-RCT00013-DELETED     02660000
026700                                                                  02670000
026800             DISPLAY PV-COMMIT-TIME-AND-RCVR                      02680000
026900                                                                  02690000
027000         WHEN SQLWARN0 NOT = SPACES                               02700000
027100         WHEN SQLCODE < ZERO                                      02710000
027200         WHEN SQLCODE > ZERO                                      02720000
027300             MOVE '2200-COMMIT-CHANGES'                           02730000
027400                                 TO PV-PARAGRAPH-NAME             02740000
027500             MOVE 'ERROR ON COMMIT OF THE CHANGES'                02750000
027600                                 TO PV-DB2-OPERATION-MESSAGE      02760000
027700             MOVE 'RCT_RECDIS_ORIG' TO PV-DB2-TABLE-NAME-1        02770000
027800             PERFORM 9100-SQL-ABEND                               02780000
027900     END-EVALUATE.                                                02790000
028000                                                                  02800000
028100                                                                  02810000
028200******************************************************************02820000
028300*  READ A RECORD FROM THE RCT_RECDIS_ORIG FILE                    02830000
028400******************************************************************02840000
028500 7000-READ-RCT00013-FILE.                                         02850000
028600                                                                  02860000
028700     READ RCT00013-FILE                                           02870000
028800       INTO DCLRCT00013                                           02880000
028900           AT END                                                 02890000
029000               SET PS-EOF-RCT00013-FILE TO TRUE.                  02900000
029100                                                                  02910000
029200                                                                  02920000
029300 9100-SQL-ABEND.                                                  02930000
029400******************************************************************02940000
029500*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    02950000
029600*  ERROR OR WARNING CODE OCCURS.                                  02960000
029700******************************************************************02970000
029800     DISPLAY '9100-SQL-ABEND'.                                    02980000
029900     DISPLAY '** ABEND             **'.                           02990000
030000     DISPLAY '** PROGRAM           ** = '                         03000000
030100                                       PC-CURRENT-PROGRAM-NAME.   03010000
030200     DISPLAY '** PARAGRAPH         ** = '                         03020000
030300                                       PV-PARAGRAPH-NAME.         03030000
030400     DISPLAY '** TABLE(S) AFFECTED ** = '                         03040000
030500                                       PV-DB2-TABLE-NAME-1.       03050000
030600     DISPLAY '**                   ** = '                         03060000
030700                                       PV-DB2-TABLE-NAME-2.       03070000
030800     DISPLAY '** OPERATION         ** = '                         03080000
030900                                       PV-DB2-OPERATION-MESSAGE.  03090000
031000     DISPLAY '**                   ** = '                         03100000
031100     DISPLAY '** LAST COMMIT INFO  ** = '                         03110000
031200                                       PV-COMMIT-TIME-AND-RCVR.   03120000
031300     DISPLAY '**                   ** = '                         03130000
031400                                       PV-COMMIT-COUNTS.          03140000
031500                                                                  03150000
031600******************************************************************03160000
031700* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    03170000
031800* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         03180000
031900* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     03190000
032000* FORMAT.                                                         03200000
032100******************************************************************03210000
032200     COPY DPPD004.                                                03220000
032300                                                                  03230000
032400     EXEC SQL                                                     03240000
032500         ROLLBACK                                                 03250000
032600     END-EXEC.                                                    03260000
032700                                                                  03270000
032800     MOVE +4013                  TO ABEND-CODE.                   03280000
032900     CALL 'ILBOABN0' USING ABEND-CODE.                            03290000
