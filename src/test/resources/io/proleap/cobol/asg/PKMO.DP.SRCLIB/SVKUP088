      ***************************************************************** 00010005
       IDENTIFICATION DIVISION.                                         00020005
      ***************************************************************** 00030005
                                                                        00040005
       PROGRAM-ID.      SVKUP088.                                       00050045
       AUTHOR.          COGNIZANT.                                      00060036
       DATE-WRITTEN.    MARCH, 2015.                                    00070036
                                                                        00080005
      *---------------------------------------------------------------* 00090024
      * ***************GIFT CARD ACTIVATION PROGRAM******************** 00100036
      * 1) THIS PROGRAM READS AN INPUT FILE FROM ECOM WHICH HAS         00110036
      * GIFT CARD NUMBER, ORDER NUMBER AND AMOUNT.                      00120036
      * 2) FOR THE GIVEN RECORD, READ TEPORD TABLE TO COLLECT RESPECTIVE00130036
      *    TRANSACTION LEVEL DETAILS.                                   00140036
      * 3) CHECK WHETHER THE TRANSACTION DETAIL IS AVAILABL IN          00150036
      *    SVT_KOHLS_CRD_TXN TABLE OR NOT. IF IT IS NOT AVAILABLE,      00160036
      *    INSERT AN ENTRY TO THAT TABLE.                               00170036
      *     A) IF TRANS EXISTS - CARD WAS ALREADY ACTIVATED AND SKIP    00180036
      *        FROM PROCESSING.                                         00190036
      *     B) IF TRANS NOT EXISTS - NEED TO INSERT TO ACTIVATE THE CARD00200036
      *---------------------------------------------------------------* 00211036
       ENVIRONMENT DIVISION.                                            00440005
       CONFIGURATION SECTION.                                           00450005
                                                                        00460005
       SOURCE-COMPUTER. IBM-3090.                                       00470005
       OBJECT-COMPUTER. IBM-3090.                                       00480005
                                                                        00490005
       INPUT-OUTPUT SECTION.                                            00500005
       FILE-CONTROL.                                                    00510005
                                                                        00520005
           SELECT ECOM-INPUT-FILE                                       00530036
               ASSIGN TO INP01.                                         00540038
                                                                        00550005
       DATA DIVISION.                                                   00560005
                                                                        00570005
       FILE SECTION.                                                    00580005
                                                                        00590005
       FD  ECOM-INPUT-FILE                                              00600036
           RECORDING MODE IS F                                          00610005
           LABEL RECORDS ARE STANDARD                                   00620005
           BLOCK CONTAINS 0 RECORDS                                     00630039
           DATA RECORD IS SV068-ECOM-INPUT-RECORD.                      00640039
       01  SV068-ECOM-INPUT-RECORD    PIC X(80).                        00650038
                                                                        00660005
                                                                        00670005
       WORKING-STORAGE SECTION.                                         00680005
                                                                        00690005
       01  ABEND-CODE                  PIC S9(04)     VALUE +0  COMP.   00700005
                                                                        00710005
      ******************************************************************00860005
      *PV - PROGRAM VARIABLES                                           00870005
      ******************************************************************00880005
       01  PROGRAM-VARIABLES.                                           00890005
031200        10  PV-ORD-NBR                   PIC  9(10).              00890139
031200        10  PV-GIFT-CRD-NBR              PIC  9(12).              00891038
031200        10  PV-GC-AMOUNT                 PIC  9(03).              00893038
031200        10  PV-ST-CDE                    PIC  X(02).              00893138
031200        10  PV-READ-CNT                  PIC  9(04) VALUE 0.      00893238
031200        10  PV-CRD-DUP-CNT               PIC  9(04) VALUE 0.      00894038
031200        10  PV-CRD-INS-CNT               PIC  9(04) VALUE 0.      00894138
              10  PV-PARAGRAPH-NAME            PIC  X(30) VALUE SPACE.  00894239
              10  PV-DB2-OPER-ATTEMPTED        PIC  X(30) VALUE SPACE.  00894339
              10  PV-DB2-CARD-NBR              PIC  9(12) VALUE ZEROES. 00894439
              10  PV-CURRENT-DATE              PIC   X(10).             00894539
              10  PV-CURRENT-TMST              PIC   X(26).             00894639
                                                                        00900037
000700 01  ECOM-INPUT-RECORD.                                           01051039
002300     05  SV068-ORD-NBR                    PIC  9(10).             01052039
002300     05  SV068-GIFT-CRD-NBR               PIC  9(12).             01052138
004100     05  SV068-GC-AMOUNT                  PIC  9(03).             01053038
004100     05  SV068-ST-CDE                     PIC  X(02).             01054038
           05  FILLER                           PIC  X(53) VALUE SPACES.01060039
                                                                        01061038
      ******************************************************************01061138
      *PS - PROGRAM CONSTANTS                                           01061238
      ******************************************************************01061338
010300 01  PC-PROGRAM-CONSTANTS.                                        01062038
010400     05  PC-PROGRAM-NAME          PIC  X(08)    VALUE 'SVKUP088'. 01063045
      ******************************************************************01070005
      *PS - PROGRAM SWITCHES                                            01080005
      ******************************************************************01090005
       01  PROGRAM-SWITCHES.                                            01100005
019200     05  PS-CARD-SWITCH           PIC  X(01) VALUE 'N'.           01110038
               88  PS-CARD-FOUND                   VALUE 'Y'.           01121038
               88  PS-CARD-NOT-FOUND               VALUE 'N'.           01130037
019200     05  PS-END-OF-INPUT-SW          PIC  X(01) VALUE 'N'.        01140038
019300         88  PS-END-OF-INPUT                    VALUE 'Y'.        01150038
       01  AC-ABEND-CODE                      PIC S9(04) VALUE ZERO     01180005
                                                        COMP SYNC.      01190005
           88  AC-CONTROL-CARD-ERROR                    VALUE +4003.    01200005
           88  AC-DB2-ERROR                             VALUE +4013.    01210005
           88  AC-CALENDAR-ROUTINE-ERROR                VALUE +4019.    01220005
           88  AC-TOTALS-ERROR                          VALUE +4020.    01230005
                                                                        01240005
      *----------------------------------------------------------------*01320005
      *    STANDARD DB2 ERROR HANDLING AREA                            *01330005
      *----------------------------------------------------------------*01340005
           COPY DPWS004.                                                01350005
                                                                        01360005
      *----------------------------------------------------------------*01370005
      *  DCLGEN FOR SVT_KOHLS_CRD_ACCT                                 *01380005
      *----------------------------------------------------------------*01390005
           EXEC SQL                                                     01400005
               INCLUDE SVT00001                                         01410005
           END-EXEC.                                                    01420005
                                                                        01430005
      *----------------------------------------------------------------*01440005
      *  DCLGEN FOR SVT_KOHLS_CRD_TXN                                  *01450005
      *----------------------------------------------------------------*01460005
           EXEC SQL                                                     01470005
               INCLUDE SVT00002                                         01480005
           END-EXEC.                                                    01490005
                                                                        01500005
                                                                        01570008
      ******************************************************************01580005
      *  SQL COMMUNICATIONS WORK AREA                                  *01590005
      ******************************************************************01600005
           COPY SQLCA2.                                                 01610005
                                                                        01620005
                                                                        01630005
      *----------------------------------------------------------------*01640005
      *    STANDARD DB2 COMMUNICATIONS AREA                            *01650005
      *----------------------------------------------------------------*01660005
           EXEC SQL                                                     01670005
               INCLUDE SQLCA                                            01680005
           END-EXEC.                                                    01690005
                                                                        01700005
      *---------------------------------------------------------------* 01710005
      *  LAYOUT FOR INPUT FILE                                          01720005
      *---------------------------------------------------------------* 01730005
           COPY SVRD068.                                                01740046
      *---------------------------------------------------------------* 02030005
       PROCEDURE DIVISION.                                              02040005
      *---------------------------------------------------------------* 02050005
                                                                        02060005
       A100-MAINLINE.                                                   02070005
                                                                        02080005
           PERFORM B100-INITIALIZE.                                     02090005
                                                                        02100005
           PERFORM B200-PROCESS-ECOM-ISSUE-REC UNTIL PS-END-OF-INPUT.   02110039
                                                                        02130005
           PERFORM B300-EOJ-ROUTINE.                                    02140005
                                                                        02150005
           GOBACK.                                                      02160005
                                                                        02170005
      ******************************************************************02180005
      *     B100-INITIALIZE                                            *02190005
      * - OPEN THE INPUT RECORD                                         02200045
      ******************************************************************02220005
       B100-INITIALIZE.                                                 02230005
                                                                        02240005
           OPEN INPUT  ECOM-INPUT-FILE.                                 02260038
                                                                        02290005
           PERFORM B110-READ-ECOM-INPUT.                                02291038
                                                                        02292038
      ******************************************************************02293038
       B110-READ-ECOM-INPUT.                                            02294038
      ******************************************************************02294141
                                                                        02295038
           READ ECOM-INPUT-FILE                                         02296038
                                INTO ECOM-INPUT-RECORD                  02297039
               AT END                                                   02298038
                   SET PS-END-OF-INPUT         TO TRUE.                 02299038
                                                                        02299138
           IF PS-END-OF-INPUT                                           02299238
             CONTINUE                                                   02299338
             DISPLAY 'FILE END'                                         02299438
           ELSE                                                         02299538
             ADD +1 TO PV-READ-CNT                                      02299638
             DISPLAY 'ECOM-INPUT-RECORD=' ECOM-INPUT-RECORD             02299740
           END-IF.                                                      02299838
      ******************************************************************02300005
      *     B200-PROCESS-ECOM-RECORDS                                *  02310038
      * - PROCESS ALL INPUT RECORDS UNTIL END OF FILE                  *02320006
      ******************************************************************02340005
       B200-PROCESS-ECOM-ISSUE-REC.                                     02350037
                                                                        02370038
           MOVE SV068-GIFT-CRD-NBR   TO SVT00002-CRD-NBR.               02371139
                                                                        02371239
           PERFORM C100-CHECK-FOR-DUP.                                  02390039
                                                                        02400005
   ******************************************************************** 02400138
   *** C100-CHECK-FOR-DUP.                                              02401041
   ******************************************************************** 02401138
           MOVE 'C100-CHECK-FOR-DUP'  TO PV-PARAGRAPH-NAME.             02401239
                                                                        02402039
150000     EXEC SQL                                                     02402139
150100         SELECT  CRD_NBR                                          02403039
150200           INTO  :SVT00002-CRD-NBR                                02404039
150300           FROM  SVT_KOHLS_CRD_TXN                                02405037
150400          WHERE  CRD_NBR          = :SVT00002-CRD-NBR             02406039
151300     END-EXEC                                                     02409639
151400                                                                  02409737
151500     EVALUATE TRUE                                                02409837
151600         WHEN SQLCODE = 0 OR -811                                 02409937
071900               SET PS-CARD-FOUND TO TRUE                          02410237
                     ADD +1 TO PV-CRD-DUP-CNT                           02410338
                     DISPLAY 'GIFT-CRD-NBR ALREADY EXIST='              02410439
                              SVT00002-CRD-NBR                          02410539
152600         WHEN SQLCODE = +100                                      02411537
071900               SET PS-CARD-NOT-FOUND TO TRUE                      02411638
152700               PERFORM C300-INSERT-ACT-ROW                        02412638
152800                                                                  02412738
152900         WHEN OTHER                                               02413037
028100                 PERFORM Z900-SQL-ABEND                           02413437
154300     END-EVALUATE.                                                02413537
                                                                        02413637
               PERFORM B110-READ-ECOM-INPUT.                            02413739
                                                                        02413838
    ******************************************************************  02413939
    *  C300-INSERT-ACT-ROW.                                             02420839
    ******************************************************************  02420939
                                                                        02421037
           EXEC SQL                                                     02421339
               SET :PV-CURRENT-DATE = CURRENT DATE                      02421439
           END-EXEC.                                                    02421539
                                                                        02421639
           EXEC SQL                                                     02421739
               SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 02421839
           END-EXEC.                                                    02421939
                                                                        02422039
044500        MOVE 873               TO SVT00002-STR-NBR                02422138
              MOVE 20                TO SVT00002-POS-TRMNL-NBR          02422238
              MOVE 1000              TO SVT00002-POS-TRN-NBR            02422338
              MOVE SV068-ORD-NBR     TO SVT00002-POS-OPRT-ID            02422439
              MOVE SV068-GIFT-CRD-NBR TO SVT00002-CRD-NBR               02422542
              MOVE PV-CURRENT-TMST   TO SVT00002-TRN-AUTH-TMST          02422639
              MOVE SV068-GC-AMOUNT   TO SVT00002-APP-AUTH-AMT           02422739
                                        SVT00002-ORIG-AUTH-AMT          02422838
              MOVE SV068-ST-CDE      TO SVT00002-ST-CDE                 02422939
                                                                        02423038
211200         MOVE SPACES              TO SVT00002-DRV-LIC-NBR         02423137
211200         MOVE SPACES              TO SVT00002-APVL-USR-ID         02423237
206700         MOVE PV-CURRENT-TMST     TO SVT00002-TRN-PSTD-TMST       02423339
206700         MOVE 2                   TO SVT00002-ACTVY-TYP-CDE.      02423437
211300         MOVE 'N'                 TO SVT00002-TRN-VOID-IND.       02423539
211300         MOVE 0                   TO SVT00002-TRN-RVRSL-CDE.      02423639
               MOVE 3                   TO SVT00002-ACTVY-STAT-CDE.     02423743
               MOVE PV-CURRENT-DATE     TO SVT00002-POS-DTE.            02423839
                                                                        02423939
                                                                        02424038
211500     EXEC SQL INSERT                                              02424138
211600              INTO SVT_KOHLS_CRD_TXN                              02424238
211700                  (CRD_NBR                                        02424338
211800                  ,DRV_LIC_NBR                                    02424438
211900                  ,TRN_RVRSL_CDE                                  02424538
212000                  ,TRN_VOID_IND                                   02424638
212100                  ,ACTVY_TYP_CDE                                  02424738
212200                  ,POS_DTE                                        02424838
212300                  ,STR_NBR                                        02424938
212400                  ,POS_TRMNL_NBR                                  02425038
212500                  ,POS_TRN_NBR                                    02425138
212600                  ,TRN_PSTD_TMST                                  02425238
212700                  ,APP_AUTH_AMT                                   02425338
212800                  ,POS_OPRT_ID                                    02425438
212900                  ,APVL_USR_ID                                    02425538
213000                  ,ACTVY_STAT_CDE                                 02425638
213100                  ,ORIG_AUTH_AMT                                  02425738
213200                  ,ST_CDE)                                        02425838
213300           VALUES                                                 02425938
213400              (:SVT00002-CRD-NBR                                  02426038
213500              ,:SVT00002-DRV-LIC-NBR                              02426138
213600              ,:SVT00002-TRN-RVRSL-CDE                            02426238
213700              ,:SVT00002-TRN-VOID-IND                             02426338
213800              ,:SVT00002-ACTVY-TYP-CDE                            02426438
213900              ,:SVT00002-POS-DTE                                  02426538
214000              ,:SVT00002-STR-NBR                                  02426638
214100              ,:SVT00002-POS-TRMNL-NBR                            02426738
214200              ,:SVT00002-POS-TRN-NBR                              02426838
214300              ,:SVT00002-TRN-PSTD-TMST                            02426938
214400              ,:SVT00002-APP-AUTH-AMT                             02427038
214500              ,:SVT00002-POS-OPRT-ID                              02427138
214600              ,:SVT00002-APVL-USR-ID                              02427238
214700              ,:SVT00002-ACTVY-STAT-CDE                           02427338
214800              ,:SVT00002-ORIG-AUTH-AMT                            02427438
214900              ,:SVT00002-ST-CDE)                                  02427538
215000      END-EXEC.                                                   02427638
215100                                                                  02427738
151500     EVALUATE TRUE                                                02427838
                                                                        02427938
151600         WHEN SQLCODE = 0                                         02428038
                    ADD +1 TO PV-CRD-INS-CNT                            02428138
044900         WHEN SQLCODE NOT EQUAL ZERO                              02428238
045000             MOVE 'C300-INSERT-ACT-ROW'                           02428338
045100                                            TO PV-PARAGRAPH-NAME  02428438
045500             DISPLAY 'ORDER NUMBER      : ' PV-ORD-NBR            02428537
045500             DISPLAY 'CARD  NUMBER      : ' PV-GIFT-CRD-NBR       02428638
                   DISPLAY  SQLCODE                                     02428744
028100             PERFORM Z900-SQL-ABEND                               02428838
             END-EVALUATE.                                              02428937
                                                                        02429037
      ******************************************************************06110005
      *   Z900-SQL-ABEND                                               *06120006
      ******************************************************************06130006
      * - ABEND THE PROGRAM IN THE EVENT THAT A SQL ERROR OR WARNING   *06140006
      *   CODE OCCURS.                                                 *06150006
      ******************************************************************06160005
       Z900-SQL-ABEND.                                                  06170005
                                                                        06180005
           DISPLAY '** ABEND     **'.                                   06190005
           DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                06200038
           DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              06210005
           DISPLAY '** OPERATION ** = ' PV-DB2-OPER-ATTEMPTED.          06220005
           DISPLAY '** CARD NBR  ** = ' PV-DB2-CARD-NBR.                06230005
                                                                        06240005
079000******************************************************************06241038
079100*     B500-EOJ-ROUTINE                                           *06242038
079200* ==> PROCESSES:                                                 *06243038
079300*     - CLOSES THE FILES.                                        *06244038
079400*     - DISPLAYS THE PROGRAM COUNTS TO SYSOUT.                   *06245038
079500* ==> PERFORMED FROM: A100-MAINLINE                              *06246038
079600******************************************************************06247038
079700 B300-EOJ-ROUTINE.                                                06248039
079800                                                                  06249038
080100     CLOSE ECOM-INPUT-FILE.                                       06249338
080800                                                                  06250038
080900     DISPLAY ' '.                                                 06251038
081000     DISPLAY 'PROGRAM NAME:' PC-PROGRAM-NAME.                     06252038
081000     DISPLAY 'INPUT FILE READ COUNT=' PV-READ-CNT.                06252139
081100     DISPLAY 'CARDS THAT ALREADY EXISTS IN SVT TXN COUNT='        06253038
081200               PV-CRD-DUP-CNT.                                    06254039
081300     DISPLAY 'CARD COUNTS THAT ARE INSERTED INTO SVT TXN='        06255038
081400               PV-CRD-INS-CNT.                                    06256039
081700     DISPLAY 'PROGRAM END'.                                       06259038
081900     DISPLAY ' '.                                                 06259238
