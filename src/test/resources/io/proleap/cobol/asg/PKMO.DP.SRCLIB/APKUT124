000100 IDENTIFICATION DIVISION.                                         00010002
000200 PROGRAM-ID.      APKUT124.                                       00020002
000300 AUTHOR.          NANCY EILBES.                                   00030002
000400 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00040002
000500 DATE-WRITTEN.    04/06/2004.                                     00050002
000600*----------------------------------------------------------------*00060002
000700*   CREATE TRANSACTIONS TO REVERSE EARNED POSTINGS FOR VENDOR    *00070017
000710*   ALLOWANCE AGREEMENTS.                                        *00071017
000800*   COBOL390 WITH DB2 SQL                                        *00080002
000900*----------------------------------------------------------------*00090002
001000*   THIS PROGRAM WILL READ AN EXTRACT FILE OF VENDOR AGREEMENT   *00100002
001100*   PURCHASE ACTIVITY AND GENERATE ADJUSTMENTS TO REVERSE THE    *00110017
001200*   POSTED EARNED AMOUNT.                                        *00120017
001300*                                                                *00130017
001400*   THE INPUT FILE WILL BE SORTED BY TRANCODE, YEAR, QUARTER,    *00140017
001500*   VENDOR.  THERE WILL BE MULTIPLE RECORDS FOR EACH OF THESE    *00150017
001510*   SORT KEYS.  WHEN THE TRANSACTIONS ARE CREATED, IF THE KEY    *00151017
001511*   FIELDS HAVE NOT CHANGED, THE SAME DOC NUMBER WILL BE ASSIGNED*00151117
001512*   SO THAT THE DETAILS WILL BE ROLLED UP UNDER ONE ADJUSTMENT   *00151217
001513*   BEFORE BEING LOADED INTO THE DATABASE.                       *00151317
001520*----------------------------------------------------------------*00152002
001530*                                                                *00153002
001540* DB2 TABLES:                                                    *00154002
001550*  1. ACCOUNTS PAYABLE CONTROL TABLE  (TAPCNTL TABLE)            *00155002
001560*  2. AP TRANCODE MASTER TABLE        (TTRNCDE TABLE)            *00156002
001570*  3. DATE ATTRIBUTE TABLE            (TDTATTR TABLE)            *00157002
001580*                                                                *00158002
001590* INPUT FILE:                                                    *00159002
001600*  1. VENDOR AGREEMENT ACTIVITY FILE  (COPYBOOK APRD081)         *00160002
001700*                                                                *00170002
001800* OUTPUT FILE:                                                   *00180002
001900*  1. ADJUSTMENT DETAILS              (COPYBOOK APRD045)         *00190002
002000*                                                                *00200002
002100*----------------------------------------------------------------*00210002
002200* CHANGE LOG:                                                    *00220002
002300*   DATE  04/06/2004                                             *00230003
002310*       CHANGE MADE: INITIAL VERSION.                            *00231002
002320*       MADE BY: NANCY EILBES            WR/IR #: WR26677        *00232002
002330*                                                                *00233002
002300*   DATE  02/21/2023                                             *00233124
002310*       CHANGE MADE: CHANGE CALL TO DPKUP151 FROM STATIC TO      *00233224
002310*                    DYNAMIC                                     *00233324
002320*       MADE BY: JEAN KURK               WR/IR #: CHG0282641     *00233424
002340*----------------------------------------------------------------*00234002
002350                                                                  00235002
002360 ENVIRONMENT DIVISION.                                            00236002
002370                                                                  00237002
002380 CONFIGURATION SECTION.                                           00238002
002390 SOURCE-COMPUTER. IBM-3090.                                       00239002
002400 OBJECT-COMPUTER. IBM-3090.                                       00240002
002500                                                                  00250002
002600 INPUT-OUTPUT SECTION.                                            00260002
002700 FILE-CONTROL.                                                    00270002
002800     SELECT VNDAGR-ACTVTY-FILE ASSIGN TO INP01.                   00280002
002900     SELECT ADJUST-JRNL-FILE ASSIGN TO OUT01.                     00290002
003000                                                                  00300002
003100 DATA DIVISION.                                                   00310002
003200                                                                  00320002
003300 FILE SECTION.                                                    00330002
003400                                                                  00340002
003500 FD  VNDAGR-ACTVTY-FILE                                           00350002
003600     RECORDING MODE IS F                                          00360002
003700     LABEL RECORDS ARE STANDARD                                   00370002
003800     BLOCK CONTAINS 0 RECORDS                                     00380002
003900     DATA RECORD IS INPUT-EXP-INV-RECORD.                         00390002
004000                                                                  00400002
004100 01  VNDAGR-ACTVTY-RECORD       PIC X(250).                       00410013
004200                                                                  00420002
004300 FD  ADJUST-JRNL-FILE                                             00430002
004400     RECORDING MODE F                                             00440002
004500     LABEL RECORDS ARE STANDARD                                   00450002
004600     DATA RECORD IS ADJUST-JRNL-RECORD.                           00460002
004700 01  ADJUST-JRNL-RECORD         PIC X(500).                       00470002
004800                                                                  00480002
004900                                                                  00490002
005000 WORKING-STORAGE SECTION.                                         00500002
005100                                                                  00510002
005200 01  CONTROL-CARD.                                                00520002
005300     05  CC-BEGIN-DTE            PIC X(10).                       00530002
005400     05  FILLER                  PIC X.                           00540002
005500     05  CC-END-DTE              PIC X(10).                       00550002
005600     05  FILLER                  PIC X(59).                       00560002
005700                                                                  00570002
005800 01  PV-PROGRAM-VARIABLES.                                        00580002
005900     05  PV-CURR-TMST               PIC X(26) VALUE SPACES.       00590002
006000     05  PV-ENTR-DTE                PIC X(10) VALUE SPACES.       00600002
006010     05  SAVE-VENDOR-NBR            PIC X(09) VALUE SPACES.       00601020
006100     05  SAVE-AP-TRN-CDE            PIC X(02) VALUE SPACES.       00610002
006120     05  MATCH-AP-TRN-CDE           PIC X(02) VALUE SPACES.       00612003
006121     05  WS-RVRS-TRN-CDE            PIC X(02) VALUE SPACES.       00612103
006210     05  PV-CAL-QTR-NBR             PIC X.                        00621016
006211     05  PV-CAL-HALF-NBR            PIC X.                        00621116
006212     05  PV-FISC-HALF-NBR           PIC X.                        00621216
006220     05  PV-CAL-YR-NBR              PIC X(4).                     00622016
006300                                                                  00630002
006400 01  WS-COUNTERS-AND-CONSTANTS.                                   00640005
006500     05  INPUT-COUNT                  PIC 9(09) VALUE 0.          00650002
006600     05  OUT-ADJUSTMENT-COUNT         PIC 9(09) VALUE 0.          00660002
006610     05  PC-PROGRAM-NAME              PIC X(08) VALUE 'APKUT124'. 00661005
006300                                                                  00662024
006800 01  PS-PROGRAM-SWITCHES.                                         00680002
006900     05  PS-ACTVTY-EOF                PIC X(01)      VALUE 'N'.   00690002
007000         88  ACTVTY-EOF                              VALUE 'Y'.   00700002
007100     05  PS-TRANCODE-CSR-SW           PIC X(01)      VALUE ' '.   00710002
007200         88  END-OF-TRANCODES                        VALUE 'Y'.   00720007
007230     05  PS-FISCAL-QTR-IND            PIC X(01)      VALUE 'N'.   00723005
007240         88  END-OF-FISCAL-QTR                       VALUE 'Y'.   00724007
007300                                                                  00730002
007400 01  WS-ABEND-FIELDS.                                             00740002
007500     05  WS-ABEND-LITERAL          PIC  X(40)   VALUE             00750002
007600             '*****       ABEND'.                                 00760002
007700     05  WS-ABEND-PROGRAM-MSG.                                    00770002
007800         10  FILLER                PIC X(17)    VALUE             00780002
007900             '*****   PROGRAM: '.                                 00790002
008000         10  WS-ABEND-PROGRAM      PIC X(8)   VALUE 'APKUT124'.   00800002
008100     05  WS-ABEND-PARAGRAPH-MSG.                                  00810002
008200         10  FILLER                PIC  X(17)   VALUE             00820002
008300             '***** PARAGRAPH: '.                                 00830002
008400         10  WS-ABEND-PARAGRAPH    PIC X(35)  VALUE SPACES.       00840002
008500     05  WS-ABEND-OPERATION-MSG.                                  00850002
008600         10  FILLER                PIC  X(17)   VALUE             00860002
008700             '***** OPERATION: '.                                 00870002
008800         10  WS-ABEND-OPERATION    PIC X(50)  VALUE SPACES.       00880002
008900     05  WS-ABEND-TABLE1-MSG.                                     00890002
009000         10  FILLER                PIC  X(15)   VALUE             00900002
009100             '***** TABLE 1: '.                                   00910002
009200         10  WS-ABEND-STRUCTURE-1  PIC X(8)   VALUE SPACES.       00920002
009300     05  WS-ABEND-TABLE2-MSG.                                     00930002
009400         10  FILLER                PIC  X(15)   VALUE             00940002
009500             '***** TABLE 2: '.                                   00950002
009600         10  WS-ABEND-STRUCTURE-2  PIC X(8)   VALUE SPACES.       00960002
009700     05  WS-ABEND-STATUS           PIC XX     VALUE SPACES.       00970002
009800     05  WS-MESSAGE-LINE-1.                                       00980002
009900         10  FILLER                PIC  X(06)   VALUE '*****'.    00990002
010000         10  WS-MESSAGE-1          PIC  X(80)   VALUE SPACES.     01000002
010100     05  WS-MESSAGE-LINE-2.                                       01010002
010200         10  FILLER                PIC  X(06)   VALUE '*****'.    01020002
010300         10  WS-MESSAGE-2          PIC  X(80)   VALUE SPACES.     01030002
010400                                                                  01040002
010500 01  ABEND-CODE                    PIC S9(4)  COMP SYNC           01050002
010600                                              VALUE ZEROS.        01060002
010700     88 AP-TABLE-FULL              VALUE +4004.                   01070002
010800     88 AP-EMPTY-FILE              VALUE +4005.                   01080002
010900     88 AP-TABLE-NOTFND            VALUE +4006.                   01090002
011000     88 AC-BAD-DATA                VALUE +4008.                   01100002
011100     88 AP-DB2-ERROR               VALUE +4013.                   01110002
011200                                                                  01120002
011300 01  AP-TRANCODES.                                                01130002
011400     05  AP-TRANCODE-TBL OCCURS 25 TIMES INDEXED BY TRN-INDEX.    01140002
011500         10  TBL-AP-TRN-CDE             PIC X(2).                 01150002
011600         10  TBL-PSTG-TYP-CDE           PIC X(2).                 01160002
011700         10  TBL-TRN-TYP-CDE            PIC X(3).                 01170002
011800         10  TBL-AUTO-OFFST-TRN-CDE     PIC X(2).                 01180002
011900         10  TBL-GL-ACCT-NBR            PIC X(6).                 01190002
012000         10  TBL-BTCH-SRC-CDE           PIC X(3).                 01200002
012010         10  TBL-VND-DEDUCT-TRN-CDE     PIC X(2).                 01201002
012100                                                                  01210002
012200*----------------------------------------------------------------*01220002
012300* DB2 SQL ERROR MESSAGE FORMAT AREA                               01230002
012400*----------------------------------------------------------------*01240002
012500                                                                  01250002
012600     COPY DPWS004.                                                01260002
012700                                                                  01270002
012800*----------------------------------------------------------------*01280002
012900* VENDOR AGREEMENT ACTIVITY EXTRACT FILE LAYOUT (INPUT)           01290002
013000*----------------------------------------------------------------*01300002
013100                                                                  01310002
013200     COPY APRD081.                                                01320002
013300                                                                  01330002
013400*----------------------------------------------------------------*01340002
013500* ADJUSTMENT JOURNAL DETAIL TRANSACTION RESULTS FILE LAYOUT       01350002
013600*----------------------------------------------------------------*01360002
013700                                                                  01370002
013800     COPY APRD045.                                                01380002
013900                                                                  01390002
014000*---------------------------------------------------------------- 01400002
014100*  WORKING STORAGE AREA FOR DPKUP151                              01410002
014200*---------------------------------------------------------------- 01420002
014300     COPY APWS151.                                                01430002
014300     COPY DPWS951.                                                01431025
014400                                                                  01440002
014500*----------------------------------------------------------------*01450002
014600* ACCOUNTS PAYABLE CONTROL TABLE                                  01460002
014700*----------------------------------------------------------------*01470002
014800                                                                  01480002
014900     EXEC SQL                                                     01490002
015000         INCLUDE TAPCNTL                                          01500002
015100     END-EXEC.                                                    01510002
015200                                                                  01520002
015300*----------------------------------------------------------------*01530002
015400* AP TRANCODE MASTER TABLE                                        01540002
015500*----------------------------------------------------------------*01550002
015600                                                                  01560002
015700     EXEC SQL                                                     01570002
015800         INCLUDE TTRNCDE                                          01580002
015900     END-EXEC.                                                    01590002
016000                                                                  01600002
016100*----------------------------------------------------------------*01610002
016200* DATE ATTRIBUTE TABLE                                            01620002
016300*----------------------------------------------------------------*01630002
016400                                                                  01640002
016500     EXEC SQL                                                     01650002
016600         INCLUDE TDTATTR                                          01660002
016700     END-EXEC.                                                    01670002
016800                                                                  01680002
016900*----------------------------------------------------------------*01690002
017000* DB2 COMMUNICATION AREA                                          01700002
017100*----------------------------------------------------------------*01710002
017200                                                                  01720002
017300     EXEC SQL                                                     01730002
017400         INCLUDE SQLCA                                            01740002
017500     END-EXEC.                                                    01750002
017600                                                                  01760002
017700*----------------------------------------------------------------*01770002
017800* DB2 COMMUNICATION AREA2                                         01780002
017900*----------------------------------------------------------------*01790002
018000                                                                  01800002
018100     COPY SQLCA2.                                                 01810002
018200                                                                  01820002
018300*----------------------------------------------------------------*01830002
018400* TRANCODE CURSOR RETURNS ALL VENDOR AGREEMENT TRANCODES         *01840002
018500*----------------------------------------------------------------*01850002
018501                                                                  01850102
018502     EXEC SQL                                                     01850202
018503       DECLARE TRANCODE_CSR CURSOR FOR                            01850302
018504         SELECT AP_TRN_CDE                                        01850402
018505              , PSTG_TYP_CDE                                      01850502
018506              , TRN_TYP_CDE                                       01850602
018507              , AUTO_OFFST_TRN_CDE                                01850702
018508              , GL_ACCT_NBR                                       01850802
018509           FROM TTRNCDE                                           01850902
018510          WHERE BTCH_SRC_CDE IN ('VAA','VDA')                     01851002
018520            AND CURRENT DATE BETWEEN EFF_STRT_DTE                 01852015
018530                                 AND EFF_END_DTE                  01853015
018540     END-EXEC.                                                    01854002
018550                                                                  01855002
018560 PROCEDURE DIVISION.                                              01856002
018570                                                                  01857002
018580 A100-PROGRAM-MAINLINE.                                           01858002
018590                                                                  01859002
018600     PERFORM B100-HOUSEKEEPING.                                   01860002
018700                                                                  01870002
018800     PERFORM B200-PROCESS-ACTVTY-REC                              01880002
018900         UNTIL ACTVTY-EOF.                                        01890002
019000                                                                  01900002
019100     PERFORM B300-END-OF-JOB.                                     01910002
019200                                                                  01920002
019300     GOBACK.                                                      01930002
019400                                                                  01940002
019500*----------------------------------------------------------------*01950002
019600*  B100-HOUSEKEEPING  OPEN FILES, INITIALIZE THE NECESSARY        01960002
019700*  FIELDS, PROCESS THE INVOICE FILE FOR THE FIRST RECORD, AND     01970002
019800*  OPENS THE CURSOR FOR THE FIRST RECORD.                         01980002
019900*----------------------------------------------------------------*01990002
020000                                                                  02000002
020100 B100-HOUSEKEEPING.                                               02010002
020200                                                                  02020002
020300     OPEN INPUT  VNDAGR-ACTVTY-FILE                               02030002
020400          OUTPUT ADJUST-JRNL-FILE.                                02040002
020500                                                                  02050002
020600     INITIALIZE AP045-TRANSACTION-FILE.                           02060002
020700                                                                  02070002
020800**   ACCEPT CONTROL-CARD.                                         02080021
020900                                                                  02090002
021000     PERFORM S400-SELECT-DATES.                                   02100002
021001                                                                  02100117
021002     DISPLAY '*** DATE CONTROLS SELECTED FOR THIS RUN ***'        02100210
021003     DISPLAY 'BATCH PROCESS DATE   = ' APCNTL-BTCH-PRC-DTE.       02100310
021004     DISPLAY 'CALCULATED ENTER DTE = ' PV-ENTR-DTE.               02100410
021018     DISPLAY 'PS-FISCAL-QTR-IND    = ' PS-FISCAL-QTR-IND.         02101810
021028     DISPLAY '****** END OF DATE CONTROLS DISPLAY *******'.       02102810
021030                                                                  02103010
021040     IF END-OF-FISCAL-QTR                                         02104022
021100        PERFORM S500-SET-CURRENT-TMST                             02110022
021200        PERFORM D200-LOAD-TRANCODES                               02120022
021400        PERFORM R100-READ-VNDAGR-ACTVTY-FILE                      02140022
021401     ELSE                                                         02140122
021402         SET ACTVTY-EOF TO TRUE                                   02140222
021410     END-IF.                                                      02141022
021500                                                                  02150002
021600*---------------------------------------------------------------* 02160002
021700*  B200-PROCESS-ACTVTY-REC                                      * 02170002
021800*  PROCESSES RECORDS FROM THE EXTRACT FILE.                     * 02180002
021900*---------------------------------------------------------------* 02190002
022000                                                                  02200002
022100 B200-PROCESS-ACTVTY-REC.                                         02210002
022200                                                                  02220002
022901     IF  AP081-EST-EARNED-AMT = 0                                 02290117
022902     OR  AP081-EST-EARNED-AMT < 0                                 02290223
022903         CONTINUE                                                 02290323
022904     ELSE                                                         02290423
022905         EVALUATE TRUE                                            02290523
022906             WHEN AP081-POST-FSCL-MNTH                            02290623
022907             WHEN AP081-POST-FSCL-QTR                             02290723
022908             WHEN AP081-POST-FSCL-SEMI-ANNL                       02290823
022909             WHEN AP081-POST-FSCL-ANNL                            02290923
022910             WHEN AP081-DO-NOT-POST                               02291023
022912                  IF  AP081-FSCL-QTR-NBR = DTATTR-FSCL-QTR-NBR    02291217
022913                  AND AP081-FSCL-YR-NBR = DTATTR-FSCL-YR-NBR      02291317
022914                      PERFORM C100-CREATE-EARNED-REVERSAL         02291417
022915                  END-IF                                          02291517
022916             WHEN AP081-POST-CAL-QTR                              02291617
022917             WHEN AP081-POST-CAL-SEMI-ANNL                        02291717
022918             WHEN AP081-POST-CAL-ANNL                             02291817
022919                  IF  AP081-CAL-QTR-NBR = DTATTR-FSCL-QTR-NBR     02291917
022920                  AND AP081-CAL-YR-NBR  = DTATTR-FSCL-YR-NBR      02292017
022921                      PERFORM C100-CREATE-EARNED-REVERSAL         02292117
022922                  END-IF                                          02292217
022944         END-EVALUATE                                             02294417
022945     END-IF.                                                      02294517
022950                                                                  02295017
023200     PERFORM R100-READ-VNDAGR-ACTVTY-FILE.                        02320002
023300                                                                  02330002
023400*---------------------------------------------------------------* 02340002
023500*  CLOSE FILES AND PERFORM FINAL DISPLAYS.                        02350002
023600*---------------------------------------------------------------* 02360002
023700 B300-END-OF-JOB.                                                 02370002
023800                                                                  02380002
023900     CLOSE VNDAGR-ACTVTY-FILE                                     02390002
024000           ADJUST-JRNL-FILE.                                      02400002
024100                                                                  02410002
024200     DISPLAY 'ACTIVITY RECORDS READ = ' INPUT-COUNT.              02420002
024300     DISPLAY 'ADJUSTMENT RECORDS WRITTEN = ' OUT-ADJUSTMENT-COUNT.02430002
024400                                                                  02440002
028900*----------------------------------------------------------------*02890003
028901*  FORMAT THE ADJUSTMENT DETAIL RECORD FROM THE DATA ON THE INPUT*02890103
028902*  RECORD FOR THE REVERSAL OF THE EARNED AMOUNT.   MANY FIELDS   *02890203
028903*  ARE LOADED FROM TTRNCDE TABLE VALUES, SO THE TRANCODE TABLE   *02890303
028904*  IS SEARCHED FOR THE REVERSAL TRANCODE THAT GOES WITH THE      *02890403
028906*  INPUT TRANCODE BEING PROCESSED.  THE AMOUNTS WILL BE BASED ON *02890604
028907*  THE GROSS PURCHASES, BUT FOR SOME OF THE POSTING FREQUENCIES, *02890704
028908*  PART OF THE EARNED AMOUNT MAY HAVE AREADY BEEN REVERSED, SO   *02890804
028909*  THE REVERSAL AMOUNT ALSO NEEDS TO BE APPLIED TO ARRIVE AT THE *02890904
028910*  FINAL ADJUSTMENT AMOUNT.                                      *02891004
028911*----------------------------------------------------------------*02891104
028912 C100-CREATE-EARNED-REVERSAL.                                     02891217
028913                                                                  02891304
028914     INITIALIZE AP045-KEY-FIELDS                                  02891404
028915                AP045-COMMON-FIELDS                               02891504
028916                AP045-DETAIL-FIELDS.                              02891604
028917                                                                  02891704
028919     IF  AP081-VENDOR-NBR = SAVE-VENDOR-NBR                       02891919
028920     AND AP081-AGR-AP-TRN-CDE = SAVE-AP-TRN-CDE                   02892019
028921         CONTINUE                                                 02892119
028922     ELSE                                                         02892219
028923         MOVE AP081-VENDOR-NBR TO SAVE-VENDOR-NBR                 02892319
028924         PERFORM S100-GET-NEXT-DOC-NBR                            02892419
028925     END-IF.                                                      02892519
028926                                                                  02892604
028927     IF AP081-AGR-AP-TRN-CDE = SAVE-AP-TRN-CDE                    02892719
028928        CONTINUE                                                  02892819
028929     ELSE                                                         02892919
028930         MOVE AP081-AGR-AP-TRN-CDE TO SAVE-AP-TRN-CDE             02893019
028931                                      MATCH-AP-TRN-CDE            02893119
028932         PERFORM D100-FIND-TRANCODE-ENTRY                         02893219
028933         MOVE TBL-AUTO-OFFST-TRN-CDE(TRN-INDEX) TO WS-RVRS-TRN-CDE02893319
028934     END-IF.                                                      02893419
028935                                                                  02893519
028936     MOVE WS-RVRS-TRN-CDE TO MATCH-AP-TRN-CDE.                    02893607
028937     PERFORM D100-FIND-TRANCODE-ENTRY.                            02893704
028938                                                                  02893804
028939     MOVE AP081-VENDOR-NBR              TO AP045-VND-NBR.         02893904
028940     MOVE WS151-NEXT-DOC-NBR            TO AP045-DOC-NBR.         02894004
028941     MOVE APCNTL-BTCH-PRC-DTE           TO AP045-DOC-DTE.         02894104
028942     MOVE WS-RVRS-TRN-CDE               TO AP045-AP-TRN-CDE.      02894204
028943     SET AP045-DETAIL-RECORD            TO TRUE.                  02894304
028944                                                                  02894404
028945     MOVE TBL-TRN-TYP-CDE(TRN-INDEX)    TO AP045-TRN-TYP-CDE.     02894504
028946     MOVE TBL-PSTG-TYP-CDE(TRN-INDEX)   TO AP045-PSTG-TYP-CDE.    02894604
028947                                                                  02894704
028948     IF AP045-MERCHANDISE                                         02894804
028949        MOVE 85                         TO AP045-STR-NBR          02894904
028950        MOVE AP081-DEPT-NBR             TO AP045-DEPT-NBR         02895004
028951     ELSE                                                         02895104
028952        MOVE 90                         TO AP045-STR-NBR          02895204
028953        MOVE TBL-GL-ACCT-NBR(TRN-INDEX) TO AP045-GL-ACCT-NBR      02895304
028954     END-IF.                                                      02895404
028955                                                                  02895504
028956     MOVE PV-CURR-TMST                  TO AP045-ENTR-TMST.       02895604
028957     MOVE PV-ENTR-DTE                   TO AP045-ENTR-DTE.        02895704
028958     MOVE 'APKUT124'                    TO AP045-ENTR-ID.         02895804
028959     SET  AP045-ORGN-ADJUST             TO TRUE.                  02895904
028960     MOVE APCNTL-BTCH-PRC-DTE           TO AP045-INV-CUTOFF-DTE   02896004
028961                                           AP045-PS-BTCH-DTE.     02896104
028962     MOVE 'ADJ'                         TO AP045-PS-BTCH-SRC-CDE. 02896204
028963     MOVE '00'                          TO AP045-PS-BTCH-SEQ-NBR. 02896304
028964                                                                  02896404
028965     MOVE AP081-ENT-ID                  TO AP045-ENT-ID.          02896504
028966     MOVE AP081-VENDOR-NAME             TO AP045-ENT-NME-DESC.    02896604
028967                                                                  02896704
028968     IF  APCNTL-MULT-PSTG-PER-IND = 'Y'                           02896804
028969         MOVE APCNTL-PREV-PSTG-FYR-NBR  TO AP045-PSTG-FYR-NBR     02896904
028970         MOVE APCNTL-PREV-PSTG-FMN-NBR  TO AP045-PSTG-FMN-NBR     02897004
028971         MOVE APCNTL-PREV-PSTG-FWK-NBR  TO AP045-PSTG-FWK-NBR     02897104
028972     ELSE                                                         02897204
028973         MOVE APCNTL-CURR-PSTG-FYR-NBR  TO AP045-PSTG-FYR-NBR     02897304
028974         MOVE APCNTL-CURR-PSTG-FMN-NBR  TO AP045-PSTG-FMN-NBR     02897404
028975         MOVE APCNTL-CURR-PSTG-FWK-NBR  TO AP045-PSTG-FWK-NBR     02897504
028976     END-IF.                                                      02897604
028977                                                                  02897704
028978     MOVE AP081-EST-EARNED-AMT TO AP045-GRO-COST-AMT.             02897813
028980                                                                  02898012
028981**   COMPUTE AP045-GRO-COST-AMT = AP045-GRO-COST-AMT +            02898113
028982**           AP081-RVRS-EARNED-AMT.                               02898213
028983                                                                  02898304
028984     IF AP045-CREDIT                                              02898404
028985        COMPUTE AP045-GRO-COST-AMT = AP045-GRO-COST-AMT * -1      02898508
028986     END-IF.                                                      02898604
028987                                                                  02898704
028988     MOVE AP045-GRO-COST-AMT TO AP045-NET-COST-AMT.               02898804
028989                                                                  02898904
028990     PERFORM W200-WRITE-OUTPUT-JRNL-REC.                          02899004
028991                                                                  02899104
028992*----------------------------------------------------------------*02899203
029000*  SEARCHES TRANCODE TABLE FOR THE TRANCODE BEING PROCESSED.     *02900002
029100*----------------------------------------------------------------*02910002
029200 D100-FIND-TRANCODE-ENTRY.                                        02920003
029300                                                                  02930002
029301     IF  MATCH-AP-TRN-CDE = SPACES                                02930104
029302         MOVE 'D100-FIND-TRANCODE-ENTRY' TO WS-ABEND-PARAGRAPH    02930204
029303         SET AP-TABLE-NOTFND TO TRUE                              02930304
029304         DISPLAY 'AP-TRN-CDE = ' AP081-AGR-AP-TRN-CDE             02930407
029305         MOVE 'NO OFFSET OR VENDOR DEDUCT TRNCODE AVAILABLE'      02930504
029306                                                  TO WS-MESSAGE-1 02930604
029307         PERFORM Z998-ABEND                                       02930704
029308     END-IF.                                                      02930804
029309                                                                  02930904
029310     PERFORM VARYING TRN-INDEX FROM 1 BY 1                        02931002
029320       UNTIL TBL-AP-TRN-CDE(TRN-INDEX) = MATCH-AP-TRN-CDE         02932003
029330          OR TRN-INDEX > 25                                       02933003
029340     END-PERFORM.                                                 02934002
029350                                                                  02935002
029360     IF  TRN-INDEX > 25                                           02936003
029370         MOVE 'D100-FIND-TRANCODE-ENTRY' TO WS-ABEND-PARAGRAPH    02937003
029380         SET AP-TABLE-NOTFND TO TRUE                              02938002
029390         DISPLAY 'AP-TRN-CDE = ' MATCH-AP-TRN-CDE                 02939003
029391         MOVE 'TRANCODE TABLE ENTRY NOT FOUND' TO WS-MESSAGE-1    02939102
029392         PERFORM Z998-ABEND                                       02939202
029393     END-IF.                                                      02939302
029394*----------------------------------------------------------------*02939402
029395*  OPENS THE TRANCODE CURSOR AND FETCHES UNTIL END, LOADING EACH *02939502
029396*  ENTRY INTO THE TRANCODE TABLE IN WORKING STORAGE.             *02939602
029397*----------------------------------------------------------------*02939702
029398 D200-LOAD-TRANCODES.                                             02939803
029399                                                                  02939902
029400     PERFORM X100-OPEN-TRANCODE-CSR.                              02940002
029500                                                                  02950002
029600     SET TRN-INDEX TO 1.                                          02960002
029700     PERFORM S300-FETCH-TRANCODE-CSR.                             02970002
029800                                                                  02980002
029900     PERFORM UNTIL END-OF-TRANCODES OR TRN-INDEX > 15             02990007
029910        MOVE TRNCDE-AP-TRN-CDE   TO TBL-AP-TRN-CDE(TRN-INDEX)     02991002
029911        MOVE TRNCDE-PSTG-TYP-CDE TO TBL-PSTG-TYP-CDE(TRN-INDEX)   02991102
029912        MOVE TRNCDE-TRN-TYP-CDE  TO TBL-TRN-TYP-CDE(TRN-INDEX)    02991202
029913        MOVE TRNCDE-AUTO-OFFST-TRN-CDE                            02991302
029914                              TO TBL-AUTO-OFFST-TRN-CDE(TRN-INDEX)02991402
029917        MOVE TRNCDE-GL-ACCT-NBR  TO TBL-GL-ACCT-NBR(TRN-INDEX)    02991704
029918        IF TRNCDE-AP-TRN-CDE = '88'                               02991804
029919           MOVE '91'         TO TBL-VND-DEDUCT-TRN-CDE(TRN-INDEX) 02991904
029920        END-IF                                                    02992004
029921        IF TRNCDE-AP-TRN-CDE = '89'                               02992104
029923           MOVE '96'         TO TBL-VND-DEDUCT-TRN-CDE(TRN-INDEX) 02992314
029924        END-IF                                                    02992404
029925        SET TRN-INDEX UP BY 1                                     02992504
029926        PERFORM S300-FETCH-TRANCODE-CSR                           02992604
029927     END-PERFORM.                                                 02992704
029928                                                                  02992804
029929     PERFORM X200-CLOSE-TRANCODE-CSR.                             02992904
029930                                                                  02993004
029931     IF  TRN-INDEX > 15                                           02993104
029932     AND NOT END-OF-TRANCODES                                     02993207
029933         MOVE 'D200-LOAD-TRANCODES' TO WS-ABEND-PARAGRAPH         02993304
029934         SET AP-TABLE-FULL TO TRUE                                02993404
029935         MOVE 'MAX NUMBER OF ENTRIES EXCEEDED ON TRANCODE TABLE'  02993504
029936                                    TO WS-MESSAGE-1               02993604
029937         MOVE 'QUERY TTRNCDE FOR BTCH SRC = VDA AND EXPAND LIMIT' 02993704
029938                                    TO WS-MESSAGE-2               02993804
029939         PERFORM Z998-ABEND                                       02993904
029940     END-IF.                                                      02994004
029941                                                                  02994104
029942*----------------------------------------------------------------*02994204
029943*  R100-READ-VNDAGR-ACTVTY-FILE                                  *02994304
029944*  READS THE INPUT FILE INTO THE APRD081 COPYBOOK.               *02994404
029945*----------------------------------------------------------------*02994504
029946                                                                  02994604
029947 R100-READ-VNDAGR-ACTVTY-FILE.                                    02994704
029948                                                                  02994804
029949     READ VNDAGR-ACTVTY-FILE INTO AP081-VNDAGR-EXTRACT            02994904
029950         AT END                                                   02995002
029960            SET ACTVTY-EOF TO TRUE.                               02996002
029970                                                                  02997002
029980     IF NOT ACTVTY-EOF                                            02998002
029990        ADD 1 TO INPUT-COUNT                                      02999002
030000     END-IF.                                                      03000002
030100                                                                  03010002
030200                                                                  03020002
030300*----------------------------------------------------------------*03030002
030400*  S100-GET-NEXT-DOC-NBR                                         *03040002
030500*  SELECT THE NEXT AVAILABLE DOC NUMBER FROM THE TAPCNTL TABLE.  *03050002
030600*----------------------------------------------------------------*03060002
030700                                                                  03070002
030800 S100-GET-NEXT-DOC-NBR.                                           03080002
030900                                                                  03090002
031000     CALL DP951-AJ-NEXT-DOC-NBR-ROUTINE                           03100025
031000                     USING WS151-DOC-NBR-PARAMETERS.              03101024
031100                                                                  03110002
031200     IF WS151-ERRORS-FOUND                                        03120002
031300        SET AC-BAD-DATA TO TRUE                                   03130002
031400        MOVE 'S100-GET-NEXT-DOC-NBR     '                         03140002
031500                                   TO WS-ABEND-PARAGRAPH          03150002
031600        MOVE WS151-ERROR-MESSAGE   TO WS-MESSAGE-1                03160002
031700        MOVE WS151-SQLCODE         TO WS-MESSAGE-2                03170002
031800        PERFORM Z998-ABEND                                        03180002
031900     END-IF.                                                      03190002
032000                                                                  03200002
032100*----------------------------------------------------------------*03210002
032200*  S300-FETCH-TRANCODE-CSR                                       *03220002
032300*----------------------------------------------------------------*03230002
032400 S300-FETCH-TRANCODE-CSR.                                         03240002
032500                                                                  03250002
032600     EXEC SQL                                                     03260002
032700          FETCH TRANCODE_CSR                                      03270002
032800           INTO :TRNCDE-AP-TRN-CDE                                03280002
032900              , :TRNCDE-PSTG-TYP-CDE                              03290002
033000              , :TRNCDE-TRN-TYP-CDE                               03300002
033100              , :TRNCDE-AUTO-OFFST-TRN-CDE                        03310002
033200              , :TRNCDE-GL-ACCT-NBR                               03320002
033300     END-EXEC.                                                    03330002
033400                                                                  03340002
033500     EVALUATE TRUE                                                03350002
033600         WHEN SQLCODE = +0                                        03360002
033700              CONTINUE                                            03370002
033800         WHEN SQLCODE = +100                                      03380002
033900              SET END-OF-TRANCODES TO TRUE                        03390007
034000                                                                  03400002
034100         WHEN SQLWARN0 NOT = SPACES                               03410002
034200         WHEN SQLCODE < +0                                        03420002
034300         WHEN SQLCODE > +0                                        03430002
034400              MOVE 'S300-FETCH-TRANCODE-CSR'                      03440002
034500                                TO WS-ABEND-PARAGRAPH             03450002
034600              MOVE 'UNSUCCESSFUL FETCH ON TRANCODE CSR'           03460002
034700                                TO WS-ABEND-OPERATION             03470002
034800              MOVE 'TTRNCDE '   TO WS-ABEND-STRUCTURE-1           03480002
034900              MOVE SPACES       TO WS-ABEND-STRUCTURE-2           03490002
035000              PERFORM Z999-SQL-ERROR                              03500002
035100     END-EVALUATE.                                                03510002
035200                                                                  03520002
035300*----------------------------------------------------------------*03530002
035500*  SELECT BATCH PROCESS DATE, CURR/PREV POSTING FISCAL YEAR,     *03550005
035600*  CURR/PREV POSTING FISCAL MONTH, AND CURR/PREV POSTING FISCAL  *03560005
035700*  WEEK FROM THE TAPCNTL TABLE, ALONG WITH THE FISCAL MONTH      *03570005
035710*  NUMBER FROM THE TDTATTR TABLE.  THE WHERE CONDITION STATING   *03571005
035720*  A.BTCH_PRC_DTE = B.FSCL_MN_END_DTE GUARANTEES THAT THIS       *03572005
035800*  PROGRAM IS BEING RUN ON THE LAST DAY OF THE FISCAL MONTH.     *03580005
035900*  BATCH PROCESS DATE PLUS 2 DAYS IS USED AS THE ENTER DATE SO   *03590005
036000*  IT WILL BE A MONDAY DATE, WHICH IS WHEN THE TRANSACTIONS      *03600005
036100*  BEING CREATED IN THIS PROGRAM WILL ACTUALLY POST.             *03610002
036200*----------------------------------------------------------------*03620002
036300 S400-SELECT-DATES.                                               03630002
036400                                                                  03640002
036500     EXEC SQL                                                     03650002
036600          SELECT A.BTCH_PRC_DTE                                   03660005
036700               , (A.BTCH_PRC_DTE + 2 DAYS)                        03670005
036800               , A.CURR_PSTG_FYR_NBR                              03680005
036900               , A.CURR_PSTG_FMN_NBR                              03690005
037000               , A.CURR_PSTG_FWK_NBR                              03700005
037100               , A.PREV_PSTG_FYR_NBR                              03710005
037200               , A.PREV_PSTG_FMN_NBR                              03720005
037300               , A.PREV_PSTG_FWK_NBR                              03730005
037400               , A.MULT_PSTG_PER_IND                              03740005
037410               , B.FSCL_MN_NBR                                    03741005
037411               , B.FSCL_YR_NBR                                    03741116
037412               , B.FSCL_QTR_NBR                                   03741216
037510            INTO :APCNTL-BTCH-PRC-DTE                             03751005
037600               , :PV-ENTR-DTE                                     03760002
037700               , :APCNTL-CURR-PSTG-FYR-NBR                        03770002
037800               , :APCNTL-CURR-PSTG-FMN-NBR                        03780002
037900               , :APCNTL-CURR-PSTG-FWK-NBR                        03790002
038000               , :APCNTL-PREV-PSTG-FYR-NBR                        03800002
038100               , :APCNTL-PREV-PSTG-FMN-NBR                        03810002
038200               , :APCNTL-PREV-PSTG-FWK-NBR                        03820002
038300               , :APCNTL-MULT-PSTG-PER-IND                        03830002
038310               , :DTATTR-FSCL-MN-NBR                              03831017
038320               , :DTATTR-FSCL-YR-NBR                              03832017
038330               , :DTATTR-FSCL-QTR-NBR                             03833017
038400            FROM TAPCNTL A                                        03840005
038410               , TDTATTR B                                        03841005
038420           WHERE A.BTCH_PRC_DTE    = B.KY_DTE                     03842005
038430             AND A.BTCH_PRC_DTE    = B.FSCL_MN_END_DTE            03843005
038500     END-EXEC.                                                    03850002
038600                                                                  03860002
038700     EVALUATE TRUE                                                03870002
038800         WHEN SQLCODE = +0                                        03880002
038830              EVALUATE TRUE                                       03883005
038837                 WHEN DTATTR-FSCL-MN-NBR = '03'                   03883705
038842                 WHEN DTATTR-FSCL-MN-NBR = '06'                   03884205
038847                 WHEN DTATTR-FSCL-MN-NBR = '09'                   03884705
038853                 WHEN DTATTR-FSCL-MN-NBR = '12'                   03885305
038854                      SET END-OF-FISCAL-QTR       TO TRUE         03885407
038855                 WHEN OTHER                                       03885517
038856                    DISPLAY 'NOT PROCESSING END OF QUARTER'       03885622
038857                    DISPLAY 'NOT PROCESSING END OF QUARTER'       03885722
038900              END-EVALUATE                                        03890017
039000         WHEN SQLWARN0 NOT = SPACES                               03900002
039100         WHEN SQLCODE < +0                                        03910002
039200         WHEN SQLCODE > +0                                        03920002
039300              MOVE 'S400-SELECT-DATES' TO WS-ABEND-PARAGRAPH      03930002
039400              MOVE 'UNSUCCESSFUL SELECT DATES'                    03940002
039500                                       TO WS-ABEND-OPERATION      03950002
039600              MOVE 'TAPCNTL '          TO WS-ABEND-STRUCTURE-1    03960002
039700              MOVE SPACE               TO WS-ABEND-STRUCTURE-2    03970002
039800              PERFORM Z999-SQL-ERROR                              03980002
039900     END-EVALUATE.                                                03990002
040000                                                                  04000002
040100*----------------------------------------------------------------*04010002
040200*  S500-SET-CURENT-TMST  GETS THE CURRENT TIMESTAMP FROM DB2.    *04020002
040300*----------------------------------------------------------------*04030002
040400                                                                  04040002
040500 S500-SET-CURRENT-TMST.                                           04050002
040600                                                                  04060002
040700                                                                  04070002
040800     EXEC SQL                                                     04080002
040900          SET :PV-CURR-TMST = CURRENT TIMESTAMP                   04090002
041000     END-EXEC.                                                    04100002
041100                                                                  04110002
041200     EVALUATE TRUE                                                04120002
041300         WHEN SQLCODE = +0                                        04130002
041400              CONTINUE                                            04140002
041500         WHEN SQLWARN0 NOT = SPACES                               04150002
041600         WHEN SQLCODE < +0                                        04160002
041700         WHEN SQLCODE > +0                                        04170002
041800              MOVE 'S500-SET-CURRENT-TMST' TO WS-ABEND-PARAGRAPH  04180002
041900              MOVE 'UNSUCCESSFUL SET TMST' TO WS-ABEND-OPERATION  04190002
042000              MOVE SPACES TO WS-ABEND-STRUCTURE-1                 04200002
042100                             WS-ABEND-STRUCTURE-2                 04210002
042200              PERFORM Z999-SQL-ERROR                              04220002
042300     END-EVALUATE.                                                04230002
042400                                                                  04240002
042500*----------------------------------------------------------------*04250002
042600*  W200-WRITE-OUTPUT-JRNL-REC                                    *04260002
042700*  WRITES TO THE JOURNALIZED OUTPUT FILE.                        *04270002
042800*----------------------------------------------------------------*04280002
042900                                                                  04290002
043000 W200-WRITE-OUTPUT-JRNL-REC.                                      04300002
043100                                                                  04310002
043200     WRITE ADJUST-JRNL-RECORD FROM AP045-TRANSACTION-FILE.        04320002
043300                                                                  04330002
043400     ADD 1 TO OUT-ADJUSTMENT-COUNT.                               04340002
043500                                                                  04350002
043600*----------------------------------------------------------------*04360002
043700*  OPEN TRANCODE CURSOR.                                         *04370002
043800*----------------------------------------------------------------*04380002
043900 X100-OPEN-TRANCODE-CSR.                                          04390002
044000                                                                  04400002
044100     EXEC SQL                                                     04410002
044200         OPEN TRANCODE_CSR                                        04420002
044300     END-EXEC.                                                    04430002
044400                                                                  04440002
044500     EVALUATE TRUE                                                04450002
044600         WHEN SQLCODE = ZERO                                      04460002
044700              CONTINUE                                            04470002
044800         WHEN SQLWARN0 NOT = SPACES                               04480002
044900         WHEN SQLCODE  NOT = ZERO                                 04490002
045000              MOVE 'X100-OPEN-TRANCODE-CSR' TO WS-ABEND-PARAGRAPH 04500002
045100              MOVE 'UNSUCCESSFUL OPEN ON TRANCODE_CSR'            04510002
045200                                       TO WS-ABEND-OPERATION      04520002
045300              MOVE 'TTRNCDE '          TO WS-ABEND-STRUCTURE-1    04530002
045400              MOVE SPACE               TO WS-ABEND-STRUCTURE-2    04540002
045500              PERFORM Z999-SQL-ERROR                              04550002
045600     END-EVALUATE.                                                04560002
045700                                                                  04570002
045800*----------------------------------------------------------------*04580002
045900*  CLOSE TRANCODE CURSOR.                                        *04590002
046000*----------------------------------------------------------------*04600002
046100 X200-CLOSE-TRANCODE-CSR.                                         04610002
046200                                                                  04620002
046300     EXEC SQL                                                     04630002
046400         CLOSE TRANCODE_CSR                                       04640002
046500     END-EXEC.                                                    04650002
046600                                                                  04660002
046700     EVALUATE TRUE                                                04670002
046800         WHEN SQLCODE = ZERO                                      04680002
046900              CONTINUE                                            04690002
047000         WHEN SQLWARN0 NOT = SPACES                               04700002
047100         WHEN SQLCODE  NOT = ZERO                                 04710002
047200              MOVE 'X200-CLOSE-TRANCODE-CSR' TO WS-ABEND-PARAGRAPH04720002
047300              MOVE 'UNSUCCESSFUL CLOSE ON TRANCODE_CSR'           04730002
047400                                       TO WS-ABEND-OPERATION      04740002
047500              MOVE 'TTRNCDE '          TO WS-ABEND-STRUCTURE-1    04750002
047600              MOVE SPACE               TO WS-ABEND-STRUCTURE-2    04760002
047700              PERFORM Z999-SQL-ERROR                              04770002
047800     END-EVALUATE.                                                04780002
047900                                                                  04790002
048000*----------------------------------------------------------------*04800002
048100*  GENERAL ABEND ROUTINE                                         *04810002
048200*----------------------------------------------------------------*04820002
048300 Z998-ABEND.                                                      04830002
048400                                                                  04840002
048500     DISPLAY WS-ABEND-LITERAL.                                    04850002
048600     DISPLAY WS-ABEND-PROGRAM-MSG.                                04860002
048700     DISPLAY WS-ABEND-PARAGRAPH-MSG.                              04870002
048800     DISPLAY WS-MESSAGE-LINE-1.                                   04880002
048900     DISPLAY WS-MESSAGE-LINE-2.                                   04890002
049000                                                                  04900002
049100     CALL 'ILBOABN0' USING ABEND-CODE.                            04910002
049200                                                                  04920002
049300*----------------------------------------------------------------*04930002
049400*  PROCESS DB2 ABENDS.                                           *04940002
049500*----------------------------------------------------------------*04950002
049600 Z999-SQL-ERROR.                                                  04960002
049700                                                                  04970002
049800     DISPLAY '*** DB2 ERROR '.                                    04980002
049900     DISPLAY WS-ABEND-PROGRAM-MSG.                                04990002
050000     DISPLAY WS-ABEND-PARAGRAPH-MSG.                              05000002
050100     DISPLAY WS-ABEND-OPERATION-MSG.                              05010002
050200     DISPLAY WS-ABEND-TABLE1-MSG.                                 05020002
050300     IF WS-ABEND-STRUCTURE-2 > SPACES                             05030002
050400         DISPLAY WS-ABEND-TABLE2-MSG.                             05040002
050500                                                                  05050002
050600     SET AP-DB2-ERROR              TO TRUE.                       05060002
050700                                                                  05070002
050800     COPY DPPD004.                                                05080002
050900     CALL 'ILBOABN0' USING ABEND-CODE.                            05090002
