000100*----------------------------------------------------------------*00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300*----------------------------------------------------------------*00030000
000400 PROGRAM-ID.           DAKUP200.                                  00040000
000500 AUTHOR.               BOB MCASEY                                 00050000
000600 INSTALLATION.         KOHLS DEPARTMENT STORES.                   00060000
000700 DATE-WRITTEN          05/30/2000.                                00070000
000800 DATE-COMPILED.                                                   00080000
000900                                                                  00090000
001000*----------------------------------------------------------------*00100000
001100*   DAKUP200 - PRORATE DEBIT ALLOWANCE TRANSACTIONS              *00110000
001100*                                                                *00120000
001200*   THIS PROGRAM SEQUENTIALLY READS AN INPUT FILE OF TDAALW      *00130000
001300*   EXTRACT RECORDS (FROM DAKUT301) AND PRORATES THEM DOWN TO    *00140000
001300*   THE STORE LEVEL.  THE PRORATION DATA IS STORED ON THE        *00150000
001400*   DEBIT ALLOWANCE PRORATION TABLE (TDAPRRT).  AN OUTPUT FILE   *00160000
001400*   IS WRITTEN CONTAINING AUDIT INFORMATION.  THE TDAALW TABLE   *00170000
001400*   IS UPDATED, CHANGING ANY ROWS WITH STATUS CODE '40' (AP      *00180000
001400*   APPROVED) TO '60' (PROCESSED).                               *00190000
001700*                                                                *00200000
      *    WR/PITS#     DATE        DESCRIPTION                        *00210000
      *    --------   ----------   ---------------------------------   *00220000
      *    PM00399424 04/10/2001   ELIMINATED THE RELEASE FROM THE     *00230000
      *                            COMMIT.  RELEASE ACTUALLY DISCON-   *00240000
      *                            NECTS FROM THE TABLE.               *00250000
0701RM*   WR22467     07/20/2001   CHANGED RECORD LENGTH OF AP TRANS  * 00260000
      *                            FILE AND ALL PROCESSING ASSOCIATE  * 00270000
      *                            WITH IT.                           * 00280000
      *   WR23724     05/15/2002   RECOMPILED FOR CHANGES IN COPYBOOK * 00290000
      *                            APRD045                            * 00300000
22405 * 22405  05-31-2001 R JANSSEN  DAII - ASSET RECOVERY ENHANCEMENT  00310000
      *   W30328      02/22/2006   10G GATEWAY. REMOVE ALTER SESSION    00320000
      *   S30328      02/23/2006   FIX UPDATE CPLT_DTE DATE FORMAT      00330000
      *                            MOVE UNDER PITS P000853786           00340000
      *   W30021      05/05/2006   WRITE OUT NEW '7D' CREDIT RECORDS.   00350000
CTLCHG*   P47031      04/10/2014   MODIFIED THE LOGIC TO ACCUMULATE     00351016
CTLCHG*                            THE AMOUNTS(PA-TOT-UPDT-RTL-AMT      00352003
CTLCHG*                            PA-TOT-UPDT-CREDIT-AMT) ONLY WHEN    00353017
CTLCHG*                            THE TRANSACTION IS SUCCESSFULLY      00354003
CTLCHG*                            PROCESSED.                           00355003
8613F *8613F   07-17-2015 S BARTELT  RMS 9 REMEDIATION. CHANGED FROM    00356027
      *                              AUTO LOGON TO EXTERNAL SIGN ON     00357029
004900*----------------------------------------------------------------*00360000
007300                                                                  00370000
007400     EJECT                                                        00380000
007500*----------------------------------------------------------------*00390000
007600 ENVIRONMENT DIVISION.                                            00400000
007700*----------------------------------------------------------------*00410000
007800 CONFIGURATION SECTION.                                           00420000
007900                                                                  00430000
008000 SOURCE-COMPUTER. IBM-3090.                                       00440000
008100 OBJECT-COMPUTER. IBM-3090.                                       00450000
008200                                                                  00460000
008300 INPUT-OUTPUT SECTION.                                            00470000
008500 FILE-CONTROL.                                                    00480000
           SELECT IN-AP-FILE                 ASSIGN TO INP01.           00490000
           SELECT CONTROL-CARD-FILE          ASSIGN TO INP02.           00500000
8613F      SELECT ORACLE-LOGIN-FILE          ASSIGN TO ORALOGON.        00501027
           SELECT OUT-AP-FILE                ASSIGN TO OUT01.           00520000
                                                                        00530000
010200*----------------------------------------------------------------*00540000
010300 DATA DIVISION.                                                   00550000
010200*----------------------------------------------------------------*00560000
010600 FILE SECTION.                                                    00570000
       FD  IN-AP-FILE                                                   00580000
           LABEL RECORDS ARE STANDARD                                   00590000
           RECORDING MODE IS F                                          00600000
           BLOCK CONTAINS 0 RECORDS.                                    00610000
0701RM*01  IN-AP-RECORD            PIC X(450).                          00620000
0701RM 01  IN-AP-RECORD            PIC X(550).                          00630000
                                                                        00640000
       FD  CONTROL-CARD-FILE                                            00650000
           RECORDING MODE IS F                                          00660000
           LABEL RECORDS ARE STANDARD                                   00670000
           BLOCK CONTAINS 0 RECORDS.                                    00680000
       01  CONTROL-CARD-RECORD     PIC X(80).                           00690000
                                                                        00690118
8613F  FD  ORACLE-LOGIN-FILE                                            00691027
8613F      RECORDING MODE IS F                                          00692027
8613F      LABEL RECORDS ARE STANDARD                                   00693027
8613F      BLOCK CONTAINS 0 RECORDS                                     00694027
8613F      DATA RECORD IS ORACLE-LOGIN-REC.                             00695027
8613F  01  ORACLE-LOGIN-REC.                                            00696027
8613F      05  FILLER                  PIC X(80).                       00697027
                                                                        00700000
       FD  OUT-AP-FILE                                                  00880000
           RECORDING MODE IS F                                          00890000
           LABEL RECORDS ARE STANDARD                                   00900000
           BLOCK CONTAINS 0 RECORDS.                                    00910000
0701RM*01  AP-TRANSACTION-RECORD         PIC X(450).                    00920000
0701RM 01  AP-TRANSACTION-RECORD         PIC X(550).                    00930000
      *                                                                 00940000
       WORKING-STORAGE SECTION.                                         00950000
                                                                        00960000
       01  PA-PROGRAM-ACCUMULATORS.                                     00970000
           05  PA-DEADLOCK-COUNT       PIC S9(04)    VALUE +0.          00980000
           05  PA-AP-TOTAL-WRITTEN     PIC 9(09)     VALUE 0.           00990000
           05  PA-DA-RECS-UPDATED      PIC 9(03)     VALUE 0.           01000000
           05  PA-RECORDS-READ         PIC 9(09)     VALUE 0.           01010000
           05  PA-ROWS-UPDATED         PIC 9(09)     VALUE 0.           01020000
           05  PA-DA-ROWS-UPDATED      PIC 9(03)     VALUE 0.           01030000
           05  PA-TOTAL-RTL-AMT        PIC S9(09)V99 COMP-3 VALUE 0.    01040000
           05  PA-TOTAL-CREDIT-AMT     PIC S9(09)V99 COMP-3 VALUE 0.    01050000
           05  PA-TOT-UPDT-RTL-AMT     PIC S9(09)V99 COMP-3 VALUE 0.    01060000
           05  PA-TOT-UPDT-CREDIT-AMT  PIC S9(09)V99 COMP-3 VALUE 0.    01070000
                                                                        01080000
                                                                        01090000
       01  PC-PROGRAM-CONSTANTS.                                        01100000
           05  PC-MAX-DEADLOCKS             PIC S9(03) VALUE +3.        01110000
           05  PC-COMMIT-COUNT              PIC 9(03) VALUE 50.         01120000
           05  PC-REC-TYPE-CDE-9            PIC X(01) VALUE '9'.        01130000
           05  PC-PROGRAM-NAME              PIC X(08) VALUE 'DAKUP200'. 01140000
           05  PC-MESSAGES.                                             01150000
               10  PC-SQL-ABEND-MESSAGE     PIC X(23) VALUE             01160000
               '** ABEND -> SQLERROR = '.                               01170000
               10  PC-PROGRAM-MESSAGE       PIC X(23) VALUE             01180000
               '** PROGRAM        ** = '.                               01190000
               10  PC-PARAGRAPH-MESSAGE     PIC X(23) VALUE             01200000
               '** PARAGRAPH-NAME ** = '.                               01210000
               10  PC-DB2-OPER-MESSAGE      PIC X(23) VALUE             01220000
               '** DB2 OPERATION  ** = '.                               01230000
8613F      05  PC-AUTO-LOGON           PIC X(01)  VALUE '/'.            01231027
                                                                        01240000
       01  PE-PROGRAM-ERROR-MESSAGES.                                   01250000
           05  PE-MSG-01                    PIC X(50) VALUE             01260000
                'PROGRAM MAXIMUM DEADLOCK COUNT HAS BEEN EXCEEDED'.     01270000
                                                                        01280000
       01  PS-PROGRAM-SWITCHES.                                         01290000
           05  PS-EOF-INPUT-FILE-SW         PIC X(01)  VALUE 'N'.       01300000
               88  PS-EOF-INPUT-FILE                   VALUE 'Y'.       01310000
           05  PS-END-OF-CONTROL-CARDS-SW   PIC X(01)  VALUE 'N'.       01320000
               88  END-OF-CONTROL-CARDS                VALUE 'Y'.       01330000
           05  PS-TDAALW-UPDATED-SW         PIC X(01)  VALUE 'N'.       01340000
               88  PS-TDAALW-UPDATED                   VALUE 'Y'.       01350000
22405      05  PS-INP03-DONE-SW             PIC X(01)      VALUE 'N'.   01360000
22405          88  INP03-PROCESS-COMPLETE                  VALUE 'Y'.   01370000
8613F      05  PS-ORACLE-LOGIN-EOF-SW          PIC  X     VALUE 'N'.    01371027
8613F          88  ORACLE-LOGIN-EOF                       VALUE 'Y'.    01372027
                                                                        01380000
8613F  01  CC-ORACLE-CONNECTION.                                        01381027
8613F      05  CC-ORACLE-USERID                PIC X(40).               01382027
8613F          88 CC-AUTO-LOGON                           VALUE '/'.    01383027
8613F      05  CC-ORACLE-PASSWORD              PIC X(40).               01384027
                                                                        01385027
       01  PV-PROGRAM-VARIABLES.                                        01390000
           05  PV-RETRY-COUNT               PIC S9(04) VALUE +0.        01400000
           05  PV-RETURN-CODE               PIC 9(04)  VALUE 0.         01410000
           05  PV-PARAGRAPH-NAME            PIC X(40)  VALUE SPACE.     01420000
           05  PV-OPERATION-ATTEMPTED       PIC X(50)  VALUE SPACE.     01430000
008600     05  PV-DETAIL-FIELDS.                                        01440000
               10  PV-STR-NBR               PIC 9(5).                   01450000
008800         10  PV-CL-NBR                PIC X(2).                   01460000
008900         10  PV-SKU-SEQ-NBR           PIC X(3).                   01470000
009000         10  PV-GRO-COST-AMT          PIC S9(07)V99 COMP-3        01480000
                                                          VALUE +0.     01490000
009100         10  PV-RETL-AMT              PIC S9(07)V99 COMP-3        01500000
                                                          VALUE +0.     01510000
009200         10  PV-FRGT-AMT              PIC S9(07)V99 COMP-3        01520000
                                                          VALUE +0.     01530000
009300         10  PV-MISC-CHRG-AMT         PIC S9(07)V99 COMP-3        01540000
                                                          VALUE +0.     01550000
009400         10  PV-NET-COST-AMT          PIC S9(07)V99 COMP-3        01560000
                                                          VALUE +0.     01570000
009500         10  PV-DTL-TERM-DISC-AMT     PIC S9(07)V99 COMP-3        01580000
                                                          VALUE +0.     01590000
009600         10  PV-DTL-NW-STR-DISC-AMT   PIC S9(07)V99 COMP-3        01600000
                                                          VALUE +0.     01610000
009700         10  PV-DTL-TRD-DISC-AMT      PIC S9(07)V99 COMP-3        01620000
                                                          VALUE +0.     01630000
009800         10  FILLER                   PIC X(22).                  01640000
2240       05  PV-EDIT-ORA-SOURCE           PIC X(04)  VALUE SPACES.    01650027
22405          88  VALID-ORACLE-CONNECT-STRING                          01660000
22405                                       VALUES 'PRD ', 'TST ',      01670000
22405                                              'LRN ', 'QA  ',      01680000
22405                                              'PRDT'.              01690000
22405          88  VALID-DEVELOPMENT-REGION VALUES 'TST ',              01700000
22405                                              'LRN ', 'QA  ',      01710000
22405                                              'PRDT'.              01720000
22405          88  ORA-PROD-REGION          VALUE 'PRD '.               01730000
22405      05  PV-DR-ALW-NBR           PIC S9(04) COMP VALUE ZERO.      01740000
22405      05  PV-STAT-CDE             PIC S9(04) COMP VALUE ZERO.      01750000
22405      05  PV-CPLT-DTE             PIC S9(04) COMP VALUE ZERO.      01760000
22405      05  PV-DEPT-NBR             PIC S9(04) COMP VALUE ZERO.      01770000
8613F      05  PV-ORACLE-USERID-LEN            PIC S9(04) VALUE ZEROS.  01771027
8613F      05  PV-ORACLE-PASSWORD-LEN          PIC S9(04) VALUE ZEROS.  01772027
                                                                        01780000
       01  PV-ABEND-CODE   COMP  SYNC       PIC S9(04) VALUE +0000.     01790000
           88  ABEND-4001-INV-WRITE-KEY                VALUE +4001.     01800000
           88  ABEND-4002-INV-READ-KEY                 VALUE +4002.     01810000
           88  ABEND-4003-CNTL-CARD-ERRORS             VALUE +4003.     01820000
           88  ABEND-4004-SEQUENCE-ERROR               VALUE +4004.     01830000
           88  ABEND-4005-OPEN-FILE-ERROR              VALUE +4005.     01840000
           88  ABEND-4006-CLOSE-FILE-ERROR             VALUE +4006.     01850000
           88  ABEND-4007-SEQUENCE-ERROR               VALUE +4007.     01860000
           88  ABEND-4008-1ST-RCD-NOT-01               VALUE +4008.     01870000
           88  ABEND-4009-INVALID-DATA                 VALUE +4009.     01880000
           88  ABEND-4012-BAD-INTR-SORT                VALUE +4012.     01890000
           88  ABEND-4013-DB2-ERROR                    VALUE +4013.     01900000
                                                                        01910000
      *                                                                 01920000
                                                                        01930000
       01  WS-MSG-TEXT                   PIC X(512).                    01940000
       01  WS-MAX-SIZE                   PIC S9(09) COMP  VALUE 512.    01950000
       01  WS-MSG-LENGTH                 PIC S9(09) COMP.               01960000
                                                                        01970000
      *----------------------------------------------------------------*01980000
      *    ORACLE DECLARE SECTION                                       01990000
      *----------------------------------------------------------------*02000000
           EXEC SQL BEGIN DECLARE SECTION END-EXEC.                     02010000
                                                                        02020000
       01  USERNAME                   PIC X(10)      VARYING.           02030000
       01  PASSWD                     PIC X(10)      VARYING.           02040000
       01  PC-APRVD-STAT-CDE          PIC X(02)      VALUE '40'.        02060000
       01  PC-PROCESS-STAT-CDE        PIC X(02)      VALUE '60'.        02070000
       01  PV-AP045-FIELDS.                                             02080000
           05  PV-AP045-DOC-NBR       PIC X(16).                        02090000
           05  PV-AP045-DEPT-NBR      PIC X(03).                        02100000
       01  PV-DTETIME                 PIC X(19).                        02110000
       01  PV-TIMESTMP.                                                 02120000
           05  PV-DATE                PIC X(10).                        02130000
           05  PV-TIME                PIC X(09).                        02140000
                                                                        02150000
      ******************************************************            02160000
      * SET FIX COLUMN LENGTHS                             *            02170000
      ******************************************************            02180000
                                                                        02190000
           EXEC SQL                                                     02200000
                VAR PV-AP045-DOC-NBR            IS CHARF(16)            02210000
           END-EXEC.                                                    02220000
           EXEC SQL                                                     02230000
                VAR PV-AP045-DEPT-NBR           IS CHARF(03)            02240000
           END-EXEC.                                                    02250000
                                                                        02260000
      ******************************************************************02270000
      * COBOL DECLARATION FOR TABLE TDAALW                              02280000
      ******************************************************************02290000
           EXEC SQL                                                     02300000
               INCLUDE TDAALW                                           02310000
           END-EXEC.                                                    02320000
      ****************************************************************  02330000
      * RECORD LAYOUT FOR CONTROL CARD FILE.                            02340000
      ****************************************************************  02350000
       01  CC-CONTROL-CARD.                                             02360000
           05  CC-CTL-DTE                   PIC X(10).                  02370000
           05  CC-CTL-FILLER                PIC X(70).                  02380000
                                                                        02390000
           EXEC SQL END DECLARE SECTION END-EXEC.                       02400000
      *                                                                 02410000
      * ORA COMMUNICATION AREA                                          02420000
      *                                                                 02430000
        01       SQLCA.                                                 02440000
                 05  SQLCAID               PIC X(8).                    02450000
                 05  SQLCABC               PIC S9(9) COMPUTATIONAL.     02460000
                 05  SQLCODE               PIC S9(9) COMPUTATIONAL.     02470000
                 05  SQLERRM.                                           02480000
                     49 SQLERRML           PIC S9(4) COMPUTATIONAL.     02490000
                     49 SQLERRMC           PIC X(70).                   02500000
                 05  SQLERRP               PIC X(8).                    02510000
                 05  SQLERRD OCCURS 6 TIMES                             02520000
                                           PIC S9(9) COMPUTATIONAL.     02530000
                 05  SQLWARN.                                           02540000
                     10 SQLWARN0           PIC X(1).                    02550000
                     10 SQLWARN1           PIC X(1).                    02560000
                     10 SQLWARN2           PIC X(1).                    02570000
                     10 SQLWARN3           PIC X(1).                    02580000
                     10 SQLWARN4           PIC X(1).                    02590000
                     10 SQLWARN5           PIC X(1).                    02600000
                     10 SQLWARN6           PIC X(1).                    02610000
                     10 SQLWARN7           PIC X(1).                    02620000
                 05  SQLEXT                PIC X(8).                    02630000
      ******************************************************************02640000
      * ORA COMMUNICATION AREA2                                         02650000
           COPY SQLCA2.                                                 02660000
                                                                        02670000
      ***************************************************************** 02680000
      *  ADJUSTMENT JOURNAL TRANSACTION RECORD LAYOUT                 * 02690000
      ***************************************************************** 02700000
           COPY APRD045.                                                02710000
      *- THESE FIELDS ARE NEEDED AT THE END OF EACH AP REC              02720000
           05  PV-APRD045-EXTRA-FIELDS.                                 02730000
               10 PV-APRD045-BATCH-NBR   PIC X(03).                     02740000
               10 PV-APRD045-CENPPC-NBR  PIC S9(07)   COMP-3.           02750000
               10 PV-APRD045-RTL-AMT     PIC S9(09)V99 COMP-3.          02760000
               10 PV-APRD045-NET-CST-AMT PIC S9(09)V99 COMP-3.          02770000
               10 PV-APRD045-EFF-DTE     PIC X(19).                     02780000
               10 FILLER                 PIC X(12).                     02790000
       01  AP045-PLUS-RECORD REDEFINES AP045-TRANSACTION-FILE.          02800000
0701RM*    05  FILLER                    PIC X(450).                    02810000
0701RM     05  FILLER                    PIC X(550).                    02820000
                                                                        02830000
       PROCEDURE DIVISION.                                              02840000
                                                                        02850000
      *----------------------------------------------------------------*02860000
      *    MAINLINE-LOGIC                                              *02870000
      *----------------------------------------------------------------*02880000
                                                                        02890000
       0000-DAKUP200.                                                   02900000
                                                                        02910000
           PERFORM 1000-INITIALIZATION.                                 02920000
                                                                        02930000
           PERFORM 2000-PROCESS-TDAALW                                  02940000
               UNTIL PS-EOF-INPUT-FILE.                                 02950000
                                                                        02960000
           PERFORM 9900-EOJ-LOGIC.                                      02970000
                                                                        02980000
           GOBACK.                                                      02990000
           EJECT                                                        03000000
      *----------------------------------------------------------------*03010000
      *    LOGON TO ORACLE, AND DECLARE THE ORACLE CURSORS.            *03020000
      *----------------------------------------------------------------*03030000
       1000-INITIALIZATION.                                             03040000
                                                                        03050000
           OPEN INPUT  IN-AP-FILE                                       03060000
8613F                  ORACLE-LOGIN-FILE                                03061028
                       CONTROL-CARD-FILE.                               03080000
           OPEN OUTPUT OUT-AP-FILE.                                     03090000
                                                                        03100000
           PERFORM 7000-READ-AP-INPUT-FILE.                             03120000
           PERFORM 7200-READ-CONTROL-CARD-FILE.                         03130000
                                                                        03140000
           IF END-OF-CONTROL-CARDS                                      03150000
               DISPLAY '** ABEND **'                                    03160000
               DISPLAY '** PROGRAM DAKUP200 **'                         03170000
               DISPLAY '** CONTROL CARD DATE EMPTY'                     03180000
               MOVE +4003 TO PV-ABEND-CODE                              03190000
               PERFORM 9998-ABEND                                       03200000
           ELSE                                                         03210000
               DISPLAY '** INPUT CONTROL CARD: ' CC-CONTROL-CARD        03220000
           END-IF.                                                      03230000
                                                                        03240000
           IF PS-EOF-INPUT-FILE                                         03250000
               CONTINUE                                                 03260000
           ELSE                                                         03270000
ORA            PERFORM 1001-CONNECT-TO-ORACLE                           03271020
           END-IF.                                                      03290000
                                                                        03300000
ORA   ******************************************************************03301018
 |    * LOGONS TO ORACLE.                                              *03302018
      ******************************************************************03303018
      *    - READ THE CONTROL CARD TO GET THE CREDENTIALS AND LOGON    *03304018
 |    *    - ORACLE                                                    *03305018
      *----------------------------------------------------------------*03306018
8613F  1001-CONNECT-TO-ORACLE.                                          03307028
8613F      DISPLAY '**********************************'.                03307128
8613F      DISPLAY '**------ BEGIN DAKUP200 ------**'.                  03307228
8613F      DISPLAY '**********************************'.                03307328
8613F                                                                   03308028
8613F      MOVE '1001-CONNECT-TO-ORACLE'   TO PV-PARAGRAPH-NAME.        03309028
8613F                                                                   03309128
8613F      READ ORACLE-LOGIN-FILE INTO CC-ORACLE-CONNECTION             03309228
8613F         AT END                                                    03309328
8613F            SET ORACLE-LOGIN-EOF      TO TRUE.                     03309428
8613F                                                                   03309528
8613F      IF CC-AUTO-LOGON                                             03309628
8613F         DISPLAY PC-PROGRAM-NAME ' - AUTO LOGON TO ORACLE'         03309728
8613F         EXEC SQL                                                  03309828
8613F              CONNECT :PC-AUTO-LOGON                               03309928
8613F         END-EXEC                                                  03310028
8613F      ELSE                                                         03310128
8613F         INITIALIZE PV-ORACLE-USERID-LEN                           03310228
8613F                    PV-ORACLE-PASSWORD-LEN                         03310328
8613F         INSPECT CC-ORACLE-USERID                                  03310428
8613F                 TALLYING PV-ORACLE-USERID-LEN                     03310528
8613F                 FOR CHARACTERS BEFORE INITIAL SPACE               03310628
8613F         INSPECT CC-ORACLE-PASSWORD                                03310728
8613F                 TALLYING PV-ORACLE-PASSWORD-LEN                   03310828
8613F                 FOR CHARACTERS BEFORE INITIAL SPACE               03310928
8613F         MOVE CC-ORACLE-USERID (1:PV-ORACLE-USERID-LEN)     TO     03311028
8613F                 USERNAME-ARR                                      03311128
8613F         MOVE PV-ORACLE-USERID-LEN    TO USERNAME-LEN              03311228
8613F         MOVE CC-ORACLE-PASSWORD (1:PV-ORACLE-PASSWORD-LEN) TO     03311328
8613F                 PASSWD-ARR                                        03311428
8613F         MOVE PV-ORACLE-PASSWORD-LEN  TO PASSWD-LEN                03311528
8613F         MOVE CC-ORACLE-PASSWORD (1:PV-ORACLE-PASSWORD-LEN) TO     03311628
8613F              PASSWD-ARR                                           03311728
8613F         MOVE PV-ORACLE-PASSWORD-LEN  TO PASSWD-LEN                03311828
8613F         MOVE CC-ORACLE-USERID (1:PV-ORACLE-USERID-LEN)     TO     03311928
8613F              USERNAME-ARR                                         03312028
8613F         MOVE PV-ORACLE-USERID-LEN    TO USERNAME-LEN              03312128
8613F         MOVE CC-ORACLE-PASSWORD (1:PV-ORACLE-PASSWORD-LEN) TO     03312228
8613F              PASSWD-ARR                                           03312328
8613F         MOVE PV-ORACLE-PASSWORD-LEN  TO PASSWD-LEN                03312428
8613F         DISPLAY PC-PROGRAM-NAME  ' - LOGON TO ORACLE AS USER '    03312528
8613F              USERNAME-ARR                                         03312628
8613F         EXEC SQL                                                  03312728
8613F              CONNECT :USERNAME IDENTIFIED BY :PASSWD              03312828
8613F         END-EXEC                                                  03312928
8613F         INITIALIZE CC-ORACLE-PASSWORD                             03313028
8613F                    PASSWD                                         03313128
8613F      END-IF.                                                      03313228
8613F                                                                   03313328
8613F      IF (SQLCODE NOT = 0)                                         03313428
8613F          DISPLAY PV-PARAGRAPH-NAME                                03313528
8613F          PERFORM 9999-SQL-ERROR                                   03313628
8613F      END-IF.                                                      03314028
                                                                        03314121
           EXEC SQL                                                     03314221
               SELECT TO_CHAR(SYSDATE, 'YYYY-MM-DDHH24:MI:SS')          03314321
               INTO :PV-DTETIME                                         03314421
               FROM DUAL                                                03314521
           END-EXEC.                                                    03314621
                                                                        03314721
           DISPLAY 'PV-DTETIME '  PV-DTETIME.                           03314821
           MOVE PV-DTETIME     TO PV-TIMESTMP.                          03314921
           MOVE CC-CTL-DTE     TO PV-DATE.                              03315021
           DISPLAY 'PV-DATE '     PV-DATE.                              03315121
           DISPLAY 'PV-TIME '     PV-TIME.                              03315221
           MOVE PV-TIMESTMP    TO PV-DTETIME.                           03315321
           DISPLAY 'PV-DTETIME  ' PV-DTETIME.                           03315421
           DISPLAY '**********************************'.                03315521
ORA   *                                                                 03315618
                                                                        04210000
       EJECT                                                            04360000
      *----------------------------------------------------------------*04370000
      *    2000-PROCESS-TDAALW                                         *04380000
      *      THIS IS PERFORMED ONLY VIA THE 0000-MAINLINE-LOGIC        *04390000
      *      PURPOSE: READ AND PROCESS THE TDAALW INFO CURSOR          *04400000
      *----------------------------------------------------------------*04410000
       2000-PROCESS-TDAALW.                                             04420000
                                                                        04430000
      *-- ONLY WRITE OUT THE TRANSACTION BECAUSE THE "OTHER SIDE" (TRAN 04440000
      *-- CODE 19) WAS ALREADY PROCESSED.                               04450000
W30021     IF AP045-AP-TRN-CDE = '69' OR '87' OR '7D'                   04460000
CTLCHG         ADD AP045-RETL-AMT            TO PA-TOT-UPDT-RTL-AMT     04461010
CTLCHG         ADD AP045-NET-COST-AMT        TO PA-TOT-UPDT-CREDIT-AMT  04462010
               PERFORM 8200-WRITE-AP-TRANS-REC                          04470000
           ELSE                                                         04480000
               MOVE 'N'            TO PS-TDAALW-UPDATED-SW              04490000
               MOVE 1              TO PA-DEADLOCK-COUNT                 04500000
               MOVE AP045-DOC-NBR  TO PV-AP045-DOC-NBR                  04510000
               MOVE AP045-DEPT-NBR TO PV-AP045-DEPT-NBR                 04520000
               PERFORM 8000-SELECT-FOR-UPDATE                           04530000
                   UNTIL PS-TDAALW-UPDATED                              04540000
                      OR PA-DEADLOCK-COUNT > PC-MAX-DEADLOCKS           04550000
           END-IF.                                                      04560000
           PERFORM 7000-READ-AP-INPUT-FILE.                             04570000
                                                                        04580000
           EJECT                                                        04590000
                                                                        04600000
      *----------------------------------------------------------------*04610000
      *  READ INPUT FILE                                                04620000
      *----------------------------------------------------------------*04630000
       7000-READ-AP-INPUT-FILE.                                         04640000
                                                                        04650000
           READ IN-AP-FILE INTO AP045-TRANSACTION-FILE                  04660000
               AT END SET PS-EOF-INPUT-FILE TO TRUE.                    04670000
                                                                        04680000
           IF PS-EOF-INPUT-FILE                                         04690000
               CONTINUE                                                 04700000
           ELSE                                                         04710000
               ADD 1                     TO PA-RECORDS-READ             04720000
               IF AP045-CONTROL-RECORD                                  04730000
                   SET PS-EOF-INPUT-FILE TO TRUE                        04740003
CTLCHG*        ELSE                                                     04750003
CTLCHG*            ADD AP045-RETL-AMT     TO PA-TOT-UPDT-RTL-AMT        04760003
CTLCHG*            ADD AP045-NET-COST-AMT TO PA-TOT-UPDT-CREDIT-AMT     04770003
               END-IF                                                   04780003
           END-IF.                                                      04790000
                                                                        04800000
      *----------------------------------------------------------------*04810000
      *  READ CONTROL CARD FILE                                        *04820000
      *----------------------------------------------------------------*04830000
       7200-READ-CONTROL-CARD-FILE.                                     04840000
                                                                        04850000
           READ CONTROL-CARD-FILE INTO CC-CONTROL-CARD                  04860000
               AT END SET END-OF-CONTROL-CARDS TO TRUE.                 04870000
                                                                        04880000
      *----------------------------------------------------------------*04890000
      *    UPDATE TDAALW INFORMATION                                   *04900000
      *----------------------------------------------------------------*04910000
       8000-SELECT-FOR-UPDATE.                                          04920000
                                                                        04930000
           MOVE '8000-SELECT-FOR UPDATE' TO PV-PARAGRAPH-NAME.          04940000
                                                                        04950000
           EXEC SQL                                                     04960000
             SELECT DR_ALW_NBR                                          04970000
                  , STAT_CDE                                            04980000
S30328            , TO_CHAR(CPLT_DTE,'YYYY-MM-DD.HH24.MI.SS')           04990000
                  , DEPT_NBR                                            05000000
22405        INTO :DAALW-DR-ALW-NBR :PV-DR-ALW-NBR                      05010000
22405            ,:DAALW-STAT-CDE   :PV-STAT-CDE                        05020000
22405            ,:DAALW-CPLT-DTE   :PV-CPLT-DTE                        05030000
22405            ,:DAALW-DEPT-NBR   :PV-DEPT-NBR                        05040000
             FROM TDAALW                                                05050000
             WHERE DR_ALW_NBR = :PV-AP045-DOC-NBR                       05060000
APRD45****     AND DEPT_NBR   = :PV-AP045-DEPT-NBR                      05070001
               AND STAT_CDE   = :PC-APRVD-STAT-CDE                      05080015
             FOR UPDATE NOWAIT                                          05090000
           END-EXEC.                                                    05100000
                                                                        05110000
           EVALUATE TRUE                                                05120000
             WHEN SQLCODE = 0                                           05130000
               PERFORM 8100-UPDATE-TDAALW                               05140000
             WHEN SQLCODE = -54                                         05150000
               ADD +1                        TO PA-DEADLOCK-COUNT       05160015
               DISPLAY 'DEADLOCK ORA-00054 8000-UPDATE-TDAALW'          05170000
               IF PA-DEADLOCK-COUNT > PC-MAX-DEADLOCKS                  05180000
                   MOVE +4092                TO PV-RETURN-CODE          05190000
                   MOVE '8000-UPDATE-TDAALW' TO PV-PARAGRAPH-NAME       05200000
                   DISPLAY 'DEADLOCK COUNT EXCEEDED - BYPASSING REC'    05210000
                   DISPLAY 'AP TRANS REC ' AP045-TRANSACTION-FILE       05220000
                   MOVE  PE-MSG-01   TO PV-OPERATION-ATTEMPTED          05230000
               END-IF                                                   05240000
             WHEN OTHER                                                 05250000
               DISPLAY PV-PARAGRAPH-NAME                                05260000
22405          DISPLAY '**'                                             05270000
22405          DISPLAY 'DOCUMENT NUMBER: ', PV-AP045-DOC-NBR            05280000
22405          DISPLAY 'DEPT: ', PV-AP045-DEPT-NBR                      05290000
22405          DISPLAY 'STATUS CODE: ', PC-APRVD-STAT-CDE               05300000
22405          DISPLAY '**'                                             05310000
               PERFORM 9999-SQL-ERROR                                   05320000
           END-EVALUATE.                                                05330000
                                                                        05340000
       8100-UPDATE-TDAALW.                                              05350000
                                                                        05360000
           MOVE '8100-UPDATE-TDAALW' TO PV-PARAGRAPH-NAME.              05370000
                                                                        05380000
           EXEC SQL                                                     05390015
             UPDATE TDAALW                                              05400015
                SET STAT_CDE   = :PC-PROCESS-STAT-CDE                   05410015
S30328*           , CPLT_DTE   = :PV-DTETIME                            05420015
S30328            , CPLT_DTE   =                                        05430015
S30328              TO_DATE(:PV-DTETIME,'YYYY-MM-DD.HH24.MI.SS')        05440015
             WHERE  DR_ALW_NBR = :PV-AP045-DOC-NBR                      05450015
APRD45***      AND DEPT_NBR    = :PV-AP045-DEPT-NBR                     05460001
APRD45         AND DEPT_NBR    = :DAALW-DEPT-NBR                        05470015
               AND STAT_CDE    = :PC-APRVD-STAT-CDE                     05480015
           END-EXEC.                                                    05490015
                                                                        05500000
           EVALUATE TRUE                                                05510000
             WHEN SQLCODE = 0                                           05520000
               ADD 1                         TO PA-ROWS-UPDATED         05530000
                                                PA-DA-ROWS-UPDATED      05540000
CTLCHG         ADD AP045-RETL-AMT            TO PA-TOT-UPDT-RTL-AMT     05541009
CTLCHG         ADD AP045-NET-COST-AMT        TO PA-TOT-UPDT-CREDIT-AMT  05542009
               IF PA-DA-ROWS-UPDATED > PC-COMMIT-COUNT                  05550000
                   PERFORM 9000-COMMIT-CHANGES                          05560000
                   MOVE 0 TO PA-DA-ROWS-UPDATED                         05570000
               END-IF                                                   05580000
               PERFORM 8200-WRITE-AP-TRANS-REC                          05590000
               SET PS-TDAALW-UPDATED         TO TRUE                    05600000
             WHEN OTHER                                                 05610000
               DISPLAY PV-PARAGRAPH-NAME                                05620000
22405          DISPLAY '**'                                             05630000
22405          DISPLAY 'DOCUMENT NUMBER: ', PV-AP045-DOC-NBR            05640000
22405          DISPLAY 'DEPT: ', PV-AP045-DEPT-NBR                      05650000
22405          DISPLAY 'STATUS CODE: ', PC-APRVD-STAT-CDE               05660000
22405          DISPLAY '**'                                             05670000
               PERFORM 9999-SQL-ERROR                                   05680000
           END-EVALUATE.                                                05690000
                                                                        05700000
                                                                        05710000
      *----------------------------------------------------------------*05720000
      *    8200-WRITE-AP-TRANS-REC                                     *05730000
      *      PURPOSE: WRITE VALID AP RECORDS TO OUTPUT FILE            *05740000
      *----------------------------------------------------------------*05750000
       8200-WRITE-AP-TRANS-REC.                                         05760000
           WRITE AP-TRANSACTION-RECORD                                  05770000
               FROM AP045-PLUS-RECORD.                                  05780000
           ADD 1                            TO PA-AP-TOTAL-WRITTEN.     05790000
                                                                        05800000
      *----------------------------------------------------------------*05810000
      *    COMMIT-CHANGES.                                             *05820000
      *      THIS IS PERFORMED ONLY VIA THE 0000-MAINLINE-ROUTINE      *05830000
      *      PURPOSE: COMMIT CHANGES TO THE TDAALW  TABLE              *05840000
      *----------------------------------------------------------------*05850000
       9000-COMMIT-CHANGES.                                             05860000
                                                                        05870000
0401RM*-- ELIMINATED "RELEASE" FROM THE COMMIT                          05880000
                                                                        05890000
           EXEC SQL                                                     05900015
             COMMIT                                                     05910015
           END-EXEC.                                                    05920015
                                                                        05930000
           EJECT                                                        05940000
                                                                        05950000
      *----------------------------------------------------------------*06070000
      *    9900-EOJ-LOGIC.                                             *06080000
      *      THIS IS PERFORMED AT END OF INPUT FILE.                   *06090000
      *      PURPOSE: CLOSE INPUT FILE, COMMIT CHANGES AND DISPLAY     *06100000
      *      RECORD COUNTS.                                            *06110000
      *----------------------------------------------------------------*06120000
       9900-EOJ-LOGIC.                                                  06130000
           DISPLAY '9990-EOJ  PV-RETURN-CODE    ' PV-RETURN-CODE        06140000
           IF PA-AP-TOTAL-WRITTEN > 0                                   06150000
               PERFORM 9910-CREATE-CONTROL-RECORD                       06160000
           END-IF.                                                      06170000
                                                                        06180000
           PERFORM 9000-COMMIT-CHANGES.                                 06190000
                                                                        06200000
           CLOSE IN-AP-FILE                                             06210000
                 CONTROL-CARD-FILE                                      06220000
                 OUT-AP-FILE.                                           06240000
                                                                        06250000
           IF PV-RETURN-CODE = 0                                        06260000
               CONTINUE                                                 06270000
           ELSE                                                         06280000
               MOVE PV-RETURN-CODE TO RETURN-CODE                       06290000
           END-IF.                                                      06300000
                                                                        06310000
           DISPLAY 'RECORDS READ    ' PA-RECORDS-READ.                  06320000
           DISPLAY 'ROWS UPDATED    ' PA-ROWS-UPDATED.                  06330000
           DISPLAY 'RECORDS WRITTEN ' PA-AP-TOTAL-WRITTEN.              06340000
           DISPLAY '**------ END DAKUP200 ------**'.                    06350000
                                                                        06360000
                                                                        06370000
      *----------------------------------------------------------------*06380000
      *    9910-CREATE-CONTROL-RECORD                                  *06390000
      *      THIS IS PERFORMED ONLY VIA THE 9900-EOJ-LOGIC             *06400000
      *      PURPOSE: THIS IS PERFORMED TO CREATE A CONTROL RECORD     *06410000
      *      FOR AP CONTAINS TOTAL AMOUNTS.                            *06420000
      *----------------------------------------------------------------*06430000
       9910-CREATE-CONTROL-RECORD.                                      06440000
                                                                        06450000
           INITIALIZE AP045-KEY-FIELDS                                  06460000
                      AP045-HEADER-FIELDS                               06470000
                      AP045-COMMON-FIELDS                               06480000
                      AP045-CONTROL-FIELDS                              06490000
                      PV-APRD045-EXTRA-FIELDS.                          06500000
                                                                        06510000
           MOVE ZEROES                 TO AP045-ENT-ID.                 06520000
           MOVE PC-REC-TYPE-CDE-9      TO AP045-RECD-TYP-CDE.           06530000
           MOVE PA-AP-TOTAL-WRITTEN    TO AP045-CTL-RECORD-COUNT.       06540000
           MOVE PA-TOT-UPDT-RTL-AMT    TO AP045-CTL-RETL-AMT.           06550000
           MOVE PA-TOT-UPDT-CREDIT-AMT TO AP045-CTL-GRO-COST-AMT        06560000
                                          AP045-CTL-NET-COST-AMT.       06570000
           PERFORM 8200-WRITE-AP-TRANS-REC.                             06580000
                                                                        06590000
                                                                        06600000
      *----------------------------------------------------------------*06610000
      * PROGRAM ABEND PARAGRAPH                                         06620000
      *----------------------------------------------------------------*06630000
       9998-ABEND.                                                      06640000
                                                                        06650000
           CALL 'ILBOABN0'  USING PV-ABEND-CODE.                        06660000
                                                                        06670000
      *----------------------------------------------------------------*06680000
      * 9999-SQL-ERROR DISPLAYS ERRORS ENCOUNTERED ON UPDATE OF ROW     06690000
      *----------------------------------------------------------------*06700000
       9999-SQL-ERROR.                                                  06710000
                                                                        06720000
           MOVE SQLCODE    TO SQLCODE2.                                 06730000
           MOVE SQLERRD(3) TO SQLERRD3.                                 06740000
           DISPLAY '** ABEND **       ** = SQLERROR'.                   06750000
           DISPLAY '** PROGRAM        ** = DAKUP200'.                   06760000
           DISPLAY '** SQLCODE        ** = ' SQLCODE2.                  06770000
           DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                  06780000
           DISPLAY '** SQLERRM        ** = ' SQLERRM.                   06790000
           DISPLAY '** SQLERRMC       ** = ' SQLERRMC.                  06800000
           DISPLAY '** SQLERRD(5)     ** = ' SQLERRD(5).                06810000
           DISPLAY '** OPERATION      ** = ' PV-OPERATION-ATTEMPTED.    06820000
                                                                        06830000
           MOVE SPACES TO WS-MSG-TEXT.                                  06840000
      *    GET FULL TEXT OF ERROR MESSAGE                               06850000
                                                                        06860000
           CALL 'SQLGLM' USING WS-MSG-TEXT,                             06870000
                               WS-MAX-SIZE,                             06880000
                               WS-MSG-LENGTH.                           06890000
           DISPLAY 'MESSAGE TEXT      ** = ' WS-MSG-TEXT.               06900000
                                                                        06910000
           EXEC SQL                                                     06920015
            ROLLBACK WORK RELEASE                                       06930015
           END-EXEC.                                                    06940015
                                                                        06950000
           MOVE +4013 TO PV-ABEND-CODE.                                 06960000
           CALL 'ILBOABN0' USING PV-ABEND-CODE.                         06970000
                                                                        06980000
      *---------------------------------------------------------------* 06990000
      *    END OF SOURCE CODE FOR DAKUP200                            * 07000000
      *---------------------------------------------------------------* 07010000
