000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.      APKUT241.                                       00020000
000300 AUTHOR.          NANCY EILBES.                                   00030000
000400 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00040000
000500 DATE-WRITTEN.    03/06/01.                                       00050000
000600 DATE-COMPILED.                                                   00060000
000700*----------------------------------------------------------------*00070000
000800*    COBOL II WITH SQL                                           *00080000
000900*                                                                *00090000
001000*    EXTRACT PO INFORMATION FOR NEW STORES                       *00100000
001100*                                                                *00110000
001200*  THIS PROGRAM READS A FILE THAT WAS CREATED USING AN UNLOAD    *00120000
001300*  UTILITY ON TABLE TMESTDS TO CAPTURE ALL PO/STORES FOR THE     *00130000
001400*  LOCATIONS THAT ARE CURRENTLY 'NEW' FOR THE PURPOSES OF THIS   *00140000
001500*  PROCESS.  FOR EACH OF THESE PO/STORES, THE PO IS CHECKED TO   *00150000
001600*  ENSURE THAT IT IS NOT FLAGGED AS A NEW STORE PO, AND THE      *00160000
001700*  CANCEL DATE FROM EACH IS COMPARED TO THE GRAND OPENING DATE   *00170000
001800*  TO ENSURE THAT IT FALLS WITHIN 60 DAYS OF THE GRAND OPENING.  *00180000
001900*                                                                *00190000
002000*  FOR EACH PO/STORE WHERE THE ABOVE IS TRUE, A RECORD WILL BE   *00200000
002100*  WRITTEN TO THE EXTRACT FILE.  THIS FILE WILL BE USED TO LOAD  *00210000
002200*  THE AP NEW STORE DISCOUNT CONTROL TABLE (APTW_NW_STR_DISC).   *00220000
002300*                                                                *00230000
002400* DB2 TABLES:                                                    *00240000
002500*  1. PURCHASE ORDER HEADER            (TPURCHS)                 *00250000
002600*  2. PLAN SHIPMENT                    (TPLNSHP)                 *00260000
002700*  3. FI DOMAIN LOCATION TABLE         (XFT00017)                *00270000
002800*                                                                *00280000
002900* INPUT:                                                         *00290000
003000*  1. PO-STORE-FILE                                              *00300000
003100*                                                                *00310000
003200* OUTPUT:                                                        *00320000
003300*  1. PO-NW-STR-FILE                   (APRD088)                 *00330000
003400*----------------------------------------------------------------*00340000
003500* CHANGE LOG:                                                    *00350000
003600* DATE  07/01/2004                                               *00360000
003700*     CHANGE MADE: INITIAL VERSION.                              *00370000
003800*     MADE BY: NANCY EILBES            WR/IR #: WR26679          *00380000
003900*                                                                *00390000
004000* DATE  03/27/2007                                               *00400000
004100*     CHANGE MADE: RECOMPILE FROM PRODUCTION TO INCORPORATE      *00410000
004200*     CHANGES TO PS_XFT_LOC TABLE FOR STORE DEMOGRAPHICS.        *00420000
004300*     MADE BY: KEVIN CATLIN            WR/IR #: WR31452          *00430000
004400*                                                                *00440000
004500*                                                               * 00450000
004600*   DATE  08/02/2011                                            * 00460000
004700*   MODIFIED PROGRAM TO REFERENCE THE NEW DOMAIN TABLES IN DB2  * 00470000
004800*   AND NO LONGER REFERENCE THE DB3P TABLES DIRECTLY AS DB3P IS * 00480000
004900*   GOING AWAY.                                                   00490000
005000*      FI_XFT_LOC  --> XFT_LOC(XFT00017)                        * 00500000
005100*      MADE BY : ANIL (CTS)          WR/IR  #: W37038           * 00510000
005200*----------------------------------------------------------------*00520000
005300 ENVIRONMENT DIVISION.                                            00530000
005400 CONFIGURATION SECTION.                                           00540000
005500 SOURCE-COMPUTER. IBM-3090.                                       00550000
005600 OBJECT-COMPUTER. IBM-3090.                                       00560000
005700                                                                  00570000
005800 INPUT-OUTPUT SECTION.                                            00580000
005900 FILE-CONTROL.                                                    00590000
006000                                                                  00600000
006100     SELECT PO-FILE ASSIGN TO INP01.                              00610000
006200     SELECT NW-STR-PO-FILE ASSIGN TO OUT01.                       00620000
006300                                                                  00630000
006400 DATA DIVISION.                                                   00640000
006500 FILE SECTION.                                                    00650000
006600                                                                  00660000
006700 FD  PO-FILE                                                      00670000
006800     RECORDING MODE F                                             00680000
006900     LABEL RECORDS ARE STANDARD                                   00690000
007000     BLOCK CONTAINS 0 RECORDS                                     00700000
007100     DATA RECORD IS PO-REC.                                       00710000
007200 01  PO-REC                           PIC X(8).                   00720000
007300                                                                  00730000
007400 FD  NW-STR-PO-FILE                                               00740000
007500     RECORDING MODE F                                             00750000
007600     LABEL RECORDS ARE STANDARD                                   00760000
007700     DATA RECORD IS NW-STR-PO-REC.                                00770000
007800 01  NW-STR-PO-REC                    PIC X(32).                  00780000
007900                                                                  00790000
008000 WORKING-STORAGE SECTION.                                         00800000
008100                                                                  00810000
008200 01  PV-PROGRAM-VARIABLES.                                        00820000
008300     05  PV-HOLD-PO-NBR               PIC S9(9) COMP.             00830000
008400     05  PV-DEPT-NBR                  PIC S9(4) COMP.             00840000
008500     05  PV-GRND-OPN-PLUS-30          PIC X(10).                  00850000
008600     05  PV-GRND-OPN-PLUS-60          PIC X(10).                  00860000
008700     05  PV-CAN-DTE                   PIC X(10).                  00870000
008800     05  DISPLAY-PO-NBR               PIC ZZZZZZZZ9.              00880000
008900     05  DISPLAY-STR-NBR              PIC ZZZZ9.                  00890000
009000     05  PV-RECORDS-READ              PIC 9(09) VALUE ZERO.       00900000
009100     05  PV-RECORDS-WRITTEN           PIC 9(09) VALUE ZERO.       00910000
009200                                                                  00920000
009300 01  ABEND-CODE                       PIC S9(4) VALUE 0 COMP SYNC.00930000
009400     88  AC-DB2-ERROR                           VALUE +4013.      00940000
009500                                                                  00950000
009600 01  PS-PROGRAM-SWITCHES.                                         00960000
009700     05  PS-END-OF-PO-REC             PIC X(01)      VALUE 'N'.   00970000
009800         88  END-OF-PO-REC                           VALUE 'Y'.   00980000
009900     05  PS-VALID-PO-SW               PIC X(01)      VALUE 'N'.   00990000
010000         88  VALID-PO                                VALUE 'Y'.   01000000
010100         88  NOT-VALID-PO                            VALUE 'N'.   01010000
010200                                                                  01020000
010300 01  ABEND-AREAS.                                                 01030000
010400     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01040000
010500             '*****       ABEND'.                                 01050000
010600     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01060000
010700             '*****   PROGRAM: APKUT241'.                         01070000
010800     05  AA-PARAGRAPH-LIT.                                        01080000
010900         10  FILLER              PIC  X(17)  VALUE                01090000
011000             '***** PARAGRAPH: '.                                 01100000
011100         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01110000
011200     05  AA-MESSAGE-LINE.                                         01120000
011300         10  FILLER              PIC  X(06)  VALUE '*****'.       01130000
011400         10  AA-MESSAGE          PIC  X(127) VALUE SPACES.        01140000
011500     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01150000
011600             '*****    DB2 ERROR'.                                01160000
011700     05  AA-DB2-OPERATION-LIT.                                    01170000
011800         10  FILLER              PIC  X(17)  VALUE                01180000
011900             '***** OPERATION: '.                                 01190000
012000         10  AA-DB2-OPERATION.                                    01200000
012100             15  AA-DB2-OP-1     PIC  X(50)  VALUE SPACES.        01210000
012200             15  AA-DB2-OP-2     PIC  X(25)  VALUE SPACES.        01220000
012300     05  AA-DB2-TABLE-1          PIC  X(08)  VALUE SPACES.        01230000
012400     05  AA-DB2-TABLE-2          PIC  X(08)  VALUE SPACES.        01240000
012500     05  AA-DB2-TABLE-3          PIC  X(08)  VALUE SPACES.        01250000
012600     05  AA-DB2-TABLE-4          PIC  X(08)  VALUE SPACES.        01260000
012700     05  AA-DB2-TABLE-5          PIC  X(08)  VALUE SPACES.        01270000
012800                                                                  01280000
012900     COPY DPWS004.                                                01290000
013000                                                                  01300000
013100*----------------------------------------------------------------*01310000
013200*    LAYOUT OF THE INPUT PO FILE..                                01320000
013300*----------------------------------------------------------------*01330000
013400 01 WS-PO-REC.                                                    01340000
013500     05  WS-PO-NBR                    PIC S9(9) COMP.             01350000
013600     05  WS-STR-NBR                   PIC S9(4) COMP.             01360000
013700                                                                  01370000
013800*----------------------------------------------------------------*01380000
013900*    LAYOUT OF THE OUTPUT NEW STORE PO DATA FILE.                 01390000
014000*----------------------------------------------------------------*01400000
014100                                                                  01410000
014200     COPY APRD088.                                                01420000
014300                                                                  01430000
014400*----------------------------------------------------------------*01440000
014500* PURCHASE ORDER HEADER TABLE.                                    01450000
014600*----------------------------------------------------------------*01460000
014700     EXEC SQL                                                     01470000
014800         INCLUDE TPURCHS                                          01480000
014900     END-EXEC.                                                    01490000
015000                                                                  01500000
015100*----------------------------------------------------------------*01510000
015200* PLAN SHIPMENT TABLE.                                            01520000
015300*----------------------------------------------------------------*01530000
015400     EXEC SQL                                                     01540000
015500         INCLUDE TPLNSHP                                          01550000
015600     END-EXEC.                                                    01560000
015700                                                                  01570000
015800*----------------------------------------------------------------*01580000
015900*    XFT_LOC TABLE                                                01590000
016000*----------------------------------------------------------------*01600000
016100     EXEC SQL                                                     01610000
016200        INCLUDE XFT00017                                          01620000
016300     END-EXEC.                                                    01630000
016400                                                                  01640000
016500 EJECT                                                            01650000
016600*----------------------------------------------------------------*01660000
016700* DB2 COMMUNICATION AREA                                          01670000
016800*----------------------------------------------------------------*01680000
016900     EXEC SQL                                                     01690000
017000         INCLUDE SQLCA                                            01700000
017100     END-EXEC.                                                    01710000
017200 EJECT                                                            01720000
017300*----------------------------------------------------------------*01730000
017400* DB2 COMMUNICATION AREA2                                         01740000
017500*----------------------------------------------------------------*01750000
017600     COPY SQLCA2.                                                 01760000
017700 EJECT                                                            01770000
017800 PROCEDURE DIVISION.                                              01780000
017900                                                                  01790000
018000 A100-PROGRAM-MAINLINE.                                           01800000
018100                                                                  01810000
018200     PERFORM B100-INITIALIZATION.                                 01820000
018300                                                                  01830000
018400     PERFORM B200-PROCESS-PO-STORE                                01840000
018500       UNTIL END-OF-PO-REC.                                       01850000
018600                                                                  01860000
018700     PERFORM B300-END-ROUTINE.                                    01870000
018800                                                                  01880000
018900     GOBACK.                                                      01890000
019000                                                                  01900000
019100 EJECT                                                            01910000
019200*----------------------------------------------------------------*01920000
019300* B100-INITIALIZATION OPENS ALL FILES AND PERFORMS INITIAL READ. *01930000
019400*----------------------------------------------------------------*01940000
019500 B100-INITIALIZATION.                                             01950000
019600                                                                  01960000
019700     OPEN INPUT  PO-FILE                                          01970000
019800          OUTPUT NW-STR-PO-FILE.                                  01980000
019900                                                                  01990000
020000     INITIALIZE  AP088-NW-STR-EXTRACT                             02000000
020100                 DCLTPURCHS                                       02010000
020200                 DCLTPLNSHP                                       02020000
020300                 DCLXFT00017.                                     02030000
020400                                                                  02040000
020500     PERFORM R100-READ-INPUT-FILE.                                02050000
020600                                                                  02060000
020700     IF  END-OF-PO-REC                                            02070000
020800         DISPLAY 'NO RECORDS IN INPUT FILE'                       02080000
020900     ELSE                                                         02090000
021000         PERFORM S100-GET-PO-DATA                                 02100000
021100         MOVE WS-PO-NBR TO PV-HOLD-PO-NBR                         02110000
021200     END-IF.                                                      02120000
021300                                                                  02130000
021400*----------------------------------------------------------------*02140000
021500* B200-CHECK TO SEE IF CURRENT PO/STORE SHOULD BE PROCESSED       02150000
021600*----------------------------------------------------------------*02160000
021700 B200-PROCESS-PO-STORE.                                           02170000
021800                                                                  02180000
021900     IF  WS-PO-NBR = PV-HOLD-PO-NBR                               02190000
022000         IF  VALID-PO                                             02200000
022100             PERFORM S200-GET-STORE-DATA                          02210000
022200             IF  PV-CAN-DTE < PV-GRND-OPN-PLUS-60                 02220000
022300             AND PURCHS-ORD-DTE < PV-GRND-OPN-PLUS-30             02230000
022400                 PERFORM C100-BUILD-NW-STR-PO                     02240000
022500             END-IF                                               02250000
022600             PERFORM R100-READ-INPUT-FILE                         02260000
022700         ELSE                                                     02270000
022800             PERFORM R100-READ-INPUT-FILE                         02280000
022900         END-IF                                                   02290000
023000     ELSE                                                         02300000
023100         PERFORM S100-GET-PO-DATA                                 02310000
023200         MOVE WS-PO-NBR TO PV-HOLD-PO-NBR                         02320000
023300     END-IF.                                                      02330000
023400                                                                  02340000
023500*----------------------------------------------------------------*02350000
023600* END OF PROGRAM - CLOSE FILES AND DISPLAY COUNTS.               *02360000
023700*----------------------------------------------------------------*02370000
023800 B300-END-ROUTINE.                                                02380000
023900                                                                  02390000
024000     CLOSE PO-FILE                                                02400000
024100           NW-STR-PO-FILE.                                        02410000
024200                                                                  02420000
024300     DISPLAY '*--------- PROGRAM APKUT241 COMPLETE --------*'.    02430000
024400     DISPLAY '*  RECORDS READ = ' PV-RECORDS-READ.                02440000
024500     DISPLAY '*  RECORDS WRITTEN = ' PV-RECORDS-WRITTEN.          02450000
024600     DISPLAY '*--------------------------------------------*'.    02460000
024700 EJECT                                                            02470000
024800*----------------------------------------------------------------*02480000
024900* MOVE APPROPRIATE FIELDS TO THE OUTPUT RECORD.                  *02490000
025000*----------------------------------------------------------------*02500000
025100 C100-BUILD-NW-STR-PO.                                            02510000
025200                                                                  02520000
025300     MOVE WS-PO-NBR             TO AP088-PO-NBR.                  02530000
025400     MOVE WS-STR-NBR            TO AP088-LOC-NBR.                 02540000
025500     MOVE XFT00017-GRND-OPN-DTE TO AP088-GRND-OPN-DTE.            02550000
025600     MOVE PURCHS-ENT-ID         TO AP088-ENT-ID.                  02560000
025700     MOVE PV-DEPT-NBR           TO AP088-DEPT-NBR.                02570000
025800     MOVE PV-CAN-DTE            TO AP088-CNCL-DTE.                02580000
025900     PERFORM W100-WRITE-NW-STR-PO-RECORD.                         02590000
026000 EJECT                                                            02600000
026100*----------------------------------------------------------------*02610000
026200* SELECT THE CANCEL DATE, EXTENDED CANCEL DATE, ENT-ID AND DEPT   02620000
026300* FROM THE PO TABLES.                                             02630000
026400*----------------------------------------------------------------*02640000
026500 S100-GET-PO-DATA.                                                02650000
026600                                                                  02660000
026700     SET NOT-VALID-PO TO TRUE.                                    02670000
026800     MOVE 'S100-GET-PO-DATA' TO AA-PARAGRAPH-NAME.                02680000
026900                                                                  02690000
027000     EXEC SQL                                                     02700000
027100          SELECT A.CAN_IFNOT_SHIP_DTE                             02710000
027200               , SMALLINT(B.DEPT_NBR)                             02720000
027300               , B.ENT_ID                                         02730000
027400               , A.EXT_CAN_DTE                                    02740000
027500               , B.ORD_DTE                                        02750000
027600            INTO :PLNSHP-CAN-IFNOT-SHIP-DTE                       02760000
027700               , :PV-DEPT-NBR                                     02770000
027800               , :PURCHS-ENT-ID                                   02780000
027900               , :PLNSHP-EXT-CAN-DTE                              02790000
028000               , :PURCHS-ORD-DTE                                  02800000
028100            FROM TPLNSHP A                                        02810000
028200               , TPURCHS B                                        02820000
028300           WHERE A.PO_NBR = :WS-PO-NBR                            02830000
028400             AND A.PO_NBR = B.PO_NBR                              02840000
028500             AND A.VER_STATUS_CDE = 'A'                           02850000
028600             AND B.VER_STATUS_CDE = 'A'                           02860000
028700             AND B.NEW_STR_PO_IND = 'N'                           02870000
028800             AND B.STATUS_CDE IN ('AC','AP','CA','CM')            02880000
028900             AND B.PO_TYP_CDE NOT IN ('IM','IF','IE','AP')        02890000
029000          WITH UR                                                 02900000
029100     END-EXEC.                                                    02910000
029200                                                                  02920000
029300     EVALUATE TRUE                                                02930000
029400         WHEN SQLCODE = ZEROS                                     02940000
029500             SET VALID-PO TO TRUE                                 02950000
029600             IF  PLNSHP-EXT-CAN-DTE = '0001-01-01'                02960000
029700                 MOVE PLNSHP-CAN-IFNOT-SHIP-DTE TO PV-CAN-DTE     02970000
029800             ELSE                                                 02980000
029900                 MOVE PLNSHP-EXT-CAN-DTE        TO PV-CAN-DTE     02990000
030000             END-IF                                               03000000
030100         WHEN SQLCODE = +100                                      03010000
030200             SET NOT-VALID-PO TO TRUE                             03020000
030300         WHEN SQLWARN0 NOT = SPACES                               03030000
030400         WHEN SQLCODE  NOT = ZERO                                 03040000
030500             MOVE 'UNSUCCESSFUL SELECT ' TO AA-DB2-OP-1           03050000
030600             MOVE 'TPURCHS '             TO AA-DB2-TABLE-1        03060000
030700             MOVE 'TPLNSHP '             TO AA-DB2-TABLE-2        03070000
030800             PERFORM Z998-DB2-ABEND                               03080000
030900     END-EVALUATE.                                                03090000
031000 EJECT                                                            03100000
031100*----------------------------------------------------------------*03110000
031200* SELECT THE GRAND OPENING DATE AND GRAND OPEN DATE PLUS 60 DAYS  03120000
031300* FROM THE XFT LOCATION TABLE.                                    03130000
031400*----------------------------------------------------------------*03140000
031500 S200-GET-STORE-DATA.                                             03150000
031600                                                                  03160000
031700     MOVE 'S200-GET-STORE-DATA' TO AA-PARAGRAPH-NAME.             03170000
031800                                                                  03180000
031900     EXEC SQL                                                     03190000
032000         SELECT GRND_OPN_DTE                                      03200000
032100              , GRND_OPN_DTE + 30 DAYS                            03210000
032200              , GRND_OPN_DTE + 60 DAYS                            03220000
032300           INTO :XFT00017-GRND-OPN-DTE                            03230000
032400              , :PV-GRND-OPN-PLUS-30                              03240000
032500              , :PV-GRND-OPN-PLUS-60                              03250000
032600           FROM XFT_LOC                                           03260000
032700          WHERE LOC_NBR = :WS-STR-NBR                             03270000
032800     END-EXEC.                                                    03280000
032900                                                                  03290000
033000     EVALUATE TRUE                                                03300000
033100       WHEN SQLCODE = ZEROS                                       03310000
033200            CONTINUE                                              03320000
033300         WHEN SQLWARN0 NOT = SPACES                               03330000
033400         WHEN SQLCODE  NOT = ZERO                                 03340000
033500             MOVE 'UNSUCCESSFUL SELECT ' TO AA-DB2-OP-1           03350000
033600             MOVE 'XFT00017'             TO AA-DB2-TABLE-1        03360000
033700             PERFORM Z998-DB2-ABEND                               03370000
033800     END-EVALUATE.                                                03380000
033900                                                                  03390000
034000****************************************************************  03400000
034100* R100-READ-INPUT-FILE                                            03410000
034200****************************************************************  03420000
034300 R100-READ-INPUT-FILE.                                            03430000
034400                                                                  03440000
034500     READ PO-FILE INTO WS-PO-REC                                  03450000
034600       AT END SET END-OF-PO-REC TO TRUE.                          03460000
034700                                                                  03470000
034800     IF  END-OF-PO-REC                                            03480000
034900         CONTINUE                                                 03490000
035000     ELSE                                                         03500000
035100         ADD +1 TO PV-RECORDS-READ                                03510000
035200     END-IF.                                                      03520000
035300                                                                  03530000
035400*----------------------------------------------------------------*03540000
035500* WRITE OUTPUT RECORD                                             03550000
035600*----------------------------------------------------------------*03560000
035700 W100-WRITE-NW-STR-PO-RECORD.                                     03570000
035800                                                                  03580000
035900     WRITE NW-STR-PO-REC FROM AP088-NW-STR-EXTRACT.               03590000
036000     ADD +1 TO PV-RECORDS-WRITTEN.                                03600000
036100                                                                  03610000
036200******************************************************************03620000
036300*     SQL WARNING OR ERROR PROCESSING                            *03630000
036400*                                                                *03640000
036500******************************************************************03650000
036600                                                                  03660000
036700 Z998-DB2-ABEND.                                                  03670000
036800                                                                  03680000
036900     MOVE WS-PO-NBR  TO DISPLAY-PO-NBR.                           03690000
037000     MOVE WS-STR-NBR TO DISPLAY-STR-NBR.                          03700000
037100                                                                  03710000
037200     DISPLAY 'PO BEING PROCESSED = '    DISPLAY-PO-NBR.           03720000
037300     DISPLAY 'STORE BEING PROCESSED = ' DISPLAY-STR-NBR.          03730000
037400     DISPLAY AA-ABEND-LIT.                                        03740000
037500     DISPLAY AA-DB2-ERROR-LIT.                                    03750000
037600     DISPLAY AA-PROGRAM-LIT.                                      03760000
037700     DISPLAY AA-PARAGRAPH-LIT.                                    03770000
037800     DISPLAY AA-DB2-OPERATION-LIT.                                03780000
037900     DISPLAY AA-DB2-TABLE-1.                                      03790000
038000     DISPLAY AA-DB2-TABLE-2.                                      03800000
038100     SET AC-DB2-ERROR TO TRUE.                                    03810000
038200                                                                  03820000
038300     COPY DPPD004.                                                03830000
038400                                                                  03840000
038500     CALL 'ILBOABN0' USING ABEND-CODE.                            03850000
