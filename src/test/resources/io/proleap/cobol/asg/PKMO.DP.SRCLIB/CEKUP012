000100 IDENTIFICATION DIVISION.                                                 
000200 PROGRAM-ID.    CEKUP012.                                                 
000300 AUTHOR.        TKMA479.                                                  
000400 DATE-WRITTEN.  02/00.                                                    
000500****************************************************************          
000600*                                                                         
000700* 01/09/2020  JEAN KURK                                                   
000700*             RENAMED FROM WMKUT012 TO CEKUP012                           
000800****************************************************************          
000900 ENVIRONMENT DIVISION.                                                    
001000 DATA DIVISION.                                                           
001100 WORKING-STORAGE SECTION.                                                 
001200                                                                          
001300 01  PV-ABEND-CODE                    PIC S9(04)   VALUE +0               
001400                                                   COMP SYNC.             
001500                                                                          
001600 01  PS-PROGRAM-SWITCHES.                                                 
001700     05  PS-PO-CSR-SW                 PIC X(01)  VALUE 'N'.               
001800         88  PS-END-PO-CSR                       VALUE 'Y'.               
001900         88  PS-NOT-END-PO-CSR                   VALUE 'N'.               
002000                                                                          
002100 01  PV-PROGRAM-VARIABLES.                                                
002400     05  PV-RETRY-COUNT               PIC S9(04)  VALUE +0                
002500                                                  COMP SYNC.              
002600     05  PV-PARAGRAPH-NAME            PIC  X(30)  VALUE SPACES.           
002700     05  PV-ERROR-MESSAGE-1           PIC  X(60)  VALUE SPACES.           
002800     05  PV-ERROR-MESSAGE-2           PIC  X(60)  VALUE SPACES.           
002900     05  PV-SQLCODE                   PIC 9(9)  VALUE ZERO.               
003000     05  PV-COUNT                     PIC 9(7)  VALUE ZERO.               
003001     05  PV-COUNT1                    PIC 9(7)  VALUE ZERO.               
003010     05  PV-COUNT2                    PIC 9(7)  VALUE ZERO.               
003100                                                                          
003200 01  PC-PROGRAM-CONSTANTS.                                                
003300     05  PC-PROGRAM-NAME              PIC X(08)  VALUE 'CEKUP012'.        
003400     05  PC-MAX-RETRIES               PIC S9(04) VALUE +3                 
003500                                                 COMP SYNC.               
003600 01  PV-ABEND-FIELDS.                                                     
003700     05  PV-ABEND-PROGRAM             PIC X(8)   VALUE 'CEKUP012'.        
003800     05  PV-ABEND-PARAGRAPH           PIC X(50)  VALUE SPACES.            
003900     05  PV-ABEND-OPERATION           PIC X(50)  VALUE SPACES.            
004000     05  PV-ABEND-STRUCTURE-1         PIC X(8)   VALUE SPACES.            
004100     05  PV-ABEND-STRUCTURE-2         PIC X(8)   VALUE SPACES.            
004200     05  PV-ABEND-STRUCTURE-3         PIC X(8)   VALUE SPACES.            
004300     05  PV-ABEND-STATUS              PIC XX     VALUE SPACES.            
004400     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.            
004500     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.            
004600     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.            
004700     05  PV-DB2-OPERATION-MESSAGE-4   PIC  X(79) VALUE SPACES.            
004800                                                                          
005200     COPY DPWS004.                                                        
005400                                                                          
005600     EXEC SQL                                                             
005700          INCLUDE SQLCA                                                   
005800     END-EXEC.                                                            
005900                                                                          
006000     EXEC SQL                                                             
006100          INCLUDE TKRPRPM                                                 
006200     END-EXEC.                                                            
006300                                                                          
006310     EXEC SQL                                                             
006320          INCLUDE TPOSYNC                                                 
006330     END-EXEC.                                                            
006340                                                                          
006310     EXEC SQL                                                             
006800          INCLUDE TPURCHS                                                 
006900     END-EXEC.                                                            
                                                                                
007300     EXEC SQL                                                             
007400          DECLARE PO-CSR CURSOR FOR                                       
007500           SELECT PO_NBR                                                  
007600             FROM TPOSYNC                                                 
007700     END-EXEC.                                                            
007800                                                                          
007900 PROCEDURE DIVISION.                                                      
008000                                                                          
008100     PERFORM 1000-INIT.                                                   
008200                                                                          
008300     PERFORM 2000-PROCESS-EXTRACT.                                        
008400                                                                          
008500     PERFORM 9000-TERMINATE.                                              
008600                                                                          
008700     GOBACK.                                                              
008800                                                                          
008900 1000-INIT.                                                               
009000                                                                          
009010     PERFORM 7300-FIND-DELETE-DAYS.                                       
009020                                                                          
013100 2000-PROCESS-EXTRACT.                                                    
013200                                                                          
013300     PERFORM 7000-OPEN-PO-CSR-CURSOR.                                     
013400     PERFORM 7100-FETCH-PO-CSR-CURSOR                                     
013500        UNTIL PS-END-PO-CSR.                                              
013600     PERFORM 7200-CLOSE-PO-CSR-CURSOR.                                    
013700                                                                          
013800 7000-OPEN-PO-CSR-CURSOR.                                                 
013900     PERFORM                                                              
014000         WITH TEST AFTER                                                  
014100         VARYING PV-RETRY-COUNT                                           
014200         FROM 1 BY 1                                                      
014300         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                         
014400            OR  (SQLCODE = +0))                                           
014500                                                                          
014600         EXEC SQL                                                         
014700             OPEN PO-CSR                                                  
014800         END-EXEC                                                         
014900                                                                          
015000         EVALUATE TRUE                                                    
015100             WHEN SQLCODE = +0                                            
015200             WHEN SQLCODE = -904                                          
015300             WHEN SQLCODE = -911                                          
015300             WHEN SQLCODE = -913                                          
015400                  CONTINUE                                                
015500             WHEN SQLWARN0 NOT = SPACE                                    
015600             WHEN SQLCODE  NOT = +0                                       
015700                  MOVE '7000-OPEN-PO-CSR-CURSOR'                          
015800                                 TO PV-ABEND-PARAGRAPH                    
015900                  MOVE 'OPEN PO-CSR CURSOR'                               
016000                                 TO PV-ABEND-OPERATION                    
016100                  MOVE 'TPOSYNC'   TO PV-ABEND-STRUCTURE-1                
016400                  PERFORM 9900-DB2-ABEND                                  
016500         END-EVALUATE                                                     
016600     END-PERFORM.                                                         
016700                                                                          
016800     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                                  
016900         MOVE '7000-OPEN-PO-CSR-CURSOR'                                   
017000                                 TO PV-ABEND-PARAGRAPH                    
017100         MOVE 'MAX RETRIES EXCEEDED'                                      
017200                                 TO PV-ABEND-OPERATION                    
017300         PERFORM 9900-DB2-ABEND                                           
017400     END-IF.                                                              
017500                                                                          
017600 7100-FETCH-PO-CSR-CURSOR.                                                
017700                                                                          
017800     INITIALIZE DCLTPOSYNC.                                               
017900                                                                          
018000     EXEC SQL                                                             
018100          FETCH PO-CSR                                                    
018200           INTO   :POSYNC-PO-NBR                                          
018300     END-EXEC.                                                            
018400                                                                          
018500     EVALUATE TRUE                                                        
018600         WHEN SQLCODE = +0                                                
018700              ADD 1 TO PV-COUNT1                                          
018710              PERFORM 8000-SELECT-PO-CHECK                                
018800         WHEN SQLCODE = +100                                              
018900              SET PS-END-PO-CSR     TO TRUE                               
019000         WHEN SQLWARN0 NOT = SPACE                                        
019100         WHEN SQLCODE  NOT = +0                                           
019200              MOVE '7100-FETCH-PO-CSR-CURSOR'                             
019300                                   TO PV-ABEND-PARAGRAPH                  
019400              MOVE 'FETCH PO-CSR CURSOR'                                  
019500                                   TO PV-ABEND-OPERATION                  
019600                  MOVE 'TPOSYNC'   TO PV-ABEND-STRUCTURE-1                
019900              PERFORM 9900-DB2-ABEND                                      
020000     END-EVALUATE.                                                        
020100                                                                          
020200 7200-CLOSE-PO-CSR-CURSOR.                                                
020300                                                                          
020400     PERFORM                                                              
020500         WITH TEST AFTER                                                  
020600         VARYING PV-RETRY-COUNT                                           
020700         FROM 1 BY 1                                                      
020800         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                         
020900            OR  (SQLCODE = +0))                                           
021000                                                                          
021100            EXEC SQL                                                      
021200                CLOSE PO-CSR                                              
021300            END-EXEC                                                      
021400                                                                          
021500            EVALUATE TRUE                                                 
021600                WHEN SQLCODE = 0                                          
021700                    CONTINUE                                              
021800                WHEN SQLCODE = -911                                       
021800                WHEN SQLCODE = -913                                       
021900                WHEN SQLCODE = -904                                       
022000                    CONTINUE                                              
022100                WHEN SQLCODE  NOT = +0                                    
022200                     MOVE '7200-CLOSE-PO-CSR-CURSOR'                      
022300                                  TO PV-ABEND-PARAGRAPH                   
022400                     MOVE 'CLOSE TSK CURSOR'                              
022500                                  TO PV-ABEND-OPERATION                   
022800                     MOVE 'TPOSYNC'   TO PV-ABEND-STRUCTURE-1             
022900                     PERFORM 9900-DB2-ABEND                               
023000            END-EVALUATE                                                  
023100                                                                          
023200     END-PERFORM.                                                         
023300                                                                          
023400     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                                  
023500         MOVE '7200-CLOSE-PO-CSR-CURSOR'                                  
023600                                 TO PV-ABEND-PARAGRAPH                    
023700         MOVE 'MAX RETRIES EXCEEDED'                                      
023800                                 TO PV-ABEND-OPERATION                    
023900         PERFORM 9900-DB2-ABEND                                           
024000     END-IF.                                                              
024100/                                                                         
024200 7300-FIND-DELETE-DAYS.                                                   
024300                                                                          
024400     PERFORM                                                              
024500         WITH TEST AFTER                                                  
024600         VARYING PV-RETRY-COUNT                                           
024700         FROM 1 BY 1                                                      
024800         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                         
024900            OR  (SQLCODE = +0 OR SQLCODE = +100))                         
025000                                                                          
025100         EXEC SQL                                                         
025200             SELECT FUNC_QTY                                              
025300             INTO :KRPRPM-FUNC-QTY                                        
025400             FROM TKRPRPM                                                 
025500             WHERE                                                        
025600                 LOC_ID = 90                                              
025700             AND INTFC_SYS_CDE = 'RDM'                                    
025800             AND SYS_PRC_FUNC_CDE = 'POPGDY'                              
025900         END-EXEC                                                         
026000                                                                          
026100         EVALUATE TRUE                                                    
026200             WHEN SQLCODE = +0                                            
026300             WHEN SQLCODE = +100                                          
026400             WHEN SQLCODE = -904                                          
026500             WHEN SQLCODE = -913                                          
026600             WHEN SQLCODE = -911                                          
026700                  CONTINUE                                                
026800             WHEN SQLWARN0 NOT = SPACE                                    
026900             WHEN SQLCODE  NOT = +0                                       
027000                  MOVE '7300-FIND-DELETE-DAYS'                            
027100                                 TO PV-ABEND-PARAGRAPH                    
027200                  MOVE 'SELECT PO INFO'                                   
027300                                 TO PV-ABEND-OPERATION                    
027400                  MOVE 'TKRPRPM'   TO PV-ABEND-STRUCTURE-1                
027500                  PERFORM 9900-DB2-ABEND                                  
027600         END-EVALUATE                                                     
027700     END-PERFORM.                                                         
027800                                                                          
027900     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                                  
028000         AND NOT (SQLCODE = +0 OR SQLCODE = +100)                         
028100          MOVE '7300-FIND-DELETE-DAYS'                                    
028200                                 TO PV-ABEND-PARAGRAPH                    
028300         MOVE 'MAX RETRIES EXCEEDED'                                      
028400                                 TO PV-ABEND-OPERATION                    
028500         PERFORM 9900-DB2-ABEND                                           
028600     END-IF.                                                              
028700/                                                                         
028800 8000-SELECT-PO-CHECK.                                                    
028900                                                                          
029000     PERFORM                                                              
029100         WITH TEST AFTER                                                  
029200         VARYING PV-RETRY-COUNT                                           
029300         FROM 1 BY 1                                                      
029400         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                         
029500            OR  (SQLCODE = +0 OR SQLCODE = +100))                         
029600                                                                          
029700         EXEC SQL                                                         
029800             SELECT PO_NBR, VER_NBR, STATUS_CDE, STATUS_TMST              
029900               INTO :PURCHS-PO-NBR                                        
030000                   ,:PURCHS-VER-NBR                                       
030100                   ,:PURCHS-STATUS-CDE                                    
030200                   ,:PURCHS-STATUS-TMST                                   
030300               FROM TPURCHS A                                             
030400               WHERE   A.PO_NBR = :POSYNC-PO-NBR                          
030500                   AND A.STATUS_CDE IN ('CM', 'CA')                       
030600                   AND A.VER_STATUS_CDE = 'A'                             
030700                   AND DATE(A.STATUS_TMST) < (CURRENT DATE) -             
030900                             :KRPRPM-FUNC-QTY DAYS                        
                 WITH UR                                                        
031300         END-EXEC                                                         
031400                                                                          
031500         EVALUATE TRUE                                                    
031600             WHEN SQLCODE = +0                                            
031700                  PERFORM 8500-DELETE-PO                                  
031800             WHEN SQLCODE = -904                                          
031900             WHEN SQLCODE = -911                                          
031900             WHEN SQLCODE = -913                                          
032000             WHEN SQLCODE = +100                                          
032100                  CONTINUE                                                
032200             WHEN SQLWARN0 NOT = SPACE                                    
032300             WHEN SQLCODE  NOT = +0                                       
032400                  MOVE '8000-SELECT-PO-CHECK'                             
032500                                 TO PV-ABEND-PARAGRAPH                    
032600                  MOVE 'SELECT PO INFO'                                   
032700                                 TO PV-ABEND-OPERATION                    
032800                  MOVE 'TPURCHS'   TO PV-ABEND-STRUCTURE-1                
032900                  PERFORM 9900-DB2-ABEND                                  
033000         END-EVALUATE                                                     
033100     END-PERFORM.                                                         
033200                                                                          
033300     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                                  
033400         MOVE '8000-SELECT-PO-CHECK'                                      
033500                                 TO PV-ABEND-PARAGRAPH                    
033600         MOVE 'MAX RETRIES EXCEEDED'                                      
033700                                 TO PV-ABEND-OPERATION                    
033800         PERFORM 9900-DB2-ABEND                                           
033900     END-IF.                                                              
034000                                                                          
034100 8500-DELETE-PO.                                                          
           IF POSYNC-PO-NBR =                                                   
              1626203 OR 1626209 OR 1626211 OR 1667844 OR 1685884               
               NEXT SENTENCE                                                    
           ELSE                                                                 
034200     PERFORM                                                              
034300         WITH TEST AFTER                                                  
034400         VARYING PV-RETRY-COUNT                                           
034500         FROM 1 BY 1                                                      
034600         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                         
034700            OR  (SQLCODE = +0 OR SQLCODE = +100))                         
034800                                                                          
034900         EXEC SQL                                                         
035000             DELETE FROM TPOSYNC                                          
035100             WHERE CURRENT OF PO-CSR                                      
035200         END-EXEC                                                         
035300                                                                          
035400         EVALUATE TRUE                                                    
035500             WHEN SQLCODE = +0                                            
035600                  ADD 1 TO PV-COUNT2                                      
035700             WHEN SQLCODE = +100                                          
035800             WHEN SQLCODE = -904                                          
035900             WHEN SQLCODE = -911                                          
035900             WHEN SQLCODE = -913                                          
036000                  CONTINUE                                                
036100             WHEN SQLWARN0 NOT = SPACE                                    
036200             WHEN SQLCODE  NOT = +0                                       
036300                  MOVE '8500-DELETE-PO'                                   
036400                                 TO PV-ABEND-PARAGRAPH                    
036500                  MOVE 'DELETE PO'                                        
036600                                 TO PV-ABEND-OPERATION                    
036700                  MOVE 'TPOSYNC'   TO PV-ABEND-STRUCTURE-1                
036800                  PERFORM 9900-DB2-ABEND                                  
036900         END-EVALUATE                                                     
037000     END-PERFORM                                                          
037800     END-IF.                                                              
037100                                                                          
037200     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                                  
037300         MOVE '8500-DELETE-PO'                                            
037400                                 TO PV-ABEND-PARAGRAPH                    
037500         MOVE 'MAX RETRIES EXCEEDED'                                      
037600                                 TO PV-ABEND-OPERATION                    
037700         PERFORM 9900-DB2-ABEND                                           
037800     END-IF.                                                              
037900                                                                          
038000 9000-TERMINATE.                                                          
038100                                                                          
038200     DISPLAY '************************'.                                  
038300     DISPLAY '******* CEKUP012 *******'.                                  
038400     DISPLAY '************************'.                                  
038500     DISPLAY ' '                                                          
038600     DISPLAY 'PO READ = ' PV-COUNT1.                                      
038700     DISPLAY 'PO DELETE = ' PV-COUNT2.                                    
038800     DISPLAY ' '                                                          
038900     DISPLAY '************************'.                                  
039000                                                                          
039100 9900-DB2-ABEND.                                                          
039200                                                                          
039300     MOVE SQLCODE TO PV-SQLCODE.                                          
039400     DISPLAY '*** DB2 ERROR '.                                            
039500     DISPLAY '*** SQLCODE   = ' PV-SQLCODE.                               
039600     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                         
039700     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.                       
039800     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.                       
039900     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.               
040000     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.               
040100     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-3.               
040200     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.                     
040300                                                                          
040400     IF PV-ABEND-STRUCTURE-2 > SPACES                                     
040500         DISPLAY '*** TABLE 2   = ' PV-ABEND-STRUCTURE-2                  
040600     END-IF.                                                              
040700                                                                          
040800                                                                          
040900     COPY DPPD004.                                                        
041000                                                                          
041100     IF SQLCODE NOT = -911                                                
041200         EXEC SQL                                                         
041300              ROLLBACK                                                    
041400         END-EXEC                                                         
041500     END-IF.                                                              
041600                                                                          
041700     MOVE +4013                  TO PV-ABEND-CODE.                        
041800     CALL 'ILBOABN0' USING PV-ABEND-CODE.                                 
041900                                                                          
042000 9200-ABEND.                                                              
042100******************************************************************        
042200*  PERFORMS A NON-SQL ABEND FOR THE PROGRAM                               
042300******************************************************************        
042400     DISPLAY '***************************'.                               
042500     DISPLAY '**       ABEND           **'.                               
042600     DISPLAY '**  IN PROGRAM CEKUP012  **'.                               
042700     DISPLAY '***************************'.                               
042800     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.                
042900     DISPLAY '**                 ** = ' PV-ERROR-MESSAGE-1.               
043000     DISPLAY '**                 ** = ' PV-ERROR-MESSAGE-2.               
043100                                                                          
043200     MOVE +4014                  TO PV-ABEND-CODE.                        
043300     CALL 'ILBOABN0' USING PV-ABEND-CODE.                                 
043400*                                                                         
