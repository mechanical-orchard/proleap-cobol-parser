000200***************************************************************** 00020001
000300 IDENTIFICATION DIVISION.                                         00030001
000400***************************************************************** 00040001
000500                                                                  00050001
000600 PROGRAM-ID.             SUKUT100.                                00060001
000700 AUTHOR.                 PATRICK BURKE.                           00070001
000800 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00080001
000900 DATE-WRITTEN            JANUARY 2005.                            00090001
001000 DATE-COMPILED.                                                   00100001
001100***************************************************************** 00110001
001200*                                                               * 00120001
001300*  THIS PROGRAM WILL CREATE AN EXTRACT FILE CONTAINING OLD DATA * 00130001
001400*  CREATED MORE THAN X(PARM VALUE) NUMBER OF MONTHS OLD.        * 00140001
001500*  IT WILL CREATE AN EXTRACT RECORD FOR EACH PO-RCVR IN THE     * 00150001
001600*  OUTBOUND CARTON INDICATING IF THE RECEIVER WAS VERIFIED      * 00160001
001700*  MOVE THAN 6 MONTHS AGO.  THIS WILL BE USED TO PURGE THE      * 00170001
001800*  OUTBOUND DATABASES.                                          * 00180001
001900***************************************************************** 00190001
002000***************************************************************** 00200001
002100 ENVIRONMENT DIVISION.                                            00210001
002200***************************************************************** 00220001
002300                                                                  00230001
002400 CONFIGURATION SECTION.                                           00240001
002500                                                                  00250001
002600 SOURCE-COMPUTER.        IBM-3090.                                00260001
002700 OBJECT-COMPUTER.        IBM-3090.                                00270001
002800                                                                  00280001
002900 INPUT-OUTPUT SECTION.                                            00290001
003000                                                                  00300001
003100 FILE-CONTROL.                                                    00310001
003200*                                                                 00320001
003300     SELECT SU-LABEL-EXTRACT-FILE                                 00330003
003400         ASSIGN TO OUT01.                                         00340001
003500*                                                                 00350001
003600***************************************************************** 00360001
003700 DATA DIVISION.                                                   00370001
003800***************************************************************** 00380001
003900*                                                                 00390001
004000 FILE SECTION.                                                    00400001
004100*                                                                 00410001
004200 FD  SU-LABEL-EXTRACT-FILE                                        00420003
004300     RECORDING MODE IS F                                          00430001
004400     BLOCK CONTAINS 0  RECORDS.                                   00440001
004500 01  SU-LABEL-EXTRACT-RECORD         PIC  X(50).                  00450011
004600*                                                                 00460001
004700                                                                  00470001
004800 WORKING-STORAGE SECTION.                                         00480001
004900*                                                                 00490001
005000 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00500001
005100                                                   COMP SYNC.     00510001
005200*                                                                 00520001
005300 01  PROGRAM-SWITCHES.                                            00530001
005400     05  PS-EOF-LBL-CURSOR-SW        PIC  X(01)    VALUE 'N'.     00540003
005500         88  PS-EOF-LBL-CSR                        VALUE 'Y'.     00550003
005600         88  PS-NOT-EOF-LBL-CSR                    VALUE 'N'.     00560003
006000                                                                  00600001
006100 01  PC-PROGRAM-CONSTANTS.                                        00610001
006200     05  PC-CURRENT-PROGRAM-NAME    PIC  X(08)     VALUE          00620001
006300                                                   'SUKUT100'.    00630003
006400                                                                  00640001
006500 01  PV-PROGRAM-VARIABLES.                                        00650001
006600     05  PV-DISPLAY-PURGE-WEEKS      PIC  Z(09).                  00660001
006700     05  PV-PURGE-TMST               PIC  X(26).                  00670001
006800     05  PV-PURGE-DATE               PIC  X(10).                  00680001
006900                                                                  00690001
007000     05  PV-ABEND-PARAGRAPH          PIC  X(30)    VALUE SPACES.  00700001
007100     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  00710001
007200     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  00720001
007300                                                                  00730001
007400     05  PV-LBL-FETCH-CNT            PIC  9(09)    VALUE ZERO.    00740003
007600     05  PV-LBL-OUTPUT-CNT           PIC  9(09)    VALUE ZERO.    00760003
007800     05  PV-TOTAL-CNT                PIC  9(09)    VALUE ZERO.    00780001
007900                                                                  00790001
008000 01  DK-DB-KEYS.                                                  00800001
008100     05  DK-PURGE-WEEKS              PIC S9(09)  COMP.            00810001
008200                                                                  00820001
008210******************************************************************00821008
008220*  FILE LAYOUT FOR LABEL REQUEST MESSAGE.                         00822008
008300******************************************************************00830008
008400     COPY SURD052.                                                00840003
008500                                                                  00850003
008600/                                                                 00860001
008700******************************************************************00870001
008800*  DB2 FORMATTED MESSAGE AREA                                     00880001
008900******************************************************************00890001
009000     COPY DPWS004.                                                00900001
009100                                                                  00910001
009200******************************************************************00920001
009300*  COPY BOOK FOR THE PARAMETER TABLE                              00930001
009400******************************************************************00940001
009500     EXEC SQL                                                     00950001
009600          INCLUDE TKRPRPM                                         00960001
009700     END-EXEC.                                                    00970001
009800                                                                  00980001
009900******************************************************************00990001
010000*   LABEL REQUEST TABLE                                           01000008
010100******************************************************************01010001
010200     EXEC SQL                                                     01020001
010300          INCLUDE SUT00043                                        01030003
010400     END-EXEC.                                                    01040001
010500                                                                  01050001
013400******************************************************************01340001
013500*  DB2 COMMUNICATION AREA                                         01350001
013600******************************************************************01360001
013700     EXEC SQL                                                     01370001
013800         INCLUDE SQLCA                                            01380001
013900     END-EXEC.                                                    01390001
014000                                                                  01400001
014100******************************************************************01410001
014200*  DB2 COMMUNICATION AREA2                                        01420001
014300******************************************************************01430001
014400     COPY SQLCA2.                                                 01440001
014500                                                                  01450001
014610******************************************************************01461005
014700     EXEC SQL                                                     01470001
014800       DECLARE LBL-CSR CURSOR FOR                                 01480003
014900         SELECT DC_NBR                                            01490002
015000               ,ACM_LBL_STA_NBR                                   01500002
015010               ,ACM_MSG_RCV_TMST                                  01501002
015100          FROM  SUT_LBL_REQ_MSG                                   01510002
015200          WHERE ACM_CART_RCV_DTE  < (CURRENT DATE -               01520010
015300                                (:DK-PURGE-WEEKS * 7) DAYS)       01530009
015400     END-EXEC.                                                    01540001
015500                                                                  01550001
016700*                                                                 01670001
016800 PROCEDURE DIVISION.                                              01680001
016900*                                                                 01690001
017000 0000-MAINLINE-PROCESSING.                                        01700001
017100******************************************************************01710001
017200**  THIS IS THE MAIN DRIVER FOR THE PROGRAM.                      01720001
017300******************************************************************01730001
017400                                                                  01740001
017500     PERFORM 1000-INITIALIZATION.                                 01750001
017600                                                                  01760001
017700     PERFORM 2000-PROCESS-LBL                                     01770007
017800       UNTIL PS-EOF-LBL-CSR.                                      01780007
017900                                                                  01790001
018000     PERFORM 2300-CLOSE-LBL-CSR.                                  01800007
018100                                                                  01810001
018600     DISPLAY 'LBL FETCHED=' PV-LBL-FETCH-CNT   '  **'.            01860007
018800     DISPLAY '                                 '.                 01880001
019100     DISPLAY 'TOTAL OUT  =' PV-TOTAL-CNT       '  **'             01910001
019200                                                                  01920001
019300     CLOSE SU-LABEL-EXTRACT-FILE.                                 01930003
019400                                                                  01940001
019500     GOBACK.                                                      01950001
019600                                                                  01960001
019800 1000-INITIALIZATION.                                             01980001
019900******************************************************************01990001
020000**  PERFORM THE INITIAL PROCESSING FOR THE PROGRAM.               02000001
020100******************************************************************02010001
020200                                                                  02020001
020300     OPEN OUTPUT SU-LABEL-EXTRACT-FILE.                           02030003
020400                                                                  02040001
020500     PERFORM 7000-GET-PURGE-WEEKS.                                02050001
020600                                                                  02060001
020700     DISPLAY '** SUKUT100 **'.                                    02070003
020800     DISPLAY '** PURGE ' PV-DISPLAY-PURGE-WEEKS ' WEEKS **'.      02080001
020900     DISPLAY '** DATE  ' PV-PURGE-DATE.                           02090001
021000                                                                  02100001
021200     SET  PS-NOT-EOF-LBL-CSR  TO  TRUE.                           02120003
021300                                                                  02130001
021400     PERFORM 2100-OPEN-LBL-CSR.                                   02140003
021500     PERFORM 2200-FETCH-LBL-CSR.                                  02150003
021600                                                                  02160001
021800*                                                                 02180001
021900 2000-PROCESS-LBL.                                                02190007
022000                                                                  02200001
022200     INITIALIZE  SU052-EXTRACT-RECORD.                            02220005
022300                                                                  02230001
022400     MOVE SUT00043-DC-NBR           TO  SU052-DC-NBR.             02240007
022600     MOVE SUT00043-ACM-LBL-STA-NBR  TO  SU052-ACM-LBL-STA-NBR.    02260007
022700     MOVE SUT00043-ACM-MSG-RCV-TMST TO  SU052-ACM-MSG-RCV-TMST.   02270007
022701                                                                  02270107
023100                                                                  02310001
023200     IF  PS-EOF-LBL-CSR                                           02320007
023400         ADD  1  TO  PV-LBL-OUTPUT-CNT                            02340007
023500         PERFORM 2300-CLOSE-LBL-CSR                               02350007
023600         PERFORM 8000-WRITE-EXTRACT-RECORD                        02360001
023700     ELSE                                                         02370001
023710         PERFORM 8000-WRITE-EXTRACT-RECORD                        02371007
023720         PERFORM 2200-FETCH-LBL-CSR                               02372007
024100     END-IF.                                                      02410001
024200                                                                  02420001
024700 2100-OPEN-LBL-CSR.                                               02470003
024800     MOVE '2100-OPEN-LBL-CSR'    TO PV-ABEND-PARAGRAPH.           02480003
024900                                                                  02490001
025000     EXEC SQL                                                     02500001
025100          OPEN LBL-CSR                                            02510003
025200     END-EXEC.                                                    02520001
025300                                                                  02530001
025400     EVALUATE TRUE                                                02540001
025500         WHEN SQLCODE = 0                                         02550001
025600             CONTINUE                                             02560001
025700         WHEN SQLWARN0 NOT = SPACES                               02570001
025800         WHEN SQLCODE < ZERO                                      02580001
025900         WHEN SQLCODE > ZERO                                      02590001
026000             MOVE '2100-OPEN-LBL-CSR'                             02600003
026100                             TO PV-PARAGRAPH-NAME                 02610001
026200             MOVE 'OPEN THE LBL_CURSOR            '               02620003
026300                             TO PV-DB2-OPERATION-ATTEMPTED        02630001
026400             PERFORM 9100-SQL-ABEND                               02640001
026500     END-EVALUATE.                                                02650001
026600                                                                  02660001
026700                                                                  02670001
026800 2200-FETCH-LBL-CSR.                                              02680003
026900     MOVE '2200-FETCH-LBL-CSR'   TO PV-ABEND-PARAGRAPH.           02690003
027000                                                                  02700001
027100     EXEC SQL                                                     02710001
027200          FETCH LBL-CSR                                           02720003
027300          INTO  :SUT00043-DC-NBR                                  02730003
027400              , :SUT00043-ACM-LBL-STA-NBR                         02740003
027410              , :SUT00043-ACM-MSG-RCV-TMST                        02741003
027500     END-EXEC.                                                    02750001
027600                                                                  02760001
027700     EVALUATE TRUE                                                02770001
027800       WHEN SQLCODE = ZEROS                                       02780001
027900            ADD  1  TO  PV-LBL-FETCH-CNT                          02790003
028000       WHEN SQLCODE = +100                                        02800001
028100            SET PS-EOF-LBL-CSR  TO TRUE                           02810003
028200       WHEN SQLWARN0 NOT = SPACES                                 02820001
028300       WHEN SQLCODE < ZERO                                        02830001
028400       WHEN SQLCODE > ZERO                                        02840001
028500           MOVE '2200-FETCH-LBL-CSR'                              02850003
028600                               TO PV-PARAGRAPH-NAME               02860001
028700           MOVE 'FETCH LBL CURSOR '                               02870003
028800                               TO PV-DB2-OPERATION-ATTEMPTED      02880001
028900           PERFORM 9100-SQL-ABEND                                 02890001
029000     END-EVALUATE.                                                02900001
029100                                                                  02910001
029200                                                                  02920001
029300 2300-CLOSE-LBL-CSR.                                              02930003
029400     MOVE '2300-CLOSE-LBL-CSR'   TO PV-ABEND-PARAGRAPH.           02940003
029500                                                                  02950001
029600     EXEC SQL                                                     02960001
029700         CLOSE LBL-CSR                                            02970003
029800     END-EXEC.                                                    02980001
029900                                                                  02990001
030000     EVALUATE TRUE                                                03000001
030100         WHEN SQLCODE = ZERO                                      03010001
030200         WHEN SQLCODE = -904                                      03020001
030300         WHEN SQLCODE = -911                                      03030001
030400              CONTINUE                                            03040001
030500         WHEN SQLWARN0 NOT = SPACES                               03050001
030600         WHEN SQLCODE < ZERO                                      03060001
030700         WHEN SQLCODE > ZERO                                      03070001
030800              MOVE '2300-CLOSE-LBL-CSR'                           03080003
030900                              TO PV-PARAGRAPH-NAME                03090001
031000              MOVE 'CLOSE THE LBL-CSR              '              03100003
031100                              TO PV-DB2-OPERATION-ATTEMPTED       03110001
031200              PERFORM 9100-SQL-ABEND                              03120001
031300     END-EVALUATE.                                                03130001
031400                                                                  03140001
031500                                                                  03150001
042200                                                                  04220001
048500 7000-GET-PURGE-WEEKS.                                            04850001
048600                                                                  04860001
048700     EXEC SQL                                                     04870001
048800         SELECT  FUNC_QTY                                         04880001
048900           INTO :DK-PURGE-WEEKS                                   04890001
049000           FROM TKRPRPM                                           04900001
049100          WHERE LOC_ID            =  90                           04910001
049200            AND INTFC_SYS_CDE     = 'KHL'                         04920001
049300            AND SYS_PRC_FUNC_CDE  = 'PAPURG'                      04930004
049400            AND FUNC_PRC_STAT_CDE = 'AC'                          04940001
049500     END-EXEC.                                                    04950001
049600                                                                  04960001
049700     EVALUATE TRUE                                                04970001
049800         WHEN SQLCODE = ZEROS                                     04980001
049900              MOVE  DK-PURGE-WEEKS  TO  PV-DISPLAY-PURGE-WEEKS    04990001
050000              PERFORM 7100-GET-PURGE-DATE                         05000001
050100         WHEN SQLCODE = +100                                      05010001
050200              CONTINUE                                            05020001
050300         WHEN SQLWARN0 NOT = SPACES                               05030001
050400         WHEN SQLCODE < ZERO                                      05040001
050500         WHEN SQLCODE > ZERO                                      05050001
050600             MOVE '7000-GET-PURGE-WEEKS'                          05060001
050700                             TO PV-PARAGRAPH-NAME                 05070001
050800             MOVE 'GET NUMBER OF WEEKS TO PURGE   '               05080001
050900                             TO PV-DB2-OPERATION-ATTEMPTED        05090001
051000             PERFORM 9100-SQL-ABEND                               05100001
051100     END-EVALUATE.                                                05110001
051200                                                                  05120001
051300                                                                  05130001
051400 7100-GET-PURGE-DATE.                                             05140001
051500                                                                  05150001
051600     EXEC SQL                                                     05160001
051700         SELECT  (CURRENT_DATE -                                  05170001
051800                  (:DK-PURGE-WEEKS * 7) DAYS)                     05180001
051900           INTO :PV-PURGE-DATE                                    05190001
052000           FROM TKRPRPM                                           05200001
052100          WHERE LOC_ID            =  90                           05210001
052200            AND INTFC_SYS_CDE     = 'KHL'                         05220001
052300            AND SYS_PRC_FUNC_CDE  = 'PAPURG'                      05230005
052400            AND FUNC_PRC_STAT_CDE = 'AC'                          05240001
052500     END-EXEC.                                                    05250001
052600                                                                  05260001
052700     EVALUATE TRUE                                                05270001
052800         WHEN SQLCODE = ZEROS                                     05280001
052900         WHEN SQLCODE = +100                                      05290001
053000              CONTINUE                                            05300001
053100         WHEN SQLWARN0 NOT = SPACES                               05310001
053200         WHEN SQLCODE < ZERO                                      05320001
053300         WHEN SQLCODE > ZERO                                      05330001
053400             MOVE '7100-GET-PURGE-DATE '                          05340001
053500                             TO PV-PARAGRAPH-NAME                 05350001
053600             MOVE 'CALCULATE PURGE DATE           '               05360001
053700                             TO PV-DB2-OPERATION-ATTEMPTED        05370001
053800             PERFORM 9100-SQL-ABEND                               05380001
053900     END-EVALUATE.                                                05390001
054000                                                                  05400001
054100                                                                  05410001
054200 8000-WRITE-EXTRACT-RECORD.                                       05420001
054300     WRITE SU-LABEL-EXTRACT-RECORD                                05430005
054400       FROM SU052-EXTRACT-RECORD.                                 05440005
054500                                                                  05450001
054510     ADD  1  TO  PV-TOTAL-CNT.                                    05451007
054600                                                                  05460001
054700 9100-SQL-ABEND.                                                  05470001
054800******************************************************************05480001
054900*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    05490001
055000*  ERROR OR WARNING CODE OCCURS.                                  05500001
055100******************************************************************05510001
055200     DISPLAY '9100-SQL-ABEND'.                                    05520001
055300     DISPLAY '** ABEND     **'.                                   05530001
055400     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        05540001
055500     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              05550001
055600     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     05560001
055700                                                                  05570001
055800******************************************************************05580001
055900* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    05590001
056000* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         05600001
056100* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     05610001
056200* FORMAT.                                                         05620001
056300******************************************************************05630001
056400     COPY DPPD004.                                                05640001
056500                                                                  05650001
056600     MOVE +4013                  TO ABEND-CODE.                   05660001
056700     CALL 'ILBOABN0' USING ABEND-CODE.                            05670001
056800                                                                  05680001
