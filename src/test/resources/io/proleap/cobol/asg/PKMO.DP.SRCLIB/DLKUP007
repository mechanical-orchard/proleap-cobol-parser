000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400                                                                  00040000
000500 PROGRAM-ID.    DLKUP007.                                         00050000
000600 AUTHOR.        BUDDY BARNES.                                     00060000
000700 INSTALLATION.  KOHLS.                                            00070000
000800 DATE-WRITTEN   JUNE 2004.                                        00080000
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100******************************************************************00110000
001200*  THIS PROGRAM READS AN INPUT FILE CONTAINING BUSEV PURGE DATA, *00120000
001300*  AND DELETES BUSINESS EVENTS FROM SUT_BUS_EVNT_EXPRT AND        00130000
001310*  SUT_BUS_EVNT_DTL(BECAUSE OF THE DELETE CASCADE).               00131003
001400******************************************************************00140000
001500                                                                  00150000
001600******************************************************************00160000
001700 ENVIRONMENT DIVISION.                                            00170000
001800******************************************************************00180000
001900                                                                  00190000
002000 CONFIGURATION SECTION.                                           00200000
002100                                                                  00210000
002200 SOURCE-COMPUTER.        IBM-3090.                                00220000
002300 OBJECT-COMPUTER.        IBM-3090.                                00230000
002400                                                                  00240000
002500 INPUT-OUTPUT SECTION.                                            00250000
002600                                                                  00260000
002700 FILE-CONTROL.                                                    00270000
002800                                                                  00280000
002900     SELECT BUSEV-FILE                                            00290000
003000         ASSIGN TO INP01.                                         00300000
003100                                                                  00310000
003200******************************************************************00320000
003300 DATA DIVISION.                                                   00330000
003400******************************************************************00340000
003500                                                                  00350000
003600 FILE SECTION.                                                    00360000
003700                                                                  00370000
003800 FD  BUSEV-FILE                                                   00380000
003900     RECORDING MODE IS F                                          00390000
004000     LABEL RECORDS ARE STANDARD                                   00400000
004100     BLOCK CONTAINS 0 RECORDS.                                    00410000
004200                                                                  00420000
004300 01  BUSEV-RECORD                     PIC X(050).                 00430000
004400                                                                  00440000
004600******************************************************************00460000
004700 WORKING-STORAGE SECTION.                                         00470000
004800******************************************************************00480000
004900******************************************************************00490000
005000*  RECORD LAYOUT FOR PURGE BUSEV PROCESSING                       00500000
005100******************************************************************00510000
005200     COPY DLRD007.                                                00520000
005201                                                                  00520100
005202******************************************************************00520203
005203*  DB2 FORMATTED MESSAGE AREA                                     00520303
005204******************************************************************00520403
005205     COPY DPWS004.                                                00520503
005206     COPY SQLCA2.                                                 00520603
005207******************************************************************00520703
005208*  COMMUNICATIONS AREA FOR DB2                                    00520803
005209******************************************************************00520903
005210                                                                  00521003
005220     EXEC SQL                                                     00522003
005230          INCLUDE SQLCA                                           00523003
005240     END-EXEC.                                                    00524003
005250                                                                  00525003
005260******************************************************************00526003
005270*  COBOL DECLARATION FOR SUT_BUS_EVNT_EXPRT                       00527003
005280******************************************************************00528003
005290     EXEC SQL                                                     00529003
005300          INCLUDE SUT00037                                        00530003
005400     END-EXEC.                                                    00540003
005500                                                                  00550003
005600 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00560003
005700                                                   COMP SYNC.     00570003
005800                                                                  00580003
005900 01  DATABASE-KEYS.                                               00590003
006000     05  DK-EVNT-EXPRT-ID            PIC S9(09)    COMP.          00600003
006100                                                                  00610003
006200 01  PS-PROGRAM-SWITCHES.                                         00620003
006300     05  PS-EOF-SW                   PIC  X(01)    VALUE 'N'.     00630003
006400         88  PS-EOF                                VALUE 'Y'.     00640003
006500         88  PS-NOT-EOF                            VALUE 'N'.     00650003
006600     05  PS-DELETE-SUCCESSFUL-SW     PIC  X(01)    VALUE 'N'.     00660003
006700         88  PS-DELETE-SUCCESSFUL                  VALUE 'Y'.     00670003
006800         88  PS-DELETE-NOT-SUCCESSFUL              VALUE 'N'.     00680003
006900                                                                  00690003
007000 01  PC-PROGRAM-CONSTANTS.                                        00700003
007100     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00710003
007200         'DLKUP007'.                                              00720003
007300     05  PC-COMMIT-HOLD              PIC 9(3)      VALUE 100.     00730003
007400                                                                  00740003
007500 01  PA-PROGRAM-ACCUMULATORS.                                     00750003
007600     05  PA-COMMIT-COUNT             PIC  S9(09)  VALUE +0 COMP-3.00760003
007700     05  PA-COMMIT-COUNTER           PIC  S9(09)  VALUE +0 COMP-3.00770003
007800     05  PA-COMMIT-TOTAL             PIC  S9(09)  VALUE +0 COMP-3.00780003
007900     05  PA-RECS-READ                PIC  S9(09)  VALUE +0 COMP-3.00790003
008000     05  PA-BUSEV-DELETES            PIC  S9(09)  VALUE +0 COMP-3.00800003
008100     05  PA-BUSEV-DEL-FAIL           PIC  S9(09)  VALUE +0 COMP-3.00810003
008200     05  PA-BUSEV-NOT-FOUND          PIC  S9(09)  VALUE +0 COMP-3.00820003
008300                                                                  00830003
008400 01  PV-PROGRAM-VARIABLES.                                        00840003
008500     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  00850003
008600     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  00860003
008700     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             00870003
008800     05  PV-DISPLAY-NBR              PIC ZZZ,ZZZ,ZZ9.             00880003
008900     05  PV-EVNT-EXPRT-ID-HOLD       PIC  S9(10) COMP VALUE +0.   00890004
008910     05  PV-EVNT-EXPRT-ID            PIC  S9(9)  COMP VALUE +0.   00891004
009000                                                                  00900003
009100 01  PV-COMMIT-INFO.                                              00910003
009200     05  FILLER                      PIC X(10) VALUE 'BUSEV KEY:'.00920003
009300     05  PV-COMMIT-KEY.                                           00930003
009400         10  PV-COMMIT-EXPRT-ID      PIC 9(10) VALUE ZERO.        00940003
009500         10  FILLER                  PIC X(01) VALUE SPACE.       00950003
009600                                                                  00960003
009700******************************************************************00970003
009800 PROCEDURE DIVISION.                                              00980003
009900******************************************************************00990003
010000                                                                  01000003
010100 0000-PROGRAM-MAINLINE.                                           01010003
010200                                                                  01020003
010300     PERFORM 1000-INITIALIZE.                                     01030003
010400     PERFORM 2000-PROCESS-INPUT                                   01040003
010500       UNTIL PS-EOF.                                              01050003
010600     PERFORM 9000-EOJ-ROUTINE.                                    01060003
010700                                                                  01070003
010800     STOP RUN.                                                    01080003
010900                                                                  01090003
011000******************************************************************01100003
011100*  DO FIRST TIME PROGRAM INITIALIZATION TASKS.                    01110003
011200******************************************************************01120003
011300 1000-INITIALIZE.                                                 01130003
011400                                                                  01140003
011500     OPEN INPUT  BUSEV-FILE.                                      01150003
011600                                                                  01160003
011700     MOVE +0 TO PA-COMMIT-COUNTER                                 01170003
011800                PA-COMMIT-TOTAL                                   01180003
011900                                                                  01190003
012000     PERFORM 7000-READ-INPUT.                                     01200003
012100                                                                  01210003
012200******************************************************************01220003
012300*  PROCESS THE INPUT FILE AND DELETE THE CORRESPONDING ROW ON     01230003
012400*  THE SUT_BUS_EVNT_EXPRT TABLE.                                  01240003
012500******************************************************************01250003
012600 2000-PROCESS-INPUT.                                              01260003
012700                                                                  01270003
012800     PERFORM 8000-DELETE-BUSEV.                                   01280003
012900                                                                  01290003
013000     IF PA-COMMIT-COUNTER > PC-COMMIT-HOLD                        01300003
013100         EXEC SQL                                                 01310003
013200            COMMIT                                                01320003
013300         END-EXEC                                                 01330003
013400                                                                  01340003
013500         IF SQLCODE NOT = +0                                      01350003
013600             DISPLAY '### COMMIT FAILED ! ###'                    01360003
013700             PERFORM 9100-SQL-ABEND                               01370003
013800         END-IF                                                   01380003
013900                                                                  01390003
014000         ADD PA-COMMIT-COUNTER           TO PA-COMMIT-TOTAL       01400003
014100         MOVE DL007-EVNT-EXPRT-ID        TO PV-COMMIT-EXPRT-ID    01410003
014200                                                                  01420003
014300         DISPLAY 'COMMIT TAKEN: ' PV-COMMIT-INFO                  01430003
014400                                                                  01440003
014500         MOVE +0 TO PA-COMMIT-COUNTER                             01450003
014600     END-IF.                                                      01460003
014700                                                                  01470003
014800     PERFORM 7000-READ-INPUT.                                     01480003
014900                                                                  01490003
015000******************************************************************01500003
015100*  READ   THE INPUT FILE                                          01510003
015200******************************************************************01520003
015300 7000-READ-INPUT.                                                 01530003
015400                                                                  01540003
015500     INITIALIZE DL007-BUSEV-PURGE-LAYOUT.                         01550003
015600                                                                  01560003
015700     READ BUSEV-FILE INTO DL007-BUSEV-PURGE-LAYOUT                01570003
015800       AT END                                                     01580003
015900         SET PS-EOF  TO TRUE                                      01590003
016000       NOT AT END                                                 01600003
016100         ADD +1 TO PA-RECS-READ.                                  01610003
016200                                                                  01620003
016300                                                                  01630003
016400******************************************************************01640003
016500*  DELETE FROM SUT_BUS_EVNT_EXPRT                                 01650003
016600******************************************************************01660003
016700 8000-DELETE-BUSEV.                                               01670003
016800                                                                  01680003
016900     MOVE DL007-EVNT-EXPRT-ID     TO PV-EVNT-EXPRT-ID-HOLD.       01690004
016910     MOVE PV-EVNT-EXPRT-ID-HOLD   TO PV-EVNT-EXPRT-ID.            01691004
017000                                                                  01700003
017100     EXEC SQL                                                     01710003
017200         DELETE FROM SUT_BUS_EVNT_EXPRT                           01720003
017300          WHERE EVNT_EXPRT_ID     = :PV-EVNT-EXPRT-ID             01730003
017400     END-EXEC.                                                    01740003
017500                                                                  01750003
017600     EVALUATE TRUE                                                01760003
017700         WHEN SQLCODE = 0                                         01770003
017800             ADD +1           TO PA-BUSEV-DELETES                 01780003
017900             ADD +1           TO PA-COMMIT-COUNTER                01790003
018000         WHEN SQLCODE = +100                                      01800003
018100             ADD +1           TO PA-BUSEV-NOT-FOUND               01810003
018200             DISPLAY ' '                                          01820003
018300             DISPLAY '*******************************************'01830003
018400             DISPLAY '  BUSEV DELETE NOT FOUND (+100)'            01840003
018500             DISPLAY '  BUSEV EXPRT ID   : ' DL007-EVNT-EXPRT-ID  01850003
018600             DISPLAY '*******************************************'01860003
018700         WHEN SQLCODE = -904                                      01870003
018800         WHEN SQLCODE = -911                                      01880003
018900         WHEN SQLCODE = -913                                      01890003
019000             ADD +1           TO PA-BUSEV-DEL-FAIL                01900003
019100             DISPLAY ' '                                          01910003
019200             DISPLAY '*******************************************'01920003
019300             DISPLAY '  BUSEV DELETE FAIL ( -904, -911, -913)'    01930003
019400             DISPLAY '  BUSEV EXPRT ID   : ' DL007-EVNT-EXPRT-ID  01940003
019500             DISPLAY '*******************************************'01950003
019600         WHEN SQLCODE < 0                                         01960003
019700         WHEN SQLCODE > 0                                         01970003
019800         WHEN SQLWARN0 = 'W'                                      01980003
019900             MOVE '8000-DELETE-BUSEV'                             01990003
020000                         TO PV-PARAGRAPH-NAME                     02000003
020100             MOVE 'DELETE FROM SUT_BUS_EVNT_EXPRT'                02010003
020200                         TO PV-DB2-OPERATION-ATTEMPTED            02020003
020300             PERFORM 9100-SQL-ABEND                               02030003
020400     END-EVALUATE.                                                02040003
020500                                                                  02050003
020600******************************************************************02060003
020700*  CLOSE OUTPUT FILE.  DISPLAY RECORD COUNTS                      02070003
020800******************************************************************02080003
020900 9000-EOJ-ROUTINE.                                                02090003
021000                                                                  02100003
021100     CLOSE BUSEV-FILE.                                            02110003
021200                                                                  02120003
021300     DISPLAY SPACE.                                               02130003
021400     DISPLAY '****************************************'.          02140003
021500     DISPLAY '**    DLKUP007 SUMMARY STATISTICS     **'.          02150003
021600     DISPLAY '****************************************'.          02160003
021700     MOVE PA-RECS-READ            TO PV-DISPLAY-COUNT.            02170003
021800     DISPLAY 'TOTAL RECORDS READ            : '  PV-DISPLAY-COUNT.02180003
021900                                                                  02190003
022000     MOVE PA-BUSEV-DELETES        TO PV-DISPLAY-COUNT.            02200003
022100     DISPLAY 'TOTAL BUSEV DELETES           : '  PV-DISPLAY-COUNT.02210003
022200                                                                  02220003
022300     MOVE PA-BUSEV-DEL-FAIL       TO PV-DISPLAY-COUNT.            02230003
022400     DISPLAY 'TOTAL BUSEV DELETES FAILED    : '  PV-DISPLAY-COUNT.02240003
022500                                                                  02250003
022600     MOVE PA-BUSEV-NOT-FOUND      TO PV-DISPLAY-COUNT.            02260003
022700     DISPLAY 'TOTAL BUSEV NOT FOUND         : '  PV-DISPLAY-COUNT.02270003
022800                                                                  02280003
022900     DISPLAY '****************************************'.          02290003
023000                                                                  02300003
023100******************************************************************02310003
023200*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    02320003
023300*  ERROR OR WARNING CODE OCCURS.                                  02330003
023400******************************************************************02340003
023500 9100-SQL-ABEND.                                                  02350003
023600                                                                  02360003
023700     DISPLAY '9100-SQL-ABEND'.                                    02370003
023800     DISPLAY '** ABEND     **'.                                   02380003
023900     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        02390003
024000     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              02400003
024100     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     02410003
024200     DISPLAY '***'                                                02420003
024300     DISPLAY '*** LAST COMMIT TAKEN **' PV-COMMIT-INFO            02430003
024400     DISPLAY '***'                                                02440003
024500     DISPLAY '*** COMMITTED UPDATE COUNTS FOLLOW: ***'            02450003
024600     DISPLAY '***'                                                02460003
024700     EXEC SQL                                                     02470003
024800          ROLLBACK                                                02480003
024900     END-EXEC.                                                    02490003
025000******************************************************************02500003
025100* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    02510003
025200* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         02520003
025300* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     02530003
025400* FORMAT.                                                         02540003
025500******************************************************************02550003
025600     COPY DPPD004.                                                02560003
025700                                                                  02570003
025800     MOVE +4013                  TO ABEND-CODE.                   02580003
025900     CALL 'ILBOABN0' USING ABEND-CODE.                            02590003
