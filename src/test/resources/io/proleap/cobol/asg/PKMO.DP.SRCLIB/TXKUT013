000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.   TXKUT013.                                          00020000
000300 AUTHOR.       BARB SCHULTZ.                                      00030000
000400 DATE-WRITTEN. FEB 2011.                                          00040000
000500******************************************************************00050000
000600*  MODULE TYPE:   COBOL2 DB2 BATCH                                00060000
000700*                                                                 00070000
000800*  DESCRIPTION: THIS PROGRAM WILL USE A SKU AND STORE NUMBERS FROM00080000
000900*     A CONTROL CARD TO COUNT AND ACCUMULATE ENVIRONMENTAL BAG    00090000
001000*     FEES.  THIS PROGRAM WILL CREATE AN EXTRACT FILE WHICH       00100000
001200*     WILL BE USED TO FEED REPORT PROGRAM TXKRP010.               00120000
001400******************************************************************00120119
001200**** USE THE LAST DAY IN THE FISCAL MONTH IN THE CONTROL CARD ****00121019
001400******************************************************************00122019
001300*  JOB: TXK501                                                    00130013
001400******************************************************************00140000
001500 ENVIRONMENT DIVISION.                                            00150000
001600 CONFIGURATION SECTION.                                           00160000
001700 SOURCE-COMPUTER.        IBM-3090.                                00170000
001800 OBJECT-COMPUTER.        IBM-3090.                                00180000
001900                                                                  00190000
002000 INPUT-OUTPUT SECTION.                                            00200000
002100                                                                  00210000
002200 FILE-CONTROL.                                                    00220000
002300                                                                  00230000
002400     SELECT DATE-CONTROL-FILE                                     00240000
002500       ASSIGN TO INP01.                                           00250000
002600                                                                  00260000
002700     SELECT SKU-CONTROL-FILE                                      00270000
002800       ASSIGN TO INP02.                                           00280000
002900                                                                  00290000
003000     SELECT BAG-FEE-EXTRACT-FILE                                  00300000
003100       ASSIGN TO OUT01.                                           00310000
003200                                                                  00320000
003300******************************************************************00330000
003400 DATA DIVISION.                                                   00340000
003500 FILE SECTION.                                                    00350000
003600                                                                  00360000
003700 FD  DATE-CONTROL-FILE                                            00370000
003800     RECORDING MODE F                                             00380000
003900     BLOCK CONTAINS 0 RECORDS                                     00390000
004000     LABEL RECORDS ARE OMITTED.                                   00400000
004100 01  DATE-CONTROL-RECORD                  PIC  X(80).             00410000
004200                                                                  00420000
004300 FD  SKU-CONTROL-FILE                                             00430000
004400     RECORDING MODE F                                             00440000
004500     BLOCK CONTAINS 0 RECORDS                                     00450000
004600     LABEL RECORDS ARE OMITTED.                                   00460000
004700 01  SKU-CONTROL-RECORD                   PIC  X(80).             00470000
004800                                                                  00480000
004900 FD  BAG-FEE-EXTRACT-FILE                                         00541000
005000     RECORDING MODE F                                             00542000
005100     BLOCK CONTAINS 0 RECORDS                                     00543000
005200     LABEL RECORDS ARE OMITTED.                                   00544000
005300 01  BAG-FEE-EXTRACT-RECORD               PIC  X(125).            00545011
005400                                                                  00546000
005500 WORKING-STORAGE SECTION.                                         00550000
005600                                                                  00560000
005700******************************************************************00570000
005800* CONTROL CARDS - FISCAL PERIOD END DATE                          00580000
005700******************************************************************00581000
006000 01  CC-DATE-CONTROL-CARD.                                        00600000
006100     05  CC-FISCAL-END-DATE          PIC  X(10) VALUE SPACE.      00610000
006200     05  CC-FISCAL-END-DATE-R REDEFINES CC-FISCAL-END-DATE.       00620000
006300         10  CC-FISCAL-END-CCYY      PIC  X(04).                  00630000
006400         10  FILLER                  PIC  X.                      00640000
006500         10  CC-FISCAL-END-MM        PIC  X(02).                  00650000
006600         10  FILLER                  PIC  X.                      00660000
006700         10  CC-FISCAL-END-DD        PIC  X(02).                  00670000
006800     05  FILLER                      PIC  X(70) VALUE SPACE.      00680000
006900                                                                  00690000
007800************************************************************      00780007
007800* CONTROL CARDS - SKU NUMBER                                      00780107
007800************************************************************      00780207
007800 01  CC-SKU-CONTROL-CARD.                                         00780307
007800     05  CC-SKU-NBR                  PIC  9(08) VALUE ZERO.       00780407
007800     05  CC-SKU-NBR-X REDEFINES                                   00780507
007800         CC-SKU-NBR                  PIC  X(08).                  00780607
007800     05  FILLER                      PIC  X(72) VALUE SPACE.      00780707
007800                                                                  00780807
005700******************************************************************00789100
008000* PS PROGRAM SWITCHES                                             00800000
005700******************************************************************00801000
008200 01  PS-PROGRAM-SWITCHES.                                         00820000
008300     05  PS-DATE-CONTROL-EOF-SW     PIC  X(001) VALUE 'N'.        00830000
008400       88  PS-DATE-CONTROL-EOF-YES              VALUE 'Y'.        00840000
008500       88  PS-DATE-CONTROL-EOF-NO               VALUE 'N'.        00850000
008600                                                                  00860000
008700     05  PS-SKU-CONTROL-EOF-SW      PIC  X(001) VALUE 'N'.        00870000
008800       88  PS-SKU-CONTROL-EOF-YES               VALUE 'Y'.        00880000
008900       88  PS-SKU-CONTROL-EOF-NO                VALUE 'N'.        00890000
009000                                                                  00900000
009100     05  PS-BAG-FEE-CURSOR-EOF-SW PIC X(001) VALUE 'N'.           00910000
009200       88  PS-BAG-FEE-CURSOR-EOF-YES             VALUE 'Y'.       00920000
009300       88  PS-BAG-FEE-CURSOR-EOF-NO              VALUE 'N'.       00930000
009400                                                                  00940000
009500     05  PS-SKU-DESC-FOUND-SW PIC X(001) VALUE 'N'.               00950000
009600       88  PS-SKU-DESC-FOUND-YES                 VALUE 'Y'.       00960000
009700       88  PS-SKU-DESC-FOUND-NO                  VALUE 'N'.       00970000
009800                                                                  00980000
005700******************************************************************00981000
010000* PROGRAM CONSTANTS                                               01000000
005700******************************************************************01001000
010200 01  PC-PROGRAM-CONSTANTS.                                        01020000
010300     05  PC-CURRENT-PROGRAM-NAME   PIC  X(08)   VALUE 'TXKUT013'. 01030000
010500                                                                  01050000
005700******************************************************************01051000
010700* PV PROGRAM VARIABLES                                            01070000
005700******************************************************************01071000
010900 01  PV-PROGRAM-VARAIBLES.                                        01090000
011000     05  PV-SQL-SUB                   PIC S9(04) COMP VALUE +0.   01100000
011100     05  PV-MAX-SKU-TABLE-SUB         PIC S9(04) COMP VALUE +100. 01111007
011200     05  PV-HOLD-PERIOD-START-DTE     PIC X(10)  VALUE SPACES.    01120003
011300     05  PV-HOLD-PERIOD-END-DTE       PIC X(10)  VALUE SPACES.    01130003
012100     05  PV-HOLD-STR-NBR              PIC S9(04) VALUE ZERO COMP. 01131000
044500     05  PV-SKU-DB2-NBR               PIC S9(8) COMP-3 VALUE ZERO.01133003
036100     05  PV-HOLD-LAST-FISCAL-DAY      PIC X(10)  VALUE SPACES.    01134015
011400                                                                  01140000
005700******************************************************************01220107
011600* SKU NUMBERS TO BE PROCESSED                                     01220207
005700******************************************************************01220307
011800 01  PV-SKU-DATA-TABLE.                                           01220407
011900     05  PV-SKU-DATA-ENTRYS OCCURS 100 TIMES                      01220507
012000         INDEXED BY PV-SKU-NDX1.                                  01220607
012100         10  PV-SKU-NBR                   PIC  9(08)  VALUE ZERO. 01220707
012200                                                                  01220807
005700******************************************************************01221000
012400* THIS IS THE COPYBOOK FOR BAG FEES COLLECTED AND                *01240000
005700******************************************************************01241000
012700     COPY TXRD002.                                                01270000
012800                                                                  01280000
005700******************************************************************01281000
013000* DATE ROUTINE COPY MEMBERS                                       01300000
005700******************************************************************01301000
013200     COPY DPWS500.                                                01320000
013300                                                                  01330000
005700******************************************************************01331000
013500* PROGRAM ACCUMULATORS                                            01350000
005700******************************************************************01351000
013700 01  PA-PROGRAM-ACCUMULATORS.                                     01370000
013800     05  PA-DATE-CONTROL-RECS-READ    PIC  9(09)   VALUE ZERO.    01380000
013900     05  PA-SKU-CONTROL-RECS-READ     PIC  9(09)   VALUE ZERO.    01391000
014000     05  PA-BAG-FEE-ROWS-READ         PIC  9(09)   VALUE ZERO.    01400000
014100     05  PA-BAG-FEE-RECS-WRITTEN      PIC  9(09)   VALUE ZERO.    01410000
014200     05  PA-BAG-FEE-CURSOR-READS      PIC  9(09)   VALUE ZERO.    01420000
014300                                                                  01430000
005700******************************************************************01431000
014500* ERROR HANDLING                                                  01450000
005700******************************************************************01451000
014700 01  PV-MISC-ABEND-FIELDS.                                        01470000
014800     05  PV-PARAGRAPH-NAME     PIC  X(030)  VALUE SPACE.          01480000
014900     05  PV-OPERATION-MSG-1    PIC  X(040)  VALUE SPACE.          01490000
015000     05  PV-OPERATION-MSG-2    PIC  X(040)  VALUE SPACE.          01500000
015100     05  PV-DB2-OPERATION      PIC  X(030)  VALUE SPACE.          01510000
015200                                                                  01520000
015300 01  ABEND-CODE                PIC S9(004)  VALUE ZEROS           01530000
015400                                            COMP  SYNC.           01540000
015500     88  ABEND-4003-INVALID-CNTL-CARD       VALUE +4003.          01550000
015600     88  ABEND-4004-TABLE-OVERFLOW          VALUE +4004.          01560000
015700     88  ABEND-4013-DB2-ERROR               VALUE +4013.          01570000
015800     88  ABEND-4019-CAL-SUB-ERROR           VALUE +4019.          01580000
015900                                                                  01590000
005700******************************************************************01591000
016100* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         01610000
005700******************************************************************01611000
016300     COPY DPWS004.                                                01630000
016400                                                                  01640000
005700******************************************************************01641000
016600* DB2 MESSAGE AREA                                                01660000
005700******************************************************************01661000
016800     COPY SQLCA2.                                                 01680000
016900                                                                  01690000
005700******************************************************************01691000
017100* DB2 COMMUNICATIONS AREA                                         01710000
005700******************************************************************01711000
017300     EXEC SQL                                                     01730000
017400       INCLUDE SQLCA                                              01740000
017500     END-EXEC.                                                    01750000
017600                                                                  01760000
005700******************************************************************01761000
017800* DB2 TABLE XST_LOC    (XST00001)                                 01780000
005700******************************************************************01781000
018000     EXEC SQL                                                     01800000
018100       INCLUDE XST00001                                           01810000
018200     END-EXEC.                                                    01820000
018300                                                                  01830000
005700******************************************************************01831000
018500* DB2 TABLE TEPPART                                               01850000
005700******************************************************************01851000
018700     EXEC SQL                                                     01870000
018800       INCLUDE TEPPART                                            01880000
018900     END-EXEC.                                                    01890000
019000                                                                  01900000
005700******************************************************************01901000
019200* DB2 TABLE TEPTRN                                                01920000
005700******************************************************************01921000
019400     EXEC SQL                                                     01940000
019500       INCLUDE TEPTRN                                             01950000
019600     END-EXEC.                                                    01960000
019700                                                                  01970000
005700******************************************************************01971000
019900* DB2 TABLE TEPITM                                                01990000
005700******************************************************************01991000
020100     EXEC SQL                                                     02010000
020200       INCLUDE TEPITM                                             02020000
020300     END-EXEC.                                                    02030000
020400                                                                  02040000
005700******************************************************************02041000
020600* DB2 TABLE XST_SKU                                               02060000
005700******************************************************************02061000
020800     EXEC SQL                                                     02080000
020900       INCLUDE XST00010                                           02090000
021000     END-EXEC.                                                    02100000
021100                                                                  02110000
005700******************************************************************02111000
021300* TRANSACTION RETURN CURSOR                                       02130000
005700******************************************************************02131000
021500     EXEC SQL                                                     02150000
021600       DECLARE BAG-FEE-CSR CURSOR FOR                             02160000
021700         SELECT B.SKU_NBR                                         02170000
021800               ,B.STR_NBR                                         02180000
021800               ,B.RGST_ID                                         02181011
021800               ,B.TRN_NBR                                         02182011
021800               ,A.SLS_DTE                                         02183012
021800               ,B.STRT_TM                                         02183111
021900               ,D.ST_CDE                                          02190000
022000               ,C.TRN_TYP_CDE                                     02200000
022100               ,B.SLD_QTY                                         02210000
022200               ,B.NET_CHRGD_AMT                                   02220000
022300           FROM TEPPART A                                         02230000
022400               ,TEPITM  B                                         02240000
022500               ,TEPTRN  C                                         02250000
022600               ,XST_LOC D                                         02260000
022700          WHERE A.PARTN_NBR     = B.PARTN_NBR                     02270000
022800            AND A.PARTN_NBR     = C.PARTN_NBR                     02280000
022900            AND C.STR_NBR       = B.STR_NBR                       02290000
023000            AND C.RGST_ID       = B.RGST_ID                       02300000
023100            AND C.TRN_NBR       = B.TRN_NBR                       02310000
023200            AND C.STRT_TM       = B.STRT_TM                       02320000
023300            AND C.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR           02330000
023400            AND C.STR_NBR       = D.LOC_NBR                       02340000
023500            AND A.SLS_DTE      >= :PV-HOLD-PERIOD-START-DTE       02350000
023700            AND A.SLS_DTE      <= :PV-HOLD-PERIOD-END-DTE         02370000
023800            AND C.TRN_TYP_CDE  IN ('01', '02' , '11', '12')       02380000
023900            AND C.TRN_STAT_CDE IN ('V', 'Z', 'L', 'R')            02390000
024000            AND C.VOID_ABRT_CDE IN ('N','U')                      02400000
024100            AND B.LIV_RSLU_CDE = '+'                              02410000
024200            AND B.SKU_NBR      = :XST00010-SKU-NBR                02420000
024300           ORDER BY B.STR_NBR                                     02430000
024400        FOR FETCH ONLY                                            02440000
024500        WITH UR                                                   02450000
024600     END-EXEC.                                                    02460000
024700                                                                  02470000
005700******************************************************************02471000
024900 PROCEDURE DIVISION.                                              02490000
005700******************************************************************02491000
025100 0000-MAINLINE.                                                   02510000
025200                                                                  02520000
025300     DISPLAY '************ START OF TXKUT013 ***************'.    02530000
025400                                                                  02540000
025500     PERFORM 1000-INITIALIZATION.                                 02550000
025600                                                                  02560000
025700     PERFORM 2000-PROC-SKU-TABLE                                  02570007
025800         VARYING PV-SKU-NDX1 FROM 1 BY 1                          02580007
025900         UNTIL PV-SKU-NDX1 > PA-SKU-CONTROL-RECS-READ.            02590007
012000                                                                  02601002
026100     PERFORM 9999-WRAPUP.                                         02610000
026200                                                                  02620000
026300     DISPLAY '************  END OF TXKUT013  ***************'.    02630000
026400                                                                  02640000
026500     GOBACK.                                                      02650000
026600                                                                  02660000
005700******************************************************************02661000
026800* INITIALIZATION.                                                 02680000
026900*     OPENS FILES                                                 02690000
027000*     INITIALIZES VARIABLES                                       02700000
027100*     PERFORM INITIAL READ                                        02710000
005700******************************************************************02711000
027300 1000-INITIALIZATION.                                             02730000
027400                                                                  02740000
027500     OPEN INPUT  DATE-CONTROL-FILE                                02750000
027600                 SKU-CONTROL-FILE                                 02760000
027700          OUTPUT BAG-FEE-EXTRACT-FILE.                            02770000
027800                                                                  02780000
027900     PERFORM 8000-READ-DATE-CONTROL-FILE.                         02790000
028000                                                                  02800000
028100     IF  PS-DATE-CONTROL-EOF-YES                                  02810000
028200         MOVE '8000-READ-DATE-CONTROL-FILE  ' TO PV-PARAGRAPH-NAME02820000
028300         MOVE 'NO CONTROL CARD TO PROCESS' TO PV-OPERATION-MSG-1  02830000
028400         SET ABEND-4003-INVALID-CNTL-CARD  TO TRUE                02840000
028400         MOVE +4003 TO ABEND-CODE                                 02841015
028500         PERFORM 9910-ABEND                                       02850000
028600     END-IF.                                                      02860000
028700                                                                  02870000
028800     PERFORM 1100-GET-FISCAL-PERIOD-START.                        02880000
028900                                                                  02890000
029000     DISPLAY ' '.                                                 02900000
029100     DISPLAY 'CONTROL CARD DATE: ' CC-FISCAL-END-DATE.            02910000
029200                                                                  02920000
029300     DISPLAY ' '.                                                 02930000
029400     DISPLAY 'REPORTING FISCAL PERIOD =>'                         02940000
029500             ' START: ' PV-HOLD-PERIOD-START-DTE                  02950000
029600             ' - '                                                02960000
029700             ' END : ' PV-HOLD-PERIOD-END-DTE.                    02970000
029800                                                                  02980000
029900     PERFORM 8100-READ-SKU-CONTROL-FILE.                          02990000
030000                                                                  03000000
030100     IF  PS-SKU-CONTROL-EOF-YES                                   03010000
030200         DISPLAY '*********************************'              03020000
030300         DISPLAY '** ABEND SKU CC NOT FOUND      **'              03030000
030400         DISPLAY '** PROGRAM = TXKUT013          **'              03040000
030500         DISPLAY '*********************************'              03050000
030600         DISPLAY DPG54-ERROR-MESSAGE                              03060000
030700         SET ABEND-4003-INVALID-CNTL-CARD  TO TRUE                03070000
028400         MOVE +4003 TO ABEND-CODE                                 03071015
030800         PERFORM 9910-ABEND                                       03080000
030900     END-IF.                                                      03090000
031000                                                                  03100000
031100     DISPLAY ' '.                                                 03110000
031200     DISPLAY 'START - SKU NUMBER TABLE LOAD: '.                   03120000
031300     DISPLAY ' '.                                                 03130000
031400                                                                  03130100
031500     PERFORM 1200-LOAD-SKU-TABLE                                  03131008
031600       UNTIL PS-SKU-CONTROL-EOF-YES.                              03132007
031400                                                                  03140000
032200******************************************************************03220000
032300* GET FISCAL PERIOD START DATE                                    03230000
032400******************************************************************03240000
032500 1100-GET-FISCAL-PERIOD-START.                                    03250000
032600                                                                  03260000
032700     INITIALIZE DPG51 DPG52 DPG53                                 03270000
032800                DPG54 DPG55 DPG56.                                03280000
032900                                                                  03290000
033000     SET DPG51-FISCAL-454-CALENDAR   TO TRUE.                     03300000
033100     SET DPG52-LK-DTE-ISO-FMT        TO TRUE.                     03310000
033200                                                                  03320000
033300     MOVE CC-FISCAL-END-DATE      TO DPG52-LK-DATE-INPUT.         03330000
033400                                                                  03340000
033500     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    03350000
033600                                             DPG54 DPG55 DPG56.   03360000
033700                                                                  03370000
033800     IF  DPG54-SEVERE-ERROR OR DPG54-WARNING-ERROR                03380018
033900         DISPLAY '*********************************'              03390000
034000         DISPLAY '** ABEND FROM CALL SUB         **'              03400000
034100         DISPLAY '** PROGRAM = TXKUT013          **'              03410000
034200         DISPLAY '** DATE = ' CC-FISCAL-END-DATE '     **'        03420000
034300         DISPLAY '*********************************'              03430000
034400         DISPLAY DPG54-ERROR-MESSAGE                              03440000
034500         SET ABEND-4019-CAL-SUB-ERROR  TO TRUE                    03450000
028400         MOVE +4019 TO ABEND-CODE                                 03451015
034600         PERFORM 9910-ABEND                                       03460000
035800     END-IF.                                                      03580000
035900                                                                  03590000
036000     MOVE DPG56-FIRST-FP-DB2-ISO-FMT TO PV-HOLD-PERIOD-START-DTE. 03600000
036100     MOVE DPG56-LAST-FP-DB2-ISO-FMT  TO PV-HOLD-PERIOD-END-DTE.   03610018
035900                                                                  03620018
036300******************************************************************03630000
036400* LOAD SKU TABLE XREF                                             03640000
036500******************************************************************03650000
036600 1200-LOAD-SKU-TABLE.                                             03660000
036700                                                                  03670000
037000     IF  PA-SKU-CONTROL-RECS-READ < PV-MAX-SKU-TABLE-SUB          03700007
037100                                                                  03710007
044500         IF  CC-SKU-NBR IS NUMERIC                                03720007
037300             MOVE CC-SKU-NBR                                      03730007
037400               TO PV-SKU-NBR (PA-SKU-CONTROL-RECS-READ)           03740007
037500             DISPLAY ' SKU=' PV-SKU-NBR (PA-SKU-CONTROL-RECS-READ)03750007
037600         ELSE                                                     03760007
037700             DISPLAY '*********************************'          03770007
037800             DISPLAY '** ABEND INVALID SKU NUMBER    **'          03780007
037900             DISPLAY '** PROGRAM = TXKUT013          **'          03790014
038000             DISPLAY '** SKU  = ' CC-SKU-NBR-X    '    **'        03800007
038100             DISPLAY '*********************************'          03810007
038200             DISPLAY DPG54-ERROR-MESSAGE                          03820007
038300             SET ABEND-4003-INVALID-CNTL-CARD TO TRUE             03830007
028400             MOVE +4003 TO ABEND-CODE                             03840015
039500             PERFORM 9910-ABEND                                   03950007
039600         END-IF                                                   03960007
039700     ELSE                                                         03970007
039700         DISPLAY '*********************************'              03971007
039700         DISPLAY '** ABEND SKU TABLE OVERFLOW    **'              03972007
039700         DISPLAY '** PROGRAM = TXKUT013          **'              03972114
039700         DISPLAY '** SKU = ' CC-SKU-NBR-X                         03972207
039700         DISPLAY '** SUB = ' PA-SKU-CONTROL-RECS-READ             03972307
039700         DISPLAY '*********************************'              03972407
039700         DISPLAY DPG54-ERROR-MESSAGE                              03972507
039700         SET ABEND-4004-TABLE-OVERFLOW TO TRUE                    03972607
028400         MOVE +4004 TO ABEND-CODE                                 03972715
039700         PERFORM 9910-ABEND                                       03972807
039700     END-IF.                                                      03972907
039700                                                                  03973007
039700     PERFORM 8100-READ-SKU-CONTROL-FILE.                          03973107
039700                                                                  03973207
039800******************************************************************03982000
039900* PROCESS SKU IN TABLE                                            03990007
040000******************************************************************04000000
040100 2000-PROC-SKU-TABLE.                                             04010007
040200                                                                  04020000
040300     MOVE PV-SKU-NBR (PV-SKU-NDX1) TO XST00010-SKU-NBR.           04030007
040400     DISPLAY '  PROCESSING SKU = ' XST00010-SKU-NBR.              04040007
040500                                                                  04050000
040600****** GET SKU DESC                                               04060000
040700                                                                  04070000
040800     PERFORM 8300-SELECT-SKU-DESC.                                04080000
040900                                                                  04090000
041000     IF  PS-SKU-DESC-FOUND-YES                                    04100000
041100         CONTINUE                                                 04110000
041200     ELSE                                                         04120000
041300         MOVE '** SKU DESC NOT FOUND' TO XST00010-SKU-DESC        04130006
041400     END-IF.                                                      04140000
041500                                                                  04150000
041600****** EXECUTE SKU CURSOR                                         04160000
041700                                                                  04170000
041800     SET PS-BAG-FEE-CURSOR-EOF-NO TO TRUE.                        04180000
041900                                                                  04190000
042000     PERFORM 8200-OPEN-BAG-FEE-CSR.                               04200000
042100                                                                  04210000
042200     PERFORM 8210-FETCH-BAG-FEE-ROW.                              04220000
042300                                                                  04230000
042400     IF  PS-BAG-FEE-CURSOR-EOF-YES                                04240000
042500         INITIALIZE TX002-BAG-FEE-RECORD                          04250001
042600                                                                  04260000
042700         MOVE PV-SKU-NBR (PV-SKU-NDX1) TO TX002-SKU-NBR           04270009
042800         MOVE XST00010-SKU-DESC        TO TX002-SKU-DESC          04280001
042900                                                                  04290000
043000         PERFORM 8500-WRITE-BAG-FEE-EXTRACT                       04300000
043100     END-IF.                                                      04310000
043200                                                                  04320000
043300     PERFORM 2100-PROC-SKU-BAG-FEES                               04330000
043400         UNTIL PS-BAG-FEE-CURSOR-EOF-YES.                         04340000
043500                                                                  04350000
043600     PERFORM 8220-CLOSE-BAG-FEE-CSR.                              04360000
043700                                                                  04370000
043800******************************************************************04380000
043900* PROCESS BAG FEES FOR SKU                                        04390000
044000******************************************************************04400000
044100 2100-PROC-SKU-BAG-FEES.                                          04410000
044200                                                                  04420000
044300     INITIALIZE TX002-BAG-FEE-RECORD.                             04430001
044400                                                                  04440000
044500     MOVE EPITM-SKU-NBR              TO TX002-SKU-NBR.            04450001
044600     MOVE XST00010-SKU-DESC          TO TX002-SKU-DESC.           04460001
044700     MOVE EPITM-STR-NBR              TO TX002-STR-NBR.            04470001
044700     MOVE EPITM-RGST-ID              TO TX002-RGST-ID.            04471011
044700     MOVE EPITM-TRN-NBR              TO TX002-TRN-NBR.            04472011
044700     MOVE EPPART-SLS-DTE             TO TX002-SLS-DTE.            04473011
044700     MOVE EPITM-STRT-TM              TO TX002-STRT-TM.            04474011
044800     MOVE XST00001-ST-CDE            TO TX002-ST-CDE.             04480001
046100     IF  EPTRN-TRN-TYP-CDE  = '01' OR '02'                        04489111
046200        MOVE EPITM-SLD-QTY           TO TX002-UNITS-SOLD          04489211
046300        MOVE EPITM-NET-CHRGD-AMT     TO TX002-FEES-CHRGD          04489311
046400     ELSE                                                         04489411
046500        MOVE EPITM-SLD-QTY           TO TX002-UNITS-RTND          04489511
046600        MOVE EPITM-NET-CHRGD-AMT     TO TX002-FEES-RTND           04489611
046700     END-IF.                                                      04489711
044900                                                                  04489811
045400     PERFORM 8500-WRITE-BAG-FEE-EXTRACT.                          04489911
046800                                                                  04490011
046900     PERFORM 8210-FETCH-BAG-FEE-ROW.                              04491011
044900                                                                  04500000
047200******************************************************************04720000
047300* READ DATE CONTROL CARD.                                         04730000
047400******************************************************************04740000
047500 8000-READ-DATE-CONTROL-FILE.                                     04750000
047600                                                                  04760000
047700     READ DATE-CONTROL-FILE INTO CC-DATE-CONTROL-CARD             04770000
047800        AT END                                                    04780000
047900           SET PS-DATE-CONTROL-EOF-YES TO TRUE.                   04790000
048000                                                                  04800000
048100     IF  PS-DATE-CONTROL-EOF-NO                                   04810000
048200         ADD 1 TO PA-DATE-CONTROL-RECS-READ                       04820000
048300     END-IF.                                                      04830000
048400                                                                  04840000
048500******************************************************************04850000
048600* READ SKU NBR CONTROL CARD.                                      04860000
048700******************************************************************04870000
048800 8100-READ-SKU-CONTROL-FILE.                                      04880000
048900                                                                  04890000
049000     READ SKU-CONTROL-FILE INTO CC-SKU-CONTROL-CARD               04900000
049100        AT END                                                    04910000
049200           SET PS-SKU-CONTROL-EOF-YES TO TRUE.                    04920000
049300                                                                  04930000
049400     IF  PS-SKU-CONTROL-EOF-NO                                    04940000
049500         ADD 1 TO PA-SKU-CONTROL-RECS-READ                        04950000
049600     END-IF.                                                      04960000
049700                                                                  04970000
049800******************************************************************04980000
049900* OPEN ITEM CSR                                                   04990000
050000******************************************************************05000000
050100 8200-OPEN-BAG-FEE-CSR.                                           05010000
050900                                                                  05090000
051000     EXEC SQL                                                     05100000
051100        OPEN BAG-FEE-CSR                                          05110000
051200     END-EXEC.                                                    05120000
051300                                                                  05130000
051400     EVALUATE TRUE                                                05140000
051500        WHEN SQLCODE = 0                                          05150000
051600        WHEN SQLCODE = -904                                       05160000
051700        WHEN SQLCODE = -911                                       05170000
051800        WHEN SQLCODE = -913                                       05180000
051900            CONTINUE                                              05190000
052000        WHEN SQLWARN0 NOT EQUAL SPACE                             05200000
052100        WHEN SQLCODE  NOT EQUAL ZERO                              05210000
052200            MOVE '8200-OPEN-BAG-FEE-CSR'                          05220000
052300                                     TO PV-PARAGRAPH-NAME         05230000
052400            MOVE 'ERROR ON OPEN OF BAG-FEE-CSR CURSOR'            05240000
052500                                     TO PV-DB2-OPERATION          05250000
052600            PERFORM 9900-SQL-ABEND-ROUTINE                        05260000
052700     END-EVALUATE.                                                05270000
052900                                                                  05290000
053800******************************************************************05380000
053900* FETCH BAG FEE ROW                                               05390000
054000******************************************************************05400000
054100 8210-FETCH-BAG-FEE-ROW.                                          05410000
054200                                                                  05420000
055100     EXEC SQL                                                     05510000
055200         FETCH BAG-FEE-CSR                                        05520000
055300            INTO :EPITM-SKU-NBR                                   05530000
055400                ,:EPITM-STR-NBR                                   05540000
055400                ,:EPITM-RGST-ID                                   05541011
055400                ,:EPITM-TRN-NBR                                   05542011
055400                ,:EPPART-SLS-DTE                                  05543012
055400                ,:EPITM-STRT-TM                                   05544011
055500                ,:XST00001-ST-CDE                                 05550000
055600                ,:EPTRN-TRN-TYP-CDE                               05560000
055700                ,:EPITM-SLD-QTY                                   05570000
055800                ,:EPITM-NET-CHRGD-AMT                             05580000
055900     END-EXEC.                                                    05590000
056000                                                                  05600000
056100     EVALUATE TRUE                                                05610000
056200         WHEN SQLCODE = -904                                      05620000
056300         WHEN SQLCODE = -911                                      05630000
056400         WHEN SQLCODE = -913                                      05640000
056500             CONTINUE                                             05650000
056600         WHEN SQLCODE = ZERO                                      05660000
056700             ADD 1 TO PA-BAG-FEE-CURSOR-READS                     05670000
056800                                                                  05680000
056900         WHEN SQLCODE = +100                                      05690000
057000             SET PS-BAG-FEE-CURSOR-EOF-YES TO TRUE                05700000
057100         WHEN SQLWARN0 NOT EQUAL SPACE                            05710000
057200         WHEN SQLCODE NOT EQUAL ZERO                              05720000
057300             MOVE '8210-FETCH-BAG-FEE-ROW'                        05730000
057400                                     TO PV-PARAGRAPH-NAME         05740000
057500             MOVE 'ERROR ON RET CSR'                              05750000
057600                                     TO PV-DB2-OPERATION          05760000
057700             PERFORM 9900-SQL-ABEND-ROUTINE                       05770000
057800     END-EVALUATE.                                                05780000
058000                                                                  05800000
058900******************************************************************05890000
059000* CLOSE BAG FEE CURSOR                                            05900000
059100******************************************************************05910000
059200 8220-CLOSE-BAG-FEE-CSR.                                          05920000
059300                                                                  05930000
060100     EXEC SQL                                                     06010000
060200         CLOSE BAG-FEE-CSR                                        06020000
060300     END-EXEC.                                                    06030000
060400                                                                  06040000
060500     EVALUATE TRUE                                                06050000
060600         WHEN SQLCODE = -904                                      06060000
060700         WHEN SQLCODE = -911                                      06070000
060800         WHEN SQLCODE = -913                                      06080000
060900         WHEN SQLCODE = 0                                         06090000
061000             CONTINUE                                             06100000
061100         WHEN SQLWARN0 NOT EQUAL SPACE                            06110000
061200         WHEN SQLCODE NOT EQUAL ZERO                              06120000
061300             MOVE '8220-CLOSE-BAG-FEE-CSR'                        06130000
061400                                     TO PV-PARAGRAPH-NAME         06140000
061500             MOVE 'ERROR ON CLOSE OF BAG-FEE-CSR'                 06150000
061600                                     TO PV-DB2-OPERATION          06160000
061700             PERFORM 9900-SQL-ABEND-ROUTINE                       06170000
061800     END-EVALUATE.                                                06180000
062000                                                                  06200000
062900******************************************************************06290000
063000* SELECT SKU DESC                                                 06300000
063100******************************************************************06310000
063200 8300-SELECT-SKU-DESC.                                            06320000
063300                                                                  06330000
063400     SET PS-SKU-DESC-FOUND-NO  TO TRUE.                           06340000
064300                                                                  06430000
064400     EXEC SQL                                                     06440000
064500         SELECT SKU_DESC                                          06450000
064600            INTO :XST00010-SKU-DESC                               06460000
064700            FROM XST_SKU                                          06470000
064800         WHERE SKU_NBR  = :XST00010-SKU-NBR                       06480010
064900     END-EXEC.                                                    06490000
065000                                                                  06500000
065100     EVALUATE TRUE                                                06510000
065200        WHEN SQLCODE = -904                                       06520000
065300        WHEN SQLCODE = -911                                       06530000
065400        WHEN SQLCODE = -913                                       06540000
065500           CONTINUE                                               06550000
065600        WHEN SQLCODE = ZERO                                       06560000
065700           SET PS-SKU-DESC-FOUND-YES TO TRUE                      06570000
065800        WHEN SQLCODE = +100                                       06580000
065900           CONTINUE                                               06590000
066000        WHEN SQLWARN0 NOT EQUAL SPACE                             06600000
066100        WHEN SQLCODE NOT EQUAL ZERO                               06610000
066200           MOVE '8300-SELECT-SKU-DESC'                            06620000
066300                                     TO PV-PARAGRAPH-NAME         06630000
066400           MOVE 'ERROR ON SELECT'                                 06640000
066500                                     TO PV-DB2-OPERATION          06650000
066600           PERFORM 9900-SQL-ABEND-ROUTINE                         06660000
066700     END-EVALUATE.                                                06670000
066900                                                                  06690000
005700******************************************************************06771000
067900*     WRITE BAG FEE EXTRACT RECORD                                06790000
005700******************************************************************06791000
068100 8500-WRITE-BAG-FEE-EXTRACT.                                      06810000
068200                                                                  06820000
068300     WRITE BAG-FEE-EXTRACT-RECORD                                 06830000
068400        FROM TX002-BAG-FEE-RECORD.                                06840001
068500                                                                  06850000
068600     ADD 1 TO PA-BAG-FEE-RECS-WRITTEN.                            06860000
068700                                                                  06870000
005700******************************************************************06871000
068900*     SQL ABEND ROUTINE.                                          06890000
005700******************************************************************06891000
069100 9900-SQL-ABEND-ROUTINE.                                          06910000
069200                                                                  06920000
069300     DISPLAY '** ABEND     **'.                                   06930000
069400     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        06940000
069500     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              06950000
069600     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               06960000
069700                                                                  06970000
069800     COPY DPPD004.                                                06980000
069900     SET ABEND-4013-DB2-ERROR TO TRUE.                            06990000
070000     CALL 'ILBOABN0' USING ABEND-CODE.                            07000000
070100                                                                  07010000
005700******************************************************************07011000
070300*  ABEND - PERFORMS A NON-                                        07030000
005700******************************************************************07031000
070500 9910-ABEND.                                                      07050000
070600                                                                  07060000
070700     DISPLAY '** ABEND           **'.                             07070000
070800     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME   07080000
070900     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        07090000
071000     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       07100000
071100     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       07110000
071200     CALL 'ILBOABN0' USING ABEND-CODE.                            07120000
071300                                                                  07130000
005700******************************************************************07131000
071500*     END OF PROGRAM ROUTINE. CLOSES ALL FILES AND DISPLAYS       07150000
071600*     ANY DATA FROM THE PROGRAM.                                  07160000
005700******************************************************************07161000
071800 9999-WRAPUP.                                                     07180000
071900                                                                  07190000
072000     CLOSE DATE-CONTROL-FILE                                      07200000
072100          SKU-CONTROL-FILE                                        07210000
072200          BAG-FEE-EXTRACT-FILE.                                   07220000
072300                                                                  07230000
072400     DISPLAY ' '.                                                 07240000
072500     DISPLAY '*********************************************'      07250000
072600     DISPLAY '    TXKUT013 SUMMARY STATISTICS              '      07260000
072700     DISPLAY '*********************************************'      07270000
072800     DISPLAY ' '.                                                 07280000
072900     DISPLAY 'DATE CONTROL RECS READ ................: '          07290000
073000              PA-DATE-CONTROL-RECS-READ.                          07300000
073100     DISPLAY ' '.                                                 07310000
073200     DISPLAY 'SKU NBR CONTROL RECS READ .............: '          07320000
073300              PA-SKU-CONTROL-RECS-READ.                           07330005
073400     DISPLAY ' '.                                                 07343005
073500     DISPLAY 'TOTAL BAG FEE CURSOR READS ........: '              07350000
073600              PA-BAG-FEE-CURSOR-READS.                            07360000
073700     DISPLAY ' '.                                                 07370000
073800     DISPLAY 'BAG FEE RECORDS WRITTEN ...........: '              07380000
073900              PA-BAG-FEE-RECS-WRITTEN.                            07390000
074000     DISPLAY ' '.                                                 07400000
074100     DISPLAY '*********************************************'.     07410000
074200                                                                  07420000
