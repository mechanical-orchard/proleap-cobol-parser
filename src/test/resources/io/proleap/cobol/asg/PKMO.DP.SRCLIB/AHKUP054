000300 IDENTIFICATION DIVISION.                                         00030001
000400 PROGRAM-ID.         AHKUP054.                                    00040001
000500 AUTHOR.             PATRICK BURKE.                               00050001
000600 DATE-WRITTEN.       MAY 2000.                                    00060001
000700 DATE-COMPILED.                                                   00070001
000800*************************************************************     00080001
000900*    COBOL 2 WITH SQL                                       *     00090001
001000*                                                           *     00100001
001100*   AHKUP054 - ARCHIVE HISTORY DATA DELETION - TWRKORD      *     00110003
001200*                                                           *     00120001
001300*   PROGRAM OVERVIEW:                                       *     00130001
001400*                                                           *     00140001
001500*  THIS PROGRAM DELETES "OLD" ROWS FROM DB2 TABLE TWRKORD.  *     00150001
001600*  ROWS DELETED ARE THOSE PREVIOUSLY - IDENTIFIED/EXTRACTED *     00160001
001700*  WITHIN THE ARCHIVE/HISTORY SYSTEM.                       *     00170001
001800*                                                           *     00180001
001900*  THE EXTRACT FILE USED AS INPUT WILL BE SORTED BY THE     *     00190001
002000*  CLUSTERING INDEX COLUMNS TO SPEED THE DELETION PROCESS.  *     00200001
002100*  THESE COLUMNS ARE ORD_NBR, RCVR_SEQ_NBR, ORD_LNE_NBR,    *     00210002
002200*  WORK_ORD_SEQ_NBR, OPER-UNT_ID, FCLTY_ID, CRE_TMST.       *     00220002
002300*                                                           *     00230001
002400*   INPUT:                                                  *     00240001
002500*                                                           *     00250001
002600*     1. TWRKORD DELETION FILE  COPYBOOK DCLTWRKORD         *     00260002
002700*                                                           *     00270001
002800*   DB2 TABLES:                                             *     00280001
002900*                                                           *     00290001
003000*        TWRKORD - RECEIVING HEADER TABLE                   *     00300002
003100*        TCKRSTIN - CHECKPOINT/RESTART INFO TABLE           *     00310001
003200*        TCKRSTCN - CHECKPOINT/RESTART CONTROL TABLE        *     00320001
003300*                                                           *     00330001
003400*************************************************************     00340001
003500*                                                           *     00350001
003600*************************************************************     00360001
003700 EJECT                                                            00370001
003800 ENVIRONMENT DIVISION.                                            00380001
003900 CONFIGURATION SECTION.                                           00390001
004000 SOURCE-COMPUTER.        IBM-370.                                 00400001
004100 OBJECT-COMPUTER.        IBM-370.                                 00410001
004200                                                                  00420001
004300 INPUT-OUTPUT SECTION.                                            00430001
004400 FILE-CONTROL.                                                    00440001
004500     SELECT TWRKORD-EXTRACT-FILE ASSIGN TO INP01.                 00450002
004600                                                                  00460001
004700 DATA DIVISION.                                                   00470001
004800 FILE SECTION.                                                    00480001
004900 FD  TWRKORD-EXTRACT-FILE                                         00490002
005000     RECORDING MODE IS F                                          00500001
005100     LABEL RECORDS ARE STANDARD                                   00510001
005200     BLOCK CONTAINS 0 RECORDS                                     00520001
005300     RECORD CONTAINS 93 CHARACTERS                                00530009
005400     DATA RECORD IS TWRKORD-EXTRACT-DATA.                         00540002
005500 01  TWRKORD-EXTRACT-DATA       PIC X(93).                        00550009
005600                                                                  00560001
005700                                                                  00570001
005800 EJECT                                                            00580001
005900 WORKING-STORAGE SECTION.                                         00590001
006000                                                                  00600001
006100 01  FILLER                       PIC X(58)     VALUE             00610001
006200     '************WORKING STORAGE STARTS HERE*******************'.00620001
006300                                                                  00630001
006400 01  PV-PROGRAM-VARIABLES.                                        00640001
006500     05  PV-PROGRAM-NAME          PIC X(08)    VALUE 'AHKUP054'.  00650002
006600     05  PV-CKPT-STAT-CODE        PIC X(01)    VALUE SPACE.       00660001
006700     05  PV-CURRENT-PARAGRAPH     PIC X(50)    VALUE SPACES.      00670001
006800     05  PV-CURRENT-TMST          PIC X(26)    VALUE SPACES.      00680001
006900                                                                  00690001
007000     05  PV-TWRKORD-INPUT-COUNT   PIC 9(09)    VALUE ZERO         00700002
007100                                               COMP-3.            00710001
007200     05  PV-TWRKORD-DELETE-COUNT  PIC 9(09)    VALUE ZERO         00720002
007300                                               COMP-3.            00730001
007400     05  PV-SQL-DELETE-COUNT      PIC 9(09)    VALUE ZERO         00740001
007500                                               COMP-3.            00750001
007600     05  PV-SQLERRD3              PIC S9(09)   VALUE ZERO         00760001
007700                                               COMP-3.            00770001
007710     05  PV-DISP-OPER-UNT-ID      PIC X(09)    VALUE SPACES.      00771008
007720     05  PV-DISP-FCLTY-ID         PIC X(09)    VALUE SPACES.      00772008
007800     05  PV-DISP-ORD-NBR          PIC X(09)    VALUE SPACES.      00780001
007900     05  PV-DISP-RCVR-SEQ-NBR     PIC X(09)    VALUE SPACES.      00790002
008000     05  PV-DISP-ORD-LNE-NBR      PIC X(09)    VALUE SPACES.      00800002
008010     05  PV-DISP-WORK-ORD-SEQ-NBR  PIC X(09)    VALUE SPACES.     00801003
008200 01  PC-PROGRAM-CONSTANTS.                                        00820001
008300     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          00830001
008400                                                COMP SYNC.        00840001
008500     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      00850001
008600     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00860001
008700     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00870001
008800                                                                  00880001
008900 01  PS-PROGRAM-SWITCHES.                                         00890001
009000     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.        00900001
009100         88  COMMITS-TAKEN                      VALUE 'T'.        00910001
009200         88  NO-COMMITS-TAKEN                   VALUE 'N'.        00920001
009300     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.        00930001
009400         88  MORE-EXTRACT                       VALUE 'M'.        00940001
009500         88  END-OF-EXTRACT                     VALUE 'E'.        00950001
009600     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        00960001
009700         88  NORMAL-RUN                         VALUE '0'.        00970001
009800         88  RESTART-RUN                        VALUE '9'.        00980001
009900                                                                  00990001
010000 01  WS-COUNTER.                                                  01000001
010100     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.     01010001
010200     05  WS-TMST                  PIC X(26)     VALUE SPACES.     01020001
010300                                                                  01030001
010400 01  CKPT-RESTART-INFO.                                           01040001
010500     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.       01050001
010600                                                                  01060001
010700*----------------------------------------------------------------*01070001
010800*  ABEND DATA AREAS                                              *01080001
010900*----------------------------------------------------------------*01090001
011000 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01100001
011100                                             COMP SYNC.           01110001
011200     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         01120001
011300     88  AC-BAD-DATA                         VALUE +4008.         01130001
011400     88  AC-DB2-ERROR                        VALUE +4013.         01140001
011500     88  AC-DATE-ERROR                       VALUE +4019.         01150001
011600                                                                  01160001
011700                                                                  01170001
011800 01  ABEND-AREAS.                                                 01180001
011900     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01190001
012000             '*****       ABEND'.                                 01200001
012100     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01210001
012200             '*****   PROGRAM: AHKUP054'.                         01220003
012300     05  AA-PARAGRAPH-LIT.                                        01230001
012400         10  FILLER              PIC  X(17)  VALUE                01240001
012500             '***** PARAGRAPH: '.                                 01250001
012600         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01260001
012700     05  AA-MESSAGE-LINE-1.                                       01270001
012800         10  FILLER              PIC  X(06)  VALUE '*****'.       01280001
012900         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01290001
013000     05  AA-MESSAGE-LINE-2.                                       01300001
013100         10  FILLER              PIC  X(06)  VALUE '*****'.       01310001
013200         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01320001
013300     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01330001
013400             '*****    DB2 ERROR'.                                01340001
013500     05  AA-DB2-OPERATION-LIT.                                    01350001
013600         10  FILLER              PIC  X(17)  VALUE                01360001
013700             '***** OPERATION: '.                                 01370001
013800         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01380001
013900     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01390001
014000     EJECT                                                        01400001
014100                                                                  01410001
014200     COPY DPWS004.                                                01420001
014300     EJECT                                                        01430001
014400*----------------------------------------------------------------*01440001
014500*      TWRKORD TABLE LAYOUT                                       01450003
014600*----------------------------------------------------------------*01460001
014700         EXEC SQL                                                 01470001
014800             INCLUDE TWRKORD                                      01480003
014900         END-EXEC.                                                01490001
015000                                                                  01500001
015100*----------------------------------------------------------------*01510001
015200*      TCKRSTCNTL TABLE LAYOUT                                    01520001
015300*----------------------------------------------------------------*01530001
015400         EXEC SQL                                                 01540001
015500             INCLUDE TCKRSTCN                                     01550001
015600         END-EXEC.                                                01560001
015700                                                                  01570001
015800*----------------------------------------------------------------*01580001
015900*      TCKRSTINF TABLE LAYOUT                                     01590001
016000*----------------------------------------------------------------*01600001
016100         EXEC SQL                                                 01610001
016200             INCLUDE TCKRSTIN                                     01620001
016300         END-EXEC.                                                01630001
016400 EJECT                                                            01640001
016500*----------------------------------------------------------------*01650001
016600*  DB2 COMMUNICATION AREA                                         01660001
016700*----------------------------------------------------------------*01670001
016800*                                                                 01680001
016900     EXEC SQL                                                     01690001
017000         INCLUDE SQLCA                                            01700001
017100     END-EXEC.                                                    01710001
017200                                                                  01720001
017300*----------------------------------------------------------------*01730001
017400*  DB2 COMMUNICATION AREA2                                        01740001
017500*----------------------------------------------------------------*01750001
017600*                                                                 01760001
017700     COPY SQLCA2.                                                 01770001
017800     EJECT                                                        01780001
017900 PROCEDURE DIVISION.                                              01790001
018000 A100-MAINLINE-ROUTINE.                                           01800001
018100                                                                  01810001
018200     PERFORM B100-INITIALIZATION.                                 01820001
018300                                                                  01830001
018400     PERFORM B200-TWRKORD-EXTRACT-PROCESS                         01840003
018500       UNTIL END-OF-EXTRACT.                                      01850001
018600                                                                  01860001
018700     PERFORM B300-EOJ-PROCESSING.                                 01870001
018800                                                                  01880001
018900     GOBACK.                                                      01890001
019000 EJECT                                                            01900001
019100 B100-INITIALIZATION.                                             01910001
019200                                                                  01920001
019300     EXEC SQL                                                     01930001
019400         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 01940001
019500     END-EXEC.                                                    01950001
019600                                                                  01960001
019700     PERFORM X300-GET-CHECKPOINT-CNTL.                            01970001
019800     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    01980001
019900                                                                  01990001
020000     OPEN INPUT TWRKORD-EXTRACT-FILE.                             02000003
020100                                                                  02010001
020200     IF RESTART-RUN                                               02020001
020300         PERFORM X200-CHECKPOINT-RESTART                          02030001
020400     ELSE                                                         02040001
020500         PERFORM R100-READ-EXTRACT-FILE                           02050001
020600     END-IF.                                                      02060001
020700                                                                  02070001
020800     PERFORM X500-SET-CHECKPOINT-TIME.                            02080001
020900                                                                  02090001
021000                                                                  02100001
021100     EJECT                                                        02110001
021200 B200-TWRKORD-EXTRACT-PROCESS.                                    02120003
021300                                                                  02130001
021310     MOVE WRKORD-OPER-UNT-ID        TO PV-DISP-OPER-UNT-ID.       02131008
021320     MOVE WRKORD-FCLTY-ID           TO PV-DISP-FCLTY-ID.          02132008
021400     MOVE WRKORD-ORD-NBR            TO PV-DISP-ORD-NBR.           02140003
021500     MOVE WRKORD-RCVR-SEQ-NBR       TO PV-DISP-RCVR-SEQ-NBR.      02150003
021510     MOVE WRKORD-ORD-LNE-NBR        TO PV-DISP-ORD-LNE-NBR.       02151003
021600     MOVE WRKORD-WORK-ORD-SEQ-NBR   TO PV-DISP-WORK-ORD-SEQ-NBR.  02160003
021800                                                                  02180001
021900     PERFORM D100-DELETE-TWRKORD.                                 02190003
022000                                                                  02200001
022100     PERFORM X100-CHECKPOINT-CHECK.                               02210001
022200                                                                  02220001
022300     PERFORM R100-READ-EXTRACT-FILE.                              02230001
022400     EJECT                                                        02240001
022500                                                                  02250001
022600                                                                  02260001
022700 B300-EOJ-PROCESSING.                                             02270001
022800                                                                  02280001
022900     DISPLAY '** AHKUP054 SUMMARY **'.                            02290004
023000     DISPLAY '** TWRKORD INPUT COUNT = ' PV-TWRKORD-INPUT-COUNT.  02300004
023100     DISPLAY '** TWRKORD DELETE COUNT = ' PV-TWRKORD-DELETE-COUNT.02310004
023200     DISPLAY '** SQL DELETE COUNT = ' PV-SQL-DELETE-COUNT.        02320001
023300                                                                  02330001
023400     CLOSE  TWRKORD-EXTRACT-FILE.                                 02340004
023500                                                                  02350001
023600     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02360001
023700     PERFORM X600-UPDATE-TCKRSTCNTL.                              02370001
023800                                                                  02380001
023900     EJECT                                                        02390001
024000*----------------------------------------------------------------*02400001
024100*    DELETES FROM THE TWRKORD TABLE. NO OTHER TABLES REFERENCE   *02410004
024200*    THIS TABLE.                                                 *02420001
024300*----------------------------------------------------------------*02430001
024400 D100-DELETE-TWRKORD.                                             02440004
024500                                                                  02450001
024600     MOVE 'D100-DELETE-TWRKORD' TO PV-CURRENT-PARAGRAPH.          02460004
024700                                                                  02470001
024800     PERFORM WITH TEST AFTER                                      02480001
024900        VARYING PC-RETRY-COUNT FROM 1 BY 1                        02490001
025000          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                     02500001
025100             OR SQLCODE = ZERO                                    02510001
025200                                                                  02520001
025300         EXEC SQL                                                 02530001
025400              DELETE                                              02540001
025500                FROM TWRKORD                                      02550005
025600               WHERE ORD_NBR          = :WRKORD-ORD-NBR           02560004
025700                 AND RCVR_SEQ_NBR     = :WRKORD-RCVR-SEQ-NBR      02570004
025710                 AND ORD_LNE_NBR      = :WRKORD-ORD-LNE-NBR       02571004
025800                 AND WORK_ORD_SEQ_NBR  = :WRKORD-WORK-ORD-SEQ-NBR 02580004
025810                 AND OPER_UNT_ID      = :WRKORD-OPER-UNT-ID       02581004
025820                 AND FCLTY_ID         = :WRKORD-FCLTY-ID          02582004
025900                 AND CRE_TMST         = :WRKORD-CRE-TMST          02590004
026000         END-EXEC                                                 02600001
026100                                                                  02610001
026200         EVALUATE TRUE                                            02620001
026300             WHEN SQLCODE = ZERO                                  02630001
026400                 ADD 1 TO PV-TWRKORD-DELETE-COUNT                 02640004
026500                 MOVE SQLERRD(3) TO PV-SQLERRD3                   02650010
026600                 ADD PV-SQLERRD3 TO PV-SQL-DELETE-COUNT           02660001
026700                                                                  02670001
026800             WHEN SQLCODE = -904                                  02680001
026900             WHEN SQLCODE = -913                                  02690001
027000                  CONTINUE                                        02700001
027100                                                                  02710001
027200             WHEN SQLCODE = +100                                  02720001
027300                 MOVE PV-CURRENT-PARAGRAPH                        02730001
027400                                     TO AA-PARAGRAPH-NAME         02740001
027410                 DISPLAY '******** OPER UNT ID:'                  02741008
027420                          PV-DISP-OPER-UNT-ID                     02742008
027430                 DISPLAY '******** FCLTY ID:'                     02743008
027440                          PV-DISP-FCLTY-ID                        02744008
027500                 DISPLAY '******** ORD NBR:'                      02750004
027600                          PV-DISP-ORD-NBR                         02760004
027700                 DISPLAY '******** RCVR SEQ NBR:'                 02770004
027800                          PV-DISP-RCVR-SEQ-NBR                    02780004
027900                 DISPLAY '******** ORD LNE NBR:'                  02790004
028000                          PV-DISP-ORD-LNE-NBR                     02800004
028010                 DISPLAY '******** WORK ORD SEQ NBR:'             02801004
028020                          PV-DISP-WORK-ORD-SEQ-NBR                02802004
028300                 MOVE 'ROW NOT ON TABLE ********'                 02830001
028400                          TO AA-MESSAGE-1                         02840001
028500                 MOVE SPACES TO AA-MESSAGE-2                      02850001
028600                 MOVE 'UNSUCCESSFUL DELETE'                       02860001
028700                          TO AA-DB2-OPERATION                     02870001
028800                 MOVE 'TWRKORD'  TO AA-DB2-TABLE                  02880004
028900                 PERFORM Z999-DB2-ABEND                           02890001
029000             WHEN SQLWARN0 NOT = SPACES                           02900001
029100             WHEN SQLCODE  NOT = ZERO                             02910001
029200                 MOVE PV-CURRENT-PARAGRAPH                        02920001
029300                                     TO AA-PARAGRAPH-NAME         02930001
029301                 DISPLAY '******** OPER UNT ID:'                  02930108
029302                          PV-DISP-OPER-UNT-ID                     02930208
029303                 DISPLAY '******** FCLTY ID:'                     02930308
029304                          PV-DISP-FCLTY-ID                        02930408
029310                 DISPLAY '******** ORD NBR:'                      02931004
029320                          PV-DISP-ORD-NBR                         02932004
029330                 DISPLAY '******** RCVR SEQ NBR:'                 02933004
029340                          PV-DISP-RCVR-SEQ-NBR                    02934004
029350                 DISPLAY '******** ORD LNE NBR:'                  02935004
029360                          PV-DISP-ORD-LNE-NBR                     02936004
029370                 DISPLAY '******** WORK ORD SEQ NBR:'             02937004
029380                          PV-DISP-WORK-ORD-SEQ-NBR                02938004
030200                 MOVE SPACES TO AA-MESSAGE-1                      03020001
030300                                AA-MESSAGE-2                      03030001
030400                 MOVE 'UNSUCCESSFUL DELETE'                       03040001
030500                                     TO AA-DB2-OPERATION          03050001
030600                 MOVE 'TWRKORD'      TO AA-DB2-TABLE              03060004
030700                 PERFORM Z999-DB2-ABEND                           03070001
030800         END-EVALUATE                                             03080001
030900     END-PERFORM.                                                 03090001
031000                                                                  03100001
031100     IF PC-RETRY-COUNT > PC-RETRY-MAX                             03110001
031200         MOVE PV-CURRENT-PARAGRAPH                                03120001
031300                             TO AA-PARAGRAPH-NAME                 03130001
031301         DISPLAY '******** OPER UNT ID:'                          03130108
031302                          PV-DISP-OPER-UNT-ID                     03130208
031303         DISPLAY '******** FCLTY ID:'                             03130308
031304                          PV-DISP-FCLTY-ID                        03130408
031310         DISPLAY '******** ORD NBR:'                              03131004
031320                          PV-DISP-ORD-NBR                         03132004
031330         DISPLAY '******** RCVR SEQ NBR:'                         03133004
031340                          PV-DISP-RCVR-SEQ-NBR                    03134004
031350         DISPLAY '******** ORD LNE NBR:'                          03135004
031360                          PV-DISP-ORD-LNE-NBR                     03136004
031370         DISPLAY '******** WORK ORD SEQ NBR:'                     03137004
031380                          PV-DISP-WORK-ORD-SEQ-NBR                03138004
032200         MOVE SPACES TO AA-MESSAGE-1                              03220001
032300                        AA-MESSAGE-2                              03230001
032400         MOVE 'MAX RETRIES EXCEEDED ON DELETE'                    03240001
032500                             TO AA-DB2-OPERATION                  03250001
032600         MOVE 'TWRKORD'      TO AA-DB2-TABLE                      03260004
032700         PERFORM Z999-DB2-ABEND                                   03270001
032800     END-IF.                                                      03280001
032900                                                                  03290001
033000     EJECT                                                        03300001
033100 R100-READ-EXTRACT-FILE.                                          03310001
033200                                                                  03320001
033300     READ TWRKORD-EXTRACT-FILE                                    03330004
033400          INTO DCLTWRKORD                                         03340004
033500          AT END SET END-OF-EXTRACT TO TRUE.                      03350001
033600                                                                  03360001
033700     IF MORE-EXTRACT                                              03370001
033800         ADD 1 TO PV-TWRKORD-INPUT-COUNT                          03380004
033900     END-IF.                                                      03390001
034000                                                                  03400001
034100                                                                  03410001
034200     EJECT                                                        03420001
034300*----------------------------------------------------------------*03430001
034400*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03440001
034500*----------------------------------------------------------------*03450001
034600 X100-CHECKPOINT-CHECK.                                           03460001
034700                                                                  03470001
034800     MOVE 'X100-CHECKPOINT-CHECK' TO PV-CURRENT-PARAGRAPH.        03480001
034900                                                                  03490001
035000     EXEC SQL                                                     03500001
035100       SET :WS-TMST = CURRENT TIMESTAMP                           03510001
035200     END-EXEC.                                                    03520001
035300                                                                  03530001
035400     IF SQLCODE = +0                                              03540001
035500         CONTINUE                                                 03550001
035600     ELSE                                                         03560001
035700         MOVE PV-CURRENT-PARAGRAPH                                03570001
035800                             TO AA-PARAGRAPH-NAME                 03580001
035900         MOVE SPACES TO AA-MESSAGE-1                              03590001
036000                        AA-MESSAGE-2                              03600001
036100         MOVE 'BAD SET COMMAND'                                   03610001
036200                             TO AA-DB2-OPERATION                  03620001
036300         MOVE SPACES             TO AA-DB2-TABLE                  03630001
036400         PERFORM Z999-DB2-ABEND                                   03640001
036500     END-IF.                                                      03650001
036600                                                                  03660001
036700     IF WS-TMST > WS-HOLD-TMST                                    03670001
036800         IF NO-COMMITS-TAKEN                                      03680001
036900             MOVE PC-IN-PROCESS-CODE TO PV-CKPT-STAT-CODE         03690001
037000             PERFORM X600-UPDATE-TCKRSTCNTL                       03700001
037100             SET COMMITS-TAKEN TO TRUE                            03710001
037200         END-IF                                                   03720001
037300         PERFORM X700-UPDATE-TCKRSTINF                            03730001
037400         PERFORM Y100-COMMIT                                      03740001
037500         PERFORM X500-SET-CHECKPOINT-TIME                         03750001
037600     END-IF.                                                      03760001
037700                                                                  03770001
037800 EJECT                                                            03780001
037900*----------------------------------------------------------------*03790001
038000*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03800001
038100*----------------------------------------------------------------*03810001
038200 X200-CHECKPOINT-RESTART.                                         03820001
038300                                                                  03830001
038400     MOVE 'X200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.      03840001
038500                                                                  03850001
038600     PERFORM X400-GET-CHECKPOINT-INFO.                            03860001
038700     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     03870001
038800                                                                  03880001
038900     DISPLAY '** AHKUP054 CHECKPOINT RESTART **'                  03890004
039000     DISPLAY '** EXTRACT RECS BYPASSED ON RESTART = '             03900001
039100              CR-EXTRACT-RECS-WORKED.                             03910001
039200     DISPLAY '***********************************************'    03920001
039300                                                                  03930001
039400     PERFORM R100-READ-EXTRACT-FILE                               03940001
039500         CR-EXTRACT-RECS-WORKED TIMES.                            03950001
039600     PERFORM R100-READ-EXTRACT-FILE.                              03960001
039700 EJECT                                                            03970001
039800*----------------------------------------------------------------*03980001
039900*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *03990001
040000*----------------------------------------------------------------*04000001
040100 X300-GET-CHECKPOINT-CNTL.                                        04010001
040200                                                                  04020001
040300     MOVE 'X300-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     04030001
040400                                                                  04040001
040500     PERFORM WITH TEST AFTER                                      04050001
040600             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04060001
040700             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04070001
040800                     SQLCODE = ZERO                               04080001
040900                                                                  04090001
041000             EXEC SQL                                             04100001
041100              SELECT CKPT_STAT_CODE                               04110001
041200               INTO :PV-CKPT-STAT-CODE                            04120001
041300               FROM TCKRSTCNTL                                    04130001
041400               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04140001
041500             END-EXEC                                             04150001
041600                                                                  04160001
041700             EVALUATE TRUE                                        04170001
041800                 WHEN SQLCODE = ZERO                              04180001
041900                 WHEN SQLCODE = -904                              04190001
042000                 WHEN SQLCODE = -913                              04200001
042100                      CONTINUE                                    04210001
042200                                                                  04220001
042300                 WHEN SQLWARN0 NOT = SPACES                       04230001
042400                 WHEN SQLCODE  NOT = ZERO                         04240001
042500                     MOVE PV-CURRENT-PARAGRAPH                    04250001
042600                                         TO AA-PARAGRAPH-NAME     04260001
042700                     DISPLAY '******** PLAN_NAME:'                04270001
042800                              PV-PROGRAM-NAME                     04280001
042900                     MOVE SPACES TO AA-MESSAGE-1                  04290001
043000                                    AA-MESSAGE-2                  04300001
043100                     MOVE 'UNSUCCESSFUL SELECT'                   04310001
043200                                         TO AA-DB2-OPERATION      04320001
043300                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          04330001
043400                     PERFORM Z999-DB2-ABEND                       04340001
043500             END-EVALUATE                                         04350001
043600     END-PERFORM.                                                 04360001
043700                                                                  04370001
043800     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04380001
043900         MOVE PV-CURRENT-PARAGRAPH                                04390001
044000                             TO AA-PARAGRAPH-NAME                 04400001
044100         DISPLAY '******** PLAN_NAME:'                            04410001
044200                  PV-PROGRAM-NAME                                 04420001
044300         MOVE SPACES TO AA-MESSAGE-1                              04430001
044400                        AA-MESSAGE-2                              04440001
044500         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    04450001
044600                             TO AA-DB2-OPERATION                  04460001
044700         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      04470001
044800         PERFORM Z999-DB2-ABEND                                   04480001
044900     END-IF.                                                      04490001
045000                                                                  04500001
045100 EJECT                                                            04510001
045200*----------------------------------------------------------------*04520001
045300*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *04530001
045400*----------------------------------------------------------------*04540001
045500 X400-GET-CHECKPOINT-INFO.                                        04550001
045600                                                                  04560001
045700     MOVE 'X400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     04570001
045800                                                                  04580001
045900     PERFORM WITH TEST AFTER                                      04590001
046000             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04600001
046100             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04610001
046200                     SQLCODE = ZERO                               04620001
046300                                                                  04630001
046400             EXEC SQL                                             04640001
046500              SELECT WORK_STRG_DESC                               04650001
046600               INTO :TCKRSTINF-WORK-STRG-DESC                     04660001
046700               FROM TCKRSTINF                                     04670001
046800               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04680001
046900             END-EXEC                                             04690001
047000                                                                  04700001
047100             EVALUATE TRUE                                        04710001
047200                 WHEN SQLCODE = ZERO                              04720001
047300                 WHEN SQLCODE = -904                              04730001
047400                 WHEN SQLCODE = -913                              04740001
047500                      CONTINUE                                    04750001
047600                                                                  04760001
047700                 WHEN SQLWARN0 NOT = SPACES                       04770001
047800                 WHEN SQLCODE  NOT = ZERO                         04780001
047900                     MOVE PV-CURRENT-PARAGRAPH                    04790001
048000                                         TO AA-PARAGRAPH-NAME     04800001
048100                     DISPLAY '******** PLAN_NAME:'                04810001
048200                              PV-PROGRAM-NAME                     04820001
048300                     MOVE SPACES TO AA-MESSAGE-1                  04830001
048400                                    AA-MESSAGE-2                  04840001
048500                     MOVE 'UNSUCCESSFUL SELECT'                   04850001
048600                                         TO AA-DB2-OPERATION      04860001
048700                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          04870001
048800                     PERFORM Z999-DB2-ABEND                       04880001
048900             END-EVALUATE                                         04890001
049000     END-PERFORM.                                                 04900001
049100                                                                  04910001
049200     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04920001
049300         MOVE PV-CURRENT-PARAGRAPH                                04930001
049400                             TO AA-PARAGRAPH-NAME                 04940001
049500         DISPLAY '******** PLAN_NAME:'                            04950001
049600                  PV-PROGRAM-NAME                                 04960001
049700         MOVE SPACES TO AA-MESSAGE-1                              04970001
049800                        AA-MESSAGE-2                              04980001
049900         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    04990001
050000                             TO AA-DB2-OPERATION                  05000001
050100         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      05010001
050200         PERFORM Z999-DB2-ABEND                                   05020001
050300     END-IF.                                                      05030001
050400                                                                  05040001
050500 EJECT                                                            05050001
050600*----------------------------------------------------------------*05060001
050700*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *05070001
050800*----------------------------------------------------------------*05080001
050900 X500-SET-CHECKPOINT-TIME.                                        05090001
051000                                                                  05100001
051100     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-CURRENT-PARAGRAPH.     05110001
051200                                                                  05120001
051300     PERFORM WITH TEST AFTER                                      05130001
051400             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05140001
051500             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05150001
051600                     SQLCODE = ZERO                               05160001
051700                                                                  05170001
051800             EXEC SQL                                             05180001
051900              SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)05190001
052000               INTO :WS-HOLD-TMST                                 05200001
052100               FROM TCKRSTCNTL                                    05210001
052200               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05220001
052300             END-EXEC                                             05230001
052400                                                                  05240001
052500             EVALUATE TRUE                                        05250001
052600                 WHEN SQLCODE = ZERO                              05260001
052700                 WHEN SQLCODE = -904                              05270001
052800                 WHEN SQLCODE = -913                              05280001
052900                      CONTINUE                                    05290001
053000                                                                  05300001
053100                 WHEN SQLWARN0 NOT = SPACES                       05310001
053200                 WHEN SQLCODE  NOT = ZERO                         05320001
053300                     MOVE PV-CURRENT-PARAGRAPH                    05330001
053400                                         TO AA-PARAGRAPH-NAME     05340001
053500                     DISPLAY '******** PLAN_NAME:'                05350001
053600                              PV-PROGRAM-NAME                     05360001
053700                     MOVE SPACES TO AA-MESSAGE-1                  05370001
053800                                    AA-MESSAGE-2                  05380001
053900                     MOVE 'UNSUCCESSFUL SELECT'                   05390001
054000                                         TO AA-DB2-OPERATION      05400001
054100                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05410001
054200                     PERFORM Z999-DB2-ABEND                       05420001
054300             END-EVALUATE                                         05430001
054400     END-PERFORM.                                                 05440001
054500                                                                  05450001
054600     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05460001
054700         MOVE PV-CURRENT-PARAGRAPH                                05470001
054800                             TO AA-PARAGRAPH-NAME                 05480001
054900         DISPLAY '******** PLAN_NAME:'                            05490001
055000                  PV-PROGRAM-NAME                                 05500001
055100         MOVE SPACES TO AA-MESSAGE-1                              05510001
055200                        AA-MESSAGE-2                              05520001
055300         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05530001
055400                             TO AA-DB2-OPERATION                  05540001
055500         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05550001
055600         PERFORM Z999-DB2-ABEND                                   05560001
055700     END-IF.                                                      05570001
055800                                                                  05580001
055900 EJECT                                                            05590001
056000*----------------------------------------------------------------*05600001
056100*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *05610001
056200*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *05620001
056300*----------------------------------------------------------------*05630001
056400 X600-UPDATE-TCKRSTCNTL.                                          05640001
056500                                                                  05650001
056600     MOVE 'X600-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       05660001
056700                                                                  05670001
056800     PERFORM WITH TEST AFTER                                      05680001
056900             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05690001
057000             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05700001
057100                     SQLCODE = ZERO                               05710001
057200                                                                  05720001
057300             EXEC SQL                                             05730001
057400                 UPDATE TCKRSTCNTL                                05740001
057500                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          05750001
057600                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          05760001
057700             END-EXEC                                             05770001
057800                                                                  05780001
057900             EVALUATE TRUE                                        05790001
058000                 WHEN SQLCODE = ZERO                              05800001
058100                 WHEN SQLCODE = -904                              05810001
058200                 WHEN SQLCODE = -913                              05820001
058300                      CONTINUE                                    05830001
058400                                                                  05840001
058500                 WHEN SQLWARN0 NOT = SPACES                       05850001
058600                 WHEN SQLCODE  NOT = ZERO                         05860001
058700                     MOVE PV-CURRENT-PARAGRAPH                    05870001
058800                                         TO AA-PARAGRAPH-NAME     05880001
058900                     DISPLAY '******** PLAN_NAME:'                05890001
059000                              PV-PROGRAM-NAME                     05900001
059100                     MOVE SPACES TO AA-MESSAGE-1                  05910001
059200                                    AA-MESSAGE-2                  05920001
059300                     MOVE 'UNSUCCESSFUL UPDATE'                   05930001
059400                                         TO AA-DB2-OPERATION      05940001
059500                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05950001
059600                     PERFORM Z999-DB2-ABEND                       05960001
059700             END-EVALUATE                                         05970001
059800     END-PERFORM.                                                 05980001
059900                                                                  05990001
060000     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06000001
060100         MOVE PV-CURRENT-PARAGRAPH                                06010001
060200                             TO AA-PARAGRAPH-NAME                 06020001
060300         DISPLAY '******** PLAN_NAME:'                            06030001
060400                  PV-PROGRAM-NAME                                 06040001
060500         MOVE SPACES TO AA-MESSAGE-1                              06050001
060600                        AA-MESSAGE-2                              06060001
060700         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06070001
060800                             TO AA-DB2-OPERATION                  06080001
060900         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06090001
061000         PERFORM Z999-DB2-ABEND                                   06100001
061100     END-IF.                                                      06110001
061200                                                                  06120001
061300     EJECT                                                        06130001
061400*----------------------------------------------------------------*06140001
061500*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *06150001
061600*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *06160001
061700*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *06170001
061800*----------------------------------------------------------------*06180001
061900 X700-UPDATE-TCKRSTINF.                                           06190001
062000                                                                  06200001
062100     MOVE 'X700-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        06210001
062200                                                                  06220001
062300     MOVE PV-TWRKORD-INPUT-COUNT TO CR-EXTRACT-RECS-WORKED.       06230004
062400     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   06240001
062500     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    06250001
062600                                                                  06260001
062700     PERFORM WITH TEST AFTER                                      06270001
062800             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06280001
062900             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06290001
063000                     SQLCODE = ZERO                               06300001
063100                                                                  06310001
063200             EXEC SQL                                             06320001
063300                 UPDATE TCKRSTINF                                 06330001
063400                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 06340001
063500                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06350001
063600             END-EXEC                                             06360001
063700                                                                  06370001
063800             EVALUATE TRUE                                        06380001
063900                 WHEN SQLCODE = ZERO                              06390001
064000                 WHEN SQLCODE = -904                              06400001
064100                 WHEN SQLCODE = -913                              06410001
064200                      CONTINUE                                    06420001
064300                                                                  06430001
064400                 WHEN SQLWARN0 NOT = SPACES                       06440001
064500                 WHEN SQLCODE  NOT = ZERO                         06450001
064600                     MOVE PV-CURRENT-PARAGRAPH                    06460001
064700                                         TO AA-PARAGRAPH-NAME     06470001
064800                     DISPLAY '******** PLAN_NAME:'                06480001
064900                              PV-PROGRAM-NAME                     06490001
065000                     MOVE SPACES TO AA-MESSAGE-1                  06500001
065100                                    AA-MESSAGE-2                  06510001
065200                     MOVE 'UNSUCCESSFUL UPDATE'                   06520001
065300                                         TO AA-DB2-OPERATION      06530001
065400                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          06540001
065500                     PERFORM Z999-DB2-ABEND                       06550001
065600             END-EVALUATE                                         06560001
065700     END-PERFORM.                                                 06570001
065800                                                                  06580001
065900     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06590001
066000         MOVE PV-CURRENT-PARAGRAPH                                06600001
066100                             TO AA-PARAGRAPH-NAME                 06610001
066200         DISPLAY '******** PLAN_NAME:'                            06620001
066300                  PV-PROGRAM-NAME                                 06630001
066400         MOVE SPACES TO AA-MESSAGE-1                              06640001
066500                        AA-MESSAGE-2                              06650001
066600         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06660001
066700                             TO AA-DB2-OPERATION                  06670001
066800         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      06680001
066900         PERFORM Z999-DB2-ABEND                                   06690001
067000     END-IF.                                                      06700001
067100                                                                  06710001
067200 EJECT                                                            06720001
067300                                                                  06730001
067400*----------------------------------------------------------------*06740001
067500*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *06750001
067600*----------------------------------------------------------------*06760001
067700 Y100-COMMIT.                                                     06770001
067800                                                                  06780001
067900     MOVE 'Y100-COMMIT'    TO PV-CURRENT-PARAGRAPH.               06790001
068000                                                                  06800001
068100     EXEC SQL                                                     06810001
068200         COMMIT                                                   06820001
068300     END-EXEC.                                                    06830001
068400                                                                  06840001
068500     EVALUATE TRUE                                                06850001
068600         WHEN SQLCODE = ZEROS                                     06860001
068700             CONTINUE                                             06870001
068800         WHEN OTHER                                               06880001
068900             MOVE PV-CURRENT-PARAGRAPH                            06890001
069000                                 TO AA-PARAGRAPH-NAME             06900001
069100             MOVE SPACES TO AA-MESSAGE-1                          06910001
069200                            AA-MESSAGE-2                          06920001
069300             MOVE 'UNSUCCESSFUL COMMIT'                           06930001
069400                                 TO AA-DB2-OPERATION              06940001
069500             MOVE SPACES         TO AA-DB2-TABLE                  06950001
069600             PERFORM Z999-DB2-ABEND                               06960001
069700     END-EVALUATE.                                                06970001
069800 EJECT                                                            06980001
069900 Z900-PROCESS-ABEND.                                              06990001
070000                                                                  07000001
070100     DISPLAY '*** ABEND'.                                         07010001
070200     DISPLAY '*** PROGRAM   = AHKUP054'.                          07020004
070300     DISPLAY '*** PARAGRAPH = ' PV-CURRENT-PARAGRAPH.             07030001
070400     DISPLAY AA-MESSAGE-LINE-1.                                   07040001
070500     DISPLAY AA-MESSAGE-LINE-2.                                   07050001
070600     COPY DPPD004.                                                07060001
070700     CALL 'ILBOABN0' USING ABEND-CODE.                            07070001
070800                                                                  07080001
070900                                                                  07090001
071000                                                                  07100001
071100 Z999-DB2-ABEND.                                                  07110001
071200                                                                  07120001
071300     DISPLAY AA-ABEND-LIT.                                        07130001
071400     DISPLAY AA-DB2-ERROR-LIT.                                    07140001
071500     DISPLAY AA-PROGRAM-LIT.                                      07150001
071600     DISPLAY AA-PARAGRAPH-LIT.                                    07160001
071700     DISPLAY AA-DB2-OPERATION-LIT.                                07170001
071800     DISPLAY AA-DB2-TABLE.                                        07180001
071900     SET AC-DB2-ERROR TO TRUE.                                    07190001
072000                                                                  07200001
072100     COPY DPPD004.                                                07210001
072200                                                                  07220001
072300     CALL 'ILBOABN0' USING ABEND-CODE.                            07230001
