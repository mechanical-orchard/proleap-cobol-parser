000100 IDENTIFICATION DIVISION.                                         00010099
000200 PROGRAM-ID.    DPKUP150.                                         00020099
000300 AUTHOR.        J. JUEL.                                          00030099
000400 DATE-WRITTEN.  DECEMBER 1998.                                    00040099
000500 DATE-COMPILED.                                                   00050099
000600***************************************************************** 00060099
000700**********    ADJUSTMENT JOURNAL PRORATION ROUTINE     ********** 00070099
000800***************************************************************** 00080099
000900*    COBOL II WITH SQL                                          * 00090099
001000***************************************************************** 00100099
001100*  THIS PROGRAM IS A SUB ROUTINE THAT WILL CALCULATE THE        * 00110099
001200*  PERCENTAGE TO BE APPLIED TO AMOUNTS ON INPUT TRANSACTIONS    * 00120099
001300*  IN THE CALLING PROGRAM.  THE CALCULATION IS BASED ON COST,   * 00130099
001400*  RETAIL, OR QUANTITY.  THE RESULT SET CAN BE PRORATED TO THE  * 00140099
001500*  MAJOR CLASS, SUB CLASS, OR SKU LEVEL.                        * 00150099
001600***************************************************************** 00160099
001700* INPUT:                                                        * 00170099
001800*  1. PARAMATER LIST FROM CALLING PROGRAM (COPYBOOK APWS150)    * 00180099
001900*                                                               * 00190099
002000* DB2 TABLES:                                                   * 00200099
002100*  1. ADJUSTMENT PRORATION             (TAJPRRT)                * 00210099
002200*  2. PURCHASE ORDER HEADER            (TPURCHS)                * 00220099
002300*  3. PURCHASE ITEM                    (TPURITM)                * 00230099
002400*  4. RECEIVER TABLE                   (TRECEIV)                * 00240099
002500*  5. RECEIPT ITEM TABLE               (TRECITM)                * 00250099
002600*  6. RECEIVER DISTRIBUTION TABLE      (TRECDIS)                * 00260099
002700***************************************************************** 00270099
002800* CHANGE LOG:                                                   * 00280099
002900* 05/04/2000 JILL JUEL                       WR/IR #: 20704     * 00290099
003000*       PERFORMANCE TUNING:                                     * 00300099
003100*       REMOVED S100-SELECT-TOTALS AND REPLACED IT WITH         * 00310099
003200*       PRORATION-TABLE THAT ACCUMULATS THE TOTAL QUANTITY,     * 00320099
003300*       TOTAL COST, AND TOTAL RETAIL AMOUNT.                    * 00330099
003400*                                                               * 00340099
003500* 11/10/2000 JILL JUEL                       WR/IR #: 20224     * 00350099
003600*       ADDED A CHECK TO SEE IF THE CURSOR WAS OPENED           * 00360099
003700*       SUCCESSFULLY BEFORE PROCESSING D100.                    * 00370099
003800*                                                               * 00380099
003810* 11/29/2005 ROLF NOHE                       WR/IR #: P000837301* 00381099
003820*       CHANGE MADE: ADDED LOGIC TO MAINTAIN ADJUSTMENTS AT     * 00382099
003830*       SKU LEVEL.                                              * 00383099
003831*                                                               * 00383199
003832* DATE  01/13/2006                                                00383299
003833*     CHANGE MADE: ADDED CLASS NUMBER TO THE SKU CURSOR AND TO  * 00383399
003834*     THE LOGIC TABLING THE DATA FETCHED FROM THIS CURSOR.  SKU * 00383499
003835*     LEVEL TRANSACTIONS WERE GETTING SPACES IN THE CLASS       * 00383599
003836*     NUMBER DUE TO THIS COLUMN NOT BEING SELECTED AND MOVED.   * 00383699
003837*     MADE BY:  NANCY EILBES           WR/IR #: P000837301      * 00383799
003838*                                                               * 00383899
003839* DATE  01/27/2006                                              * 00383999
003840*     CHANGE MADE: REMOVED DISPLAY THAT WAS CAUSING EXCESSIVE   * 00384099
003850*     SYSOUT.                                                   * 00385099
003851*     MADE BY: NANCY EILBES            WR/IR #: WR28582         * 00385199
003852*                                                               * 00385299
003853* DATE  01/11/2011                                              * 00385399
003854*     CHANGE MADE: IMPORT REPLENISHMENT PROJECT - ADDED THE     * 00385499
003855*     CODE "AND RI.OPER_UNT_ID BETWEEN :LOW-OPER-UNT AND        * 00385599
003856*     :HIGH-OPER-UNT AND PI.CL_NBR BETWEEN :LOW-CL-NBR AND      * 00385699
003857*     :HIGH-CL-NBR" TO THE CLASS_CSR AND SKU_CSR CURSORS' WHERE * 00385799
003858*     CLAUSES.  ACCORDINGLY, IN PARAGRAPH B100-INITIALIZATION,  * 00385899
003859*     MOVED THE VALUES FROM THE APWS150 COPYBOOK TO THE LOW/    * 00385999
003860*     HIGH OPER-UNT AND CL-NBR FIELDS.  THE NEW FIELDS ARE      * 00386099
003861*     DEFINED IN THE APWS150 COPYBOOK AS WS150-DC-NBR AND       * 00386199
003862*     WS150-CL-NBR.  CHANGED THE PERFORM UNTIL CLAUSE IN        * 00386299
003863*     PARAGRAPH C200-PRORATE-BY-MAJOR-CLASS BY A) REMOVING THE  * 00386399
003864*     END-OF-CLASS-CSR AND B) EDITING THE CLASS LOGIC TO USE    * 00386499
003865*     THE TBL-CL-NBR RATHER THAN THE PV-CLASS FOR COMPARISON.   * 00386599
003866*     ALSO ELIMINATED INCREASING THE INDEX VALUE WITHIN THE     * 00386699
003867*     PERFORM LOOP.  LASTLY, INCLUDED THE TRIP_ID AND ENT_ID    * 00386799
003868*     FIELDS IN THE INSERT STATEMENT IN THE I100-INSERT-ADJ     * 00386899
003869*     PRORATION PARAGRAPH AND MOVED ZEROS TO THESE FIELDS IN THE* 00386999
003870*     C200-PRORATE-BY-MAJOR-CLASS, C300-PRORATE-BY-SUB-CLASS,   * 00387099
003871*     AND C400-PRORATE-BY-SKU PARAGRAPHS.                       * 00387199
003872*     MADE BY: KRYSTEN LEROY           WR/IR #: WR38804         * 00387299
003873*                                                               * 00387399
003874* DATE  01/21/2011                                              * 00387499
003875*     CHANGE MADE: INCLUDED THE CODE "OR WS150-CL-NBR = '0'"    * 00387599
003876*     IN PARAGRAPH B100-INITIALIZATION WHERE THE WS150-CL-NBR   * 00387699
003877*     VARIABLE IS BEING EVALUATED.                              * 00387799
003878*     MADE BY: KRYSTEN LEROY           WR/IR #: INC000001565824 * 00387899
003879*                                                               * 00387999
003880* DATE  01/27/2011                                              * 00388099
003881*     CHANGE MADE: REMOVED THE "AND PI.CL_NBR ..." LOGIC FROM   * 00388199
003882*     THE WHERE CLAUSE OF THE CLASS_CSR AND SKU_CSR AS IT WAS   * 00388299
003883*     DETERMINED THAT INCLUDING THE CLASS NUMBER IN THE         * 00388399
003884*     PRORATION ROUTINE DID NOT ADD EXTRA VALUE.  AS A RESULT,  * 00388499
003885*     THE LOW-CL-NBR AND HIGH-CL-NBR VARIABLE DECLARATIONS WERE * 00388599
003886*     REMOVED ALONG WITH ALL CODE RELATED TO THE WS150-CL-NBR   * 00388699
003887*     IN THE B100-INITIALIZATION PARAGRAPH.                     * 00388799
003894*     MADE BY: KRYSTEN LEROY           WR/IR #: INC000001566554 * 00389499
003895*                                                               * 00389599
003896***************************************************************** 00389699
003897 ENVIRONMENT DIVISION.                                            00389799
003898                                                                  00389899
003899 INPUT-OUTPUT SECTION.                                            00389999
003900 FILE-CONTROL.                                                    00390099
003901                                                                  00390199
003902 DATA DIVISION.                                                   00390299
003903                                                                  00390399
003904 FILE SECTION.                                                    00390499
003905                                                                  00390599
003906*************************                                         00390699
003907 WORKING-STORAGE SECTION.                                         00390799
003908*************************                                         00390899
003909                                                                  00390999
003910 01  MIN-MAX-VALUES.                                              00391099
003911     05  LOW-SEQ-NBR             PIC S9(09) COMP VALUE ZERO.      00391199
003912     05  HIGH-SEQ-NBR            PIC S9(09) COMP VALUE 999999999. 00391299
003913     05  LOW-STR-NBR             PIC S9(04) COMP VALUE ZERO.      00391399
003914     05  HIGH-STR-NBR            PIC S9(04) COMP VALUE 9999.      00391499
003915     05  LOW-LNE-NBR             PIC S9(09) COMP VALUE ZERO.      00391599
003920     05  HIGH-LNE-NBR            PIC S9(09) COMP VALUE 999999999. 00392099
004000     05  LOW-OPER-UNT            PIC S9(04) COMP VALUE ZERO.      00400099
004100     05  HIGH-OPER-UNT           PIC S9(04) COMP VALUE 9999.      00410099
004600                                                                  00460099
004700 01  PROGRAM-CONSTANTS.                                           00470099
004800     05  PC-PROGRAM-NAME         PIC  X(08)  VALUE 'DPKUP150'.    00480099
004810                                                                  00481099
004820 01  PROGRAM-VARIABLES.                                           00482099
004830     05  CLASS-BEING-PROCESSED   PIC  X(02)  VALUE SPACES.        00483099
004840     05  STORE-BEING-PROCESSED   PIC S9(04)      COMP   VALUE +0. 00484099
004850     05  PO-BEING-PROCESSED      PIC S9(09)      COMP   VALUE +0. 00485099
004860     05  PV-TOTAL-ITEM-QTY-COMP  PIC S9(09)      COMP   VALUE +0. 00486099
004870     05  PV-TOTAL-ITEM-QTY       PIC S9(11)      COMP-3 VALUE +0. 00487099
004880     05  PV-TOTAL-COST-AMT       PIC S9(11)V9(3) COMP-3 VALUE +0. 00488099
004890     05  PV-TOTAL-RETAIL-AMT     PIC S9(11)V99   COMP-3 VALUE +0. 00489099
004900     05  PV-DETAIL-ITEM-QTY-COMP PIC S9(09)      COMP   VALUE +0. 00490099
005000     05  PV-DETAIL-ITEM-QTY      PIC S9(11)      COMP-3 VALUE +0. 00500099
005100     05  PV-DETAIL-COST-AMT      PIC S9(11)V9(3) COMP-3 VALUE +0. 00510099
005200     05  PV-DETAIL-RETAIL-AMT    PIC S9(11)V99   COMP-3 VALUE +0. 00520099
005300     05  PV-ACCUM-ITEM-QTY       PIC S9(14)      COMP-3 VALUE +0. 00530099
005400     05  PV-ACCUM-COST-AMT       PIC S9(13)V9(3) COMP-3 VALUE +0. 00540099
005500     05  PV-ACCUM-RETAIL-AMT     PIC S9(13)V99   COMP-3 VALUE +0. 00550099
005600     05  PV-PRORATION-PCT        PIC S9(01)V9(7) COMP-3 VALUE +0. 00560099
005700     05  PV-CLASS                PIC  X(02)  VALUE SPACES.        00570099
005800                                                                  00580099
005900 01  PROGRAM-SWITCHES.                                            00590099
006000     05  PS-END-OF-SKU-CSR-SW    PIC  X(01)   VALUE 'N'.          00600099
006100         88 END-OF-SKU-CSR                    VALUE 'Y'.          00610099
006200     05  PS-END-OF-CLASS-CSR-SW  PIC  X(01)   VALUE 'N'.          00620099
006300         88 END-OF-CLASS-CSR                  VALUE 'Y'.          00630099
006400     05  PS-PO-NBR-PROCESSED-SW  PIC  X(01)   VALUE 'N'.          00640099
006500         88 PO-NBR-PROCESSED                  VALUE 'Y'.          00650099
006600                                                                  00660099
006700 01  PRORATION-TABLE.                                             00670099
006800     05  TBL-CNT                 PIC 9(07)   VALUE 0.             00680099
006900     05  TBL-INDX                PIC 9(07)   VALUE 0.             00690099
007000     05  TBL-MAX                 PIC 9(07)   VALUE 100000.        00700099
007100     05  PRORATION-TBL OCCURS 100000 TIMES.                       00710099
007200         10 TBL-CL-NBR           PIC  X(2).                       00720099
007300         10 TBL-SKU-NBR          PIC  9(8).                       00730099
007400         10 TBL-STR-NBR          PIC S9(4)       COMP.            00740099
007500         10 TBL-ITEM-QTY         PIC S9(09)      COMP.            00750099
007600         10 TBL-COST-AMT         PIC S9(11)V9(3) COMP-3.          00760099
007700         10 TBL-RETAIL-AMT       PIC S9(11)V99   COMP-3.          00770099
007800                                                                  00780099
007900 01  ERROR-MESSAGES.                                              00790099
008000     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                00800099
008100             '*****   PROGRAM: DPKUP150'.                         00810099
008200     05  AA-PARAGRAPH-LIT.                                        00820099
008300         10  FILLER              PIC  X(17)  VALUE                00830099
008400             '***** PARAGRAPH: '.                                 00840099
008500         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        00850099
008600     05  AA-MESSAGE-LINE.                                         00860099
008700         10  FILLER              PIC  X(06)  VALUE '*****'.       00870099
008800         10  AA-MESSAGE          PIC  X(127) VALUE SPACES.        00880099
008900     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                00890099
009000             '*****    DB2 ERROR'.                                00900099
009100     05  AA-DB2-OPERATION-LIT.                                    00910099
009200         10  FILLER              PIC  X(17)  VALUE                00920099
009300             '***** OPERATION: '.                                 00930099
009400         10  AA-DB2-OPERATION.                                    00940099
009500             15  AA-DB2-OP-1     PIC  X(25)  VALUE SPACES.        00950099
009600             15  AA-DB2-OP-2     PIC  X(25)  VALUE SPACES.        00960099
009700     05  AA-DB2-TABLE-1          PIC  X(08)  VALUE SPACES.        00970099
009800     05  AA-DB2-TABLE-2          PIC  X(08)  VALUE SPACES.        00980099
009900     05  AA-DB2-TABLE-3          PIC  X(08)  VALUE SPACES.        00990099
010000*--------------------------------------------------------------*  01000099
010100*  DPWS004 CONTAINS THE FIELDS NECESSARY TO CALL THE SQLCA     *  01010099
010200*  MESSAGE MODULE 'DSNTIAR' AND DISPLAY THE FORMATTED RESULTS. *  01020099
010300*--------------------------------------------------------------*  01030099
010400     COPY DPWS004.                                                01040099
010500 EJECT                                                            01050099
010600                                                                  01060099
010700*---------------------------------------------------------------  01070099
010800*  COMMUNICATIONS AREA2 FOR DB2                                   01080099
010900*---------------------------------------------------------------  01090099
011000     COPY SQLCA2.                                                 01100099
011100                                                                  01110099
011200*---------------------------------------------------------------  01120099
011300*     SQL COMMUNICATIONS AREA DCLGEN                              01130099
011400*---------------------------------------------------------------  01140099
011500     EXEC SQL                                                     01150099
011600         INCLUDE SQLCA                                            01160099
011700     END-EXEC.                                                    01170099
011800     EJECT                                                        01180099
011900                                                                  01190099
012000*---------------------------------------------------------------  01200099
012100*     TAJPRRT DCLGEN                                              01210099
012200*---------------------------------------------------------------  01220099
012300     EXEC SQL                                                     01230099
012400         INCLUDE TAJPRRT                                          01240099
012500     END-EXEC.                                                    01250099
012600     EJECT                                                        01260099
012700                                                                  01270099
012800*---------------------------------------------------------------  01280099
012900*     TPURCHS DCLGEN                                              01290099
013000*---------------------------------------------------------------  01300099
013100     EXEC SQL                                                     01310099
013200         INCLUDE TPURCHS                                          01320099
013300     END-EXEC.                                                    01330099
013400     EJECT                                                        01340099
013500                                                                  01350099
013600*---------------------------------------------------------------  01360099
013700*     TPURITM DCLGEN                                              01370099
013800*---------------------------------------------------------------  01380099
013900     EXEC SQL                                                     01390099
014000         INCLUDE TPURITM                                          01400099
014100     END-EXEC.                                                    01410099
014200     EJECT                                                        01420099
014300                                                                  01430099
014400*---------------------------------------------------------------  01440099
014500*     TRECEIV DCLGEN                                              01450099
014600*---------------------------------------------------------------  01460099
014700     EXEC SQL                                                     01470099
014800         INCLUDE TRECEIV                                          01480099
014900     END-EXEC.                                                    01490099
015000     EJECT                                                        01500099
015100                                                                  01510099
015200*---------------------------------------------------------------  01520099
015300*     TRECITM DCLGEN                                              01530099
015400*---------------------------------------------------------------  01540099
015500     EXEC SQL                                                     01550099
015600         INCLUDE TRECITM                                          01560099
015700     END-EXEC.                                                    01570099
015800     EJECT                                                        01580099
015900                                                                  01590099
016000*---------------------------------------------------------------  01600099
016100*     TRECDIS DCLGEN                                              01610099
016200*---------------------------------------------------------------  01620099
016300     EXEC SQL                                                     01630099
016400         INCLUDE TRECDIS                                          01640099
016500     END-EXEC.                                                    01650099
016600     EJECT                                                        01660099
016700                                                                  01670099
016800*---------------------------------------------------------------* 01680099
016900*  CLASS CURSOR - CLASS_CSR                                     * 01690099
017000*  RETRIEVES THE QUANTITY, COST, AND RETAIL VALUES FOR THE PO   * 01700099
017100*  BEING PROCESSED, SUMMED BY CLASS NUMBER AND STORE NUMBER.    * 01710099
017200*  THIS CAN BE PROCESSING ONE RECEIVER OR ALL RECEIVERS, ONE    * 01720099
017300*  STORE OR ALL STORES, AND ONE PO LINE OR ALL LINES, DEPENDING * 01730099
017400*  ON THE PARAMETERS PASSED.  THAT IS WHY THESE 3 COLUMNS USE   * 01740099
017500* 'BETWEEN' CLAUSES IN THE WHERE CONDITION.                     * 01750099
017600*---------------------------------------------------------------* 01760099
017700     EXEC SQL                                                     01770099
017800         DECLARE CLASS_CSR CURSOR FOR                             01780099
017900         SELECT PI.CL_NBR                                         01790099
018000              , RD.STR_NBR                                        01800099
018100              , SUM(RD.AP_VERIFY_ITM_QTY)                         01810099
018200              , SUM(RD.AP_VERIFY_ITM_QTY * PI.UNT_COST_AMT)       01820099
018300              , SUM(CASE WHEN PI.GP_QTY > 1                       01830099
018400                    THEN RD.AP_VERIFY_ITM_QTY * PI.GP_RTL_AMT /   01840099
018500                         PI.GP_QTY                                01850099
018600                    ELSE RD.AP_VERIFY_ITM_QTY * PI.UNT_RTL_PR_AMT 01860099
018700                    END)                                          01870099
018800         FROM TRECEIV RV                                          01880099
018900            , TPURITM PI                                          01890099
019000            , TRECDIS RD                                          01900099
019100            , TRECITM RI                                          01910099
019200        WHERE RV.ORD_NBR          = :PO-BEING-PROCESSED           01920099
019300          AND RV.STATUS_CDE       = 'VE'                          01930099
019400          AND RV.FS_POST_TMST    ^= '9999-09-09-09.09.09.999999'  01940099
019500                                                                  01950099
019600          AND RV.ORD_NBR          = RI.ORD_NBR                    01960099
019700          AND RV.ORD_NBR          = RD.ORD_NBR                    01970099
019800          AND RV.ORD_NBR          = PI.PO_NBR                     01980099
019900                                                                  01990099
020000          AND RV.VER_STATUS_CDE   = 'A'                           02000099
020100          AND RI.VER_STATUS_CDE   = 'A'                           02010099
020300                                                                  02030099
020400          AND RV.REC_SEQ_NBR      BETWEEN :LOW-SEQ-NBR AND        02040099
020500                                          :HIGH-SEQ-NBR           02050099
020600          AND RV.REC_SEQ_NBR      = RI.REC_SEQ_NBR                02060099
020700          AND RV.REC_SEQ_NBR      = RD.REC_SEQ_NBR                02070099
020800                                                                  02080099
020900          AND ((RI.OPER_UNT_ID      BETWEEN :LOW-OPER-UNT AND     02090099
021000                                            :HIGH-OPER-UNT)       02100099
021010           OR (RV.CURR_OPER_UNT_ID  BETWEEN :LOW-OPER-UNT AND     02101099
021020                                            :HIGH-OPER-UNT))      02102099
021030          AND RI.OPER_UNT_ID      = RD.OPER_UNT_ID                02103099
021040          AND RI.FCLTY_ID         = RD.FCLTY_ID                   02104099
021090          AND RD.STR_NBR          BETWEEN :LOW-STR-NBR AND        02109099
021100                                          :HIGH-STR-NBR           02110099
021200          AND RI.ORD_LNE_NBR      BETWEEN :LOW-LNE-NBR AND        02120099
021300                                          :HIGH-LNE-NBR           02130099
021400          AND RI.ORD_LNE_NBR      = RD.ORD_LNE_NBR                02140099
021500          AND RI.ORD_LNE_NBR      = PI.APP_PO_LNE_NBR             02150099
021600                                                                  02160099
021700          AND RI.PO_VER_NBR       = PI.VER_NBR                    02170099
021800        GROUP BY RD.STR_NBR                                       02180099
021900               , PI.CL_NBR                                        02190099
022000        ORDER BY RD.STR_NBR                                       02200099
022100               , PI.CL_NBR                                        02210099
022200     END-EXEC.                                                    02220099
022300     EJECT                                                        02230099
022400                                                                  02240099
022500*---------------------------------------------------------------* 02250099
022600*  SKU CURSOR - SKU_CSR                                         * 02260099
022700*  RETRIEVES THE QUANTITY, COST, AND RETAIL VALUES FOR THE PO   * 02270099
022800*  BEING PROCESSED, SUMMED BY CLASS NUMBER, SKU NUMBER, AND     * 02280099
022900*  STORE NUMBER.  THIS CAN BE PROCESSING ONE RECEIVER OR ALL    * 02290099
023000*  RECEIVERS, ONE STORE OR ALL STORES, AND ONE PO LINE OR ALL   * 02300099
023100*  LINES, DEPENDING ON THE PARAMETERS PASSED. THAT IS WHY THESE * 02310099
023200*  3 COLUMNS USE 'BETWEEN' CLAUSES IN THE WHERE CONDITION.      * 02320099
023300*---------------------------------------------------------------* 02330099
023400     EXEC SQL                                                     02340099
023500         DECLARE SKU_CSR CURSOR FOR                               02350099
023600         SELECT PI.RMS_PO_SKU_NBR                                 02360099
023700              , PI.CL_NBR                                         02370099
023800              , RD.STR_NBR                                        02380099
023900              , SUM(RD.AP_VERIFY_ITM_QTY)                         02390099
024000              , SUM(RD.AP_VERIFY_ITM_QTY * PI.UNT_COST_AMT)       02400099
024100              , SUM(CASE WHEN PI.GP_QTY > 1                       02410099
024200                    THEN RD.AP_VERIFY_ITM_QTY * PI.GP_RTL_AMT /   02420099
024300                         PI.GP_QTY                                02430099
024400                    ELSE RD.AP_VERIFY_ITM_QTY * PI.UNT_RTL_PR_AMT 02440099
024500                    END)                                          02450099
024600         FROM TRECEIV RV                                          02460099
024700            , TPURITM PI                                          02470099
024800            , TRECDIS RD                                          02480099
024900            , TRECITM RI                                          02490099
025000        WHERE RV.ORD_NBR          = :PO-BEING-PROCESSED           02500099
025100          AND RV.STATUS_CDE       = 'VE'                          02510099
025200          AND RV.FS_POST_TMST    ^= '9999-09-09-09.09.09.999999'  02520099
025300                                                                  02530099
025400          AND RV.ORD_NBR          = RI.ORD_NBR                    02540099
025500          AND RV.ORD_NBR          = RD.ORD_NBR                    02550099
025600          AND RV.ORD_NBR          = PI.PO_NBR                     02560099
025700                                                                  02570099
025800          AND RV.VER_STATUS_CDE   = 'A'                           02580099
025900          AND RI.VER_STATUS_CDE   = 'A'                           02590099
026100                                                                  02610099
026200          AND RV.REC_SEQ_NBR      BETWEEN :LOW-SEQ-NBR AND        02620099
026300                                          :HIGH-SEQ-NBR           02630099
026400          AND RV.REC_SEQ_NBR      = RI.REC_SEQ_NBR                02640099
026500          AND RV.REC_SEQ_NBR      = RD.REC_SEQ_NBR                02650099
026600                                                                  02660099
026700          AND ((RI.OPER_UNT_ID      BETWEEN :LOW-OPER-UNT AND     02670099
026800                                            :HIGH-OPER-UNT)       02680099
026900           OR (RV.CURR_OPER_UNT_ID  BETWEEN :LOW-OPER-UNT AND     02690099
027000                                            :HIGH-OPER-UNT))      02700099
027100          AND RI.OPER_UNT_ID      = RD.OPER_UNT_ID                02710099
027200          AND RI.FCLTY_ID         = RD.FCLTY_ID                   02720099
027700          AND RD.STR_NBR          BETWEEN :LOW-STR-NBR AND        02770099
027800                                          :HIGH-STR-NBR           02780099
027900          AND RI.ORD_LNE_NBR      BETWEEN :LOW-LNE-NBR AND        02790099
028000                                          :HIGH-LNE-NBR           02800099
028100          AND RI.ORD_LNE_NBR      = RD.ORD_LNE_NBR                02810099
028200          AND RI.ORD_LNE_NBR      = PI.APP_PO_LNE_NBR             02820099
028210                                                                  02821099
028220          AND RI.PO_VER_NBR       = PI.VER_NBR                    02822099
028230        GROUP BY PI.RMS_PO_SKU_NBR                                02823099
028240               , PI.CL_NBR                                        02824099
028250               , RD.STR_NBR                                       02825099
028260     END-EXEC.                                                    02826099
028270     EJECT                                                        02827099
028280                                                                  02828099
028290 LINKAGE SECTION.                                                 02829099
028300                                                                  02830099
028400     COPY APWS150.                                                02840099
028500                                                                  02850099
028600***************************************************               02860099
028700 PROCEDURE DIVISION USING WS150-PRORATE-PARAMETERS.               02870099
028800***************************************************               02880099
028900                                                                  02890099
029000 A100-MAINLINE-ROUTINE.                                           02900099
029100                                                                  02910099
029200     PERFORM B100-INITIALIZATION.                                 02920099
029300                                                                  02930099
029400     IF (WS150-ERRORS-FOUND)                                      02940099
029500         OR (PO-NBR-PROCESSED)                                    02950099
029600         CONTINUE                                                 02960099
029700     ELSE                                                         02970099
029800         PERFORM B200-PROCESS-PRORATION                           02980099
029900     END-IF.                                                      02990099
030000                                                                  03000099
030100     GOBACK.                                                      03010099
030200                                                                  03020099
030300*--------------------------------------------------------------*  03030099
030400*    INITIALIZATION PROCESSING                                 *  03040099
030500*--------------------------------------------------------------*  03050099
030600 B100-INITIALIZATION.                                             03060099
030700                                                                  03070099
030800     INITIALIZE DCLTAJPRRT                                        03080099
030900                DCLTPURCHS                                        03090099
031000                DCLTPURITM                                        03100099
031100                DCLTRECEIV                                        03110099
031200                DCLTRECITM                                        03120099
031300                DCLTRECDIS.                                       03130099
031400                                                                  03140099
031500     MOVE 'N' TO PS-END-OF-CLASS-CSR-SW.                          03150099
031600     MOVE 'N' TO PS-END-OF-SKU-CSR-SW.                            03160099
031700     MOVE 'N' TO PS-PO-NBR-PROCESSED-SW.                          03170099
031800*---------------------------------------------------------------* 03180099
031900*  SET UP THE HOST VARIABLE BASED ON THE DATE PASSED IN THE     * 03190099
032000*  PARAMETER LIST                                               * 03200099
032100*---------------------------------------------------------------* 03210099
032200     IF WS150-PO-NBR > 0                                          03220099
032300         MOVE WS150-PO-NBR TO PO-BEING-PROCESSED                  03230099
032400     ELSE                                                         03240099
032500         MOVE 'B100-INITIALIZATION'    TO AA-PARAGRAPH-NAME       03250099
032600         MOVE 'PO NUMBER NOT > 0'      TO AA-MESSAGE              03260099
032700         PERFORM Z901-ERROR-ROUTINE                               03270099
032800     END-IF.                                                      03280099
032900                                                                  03290099
033000     IF WS150-PRORATE-TO-ALL-RCVRS                                03300099
033100        MOVE ZEROES            TO LOW-SEQ-NBR                     03310099
033200        MOVE 999999999         TO HIGH-SEQ-NBR                    03320099
033300     ELSE                                                         03330099
033400        MOVE WS150-REC-SEQ-NBR TO LOW-SEQ-NBR                     03340099
033500        MOVE WS150-REC-SEQ-NBR TO HIGH-SEQ-NBR                    03350099
033600     END-IF.                                                      03360099
033700                                                                  03370099
033800     IF WS150-PRORATE-TO-ALL-STORES                               03380099
033900        MOVE ZEROES            TO LOW-STR-NBR                     03390099
034000        MOVE 9999              TO HIGH-STR-NBR                    03400099
034100     ELSE                                                         03410099
034200        MOVE WS150-STR-NBR     TO LOW-STR-NBR                     03420099
034300        MOVE WS150-STR-NBR     TO HIGH-STR-NBR                    03430099
034400     END-IF.                                                      03440099
034500                                                                  03450099
036172     IF WS150-PRORATE-TO-ALL-LINES                                03617299
036173        MOVE ZEROES            TO LOW-LNE-NBR                     03617399
036174        MOVE 999999999         TO HIGH-LNE-NBR                    03617499
036175     ELSE                                                         03617599
036176        MOVE WS150-PO-LNE-NBR  TO LOW-LNE-NBR                     03617699
036177        MOVE WS150-PO-LNE-NBR  TO HIGH-LNE-NBR                    03617799
036178     END-IF.                                                      03617899
036179                                                                  03617999
036180     IF WS150-PRORATE-TO-ALL-DCS                                  03618099
036190        MOVE ZEROES            TO LOW-OPER-UNT                    03619099
036200        MOVE 9999              TO HIGH-OPER-UNT                   03620099
036300     ELSE                                                         03630099
036400        MOVE WS150-DC-NBR      TO LOW-OPER-UNT                    03640099
036500        MOVE WS150-DC-NBR      TO HIGH-OPER-UNT                   03650099
036600     END-IF.                                                      03660099
036700                                                                  03670099
036800     PERFORM VARYING TBL-INDX FROM 1 BY 1                         03680099
036900       UNTIL TBL-INDX = 100000                                    03690099
036910         MOVE SPACES     TO TBL-CL-NBR(TBL-INDX)                  03691099
036920         MOVE ZEROES     TO TBL-SKU-NBR(TBL-INDX)                 03692099
036930         MOVE ZEROES     TO TBL-STR-NBR(TBL-INDX)                 03693099
036940         MOVE ZEROES     TO TBL-ITEM-QTY(TBL-INDX)                03694099
036950         MOVE ZEROES     TO TBL-COST-AMT(TBL-INDX)                03695099
036960         MOVE ZEROES     TO TBL-RETAIL-AMT(TBL-INDX)              03696099
036970     END-PERFORM.                                                 03697099
036980     MOVE ZERO    TO TBL-CNT.                                     03698099
036990     MOVE ZERO    TO TBL-INDX.                                    03699099
037000     MOVE 100000  TO TBL-MAX.                                     03700099
037100                                                                  03710099
037200     MOVE ZEROS   TO PV-TOTAL-ITEM-QTY.                           03720099
037300     MOVE ZEROS   TO PV-TOTAL-COST-AMT.                           03730099
037400     MOVE ZEROS   TO PV-TOTAL-RETAIL-AMT.                         03740099
037500                                                                  03750099
037600     PERFORM S200-SELECT-DEPARTMENT.                              03760099
037700     PERFORM S300-SELECT-PO-NBR.                                  03770099
037800 EJECT                                                            03780099
037900                                                                  03790099
038000*---------------------------------------------------------------* 03800099
038100*  THIS STEP DETERMINES WHICH CURSOR TO USE TO RETRIEVE THE     * 03810099
038200*  DETAIL LEVEL INFORMATION                                     * 03820099
038300*---------------------------------------------------------------* 03830099
038400 B200-PROCESS-PRORATION.                                          03840099
038500                                                                  03850099
038600     EVALUATE TRUE                                                03860099
038700     WHEN WS150-MAJOR-CLASS                                       03870099
038800         PERFORM Y200-OPEN-CLASS-CSR                              03880099
038900         IF WS150-SUCCESSFUL                                      03890099
039000            PERFORM D100-LOAD-PRORATION-TABLE-CL                  03900099
039100            MOVE TBL-STR-NBR(1) TO STORE-BEING-PROCESSED          03910099
039200            MOVE 1 TO TBL-INDX                                    03920099
039300            PERFORM C200-PRORATE-BY-MAJOR-CLASS                   03930099
039400              UNTIL (TBL-INDX = TBL-CNT) OR                       03940099
039500                    (WS150-ERRORS-FOUND)                          03950099
039600            PERFORM Y400-CLOSE-CLASS-CSR                          03960099
039700         END-IF                                                   03970099
039800     WHEN WS150-SUB-CLASS                                         03980099
039900         PERFORM Y200-OPEN-CLASS-CSR                              03990099
040000         IF WS150-SUCCESSFUL                                      04000099
040100            PERFORM D100-LOAD-PRORATION-TABLE-CL                  04010099
040200            MOVE 1 TO TBL-INDX                                    04020099
040300            PERFORM C300-PRORATE-BY-SUB-CLASS                     04030099
040400              UNTIL (TBL-INDX = TBL-CNT) OR                       04040099
040500                    (WS150-ERRORS-FOUND)                          04050099
040600            PERFORM Y400-CLOSE-CLASS-CSR                          04060099
040700         END-IF                                                   04070099
040800     WHEN WS150-SKU                                               04080099
040900         PERFORM Y100-OPEN-SKU-CSR                                04090099
041000         IF WS150-SUCCESSFUL                                      04100099
041100            PERFORM D200-LOAD-PRORATION-TABLE-SKU                 04110099
041200            MOVE 1 TO TBL-INDX                                    04120099
041300            PERFORM C400-PRORATE-BY-SKU                           04130099
041400              UNTIL (TBL-INDX = TBL-CNT) OR                       04140099
041500                    (WS150-ERRORS-FOUND)                          04150099
041600            PERFORM Y300-CLOSE-SKU-CSR                            04160099
041700         END-IF                                                   04170099
041800     END-EVALUATE.                                                04180099
041900 EJECT                                                            04190099
042000                                                                  04200099
042100*---------------------------------------------------------------* 04210099
042200*  PRORATING BY MAJOR CLASS.  THE CLASS CURSOR RETURNS THE DATA * 04220099
042300*  AT THE SUBCLASS LEVEL, SO THIS PARAGRAPH ACCUMULATES THE     * 04230099
042400*  RECORDS FOR THE SAME MAJOR CLASS, PRIOR TO CALCULATING THE   * 04240099
042500*  PRORATION PERCENTAGE AND INSERTING THE ROW IN THE TAJPRRT    * 04250099
042600*  TABLE.  THE MAJOR CLASS IS IDENTIFIED BY THE FIRST DIGIT OF  * 04260099
042700*  OF THE CLASS NUMBER, PLUS A ZERO.                            * 04270099
042800*---------------------------------------------------------------* 04280099
042900 C200-PRORATE-BY-MAJOR-CLASS.                                     04290099
043000                                                                  04300099
043100     MOVE ZEROES TO PV-ACCUM-ITEM-QTY                             04310099
043200                    PV-ACCUM-COST-AMT                             04320099
043300                    PV-ACCUM-RETAIL-AMT.                          04330099
043400                                                                  04340099
043500     MOVE TBL-CL-NBR(TBL-INDX)  TO PV-CLASS                       04350099
043600     MOVE PV-CLASS(1:1)         TO CLASS-BEING-PROCESSED(1:1).    04360099
043700     MOVE '0'                   TO CLASS-BEING-PROCESSED(2:1).    04370099
043800     MOVE PURCHS-PO-NBR         TO AJPRRT-PO-NBR.                 04380099
043900     MOVE WS150-REC-SEQ-NBR     TO AJPRRT-RCVR-SEQ-NBR            04390099
044000     MOVE WS150-PO-LNE-NBR      TO AJPRRT-PO-LNE-NBR              04400099
044100     MOVE PURCHS-DEPT-NBR       TO AJPRRT-DEPT-NBR.               04410099
044200     MOVE CLASS-BEING-PROCESSED TO AJPRRT-CL-NBR.                 04420099
044300     MOVE ZEROES                TO AJPRRT-SKU-NBR.                04430099
044400     MOVE TBL-STR-NBR(TBL-INDX) TO AJPRRT-STR-NBR.                04440099
044500     MOVE ZEROES                TO AJPRRT-TRIP-ID.                04450099
044600     MOVE ZEROES                TO AJPRRT-ENT-ID.                 04460099
044700                                                                  04470099
044800     PERFORM VARYING TBL-INDX FROM TBL-INDX BY 1                  04480099
044900             UNTIL ((TBL-CL-NBR(TBL-INDX)(1:1)) NOT =             04490099
045000                    CLASS-BEING-PROCESSED(1:1))                   04500099
045100                OR (TBL-STR-NBR(TBL-INDX) NOT =                   04510099
045200                    STORE-BEING-PROCESSED)                        04520099
045300         COMPUTE PV-ACCUM-ITEM-QTY =                              04530099
045400                 PV-ACCUM-ITEM-QTY + TBL-ITEM-QTY(TBL-INDX)       04540099
045500         COMPUTE PV-ACCUM-COST-AMT =                              04550099
045600                 PV-ACCUM-COST-AMT + TBL-COST-AMT(TBL-INDX)       04560099
045700         COMPUTE PV-ACCUM-RETAIL-AMT =                            04570099
045800                 PV-ACCUM-RETAIL-AMT + TBL-RETAIL-AMT(TBL-INDX)   04580099
045810         MOVE TBL-CL-NBR(TBL-INDX) TO PV-CLASS                    04581099
045820     END-PERFORM.                                                 04582099
045830     MOVE TBL-STR-NBR(TBL-INDX) TO STORE-BEING-PROCESSED.         04583099
045840                                                                  04584099
045850     EVALUATE TRUE                                                04585099
045860         WHEN WS150-BASE-ON-QUANTITY                              04586099
045870             IF PV-TOTAL-ITEM-QTY = ZERO                          04587099
045880                MOVE ZERO TO PV-PRORATION-PCT                     04588099
045890             ELSE                                                 04589099
045900                COMPUTE PV-PRORATION-PCT =                        04590099
046000                    (PV-ACCUM-ITEM-QTY   / PV-TOTAL-ITEM-QTY)     04600099
046100                    + .0000005                                    04610099
046200              END-IF                                              04620099
046300         WHEN WS150-BASE-ON-COST                                  04630099
046400             IF PV-TOTAL-COST-AMT = ZERO                          04640099
046500                MOVE ZERO TO PV-PRORATION-PCT                     04650099
046600             ELSE                                                 04660099
046700                COMPUTE PV-PRORATION-PCT =                        04670099
046800                    (PV-ACCUM-COST-AMT   / PV-TOTAL-COST-AMT)     04680099
046900                    + .0000005                                    04690099
047000              END-IF                                              04700099
047100         WHEN WS150-BASE-ON-RETAIL                                04710099
047200             IF PV-TOTAL-RETAIL-AMT = ZERO                        04720099
047300                MOVE ZERO TO PV-PRORATION-PCT                     04730099
047400             ELSE                                                 04740099
047500                COMPUTE PV-PRORATION-PCT =                        04750099
047600                    (PV-ACCUM-RETAIL-AMT / PV-TOTAL-RETAIL-AMT)   04760099
047700                    + .0000005                                    04770099
047800             END-IF                                               04780099
047900     END-EVALUATE.                                                04790099
048000     MOVE PV-PRORATION-PCT      TO AJPRRT-PRRT-PCT.               04800099
048100                                                                  04810099
048200     PERFORM I100-INSERT-ADJ-PRORATION.                           04820099
048300 EJECT                                                            04830099
048400                                                                  04840099
048500*---------------------------------------------------------------* 04850099
048600*  PRORATING BY SUBCLASS.                                       * 04860099
048700*  THIS PARAGRAPH CALCULATES THE PRORATION PRECENTAGE BASED ON  * 04870099
048800*  SUBCLASS AND INSERTS THE ROW INTO THE TAJPRRT TABLE.         * 04880099
048900*---------------------------------------------------------------* 04890099
049000 C300-PRORATE-BY-SUB-CLASS.                                       04900099
049100     EVALUATE TRUE                                                04910099
049200         WHEN WS150-BASE-ON-QUANTITY                              04920099
049300             IF PV-TOTAL-ITEM-QTY = ZERO                          04930099
049400                MOVE ZERO TO PV-PRORATION-PCT                     04940099
049500             ELSE                                                 04950099
049600                COMPUTE PV-PRORATION-PCT =                        04960099
049700                    (TBL-ITEM-QTY(TBL-INDX) / PV-TOTAL-ITEM-QTY)  04970099
049800                    + .0000005                                    04980099
049900             END-IF                                               04990099
050000         WHEN WS150-BASE-ON-COST                                  05000099
050100             IF PV-TOTAL-COST-AMT = ZERO                          05010099
050200                MOVE ZERO TO PV-PRORATION-PCT                     05020099
050300             ELSE                                                 05030099
050400                COMPUTE PV-PRORATION-PCT =                        05040099
050500                    (TBL-COST-AMT(TBL-INDX) / PV-TOTAL-COST-AMT)  05050099
050600                    + .0000005                                    05060099
050700             END-IF                                               05070099
050800         WHEN WS150-BASE-ON-RETAIL                                05080099
050900             IF PV-TOTAL-RETAIL-AMT = ZERO                        05090099
051000                MOVE ZERO TO PV-PRORATION-PCT                     05100099
051100             ELSE                                                 05110099
051200                COMPUTE PV-PRORATION-PCT =                        05120099
051300                 (TBL-RETAIL-AMT(TBL-INDX) / PV-TOTAL-RETAIL-AMT) 05130099
051400                    + .0000005                                    05140099
051500             END-IF                                               05150099
051600     END-EVALUATE.                                                05160099
051700     MOVE PURCHS-PO-NBR         TO AJPRRT-PO-NBR.                 05170099
051800     MOVE WS150-REC-SEQ-NBR     TO AJPRRT-RCVR-SEQ-NBR            05180099
051900     MOVE WS150-PO-LNE-NBR      TO AJPRRT-PO-LNE-NBR              05190099
052000     MOVE PURCHS-DEPT-NBR       TO AJPRRT-DEPT-NBR.               05200099
052100     MOVE TBL-CL-NBR(TBL-INDX)  TO AJPRRT-CL-NBR.                 05210099
052200     MOVE ZEROES                TO AJPRRT-SKU-NBR.                05220099
052300     MOVE TBL-STR-NBR(TBL-INDX) TO AJPRRT-STR-NBR.                05230099
052400     MOVE PV-PRORATION-PCT      TO AJPRRT-PRRT-PCT.               05240099
052500     MOVE ZEROES                TO AJPRRT-TRIP-ID.                05250099
052600     MOVE ZEROES                TO AJPRRT-ENT-ID.                 05260099
052700                                                                  05270099
052800     PERFORM I100-INSERT-ADJ-PRORATION.                           05280099
052900     ADD +1 TO TBL-INDX.                                          05290099
053000 EJECT                                                            05300099
053100                                                                  05310099
053200*---------------------------------------------------------------* 05320099
053300*  PRORATING BY SKU SEQUENCE.                                   * 05330099
053400*  THIS PARAGRAPH CALCULATES THE PRORATION PRECENTAGE BASED ON  * 05340099
053500*  SKU AND INSERTS THE ROW INTO THE TAJPRRT TABLE.              * 05350099
053600*---------------------------------------------------------------* 05360099
053700 C400-PRORATE-BY-SKU.                                             05370099
053800                                                                  05380099
053900     EVALUATE TRUE                                                05390099
054000         WHEN WS150-BASE-ON-QUANTITY                              05400099
054100             IF PV-TOTAL-ITEM-QTY = ZERO                          05410099
054200                MOVE ZERO TO PV-PRORATION-PCT                     05420099
054300             ELSE                                                 05430099
054400                COMPUTE PV-PRORATION-PCT =                        05440099
054500                    (TBL-ITEM-QTY(TBL-INDX) / PV-TOTAL-ITEM-QTY)  05450099
054600                    + .0000005                                    05460099
054700             END-IF                                               05470099
054800         WHEN WS150-BASE-ON-COST                                  05480099
054900             IF PV-TOTAL-COST-AMT = ZERO                          05490099
055000                MOVE ZERO TO PV-PRORATION-PCT                     05500099
055100             ELSE                                                 05510099
055200                COMPUTE PV-PRORATION-PCT =                        05520099
055300                    (TBL-COST-AMT(TBL-INDX) / PV-TOTAL-COST-AMT)  05530099
055400                    + .0000005                                    05540099
055500             END-IF                                               05550099
055600         WHEN WS150-BASE-ON-RETAIL                                05560099
055700             IF PV-TOTAL-RETAIL-AMT = ZERO                        05570099
055800                MOVE ZERO TO PV-PRORATION-PCT                     05580099
055900             ELSE                                                 05590099
056000                COMPUTE PV-PRORATION-PCT =                        05600099
056100                 (TBL-RETAIL-AMT(TBL-INDX) / PV-TOTAL-RETAIL-AMT) 05610099
056200                    + .0000005                                    05620099
056300             END-IF                                               05630099
056400     END-EVALUATE.                                                05640099
056500     MOVE PURCHS-PO-NBR             TO AJPRRT-PO-NBR.             05650099
056600     MOVE WS150-REC-SEQ-NBR         TO AJPRRT-RCVR-SEQ-NBR        05660099
056700     MOVE WS150-PO-LNE-NBR          TO AJPRRT-PO-LNE-NBR          05670099
056800     MOVE PURCHS-DEPT-NBR           TO AJPRRT-DEPT-NBR.           05680099
056900     MOVE TBL-CL-NBR(TBL-INDX)      TO AJPRRT-CL-NBR.             05690099
057000     MOVE TBL-SKU-NBR(TBL-INDX)     TO AJPRRT-SKU-NBR.            05700099
057100     MOVE TBL-STR-NBR(TBL-INDX)     TO AJPRRT-STR-NBR.            05710099
057200     MOVE PV-PRORATION-PCT          TO AJPRRT-PRRT-PCT.           05720099
057300     MOVE ZEROES                    TO AJPRRT-TRIP-ID.            05730099
057400     MOVE ZEROES                    TO AJPRRT-ENT-ID.             05740099
057500                                                                  05750099
057600     PERFORM I100-INSERT-ADJ-PRORATION.                           05760099
057700     ADD +1 TO TBL-INDX.                                          05770099
057800 EJECT                                                            05780099
057900                                                                  05790099
058000*---------------------------------------------------------------* 05800099
058100*  LOADS THE PRORATION TABLE FROM THE CLASS CURSOR AND TOTALS   * 05810099
058200*  THE QUANTITY, COST, COST AND RETAIL AMOUNTS.                 * 05820099
058300*---------------------------------------------------------------* 05830099
058400 D100-LOAD-PRORATION-TABLE-CL.                                    05840099
058500* INITIAL READ/FETCH                                              05850099
058600     PERFORM S500-FETCH-CLASS-CSR                                 05860099
058700     PERFORM VARYING TBL-INDX FROM 1 BY 1                         05870099
058800               UNTIL TBL-INDX > TBL-MAX                           05880099
058900                  OR END-OF-CLASS-CSR                             05890099
059000                                                                  05900099
059100        MOVE PURITM-CL-NBR           TO TBL-CL-NBR(TBL-INDX)      05910099
059200        MOVE ZEROES                  TO TBL-SKU-NBR(TBL-INDX)     05920099
059300        MOVE RECDIS-STR-NBR          TO TBL-STR-NBR(TBL-INDX)     05930099
059400        MOVE PV-DETAIL-ITEM-QTY-COMP TO TBL-ITEM-QTY(TBL-INDX)    05940099
059500        MOVE PV-DETAIL-COST-AMT      TO TBL-COST-AMT(TBL-INDX)    05950099
059600        MOVE PV-DETAIL-RETAIL-AMT    TO TBL-RETAIL-AMT(TBL-INDX)  05960099
059700                                                                  05970099
059800        ADD PV-DETAIL-ITEM-QTY       TO PV-TOTAL-ITEM-QTY         05980099
059900        ADD PV-DETAIL-COST-AMT       TO PV-TOTAL-COST-AMT         05990099
060000        ADD PV-DETAIL-RETAIL-AMT     TO PV-TOTAL-RETAIL-AMT       06000099
060100                                                                  06010099
060200        PERFORM S500-FETCH-CLASS-CSR                              06020099
060300     END-PERFORM.                                                 06030099
060400     MOVE TBL-INDX TO TBL-CNT.                                    06040099
060500                                                                  06050099
060600*---------------------------------------------------------------* 06060099
060700*  LOADS THE PRORATION TABLE FROM THE SKU CURSOR AND TOTALS     * 06070099
060800*  THE QUANTITY, COST, COST AND RETAIL AMOUNTS.                 * 06080099
060900*---------------------------------------------------------------* 06090099
061000 D200-LOAD-PRORATION-TABLE-SKU.                                   06100099
061100                                                                  06110099
061200* INITIAL READ/FETCH                                              06120099
061300     PERFORM S400-FETCH-SKU-CSR                                   06130099
061400     PERFORM VARYING TBL-INDX FROM 1 BY 1                         06140099
061500               UNTIL TBL-INDX > TBL-MAX                           06150099
061600                  OR END-OF-SKU-CSR                               06160099
061700                                                                  06170099
061800        MOVE PURITM-CL-NBR           TO TBL-CL-NBR(TBL-INDX)      06180099
061900        MOVE PURITM-RMS-PO-SKU-NBR   TO TBL-SKU-NBR(TBL-INDX)     06190099
062000        MOVE RECDIS-STR-NBR          TO TBL-STR-NBR(TBL-INDX)     06200099
062100        MOVE PV-DETAIL-ITEM-QTY-COMP TO TBL-ITEM-QTY(TBL-INDX)    06210099
062200        MOVE PV-DETAIL-COST-AMT      TO TBL-COST-AMT(TBL-INDX)    06220099
062300        MOVE PV-DETAIL-RETAIL-AMT    TO TBL-RETAIL-AMT(TBL-INDX)  06230099
062400                                                                  06240099
062500        ADD PV-DETAIL-ITEM-QTY       TO PV-TOTAL-ITEM-QTY         06250099
062600        ADD PV-DETAIL-COST-AMT       TO PV-TOTAL-COST-AMT         06260099
062700        ADD PV-DETAIL-RETAIL-AMT     TO PV-TOTAL-RETAIL-AMT       06270099
062800                                                                  06280099
062900        PERFORM S400-FETCH-SKU-CSR                                06290099
063000     END-PERFORM.                                                 06300099
063100     MOVE TBL-INDX TO TBL-CNT.                                    06310099
063200                                                                  06320099
063300*---------------------------------------------------------------* 06330099
063400*  INSERTS A ROW INTO THE ADJUSTMENT PRORATION TABLE.           * 06340099
063500*---------------------------------------------------------------* 06350099
063600 I100-INSERT-ADJ-PRORATION.                                       06360099
063700                                                                  06370099
063800     EXEC SQL                                                     06380099
063900         INSERT INTO TAJPRRT                                      06390099
064000                ( PO_NBR                                          06400099
064100                 ,RCVR_SEQ_NBR                                    06410099
064200                 ,PO_LNE_NBR                                      06420099
064300                 ,DEPT_NBR                                        06430099
064400                 ,CL_NBR                                          06440099
064500                 ,SKU_NBR                                         06450099
064600                 ,STR_NBR                                         06460099
064700                 ,PRRT_PCT                                        06470099
064800                 ,TRIP_ID                                         06480099
064900                 ,ENT_ID                                          06490099
065000                )                                                 06500099
065100         VALUES ( :AJPRRT-PO-NBR                                  06510099
065200                 ,:AJPRRT-RCVR-SEQ-NBR                            06520099
065300                 ,:AJPRRT-PO-LNE-NBR                              06530099
065400                 ,:AJPRRT-DEPT-NBR                                06540099
065500                 ,:AJPRRT-CL-NBR                                  06550099
065600                 ,:AJPRRT-SKU-NBR                                 06560099
065700                 ,:AJPRRT-STR-NBR                                 06570099
065800                 ,:AJPRRT-PRRT-PCT                                06580099
065900                 ,:AJPRRT-TRIP-ID                                 06590099
066000                 ,:AJPRRT-ENT-ID                                  06600099
066100                )                                                 06610099
066200     END-EXEC.                                                    06620099
066300                                                                  06630099
066400     EVALUATE TRUE                                                06640099
066500         WHEN SQLCODE = ZEROES                                    06650099
066600             CONTINUE                                             06660099
066700         WHEN OTHER                                               06670099
066800             DISPLAY 'PO-BEING-PROCESSED  ' PO-BEING-PROCESSED    06680099
066810             MOVE 'I100-INSERT-ADJ-PRORATION'                     06681099
066820                                           TO AA-PARAGRAPH-NAME   06682099
066830             MOVE 'INSERT '                TO AA-DB2-OPERATION    06683099
066840             MOVE 'TAJPRRT'                TO AA-DB2-TABLE-1      06684099
066850             MOVE SPACES                   TO AA-DB2-TABLE-2      06685099
066860             MOVE SPACES                   TO AA-DB2-TABLE-3      06686099
066870             PERFORM Z900-DB2-ERROR-ROUTINE                       06687099
066880     END-EVALUATE.                                                06688099
066890 EJECT                                                            06689099
066900                                                                  06690099
067000*---------------------------------------------------------------* 06700099
067100*  SELECTS THE DEPARTMENT NUMBER FOR THE PO BEING PROCESSED     * 06710099
067200*---------------------------------------------------------------* 06720099
067300 S200-SELECT-DEPARTMENT.                                          06730099
067400                                                                  06740099
067500     EXEC SQL                                                     06750099
067600         SELECT PO_NBR                                            06760099
067700              , DEPT_NBR                                          06770099
067800           INTO :PURCHS-PO-NBR                                    06780099
067900              , :PURCHS-DEPT-NBR                                  06790099
068000           FROM TPURCHS                                           06800099
068100          WHERE PO_NBR = :PO-BEING-PROCESSED                      06810099
068200            AND VER_STATUS_CDE  = 'A'                             06820099
068300     END-EXEC.                                                    06830099
068400                                                                  06840099
068500     EVALUATE TRUE                                                06850099
068600         WHEN SQLCODE = ZEROES                                    06860099
068700             CONTINUE                                             06870099
068800         WHEN OTHER                                               06880099
068900             DISPLAY 'PO-BEING-PROCESSED  ' PO-BEING-PROCESSED    06890099
069000             MOVE 'S200-SELECT-DEPARTMENT' TO AA-PARAGRAPH-NAME   06900099
069100             MOVE 'SELECT '                TO AA-DB2-OPERATION    06910099
069200             MOVE 'TPURCHS'                TO AA-DB2-TABLE-1      06920099
069300             MOVE SPACES                   TO AA-DB2-TABLE-2      06930099
069400             MOVE SPACES                   TO AA-DB2-TABLE-3      06940099
069500             PERFORM Z900-DB2-ERROR-ROUTINE                       06950099
069600     END-EVALUATE.                                                06960099
069700 EJECT                                                            06970099
069800                                                                  06980099
069900*---------------------------------------------------------------* 06990099
070000*  CHECKS TO SEE IF THE PO HAS ALREADY BEEN PROCESSED           * 07000099
070100*---------------------------------------------------------------* 07010099
070200 S300-SELECT-PO-NBR.                                              07020099
070300                                                                  07030099
070400     EXEC SQL                                                     07040099
070500         SELECT DISTINCT PO_NBR                                   07050099
070600           INTO :AJPRRT-PO-NBR                                    07060099
070700           FROM TAJPRRT                                           07070099
070800          WHERE PO_NBR = :PO-BEING-PROCESSED                      07080099
070900     END-EXEC.                                                    07090099
071000                                                                  07100099
071100     EVALUATE TRUE                                                07110099
071200         WHEN SQLCODE = +100                                      07120099
071300             CONTINUE                                             07130099
071400         WHEN SQLCODE = ZEROES                                    07140099
071500             SET PO-NBR-PROCESSED TO TRUE                         07150099
071600         WHEN OTHER                                               07160099
071700             DISPLAY 'PO-BEING-PROCESSED  ' PO-BEING-PROCESSED    07170099
071800             MOVE 'Y300-SELECT-PO-NBR'     TO AA-PARAGRAPH-NAME   07180099
071900             MOVE 'SELECT '                TO AA-DB2-OPERATION    07190099
072000             MOVE 'TAJPRRT'                TO AA-DB2-TABLE-1      07200099
072100             MOVE SPACES                   TO AA-DB2-TABLE-2      07210099
072200             MOVE SPACES                   TO AA-DB2-TABLE-3      07220099
072300             PERFORM Z900-DB2-ERROR-ROUTINE                       07230099
072400     END-EVALUATE.                                                07240099
072500 EJECT                                                            07250099
072600                                                                  07260099
072700*---------------------------------------------------------------* 07270099
072800*  RETRIEVES THE QUANTITY, COST, AND RETAIL VALUES FOR THE PO   * 07280099
072900*  BEING PROCESSED, SUMMED BY CLASS NUMBER, SKU NUMBER, AND     * 07290099
073000*  STORE NUMBER.                                                * 07300099
073100*---------------------------------------------------------------* 07310099
073200 S400-FETCH-SKU-CSR.                                              07320099
073300                                                                  07330099
073400     EXEC SQL                                                     07340099
073500         FETCH SKU_CSR                                            07350099
073600          INTO :PURITM-RMS-PO-SKU-NBR                             07360099
073700             , :PURITM-CL-NBR                                     07370099
073800             , :RECDIS-STR-NBR                                    07380099
073900             , :PV-DETAIL-ITEM-QTY-COMP                           07390099
074000             , :PV-DETAIL-COST-AMT                                07400099
074100             , :PV-DETAIL-RETAIL-AMT                              07410099
074200     END-EXEC.                                                    07420099
074300     EVALUATE TRUE                                                07430099
074400         WHEN SQLCODE = ZEROES                                    07440099
074500             MOVE PV-DETAIL-ITEM-QTY-COMP TO PV-DETAIL-ITEM-QTY   07450099
074600         WHEN SQLCODE = +100                                      07460099
074700             SET END-OF-SKU-CSR TO TRUE                           07470099
074800         WHEN OTHER                                               07480099
074900             DISPLAY 'PO-BEING-PROCESSED  ' PO-BEING-PROCESSED    07490099
075000             MOVE 'S400-FETCH-SKU-CSR'     TO AA-PARAGRAPH-NAME   07500099
075100             MOVE 'FETCH CURSOR FROM TRECEIV'                     07510099
075200                                           TO AA-DB2-OPERATION    07520099
075300             MOVE 'TPURITM'                TO AA-DB2-TABLE-1      07530099
075400             MOVE 'TRECDIS'                TO AA-DB2-TABLE-2      07540099
075500             MOVE 'TRECITM'                TO AA-DB2-TABLE-3      07550099
075600             PERFORM Z900-DB2-ERROR-ROUTINE                       07560099
075700     END-EVALUATE.                                                07570099
075800 EJECT                                                            07580099
075900                                                                  07590099
076000*---------------------------------------------------------------* 07600099
076100*  RETRIEVES THE QUANTITY, COST, AND RETAIL VALUES FOR THE PO   * 07610099
076200*  BEING PROCESSED, SUMMED BY CLASS NUMBER AND STORE NUMBER.    * 07620099
076300*---------------------------------------------------------------* 07630099
076400 S500-FETCH-CLASS-CSR.                                            07640099
076500                                                                  07650099
076600     EXEC SQL                                                     07660099
076700         FETCH CLASS_CSR                                          07670099
076800          INTO :PURITM-CL-NBR                                     07680099
076900             , :RECDIS-STR-NBR                                    07690099
077000             , :PV-DETAIL-ITEM-QTY-COMP                           07700099
077100             , :PV-DETAIL-COST-AMT                                07710099
077200             , :PV-DETAIL-RETAIL-AMT                              07720099
077300     END-EXEC.                                                    07730099
077400                                                                  07740099
077500     EVALUATE TRUE                                                07750099
077600         WHEN SQLCODE = ZEROES                                    07760099
077700             MOVE PV-DETAIL-ITEM-QTY-COMP TO PV-DETAIL-ITEM-QTY   07770099
077800             SET WS150-SUCCESSFUL TO TRUE                         07780099
077900         WHEN SQLCODE = +100                                      07790099
078000             SET END-OF-CLASS-CSR TO TRUE                         07800099
078100         WHEN OTHER                                               07810099
078200             DISPLAY 'PO-BEING-PROCESSED  ' PO-BEING-PROCESSED    07820099
078300             MOVE 'S500-FETCH-CLASS-CSR'   TO AA-PARAGRAPH-NAME   07830099
078400             MOVE 'FETCH CURSOR FROM TRECEIV'                     07840099
078500                                           TO AA-DB2-OPERATION    07850099
078600             MOVE 'TPURITM'                TO AA-DB2-TABLE-1      07860099
078700             MOVE 'TRECDIS'                TO AA-DB2-TABLE-2      07870099
078800             MOVE 'TRECITM'                TO AA-DB2-TABLE-3      07880099
078900             PERFORM Z900-DB2-ERROR-ROUTINE                       07890099
079000     END-EVALUATE.                                                07900099
079100 EJECT                                                            07910099
079200                                                                  07920099
079300*---------------------------------------------------------------* 07930099
079400*  OPENS THE SKU CURSOR                                         * 07940099
079500*---------------------------------------------------------------* 07950099
079600 Y100-OPEN-SKU-CSR.                                               07960099
079700                                                                  07970099
079800     EXEC SQL                                                     07980099
079900         OPEN SKU_CSR                                             07990099
080000     END-EXEC.                                                    08000099
080100                                                                  08010099
080200     EVALUATE TRUE                                                08020099
080300         WHEN SQLCODE = ZEROES                                    08030099
080400             SET WS150-SUCCESSFUL TO TRUE                         08040099
080500         WHEN OTHER                                               08050099
080600             DISPLAY 'PO-BEING-PROCESSED  ' PO-BEING-PROCESSED    08060099
080700             MOVE 'Y100-OPEN-SKU-CSR'      TO AA-PARAGRAPH-NAME   08070099
080800             MOVE 'OPEN CURSOR - TRECEIV'  TO AA-DB2-OPERATION    08080099
080900             MOVE 'TPURITM'                TO AA-DB2-TABLE-1      08090099
081000             MOVE 'TRECDIS'                TO AA-DB2-TABLE-2      08100099
081100             MOVE 'TRECITM'                TO AA-DB2-TABLE-3      08110099
081200             PERFORM Z900-DB2-ERROR-ROUTINE                       08120099
081300     END-EVALUATE.                                                08130099
081400 EJECT                                                            08140099
081500                                                                  08150099
081600*---------------------------------------------------------------* 08160099
081700*  OPENS THE CLASS CURSOR                                       * 08170099
081800*---------------------------------------------------------------* 08180099
081900 Y200-OPEN-CLASS-CSR.                                             08190099
082000     EXEC SQL                                                     08200099
082100         OPEN CLASS_CSR                                           08210099
082200     END-EXEC.                                                    08220099
082300                                                                  08230099
082400     EVALUATE TRUE                                                08240099
082500         WHEN SQLCODE = ZEROES                                    08250099
082600             SET WS150-SUCCESSFUL TO TRUE                         08260099
082700         WHEN OTHER                                               08270099
082800             DISPLAY 'PO-BEING-PROCESSED  ' PO-BEING-PROCESSED    08280099
082900             MOVE 'Y200-OPEN-CLASS-CSR'    TO AA-PARAGRAPH-NAME   08290099
083000             MOVE 'OPEN CURSOR - TRECEIV'  TO AA-DB2-OPERATION    08300099
083100             MOVE 'TPURITM'                TO AA-DB2-TABLE-1      08310099
083200             MOVE 'TRECDIS'                TO AA-DB2-TABLE-2      08320099
083300             MOVE 'TRECITM'                TO AA-DB2-TABLE-3      08330099
083400             PERFORM Z900-DB2-ERROR-ROUTINE                       08340099
083500     END-EVALUATE.                                                08350099
083600 EJECT                                                            08360099
083700                                                                  08370099
083800*---------------------------------------------------------------* 08380099
083900*  CLOSES THE SKU CURSOR                                        * 08390099
084000*---------------------------------------------------------------* 08400099
084100 Y300-CLOSE-SKU-CSR.                                              08410099
084200     EXEC SQL                                                     08420099
084300         CLOSE SKU_CSR                                            08430099
084400     END-EXEC.                                                    08440099
084500                                                                  08450099
084600     EVALUATE TRUE                                                08460099
084700         WHEN SQLCODE = ZEROES                                    08470099
084800             CONTINUE                                             08480099
084900         WHEN OTHER                                               08490099
085000             DISPLAY 'PO-BEING-PROCESSED  ' PO-BEING-PROCESSED    08500099
085100             MOVE 'Y300-CLOSE-SKU-CSR'     TO AA-PARAGRAPH-NAME   08510099
085200             MOVE 'CLOSE CURSOR - TRECEIV' TO AA-DB2-OPERATION    08520099
085300             MOVE 'TPURITM'                TO AA-DB2-TABLE-1      08530099
085400             MOVE 'TRECDIS'                TO AA-DB2-TABLE-2      08540099
085500             MOVE 'TRECITM'                TO AA-DB2-TABLE-3      08550099
085600             PERFORM Z900-DB2-ERROR-ROUTINE                       08560099
085700     END-EVALUATE.                                                08570099
085800 EJECT                                                            08580099
085900                                                                  08590099
086000*---------------------------------------------------------------* 08600099
086100*  CLOSES THE CLASS CURSOR                                      * 08610099
086200*---------------------------------------------------------------* 08620099
086300 Y400-CLOSE-CLASS-CSR.                                            08630099
086400     EXEC SQL                                                     08640099
086500         CLOSE CLASS_CSR                                          08650099
086600     END-EXEC.                                                    08660099
086700                                                                  08670099
086800     EVALUATE TRUE                                                08680099
086900         WHEN SQLCODE = ZEROES                                    08690099
087000             CONTINUE                                             08700099
087100         WHEN OTHER                                               08710099
087200             DISPLAY 'PO-BEING-PROCESSED  ' PO-BEING-PROCESSED    08720099
087300             MOVE 'Y400-CLOSE-CLASS-CSR'   TO AA-PARAGRAPH-NAME   08730099
087400             MOVE 'CLOSE CURSOR - TRECEIV' TO AA-DB2-OPERATION    08740099
087500             MOVE 'TPURITM'                TO AA-DB2-TABLE-1      08750099
087600             MOVE 'TRECDIS'                TO AA-DB2-TABLE-2      08760099
087700             MOVE 'TRECITM'                TO AA-DB2-TABLE-3      08770099
087800             PERFORM Z900-DB2-ERROR-ROUTINE                       08780099
087900     END-EVALUATE.                                                08790099
088000 EJECT                                                            08800099
088100                                                                  08810099
088200*--------------------------------------------------------------*  08820099
088300*     DB2 ERROR ROUTINE                                        *  08830099
088400*--------------------------------------------------------------*  08840099
088500 Z900-DB2-ERROR-ROUTINE.                                          08850099
088600                                                                  08860099
088700     DISPLAY AA-DB2-ERROR-LIT.                                    08870099
088800     DISPLAY AA-PROGRAM-LIT.                                      08880099
088900     DISPLAY AA-PARAGRAPH-LIT.                                    08890099
089000     DISPLAY AA-DB2-OPERATION-LIT.                                08900099
089100     DISPLAY AA-DB2-TABLE-1.                                      08910099
089200     DISPLAY AA-DB2-TABLE-2.                                      08920099
089300     DISPLAY AA-DB2-TABLE-3.                                      08930099
089400     SET WS150-ERRORS-FOUND TO TRUE.                              08940099
089500                                                                  08950099
089600     COPY DPPD004.                                                08960099
089700 EJECT                                                            08970099
089800                                                                  08980099
089900*---------------------------------------------------------------  08990099
090000*     ERROR ROUTINE                                               09000099
090100*---------------------------------------------------------------  09010099
090200 Z901-ERROR-ROUTINE.                                              09020099
090300                                                                  09030099
090400     DISPLAY AA-PROGRAM-LIT.                                      09040099
090500     DISPLAY AA-PARAGRAPH-LIT.                                    09050099
090600     DISPLAY AA-MESSAGE-LINE.                                     09060099
090700     SET WS150-ERRORS-FOUND TO TRUE.                              09070099
090800 EJECT                                                            09080099
