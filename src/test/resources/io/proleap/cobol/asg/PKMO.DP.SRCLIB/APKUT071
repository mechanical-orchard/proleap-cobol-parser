000100 IDENTIFICATION DIVISION.                                         00010045
000200 PROGRAM-ID.     APKUT071.                                        00020045
000300 AUTHOR.         R BERNOSKI.                                      00030045
000400*DATE-WRITTEN.   JUNE 12, 1998.                                   00040045
000500*DATE-COMPILED.                                                   00050045
000600*************************************************************     00060045
000700*    COBOL 2 WITH SQL                                       *     00070045
000800*                                                           *     00080069
000900*    EXTRACT IMPORT INVOICES ENTERED DURING CURRENT WEEK    *     00090045
001000*                                                           *     00100069
001100*  THE PURPOSE OF THIS PROGRAM IS TO SELECT ALL MERCHANDISE *     00110069
001200*  INVOICES                                                 *     00120069
001300*                                                           *     00130069
001400*                                                           *     00140069
001500*************************************************************     00150045
001600*                                                           *     00160045
001700* INPUT:                                                    *     00170045
001800* 1.  INVOICE TABLE                   (TINVOIC)             *     00180061
001900* 2.  AP ACCOUNT TYPE                 (TACCTYP)             *     00190061
002000* 3.  AP MERCHANDISE INVOICE TABLE    (TMDINVC)             *     00200061
002100* 4.  AP CONTROL TABLE                (TAPCNTL)             *     00210061
002200* 5.  AP ALLOWANCE/CHARGE TABLE       (TALCHRG)             *     00220062
002300*                                                           *     00230045
002400* OUTPUT:                                                   *     00240045
002500* 1.  MERCHANDISE INVOICE ACCOUNT ACTIVITY FILE (APRD069)   *     00250045
002600*     PKMO.AP.APRD069.MIACTVTY.EXTRACT                      *     00260045
002700*************************************************************     00270045
002800* CHANGE LOG:                                               *     00280045
002900*                                                           *     00290045
003000* 06/12/98    INITIAL VERSION.                              *     00300045
003100*                                                           *     00310045
003200* 08/26/1999  JILL JUEL                                     *     00320056
003300*    REMOVE UNION FROM CURSOR TO PREVENT PREPAID ACCOUNT    *     00330045
003400*    FROM BEING DUPLICATED.                                 *     00340045
003500*                                                           *     00350057
003600* 06/17/2002                                                *     00360057
003700*    ARK PO PROJECT PHASE 1.  RECOMPILE FROM PRODUCTION.    *     00370057
003800* MADE BY: KEVIN CATLIN                    WR# 23500        *     00380057
003900*                                                           *     00390057
004000* 06/20/2002                                                *     00400060
004100*    ARK PO PROJECT PHASE 1.  REMOVE ALL REFERENCES TO      *     00410058
004200*    TABLE TPAYREQ.                                         *     00420058
004300* MADE BY: KEVIN CATLIN                    WR# 23500        *     00430058
004400*                                                           *     00440058
004500* 08/08/2002                                                *     00450072
004600*    COLBY HANGER EXPENSE PROCESSING.  BACK CHARGES OUT FOR *     00460066
004700*    INVOICE TO OBTAIN NET COST.  ADDED ALW_CHRG_CSR AND    *     00470066
004800*    MODIFIED PROCESSING IN PARAGRAPH B200.                 *     00480066
004900* MADE BY: KEVIN CATLIN                    WR# 23500        *     00490066
005000*                                                           *     00500066
005100* 08/29/2002                                                *     00510076
005200*    ARK PO PHASE 2.  REPLACE PAYT-REQ-SEQ-NBR WITH PO-NBR  *     00520074
005300*    INVC-ID IN THE WHERE CONDITION OF ALW_CHRG_CSR.  ALSO  *     00530074
005400*    PAYT-REQ-SEQ-NBR FROM THE INVOICE_CSR.                 *     00540074
005500* MADE BY: MIKE BESKE                      WR# 23500        *     00550074
005600*                                                           *     00560074
005700* 11/04/2002                                                *     00570077
005800*    COLBY DATING PROJECT.  ADDED INVC_DTE TO INVOICE_CSR.  *     00580076
005900*    ALSO ADDED EFFECTIVE DATING TO THE INVOICE_CSR AND     *     00590076
006000*    ALW_CHRG_CSR.                                          *     00600076
006100* MADE BY: MIKE BESKE                      WR# 23750        *     00610076
006200*                                                           *     00620076
005700* 03/11/2007                                                *     00621078
005800*    MBDC PROJECT. RECOMPILE                                *     00622078
006100* MADE BY: GREG WISIALOWSKI                WR# 21578        *     00625078
006200*                                                           *     00626078
006300*************************************************************     00630074
006400                                                                  00640074
006500 ENVIRONMENT DIVISION.                                            00650074
006600                                                                  00660074
006700 INPUT-OUTPUT SECTION.                                            00670074
006800                                                                  00680074
006900 FILE-CONTROL.                                                    00690074
007000                                                                  00700074
007100     SELECT EXTRACT-INV-OUT-FILE                                  00710074
007200         ASSIGN         TO UT-S-OUT01.                            00720074
007300                                                                  00730074
007400 DATA DIVISION.                                                   00740074
007500                                                                  00750074
007600 FILE SECTION.                                                    00760074
007700                                                                  00770074
007800 FD  EXTRACT-INV-OUT-FILE                                         00780074
007900         LABEL RECORDS  ARE STANDARD                              00790074
008000         RECORDING MODE IS  F                                     00800074
008100         DATA RECORD    IS  EXTRACT-INV-OUT-REC.                  00810074
008200                                                                  00820074
008300 01  EXTRACT-INV-OUT-REC         PIC X(75).                       00830074
008400                                                                  00840074
008500/                                                                 00850074
008600 WORKING-STORAGE SECTION.                                         00860074
008700                                                                  00870074
008800 01  FILLER                      PIC X(25)  VALUE                 00880074
008900                             'WS FOR APKUT071 BEGINS==>'.         00890074
009000 01  WS-RETRY-COUNTER            PIC S9(4)    COMP VALUE ZERO.    00900074
009100 01  WS-RETRY-MAX                PIC S9(4)    COMP VALUE 3.       00910074
009200                                                                  00920074
009300 01  WS-PROGRAM-COUNTERS.                                         00930074
009400     05  WS-APOUT-REC-CNT        PIC S9(09)   VALUE ZEROS.        00940074
009500     05  WS-ROWS-FETCHED         PIC  9(06)   VALUE ZEROS.        00950074
009600     05  WS-RECORDS-WRITTEN      PIC  9(06)   VALUE ZEROES.       00960074
009700                                                                  00970074
009800 01  PS-PROGRAM-SWITCHES.                                         00980074
009900     05  PS-END-ALW-CHRG-SW      PIC X        VALUE ' '.          00990074
010000         88  PS-END-ALW-CHRG                  VALUE 'Y'.          01000074
010100         88  PS-MORE-ALW-CHRG                 VALUE ' '.          01010074
010200     05  WS-INVC-CSR-END-SW      PIC X        VALUE 'N'.          01020074
010300         88  WS-END-OF-INVC-CSR               VALUE 'Y'.          01030074
010400         88  WS-NOT-END-OF-INVC-CSR           VALUE 'N'.          01040074
010500                                                                  01050074
010600 01  PV-PROGRAM-VARIABLES.                                        01060074
010700     05  PV-CURRENT-PARAGRAPH    PIC  X(35).                      01070074
010800     05  PV-COST-CHRG-AMT        PIC S9(08)V99 VALUE ZEROS        01080074
010900                                               COMP-3.            01090074
011000     05  PV-ALW-CHRG-AMT         PIC S9(8)V99  VALUE ZEROES       01100074
011100                                               COMP-3.            01110074
011200     05  PV-NET-COST-AMT         PIC S9(8)V99  VALUE ZEROES       01120074
011300                                               COMP-3.            01130074
011400     05  PV-GL-ACCT-NBR          PIC  X(07)    VALUE SPACES.      01140074
011500*                                                                 01150074
011600     COPY DPWS004.                                                01160074
011700*                                                                 01170074
011800     COPY APRD069.                                                01180074
011900*                                                                 01190074
012000 01  FILLER                      PIC X(35)    VALUE               01200074
012100     'END OF AP WORK RECORD AREA       **'.                       01210074
012200*                                                                 01220074
012300 01  WS-ABEND-FIELDS.                                             01230074
012400     05  WS-ABEND-PROGRAM        PIC X(8)     VALUE 'APKUT071'.   01240074
012500     05  WS-ABEND-PARAGRAPH      PIC X(50)    VALUE SPACES.       01250074
012600     05  WS-ABEND-OPERATION      PIC X(50)    VALUE SPACES.       01260074
012700     05  WS-ABEND-STRUCTURE-1    PIC X(8)     VALUE SPACES.       01270074
012800     05  WS-ABEND-STRUCTURE-2    PIC X(8)     VALUE SPACES.       01280074
012900     05  WS-ABEND-STRUCTURE-3    PIC X(8)     VALUE SPACES.       01290074
013000     05  WS-ABEND-STRUCTURE-4    PIC X(8)     VALUE SPACES.       01300074
013100     05  WS-ABEND-STATUS         PIC XX       VALUE SPACES.       01310074
013200*                                                                 01320074
013300 01  ABEND-CODE                  PIC S9(4)    COMP SYNC           01330074
013400                                              VALUE ZEROS.        01340074
013500     88 AP-TABLE-FULL                         VALUE +4004.        01350074
013600     88 AP-EMPTY-FILE                         VALUE +4005.        01360074
013700     88 AP-DB2-ERROR                          VALUE +4013.        01370074
013800*                                                                 01380074
013900******************************************************************01390074
014000*  COMMUNICATIONS AREA2 FOR DB2                                  *01400074
014100******************************************************************01410074
014200     COPY SQLCA2.                                                 01420074
014300                                                                  01430074
014400     EXEC SQL                                                     01440074
014500          INCLUDE SQLCA                                           01450074
014600     END-EXEC.                                                    01460074
014700******************************************************************01470074
014800*  TINVOIC DCLGEN                                                *01480074
014900******************************************************************01490074
015000     EXEC SQL                                                     01500074
015100          INCLUDE TINVOIC                                         01510074
015200     END-EXEC.                                                    01520074
015300                                                                  01530074
015400******************************************************************01540074
015500*  TAPCNTL DCLGEN                                                *01550074
015600******************************************************************01560074
015700     EXEC SQL                                                     01570074
015800          INCLUDE TAPCNTL                                         01580074
015900     END-EXEC.                                                    01590074
016000                                                                  01600074
016100******************************************************************01610074
016200*  TACCTYP DCLGEN                                                *01620074
016300******************************************************************01630074
016400     EXEC SQL                                                     01640074
016500          INCLUDE TACCTYP                                         01650074
016600     END-EXEC.                                                    01660074
016700                                                                  01670074
016800******************************************************************01680074
016900*  TMDINVC DCLGEN                                                *01690074
017000******************************************************************01700074
017100     EXEC SQL                                                     01710074
017200          INCLUDE TMDINVC                                         01720074
017300     END-EXEC.                                                    01730074
017400                                                                  01740074
017500******************************************************************01750074
017600*  TALCHRG DCLGEN                                                *01760074
017700******************************************************************01770074
017800     EXEC SQL                                                     01780074
017900          INCLUDE TALCHRG                                         01790074
018000     END-EXEC.                                                    01800074
018100                                                                  01810074
018200******************************************************************01820074
018300     EXEC SQL                                                     01830074
018400          DECLARE INVOICE_CSR CURSOR FOR                          01840074
018500           SELECT                                                 01850074
018600                  A.PO_NBR                                        01860074
018700                , A.GRO_COST_AMT                                  01870074
018800                , A.INVC_NET_COST_AMT                             01880074
018900                , A.INVC_ID                                       01890074
019000                , A.INVC_DTE                                      01900076
019100                , A.STATUS_CDE                                    01910074
019200                , C.GL_ACCT_NBR                                   01920074
019300             FROM                                                 01930074
019400                  TINVOIC A                                       01940074
019500                , TMDINVC B                                       01950074
019600                , TACCTYP C                                       01960074
019700            WHERE                                                 01970074
019800                   A.PO_NBR             = B.PO_NBR                01980074
019900              AND  A.INVC_ID            = B.INVC_ID               01990074
020000              AND  B.IMPRT_CHRG_PRC_CDE = C.ALW_CHRG_CDE          02000074
020100              AND  A.CRE_DTE            > :APCNTL-PREV-WK-END-DTE 02010074
020200              AND  A.INVC_DTE     BETWEEN C.EFF_STRT_DTE          02020076
020300                                      AND C.EFF_END_DTE           02030076
020400              AND  A.STATUS_CDE     NOT IN ('DE')                 02040074
020500              AND  A.INVC_TYP_CDE       = 'MI'                    02050074
020600     END-EXEC.                                                    02060074
020700****                                                              02070074
020800*---------------------------------------------------------------- 02080074
020900* ALW_CHRG_CSR RETRIEVES ALL CHARGES FOR COLBY MERCHANDISE        02090074
021000* INVOICES                                                        02100074
021100*---------------------------------------------------------------- 02110074
021200     EXEC SQL                                                     02120074
021300       DECLARE ALW_CHRG_CSR CURSOR FOR                            02130074
021400          SELECT AC.ALW_CHRG_AMT                                  02140074
021500                ,AT.GL_ACCT_NBR                                   02150074
021600            FROM TALCHRG AC                                       02160074
021700                ,TACCTYP AT                                       02170074
021800            WHERE AC.PO_NBR           = :INVOIC-PO-NBR            02180074
021900              AND AC.INVC_ID          = :INVOIC-INVC-ID           02190074
022000              AND AC.ALW_CHRG_CDE     =  AT.ALW_CHRG_CDE          02200074
022100              AND AC.ALW_CHRG_TYP_CDE = 'C'                       02210074
022200              AND AT.STAT_CDE         = 'A'                       02220074
022300              AND AT.INCL_IN_ALC_IND  = 'Y'                       02230074
022400              AND :INVOIC-INVC-DTE BETWEEN AT.EFF_STRT_DTE        02240076
022500                                       AND AT.EFF_END_DTE         02250076
022600     END-EXEC.                                                    02260074
022700                                                                  02270074
022800 01  FILLER                        PIC X(25) VALUE                02280074
022900          '<====WS FOR APKUT071 ENDS'.                            02290074
023000                                                                  02300074
023100*LINKAGE SECTION.                                                 02310074
023200                                                                  02320074
023300                                                                  02330074
023400 PROCEDURE DIVISION.                                              02340074
023500                                                                  02350074
023600***************************************************************** 02360074
023700*    MAIN DRIVER FOR PROGRAM                                    * 02370074
023800***************************************************************** 02380074
023900 A100-MAINLINE.                                                   02390074
024000                                                                  02400074
024100     DISPLAY ' '.                                                 02410074
024200     DISPLAY '*****************  APKUT071  *******************'.  02420074
024300                                                                  02430074
024400     PERFORM B100-INITIALIZATION.                                 02440074
024500                                                                  02450074
024600     PERFORM B200-CREATE-EXTRACT-RECORDS                          02460074
024700             UNTIL WS-END-OF-INVC-CSR.                            02470074
024800                                                                  02480074
024900     PERFORM B300-END-OF-JOB.                                     02490074
025000                                                                  02500074
025100     GOBACK.                                                      02510074
025200        EJECT                                                     02520074
025300                                                                  02530074
025400***************************************************************** 02540074
025500*    INITIALIZE TABLES AND RETRIEVE PREV_WK_END_DTE FROM THE    * 02550074
025600*    TAPCNTL TABLE.                                             * 02560074
025700***************************************************************** 02570074
025800 B100-INITIALIZATION.                                             02580074
025900                                                                  02590074
026000     OPEN  OUTPUT  EXTRACT-INV-OUT-FILE.                          02600074
026100                                                                  02610074
026200     INITIALIZE DCLTINVOIC                                        02620074
026300                DCLTAPCNTL                                        02630074
026400                DCLTACCTYP                                        02640074
026500                DCLTALCHRG                                        02650074
026600                DCLTMDINVC.                                       02660074
026700                                                                  02670074
026800     EXEC SQL                                                     02680074
026900         SELECT  PREV_WK_END_DTE                                  02690074
027000                ,CURR_WK_END_DTE                                  02700074
027100         INTO    :APCNTL-PREV-WK-END-DTE                          02710074
027200                ,:APCNTL-CURR-WK-END-DTE                          02720074
027300         FROM   TAPCNTL                                           02730074
027400     END-EXEC.                                                    02740074
027500                                                                  02750074
027600     PERFORM X100-OPEN-CURSOR.                                    02760074
027700                                                                  02770074
027800     PERFORM R100-FETCH-INVOICE.                                  02780074
027900                                                                  02790074
028000     IF   WS-END-OF-INVC-CSR                                      02800074
028100          DISPLAY '**********************************'            02810074
028200          DISPLAY '*   EMPTY INVOICE TABLE          *'            02820074
028300          DISPLAY '*   PROGRAM ** = APKUT071        *'            02830074
028400          DISPLAY '**********************************'            02840074
028500     END-IF.                                                      02850074
028600                                                                  02860074
028700                                                                  02870074
028800***************************************************************** 02880074
028900*              FORMAT INVOICES TO OUTPUT LAYOUT                 * 02890074
029000***************************************************************** 02900074
029100 B200-CREATE-EXTRACT-RECORDS.                                     02910074
029200                                                                  02920074
029300     MOVE INVOIC-PO-NBR              TO AP069-PO-NBR.             02930074
029400     MOVE INVOIC-INVC-ID             TO AP069-INVOICE-ID.         02940074
029500     MOVE INVOIC-STATUS-CDE          TO AP069-INVOICE-STATUS.     02950074
029600     MOVE APCNTL-CURR-WK-END-DTE     TO AP069-PERD-END-DTE.       02960074
029700                                                                  02970074
029800     PERFORM X200-OPEN-CHRG-CODE-CSR.                             02980074
029900     INITIALIZE PV-ALW-CHRG-AMT                                   02990074
030000                PV-NET-COST-AMT.                                  03000074
030100     SET PS-MORE-ALW-CHRG TO TRUE.                                03010074
030200     PERFORM R200-FETCH-ALW-CHRG.                                 03020074
030300     PERFORM UNTIL PS-END-ALW-CHRG                                03030074
030400        ADD  ALCHRG-ALW-CHRG-AMT     TO PV-ALW-CHRG-AMT           03040074
030500        MOVE ALCHRG-ALW-CHRG-AMT     TO AP069-GROSS-COST-AMT      03050074
030600                                        AP069-NET-COST-AMT        03060074
030700        MOVE PV-GL-ACCT-NBR          TO AP069-GL-ACCT-NBR         03070074
030800        PERFORM W100-WRITE-OUTPUT                                 03080074
030900        PERFORM R200-FETCH-ALW-CHRG                               03090074
031000     END-PERFORM.                                                 03100074
031100     PERFORM Y200-CLOSE-CHRG-CODE-CSR.                            03110074
031200                                                                  03120074
031300     MOVE PV-COST-CHRG-AMT           TO AP069-GROSS-COST-AMT.     03130074
031400     COMPUTE PV-NET-COST-AMT =                                    03140074
031500                INVOIC-INVC-NET-COST-AMT - PV-ALW-CHRG-AMT.       03150074
031600     MOVE PV-NET-COST-AMT            TO AP069-NET-COST-AMT.       03160074
031700     MOVE ACCTYP-GL-ACCT-NBR         TO AP069-GL-ACCT-NBR.        03170074
031800                                                                  03180074
031900     PERFORM W100-WRITE-OUTPUT.                                   03190074
032000     PERFORM R100-FETCH-INVOICE.                                  03200074
032100                                                                  03210074
032200***************************************************************** 03220074
032300*     FINISH THE PROCESS, REPORT ON NECESSARY TOTALS,           * 03230074
032400*     AND CLOSE ALL FILES                                       * 03240074
032500***************************************************************** 03250074
032600 B300-END-OF-JOB.                                                 03260074
032700                                                                  03270074
032800     DISPLAY '*********************************************'      03280074
032900     DISPLAY 'PROGRAM NAME = APKUT071'                            03290074
033000     DISPLAY 'PREV_WK_END_DTE = ' APCNTL-PREV-WK-END-DTE          03300074
033100     DISPLAY 'ROWS FETCHED = ' WS-ROWS-FETCHED                    03310074
033200     DISPLAY 'RECORDS WRITTEN = ' WS-RECORDS-WRITTEN              03320074
033300     DISPLAY '*********************************************'      03330074
033400                                                                  03340074
033500     PERFORM Y100-CLOSE-CURSOR                                    03350074
033600     CLOSE EXTRACT-INV-OUT-FILE.                                  03360074
033700                                                                  03370074
033800                                                                  03380074
033900***************************************************************** 03390074
034000*    FETCH THE INVOICE CURSOR                                   * 03400074
034100***************************************************************** 03410074
034200 R100-FETCH-INVOICE.                                              03420074
034300                                                                  03430074
034400     PERFORM WITH TEST AFTER                                      03440074
034500        VARYING WS-RETRY-COUNTER FROM 1 BY 1                      03450074
034600        UNTIL   WS-RETRY-COUNTER > WS-RETRY-MAX OR                03460074
034700                SQLCODE = ZERO OR                                 03470074
034800                SQLCODE = +100                                    03480074
034900                                                                  03490074
035000        EXEC SQL                                                  03500074
035100            FETCH INVOICE_CSR                                     03510074
035200            INTO :INVOIC-PO-NBR                                   03520074
035300               , :PV-COST-CHRG-AMT                                03530074
035400               , :INVOIC-INVC-NET-COST-AMT                        03540074
035500               , :INVOIC-INVC-ID                                  03550074
035600               , :INVOIC-INVC-DTE                                 03560076
035700               , :INVOIC-STATUS-CDE                               03570076
035800               , :ACCTYP-GL-ACCT-NBR                              03580076
035900        END-EXEC                                                  03590076
036000                                                                  03600076
036100        EVALUATE TRUE                                             03610076
036200            WHEN SQLCODE = ZERO                                   03620076
036300                 ADD 1 TO WS-ROWS-FETCHED                         03630076
036400            WHEN SQLCODE = +100                                   03640076
036500                 SET WS-END-OF-INVC-CSR TO TRUE                   03650076
036600            WHEN SQLCODE = -904                                   03660076
036700            WHEN SQLCODE = -913                                   03670076
036800              CONTINUE                                            03680076
036900            WHEN SQLWARN0 NOT = SPACES                            03690076
037000            WHEN SQLCODE  NOT = ZERO                              03700076
037100              MOVE 'R100-FETCH-INVOICE             '              03710076
037200                            TO WS-ABEND-PARAGRAPH                 03720076
037300              MOVE 'UNSUCCESSFUL FETCH  INVOIC'                   03730076
037400                            TO WS-ABEND-OPERATION                 03740076
037500              MOVE 'TINVOIC ' TO WS-ABEND-STRUCTURE-1             03750076
037600              MOVE 'TMDINVC ' TO WS-ABEND-STRUCTURE-2             03760076
037700              MOVE 'TACCTYP ' TO WS-ABEND-STRUCTURE-3             03770076
037800              MOVE SPACES     TO WS-ABEND-STRUCTURE-4             03780076
037900              PERFORM Z999-SQL-ERROR                              03790076
038000           END-EVALUATE                                           03800076
038100     END-PERFORM.                                                 03810076
038200                                                                  03820076
038300     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           03830076
038400         MOVE 'R100-FETCH-INVOICE             '                   03840076
038500                       TO WS-ABEND-PARAGRAPH                      03850076
038600         MOVE 'MAX RETRIES EXCEEDED ON FETCH  INVOIC'             03860076
038700                         TO WS-ABEND-OPERATION                    03870076
038800         PERFORM Z999-SQL-ERROR                                   03880076
038900     END-IF.                                                      03890076
039000                                                                  03900076
039100*---------------------------------------------------------------- 03910076
039200*    RETRIEVES THE CHARGES AND CORRESPONDING ACCOUNT NUMBERS      03920076
039300*    FROM THE TALCHRG AND TACCTYP TABLES.                         03930076
039400*---------------------------------------------------------------- 03940076
039500 R200-FETCH-ALW-CHRG.                                             03950076
039600                                                                  03960076
039700     MOVE 'R200-FETCH-ALW-CHRG' TO PV-CURRENT-PARAGRAPH.          03970076
039800                                                                  03980076
039900     PERFORM WITH TEST AFTER                                      03990076
040000        VARYING WS-RETRY-COUNTER FROM 1 BY 1                      04000076
040100        UNTIL   WS-RETRY-COUNTER > WS-RETRY-MAX OR                04010076
040200                SQLCODE = ZERO OR                                 04020076
040300                SQLCODE = +100                                    04030076
040400                                                                  04040076
040500        EXEC SQL                                                  04050076
040600            FETCH ALW_CHRG_CSR                                    04060076
040700             INTO :ALCHRG-ALW-CHRG-AMT                            04070076
040800                , :PV-GL-ACCT-NBR                                 04080076
040900        END-EXEC                                                  04090076
041000                                                                  04100076
041100        EVALUATE TRUE                                             04110076
041200            WHEN SQLCODE = ZERO                                   04120076
041300                 CONTINUE                                         04130076
041400            WHEN SQLCODE = +100                                   04140076
041500                 SET PS-END-ALW-CHRG TO TRUE                      04150076
041600            WHEN SQLWARN0 NOT = SPACES                            04160076
041700            WHEN SQLCODE  NOT = ZERO                              04170076
041800                 MOVE PV-CURRENT-PARAGRAPH                        04180076
041900                                     TO WS-ABEND-PARAGRAPH        04190076
042000                 MOVE                                             04200076
042100                   'UNSUCCESSFUL FETCH WITH ALW_CHRG_CSR'         04210076
042200                                     TO WS-ABEND-OPERATION        04220076
042300                 MOVE 'TALCHRG'      TO WS-ABEND-STRUCTURE-1      04230076
042400                 MOVE 'TACCTYP'      TO WS-ABEND-STRUCTURE-2      04240076
042500                 MOVE SPACES         TO WS-ABEND-STRUCTURE-3      04250076
042600                                        WS-ABEND-STRUCTURE-4      04260076
042700                 PERFORM Z999-SQL-ERROR                           04270076
042800        END-EVALUATE                                              04280076
042900     END-PERFORM.                                                 04290076
043000                                                                  04300076
043100     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           04310076
043200         MOVE PV-CURRENT-PARAGRAPH                                04320076
043300                       TO WS-ABEND-PARAGRAPH                      04330076
043400         MOVE 'MAX RETRIES EXCEEDED ON FETCH'                     04340076
043500                       TO WS-ABEND-OPERATION                      04350076
043600         PERFORM Z999-SQL-ERROR                                   04360076
043700     END-IF.                                                      04370076
043800                                                                  04380076
043900***************************************************************** 04390076
044000*    WRITE OUTPUT RECORD                                        * 04400076
044100***************************************************************** 04410076
044200 W100-WRITE-OUTPUT.                                               04420076
044300                                                                  04430076
044400     WRITE EXTRACT-INV-OUT-REC    FROM AP069-INVOICE-EXTRACT.     04440076
044500                                                                  04450076
044600     ADD 1 TO WS-RECORDS-WRITTEN.                                 04460076
044700                                                                  04470076
044800***************************************************************** 04480076
044900*    OPEN THE INVOICE CURSOR                                    * 04490076
045000***************************************************************** 04500076
045100 X100-OPEN-CURSOR.                                                04510076
045200                                                                  04520076
045300     PERFORM WITH TEST AFTER                                      04530076
045400        VARYING WS-RETRY-COUNTER FROM 1 BY 1                      04540076
045500          UNTIL WS-RETRY-COUNTER > WS-RETRY-MAX                   04550076
045600                OR SQLCODE = ZERO                                 04560076
045700                                                                  04570076
045800             EXEC SQL                                             04580076
045900                OPEN INVOICE_CSR                                  04590076
046000             END-EXEC                                             04600076
046100                                                                  04610076
046200          EVALUATE TRUE                                           04620076
046300                 WHEN SQLCODE = ZERO                              04630076
046400                 WHEN SQLCODE = -904                              04640076
046500                 WHEN SQLCODE = -913                              04650076
046600                      CONTINUE                                    04660076
046700                                                                  04670076
046800                 WHEN SQLWARN0 NOT = SPACES                       04680076
046900                 WHEN SQLCODE  NOT = ZERO                         04690076
047000                      MOVE 'X100-OPEN-CURSOR             '        04700076
047100                                    TO WS-ABEND-PARAGRAPH         04710076
047200                      MOVE 'UNSUCCESSFUL OPEN   INVOIC'           04720076
047300                                    TO WS-ABEND-OPERATION         04730076
047400                      MOVE 'TINVOIC ' TO WS-ABEND-STRUCTURE-1     04740076
047500                      MOVE 'TMDINVC ' TO WS-ABEND-STRUCTURE-2     04750076
047600                      MOVE 'TACCTYP ' TO WS-ABEND-STRUCTURE-3     04760076
047700                      MOVE SPACES     TO WS-ABEND-STRUCTURE-4     04770076
047800                      PERFORM Z999-SQL-ERROR                      04780076
047900             END-EVALUATE                                         04790076
048000     END-PERFORM.                                                 04800076
048100                                                                  04810076
048200     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           04820076
048300         MOVE 'X100-OPEN-CURSOR             '                     04830076
048400                       TO WS-ABEND-PARAGRAPH                      04840076
048500         MOVE 'MAX RETRIES EXCEEDED ON OPEN   INVOIC'             04850076
048600                         TO WS-ABEND-OPERATION                    04860076
048700         PERFORM Z999-SQL-ERROR                                   04870076
048800     END-IF.                                                      04880076
048900                                                                  04890076
049000*---------------------------------------------------------------- 04900076
049100*    OPENS THE CHARGE CODE CURSOR.                                04910076
049200*---------------------------------------------------------------- 04920076
049300 X200-OPEN-CHRG-CODE-CSR.                                         04930076
049400                                                                  04940076
049500     MOVE 'X200-OPEN-CHRG-CODE-CSR' TO PV-CURRENT-PARAGRAPH.      04950076
049600                                                                  04960076
049700     PERFORM WITH TEST AFTER                                      04970076
049800        VARYING WS-RETRY-COUNTER FROM 1 BY 1                      04980076
049900        UNTIL   WS-RETRY-COUNTER > WS-RETRY-MAX                   04990076
050000                OR SQLCODE = ZERO                                 05000076
050100                                                                  05010076
050200        EXEC SQL                                                  05020076
050300            OPEN ALW_CHRG_CSR                                     05030076
050400        END-EXEC                                                  05040076
050500                                                                  05050076
050600        EVALUATE TRUE                                             05060076
050700            WHEN SQLCODE = ZERO                                   05070076
050800                 CONTINUE                                         05080076
050900            WHEN SQLWARN0 NOT = SPACES                            05090076
051000            WHEN SQLCODE  NOT = ZERO                              05100076
051100                 MOVE PV-CURRENT-PARAGRAPH                        05110076
051200                                  TO WS-ABEND-PARAGRAPH           05120076
051300                 MOVE 'UNSUCCESSFUL OPEN ON ALW_CHRG_CSR'         05130076
051400                                  TO WS-ABEND-OPERATION           05140076
051500                 MOVE 'TALCHRG'   TO WS-ABEND-STRUCTURE-1         05150076
051600                 MOVE 'TACCTYP'   TO WS-ABEND-STRUCTURE-2         05160076
051700                 MOVE SPACES      TO WS-ABEND-STRUCTURE-3         05170076
051800                                     WS-ABEND-STRUCTURE-4         05180076
051900                 PERFORM Z999-SQL-ERROR                           05190076
052000        END-EVALUATE                                              05200076
052100     END-PERFORM.                                                 05210076
052200                                                                  05220076
052300     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           05230076
052400         MOVE PV-CURRENT-PARAGRAPH                                05240076
052500                       TO WS-ABEND-PARAGRAPH                      05250076
052600         MOVE 'MAX RETRIES EXCEEDED ON OPEN'                      05260076
052700                         TO WS-ABEND-OPERATION                    05270076
052800         PERFORM Z999-SQL-ERROR                                   05280076
052900     END-IF.                                                      05290076
053000                                                                  05300076
053100                                                                  05310076
053200***************************************************************** 05320076
053300*    CLOSE THE INVOICE CURSOR                                   * 05330076
053400***************************************************************** 05340076
053500 Y100-CLOSE-CURSOR.                                               05350076
053600                                                                  05360076
053700     PERFORM WITH TEST AFTER                                      05370076
053800             VARYING WS-RETRY-COUNTER FROM 1 BY 1                 05380076
053900             UNTIL   WS-RETRY-COUNTER > WS-RETRY-MAX OR           05390076
054000                     SQLCODE = ZERO                               05400076
054100                                                                  05410076
054200             EXEC SQL                                             05420076
054300                CLOSE INVOICE_CSR                                 05430076
054400             END-EXEC                                             05440076
054500                                                                  05450076
054600             EVALUATE TRUE                                        05460076
054700                 WHEN SQLCODE = ZERO                              05470076
054800                 WHEN SQLCODE = -904                              05480076
054900                 WHEN SQLCODE = -913                              05490076
055000                      CONTINUE                                    05500076
055100                 WHEN SQLWARN0 NOT = SPACES                       05510076
055200                 WHEN SQLCODE  NOT = ZERO                         05520076
055300                      MOVE 'Y100-CLOSE-CURSOR             '       05530076
055400                                    TO WS-ABEND-PARAGRAPH         05540076
055500                      MOVE 'UNSUCCESSFUL CLOSE  INVOIC'           05550076
055600                                    TO WS-ABEND-OPERATION         05560076
055700                      MOVE 'TINVOIC ' TO WS-ABEND-STRUCTURE-1     05570076
055800                      MOVE 'TMDINVC ' TO WS-ABEND-STRUCTURE-2     05580076
055900                      MOVE 'TACCTYP ' TO WS-ABEND-STRUCTURE-3     05590076
056000                      MOVE SPACES     TO WS-ABEND-STRUCTURE-4     05600076
056100                      PERFORM Z999-SQL-ERROR                      05610076
056200             END-EVALUATE                                         05620076
056300     END-PERFORM.                                                 05630076
056400                                                                  05640076
056500     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           05650076
056600         MOVE 'Y100-CLOSE-CURSOR             '                    05660076
056700                       TO WS-ABEND-PARAGRAPH                      05670076
056800         MOVE 'MAX RETRIES EXCEEDED ON CLOSE  INVOIC'             05680076
056900                         TO WS-ABEND-OPERATION                    05690076
057000         PERFORM Z999-SQL-ERROR                                   05700076
057100     END-IF.                                                      05710076
057200                                                                  05720076
057300*---------------------------------------------------------------- 05730076
057400*    CLOSES THE CHARGE CODE CURSOR.                               05740076
057500*---------------------------------------------------------------- 05750076
057600 Y200-CLOSE-CHRG-CODE-CSR.                                        05760076
057700                                                                  05770076
057800     MOVE 'Y200-CLOSE-CHRG-CODE-CSR' TO PV-CURRENT-PARAGRAPH.     05780076
057900                                                                  05790076
058000     PERFORM WITH TEST AFTER                                      05800076
058100        VARYING WS-RETRY-COUNTER FROM 1 BY 1                      05810076
058200        UNTIL   WS-RETRY-COUNTER > WS-RETRY-MAX                   05820076
058300                OR SQLCODE = ZERO                                 05830076
058400                                                                  05840076
058500        EXEC SQL                                                  05850076
058600            CLOSE ALW_CHRG_CSR                                    05860076
058700        END-EXEC                                                  05870076
058800                                                                  05880076
058900        EVALUATE TRUE                                             05890076
059000            WHEN SQLCODE = ZERO                                   05900076
059100                 CONTINUE                                         05910076
059200            WHEN SQLWARN0 NOT = SPACES                            05920076
059300            WHEN SQLCODE  NOT = ZERO                              05930076
059400                 MOVE PV-CURRENT-PARAGRAPH                        05940076
059500                                   TO WS-ABEND-PARAGRAPH          05950076
059600                 MOVE 'UNSUCCESSFUL CLOSE ON ALW_CHRG_CSR'        05960076
059700                                   TO WS-ABEND-OPERATION          05970076
059800                 MOVE 'TALCHRG'    TO WS-ABEND-STRUCTURE-1        05980076
059900                 MOVE 'TACCTYP'    TO WS-ABEND-STRUCTURE-2        05990076
060000                 MOVE SPACES       TO WS-ABEND-STRUCTURE-3        06000076
060100                                      WS-ABEND-STRUCTURE-4        06010076
060200                 PERFORM Z999-SQL-ERROR                           06020076
060300        END-EVALUATE                                              06030076
060400     END-PERFORM.                                                 06040076
060500                                                                  06050076
060600     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           06060076
060700         MOVE PV-CURRENT-PARAGRAPH                                06070076
060800                       TO WS-ABEND-PARAGRAPH                      06080076
060900         MOVE 'MAX RETRIES EXCEEDED ON OPEN'                      06090076
061000                         TO WS-ABEND-OPERATION                    06100076
061100         PERFORM Z999-SQL-ERROR                                   06110076
061200     END-IF.                                                      06120076
061300                                                                  06130076
061400***************************************************************** 06140076
061500*     PROCESS DB2 ABENDS                                        * 06150076
061600***************************************************************** 06160076
061700 Z999-SQL-ERROR.                                                  06170076
061800                                                                  06180076
061900     DISPLAY '*** DB2 ERROR '.                                    06190076
062000     DISPLAY '*** PROGRAM   = ' WS-ABEND-PROGRAM.                 06200076
062100     DISPLAY '*** PARAGRAPH = ' WS-ABEND-PARAGRAPH.               06210076
062200     DISPLAY '*** OPERATION = ' WS-ABEND-OPERATION.               06220076
062300     DISPLAY '*** TABLE 1   = ' WS-ABEND-STRUCTURE-1.             06230076
062400     IF WS-ABEND-STRUCTURE-2 > SPACES                             06240076
062500        DISPLAY '*** TABLE 2   = ' WS-ABEND-STRUCTURE-2           06250076
062600        IF WS-ABEND-STRUCTURE-3 > SPACES                          06260076
062700           DISPLAY '*** TABLE 3   = ' WS-ABEND-STRUCTURE-3        06270076
062800           IF WS-ABEND-STRUCTURE-4 > SPACES                       06280076
062900              DISPLAY '*** TABLE 4   = ' WS-ABEND-STRUCTURE-4     06290076
063000           END-IF                                                 06300076
063100        END-IF                                                    06310076
063200     END-IF                                                       06320076
063300                                                                  06330076
063400     SET AP-DB2-ERROR              TO TRUE.                       06340076
063500                                                                  06350076
063600     COPY DPPD004.                                                06360076
063700     CALL 'ILBOABN0' USING ABEND-CODE.                            06370076
063800                                                                  06380076
