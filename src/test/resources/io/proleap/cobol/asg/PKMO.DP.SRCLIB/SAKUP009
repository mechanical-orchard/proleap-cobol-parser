000100 IDENTIFICATION DIVISION.                                         00010000
000200                                                                  00020000
000300 PROGRAM-ID.      SAKUP009.                                       00030000
000400 AUTHOR.          STEVEN NOWAK.                                   00040000
000500 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00050000
000600 DATE-WRITTEN.    07/15/09.                                       00060000
000700 DATE-COMPILED.                                                   00070000
000800                                                                  00080000
000900******************************************************************00090000
001000*  MODULE TYPE:   COBOL2 DB2 BATCH                                00100000
001100*                                                                 00110000
001200*  DESCRIPTION: PROGRAM UPDATES THE BLUE MARTINI QUEUE WITH THE   00120000
001300*               DATA PULLED IN PROGRAM SAKUT054                   00130000
001400*                                                                 00140000
001500*========================== CHANGE LOG ===========================00150000
001600*  AUTH        BY           DATE    DESCRIPTION                   00160005
001700*=================================================================00170000
001800* WR36527     TKMA409     07-01-09  CREATE PROGRAM                00180005
002000******************************************************************00200000
002100* WR38972  TKMAD44  10-29-10   CHANGED ES-ESTORE-TABLE TO ALLOW   00210000
002200*                              UP TO 99 E-COMM STORES FOR MLOF    00220000
002300******************************************************************00230000
002400* I1896688 COGNIZANT10-28-11   AMENDE TO HANDLE RETURN A BRICK    00240000
002500*                              AND MORTOR STORE IS SHIPPED ON     00250000
002600*                              CURRENT DAY                        00260000
002700******************************************************************00270000
002800*          COGNIZANT01-17-12   REGISTERS FOR THE FULFILLMENT      00280000
002900*                              CENTERS ARE CHANGED FROM 80-89     00290000
003000*                              TO 1 - 4 AND 9 - 15.               00300000
003100*          COGNIZANT05-23-12   IN PARA Z2000-SQL-ABEND, REPLACED  00310000
003200*                              PERFORM Z9999-CONTROLS INSTEAD OF  00320000
003300*                              Z9000-EOJ-ROUTINE.                 00330000
003400******************************************************************00340000
003500*          COGNIZANT02-06-13   INCLUDED ATG QUEUE AND MODIFIED    00350000
003600*                              PROCESSING TO WRITE MESSAGE TO     00360000
003700*                              ATG IF ORDER NUMBER >= 650 MILLION 00370000
003800*                              OTHERWISE WRITE MESSAGE TO BM      00380000
003900*                              QUEUE.                             00390000
004000******************************************************************00400000
004100*  06/13/13  DAVE WELLER                                         *00410000
004200*  CHANGES RELATED TO SFS CHANGE TO TEPTRN                       *00420000
004300*  CHANGE MARKED C53632                                          *00430000
004400******************************************************************00440000
004500*  SEPTEMBER 2013  JAMES ALT                                     *00450000
004600*  CHANGES RELATED TO 9607 -- FLEXIBLE STORE HOURS 2013          *00460000
004700*  REMOVE ALL REFERENCES TO THE TEPIPSH AND TEPECXH TABLES.      *00470000
004800*  CHANGE REQUEST CHG0062728                                     *00480000
004900******************************************************************00490000
005000******************************************************************00500002
005100* INCIDENT:0451115                                                00510000
005200* ----------------                                                00520000
005300* CHANGE: VOID_ABRT_CDE AND TRN_STAT_CDE CONDITION CHECKS ARE     00530000
005400* REMOVED FROM THE PARA C2000.                                    00540000
005500* VOID_ABRT_CDE STATUS WOULD CHANGE FROM N TO V IF A NORMAL       00550000
005600* TRANS VOIDED WITIN FEW MINS OF TIME BEFORE THE JOB COMPLETION   00560000
005700* AND THAT CAUSES FAILED IN THE PARA C2000.                       00570000
005800* WHO: COGNIZANT                                DATE:2013-12-11   00580000
005900******************************************************************00590000
006000******************************************************************00600000
006100* INCIDENT:0465218                                                00610000
006200* ----------------                                                00620000
006300* CHANGE: SECONDS PARAMETER IS INCLUDED FOR THE STRT_TM CHECK IN  00630000
006400*         TEPECX.                                                 00640000
006500*         MORE THAN ONE ROW IS RETRIEVED FROM TEPECX TABLE WHEN   00650000
006600*         STRT_TM COLUMN IS CHECKED FOR THE SAME HOUR-MINUTE      00660000
006700*         COMBINATION FROM D5110 SECTION.                         00670000
006800*         SO, INCLUDED SECONDS ALONG WITH THIS TO ENSURE ONLY     00680000
006900*         ONE ROW IS SELECTED AT A GIVEN TIME.                    00690000
007000* WHO: COGNIZANT                                DATE:2013-12-19   00700000
007100******************************************************************00710000
007200* CHG0078352 TKMA953 03-31-14 CHANGED PROGRAM TO HANDLE 10 DIGIT  00720000
007300*                              ORDER NUMBERS FROM ATG.            00730000
007400*                                                                 00740000
007500*   CHANGE DATE: 01/05/15                                         00750000
007600*   BY: COGNIZANT                    WR/IR#:  CHG0105181          00760000
007700*   CHANGES: REMOVED ALL THE REFERENCE TO TEPORDH TABLE.          00770000
007800*                                                                 00780000
007900******************************************************************00790000
008000* CHG#: CHG0145120                                                00800000
008100* ----------------                                                00810000
008200* CHANGE: MODIFIED PROGRAM TO FETCH CORRECT ORIGINAL-PARTITION-   00820000
008300* NUMBER FOR ALL RETURN TRANSACTIONS.                             00830000
008400* REMOVED BLUE MARTINI QUEUE INPUT/OUTPUT COMPONENTS              00840000
008500* CHANGES ARE TAGGED WITH C45120                                  00850000
008600* WHO: COGNIZANT                                DATE:2016-09-15   00860000
008700******************************************************************00870000
008800* CHANGE #: CHG0160001                                            00880000
008900* --------------------                                            00890000
009000* SEND FEES TO ECOM FOR SALES TAX COMPLIANCE PROJECT              00900000
009100* INCLUDE FEE IN RECORD TOTALS - DO NOT ADD FEE FIELDS.           00910000
009200* WHO: JIM HUNTER                               DATE:2017-01-30   00920000
009300******************************************************************00930000
254716* CHANGE #: CHG0254716                                            00931004
254716* --------------------                                            00932004
254716* SEPHORA - ADD SEPHORA CREDIT CARD TENDER TYPE 22 TO LIST OF     00933004
254716*           CREDIT CARD TENDERS.                                  00933104
254716* AI - AI TEAM HAS REQUESTED THAT ALL REGISTERS BE PASSED TO      00934004
254716*      ECOM SO THAT THEY CAN PREVENT FRAUD WHERE CUSTOMERS ARE    00934104
254716*      CREDITED WHEN THEY CALL IN A RETURN AND THEN PHYSICALLY    00934204
254716*      RETURN THEIR ITEMS TO A STORE.  CURRENTLY, RETURNS         00934304
254716*      PERFORMED AT ECOM ARE ONLY PASSED BACK TO ECOM, IF THE     00934404
254716*      REGISTERS ARE 1 THRU 4 OR 9 THRU 15.                       00934604
254716* WHO: JIM HUNTER                               DATE:2021-03-12   00935004
254716******************************************************************00936004
260107* CHG0260107  JIM HUNTER  08-19-21  ADD COPYBOOK DPWS991 TO MAKE  00936208
260107*                                   THE CALL TO DPKUT901 DYNAMIC. 00936308
254716******************************************************************00936408
COBRND* CHANGE #: CHG0286246                                            00937009
COBRND* --------------------                                            00938006
COBRND* COBRAND - ADD COBRAND VISA CHARGE TENDER TYPE 24 TO LIST OF     00939006
COBRND*           CREDIT CARD TENDERS IN PARA'S D5300-DET-REFUND-TENDER 00939106
COBRND*           AND D5400-SLCT-CREDIT-CRD-INFO.                       00939206
COBRND* WHO: JIM HUNTER                               DATE:2023-03-03   00939806
COBRND******************************************************************00939906
PAYVEN* CHANGE #: CHG0287492                                            00940011
PAYVEN* --------------------                                            00940110
PAYVEN* PAYPAL & VENMO - ADDED PAYPAL TYPE 16 AND VENMO TYPE 17 TO THE  00940210
PAYVEN*         LIST OF CREDIT CARD TENDERS IN PARAGRAPHS               00940310
PAYVEN*         D5300-DET-REFUND-TENDER AND D5400-SLCT-CREDIT-CRD-INFO. 00940410
PAYVEN* WHO: BARB SCHULTZ                             DATE:2023-04-20   00940610
PAYVEN******************************************************************00940710
009400                                                                  00941010
009500 ENVIRONMENT DIVISION.                                            00950000
009600 CONFIGURATION SECTION.                                           00960000
009700                                                                  00970000
009800 SOURCE-COMPUTER.    IBM-3090.                                    00980000
009900 OBJECT-COMPUTER.    IBM-3090.                                    00990000
010000                                                                  01000000
010100 INPUT-OUTPUT SECTION.                                            01010000
010200 FILE-CONTROL.                                                    01020000
010300                                                                  01030000
010400     SELECT DATE-CARD-FILE  ASSIGN TO INP02.                      01040000
010500     SELECT CONTROL-CARD-3  ASSIGN TO INP03.                      01050000
010600     SELECT CONTROL-CARD-4  ASSIGN TO INP04.                      01060000
010700     SELECT CONTROL-CARD-5  ASSIGN TO INP05.                      01070000
010800                                                                  01080000
010900 DATA DIVISION.                                                   01090000
011000 FILE SECTION.                                                    01100000
011100                                                                  01110000
011200 FD  DATE-CARD-FILE                                               01120000
011300     RECORDING MODE IS F                                          01130000
011400     BLOCK CONTAINS 0 RECORDS                                     01140000
011500     LABEL RECORDS ARE STANDARD.                                  01150000
011600                                                                  01160000
011700 01  DATE-CARD-REC                    PIC  X(80).                 01170000
011800                                                                  01180000
011900 FD  CONTROL-CARD-3                                               01190000
012000     RECORDING MODE F                                             01200000
012100     BLOCK CONTAINS 0 RECORDS                                     01210000
012200     LABEL RECORDS ARE OMITTED.                                   01220000
012300                                                                  01230000
012400 01  CONTROL-CARD-3-LINE              PIC  X(80).                 01240000
012500                                                                  01250000
012600 FD  CONTROL-CARD-4                                               01260000
012700     RECORDING MODE F                                             01270000
012800     BLOCK CONTAINS 0 RECORDS                                     01280000
012900     LABEL RECORDS ARE OMITTED.                                   01290000
013000                                                                  01300000
013100 01  CONTROL-CARD-4-LINE              PIC  X(80).                 01310000
013200                                                                  01320000
013300 FD  CONTROL-CARD-5                                               01330000
013400     RECORDING MODE F                                             01340000
013500     BLOCK CONTAINS 0 RECORDS                                     01350000
013600     LABEL RECORDS ARE OMITTED.                                   01360000
013700                                                                  01370000
013800 01  CONTROL-CARD-5-LINE              PIC  X(80).                 01380000
013900                                                                  01390000
014000                                                                  01400000
014100***************************************************************** 01410000
014200*                       WORKING STORAGE                           01420000
014300***************************************************************** 01430000
014400 WORKING-STORAGE SECTION.                                         01440000
014500                                                                  01450000
014600 01  W-START                          PIC  X(40)                  01460000
014700     VALUE 'SAKUP009 - WORKING STORAGE BEGINS HERE'.              01470000
014800                                                                  01480000
014900                                                                  01490000
015000***************************************************************** 01500000
015100*                         SWITCHES                                01510000
015200***************************************************************** 01520000
015300 01  PROGRAM-SWITCHES.                                            01530000
015400     05  PS-RESTART-REQUIRED-SW       PIC  X(01)    VALUE 'N'.    01540000
015500         88  PS-RESTART-REQUIRED                    VALUE 'Y'.    01550000
015600         88  PS-RESTART-NOT-REQUIRED                VALUE 'N'.    01560000
015700                                                                  01570000
015800     05  PS-END-OF-CARD-FILE-SW       PIC  X(01)    VALUE 'N'.    01580000
015900         88  PS-END-OF-CARD-FILE                    VALUE 'Y'.    01590000
016000     05  PS-CONTROL-CARD-3-SW         PIC  X(01)    VALUE 'N'.    01600000
016100         88  PS-CONTROL-CARD-3-END                  VALUE 'Y'.    01610000
016200         88  PS-CONTROL-CARD-3-START                VALUE 'N'.    01620000
016300     05  PS-CONTROL-CARD-4-SW         PIC  X(01)    VALUE 'N'.    01630000
016400         88  PS-CONTROL-CARD-4-END                  VALUE 'Y'.    01640000
016500         88  PS-CONTROL-CARD-4-START                VALUE 'N'.    01650000
016600     05  PS-CONTROL-CARD-5-SW         PIC  X(01)    VALUE 'N'.    01660000
016700         88  PS-CONTROL-CARD-5-END                  VALUE 'Y'.    01670000
016800         88  PS-CONTROL-CARD-5-START                VALUE 'N'.    01680000
016900                                                                  01690000
017000     05  PS-ECOM-STR-SW               PIC  X(01)    VALUE 'N'.    01700000
017100         88  PS-ECOM-STR                            VALUE 'Y'.    01710000
017200     05  PS-MQPUT-SUCCESSFUL-IND      PIC  X(01)    VALUE 'N'.    01720000
017300         88 PS-MQPUT-SUCCESSFUL                     VALUE 'Y'.    01730000
017400                                                                  01740000
017500     05  PS-END-OF-RTRN-ITM-CSR-SW    PIC  X(01)    VALUE 'N'.    01750000
017600         88  PS-NOT-END-OF-RTRN-ITM-CSR             VALUE 'N'.    01760000
017700         88  PS-END-OF-RETRN-ITM-CSR                VALUE 'Y'.    01770000
017800     05  PS-REFUND-TENDER-SW          PIC  X(01)    VALUE 'N'.    01780000
017900         88  PS-CREDIT-CARD-REFUND                  VALUE 'C'.    01790000
018000         88  PS-MAIL-CHECK-REFUND                   VALUE 'M'.    01800000
018100     05  PS-ORIG-TRN-INFO-CHNGD-SW    PIC  X(01)    VALUE 'N'.    01810000
018200         88  PS-ORIG-TRAN-INFO-CHNGD                VALUE 'Y'.    01820000
018300         88  PS-ORIG-TRAN-HASNT-CHNGD               VALUE 'N'.    01830000
018400     05  PS-TRAN-FIRST-TIME-SW        PIC  X(01)    VALUE 'Y'.    01840000
018500         88  PS-TRAN-FIRST-TIME                     VALUE 'Y'.    01850000
018600         88  PS-TRAN-NOT-FIRST-TIME                 VALUE 'N'.    01860000
018700     05  PS-MQ-MSG-LARGER-10000-SW    PIC  X(01)    VALUE 'N'.    01870000
018800         88 PS-MQ-TOO-LARGE                         VALUE 'Y'.    01880000
018900         88 PS-MQ-OK                                VALUE 'N'.    01890000
019000     05  PS-ECOM-STR-NBR-SW           PIC  X(01)    VALUE 'N'.    01900000
019100         88  PS-ECOM-STR-NBR-YES                    VALUE 'Y'.    01910000
019200         88  PS-ECOM-STR-NBR-NO                     VALUE 'N'.    01920000
019300     05  PS-ORIG-SLS-DTE-PARTN-SW     PIC  X(01)    VALUE 'N'.    01930000
019400         88  PS-ORIG-SLS-PARTN-FOUND                VALUE 'Y'.    01940000
019500         88  PS-ORIG-SLS-PARTN-NOT-FOUND            VALUE 'N'.    01950000
019600                                                                  01960000
019700******************************************************************01970000
019800*                           CONSTANTS                             01980000
019900******************************************************************01990000
020000 01  PROGRAM-CONSTANTS.                                           02000000
020100     05  PC-CKPT-JOB-NAME             PIC  X(08) VALUE 'SAK051  '.02010000
020200     05  PC-CKPT-PLAN-NAME            PIC  X(08) VALUE 'SAKUP009'.02020000
020300     05  PC-PGM-NAME                  PIC  X(08) VALUE 'SAKUP009'.02030000
020400                                                                  02040000
020500     05  PC-TRAN-PRES-FUNC-CODES.                                 02050000
020600         10  PC-TRAN-PRES-FUNC-OPEN   PIC  X(05) VALUE 'OPEN '.   02060000
020700         10  PC-TRAN-PRES-FUNC-TRANS  PIC  X(05) VALUE 'TRANS'.   02070000
020800         10  PC-TRAN-PRES-FUNC-RSTRT  PIC  X(05) VALUE 'RSTRT'.   02080000
020900         10  PC-TRAN-PRES-FUNC-CLOSE  PIC  X(05) VALUE 'CLOSE'.   02090000
021000                                                                  02100000
021100     05  PC-MINUS-ONE                 PIC S9(01) VALUE -1.        02110000
021200     05  PC-SYSTEM                    PIC  X(08) VALUE 'SYSTEM  '.02120000
021300                                                                  02130000
021400     05  PC-ROW-NOT-FOUND             PIC S9(04)    VALUE +100    02140000
021500                                                    COMP SYNC.    02150000
021600                                                                  02160000
021700     05  PC-GIFTWRAP-SKU              PIC  X(08)    VALUE         02170000
021800                                                    '85020001'.   02180000
021900                                                                  02190000
022000     05  PC-CREDIT-CARD               PIC  X(03)    VALUE 'CCD'.  02200000
022100     05  PC-CHECK                     PIC  X(03)    VALUE 'CHK'.  02210000
022200                                                                  02220000
022300     05  PC-DECIMAL-HOLDER            PIC S9(02)    VALUE 6  COMP.02230000
022400     05  PC-PERCENT-DECIMAL           PIC S9(02)    VALUE 2  COMP.02240000
022500                                                                  02250000
022600     05  PC-3                         PIC S9(02)    VALUE  3 COMP.02260000
022700     05  PC-4                         PIC S9(02)    VALUE  4 COMP.02270000
022800     05  PC-6                         PIC S9(02)    VALUE  6 COMP.02280000
022900     05  PC-7                         PIC S9(02)    VALUE  7 COMP.02290000
023000     05  PC-24                        PIC  S9(02)   VALUE 24 COMP.02300000
023100                                                                  02310000
023200     05  PC-FIFTY-STARS               PIC  X(50)    VALUE ALL '*'.02320000
023300     05  PC-MQPUT-RETRY-COUNTER       PIC  9(03)    VALUE ZERO.   02330000
023400                                                                  02340000
023500     05  PC-MAXIMUM-ESTORE-ENTRIES                                02350000
023600                                      PIC S9(02)    VALUE +99     02360000
023700                                                    COMP-3.       02370000
023800     05  PC-MAX-RETURN-ITEMS                                      02380000
023900                                      PIC S9(04)    VALUE +500    02390000
024000                                                    COMP-3.       02400000
024100     05  PC-MAX-QUEUE-CHARS                                       02410000
024200                                      PIC S9(07)    VALUE +10000  02420000
024300                                                    COMP-3.       02430000
024400                                                                  02440000
024500     05  PC-DELAY-INTERVAL.                                       02450000
024600         10  FILLER                   PIC  X(02)    VALUE SPACES. 02460000
024700         10  PC-DELAY-TIME            PIC  9(08)    VALUE 1500.   02470000
024800                                                                  02480000
024900     05  PC-LINE-ITM-HEADER-FIXED     PIC  X(21)    VALUE         02490000
025000            'RETURN_ORDER_LINE?WEB'.                              02500000
025100                                                                  02510000
025200                                                                  02520000
025300******************************************************************02530000
025400*                          VARIABLES                              02540000
025500******************************************************************02550000
025600 01  PROGRAM-VARIABLES.                                           02560000
025700     05  PV-SQL                       PIC S9(04)    VALUE ZEROS.  02570000
025800     05  PV-DB2-TABLE-NAME            PIC  X(12)    VALUE SPACES. 02580000
025900     05  PV-DB2-OPERATION-MSG         PIC  X(60)    VALUE SPACES. 02590000
026000                                                                  02600000
026100     05  PV-SQL-SUB                   PIC  9(03)    VALUE ZERO.   02610000
026200     05  PV-PARAGRAPH-NAME            PIC  X(30)    VALUE SPACE.  02620000
026300     05  PV-DB2-OPER-ATTEMPTED        PIC  X(30)    VALUE SPACE.  02630000
026400     05  PV-OPERATION-MSG-1           PIC  X(35)    VALUE SPACE.  02640000
026500     05  PV-OPERATION-MSG-2           PIC  X(35)    VALUE SPACE.  02650000
026600     05  PV-RET-CODE                  PIC  9(04)    VALUE ZEROS.  02660000
026700     05  PV-DB2-SLS-CORR-SEQ-NBR      PIC S9(04)    COMP          02670000
026800                                                    VALUE ZERO.   02680000
026900     05  PV-ESTORE-COUNT              PIC S9(02)    VALUE ZEROES  02690000
027000                                                    COMP-3.       02700000
027100     05  PV-ORDER-NO.                                             02710000
027200         10  PV-ORDER-NO-X            PIC  X(09)    VALUE SPACES. 02720000
027300         10  PV-ORDER-NO-N  REDEFINES PV-ORDER-NO-X               02730000
027400                                      PIC  9(09).                 02740000
027500         10  PV-DIGIT-10              PIC  X(01)    VALUE SPACES. 02750000
027600         10  FILLER                   PIC  X(30).                 02760000
027700                                                                  02770000
027800                                                                  02780000
027900******************************************************************02790000
028000*                          WORK AREA                              02800000
028100******************************************************************02810000
028200 01  PV-MISC-FIELDS.                                              02820000
028300                                                                  02830000
028400     05  PV-DUMMY                     PIC  X(01)    VALUE SPACES. 02840000
028500     05  PV-RTRN-STORE                PIC  9(04)    VALUE ZEROS.  02850000
028600     05  PV-RTRN-TERM                 PIC  9(04)    VALUE ZEROS.  02860000
028700     05  PV-RTRN-TRAN                 PIC  9(04)    VALUE ZEROS.  02870000
028800     05  PV-TMP-NBR-FLD               PIC  9(04)    VALUE ZEROS.  02880000
028900     05  PV-SVD-SLS-DTE               PIC  X(10)    VALUE SPACES. 02890000
029000     05  PV-SVD-PARTN-NBR             PIC S9(04)    COMP          02900000
029100                                                    VALUE ZEROS.  02910000
029200     05  PV-SVD-STR-NBR               PIC S9(04)    COMP          02920000
029300                                                    VALUE ZEROS.  02930000
029400     05  PV-SVD-RGST-ID               PIC S9(04)    COMP          02940000
029500                                                    VALUE ZEROS.  02950000
029600     05  PV-SVD-TRN-NBR               PIC S9(04)    COMP          02960000
029700                                                    VALUE ZEROS.  02970000
029800     05  PV-SVD-STRT-TM               PIC  X(08)    VALUE SPACES. 02980000
029900     05  PV-CNTR                      PIC S9(04)    COMP          02990000
030000                                                    VALUE ZEROS.  03000000
030100     05  PV-CURRENT-DAY-PARTN         PIC S9(04)    COMP          03010000
030200                                                    VALUE ZERO.   03020000
030300     05  PV-TNDR-TYP-CDE              PIC  X(02)    VALUE SPACES. 03030000
030400     05  PV-TNDR-EXPRN-DTE            PIC  X(04)    VALUE SPACES. 03040000
030500     05  PV-TNDR-ID                   PIC  X(33)    VALUE SPACES. 03050000
030600     05  PV-ZERO-TALLY                PIC  9(04)    VALUE ZERO.   03060000
030700     05  PV-MOVE-FIELD-LENGTH         PIC  9(04)    VALUE ZERO.   03070000
030800     05  PV-LINE-ITEM-TAX             PIC S9(07)V99 VALUE ZERO.   03080000
030900     05  PV-LI-NET-TAXABLE-AMT        PIC S9(07)V99 VALUE ZERO.   03090000
031000     05  PV-TEMP-NUMBER               PIC  9(04)    VALUE ZERO.   03100000
031100     05  PV-TEMP-TAX-NUM              PIC  9(10)    VALUE ZERO.   03110000
031200     05  PV-TEMP-TAX-CHAR             PIC  X(10)    VALUE SPACES. 03120000
031300     05  PV-NUMBER-X                  PIC  X(04)    VALUE ZERO.   03130000
031400                                                                  03140000
031500     05  PV-MISC-TEXT-FIELD           PIC  X(80)    VALUE SPACE.  03150000
031600     05  PV-MISC-TEXT-CHAR      REDEFINES PV-MISC-TEXT-FIELD      03160000
031700                                OCCURS 80 TIMES                   03170000
031800                                INDEXED BY PV-MISC-TEXT-CHAR-INDX 03180000
031900                                      PIC  X(01).                 03190000
032000                                                                  03200000
032100     05  PV-MISC-NUM-FIELD            PIC  9(5)V99  VALUE ZEROS.  03210000
032200     05  PV-MISC-NUM-NBR        REDEFINES PV-MISC-NUM-FIELD       03220000
032300                                OCCURS  7 TIMES                   03230000
032400                                INDEXED BY PV-MISC-NUM-NBR-INDX   03240000
032500                                      PIC  9(01).                 03250000
032600                                                                  03260000
032700     05  PV-MISC-PERCNT-FIELD         PIC  9(1)V9(5) VALUE ZEROS. 03270000
032800     05  PV-MISC-PCT-NBR        REDEFINES PV-MISC-PERCNT-FIELD    03280000
032900                                OCCURS  6 TIMES                   03290000
033000                                INDEXED BY PV-MISC-PCT-NBR-INDX   03300000
033100                                      PIC  9(01).                 03310000
033200                                                                  03320000
033300     05  PV-REGISTER-NUMBER           PIC  9(04)    VALUE ZEROS.  03330000
033400         88  PV-ECOM-FUL-CNTR-POS-REG VALUE  01                   03340000
033500                                             02                   03350000
033600                                             03                   03360000
033700                                             04                   03370000
033800                                             09                   03380000
033900                                             10                   03390000
034000                                             11                   03400000
034100                                             12                   03410000
034200                                             13                   03420000
034300                                             14                   03430000
034400                                             15.                  03440000
034500     05  PV-STORE-NUMBER-NUM          PIC  9(04)    VALUE ZEROS.  03450000
034600     05  PV-STORE-NUMBER-CHAR    REDEFINES                        03460000
034700           PV-STORE-NUMBER-NUM        PIC  X(04).                 03470000
034800                                                                  03480000
034900     05  PV-TRAN-NET-CHRGD-AMT        PIC S9(07)V99 COMP-3        03490000
035000                                                    VALUE ZEROS.  03500000
035100     05  PV-TRAN-TAX-AMT              PIC S9(07)V99 COMP-3        03510000
035200                                                    VALUE ZEROS.  03520000
035300     05  PV-TRAN-SPCL-SVC-TAX-AMT     PIC S9(07)V99 COMP-3        03530000
035400                                                    VALUE ZEROS.  03540000
035500     05  PV-TRAN-SHIPPING-TAX-AMT     PIC S9(07)V99 COMP-3        03550000
035600                                                    VALUE ZEROS.  03560000
035700     05  PV-TRAN-TLD-AMT              PIC S9(07)V99 COMP-3        03570000
035800                                                    VALUE ZEROS.  03580000
035900     05  PV-TRAN-SPCL-SVC-AMT         PIC S9(07)V99 COMP-3        03590000
036000                                                    VALUE ZEROS.  03600000
036100     05  PV-TRAN-SHIPPING-AMT         PIC S9(07)V99 COMP-3        03610000
036200                                                    VALUE ZEROS.  03620000
036300     05  PV-TRAN-SUBTOTAL             PIC S9(07)V99 COMP-3        03630000
036400                                                    VALUE ZEROS.  03640000
036500     05  PV-TRAN-TOTAL-AMT            PIC S9(07)V99 COMP-3        03650000
036600                                                    VALUE ZEROS.  03660000
036700     05  PV-TRAN-COMBINED-TAX-AMT     PIC S9(07)V99 COMP-3        03670000
036800                                                    VALUE ZEROS.  03680000
036900     05  PV-TRAN-TOTAL-FEE-AMT        PIC S9(07)V99 COMP-3        03690000
037000                                                    VALUE ZEROS.  03700000
037100     05  PV-SALE-PRICE                PIC S9(07)V99 COMP-3        03710000
037200                                                    VALUE ZEROS.  03720000
037300     05  PV-ITEM-EXTENDED-PRICE       PIC S9(07)V99 COMP-3        03730000
037400                                                    VALUE ZEROS.  03740000
037500     05  PV-ITEM-TOTAL-AMOUNT         PIC S9(07)V99 COMP-3        03750000
037600                                                    VALUE ZEROS.  03760000
037700     05  PV-ORIG-TRN-PARTN            PIC S9(04)    COMP          03770000
037800                                                    VALUE ZEROS.  03780000
037900     05  PV-OUTPUT-RECORD             PIC  X(10024) VALUE SPACES. 03790000
038000                                                                  03800000
038100     05  PV-RI-INDEX                  PIC S9(05)    COMP          03810000
038200                                                    VALUE ZERO.   03820000
038300*01 PV-TIME-HHMM-FMT.                                             03830000
038400*    05  PV-TIME-HHMM-FMT-HH          PIC X(02) VALUE SPACES.     03840000
038500*    05  FILLER                       PIC X(01) VALUE '.'.        03850000
038600*    05  PV-TIME-HHMM-FMT-MM          PIC X(02) VALUE SPACES.     03860000
038700*    05  FILLER                       PIC X(01) VALUE '%'.        03870000
038800*01  PV-TIME-HHMM-FMT-X               PIC X(06) VALUE SPACES.     03880000
038900 01  PS-ORIG-SLS-DTE-SW               PIC X(01) VALUE 'N'.        03890000
039000     88  PS-ORIG-SLS-DTE-FOUND                  VALUE 'Y'.        03900000
039100     88  PS-ORIG-SLS-DTE-NOT-FOUND              VALUE 'N'.        03910000
039200                                                                  03920000
039300******************************************************************03930000
039400*                           TABLES                                03940000
039500******************************************************************03950000
039600 01  ES-ESTORE-TABLE.                                             03960000
039700     05  ES-ESTORE-ENTRY OCCURS 99 TIMES                          03970000
039800                                 INDEXED BY ES-INDEX.             03980000
039900         10  ES-ESTORE.                                           03990000
040000             15  ES-ESTORE-NBR      PIC X(04) VALUE ZEROS.        04000000
040100         10  ES-ESTORE-NUM REDEFINES                              04010000
040200             ES-ESTORE              PIC 9(04).                    04020000
040300                                                                  04030000
040400 01  RO-RETURN-TRAN.                                              04040000
040500     05  RO-RETURN-TRAN-FIXED    PIC X(24)     VALUE              04050000
040600            'RETURN_ORDER_HEADER?WEB?'.                           04060000
040700     05  RO-RETURN-TRAN-DETAIL   PIC X(10000)    VALUE SPACES.    04070000
040800     05  RO-RETURN-TRAN-CHAR     REDEFINES RO-RETURN-TRAN-DETAIL  04080000
040900                                 OCCURS 10000 TIMES               04090000
041000                                 INDEXED BY RO-RETURN-TRAN-INDX   04100000
041100                                 PIC X(1).                        04110000
041200                                                                  04120000
041300 01  PT-RETURNED-ITEM-TABLE.                                      04130000
041400     05  PT-RI-TBL-ROW             OCCURS 500 TIMES.              04140000
041500         10  PT-RI-SKU             PIC  X(08)     VALUE SPACES.   04150000
041600         10  PT-RI-DEPT-CLASS-RDEF REDEFINES PT-RI-SKU.           04160000
041700             15  PT-RI-DPT-CLA-RDF PIC  X(05).                    04170000
041800                 88 PT-RI-MISC-DEPT-CLASS VALUE '09910'.          04180000
041900             15  FILLER            PIC  X(03).                    04190000
042000         10  PT-RI-QTY             PIC S9(04)     VALUE ZEROES.   04200000
042100         10  PT-RI-NET-CHRGD-AMT   PIC S9(07)V99  VALUE ZEROES.   04210000
042200         10  PT-RI-TAX-RATE        PIC S9(1)V9(5) VALUE ZEROES.   04220000
042300         10  PT-RI-TAX-AMT         PIC S9(7)V99   VALUE ZEROES.   04230000
042400         10  PT-RI-FEE-AMT         PIC S9(7)V99   VALUE ZEROES.   04240000
042500         10  PT-RI-TLD-AMT         PIC S9(7)V99   VALUE ZEROES.   04250000
042600         10  PT-RI-ORIG-LNE-ITM    PIC  9(4)      VALUE ZEROES.   04260000
042700         10  PT-RI-SPCL-SVC-IND    PIC X(01)      VALUE 'N'.      04270000
042800               88 PT-RI-SPCL-SRVC-ITM     VALUE 'Y'.              04280000
042900               88 NOT-PT-RI-SPCL-SRVC-ITM VALUE 'N'.              04290000
043000                                                                  04300000
043100******************************************************************04310000
043200*                       DATE/TIME                                 04320000
043300******************************************************************04330000
043400 01  PV-DATE-AND-TIME-FIELDS.                                     04340000
043500                                                                  04350000
043600     05  PV-POS-CCYY-MM-DD            PIC  X(10)    VALUE SPACE.  04360000
043700     05  FILLER REDEFINES PV-POS-CCYY-MM-DD.                      04370000
043800         10  PV-POS-CCYY              PIC  X(04).                 04380000
043900         10  FILLER                   PIC  X(01).                 04390000
044000         10  PV-POS-MM                PIC  X(02).                 04400000
044100         10  FILLER                   PIC  X(01).                 04410000
044200         10  PV-POS-DD                PIC  X(02).                 04420000
044300                                                                  04430000
044400******************************************************************04440000
044500*               SYSTEM TIME AND DATE VARIABLES                    04450000
044600******************************************************************04460000
044700 01  SYS-DATE-TIME.                                               04470000
044800     05  SYS-DATE                     PIC  X(08) VALUE SPACES.    04480000
044900     05  SYS-TIME                     PIC  X(08) VALUE SPACES.    04490000
045000                                                                  04500000
045100 01  ST-BEG-TIME.                                                 04510000
045200     05  ST-BEG-HR                    PIC  9(02) VALUE ZEROS.     04520000
045300     05  FILLER                       PIC  X(01) VALUE ':'.       04530000
045400     05  ST-BEG-MN                    PIC  9(02) VALUE ZEROS.     04540000
045500                                                                  04550000
045600 01  ST-END-TIME.                                                 04560000
045700     05  ST-END-HR                    PIC  9(02) VALUE ZEROS.     04570000
045800     05  FILLER                       PIC  X(01) VALUE ':'.       04580000
045900     05  ST-END-MN                    PIC  9(02) VALUE ZEROS.     04590000
046000                                                                  04600000
046100 01  SD-EDIT-DATE.                                                04610000
046200     05  SD-MONTH                     PIC  9(02) VALUE ZEROS.     04620000
046300     05  FILLER                       PIC  X(01) VALUE '-'.       04630000
046400     05  SD-DAY                       PIC  9(02) VALUE ZEROS.     04640000
046500     05  FILLER                       PIC  X(01) VALUE '-'.       04650000
046600     05  SD-CENT                      PIC  9(02) VALUE ZEROS.     04660000
046700     05  SD-YEAR                      PIC  9(02) VALUE ZEROS.     04670000
046800                                                                  04680000
046900***************************************************************** 04690000
047000* RECORD LAYOUT FOR INPUT DATE CARD (POS DATE)                    04700000
047100***************************************************************** 04710000
047200 01  CC-CONTROL-CARD.                                             04720000
047300                                                                  04730000
047400     05  CC-CONTROL-CARD-DISPLAY.                                 04740000
047500         10  CC-CONTROL-NAME          PIC  X(14)    VALUE SPACE.  04750000
047600             88  CC-VALID-CONTROL-NAME              VALUE         04760000
047700                 'P.O.S. DATE = '.                                04770000
047800         10  CC-POS-DATE-MMDDYY       PIC  9(06)    VALUE ZERO.   04780000
047900     05  FILLER                       PIC  X(60)    VALUE SPACE.  04790000
048000                                                                  04800000
048100***************************************************************** 04810000
048200*                   MQ CONTROL CARDS                              04820000
048300***************************************************************** 04830000
048400 01  CC-CONTROL-CARD-3.                                           04840000
048500     05  CC-QMGR-NAME                 PIC  X(48).                 04850000
048600     05  FILLER                       PIC  X(32).                 04860000
048700 01  CC-CONTROL-CARD-4.                                           04870000
048800     05  CC-BOX-NAME-ATG              PIC  X(48).                 04880000
048900     05  FILLER                       PIC  X(32).                 04890000
049000 01  CC-CONTROL-CARD-5.                                           04900000
049100     05  CC-ATG-RETRN-QUEUE-NAME      PIC  X(48).                 04910000
049200     05  FILLER                       PIC  X(32).                 04920000
049300                                                                  04930000
049400******************************************************************04940000
049500*                        ERROR HANDLING                           04950000
049600******************************************************************04960000
049700 01  ABEND-CODE                       PIC S9(04) VALUE ZEROS      04970000
049800                                                 COMP SYNC.       04980000
049900     88  ABEND-4002-READ-ERROR                   VALUE +4002.     04990000
050000     88  ABEND-4003-CTRL-CARD-ERROR              VALUE +4003.     05000000
050100     88  ABEND-4004-TABLE-ERROR                  VALUE +4004.     05010000
050200     88  ABEND-4005-OPEN-ERROR                   VALUE +4005.     05020000
050300     88  ABEND-4006-CLOSE-ERROR                  VALUE +4006.     05030000
050400     88  ABEND-4013-DB2-ERROR                    VALUE +4013.     05040000
050500     88  ABEND-4019-CAL-SUB-ERROR                VALUE +4019.     05050000
050600     88  ABEND-4020-MQ-ERROR                     VALUE +4020.     05060000
050700     88  ABEND-4444-FORCED-ABEND                 VALUE +4444.     05070000
050800                                                                  05080000
050900                                                                  05090000
051000******************************************************************05100000
051100*                         MQ WORK AREA                            05110000
051200******************************************************************05120000
051300 01  MQ-WORKING-STORAGE.                                          05130000
051400                                                                  05140000
051500     05  WS-MQCONN                   PIC  X(08)  VALUE 'CSQBCONN'.05150000
051600     05  WS-MQOPEN                   PIC  X(08)  VALUE 'CSQBOPEN'.05160000
051700     05  WS-MQINQ                    PIC  X(08)  VALUE 'CSQBINQ'. 05170000
051800     05  WS-MQGET                    PIC  X(08)  VALUE 'CSQBGET'. 05180000
051900     05  WS-MQPUT                    PIC  X(08)  VALUE 'CSQBPUT'. 05190000
052000     05  WS-MQCMIT                   PIC  X(08)  VALUE 'CSQBCOMM'.05200000
052100     05  WS-MQBACK                   PIC  X(08)  VALUE 'CSQBBACK'.05210000
052200     05  WS-MQCLOSE                  PIC  X(08)  VALUE 'CSQBCLOS'.05220000
052300     05  WS-MQDISC                   PIC  X(08)  VALUE 'CSQBDISC'.05230000
052400     05  WS-MQCHECK                  PIC  X(08)  VALUE 'MQR2C'.   05240000
052500                                                                  05250000
052600     05  WS-MDY-DATE.                                             05260000
052700         10  WS-MDY-DATE-MONTH       PIC  9(02).                  05270000
052800         10  WS-MDY-DATE-DAY         PIC  9(02).                  05280000
052900         10  WS-MDY-DATE-YEAR        PIC  9(02).                  05290000
053000                                                                  05300000
053100******************************************************************05310000
053200*                         MQ VARIABLES                            05320000
053300******************************************************************05330000
053400 01 PV-MQ-PROGRAM-VARIABLES.                                      05340000
053500                                                                  05350000
053600     05  PV-FMT-OPEN-OUTPUT-HNDL      PIC S9(09) BINARY VALUE 0.  05360000
053700     05  PV-FMT-OPEN-OUTPUT-HNDL1     PIC S9(09) BINARY VALUE 0.  05370000
053800     05  PV-QM-NAME                   PIC  X(48).                 05380000
053900     05  PV-HCONN                     PIC S9(09) BINARY VALUE 0.  05390000
054000     05  PV-COMP-CODE                 PIC S9(09) BINARY.          05400000
054100     05  PV-REASON                    PIC S9(09) BINARY.          05410000
054200     05  PV-SAVE-COMP-CODE            PIC S9(09) BINARY.          05420000
054300     05  PV-SAVE-REASON               PIC S9(09) BINARY.          05430000
054400     05  PV-CLOSE-HANDLE              PIC S9(09) BINARY VALUE 0.  05440000
054500     05  PV-CON-REASON                PIC S9(09) BINARY.          05450000
054600     05  PV-DEAD-LETTER-QUEUE-NAME    PIC  X(48).                 05460000
054700     05  PV-PARAGRAPH                 PIC  X(48) VALUE SPACES.    05470000
054800     05  PV-ERROR-MESSAGE             PIC  X(48) VALUE SPACES.    05480000
054900     05  PV-OPEN-OPTIONS              PIC S9(09) BINARY.          05490000
055000     05  PV-GQ-HANDLE                 PIC S9(09) BINARY VALUE 0.  05500000
055100     05  PV-PQ-HANDLE                 PIC S9(09) BINARY VALUE 0.  05510000
055200     05  PV-PQ-Q2-HANDLE              PIC S9(09) BINARY VALUE 0.  05520000
055300     05  PV-UNPKD-OPEN-IO-HNDL        PIC S9(09) BINARY VALUE 0.  05530000
055400     05  PV-DATA-LENGTH               PIC S9(09) BINARY.          05540000
055500     05  PV-REC-LENGTH                PIC S9(09) BINARY.          05550000
055600     05  PV-MQ-REASON-TEXT            PIC  X(30) VALUE SPACES.    05560000
055700     05  PV-MSGBUFFER                 PIC X(100000) VALUE SPACES. 05570000
055800     05  PV-MSGLENGTH                 PIC S9(09) BINARY           05580000
055900                                                 VALUE +100000.   05590000
056000                                                                  05600000
056100******************************************************************05610000
056200*                         MQ COPYBOOKS                            05620000
056300******************************************************************05630000
056400 01  MQM-OBJECT-DESCRIPTOR.                                       05640000
056500     COPY CMQODV.                                                 05650000
056600 01  MQM-MESSAGE-DESCRIPTOR.                                      05660000
056700     COPY CMQMDV.                                                 05670000
056800 01  MQM-GET-MESSAGE-OPTIONS.                                     05680000
056900     COPY CMQGMOV.                                                05690000
057000 01  MQM-PUT-MESSAGE-OPTIONS.                                     05700000
057100     COPY CMQPMOV.                                                05710000
057200                                                                  05720000
057300*    MQV CONTAINS CONSTANTS (FOR FILLING IN THE CONTROL BLOCKS)   05730000
057400*    AND RETURN CODES (FOR TESTING THE RESULT OF A CALL)          05740000
057500                                                                  05750000
057600 01  MQM-CONSTANTS.                                               05760000
057700     COPY CMQV.                                                   05770000
057800                                                                  05780000
057900******************************************************************05790000
058000*  MASTER KEY RECORD LAYOUT                                       05800000
058100******************************************************************05810000
058200     COPY SARD012.                                                05820000
058300                                                                  05830000
058400******************************************************************05840000
058500*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             05850000
058600******************************************************************05860000
058700     COPY DPWS500.                                                05870000
058800                                                                  05880000
058900******************************************************************05890000
059000*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            05900000
059100******************************************************************05910000
059200     COPY DPWS004.                                                05920000
059300                                                                  05930000
059400******************************************************************05940000
059500*  SQL COMMUNICATIONS WORK AREA                                   05950000
059600******************************************************************05960000
059700     COPY SQLCA2.                                                 05970000
059800                                                                  05980000
059900******************************************************************05990000
060000*  DB2 COMMUNICATION AREA.                                        06000000
060100******************************************************************06010000
060200     EXEC SQL                                                     06020000
060300          INCLUDE SQLCA                                           06030000
060400     END-EXEC.                                                    06040000
060500                                                                  06050000
060600******************************************************************06060000
060700*  DB2 TABLE TEPPART - PARTITION TABLE                            06070000
060800******************************************************************06080000
060900     EXEC SQL                                                     06090000
061000          INCLUDE TEPPART                                         06100000
061100     END-EXEC.                                                    06110000
061200                                                                  06120000
061300******************************************************************06130000
061400*  DB2 TABLE TEPTRN - TRANSACTION TABLE                           06140000
061500******************************************************************06150000
061600     EXEC SQL                                                     06160000
061700          INCLUDE TEPTRN                                          06170000
061800     END-EXEC.                                                    06180000
061900                                                                  06190000
062000******************************************************************06200000
062100*  DB2 TABLE TEPITM - TRANSACTION ITEM TABLE                      06210000
062200******************************************************************06220000
062300     EXEC SQL                                                     06230000
062400          INCLUDE TEPITM                                          06240000
062500     END-EXEC.                                                    06250000
062600                                                                  06260000
062700******************************************************************06270000
062800*  DB2 TABLE XST_LOC - STORE LOCATION TABLE                       06280000
062900******************************************************************06290000
063000     EXEC SQL                                                     06300000
063100          INCLUDE XST00001                                        06310000
063200     END-EXEC.                                                    06320000
063300                                                                  06330000
063400******************************************************************06340000
063500*  DB2 TABLE TSTATE  - STATE TABLE                                06350000
063600******************************************************************06360000
063700     EXEC SQL                                                     06370000
063800          INCLUDE TSTATE                                          06380000
063900     END-EXEC.                                                    06390000
064000                                                                  06400000
064100******************************************************************06410000
064200*  DB2 TABLE TEPLID - LINE ITEM DISCOUNT TABLE                    06420000
064300******************************************************************06430000
064400     EXEC SQL                                                     06440000
064500          INCLUDE TEPLID                                          06450000
064600     END-EXEC.                                                    06460000
064700                                                                  06470000
064800******************************************************************06480000
064900*  DB2 TABLE TEPLIS - LINE ITEM SERVICES TABLE                    06490000
065000******************************************************************06500000
065100     EXEC SQL                                                     06510000
065200          INCLUDE TEPLIS                                          06520000
065300     END-EXEC.                                                    06530000
065400                                                                  06540000
065500******************************************************************06550000
065600*  DB2 TABLE TEPSHP - TRANSACTION SHIPPING TABLE                  06560000
065700******************************************************************06570000
065800     EXEC SQL                                                     06580000
065900          INCLUDE TEPSHP                                          06590000
066000     END-EXEC.                                                    06600000
066100                                                                  06610000
066200******************************************************************06620000
066300*  DB2 TABLE TEPDKEY - CURRENT PROCESSING DAY KEYS                06630000
066400******************************************************************06640000
066500     EXEC SQL                                                     06650000
066600          INCLUDE TEPDKEY                                         06660000
066700     END-EXEC.                                                    06670000
066800                                                                  06680000
066900******************************************************************06690000
067000*  DB2 TABLE TEPIRT - ITEM RETURN INFORMATION TABLE               06700000
067100******************************************************************06710000
067200     EXEC SQL                                                     06720000
067300          INCLUDE TEPIRT                                          06730000
067400     END-EXEC.                                                    06740000
067500                                                                  06750000
067600******************************************************************06760000
067700*  DB2 TABLE TEPTND - COSA TENDER TABLE                           06770000
067800******************************************************************06780000
067900     EXEC SQL                                                     06790000
068000          INCLUDE TEPTND                                          06800000
068100     END-EXEC.                                                    06810000
068200                                                                  06820000
068300******************************************************************06830000
068400*  DB2 TABLE TEPORD - BLUE MARTINI ORDER TALBE                    06840000
068500******************************************************************06850000
068600     EXEC SQL                                                     06860000
068700          INCLUDE TEPORD                                          06870000
068800     END-EXEC.                                                    06880000
068900                                                                  06890000
069000******************************************************************06900000
069100*  DB2 TABLE TEPECX- E-COM ORDER TABLE                            06910000
069200******************************************************************06920000
069300     EXEC SQL                                                     06930000
069400          INCLUDE TEPECX                                          06940000
069500     END-EXEC.                                                    06950000
069600                                                                  06960000
069700******************************************************************06970000
069800*  CURSOR TO RETRIEVE ALL ITEMS RETURNED IN A TRANSACTION THAT    06980000
069900*  ORIGINATED FROM A SALE AT THE E-STORE.                         06990000
070000******************************************************************07000000
070100                                                                  07010000
070200     EXEC SQL                                                     07020000
070300       DECLARE RETRN-ITM-CURSOR CURSOR FOR                        07030000
070400                                                                  07040000
070500          SELECT  ITM.LNE_ITM_SEQ_NBR                             07050000
070600                 ,ITM.SLD_QTY                                     07060000
070700                 ,ITM.NET_CHRGD_AMT                               07070000
070800                 ,ITM.TXBL_IND                                    07080000
070900                 ,ITM.RCPT_TX_TOT_CDE                             07090000
071000                 ,ITM.TX_RT_PCT                                   07100000
071100                 ,ITM.TX_AMT                                      07110000
071200                 ,ITM.SKU_NBR                                     07120000
071300                 ,IRT.ORIG_SLS_DTE                                07130000
071400                 ,IRT.ORIG_STR_NBR                                07140000
071500                 ,IRT.ORIG_RGST_ID                                07150000
071600                 ,IRT.ORIG_TRN_NBR                                07160000
071700                 ,IRT.ORIG_STRT_TM                                07170000
071800                 ,IRT.ORIG_LNE_ITM_NBR                            07180000
071900                 ,PRT.PARTN_NBR                                   07190000
072000                                                                  07200000
072100          FROM    TEPITM  ITM                                     07210000
072200                 ,TEPIRT  IRT                                     07220000
072300                 ,XST_LOC LOC                                     07230000
072400                 ,TEPPART PRT                                     07240000
072500                                                                  07250000
072600          WHERE   ITM.PARTN_NBR        = :EPTRN-PARTN-NBR         07260000
072700             AND  ITM.STR_NBR          = :EPTRN-STR-NBR           07270000
072800             AND  ITM.RGST_ID          = :EPTRN-RGST-ID           07280000
072900             AND  ITM.TRN_NBR          = :EPTRN-TRN-NBR           07290000
073000             AND  ITM.STRT_TM          = :EPTRN-STRT-TM           07300000
073100             AND  ITM.SLS_CORR_SEQ_NBR = :PV-DB2-SLS-CORR-SEQ-NBR 07310000
073200                                                                  07320000
073300             AND  ITM.PARTN_NBR        = IRT.PARTN_NBR            07330000
073400             AND  ITM.STR_NBR          = IRT.STR_NBR              07340000
073500             AND  ITM.RGST_ID          = IRT.RGST_ID              07350000
073600             AND  ITM.TRN_NBR          = IRT.TRN_NBR              07360000
073700             AND  ITM.STRT_TM          = IRT.STRT_TM              07370000
073800             AND  ITM.SLS_CORR_SEQ_NBR = IRT.SLS_CORR_SEQ_NBR     07380000
073900             AND  ITM.LNE_ITM_SEQ_NBR  = IRT.LNE_ITM_SEQ_NBR      07390000
074000                                                                  07400000
074100             AND  ITM.LIV_RSLU_CDE     IN ('+', '-')              07410000
074200             AND  IRT.ORIG_STR_NBR     = LOC.LOC_NBR              07420000
074300             AND  LOC.LOC_TYP_CDE      = 'DS'                     07430000
074400             AND ((LOC.E_BUS_IND         = 'Y')                   07440003
074500              OR (LOC.E_BUS_IND         = 'N'                     07450003
074600             AND  IRT.ORIG_RGST_ID BETWEEN 90 AND 99))            07460003
074700                                                                  07470000
074800             AND  PRT.SLS_DTE = IRT.ORIG_SLS_DTE                  07480000
074900             AND  PRT.STR_GP_CDE = 'A'                            07490000
075000                                                                  07500000
075100          ORDER BY 9, 10, 11, 12, 13                              07510000
075200                                                                  07520000
075300*************                                                     07530000
075400* THE ACTUAL SORT COLUMNS ARE THE ONES BELOW.                     07540000
075500* THE UNION PREVENTS ORDER BY COLUMN NAMES                        07550000
075600*         ORDER BY IRT.ORIG_SLS_DTE                               07560000
075700*                 ,IRT.ORIG_STR_NBR                               07570000
075800*                 ,IRT.ORIG_RGST_ID                               07580000
075900*                 ,IRT.ORIG_TRN_NBR                               07590000
076000*                 ,IRT.ORIG_STRT_TM                               07600000
076100*************                                                     07610000
076200         WITH UR                                                  07620000
076300                                                                  07630000
076400     END-EXEC.                                                    07640000
076500                                                                  07650000
076600******************************************************************07660000
076700*  CURSOR USED TO RETRIEVE ALL VALID E-STORES                     07670000
076800*  (CURRENTLY THE MAX NUMBER OF E-STORES ASSUMED IS 99!!)         07680000
076900******************************************************************07690000
077000                                                                  07700000
077100     EXEC SQL                                                     07710000
077200       DECLARE ESTORE_CURSOR CURSOR FOR                           07720000
077300            SELECT  LOC.LOC_NBR                                   07730000
077400              FROM  XST_LOC LOC                                   07740000
077500             WHERE  LOC.E_BUS_IND   = 'Y'                         07750000
077600               AND  LOC.LOC_TYP_CDE = 'DS'                        07760000
077700               AND  LOC.OPN_DTE <= :PV-POS-CCYY-MM-DD             07770000
077800               AND  LOC.CLO_DTE >= :PV-POS-CCYY-MM-DD             07780000
077900            WITH UR                                               07790000
078000     END-EXEC.                                                    07800000
078100                                                                  07810000
078200                                                                  07820000
078300                                                                  07830000
078400******************************************************************07840000
078500*  TRANSACTION PREPARATION MODULE COMMUNICATIONS AREA             07850000
078600******************************************************************07860000
260107     COPY DPWS991.                                                07870005
078700                                                                  07871005
078700     COPY DPLS001.                                                07872005
078800                                                                  07880000
078900     05  WORK-STORAGE-PASSED.                                     07890000
079000******************************************************************07900000
079100*PA - PROGRAM ACCUMULATORS                                        07910000
079200******************************************************************07920000
079300         10  PROGRAM-ACCUMULATORS.                                07930000
079400             15  PA-READ          PIC S9(11)           VALUE ZERO 07940000
079500                                                       COMP-3.    07950000
079600             15  PA-CKPT          PIC S9(11)           VALUE ZERO 07960000
079700                                                       COMP-3.    07970000
079800             15  PA-ROWS-PUT-ATG  PIC S9(11)           VALUE ZERO 07980000
079900                                                       COMP-3.    07990000
080000                                                                  08000000
080100 01  FILLER                          PIC X(4096)  VALUE SPACE.    08010000
080200                                                                  08020000
080300                                                                  08030000
080400                                                                  08040000
080500 PROCEDURE DIVISION.                                              08050000
080600******************************************************************08060000
080700* MAINLINE-PROCESSING                                             08070000
080800******************************************************************08080000
080900                                                                  08090000
081000     PERFORM A1000-INITIALIZE.                                    08100000
081100                                                                  08110000
081200     PERFORM B1000-PROCESS-UPDATE-RECORDS                         08120000
081300       UNTIL DP001-PREP-TRANS-EOF.                                08130000
081400                                                                  08140000
081500     PERFORM Z9000-EOJ-ROUTINE.                                   08150000
081600                                                                  08160000
081700     GOBACK.                                                      08170000
081800                                                                  08180000
081900                                                                  08190000
082000******************************************************************08200000
082100* PREFORMS TASK INITIATION                                        08210000
082200******************************************************************08220000
082300 A1000-INITIALIZE.                                                08230000
082400                                                                  08240000
082500     OPEN INPUT  DATE-CARD-FILE.                                  08250000
082600                                                                  08260000
082700     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 08270000
082800                                                                  08280000
082900     MOVE SYS-TIME (1:2) TO ST-BEG-HR.                            08290000
083000     MOVE SYS-TIME (3:2) TO ST-BEG-MN.                            08300000
083100                                                                  08310000
083200     MOVE SYS-DATE (1:2) TO SD-CENT.                              08320000
083300     MOVE SYS-DATE (3:2) TO SD-YEAR.                              08330000
083400     MOVE SYS-DATE (5:2) TO SD-MONTH.                             08340000
083500     MOVE SYS-DATE (7:2) TO SD-DAY.                               08350000
083600                                                                  08360000
083700     PERFORM A2000-PROCESS-CONTROL-CARD.                          08370000
083800                                                                  08380000
083900     PERFORM A4000-MQSETUP.                                       08390000
084000     PERFORM A5000-LOAD-ESTORE-TABLE.                             08400000
084100                                                                  08410000
084200     MOVE PC-TRAN-PRES-FUNC-OPEN TO DP001-FUNC-CODE.              08420000
084300     PERFORM X100-BUILD-COMM-AREA-TRAN-PRES.                      08430000
084400                                                                  08440000
084500                                                                  08450000
084600******************************************************************08460000
084700* READ CONTROL CARD TO GET POS DATE IN MMDDYY FORMAT.  CALL       08470000
084800* DATE ROUTINE TO CONVERT DATE TO A CCYY-MM-DD PROCESS DATE.      08480000
084900******************************************************************08490000
085000 A2000-PROCESS-CONTROL-CARD.                                      08500000
085100                                                                  08510000
085200     PERFORM A2100-READ-DATE-CARD-FILE.                           08520000
085300                                                                  08530000
085400     CLOSE DATE-CARD-FILE.                                        08540000
085500                                                                  08550000
085600     IF PS-END-OF-CARD-FILE                                       08560000
085700         MOVE 'A2000-PROCESS-CONTROL-CARD' TO PV-PARAGRAPH-NAME   08570000
085800         MOVE 'NO CONTROL CARD TO PROCESS' TO PV-OPERATION-MSG-1  08580000
085900         SET ABEND-4003-CTRL-CARD-ERROR TO TRUE                   08590000
086000         PERFORM Z1000-ABEND                                      08600000
086100     END-IF.                                                      08610000
086200                                                                  08620000
086300     DISPLAY '          '.                                        08630000
086400     DISPLAY PC-PGM-NAME                                          08640000
086500             ' - CONTROL CARD = (' CC-CONTROL-CARD-DISPLAY  ')'.  08650000
086600                                                                  08660000
086700     PERFORM A2200-CONVERT-INPUT-DATE.                            08670000
086800                                                                  08680000
086900                                                                  08690000
087000******************************************************************08700000
087100* READ DATE CONTROL CARD                                          08710000
087200******************************************************************08720000
087300 A2100-READ-DATE-CARD-FILE.                                       08730000
087400                                                                  08740000
087500     READ DATE-CARD-FILE INTO CC-CONTROL-CARD                     08750000
087600        AT END                                                    08760000
087700           SET PS-END-OF-CARD-FILE TO TRUE.                       08770000
087800                                                                  08780000
087900                                                                  08790000
088000******************************************************************08800000
088100* CALL KOHLS CALENDAR ROUTINE:                                    08810000
088200*     PASS: CONTROL CARD POS DATE (MMDDYY FORMAT).                08820000
088300*   RETURN: ACTUAL CALENDAR DB2 ISO DATE (CCYY-MM-DD FORMAT).     08830000
088400******************************************************************08840000
088500 A2200-CONVERT-INPUT-DATE.                                        08850000
088600                                                                  08860000
088700     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              08870000
088800                                                                  08880000
088900     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   08890000
089000     SET  DPG51-DO-NOT-INCR-DECR-DATE  TO TRUE.                   08900000
089100     SET  DPG52-LK-DTE-GREG            TO TRUE.                   08910000
089200                                                                  08920000
089300     MOVE CC-POS-DATE-MMDDYY           TO DPG52-LK-DATE-INPUT.    08930000
089400                                                                  08940000
089500     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    08950000
089600                                             DPG54 DPG55 DPG56.   08960000
089700     EVALUATE TRUE                                                08970000
089800         WHEN DPG54-SEVERE-ERROR                                  08980000
089900         WHEN DPG54-DATE-INVALID                                  08990000
090000             MOVE 'A2200-CONVERT-INPUT-DATE'                      09000000
090100                                   TO PV-PARAGRAPH-NAME           09010000
090200             MOVE 'ERROR CONVERTING INPUT CARD DATE'              09020000
090300                                   TO PV-OPERATION-MSG-1          09030000
090400             SET ABEND-4019-CAL-SUB-ERROR                         09040000
090500                                   TO TRUE                        09050000
090600             MOVE DPG54-ERROR-MESSAGE                             09060000
090700                                   TO PV-OPERATION-MSG-2          09070000
090800             PERFORM Z1000-ABEND                                  09080000
090900     END-EVALUATE.                                                09090000
091000                                                                  09100000
091100     MOVE DPG55-DB2-ISO-DATE-FMT   TO PV-POS-CCYY-MM-DD.          09110000
091200                                                                  09120000
091300                                                                  09130000
091400******************************************************************09140000
091500* MQ SETUP                                                        09150000
091600******************************************************************09160000
091700 A4000-MQSETUP.                                                   09170000
091800                                                                  09180000
091900*=================================================================09190000
092000*  READ CONTROL CARD TO GET QUEUE MANAGER NAME                    09200000
092100*=================================================================09210000
092200      SET PS-CONTROL-CARD-3-START TO TRUE.                        09220000
092300      OPEN INPUT CONTROL-CARD-3.                                  09230000
092400      READ CONTROL-CARD-3 INTO CC-CONTROL-CARD-3                  09240000
092500          AT END SET PS-CONTROL-CARD-3-END TO TRUE.               09250000
092600                                                                  09260000
092700      IF PS-CONTROL-CARD-3-END                                    09270000
092800          DISPLAY PC-PGM-NAME                                     09280000
092900              'CONTROL CARD MISSING - FOR QMGR NAME'              09290000
093000          PERFORM A4100-CNTL-ABEND                                09300000
093100      ELSE                                                        09310000
093200          DISPLAY '                     '                         09320000
093300          DISPLAY PC-PGM-NAME                                     09330000
093400                  '- '                                            09340000
093500                  PC-FIFTY-STARS                                  09350000
093600          DISPLAY PC-PGM-NAME                                     09360000
093700                  '- CONTROL CARD 3: '                            09370000
093800                  CC-CONTROL-CARD-3                               09380000
093900      END-IF.                                                     09390000
094000                                                                  09400000
094100      CLOSE CONTROL-CARD-3.                                       09410000
094200                                                                  09420000
094300*=================================================================09430000
094400*  READ CONTROL CARD TO GET BOX NAME FOR ATG                      09440000
094500*=================================================================09450000
094600      SET PS-CONTROL-CARD-4-START TO TRUE.                        09460000
094700      OPEN INPUT CONTROL-CARD-4.                                  09470000
094800      READ CONTROL-CARD-4 INTO CC-CONTROL-CARD-4                  09480000
094900          AT END SET PS-CONTROL-CARD-4-END TO TRUE.               09490000
095000                                                                  09500000
095100      IF PS-CONTROL-CARD-4-END                                    09510000
095200          DISPLAY PC-PGM-NAME                                     09520000
095300              'CONTROL CARD MISSING - FOR ATG BOX NAME'           09530000
095400          PERFORM A4100-CNTL-ABEND                                09540000
095500      ELSE                                                        09550000
095600          DISPLAY PC-PGM-NAME                                     09560000
095700                  '- '                                            09570000
095800                  PC-FIFTY-STARS                                  09580000
095900          DISPLAY PC-PGM-NAME                                     09590000
096000                  '- CONTROL CARD 4: '                            09600000
096100                  CC-CONTROL-CARD-4                               09610000
096200      END-IF.                                                     09620000
096300                                                                  09630000
096400      CLOSE CONTROL-CARD-4.                                       09640000
096500                                                                  09650000
096600*=================================================================09660000
096700*  READ CONTROL CARD TO GET OUTPUT QUEUE NAME FOR ATG             09670000
096800*=================================================================09680000
096900      SET PS-CONTROL-CARD-5-START TO TRUE.                        09690000
097000      OPEN INPUT CONTROL-CARD-5.                                  09700000
097100      READ CONTROL-CARD-5 INTO CC-CONTROL-CARD-5                  09710000
097200          AT END SET PS-CONTROL-CARD-5-END TO TRUE.               09720000
097300                                                                  09730000
097400      IF PS-CONTROL-CARD-5-END                                    09740000
097500          DISPLAY PC-PGM-NAME                                     09750000
097600             'CONTROL CARD MISSING - ATG RTRN QUEUE NAME'         09760000
097700          PERFORM A4100-CNTL-ABEND                                09770000
097800      ELSE                                                        09780000
097900          DISPLAY PC-PGM-NAME                                     09790000
098000                  '- '                                            09800000
098100                  PC-FIFTY-STARS                                  09810000
098200          DISPLAY PC-PGM-NAME                                     09820000
098300                  '- CONTROL CARD 5: '                            09830000
098400                  CC-CONTROL-CARD-5                               09840000
098500          DISPLAY PC-PGM-NAME                                     09850000
098600                  '- '                                            09860000
098700                  PC-FIFTY-STARS                                  09870000
098800      END-IF.                                                     09880000
098900                                                                  09890000
099000      CLOSE CONTROL-CARD-5.                                       09900000
099100                                                                  09910000
099200*=================================================================09920000
099300*    CONNECT TO THE QUEUE MANAGER                                 09930000
099400*=================================================================09940000
099500* SUPPLY QM-NAME, GET BACK HCONN, COMPLETION CODE AND REASON      09950000
099600                                                                  09960000
099700     MOVE CC-QMGR-NAME TO PV-QM-NAME.                             09970000
099800     CALL WS-MQCONN USING PV-QM-NAME                              09980000
099900                          PV-HCONN                                09990000
100000                          PV-COMP-CODE                            10000000
100100                          PV-REASON.                              10010000
100200                                                                  10020000
100300*    IF CONNECTION FAILED THEN DISPLAY ERROR MESSAGE              10030000
100400*    AND EXIT                                                     10040000
100500                                                                  10050000
100600     MOVE PV-REASON TO PV-CON-REASON.                             10060000
100700                                                                  10070000
100800     IF (PV-COMP-CODE NOT = MQCC-OK) THEN                         10080000
100900        MOVE 'MQCONN ERROR'  TO PV-ERROR-MESSAGE                  10090000
101000        MOVE 'A4000-MQ-SETUP' TO PV-PARAGRAPH                     10100000
101100        PERFORM Z3000-DISPLAY-MQ-ERROR                            10110000
101200     END-IF.                                                      10120000
101300                                                                  10130000
101400     DISPLAY '                     '.                             10140000
101500     DISPLAY 'MQCONN SUCCESSFUL TO ', PV-QM-NAME.                 10150000
101600                                                                  10160000
101700*=================================================================10170000
101800*    OPEN THE ATG RETURN QUEUE FOR OUTPUT                         10180000
101900*=================================================================10190000
102000                                                                  10200000
102100     COMPUTE PV-OPEN-OPTIONS = MQOO-OUTPUT +                      10210000
102200                               MQOO-FAIL-IF-QUIESCING.            10220000
102300     MOVE CC-ATG-RETRN-QUEUE-NAME  TO MQOD-OBJECTNAME.            10230000
102400     MOVE CC-BOX-NAME-ATG          TO MQOD-OBJECTQMGRNAME.        10240000
102500                                                                  10250000
102600     CALL WS-MQOPEN USING PV-HCONN                                10260000
102700                          MQM-OBJECT-DESCRIPTOR                   10270000
102800                          PV-OPEN-OPTIONS                         10280000
102900                          PV-PQ-Q2-HANDLE                         10290000
103000                          PV-COMP-CODE                            10300000
103100                          PV-REASON.                              10310000
103200                                                                  10320000
103300*    IF OPEN FAILED THEN DISPLAY ERROR MESSAGE                    10330000
103400*    AND EXIT.                                                    10340000
103500*                                                                 10350000
103600     IF (PV-COMP-CODE NOT = MQCC-OK) THEN                         10360000
103700        MOVE 'MQOPEN ERROR - ATG'         TO PV-ERROR-MESSAGE     10370000
103800        MOVE 'A4000-MQSETUP'              TO PV-PARAGRAPH         10380000
103900        MOVE PV-REASON                    TO PV-SAVE-REASON       10390000
104000        MOVE PV-COMP-CODE                 TO PV-SAVE-COMP-CODE    10400000
104100        PERFORM A4200-DISCONNECT-QMGR                             10410000
104200        PERFORM Z3000-DISPLAY-MQ-ERROR                            10420000
104300     END-IF.                                                      10430000
104400                                                                  10440000
104500     MOVE PV-PQ-Q2-HANDLE TO PV-FMT-OPEN-OUTPUT-HNDL1.            10450000
104600     DISPLAY 'MQOPEN OF ATG RETURN QUEUE SUCCESSFUL'.             10460000
104700                                                                  10470000
104800******************************************************************10480000
104900* CONTROL CARD ABEND                                              10490000
105000******************************************************************10500000
105100 A4100-CNTL-ABEND.                                                10510000
105200                                                                  10520000
105300     DISPLAY '                        '.                          10530000
105400     DISPLAY '** CONTROL CARD ISSUE **'.                          10540000
105500                                                                  10550000
105600     SET ABEND-4003-CTRL-CARD-ERROR TO TRUE.                      10560000
105700                                                                  10570000
105800     CALL 'ILBOABN0' USING ABEND-CODE.                            10580000
105900                                                                  10590000
106000                                                                  10600000
106100***************************************************************** 10610000
106200* DISCONNECT FROM THE QUEUE MANAGER                               10620000
106300***************************************************************** 10630000
106400 A4200-DISCONNECT-QMGR.                                           10640000
106500                                                                  10650000
106600     IF PV-CON-REASON IS NOT EQUAL TO MQRC-ALREADY-CONNECTED      10660000
106700        CALL WS-MQDISC USING PV-HCONN                             10670000
106800                             PV-COMP-CODE                         10680000
106900                             PV-REASON                            10690000
107000                                                                  10700000
107100        IF (PV-COMP-CODE NOT = MQCC-OK) THEN                      10710000
107200           MOVE 'MQDISC ERROR'         TO PV-ERROR-MESSAGE        10720000
107300           MOVE 'A4200-DISCONNECT-QMGR' TO PV-PARAGRAPH           10730000
107400           MOVE PV-REASON              TO PV-SAVE-REASON          10740000
107500           MOVE PV-COMP-CODE           TO PV-SAVE-COMP-CODE       10750000
107600           PERFORM Z3000-DISPLAY-MQ-ERROR                         10760000
107700                                                                  10770000
107800        ELSE                                                      10780000
107900           DISPLAY 'MQDISC SUCCESSFUL'                            10790000
108000                                                                  10800000
108100        END-IF                                                    10810000
108200     END-IF.                                                      10820000
108300                                                                  10830000
108400                                                                  10840000
108500******************************************************************10850000
108600* LOADS ALL VALID E-STORES INTO A INTERNAL TABLE.                 10860000
108700******************************************************************10870000
108800 A5000-LOAD-ESTORE-TABLE.                                         10880000
108900                                                                  10890000
109000     INITIALIZE ES-ESTORE-TABLE                                   10900000
109100        REPLACING ALPHANUMERIC DATA BY ZEROS                      10910000
109200                  NUMERIC DATA BY ZEROS.                          10920000
109300                                                                  10930000
109400     PERFORM A5100-OPEN-ESTORE-CURSOR.                            10940000
109500                                                                  10950000
109600     PERFORM A5200-FETCH-ESTORE-ROW.                              10960000
109700                                                                  10970000
109800     PERFORM VARYING ES-INDEX FROM 1 BY 1                         10980000
109900       UNTIL ((ES-INDEX > PC-MAXIMUM-ESTORE-ENTRIES)              10990000
110000          OR (SQLCODE = PC-ROW-NOT-FOUND))                        11000000
110100             MOVE XST00001-LOC-NBR TO ES-ESTORE-NBR (ES-INDEX)    11010000
110200             PERFORM A5200-FETCH-ESTORE-ROW                       11020000
110300     END-PERFORM.                                                 11030000
110400                                                                  11040000
110500     SET ES-INDEX         DOWN BY 1.                              11050000
110600     SET PV-ESTORE-COUNT       TO ES-INDEX.                       11060000
110700                                                                  11070000
110800     IF ES-INDEX > PC-MAXIMUM-ESTORE-ENTRIES                      11080000
110900         DISPLAY '           '                                    11090000
111000         DISPLAY '** ABEND **'                                    11100000
111100         DISPLAY '** A5000-LOAD-ESTORE-TABLE **'                  11110000
111200         DISPLAY '** OVERFLOW ON ESTORE TABLE **'                 11120000
111300         DISPLAY '** PC-MAXIMUM-ESTORE-ENTRIES = '                11130000
111400                                PC-MAXIMUM-ESTORE-ENTRIES         11140000
111500         DISPLAY PC-PGM-NAME              ' - MAXIMUM NUMBER OF ' 11150000
111600                   'ENTRIES ON THE ESTORE TABLE EXCEEDED'         11160000
111700         DISPLAY PC-PGM-NAME              ' - EXPAND THE TABLE '  11170000
111800                   'AND RERUN'                                    11180000
111900                                                                  11190000
112000         SET ABEND-4004-TABLE-ERROR TO TRUE                       11200000
112100         CALL 'ILBOABN0' USING ABEND-CODE                         11210000
112200     END-IF.                                                      11220000
112300                                                                  11230000
112400     PERFORM A5300-CLOSE-ESTORE-CURSOR.                           11240000
112500                                                                  11250000
112600                                                                  11260000
112700******************************************************************11270000
112800* OPEN CURSOR                                                     11280000
112900******************************************************************11290000
113000 A5100-OPEN-ESTORE-CURSOR.                                        11300000
113100                                                                  11310000
113200     EXEC SQL                                                     11320000
113300         OPEN ESTORE_CURSOR                                       11330000
113400     END-EXEC.                                                    11340000
113500                                                                  11350000
113600     EVALUATE TRUE                                                11360000
113700         WHEN SQLCODE = ZERO                                      11370000
113800             CONTINUE                                             11380000
113900                                                                  11390000
114000         WHEN SQLWARN0 NOT EQUAL SPACE                            11400000
114100         WHEN SQLCODE NOT EQUAL ZERO                              11410000
114200             MOVE SQLCODE TO PV-SQL                               11420000
114300                                                                  11430000
114400             MOVE 'A5100-OPEN-ESTORE-CURSOR' TO PV-PARAGRAPH-NAME 11440000
114500             MOVE 'XST_LOC'                 TO PV-DB2-TABLE-NAME  11450000
114600                                                                  11460000
114700             STRING 'ERROR ON OPEN OF ESTORE-CURSOR - SQLCODE = ' 11470000
114800                PV-SQL DELIMITED BY SIZE INTO PV-DB2-OPERATION-MSG11480000
114900             END-STRING                                           11490000
115000                                                                  11500000
115100             SET ABEND-4005-OPEN-ERROR TO TRUE                    11510000
115200             PERFORM Z2000-SQL-ABEND                              11520000
115300     END-EVALUATE.                                                11530000
115400                                                                  11540000
115500                                                                  11550000
115600******************************************************************11560000
115700* FETCH ESTORE ROW                                                11570000
115800******************************************************************11580000
115900 A5200-FETCH-ESTORE-ROW.                                          11590000
116000                                                                  11600000
116100     EXEC SQL                                                     11610000
116200         FETCH ESTORE_CURSOR                                      11620000
116300             INTO :XST00001-LOC-NBR                               11630000
116400     END-EXEC.                                                    11640000
116500                                                                  11650000
116600     EVALUATE TRUE                                                11660000
116700         WHEN SQLCODE = ZERO                                      11670000
116800         WHEN SQLCODE = PC-ROW-NOT-FOUND                          11680000
116900             CONTINUE                                             11690000
117000                                                                  11700000
117100         WHEN SQLWARN0 NOT EQUAL SPACE                            11710000
117200         WHEN SQLCODE NOT EQUAL ZERO                              11720000
117300             MOVE SQLCODE TO PV-SQL                               11730000
117400                                                                  11740000
117500             MOVE 'A5200-FETCH-ESTORE-ROW' TO PV-PARAGRAPH-NAME   11750000
117600             MOVE 'XST_LOC'                TO PV-DB2-TABLE-NAME   11760000
117700                                                                  11770000
117800             STRING 'ERROR ON FETCH OF ESTORE-CURSOR - SQLCODE = '11780000
117900                PV-SQL DELIMITED BY SIZE INTO PV-DB2-OPERATION-MSG11790000
118000             END-STRING                                           11800000
118100                                                                  11810000
118200             SET ABEND-4002-READ-ERROR TO TRUE                    11820000
118300             PERFORM Z2000-SQL-ABEND                              11830000
118400     END-EVALUATE.                                                11840000
118500                                                                  11850000
118600                                                                  11860000
118700******************************************************************11870000
118800* CLOSE CURSOR                                                    11880000
118900******************************************************************11890000
119000 A5300-CLOSE-ESTORE-CURSOR.                                       11900000
119100                                                                  11910000
119200     EXEC SQL                                                     11920000
119300         CLOSE ESTORE_CURSOR                                      11930000
119400     END-EXEC.                                                    11940000
119500                                                                  11950000
119600     EVALUATE TRUE                                                11960000
119700         WHEN SQLCODE = ZERO                                      11970000
119800              CONTINUE                                            11980000
119900                                                                  11990000
120000         WHEN SQLWARN0 NOT EQUAL SPACE                            12000000
120100         WHEN SQLCODE NOT EQUAL ZERO                              12010000
120200             MOVE SQLCODE TO PV-SQL                               12020000
120300                                                                  12030000
120400             MOVE 'A5300-CLOSE-ESTORE-CURSOR' TO PV-PARAGRAPH-NAME12040000
120500             MOVE 'XST_LOC'                   TO PV-DB2-TABLE-NAME12050000
120600                                                                  12060000
120700             STRING 'ERROR ON CLOSE OF ESTORE-CURSOR - SQLCODE = '12070000
120800                PV-SQL DELIMITED BY SIZE INTO PV-DB2-OPERATION-MSG12080000
120900             END-STRING                                           12090000
121000                                                                  12100000
121100             SET ABEND-4006-CLOSE-ERROR TO TRUE                   12110000
121200             PERFORM Z2000-SQL-ABEND                              12120000
121300     END-EVALUATE.                                                12130000
121400                                                                  12140000
121500                                                                  12150000
121600******************************************************************12160000
121700* PROCESS UPDATE RECORDS                                          12170000
121800******************************************************************12180000
121900 B1000-PROCESS-UPDATE-RECORDS.                                    12190000
122000                                                                  12200000
122100     SET PS-RESTART-NOT-REQUIRED TO TRUE.                         12210000
122200     MOVE EPTRN-STR-NBR          TO PV-STORE-NUMBER-NUM.          12220000
122300     MOVE EPTRN-RGST-ID          TO PV-REGISTER-NUMBER.           12230000
122400     INSPECT PV-STORE-NUMBER-CHAR REPLACING LEADING SPACES BY     12240000
122500             ZEROS.                                               12250000
122600** IF THE STORE NUMBER OF THE RETURN TRANSACTION IS AN E-STOR     12260000
122700** WE DO NOT HAVE TO WRITE DATA TO THE QUEUE FOR BLUE MARTINI     12270000
122800     PERFORM D4010-CHECK-IF-ESTORE.                               12280000
254716** COMMENT ABOVE IS OBSOLETE AS OF MARCH, 2021 - ALL RETURNS      12281004
254716** NEED TO BE WRITTEN.  PARA D4010 CURRENTLY NOT NEEDED.          12281104
254716     PERFORM C1000-PROCESS-MASTER-KEY.                            12282004
254716*    IF ((PS-ECOM-STR-NBR-YES AND PV-ECOM-FUL-CNTR-POS-REG)       12290004
254716*        OR PS-ECOM-STR-NBR-NO)                                   12300004
254716*             PERFORM C1000-PROCESS-MASTER-KEY                    12310004
254716*    END-IF.                                                      12320004
123300                                                                  12330000
123400                                                                  12340000
123500*----------------------------------------------------------------*12350000
123600*  IF A RESTART IS REQUIRED, ISSUE A RESTART CALL RATHER THAN A  *12360000
123700*  TRANS CALL.  THIS WILL ALLOW PROCESSING TO RESUME WITH THE    *12370000
123800*  FIRST TRANSACTION AFTER THE LAST COMMIT.                      *12380000
123900*----------------------------------------------------------------*12390000
124000     IF  PS-RESTART-REQUIRED                                      12400000
124100         MOVE PC-TRAN-PRES-FUNC-RSTRT TO DP001-FUNC-CODE          12410000
124200     ELSE                                                         12420000
124300         MOVE PC-TRAN-PRES-FUNC-TRANS TO DP001-FUNC-CODE          12430000
124400     END-IF.                                                      12440000
124500                                                                  12450000
124600     PERFORM X100-BUILD-COMM-AREA-TRAN-PRES.                      12460000
124700                                                                  12470000
124800     ADD 1 TO PA-READ.                                            12480000
124900                                                                  12490000
125000                                                                  12500000
125100******************************************************************12510000
125200* MASTER KEY PROCESSING                                           12520000
125300******************************************************************12530000
125400 C1000-PROCESS-MASTER-KEY.                                        12540000
125500                                                                  12550000
125600     PERFORM C2000-FIND-SLS-CORR-SEQ-NBR.                         12560000
125700     PERFORM C3000-INITIALIZE-FIELDS.                             12570000
125800                                                                  12580000
125900     PERFORM C4000-OPEN-RET-ITM-CURSOR.                           12590000
126000     PERFORM C5000-FETCH-RTRN-ITM-CURSOR.                         12600000
126100                                                                  12610000
126200     PERFORM D1000-PROCESS-RET-OF-ORIG-TRAN                       12620000
126300       UNTIL PS-END-OF-RETRN-ITM-CSR.                             12630000
126400                                                                  12640000
126500     PERFORM C6000-CLOSE-RET-ITM-CURSOR.                          12650000
126600                                                                  12660000
126700                                                                  12670000
126800***************************************************************** 12680000
126900* FINDS THE SALES CORRECTION SEQUENCE NUMBER.                     12690000
127000***************************************************************** 12700000
127100 C2000-FIND-SLS-CORR-SEQ-NBR.                                     12710000
127200                                                                  12720000
127300     EXEC SQL                                                     12730000
127400       SELECT  MAX(SLS_CORR_SEQ_NBR)                              12740000
127500         INTO  :PV-DB2-SLS-CORR-SEQ-NBR                           12750000
127600         FROM  TEPTRN                                             12760000
127700        WHERE  PARTN_NBR          = :EPTRN-PARTN-NBR              12770000
127800         AND   STR_NBR            = :EPTRN-STR-NBR                12780000
127900         AND   RGST_ID            = :EPTRN-RGST-ID                12790000
128000         AND   TRN_NBR            = :EPTRN-TRN-NBR                12800000
128100         AND   STRT_TM            = :EPTRN-STRT-TM                12810000
128200       WITH UR                                                    12820000
128300     END-EXEC.                                                    12830000
128400                                                                  12840000
128500     EVALUATE TRUE                                                12850000
128600         WHEN SQLCODE = ZERO                                      12860000
128700             CONTINUE                                             12870000
128800                                                                  12880000
128900         WHEN OTHER                                               12890000
129000             DISPLAY '            '                               12900000
129100             DISPLAY 'PARTN NBR = ' EPTRN-PARTN-NBR               12910000
129200             DISPLAY 'STR NBR   = ' EPTRN-STR-NBR                 12920000
129300             DISPLAY 'RGST ID   = ' EPTRN-RGST-ID                 12930000
129400             DISPLAY 'TRN NBR   = ' EPTRN-TRN-NBR                 12940000
129500             DISPLAY 'STRT-TM   = ' EPTRN-STRT-TM                 12950000
129600                                                                  12960000
129700             MOVE 'C2000-FIND-SLS-CORR-SEQ-NBR'                   12970000
129800                                  TO PV-PARAGRAPH-NAME            12980000
129900             MOVE 'TEPTRN'        TO PV-DB2-TABLE-NAME            12990000
130000             MOVE 'ERROR SELECTING SLS CORR SEQ NBR'              13000000
130100                                  TO PV-DB2-OPERATION-MSG         13010000
130200                                                                  13020000
130300             PERFORM Z2000-SQL-ABEND                              13030000
130400     END-EVALUATE.                                                13040000
130500                                                                  13050000
130600                                                                  13060000
130700***************************************************************** 13070000
130800* INTIALIZE FIELDS FOR NEXT RECORD AND SET SWITCHES               13080000
130900***************************************************************** 13090000
131000 C3000-INITIALIZE-FIELDS.                                         13100000
131100                                                                  13110000
131200     INITIALIZE EPIRT-ORIG-SLS-DTE                                13120000
131300                EPIRT-ORIG-STR-NBR                                13130000
131400                EPIRT-ORIG-RGST-ID                                13140000
131500                EPIRT-ORIG-TRN-NBR                                13150000
131600                EPIRT-ORIG-STRT-TM                                13160000
131700                PV-SVD-SLS-DTE                                    13170000
131800                PV-SVD-STR-NBR                                    13180000
131900                PV-SVD-PARTN-NBR                                  13190000
132000                PV-SVD-RGST-ID                                    13200000
132100                PV-SVD-TRN-NBR                                    13210000
132200                PV-SVD-STRT-TM.                                   13220000
132300                                                                  13230000
132400     SET PS-MQ-OK           TO TRUE.                              13240000
132500     SET PS-TRAN-FIRST-TIME TO TRUE.                              13250000
132600                                                                  13260000
132700                                                                  13270000
132800***************************************************************** 13280000
132900* OPEN CURSOR                                                     13290000
133000***************************************************************** 13300000
133100 C4000-OPEN-RET-ITM-CURSOR.                                       13310000
133200                                                                  13320000
133300     EXEC SQL                                                     13330000
133400          OPEN RETRN-ITM-CURSOR                                   13340000
133500     END-EXEC.                                                    13350000
133600                                                                  13360000
133700     EVALUATE TRUE                                                13370000
133800         WHEN SQLCODE = ZERO                                      13380000
133900              SET PS-NOT-END-OF-RTRN-ITM-CSR TO TRUE              13390000
134000                                                                  13400000
134100         WHEN SQLWARN0 NOT EQUAL SPACE                            13410000
134200         WHEN SQLCODE NOT EQUAL ZERO                              13420000
134300             MOVE 'C4000-OPEN-RET-ITM-CURSOR'                     13430000
134400                                   TO PV-PARAGRAPH-NAME           13440000
134500             MOVE 'TEPITM'        TO PV-DB2-TABLE-NAME            13450000
134600             MOVE 'ERROR ON OPEN OF RTRN ITM CSR'                 13460000
134700                                   TO PV-DB2-OPERATION-MSG        13470000
134800             PERFORM Z2000-SQL-ABEND                              13480000
134900     END-EVALUATE.                                                13490000
135000                                                                  13500000
135100                                                                  13510000
135200***************************************************************** 13520000
135300* FETCH RTRN ITM CURSOR                                           13530000
135400***************************************************************** 13540000
135500 C5000-FETCH-RTRN-ITM-CURSOR.                                     13550000
135600                                                                  13560000
135700     EXEC SQL                                                     13570000
135800          FETCH RETRN-ITM-CURSOR                                  13580000
135900           INTO :EPITM-LNE-ITM-SEQ-NBR                            13590000
136000               ,:EPITM-SLD-QTY                                    13600000
136100               ,:EPITM-NET-CHRGD-AMT                              13610000
136200               ,:EPITM-TXBL-IND                                   13620000
136300               ,:EPITM-RCPT-TX-TOT-CDE                            13630000
136400               ,:EPITM-TX-RT-PCT                                  13640000
136500               ,:EPITM-TX-AMT                                     13650000
136600               ,:EPITM-SKU-NBR                                    13660000
136700               ,:EPIRT-ORIG-SLS-DTE                               13670000
136800               ,:EPIRT-ORIG-STR-NBR                               13680000
136900               ,:EPIRT-ORIG-RGST-ID                               13690000
137000               ,:EPIRT-ORIG-TRN-NBR                               13700000
137100               ,:EPIRT-ORIG-STRT-TM                               13710000
137200               ,:EPIRT-ORIG-LNE-ITM-NBR                           13720000
137300               ,:PV-ORIG-TRN-PARTN                                13730000
137400     END-EXEC.                                                    13740000
137500                                                                  13750000
137600     EVALUATE TRUE                                                13760000
137700         WHEN SQLCODE = ZERO                                      13770000
137800             IF EPIRT-ORIG-SLS-DTE NOT = PV-SVD-SLS-DTE           13780000
137900                OR  EPIRT-ORIG-STR-NBR NOT = PV-SVD-STR-NBR       13790000
138000                OR  EPIRT-ORIG-RGST-ID NOT = PV-SVD-RGST-ID       13800000
138100                OR  EPIRT-ORIG-TRN-NBR NOT = PV-SVD-TRN-NBR       13810000
138200                OR  EPIRT-ORIG-STRT-TM NOT = PV-SVD-STRT-TM       13820000
138300                                                                  13830000
138400               IF PS-TRAN-FIRST-TIME                              13840000
138500                  MOVE EPIRT-ORIG-SLS-DTE TO PV-SVD-SLS-DTE       13850000
138600                  MOVE EPIRT-ORIG-STR-NBR TO PV-SVD-STR-NBR       13860000
138700                  MOVE PV-ORIG-TRN-PARTN  TO PV-SVD-PARTN-NBR     13870000
138800                  MOVE EPIRT-ORIG-RGST-ID TO PV-SVD-RGST-ID       13880000
138900                  MOVE EPIRT-ORIG-TRN-NBR TO PV-SVD-TRN-NBR       13890000
139000                  MOVE EPIRT-ORIG-STRT-TM TO PV-SVD-STRT-TM       13900000
139100                  SET PS-TRAN-NOT-FIRST-TIME TO TRUE              13910000
139200               ELSE                                               13920000
139300                  SET PS-ORIG-TRAN-INFO-CHNGD TO TRUE             13930000
139400               END-IF                                             13940000
139500             END-IF                                               13950000
139600                                                                  13960000
139700         WHEN SQLCODE = PC-ROW-NOT-FOUND                          13970000
139800             SET PS-END-OF-RETRN-ITM-CSR TO TRUE                  13980000
139900                                                                  13990000
140000         WHEN SQLWARN0 NOT EQUAL SPACE                            14000000
140100         WHEN SQLCODE NOT EQUAL ZERO                              14010000
140200             MOVE 'C5000-FETCH-RTRN-ITM-CURSOR'                   14020000
140300                                   TO PV-PARAGRAPH-NAME           14030000
140400             MOVE 'TEPITM'         TO PV-DB2-TABLE-NAME           14040000
140500             MOVE 'ERROR ON FETCH OF RTRN ITM CSR'                14050000
140600                                   TO PV-DB2-OPERATION-MSG        14060000
140700             PERFORM Z2000-SQL-ABEND                              14070000
140800     END-EVALUATE.                                                14080000
140900***************************************************************** 14090000
141000* CLOSE CURSOR                                                    14100000
141100***************************************************************** 14110000
141200 C6000-CLOSE-RET-ITM-CURSOR.                                      14120000
141300                                                                  14130000
141400     EXEC SQL                                                     14140000
141500          CLOSE RETRN-ITM-CURSOR                                  14150000
141600     END-EXEC.                                                    14160000
141700                                                                  14170000
141800     EVALUATE TRUE                                                14180000
141900         WHEN SQLCODE = ZERO                                      14190000
142000              CONTINUE                                            14200000
142100                                                                  14210000
142200         WHEN SQLWARN0 NOT EQUAL SPACE                            14220000
142300         WHEN SQLCODE NOT EQUAL ZERO                              14230000
142400             MOVE 'C6000-CLOSE-RET-ITM-CSR'                       14240000
142500                                   TO PV-PARAGRAPH-NAME           14250000
142600             MOVE 'TEPITM'         TO PV-DB2-TABLE-NAME           14260000
142700             MOVE 'ERROR ON CLOSE OF RTRN ITM CSR'                14270000
142800                                   TO PV-DB2-OPERATION-MSG        14280000
142900             PERFORM Z2000-SQL-ABEND                              14290000
143000     END-EVALUATE.                                                14300000
143100                                                                  14310000
143200                                                                  14320000
143300***************************************************************** 14330000
143400* PROCESSES EACH ORIG SALE TRAN TIED TO THE RETRN TRANS RETRVD    14340000
143500* IN THE MASTER CURSOR.  WHEN NEW ORIG TRAN INFO IS DETECTED      14350000
143600* WITHIN THE RETURN, THE MESSAGE IS WRITTEN OUT AND THEN WE PROCES14360000
143700* THE NEXT ORIG SALE TRANS RETURNED.  WE DO THIS UNTIL ALL ORIG   14370000
143800* TRANSACTIONS WITHIN THE RETURN HAVE BEEN PROCESSED.             14380000
143900* WILL INITIALIZE FIELDS BEFORE EACH TRANSACTION, AND THEN BUILD  14390000
144000* A INTERNAL TABLE WITH ITEM INFORMATION FOR ALL ITEMS RETURNED   14400000
144100* IN THE TRANSACTION.                                             14410000
144200***************************************************************** 14420000
144300 D1000-PROCESS-RET-OF-ORIG-TRAN.                                  14430000
144400                                                                  14440000
144500     PERFORM D2000-INITIALIZE-FIELDS.                             14450000
144600                                                                  14460000
144700     PERFORM D3000-SELECT-STATE-TAX-CODE.                         14470000
144800*    INITIALIZE PV-TIME-HHMM-FMT PV-TIME-HHMM-FMT-X.              14480000
144900*    MOVE PV-SVD-STRT-TM(1:2) TO PV-TIME-HHMM-FMT-HH.             14490000
145000*    MOVE PV-SVD-STRT-TM(4:2) TO PV-TIME-HHMM-FMT-MM.             14500000
145100*    MOVE PV-TIME-HHMM-FMT TO PV-TIME-HHMM-FMT-X.                 14510000
145200                                                                  14520000
145300     PERFORM D4000-PROCESS-RET-ITMS                               14530000
145400       UNTIL PS-END-OF-RETRN-ITM-CSR                              14540000
145500          OR PS-ORIG-TRAN-INFO-CHNGD.                             14550000
145600                                                                  14560000
145700     SET PS-ORIG-TRAN-HASNT-CHNGD TO TRUE.                        14570000
145800                                                                  14580000
145900     PERFORM D5000-SELECT-TRN-VALUES.                             14590000
146000     PERFORM D6000-BUILD-ORDER-HEADER.                            14600000
146100                                                                  14610000
146200     PERFORM VARYING PV-RI-INDEX                                  14620000
146300        FROM +1 BY +1                                             14630000
146400         UNTIL (PT-RI-SKU (PV-RI-INDEX) = SPACES)                 14640000
146500            OR (PV-RI-INDEX > PC-MAX-RETURN-ITEMS)                14650000
146600               PERFORM D7000-BUILD-LINE-ITEM-MSGS                 14660000
146700     END-PERFORM.                                                 14670000
146800                                                                  14680000
146900     COMPUTE PV-REC-LENGTH = PV-REC-LENGTH + PC-24.               14690000
147000                                                                  14700000
147100     MOVE RO-RETURN-TRAN  TO PV-OUTPUT-RECORD.                    14710000
147200                                                                  14720000
147300     PERFORM W3000-WRITE-QUEUE-MSG-ATG.                           14730000
147400                                                                  14740000
147500     MOVE EPIRT-ORIG-SLS-DTE TO PV-SVD-SLS-DTE.                   14750000
147600     MOVE EPIRT-ORIG-STR-NBR TO PV-SVD-STR-NBR.                   14760000
147700     MOVE EPIRT-ORIG-RGST-ID TO PV-SVD-RGST-ID.                   14770000
147800     MOVE EPIRT-ORIG-TRN-NBR TO PV-SVD-TRN-NBR.                   14780000
147900     MOVE EPIRT-ORIG-STRT-TM TO PV-SVD-STRT-TM.                   14790000
148000     MOVE PV-ORIG-TRN-PARTN  TO PV-SVD-PARTN-NBR.                 14800000
148100                                                                  14810000
148200                                                                  14820000
148300***************************************************************** 14830000
148400* INITIALIZE THE FIELDS AND TABLES FOR PROCESSING                 14840000
148500***************************************************************** 14850000
148600 D2000-INITIALIZE-FIELDS.                                         14860000
148700                                                                  14870000
148800     MOVE ZEROS TO PV-TRAN-NET-CHRGD-AMT                          14880000
148900                   PV-TRAN-TAX-AMT                                14890000
149000                   PV-TRAN-TLD-AMT                                14900000
149100                   PV-TRAN-SUBTOTAL                               14910000
149200                   PV-TRAN-TOTAL-AMT                              14920000
149300                   PV-TRAN-SPCL-SVC-AMT                           14930000
149400                   PV-TRAN-SPCL-SVC-TAX-AMT                       14940000
149500                   PV-TRAN-SHIPPING-AMT                           14950000
149600                   PV-TRAN-SHIPPING-TAX-AMT                       14960000
149700                   PV-TRAN-TOTAL-FEE-AMT                          14970000
149800                   PV-TRAN-COMBINED-TAX-AMT.                      14980000
149900                                                                  14990000
150000     MOVE 'N' TO PS-ECOM-STR-SW                                   15000000
150100                 PS-REFUND-TENDER-SW.                             15010000
150200                                                                  15020000
150300     PERFORM VARYING PV-RI-INDEX                                  15030000
150400         FROM 1 BY 1 UNTIL PV-RI-INDEX > PC-MAX-RETURN-ITEMS      15040000
150500             MOVE SPACES TO PT-RI-SKU(PV-RI-INDEX)                15050000
150600             MOVE 'N'    TO PT-RI-SPCL-SVC-IND(PV-RI-INDEX)       15060000
150700             MOVE ZERO   TO PT-RI-QTY(PV-RI-INDEX)                15070000
150800                            PT-RI-NET-CHRGD-AMT(PV-RI-INDEX)      15080000
150900                            PT-RI-TAX-RATE(PV-RI-INDEX)           15090000
151000                            PT-RI-TAX-AMT(PV-RI-INDEX)            15100000
151100                            PT-RI-FEE-AMT(PV-RI-INDEX)            15110000
151200                            PT-RI-TLD-AMT(PV-RI-INDEX)            15120000
151300                            PT-RI-ORIG-LNE-ITM(PV-RI-INDEX)       15130000
151400     END-PERFORM.                                                 15140000
151500                                                                  15150000
151600     INITIALIZE PV-TNDR-TYP-CDE                                   15160000
151700                PV-TNDR-EXPRN-DTE                                 15170000
151800                PV-TNDR-ID.                                       15180000
151900                                                                  15190000
152000     MOVE 0 TO PV-RI-INDEX.                                       15200000
152100                                                                  15210000
152200                                                                  15220000
152300***************************************************************** 15230000
152400* SELECT STATE TAX CODE                                           15240000
152500***************************************************************** 15250000
152600 D3000-SELECT-STATE-TAX-CODE.                                     15260000
152700                                                                  15270000
152800     EXEC SQL                                                     15280000
152900       SELECT  ST_TX_RND_MTHD_CDE                                 15290000
153000         INTO :TSTATE-ST-TX-RND-MTHD-CDE                          15300000
153100         FROM  TSTATE  STE                                        15310000
153200              ,XST_LOC LOC                                        15320000
153300        WHERE  LOC.LOC_NBR        = :EPTRN-STR-NBR                15330000
153400          AND  LOC.ST_CDE         = STE.STATE_CODE                15340000
153500       WITH UR                                                    15350000
153600     END-EXEC.                                                    15360000
153700                                                                  15370000
153800     EVALUATE TRUE                                                15380000
153900         WHEN SQLCODE = ZERO                                      15390000
154000             CONTINUE                                             15400000
154100                                                                  15410000
154200         WHEN OTHER                                               15420000
154300             MOVE 'D3000-SELECT-STATE-TAX-CODE'                   15430000
154400                                  TO PV-PARAGRAPH-NAME            15440000
154500             MOVE 'TSTATE'        TO PV-DB2-TABLE-NAME            15450000
154600             MOVE 'ERROR SELECTING TAX CODE'                      15460000
154700                                  TO PV-DB2-OPERATION-MSG         15470000
154800             DISPLAY 'STR NBR = ' EPTRN-STR-NBR                   15480000
154900             DISPLAY 'DATE    = ' PV-POS-CCYY-MM-DD               15490000
155000             PERFORM Z2000-SQL-ABEND                              15500000
155100     END-EVALUATE.                                                15510000
155200                                                                  15520000
155300                                                                  15530000
155400***************************************************************** 15540000
155500* PROCESSES EACH ITEM RETURNED IN THE TRANSACTION THAT ORIGINATE  15550000
155600* AT AN E-STORE.  STORES THE INFORMATION IN AN INTERNAL TABLE.    15560000
155700***************************************************************** 15570000
155800 D4000-PROCESS-RET-ITMS.                                          15580000
155900                                                                  15590000
156000     ADD +1 TO PV-RI-INDEX.                                       15600000
156100                                                                  15610000
156200     COMPUTE EPITM-NET-CHRGD-AMT = (EPITM-NET-CHRGD-AMT * -1).    15620000
156300                                                                  15630000
156400     ADD  EPITM-NET-CHRGD-AMT TO   PV-TRAN-NET-CHRGD-AMT.         15640000
156500                                                                  15650000
156600     MOVE EPITM-NET-CHRGD-AMT TO                                  15660000
156700                             PT-RI-NET-CHRGD-AMT (PV-RI-INDEX).   15670000
156800                                                                  15680000
156900     COMPUTE EPITM-TX-AMT   = (EPITM-TX-AMT * -1).                15690000
157000     MOVE EPITM-TX-RT-PCT  TO  PT-RI-TAX-RATE  (PV-RI-INDEX).     15700000
157100     MOVE EPITM-TX-AMT     TO  PT-RI-TAX-AMT   (PV-RI-INDEX).     15710000
157200     ADD  EPITM-TX-AMT     TO  PV-TRAN-TAX-AMT.                   15720000
157300                                                                  15730000
157400     MOVE EPIRT-ORIG-LNE-ITM-NBR TO                               15740000
157500                         PT-RI-ORIG-LNE-ITM (PV-RI-INDEX).        15750000
157600     MOVE EPITM-SKU-NBR        TO  PT-RI-SKU (PV-RI-INDEX).       15760000
157700     MOVE EPITM-SLD-QTY        TO  PT-RI-QTY (PV-RI-INDEX).       15770000
157800     PERFORM D4200-DETERMINE-TLD-AMT.                             15780000
157900                                                                  15790000
158000     IF PT-RI-MISC-DEPT-CLASS (PV-RI-INDEX)                       15800000
158100** WE WILL ONLY HAVE SPECIAL SERVICES ON A RETURN TIED TO 099 10'S15810000
158200         PERFORM D4300-DETERMINE-SPEC-SVCS-AMT                    15820000
158300         PERFORM D4400-DETERMINE-SHIPPING-AMT                     15830000
158400     END-IF.                                                      15840000
158500                                                                  15850000
158600** CHECK FOR FEE AMOUNTS WHICH WILL BE KEPT ON THE TEPLIS TABLE.  15860000
158700     PERFORM D4500-DETERMINE-FEE-AMT.                             15870000
158800                                                                  15880000
158900*** WE ONLY WANT TO SEND TRUE 099 10 ITEMS TO BM.  GIFT WRAP SKUS 15890000
159000*** WILL BE SENT AS WELL BUT THE D/C/S WILL BE CHANGED TO THE GIFT15900000
159100*** WRAP SKU.  WE DO NOT WANT TO SEND THE DUMMY 099 10 SKUS'S     15910000
159200*** WE'VE CREATED FOR SHIPPING REFUNDS.                           15920000
159300                                                                  15930000
159400     IF PT-RI-MISC-DEPT-CLASS (PV-RI-INDEX)                       15940000
159500        IF NOT PT-RI-SPCL-SRVC-ITM (PV-RI-INDEX)                  15950000
159600           IF EPITM-NET-CHRGD-AMT = 0                             15960000
159700              INITIALIZE PT-RI-TBL-ROW (PV-RI-INDEX)              15970000
159800              SUBTRACT +1 FROM  PV-RI-INDEX                       15980000
159900           END-IF                                                 15990000
160000        END-IF                                                    16000000
160100     END-IF.                                                      16010000
160200                                                                  16020000
160300                                                                  16030000
160400     PERFORM C5000-FETCH-RTRN-ITM-CURSOR.                         16040000
160500                                                                  16050000
160600                                                                  16060000
160700***************************************************************** 16070000
160800* DETERMINES IF LOCATION ON XST_LOC HAS E_BUS_IND = 'Y'           16080000
160900***************************************************************** 16090000
161000 D4010-CHECK-IF-ESTORE.                                           16100000
161100                                                                  16110000
161200     SET PS-ECOM-STR-NBR-NO    TO TRUE.                           16120000
161300                                                                  16130000
161400     PERFORM VARYING ES-INDEX FROM 1 BY 1                         16140000
161500       UNTIL PS-ECOM-STR-NBR-YES                                  16150000
161600          OR (ES-INDEX > PV-ESTORE-COUNT)                         16160000
161700                                                                  16170000
161800           IF PV-STORE-NUMBER-NUM = ES-ESTORE-NUM(ES-INDEX)       16180000
161900              SET PS-ECOM-STR-NBR-YES   TO TRUE                   16190000
162000           END-IF                                                 16200000
162100                                                                  16210000
162200     END-PERFORM.                                                 16220000
162300                                                                  16230000
162400                                                                  16240000
162500***************************************************************** 16250000
162600* DETERMINES THE TLD AMOUND FOR AN ITEM.                          16260000
162700***************************************************************** 16270000
162800 D4200-DETERMINE-TLD-AMT.                                         16280000
162900                                                                  16290000
163000     EXEC SQL                                                     16300000
163100       SELECT  SUM(LID_AMT)                                       16310000
163200         INTO  :EPLID-LID-AMT                                     16320000
163300         FROM  TEPLID                                             16330000
163400        WHERE  PARTN_NBR          = :EPTRN-PARTN-NBR              16340000
163500         AND   STR_NBR            = :EPTRN-STR-NBR                16350000
163600         AND   RGST_ID            = :EPTRN-RGST-ID                16360000
163700         AND   TRN_NBR            = :EPTRN-TRN-NBR                16370000
163800         AND   STRT_TM            = :EPTRN-STRT-TM                16380000
163900         AND   SLS_CORR_SEQ_NBR   = :PV-DB2-SLS-CORR-SEQ-NBR      16390000
164000         AND   LNE_ITM_SEQ_NBR    = :EPITM-LNE-ITM-SEQ-NBR        16400000
164100         AND   LID_TYP_CDE   IN ('T', 'S', 'Q', 'R', 'I')         16410000
164200       WITH UR                                                    16420000
164300     END-EXEC.                                                    16430000
164400                                                                  16440000
164500     EVALUATE TRUE                                                16450000
164600         WHEN SQLCODE = ZERO                                      16460000
164700             ADD  EPLID-LID-AMT TO PV-TRAN-TLD-AMT                16470000
164800             MOVE EPLID-LID-AMT TO PT-RI-TLD-AMT (PV-RI-INDEX)    16480000
164900                                                                  16490000
165000         WHEN SQLCODE = +100 OR -305                              16500000
165100             MOVE ZEROS TO PT-RI-TLD-AMT (PV-RI-INDEX)            16510000
165200                                                                  16520000
165300         WHEN OTHER                                               16530000
165400             DISPLAY '              '                             16540000
165500             DISPLAY 'PARTN NBR   = ' EPTRN-PARTN-NBR             16550000
165600             DISPLAY 'STR NBR     = ' EPTRN-STR-NBR               16560000
165700             DISPLAY 'RGST ID     = ' EPTRN-RGST-ID               16570000
165800             DISPLAY 'TRN NBR     = ' EPTRN-TRN-NBR               16580000
165900             DISPLAY 'STRT-TM     = ' EPTRN-STRT-TM               16590000
166000             DISPLAY 'SLS CORR    = ' PV-DB2-SLS-CORR-SEQ-NBR     16600000
166100             DISPLAY 'LNE ITM SEQ = ' EPITM-LNE-ITM-SEQ-NBR       16610000
166200                                                                  16620000
166300             MOVE 'D4200-DETERMINE-TLD-AMT'                       16630000
166400                                  TO PV-PARAGRAPH-NAME            16640000
166500             MOVE 'TEPLID'        TO PV-DB2-TABLE-NAME            16650000
166600             MOVE 'ERROR SELECTING SUM OF TLD AMT'                16660000
166700                                  TO PV-DB2-OPERATION-MSG         16670000
166800                                                                  16680000
166900             PERFORM Z2000-SQL-ABEND                              16690000
167000     END-EVALUATE.                                                16700000
167100                                                                  16710000
167200                                                                  16720000
167300***************************************************************** 16730000
167400* DETERMINES THE SPECIAL SERVICES AMOUNT REFUNDED WITH AN ITEM.   16740000
167500* ONLY CONSIDER GIFT WRAP AMT HERE BECAUSE SHIPPING IS HANDLED    16750000
167600* SEPARATELY.                                                     16760000
167700***************************************************************** 16770000
167800 D4300-DETERMINE-SPEC-SVCS-AMT.                                   16780000
167900                                                                  16790000
168000     SET NOT-PT-RI-SPCL-SRVC-ITM(PV-RI-INDEX) TO TRUE.            16800000
168100                                                                  16810000
168200     EXEC SQL                                                     16820000
168300       SELECT  SRVC_AMT, TX_RT_PCT, TX_AMT                        16830000
168400         INTO  :EPLIS-SRVC-AMT, :EPLIS-TX-RT-PCT, :EPLIS-TX-AMT   16840000
168500         FROM  TEPLIS                                             16850000
168600        WHERE  PARTN_NBR          = :EPTRN-PARTN-NBR              16860000
168700         AND   STR_NBR            = :EPTRN-STR-NBR                16870000
168800         AND   RGST_ID            = :EPTRN-RGST-ID                16880000
168900         AND   TRN_NBR            = :EPTRN-TRN-NBR                16890000
169000         AND   STRT_TM            = :EPTRN-STRT-TM                16900000
169100         AND   SLS_CORR_SEQ_NBR   = :PV-DB2-SLS-CORR-SEQ-NBR      16910000
169200         AND   LNE_ITM_SEQ_NBR    = :EPITM-LNE-ITM-SEQ-NBR        16920000
169300         AND   SRVC_TYP_CDE       = 'W'                           16930000
169400       WITH UR                                                    16940000
169500     END-EXEC.                                                    16950000
169600                                                                  16960000
169700     EVALUATE TRUE                                                16970000
169800         WHEN SQLCODE = ZERO                                      16980000
169900            SET PT-RI-SPCL-SRVC-ITM (PV-RI-INDEX) TO TRUE         16990000
170000                                                                  17000000
170100            MOVE PC-GIFTWRAP-SKU TO PT-RI-SKU (PV-RI-INDEX)       17010000
170200                                                                  17020000
170300            COMPUTE EPLIS-SRVC-AMT = (EPLIS-SRVC-AMT * -1)        17030000
170400            COMPUTE EPLIS-TX-AMT   = (EPLIS-TX-AMT * -1)          17040000
170500                                                                  17050000
170600            ADD  EPLIS-SRVC-AMT  TO PV-TRAN-SPCL-SVC-AMT          17060000
170700            ADD  EPLIS-TX-AMT    TO PV-TRAN-SPCL-SVC-TAX-AMT      17070000
170800                                                                  17080000
170900            MOVE EPLIS-TX-AMT    TO PT-RI-TAX-AMT(PV-RI-INDEX)    17090000
171000            MOVE EPLIS-TX-RT-PCT TO PT-RI-TAX-RATE(PV-RI-INDEX)   17100000
171100            MOVE EPLIS-SRVC-AMT  TO                               17110000
171200                               PT-RI-NET-CHRGD-AMT(PV-RI-INDEX)   17120000
171300                                                                  17130000
171400         WHEN SQLCODE = +100 OR -305                              17140000
171500            SET NOT-PT-RI-SPCL-SRVC-ITM (PV-RI-INDEX) TO TRUE     17150000
171600                                                                  17160000
171700         WHEN OTHER                                               17170000
171800            DISPLAY '              '                              17180000
171900            DISPLAY 'PARTN NBR   = ' EPTRN-PARTN-NBR              17190000
172000            DISPLAY 'STR NBR     = ' EPTRN-STR-NBR                17200000
172100            DISPLAY 'RGST ID     = ' EPTRN-RGST-ID                17210000
172200            DISPLAY 'TRN NBR     = ' EPTRN-TRN-NBR                17220000
172300            DISPLAY 'STRT-TM     = ' EPTRN-STRT-TM                17230000
172400            DISPLAY 'SLS CORR    = ' PV-DB2-SLS-CORR-SEQ-NBR      17240000
172500            DISPLAY 'LNE ITM SEQ = ' EPITM-LNE-ITM-SEQ-NBR        17250000
172600                                                                  17260000
172700            MOVE 'D4300-DETERMINE-SPEC-SVCS-AMT'                  17270000
172800                                 TO PV-PARAGRAPH-NAME             17280000
172900             MOVE 'TEPLIS'       TO PV-DB2-TABLE-NAME             17290000
173000            MOVE 'ERROR SELECTING SUM OF SPCL SVCS'               17300000
173100                                 TO PV-DB2-OPERATION-MSG          17310000
173200                                                                  17320000
173300            PERFORM Z2000-SQL-ABEND                               17330000
173400     END-EVALUATE.                                                17340000
173500                                                                  17350000
173600                                                                  17360000
173700***************************************************************** 17370000
173800* DETERMINES THE SHIPPING AMOUNT REFUNDED.                        17380000
173900***************************************************************** 17390000
174000 D4400-DETERMINE-SHIPPING-AMT.                                    17400000
174100                                                                  17410000
174200     EXEC SQL                                                     17420000
174300       SELECT  SRVC_AMT, TX_AMT                                   17430000
174400         INTO  :EPLIS-SRVC-AMT, :EPLIS-TX-AMT                     17440000
174500         FROM  TEPLIS                                             17450000
174600        WHERE  PARTN_NBR          = :EPTRN-PARTN-NBR              17460000
174700         AND   STR_NBR            = :EPTRN-STR-NBR                17470000
174800         AND   RGST_ID            = :EPTRN-RGST-ID                17480000
174900         AND   TRN_NBR            = :EPTRN-TRN-NBR                17490000
175000         AND   STRT_TM            = :EPTRN-STRT-TM                17500000
175100         AND   SLS_CORR_SEQ_NBR   = :PV-DB2-SLS-CORR-SEQ-NBR      17510000
175200         AND   LNE_ITM_SEQ_NBR    = :EPITM-LNE-ITM-SEQ-NBR        17520000
175300         AND   SRVC_TYP_CDE       = 'S'                           17530000
175400       WITH UR                                                    17540000
175500     END-EXEC.                                                    17550000
175600                                                                  17560000
175700     EVALUATE TRUE                                                17570000
175800         WHEN SQLCODE = ZERO                                      17580000
175900             COMPUTE EPLIS-SRVC-AMT = (EPLIS-SRVC-AMT * -1)       17590000
176000             COMPUTE EPLIS-TX-AMT   = (EPLIS-TX-AMT * -1)         17600000
176100                                                                  17610000
176200             ADD  EPLIS-SRVC-AMT TO PV-TRAN-SHIPPING-AMT          17620000
176300             ADD  EPLIS-TX-AMT   TO PV-TRAN-SHIPPING-TAX-AMT      17630000
176400                                                                  17640000
176500         WHEN SQLCODE = +100 OR -305                              17650000
176600             CONTINUE                                             17660000
176700                                                                  17670000
176800         WHEN OTHER                                               17680000
176900             DISPLAY '              '                             17690000
177000             DISPLAY 'PARTN NBR   = ' EPTRN-PARTN-NBR             17700000
177100             DISPLAY 'STR NBR     = ' EPTRN-STR-NBR               17710000
177200             DISPLAY 'RGST ID     = ' EPTRN-RGST-ID               17720000
177300             DISPLAY 'TRN NBR     = ' EPTRN-TRN-NBR               17730000
177400             DISPLAY 'STRT-TM     = ' EPTRN-STRT-TM               17740000
177500             DISPLAY 'SLS CORR    = ' PV-DB2-SLS-CORR-SEQ-NBR     17750000
177600             DISPLAY 'LNE ITM SEQ = ' EPITM-LNE-ITM-SEQ-NBR       17760000
177700                                                                  17770000
177800             MOVE 'D4300-DETERMINE-SPEC-SVCS-AMT'                 17780000
177900                                  TO PV-PARAGRAPH-NAME            17790000
178000             MOVE 'TEPLIS'        TO PV-DB2-TABLE-NAME            17800000
178100             MOVE 'ERROR SELECTING SUM OF SPCL SVCS'              17810000
178200                                  TO PV-DB2-OPERATION-MSG         17820000
178300                                                                  17830000
178400             PERFORM Z2000-SQL-ABEND                              17840000
178500     END-EVALUATE.                                                17850000
178600                                                                  17860000
178700                                                                  17870000
178800***************************************************************** 17880000
178900* DETERMINES THE TOTAL FEES REFUNDED WITH AN ITEM.                17890000
179000***************************************************************** 17900000
179100 D4500-DETERMINE-FEE-AMT.                                         17910000
179200                                                                  17920000
179300     EXEC SQL                                                     17930000
179400       SELECT  SUM(SRVC_AMT)                                      17940000
179500         INTO  :EPLIS-SRVC-AMT                                    17950000
179600         FROM  TEPLIS                                             17960000
179700        WHERE  PARTN_NBR          = :EPTRN-PARTN-NBR              17970000
179800         AND   STR_NBR            = :EPTRN-STR-NBR                17980000
179900         AND   RGST_ID            = :EPTRN-RGST-ID                17990000
180000         AND   TRN_NBR            = :EPTRN-TRN-NBR                18000000
180100         AND   STRT_TM            = :EPTRN-STRT-TM                18010000
180200         AND   SLS_CORR_SEQ_NBR   = :PV-DB2-SLS-CORR-SEQ-NBR      18020000
180300         AND   LNE_ITM_SEQ_NBR    = :EPITM-LNE-ITM-SEQ-NBR        18030000
180400         AND   SRVC_TYP_CDE       = 'F'                           18040000
180500       WITH UR                                                    18050000
180600     END-EXEC.                                                    18060000
180700                                                                  18070000
180800     EVALUATE TRUE                                                18080000
180900         WHEN SQLCODE = ZERO                                      18090000
181000            COMPUTE EPLIS-SRVC-AMT = (EPLIS-SRVC-AMT * -1)        18100000
181100            MOVE EPLIS-SRVC-AMT  TO PT-RI-FEE-AMT (PV-RI-INDEX)   18110000
181200            ADD  EPLIS-SRVC-AMT  TO PV-TRAN-TOTAL-FEE-AMT         18120000
181300                                                                  18130000
181400         WHEN SQLCODE = +100 OR -305                              18140000
181500            MOVE ZEROES  TO  EPLIS-SRVC-AMT                       18150000
181600                                                                  18160000
181700         WHEN OTHER                                               18170000
181800            DISPLAY '              '                              18180000
181900            DISPLAY 'PARTN NBR   = ' EPTRN-PARTN-NBR              18190000
182000            DISPLAY 'STR NBR     = ' EPTRN-STR-NBR                18200000
182100            DISPLAY 'RGST ID     = ' EPTRN-RGST-ID                18210000
182200            DISPLAY 'TRN NBR     = ' EPTRN-TRN-NBR                18220000
182300            DISPLAY 'STRT-TM     = ' EPTRN-STRT-TM                18230000
182400            DISPLAY 'SLS CORR    = ' PV-DB2-SLS-CORR-SEQ-NBR      18240000
182500            DISPLAY 'LNE ITM SEQ = ' EPITM-LNE-ITM-SEQ-NBR        18250000
182600                                                                  18260000
182700            MOVE 'D4500-DETERMINE-FEE-AMT'                        18270000
182800                                 TO PV-PARAGRAPH-NAME             18280000
182900             MOVE 'TEPLIS'       TO PV-DB2-TABLE-NAME             18290000
183000            MOVE 'ERROR SELECTING SUM OF FEES'                    18300000
183100                                 TO PV-DB2-OPERATION-MSG          18310000
183200                                                                  18320000
183300            PERFORM Z2000-SQL-ABEND                               18330000
183400     END-EVALUATE.                                                18340000
183500                                                                  18350000
183600                                                                  18360000
183700***************************************************************** 18370000
183800* SELECTS TRANSACTION LEVEL INFORMATION FOR THE RETURN.           18380000
183900***************************************************************** 18390000
184000 D5000-SELECT-TRN-VALUES.                                         18400000
184100                                                                  18410000
184200     PERFORM D5100-RETRIEVE-BM-ORD-NBR-OPR.                       18420000
184300                                                                  18430000
184400     IF EPORD-ORD-NBR = ZEROS                                     18440000
184500        PERFORM D5110-SELECT-ORIG-SLS-DTE                         18450000
184600        IF PS-ORIG-SLS-DTE-FOUND                                  18460000
184700           MOVE EPPART-PARTN-NBR TO PV-SVD-PARTN-NBR              18470000
184800           MOVE EPECX-SLS-DTE TO PV-SVD-SLS-DTE                   18480000
184900           MOVE EPECX-STRT-TM TO PV-SVD-STRT-TM                   18490000
185000           PERFORM D5100-RETRIEVE-BM-ORD-NBR-OPR                  18500000
185100        ELSE                                                      18510000
185200           MOVE ZEROS TO EPORD-ORD-NBR                            18520000
185300       END-IF                                                     18530000
185400     END-IF.                                                      18540000
185500                                                                  18550000
185600     MOVE EPORD-ORD-NBR-TEXT TO PV-ORDER-NO.                      18560000
185700                                                                  18570000
185800     PERFORM D5300-DET-REFUND-TENDER.                             18580000
185900                                                                  18590000
186000     IF PS-CREDIT-CARD-REFUND                                     18600000
186100        PERFORM D5400-SLCT-CREDIT-CRD-INFO                        18610000
186200     END-IF.                                                      18620000
186300                                                                  18630000
186400*!!! COMPUTE PV-TRAN-SUBTOTAL = PV-TRAN-NET-CHRGD-AMT +           18640000
186500*!!!    PV-TRAN-SPCL-SVC-AMT + PV-TRAN-TLD-AMT.                   18650000
186600                                                                  18660000
186700     COMPUTE PV-TRAN-SUBTOTAL = PV-TRAN-NET-CHRGD-AMT +           18670000
186800        PV-TRAN-SPCL-SVC-AMT.                                     18680000
186900                                                                  18690000
187000     COMPUTE PV-TRAN-COMBINED-TAX-AMT = PV-TRAN-TAX-AMT +         18700000
187100             PV-TRAN-SPCL-SVC-TAX-AMT +                           18710000
187200             PV-TRAN-SHIPPING-TAX-AMT.                            18720000
187300                                                                  18730000
187400*!!! COMPUTE PV-TRAN-TOTAL-AMT = (PV-TRAN-SUBTOTAL +              18740000
187500*!!!      PV-TRAN-SHIPPING-AMT + PV-TRAN-COMBINED-TAX-AMT -       18750000
187600*!!!      PV-TRAN-TLD-AMT).                                       18760000
187700                                                                  18770000
187800     COMPUTE PV-TRAN-TOTAL-AMT = (PV-TRAN-SUBTOTAL +              18780000
187900          PV-TRAN-SHIPPING-AMT + PV-TRAN-COMBINED-TAX-AMT         18790000
188000                               + PV-TRAN-TOTAL-FEE-AMT).          18800000
188100                                                                  18810000
188200                                                                  18820000
188300***************************************************************** 18830000
188400* SELECTS THE BLUE MART ORDER NUMBER FROM THE OPERATIONAL DB FOR  18840000
188500* THE ORIG E-SALE TRANSACTION.                                    18850000
188600***************************************************************** 18860000
188700 D5100-RETRIEVE-BM-ORD-NBR-OPR.                                   18870000
188800                                                                  18880000
188900     INITIALIZE EPORD-ORD-NBR.                                    18890000
189000                                                                  18900000
189100     EXEC SQL                                                     18910000
189200       SELECT  ORD_NBR                                            18920000
189300         INTO  :EPORD-ORD-NBR                                     18930000
189400         FROM  TEPORD                                             18940000
189500        WHERE  PARTN_NBR          = :PV-SVD-PARTN-NBR             18950000
189600         AND   STR_NBR            = :PV-SVD-STR-NBR               18960000
189700         AND   RGST_ID            = :PV-SVD-RGST-ID               18970000
189800         AND   TRN_NBR            = :PV-SVD-TRN-NBR               18980000
189900         AND   STRT_TM            = :PV-SVD-STRT-TM               18990000
190000         AND  SLS_CORR_SEQ_NBR = (SELECT MAX(SLS_CORR_SEQ_NBR)    19000000
190100               FROM TEPORD WHERE  PARTN_NBR  = :PV-SVD-PARTN-NBR  19010000
190200                   AND  STR_NBR = :PV-SVD-STR-NBR                 19020000
190300                   AND  RGST_ID = :PV-SVD-RGST-ID                 19030000
190400                   AND  TRN_NBR = :PV-SVD-TRN-NBR                 19040000
190500                   AND  STRT_TM = :PV-SVD-STRT-TM)                19050000
190600       WITH UR                                                    19060000
190700     END-EXEC.                                                    19070000
190800                                                                  19080000
190900     EVALUATE TRUE                                                19090000
191000         WHEN SQLCODE = ZERO                                      19100000
191100             CONTINUE                                             19110000
191200                                                                  19120000
191300         WHEN SQLCODE = +100 OR -305                              19130000
191400             MOVE ZEROS TO EPORD-ORD-NBR                          19140000
191500*             DISPLAY 'OPERATIONAL ORDER NUMBER NOT FOUND!'       19150000
191600*             DISPLAY 'PARTN NBR = ' PV-SVD-PARTN-NBR             19160000
191700*             DISPLAY 'STR NBR   = ' PV-SVD-STR-NBR               19170000
191800*             DISPLAY 'RGST ID   = ' PV-SVD-RGST-ID               19180000
191900*             DISPLAY 'TRN NBR   = ' PV-SVD-TRN-NBR               19190000
192000*             DISPLAY 'STRT-TM   = ' PV-SVD-STRT-TM               19200000
192100                                                                  19210000
192200         WHEN OTHER                                               19220000
192300             DISPLAY '            '                               19230000
192400             DISPLAY 'PARTN NBR = ' PV-SVD-PARTN-NBR              19240000
192500             DISPLAY 'STR NBR   = ' PV-SVD-STR-NBR                19250000
192600             DISPLAY 'RGST ID   = ' PV-SVD-RGST-ID                19260000
192700             DISPLAY 'TRN NBR   = ' PV-SVD-TRN-NBR                19270000
192800             DISPLAY 'STRT-TM   = ' PV-SVD-STRT-TM                19280000
192900                                                                  19290000
193000             MOVE 'D5100-RETRIEVE-BM-ORD-NBR-OPR'                 19300000
193100                                  TO PV-PARAGRAPH-NAME            19310000
193200             MOVE 'TEPORD'        TO PV-DB2-TABLE-NAME            19320000
193300             MOVE 'ERROR SELECTING ORD # FROM OP'                 19330000
193400                                  TO PV-DB2-OPERATION-MSG         19340000
193500                                                                  19350000
193600             PERFORM Z2000-SQL-ABEND                              19360000
193700     END-EVALUATE.                                                19370000
193800                                                                  19380000
193900                                                                  19390000
194000***************************************************************** 19400000
194100* D5110-SELECT-ORIG-SLS-DTE                                       19410000
194200***************************************************************** 19420000
194300 D5110-SELECT-ORIG-SLS-DTE.                                       19430000
194400                                                                  19440000
194500        EXEC SQL                                                  19450000
194600                                                                  19460000
194700             SELECT A.PARTN_NBR                                   19470000
194800                   ,B.SLS_DTE                                     19480000
194900                   ,B.STRT_TM                                     19490000
195000             INTO  :EPPART-PARTN-NBR                              19500000
195100                  ,:EPECX-SLS-DTE                                 19510000
195200                  ,:EPECX-STRT-TM                                 19520000
195300             FROM   TEPPART A                                     19530000
195400                   ,TEPECX B                                      19540000
195500             WHERE A.SLS_DTE = B.SLS_DTE                          19550000
195600                   AND B.ORD_PARTN_NBR = :PV-SVD-PARTN-NBR        19560000
195700                   AND B.ORD_DTE = :PV-SVD-SLS-DTE                19570000
195800                   AND B.STR_NBR = :PV-SVD-STR-NBR                19580000
195900                   AND B.RGST_ID = :PV-SVD-RGST-ID                19590000
196000                   AND B.TRN_NBR = :PV-SVD-TRN-NBR                19600000
196100                   AND B.STRT_TM = :PV-SVD-STRT-TM                19610000
196200                   AND A.STR_GP_CDE = 'A'                         19620000
196300             WITH UR                                              19630000
196400           END-EXEC.                                              19640000
196500                                                                  19650000
196600       EVALUATE TRUE                                              19660000
196700                                                                  19670000
196800           WHEN SQLCODE = 0                                       19680000
196900                SET PS-ORIG-SLS-DTE-FOUND TO TRUE                 19690000
197000                                                                  19700000
197100           WHEN SQLCODE = PC-ROW-NOT-FOUND                        19710000
197200                SET PS-ORIG-SLS-DTE-NOT-FOUND TO TRUE             19720000
197300                                                                  19730000
197400           WHEN OTHER                                             19740000
197500                MOVE 'D5110-SELECT-ORIG-SLS-DTE'                  19750000
197600                            TO PV-PARAGRAPH-NAME                  19760000
197700                MOVE 'TEPECX'       TO PV-DB2-TABLE-NAME          19770000
197800                MOVE 'ERROR SELECTING TEPECX'                     19780000
197900                            TO PV-DB2-OPERATION-MSG               19790000
198000                DISPLAY 'STR NBR = ' EPIRT-ORIG-STR-NBR           19800000
198100                DISPLAY 'DATE    = ' EPIRT-ORIG-SLS-DTE           19810000
198200                PERFORM Z2000-SQL-ABEND                           19820000
198300      END-EVALUATE.                                               19830000
198400***************************************************************** 19840000
198500* DETERMINES IF THE REFUND IS CREDIT CARD AND IF NOT FLAGS IT AS  19850000
198600* A MAIL CHECK.                                                   19860000
198700*                                                                 19870000
198800* NOTE: THE ADDITIONAL CONDITION THAT TNDR AMT BE < 0 IS BECUASE  19880000
198900* A MIX MODE TRANSACTION RESULTING IN A CUSTOMER MAKING PAYMENT   19890000
199000* WOULD ALLOW A CREDIT CARD TO BE USED, BUT AS PAYMENT.  WE WOULD 19900000
199100* NOT WANT TO REFLECT THIS AS A CREDIT CARD REFUND.               19910000
199200***************************************************************** 19920000
199300 D5300-DET-REFUND-TENDER.                                         19930000
199400                                                                  19940000
199500     EXEC SQL                                                     19950000
199600         SELECT 'X'                                               19960000
199700           INTO :PV-DUMMY                                         19970000
199800            FROM  TEPTND                                          19980000
199900           WHERE                                                  19990000
200000              PARTN_NBR = :EPTRN-PARTN-NBR                        20000000
200100          AND STR_NBR = :EPTRN-STR-NBR                            20010000
200200          AND RGST_ID = :EPTRN-RGST-ID                            20020000
200300          AND TRN_NBR = :EPTRN-TRN-NBR                            20030000
200400          AND STRT_TM = :EPTRN-STRT-TM                            20040000
200500          AND SLS_CORR_SEQ_NBR = :PV-DB2-SLS-CORR-SEQ-NBR         20050000
200600          AND TNDR_VOID_IND = 'N'                                 20060000
254716          AND TNDR_TYP_CDE IN                                     20070004
PAYVEN          ('04', '05', '06', '07', '08', '16', '17', '22', '24')  20071010
200800          AND TNDR_AMT < 0                                        20080000
200900                                                                  20090000
201000     END-EXEC.                                                    20100000
201100                                                                  20110000
201200     EVALUATE TRUE                                                20120000
201300         WHEN SQLCODE = ZERO                                      20130000
201400         WHEN SQLCODE = -811                                      20140000
201500              SET PS-CREDIT-CARD-REFUND TO TRUE                   20150000
201600                                                                  20160000
201700         WHEN SQLCODE = +100 OR -305                              20170000
201800              SET PS-MAIL-CHECK-REFUND TO TRUE                    20180000
201900                                                                  20190000
202000         WHEN OTHER                                               20200000
202100             MOVE 'D5300-DET-REFUND-TENDER'                       20210000
202200                                  TO PV-PARAGRAPH-NAME            20220000
202300             MOVE 'TEPTND'        TO PV-DB2-TABLE-NAME            20230000
202400             MOVE 'ERROR IN DETERMINING REFUND TENDER'            20240000
202500                                  TO PV-DB2-OPERATION-MSG         20250000
202600             DISPLAY 'SQLCODE= ' SQLCODE                          20260000
202700             PERFORM Z2000-SQL-ABEND                              20270000
202800     END-EVALUATE.                                                20280000
202900                                                                  20290000
203000                                                                  20300000
203100***************************************************************** 20310000
203200* SINCE WE KNOW A CREDIT CARD WAS TENDERED, WE WANT TO RETRIEVE   20320000
203300* THE DATA TIED TO IT.                                            20330000
203400***************************************************************** 20340000
203500 D5400-SLCT-CREDIT-CRD-INFO.                                      20350000
203600                                                                  20360000
203700     EXEC SQL                                                     20370000
203800         SELECT TNDR_TYP_CDE                                      20380000
203900           INTO :PV-TNDR-TYP-CDE                                  20390000
204000            FROM  TEPTND TND                                      20400000
204100           WHERE                                                  20410000
204200              TND.PARTN_NBR = :EPTRN-PARTN-NBR                    20420000
204300          AND TND.STR_NBR   = :EPTRN-STR-NBR                      20430000
204400          AND TND.RGST_ID   = :EPTRN-RGST-ID                      20440000
204500          AND TND.TRN_NBR   = :EPTRN-TRN-NBR                      20450000
204600          AND TND.STRT_TM   = :EPTRN-STRT-TM                      20460000
204700          AND TND.SLS_CORR_SEQ_NBR = :PV-DB2-SLS-CORR-SEQ-NBR     20470000
204800          AND TND.TNDR_VOID_IND = 'N'                             20480000
254716          AND TND.TNDR_TYP_CDE IN                                 20490004
PAYVEN          ('04', '05', '06', '07', '08', '16', '17', '22', '24')  20493010
205000          AND TND.TNDR_AMT < 0                                    20500000
205100         WITH UR                                                  20510000
205200                                                                  20520000
205300     END-EXEC.                                                    20530000
205400                                                                  20540000
205500     EVALUATE TRUE                                                20550000
205600         WHEN SQLCODE = ZERO                                      20560000
205700         WHEN SQLCODE = -811                                      20570000
205800              CONTINUE                                            20580000
205900                                                                  20590000
206000         WHEN OTHER                                               20600000
206100             MOVE 'D5400-SLCT-CREDIT-CRD-INFO'                    20610000
206200                                  TO PV-PARAGRAPH-NAME            20620000
206300             MOVE 'TEPTND'        TO PV-DB2-TABLE-NAME            20630000
206400             MOVE 'ERROR IN SELECTING CREDIT CARD INFO'           20640000
206500                                  TO PV-DB2-OPERATION-MSG         20650000
206600             DISPLAY 'SQLCODE= ' SQLCODE                          20660000
206700             PERFORM Z2000-SQL-ABEND                              20670000
206800     END-EVALUATE.                                                20680000
206900                                                                  20690000
207000                                                                  20700000
207100***************************************************************** 20710000
207200* BUILDS THE RETURN TRANSACTION HEADER TO BE PUT TO THE BLUE MART 20720000
207300* QUEUE.  ALL FIELDS NOT PROVIDED ARE DOUBLE PIPED FOR BLUE MART. 20730000
207400***************************************************************** 20740000
207500 D6000-BUILD-ORDER-HEADER.                                        20750000
207600                                                                  20760000
207700     MOVE SPACES       TO RO-RETURN-TRAN-DETAIL.                  20770000
207800     MOVE ZERO         TO PV-REC-LENGTH.                          20780000
207900     SET PS-MQ-OK TO TRUE.                                        20790000
208000                                                                  20800000
208100     SET RO-RETURN-TRAN-INDX TO +1.                               20810000
208200                                                                  20820000
208300** FORMATS THE ORDER NUMBER                                       20830000
208400     MOVE EPORD-ORD-NBR-TEXT  TO PV-MISC-TEXT-FIELD.              20840000
208500                                                                  20850000
208600     IF PS-MQ-OK                                                  20860000
208700         PERFORM E1000-MOVE-TEXT-TO-OUTPUT                        20870000
208800     END-IF.                                                      20880000
208900                                                                  20890000
209000** PUTS IN THE NECESSARY PIPES TO NOTE WE ARE NOT PROVIDING FIELDS20900000
209100** IN THE BLUE MARTINI RETURN HEADER LAYOUT                       20910000
209200** FIELDS NOT BEING PASSED ARE: STATUS CODE, PARTH, CREATED FOR,  20920000
209300** BILL ADDRESS ID, PAY STATUS                                    20930000
209400     PERFORM E2000-INSERT-PIPES                                   20940000
209500       VARYING PV-CNTR FROM +1 BY +1                              20950000
209600         UNTIL PS-MQ-TOO-LARGE                                    20960000
209700            OR PV-CNTR = PC-6.                                    20970000
209800                                                                  20980000
209900** FORMATS PAY TYPE FIELD                                         20990000
210000     IF PS-CREDIT-CARD-REFUND                                     21000000
210100        MOVE PC-CREDIT-CARD   TO PV-MISC-TEXT-FIELD               21010000
210200     ELSE                                                         21020000
210300        MOVE PC-CHECK         TO PV-MISC-TEXT-FIELD               21030000
210400     END-IF.                                                      21040000
210500     IF PS-MQ-OK                                                  21050000
210600         PERFORM E1000-MOVE-TEXT-TO-OUTPUT                        21060000
210700     END-IF.                                                      21070000
210800                                                                  21080000
210900** PUTS IN THE NECESSARY PIPES TO NOTE WE ARE NOT PROVIDING FIELDS21090000
211000** IN THE BLUE MARTINI RETURN HEADER LAYOUT                       21100000
211100** FIELDS NOT BEING PASSED ARE: CREDIT CARD ID AND CURRENCY CODE  21110000
211200     PERFORM E2000-INSERT-PIPES                                   21120000
211300       VARYING PV-CNTR FROM +1 BY +1                              21130000
211400         UNTIL PS-MQ-TOO-LARGE                                    21140000
211500            OR PV-CNTR = PC-3.                                    21150000
211600                                                                  21160000
211700** FORMATS THE TRANSACTION SUBTOTAL AMOUNT                        21170000
211800     MOVE PV-TRAN-SUBTOTAL    TO PV-MISC-NUM-FIELD.               21180000
211900     IF PS-MQ-OK                                                  21190000
212000         PERFORM E3000-MOVE-NUM-TO-OUTPUT                         21200000
212100     END-IF.                                                      21210000
212200                                                                  21220000
212300** FORMATS THE TRANSACTION DISCOUNT AMOUNT                        21230000
212400     MOVE PV-TRAN-TLD-AMT TO PV-MISC-NUM-FIELD.                   21240000
212500     IF PS-MQ-OK                                                  21250000
212600         PERFORM E3000-MOVE-NUM-TO-OUTPUT                         21260000
212700     END-IF.                                                      21270000
212800                                                                  21280000
212900*** INSERTS PIPES TO NOTE WE ARE NOT PROVIDING FIELDS IN THE BLUE 21290000
213000*** MARTINI RETURN HEADER LAYOUT.  FIELD NOT PASSED: TOT SHIP AMT 21300000
213100     IF PS-MQ-OK                                                  21310000
213200         PERFORM E2000-INSERT-PIPES                               21320000
213300     END-IF.                                                      21330000
213400                                                                  21340000
213500** FORMATS THE TRANSACTION TOT TAX AMOUNT                         21350000
213600     MOVE PV-TRAN-COMBINED-TAX-AMT TO PV-MISC-NUM-FIELD.          21360000
213700     IF PS-MQ-OK                                                  21370000
213800         PERFORM E3000-MOVE-NUM-TO-OUTPUT                         21380000
213900     END-IF.                                                      21390000
214000                                                                  21400000
214100** FORMATS THE TRANSACTION TOTAL AMOUNT                           21410000
214200     MOVE PV-TRAN-TOTAL-AMT TO  PV-MISC-NUM-FIELD.                21420000
214300     IF PS-MQ-OK                                                  21430000
214400         PERFORM E3000-MOVE-NUM-TO-OUTPUT                         21440000
214500     END-IF.                                                      21450000
214600                                                                  21460000
214700** PUTS IN THE NECESSARY PIPES TO NOTE WE ARE NOT PROVIDING FIELDS21470000
214800** IN THE BLUE MARTINI RETURN HEADER LAYOUT                       21480000
214900** FIELDS NOT BEING PASSED ARE: PROMO CODE                        21490000
215000     IF PS-MQ-OK                                                  21500000
215100         PERFORM E2000-INSERT-PIPES                               21510000
215200     END-IF.                                                      21520000
215300                                                                  21530000
215400** FORMATS THE TRANSACTION SHIPPING REFUND                        21540000
215500     MOVE PV-TRAN-SHIPPING-AMT TO PV-MISC-NUM-FIELD.              21550000
215600     IF PS-MQ-OK                                                  21560000
215700         PERFORM E3000-MOVE-NUM-TO-OUTPUT                         21570000
215800     END-IF.                                                      21580000
215900                                                                  21590000
216000** FORMATS THE RETURN STORE NUMBER FOR OUTPUT.                    21600000
216100       MOVE EPTRN-STR-NBR TO PV-TEMP-NUMBER.                      21610000
216200       MOVE PV-TEMP-NUMBER TO PV-NUMBER-X.                        21620000
216300       MOVE ZEROS TO PV-ZERO-TALLY.                               21630000
216400       INSPECT PV-NUMBER-X TALLYING                               21640000
216500          PV-ZERO-TALLY FOR LEADING ZEROS.                        21650000
216600       COMPUTE PV-ZERO-TALLY = PV-ZERO-TALLY + 1.                 21660000
216700       COMPUTE PV-MOVE-FIELD-LENGTH = PC-4 - PV-ZERO-TALLY + 1.   21670000
216800       MOVE PV-NUMBER-X (PV-ZERO-TALLY:PV-MOVE-FIELD-LENGTH)      21680000
216900          TO PV-MISC-TEXT-FIELD.                                  21690000
217000     IF PS-MQ-OK                                                  21700000
217100         PERFORM E1000-MOVE-TEXT-TO-OUTPUT                        21710000
217200     END-IF.                                                      21720000
217300                                                                  21730000
217400** FORMATS THE RETURN TERMINAL NUMBER FOR OUTPUT                  21740000
217500       MOVE EPTRN-RGST-ID TO PV-TEMP-NUMBER.                      21750000
217600       MOVE PV-TEMP-NUMBER TO PV-NUMBER-X.                        21760000
217700       MOVE ZEROS TO PV-ZERO-TALLY.                               21770000
217800       INSPECT PV-NUMBER-X TALLYING                               21780000
217900          PV-ZERO-TALLY FOR LEADING ZEROS.                        21790000
218000       COMPUTE PV-ZERO-TALLY = PV-ZERO-TALLY + 1.                 21800000
218100       COMPUTE PV-MOVE-FIELD-LENGTH = PC-4 - PV-ZERO-TALLY + 1.   21810000
218200       MOVE PV-NUMBER-X (PV-ZERO-TALLY:PV-MOVE-FIELD-LENGTH)      21820000
218300          TO PV-MISC-TEXT-FIELD.                                  21830000
218400     IF PS-MQ-OK                                                  21840000
218500         PERFORM E1000-MOVE-TEXT-TO-OUTPUT                        21850000
218600     END-IF.                                                      21860000
218700                                                                  21870000
218800** FORMATS THE RETURN TRANSACTION NUMBER FOR OUTPUT               21880000
218900       MOVE EPTRN-TRN-NBR TO PV-TEMP-NUMBER.                      21890000
219000       MOVE PV-TEMP-NUMBER TO PV-NUMBER-X.                        21900000
219100       MOVE ZEROS TO PV-ZERO-TALLY.                               21910000
219200       INSPECT PV-NUMBER-X TALLYING                               21920000
219300          PV-ZERO-TALLY FOR LEADING ZEROS.                        21930000
219400       COMPUTE PV-ZERO-TALLY = PV-ZERO-TALLY + 1.                 21940000
219500       COMPUTE PV-MOVE-FIELD-LENGTH = PC-4 - PV-ZERO-TALLY + 1.   21950000
219600       MOVE PV-NUMBER-X (PV-ZERO-TALLY:PV-MOVE-FIELD-LENGTH)      21960000
219700          TO PV-MISC-TEXT-FIELD.                                  21970000
219800     IF PS-MQ-OK                                                  21980000
219900         PERFORM E1000-MOVE-TEXT-TO-OUTPUT                        21990000
220000     END-IF.                                                      22000000
220100                                                                  22010000
220200** SENDS DUMMY INFO TO TENDER FIELD WHEN CREDIT CARD FOUND        22020000
220300       IF PV-TNDR-TYP-CDE = SPACES                                22030000
220400           IF PS-MQ-OK                                            22040000
220500               PERFORM E2000-INSERT-PIPES                         22050000
220600           END-IF                                                 22060000
220700       ELSE                                                       22070000
220800           MOVE '01234567890' TO PV-MISC-TEXT-FIELD               22080000
220900           IF PS-MQ-OK                                            22090000
221000               PERFORM E1000-MOVE-TEXT-TO-OUTPUT                  22100000
221100           END-IF                                                 22110000
221200       END-IF.                                                    22120000
221300                                                                  22130000
221400** FORMATS THE CREDIT CARD TYPE CODE FOR OUTPUT IF IT EXISTS      22140000
221500       IF PV-TNDR-TYP-CDE = SPACES                                22150000
221600         IF PS-MQ-OK                                              22160000
221700             PERFORM E2000-INSERT-PIPES                           22170000
221800         END-IF                                                   22180000
221900       ELSE                                                       22190000
222000        MOVE PV-TNDR-TYP-CDE TO PV-MISC-TEXT-FIELD                22200000
222100           IF PS-MQ-OK                                            22210000
222200               PERFORM E1000-MOVE-TEXT-TO-OUTPUT                  22220000
222300           END-IF                                                 22230000
222400       END-IF.                                                    22240000
222500                                                                  22250000
222600** MOVES 0000 TO CREDIT CARD EXPIRATION DT FOR OUTPUT IF CREDIT   22260000
222700       IF PV-TNDR-TYP-CDE = SPACES                                22270000
222800         IF PS-MQ-OK                                              22280000
222900             PERFORM E2000-INSERT-PIPES                           22290000
223000         END-IF                                                   22300000
223100       ELSE                                                       22310000
223200        MOVE '0000' TO PV-MISC-TEXT-FIELD                         22320000
223300           IF PS-MQ-OK                                            22330000
223400               PERFORM E1000-MOVE-TEXT-TO-OUTPUT                  22340000
223500           END-IF                                                 22350000
223600       END-IF.                                                    22360000
223700                                                                  22370000
223800***************************************************************** 22380000
223900* BUILD LINE ITEM MSGS                                            22390000
224000***************************************************************** 22400000
224100 D7000-BUILD-LINE-ITEM-MSGS.                                      22410000
224200                                                                  22420000
224300** MOVES THE FIXED LINE ITEM HEADER TO OUTPUT FOR EACH ITEM       22430000
224400     MOVE PC-LINE-ITM-HEADER-FIXED TO PV-MISC-TEXT-FIELD          22440000
224500     IF PS-MQ-OK                                                  22450000
224600         PERFORM E1000-MOVE-TEXT-TO-OUTPUT                        22460000
224700     END-IF.                                                      22470000
224800                                                                  22480000
224900** FORMATS THE ORDER NUMBER                                       22490000
225000     MOVE EPORD-ORD-NBR-TEXT  TO PV-MISC-TEXT-FIELD.              22500000
225100                                                                  22510000
225200     IF PS-MQ-OK                                                  22520000
225300         PERFORM E1000-MOVE-TEXT-TO-OUTPUT                        22530000
225400     END-IF.                                                      22540000
225500                                                                  22550000
225600** FORMATS THE ORIG LINE ITEM SEQ NBR IF IT'S NOT 0 AS A RESULT   22560000
225700** OF A RETURN USING A GIFT RECEIPT, OTHERWISE SEND 0             22570000
225800     IF PT-RI-ORIG-LNE-ITM (PV-RI-INDEX) = 0                      22580000
225900        MOVE '0' TO RO-RETURN-TRAN-CHAR (RO-RETURN-TRAN-INDX)     22590000
226000        SET RO-RETURN-TRAN-INDX UP BY +1                          22600000
226100        ADD +1 TO PV-REC-LENGTH                                   22610000
226200        IF PV-REC-LENGTH > PC-MAX-QUEUE-CHARS                     22620000
226300            SET PS-MQ-TOO-LARGE TO TRUE                           22630000
226400        ELSE                                                      22640000
226500            IF PS-MQ-OK                                           22650000
226600                PERFORM E2000-INSERT-PIPES                        22660000
226700            END-IF                                                22670000
226800        END-IF                                                    22680000
226900     ELSE                                                         22690000
227000       MOVE PT-RI-ORIG-LNE-ITM (PV-RI-INDEX) TO PV-NUMBER-X       22700000
227100       MOVE ZEROS TO PV-ZERO-TALLY                                22710000
227200       INSPECT PV-NUMBER-X TALLYING                               22720000
227300          PV-ZERO-TALLY FOR LEADING ZEROS                         22730000
227400       COMPUTE PV-ZERO-TALLY = PV-ZERO-TALLY + 1                  22740000
227500       COMPUTE PV-MOVE-FIELD-LENGTH = PC-4 - PV-ZERO-TALLY + 1    22750000
227600       MOVE PV-NUMBER-X                                           22760000
227700                          (PV-ZERO-TALLY:PV-MOVE-FIELD-LENGTH)    22770000
227800          TO PV-MISC-TEXT-FIELD                                   22780000
227900       IF PS-MQ-OK                                                22790000
228000           PERFORM E1000-MOVE-TEXT-TO-OUTPUT                      22800000
228100       END-IF                                                     22810000
228200     END-IF.                                                      22820000
228300                                                                  22830000
228400** PUTS IN THE NECESSARY PIPES TO NOTE WE ARE NOT PROVIDING FIELDS22840000
228500** IN THE BLUE MARTINI RETURN HEADER LAYOUT                       22850000
228600** FIELDS NOT BEING PASSED ARE: STATUS CODE                       22860000
228700     IF PS-MQ-OK                                                  22870000
228800        PERFORM E2000-INSERT-PIPES                                22880000
228900     END-IF.                                                      22890000
229000                                                                  22900000
229100** FORMATS THE SKU                                                22910000
229200     MOVE PT-RI-SKU(PV-RI-INDEX) TO PV-MISC-TEXT-FIELD.           22920000
229300     IF PS-MQ-OK                                                  22930000
229400         PERFORM E1000-MOVE-TEXT-TO-OUTPUT                        22940000
229500     END-IF.                                                      22950000
229600                                                                  22960000
229700** PUTS IN THE NECESSARY PIPES TO NOTE WE ARE NOT PROVIDING FIELDS22970000
229800** IN THE BLUE MARTINI RETURN HEADER LAYOUT                       22980000
229900** FIELDS NOT BEING PASSED ARE: CURRENCY CODE                     22990000
230000     IF PS-MQ-OK                                                  23000000
230100        PERFORM E2000-INSERT-PIPES                                23010000
230200     END-IF.                                                      23020000
230300                                                                  23030000
230400** FORMATS THE QUANTITY                                           23040000
230500     MOVE PT-RI-QTY(PV-RI-INDEX) TO PV-MISC-TEXT-FIELD.           23050000
230600     IF PS-MQ-OK                                                  23060000
230700         PERFORM E1000-MOVE-TEXT-TO-OUTPUT                        23070000
230800     END-IF.                                                      23080000
230900                                                                  23090000
231000** PUTS IN THE NECESSARY PIPES TO NOTE WE ARE NOT PROVIDING FIELDS23100000
231100** IN THE BLUE MARTINI RETURN HEADER LAYOUT                       23110000
231200** FIELDS NOT BEING PASSED ARE: LIST PRICE                        23120000
231300     IF PS-MQ-OK                                                  23130000
231400        PERFORM E2000-INSERT-PIPES                                23140000
231500     END-IF.                                                      23150000
231600                                                                  23160000
231700** FORMATS THE SALE PRICE                                         23170000
231800                                                                  23180000
231900*!!! COMPUTE PV-SALE-PRICE =                                      23190000
232000*!!!  ( (PT-RI-NET-CHRGD-AMT (PV-RI-INDEX) +                      23200000
232100*!!!    PT-RI-TLD-AMT (PV-RI-INDEX)) / PT-RI-QTY(PV-RI-INDEX)     23210000
232200*!!!  ).                                                          23220000
232300                                                                  23230000
232400     IF PT-RI-QTY(PV-RI-INDEX) = 0                                23240000
232500         MOVE ZERO TO PV-SALE-PRICE                               23250000
232600         DISPLAY 'ZERO SALE PRICE'                                23260000
232700         DISPLAY 'PARTN NBR= ' EPTRN-PARTN-NBR                    23270000
232800         DISPLAY 'STR NBR= ' EPTRN-STR-NBR                        23280000
232900         DISPLAY 'RGST ID= ' EPTRN-RGST-ID                        23290000
233000         DISPLAY 'TRN NBR= ' EPTRN-TRN-NBR                        23300000
233100         DISPLAY 'STRT-TM= ' EPTRN-STRT-TM                        23310000
233200     ELSE                                                         23320000
233300         COMPUTE PV-SALE-PRICE =                                  23330000
233400             PT-RI-NET-CHRGD-AMT (PV-RI-INDEX)                    23340000
233500           / PT-RI-QTY(PV-RI-INDEX)                               23350000
233600     END-IF.                                                      23360000
233700                                                                  23370000
233800     MOVE PV-SALE-PRICE TO PV-MISC-NUM-FIELD.                     23380000
233900     IF PS-MQ-OK                                                  23390000
234000         PERFORM E3000-MOVE-NUM-TO-OUTPUT                         23400000
234100     END-IF.                                                      23410000
234200                                                                  23420000
234300** FORMATS THE EXTENDED PRICE                                     23430000
234400                                                                  23440000
234500     COMPUTE PV-ITEM-EXTENDED-PRICE =                             23450000
234600       (PV-SALE-PRICE * PT-RI-QTY(PV-RI-INDEX)).                  23460000
234700     MOVE PV-ITEM-EXTENDED-PRICE    TO PV-MISC-NUM-FIELD.         23470000
234800     IF PS-MQ-OK                                                  23480000
234900         PERFORM E3000-MOVE-NUM-TO-OUTPUT                         23490000
235000     END-IF.                                                      23500000
235100                                                                  23510000
235200** FORMATS THE TAX AMOUNT                                         23520000
235300     MOVE PT-RI-TAX-AMT (PV-RI-INDEX) TO PV-MISC-NUM-FIELD.       23530000
235400     IF PS-MQ-OK                                                  23540000
235500         PERFORM E3000-MOVE-NUM-TO-OUTPUT                         23550000
235600     END-IF.                                                      23560000
235700                                                                  23570000
235800** FORMATS THE TAX RATE                                           23580000
235900     MOVE PT-RI-TAX-RATE (PV-RI-INDEX) TO PV-MISC-PERCNT-FIELD.   23590000
236000     IF PS-MQ-OK                                                  23600000
236100         PERFORM E4000-MOVE-PRCNT-TO-OUTPUT                       23610000
236200     END-IF.                                                      23620000
236300                                                                  23630000
236400** FORMATS THE TOTAL AMOUNT                                       23640000
236500     COMPUTE PV-ITEM-TOTAL-AMOUNT =                               23650000
236600       (PV-ITEM-EXTENDED-PRICE + PT-RI-TAX-AMT (PV-RI-INDEX)      23660000
236700                               + PT-RI-FEE-AMT (PV-RI-INDEX)).    23670000
236800     MOVE PV-ITEM-TOTAL-AMOUNT TO PV-MISC-NUM-FIELD.              23680000
236900     IF PS-MQ-OK                                                  23690000
237000         PERFORM E3000-MOVE-NUM-TO-OUTPUT                         23700000
237100     END-IF.                                                      23710000
237200                                                                  23720000
237300                                                                  23730000
237400***************************************************************** 23740000
237500* MOVES TEXT VALUES TO THE OUTPUT RECORD BYTE BY BYE.             23750000
237600* IF AN EMPTY FIELD IS FOUND, THE FIELD WILL BE DOUBLE PIPED.     23760000
237700***************************************************************** 23770000
237800 E1000-MOVE-TEXT-TO-OUTPUT.                                       23780000
237900                                                                  23790000
238000     IF PV-MISC-TEXT-FIELD = ZEROS OR SPACES                      23800000
238100        MOVE '?' TO RO-RETURN-TRAN-CHAR (RO-RETURN-TRAN-INDX)     23810000
238200        SET RO-RETURN-TRAN-INDX UP BY +1                          23820000
238300        ADD +1 TO PV-REC-LENGTH                                   23830000
238400                                                                  23840000
238500        IF PV-REC-LENGTH > PC-MAX-QUEUE-CHARS                     23850000
238600            SET PS-MQ-TOO-LARGE TO TRUE                           23860000
238700        END-IF                                                    23870000
238800                                                                  23880000
238900     ELSE                                                         23890000
239000        SET PV-MISC-TEXT-CHAR-INDX TO +1                          23900000
239100                                                                  23910000
239200        PERFORM E1100-MOVE-TEXT-BY-BYTE                           23920000
239300          UNTIL PS-MQ-TOO-LARGE                                   23930000
239400             OR PV-MISC-TEXT-CHAR (PV-MISC-TEXT-CHAR-INDX)        23940000
239500                = SPACES OR LOW-VALUES                            23950000
239600                                                                  23960000
239700        MOVE '?' TO RO-RETURN-TRAN-CHAR (RO-RETURN-TRAN-INDX)     23970000
239800        SET RO-RETURN-TRAN-INDX UP BY +1                          23980000
239900        ADD +1 TO PV-REC-LENGTH                                   23990000
240000                                                                  24000000
240100        IF PV-REC-LENGTH > PC-MAX-QUEUE-CHARS                     24010000
240200            SET PS-MQ-TOO-LARGE TO TRUE                           24020000
240300        END-IF                                                    24030000
240400                                                                  24040000
240500     END-IF.                                                      24050000
240600                                                                  24060000
240700     MOVE SPACES TO PV-MISC-TEXT-FIELD.                           24070000
240800                                                                  24080000
240900                                                                  24090000
241000***************************************************************** 24100000
241100* MOVE TEXT BY BYTE                                               24110000
241200***************************************************************** 24120000
241300 E1100-MOVE-TEXT-BY-BYTE.                                         24130000
241400                                                                  24140000
241500     MOVE PV-MISC-TEXT-CHAR (PV-MISC-TEXT-CHAR-INDX) TO           24150000
241600             RO-RETURN-TRAN-CHAR (RO-RETURN-TRAN-INDX)            24160000
241700                                                                  24170000
241800     SET PV-MISC-TEXT-CHAR-INDX                                   24180000
241900         RO-RETURN-TRAN-INDX    UP BY +1                          24190000
242000                                                                  24200000
242100     ADD +1 TO PV-REC-LENGTH.                                     24210000
242200                                                                  24220000
242300     IF PV-REC-LENGTH > PC-MAX-QUEUE-CHARS                        24230000
242400         SET PS-MQ-TOO-LARGE TO TRUE                              24240000
242500     END-IF.                                                      24250000
242600                                                                  24260000
242700                                                                  24270000
242800***************************************************************** 24280000
242900* INSERT PIPES                                                    24290000
243000***************************************************************** 24300000
243100 E2000-INSERT-PIPES.                                              24310000
243200                                                                  24320000
243300     MOVE '?' TO RO-RETURN-TRAN-CHAR (RO-RETURN-TRAN-INDX)        24330000
243400                                                                  24340000
243500     SET RO-RETURN-TRAN-INDX UP BY +1                             24350000
243600                                                                  24360000
243700     ADD +1 TO PV-REC-LENGTH.                                     24370000
243800                                                                  24380000
243900     IF PV-REC-LENGTH > PC-MAX-QUEUE-CHARS                        24390000
244000        SET PS-MQ-TOO-LARGE TO TRUE                               24400000
244100     END-IF.                                                      24410000
244200                                                                  24420000
244300                                                                  24430000
244400***************************************************************** 24440000
244500* MOVE NUM TO OUTPUT                                              24450000
244600***************************************************************** 24460000
244700 E3000-MOVE-NUM-TO-OUTPUT.                                        24470000
244800                                                                  24480000
244900     SET PV-MISC-NUM-NBR-INDX TO +1.                              24490000
245000                                                                  24500000
245100     PERFORM E3100-MOVE-NUM-BY-BYTE                               24510000
245200       UNTIL PS-MQ-TOO-LARGE                                      24520000
245300          OR PV-MISC-NUM-NBR-INDX > PC-7.                         24530000
245400                                                                  24540000
245500     IF PS-MQ-OK                                                  24550000
245600         MOVE '?' TO RO-RETURN-TRAN-CHAR (RO-RETURN-TRAN-INDX)    24560000
245700         SET RO-RETURN-TRAN-INDX UP BY +1                         24570000
245800                                                                  24580000
245900         ADD +1 TO PV-REC-LENGTH                                  24590000
246000                                                                  24600000
246100         IF  PV-REC-LENGTH > PC-MAX-QUEUE-CHARS                   24610000
246200             SET PS-MQ-TOO-LARGE TO TRUE                          24620000
246300                                                                  24630000
246400         END-IF                                                   24640000
246500     END-IF.                                                      24650000
246600                                                                  24660000
246700     MOVE ZEROS TO PV-MISC-NUM-FIELD.                             24670000
246800                                                                  24680000
246900                                                                  24690000
247000***************************************************************** 24700000
247100* MOVE NUM BY BYTE                                                24710000
247200***************************************************************** 24720000
247300 E3100-MOVE-NUM-BY-BYTE.                                          24730000
247400                                                                  24740000
247500       IF PV-MISC-NUM-NBR-INDX = PC-DECIMAL-HOLDER                24750000
247600         MOVE '.' TO RO-RETURN-TRAN-CHAR(RO-RETURN-TRAN-INDX)     24760000
247700         SET RO-RETURN-TRAN-INDX     UP BY +1                     24770000
247800                                                                  24780000
247900         ADD +1 TO PV-REC-LENGTH                                  24790000
248000                                                                  24800000
248100         IF  PV-REC-LENGTH > PC-MAX-QUEUE-CHARS                   24810000
248200             SET PS-MQ-TOO-LARGE TO TRUE                          24820000
248300                                                                  24830000
248400         END-IF                                                   24840000
248500       END-IF.                                                    24850000
248600                                                                  24860000
248700       MOVE PV-MISC-NUM-NBR (PV-MISC-NUM-NBR-INDX) TO             24870000
248800            RO-RETURN-TRAN-CHAR (RO-RETURN-TRAN-INDX).            24880000
248900                                                                  24890000
249000       SET PV-MISC-NUM-NBR-INDX                                   24900000
249100           RO-RETURN-TRAN-INDX     UP BY +1.                      24910000
249200                                                                  24920000
249300       ADD +1 TO PV-REC-LENGTH.                                   24930000
249400                                                                  24940000
249500       IF  PV-REC-LENGTH > PC-MAX-QUEUE-CHARS                     24950000
249600           SET PS-MQ-TOO-LARGE TO TRUE                            24960000
249700       END-IF.                                                    24970000
249800                                                                  24980000
249900                                                                  24990000
250000***************************************************************** 25000000
250100* MOVE PRCNT TO OUTPUT                                            25010000
250200***************************************************************** 25020000
250300 E4000-MOVE-PRCNT-TO-OUTPUT.                                      25030000
250400                                                                  25040000
250500     IF PT-RI-TAX-AMT (PV-RI-INDEX) = ZEROS                       25050000
250600        MOVE '0' TO RO-RETURN-TRAN-CHAR (RO-RETURN-TRAN-INDX)     25060000
250700        SET RO-RETURN-TRAN-INDX UP BY +1                          25070000
250800                                                                  25080000
250900        MOVE '?' TO RO-RETURN-TRAN-CHAR (RO-RETURN-TRAN-INDX)     25090000
251000        SET RO-RETURN-TRAN-INDX UP BY +1                          25100000
251100                                                                  25110000
251200        ADD +2 TO PV-REC-LENGTH                                   25120000
251300                                                                  25130000
251400        IF  PV-REC-LENGTH > PC-MAX-QUEUE-CHARS                    25140000
251500            SET PS-MQ-TOO-LARGE TO TRUE                           25150000
251600        END-IF                                                    25160000
251700                                                                  25170000
251800     ELSE                                                         25180000
251900        SET PV-MISC-PCT-NBR-INDX TO +1                            25190000
252000        PERFORM E4100-MOVE-PCT-BY-BYTE                            25200000
252100          UNTIL PS-MQ-TOO-LARGE                                   25210000
252200             OR PV-MISC-PCT-NBR-INDX > PC-6                       25220000
252300                                                                  25230000
252400        IF PS-MQ-OK                                               25240000
252500            MOVE '?' TO RO-RETURN-TRAN-CHAR (RO-RETURN-TRAN-INDX) 25250000
252600            SET RO-RETURN-TRAN-INDX UP BY +1                      25260000
252700                                                                  25270000
252800            ADD +1 TO PV-REC-LENGTH                               25280000
252900                                                                  25290000
253000            IF  PV-REC-LENGTH > PC-MAX-QUEUE-CHARS                25300000
253100                SET PS-MQ-TOO-LARGE TO TRUE                       25310000
253200                                                                  25320000
253300             END-IF                                               25330000
253400        END-IF                                                    25340000
253500     END-IF.                                                      25350000
253600                                                                  25360000
253700     MOVE ZEROS TO PV-MISC-PERCNT-FIELD.                          25370000
253800                                                                  25380000
253900                                                                  25390000
254000***************************************************************** 25400000
254100* MOVE PCT BY BYTE                                                25410000
254200***************************************************************** 25420000
254300 E4100-MOVE-PCT-BY-BYTE.                                          25430000
254400                                                                  25440000
254500     MOVE PV-MISC-PCT-NBR (PV-MISC-PCT-NBR-INDX) TO               25450000
254600            RO-RETURN-TRAN-CHAR (RO-RETURN-TRAN-INDX).            25460000
254700                                                                  25470000
254800     SET PV-MISC-PCT-NBR-INDX                                     25480000
254900         RO-RETURN-TRAN-INDX     UP BY +1.                        25490000
255000                                                                  25500000
255100     ADD +1 TO PV-REC-LENGTH.                                     25510000
255200                                                                  25520000
255300     IF  PV-REC-LENGTH > PC-MAX-QUEUE-CHARS                       25530000
255400         SET PS-MQ-TOO-LARGE TO TRUE                              25540000
255500     END-IF.                                                      25550000
255600                                                                  25560000
255700     IF PV-MISC-PCT-NBR-INDX = PC-PERCENT-DECIMAL                 25570000
255800       MOVE '.' TO  RO-RETURN-TRAN-CHAR(RO-RETURN-TRAN-INDX)      25580000
255900       SET RO-RETURN-TRAN-INDX    UP BY +1                        25590000
256000                                                                  25600000
256100       ADD +1 TO PV-REC-LENGTH                                    25610000
256200                                                                  25620000
256300       IF  PV-REC-LENGTH > PC-MAX-QUEUE-CHARS                     25630000
256400           SET PS-MQ-TOO-LARGE TO TRUE                            25640000
256500                                                                  25650000
256600         END-IF                                                   25660000
256700     END-IF.                                                      25670000
256800                                                                  25680000
256900                                                                  25690000
257000******************************************************************25700000
257100* BACK OUT MQ                                                     25710000
257200******************************************************************25720000
257300 W2000-BACK-OUT-MQ.                                               25730000
257400                                                                  25740000
257500     CALL WS-MQBACK USING PV-HCONN                                25750000
257600                          PV-COMP-CODE                            25760000
257700                          PV-REASON.                              25770000
257800                                                                  25780000
257900     IF (PV-COMP-CODE NOT = MQCC-OK) THEN                         25790000
258000        MOVE 'W2000-BACK-OUT-MQ' TO PV-PARAGRAPH                  25800000
258100        MOVE 'MQBACK ERROR'      TO PV-ERROR-MESSAGE              25810000
258200                                                                  25820000
258300        PERFORM Z3000-DISPLAY-MQ-ERROR                            25830000
258400     END-IF.                                                      25840000
258500                                                                  25850000
258600                                                                  25860000
258700******************************************************************25870000
258800* PUT MESSAGE TO ATG QUEUE                                        25880000
258900******************************************************************25890000
259000 W3000-WRITE-QUEUE-MSG-ATG.                                       25900000
259100                                                                  25910000
259200     INITIALIZE PV-MSGBUFFER.                                     25920000
259300                                                                  25930000
259400     MOVE MQMI-NONE    TO MQMD-MSGID.                             25940000
259500     MOVE MQCI-NONE    TO MQMD-CORRELID.                          25950000
259600     MOVE MQFMT-STRING TO MQMD-FORMAT.                            25960000
259700                                                                  25970000
259800     COMPUTE MQPMO-CONTEXT = PV-PQ-Q2-HANDLE.                     25980000
259900     COMPUTE MQPMO-OPTIONS = MQPMO-SYNCPOINT.                     25990000
260000                                                                  26000000
260100     MOVE CC-BOX-NAME-ATG          TO MQOD-OBJECTQMGRNAME.        26010000
260200     MOVE CC-ATG-RETRN-QUEUE-NAME  TO MQOD-OBJECTNAME.            26020000
260300     MOVE PV-OUTPUT-RECORD         TO PV-MSGBUFFER.               26030000
260400     MOVE MQPER-PERSISTENT         TO MQMD-PERSISTENCE.           26040000
260500     MOVE PV-REC-LENGTH            TO PV-DATA-LENGTH.             26050000
260600                                                                  26060000
260700     CALL WS-MQPUT USING PV-HCONN                                 26070000
260800                         PV-FMT-OPEN-OUTPUT-HNDL1                 26080000
260900                         MQM-MESSAGE-DESCRIPTOR                   26090000
261000                         MQM-PUT-MESSAGE-OPTIONS                  26100000
261100                         PV-DATA-LENGTH                           26110000
261200                         PV-MSGBUFFER                             26120000
261300                         PV-COMP-CODE                             26130000
261400                         PV-REASON.                               26140000
261500                                                                  26150000
261600*        IF PUT FAILED THEN DISPLAY ERROR MESSAGE                 26160000
261700*        AND BREAK OUT OF LOOP                                    26170000
261800                                                                  26180000
261900     IF (PV-COMP-CODE NOT = MQCC-OK) THEN                         26190000
262000        IF (PV-REASON NOT = MQRC-PAGESET-FULL AND                 26200000
262100            PV-REASON NOT = MQRC-Q-FULL AND                       26210000
262200            PV-REASON NOT = MQRC-Q-SPACE-NOT-AVAILABLE )          26220000
262300                                                                  26230000
262400           MOVE 'W3000-WRITE-QUEUE-MSG-ATG' TO PV-PARAGRAPH       26240000
262500           MOVE 'MQPUT ERROR'               TO PV-ERROR-MESSAGE   26250000
262600           MOVE PV-REASON                   TO PV-SAVE-REASON     26260000
262700           MOVE PV-COMP-CODE                TO PV-SAVE-COMP-CODE  26270000
262800                                                                  26280000
262900           PERFORM W2000-BACK-OUT-MQ                              26290000
263000           PERFORM Z3000-DISPLAY-MQ-ERROR                         26300000
263100                                                                  26310000
263200        ELSE                                                      26320000
263300           ADD 1 TO PC-MQPUT-RETRY-COUNTER                        26330000
263400                                                                  26340000
263500           IF PC-MQPUT-RETRY-COUNTER >= 120                       26350000
263600             MOVE 'W3000-WRITE-QUEUE-MSG-ATG' TO PV-PARAGRAPH     26360000
263700             MOVE 'MQPUT ERROR- RETRY > 120 ' TO PV-ERROR-MESSAGE 26370000
263800             MOVE PV-REASON    TO PV-SAVE-REASON                  26380000
263900             MOVE PV-COMP-CODE TO PV-SAVE-COMP-CODE               26390000
264000                                                                  26400000
264100             PERFORM W2000-BACK-OUT-MQ                            26410000
264200             PERFORM Z3000-DISPLAY-MQ-ERROR                       26420000
264300                                                                  26430000
264400           ELSE                                                   26440000
264500*** WAIT FOR 15 SECONDS AND TRY AGAIN                             26450000
264600             CALL 'SYSWAIT' USING PC-DELAY-INTERVAL               26460000
264700                                                                  26470000
264800           END-IF                                                 26480000
264900        END-IF                                                    26490000
265000                                                                  26500000
265100     ELSE                                                         26510000
265200        SET PS-MQPUT-SUCCESSFUL TO TRUE                           26520000
265300        ADD 1                   TO PA-ROWS-PUT-ATG                26530000
265400     END-IF.                                                      26540000
265500                                                                  26550000
265600******************************************************************26560000
265700* BUILD THE COMMUNICATION AREA FOR A CALL TO THE TRANSACTION      26570000
265800* PRESENTATION MODULE                                             26580000
265900******************************************************************26590000
266000 X100-BUILD-COMM-AREA-TRAN-PRES.                                  26600000
266100                                                                  26610000
266200     MOVE LENGTH OF                                               26620000
266300          WORK-STORAGE-PASSED TO DP001-WORK-STRG-LENGTH.          26630000
266400     MOVE PC-CKPT-JOB-NAME    TO DP001-JOB-NAME.                  26640000
266500     MOVE PC-CKPT-PLAN-NAME   TO DP001-PLAN-NAME.                 26650000
266600                                                                  26660000
266700     PERFORM X200-CALL-TRANS-PRES-MODULE.                         26670000
266800                                                                  26680000
266900     MOVE DP001-TRANS-RECORD  TO SA012-BLUMART-REC.               26690000
267000     MOVE SA012-PARTN-NBR     TO EPTRN-PARTN-NBR.                 26700000
267100     MOVE SA012-SLS-DTE       TO EPTRN-SLS-DTE.                   26710000
267200     MOVE SA012-STR-NBR       TO EPTRN-STR-NBR.                   26720000
267300     MOVE SA012-RGST-ID       TO EPTRN-RGST-ID.                   26730000
267400     MOVE SA012-TRN-NBR       TO EPTRN-TRN-NBR.                   26740000
267500     MOVE SA012-STRT-TM       TO EPTRN-STRT-TM.                   26750000
267600                                                                  26760000
267700     IF  DP001-CKPT-TAKEN                                         26770000
267800         ADD 1 TO PA-CKPT                                         26780000
267900                                                                  26790000
268000         PERFORM X300-COMMIT-MQ                                   26800000
268100     END-IF.                                                      26810000
268200                                                                  26820000
268300                                                                  26830000
268400******************************************************************26840000
268500* VERIFY THE RETURN CODE ON THE CALLED MODULE                     26850000
268600******************************************************************26860000
268700 X200-CALL-TRANS-PRES-MODULE.                                     26870000
268800                                                                  26880000
268900     PERFORM Z900-CALL-TRANS-PRES-MODULE.                         26890000
269000                                                                  26900000
269100     IF  DP001-GOOD-RET-CODE                                      26910000
269200     OR  DP001-CKPT-TAKEN                                         26920000
269300     OR  DP001-RESTART                                            26930000
269400         CONTINUE                                                 26940000
269500                                                                  26950000
269600     ELSE                                                         26960000
269700         MOVE 'X200-CALL-TRANS-PRES-MODULE' TO PV-PARAGRAPH-NAME  26970000
269800         MOVE '** BAD CALL TO TRANS PREP MODULE **'               26980000
269900                                            TO PV-OPERATION-MSG-1 26990000
270000         MOVE DP001-RET-CODE                TO PV-RET-CODE        27000000
270100                                                                  27010000
270200         SET ABEND-4444-FORCED-ABEND TO TRUE                      27020000
270300                                                                  27030000
270400         PERFORM Z1000-ABEND                                      27040000
270500     END-IF.                                                      27050000
270600                                                                  27060000
270700                                                                  27070000
270800******************************************************************27080000
270900* COMMIT MQ PROCESSING SINCE THE POINT OF THE LAST COMMIT         27090000
271000******************************************************************27100000
271100 X300-COMMIT-MQ.                                                  27110000
271200                                                                  27120000
271300     CALL WS-MQCMIT USING PV-HCONN                                27130000
271400                          PV-COMP-CODE                            27140000
271500                          PV-REASON.                              27150000
271600                                                                  27160000
271700     IF (PV-COMP-CODE NOT = MQCC-OK) THEN                         27170000
271800        MOVE 'X300-COMMIT-MQ'   TO PV-PARAGRAPH                   27180000
271900        MOVE 'MQCMIT ERROR'     TO PV-ERROR-MESSAGE               27190000
272000        MOVE PV-COMP-CODE       TO PV-SAVE-COMP-CODE              27200000
272100        MOVE PV-REASON          TO PV-SAVE-REASON                 27210000
272200                                                                  27220000
272300        PERFORM W2000-BACK-OUT-MQ                                 27230000
272400     END-IF.                                                      27240000
272500                                                                  27250000
272600                                                                  27260000
272700******************************************************************27270000
272800* BUILD THE COMMUNICATION AREA FOR A CALL TO THE TRANSACTION      27280000
272900* PRESENTATION MODULE - USED FOR TRAN-PRES-FUNC-CLOSE ONLY        27290000
273000******************************************************************27300000
273100 X400-BUILD-COMM-AREA-TRAN-PRES.                                  27310000
273200                                                                  27320000
273300     MOVE LENGTH OF                                               27330000
273400          WORK-STORAGE-PASSED TO DP001-WORK-STRG-LENGTH.          27340000
273500     MOVE PC-CKPT-JOB-NAME    TO DP001-JOB-NAME.                  27350000
273600     MOVE PC-CKPT-PLAN-NAME   TO DP001-PLAN-NAME.                 27360000
273700                                                                  27370000
273800     PERFORM X200-CALL-TRANS-PRES-MODULE.                         27380000
273900                                                                  27390000
274000                                                                  27400000
274100******************************************************************27410000
274200* NON-DB2 ABEND                                                   27420000
274300******************************************************************27430000
274400 Z1000-ABEND.                                                     27440000
274500                                                                  27450000
274600     PERFORM Z9999-CONTROLS.                                      27460000
274700                                                                  27470000
274800     DISPLAY '                     '.                             27480000
274900     DISPLAY '** ABEND           **'.                             27490000
275000     DISPLAY '** PROGRAM         ** = ' PC-PGM-NAME.              27500000
275100     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        27510000
275200     DISPLAY '** MSG 1           ** = ' PV-OPERATION-MSG-1.       27520000
275300     DISPLAY '** MSG 2           ** = ' PV-OPERATION-MSG-2.       27530000
275400     DISPLAY '** RETURN CODE     ** = ' PV-RET-CODE.              27540000
275500                                                                  27550000
275600     CALL 'ILBOABN0' USING ABEND-CODE.                            27560000
275700                                                                  27570000
275800                                                                  27580000
275900***************************************************************** 27590000
276000* ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.    27600000
276100***************************************************************** 27610000
276200 Z2000-SQL-ABEND.                                                 27620000
276300                                                                  27630000
276400     PERFORM Z9999-CONTROLS.                                      27640000
276500                                                                  27650000
276600     DISPLAY '** ABEND     **'.                                   27660000
276700     DISPLAY '** PROGRAM   ** = ' PC-PGM-NAME.                    27670000
276800     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              27680000
276900     DISPLAY '** TABLE     ** = ' PV-DB2-TABLE-NAME.              27690000
277000     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-MSG.           27700000
277100     DISPLAY '** SQLCODE   ** = ' SQLCODE.                        27710000
277200                                                                  27720000
277300******************************************************************27730000
277400* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     27740000
277500* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      27750000
277600******************************************************************27760000
277700     COPY DPPD004.                                                27770000
277800                                                                  27780000
277900     SET ABEND-4013-DB2-ERROR TO TRUE.                            27790000
278000                                                                  27800000
278100     CALL 'ILBOABN0' USING ABEND-CODE.                            27810000
278200                                                                  27820000
278300                                                                  27830000
278400******************************************************************27840000
278500* DISPLAY MQ ERROR                                                27850000
278600******************************************************************27860000
278700 Z3000-DISPLAY-MQ-ERROR.                                          27870000
278800                                                                  27880000
278900     PERFORM Z9000-EOJ-ROUTINE.                                   27890000
279000                                                                  27900000
279100     CALL WS-MQCHECK USING PV-SAVE-REASON                         27910000
279200                           PV-MQ-REASON-TEXT.                     27920000
279300                                                                  27930000
279400     DISPLAY '                    '.                              27940000
279500     DISPLAY '** MQSERIES ERROR **'.                              27950000
279600     DISPLAY '** PROGRAM    = ' PC-PGM-NAME.                      27960000
279700     DISPLAY '** PARAGRAPH  = ' PV-PARAGRAPH.                     27970000
279800     DISPLAY '** MESSAGE    = ' PV-ERROR-MESSAGE.                 27980000
279900     DISPLAY '** COMP CODE  = ' PV-SAVE-COMP-CODE.                27990000
280000     DISPLAY '** RSN CODE   = ' PV-SAVE-REASON.                   28000000
280100     DISPLAY '                    '.                              28010000
280200                                                                  28020000
280300     SET ABEND-4020-MQ-ERROR TO TRUE.                             28030000
280400                                                                  28040000
280500     CALL 'ILBOABN0' USING ABEND-CODE.                            28050000
280600                                                                  28060000
280700                                                                  28070000
280800******************************************************************28080000
280900* PREFORMS TASK TERMINATION PROCESSING                            28090000
281000******************************************************************28100000
281100 Z9000-EOJ-ROUTINE.                                               28110000
281200                                                                  28120000
281300     MOVE PC-TRAN-PRES-FUNC-CLOSE TO DP001-FUNC-CODE.             28130000
281400     PERFORM X400-BUILD-COMM-AREA-TRAN-PRES.                      28140000
281500                                                                  28150000
281600     PERFORM Z9999-CONTROLS.                                      28160000
281700                                                                  28170000
281800                                                                  28180000
281900******************************************************************28190000
282000* DISPLAY CONTROLS FROM THE PROGRAM                               28200000
282100******************************************************************28210000
282200 Z9999-CONTROLS.                                                  28220000
282300                                                                  28230000
282400     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 28240000
282500                                                                  28250000
282600     MOVE SYS-TIME (1:2) TO ST-END-HR.                            28260000
282700     MOVE SYS-TIME (3:2) TO ST-END-MN.                            28270000
282800                                                                  28280000
282900     DISPLAY '                    '.                              28290000
283000     DISPLAY '**********************'.                            28300000
283100     DISPLAY '   SAKUP009 CONTROLS  '.                            28310000
283200     DISPLAY '**********************'.                            28320000
283300     DISPLAY 'RUN DATE  = ' SD-EDIT-DATE.                         28330000
283400     DISPLAY 'BEG TIME  = ' ST-BEG-TIME.                          28340000
283500     DISPLAY 'END TIME  = ' ST-END-TIME.                          28350000
283600     DISPLAY '======================'.                            28360000
283700     DISPLAY 'RECORDS READ = ' PA-READ.                           28370000
283800     DISPLAY 'CHECKPOINTS  = ' PA-CKPT.                           28380000
283900     DISPLAY '                '.                                  28390000
284000     DISPLAY 'ROWS PUT TO ATG QUEUE = ' PA-ROWS-PUT-ATG.          28400000
284100     DISPLAY '                '.                                  28410000
284200                                                                  28420000
284300                                                                  28430000
284400******************************************************************28440000
284500* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    28450000
284600* MENTS THAT ARE REQUIRED TO INVOKE THE TRANSACTION PRESENTATION  28460000
284700* MODULE (DPKUT901) OF THE DB2 CHECKPOINT RESTART SYSTEM.         28470000
284800******************************************************************28480000
284900     COPY DPPD001.                                                28490000
285000                                                                  28500000
285100                                                                  28510000
