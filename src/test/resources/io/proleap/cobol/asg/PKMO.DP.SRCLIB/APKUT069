000100 IDENTIFICATION DIVISION.                                         00010003
000200 PROGRAM-ID.     APKUT069.                                        00020003
000300 AUTHOR.         R BERNOSKI.                                      00030003
000400*DATE-WRITTEN.   MAY 20, 1998.                                    00040003
000500*DATE-COMPILED.                                                   00050003
000600*************************************************************     00060003
000700*    COBOL 2 WITH SQL                                       *     00070003
000800*                                                           *     00080003
000900*       EXTRACT REMAINDER INVOICES THAT WERE LAST UPDATED   *     00090004
001000*       BEFORE THE CUTOFF DATE SELECTED IN THE PROGRAM.     *     00100004
001100*       THE CUTOFF DATE IS SELECTED BY SUBTRACTING X        *     00110004
001200*       NUMBER OF DAYS FROM THE APCNTL-BTCH-PRCS-DTE.       *     00120004
001300*                                                           *     00130003
001400* INPUT:                                                    *     00140003
001500* 1.  INVOICES WITH ENTERED STATUS THAT MEET DATE CRITERIA. *     00150003
001600*     TINVOIC - INVOICE TABLE                               *     00160003
001700*                                                           *     00170003
001800* OUTPUT:                                                   *     00180003
001900* 1.  OUTPUT WILL CONTAIN DATA FOR INVOICES TO BE DELETED   *     00190003
002000*     COPYBOOK APRD067                                      *     00200004
002100*************************************************************     00210003
002200* CHANGE LOG:                                               *     00220003
002300*                                                           *     00230003
002400* 05/01/98    INITIAL VERSION.                              *     00240003
002500* 02/23/01    CHANGED NUMBER OF DAYS TO USE IN THE CUTOFF   *     00250004
002600*             DATE CALCULATION FROM 120 TO 150.             *     00260004
002700*                                                           *     00270003
002800* 06/17/2002                                                *     00280005
002900*    ARK PO PROJECT PHASE 1.  RECOMPILE FROM PRODUCTION.    *     00290005
003000* MADE BY: KEVIN CATLIN                    WR# 23500        *     00300005
003100*                                                           *     00310005
003200* 06/20/2002                                                *     00320007
003300*    ARK PO PROJECT PHASE 1.  REMOVED ALL REFERENCES TO     *     00330006
003400*    TABLE TPAYREQ.                                         *     00340006
003500* MADE BY: KEVIN CATLIN                    WR# 23500        *     00350006
003600*                                                           *     00360008
003700* DATE  03/11/2007                                          *     00370012
003800*     CHANGE MADE: MATCH BY DC PROJECT                      *     00380008
003900*     ADDED DC_NBR & MTCH_LVL_CDE TO THE CURSOR AND FETCH.  *     00390008
004000*     ADDED CODE IN B200- TO MOVE THESE FIELDS TO THE       *     00400008
004100*     APRD067 COPYBOOK FORMATTED EXTRACT FILE.              *     00410008
004200*     MADE BY: MIKE BESKE              WR/IR #: WR21578     *     00420008
004300*                                                           *     00430008
004310* DATE   04/26/2013                                         *     00431013
004311*     CHANGE MADE: CHANGED NUMBER OF DAYS TO USE IN THE     *     00431113
004312*     CUTOFF DATE CALCULATION FROM 150 TO 365.              *     00431213
004320*     MADE BY: COGNIZANT               WR/IR #: WR39930     *     00432013
004321*                                                           *     00432115
004322* DATE  11/14/2014                                          *     00433015
004323*      RECOMPILED THE PROGRAM. CHANGES WERE MADE TO APRD067 *     00434015
004324*      COPYBOOK.                                            *     00435015
004325*      MADE BY: COGNIZANT              WR/IR: CHG0094517    *     00436015
004400*************************************************************     00440003
004500                                                                  00450003
004600 ENVIRONMENT DIVISION.                                            00460003
004700                                                                  00470003
004800 INPUT-OUTPUT SECTION.                                            00480003
004900                                                                  00490003
005000 FILE-CONTROL.                                                    00500003
005100                                                                  00510003
005200     SELECT APOUT-APULL-FILE                                      00520003
005300         ASSIGN         TO UT-S-OUT01.                            00530003
005400                                                                  00540003
005500 DATA DIVISION.                                                   00550003
005600                                                                  00560003
005700 FILE SECTION.                                                    00570003
005800                                                                  00580003
005900 FD  APOUT-APULL-FILE                                             00590003
006000         LABEL RECORDS  ARE STANDARD                              00600003
006100         RECORDING MODE IS  F                                     00610003
006200         DATA RECORD    IS  APOUT-APULL-RECORD.                   00620003
006300                                                                  00630003
006400 01  APOUT-APULL-RECORD            PIC X(80).                     00640003
006500                                                                  00650003
006600/                                                                 00660003
006700 WORKING-STORAGE SECTION.                                         00670003
006800                                                                  00680003
006900 01  FILLER                        PIC X(25) VALUE                00690003
007000                             'WS FOR APKUT069 BEGINS==>'.         00700003
007100                                                                  00710003
007200 01  RMNDR-INV-TMST.                                              00720003
007300     05 RI-DATE                    PIC X(10) VALUE SPACES.        00730003
007400     05 RI-TIME                    PIC X(16) VALUE                00740003
007500                                       '-00.00.00.000000'.        00750003
007600                                                                  00760003
007700 01  RI-TMST                       PIC X(26) VALUE SPACES.        00770003
007800                                                                  00780003
007900 01  WS-RETRY-COUNTER              PIC S9(4) COMP VALUE ZERO.     00790003
008000 01  WS-RETRY-MAX                  PIC S9(4) COMP VALUE 3.        00800003
008100                                                                  00810003
008200 01  WS-SWITCH-AREA.                                              00820003
008300     05  WS-FETCH-END-SW           PIC X(03)  VALUE 'NO '.        00830003
008400         88  WS-END-OF-FETCH                  VALUE 'YES'.        00840003
008500         88  WS-NOT-END-OF-FETCH              VALUE 'NO '.        00850003
008600                                                                  00860003
008700                                                                  00870003
008800*                                                                 00880003
008900 01  WS-PROGRAM-COUNTERS.                                         00890003
009000     05  WS-APOUT-REC-CNT        PIC S9(09)   VALUE ZEROS.        00900003
009100     05  WS-ROWS-FETCHED         PIC S9(05) VALUE ZEROS.          00910010
009200     05  WS-RECORDS-WRITTEN      PIC S9(05) VALUE ZEROS.          00920010
009300     05  WS-ROWS-FETCHED-9       PIC ZZZZ9.                       00930010
009400     05  WS-RECORDS-WRITTEN-9    PIC ZZZZ9.                       00940010
009500                                                                  00950003
009600     COPY DPWS004.                                                00960003
009700                                                                  00970003
009800     COPY APRD067.                                                00980003
009900                                                                  00990003
010000 01  FILLER                      PIC X(35)  VALUE                 01000003
010100     'END OF AP WORK RECORD AREA       **'.                       01010003
010200                                                                  01020003
010300 01  WS-ABEND-FIELDS.                                             01030003
010400     05  WS-ABEND-PROGRAM             PIC X(8)  VALUE 'APKUT069'. 01040003
010500     05  WS-ABEND-PARAGRAPH           PIC X(50) VALUE SPACES.     01050003
010600     05  WS-ABEND-OPERATION           PIC X(50) VALUE SPACES.     01060003
010700     05  WS-ABEND-STRUCTURE-1         PIC X(8)  VALUE SPACES.     01070003
010800     05  WS-ABEND-STRUCTURE-2         PIC X(8)  VALUE SPACES.     01080003
010900     05  WS-ABEND-STATUS              PIC XX    VALUE SPACES.     01090003
011000                                                                  01100003
011100 01  ABEND-CODE                    PIC S9(4) COMP SYNC            01110003
011200                                             VALUE ZEROS.         01120003
011300     88 AP-TABLE-FULL              VALUE +4004.                   01130003
011400     88 AP-EMPTY-FILE              VALUE +4005.                   01140003
011500     88 AP-DB2-ERROR               VALUE +4013.                   01150003
011600                                                                  01160003
011700******************************************************************01170003
011800*  COMMUNICATIONS AREA2 FOR DB2                                   01180003
011900******************************************************************01190003
012000     COPY SQLCA2.                                                 01200003
012100                                                                  01210003
012200                                                                  01220003
012300     EXEC SQL                                                     01230003
012400          INCLUDE SQLCA                                           01240003
012500     END-EXEC.                                                    01250003
012600                                                                  01260003
012700                                                                  01270003
012800     EXEC SQL                                                     01280003
012900          INCLUDE TINVOIC                                         01290003
013000     END-EXEC.                                                    01300003
013100                                                                  01310003
013200                                                                  01320003
013300     EXEC SQL                                                     01330003
013400          INCLUDE TAPCNTL                                         01340003
013500     END-EXEC.                                                    01350003
013600                                                                  01360003
013700                                                                  01370003
013800     EXEC SQL                                                     01380003
013900          DECLARE TINVOIC_CSR CURSOR FOR                          01390003
014000            SELECT                                                01400003
014100               PO_NBR                                             01410006
014200              ,INVC_ID                                            01420006
014300              ,PAYT_REQ_SEQ_NBR                                   01430006
014400              ,INVC_TYP_CDE                                       01440006
014500              ,GRO_COST_AMT                                       01450006
014600              ,STR_NBR                                            01460006
014700              ,STATUS_CDE                                         01470006
014800              ,STATUS_CHG_TMST                                    01480006
014900              ,DC_NBR                                             01490008
015000              ,MTCH_LVL_CDE                                       01500008
015100            FROM                                                  01510003
015200               TINVOIC                                            01520006
015300            WHERE                                                 01530003
015400                   STATUS_CDE       =  'EN'                       01540006
015500              AND  INVC_TYP_CDE     =  'RI'                       01550006
015600              AND  STATUS_CHG_TMST  <  :RI-TMST                   01560006
015700     END-EXEC.                                                    01570003
015800****                                                              01580003
015900                                                                  01590003
016000 01  FILLER                        PIC X(25) VALUE                01600003
016100          '<====WS FOR APKUT069 ENDS'.                            01610003
016200                                                                  01620003
016300*LINKAGE SECTION.                                                 01630003
016400                                                                  01640003
016500                                                                  01650003
016600 PROCEDURE DIVISION.                                              01660003
016700                                                                  01670003
016800 A100-MAINLINE.                                                   01680003
016900                                                                  01690003
017000     PERFORM B100-HOUSEKEEPING                                    01700003
017100     PERFORM B200-PROCESSING                                      01710003
017200             UNTIL WS-END-OF-FETCH                                01720003
017300                                                                  01730003
017400     PERFORM B300-END-OF-JOB                                      01740003
017500                                                                  01750003
017600     GOBACK.                                                      01760003
017700        EJECT                                                     01770003
017800                                                                  01780003
017900 B100-HOUSEKEEPING.                                               01790003
018000*                                                                 01800003
018100***************************************************************** 01810003
018200*    CALCULATE DATE USED FOR DELETING INOVICES BASED ON THE     * 01820003
018300*    BTCH_PRC_DTE FROM TAPCNTL TABLE.                           * 01830003
018400***************************************************************** 01840003
018500*                                                                 01850003
018600     OPEN  OUTPUT  APOUT-APULL-FILE.                              01860003
018700                                                                  01870003
018800     INITIALIZE DCLTINVOIC                                        01880006
018900                DCLTAPCNTL.                                       01890006
019000                                                                  01900003
019100     EXEC SQL                                                     01910003
019200         SELECT (BTCH_PRC_DTE - 365 DAYS)                         01920013
019300         INTO   :RI-DATE                                          01930003
019400         FROM   TAPCNTL                                           01940003
019500     END-EXEC.                                                    01950003
019600                                                                  01960003
019700     MOVE RMNDR-INV-TMST TO RI-TMST                               01970003
019800                                                                  01980003
019900     DISPLAY RI-TMST                                              01990003
020000                                                                  02000003
020100     PERFORM Y100-OPEN-CURSOR.                                    02010003
020200     PERFORM R100-FETCH-INVOIC.                                   02020003
020300     IF   WS-END-OF-FETCH                                         02030003
020400          DISPLAY '**********************************'            02040003
020500          DISPLAY '*   EMPTY INVOICE TABLE          *'            02050003
020600          DISPLAY '*   PROGRAM ** = APKUT069        *'            02060003
020700          DISPLAY '**********************************'            02070003
020800     END-IF.                                                      02080003
020900                                                                  02090003
021000                                                                  02100003
021100 B200-PROCESSING.                                                 02110003
021200*                                                                 02120003
021300***************************************************************** 02130003
021400*              FORMAT INVOICES TO OUTPUT LAYOUT                 * 02140003
021500***************************************************************** 02150003
021600*                                                                 02160003
021700     MOVE INVOIC-PAYT-REQ-SEQ-NBR TO AP067-PAYT-REQ-SEQ-NBR.      02170003
021800     MOVE INVOIC-PO-NBR           TO AP067-PO-NBR.                02180006
021900     MOVE INVOIC-INVC-ID          TO AP067-INVC-ID.               02190003
022000     MOVE INVOIC-STATUS-CDE       TO AP067-STATUS-CDE.            02200003
022100     MOVE INVOIC-GRO-COST-AMT     TO AP067-GRO-COST-AMT.          02210003
022200     MOVE INVOIC-STR-NBR          TO AP067-STR-NBR.               02220003
022300     MOVE INVOIC-STATUS-CHG-TMST  TO AP067-STATUS-CHG-TMST.       02230008
022400     MOVE INVOIC-INVC-TYP-CDE     TO AP067-INVC-TYP-CDE.          02240008
022500     MOVE INVOIC-DC-NBR           TO AP067-DC-NBR.                02250008
022600     MOVE INVOIC-MTCH-LVL-CDE     TO AP067-MTCH-LVL-CDE.          02260008
022700                                                                  02270003
022800                                                                  02280003
022900     PERFORM W100-WRITE-OUTPUT                                    02290003
023000     PERFORM R100-FETCH-INVOIC.                                   02300003
023100                                                                  02310003
023200 B300-END-OF-JOB.                                                 02320003
023300*                                                                 02330003
023400***************************************************************** 02340003
023500*     FINISH THE ERROR PROCESS, REPORT ON NECESSARY TOTALS,       02350003
023600*     AND CLOSE ALL FILES                                         02360003
023700***************************************************************** 02370003
023800*                                                                 02380003
023900     MOVE WS-ROWS-FETCHED    TO WS-ROWS-FETCHED-9.                02390010
024000     MOVE WS-RECORDS-WRITTEN TO WS-RECORDS-WRITTEN-9.             02400010
024100     DISPLAY 'ROWS FETCHED = ' WS-ROWS-FETCHED-9.                 02410010
024200     DISPLAY 'RECORDS WRITTEN = ' WS-RECORDS-WRITTEN-9.           02420011
024300                                                                  02430010
024400     PERFORM Y200-CLOSE-CURSOR                                    02440010
024500     CLOSE APOUT-APULL-FILE.                                      02450010
024600                                                                  02460010
024700                                                                  02470010
024800 R100-FETCH-INVOIC.                                               02480010
024900                                                                  02490010
025000     PERFORM WITH TEST AFTER                                      02500010
025100        VARYING WS-RETRY-COUNTER FROM 1 BY 1                      02510010
025200        UNTIL   WS-RETRY-COUNTER > WS-RETRY-MAX OR                02520010
025300                SQLCODE = ZERO OR                                 02530010
025400                SQLCODE = +100                                    02540010
025500        EXEC SQL                                                  02550010
025600            FETCH TINVOIC_CSR                                     02560010
025700            INTO :INVOIC-PO-NBR                                   02570010
025800               , :INVOIC-INVC-ID                                  02580010
025900               , :INVOIC-PAYT-REQ-SEQ-NBR                         02590010
026000               , :INVOIC-INVC-TYP-CDE                             02600010
026100               , :INVOIC-GRO-COST-AMT                             02610010
026200               , :INVOIC-STR-NBR                                  02620010
026300               , :INVOIC-STATUS-CDE                               02630010
026400               , :INVOIC-STATUS-CHG-TMST                          02640010
026500               , :INVOIC-DC-NBR                                   02650010
026600               , :INVOIC-MTCH-LVL-CDE                             02660010
026700        END-EXEC                                                  02670010
026800                                                                  02680010
026900                                                                  02690010
027000        EVALUATE TRUE                                             02700010
027100            WHEN SQLCODE = ZERO                                   02710010
027200                 ADD 1 TO WS-ROWS-FETCHED                         02720010
027300            WHEN SQLCODE = +100                                   02730010
027400                 SET WS-END-OF-FETCH TO TRUE                      02740010
027500            WHEN SQLCODE = -904                                   02750010
027600            WHEN SQLCODE = -913                                   02760010
027700              CONTINUE                                            02770010
027800            WHEN SQLWARN0 NOT = SPACES                            02780010
027900            WHEN SQLCODE  NOT = ZERO                              02790010
028000              MOVE 'R100-FETCH                    '               02800010
028100                            TO WS-ABEND-PARAGRAPH                 02810010
028200              MOVE 'UNSUCCESSFUL FETCH  INVOIC'                   02820010
028300                            TO WS-ABEND-OPERATION                 02830010
028400              MOVE 'TINVOIC ' TO WS-ABEND-STRUCTURE-1             02840010
028500              MOVE SPACES     TO WS-ABEND-STRUCTURE-2             02850010
028600              PERFORM Z999-SQL-ERROR                              02860010
028700           END-EVALUATE                                           02870010
028800     END-PERFORM.                                                 02880010
028900                                                                  02890010
029000     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           02900010
029100         MOVE 'R100-FETCH                    '                    02910010
029200                       TO WS-ABEND-PARAGRAPH                      02920010
029300         MOVE 'MAX RETRIES EXCEEDED ON FETCH  INVOIC'             02930010
029400                         TO WS-ABEND-OPERATION                    02940010
029500         PERFORM Z999-SQL-ERROR                                   02950010
029600     END-IF.                                                      02960010
029700                                                                  02970010
029800 W100-WRITE-OUTPUT.                                               02980010
029900                                                                  02990010
030000     WRITE APOUT-APULL-RECORD     FROM AP067-RECORD.              03000010
030100                                                                  03010010
030200     ADD 1 TO WS-RECORDS-WRITTEN.                                 03020010
030300                                                                  03030010
030400 Y100-OPEN-CURSOR.                                                03040010
030500                                                                  03050010
030600     PERFORM WITH TEST AFTER                                      03060010
030700             VARYING WS-RETRY-COUNTER FROM 1 BY 1                 03070010
030800             UNTIL   WS-RETRY-COUNTER > WS-RETRY-MAX OR           03080010
030900                     SQLCODE = ZERO                               03090010
031000                                                                  03100010
031100             EXEC SQL                                             03110010
031200                OPEN TINVOIC_CSR                                  03120010
031300             END-EXEC                                             03130010
031400                                                                  03140010
031500             EVALUATE TRUE                                        03150010
031600                 WHEN SQLCODE = ZERO                              03160010
031700                 WHEN SQLCODE = -904                              03170010
031800                 WHEN SQLCODE = -913                              03180010
031900                      CONTINUE                                    03190010
032000                                                                  03200010
032100                 WHEN SQLWARN0 NOT = SPACES                       03210010
032200                 WHEN SQLCODE  NOT = ZERO                         03220010
032300                      MOVE 'Y100-OPEN-CURSOR             '        03230010
032400                                    TO WS-ABEND-PARAGRAPH         03240010
032500                      MOVE 'UNSUCCESSFUL OPEN   INVOIC'           03250010
032600                                    TO WS-ABEND-OPERATION         03260010
032700                      MOVE 'TINVOIC ' TO WS-ABEND-STRUCTURE-1     03270010
032800                      MOVE SPACES     TO WS-ABEND-STRUCTURE-2     03280010
032900                      PERFORM Z999-SQL-ERROR                      03290010
033000             END-EVALUATE                                         03300010
033100     END-PERFORM.                                                 03310010
033200                                                                  03320010
033300     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           03330010
033400         MOVE 'Y100-OPEN-CURSOR             '                     03340010
033500                       TO WS-ABEND-PARAGRAPH                      03350010
033600         MOVE 'MAX RETRIES EXCEEDED ON OPEN   INVOIC'             03360010
033700                         TO WS-ABEND-OPERATION                    03370010
033800         PERFORM Z999-SQL-ERROR.                                  03380010
033900                                                                  03390010
034000 Y200-CLOSE-CURSOR.                                               03400010
034100                                                                  03410010
034200     PERFORM WITH TEST AFTER                                      03420010
034300             VARYING WS-RETRY-COUNTER FROM 1 BY 1                 03430010
034400             UNTIL   WS-RETRY-COUNTER > WS-RETRY-MAX OR           03440010
034500                     SQLCODE = ZERO                               03450010
034600                                                                  03460010
034700             EXEC SQL                                             03470010
034800                CLOSE TINVOIC_CSR                                 03480010
034900             END-EXEC                                             03490010
035000                                                                  03500010
035100             EVALUATE TRUE                                        03510010
035200                 WHEN SQLCODE = ZERO                              03520010
035300                 WHEN SQLCODE = -904                              03530010
035400                 WHEN SQLCODE = -913                              03540010
035500                      CONTINUE                                    03550010
035600                                                                  03560010
035700                 WHEN SQLWARN0 NOT = SPACES                       03570010
035800                 WHEN SQLCODE  NOT = ZERO                         03580010
035900                      MOVE 'Y200-CLOSE-CURSOR             '       03590010
036000                                    TO WS-ABEND-PARAGRAPH         03600010
036100                      MOVE 'UNSUCCESSFUL CLOSE  INVOIC'           03610010
036200                                    TO WS-ABEND-OPERATION         03620010
036300                      MOVE 'TINVOIC ' TO WS-ABEND-STRUCTURE-1     03630010
036400                      MOVE SPACES     TO WS-ABEND-STRUCTURE-2     03640010
036500                      PERFORM Z999-SQL-ERROR                      03650010
036600             END-EVALUATE                                         03660010
036700     END-PERFORM.                                                 03670010
036800                                                                  03680010
036900     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           03690010
037000         MOVE 'Y200-CLOSE-CURSOR             '                    03700010
037100                       TO WS-ABEND-PARAGRAPH                      03710010
037200         MOVE 'MAX RETRIES EXCEEDED ON CLOSE  INVOIC'             03720010
037300                         TO WS-ABEND-OPERATION                    03730010
037400         PERFORM Z999-SQL-ERROR.                                  03740010
037500                                                                  03750010
037600 Z999-SQL-ERROR.                                                  03760010
037700*                                                                 03770010
037800***************************************************************** 03780010
037900*     PROCESS DB2 ABENDS                                          03790010
038000***************************************************************** 03800010
038100*                                                                 03810010
038200     DISPLAY '*** DB2 ERROR '.                                    03820010
038300     DISPLAY '*** PROGRAM   = ' WS-ABEND-PROGRAM.                 03830010
038400     DISPLAY '*** PARAGRAPH = ' WS-ABEND-PARAGRAPH.               03840010
038500     DISPLAY '*** OPERATION = ' WS-ABEND-OPERATION.               03850010
038600     DISPLAY '*** TABLE 1   = ' WS-ABEND-STRUCTURE-1.             03860010
038700     IF WS-ABEND-STRUCTURE-2 > SPACES                             03870010
038800         DISPLAY '*** TABLE 2   = ' WS-ABEND-STRUCTURE-2.         03880010
038900                                                                  03890010
039000     SET AP-DB2-ERROR              TO TRUE.                       03900010
039100                                                                  03910010
039200     COPY DPPD004.                                                03920010
039300     CALL 'ILBOABN0' USING ABEND-CODE.                            03930010
039400                                                                  03940010
