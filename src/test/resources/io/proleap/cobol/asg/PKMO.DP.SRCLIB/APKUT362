000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.    APKUT362.                                         00020000
000300 AUTHOR.        NANCY EILBES.                                     00030000
000400 DATE-WRITTEN.  SEPTEMBER 2012.                                   00040000
000500 DATE-COMPILED.                                                   00050000
000600***************************************************************** 00060000
000700*                SALES TAX AUDIT                                * 00070000
000800***************************************************************** 00080000
000900*    COBOL II WITH PEOPLESOFT SQL                               * 00090000
001000***************************************************************** 00100000
001100*  PURPOSE:  TO CREATE A SALES TAX AUDIT FILE, EXTRACTING DATA  * 00110000
001200*  FROM PEOPLE SOFT TABLES.                                     * 00120000
001300***************************************************************** 00130000
001400*                                                               * 00140000
001500*  PEOPLESOFT TABLES:  PS_PAYMENT_TBL  COBOL DCLGENS: FIT00180  * 00150000
001600*                      PS_PYMNT_VCHR_XREF             FIT00198  * 00160000
001700*                      PS_VOUCHER                     FIT00260  * 00170000
001800*                      PS_DISTRIB_LINE                FIT00164  * 00180000
001900*                      PS_VENDOR                      FIT00236  * 00190000
002000*                      PS_PROJ_ACTIVITY               FIT00288  * 00200000
002100*                      GL_ACCOUNT_TBL                 FIT00170  * 00210008
002200*                                                               * 00220000
002300*  INPUT: DEPTID SELECTION FILE                                 * 00230014
002400*         CONTROL CARD WITH DATE RANGE                          * 00240015
002500*  OUTPUT: SALES TAX AUDIT FILE                COPYBOOK APRD216 * 00250014
002600*                                                               * 00260000
002700*---------------------------------------------------------------* 00270014
002800* CHANGE LOG:                                                   * 00280014
002900* DATE  06/14/2013                                              * 00290013
003000*     CHANGE MADE: INITIAL IMPLEMENTATION.  THIS PROGRAM IS A   * 00300013
003100*     REWRITE OF APKUT216.  LOCATION SELECTION IS NOW DRIVEN BY * 00310013
003200*     AN INPUT LIST OF DEPTIDS RATHER THAN BUILDING THE STORE   * 00320013
003300*     FROM THE LOCATION DATABASE.  FIELDS BEING SELECTED HAS    * 00330013
003400*     BEEN ENHANCED TO CAPTURE NEW FIELDS APPROPRIATE TO THE    * 00340013
003500*     PS UPGRADE TO V9.1 AND OBSOLETE FIELDS ELIMINATED.        * 00350013
003600*     MADE BY: NANCY EILBES            WR/IR #: CHG0055677      * 00360013
003700*                                                               * 00370000
003800* DATE  10/04/2013                                              * 00380018
003900*     CHANGE MADE: ADDED TRIRIGA CODE                           * 00390018
004000*     MADE BY: STEVE KRIEG             WR/IR #:WRSJK???         * 00400018
004100*                                                               * 00410018
004200*  DATE  11/11/2013                                             * 00420019
004300*      CHANGE MADE: CHANGES MADE FOR INCLUDING BASE INTERFACE   * 00430019
004400*      FILE. THE CHANGES INCLUDE READING OF THE NEW ORIGIN CODE * 00440019
004500*      MADE BY: VIKRAM V                WR/IR #: CHG0070953     * 00450023
004510*                                                               * 00451028
004520*  DATE  04/25/2014                                             * 00452028
004530*      CHANGE MADE: DELETED THE FIELD C.DESCR FROM CURSOR       * 00453028
004540*      XPEDX_FEED_CSR FETCH THE SAME DATA MATCHING WITH CURSOR  * 00454028
004541*      AUDIT_CSR USED IN PROGRAM APKUT363 FOR SALES TAX AUDIT.  * 00454128
004542*      MADE BY: COGNIZANT               WR/IR #: CHG0079948     * 00454228
004543*                                                               * 00454328
004544*  DATE  10/01/2014                                             * 00454428
004545*      CHANGE MADE: ADDED NEW ORIGINS FOR ARIBA TRANSACTIONS    * 00454528
004546*      IN THE AUDIT_FEED_CSR AND THE XPEDX_FEED_CSR.            * 00454628
004548*      MADE BY: MARK BURNSIDE           WR/IR #: CHG0093763     * 00454828
004600*---------------------------------------------------------------* 00460014
004700 ENVIRONMENT DIVISION.                                            00470000
004800 CONFIGURATION SECTION.                                           00480000
004900 SOURCE-COMPUTER.        IBM-370.                                 00490000
005000 OBJECT-COMPUTER.        IBM-370.                                 00500000
005100                                                                  00510000
005200 INPUT-OUTPUT SECTION.                                            00520000
005300                                                                  00530000
005400 FILE-CONTROL.                                                    00540000
005500     SELECT ORACLE-LOGIN-FILE     ASSIGN TO UT-S-ORALOGON.        00550000
005600     SELECT DEPTID-SELECTION-FILE ASSIGN TO UT-S-INP01.           00560001
005700     SELECT STATE-TAX-AUDIT-FILE  ASSIGN TO UT-S-OUT01.           00570001
005800                                                                  00580000
005900 DATA DIVISION.                                                   00590000
006000 FILE SECTION.                                                    00600000
006100 FD  ORACLE-LOGIN-FILE                                            00610000
006200     RECORDING MODE IS F                                          00620000
006300     LABEL RECORDS ARE STANDARD                                   00630000
006400     BLOCK CONTAINS 0 RECORDS                                     00640000
006500     DATA RECORD IS ORACLE-LOGIN-REC.                             00650000
006600 01  ORACLE-LOGIN-REC.                                            00660000
006700     05  FILLER                         PIC X(080).               00670000
006800                                                                  00680000
006900 FD  DEPTID-SELECTION-FILE                                        00690000
007000     RECORDING MODE IS F                                          00700000
007100     LABEL RECORDS ARE STANDARD                                   00710000
007200     BLOCK CONTAINS 0 RECORDS                                     00720000
007300     RECORD CONTAINS 80 CHARACTERS                                00730000
007400     DATA RECORD IS DEPTID-SELECTION-RECORD.                      00740000
007500                                                                  00750000
007600 01  DEPTID-SELECTION-RECORD            PIC X(80).                00760000
007700                                                                  00770000
007800 FD  STATE-TAX-AUDIT-FILE                                         00780000
007900     RECORDING MODE IS F                                          00790000
008000     LABEL RECORDS ARE STANDARD                                   00800000
008100     BLOCK CONTAINS 0 RECORDS                                     00810000
008200     RECORD CONTAINS 325 CHARACTERS                               00820008
008300     DATA RECORD IS STATE-TAX-AUDIT-RECORD.                       00830000
008400                                                                  00840000
008500 01  STATE-TAX-AUDIT-RECORD             PIC X(325).               00850008
008600                                                                  00860000
008700                                                                  00870000
008800 WORKING-STORAGE SECTION.                                         00880000
008900 01  PROGRAM-CONSTANTS.                                           00890000
009000     05  FILLER                         PIC X.                    00900000
009100                                                                  00910000
009200 01  PROGRAM-SWITCHES.                                            00920000
009300     05  PS-END-OF-DEPTID-FILE          PIC X  VALUE 'N'.         00930003
009400         88  END-OF-DEPTID-FILE                VALUE 'Y'.         00940003
009500     05  PS-AUDIT-FEED-END-OF-CSR       PIC X  VALUE 'N'.         00950000
009600         88  AUDIT-FEED-END-OF-CSR             VALUE 'Y'.         00960000
009700     05  PS-XPEDX-FEED-END-OF-CSR       PIC X  VALUE 'N'.         00970000
009800         88  XPEDX-FEED-END-OF-CSR             VALUE 'Y'.         00980000
009900     05  PS-ORACLE-LOGIN-EOF-SW         PIC X  VALUE 'N'.         00990000
010000         88  ORACLE-LOGIN-EOF                  VALUE 'Y'.         01000000
010100                                                                  01010000
010200 01  SI-DEPTID-RECORD.                                            01020003
010300     05  SI-DEPTID                      PIC X(10).                01030003
010400     05  FILLER                         PIC X(70).                01040003
010500                                                                  01050003
010600 01  CC-CONTROL-CARD.                                             01060003
010700     05  FILLER                         PIC X(07).                01070003
010800     05  CC-STATE-CD                    PIC X(02).                01080003
010900     05  FILLER                         PIC X(08).                01090000
011000     05  CC-BEGIN-DATE                  PIC X(10).                01100000
011100     05  FILLER REDEFINES CC-BEGIN-DATE.                          01110000
011200         10 CC-BEGIN-DATE-CCYY          PIC X(04).                01120000
011300         10 FILLER                      PIC X(01).                01130000
011400         10 CC-BEGIN-DATE-MM            PIC X(02).                01140000
011500         10 FILLER                      PIC X(01).                01150000
011600         10 CC-BEGIN-DATE-DD            PIC X(02).                01160000
011700     05  FILLER                         PIC X(06).                01170000
011800     05  CC-END-DATE                    PIC X(10).                01180000
011900     05  FILLER REDEFINES CC-END-DATE.                            01190000
012000         10 CC-END-DATE-CCYY            PIC X(04).                01200000
012100         10 FILLER                      PIC X(01).                01210000
012200         10 CC-END-DATE-MM              PIC X(02).                01220000
012300         10 FILLER                      PIC X(01).                01230000
012400         10 CC-END-DATE-DD              PIC X(02).                01240000
012500     05  FILLER                         PIC X(08).                01250000
012600     05  CC-XPEDX-INDICATOR             PIC X(01).                01260000
012700     05  FILLER                         PIC X(28).                01270000
012800                                                                  01280000
012900 01  PROGRAM-COUNTERS.                                            01290000
013000     05  DEPTID-COUNT                   PIC S9(09) COMP VALUE 0.  01300000
013100     05  AUDIT-CSR-COUNT                PIC S9(09) COMP VALUE 0.  01310000
013200     05  AUDIT-OUT-COUNT                PIC S9(09) COMP VALUE 0.  01320000
013300     05  STATE-STORE-SUB                PIC  9(04) VALUE 0.       01330000
013400                                                                  01340000
013500 01  PROGRAM-VARIABLES.                                           01350000
013600     05  PV-STATE-STORE-TOTAL           PIC 9(04) VALUE 0.        01360000
013700     05  PV-STORE-NBR                   PIC 9(04) VALUE 0.        01370003
013800     05  PV-PROGRAM-NAME                PIC X(08) VALUE           01380000
013900                                                   'APKUT362'.    01390000
014000     05  PV-ORACLE-USERID-LEN           PIC S9(4) VALUE ZEROS.    01400000
014100     05  PV-ORACLE-PASSWORD-LEN         PIC S9(4) VALUE ZEROS.    01410000
014200     05  PV-DEPTID                      PIC X(10) VALUE SPACE.    01420000
014300     05  PV-PYMNT-ID-REF                PIC X(20) VALUE SPACE.    01430000
014400                                                                  01440000
014500 01  STATE-STORE-TABLE.                                           01450000
014600     05  STATE-DEPTID                   PIC X(10) OCCURS 9999.    01460000
014700                                                                  01470000
014800 01  ABEND-CODE                         PIC S9(04) VALUE ZEROS    01480000
014900                                                   COMP SYNC.     01490000
015000     88  AC-BAD-WRITE                   VALUE  +4001.             01500000
015100     88  AC-CONTROL-CARD-ERROR          VALUE  +4003.             01510000
015200     88  AC-OPEN-ERROR                  VALUE  +4005.             01520000
015300     88  AC-CLOSE-ERROR                 VALUE  +4006.             01530000
015400     88  AC-BAD-DATA                    VALUE  +4008.             01540000
015500     88  AC-ORA-ERROR                   VALUE  +4013.             01550000
015600     88  AC-UNSUCCESSFUL-SELECT         VALUE  +4015.             01560000
015700     88  AC-MAX-RETRIES-EXCEEDED        VALUE  +4016.             01570000
015800     88  AC-DATE-ERROR                  VALUE  +4019.             01580000
015900                                                                  01590000
016000 01  ABEND-AREAS.                                                 01600000
016100     05  AA-ABEND-LIT                   PIC  X(40)  VALUE         01610000
016200             '*****       ABEND'.                                 01620000
016300     05  AA-PROGRAM-LIT                 PIC  X(40)  VALUE         01630000
016400             '*****   PROGRAM: APKUT362'.                         01640000
016500     05  AA-PARAGRAPH-LIT.                                        01650000
016600         10  FILLER                     PIC  X(17)  VALUE         01660000
016700             '***** PARAGRAPH: '.                                 01670000
016800         10  AA-PARAGRAPH-NAME          PIC  X(35)  VALUE SPACES. 01680000
016900     05  AA-MESSAGE-LINE.                                         01690000
017000         10  FILLER                     PIC  X(06)  VALUE         01700000
017100             '*****'.                                             01710000
017200         10  AA-MESSAGE                 PIC  X(127) VALUE SPACES. 01720000
017300         10  FILLER REDEFINES AA-MESSAGE.                         01730000
017400             15 AA-MESSAGE-1     PIC  X(45).                      01740000
017500             15 AA-MESSAGE-2     PIC  X(45).                      01750000
017600             15 AA-MESSAGE-3     PIC  X(37).                      01760000
017700     05  AA-ORA-ERROR-LIT               PIC  X(40)  VALUE         01770000
017800             '*****    ORACLE ERROR'.                             01780000
017900     05  AA-ORA-OPERATION-LIT.                                    01790000
018000         10  FILLER                     PIC  X(17)  VALUE         01800000
018100             '***** OPERATION: '.                                 01810000
018200         10  AA-ORA-OPERATION.                                    01820000
018300             15  AA-ORA-OP-1            PIC  X(25)  VALUE SPACES. 01830000
018400             15  AA-ORA-OP-2            PIC  X(25)  VALUE SPACES. 01840000
018500     05  AA-ORA-TABLE-1                 PIC  X(18)  VALUE SPACES. 01850000
018600     05  AA-ORA-TABLE-2                 PIC  X(18)  VALUE SPACES. 01860000
018700     05  AA-ORA-TABLE-3                 PIC  X(18)  VALUE SPACES. 01870000
018800                                                                  01880000
018900 01  CC-ORACLE-CONNECTION.                                        01890000
019000     05  CC-ORACLE-USERID               PIC  X(40).               01900000
019100         88 CC-AUTO-SIGNON-IND                      VALUE '/'.    01910000
019200     05  CC-ORACLE-PASSWORD             PIC  X(40).               01920000
019300******************************************************************01930000
019400*                      O  R  A  C  L  E                          *01940000
019500*=================================================================01950000
019600* ORACLE DECLARE SECTION                                         *01960000
019700* ORACLE USED AND RETURNED VARIABLES                             *01970000
019800******************************************************************01980000
019900     EXEC SQL BEGIN DECLARE SECTION END-EXEC.                     01990000
020000     EXEC ORACLE OPTION (PREFETCH=5000) END-EXEC.                 02000000
020100                                                                  02010000
020200*----------------------------------------------------------------*02020000
020300* ORACLE LOGON WORKING STORAGE COPYBOOK                          *02030000
020400*----------------------------------------------------------------*02040000
020500 01  PC-ENT01-TYPE-CDE                  PIC  X(02)  VALUE '01'.   02050000
020600 01  PV-ORACLE-ID                       PIC  X(01)  VALUE '/'.    02060000
020700                                                                  02070000
020800 01  USERNAME                           PIC  X(10)  VARYING.      02080000
020900 01  PASSWD                             PIC  X(10)  VARYING.      02090000
021000                                                                  02100000
021100 01  ORACLE-RETURN                      PIC  X(200) VALUE SPACES. 02110000
021200                                                                  02120000
021300*--------------------------------------------------------------*  02130000
021400*   THIS IS THE RECORD LAYOUT FOR THE STATE TAX AUDIT FILE     *  02140000
021500*--------------------------------------------------------------*  02150000
021600     COPY APRD216.                                                02160000
021700                                                                  02170000
021800*--------------------------------------------------------------*  02180000
021900* WORKING STORAGE FOR CALENDAR ROUTINE                         *  02190000
022000*--------------------------------------------------------------*  02200000
022100     COPY DPWS500.                                                02210000
022200                                                                  02220000
022300*--------------------------------------------------------------*  02230000
022400*  DPWS004 CONTAINS THE FIELDS NECESSARY TO CALL THE SQLCA     *  02240000
022500*  MESSAGE MODULE 'DSNTIAR' AND DISPLAY THE FORMATTED RESULTS. *  02250000
022600*--------------------------------------------------------------*  02260000
022700     COPY DPWS004.                                                02270000
022800                                                                  02280000
022900*--------------------------------------------------------------*  02290000
023000*  PEOPLE SOFT VENDOR TABLE                                    *  02300000
023100*--------------------------------------------------------------*  02310000
023200     EXEC SQL                                                     02320000
023300          INCLUDE FIT00236                                        02330000
023400     END-EXEC.                                                    02340000
023500                                                                  02350000
023600*--------------------------------------------------------------*  02360000
023700*  PEOPLE SOFT PAYMENT_TBL TABLE                               *  02370000
023800*--------------------------------------------------------------*  02380000
023900     EXEC SQL                                                     02390000
024000          INCLUDE FIT00180                                        02400000
024100     END-EXEC.                                                    02410000
024200                                                                  02420000
024300*--------------------------------------------------------------*  02430000
024400*  PEOPLE SOFT PYMNT_VCHR_XREF TABLE                           *  02440000
024500*--------------------------------------------------------------*  02450000
024600     EXEC SQL                                                     02460000
024700          INCLUDE FIT00198                                        02470000
024800     END-EXEC.                                                    02480000
024900                                                                  02490000
025000*--------------------------------------------------------------*  02500000
025100*  PEOPLE SOFT VOUCHER TABLE                                   *  02510000
025200*--------------------------------------------------------------*  02520000
025300     EXEC SQL                                                     02530000
025400          INCLUDE FIT00260                                        02540000
025500     END-EXEC.                                                    02550000
025600                                                                  02560000
025700*--------------------------------------------------------------*  02570000
025800*  PEOPLE SOFT DISTRIB LINE TABLE                              *  02580000
025900*--------------------------------------------------------------*  02590000
026000     EXEC SQL                                                     02600000
026100          INCLUDE FIT00164                                        02610000
026200     END-EXEC.                                                    02620000
026300                                                                  02630000
026400*--------------------------------------------------------------*  02640000
026500*LOCATION TABLE PS_XFT_LOC                                     *  02650000
026600*--------------------------------------------------------------*  02660000
026700*    EXEC SQL                                                     02670000
026800*         INCLUDE FIT00264                                        02680000
026900*    END-EXEC.                                                    02690000
027000*                                                                 02700000
027100*--------------------------------------------------------------*  02710000
027200*ATTRIBUTE TABLE PS_XFT_LOC_ATTR                               *  02720000
027300*--------------------------------------------------------------*  02730000
027400     EXEC SQL                                                     02740005
027500          INCLUDE FIT00266                                        02750005
027600     END-EXEC.                                                    02760005
027700                                                                  02770005
027800*--------------------------------------------------------------*  02780000
027900* PROJECT ACTIVITY TABLE PS_PROJ_ACTIVITY                      *  02790000
028000*--------------------------------------------------------------*  02800000
028100     EXEC SQL                                                     02810000
028200          INCLUDE FIT00288                                        02820000
028300     END-EXEC.                                                    02830000
028400                                                                  02840000
028500*--------------------------------------------------------------*  02850008
028600* GL ACCOUNT TABLE  PS_GL_ACCOUNT_TBL                          *  02860008
028700*--------------------------------------------------------------*  02870008
028800     EXEC SQL                                                     02880008
028900          INCLUDE FIT00170                                        02890008
029000     END-EXEC.                                                    02900008
029100                                                                  02910008
029200     EXEC SQL INCLUDE SQLCACOB    END-EXEC.                       02920000
029300     EXEC SQL END DECLARE SECTION END-EXEC.                       02930000
029400*--------------------------------------------------------------*  02940000
029500*  AUDIT_FEED_CSR                                              *  02950000
029600*--------------------------------------------------------------*  02960000
029700     EXEC SQL                                                     02970000
029800       DECLARE AUDIT_FEED_CSR CURSOR FOR                          02980000
029900          SELECT A.VOUCHER_ID                                     02990000
030000               , A.VENDOR_ID                                      03000000
030100               , A.INVOICE_ID                                     03010000
030200               , TO_CHAR(A.INVOICE_DT, 'YYYY-MM-DD')              03020000
030300               , TO_CHAR(A.ACCOUNTING_DT, 'YYYY-MM-DD')           03030000
030400               , A.ORIGIN                                         03040008
030500               , A.VOUCHER_STYLE                                  03050012
030600               , C.ACCOUNT                                        03060000
030700               , C.MONETARY_AMOUNT                                03070000
030800               , C.FREIGHT_AMT                                    03080012
030900               , C.SALETX_AMT                                     03090012
031000               , C.MERCHANDISE_AMT                                03100012
031100               , C.DSCNT_AMT                                      03110012
031200               , C.DEPTID                                         03120000
031300               , C.PROJECT_ID                                     03130000
031400               , C.ACTIVITY_ID                                    03140000
031500               , C.PROFILE_ID                                     03150000
031600               , C.BUSINESS_UNIT_PC                               03160000
031700               , E.PYMNT_ID_REF                                   03170000
031800               , E.REMIT_VENDOR                                   03180000
031900               , E.NAME1                                          03190000
032000               , TO_CHAR(E.PYMNT_DT,'YYYY-MM-DD')                 03200000
032100               , G.DESCR                                          03210008
032200            FROM PS_VOUCHER A                                     03220000
032300               , PS_DISTRIB_LINE C                                03230000
032400               , PS_PYMNT_VCHR_XREF D                             03240000
032500               , PS_PAYMENT_TBL E                                 03250000
032600               , PS_GL_ACCOUNT_TBL G                              03260008
032700           WHERE A.BUSINESS_UNIT      = 'KDS'                     03270000
032800             AND A.ORIGIN IN ('ONL','E98','E99','EPM','EPL',      03280018
032900                              'E8L','E8M','E8S','E8T','E8U',      03290011
033000                              'E8V','E8W','E8X','E9U','E9V',      03300011
033100                              'EPA','EPB','EPC','EPD','EPE',      03310011
033200                              'EPF','EBA','EBB','EPN','EPP',      03320028
033210                              'EPQ','EPR','EPS','EPT','EPU',      03321028
033220                              'EPV','EPW','EPX','EPY','EPZ',      03322028
033230                              'EQA','EQB')                        03323028
033300****         AND A.ORIGIN IN ('C80','I70','A60','A67','A68',      03330006
033400****                          'ONL','X64','X80','X87','X88')      03340006
033500             AND C.BUSINESS_UNIT   =  A.BUSINESS_UNIT             03350000
033600             AND C.VOUCHER_ID         = A.VOUCHER_ID              03360000
033700             AND C.ACCOUNT            NOT IN ('50000')            03370000
033800             AND D.PYMNT_SELCT_STATUS = 'P'                       03380000
033900             AND D.BUSINESS_UNIT      = A.BUSINESS_UNIT           03390000
034000             AND D.VOUCHER_ID         = A.VOUCHER_ID              03400000
034100             AND A.ACCOUNTING_DT BETWEEN TO_DATE(:CC-BEGIN-DATE,  03410000
034200                                                   'YYYY-MM-DD')  03420000
034300                                     AND TO_DATE(:CC-END-DATE,    03430000
034400                                                 'YYYY-MM-DD')    03440000
034500***          AND E.PYMNT_DT BETWEEN     TO_DATE(:CC-BEGIN-DATE,   03450000
034600***                                     'YYYY-MM-DD') AND         03460000
034700***                                     TO_DATE(:CC-END-DATE,     03470000
034800***                                     'YYYY-MM-DD')             03480000
034900             AND E.BANK_SETID         = D.BANK_SETID              03490000
035000             AND E.BANK_CD            = D.BANK_CD                 03500000
035100             AND E.BANK_ACCT_KEY      = D.BANK_ACCT_KEY           03510000
035200             AND E.PYMNT_ID           = D.PYMNT_ID                03520000
035300             AND E.PYMNT_METHOD       = D.PYMNT_METHOD            03530000
035400             AND E.PAY_CYCLE          = D.PAY_CYCLE               03540000
035500             AND E.PAY_CYCLE_SEQ_NUM  = D.PAY_CYCLE_SEQ_NUM       03550000
035600             AND E.REMIT_VENDOR       = D.REMIT_VENDOR            03560000
035700             AND G.EFFDT =                                        03570008
035800                 (SELECT MAX(G_ED.EFFDT)                          03580008
035900                    FROM PS_GL_ACCOUNT_TBL G_ED                   03590008
036000                   WHERE G.SETID = G_ED.SETID                     03600008
036100                     AND G.ACCOUNT = G_ED.ACCOUNT                 03610008
036200                     AND G_ED.EFFDT <= A.ACCOUNTING_DT)           03620008
036300             AND G.SETID = 'SHARE'                                03630008
036400             AND G.ACCOUNT = C.ACCOUNT                            03640008
036500         ORDER BY A.VOUCHER_ID                                    03650000
036600     END-EXEC.                                                    03660000
036700                                                                  03670000
036800*--------------------------------------------------------------*  03680000
036900*  XPEDX_FEED_CSR                                              *  03690000
037000*--------------------------------------------------------------*  03700000
037100     EXEC SQL                                                     03710000
037200       DECLARE XPEDX_FEED_CSR CURSOR FOR                          03720000
037300          SELECT A.VOUCHER_ID                                     03730008
037400               , A.VENDOR_ID                                      03740008
037500               , A.INVOICE_ID                                     03750008
037600               , TO_CHAR(A.INVOICE_DT, 'YYYY-MM-DD')              03760008
037700               , TO_CHAR(A.ACCOUNTING_DT, 'YYYY-MM-DD')           03770008
037800               , A.ORIGIN                                         03780008
037900               , A.VOUCHER_STYLE                                  03790012
038000               , C.ACCOUNT                                        03800008
038100               , C.MONETARY_AMOUNT                                03810008
038200               , C.FREIGHT_AMT                                    03820012
038300               , C.SALETX_AMT                                     03830012
038400               , C.MERCHANDISE_AMT                                03840012
038500               , C.DSCNT_AMT                                      03850012
038600               , C.DEPTID                                         03860012
038800               , C.PROJECT_ID                                     03880012
038900               , C.ACTIVITY_ID                                    03890012
039000               , C.PROFILE_ID                                     03900012
039100               , C.BUSINESS_UNIT_PC                               03910012
039200               , E.PYMNT_ID_REF                                   03920012
039300               , E.REMIT_VENDOR                                   03930012
039400               , E.NAME1                                          03940012
039500               , TO_CHAR(E.PYMNT_DT,'YYYY-MM-DD')                 03950012
039600               , G.DESCR                                          03960012
039700            FROM PS_VOUCHER A                                     03970012
039800               , PS_DISTRIB_LINE C                                03980012
039900               , PS_PYMNT_VCHR_XREF D                             03990012
040000               , PS_PAYMENT_TBL E                                 04000012
040100               , PS_GL_ACCOUNT_TBL G                              04010012
040200           WHERE A.BUSINESS_UNIT      = 'KDS'                     04020000
040300             AND A.ORIGIN IN ('ONL','E98','E99','EPM','EPL',      04030018
040400                              'E8L','E8M','E8S','E8T','E8U',      04040011
040500                              'E8V','E8W','E8X','E9U','E9V',      04050011
040600                              'EPA','EPB','EPC','EPD','EPE',      04060011
040700                              'EPF','E83','E84','EBA','EBB',      04070029
040710                              'EPN','EPP','EPQ','EPR','EPS',      04071029
040720                              'EPT','EPU','EPV','EPW','EPX',      04072029
040730                              'EPY','EPZ','EQA','EQB')            04073029
040800****         AND A.ORIGIN IN ('C80','I70','A60','A67','A68',      04080007
040900****                          'ONL','X64','X80','X87','X88',      04090007
041000****                          'E83','E84')                        04100007
041100             AND C.BUSINESS_UNIT   =  A.BUSINESS_UNIT             04110000
041200             AND C.VOUCHER_ID         = A.VOUCHER_ID              04120000
041300             AND C.ACCOUNT            NOT IN ('50000')            04130000
041400             AND D.PYMNT_SELCT_STATUS = 'P'                       04140000
041500             AND D.BUSINESS_UNIT      = A.BUSINESS_UNIT           04150000
041600             AND D.VOUCHER_ID         = A.VOUCHER_ID              04160000
041700             AND A.ACCOUNTING_DT BETWEEN TO_DATE(:CC-BEGIN-DATE,  04170000
041800                                                   'YYYY-MM-DD')  04180000
041900                                     AND TO_DATE(:CC-END-DATE,    04190000
042000                                                 'YYYY-MM-DD')    04200000
042100***          AND E.PYMNT_DT BETWEEN     TO_DATE(:CC-BEGIN-DATE,   04210000
042200***                                     'YYYY-MM-DD') AND         04220000
042300***                                     TO_DATE(:CC-END-DATE,     04230000
042400***                                     'YYYY-MM-DD')             04240000
042500             AND E.BANK_SETID         = D.BANK_SETID              04250000
042600             AND E.BANK_CD            = D.BANK_CD                 04260000
042700             AND E.BANK_ACCT_KEY      = D.BANK_ACCT_KEY           04270000
042800             AND E.PYMNT_ID           = D.PYMNT_ID                04280000
042900             AND E.PYMNT_METHOD       = D.PYMNT_METHOD            04290000
043000             AND E.PAY_CYCLE          = D.PAY_CYCLE               04300000
043100             AND E.PAY_CYCLE_SEQ_NUM  = D.PAY_CYCLE_SEQ_NUM       04310000
043200             AND E.REMIT_VENDOR       = D.REMIT_VENDOR            04320000
043300             AND G.EFFDT =                                        04330008
043400                 (SELECT MAX(G_ED.EFFDT)                          04340008
043500                    FROM PS_GL_ACCOUNT_TBL G_ED                   04350008
043600                   WHERE G.SETID = G_ED.SETID                     04360008
043700                     AND G.ACCOUNT = G_ED.ACCOUNT                 04370008
043800                     AND G_ED.EFFDT <= A.ACCOUNTING_DT)           04380008
043900             AND G.SETID = 'SHARE'                                04390008
044000             AND G.ACCOUNT = C.ACCOUNT                            04400008
044100         ORDER BY A.VOUCHER_ID                                    04410000
044200     END-EXEC.                                                    04420000
044300                                                                  04430000
044400                                                                  04440000
044500************************                                          04450000
044600 PROCEDURE DIVISION.                                              04460000
044700************************                                          04470000
044800 A100-MAINLINE-ROUTINE.                                           04480000
044900                                                                  04490000
045000     PERFORM B100-INITIALIZATION.                                 04500000
045100                                                                  04510000
045200     IF CC-XPEDX-INDICATOR = 'Y'                                  04520000
045300        PERFORM B250-PROCESS-XPEDX-FEED-CSR                       04530000
045400          UNTIL XPEDX-FEED-END-OF-CSR                             04540000
045500     ELSE                                                         04550000
045600        PERFORM B200-PROCESS-AUDIT-FEED-CSR                       04560000
045700          UNTIL AUDIT-FEED-END-OF-CSR                             04570000
045800     END-IF.                                                      04580000
045900                                                                  04590000
046000     PERFORM B500-TERMINATION.                                    04600000
046100     GOBACK.                                                      04610000
046200                                                                  04620000
046300*--------------------------------------------------------------*  04630000
046400*  INITIALIZATION PROCESSING                                   *  04640000
046500*--------------------------------------------------------------*  04650000
046600 B100-INITIALIZATION.                                             04660000
046700                                                                  04670000
046800     DISPLAY ' '.                                                 04680000
046900     DISPLAY '**----------- APKUT362 BEGINS -------------**'.     04690000
047000     DISPLAY '**-------  ACCOUNTING DATE VERSION  ---------**'.   04700000
047100     DISPLAY 'SYSTEM DATE ' FUNCTION CURRENT-DATE(1:8)            04710000
047200     DISPLAY 'SYSTEM TIME ' FUNCTION CURRENT-DATE(9:6)            04720000
047300                                                                  04730000
047400     ACCEPT CC-CONTROL-CARD.                                      04740000
047500     DISPLAY ' '.                                                 04750000
047600     DISPLAY 'STATE CODE = ' CC-STATE-CD.                         04760000
047700     DISPLAY 'BEGIN DATE = ' CC-BEGIN-DATE.                       04770000
047800     DISPLAY 'END   DATE = ' CC-END-DATE.                         04780000
047900     DISPLAY 'XPEDX IND  = ' CC-XPEDX-INDICATOR.                  04790000
048000     DISPLAY ' '.                                                 04800000
048100                                                                  04810000
048200** THIS VERIFIES THE CONTROL CARD DATE, CC-BEGIN-DATE             04820000
048300     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              04830000
048400     SET DPG51-ACTUAL-CALENDAR-ONLY TO TRUE.                      04840000
048500     SET DPG52-LK-DTE-ISO-FMT TO TRUE.                            04850000
048600     MOVE CC-BEGIN-DATE TO DPG52-DB2-ISO-DATE-FMT                 04860000
048700     PERFORM Z900-CALENDAR-ROUTINE.                               04870000
048800     IF (DPG54-SEVERE-ERROR) OR                                   04880000
048900        (DPG54-WARNING-ERROR)                                     04890000
049000         SET AC-DATE-ERROR TO TRUE                                04900000
049100         MOVE 'B100-INITIALIZATION' TO AA-PARAGRAPH-NAME          04910000
049200         MOVE DPG54-ERROR-MESSAGE   TO AA-MESSAGE                 04920000
049300         PERFORM Z999-ABEND                                       04930000
049400     END-IF.                                                      04940000
049500                                                                  04950000
049600** THIS VERIFIES THE CONTROL CARD DATE, CC-END-DATE               04960000
049700     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              04970000
049800     SET DPG51-ACTUAL-CALENDAR-ONLY TO TRUE.                      04980000
049900     SET DPG52-LK-DTE-ISO-FMT TO TRUE.                            04990000
050000     MOVE CC-END-DATE TO DPG52-DB2-ISO-DATE-FMT                   05000000
050100     PERFORM Z900-CALENDAR-ROUTINE.                               05010000
050200     IF (DPG54-SEVERE-ERROR) OR                                   05020000
050300        (DPG54-WARNING-ERROR)                                     05030000
050400         SET AC-DATE-ERROR TO TRUE                                05040000
050500         MOVE 'B100-INITIALIZATION' TO AA-PARAGRAPH-NAME          05050000
050600         MOVE DPG54-ERROR-MESSAGE   TO AA-MESSAGE                 05060000
050700         PERFORM Z999-ABEND                                       05070000
050800     END-IF.                                                      05080000
050900                                                                  05090000
051000     INITIALIZE AP216-STATE-TAX-AUDIT-RECORD.                     05100000
051100     OPEN INPUT  ORACLE-LOGIN-FILE                                05110000
051200                 DEPTID-SELECTION-FILE                            05120000
051300          OUTPUT STATE-TAX-AUDIT-FILE.                            05130000
051400                                                                  05140000
051500     PERFORM B150-CONNECT-TO-ORACLE.                              05150000
051600                                                                  05160000
051700**   DISPLAY 'OPEN STORE CURSOR'                                  05170000
051800**   PERFORM Y100-OPEN-STORE-CSR.                                 05180000
051900**   LOAD STORE TABLE                                             05190000
052000     DISPLAY 'LOAD STORE TABLE'                                   05200000
052100     INITIALIZE STATE-STORE-TABLE.                                05210000
052200     PERFORM UNTIL STATE-STORE-SUB > 9998                         05220000
052300             OR END-OF-DEPTID-FILE                                05230000
052400        PERFORM R100-READ-DEPTID-FILE                             05240000
052500        DISPLAY 'DEPTID=>' SI-DEPTID                              05250003
052600        ADD 1 TO STATE-STORE-SUB                                  05260000
052700        MOVE SI-DEPTID TO STATE-DEPTID(STATE-STORE-SUB)           05270003
052800     END-PERFORM.                                                 05280000
052900     MOVE STATE-STORE-SUB TO PV-STATE-STORE-TOTAL.                05290005
053000**   PERFORM Y200-CLOSE-STORE-CSR.                                05300000
053100                                                                  05310000
053200                                                                  05320000
053300     IF CC-XPEDX-INDICATOR = 'Y'                                  05330000
053400        DISPLAY 'OPEN XPEDX FEED CURSOR'                          05340000
053500        PERFORM Y700-OPEN-XPEDX-FEED-CSR                          05350000
053600     ELSE                                                         05360000
053700        DISPLAY 'OPEN AUDIT FEED CURSOR'                          05370000
053800        PERFORM Y500-OPEN-AUDIT-FEED-CSR                          05380000
053900     END-IF.                                                      05390000
054000                                                                  05400000
054100     DISPLAY 'TIME ' FUNCTION CURRENT-DATE(9:6).                  05410000
054200                                                                  05420000
054300*--------------------------------------------------------------*  05430000
054400****************************************************************  05440000
054500*    LOGON TO ORACLE                                           *  05450000
054600*    - ACCEPT CONTROL CARD WITH CREDENTIALS                    *  05460000
054700****************************************************************  05470000
054800 B150-CONNECT-TO-ORACLE.                                          05480000
054900                                                                  05490000
055000     READ ORACLE-LOGIN-FILE INTO CC-ORACLE-CONNECTION             05500000
055100        AT END                                                    05510000
055200             SET ORACLE-LOGIN-EOF TO TRUE.                        05520000
055300                                                                  05530000
055400     IF NOT ORACLE-LOGIN-EOF                                      05540000
055500        INITIALIZE PV-ORACLE-USERID-LEN                           05550000
055600                   PV-ORACLE-PASSWORD-LEN                         05560000
055700        INSPECT CC-ORACLE-USERID                                  05570000
055800            TALLYING PV-ORACLE-USERID-LEN                         05580000
055900            FOR CHARACTERS BEFORE INITIAL SPACE                   05590000
056000        INSPECT CC-ORACLE-PASSWORD                                05600000
056100            TALLYING PV-ORACLE-PASSWORD-LEN                       05610000
056200            FOR CHARACTERS BEFORE INITIAL SPACE                   05620000
056300        MOVE CC-ORACLE-USERID (1:PV-ORACLE-USERID-LEN) TO         05630000
056400                   USERNAME-ARR                                   05640000
056500        MOVE PV-ORACLE-USERID-LEN TO USERNAME-LEN                 05650000
056600        MOVE CC-ORACLE-PASSWORD (1:PV-ORACLE-PASSWORD-LEN) TO     05660000
056700                   PASSWD-ARR                                     05670000
056800        MOVE PV-ORACLE-PASSWORD-LEN TO PASSWD-LEN                 05680000
056900                                                                  05690000
057000     IF CC-AUTO-SIGNON-IND                                        05700000
057100         DISPLAY PV-PROGRAM-NAME ' - AUTO SIGN-ON TO ORACLE'      05710000
057200         EXEC SQL                                                 05720000
057300              CONNECT :USERNAME                                   05730000
057400         END-EXEC                                                 05740000
057500     ELSE                                                         05750000
057600         DISPLAY PV-PROGRAM-NAME ' - SIGN-ON TO ORACLE AS USER '  05760000
057700                   USERNAME-ARR                                   05770000
057800         EXEC SQL                                                 05780000
057900              CONNECT :USERNAME IDENTIFIED BY :PASSWD             05790000
058000         END-EXEC                                                 05800000
058100     END-IF                                                       05810000
058200                                                                  05820000
058300     INITIALIZE CC-ORACLE-PASSWORD                                05830000
058400                PASSWD                                            05840000
058500                PV-ORACLE-PASSWORD-LEN                            05850000
058600                PASSWD-LEN                                        05860000
058700                                                                  05870000
058800     IF (SQLCODE NOT = 0)                                         05880000
058900         MOVE 'B150-CONNECT-TO-ORACLE' TO AA-PARAGRAPH-NAME       05890000
059000         DISPLAY PV-PROGRAM-NAME ' - ERROR SIGNING ON TO ORACLE'  05900000
059100         PERFORM Z998-ORA-ABEND                                   05910000
059200     END-IF.                                                      05920000
059300*                                                                 05930000
059400*                                                                 05940000
059500*----------------------------------------------------------------*05950000
059600*  THIS ROUTINE HOLDS THE MAIN LOGIC FOR CREATING THE STATE    *  05960000
059700*  TAX AUDIT FILE.                                             *  05970000
059800*--------------------------------------------------------------*  05980000
059900 B200-PROCESS-AUDIT-FEED-CSR.                                     05990000
060000                                                                  06000000
060100      PERFORM F200-FETCH-AUDIT-FEED-CSR.                          06010000
060200                                                                  06020000
060300*--------------------------------------------------------------*  06030000
060400*  THIS ROUTINE HOLDS THE MAIN LOGIC FOR CREATING THE STATE    *  06040000
060500*  TAX AUDIT FILE INCLUDING THE XPEDX INVOICES.                *  06050000
060600*--------------------------------------------------------------*  06060000
060700 B250-PROCESS-XPEDX-FEED-CSR.                                     06070000
060800                                                                  06080000
060900      PERFORM F400-FETCH-XPEDX-FEED-CSR.                          06090000
061000                                                                  06100000
061100                                                                  06110000
061200*--------------------------------------------------------------*  06120000
061300*  THIS ROUTINE PROCESSES THE FETCHED DETAIL                   *  06130000
061400*--------------------------------------------------------------*  06140000
061500 B400-PROCESS-AUDIT-CSR.                                          06150000
061600                                                                  06160000
061700      MOVE PYMNT-ID-REF OF FIT00180 TO PV-PYMNT-ID-REF            06170000
061800      MOVE PV-PYMNT-ID-REF(1:10)    TO AP216-CHECK-NBR            06180000
061900                                                                  06190000
062000**    GET THE VENDOR NAME FROM THE VENDOR TABLE                   06200000
062100      IF REMIT-VENDOR OF FIT00180 = VENDOR-ID OF FIT00260         06210000
062200         MOVE REMIT-VENDOR OF FIT00180   TO AP216-VENDOR-NBR      06220000
062300         MOVE NAME1        OF FIT00180   TO AP216-VENDOR-NAME     06230000
062400      ELSE                                                        06240000
062500         MOVE VENDOR-ID    OF FIT00260   TO AP216-VENDOR-NBR      06250000
062600         PERFORM S100-SELECT-VENDOR-NAME                          06260000
062700         MOVE NAME1        OF FIT00236   TO AP216-VENDOR-NAME     06270000
062800      END-IF.                                                     06280000
062900                                                                  06290000
063000      MOVE PYMNT-DT        OF FIT00180   TO AP216-PAID-DT.        06300000
063100      MOVE INVOICE-ID      OF FIT00260   TO AP216-INVOICE-ID.     06310000
063200      MOVE INVOICE-DT      OF FIT00260   TO AP216-INVOICE-DT.     06320000
063300      MOVE ACCOUNTING-DT   OF FIT00260   TO AP216-ACCOUNTING-DT.  06330008
063400      MOVE ORIGIN          OF FIT00260   TO AP216-ORIGIN.         06340008
063500      MOVE ACCOUNT         OF FIT00164   TO AP216-ACCOUNT.        06350000
063600      MOVE MONETARY-AMOUNT OF FIT00164   TO AP216-AMOUNT-PAID.    06360000
063700      MOVE FREIGHT-AMT     OF FIT00164   TO AP216-FREIGHT-AMT.    06370012
063800      MOVE SALETX-AMT      OF FIT00164   TO AP216-SALETX-AMT.     06380012
063900      MOVE DSCNT-AMT       OF FIT00164   TO AP216-DISCOUNT-AMT.   06390008
064000      MOVE PROJECT-ID      OF FIT00164   TO AP216-PROJECT-ID.     06400008
064100      MOVE DESCR           OF FIT00170   TO AP216-ACCT-DESCR.     06410008
064200                                                                  06420012
064300** NOTE: THIRD PARTY VOUCHERS WILL HAVE A VALUE IN THE MERCHANDISE06430012
064400**       AMOUNT FIELD THAT WAS COPIED FROM THE PO AND IS USED FOR 06440012
064500**       DISTRIBUTING THE FREIGHT AMOUNT ON VOUCHER ENTRY.  IT IS 06450012
064600**       NOT INCLUDED IN THE MONETARY AMOUNT CALCULATION ON THE   06460012
064700**       DISTRIB LINE.  WE ARE MOVING ZEROES TO THIS FIELD SO THAT06470012
064800**       THIS AMOUNT IS NOT SHOWN ON THE SALESTAX EXTRACT FILE    06480012
064900**       WHERE THE DETAIL AMOUNTS APPEAR.                         06490012
065000      IF VOUCHER-STYLE OF FIT00260 = 'THRD'                       06500012
065100         MOVE ZERO TO AP216-MERCHANDISE-AMT                       06510012
065200      ELSE                                                        06520012
065300         MOVE MERCHANDISE-AMT OF FIT00164 TO AP216-MERCHANDISE-AMT06530012
065400      END-IF.                                                     06540012
065500                                                                  06550000
065600      IF  ACTIVITY-ID OF FIT00164 = SPACE                         06560000
065700      OR  PROJECT-ID OF FIT00164 = SPACE                          06570000
065800          MOVE SPACES TO AP216-ACTIVITY-ID                        06580000
065900                         AP216-ACTIVITY-DESCR                     06590000
066000                         AP216-ACTIVITY-TYPE                      06600000
066100                         AP216-ASSET-PROFILE                      06610000
066200      ELSE                                                        06620000
066300*     DISPLAY 'VOUCHER = ' VOUCHER-ID OF FIT00260                 06630000
066400*     DISPLAY 'ACTIVITY-ID = '  ACTIVITY-ID OF FIT00164           06640000
066500*     DISPLAY 'PROJECT-ID = '  PROJECT-ID OF FIT00164             06650000
066600          MOVE ACTIVITY-ID OF FIT00164   TO AP216-ACTIVITY-ID     06660000
066700          MOVE PROFILE-ID OF FIT00164    TO AP216-ASSET-PROFILE   06670000
066800          PERFORM S300-SELECT-ACTIVITY-INFO                       06680000
066900          MOVE DESCR OF FIT00288         TO AP216-ACTIVITY-DESCR  06690000
067000          MOVE ACTIVITY-TYPE OF FIT00288 TO AP216-ACTIVITY-TYPE   06700000
067100      END-IF.                                                     06710000
067200                                                                  06720000
067300      MOVE DEPTID OF FIT00164 TO PV-DEPTID.                       06730000
067400                                                                  06740000
067500** CHECK TO SEE IF DEPTID IS IN LIST TO BE AUDITED.               06750008
067600** IF THE MATCHING DEPTID IS NOT FOUND, THE RECORD IS NOT WRITTEN.06760008
067700      PERFORM VARYING STATE-STORE-SUB FROM 1 BY 1                 06770000
067800        UNTIL STATE-DEPTID(STATE-STORE-SUB) = PV-DEPTID           06780000
067900           OR STATE-DEPTID(STATE-STORE-SUB) > PV-DEPTID           06790000
068000           OR STATE-DEPTID(STATE-STORE-SUB) = SPACE               06800005
068100           OR STATE-STORE-SUB > 9998                              06810000
068200      END-PERFORM.                                                06820000
068300                                                                  06830000
068400      IF STATE-DEPTID(STATE-STORE-SUB) = PV-DEPTID                06840000
068500         MOVE PV-DEPTID(1:5) TO AP216-DEPTID                      06850008
068600         PERFORM W100-WRITE-STATE-TAX-AUDIT                       06860008
068700      END-IF.                                                     06870000
068800                                                                  06880000
068900*--------------------------------------------------------------*  06890000
069000*  END OF PROGRAM PROCESSING                                   *  06900000
069100*--------------------------------------------------------------*  06910000
069200 B500-TERMINATION.                                                06920000
069300                                                                  06930000
069400     DISPLAY '*********************************************'.     06940000
069500     DISPLAY '**      RECORD COUNTS                      **'.     06950000
069600     DISPLAY '*********************************************'.     06960000
069700     DISPLAY 'TOTAL STORES FOR STATE ' PV-STATE-STORE-TOTAL.      06970000
069800     DISPLAY 'AUDIT CURSOR COUNT     ' AUDIT-CSR-COUNT.           06980000
069900     DISPLAY 'AUDIT RECORDS WRITTEN  ' AUDIT-OUT-COUNT.           06990000
070000     DISPLAY '*********************************************'.     07000000
070100     DISPLAY '********  END OF PROGRAM APKUT362  **********'.     07010000
070200     DISPLAY '*********************************************'.     07020000
070300                                                                  07030000
070400     IF CC-XPEDX-INDICATOR = 'Y'                                  07040000
070500        PERFORM Y800-CLOSE-XPEDX-FEED-CSR                         07050000
070600     ELSE                                                         07060000
070700        PERFORM Y600-CLOSE-AUDIT-FEED-CSR                         07070000
070800     END-IF.                                                      07080000
070900                                                                  07090000
071000     CLOSE ORACLE-LOGIN-FILE                                      07100000
071100           STATE-TAX-AUDIT-FILE.                                  07110000
071200                                                                  07120000
071300     DISPLAY '**----------- APKUT362 ENDS ---------------**'.     07130000
071400                                                                  07140000
071500*--------------------------------------------------------------*  07150000
071600*  EXTRACTS THE INFORMATION NEEDED FOR STATE TAX AUDIT         *  07160000
071700*--------------------------------------------------------------*  07170000
071800 F200-FETCH-AUDIT-FEED-CSR.                                       07180000
071900                                                                  07190000
072000     EXEC SQL                                                     07200000
072100         FETCH AUDIT_FEED_CSR                                     07210000
072200          INTO :FIT00260.VOUCHER-ID                               07220000
072300             , :FIT00260.VENDOR-ID                                07230000
072400             , :FIT00260.INVOICE-ID                               07240000
072500             , :FIT00260.INVOICE-DT                               07250000
072600             , :FIT00260.ACCOUNTING-DT                            07260000
072700             , :FIT00260.ORIGIN                                   07270008
072800             , :FIT00260.VOUCHER-STYLE                            07280012
072900             , :FIT00164.ACCOUNT                                  07290000
073000             , :FIT00164.MONETARY-AMOUNT                          07300000
073100             , :FIT00164.FREIGHT-AMT                              07310012
073200             , :FIT00164.SALETX-AMT                               07320012
073300             , :FIT00164.MERCHANDISE-AMT                          07330008
073400             , :FIT00164.DSCNT-AMT                                07340008
073500             , :FIT00164.DEPTID                                   07350000
073600             , :FIT00164.PROJECT-ID                               07360000
073700             , :FIT00164.ACTIVITY-ID                              07370000
073800             , :FIT00164.PROFILE-ID                               07380000
073900             , :FIT00164.BUSINESS-UNIT-PC                         07390000
074000             , :FIT00180.PYMNT-ID-REF                             07400000
074100             , :FIT00180.REMIT-VENDOR                             07410000
074200             , :FIT00180.NAME1                                    07420000
074300             , :FIT00180.PYMNT-DT                                 07430000
074400             , :FIT00170.DESCR                                    07440008
074500     END-EXEC.                                                    07450000
074600                                                                  07460000
074700     EVALUATE TRUE                                                07470000
074800         WHEN SQLCODE = ZERO                                      07480000
074900             ADD 1 TO AUDIT-CSR-COUNT                             07490000
075000             PERFORM B400-PROCESS-AUDIT-CSR                       07500000
075100         WHEN SQLCODE = +01403                                    07510000
075200             SET AUDIT-FEED-END-OF-CSR TO TRUE                    07520000
075300         WHEN OTHER                                               07530000
075400             SET AC-UNSUCCESSFUL-SELECT    TO TRUE                07540000
075500             MOVE 'F300-FETCH-AUDIT-CSR'   TO AA-PARAGRAPH-NAME   07550000
075600             MOVE 'UNSUCCESSFUL FETCH '    TO AA-ORA-OPERATION    07560000
075700             MOVE 'PS_PAYMENT_TBL'         TO AA-ORA-TABLE-1      07570000
075800             MOVE 'PS_VOUCHER'             TO AA-ORA-TABLE-2      07580000
075900             MOVE 'PS_A22_VOU_INFO'        TO AA-ORA-TABLE-3      07590000
076000             PERFORM Z998-ORA-ABEND                               07600000
076100     END-EVALUATE.                                                07610000
076200                                                                  07620000
076300*--------------------------------------------------------------*  07630000
076400*  EXTRACTS THE INFORMATION NEEDED FOR STATE TAX AUDIT AND     *  07640000
076500*  INCLUDES XPEDX INVOICES.                                    *  07650000
076600*--------------------------------------------------------------*  07660000
076700 F400-FETCH-XPEDX-FEED-CSR.                                       07670000
076800                                                                  07680000
076900     EXEC SQL                                                     07690000
077000         FETCH XPEDX_FEED_CSR                                     07700000
077100          INTO :FIT00260.VOUCHER-ID                               07710008
077200             , :FIT00260.VENDOR-ID                                07720008
077300             , :FIT00260.INVOICE-ID                               07730008
077400             , :FIT00260.INVOICE-DT                               07740008
077500             , :FIT00260.ACCOUNTING-DT                            07750008
077600             , :FIT00260.ORIGIN                                   07760008
077700             , :FIT00260.VOUCHER-STYLE                            07770012
077800             , :FIT00164.ACCOUNT                                  07780008
077900             , :FIT00164.MONETARY-AMOUNT                          07790008
078000             , :FIT00164.FREIGHT-AMT                              07800012
078100             , :FIT00164.SALETX-AMT                               07810012
078200             , :FIT00164.MERCHANDISE-AMT                          07820008
078300             , :FIT00164.DSCNT-AMT                                07830008
078400             , :FIT00164.DEPTID                                   07840008
078500             , :FIT00164.PROJECT-ID                               07850008
078600             , :FIT00164.ACTIVITY-ID                              07860008
078700             , :FIT00164.PROFILE-ID                               07870008
078800             , :FIT00164.BUSINESS-UNIT-PC                         07880008
078900             , :FIT00180.PYMNT-ID-REF                             07890008
079000             , :FIT00180.REMIT-VENDOR                             07900008
079100             , :FIT00180.NAME1                                    07910008
079200             , :FIT00180.PYMNT-DT                                 07920008
079300             , :FIT00170.DESCR                                    07930008
079400     END-EXEC.                                                    07940000
079500                                                                  07950000
079600     EVALUATE TRUE                                                07960000
079700         WHEN SQLCODE = ZERO                                      07970000
079800             ADD 1 TO AUDIT-CSR-COUNT                             07980000
079900             PERFORM B400-PROCESS-AUDIT-CSR                       07990000
080000         WHEN SQLCODE = +01403                                    08000000
080100             SET XPEDX-FEED-END-OF-CSR TO TRUE                    08010000
080200         WHEN OTHER                                               08020000
080300             SET AC-UNSUCCESSFUL-SELECT    TO TRUE                08030000
080400             MOVE 'F300-FETCH-AUDIT-CSR'   TO AA-PARAGRAPH-NAME   08040000
080500             MOVE 'UNSUCCESSFUL FETCH '    TO AA-ORA-OPERATION    08050000
080600             MOVE 'PS_PAYMENT_TBL'         TO AA-ORA-TABLE-1      08060000
080700             MOVE 'PS_VOUCHER'             TO AA-ORA-TABLE-2      08070000
080800             MOVE 'PS_A22_VOU_INFO'        TO AA-ORA-TABLE-3      08080000
080900             PERFORM Z998-ORA-ABEND                               08090000
081000     END-EVALUATE.                                                08100000
081100                                                                  08110000
081200*--------------------------------------------------------------*  08120003
081300* READ THE STATE TAX AUDIT DEPTID LIST FILE                    *  08130003
081400*--------------------------------------------------------------*  08140003
081500 R100-READ-DEPTID-FILE.                                           08150003
081600                                                                  08160003
081700     READ DEPTID-SELECTION-FILE INTO SI-DEPTID-RECORD             08170003
081800       AT END                                                     08180003
081900          SET END-OF-DEPTID-FILE TO TRUE                          08190003
082000       NOT AT END                                                 08200003
082100          ADD 1                  TO DEPTID-COUNT                  08210004
082200     END-READ.                                                    08220003
082300                                                                  08230003
082400*--------------------------------------------------------------*  08240000
082500*  THIS SELECTS THE THE VENDOR NAME FROM THE VENDOR TABLE      *  08250000
082600*  WHEN THE MERCHANDISE CAME FROM A DIFFERENT VENDOR THAN      *  08260000
082700*  THE VENDOR BEING PAID.                                      *  08270000
082800*--------------------------------------------------------------*  08280000
082900 S100-SELECT-VENDOR-NAME.                                         08290000
083000                                                                  08300000
083100     EXEC SQL                                                     08310000
083200         SELECT NAME1                                             08320000
083300           INTO :FIT00236.NAME1                                   08330000
083400           FROM PS_VENDOR                                         08340000
083500          WHERE VENDOR_ID = :FIT00260.VENDOR-ID                   08350000
083600            AND SETID     = 'SHARE'                               08360000
083700     END-EXEC.                                                    08370000
083800                                                                  08380000
083900     EVALUATE TRUE                                                08390000
084000         WHEN SQLCODE = ZERO                                      08400000
084100             CONTINUE                                             08410000
084200         WHEN OTHER                                               08420000
084300             DISPLAY 'REMIT VENDOR ' REMIT-VENDOR OF FIT00180     08430000
084400             DISPLAY 'VENDOR       ' VENDOR-ID OF FIT00260        08440000
084500             SET AC-UNSUCCESSFUL-SELECT     TO TRUE               08450000
084600             MOVE 'S100-SELECT-VENDOR-NAME' TO AA-PARAGRAPH-NAME  08460000
084700             MOVE 'UNSUCCESSFUL SELECT'     TO AA-ORA-OPERATION   08470000
084800             MOVE 'PS_VENDOR'               TO AA-ORA-TABLE-1     08480000
084900             MOVE SPACES                    TO AA-ORA-TABLE-2     08490000
085000             MOVE SPACES                    TO AA-ORA-TABLE-3     08500000
085100             PERFORM Z998-ORA-ABEND                               08510000
085200     END-EVALUATE.                                                08520000
085300                                                                  08530000
085400                                                                  08540005
085500*--------------------------------------------------------------*  08550000
085600*  THIS SELECTS THE ACTIVITY DESC AND TYPE FROM THE PROJECT    *  08560000
085700*  ACTIVITY TABLE FOR VOUCHERS WHERE THE PROJECT AND ACTIVITY  *  08570000
085800*  ID WERE NOT BLANK.                                          *  08580000
085900*--------------------------------------------------------------*  08590000
086000 S300-SELECT-ACTIVITY-INFO.                                       08600000
086100                                                                  08610000
086200     EXEC SQL                                                     08620000
086300         SELECT DESCR                                             08630000
086400              , ACTIVITY_TYPE                                     08640000
086500           INTO :FIT00288.DESCR                                   08650000
086600              , :FIT00288.ACTIVITY-TYPE                           08660000
086700           FROM PS_PROJ_ACTIVITY                                  08670000
086800          WHERE BUSINESS_UNIT = :FIT00164.BUSINESS-UNIT-PC        08680000
086900            AND PROJECT_ID = :FIT00164.PROJECT-ID                 08690000
087000            AND ACTIVITY_ID = :FIT00164.ACTIVITY-ID               08700000
087100     END-EXEC.                                                    08710000
087200                                                                  08720000
087300     EVALUATE TRUE                                                08730000
087400         WHEN SQLCODE = ZERO                                      08740000
087500             CONTINUE                                             08750000
087600         WHEN SQLCODE = +01403                                    08760000
087700             MOVE SPACE TO DESCR OF FIT00288                      08770000
087800                           ACTIVITY-TYPE OF FIT00288              08780000
087900         WHEN OTHER                                               08790000
088000             DISPLAY 'VOUCHER = ' VOUCHER-ID OF FIT00260          08800000
088100             DISPLAY 'ACTIVITY-ID = '  ACTIVITY-ID OF FIT00164    08810000
088200             DISPLAY 'PROJECT-ID = '  PROJECT-ID OF FIT00164      08820000
088300             SET AC-UNSUCCESSFUL-SELECT     TO TRUE               08830000
088400             MOVE 'S300-SELECT-ACTIVITY-INFO' TO AA-PARAGRAPH-NAME08840000
088500             MOVE 'UNSUCCESSFUL SELECT'     TO AA-ORA-OPERATION   08850000
088600             MOVE 'PS_PROJ_ACTIVITY'        TO AA-ORA-TABLE-1     08860000
088700             MOVE SPACES                    TO AA-ORA-TABLE-2     08870000
088800             MOVE SPACES                    TO AA-ORA-TABLE-3     08880000
088900             PERFORM Z998-ORA-ABEND                               08890000
089000     END-EVALUATE.                                                08900000
089100                                                                  08910000
089200*--------------------------------------------------------------*  08920000
089300*  THIS ROUTINE WRITES A RECORD TO THE AUDIT EXTRACT FILE      *  08930000
089400*--------------------------------------------------------------*  08940000
089500 W100-WRITE-STATE-TAX-AUDIT.                                      08950000
089600                                                                  08960000
089700     WRITE STATE-TAX-AUDIT-RECORD                                 08970000
089800           FROM AP216-STATE-TAX-AUDIT-RECORD.                     08980000
089900     ADD 1 TO AUDIT-OUT-COUNT.                                    08990000
090000                                                                  09000000
090100*--------------------------------------------------------------*  09010000
090200*  THIS ROUTINE OPENS THE AUDIT FEED CURSOR                    *  09020000
090300*--------------------------------------------------------------*  09030000
090400 Y500-OPEN-AUDIT-FEED-CSR.                                        09040000
090500                                                                  09050000
090600     EXEC SQL                                                     09060000
090700         OPEN AUDIT_FEED_CSR                                      09070000
090800     END-EXEC.                                                    09080000
090900                                                                  09090000
091000     EVALUATE TRUE                                                09100000
091100         WHEN SQLCODE = ZERO                                      09110000
091200             CONTINUE                                             09120000
091300         WHEN OTHER                                               09130000
091400             SET AC-OPEN-ERROR TO TRUE                            09140000
091500             MOVE 'Y500-OPEN-AUDIT-FEED-CSR' TO AA-PARAGRAPH-NAME 09150000
091600             MOVE 'UNSUCCESSFUL OPEN'    TO AA-ORA-OPERATION      09160000
091700             MOVE 'PS_VOUCHER'           TO AA-ORA-TABLE-1        09170000
091800             PERFORM Z998-ORA-ABEND                               09180000
091900     END-EVALUATE.                                                09190000
092000                                                                  09200000
092100*--------------------------------------------------------------*  09210000
092200*  THIS ROUTINE CLOSES THE AUDIT FEED CURSOR                   *  09220000
092300*--------------------------------------------------------------*  09230000
092400 Y600-CLOSE-AUDIT-FEED-CSR.                                       09240000
092500                                                                  09250000
092600     EXEC SQL                                                     09260000
092700         CLOSE AUDIT_FEED_CSR                                     09270000
092800     END-EXEC.                                                    09280000
092900                                                                  09290000
093000     EVALUATE TRUE                                                09300000
093100         WHEN SQLCODE = ZERO                                      09310000
093200             CONTINUE                                             09320000
093300         WHEN OTHER                                               09330000
093400             SET AC-CLOSE-ERROR TO TRUE                           09340000
093500        MOVE 'Y600-CLOSE-AUDIT-FEED-CSR'  TO AA-PARAGRAPH-NAME    09350000
093600             MOVE 'UNSUCCESSFUL CLOSE'    TO AA-ORA-OPERATION     09360000
093700             MOVE 'PS_VOUCHER'            TO AA-ORA-TABLE-1       09370000
093800             PERFORM Z998-ORA-ABEND                               09380000
093900     END-EVALUATE.                                                09390000
094000                                                                  09400000
094100*--------------------------------------------------------------*  09410000
094200*  THIS ROUTINE OPENS THE XPEDX FEED CURSOR                    *  09420000
094300*--------------------------------------------------------------*  09430000
094400 Y700-OPEN-XPEDX-FEED-CSR.                                        09440000
094500                                                                  09450000
094600     EXEC SQL                                                     09460000
094700         OPEN XPEDX_FEED_CSR                                      09470000
094800     END-EXEC.                                                    09480000
094900                                                                  09490000
095000     EVALUATE TRUE                                                09500000
095100         WHEN SQLCODE = ZERO                                      09510000
095200             CONTINUE                                             09520000
095300         WHEN OTHER                                               09530000
095400             SET AC-OPEN-ERROR TO TRUE                            09540000
095500             MOVE 'Y700-OPEN-XPEDX-FEED-CSR' TO AA-PARAGRAPH-NAME 09550000
095600             MOVE 'UNSUCCESSFUL OPEN'    TO AA-ORA-OPERATION      09560000
095700             MOVE 'PS_VOUCHER'           TO AA-ORA-TABLE-1        09570000
095800             PERFORM Z998-ORA-ABEND                               09580000
095900     END-EVALUATE.                                                09590000
096000                                                                  09600000
096100*--------------------------------------------------------------*  09610000
096200*  THIS ROUTINE CLOSES THE XPEDX FEED CURSOR                   *  09620000
096300*--------------------------------------------------------------*  09630000
096400 Y800-CLOSE-XPEDX-FEED-CSR.                                       09640000
096500                                                                  09650000
096600     EXEC SQL                                                     09660000
096700         CLOSE XPEDX_FEED_CSR                                     09670000
096800     END-EXEC.                                                    09680000
096900                                                                  09690000
097000     EVALUATE TRUE                                                09700000
097100         WHEN SQLCODE = ZERO                                      09710000
097200             CONTINUE                                             09720000
097300         WHEN OTHER                                               09730000
097400             SET AC-CLOSE-ERROR TO TRUE                           09740000
097500        MOVE 'Y800-CLOSE-XPEDX-FEED-CSR'  TO AA-PARAGRAPH-NAME    09750000
097600             MOVE 'UNSUCCESSFUL CLOSE'    TO AA-ORA-OPERATION     09760000
097700             MOVE 'PS_VOUCHER'            TO AA-ORA-TABLE-1       09770000
097800             PERFORM Z998-ORA-ABEND                               09780000
097900     END-EVALUATE.                                                09790000
098000                                                                  09800000
098100*--------------------------------------------------------------*  09810000
098200*  THIS ROUTINE CALLS THE NEW FISCAL CALENDAR SUBROUTINE       *  09820000
098300*  TO OBTAIN DATE, PROGRAM NAME DPKUT500                       *  09830000
098400*--------------------------------------------------------------*  09840000
098500 Z900-CALENDAR-ROUTINE.                                           09850000
098600                                                                  09860000
098700     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51                09870000
098800                                             DPG52                09880000
098900                                             DPG53                09890000
099000                                             DPG54                09900000
099100                                             DPG55                09910000
099200                                             DPG56.               09920000
099300                                                                  09930000
099400*--------------------------------------------------------------*  09940000
099500*  ORACLE ABEND ROUTINE                                        *  09950000
099600*--------------------------------------------------------------*  09960000
099700 Z998-ORA-ABEND.                                                  09970000
099800                                                                  09980000
099900     DISPLAY '*********************************************'.     09990000
100000     DISPLAY '!!!!!!!!  PROGRAM APKUT362 ABENDING  !!!!!!!!'.     10000000
100100     DISPLAY '*********************************************'.     10010000
100200     DISPLAY 'TOTAL STORES FOR STATE ' STATE-STORE-SUB.           10020000
100300     DISPLAY 'AUDIT CURSOR COUNT     ' AUDIT-CSR-COUNT.           10030000
100400     DISPLAY 'AUDIT RECORDS WRITTEN  ' AUDIT-OUT-COUNT.           10040000
100500     DISPLAY '*********************************************'.     10050000
100600     DISPLAY '!!!!!!!!  PROGRAM APKUT362 ABENDING  !!!!!!!!'.     10060000
100700     DISPLAY '*********************************************'.     10070000
100800                                                                  10080000
100900     CLOSE ORACLE-LOGIN-FILE                                      10090000
101000           STATE-TAX-AUDIT-FILE.                                  10100000
101100                                                                  10110000
101200     DISPLAY AA-ABEND-LIT.                                        10120000
101300     DISPLAY AA-ORA-ERROR-LIT.                                    10130000
101400     DISPLAY AA-PROGRAM-LIT.                                      10140000
101500     DISPLAY AA-PARAGRAPH-LIT.                                    10150000
101600     DISPLAY AA-ORA-OPERATION-LIT.                                10160000
101700     DISPLAY AA-ORA-TABLE-1.                                      10170000
101800     DISPLAY AA-ORA-TABLE-2.                                      10180000
101900     DISPLAY AA-ORA-TABLE-3.                                      10190000
102000     SET AC-ORA-ERROR TO TRUE.                                    10200000
102100                                                                  10210000
102200     COPY DPPD004.                                                10220000
102300                                                                  10230000
102400     CALL 'ILBOABN0' USING ABEND-CODE.                            10240000
102500                                                                  10250000
102600*--------------------------------------------------------------*  10260000
102700*  ABEND ROUTINE                                               *  10270000
102800*--------------------------------------------------------------*  10280000
102900 Z999-ABEND.                                                      10290000
103000                                                                  10300000
103100     DISPLAY '*********************************************'.     10310000
103200     DISPLAY '!!!!!!!!  PROGRAM APKUT362 ABENDING  !!!!!!!!'.     10320000
103300     DISPLAY '*********************************************'.     10330000
103400     DISPLAY 'TOTAL STORES FOR STATE ' STATE-STORE-SUB.           10340000
103500     DISPLAY 'AUDIT CURSOR COUNT     ' AUDIT-CSR-COUNT.           10350000
103600     DISPLAY 'AUDIT RECORDS WRITTEN  ' AUDIT-OUT-COUNT.           10360000
103700     DISPLAY '*********************************************'.     10370000
103800     DISPLAY '!!!!!!!!  PROGRAM APKUT362 ABENDING  !!!!!!!!'.     10380000
103900     DISPLAY '*********************************************'.     10390000
104000                                                                  10400000
104100     CLOSE ORACLE-LOGIN-FILE                                      10410000
104200           STATE-TAX-AUDIT-FILE.                                  10420000
104300                                                                  10430000
104400     DISPLAY AA-ABEND-LIT.                                        10440000
104500     DISPLAY AA-PROGRAM-LIT.                                      10450000
104600     DISPLAY AA-PARAGRAPH-LIT.                                    10460000
104700     DISPLAY AA-MESSAGE-LINE.                                     10470000
104800                                                                  10480000
104900     CALL 'ILBOABN0' USING ABEND-CODE.                            10490000
