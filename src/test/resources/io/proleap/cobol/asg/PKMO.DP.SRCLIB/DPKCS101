000100******************************************************************00010000
000200*                                                                *00020000
000300* MODULE NAME = DPKCS101                                         *00030000
000400*                                                                *00040000
000500* DESCRIPTIVE NAME = CICS/ESA(SAMPLE)   Terminal Autoinstall     *00050000
000600*                                       User Program (COBOL) @P2A*00060000
000700*                                                                *00070000
000800*     5655-018                                                   *00080000
000900*     COPYRIGHT = NONE                                           *00090000
001000*                                                                *00100000
001100* STATUS = 4.1.0                                                * 00110000
001200*                                                                *00120000
001300* FUNCTION = Provide user input to Terminal Autoinstall          *00130000
001400*            processing.                                     @P2A*00140000
001500*                                                                *00150000
001600*            This module must be compiled with COBOL II compiler.*00160000
001700*                                                                *00170000
001800*            This module is a component of ZCP.                  *00180000
001900*                                                                *00190000
002000*            It is called via an DFHPC CTYPE=LINK-URM, from      *00200000
002100*            DFHZATA (INSTALL) and DFHZATD (DELETE).             *00210000
002200*                                                                *00220000
002300*            Input to the module is a parameter list addressed   *00230000
002400*            by DFHEICAP.                                        *00240000
002500*                                                                *00250000
002600*            The program is invoked when:                        *00260000
002700*            1) An autoinstall INSTALL is in progress            *00270000
002800*            2) An autoinstall DELETE has just completed         *00280000
002900*                                                                *00290000
003000*            The function to be performed is indicated via the   *00300000
003100*            passed parameter list. This is evaluated during     *00310000
003200*            common initialisation processing, and control       *00320000
003300*            passed to the appropriate routine.                  *00330000
003400*                                                                *00340000
003500*  Function 1 - INSTALL                                          *00350000
003600*  --------------------                                          *00360000
003700*  The primary purpose of this function is to complete the       *00370000
003800*  SELECTED-PARMS fields.  They are used as input to an auto-    *00380000
003900*  install resource 'builder' request.                           *00390000
004000*                                                                *00400000
004100*  The following fields may already have been supplied by MTS:   *00410000
004200*     SELECTED-MODELNAME                                         *00420000
004300*     SELECTED-PRINTER-NETNAME                                   *00430000
004400*     SELECTED-ALTPRINTER-NETNAME                                *00440000
004500*  The following fields should be set (if not supplied by MTS):  *00450000
004600*     SELECTED-MODELNAME                                         *00460000
004700*  The following fields should be set:                           *00470000
004800*     SELECTED-TERM-ID                                           *00480000
004900*     SELECTED-RETURN-CODE                                       *00490000
005000*  The following fields may be set.                              *00500000
005100*     SELECTED-PRINTER-ID                                        *00510000
005200*     SELECTED-ALTPRINTER-ID                                     *00520000
005300*                                                                *00530000
005400*  The default action of this program is:                        *00540000
005500*                                                                *00550000
005600*  - If the modelname list contains no elements, then return     *00560000
005700*  - If the first character of SELECTED-MODELNAME is blank       *00570000
005800*    (Not supplied by MTS), then copy the first modelname in     *00580000
005900*    MODELNAME-LIST into SELECTED-MODELNAME.                     *00590000
006000*  - Copy the last 4 non-blank characters of the passed Netname t*00600000
006100*    SELECTED-TERM-ID.                                           *00610000
006200*  - Set the SELECTED-RETURN-CODE to RETURN-OK to indicate that  *00620000
006300*    a selection has been made.                                  *00630000
006400*  - Return to the calling program.                              *00640000
006500*                                                                *00650000
006600*  EXIT-NORMAL =                                                 *00660000
006700*       Exit is via an EXEC CICS RETURN command.                 *00670000
006800*       Status is set to zero if all processing completes normall*00680000
006900*                                                                *00690000
007000*  EXIT-ERROR =                                                  *00700000
007100*       Exit is via an EXEC CICS RETURN command.                 *00710000
007200*       RETURN-CODE is non-zero on entry to this module and is   *00720000
007300*       untouched if any error occurs, hence, a non-zero return  *00730000
007400*       code is passed back to the calling program.              *00740000
007500*                                                                *00750000
007600*  Function 2 - autoinstall DELETE                               *00760000
007700*  -------------------------------                               *00770000
007800*                                                                *00780000
007900*  This function gives the user the opportunity to perform       *00790000
008000*  processing when an autoinstall'ed terminal has been deleted.  *00800000
008100*                                                                *00810000
008200*  The default action of this program is to establish            *00820000
008300*  addressability to the parameter list, and RETURN.             *00830000
008400*                                                                *00840000
008500*                                                                *00850000
008600*    EXIT-NORMAL =                                               *00860000
008700*         Exit is via an EXEC CICS RETURN command.               *00870000
008800*                                                                *00880000
008900*  Function 7 & 8 - autoinstall of a shipped definition          *00890000
009000*  ---------------------------------------------------------     *00900000
009100*                                                                *00910000
009200*  The primary purpose of this function is to validate the       *00920000
009300*  SELECTED_TERMID field.  This is used as input to an auto-     *00930000
009400*  install resource 'builder' request.                           *00940000
009500*                                                                *00950000
009600*  The fields are described in more detail in DFHTCUDS.          *00960000
009700*                                                                *00970000
009800*  The following input fields are supplied:                      *00980000
009900*     INSTALL_SHIPPED_CLASH       -> Y/N                         *00990000
010000*     INSTALL_SHIPPED_NETNAME_PTR -> NETNAME_FIELD               *01000000
010100*     INSTALL_SHIPPED_TERMID_PTR  -> incoming TERMID             *01010000
010200*     INSTALL_SHIPPED_APPLID_PTR  -> APPLID of TOR               *01020000
010300*     INSTALL_SHIPPED_SYSID_PTR   -> SYSID of incoming request   *01030000
010400*     INSTALL_SHIPPED_CORRID_PTR  -> Correlation token           *01040000
010500*                                                                *01050000
010600*  The following fields should be set on exit:                   *01060000
010700*     SELECTED_TERM_ID                                           *01070000
010800*     SELECTED_RETURN_CODE                                       *01080000
010900*  EXIT-NORMAL =                                                 *01090000
011000*     Exit is via an EXEC CICS RETURN command.                   *01100000
011100*     Status is set to zero if all processing completes normally.*01110000
011200*                                                                *01120000
011300*  EXIT-ERROR =                                                  *01130000
011400*     Exit is via an EXEC CICS RETURN command.                   *01140000
011500*     RETURN_CODE is non-zero on entry to this module and is     *01150000
011600*     untouched if any error occurs, hence, a non-zero return    *01160000
011700*     code is passed back to the calling program.                *01170000
011800*                                                                *01180000
011900*  Function 10 & 11 - autoinstall delete of shipped definition   *01190000
012000*  -----------------------------------------------------------   *01200000
012100*                                                                *01210000
012200*  This function gives the user the opportunity to perform       *01220000
012300*  processing when an autoinstall'ed terminal has been deleted.  *01230000
012400*                                                                *01240000
012500*  The default action of this program is to establish            *01250000
012600*  addressability to the parameter list, and RETURN.             *01260000
012700*                                                                *01270000
012800*                                                                *01280000
012900*    EXIT-NORMAL =                                               *01290000
013000*         Exit is via an EXEC CICS RETURN command.               *01300000
013100*----------------------------------------------------------------*01310000
013200*                                                                *01320000
013300* ENTRY POINT = DPKCS101                                         *01330000
013400*                                                                *01340000
013500*     PURPOSE = All Functions                                    *01350000
013600*                                                                *01360000
013700*     The request type is analysed, and control passsed to the   *01370000
013800*     appropriate routine.                                       *01380000
013900*                                                                *01390000
014000*                                                                *01400000
014100*----------------------------------------------------------------*01410000
014200*                                                                *01420000
014300* EXTERNAL REFERENCES = None                                     *01430000
014400*                                                                *01440000
014500*     ROUTINES =                                                 *01450000
014600*         EXEC CICS RETURN - return to calling program           *01460000
014700*                                                                *01470000
014800*                                                                *01480000
014900*     CONTROL BLOCKS =                                           *01490000
015000*         See FUNCTION section for description of input          *01500000
015100*         parameters                                             *01510000
015200*                                                                *01520000
015300*----------------------------------------------------------------*01530000
015400*                                                                *01540000
015500* DESCRIPTION                                                    *01550000
015600*                                                                *01560000
015700* A check is made to ensure the presence of the input parameters *01570000
015800* (passed via COMMAREA). If these do not exist, then return is   *01580000
015900* made to the calling program.                                   *01590000
016000*                                                                *01600000
016100* The type of request(INSTALL|DELETE) is then determined, and a  *01610000
016200* branch taken to the appropriate function routine(see 'FUNCTION'*01620000
016300* above for details).                                            *01630000
016400*                                                                *01640000
016500*--------------------------------------------------------------- *01650000
016600*                                                                *01660000
016700* CHANGE ACTIVITY :                                              *01670000
016800*                                                                *01680000
016900*     PN= REASON REL YYMMDD HDXIII : REMARKS                     *01690000
017000*    $D1= I06615 410 950614 HD6NPRW: Shipped URM                 *01700000
017100*    $P0=        170 850514        : Created.                    *01710000
017200*    $P1= M90474 330 910807 HDBWSH : Prologue fixed.             *01720000
017300*    $P2= M83127 410 930709 HDAFDRB: Correct prologue comments.  *01730000
017400*                                                                *01740000
017500******************************************************************01750000
017600  IDENTIFICATION DIVISION.                                        01760000
017700  PROGRAM-ID. DPKCS101.                                           01770000
017800                                                                  01780000
017900  ENVIRONMENT DIVISION.                                           01790000
018000                                                                  01800000
018100  DATA DIVISION.                                                  01810000
018200  WORKING-STORAGE SECTION.                                        01820000
018300*                                                                 01830000
018400* CODES SUPPLIED BY COMMAREA:                                     01840000
018500*                                                                 01850000
018600  77  install-code        PIC X(1) VALUE IS '0'.                  01860000
018700  77  delete-code         PIC X(1) VALUE IS '1'.                  01870000
018800  77  install-sterm       PIC X(1) VALUE IS '7'.                  01880000
018900  77  install-srse        PIC X(1) VALUE IS '8'.                  01890000
019000  77  delete-sterm        PIC X(1) VALUE IS X'FA'.                01900008
019100  77  delete-srse         PIC X(1) VALUE IS X'FB'.                01910008
019200*                                                                 01920000
019300* RETURN CODES:                                                   01930000
019400*                                                                 01940000
019500  77  return-ok           PIC X(1) VALUE IS LOW-VALUES.           01950000
019600  77  reject              PIC X(1) VALUE IS X'01'.                01960008
019601 01  WM-WRITEQ-MESSAGE1.                                          01960100
019602     05  FILLER          PIC X(15) VALUE '***** TERMINAL '.       01960200
019603     05  WM-TERMINAL     PIC X(4) VALUE SPACES.                   01960300
019604     05  FILLER          PIC X(22) VALUE ' HAS NO ENTRY IN TABLE'.01960400
019605     05  FILLER          PIC X(13) VALUE ' FOR DPKCS101'.         01960500
019606 01  WM-WRITEQ-MESSAGE2.                                          01960600
019607     05  FILLER          PIC X(16) VALUE '***** CNTL UNIT '.      01960700
019608     05  WM-CNTLUNIT     PIC X(2)  VALUE SPACES.                  01960800
019609     05  FILLER          PIC X(22) VALUE ' HAS NO ENTRY IN TABLE'.01960900
019610     05  FILLER          PIC X(13) VALUE ' FOR DPKCS101'.         01961000
019620*                                                                 01962000
019630* STRUCTURE TO ALLOW THE LAST FOUR CHARACTERS TO BE USED AS       01963000
019640* THE NETNAME.                                                    01964000
019650*                                                                 01965000
019660  01  net-sub1              pic s9(2) comp value 8.               01966000
019670  01  net-sub2              pic s9(2) comp value 0.               01967000
019680  01  netname-bits.                                               01968000
019690      02  net-chr           pic x(1) occurs 8.                    01969000
019700*                                                                 01970000
019800* TERMINAL IDENTIFIER IS BUILT HERE BEFORE BEING PLACED IN THE    01980000
019900* RETURN FIELD.                                                   01990000
020000*                                                                 02000000
020100  01  term-idnt.                                                  02010000
020200      02 term-chr           pic x(1) occurs 4.                    02020000
020300  01  TI-TERM-IDNT-ALT REDEFINES term-idnt.                       02030000
020400      05 TI-TERM-CHR1-CHR2   PIC X(2).                            02040000
020500      05 FILLER              PIC X(2).                            02050000
020600  01  DT-DUMMY-TERM.                                              02060000
020700      05 DT-CNTL-UNIT-ID     PIC X(2) VALUE SPACES.               02070000
020800      05 FILLER              PIC X(2) VALUE 'XX'.                 02080000
020900  01  DE-DB2-ERROR-MSG.                                           02090000
021000      05 FILLER              PIC X(34) VALUE                      02100000
021010              'DB2 ERROR - DPKCS101 - SQLCODE = ('.               02101000
021011      05 DE-SQLCODE          PIC Z(8)9- VALUE ZERO.               02101100
021012      05 FILLER              PIC X VALUE ')'.                     02101200
021013      05 FILLER              PIC X(8) VALUE                       02101300
021014              'ERRMC = '.                                         02101400
021015      05 DE-SQLERRMC         PIC X(72) VALUE SPACES.              02101500
021016******************************************************************02101600
021017*    STANDARD SQLCA2 COPY MEMBER                                  02101700
021018******************************************************************02101800
021019     COPY SQLCA2.                                                 02101900
021020      EXEC SQL                                                    02102000
021021          INCLUDE TTRM000                                         02102100
021022      END-EXEC.                                                   02102200
021023      EXEC SQL                                                    02102300
021024          INCLUDE SQLCA                                           02102400
021025      END-EXEC.                                                   02102500
021026  linkage section.                                                02102600
021027  01  dfhcommarea.                                                02102700
021028     COPY DFHTCUDS.                                               02102800
021029  01  sterm-idnt.                                                 02102900
021030      02 sterm-chr          pic x(1) occurs 4.                    02103000
021040                                                                  02104000
021050*                                                       @BA83325C 02105000
021060* The IBM supplied structure for MODELNAME-LIST is for a single   02106000
021070* modelname.  If you need to select the 2nd or subsequent         02107000
021080* modelname you can use a structure similar to the following:     02108000
021090*                                                                 02109000
021100* 01  modelname-list.                                             02110000
021200*     02  modelname-count           PIC X(2).                     02120000
021300*     02  modelname-names           PIC X(8) occurs 1 to 999      02130000
021400*                                   depending on modelname-count. 02140000
021500*                                                                 02150000
021600 procedure division.                                              02160000
021700*                                                                 02170000
021800* CHECK THAT WE HAVE A COMMAREA, IF NOT THEN EXIT                 02180000
021900*                                                                 02190000
022000     if eibcalen not equal 0                                      02200000
022100*                                                                 02210000
022200* EXECUTE THE APPROPRIATE PARAGRAPH FOR INSTALL OR DELETE:        02220000
022300*                                                                 02230000
022400        if install-exit-function equal install-code then          02240000
022500           perform install-paragraph                              02250000
022600        end-if                                                    02260000
022700*                                                                 02270000
022800* IF THE REQUEST WAS AN INSTALL REQUEST THEN THE NEXT TEST        02280000
022900* WILL FAIL ANYWAY, IE. FANCY LOGIC NOT REQUIRED!                 02290000
023000*                                                                 02300000
023100        if delete-exit-function equal delete-code then            02310000
023200           perform delete-paragraph                               02320000
023300        end-if                                                    02330000
023400*                                                                 02340000
023500       if install-shipped-exit-function equal install-sterm then  02350000
023600          perform install-shipped-paragraph                       02360000
023700        end-if                                                    02370000
023800*                                                                 02380000
023900       if install-shipped-exit-function equal install-srse then   02390000
024000          perform install-shipped-paragraph                       02400000
024100        end-if                                                    02410000
024200*                                                                 02420000
024300        if delete-exit-function equal delete-sterm then           02430000
024400           perform delete-paragraph                               02440000
024500        end-if                                                    02450000
024600*                                                                 02460000
024700        if delete-exit-function equal delete-srse then            02470000
024800           perform delete-paragraph                               02480000
024900        end-if                                                    02490000
025000*                                                                 02500000
025100* RETURN TO CICS.                                                 02510000
025200*                                                                 02520000
025300     end-if.                                                      02530000
025400 return-line.                                                     02540000
025500     exec cics return end-exec.                                   02550000
025600     goback.                                                      02560000
025700*                                                                 02570000
025800*                                                                 02580000
025900 install-paragraph.                                               02590000
026000*                                                                 02600000
026100* SET UP ADDRESSABILITY TO THE COMMAREA.                          02610000
026200*                                                                 02620000
026300     set address of netname-field to install-netname-ptr.         02630000
026400*                                                                 02640000
026500     set address of modelname-list to install-modelname-ptr.      02650000
026600*                                                                 02660000
026700     set address of selected-parms to install-selected-ptr.       02670000
026800*                                                                 02680000
026900* CHECK IF WE HAVE MODELS TO USE, IF NOT THEN EXIT.               02690000
027000*                                                                 02700000
027100     if modelname-count not equal 0                               02710000
027200*                                                                 02720000
027300* MOVE THE NETNAME SO THAT IT CAN BE DEALT WITH ON A CHARACTER TO 02730000
027400* CHARACTER BASIS.                                                02740000
027500*                                                                 02750000
027600        move netname to netname-bits                              02760000
027700*                                                                 02770000
027800* RESET NETNAME LENGTH IF THERE ARE TRAILING SPACES.              02780000
027900*                                                                 02790000
028000        perform with test before                                  02800000
028100                varying net-sub1 from netname-length by -1        02810000
028200                until (net-chr(net-sub1) not = space)             02820000
028300                      or (net-sub1 = 4)                           02830000
028400        end-perform                                               02840000
028500                                                                  02850000
028600        subtract 3 from net-sub1                                  02860000
028700                                                                  02870000
028800        perform with test after                                   02880000
028900                varying net-sub2 from 1 by 1                      02890000
029000                until net-sub2 = 4                                02900000
029100             move net-chr(net-sub1) to term-chr(net-sub2)         02910000
029200             add 1 to net-sub1                                    02920000
029300        end-perform                                               02930000
029400                                                                  02940000
029500*                                                                 02950000
029600* PLACE TERM-IDNT INTO SELECTED Parameterd                        02960000
029700*                                                                 02970000
029800        move term-idnt to selected-term-id                        02980000
029900                          TTRM000-TERMINAL-NMBR                   02990000
030000*                                                                 03000000
030100* GET PRINTER INFO FROM TABLE                                     03010000
030200*                                                                 03020000
030300     EXEC CICS HANDLE ABEND END-EXEC                              03030000
030400     EXEC SQL                                                     03040000
030500         SELECT TERMINAL_NMBR,                                    03050000
030600                PRINTER_NMBR                                      03060000
030700         INTO :TTRM000-TERMINAL-NMBR,                             03070000
030800              :TTRM000-PRINTER-NMBR                               03080000
030900         FROM TTRM000                                             03090000
030910         WHERE TERMINAL_NMBR = :TTRM000-TERMINAL-NMBR             03091000
030920     END-EXEC                                                     03092000
030921     MOVE SQLCODE TO DE-SQLCODE                                   03092100
030922     MOVE SQLERRMC TO DE-SQLERRMC                                 03092200
030923     IF SQLCODE = 0                                               03092300
030924         MOVE TTRM000-PRINTER-NMBR TO selected-printer-id         03092400
030925     ELSE                                                         03092500
030926         IF SQLCODE = +100                                        03092600
030927             MOVE term-idnt TO WM-TERMINAL                        03092700
030928             EXEC CICS                                            03092800
030929                  WRITEQ TD                                       03092900
030930                  QUEUE('CSML')                                   03093000
030931                  FROM (WM-WRITEQ-MESSAGE1)                       03093100
030932                  LENGTH(54)                                      03093200
030933             END-EXEC                                             03093300
030934             MOVE TI-TERM-CHR1-CHR2 TO DT-CNTL-UNIT-ID            03093400
030935             MOVE DT-DUMMY-TERM TO TTRM000-TERMINAL-NMBR          03093500
030936             EXEC SQL                                             03093600
030937                 SELECT TERMINAL_NMBR,                            03093700
030938                        PRINTER_NMBR                              03093800
030939                 INTO :TTRM000-TERMINAL-NMBR,                     03093900
030940                      :TTRM000-PRINTER-NMBR                       03094000
030941                 FROM TTRM000                                     03094100
030942                 WHERE TERMINAL_NMBR = :TTRM000-TERMINAL-NMBR     03094200
030943             END-EXEC                                             03094300
030944             IF (SQLCODE < 0 OR SQLCODE > +99)                    03094400
030945                 MOVE TI-TERM-CHR1-CHR2 TO WM-CNTLUNIT            03094500
030946                 EXEC CICS                                        03094600
030947                      WRITEQ TD                                   03094700
030948                      QUEUE('CSML')                               03094800
030949                      FROM (WM-WRITEQ-MESSAGE2)                   03094900
030950                      LENGTH(53)                                  03095000
030951                 END-EXEC                                         03095100
030952                 MOVE SQLCODE TO DE-SQLCODE                       03095200
030953                 MOVE SQLERRMC TO DE-SQLERRMC                     03095300
030954                 EXEC CICS                                        03095400
030955                     WRITEQ TD                                    03095500
030956                     QUEUE('CSML')                                03095600
030957                     FROM (DE-DB2-ERROR-MSG)                      03095700
030958                     LENGTH(125)                                  03095800
030959                 END-EXEC                                         03095900
030960             ELSE                                                 03096000
030961                 MOVE TTRM000-PRINTER-NMBR TO selected-printer-id 03096100
030962             END-IF                                               03096200
030963         ELSE                                                     03096300
030964             MOVE SQLCODE TO DE-SQLCODE                           03096400
030965             MOVE SQLERRMC TO DE-SQLERRMC                         03096500
030966             EXEC CICS                                            03096600
030967                  WRITEQ TD                                       03096700
030968                  QUEUE('CSML')                                   03096800
030969                  FROM (DE-DB2-ERROR-MSG)                         03096900
030970                  LENGTH(125)                                     03097000
030971             END-EXEC                                             03097100
030972         END-IF                                                   03097200
030973     END-IF                                                       03097300
030974*                                                                 03097400
030975* SELECT THE MODEL FROM THE LIST SUPPLIED (THE FIRST MODEL IS     03097500
030976* SELECTED).                                                      03097600
030977*                                                                 03097700
030978*                                                                 03097800
030979        if selected-modelname = spaces                            03097900
030980            move modelname to selected-modelname                  03098000
030990        end-if                                                    03099000
031000*                                                                 03100000
031100* SET RETURN CODE 0                                               03110000
031200*                                                                 03120000
031300        move return-ok to selected-return-code                    03130000
031400*                                                                 03140000
031500     end-if.                                                      03150000
031600*                                                                 03160000
031700 install-shipped-paragraph.                                       03170000
031800*                                                                 03180000
031900* INSTALL CODE HERE.                                              03190000
032000*   This sample accepts the selected termid value.If however      03200000
032100*   a termid clash has occurred then this value has been          03210000
032200*   selected by the caller module DFHZATS.                        03220000
032300*   There is no guarantee that this value will be the same        03230000
032400*   once a restart has occurred.                                  03240000
032500*   Special consideration MUST be given to how this termid        03250000
032600*   will be used.                                                 03260000
032700*   This sample will update the selected termid value to          03270000
032800*   the original incoming value.If a clash has occurred and       03280000
032900*   the definition is not busy then it will be replaced.          03290000
033000*                                                                 03300000
033100        set address of install-shipped-selected-parms to          03310000
033200                    install-shipped-selected-ptr.                 03320000
033300        set address of sterm-idnt to install-shipped-termid-ptr.  03330000
033400        move sterm-idnt to selected-shipped-termid.               03340000
033500        move return-ok to selected-shipped-return-code.           03350000
033600*                                                                 03360000
033700 delete-paragraph.                                                03370000
033800*                                                                 03380000
033900* DELETE CODE IS PLACED HERE.                                     03390000
034000*                                                                 03400000
