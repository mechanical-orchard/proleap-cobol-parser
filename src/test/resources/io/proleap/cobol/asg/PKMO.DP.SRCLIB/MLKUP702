000100 IDENTIFICATION DIVISION.                                         00010080
000200                                                                  00020080
000300 PROGRAM-ID.    MLKUP702                                          00030080
000400 AUTHOR.        BOB & DAVE (CROC MEN).                            00040080
000500 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00050080
000600 DATE-WRITTEN.  5-05-99.                                          00060080
000700 DATE-COMPILED.                                                   00070080
000800                                                                  00080080
000900******************************************************************00090080
001000* MLKUP702 - M/L RECALC MONTH-TO-DATE MAJOR CLASS TABLE (TVAMCL  )00100080
001100******************************************************************00110080
001200*  THIS PROGRAM WILL RECALCULATE THE FOLLOWING FIELDS ON TVAMCL  *00120080
001300*    SHNK_RTL_AMT     - RETAIL SHRINK                            *00130080
001400*    END_INV_RTL_AMT  - RETAIL ENDING INVENTORY                  *00140080
001500*    CUM_MKUP_PCT     - CUM-TO-DATE MARKUP PERCENT               *00150080
001600*    END_INV_COST_AMT - COST ENDING INVENTORY                    *00160080
001700*    SLS_COST_AMT     - COST AS A BASIS OF SALES                 *00170080
001800*    GRO_MRGN_AMT     - GROSS MARGIN DOLLAR AMOUNT               *00180080
001900******************************************************************00190080
002000* THIS PROGRAM WILL OPEN A CURSOR FOR PROCESSING ALL OF THE      *00200080
002000*   DATES BETWEEN THE OPEN FISCAL MONTH END DATE AND MAX DATE    *00201080
002000*   WHICH IS THE DRIVER OF THE PROGRAM.                          *00202080
002100* FOR EACH DATE, ALL THE DEPT, MAJ-CL, ENT-ID'S ARE PROCESSED    *00210080
002200*   AND THE DATA IS RECALCULATED FOR EACH.                       *00220080
002500* FSCL_MN_END_DTE IS BETWEEN THE OPN_FSCL__MN_DTE AND THE MXPSTG_*00250080
002600* FSCL_MN_DTE, OR IF IT IS IN THE PRIOR FISCAL MONTH AND HAS END-*00260080
002700* INVENTORY COST OR RETAIL <> 0.                                 *00270080
002800*   AN ADDITIONAL CUSOR IS BUILT TO DETERMINE THE NUMBER OF      *00280080
002900* ENT-IDS WITHIN A DEPT/MCL.  THIS IS USED WHEN PRORATING THE    *00290080
003000* SHRINK RETAIL AMOUNT.  IF THE TOTAL AMOUNT OF SHRINK FOR A     *00300080
003100* MAJOR CLASS IS NOT EQUAL TO THE SHRINK IN THE TMNMCL TBL, THE  *00310084
003200* DIFFERENCE IS ADDED/SUBTRACTED TO THE LAST ENT-ID OF A DEPT/MCL*00320080
003300*     IF THERE IS ACTIVITY FOR THE CURRENT OPEN MONTH, THEN THE  *00330080
003400* ROW IS ALWAYS TO BE RECALCED. IF THERE IS NO CURRENT ACTIVITY, *00340080
003500* (IE. ALL DOLLAR VALUES FOR OPEN-FSCL-MN-DTE = 0), BUT THERE IS *00350080
003600* ENDING-INVENTORY DOLLARS PRESENT FROM THE PREVIOUS MONTH-END - *00360080
003700* THEN A NEW ROW IS INSERTED THAT CARRIES FORWARD ONLY INVENTORY *00370080
003800* BALANCES FROM THE PRIOR MONTH. IF THERE IS NO CURRENT DOLLARS  *00380080
003900* FOR THE CURRENT OPEN MONTH, AS WELL AS, NO PREVIOUS END-INV    *00390080
004000* DOLLARS FROM THE PRIOR MONTH, A NEW ROW WILL NOT BE INSERTED.  *00400080
004100*                                                                 00410080
004200* THIS PGM WILL USE CHECKPOINT RESTART LOGIC TO DETERMINE IF AND *00420080
004300* WHEN A CHECKPOINT IS TO BE TAKEN. A CHECKPOINT/COMMIT WILL     *00430080
004300* BE TAKEN WHEN EVER THERE IS A DEPT NUMBER CHANGE OR AT THE END *00431080
004400* OF THE ENT-ID CURSOR.                                           00440080
004500* CONDITIONS ....                                                *00450080
004600* NORMAL START - INITAL CURSOR WILL SELECT ALL DATES WITHIN THE  *00460080
004700*   DATE RANGE SPECIFIED.  A COMMIT IS ONLY TAKE AFTER A ENTIRE  *00470080
004800*   DEPT HAS BEEN RECALCED FOR A SPECIFIC DATE.                  *00480080
004900* RESTART - SELECT CHECKPOINT RESTART KEY FROM TCKRSTINF, USE    *00490080
005000*   DATE AND DEPT NBR TO DETERMINE WHICH ROWS SHOULD BE RECALCED *00500080
005100*   WHICH IS ALL ROWS >= TO LAST COMMITED DATE AND DEPT NUMBER.  *00510080
005200******************************************************************00520080
005300*                        CHANGE LOG                              *00530080
005400*  CHANGE ID    CHANGE DATE            REASON FOR CHANGE         *00540080
BKPFLC* 08/05/12 - COGNIZANT        -  INC # CRQ000000030235            00541091
BKPFLC*    - RECOMPILING THE PROGRAM.                                   00542091
005500******************************************************************00550080
P18333*  CHANGE ID    CHANGE DATE            REASON FOR CHANGE         *00551094
P18333* P18333  - COGNIZANT - 09/28/12        -PBI000000018333          00552094
P18333*    - ML PERFORMANCE TUNING-REMOVED UNWANTED DISPLAYS.           00553094
P18333******************************************************************00554094
005600                                                                  00560080
005700 ENVIRONMENT DIVISION.                                            00570080
005800                                                                  00580080
005900 CONFIGURATION SECTION.                                           00590080
006000 SOURCE-COMPUTER.        IBM-3090.                                00600080
006100 OBJECT-COMPUTER.        IBM-3090.                                00610080
006200 INPUT-OUTPUT SECTION.                                            00620080
006300 FILE-CONTROL.                                                    00630080
006400**                                                                00640080
006500*                                                                 00650080
006600 DATA DIVISION.                                                   00660080
006700 FILE SECTION.                                                    00670080
006800**                                                                00680080
006900*                                                                 00690080
007000 WORKING-STORAGE SECTION.                                         00700080
007100                                                                  00710080
007200 01  ABEND-CODE                  PIC S9(04)  VALUE ZERO COMP SYNC.00720080
007300                                                                  00730080
007400 01  PA-PROGRAM-ACCUMULATORS.                                     00740080
007500     05  PA-COMMIT-COUNT                 PIC  9(09) VALUE ZEROES. 00750080
007600     05  PA-DEPT-MCL-COUNT               PIC  9(09) VALUE ZEROES. 00760080
007700     05  PA-DATE-COUNT                   PIC  9(09) VALUE ZEROES. 00770080
007800     05  PA-INSERT-COUNT                 PIC  9(09) VALUE ZEROES. 00780080
007900     05  PA-UPDATE-COUNT                 PIC  9(09) VALUE ZEROES. 00790080
008000                                                                  00800080
008100 01  PS-PROGRAM-SWITCHES.                                         00810080
008200     05  PS-FIRST-COMMIT-SW              PIC X     VALUE 'N'.     00820080
008300         88  PS-FIRST-COMMIT                       VALUE 'Y'.     00830080
008400     05  PS-ENT-ID-CURSOR-SW             PIC X     VALUE 'N'.     00840081
008500         88  PS-END-OF-ENT-ID-CURSOR               VALUE 'Y'.     00850080
008600         88  PS-NOT-END-OF-ENT-ID-CURSOR           VALUE 'N'.     00860080
008700     05  PS-CURR-MONTH-SW                PIC X     VALUE 'N'.     00870080
008800         88  PS-CURR-MONTH-ROW-FOUND               VALUE 'Y'.     00880080
008900         88  PS-CURR-MONTH-ROW-NOT-FOUND           VALUE 'N'.     00890080
009000     05  PS-PREV-MONTH-ROW-SW            PIC X     VALUE 'N'.     00900080
009100         88  PS-PREV-MONTH-ROW-FOUND               VALUE 'Y'.     00910080
009200         88  PS-PREV-MONTH-ROW-NOT-FOUND           VALUE 'N'.     00920080
009300     05  PS-PREV-SEASON-INV-SW           PIC X     VALUE 'N'.     00930080
009400         88  PS-NO-PREV-SEASONAL-INV               VALUE 'Y'.     00940080
009500     05  PS-CURR-SEASON-CURSOR-SW        PIC X     VALUE 'N'.     00950080
009600         88  PS-END-OF-CURR-SEASON-CSR             VALUE 'Y'.     00960080
009700     05  PS-CURRENT-PURCH-COST-SW        PIC X     VALUE 'N'.     00970080
009800         88  PS-NO-CURRENT-PURCH-COSTS             VALUE 'Y'.     00980080
009900     05  PS-RESULT-TABLE-SW              PIC X     VALUE 'N'.     00990080
010000         88  PS-EMPTY-RESULT-TABLE                 VALUE 'Y'.     01000080
010100     05  PS-END-OF-FISCAL-DATE-CSR-SW    PIC X     VALUE 'N'.     01010080
010200         88  PS-END-OF-FISCAL-DATE-CSR             VALUE 'Y'.     01020080
010300                                                                  01030080
010400 01  PC-PROGRAM-CONSTANTS.                                        01040080
010500     05  PC-JOB-NAME             PIC  X(06)    VALUE 'MLK410'.    01050080
010600     05  PC-PROGRAM-NAME         PIC  X(08)    VALUE 'MLKUP702'.  01060080
010700                                                                  01070080
010800 01  PE-PROGRAM-ERROR-MESSAGES.                                   01080080
010900     05  PE-MSG-01                       PIC X(30) VALUE          01090080
011000          'INSPECT WHERE CLAUSE VARIABLE'.                        01100080
011100     05  PE-MSG-02                       PIC X(30) VALUE          01110080
011200          'DB2 SELECT ATTEMPTED         '.                        01120080
011300     05  PE-MSG-03                       PIC X(30) VALUE          01130080
011400          'ATTEMPTING TO OPEN DB2 CURSOR'.                        01140080
011500     05  PE-MSG-04                       PIC X(30) VALUE          01150080
011600          'ATTEMPT TO FETCH CURSOR ROW  '.                        01160080
011700     05  PE-MSG-05                       PIC X(30) VALUE          01170080
011800          'ATTEMPT TO CLOSE DB2 CURSOR  '.                        01180080
011900     05  PE-MSG-06                       PIC X(30) VALUE          01190080
012000          'ERROR ON UPDATE OF TVAMCL    '.                        01200080
012100     05  PE-MSG-07                       PIC X(30) VALUE          01210080
012200          'ERROR IN SELECT - TCKRSTCNTL '.                        01220080
012300     05  PE-MSG-08                       PIC X(30) VALUE          01230080
012400          'UPDATE WORK_STRG - TCKRSTINF '.                        01240080
012500     05  PE-MSG-09                       PIC X(30) VALUE          01250080
012600          'PGM ABEND DURING A COMMIT    '.                        01260080
012700     05  PE-MSG-10                       PIC X(30) VALUE          01270080
012800          'UPDATE OF TCKRSTCNTL FAILED  '.                        01280080
012900     05  PE-MSG-11                       PIC X(30) VALUE          01290080
013000          'ERROR IN SELECT - TCKRSTINF  '.                        01300080
013100     05  PE-MSG-13                       PIC X(30) VALUE          01310080
013200          'SHRINK NOT FND FOR DEPT/DATE '.                        01320080
013300     05  PE-MSG-14                       PIC X(30) VALUE          01330080
013400          'ERROR ON ''INSERT'' TO TVAMCL'.                        01340080
013500     05  PE-MSG-16                       PIC X(30) VALUE          01350080
013600          'ERROR SELECTING COUNT OF ROWS.'.                       01360080
013700*                                                                 01370080
013800 01  PROGRAM-VARIABLES.                                           01380080
013900     05  PV-TVAMCL-UPDATE-VARIABLES.                              01390080
014000* THESE VARIABLES WILL UPDATE CURRENT TVAMCL ROW *****************01400080
014100         10  PV-SHNK-RTL-AMT             PIC  S9(11)V9(2) COMP-3. 01410080
014200         10  PV-END-INV-RTL-AMT          PIC  S9(11)V9(2) COMP-3. 01420080
014300         10  PV-CUM-MKUP-PCT             PIC  S9(4)V9(7)  COMP-3. 01430080
014400         10  PV-END-INV-COST-AMT         PIC  S9(11)V9(2) COMP-3. 01440080
014500         10  PV-SLS-COST-AMT             PIC  S9(11)V9(2) COMP-3. 01450080
014600         10  PV-GRO-MRGN-AMT             PIC  S9(11)V9(2) COMP-3. 01460080
014700******************************************************************01470080
014800     05  PV-SEASON-TO-DATE-CSR-VAR.                               01480080
014900         10  PV-VAMCL-RCPT-RTL-AMT       PIC  S9(11)V9(2) COMP-3. 01490080
015000         10  PV-VAMCL-RCPT-NET-COST-AMT  PIC  S9(11)V9(2) COMP-3. 01500080
015100         10  PV-VAMCL-PADJ-RTL-AMT       PIC  S9(11)V9(2) COMP-3. 01510080
015200         10  PV-VAMCL-PADJ-NET-COST-AMT  PIC  S9(11)V9(2) COMP-3. 01520080
015300         10  PV-VAMCL-MKUP-RTL-AMT       PIC  S9(11)V9(2) COMP-3. 01530080
015400         10  PV-VAMCL-XFER-NET-AMT       PIC  S9(11)V9(2) COMP-3. 01540080
015500     05  PV-CURR-MONTH-COST-VAR.                                  01550080
015600         10  PV-CURR-MONTH-RCPT-NET-COST PIC  S9(11)V9(2) COMP-3. 01560080
015700         10  PV-CURR-MONTH-PADJ-NET-COST PIC  S9(11)V9(2) COMP-3. 01570080
015800     05  PV-PREV-MONTH-VAR.                                       01580080
015900         10  PV-PREV-MONTH-END-INV-RTL   PIC  S9(11)V9(2) COMP-3. 01590080
016000         10  PV-PREV-MONTH-END-INV-COST  PIC  S9(11)V9(2) COMP-3. 01600080
016100     05  PV-PREV-SEASON-VAR.                                      01610080
016200         10  PV-PREV-SEASON-END-INV-RTL  PIC  S9(11)V9(2) COMP-3. 01620080
016300         10  PV-PREV-SEASON-END-INV-COST PIC  S9(11)V9(2) COMP-3. 01630080
016400     05  PV-CUM-TO-DATE-VARIABLES.                                01640080
016500         10  PV-CUM-TO-DATE-PURCH-RETAIL PIC  S9(11)V9(2) COMP-3. 01650080
016600         10  PV-CUM-TO-DATE-PURCH-COST   PIC  S9(11)V9(2) COMP-3. 01660080
016700         10  PV-CUM-SEASON-MKUP          PIC  S9(11)V9(2) COMP-3. 01670080
016800*                                                                 01680080
016900 01  PV-VARIABLE-FIELDS.                                          01690080
016901     05  PV-SALES-NULL-IND               PIC S9(04) VALUE ZEROS   01690180
016910                                                    COMP.         01690280
017000     05  PV-COMMIT-DEPT                  PIC  X(03) VALUE SPACES. 01690380
017100     05  PV-HOLD-DEPT-NBR                PIC  X(03) VALUE SPACES. 01690480
017200     05  PV-HOLD-MAJ-CL-NBR              PIC  X(02) VALUE SPACES. 01690580
017300     05  PV-PARAGRAPH-NAME               PIC  X(30) VALUE SPACES. 01690680
017400     05  PV-ABEND-MESSAGE                PIC  X(75) VALUE SPACES. 01690780
017500     05  PV-OPERATION-ATTEMPTED          PIC  X(30) VALUE SPACES. 01690880
017600     05  PV-XFER-NET                     PIC  S9(11)V99 COMP-3    01690980
017610                                                       VALUE +0.  01691080
017700     05  PV-MCL-SHNK-DIFF                PIC  S9(11)V99 COMP-3    01692080
017800                                                       VALUE +0.  01693080
017900     05  PV-ENT-ID-SALES-AMT      PIC S9(11)V99 COMP-3 VALUE +0.  01694080
018000     05  PV-ENT-ID-MKDN-AMT       PIC S9(11)V99 COMP-3 VALUE +0.  01695080
018100     05  PV-VAMCL-SHNK-RTL-AMT    PIC S9(11)V99 COMP-3 VALUE +0.  01696080
018200     05  PV-MCL-SALES-AMT         PIC S9(11)V99 COMP-3 VALUE +0.  01697080
018300     05  PV-MNMCL-SHNK-RTL-AMT    PIC S9(11)V99 COMP-3 VALUE +0.  01698080
018400     05  PV-ENT-ID-PCT-SALES      PIC S9(04)V9(07)                01699080
018500                                                COMP-3 VALUE +0.  01700080
018600     05  PV-ENT-ID-COUNT          PIC  S9(04)   COMP-3 VALUE +0.  01710080
018700     05  PV-ENT-ID-PROCESS-COUNT  PIC  S9(04)   COMP-3 VALUE +0.  01720080
018800                                                                  01730080
019500****************************************************              01800080
019600*  MONTHLY MAJOR CLASS TABLE - CONTAINS SHRINK AMT *              01810080
019700****************************************************              01820080
019800     EXEC SQL                                                     01830080
019900         INCLUDE TMNMCL                                           01840080
020000     END-EXEC.                                                    01850080
020100****************************************************              01860080
020200*  COMMUNICATION AREAS FOR DB2                     *              01870080
020300****************************************************              01880080
020400     EXEC SQL                                                     01890080
020500         INCLUDE SQLCA                                            01900080
020600     END-EXEC.                                                    01910080
020700****************************************************              01920080
020800*  M/L MONTH-TO-DATE DEPT, MAJ CL, ENT-ID TABLE    *              01930085
020900****************************************************              01940080
021000     EXEC SQL                                                     01950080
021100         INCLUDE TVAMCL                                           01960080
021200     END-EXEC.                                                    01970080
021300****************************************************              01980080
021400* M/L DATE TABLE                                   *              01990085
021500****************************************************              02000080
021600     EXEC SQL                                                     02010080
021700         INCLUDE TDTATTR                                          02020080
021800     END-EXEC.                                                    02030080
021900                                                                  02040080
021300****************************************************              02041085
021400* M/L CONTROL TABLE                                *              02042085
021500****************************************************              02043085
022000     EXEC SQL                                                     02050085
022100         INCLUDE TMLCNTL                                          02060085
022200     END-EXEC.                                                    02070085
                                                                        02080085
025900******************************************************************02440080
026000* THE NUMBER OF COLUMNS DESCRIBED BY THIS DECLARATION IS  12     *02450080
026100******************************************************************02460080
026200                                                                  02470080
026300****************************************************              02480080
026400*CHECKPOINT RESTART CONTROL AND INFORMATION TABLES *              02490080
026500****************************************************              02500080
026600     EXEC SQL                                                     02510080
026700         INCLUDE TCKRSTCN                                         02520080
026800     END-EXEC.                                                    02530080
026900*                                                                 02540080
027000     EXEC SQL                                                     02550080
027100         INCLUDE TCKRSTIN                                         02560080
027200     END-EXEC.                                                    02570080
027300     EXEC SQL                                                     02580080
027400         DECLARE ENT_ID_CSR CURSOR FOR                            02590080
027500          SELECT  DISTINCT DEPT_NBR, MAJ_CL_NBR, ENT_ID           02600080
027600           FROM TVAMCL                                            02610080
027700            WHERE DEPT_NBR       >= :VAMCL-DEPT-NBR               02620080
027800            AND ((FSCL_MN_END_DTE = :MLCNTL-OPN-FSCL-MN-DTE)      02630080
028100            OR  (FSCL_MN_END_DTE  = :DTATTR-PFM-END-DTE           02640080
028200            AND (END_INV_RTL_AMT  <> 0 OR                         02650080
028300                 END_INV_COST_AMT <> 0)))                         02660080
028400           ORDER BY DEPT_NBR, MAJ_CL_NBR, ENT_ID                  02670080
028500           FOR FETCH ONLY                                         02680080
028600     END-EXEC.                                                    02690080
028700                                                                  02700080
028800*                                                                 02710080
028900* MAX (6) ROWS FOR EACH DEPT (MONTHS PER SEASON) - CUM SEASON $   02720080
029000     EXEC SQL                                                     02730080
029100         DECLARE SEASON_TO_DATE_CSR CURSOR FOR                    02740080
029200          SELECT  XFER_IN_RTL_AMT                                 02750080
029300                 ,XFER_OUT_RTL_AMT                                02760080
029400                 ,RCPT_RTL_AMT                                    02770080
029500                 ,RCPT_NET_COST_AMT                               02780080
029600                 ,PADJ_RTL_AMT                                    02790080
029700                 ,PADJ_NET_COST_AMT                               02800080
029800                 ,MKUP_RTL_AMT                                    02810080
029900            FROM  TVAMCL                                          02820080
030000           WHERE (DEPT_NBR   = :VAMCL-DEPT-NBR)                   02830080
030100             AND (MAJ_CL_NBR = :VAMCL-MAJ-CL-NBR)                 02840080
030200             AND (ENT_ID     = :VAMCL-ENT-ID)                     02850080
030300             AND (FSCL_MN_END_DTE >= :DTATTR-SEA-BEG-DTE          02860080
030400             AND  FSCL_MN_END_DTE <= :DTATTR-FSCL-MN-END-DTE)     02870080
030500           FOR FETCH ONLY                                         02880080
030600     END-EXEC.                                                    02890080
030700                                                                  02900080
030800*                                                                 02910080
030900* MONTHS TO BE PROCESSED - ALL DATES BETWEEN OPEN AND MAX DATES   02920080
031000     EXEC SQL                                                     02930080
031100         DECLARE FISCAL_DATE_CSR CURSOR FOR                       02940080
031200          SELECT  DISTINCT                                        02950080
031300                  FSCL_MN_END_DTE                                 02960080
031400                 ,CAL_MN_NBR                                      02970080
031500                 ,PFM_END_DTE                                     02980080
031600                 ,SEA_BEG_DTE                                     02990080
031700                 ,PREV_SEA_END_DTE                                03000080
031800                 ,FSCL_MN_NBR                                     03010080
031900                 ,FSCL_YR_NBR                                     03020080
032000            FROM  TDTATTR                                         03030080
032100           WHERE FSCL_MN_END_DTE BETWEEN                          03040080
032200                                      :MLCNTL-OPN-FSCL-MN-DTE     03050080
032300                                  AND :MLCNTL-MXPSTG-FSCL-MN-DTE  03060080
032400           ORDER BY FSCL_MN_END_DTE                               03070080
032500           FOR FETCH ONLY                                         03080080
032600     END-EXEC.                                                    03090080
032700*                                                                 03100080
032800******************************************************************03110080
032900* CHECKPOINT RESTART VARIABLES                                   *03120080
033000******************************************************************03130080
033100 01  CR-CHECKPOINT-RESTART-AREA.                                  03140080
033200     05  CR-AREA-LEN                  PIC S9(04) VALUE +67  COMP. 03150080
033300     05  CR-CHECKPOINT-RESTART-VAR.                               03160080
033400         10  CR-PREV-DTL-KEY.                                     03170080
033500             15  CR-FISCAL-MN-END-DTE PIC  X(10).                 03180080
033600             15  FILLER               PIC  X(01).                 03190080
033700             15  CR-FISCAL-MN-NBR     PIC  X(02).                 03200080
033800             15  FILLER               PIC  X(01).                 03210080
033900             15  CR-DEPT-NBR          PIC  X(03).                 03220080
034000         10  FILLER                   PIC  X(01) VALUE SPACES.    03230080
034100         10  CR-TVAMCL-FETCH-COUNT    PIC  9(09) VALUE ZEROES.    03240080
034200         10  FILLER                   PIC  X(01) VALUE SPACES.    03250080
034300         10  CR-TVAMCL-UPDATE-COUNT   PIC  9(09) VALUE ZEROES.    03260080
034400         10  FILLER                   PIC  X(01) VALUE SPACES.    03270080
034500         10  CR-TVAMCL-INSERT-COUNT   PIC  9(09) VALUE ZEROES.    03280080
034600         10  FILLER                   PIC  X(01) VALUE SPACES.    03290080
034700         10  CR-TVAMCL-COMMIT-COUNT   PIC  9(09) VALUE ZEROES.    03300080
034800     EJECT                                                        03310080
034900*                                                                 03320080
035000****************************************************              03330080
035100*  ERROR MESSAGE AREA FOR DB2                      *              03340080
035200****************************************************              03350080
035300     COPY DPWS004.                                                03360080
035400*                                                                 03370080
035500*-------------------*                                             03380080
035600 PROCEDURE DIVISION.                                              03390080
035700*-------------------*                                             03400080
035800                                                                  03410080
035900 0000-MAIN-MODULE.                                                03420080
036000                                                                  03430080
036100     PERFORM 1000-INITIALIZATION.                                 03440080
036200                                                                  03450080
036300     PERFORM 2000-PROCESS-INPUT                                   03460080
036400         UNTIL PS-END-OF-FISCAL-DATE-CSR.                         03470080
036500                                                                  03480080
036600     PERFORM 8000-EOJ-ROUTINE.                                    03490080
036700                                                                  03500080
036800     STOP RUN.                                                    03510080
036900*                                                                 03520080
037000*                                                                 03530080
037100******************************************************************03540080
037200* 1000-INITIALIZATION.                                            03550080
037300* LOAD TABLE WITH MONTHS TO BE RECALCULATED - OPN_MN THRU MXPSTG  03560080
037400* DETERMINE IF THIS IS A 'RESTART' (TCKRSTINF-CKPT-STAT-CODE = 9) 03570080
037500******************************************************************03580080
037600 1000-INITIALIZATION.                                             03590080
037700                                                                  03600080
037800     PERFORM 7000-SELECT-CNTL-TBL-ROW.                            03610080
037900     PERFORM 7650-INIT-CHECKPOINT-SELECT.                         03620080
038000                                                                  03630080
038100     IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           03640080
038200         PERFORM 7700-SELECT-RESTART-INFO                         03650080
038300         MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO                    03660080
038400                                       CR-CHECKPOINT-RESTART-VAR  03670080
038500         DISPLAY 'RESTART-LAST DATE COMMIT: ' CR-FISCAL-MN-END-DTE03680080
038510         DISPLAY 'RESTART-LAST DEPT COMMIT: ' CR-DEPT-NBR         03690080
038600         MOVE CR-FISCAL-MN-END-DTE       TO MLCNTL-OPN-FSCL-MN-DTE03700080
038700         PERFORM 7050-OPEN-DATE-CURSOR                            03710080
038800         PERFORM 7075-FETCH-DATE-CURSOR                           03720080
038900         MOVE CR-DEPT-NBR                TO VAMCL-DEPT-NBR        03730080
039000     ELSE                                                         03740080
039100         SET PS-FIRST-COMMIT TO TRUE                              03750080
039200         INITIALIZE CR-CHECKPOINT-RESTART-VAR                     03760080
039300         DISPLAY 'COMMITS WILL BE TAKEN AFTER A CHG IN DEPT.'     03770080
039400         PERFORM 7050-OPEN-DATE-CURSOR                            03780080
039500         PERFORM 7075-FETCH-DATE-CURSOR                           03790080
039600         MOVE MLCNTL-OPN-FSCL-MN-DTE TO  DTATTR-FSCL-MN-END-DTE   03800080
039700     END-IF.                                                      03810080
039800                                                                  03820080
039900     INITIALIZE PA-PROGRAM-ACCUMULATORS.                          03830080
040000                                                                  03840080
040100     IF  PS-END-OF-ENT-ID-CURSOR                                  03850080
040200         IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                       03860080
040300             DISPLAY 'NO RECORDS TO PROCESSED AFTER RESTART'      03870080
040400             SET PS-EMPTY-RESULT-TABLE TO TRUE                    03880080
040500         ELSE                                                     03890080
040600             IF TCKRSTCNTL-CKPT-STAT-CODE = '0'                   03900080
040700                 DISPLAY 'NO ROWS SELECTED FOR RECALCULATION'     03910080
040800                 SET PS-EMPTY-RESULT-TABLE TO TRUE                03920080
040900             END-IF                                               03930080
041000         END-IF                                                   03940080
041400     END-IF.                                                      03980080
041500*                                                                 03990080
041600*                                                                 04000080
041700******************************************************************04010080
041800* MAIN PROCESSING PARAGRAPH-PERFORMED UNTIL END OF CSR PROCESSING 04020080
041900* WHEN PV-SUB1 > PV-MAX-SUB - THEN ALL DATES FOR THIS DEPT/MCL    04030080
042000*                 HAVE BEEN PROCESSED, CHECK IF COMMIT REQUIRED.  04040080
042100******************************************************************04050080
042200 2000-PROCESS-INPUT.                                              04060080
042300                                                                  04070080
042400     ADD 1      TO PA-DATE-COUNT.                                 04080080
042410                                                                  04090080
042500     SET PS-NOT-END-OF-ENT-ID-CURSOR TO TRUE.                     04100080
042600     PERFORM 7149-OPEN-ENT-ID-CURSOR.                             04110080
042700     PERFORM 7150-FETCH-ENT-ID-CURSOR.                            04120080
042710                                                                  04130080
042800     MOVE VAMCL-DEPT-NBR   TO PV-COMMIT-DEPT.                     04140080
042900                                                                  04150080
043000     PERFORM 2025-PROCESS-ENT-IDS                                 04160080
043100          UNTIL PS-END-OF-ENT-ID-CURSOR.                          04170080
043200                                                                  04180080
043300     PERFORM 7075-FETCH-DATE-CURSOR.                              04190080
043400     MOVE DTATTR-FSCL-MN-END-DTE TO MLCNTL-OPN-FSCL-MN-DTE.       04200080
043500                                                                  04210080
043600******************************************************************04220080
043700* DEPT LEVEL PROCESSING PARAGRAPH                                 04230080
043800* PROCESS ALL DATES FOR THIS DEPARTMENT                           04240080
043900******************************************************************04250080
044000 2025-PROCESS-ENT-IDS.                                            04260080
044100                                                                  04270080
044200     ADD 1 TO PV-ENT-ID-PROCESS-COUNT                             04280080
044300              PA-DEPT-MCL-COUNT.                                  04290080
044400     INITIALIZE  PROGRAM-VARIABLES.                               04300080
044500     MOVE 'N' TO PS-CURR-MONTH-SW                                 04310080
044600                 PS-PREV-MONTH-ROW-SW.                            04320080
044700                                                                  04330080
044800***  DETERMINE IF CURRENT DOLLARS AND/OR PRIOR INVENTORY DOLLARS  04340080
045020     PERFORM 7350-SELECT-PREV-MONTH-END-INV.                      04350080
045030     PERFORM 7300-SELECT-CURRENT-DOLLARS.                         04360080
045100                                                                  04370080
045200******************************************************************04380080
045300*****                CARRY FORWARD LOGIC                     *****04390080
045400******************************************************************04400080
045500*    CURRENT $ FOUND FOR THIS MONTH  - RECALC ROW                *04410080
045600* NO CURRENT $ FOUND/NO PREV $ FOUND - BYPASS RECALC THIS MONTH  *04420080
045700* NO CURRENT $ FOUND/   PREV $ FOUND - CARRY FORWARD INVENTORY $ *04430080
045800******************************************************************04440080
045900     IF PS-CURR-MONTH-ROW-FOUND                                   04450080
046000         PERFORM 2035-RECALC-PROCESSING                           04460080
052081         PERFORM 7500-UPDATE-PROCESSING                           04470080
052082     ELSE                                                         04480080
052083         IF PS-PREV-MONTH-ROW-FOUND                               04490080
052086            PERFORM 2030-INITIALIZE-DCLGEN-FIELDS                 04500080
052108            PERFORM 2035-RECALC-PROCESSING                        04510080
052109            PERFORM 7510-INSERT-CARRY-FWD-ROW                     04520080
052110         END-IF                                                   04530080
052111     END-IF.                                                      04540080
052112                                                                  04550080
052113     PERFORM 7150-FETCH-ENT-ID-CURSOR.                            04560080
052114                                                                  04570080
052115***  PERFORM COMMIT WHEN DEPT CHANGES OR END OF ENT-ID CSR        04580080
052116     IF VAMCL-DEPT-NBR NOT = PV-COMMIT-DEPT OR                    04590080
052117        PS-END-OF-ENT-ID-CURSOR                                   04600080
052118        PERFORM 7800-COMMIT-PROCESSING                            04610080
052119        MOVE VAMCL-DEPT-NBR   TO PV-COMMIT-DEPT                   04620080
052120     END-IF.                                                      04630080
052121*                                                                 04640080
052122*                                                                 04650080
052123******************************************************************04660080
052125*  INITIALIZE THE TVAMCL DGLGEN FIELDS USED FOR RECALC WHEN      *04670080
052126*  CARRYING FORWARD PREV MONTTH ENDING INVENTORY RETAIL AND COST *04680080
052127******************************************************************04690080
052128 2030-INITIALIZE-DCLGEN-FIELDS.                                   04700080
052129                                                                  04710080
052130     MOVE ZEROS       TO VAMCL-SLS-REG-RTL-AMT                    04720080
052131                         VAMCL-SLS-PROMO-RTL-AMT                  04730080
052132                         VAMCL-SLS-PROCLR-RTL-AMT                 04740080
052133                         VAMCL-SLS-CLR-RTL-AMT                    04750080
052134                         VAMCL-SLS-OTH-RTL-AMT                    04760080
052135                         VAMCL-MKDN-PLU-RTL-AMT                   04770080
052136                         VAMCL-MKDN-RGST-RTL-AMT                  04780080
052137                         VAMCL-MKDN-UMTCH-RTL-AMT                 04790080
052138                         VAMCL-MKDN-BYR-RTL-AMT                   04800080
052139                         VAMCL-MKDN-STR-RTL-AMT                   04810080
052140                         VAMCL-MKUP-RTL-AMT                       04820080
052141                         VAMCL-XFER-IN-RTL-AMT                    04830080
052142                         VAMCL-XFER-OUT-RTL-AMT                   04840080
052143                         VAMCL-RCPT-RTL-AMT                       04850080
052144                         VAMCL-RCPT-NET-COST-AMT                  04860080
052145                         VAMCL-RCPT-GRO-COST-AMT                  04870080
052146                         VAMCL-PADJ-FRGT-COST-AMT                 04880080
052147                         VAMCL-PADJ-DISC-COST-AMT                 04890080
052148                         VAMCL-PADJ-RTL-AMT                       04900080
052149                         VAMCL-PADJ-NET-COST-AMT                  04910080
052150                         VAMCL-INV-ADJ-RTL-AMT.                   04920080
052151*                                                                 04930080
052152*                                                                 04940080
052153******************************************************************04950080
052154*                                                                *04960080
052155*            ********* RECALC PROCESSING **********              *04970080
052156*                                                                *04980080
052157******************************************************************04990080
052158 2035-RECALC-PROCESSING.                                          05000080
052159                                                                  05010080
052160***  GET THE # OF ENT-IDS W/IN A DEPT MAJ CLS WHEN CHANGE OCCURS  05020080
052161     IF VAMCL-DEPT-NBR   = PV-HOLD-DEPT-NBR  AND                  05030080
052162        VAMCL-MAJ-CL-NBR = PV-HOLD-MAJ-CL-NBR                     05040080
052163         CONTINUE                                                 05050080
052164     ELSE                                                         05060080
052165         PERFORM 7155-GET-ENT-ID-COUNT                            05070080
052166         PERFORM 7200-SELECT-SHRINK-DLRS                          05080081
052167***  RESET ENT ID PROCESS COUNT FOR MAJ CLASS AND CLEAR           05090080
052168***  MAJ CLASS SHRINK ACCUMULATOR                                 05100080
052169         MOVE 1                        TO PV-ENT-ID-PROCESS-COUNT 05110080
052170         MOVE 0                        TO PV-VAMCL-SHNK-RTL-AMT   05120080
052171         MOVE VAMCL-DEPT-NBR           TO PV-HOLD-DEPT-NBR        05130080
052172         MOVE VAMCL-MAJ-CL-NBR         TO PV-HOLD-MAJ-CL-NBR      05140080
052173     END-IF.                                                      05150080
052174                                                                  05160080
052175     PERFORM 2125-PRORATE-SHRINK.                                 05170080
052176     PERFORM 2150-CALC-ENDINV-RETAIL.                             05180080
052177                                                                  05190080
052178     PERFORM 7400-PREV-SEASON-END-INV.                            05200080
052179                                                                  05210080
052180     PERFORM 2200-CALC-PREV-SEASN-END-PURCH.                      05211080
052181                                                                  05212080
052182     PERFORM 7425-OPEN-SEASON-CURSOR.                             05213080
052183     PERFORM 7450-FETCH-SEASONAL-CURSOR.                          05214089
052184     PERFORM 2250-CALC-SEASON-TO-DATE-PURCH                       05215080
052185        UNTIL PS-END-OF-CURR-SEASON-CSR.                          05216080
052186                                                                  05217080
052187     PERFORM 7575-CLOSE-SEASON-CURSOR.                            05218080
052188                                                                  05218180
052189     PERFORM 2300-CALC-CUMM-TO-DATE-PURCH.                        05218280
052190     PERFORM 2400-CALC-CUMM-MARKUP-PCT.                           05218380
052191                                                                  05218480
052192     PERFORM 2500-CALC-END-INV-COST.                              05218580
052193***  SALES COST AMOUNT                                            05218680
052194     PERFORM 7475-CURR-SEASON-COST.                               05218780
052195     PERFORM 2600-CALC-SALES-COST-AMT.                            05218880
052196***  GROSS MARGIN AMOUNT                                          05218980
052197     PERFORM 2700-CALC-GROSS-MARGIN-AMT.                          05219080
052300*                                                                 05220080
052400*                                                                 05230080
052500**************************************************                05240080
052600*                                                *                05250080
052700* FOLLOWING PARAGRAPHS PERFORM ALL CALCULATIONS  *                05260080
052800*                                                *                05270080
052900**************************************************                05280080
053000 2125-PRORATE-SHRINK.                                             05290080
053100                                                                  05300080
053200***  COMPUTE TOTAL SALES FOR AN ENT-ID TO BE USED TO PRORATE      05310080
053300***  THE SHRINK AMOUNT TO THE ENT-ID                              05320080
053400     COMPUTE PV-ENT-ID-SALES-AMT = VAMCL-SLS-REG-RTL-AMT          05330080
053500                                 + VAMCL-SLS-PROMO-RTL-AMT        05340080
053600                                 + VAMCL-SLS-PROCLR-RTL-AMT       05350080
053700                                 + VAMCL-SLS-CLR-RTL-AMT          05360080
053800                                 + VAMCL-SLS-OTH-RTL-AMT.         05370080
                                                                        05371080
053900     PERFORM 7250-SUM-SALES-DLRS.                                 05380080
054000                                                                  05390080
054100***  CALC % OF SALES FOR AN ENT-ID WITHIN A DEPT/MCL              05400080
054200     IF PV-MCL-SALES-AMT = 0                                      05410080
054300         MOVE 0 TO PV-ENT-ID-PCT-SALES                            05420080
054400     ELSE                                                         05430080
054500         COMPUTE PV-ENT-ID-PCT-SALES ROUNDED =                    05440080
054600                 PV-ENT-ID-SALES-AMT / PV-MCL-SALES-AMT           05450080
054700     END-IF.                                                      05460080
054800                                                                  05470080
054900***  CALC SHRINK RETAIL FOR AN ENT-ID W/IN A DEPT/MCL             05480080
055000     COMPUTE PV-SHNK-RTL-AMT ROUNDED =                            05490080
055100             PV-ENT-ID-PCT-SALES * PV-MNMCL-SHNK-RTL-AMT.         05500080
055200                                                                  05510080
055300***  ACCUMULATOR FOR MAJOR CLASS LEVEL SHRINK AMOUNTS USED TO     05520080
055400***  BALANCE BACK TO MNMCL SHRINK AMOUNTS                         05530080
055500     ADD PV-SHNK-RTL-AMT TO PV-VAMCL-SHNK-RTL-AMT.                05540080
055600                                                                  05550080
055700***  ON LAST ENT ID OF MAJOR CLASS, CHECK THAT SHRINK             05560080
055800***  TOTALS ARE IN SYNC, IF NOT RECALC THE SHRINK FOR THAT LAST   05570080
055900***  ENT ID FOR A DEPT,MAJ CL.                                    05580080
056000     IF PV-ENT-ID-COUNT = PV-ENT-ID-PROCESS-COUNT                 05590080
056100         IF PV-VAMCL-SHNK-RTL-AMT = PV-MNMCL-SHNK-RTL-AMT         05600080
056200             CONTINUE                                             05610080
056300         ELSE                                                     05620080
056400             COMPUTE PV-MCL-SHNK-DIFF = PV-MNMCL-SHNK-RTL-AMT -   05630080
056500                                        PV-VAMCL-SHNK-RTL-AMT     05640080
056600             COMPUTE PV-SHNK-RTL-AMT =                            05650080
056700                     PV-SHNK-RTL-AMT + PV-MCL-SHNK-DIFF           05660080
056800         END-IF                                                   05670080
056900         MOVE ZEROES TO PV-ENT-ID-PROCESS-COUNT                   05680080
057000                        PV-VAMCL-SHNK-RTL-AMT                     05690080
057100     END-IF.                                                      05700080
057200*                                                                 05710080
057300*                                                                 05720080
057400******************************************************************05730080
057500* CALCULATE THE ENDING INVENTORY OF CURRENT MONTH BASED ON THE    05740080
057600*       ENDING INVENTORY FROM THE PRIOR MONTH                     05750080
057700******************************************************************05760080
057800 2150-CALC-ENDINV-RETAIL.                                         05770080
057900                                                                  05780080
058000***  THE TOTAL MARKDOWN AMT                                       05790080
058100     COMPUTE PV-ENT-ID-MKDN-AMT = VAMCL-MKDN-PLU-RTL-AMT          05800080
058200                                + VAMCL-MKDN-RGST-RTL-AMT         05810080
058300                                + VAMCL-MKDN-UMTCH-RTL-AMT        05820080
058400                                + VAMCL-MKDN-BYR-RTL-AMT          05830080
058500                                + VAMCL-MKDN-STR-RTL-AMT.         05840080
058600                                                                  05850080
058700     COMPUTE PV-END-INV-RTL-AMT = (  PV-PREV-MONTH-END-INV-RTL    05860080
058800                                   + VAMCL-RCPT-RTL-AMT           05870080
058900                                   + VAMCL-PADJ-RTL-AMT           05880080
059000                                   + VAMCL-MKUP-RTL-AMT           05890080
059100                                   - PV-ENT-ID-SALES-AMT          05900080
059200                                   + VAMCL-XFER-IN-RTL-AMT        05910080
059300                                   - VAMCL-XFER-OUT-RTL-AMT       05920080
059400                                   - PV-ENT-ID-MKDN-AMT           05930080
059500                                   - VAMCL-INV-ADJ-RTL-AMT        05940080
059600                                   - PV-SHNK-RTL-AMT).            05950080
059700*                                                                 05960080
059800*                                                                 05970080
059900******************************************************************05980080
060000* CALCULATE CUMULATIVE MARKUP PERCENTAGE FOR UPDATE               05990080
060100******************************************************************06000080
060200 2200-CALC-PREV-SEASN-END-PURCH.                                  06010080
060300                                                                  06020080
060400     IF PS-NO-PREV-SEASONAL-INV                                   06030080
060500          MOVE 0 TO PV-PREV-SEASON-END-INV-RTL                    06040080
060600          MOVE 0 TO PV-PREV-SEASON-END-INV-COST                   06050080
060700     ELSE                                                         06060080
060800          MOVE VAMCL-END-INV-RTL-AMT TO                           06070080
060900                                   PV-PREV-SEASON-END-INV-RTL     06080080
061000          MOVE VAMCL-END-INV-COST-AMT TO                          06090080
061100                                   PV-PREV-SEASON-END-INV-COST    06100080
061200     END-IF.                                                      06110080
061300*                                                                 06120080
061400*                                                                 06130080
061500******************************************************************06140080
061600* ACCUMULATE CURRENT SEASON RETAIL/COST AMTS FROM SEASON BEGINNING06150080
061700******************************************************************06160080
061800 2250-CALC-SEASON-TO-DATE-PURCH.                                  06170080
061900                                                                  06180080
062000     COMPUTE PV-XFER-NET =                                        06190080
062100        (VAMCL-XFER-IN-RTL-AMT -                                  06200080
062200         VAMCL-XFER-OUT-RTL-AMT).                                 06210080
062300                                                                  06220080
062400     ADD PV-XFER-NET             TO  PV-VAMCL-XFER-NET-AMT.       06230080
062500     ADD VAMCL-RCPT-RTL-AMT      TO  PV-VAMCL-RCPT-RTL-AMT.       06240080
062600     ADD VAMCL-RCPT-NET-COST-AMT TO  PV-VAMCL-RCPT-NET-COST-AMT.  06250080
062700     ADD VAMCL-PADJ-RTL-AMT      TO  PV-VAMCL-PADJ-RTL-AMT.       06260080
062800     ADD VAMCL-PADJ-NET-COST-AMT TO  PV-VAMCL-PADJ-NET-COST-AMT.  06270080
062900     ADD VAMCL-MKUP-RTL-AMT      TO  PV-VAMCL-MKUP-RTL-AMT.       06280080
063000                                                                  06290080
063100     PERFORM 7450-FETCH-SEASONAL-CURSOR.                          06300089
063200*                                                                 06310080
063300*                                                                 06320080
063400******************************************************************06330080
063500* DETERMINE CUMULATIVE RETAIL AND COST                            06340080
063600* ADD PRIOR SEASON END INV AMTS TO CURRENT SEASON-TO-DATE AMTS    06350080
063700******************************************************************06360080
063800 2300-CALC-CUMM-TO-DATE-PURCH.                                    06370080
063900                                                                  06380080
064000     COMPUTE PV-CUM-TO-DATE-PURCH-COST   =                        06390080
064100                                   (  PV-PREV-SEASON-END-INV-COST 06400080
064200                                    + PV-VAMCL-RCPT-NET-COST-AMT  06410080
064300                                    + PV-VAMCL-PADJ-NET-COST-AMT).06420080
064400                                                                  06430080
064500     COMPUTE PV-CUM-TO-DATE-PURCH-RETAIL =                        06440080
064600                                    (  PV-PREV-SEASON-END-INV-RTL 06450080
064700                                     + PV-VAMCL-XFER-NET-AMT      06460080
064800                                     + PV-VAMCL-RCPT-RTL-AMT      06470080
064900                                     + PV-VAMCL-PADJ-RTL-AMT      06480080
065000                                     + PV-VAMCL-MKUP-RTL-AMT).    06490080
065100*                                                                 06500080
065200*                                                                 06510080
065300******************************************************************06520080
065400* FINAL CALCULATIONS OF VALUES TO UPDATE TVAMCL - CUM_MKUP_PCT    06530080
065500******************************************************************06540080
065600 2400-CALC-CUMM-MARKUP-PCT.                                       06550080
065700                                                                  06560080
065800     COMPUTE PV-CUM-SEASON-MKUP = (  PV-CUM-TO-DATE-PURCH-RETAIL  06570080
065900                                   - PV-CUM-TO-DATE-PURCH-COST  ).06580080
066000                                                                  06590080
066100     IF PV-CUM-TO-DATE-PURCH-RETAIL = 0                           06600080
066200          MOVE 100 TO PV-CUM-MKUP-PCT                             06610080
066300     ELSE                                                         06620080
066400          COMPUTE PV-CUM-MKUP-PCT ROUNDED =                       06630080
066500         (PV-CUM-SEASON-MKUP * 100) / PV-CUM-TO-DATE-PURCH-RETAIL 06640080
066600     END-IF.                                                      06650080
066700*                                                                 06660080
066800*                                                                 06670080
066900******************************************************************06680080
067000* FINAL CALCULATIONS OF VALUES TO UPDATE TVAMCL - END_INV_COST_AMT06690080
067100******************************************************************06700080
067200 2500-CALC-END-INV-COST.                                          06710080
067300                                                                  06720080
067400     COMPUTE PV-END-INV-COST-AMT ROUNDED =                        06730080
067500                  ( (100 - PV-CUM-MKUP-PCT)  *                    06740080
067600                         ( PV-END-INV-RTL-AMT) ) / 100.           06750080
067700*                                                                 06760080
067800*                                                                 06770080
067900******************************************************************06780080
068000* FINAL CALCULATIONS OF VALUES TO UPDATE TVAMCL - SALES_COST_AMT *06790080
068100******************************************************************06800080
068200 2600-CALC-SALES-COST-AMT.                                        06810080
068300                                                                  06820080
068400     IF PS-NO-CURRENT-PURCH-COSTS                                 06830080
068500         MOVE ZEROES            TO PV-CURR-MONTH-RCPT-NET-COST    06840080
068600                                   PV-CURR-MONTH-PADJ-NET-COST    06850080
068700     END-IF.                                                      06860080
068800                                                                  06870080
068900     COMPUTE PV-SLS-COST-AMT =                                    06880080
069000           (  PV-PREV-MONTH-END-INV-COST                          06890080
069100            + PV-CURR-MONTH-RCPT-NET-COST                         06900080
069200            + PV-CURR-MONTH-PADJ-NET-COST                         06910080
069300            - PV-END-INV-COST-AMT         ).                      06920080
069400*                                                                 06930080
069500*                                                                 06940080
069600******************************************************************06950080
069700* FINAL CALCULATIONS OF VALUES TO UPDATE TVAMCL - GRO_MRGN_AMT   *06960080
069800******************************************************************06970080
069900 2700-CALC-GROSS-MARGIN-AMT.                                      06980080
070000                                                                  06990080
070100     IF PV-ENT-ID-SALES-AMT = 0                                   07000080
070200         MOVE 0 TO PV-GRO-MRGN-AMT                                07010080
070300     ELSE                                                         07020080
070400         COMPUTE PV-GRO-MRGN-AMT =                                07030080
070500         (PV-ENT-ID-SALES-AMT - PV-SLS-COST-AMT)                  07040080
070600     END-IF.                                                      07050080
070700*                                                                 07060080
070800*                                                                 07070080
070900******************************************************************07080080
071000* READ THE DB2 CONTROL TABLE CONTAINING OPEN FISCAL DATE INFO     07090080
071100******************************************************************07100080
071200 7000-SELECT-CNTL-TBL-ROW.                                        07110080
071300                                                                  07120080
071400      EXEC SQL                                                    07130080
071500          SELECT OPN_FSCL_MN_DTE                                  07140080
071600                ,OPN_FSCL_MN_NBR                                  07150080
071700                ,MXPSTG_FSCL_MN_DTE                               07160080
071800                ,MXPSTG_FSCL_MN_NBR                               07170080
071900           INTO  :MLCNTL-OPN-FSCL-MN-DTE                          07180080
072000                ,:MLCNTL-OPN-FSCL-MN-NBR                          07190080
072100                ,:MLCNTL-MXPSTG-FSCL-MN-DTE                       07200080
072200                ,:MLCNTL-MXPSTG-FSCL-MN-NBR                       07210080
072300           FROM  TMLCNTL                                          07220085
072400      END-EXEC.                                                   07230080
072500                                                                  07240080
072600     EVALUATE SQLCODE                                             07250080
072700         WHEN 0                                                   07260080
072800             MOVE MLCNTL-OPN-FSCL-MN-DTE TO CR-FISCAL-MN-END-DTE  07270080
072900             MOVE MLCNTL-OPN-FSCL-MN-NBR TO CR-FISCAL-MN-NBR      07280080
073000             DISPLAY 'CONTROL DATES (TMLCNTL)'                    07290080
073100             DISPLAY ' FISCAL OPEN END DATE : ',                  07300083
073200                                           MLCNTL-OPN-FSCL-MN-DTE 07310080
073300             DISPLAY '       OPEN MONTH NBR : ',                  07320083
073400                                           MLCNTL-OPN-FSCL-MN-NBR 07330080
073500             DISPLAY 'MAXPSTG MONTH END DTE : ',                  07340083
073600                                        MLCNTL-MXPSTG-FSCL-MN-DTE 07350080
073700             DISPLAY '     MAX MONTH NUMBER : ',                  07360083
073800                                        MLCNTL-MXPSTG-FSCL-MN-NBR 07370080
073900         WHEN OTHER                                               07380080
074000            MOVE '7000-SELECT-CNTL-TBL-ROW' TO PV-PARAGRAPH-NAME  07390080
074100            MOVE PE-MSG-01 TO PV-OPERATION-ATTEMPTED              07400080
074200            PERFORM 9999-SQL-ABEND                                07410080
074300     END-EVALUATE.                                                07420080
074400*                                                                 07430080
074500*                                                                 07440080
074600***************************************************************** 07450080
074700* OPEN CURSOR FOR UPDATE AT INITIALIZATION & AFTER EACH COMMIT    07460080
074800***************************************************************** 07470080
074900 7050-OPEN-DATE-CURSOR.                                           07480080
075000                                                                  07490080
075100     EXEC SQL                                                     07500080
075200         OPEN FISCAL_DATE_CSR                                     07510080
075300     END-EXEC                                                     07520080
075400                                                                  07530080
075500     EVALUATE SQLCODE                                             07540080
075600         WHEN 0                                                   07550080
075700              CONTINUE                                            07560080
075800         WHEN OTHER                                               07570080
075900            MOVE '7050-OPEN-DATE-CSR' TO PV-PARAGRAPH-NAME        07580080
076000            MOVE PE-MSG-03 TO PV-OPERATION-ATTEMPTED              07590080
076100            PERFORM 9999-SQL-ABEND                                07600080
076200     END-EVALUATE.                                                07610080
076300*                                                                 07620080
076400*                                                                 07630080
076500***************************************************************** 07640080
076600* INCREMENT SUBSCRIPT AND CONTINUE LOADING INTERNAL TABLE         07650080
076700***************************************************************** 07660080
076800 7075-FETCH-DATE-CURSOR.                                          07670080
076900                                                                  07680080
077000     EXEC SQL                                                     07690080
077100            FETCH FISCAL_DATE_CSR                                 07700080
077200             INTO :DTATTR-FSCL-MN-END-DTE                         07710080
077300                 ,:DTATTR-CAL-MN-NBR                              07720080
077400                 ,:DTATTR-PFM-END-DTE                             07730080
077500                 ,:DTATTR-SEA-BEG-DTE                             07740080
077600                 ,:DTATTR-PREV-SEA-END-DTE                        07750080
077700                 ,:DTATTR-FSCL-MN-NBR                             07760080
077800                 ,:DTATTR-FSCL-YR-NBR                             07770080
077900     END-EXEC                                                     07780080
078000                                                                  07790080
078100     EVALUATE SQLCODE                                             07800080
078200         WHEN +0                                                  07810080
                   CONTINUE                                             07811087
078300***      USED FOR TESTING/DEBUG                                   07820087
078300***          DISPLAY '---------------------------------'          07821087
078400***          DISPLAY 'PROCESS DATE: ', DTATTR-FSCL-MN-END-DTE     07830087
078500         WHEN +100                                                07840080
078600             SET PS-END-OF-FISCAL-DATE-CSR TO TRUE                07850080
078700         WHEN OTHER                                               07860080
078800             MOVE '7075-PROCESS-DATE-CSR' TO PV-PARAGRAPH-NAME    07870080
078900             MOVE PE-MSG-04 TO PV-OPERATION-ATTEMPTED             07880080
079000             PERFORM 9999-SQL-ABEND                               07890080
079100     END-EVALUATE.                                                07900080
079200                                                                  07910080
079300*                                                                 07920080
079400*                                                                 07930080
079500***************************************************************** 07940080
079600*                                                                 07950080
079700***************************************************************** 07960080
079800 7149-OPEN-ENT-ID-CURSOR.                                         07970080
079900                                                                  07980080
080000     EXEC SQL                                                     07990080
080100         OPEN ENT_ID_CSR                                          08000080
080200     END-EXEC                                                     08010080
080300                                                                  08020080
080400     EVALUATE SQLCODE                                             08030080
080500         WHEN 0                                                   08040080
080600              CONTINUE                                            08050080
080700         WHEN OTHER                                               08060080
080800            DISPLAY 'HOLD-DATE ', DTATTR-PFM-END-DTE              08070080
080900            DISPLAY 'MAX DATE  ', MLCNTL-MXPSTG-FSCL-MN-DTE       08080080
081000            MOVE '7149-OPEN-ENT-ID-CSR' TO PV-PARAGRAPH-NAME      08090081
081100            MOVE PE-MSG-03 TO PV-OPERATION-ATTEMPTED              08100080
081200            PERFORM 9999-SQL-ABEND                                08110080
081300     END-EVALUATE.                                                08120080
081400*                                                                 08130080
081500*                                                                 08140080
081600***************************************************************** 08150080
081700* FETCH A DEPT / MCL TO PROCESS                                   08160080
081800***************************************************************** 08170080
081900 7150-FETCH-ENT-ID-CURSOR.                                        08180080
082000                                                                  08190080
082100     EXEC SQL                                                     08200080
082200            FETCH ENT_ID_CSR                                      08210080
082300             INTO :VAMCL-DEPT-NBR                                 08220080
082400                 ,:VAMCL-MAJ-CL-NBR                               08230080
082500                 ,:VAMCL-ENT-ID                                   08240080
082600     END-EXEC                                                     08250080
082700                                                                  08260080
082800     EVALUATE SQLCODE                                             08270080
082900         WHEN +0                                                  08280080
**TEMP*** THE FOLLOWING DISPLAYS ARE TEMPORARY TO DETERMINE             08281090
**TEMP*** WHAT IS NOT BEING RECALC'D                                    08282090
P18333*    DISPLAY ' FETCH KEY : ' VAMCL-DEPT-NBR ' ' VAMCL-MAJ-CL-NBR  08283094
P18333*            ' ' VAMCL-ENT-ID                                     08284094
083000             CONTINUE                                             08290092
083100         WHEN +100                                                08300080
083200             SET PS-END-OF-ENT-ID-CURSOR TO TRUE                  08310080
083300         WHEN OTHER                                               08320080
083400             MOVE '7150-FETCH-ENT-ID-CURSOR' TO PV-PARAGRAPH-NAME 08330081
083500             MOVE PE-MSG-04              TO PV-OPERATION-ATTEMPTED08340080
083600             PERFORM 9999-SQL-ABEND                               08350080
083700       END-EVALUATE.                                              08360080
083800*                                                                 08370080
083900*                                                                 08380080
084000***************************************************************** 08390080
084100*-- RETRIEVE COUNT OF ALL ROWS WITHIN THE PREVIOUS FISCAL         08400080
084200*-- MONTH END DATE (CARRY FORWARD ROWS) AND THE MAX POSTING DATE  08410080
084300*-- THIS COUNT IS USED TO ACCOMODATE FOR ANY IMBALANCE IN THE     08420080
084400*-- CALCULATED SHRINK VS. THE TMNMCL SHRINK.  ANY OUT OF BALANCE  08430080
084500*-- AMOUNT IS LOADED INTO THE LAST ENT ID OF A DEPT/MCL           08440080
084600***************************************************************** 08450080
084700 7155-GET-ENT-ID-COUNT.                                           08460080
084800                                                                  08470080
084900     MOVE ZEROES TO PV-ENT-ID-COUNT.                              08480080
085000                                                                  08490080
085100     EXEC SQL                                                     08500080
085200          SELECT  COUNT (DISTINCT ENT_ID)                         08510080
085300             INTO :PV-ENT-ID-COUNT                                08520080
085400           FROM  TVAMCL                                           08530080
085500          WHERE DEPT_NBR          = :VAMCL-DEPT-NBR               08540080
085600            AND MAJ_CL_NBR        = :VAMCL-MAJ-CL-NBR             08550080
085700            AND ((FSCL_MN_END_DTE = :MLCNTL-OPN-FSCL-MN-DTE)      08560080
086000            OR  (FSCL_MN_END_DTE  = :DTATTR-PFM-END-DTE           08570080
086100            AND (END_INV_RTL_AMT  <> 0 OR                         08580080
086200                 END_INV_COST_AMT <> 0)))                         08590080
086300     END-EXEC.                                                    08600080
086400                                                                  08610080
086500     EVALUATE SQLCODE                                             08620080
086600         WHEN +0                                                  08630080
086700             CONTINUE                                             08640080
086800         WHEN OTHER                                               08650080
086900             MOVE '7155-GET-ENT-ID-COUNT' TO PV-PARAGRAPH-NAME    08660080
087000             MOVE PE-MSG-16              TO PV-OPERATION-ATTEMPTED08670080
087100             PERFORM 9999-SQL-ABEND                               08680080
087200     END-EVALUATE.                                                08690080
087300*                                                                 08700080
087400*                                                                 08710080
087500***************************************************************** 08720080
087600* RETRIEVES CURRENT MONTH SHRINK DOLLARS FROM TMNSCLS             08730080
087700***************************************************************** 08740080
087800 7200-SELECT-SHRINK-DLRS.                                         08750081
087900                                                                  08760080
088000     EXEC SQL                                                     08770080
088100          SELECT  SUM (SHNK_RTL_AMT)                              08780080
088200          INTO   :PV-MNMCL-SHNK-RTL-AMT                           08790080
088300            FROM TMNMCL                                           08800080
088400           WHERE FSCL_MN_END_DTE = :DTATTR-FSCL-MN-END-DTE        08810080
088500            AND  DEPT_NBR        = :VAMCL-DEPT-NBR                08820080
088600            AND  MAJ_CL_NBR      = :VAMCL-MAJ-CL-NBR              08830080
088700     END-EXEC.                                                    08840080
088800                                                                  08850080
088900     EVALUATE SQLCODE                                             08860080
089000         WHEN +0                                                  08870080
089100            CONTINUE                                              08880080
089200         WHEN -305                                                08890080
089300            MOVE ZERO TO PV-MNMCL-SHNK-RTL-AMT                    08900080
089400         WHEN OTHER                                               08910080
089500           DISPLAY SPACE                                          08920080
089700           DISPLAY 'OPEN MONTH DATE : '  DTATTR-FSCL-MN-END-DTE   08921083
089600           DISPLAY '    DEPT        : '  VAMCL-DEPT-NBR           08930083
089800           DISPLAY '    MAJ CLASS   : '  VAMCL-MAJ-CL-NBR         08950080
089900           DISPLAY '    ENT-ID      : '  VAMCL-ENT-ID             08960080
090000           MOVE '7200-SELECT-SHRINK-AMT' TO PV-PARAGRAPH-NAME     08970080
090100           MOVE PE-MSG-13                TO PV-OPERATION-ATTEMPTED08980080
090200           PERFORM 9999-SQL-ABEND                                 08990080
090300       END-EVALUATE.                                              09000080
090400*                                                                 09010080
090500*                                                                 09020080
090600***************************************************************** 09030080
090700*-- SUM RETAIL SALES FROM TVAMCL FOR AN DEPT/MCL                  09040080
090800***************************************************************** 09050080
090900 7250-SUM-SALES-DLRS.                                             09060080
091000                                                                  09070080
091100     EXEC SQL                                                     09080080
091200          SELECT  SUM (SLS_REG_RTL_AMT +                          09090080
091300                       SLS_PROMO_RTL_AMT +                        09100080
091400                       SLS_PROCLR_RTL_AMT +                       09110080
091500                       SLS_CLR_RTL_AMT +                          09120080
091600                       SLS_OTH_RTL_AMT)                           09130080
091700            INTO  :PV-MCL-SALES-AMT:PV-SALES-NULL-IND             09140080
091800            FROM TVAMCL                                           09150080
091900           WHERE FSCL_MN_NBR     = :DTATTR-FSCL-MN-NBR            09160080
092000             AND FSCL_MN_END_DTE = :DTATTR-FSCL-MN-END-DTE        09170080
092100             AND DEPT_NBR        = :VAMCL-DEPT-NBR                09180080
092200             AND MAJ_CL_NBR      = :VAMCL-MAJ-CL-NBR              09190080
092300     END-EXEC                                                     09200080
092400                                                                  09210080
092500     EVALUATE SQLCODE                                             09220080
092600         WHEN +0                                                  09230080
092610             IF PV-SALES-NULL-IND < 0                             09240080
092700                MOVE ZEROS              TO PV-MCL-SALES-AMT       09250080
092710             END-IF                                               09260080
092800         WHEN OTHER                                               09270080
092900             MOVE '7250-SUM END ID SSL' TO PV-PARAGRAPH-NAME      09280080
093000             MOVE 'NEED MESSAGE'        TO PV-OPERATION-ATTEMPTED 09290080
093100             PERFORM 9999-SQL-ABEND                               09300080
093200     END-EVALUATE.                                                09310080
093300*                                                                 09320080
093400*                                                                 09330080
093500***************************************************************** 09340080
093600* SELECT A ROW FROM DB2 TO BE RECALCED THEN INSERTED OR UPDATED   09350086
093700***************************************************************** 09360080
093800 7300-SELECT-CURRENT-DOLLARS.                                     09370080
093900                                                                  09380080
094000     EXEC SQL                                                     09390080
094100         SELECT SLS_REG_RTL_AMT                                   09400080
094200               ,SLS_PROMO_RTL_AMT                                 09410080
094300               ,SLS_PROCLR_RTL_AMT                                09420080
094400               ,SLS_CLR_RTL_AMT                                   09430080
094500               ,SLS_OTH_RTL_AMT                                   09440080
094600               ,MKDN_PLU_RTL_AMT                                  09450080
094700               ,MKDN_RGST_RTL_AMT                                 09460080
094800               ,MKDN_UMTCH_RTL_AMT                                09470080
094900               ,MKDN_BYR_RTL_AMT                                  09480080
095000               ,MKDN_STR_RTL_AMT                                  09490080
095100               ,MKUP_RTL_AMT                                      09500080
095200               ,XFER_IN_RTL_AMT                                   09510080
095300               ,XFER_OUT_RTL_AMT                                  09520080
095400               ,RCPT_RTL_AMT                                      09530080
095500               ,RCPT_NET_COST_AMT                                 09540080
095600               ,RCPT_GRO_COST_AMT                                 09550080
095700               ,PADJ_FRGT_COST_AMT                                09560080
095800               ,PADJ_DISC_COST_AMT                                09570080
095900               ,PADJ_RTL_AMT                                      09580080
096000               ,PADJ_NET_COST_AMT                                 09590080
096100               ,INV_ADJ_RTL_AMT                                   09600080
096200           INTO :VAMCL-SLS-REG-RTL-AMT                            09610080
096300               ,:VAMCL-SLS-PROMO-RTL-AMT                          09620080
096400               ,:VAMCL-SLS-PROCLR-RTL-AMT                         09630080
096500               ,:VAMCL-SLS-CLR-RTL-AMT                            09640080
096600               ,:VAMCL-SLS-OTH-RTL-AMT                            09650080
096700               ,:VAMCL-MKDN-PLU-RTL-AMT                           09660080
096800               ,:VAMCL-MKDN-RGST-RTL-AMT                          09670080
096900               ,:VAMCL-MKDN-UMTCH-RTL-AMT                         09680080
097000               ,:VAMCL-MKDN-BYR-RTL-AMT                           09690080
097100               ,:VAMCL-MKDN-STR-RTL-AMT                           09700080
097200               ,:VAMCL-MKUP-RTL-AMT                               09710080
097300               ,:VAMCL-XFER-IN-RTL-AMT                            09720080
097400               ,:VAMCL-XFER-OUT-RTL-AMT                           09730080
097500               ,:VAMCL-RCPT-RTL-AMT                               09740080
097600               ,:VAMCL-RCPT-NET-COST-AMT                          09750080
097700               ,:VAMCL-RCPT-GRO-COST-AMT                          09760080
097800               ,:VAMCL-PADJ-FRGT-COST-AMT                         09770080
097900               ,:VAMCL-PADJ-DISC-COST-AMT                         09780080
098000               ,:VAMCL-PADJ-RTL-AMT                               09790080
098100               ,:VAMCL-PADJ-NET-COST-AMT                          09800080
098200               ,:VAMCL-INV-ADJ-RTL-AMT                            09810080
098300            FROM TVAMCL                                           09820080
098400           WHERE FSCL_MN_NBR     = :DTATTR-FSCL-MN-NBR            09830080
098500             AND FSCL_MN_END_DTE = :DTATTR-FSCL-MN-END-DTE        09840080
098600             AND DEPT_NBR        = :VAMCL-DEPT-NBR                09850080
098700             AND MAJ_CL_NBR      = :VAMCL-MAJ-CL-NBR              09860080
098800             AND ENT_ID          = :VAMCL-ENT-ID                  09870080
098900     END-EXEC                                                     09880080
099000                                                                  09890080
099100     EVALUATE SQLCODE                                             09900080
099200         WHEN +0                                                  09910080
099300           SET PS-CURR-MONTH-ROW-FOUND   TO TRUE                  09920080
099400         WHEN +100                                                09930080
099500           SET PS-CURR-MONTH-ROW-NOT-FOUND   TO TRUE              09940080
099600         WHEN OTHER                                               09950080
099700           MOVE '7300-SELECT-CURRENT-DOLLARS' TO PV-PARAGRAPH-NAME09960081
099800           MOVE PE-MSG-04              TO PV-OPERATION-ATTEMPTED  09970081
099900           PERFORM 9999-SQL-ABEND                                 09980081
100000       END-EVALUATE.                                              09990080
100100*                                                                 10000080
100200*                                                                 10010080
100300******************************************************************10020080
100400* RETRIEVE LAST MONTH'S ENDING INVENTORY RETAIL/COST              10030080
100500*     THIS IS ALSO THE BEGINNING INVENTORY FOR THIS MONTH         10040080
100600******************************************************************10050080
100700 7350-SELECT-PREV-MONTH-END-INV.                                  10060080
100800                                                                  10070080
100900     EXEC SQL                                                     10080080
101000          SELECT  END_INV_RTL_AMT                                 10090080
101100                , END_INV_COST_AMT                                10100080
101200            INTO  :PV-PREV-MONTH-END-INV-RTL                      10110080
101300                 ,:PV-PREV-MONTH-END-INV-COST                     10120080
101400            FROM  TVAMCL                                          10130080
101500           WHERE  DEPT_NBR        = :VAMCL-DEPT-NBR               10140080
101600             AND  MAJ_CL_NBR      = :VAMCL-MAJ-CL-NBR             10150080
101700             AND  ENT_ID          = :VAMCL-ENT-ID                 10160080
101800             AND  FSCL_MN_END_DTE = :DTATTR-PFM-END-DTE           10170080
101900     END-EXEC.                                                    10180080
102000                                                                  10190080
102100     EVALUATE SQLCODE                                             10200080
102200         WHEN 0                                                   10210080
102300             SET PS-PREV-MONTH-ROW-FOUND TO TRUE                  10220080
102400         WHEN +100                                                10230080
102500             SET PS-PREV-MONTH-ROW-NOT-FOUND TO TRUE              10240080
102600             MOVE ZEROES TO PV-PREV-MONTH-END-INV-RTL             10250080
102700                            PV-PREV-MONTH-END-INV-COST            10260080
102800         WHEN OTHER                                               10270080
102900             MOVE PE-MSG-02            TO PV-OPERATION-ATTEMPTED  10280080
103000             MOVE  '7350-SELECT-PREV-MONTH-END-INV'               10290080
103100                                       TO PV-PARAGRAPH-NAME       10300080
103200             PERFORM 9999-SQL-ABEND                               10310080
103300     END-EVALUATE.                                                10320080
103400*                                                                 10330080
103500*                                                                 10340080
103600******************************************************************10350080
103700* 7400-PREV-SEASON-END-INV SELECTS THE ENDING INVENTORY COST &   *10360080
103800*      RETAIL FROM THE LAST DAY OF THE PREVIOUS FISCAL SEASON    *10370080
103900******************************************************************10380080
104000 7400-PREV-SEASON-END-INV.                                        10390080
104100                                                                  10400080
104200     MOVE 'N'    TO PS-PREV-SEASON-INV-SW.                        10410080
104300                                                                  10420080
104400     EXEC SQL                                                     10430080
104500          SELECT  END_INV_RTL_AMT                                 10440080
104600                 ,END_INV_COST_AMT                                10450080
104700            INTO  :VAMCL-END-INV-RTL-AMT                          10460080
104800                 ,:VAMCL-END-INV-COST-AMT                         10470080
104900            FROM  TVAMCL                                          10480080
105000           WHERE  DEPT_NBR        = :VAMCL-DEPT-NBR               10490080
105100             AND  MAJ_CL_NBR      = :VAMCL-MAJ-CL-NBR             10500080
105200             AND  ENT_ID          = :VAMCL-ENT-ID                 10510080
105300             AND  FSCL_MN_END_DTE = :DTATTR-PREV-SEA-END-DTE      10520080
105400     END-EXEC.                                                    10530080
105500                                                                  10540080
105600     EVALUATE SQLCODE                                             10550080
105700         WHEN 0                                                   10560080
105800             CONTINUE                                             10570080
105900         WHEN +100                                                10580080
106000             SET PS-NO-PREV-SEASONAL-INV       TO TRUE            10590080
106100         WHEN OTHER                                               10600080
106200             MOVE PE-MSG-02            TO PV-OPERATION-ATTEMPTED  10610080
106300             MOVE  '7400-PREV-SEASON-END-INV'                     10620080
106400                                       TO PV-PARAGRAPH-NAME       10630080
106500             PERFORM 9999-SQL-ABEND                               10640080
106600     END-EVALUATE.                                                10650080
106700*                                                                 10660080
106800*                                                                 10670080
106900***************************************************************** 10680080
107000* OPEN CURSOR FOR MONTH-END VALUES FOR THIS SEASON                10690080
107100***************************************************************** 10700080
107200 7425-OPEN-SEASON-CURSOR.                                         10710080
107300                                                                  10720080
107400     EXEC SQL                                                     10730080
107500         OPEN SEASON_TO_DATE_CSR                                  10740080
107600     END-EXEC                                                     10750080
107700                                                                  10760080
107800     IF SQLCODE = +0                                              10770080
107900         CONTINUE                                                 10780080
108000     ELSE                                                         10790080
108100         MOVE PE-MSG-03                 TO PV-OPERATION-ATTEMPTED 10800080
108200         MOVE '7425-OPEN-SEASON-CURSOR' TO PV-PARAGRAPH-NAME      10810080
108300         PERFORM 9999-SQL-ABEND                                   10820080
108400     END-IF.                                                      10830080
108500*                                                                 10840080
108600*                                                                 10850080
108700******************************************************************10860080
108800* 7450-FETCH-SEASON-CURSOR WILL RETRIEVE ALL ROWS WITH AN   ENDING10870089
108900* INVENTORY AMOUNT FOR EACH MONTH END DATE FOR THE CURRENT SEASON.10880080
109000******************************************************************10890080
109100 7450-FETCH-SEASONAL-CURSOR.                                      10900089
109200                                                                  10910080
109300     MOVE 'N'    TO PS-CURR-SEASON-CURSOR-SW.                     10920080
109400                                                                  10930080
109500     EXEC SQL                                                     10940080
109600           FETCH SEASON_TO_DATE_CSR                               10950080
109700            INTO  :VAMCL-XFER-IN-RTL-AMT                          10960080
109800                 ,:VAMCL-XFER-OUT-RTL-AMT                         10970080
109900                 ,:VAMCL-RCPT-RTL-AMT                             10980080
110000                 ,:VAMCL-RCPT-NET-COST-AMT                        10990080
110100                 ,:VAMCL-PADJ-RTL-AMT                             11000080
110200                 ,:VAMCL-PADJ-NET-COST-AMT                        11010080
110300                 ,:VAMCL-MKUP-RTL-AMT                             11020080
110400     END-EXEC.                                                    11030080
110500                                                                  11040080
110600     EVALUATE SQLCODE                                             11050080
110700          WHEN 0                                                  11060080
110800              CONTINUE                                            11070080
110900          WHEN +100                                               11080080
111000              SET PS-END-OF-CURR-SEASON-CSR    TO TRUE            11090080
111100          WHEN OTHER                                              11100080
111200              MOVE PE-MSG-04             TO PV-OPERATION-ATTEMPTED11110080
111300              MOVE '7450-FETCH-SEASONAL-CURSOR'                   11120089
111400                                         TO PV-PARAGRAPH-NAME     11130080
111500              PERFORM 9999-SQL-ABEND                              11140080
111600     END-EVALUATE.                                                11150080
111700*                                                                 11160080
111800*                                                                 11170080
111900******************************************************************11180080
112000* 7475-CURR-SEASON-COST SELECTS THE CURRENT MONTH RECEIPT NET    *11190080
112100*      COST AND PURCH ADJ NET COST AMTS FOR THE OPEN FISCAL      *11200080
112200*      PERIOD FOR A PARTICULAR ENT ID.                           *11210080
112300******************************************************************11220080
112400 7475-CURR-SEASON-COST.                                           11230080
112500                                                                  11240080
112600     MOVE 'N'    TO PS-CURRENT-PURCH-COST-SW.                     11250080
112700                                                                  11260080
112800     EXEC SQL                                                     11270080
112900          SELECT  RCPT_NET_COST_AMT                               11280080
113000                 ,PADJ_NET_COST_AMT                               11290080
113100            INTO  :PV-CURR-MONTH-RCPT-NET-COST                    11300080
113200                 ,:PV-CURR-MONTH-PADJ-NET-COST                    11310080
113300            FROM  TVAMCL                                          11320080
113400           WHERE  DEPT_NBR        = :VAMCL-DEPT-NBR               11330080
113500             AND  MAJ_CL_NBR      = :VAMCL-MAJ-CL-NBR             11340080
113600             AND  ENT_ID          = :VAMCL-ENT-ID                 11350080
113700             AND  FSCL_MN_END_DTE = :DTATTR-FSCL-MN-END-DTE       11360080
113800     END-EXEC.                                                    11370080
113900                                                                  11380080
114000     EVALUATE SQLCODE                                             11390080
114100         WHEN 0                                                   11400080
114200             CONTINUE                                             11410080
114300         WHEN +100                                                11420080
114400             SET PS-NO-CURRENT-PURCH-COSTS     TO TRUE            11430080
114500         WHEN OTHER                                               11440080
114600             MOVE PE-MSG-02            TO PV-OPERATION-ATTEMPTED  11450080
114700             MOVE  '7475-CURRENT-SEASON-COST'                     11460080
114800                                       TO PV-PARAGRAPH-NAME       11470080
114900             PERFORM 9999-SQL-ABEND                               11480080
115000     END-EVALUATE.                                                11490080
115100*                                                                 11500080
115200*                                                                 11510080
115300******************************************************************11520080
115400* UPDATE COLUMNS WITH VALUES JUST CALCULATED FOR THIS DEPARTMENT  11530080
115500******************************************************************11540080
115600 7500-UPDATE-PROCESSING.                                          11550080
115700                                                                  11560080
**TEMP*** THE FOLLOWING DISPLAYS ARE TEMPORARY TO DETERMINE             11561090
**TEMP*** WHAT IS NOT BEING RECALC'D                                    11562090
P18333*    DISPLAY ' UPDATE KEY: ' VAMCL-DEPT-NBR ' ' VAMCL-MAJ-CL-NBR  11563094
P18333*             ' ' VAMCL-ENT-ID.                                   11564094
P18333*    DISPLAY '       DATA: SHRINK ' PV-SHNK-RTL-AMT               11565094
P18333*                    ' ENDINV RTL ' PV-END-INV-RTL-AMT            11565194
P18333*                    ' CUM MKUP % ' PV-CUM-MKUP-PCT               11566094
P18333*                    ' ENDINV CST ' PV-END-INV-COST-AMT           11567094
P18333*                    ' SLS COST   ' PV-SLS-COST-AMT               11568094
P18333*                    ' GRO MARGIN ' PV-GRO-MRGN-AMT.              11569094
115800     EXEC SQL                                                     11570080
115900         UPDATE TVAMCL                                            11580080
116000            SET  SHNK_RTL_AMT     = :PV-SHNK-RTL-AMT              11590080
116100                ,END_INV_RTL_AMT  = :PV-END-INV-RTL-AMT           11600080
116200                ,CUM_MKUP_PCT     = :PV-CUM-MKUP-PCT              11610080
116300                ,END_INV_COST_AMT = :PV-END-INV-COST-AMT          11620080
116400                ,SLS_COST_AMT     = :PV-SLS-COST-AMT              11630080
116500                ,GRO_MRGN_AMT     = :PV-GRO-MRGN-AMT              11640080
116600          WHERE FSCL_MN_NBR       = :DTATTR-FSCL-MN-NBR           11650080
116700            AND FSCL_MN_END_DTE   = :DTATTR-FSCL-MN-END-DTE       11660080
116800            AND DEPT_NBR          = :VAMCL-DEPT-NBR               11670080
116900            AND MAJ_CL_NBR        = :VAMCL-MAJ-CL-NBR             11680080
117000            AND ENT_ID            = :VAMCL-ENT-ID                 11690080
117100     END-EXEC                                                     11700080
117200                                                                  11710080
117300     EVALUATE SQLCODE                                             11720080
117400         WHEN 0                                                   11730080
117500              ADD 1                TO PA-UPDATE-COUNT             11740080
117600         WHEN OTHER                                               11750080
117700              DISPLAY '*************************************'     11760080
117800              DISPLAY 'ROW IN PROCESS  : ', VAMCL-DEPT-NBR        11770080
117900                                            VAMCL-MAJ-CL-NBR      11780080
118000                                            VAMCL-ENT-ID          11790080
118100              DISPLAY 'MONTH-END-DATE  : ',                       11800080
118200                                        DTATTR-FSCL-MN-END-DTE    11810080
118300              DISPLAY 'FISCAL MONTH NBR: ',                       11820080
118400                                           DTATTR-FSCL-MN-NBR     11830080
118500              MOVE PE-MSG-06        TO PV-OPERATION-ATTEMPTED     11840080
118600              MOVE '7500-UPDATE-PROCESSING'                       11850080
118700                                    TO PV-PARAGRAPH-NAME          11860080
118800              PERFORM 9999-SQL-ABEND                              11870080
118900     END-EVALUATE.                                                11880080
119000*                                                                 11890080
119100*                                                                 11900080
119200******************************************************************11910080
119300* 7510-INSERT-CARRY-FWD-ROW                                       11920080
119400* PERFORMED IF NO ROW IS FOUND ON DB2 (FOR THIS PROCESSING MONTH) 11930080
119500* BUT INVENTORY DOLLARS (COST AND/OR RETAIL) FOUND FOR LAST MONTH 11940080
119600******************************************************************11950080
119700 7510-INSERT-CARRY-FWD-ROW.                                       11960080
119800                                                                  11970080
119900***  USED TO DISPLAY INSERTED ROWS DURING TESTING                 11980083
119900***  DISPLAY 'INSERTED ROW : ', VAMCL-DEPT-NBR, '-',              11981083
120000***    VAMCL-MAJ-CL-NBR, ' ', DTATTR-FSCL-MN-END-DTE ' '          11990083
120100***    VAMCL-ENT-ID                                               12000083
120200                                                                  12010080
120300     EXEC SQL                                                     12020080
120400         INSERT INTO TVAMCL                                       12030080
120500              (  FSCL_MN_NBR                                      12040080
120600               , FSCL_MN_END_DTE                                  12050080
120700               , DEPT_NBR                                         12060080
120800               , MAJ_CL_NBR                                       12070080
120900               , ENT_ID                                           12080080
121000               , SLS_REG_RTL_AMT                                  12090080
121010               , SLS_PROMO_RTL_AMT                                12100080
121020               , SLS_PROCLR_RTL_AMT                               12101080
121030               , SLS_CLR_RTL_AMT                                  12102080
121040               , SLS_OTH_RTL_AMT                                  12103080
121050               , MKDN_PLU_RTL_AMT                                 12104080
121060               , MKDN_RGST_RTL_AMT                                12105080
121070               , MKDN_UMTCH_RTL_AMT                               12106080
121080               , MKDN_BYR_RTL_AMT                                 12107080
121090               , MKDN_STR_RTL_AMT                                 12108080
121091               , MKUP_RTL_AMT                                     12109080
121092               , XFER_IN_RTL_AMT                                  12109180
121093               , XFER_OUT_RTL_AMT                                 12109280
121094               , RCPT_RTL_AMT                                     12109380
121095               , RCPT_NET_COST_AMT                                12109480
121096               , RCPT_GRO_COST_AMT                                12109580
121097               , PADJ_FRGT_COST_AMT                               12109680
121098               , PADJ_DISC_COST_AMT                               12109780
121099               , PADJ_RTL_AMT                                     12109880
121100               , PADJ_NET_COST_AMT                                12109980
121101               , DR_ALW_RTL_AMT                                   12110080
121102               , RTV_RTL_AMT                                      12110180
121103               , INV_ADJ_RTL_AMT                                  12110280
121104               , SHNK_RTL_AMT                                     12110380
121105               , MKUP_INIT_AMT                                    12110480
121106               , MKUP_NET_AMT                                     12110580
121107               , END_INV_RTL_AMT                                  12110680
121108               , CUM_MKUP_PCT                                     12110780
121109               , END_INV_COST_AMT                                 12110880
121110               , SLS_COST_AMT                                     12110980
121111               , GRO_MRGN_AMT      )                              12111080
121112         VALUES (:DTATTR-FSCL-MN-NBR                              12111180
121113                ,:DTATTR-FSCL-MN-END-DTE                          12111280
121114                ,:VAMCL-DEPT-NBR                                  12111380
121115                ,:VAMCL-MAJ-CL-NBR                                12111480
121116                ,:VAMCL-ENT-ID                                    12111580
121117                ,0                                                12111680
121118                ,0                                                12111780
121119                ,0                                                12111880
121120                ,0                                                12111980
121121                ,0                                                12112080
121122                ,0                                                12112180
121123                ,0                                                12112280
121124                ,0                                                12112380
121125                ,0                                                12112480
121126                ,0                                                12112580
121127                ,0                                                12112680
121128                ,0                                                12112780
121129                ,0                                                12112880
121130                ,0                                                12112980
121131                ,0                                                12113080
121132                ,0                                                12113180
121133                ,0                                                12113280
121134                ,0                                                12113380
121135                ,0                                                12113480
121136                ,0                                                12113580
121137                ,0                                                12113680
121138                ,0                                                12113780
121139                ,0                                                12113880
121140                ,:PV-SHNK-RTL-AMT                                 12113980
121141                ,0                                                12114080
121142                ,0                                                12114180
121143                ,:PV-END-INV-RTL-AMT                              12114280
121144                ,:PV-CUM-MKUP-PCT                                 12114380
121145                ,:PV-END-INV-COST-AMT                             12114480
121146                ,:PV-SLS-COST-AMT                                 12114580
121147                ,:PV-GRO-MRGN-AMT)                                12114680
121148                                                                  12114780
121149     END-EXEC.                                                    12114880
121150                                                                  12114980
121151     IF SQLCODE = 0                                               12115080
121152         ADD 1                      TO PA-INSERT-COUNT            12115180
121153     ELSE                                                         12115280
121154         MOVE '7510-INSERT-CARRY-FWD-ROW' TO PV-PARAGRAPH-NAME    12115380
121155         MOVE PE-MSG-14             TO PV-OPERATION-ATTEMPTED     12115480
121156         PERFORM 9999-SQL-ABEND                                   12115580
121157     END-IF.                                                      12115680
121158*                                                                 12115780
121159*                                                                 12115880
121160******************************************************************12115980
121200*                                                                 12116080
121300******************************************************************12117080
121400 7575-CLOSE-SEASON-CURSOR.                                        12118080
121500                                                                  12119080
121600     EXEC SQL                                                     12120080
121700         CLOSE SEASON_TO_DATE_CSR                                 12130080
121800     END-EXEC.                                                    12140080
121900                                                                  12150080
122000     EVALUATE SQLCODE                                             12160080
122100         WHEN 0                                                   12170080
122200             CONTINUE                                             12180080
122300         WHEN OTHER                                               12190080
122400             MOVE PE-MSG-05            TO PV-OPERATION-ATTEMPTED  12200080
122500             MOVE '7575-CLOSE-SEASON-CURSOR' TO PV-PARAGRAPH-NAME 12210080
122600             PERFORM 9999-SQL-ABEND                               12220080
122700     END-EVALUATE.                                                12230080
122800*                                                                 12240080
122900*                                                                 12250080
123000******************************************************************12260080
123100* 7650-INIT-CHECKPOINT-SELECT                                    *12270080
123200* CHECK STATUS CODE TO SEE IF THIS IS A RESTART CONDITION        *12280080
123300******************************************************************12290080
123400 7650-INIT-CHECKPOINT-SELECT.                                     12300080
123500                                                                  12310080
123600     EXEC SQL                                                     12320080
123700       SELECT  CKPT_STAT_CODE                                     12330080
123800              ,CKPT_FRQNCY_QTY                                    12340080
123900         INTO  :TCKRSTCNTL-CKPT-STAT-CODE                         12350080
124000              ,:TCKRSTCNTL-CKPT-FRQNCY-QTY                        12360080
124100         FROM  TCKRSTCNTL                                         12370080
124200        WHERE  JOB_NAME  = :PC-JOB-NAME                           12380080
124300          AND  PLAN_NAME = :PC-PROGRAM-NAME                       12390080
124400     END-EXEC.                                                    12400080
124500                                                                  12410080
124600     IF SQLCODE = 0                                               12420080
124700         CONTINUE                                                 12430080
124800     ELSE                                                         12440080
124900         MOVE '7650-INIT-CHECKPOINT-SELECT' TO PV-PARAGRAPH-NAME  12450080
125000         MOVE PE-MSG-07             TO PV-OPERATION-ATTEMPTED     12460080
125100         PERFORM 9999-SQL-ABEND                                   12470080
125200     END-IF.                                                      12480080
125300*                                                                 12490080
125400*                                                                 12500080
125500******************************************************************12510080
125600* 7700-SELECT-RESTART-INFO                                       *12520080
125700* OBTAIN INFORMATION REGARDING WHERE TO RESTART TABLE PROCESSING *12530080
125800******************************************************************12540080
125900 7700-SELECT-RESTART-INFO.                                        12550080
126000                                                                  12560080
126100     EXEC SQL                                                     12570080
126200       SELECT  WORK_STRG_DESC                                     12580080
126300         INTO  :TCKRSTINF-WORK-STRG-DESC                          12590080
126400         FROM  TCKRSTINF                                          12600080
126500        WHERE  JOB_NAME  = :PC-JOB-NAME                           12610080
126600          AND  PLAN_NAME = :PC-PROGRAM-NAME                       12620080
126700     END-EXEC.                                                    12630080
126800                                                                  12640080
126900     IF SQLCODE = 0                                               12650080
127000         CONTINUE                                                 12660080
127100     ELSE                                                         12670080
127200         MOVE '*7700-SELECT-RESTART-INFO*' TO PV-PARAGRAPH-NAME   12680080
127300         MOVE PE-MSG-11             TO PV-OPERATION-ATTEMPTED     12690080
127400         PERFORM 9999-SQL-ABEND                                   12700080
127500     END-IF.                                                      12710080
127600*                                                                 12720080
127700*                                                                 12730080
127800******************************************************************12740080
127900* 7800-COMMIT-PROCESSING.                                        *12750080
127910*      THE ENT-ID CURSOR IS ALWAYS CLOSED BY THE COMMIT WHEN     *12760080
127920*      A DEPT CHANGES OR WHEN THE END-OF-CURSOR IS REACHED       *12770080
127921*      SO CODE TO CLOSE FOR THE ENT-ID CURSOR WAS NOT NEEDED     *12780080
127930******************************************************************12790080
128100 7800-COMMIT-PROCESSING.                                          12800080
128200                                                                  12810080
128300     MOVE '*7800-COMMIT-PROCESSING*' TO PV-PARAGRAPH-NAME.        12820080
128400                                                                  12830080
128500***  CHECK DEPT-MCL COMBO                                         12840080
128600***      PREPARE COMMIT RECORD FOR UPDATE                         12850080
128700     ADD 1                           TO PA-COMMIT-COUNT.          12860080
128800     MOVE DTATTR-FSCL-MN-END-DTE     TO CR-FISCAL-MN-END-DTE.     12870080
128900     MOVE DTATTR-FSCL-MN-NBR         TO CR-FISCAL-MN-NBR.         12880080
129000     MOVE VAMCL-DEPT-NBR             TO CR-DEPT-NBR.              12890080
129100     MOVE PA-DEPT-MCL-COUNT          TO CR-TVAMCL-FETCH-COUNT.    12900080
129200     MOVE PA-UPDATE-COUNT            TO CR-TVAMCL-UPDATE-COUNT.   12910080
129300     MOVE PA-INSERT-COUNT            TO CR-TVAMCL-INSERT-COUNT.   12920080
129400     MOVE PA-COMMIT-COUNT            TO CR-TVAMCL-COMMIT-COUNT.   12930080
129410                                                                  12940080
129500***      MOVE COMMIT INFO TO WORKING STORAGE ROW                  12950080
129600     MOVE CR-CHECKPOINT-RESTART-AREA TO TCKRSTINF-WORK-STRG-DESC. 12960080
129800***  DISPLAY COMMITS POINTS DURING TESTING                        12970083
129800***  DISPLAY 'COMMIT TAKEN FOR DEPT: ' PV-COMMIT-DEPT.            12971083
129810                                                                  12980080
129900     IF PS-FIRST-COMMIT                                           12990080
130000         MOVE '9' TO TCKRSTCNTL-CKPT-STAT-CODE                    13000080
130100         PERFORM 7900-UPDATE-CHECKPOINT-STATUS                    13010080
130200         MOVE 'N' TO PS-FIRST-COMMIT-SW                           13020080
130300     END-IF.                                                      13030080
130310                                                                  13031080
130400     PERFORM 7850-COMMIT-CHANGES.                                 13032080
130410                                                                  13033080
130420***  REESTABLISH DATE CURSOR FOR THE DATE IT LEFT OFF ON          13034080
130500     PERFORM 7050-OPEN-DATE-CURSOR.                               13035080
130600     PERFORM 7075-FETCH-DATE-CURSOR.                              13036080
130610                                                                  13037080
130700***  REESTABLISH ENT-ID CURSOR FOR THE DEPT IT LEFT OFF ON        13038080
130800***  WHENEVER THERE IS A DEPT CHANGE COMMIT TAKING PLACE          13039080
130900***  OR SET HOST-VAR TO SPACES WHEN END OF ENT-ID CURSOR          13040080
131000     IF PS-END-OF-ENT-ID-CURSOR                                   13050080
131100        MOVE SPACES           TO VAMCL-DEPT-NBR                   13060080
131200     ELSE                                                         13070080
131300        PERFORM 7149-OPEN-ENT-ID-CURSOR                           13080080
131400        PERFORM 7150-FETCH-ENT-ID-CURSOR                          13090080
131600     END-IF.                                                      13100080
131800*                                                                 13110080
131900*                                                                 13120080
132000******************************************************************13130080
132100* 7850-COMMIT-CHANGES.                                            13140080
132200* UPDATE CHECKPOINT INFORMATION TABLE. TAKE A COMMIT.             13150080
132300******************************************************************13160080
132400 7850-COMMIT-CHANGES.                                             13170080
132500                                                                  13180080
132600     EXEC SQL                                                     13190080
132700       UPDATE TCKRSTINF                                           13200080
132800          SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC          13210080
132900        WHERE JOB_NAME       = :PC-JOB-NAME                       13220080
133000          AND PLAN_NAME      = :PC-PROGRAM-NAME                   13230080
133100     END-EXEC.                                                    13240080
133200                                                                  13250080
133300     IF SQLCODE = 0                                               13260080
133400         CONTINUE                                                 13270080
133500     ELSE                                                         13280080
133600         MOVE PE-MSG-08                  TO PV-OPERATION-ATTEMPTED13290080
133700         MOVE  '* 7850-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     13300080
133800         PERFORM 9999-SQL-ABEND                                   13310080
133900     END-IF.                                                      13320080
134000                                                                  13330080
134100     EXEC SQL                                                     13340080
134200         COMMIT                                                   13350080
134300     END-EXEC.                                                    13360080
134400                                                                  13370080
134500     IF SQLCODE = 0                                               13380080
134600         CONTINUE                                                 13390080
134700     ELSE                                                         13400080
134800         MOVE PE-MSG-09                  TO PV-OPERATION-ATTEMPTED13410080
134900         MOVE  '* 7850-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     13420080
135000         PERFORM 9999-SQL-ABEND                                   13430080
135100     END-IF.                                                      13440080
135200*                                                                 13450080
135300*                                                                 13460080
135400******************************************************************13470080
135500* UPDATE CHECKPOINT STATUS                                        13480080
135600******************************************************************13490080
135700 7900-UPDATE-CHECKPOINT-STATUS.                                   13500080
135800                                                                  13510080
135900     EXEC SQL                                                     13520080
136000       UPDATE  TCKRSTCNTL                                         13530080
136100          SET  CKPT_STAT_CODE = :TCKRSTCNTL-CKPT-STAT-CODE        13540080
136200        WHERE  JOB_NAME  = :PC-JOB-NAME                           13550080
136300          AND  PLAN_NAME = :PC-PROGRAM-NAME                       13560080
136400     END-EXEC.                                                    13570080
136500                                                                  13580080
136600     IF SQLCODE = 0                                               13590080
136700         CONTINUE                                                 13600080
136800     ELSE                                                         13610080
136900         MOVE '7900-UPDATE-CHECKPOINT-STATUS' TO PV-PARAGRAPH-NAME13620080
137000         MOVE PE-MSG-10                  TO PV-OPERATION-ATTEMPTED13630080
137100         PERFORM 9999-SQL-ABEND                                   13640080
137200     END-IF.                                                      13650080
137300*                                                                 13660080
137400*                                                                 13670080
147100******************************************************************13680080
147200*  RESET STATUS CODE, DISPLAY FINAL COUNTS , CLOSE INPUT FILE    *13690080
147300******************************************************************13700080
147400 8000-EOJ-ROUTINE.                                                13710080
147500                                                                  13720080
147600***  COMMIT ANY FINAL CHANGES THAT MAY HAVE BEEN MADE             13730080
147700     IF PS-EMPTY-RESULT-TABLE                                     13740080
147800         CONTINUE                                                 13750080
147900     ELSE                                                         13760080
148000         PERFORM 7800-COMMIT-PROCESSING                           13770080
148100     END-IF.                                                      13780080
148200                                                                  13790080
148300     MOVE '0' TO TCKRSTCNTL-CKPT-STAT-CODE.                       13800080
148400     PERFORM 7900-UPDATE-CHECKPOINT-STATUS.                       13810080
148500                                                                  13820080
148600     DISPLAY '                                             '.     13830080
148700     DISPLAY '******* END OF JOB STATISTICS ********'.            13840080
148800     DISPLAY '                                             '.     13850080
148900     DISPLAY 'DATES PROCESSED        : ', PA-DATE-COUNT.          13860083
149000     DISPLAY 'DEPT/MCL ROWS PROCESSED: ', PA-DEPT-MCL-COUNT.      13870083
149100     DISPLAY 'TVAMCL ROWS UPDATED    : ', PA-UPDATE-COUNT.        13880083
149200     DISPLAY 'TVAMCL ROWS INSERTED   : ', PA-INSERT-COUNT.        13890083
149300     DISPLAY '                                             '.     13900080
149400     DISPLAY 'COMMITS TAKEN          : ', PA-COMMIT-COUNT.        13910083
149500     DISPLAY '                                             '.     13920080
149600     DISPLAY '*********************** EOJ ********************'.  13930080
149700*                                                                 13940080
149800*                                                                 13950080
149900******************************************************************13960080
150000*  STANDARD DB2 ERROR ABEND ROUTINE                               13970080
150100*  THIS ROUTINE FORCES AN ABEND DUE TO A DB2 PROBLEM.             13980080
150200******************************************************************13990080
150300 9999-SQL-ABEND.                                                  14000080
150400                                                                  14010080
150500     MOVE +4013                 TO ABEND-CODE.                    14020080
150600     DISPLAY '**  ABEND     **'.                                  14030080
150700     DISPLAY '**  PROGRAM   ** => ' PC-PROGRAM-NAME.              14040080
150800     DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            14050080
150900     DISPLAY '**  OPERATION **  = ' PV-OPERATION-ATTEMPTED.       14060080
151000                                                                  14070080
151100***  THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE         14080080
151200***  DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.        14090080
151300                                                                  14100080
151400     COPY DPPD004.                                                14110080
151500     CALL 'ILBOABN0'  USING ABEND-CODE.                           14120080
151600*                                                                 14130080
151700*                                                                 14140080
