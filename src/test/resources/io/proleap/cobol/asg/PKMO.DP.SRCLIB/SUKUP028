000100 IDENTIFICATION DIVISION.                                         00010046
000200                                                                  00020046
000300* PROGRAM TO POPULATE THE SUT_TRIP_PRCHG TABLE                    00030046
000400*                                                                 00040046
000500 PROGRAM-ID.             SUKUP028.                                00050046
000600 AUTHOR.                 DAVID WELLER.                            00060046
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070046
000800 DATE-WRITTEN            AUGUST 2012.                             00080046
000900 DATE-COMPILED.                                                   00090046
001000*========================== CHANGE LOG ===========================00100046
001100*  BY        DATE     #                DESCRIPTION                00110046
001200*=================================================================00120046
001300*  C.PARMLEY 07-10-15 CHG              REPLACED MDSE PGM ID WITH  00130046
001400*                                      BRAND ID                   00140046
001500******************************************************************00150046
001600                                                                  00160046
001700 ENVIRONMENT DIVISION.                                            00170046
001800 CONFIGURATION SECTION.                                           00180046
001900 SOURCE-COMPUTER.        IBM-3090.                                00190046
002000 OBJECT-COMPUTER.        IBM-3090.                                00200046
002100 INPUT-OUTPUT SECTION.                                            00210046
002200 FILE-CONTROL.                                                    00220046
002300                                                                  00230046
002400     SELECT INPUT-UPDATE-FILE                                     00240046
002500         ASSIGN TO INP01.                                         00250046
002600                                                                  00260046
002700 DATA DIVISION.                                                   00270046
002800 FILE SECTION.                                                    00280046
002900                                                                  00290046
003000 FD  INPUT-UPDATE-FILE                                            00300046
003100     RECORDING MODE IS F                                          00310046
003200     LABEL RECORDS ARE STANDARD                                   00320046
003300     BLOCK CONTAINS 0  RECORDS.                                   00330046
003400 01  INPUT-UPDATE-REC                 PIC X(200).                 00340046
003500                                                                  00350046
003600 WORKING-STORAGE SECTION.                                         00360046
003700 01  PS-SWITCHES.                                                 00370046
003800     05  PS-EOF-EXTRACT-SW            PIC X(01) VALUE 'N'.        00380046
003900         88  PS-EOF-EXTRACT-YES                 VALUE 'Y'.        00390046
004000                                                                  00400046
004100 01  PROGRAM-VARIABLES.                                           00410046
004200     05  PS-END-OF-CSR-SW             PIC  X(01) VALUE 'N'.       00420046
004300         88 PS-END-OF-CSR-N                      VALUE 'N'.       00430046
004400         88 PS-END-OF-CSR-Y                      VALUE 'Y'.       00440046
004500     05  PV-DISP-NBR                  PIC Z,ZZZ,ZZ9.              00450046
004600     05  PV-DISP-TRIP-ID              PIC ZZZ,ZZZ,ZZ9.            00460046
004700     05  PV-ABEND-CODE                PIC S9(04) VALUE ZERO       00470046
004800                                                 COMP SYNC.       00480046
004900         88  ABEND-4013-DB2-ERROR                VALUE +4013.     00490046
005000     05  PV-INPUT-COUNT               PIC S9(09) COMP-3           00500046
005100                                          VALUE ZERO.             00510046
005200     05  PV-INSERT-COUNT              PIC S9(05) COMP-3           00520046
005300                                          VALUE ZERO.             00530046
005400     05  PV-PAST-DAYS                 PIC S9(09) COMP             00540046
005500                                          VALUE +0.               00550046
005600     05  PV-FUTURE-DAYS               PIC S9(09) COMP             00560046
005700                                          VALUE +0.               00570046
005800     05  PV-UPDATE-COUNT              PIC S9(05) COMP-3           00580046
005900                                          VALUE ZERO.             00590046
006000     05  PV-RETRY-COUNTER             PIC S9(03) COMP-3           00600046
006100                                        VALUE 3.                  00610046
006200     05  PC-MAX-RETRIES               PIC S9(03) COMP-3           00620046
006300                                        VALUE 3.                  00630046
006400     05  PV-ABEND-PARAGRAPH           PIC X(35) VALUE SPACES.     00640046
006500     05  PV-CURRENT-TMST              PIC X(26) VALUE SPACES.     00650046
006600                                                                  00660046
006700 01  PV-DISP-KEY-MSG.                                             00670046
006800     05  FILLER                      PIC X(11) VALUE              00680046
006900         ' TRIP-ID = '.                                           00690046
007000     05  PV-KEY-OTBND-TRIP-ID        PIC S9(09) VALUE ZEROES.     00700046
007100     05  FILLER                      PIC X(09) VALUE              00710046
007200         '; DEPT = '.                                             00720046
007300     05  PV-KEY-DEPT-NBR             PIC S9(04) VALUE ZEROES.     00730046
007400     05  FILLER                      PIC X(12) VALUE              00740046
007500         '; MAJ-CLS = '.                                          00750046
007600     05  PV-KEY-MAJ-CLS-NBR          PIC S9(04) VALUE ZEROES.     00760046
007700     05  FILLER                      PIC X(13) VALUE              00770046
007800         '; BUS-AREA = '.                                         00780046
007900     05  PV-KEY-BUS-AREA-ID          PIC S9(04) VALUE ZEROES.     00790046
008000*CLP 07/10/2015 START                                             00800046
008100     05  FILLER                      PIC X(13) VALUE              00810046
008200         '; BRND-ID  = '.                                         00820046
008300     05  PV-KEY-BRND-ID              PIC  9(05) VALUE ZEROES.     00830048
008400*CLP 07/10/2015 END                                               00840046
008500                                                                  00850046
008600     COPY SURD105.                                                00860046
008700                                                                  00870046
008800***DB2 ABEND COPYBOOK                                             00880046
008900     COPY DPWS900.                                                00890046
009000                                                                  00900046
009100     EXEC SQL                                                     00910046
009200         INCLUDE SUT00007                                         00920046
009300     END-EXEC.                                                    00930046
009400                                                                  00940046
009500     EXEC SQL                                                     00950046
009600         INCLUDE SUT00095                                         00960046
009700     END-EXEC.                                                    00970046
009800                                                                  00980046
009900     EXEC SQL                                                     00990046
010000         INCLUDE SUT00114                                         01000046
010100     END-EXEC.                                                    01010046
010200                                                                  01020046
010300     EXEC SQL                                                     01030046
010400         INCLUDE TKRPRPM                                          01040046
010500     END-EXEC.                                                    01050046
010600                                                                  01060046
010700     EXEC SQL                                                     01070046
010800         INCLUDE XLT00003                                         01080046
010900     END-EXEC.                                                    01090046
011000                                                                  01100046
011100     EXEC SQL                                                     01110046
011200         INCLUDE XLT00010                                         01120046
011300     END-EXEC.                                                    01130046
011400                                                                  01140046
011500     EXEC SQL                                                     01150046
011600         INCLUDE XLT00032                                         01160046
011700     END-EXEC.                                                    01170046
011800                                                                  01180046
011900     EXEC SQL                                                     01190046
012000         INCLUDE XLT00033                                         01200046
012100     END-EXEC.                                                    01210046
012200                                                                  01220046
012300     EXEC SQL                                                     01230046
012400         INCLUDE XLT00034                                         01240046
012500     END-EXEC.                                                    01250046
012600                                                                  01260046
012700     EXEC SQL                                                     01270046
012800         INCLUDE TCNTRID                                          01280046
012900     END-EXEC.                                                    01290046
013000                                                                  01300046
013100     EXEC SQL                                                     01310046
013200         INCLUDE TSUOBTR                                          01320046
013300     END-EXEC.                                                    01330046
013400                                                                  01340046
013500     EXEC SQL                                                     01350046
013600         INCLUDE SQLCA                                            01360046
013700     END-EXEC.                                                    01370046
013800                                                                  01380046
013900     COPY SQLCA2.                                                 01390046
014000     COPY DPWS004.                                                01400046
014100 EJECT                                                            01410046
014200/                                                                 01420046
014300 PROCEDURE DIVISION.                                              01430046
014400     PERFORM 1000-INITIALIZE.                                     01440046
014500     PERFORM 2000-PROCESS                                         01450046
014600             UNTIL PS-EOF-EXTRACT-YES                             01460046
014700     PERFORM 9000-EOJ.                                            01470046
014800                                                                  01480046
014900     GOBACK.                                                      01490046
015000                                                                  01500046
015100 1000-INITIALIZE.                                                 01510046
015200                                                                  01520046
015300     OPEN INPUT INPUT-UPDATE-FILE.                                01530046
015400                                                                  01540046
015500     EXEC SQL                                                     01550046
015600         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 01560046
015700     END-EXEC.                                                    01570046
015800                                                                  01580046
015900     PERFORM 8000-READ-EXTRACT-FILE.                              01590046
016000     IF PS-EOF-EXTRACT-YES                                        01600046
016100         DISPLAY ' SUKUP028 - INPUT FILE IS EMPTY '               01610046
016200     END-IF.                                                      01620046
016300                                                                  01630046
016400 2000-PROCESS.                                                    01640046
016500                                                                  01650046
016600     PERFORM 4100-UPDATE-TRIP-PRCHG.                              01660046
016700     IF SQLCODE = +100                                            01670046
016800        PERFORM 4200-INSERT-TRIP-PRCHG                            01680046
016900     END-IF.                                                      01690046
017000                                                                  01700046
017100     PERFORM 8000-READ-EXTRACT-FILE.                              01710046
017200     IF PS-EOF-EXTRACT-YES                                        01720046
017300         DISPLAY ' SUKUP028 - END OF INPUT FILE '                 01730046
017400     END-IF.                                                      01740046
017500                                                                  01750046
017600 4100-UPDATE-TRIP-PRCHG.                                          01760046
017700                                                                  01770046
017800     MOVE SU105-OTBND-TRIP-ID    TO SUT00114-OTBND-TRIP-ID        01780046
017900                                    PV-KEY-OTBND-TRIP-ID.         01790046
018000     MOVE SU105-DEPT-NBR         TO SUT00114-DEPT-NBR             01800046
018100                                    PV-KEY-DEPT-NBR.              01810046
018200     MOVE SU105-MAJ-CLS-NBR      TO SUT00114-MAJ-CLS-NBR          01820046
018300                                    PV-KEY-MAJ-CLS-NBR.           01830046
018400     MOVE SU105-BUS-AREA-ID      TO SUT00114-BUS-AREA-ID          01840046
018500                                    PV-KEY-BUS-AREA-ID.           01850046
018600*CLP 07/10/2015 START                                             01860046
018700     MOVE SU105-BRND-ID          TO SUT00114-BRND-ID              01870046
018800                                    PV-KEY-BRND-ID.               01880046
018900*CLP 07/10/2015 END                                               01890046
019000     MOVE SU105-SKU-NBR          TO SUT00114-SKU-NBR.             01900046
019100     MOVE SU105-UPD-PRIC-EFF-DTE                                  01910046
019200                                 TO SUT00114-UPD-PRIC-EFF-DTE.    01920046
019300     MOVE SU105-SUMMED-UNT-QTY   TO SUT00114-UNT-QTY.             01930046
019400     MOVE SU105-UNT-RTL-AMT      TO SUT00114-UNT-RTL-AMT.         01940046
019500     MOVE SU105-PREV-UNT-RTL-AMT TO SUT00114-PREV-UNT-RTL-AMT.    01950046
019600*    MOVE SU105-LAST-UPD-TMST    TO SUT00114-LAST-UPD-TMST.       01960046
019700     MOVE PV-CURRENT-TMST        TO SUT00114-LAST-UPD-TMST.       01970046
019800                                                                  01980046
019900     PERFORM 7000-UPDATE-TRIP-PRCHG.                              01990046
020000                                                                  02000046
020100 4200-INSERT-TRIP-PRCHG.                                          02010046
020200                                                                  02020046
020300     PERFORM 7100-INSERT-TRIP-PRCHG.                              02030046
020400                                                                  02040046
020500 7000-UPDATE-TRIP-PRCHG.                                          02050046
020600                                                                  02060046
020700     MOVE '7000-UPDATE-TRIP-PRCHG'    TO PV-ABEND-PARAGRAPH       02070046
020800                                                                  02080046
020900     PERFORM                                                      02090046
021000         WITH TEST AFTER                                          02100046
021100         VARYING PV-RETRY-COUNTER                                 02110046
021200         FROM 1 BY 1                                              02120046
021300               UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)         02130046
021400                  OR  (SQLCODE = +100)                            02140046
021500                  OR  (SQLCODE = +0))                             02150046
021600                                                                  02160046
021700     EXEC SQL                                                     02170046
021800         UPDATE SUT_TRIP_PRCHG                                    02180046
021900            SET LAST_UPD_TMST     = :SUT00114-LAST-UPD-TMST       02190046
022000         WHERE                                                    02200046
022100             OTBND_TRIP_ID        = :SUT00114-OTBND-TRIP-ID       02210046
022200         AND DEPT_NBR             = :SUT00114-DEPT-NBR            02220046
022300         AND MAJ_CLS_NBR          = :SUT00114-MAJ-CLS-NBR         02230046
022400         AND BUS_AREA_ID          = :SUT00114-BUS-AREA-ID         02240046
022500*CLP 07/10/2015 START                                             02250046
022600         AND BRND_ID              = :SUT00114-BRND-ID             02260046
022700*CLP 07/10/2015 END                                               02270046
022800         AND SKU_NBR              = :SUT00114-SKU-NBR             02280046
022900         AND UPD_PRIC_EFF_DTE     = :SUT00114-UPD-PRIC-EFF-DTE    02290046
023000         AND UNT_QTY              = :SUT00114-UNT-QTY             02300046
023100         AND UNT_RTL_AMT          = :SUT00114-UNT-RTL-AMT         02310046
023200         AND PREV_UNT_RTL_AMT     = :SUT00114-PREV-UNT-RTL-AMT    02320046
023300                                                                  02330046
023400     END-EXEC                                                     02340046
023500                                                                  02350046
023600     EVALUATE TRUE                                                02360046
023700         WHEN SQLCODE = ZERO                                      02370046
023800             ADD 1                    TO PV-UPDATE-COUNT          02380046
023900         WHEN SQLCODE = +100                                      02390046
024000             CONTINUE                                             02400046
024100         WHEN SQLCODE = -904                                      02410046
024200         WHEN SQLCODE = -911                                      02420046
024300         WHEN SQLCODE = -913                                      02430046
024400             CONTINUE                                             02440046
024500                                                                  02450046
024600         WHEN (SQLCODE > ZERO OR SQLWARN0 = 'W')                  02460046
024700             DISPLAY '**************************************'     02470046
024800             DISPLAY 'WARNING ISSUED '                            02480046
024900             DISPLAY 'UPDATE SUT_TRIP_PRCHG                 '     02490046
025000             DISPLAY  PV-DISP-KEY-MSG                             02500046
025100             DISPLAY '**************************************'     02510046
025200             PERFORM 9800-SQL-WARNING                             02520046
025300                                                                  02530046
025400         WHEN SQLCODE < ZERO                                      02540046
025500             DISPLAY '**************************************'     02550046
025600             DISPLAY 'ERROR ISSUED ON                       '     02560046
025700             DISPLAY 'UPDATE SUT_TRIP_PRCHG                 '     02570046
025800             DISPLAY PV-DISP-KEY-MSG                              02580046
025900             DISPLAY '**************************************'     02590046
026000             PERFORM 9900-SQL-ERROR                               02600046
026100         END-EVALUATE                                             02610046
026200     END-PERFORM.                                                 02620046
026300                                                                  02630046
026400     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                    02640046
026500         SQLCODE NOT = ZERO                                       02650046
026600         DISPLAY '**************************************'         02660046
026700         DISPLAY 'MAX RETRIES EXCEEDED ATTEMPTING TO    '         02670046
026800         DISPLAY 'UPDATE SUT_TRIP_PRCHG'                          02680046
026900         DISPLAY PV-DISP-KEY-MSG                                  02690046
027000         DISPLAY '**************************************'         02700046
027100         PERFORM 9900-SQL-ERROR                                   02710046
027200     END-IF.                                                      02720046
027300                                                                  02730046
027400 7100-INSERT-TRIP-PRCHG.                                          02740046
027500     MOVE '7100-INSERT-TRIP-PRCHG'    TO PV-ABEND-PARAGRAPH       02750046
027600                                                                  02760046
027700     PERFORM                                                      02770046
027800         WITH TEST AFTER                                          02780046
027900         VARYING PV-RETRY-COUNTER                                 02790046
028000         FROM 1 BY 1                                              02800046
028100               UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)         02810046
028200                  OR  (SQLCODE = +0))                             02820046
028300                                                                  02830046
028400     EXEC SQL                                                     02840046
028500         INSERT INTO SUT_TRIP_PRCHG                               02850046
028600         (   OTBND_TRIP_ID                                        02860046
028700            ,DEPT_NBR                                             02870046
028800            ,MAJ_CLS_NBR                                          02880046
028900            ,BUS_AREA_ID                                          02890046
029000*CLP 07/10/2015 START                                             02900046
029100            ,BRND_ID                                              02910046
029200*CLP 07/10/2015 END                                               02920046
029300            ,SKU_NBR                                              02930046
029400            ,UPD_PRIC_EFF_DTE                                     02940046
029500            ,UNT_QTY                                              02950046
029600            ,UNT_RTL_AMT                                          02960046
029700            ,PREV_UNT_RTL_AMT                                     02970046
029800            ,LAST_UPD_TMST  )                                     02980046
029900             VALUES                                               02990046
030000         (   :SUT00114-OTBND-TRIP-ID                              03000046
030100            ,:SUT00114-DEPT-NBR                                   03010046
030200            ,:SUT00114-MAJ-CLS-NBR                                03020046
030300            ,:SUT00114-BUS-AREA-ID                                03030046
030400*CLP 07/10/2015 START                                             03040046
030500            ,:SUT00114-BRND-ID                                    03050046
030600*CLP 07/10/2015 END                                               03060046
030700            ,:SUT00114-SKU-NBR                                    03070046
030800            ,:SUT00114-UPD-PRIC-EFF-DTE                           03080046
030900            ,:SUT00114-UNT-QTY                                    03090046
031000            ,:SUT00114-UNT-RTL-AMT                                03100046
031100            ,:SUT00114-PREV-UNT-RTL-AMT                           03110046
031200            ,:SUT00114-LAST-UPD-TMST  )                           03120046
031300     END-EXEC                                                     03130046
031400                                                                  03140046
031500     EVALUATE TRUE                                                03150046
031600         WHEN SQLCODE = ZERO                                      03160046
031700             ADD 1                    TO PV-INSERT-COUNT          03170046
031800         WHEN SQLCODE = -803                                      03180046
031900             CONTINUE                                             03190046
032000         WHEN SQLCODE = -904                                      03200046
032100         WHEN SQLCODE = -911                                      03210046
032200         WHEN SQLCODE = -913                                      03220046
032300             CONTINUE                                             03230046
032400                                                                  03240046
032500         WHEN (SQLCODE > ZERO OR SQLWARN0 = 'W')                  03250046
032600             DISPLAY '**************************************'     03260046
032700             DISPLAY 'WARNING ISSUED '                            03270046
032800             DISPLAY 'INSERT SUT_TRIP_PRCHG'                      03280046
032900             DISPLAY  PV-DISP-KEY-MSG                             03290046
033000             DISPLAY '**************************************'     03300046
033100             PERFORM 9800-SQL-WARNING                             03310046
033200                                                                  03320046
033300         WHEN SQLCODE < ZERO                                      03330046
033400             DISPLAY '**************************************'     03340046
033500             DISPLAY 'ERROR ISSUED ON                       '     03350046
033600             DISPLAY 'INSERT SUT_TRIP_PRCHG'                      03360046
033700             DISPLAY PV-DISP-KEY-MSG                              03370046
033800             DISPLAY '**************************************'     03380046
033900             PERFORM 9900-SQL-ERROR                               03390046
034000         END-EVALUATE                                             03400046
034100     END-PERFORM.                                                 03410046
034200                                                                  03420046
034300     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                    03430046
034400         SQLCODE NOT = ZERO                                       03440046
034500         DISPLAY '**************************************'         03450046
034600         DISPLAY 'MAX RETRIES EXCEEDED ATTEMPTING TO    '         03460046
034700         DISPLAY 'INSERT SUT_TRIP_PRCHG'                          03470046
034800         DISPLAY PV-DISP-KEY-MSG                                  03480046
034900         DISPLAY '**************************************'         03490046
035000         PERFORM 9900-SQL-ERROR                                   03500046
035100     END-IF.                                                      03510046
035200                                                                  03520046
035300 8000-READ-EXTRACT-FILE.                                          03530046
035400                                                                  03540046
035500     READ INPUT-UPDATE-FILE                                       03550046
035600         INTO SU105-INPUT-RECORD                                  03560046
035700     AT END                                                       03570046
035800         SET PS-EOF-EXTRACT-YES       TO TRUE                     03580046
035900     NOT AT END                                                   03590046
036000         ADD 1                        TO PV-INPUT-COUNT           03600046
036100     END-READ.                                                    03610046
036200                                                                  03620046
036300 9000-EOJ.                                                        03630046
036400                                                                  03640046
036500     CLOSE      INPUT-UPDATE-FILE.                                03650046
036600                                                                  03660046
036700     DISPLAY SPACES.                                              03670046
036800     DISPLAY ' SUKUP028'                                          03680046
036900     DISPLAY SPACES.                                              03690046
037000     MOVE PV-INPUT-COUNT              TO PV-DISP-NBR              03700046
037100     DISPLAY 'INPUTS READ   = ' PV-DISP-NBR.                      03710046
037200     MOVE PV-UPDATE-COUNT             TO PV-DISP-NBR              03720046
037300     DISPLAY 'ROWS UPDATED  = ' PV-DISP-NBR.                      03730046
037400     MOVE PV-INSERT-COUNT             TO PV-DISP-NBR              03740046
037500     DISPLAY 'ROWS INSERTED = ' PV-DISP-NBR.                      03750046
037600                                                                  03760046
037700 9800-SQL-WARNING.                                                03770046
037800                                                                  03780046
037900     MOVE SQLCODE               TO SQLCODE2.                      03790046
038000     MOVE SQLERRD(3)            TO SQLERRD3.                      03800046
038100     DISPLAY '** ABEND **       ** = SQLWARNING'.                 03810046
038200     DISPLAY '** PROGRAM        ** = SUKUP028'.                   03820046
038300     DISPLAY '** PARAGRAPH      ** = ' PV-ABEND-PARAGRAPH.        03830046
038400     DISPLAY '** SQLCODE        ** = ' SQLCODE2.                  03840046
038500     DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                  03850046
038600                                                                  03860046
038700     COPY DPPD004.                                                03870046
038800     SET ABEND-4013-DB2-ERROR   TO TRUE                           03880046
038900     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         03890046
039000                                                                  03900046
039100 9900-SQL-ERROR.                                                  03910046
039200                                                                  03920046
039300     MOVE SQLCODE               TO SQLCODE2.                      03930046
039400     MOVE SQLERRD(3)            TO SQLERRD3.                      03940046
039500     DISPLAY '** ABEND **       ** = SQLERROR'.                   03950046
039600     DISPLAY '** PROGRAM        ** = SUKUP028'.                   03960046
039700     DISPLAY '** PARAGRAPH      ** = ' PV-ABEND-PARAGRAPH.        03970046
039800     DISPLAY '** SQLCODE        ** = ' SQLCODE2.                  03980046
039900                                                                  03990046
040000     COPY DPPD004.                                                04000046
040100     SET ABEND-4013-DB2-ERROR   TO TRUE                           04010046
040200     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         04020046
