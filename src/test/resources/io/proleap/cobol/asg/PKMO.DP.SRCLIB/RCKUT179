000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400*  BUILD TIMESTAMP RANGE FILE                                     00040000
000500***************************************************************** 00050000
000600*                                                                 00060000
000700 PROGRAM-ID.    RCKUT179.                                         00070000
000800 AUTHOR.        RON KRIER.                                        00080000
000900 INSTALLATION.  KOHLS.                                            00090000
001000 DATE-WRITTEN   JUNE 2021.                                        00100000
001100 DATE-COMPILED.                                                   00110000
001200                                                                  00120000
001300***************************************************************** 00130000
001400*  THIS PROGRAM WILL SET THE TIMESTAMP RANGE FOR USE IN         * 00140000
001500*  PROGRAMS NEEDING A TIMESTAMP RANGE TO PULL DATA FOR.         * 00150000
001600*   FROM TIMESTAMP IS FROM THE PREVIOUS TIMESTAMP RANGE         * 00160000
001700*   TO   TIMESTAMP IS THE CURRENT TIMESTAMP MINUS X MINUTES     * 00170000
001800*                                                               * 00180000
001900***************************************************************** 00190000
002000 ENVIRONMENT DIVISION.                                            00200000
002100 INPUT-OUTPUT SECTION.                                            00210000
002200                                                                  00220000
002300 FILE-CONTROL.                                                    00230000
002400                                                                  00240000
002500     SELECT LAST-RUN-FILE                                         00250000
002600         ASSIGN TO INP01.                                         00260000
002700                                                                  00270000
002800     SELECT TIMESTAMP-FILE                                        00280000
002900         ASSIGN TO OUT01.                                         00290000
003000                                                                  00300000
003100     SELECT THIS-RUN-FILE                                         00310000
003200         ASSIGN TO OUT02.                                         00320000
003300                                                                  00330000
003400***************************************************************** 00340000
003500 DATA DIVISION.                                                   00350000
003600***************************************************************** 00360000
003700 FILE SECTION.                                                    00370000
003800                                                                  00380000
003900 FD  LAST-RUN-FILE                                                00390000
004000     RECORDING MODE IS F                                          00400000
004100     BLOCK CONTAINS 0 RECORDS                                     00410000
004200     LABEL RECORDS ARE STANDARD.                                  00420000
004300                                                                  00430000
004400 01  LAST-RUN-DATE-REC            PIC X(80).                      00440000
004500                                                                  00450000
004600 FD  TIMESTAMP-FILE                                               00460000
004700     RECORDING MODE IS F                                          00470000
004800     BLOCK CONTAINS 0 RECORDS                                     00480000
004900     LABEL RECORDS ARE STANDARD.                                  00490000
005000                                                                  00500000
005100 01  TIMESTAMP-RECORD             PIC X(80).                      00510000
005200                                                                  00520000
005300 FD  THIS-RUN-FILE                                                00530000
005400     RECORDING MODE IS F                                          00540000
005500     BLOCK CONTAINS 0 RECORDS                                     00550000
005600     LABEL RECORDS ARE STANDARD.                                  00560000
005700                                                                  00570000
005800 01  THIS-RUN-DATE-REC            PIC X(80).                      00580000
005900                                                                  00590000
006000                                                                  00600000
006100***************************************************************** 00610000
006200 WORKING-STORAGE SECTION.                                         00620000
006300                                                                  00630000
006400 01  PC-PROGRAM-CONSTANTS.                                        00640000
006500     05  PC-PROGRAM-NAME              PIC  X(08) VALUE 'RCKUT179'.00650000
006600                                                                  00660000
006700 01  PV-PROGRAM-VARIABLES.                                        00670000
006800     05  PV-CURR-TIMESTAMP            PIC X(26) VALUE SPACES.     00680000
006900     05  PV-FROM-TIMESTAMP            PIC X(26) VALUE SPACES.     00690000
006910     05  PV-TO-TIMESTAMP              PIC X(26) VALUE SPACES.     00691000
006920     05  PV-DISP-MIN                  PIC ZZZ9.                   00692000
006930                                                                  00693000
006940 01  PV-ABEND-FIELDS.                                             00694000
006950     05  PV-ABEND-PARAGRAPH           PIC  X(50) VALUE SPACES.    00695000
006960     05  PV-ABEND-TABLE               PIC  X(12) VALUE SPACES.    00696000
006970     05  PV-DB2-MESSAGE               PIC  X(50) VALUE SPACES.    00697000
006980     05  PV-ABEND-CODE                PIC S9(04) COMP SYNC        00698000
006990                                                 VALUE +0.        00699000
007000                                                                  00700000
007100 01  TIMESTAMP-REC-OUT.                                           00710000
007200     05  TR-FROM-TIMESTAMP            PIC X(26)   VALUE SPACES.   00720000
007300     05  FILLER                       PIC X(1)    VALUE SPACES.   00730000
007400     05  TR-TO-TIMESTAMP              PIC X(26)   VALUE SPACES.   00740000
007500     05  FILLER                       PIC X(27)   VALUE SPACES.   00750000
007600                                                                  00760000
007700                                                                  00770000
007800*----------------------------------------------------------------*00780000
007900*  TKRPRPM - PARM TABLE                                          *00790000
008000*----------------------------------------------------------------*00800000
008100     EXEC SQL                                                     00810000
008200          INCLUDE TKRPRPM                                         00820000
008300     END-EXEC.                                                    00830000
008400                                                                  00840000
008500*----------------------------------------------------------------*00850000
008600*   COMMUNICATION AREA FOR DB2                                   *00860000
008700*----------------------------------------------------------------*00870000
008800     EXEC SQL                                                     00880000
008900          INCLUDE SQLCA                                           00890000
009000     END-EXEC.                                                    00900000
009100                                                                  00910000
009200     COPY DPWS004.                                                00920000
009300                                                                  00930000
009400                                                                  00940000
009500***************************************************************** 00950000
009600 PROCEDURE DIVISION.                                              00960000
009700***************************************************************** 00970000
009800                                                                  00980000
009900     OPEN INPUT  LAST-RUN-FILE                                    00990000
010000          OUTPUT TIMESTAMP-FILE                                   01000000
010100          OUTPUT THIS-RUN-FILE.                                   01010000
010200                                                                  01020000
010300     DISPLAY '*'.                                                 01030000
010400     DISPLAY '* START - RCKUT179'.                                01040000
010410     DISPLAY '*'.                                                 01041000
010420                                                                  01042000
010430     PERFORM 1000-GET-CURRENT-TMST.                               01043000
010440                                                                  01044000
010450     PERFORM 1010-READ-LAST-RUN-DATE.                             01045000
010460                                                                  01046000
010470     DISPLAY '* FROM TIMESTAMP:' PV-FROM-TIMESTAMP.               01047000
010480     DISPLAY '* TO TIMESTAMP:  ' PV-TO-TIMESTAMP.                 01048000
010490     DISPLAY '*'.                                                 01049000
010500                                                                  01050000
010600     PERFORM 3000-WRITE-THIS-RUN-DATE.                            01060000
010700     PERFORM 3020-WRITE-TIMESTAMP.                                01070000
010800                                                                  01080000
010900     CLOSE LAST-RUN-FILE                                          01090000
011000           TIMESTAMP-FILE                                         01100000
011100           THIS-RUN-FILE.                                         01110000
011200                                                                  01120000
011300     GOBACK.                                                      01130000
011400                                                                  01140000
011500***************************************************************** 01150000
011600*  GET THE CURRENT TIMESTAMP                                      01160000
011700***************************************************************** 01170000
011800 1000-GET-CURRENT-TMST.                                           01180000
011900                                                                  01190000
012000     EXEC SQL                                                     01200000
012100         SELECT  FUNC_QTY                                         01210000
012200              ,  CURRENT TIMESTAMP                                01220000
012300              ,  CURRENT TIMESTAMP - FUNC_QTY MINUTES             01230000
012400           INTO :KRPRPM-FUNC-QTY                                  01240000
012410              , :PV-CURR-TIMESTAMP                                01241000
012420              , :PV-TO-TIMESTAMP                                  01242000
012430           FROM  TKRPRPM                                          01243000
012440         WHERE LOC_ID            = 90                             01244000
012450           AND INTFC_SYS_CDE     = 'KHL'                          01245000
012460           AND SYS_PRC_FUNC_CDE  = 'RCSSPE'                       01246000
012470           AND FUNC_PRC_STAT_CDE = 'AC'                           01247000
012480           AND FUNC_BEG_TMST    <=  CURRENT TIMESTAMP             01248000
012490           AND FUNC_END_TMST    >=  CURRENT TIMESTAMP             01249000
012500     END-EXEC.                                                    01250000
012600                                                                  01260000
012601     MOVE KRPRPM-FUNC-QTY  TO  PV-DISP-MIN.                       01260100
012602     DISPLAY '*'.                                                 01260200
012603     DISPLAY '* PARM: RCSSPE  MINUTES:' PV-DISP-MIN.              01260300
012604     DISPLAY '*'.                                                 01260400
012605     DISPLAY '* CURR TIMESTAMP:' PV-CURR-TIMESTAMP                01260500
012606     DISPLAY '* CURR - RCSSPE :' PV-TO-TIMESTAMP                  01260600
012607     DISPLAY '*'.                                                 01260700
012608                                                                  01260800
012609                                                                  01260900
012610***************************************************************** 01261000
012611*  READ THE DATASET WITH THE LAST RUN DATE IN IT                  01261100
012620***************************************************************** 01262000
012630 1010-READ-LAST-RUN-DATE.                                         01263000
012640                                                                  01264000
012650     READ LAST-RUN-FILE                                           01265000
012660            AT END                                                01266000
012670               MOVE 'MISSING LAST RUN DATE DATASET'               01267000
012680                                TO PV-DB2-MESSAGE                 01268000
012690               MOVE '1010-READ-LAST-RUN-DATE'                     01269000
012700                                TO PV-ABEND-PARAGRAPH             01270000
012800               MOVE 'INP01'     TO PV-ABEND-TABLE                 01280000
012900               PERFORM 9100-SQL-ABEND                             01290000
013000     END-READ.                                                    01300000
013100                                                                  01310000
013200     MOVE LAST-RUN-DATE-REC(1:26)  TO PV-FROM-TIMESTAMP.          01320000
013300                                                                  01330000
013400                                                                  01340000
013500***************************************************************** 01350000
013600*  WRITE OUT THE DATASET WITH THE CURRENT RUN DATE, FOR NEXT RUN  01360000
013700***************************************************************** 01370000
013800 3000-WRITE-THIS-RUN-DATE.                                        01380000
013900                                                                  01390000
014000     MOVE PV-TO-TIMESTAMP       TO THIS-RUN-DATE-REC.             01400000
014100     WRITE THIS-RUN-DATE-REC.                                     01410000
014200                                                                  01420000
014300                                                                  01430000
014400******************************************************************01440000
014500*  CREATE TIMESTAMP RANGE FILE                                    01450000
014700******************************************************************01470000
014800 3020-WRITE-TIMESTAMP.                                            01480000
014900                                                                  01490000
015000                                                                  01500000
015100     MOVE PV-FROM-TIMESTAMP     TO TR-FROM-TIMESTAMP.             01510000
015200     MOVE PV-TO-TIMESTAMP       TO TR-TO-TIMESTAMP.               01520000
015300                                                                  01530000
015400     WRITE TIMESTAMP-RECORD                                       01540000
015500      FROM TIMESTAMP-REC-OUT.                                     01550000
015600                                                                  01560000
015700     DISPLAY 'DATE RANGE: ' TIMESTAMP-REC-OUT.                    01570000
015800                                                                  01580000
015900                                                                  01590000
016000 9100-SQL-ABEND.                                                  01600000
016100******************************************************************01610000
016200*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    01620000
016300*  ERROR OR WARNING CODE OCCURS.                                  01630000
016400******************************************************************01640000
016500     DISPLAY '9100-SQL-ABEND'.                                    01650000
016600     DISPLAY '** ABEND     **'.                                   01660000
016700     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                01670000
016800     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.             01680000
016900     DISPLAY '** TABLE     ** = ' PV-ABEND-TABLE.                 01690000
017000     DISPLAY '** MESSAGE   ** = ' PV-DB2-MESSAGE.                 01700000
017100     COPY DPPD004.                                                01710000
017200                                                                  01720000
017300     MOVE +4013                  TO PV-ABEND-CODE.                01730000
017400     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         01740000
017500                                                                  01750000
