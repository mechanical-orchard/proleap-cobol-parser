000100******************************************************************00010020
000200 IDENTIFICATION DIVISION.                                         00020021
000300******************************************************************00030021
000400                                                                  00040021
000500 PROGRAM-ID.    PCKUP003.                                         00050021
000600 AUTHOR.        PATRICK BURKE.                                    00060021
000700 INSTALLATION.  KOHLS.                                            00070021
000800 DATE-WRITTEN   DEC, 2000.                                        00080021
000900 DATE-COMPILED.                                                   00090021
001000                                                                  00100021
001100******************************************************************00110021
001200*  THIS PROGRAM DELETES ALL TSHPSUM ROWS FOR                     *00120021
001300*  ALL RECORDS FOUND ON THE TSHPSUM EXTRACT FILE.  THIS EXTRACT  *00130021
001400*  FILE IS CREATED IN PCKUT014.  THIS FILE CONTAINS THE PURCHASE *00140021
001500*  ORDER/PACKSLIP SEQUENCE NUMBER TO BE DELETED FROM THE TSHSPUM *00150021
001600*  TABLE.                                                        *00160021
001700******************************************************************00170021
001800                                                                  00180021
001900******************************************************************00190021
002000 ENVIRONMENT DIVISION.                                            00200021
002100******************************************************************00210021
002200                                                                  00220021
002300 CONFIGURATION SECTION.                                           00230021
002400                                                                  00240021
002500 SOURCE-COMPUTER.        IBM-3090.                                00250021
002600 OBJECT-COMPUTER.        IBM-3090.                                00260021
002700                                                                  00270021
002800 INPUT-OUTPUT SECTION.                                            00280021
002900                                                                  00290021
003000 FILE-CONTROL.                                                    00300021
003100                                                                  00310021
003200     SELECT ARCHIVE-FILE                                          00320022
003300         ASSIGN TO INP01.                                         00330021
003400                                                                  00340021
003500******************************************************************00350021
003600 DATA DIVISION.                                                   00360021
003700******************************************************************00370021
003800                                                                  00380021
003900 FILE SECTION.                                                    00390021
004000                                                                  00400021
004100 FD  ARCHIVE-FILE                                                 00410022
004200     RECORDING MODE IS F                                          00420021
004300     LABEL RECORDS ARE STANDARD                                   00430021
004400     BLOCK CONTAINS 0 RECORDS.                                    00440021
004500                                                                  00450021
004600 01  ARCHIVE-FILE-RECORD     PIC  X(42).                          00460033
004700*                                                                 00470021
004900******************************************************************00490021
005000 WORKING-STORAGE SECTION.                                         00500021
005100******************************************************************00510021
005200*                                                                 00520021
005300*                                                                 00530021
005400******************************************************************00540021
005500** DB2 FORMATTED MESSAGE AREA                                   **00550021
005600******************************************************************00560021
005700     COPY DPWS004.                                                00570021
005800*                                                                 00580021
006100******************************************************************00610021
006200** COMMUNICATIONS AREA FOR DB2                                  **00620021
006300******************************************************************00630021
006400     EXEC SQL                                                     00640021
006500          INCLUDE SQLCA                                           00650021
006600     END-EXEC.                                                    00660021
006700*                                                                 00670021
006900******************************************************************00690021
007000** COBOL DECLARATION AND DCLGEN MEMBER FOR THE TSHPUM TABLE     **00700022
007200******************************************************************00720021
007210*                                                                 00721022
007300     EXEC SQL                                                     00730021
007400          INCLUDE TSHPSUM                                         00740022
007500     END-EXEC.                                                    00750021
007700*                                                                 00770021
007800******************************************************************00780027
009800*                                                                 00980021
009900 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00990021
010000                                                   COMP SYNC.     01000021
010100                                                                  01010021
010200 01  PS-PROGRAM-SWITCHES.                                         01020021
010300     05  PS-EOF-ARCHIVE-FILE-SW      PIC  X(01)    VALUE 'N'.     01030022
010400         88  PS-EOF-ARCHIVE-FILE                   VALUE 'Y'.     01040022
010500         88  PS-NOT-EOF-ARCHIVE-FILE               VALUE 'N'.     01050022
010600     05  PS-EOF-DISTRB-DTL-CSR-SW    PIC  X(01)    VALUE 'N'.     01060021
010700         88  PS-EOF-DISTRB-DTL-CSR                 VALUE 'Y'.     01070021
010800         88  PS-NOT-EOF-DISTRB-DTL-CSR             VALUE 'N'.     01080021
010900                                                                  01090021
011000                                                                  01100021
011100 01  PC-PROGRAM-CONSTANTS.                                        01110021
011200     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          01120021
011300         'PCKUP003'.                                              01130022
011400     05  PC-MAX-RETRIES              PIC S9(04)    VALUE +3       01140021
011500                                                   COMP SYNC.     01150021
011600                                                                  01160021
011700 01  PV-PROGRAM-VARIABLES.                                        01170021
011800     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  01180021
011900     05  PV-DB2-TABLE-NAME-1         PIC  X(30)    VALUE SPACES.  01190021
012000     05  PV-DB2-TABLE-NAME-2         PIC  X(30)    VALUE SPACES.  01200021
012100     05  PV-DB2-OPERATION-MESSAGE    PIC  X(50)    VALUE SPACES.  01210021
012200     05  PV-RETRY-COUNTER            PIC S9(04)    VALUE ZERO     01220021
012300                                                   COMP SYNC.     01230021
012400     05  PV-TSHPSUM-READ-CNTR        PIC S9(07)    VALUE ZERO     01240022
012500                                                   COMP-3.        01250021
012600     05  PV-TSHPSUM-DELETE-CNTR      PIC S9(07)    VALUE ZERO     01260022
012700                                                   COMP-3.        01270021
012800     05  PV-TSHPSUM-COMMIT-CNTR      PIC S9(07)    VALUE ZERO     01280027
012900                                                   COMP-3.        01290027
013000     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             01300021
013100                                                                  01310021
013200     05  PV-DB2-COUNT                PIC S9(09)    VALUE ZERO     01320021
013300                                                   COMP-3.        01330021
013400     05  PV-OPER-UNT-ID              PIC 9(04)     VALUE ZERO.    01340021
013500     05  PV-RECV-SEQ-NBR             PIC 9(03)     VALUE ZERO.    01350021
013600     05  PV-PO-NBR                   PIC S9(08)    VALUE ZERO.    01360021
013700     05  PV-PO-LNE-NBR               PIC 9(03)     VALUE ZERO.    01370021
013800     05  PV-CURRENT-TIMESTAMP        PIC X(26)     VALUE SPACES.  01380021
013900     05  PV-COMMIT-TIMESTAMP         PIC X(26)     VALUE SPACES.  01390021
014000     05  PV-COMMIT-TIME-AND-RCVR.                                 01400021
014100         10  FILLER                  PIC X(15)     VALUE          01410021
014200         'RECEIVER/LINE: '.                                       01420021
014300         10  PV-COMMIT-ORD-NBR       PIC 9(08)     VALUE ZEROS.   01430021
014400         10  FILLER                  PIC X(01)     VALUE '-'.     01440021
014500         10  PV-COMMIT-SEQ-NBR       PIC 9(04)     VALUE ZEROS.   01450021
014600         10  FILLER                  PIC X(01)     VALUE '-'.     01460021
014700         10  PV-COMMIT-LINE-NBR      PIC 9(04)     VALUE ZEROS.   01470021
014800         10  FILLER                  PIC X(20)     VALUE          01480021
014900         '  LAST COMMIT TIME: '.                                  01490021
015000         10  PV-LAST-COMMIT-TIMESTAMP                             01500021
015100                                     PIC X(26)     VALUE SPACES.  01510021
015200     05  PV-COMMIT-COUNTS.                                        01520021
015300         10  FILLER                  PIC X(22)     VALUE          01530021
015400         'TSHPSUM ROWS DELETED: '.                                01540028
015500         10  PV-TSHPSUM-ROWS-DELETED PIC ZZ,ZZZ,ZZ9.              01550028
015600         10  FILLER                  PIC X(23)     VALUE          01560021
015700         ' TSHPSUM ROWS DELETED: '.                               01570028
015800         10  PV-TSHPSUM-ROWS-DELETED PIC ZZ,ZZZ,ZZ9.              01580028
015900                                                                  01590021
018000                                                                  01800021
018100******************************************************************01810021
018200 PROCEDURE DIVISION.                                              01820021
018300******************************************************************01830021
018400                                                                  01840021
018500******************************************************************01850021
018600* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     01860021
018700*      PROGRAM.                                                   01870021
018800******************************************************************01880021
018900 0000-PROGRAM-MAINLINE.                                           01890021
019000                                                                  01900021
019100     PERFORM 1000-INITIALIZE.                                     01910021
019200                                                                  01920021
019300     SET PS-NOT-EOF-ARCHIVE-FILE TO TRUE.                         01930023
019400     PERFORM 7000-READ-ARCHIVE-FILE.                              01940023
019500                                                                  01950021
019600     PERFORM 2000-PROCESS-TSHPSUM-RECORDS                         01960023
019700        UNTIL PS-EOF-ARCHIVE-FILE.                                01970023
019800                                                                  01980021
019900     CLOSE ARCHIVE-FILE.                                          01990023
020000                                                                  02000021
020100     MOVE PV-TSHPSUM-READ-CNTR TO PV-DISPLAY-COUNT.               02010023
020200     DISPLAY 'TOTAL ROWS READ...: ' PV-DISPLAY-COUNT.             02020023
020300                                                                  02030021
020400     MOVE PV-TSHPSUM-DELETE-CNTR TO PV-DISPLAY-COUNT.             02040023
020500     DISPLAY 'TOTAL ROWS DELETED: ' PV-DISPLAY-COUNT.             02050023
020600                                                                  02060021
021000     STOP RUN.                                                    02100021
021100*                                                                 02110021
021200*0000-EXIT.                                                       02120021
021300*                                                                 02130021
021500******************************************************************02150021
021600*  DO FIRST TIME PROGRAM INITIALIZATION TASKS.                    02160021
021700******************************************************************02170021
021800 1000-INITIALIZE.                                                 02180021
021900*                                                                 02190021
022000     INITIALIZE PV-TSHPSUM-READ-CNTR                              02200023
022200                PV-TSHPSUM-DELETE-CNTR.                           02220023
022300*                                                                 02230021
022400     OPEN INPUT ARCHIVE-FILE.                                     02240023
022500*                                                                 02250021
022800*1000-EXIT.                                                       02280021
022900*                                                                 02290021
023000*                                                                 02300021
026200******************************************************************02620021
026300*  PROCESS THE DISTRIBUTION HEADER ROWS THAT ARE IN THE TDISTHD   02630021
026400*  EXTRACT FILE.  DELETE THE ROW FROM THE TDISTHD TABLE.  OPEN    02640021
026500*  OPEN ANOTHER CURSOR AND DELETE ALL OF THE DISTRIBUTION DETAIL  02650021
026600*  ROWS FOR THE SPECIFIED LINE.                                   02660021
026700******************************************************************02670021
026800 2000-PROCESS-TSHPSUM-RECORDS.                                    02680023
026900*                                                                 02690021
027000     ADD +1 TO PV-TSHPSUM-READ-CNTR.                              02700024
027100*                                                                 02710021
027200     PERFORM 2100-DELETE-TSHPSUM-ROW.                             02720025
027300*                                                                 02730021
027301     PERFORM 2200-COMMIT-CHANGES.                                 02730132
027302*                                                                 02730232
027310     PERFORM 7000-READ-ARCHIVE-FILE.                              02731029
030300*                                                                 03030021
030400*2000-EXIT.                                                       03040021
030600*                                                                 03060021
030700******************************************************************03070021
030800*  DELETE THE CURRENT ROW FROM THE TSHPSUM TABLE.                 03080026
031200******************************************************************03120021
031300 2100-DELETE-TSHPSUM-ROW.                                         03130026
031400                                                                  03140021
032300         EXEC SQL                                                 03230021
032400              DELETE FROM TSHPSUM                                 03240026
032500                  WHERE PO_NBR        = :SHPSUM-PO-NBR            03250026
032600                    AND PKSL_SEQ_NBR  = :SHPSUM-PKSL-SEQ-NBR      03260030
032700                    AND CART_COMB_NBR = :SHPSUM-CART-COMB-NBR     03270026
032710                    AND PO_LNE_NBR   =  :SHPSUM-PO-LNE-NBR        03271030
032720                    AND TOT_CART_CNT  = :SHPSUM-TOT-CART-CNT      03272026
032730                    AND OTPK_UNT_QTY  = :SHPSUM-OTPK-UNT-QTY      03273026
032740                    AND CRE_TMST      = :SHPSUM-CRE-TMST          03274026
032800         END-EXEC                                                 03280021
032900                                                                  03290021
033000         EVALUATE TRUE                                            03300021
033100             WHEN SQLCODE = ZERO                                  03310021
033200                 ADD +1          TO PV-TSHPSUM-DELETE-CNTR        03320026
033300             WHEN SQLCODE = +100                                  03330021
033400             WHEN SQLCODE = -904                                  03340021
033500             WHEN SQLCODE = -911                                  03350021
033600                 CONTINUE                                         03360021
033700             WHEN SQLWARN0 NOT = SPACES                           03370021
033800             WHEN SQLCODE < ZERO                                  03380021
033900             WHEN SQLCODE > ZERO                                  03390021
034000                 MOVE '2100-DELETE-TVISTHD-ROW        '           03400026
034100                                 TO PV-PARAGRAPH-NAME             03410021
034200                 MOVE 'ERROR DELETING ROW FROM TSHPSUM TABLE'     03420026
034300                                 TO PV-DB2-OPERATION-MESSAGE      03430021
034400                 MOVE 'TSHPSUM'  TO PV-DB2-TABLE-NAME-1           03440026
034500                 PERFORM 9100-SQL-ABEND                           03450021
034600         END-EVALUATE.                                            03460029
034800                                                                  03480021
035700*2100-EXIT.                                                       03570021
035800*                                                                 03580021
036000******************************************************************03600021
036100*  COMMIT THE CHANGES TO THE TSHPSUM TABLE.                       03610026
036200******************************************************************03620021
036300 2200-COMMIT-CHANGES.                                             03630021
036400                                                                  03640021
036500     EXEC SQL                                                     03650021
036600          COMMIT                                                  03660021
036700     END-EXEC                                                     03670031
036800                                                                  03680021
036900     EVALUATE TRUE                                                03690021
037000         WHEN SQLCODE = ZERO                                      03700021
037010             ADD +1          TO PV-TSHPSUM-COMMIT-CNTR            03701026
038200         WHEN SQLWARN0 NOT = SPACES                               03820021
038300         WHEN SQLCODE < ZERO                                      03830021
038400         WHEN SQLCODE > ZERO                                      03840021
038500             MOVE '2200-COMMIT-CHANGES'                           03850021
038600                                 TO PV-PARAGRAPH-NAME             03860021
038700             MOVE 'ERROR ON COMMIT OF THE CHANGES'                03870021
038800                                 TO PV-DB2-OPERATION-MESSAGE      03880021
038900             MOVE 'TSHPSUM'      TO PV-DB2-TABLE-NAME-1           03890026
039000             MOVE 'TSHPSUM'      TO PV-DB2-TABLE-NAME-2           03900026
039100             PERFORM 9100-SQL-ABEND                               03910021
039200     END-EVALUATE.                                                03920021
039300*                                                                 03930021
039400*2200-EXIT.                                                       03940021
039500*                                                                 03950021
045600******************************************************************04560021
045700*  READ A RECORD FROM THE ARCHIVE FILE                            04570029
045800******************************************************************04580021
045900 7000-READ-ARCHIVE-FILE.                                          04590029
046000                                                                  04600021
046100     READ ARCHIVE-FILE                                            04610026
046200       INTO DCLTSHPSUM                                            04620026
046300           AT END                                                 04630021
046400               SET PS-EOF-ARCHIVE-FILE TO TRUE.                   04640026
046500*                                                                 04650021
046600*7000-EXIT.                                                       04660021
046700*                                                                 04670021
046800******************************************************************04680033
059300 9100-SQL-ABEND.                                                  05930021
059400******************************************************************05940021
059500*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    05950021
059600*  ERROR OR WARNING CODE OCCURS.                                  05960021
059700******************************************************************05970021
059800     DISPLAY '9100-SQL-ABEND'.                                    05980021
059900     DISPLAY '** ABEND             **'.                           05990021
060000     DISPLAY '** PROGRAM           ** = '                         06000021
060100                                       PC-CURRENT-PROGRAM-NAME.   06010021
060200     DISPLAY '** PARAGRAPH         ** = '                         06020021
060300                                       PV-PARAGRAPH-NAME.         06030021
060400     DISPLAY '** TABLE(S) AFFECTED ** = '                         06040021
060500                                       PV-DB2-TABLE-NAME-1.       06050021
060600     DISPLAY '**                   ** = '                         06060021
060700                                       PV-DB2-TABLE-NAME-2.       06070021
060800     DISPLAY '** OPERATION         ** = '                         06080021
060900                                       PV-DB2-OPERATION-MESSAGE.  06090021
061000     DISPLAY '**                   ** = '                         06100021
061100     DISPLAY '** LAST COMMIT INFO  ** = '                         06110021
061200                                       PV-COMMIT-TIME-AND-RCVR.   06120021
061300     DISPLAY '**                   ** = '                         06130021
061400                                       PV-COMMIT-COUNTS.          06140021
061500                                                                  06150021
061600******************************************************************06160021
061700* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    06170021
061800* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         06180021
061900* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     06190021
062000* FORMAT.                                                         06200021
062100******************************************************************06210021
062200     COPY DPPD004.                                                06220021
062300                                                                  06230021
062400     EXEC SQL                                                     06240021
062500         ROLLBACK                                                 06250021
062600     END-EXEC.                                                    06260021
062700                                                                  06270021
062800     MOVE +4013                  TO ABEND-CODE.                   06280021
062900     CALL 'ILBOABN0' USING ABEND-CODE.                            06290021
063000*9100-EXIT.                                                       06300021
