000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400                                                                  00040000
000500 PROGRAM-ID.             SUKUT203.                                00050000
000600 AUTHOR.                 DENISE HAHN.                             00060000
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070000
000800 DATE-WRITTEN            MARCH, 2020.                             00080000
000900 DATE-COMPILED.                                                   00090000
001000***************************************************************** 00100000
001100*                                                               * 00110000
001200*  THIS PROGRAM WILL CREATE AN EXTRACT FILE CONTAINING ROWS     * 00120000
001300*  FROM SUT_OTBND_PKD_UPC BASE ON PARM TO PURGE X # WEEKS OLD.  * 00130000
001400*  SELECTED ROWS WILL BE WRITTEN  TO AN EXTRACT FILE.           * 00140001
001410*  EXTRACT FILE WILL BE USED TO PURGE FROM SUT_OTBND_PKD_UPC    * 00141000
001440***************************************************************** 00144000
001450***************************************************************** 00145000
001460 ENVIRONMENT DIVISION.                                            00146000
001470***************************************************************** 00147000
001480                                                                  00148000
001490 CONFIGURATION SECTION.                                           00149000
001500                                                                  00150000
001600 SOURCE-COMPUTER.        IBM-3090.                                00160000
001700 OBJECT-COMPUTER.        IBM-3090.                                00170000
001800                                                                  00180000
001900 INPUT-OUTPUT SECTION.                                            00190000
002000                                                                  00200000
002100 FILE-CONTROL.                                                    00210000
002200*                                                                 00220000
002300     SELECT SU-OTBND-PKD-UPC-FILE                                 00230000
002400         ASSIGN TO OUT01.                                         00240000
002500*                                                                 00250000
002600***************************************************************** 00260000
002700 DATA DIVISION.                                                   00270000
002800***************************************************************** 00280000
002900*                                                                 00290000
003000 FILE SECTION.                                                    00300000
003100*                                                                 00310000
003200 FD  SU-OTBND-PKD-UPC-FILE                                        00320000
003300     RECORDING MODE IS F                                          00330000
003400     BLOCK CONTAINS 0  RECORDS.                                   00340000
003500 01  SU-OTBND-PKD-UPC-RECORD         PIC  X(100).                 00350000
003600*                                                                 00360000
003700                                                                  00370000
003800 WORKING-STORAGE SECTION.                                         00380000
003900*                                                                 00390000
004000 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00400000
004100                                                   COMP SYNC.     00410000
004200*                                                                 00420000
004300 01  PROGRAM-SWITCHES.                                            00430000
004400     05  PS-EOF-CURSOR-SW            PIC  X(01)    VALUE 'N'.     00440000
004500         88  PS-EOF-CSR                            VALUE 'Y'.     00450000
004600         88  PS-NOT-EOF-CSR                        VALUE 'N'.     00460000
005000                                                                  00500000
005100 01  PC-PROGRAM-CONSTANTS.                                        00510000
005200     05  PC-CURRENT-PROGRAM-NAME    PIC  X(08)     VALUE          00520000
005300                                                   'SUKUT203'.    00530000
005400                                                                  00540000
005500 01  PV-PROGRAM-VARIABLES.                                        00550000
005600     05  PV-DISPLAY-PURGE-WEEKS      PIC  Z(09).                  00560000
005900                                                                  00590000
006000     05  PV-ABEND-PARAGRAPH          PIC  X(30)    VALUE SPACES.  00600000
006100     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  00610000
006200     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  00620000
006300                                                                  00630000
006400     05  PV-SML-FETCH-CNT            PIC  9(09)    VALUE ZERO.    00640000
006800     05  PV-TOTAL-CNT                PIC  9(09)    VALUE ZERO.    00680000
007100                                                                  00710000
007200 01  DK-DB-KEYS.                                                  00720000
007300     05  DK-PURGE-WEEKS              PIC S9(09)  COMP.            00730000
007310     05  DK-PURGE-DATE               PIC  X(10).                  00731001
007400                                                                  00740000
007600     COPY SURD169.                                                00760001
007700                                                                  00770000
007800/                                                                 00780000
007900******************************************************************00790000
008000*  DB2 FORMATTED MESSAGE AREA                                     00800000
008100******************************************************************00810000
008200     COPY DPWS004.                                                00820000
008300                                                                  00830000
008400******************************************************************00840000
008500*  COPY BOOK FOR THE PARAMETER TABLE                              00850000
008600******************************************************************00860000
008700     EXEC SQL                                                     00870000
008800          INCLUDE TKRPRPM                                         00880000
008900     END-EXEC.                                                    00890000
009000                                                                  00900000
009100******************************************************************00910000
009200*  COPY BOOK FOR THE OUTBOUND CARTON PACKED UPC TABLE             00920001
009210*  SUT_OTBND_PKD_UPC                                              00921001
009300******************************************************************00930000
009400     EXEC SQL                                                     00940000
009500          INCLUDE SUT00025                                        00950001
009600     END-EXEC.                                                    00960000
009700                                                                  00970000
012600******************************************************************01260000
012700*  DB2 COMMUNICATION AREA                                         01270000
012800******************************************************************01280000
012900     EXEC SQL                                                     01290000
013000         INCLUDE SQLCA                                            01300000
013100     END-EXEC.                                                    01310000
013200                                                                  01320000
013300******************************************************************01330000
013400*  DB2 COMMUNICATION AREA2                                        01340000
013500******************************************************************01350000
013600     COPY SQLCA2.                                                 01360000
013700                                                                  01370000
013800                                                                  01380000
013900     EXEC SQL                                                     01390000
014000       DECLARE PKD-UPC-CSR CURSOR FOR                             01400001
014210         SELECT SHIPT_UNT_ID                                      01421001
014220               ,TRN_NBR                                           01422001
014230               ,RCVR_SEQ_NBR                                      01423001
014240               ,TRN_LNE_NBR                                       01424001
014250               ,TRN_TYP_CDE                                       01425001
014260               ,UPC_NBR                                           01426001
014270               ,PKD_BY_USR_ID                                     01427001
014280               ,PKD_TMST                                          01428001
014300          FROM  SUT_OTBND_PKD_UPC                                 01430001
014400          WHERE DATE(PKD_TMST) <= :DK-PURGE-DATE                  01440001
014600     END-EXEC.                                                    01460000
014800                                                                  01480000
015800                                                                  01580000
015900*                                                                 01590000
016000 PROCEDURE DIVISION.                                              01600000
016100*                                                                 01610000
016200 0000-MAINLINE-PROCESSING.                                        01620000
016300******************************************************************01630000
016400**  THIS IS THE MAIN DRIVER FOR THE PROGRAM.                      01640000
016500******************************************************************01650000
016600                                                                  01660000
016700     PERFORM 1000-INITIALIZATION.                                 01670000
016800                                                                  01680000
016900     PERFORM 2000-PROCESS-SML                                     01690000
017000       UNTIL PS-EOF-CSR.                                          01700000
017100                                                                  01710000
017200     PERFORM 2300-CLOSE-PKD-UPC-CSR.                              01720001
017300                                                                  01730000
017700                                                                  01770000
017710     DISPLAY '                                 '.                 01771001
017800     DISPLAY 'SML FETCHED=' PV-SML-FETCH-CNT   '  **'.            01780000
018000     DISPLAY '                                 '.                 01800000
018300     DISPLAY 'TOTAL OUT  =' PV-TOTAL-CNT       '  **'             01830000
018400     DISPLAY '                                 '.                 01840000
018700                                                                  01870000
018800     CLOSE SU-OTBND-PKD-UPC-FILE.                                 01880000
018900                                                                  01890000
019000     GOBACK.                                                      01900000
019100                                                                  01910000
019200                                                                  01920000
019300 1000-INITIALIZATION.                                             01930000
019400******************************************************************01940000
019500**  PERFORM THE INITIAL PROCESSING FOR THE PROGRAM.               01950000
019600******************************************************************01960000
019700                                                                  01970000
019800     OPEN OUTPUT SU-OTBND-PKD-UPC-FILE.                           01980000
019900                                                                  01990000
020000     PERFORM 7000-GET-PURGE-WEEKS.                                02000000
020100                                                                  02010000
020200     DISPLAY '** SUKUT203 **'.                                    02020000
020300     DISPLAY '** PURGE ' PV-DISPLAY-PURGE-WEEKS ' WEEKS **'.      02030000
020400     DISPLAY '** DATE  ' DK-PURGE-DATE.                           02040001
020500                                                                  02050000
020600     SET  PS-NOT-EOF-CSR      TO  TRUE.                           02060002
020800                                                                  02080000
020900     PERFORM 2100-OPEN-PKD-UPC-CSR.                               02090001
021000     PERFORM 2200-FETCH-PKD-UPC-CSR.                              02100001
021100                                                                  02110000
021200                                                                  02120000
021300*                                                                 02130000
021400 2000-PROCESS-SML.                                                02140000
021500                                                                  02150000
021700     INITIALIZE  SU169-EXTRACT-RECORD.                            02170001
021800                                                                  02180000
021810     MOVE SUT00025-SHIPT-UNT-ID  TO  SU169-SHIPT-UNT-ID.          02181001
021820     MOVE SUT00025-TRN-NBR       TO  SU169-TRN-NBR.               02182001
021830     MOVE SUT00025-RCVR-SEQ-NBR  TO  SU169-RCVR-SEQ-NBR.          02183001
021840     MOVE SUT00025-TRN-LNE-NBR   TO  SU169-TRN-LNE-NBR.           02184001
021850     MOVE SUT00025-TRN-TYP-CDE   TO  SU169-TRN-TYP-CDE.           02185001
021860     MOVE SUT00025-UPC-NBR       TO  SU169-UPC-NBR.               02186001
021870     MOVE SUT00025-PKD-BY-USR-ID TO  SU169-PKD-BY-USR-ID.         02187001
021880     MOVE SUT00025-PKD-TMST      TO  SU169-PKD-TMST.              02188001
022300                                                                  02230000
023100     PERFORM 8000-WRITE-EXTRACT-RECORD.                           02310001
023800                                                                  02380000
023900     PERFORM 2200-FETCH-PKD-UPC-CSR.                              02390001
024000                                                                  02400000
024100                                                                  02410000
024200 2100-OPEN-PKD-UPC-CSR.                                           02420001
024300     MOVE '2100-OPEN-PKD-UPC-CSR' TO PV-ABEND-PARAGRAPH.          02430001
024400                                                                  02440000
024500     EXEC SQL                                                     02450000
024600          OPEN PKD-UPC-CSR                                        02460001
024700     END-EXEC.                                                    02470000
024800                                                                  02480000
024900     EVALUATE TRUE                                                02490000
025000         WHEN SQLCODE = 0                                         02500000
025100             CONTINUE                                             02510000
025200         WHEN SQLWARN0 NOT = SPACES                               02520000
025300         WHEN SQLCODE < ZERO                                      02530000
025400         WHEN SQLCODE > ZERO                                      02540000
025500             MOVE '2100-OPEN-PKD-UPC-CSR'                         02550001
025600                             TO PV-PARAGRAPH-NAME                 02560000
025700             MOVE 'OPEN THE SML_CURSOR            '               02570000
025800                             TO PV-DB2-OPERATION-ATTEMPTED        02580000
025900             PERFORM 9100-SQL-ABEND                               02590000
026000     END-EVALUATE.                                                02600000
026100                                                                  02610000
026200                                                                  02620000
026300 2200-FETCH-PKD-UPC-CSR.                                          02630001
026400     MOVE '2200-FETCH-PKD-UPC-CSR' TO PV-ABEND-PARAGRAPH.         02640001
026500                                                                  02650000
026600     EXEC SQL                                                     02660000
026700          FETCH PKD-UPC-CSR                                       02670001
026800          INTO  :SUT00025-SHIPT-UNT-ID                            02680001
026900              , :SUT00025-TRN-NBR                                 02690001
026910              , :SUT00025-RCVR-SEQ-NBR                            02691001
026920              , :SUT00025-TRN-LNE-NBR                             02692001
026930              , :SUT00025-TRN-TYP-CDE                             02693001
026940              , :SUT00025-UPC-NBR                                 02694001
026950              , :SUT00025-PKD-BY-USR-ID                           02695001
026960              , :SUT00025-PKD-TMST                                02696001
027000     END-EXEC.                                                    02700000
027100                                                                  02710000
027200     EVALUATE TRUE                                                02720000
027300       WHEN SQLCODE = ZEROS                                       02730000
027400            ADD  1  TO  PV-SML-FETCH-CNT                          02740000
027500       WHEN SQLCODE = +100                                        02750000
027600            SET PS-EOF-CSR      TO TRUE                           02760000
027700       WHEN SQLWARN0 NOT = SPACES                                 02770000
027800       WHEN SQLCODE < ZERO                                        02780000
027900       WHEN SQLCODE > ZERO                                        02790000
028000           MOVE '2200-FETCH-PKD-UPC-CSR'                          02800001
028100                               TO PV-PARAGRAPH-NAME               02810000
028200           MOVE 'FETCH SML CURSOR '                               02820000
028300                               TO PV-DB2-OPERATION-ATTEMPTED      02830000
028400           PERFORM 9100-SQL-ABEND                                 02840000
028500     END-EVALUATE.                                                02850000
028600                                                                  02860000
028700                                                                  02870000
028800 2300-CLOSE-PKD-UPC-CSR.                                          02880001
028900     MOVE '2300-CLOSE-PKD-UPC-CSR' TO PV-ABEND-PARAGRAPH.         02890001
029000                                                                  02900000
029100     EXEC SQL                                                     02910000
029200         CLOSE PKD-UPC-CSR                                        02920001
029300     END-EXEC.                                                    02930000
029400                                                                  02940000
029500     EVALUATE TRUE                                                02950000
029600         WHEN SQLCODE = ZERO                                      02960000
029700         WHEN SQLCODE = -904                                      02970000
029800         WHEN SQLCODE = -911                                      02980000
029900              CONTINUE                                            02990000
030000         WHEN SQLWARN0 NOT = SPACES                               03000000
030100         WHEN SQLCODE < ZERO                                      03010000
030200         WHEN SQLCODE > ZERO                                      03020000
030300              MOVE '2300-CLOSE-PKD-UPC-CSR'                       03030001
030400                              TO PV-PARAGRAPH-NAME                03040000
030500              MOVE 'CLOSE THE PKD-UPC-CSR              '          03050001
030600                              TO PV-DB2-OPERATION-ATTEMPTED       03060000
030700              PERFORM 9100-SQL-ABEND                              03070000
030800     END-EVALUATE.                                                03080000
030900                                                                  03090000
031000                                                                  03100000
046865 7000-GET-PURGE-WEEKS.                                            04686500
046866                                                                  04686600
046867     EXEC SQL                                                     04686700
046868         SELECT  FUNC_QTY                                         04686800
046869                ,(CURRENT_DATE -(FUNC_QTY * 7) DAYS)              04686901
046872           INTO :DK-PURGE-WEEKS                                   04687200
046873              , :DK-PURGE-DATE                                    04687301
046874           FROM TKRPRPM                                           04687400
046875          WHERE LOC_ID            =  90                           04687500
046876            AND INTFC_SYS_CDE     = 'KHL'                         04687600
046877            AND SYS_PRC_FUNC_CDE  = 'OBPKPG'                      04687703
046878            AND FUNC_PRC_STAT_CDE = 'AC'                          04687800
046879     END-EXEC.                                                    04687900
046880                                                                  04688000
046881     EVALUATE TRUE                                                04688100
046882         WHEN SQLCODE = ZEROS                                     04688200
046883              MOVE  DK-PURGE-WEEKS  TO  PV-DISPLAY-PURGE-WEEKS    04688300
046885         WHEN SQLCODE = +100                                      04688500
046886              CONTINUE                                            04688600
046887         WHEN SQLWARN0 NOT = SPACES                               04688700
046888         WHEN SQLCODE < ZERO                                      04688800
046889         WHEN SQLCODE > ZERO                                      04688900
046890             MOVE '7000-GET-PURGE-WEEKS'                          04689000
046891                             TO PV-PARAGRAPH-NAME                 04689100
046892             MOVE 'GET NUMBER OF WEEKS TO PURGE   '               04689200
046893                             TO PV-DB2-OPERATION-ATTEMPTED        04689300
046894             PERFORM 9100-SQL-ABEND                               04689400
046895     END-EVALUATE.                                                04689500
046896                                                                  04689600
046897                                                                  04689700
047030 8000-WRITE-EXTRACT-RECORD.                                       04703000
047040     WRITE SU-OTBND-PKD-UPC-RECORD                                04704000
047050       FROM SU169-EXTRACT-RECORD.                                 04705001
047060                                                                  04706000
047061     ADD  1  TO  PV-TOTAL-CNT.                                    04706101
047062                                                                  04706201
047070                                                                  04707000
047080 9100-SQL-ABEND.                                                  04708000
047090******************************************************************04709000
047100*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    04710000
047200*  ERROR OR WARNING CODE OCCURS.                                  04720000
047300******************************************************************04730000
047400     DISPLAY '9100-SQL-ABEND'.                                    04740000
047500     DISPLAY '** ABEND     **'.                                   04750000
047600     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        04760000
047700     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              04770000
047800     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     04780000
047900                                                                  04790000
048000******************************************************************04800000
048100* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    04810000
048200* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         04820000
048300* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     04830000
048400* FORMAT.                                                         04840000
048500******************************************************************04850000
048600     COPY DPPD004.                                                04860000
048700                                                                  04870000
048800     MOVE +4013                  TO ABEND-CODE.                   04880000
048900     CALL 'ILBOABN0' USING ABEND-CODE.                            04890000
049000                                                                  04900000
