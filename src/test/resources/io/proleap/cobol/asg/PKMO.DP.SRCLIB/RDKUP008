000100******************************************************************00010084
000200 IDENTIFICATION DIVISION.                                         00020084
000300******************************************************************00030084
000400 PROGRAM-ID.         RDKUP008.                                    00040084
000500 AUTHOR.             JIM LEIKNESS.                                00050084
000600 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00060084
000700 DATE-WRITTEN.       JULY 2003.                                   00070084
000800 DATE-COMPILED.                                                   00080084
000900                                                                  00090084
001000******************************************************************00100084
001100* THIS PROGRAM UPDATES (OR INSERTS) THE RDT_MAL_CK_RFND TABLE.   *00110084
001200* FOLLOWING THE ISSUANCE OF CORP REFUND CHECKS                   *00120084
001300* INPUT FILES:   UPDATE REFUND FILE        DDNAME = INP01        *00130084
001400*                                                                *00140084
001500* OUTPUT FILES:  N/A                                             *00150084
001600*                                                                *00160084
260107*========================== CHANGE LOG ===========================00161086
260107*  AUTH             BY          DATE     DESCRIPTION              00162086
260107*=================================================================00163086
260107* CHG0260107   JIM HUNTER   08-16-21   ADD COPYBOOK DPWS991 TO    00166086
260107*                                      MAKE DPKUT901 CALL DYNAMIC.00167086
001700******************************************************************00170084
001800 ENVIRONMENT DIVISION.                                            00180084
001900******************************************************************00190084
002000                                                                  00200084
002100 CONFIGURATION SECTION.                                           00210084
002200                                                                  00220084
002300 SOURCE-COMPUTER.    IBM-3090.                                    00230084
002400 OBJECT-COMPUTER.    IBM-3090.                                    00240084
002500                                                                  00250084
002600 INPUT-OUTPUT SECTION.                                            00260084
002700                                                                  00270084
002800 FILE-CONTROL.                                                    00280084
002900                                                                  00290084
003000******************************************************************00300084
003100 DATA DIVISION.                                                   00310084
003200******************************************************************00320084
003300                                                                  00330084
003400 WORKING-STORAGE SECTION.                                         00340084
003500                                                                  00350084
003600 01  ABEND-CODE                  PIC S9(04)     VALUE +0  COMP.   00360084
003700                                                                  00370084
003800******************************************************************00380084
003900*PC - PROGRAM CONSTANTS                                           00390084
004000******************************************************************00400084
004100 01  PROGRAM-CONSTANTS.                                           00410084
004200     05  PC-MAX-RETRIES          PIC S9(04)     VALUE +3          00420084
004300                                                COMP SYNC.        00430084
004400     05  PC-MAX-DEADLOCKS        PIC S9(04)     VALUE +3          00440084
004500                                                COMP SYNC.        00450084
004600     05  PC-CKPT-JOB-NAME        PIC  X(08)     VALUE 'RDK920  '. 00460084
004700     05  PC-CKPT-PLAN-NAME       PIC  X(08)     VALUE 'RDKUP008'. 00470084
004800     05  PC-CURRENT-PROGRAM-NAME PIC  X(08)     VALUE 'RDKUP008'. 00480084
004900                                                                  00490084
005000     05  PC-TRAN-PRES-FUNC-CODES.                                 00500084
005100         10  PC-TRAN-PRES-FUNC-OPEN   PIC  X(05)  VALUE 'OPEN '.  00510084
005200         10  PC-TRAN-PRES-FUNC-TRANS  PIC  X(05)  VALUE 'TRANS'.  00520084
005300         10  PC-TRAN-PRES-FUNC-RSTRT  PIC  X(05)  VALUE 'RSTRT'.  00530084
005400         10  PC-TRAN-PRES-FUNC-CLOSE  PIC  X(05)  VALUE 'CLOSE'.  00540084
005500                                                                  00550084
005600     05  PC-MINUS-ONE            PIC S9(01)     VALUE -1.         00560084
005700                                                                  00570084
005800******************************************************************00580084
005900*PV - PROGRAM VARIABLES                                           00590084
006000******************************************************************00600084
006100 01  PROGRAM-VARIABLES.                                           00610084
006200     05  PV-SQL-SUB                   PIC  9(03)   VALUE ZERO.    00620084
006300     05  PV-DEADLOCK-COUNTER          PIC  9(03)   VALUE ZERO.    00630084
006400     05  PV-PARAGRAPH-NAME            PIC  X(30)   VALUE SPACE.   00640084
006500     05  PV-DB2-OPER-ATTEMPTED        PIC  X(30)   VALUE SPACE.   00650084
006600     05  PV-CURRENT-TIMESTAMP         PIC  X(26)   VALUE SPACES.  00660084
006700     05  PV-DISPLAY-COUNT             PIC ZZ,ZZZ,ZZZ,ZZ9.         00670084
006800                                                                  00680084
006900******************************************************************00690084
007000*PS - PROGRAM SWITCHES                                            00700084
007100******************************************************************00710084
007200 01  PROGRAM-SWITCHES.                                            00720084
007300     05  PS-RESTART-REQUIRED-SW  PIC X(01)      VALUE 'N'.        00730084
007400         88  PS-RESTART-REQUIRED                VALUE 'Y'.        00740084
007500         88  PS-RESTART-NOT-REQUIRED            VALUE 'N'.        00750084
007600                                                                  00760084
007700******************************************************************00770084
007800*      UPDATE REFUND RECORD LAYOUT                               *00780084
007900******************************************************************00790084
008000     COPY RDRD039.                                                00800084
008100                                                                  00810084
008200******************************************************************00820084
008300**   DCLGEN FOR TABLE RDT_MAL_CK_RFND                             00830084
008400******************************************************************00840084
008500     EXEC SQL                                                     00850084
008600         INCLUDE RDT00001                                         00860084
008700     END-EXEC.                                                    00870084
008800                                                                  00880084
008900******************************************************************00890084
009000*  SQL COMMUNICATIONS WORK AREA                                  *00900084
009100******************************************************************00910084
009200     COPY SQLCA2.                                                 00920084
009300                                                                  00930084
009400******************************************************************00940084
009500*  DB2 FORMATTED ERROR MESSAGE                                   *00950084
009600******************************************************************00960084
009700     COPY DPWS004.                                                00970084
009800                                                                  00980084
009900******************************************************************00990084
010000*  TRANSACTION PREPARATION MODULE COMMUNICATIONS AREA            *01000084
010100******************************************************************01010084
260107     COPY DPWS991.                                                01011086
015900                                                                  01012086
010200     COPY DPLS001.                                                01020084
010300     05  WORK-STORAGE-PASSED.                                     01030084
010400******************************************************************01040084
010500*PA - PROGRAM ACCUMULATORS                                        01050084
010600******************************************************************01060084
010700         10  PROGRAM-ACCUMULATORS.                                01070084
010800             15  PA-REFUND-ROWS-UPDATED    PIC S9(11)  VALUE ZERO 01080084
010900                                                       COMP-3.    01090084
011000                                                                  01100084
011100 01  FILLER                          PIC X(4096)  VALUE SPACE.    01110084
011200******************************************************************01120084
011300*  COMMUNICATIONS AREA FOR DB2                                   *01130084
011400******************************************************************01140084
011500     EXEC SQL                                                     01150084
011600         INCLUDE SQLCA                                            01160084
011700     END-EXEC.                                                    01170084
011800                                                                  01180084
011900******************************************************************01190084
012000 PROCEDURE DIVISION.                                              01200084
012100******************************************************************01210084
012200 0000-MAINLINE.                                                   01220084
012300                                                                  01230084
012400     PERFORM 1000-INITIALIZE.                                     01240084
012500                                                                  01250084
012600     PERFORM 2000-PROCESS-UPDATE-RECORDS                          01260084
012700         UNTIL DP001-PREP-TRANS-EOF.                              01270084
012800                                                                  01280084
012900     PERFORM 3000-EOJ-ROUTINE.                                    01290084
013000                                                                  01300084
013100     GOBACK.                                                      01310084
013200                                                                  01320084
013300******************************************************************01330084
013400*     1000-INITIALIZE                                            *01340084
013500* ==> PROCESSES:                                                 *01350084
013600* ==> PERFORMED FROM: 0000-MAINLINE                              *01360084
013700******************************************************************01370084
013800 1000-INITIALIZE.                                                 01380084
013900                                                                  01390084
014000     MOVE PC-TRAN-PRES-FUNC-OPEN TO DP001-FUNC-CODE.              01400084
014100     PERFORM 4000-BUILD-COMM-AREA-TRAN-PRES.                      01410084
014200                                                                  01420084
014300******************************************************************01430084
014400*     2000-PROCESS-UPDATE-RECORDS                                *01440084
014500* ==> PROCESSES:                                                 *01450084
014600* ==> PERFORMED FROM: 0000-MAINLINE                              *01460084
014700******************************************************************01470084
014800 2000-PROCESS-UPDATE-RECORDS.                                     01480084
014900                                                                  01490084
015000     SET PS-RESTART-NOT-REQUIRED TO TRUE.                         01500084
015100                                                                  01510084
015200     PERFORM  5000-UPDATE-REFUND.                                 01520084
015300*----------------------------------------------------------------*01530084
015400*  IF A RESTART IS REQUIRED, ISSUE A RESTART CALL RATHER THAN A  *01540084
015500*  TRANS CALL.  THIS WILL ALLOW PROCESSING TO RESUME WITH THE    *01550084
015600*  FIRST TRANSACTION AFTER THE LAST COMMIT.                      *01560084
015700*----------------------------------------------------------------*01570084
015800     IF PS-RESTART-REQUIRED                                       01580084
015900         MOVE PC-TRAN-PRES-FUNC-RSTRT TO DP001-FUNC-CODE          01590084
016000     ELSE                                                         01600084
016100         MOVE PC-TRAN-PRES-FUNC-TRANS TO DP001-FUNC-CODE          01610084
016200     END-IF.                                                      01620084
016300                                                                  01630084
016400     PERFORM 4000-BUILD-COMM-AREA-TRAN-PRES.                      01640084
016500                                                                  01650084
016600******************************************************************01660084
016700*     3000-EOJ-ROUTINE                                           *01670084
016800* ==> PROCESSES:                                                 *01680084
016900* ==> PERFORMED FROM: 0000-MAINLINE                              *01690084
017000******************************************************************01700084
017100 3000-EOJ-ROUTINE.                                                01710084
017200                                                                  01720084
017300     MOVE PA-REFUND-ROWS-UPDATED    TO PV-DISPLAY-COUNT.          01730084
017400     DISPLAY 'REFUND ROWS UPDATED ' PV-DISPLAY-COUNT.             01740084
017500                                                                  01750084
017600     MOVE PC-TRAN-PRES-FUNC-CLOSE TO DP001-FUNC-CODE.             01760084
017700     PERFORM 4000-BUILD-COMM-AREA-TRAN-PRES.                      01770084
017800                                                                  01780084
017900******************************************************************01790084
018000*     4000-BUILD-COMM-AREA-TRAN-PRES                             *01800084
018100* ==> PROCESSES:                                                 *01810084
018200*     - BUILD THE COMMUNICATION AREA FOR A CALL TO THE           *01820084
018300*       TRANSACTION PRESENTATION MODULE.                         *01830084
018400* ==> PERFORMED FROM:                                            *01840084
018500******************************************************************01850084
018600 4000-BUILD-COMM-AREA-TRAN-PRES.                                  01860084
018700                                                                  01870084
018800     MOVE LENGTH OF WORK-STORAGE-PASSED                           01880084
018900                                       TO DP001-WORK-STRG-LENGTH. 01890084
019000     MOVE PC-CKPT-JOB-NAME             TO DP001-JOB-NAME.         01900084
019100     MOVE PC-CKPT-PLAN-NAME            TO DP001-PLAN-NAME.        01910084
019200     PERFORM Z900-CALL-TRANS-PRES-MODULE.                         01920084
019300     MOVE DP001-TRANS-RECORD           TO RD039-RECORD.           01930084
019400     IF DP001-CKPT-TAKEN                                          01940084
019500         INITIALIZE PV-DEADLOCK-COUNTER                           01950084
019600     END-IF.                                                      01960084
019700                                                                  01970084
019800******************************************************************01980084
019900*     5000-UPDATE-REFUND                                         *01990084
020000* ==> PROCESSES:                                                 *02000084
020100*     - UPDATES THE REFUND RECORD.                               *02010084
020200* ==> PERFORMED FROM:  2000-CHECK-FOR-UPDATE                     *02020084
020300******************************************************************02030084
020400 5000-UPDATE-REFUND.                                              02040084
020500                                                                  02050084
020600     MOVE RD039-CUST-ID        TO RDT00001-CUST-ID.               02060084
020700     MOVE RD039-STR-RGST-ID    TO RDT00001-STR-RGST-ID.           02070084
020800     MOVE RD039-RGST-TRN-NBR   TO RDT00001-RGST-TRN-NBR.          02080084
020900     MOVE RD039-RFND-SEQ-NBR   TO RDT00001-RFND-SEQ-NBR.          02090084
021000     MOVE RD039-CHECK-NBR      TO RDT00001-RFND-CK-NBR.           02100084
021100     MOVE RD039-CHECK-DATE     TO RDT00001-RFND-CK-DTE.           02110084
021200                                                                  02120084
021500     PERFORM WITH TEST AFTER                                      02150084
021600         VARYING PV-SQL-SUB                                       02160084
021700         FROM 1 BY 1                                              02170084
021800         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       02180084
021900                OR SQLCODE = -911                                 02190084
022000                OR SQLCODE = 0)                                   02200084
022100                                                                  02210084
022200         EXEC SQL                                                 02220084
022300             UPDATE RDT_MAL_CK_RFND                               02230084
022400                SET  RFND_CK_NBR    = :RDT00001-RFND-CK-NBR       02240084
022500                    ,RFND_CK_DTE    = :RDT00001-RFND-CK-DTE       02250084
022600                    ,LST_UPD_TMST   = CURRENT TIMESTAMP           02260084
022700              WHERE CUST_ID      = :RDT00001-CUST-ID              02270084
022800                AND STR_RGST_ID  = :RDT00001-STR-RGST-ID          02280084
022900                AND RGST_TRN_NBR = :RDT00001-RGST-TRN-NBR         02290084
023000                AND RFND_SEQ_NBR = :RDT00001-RFND-SEQ-NBR         02300084
023100         END-EXEC                                                 02310084
023200                                                                  02320084
023300         EVALUATE TRUE                                            02330084
023400             WHEN SQLCODE = 0                                     02340084
023500                 ADD +1 TO PA-REFUND-ROWS-UPDATED                 02350084
023600             WHEN SQLCODE = -911                                  02360084
023700                 ADD +1 TO PV-DEADLOCK-COUNTER                    02370084
023800                           PV-SQL-SUB                             02380084
023900                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        02390084
024000                     MOVE '5000-UPDATE-REFUND          '          02400084
024100                                      TO PV-PARAGRAPH-NAME        02410084
024200                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        02420084
024300                                      TO PV-DB2-OPER-ATTEMPTED    02430084
024400                     PERFORM 9999-SQL-ABEND                       02440084
024500                 ELSE                                             02450084
024600                     SET PS-RESTART-REQUIRED TO TRUE              02460084
024700                 END-IF                                           02470084
024800             WHEN OTHER                                           02480084
024900                 MOVE '5000-UPDATE-REFUND          '              02490084
025000                                  TO PV-PARAGRAPH-NAME            02500084
025100                 MOVE 'UPDATE TO RDT_MAL_CK_RFND    '             02510084
025200                                  TO PV-DB2-OPER-ATTEMPTED        02520084
025300                 PERFORM 9999-SQL-ABEND                           02530084
025400         END-EVALUATE                                             02540084
025500     END-PERFORM.                                                 02550084
025600                                                                  02560084
025700     IF PV-SQL-SUB > PC-MAX-RETRIES                               02570084
025800         MOVE '5000-UPDATE-REFUND          '                      02580084
025900                                      TO PV-PARAGRAPH-NAME        02590084
026000         MOVE 'UPDATE RETRIES EXCEEDED       '                    02600084
026100                                      TO PV-DB2-OPER-ATTEMPTED    02610084
026200         PERFORM 9999-SQL-ABEND                                   02620084
026300     END-IF.                                                      02630084
026400                                                                  02640084
026500******************************************************************02650084
026600*  ABEND THE PROGRAM IN THE EVENT THAT A SQL ERROR OR WARNING    *02660084
026700*  CODE OCCURS.                                                  *02670084
026800******************************************************************02680084
026900 9999-SQL-ABEND.                                                  02690084
027000                                                                  02700084
027100     DISPLAY '** ABEND     **'.                                   02710084
027200     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        02720084
027300     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              02730084
027400     DISPLAY '** OPERATION ** = ' PV-DB2-OPER-ATTEMPTED.          02740084
027500                                                                  02750084
027600******************************************************************02760084
027700*  THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-  *02770084
027800*  MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE       *02780084
027900*  'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE   *02790084
028000*  FORMAT.                                                       *02800084
028100******************************************************************02810084
028200     COPY DPPD004.                                                02820084
028300                                                                  02830084
028400     MOVE +4013 TO ABEND-CODE.                                    02840084
028500     CALL 'ILBOABN0' USING ABEND-CODE.                            02850084
028600                                                                  02860084
028700******************************************************************02870084
028800*  THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-  *02880084
028900*  MENTS THAT ARE REQUIRED TO INVOKE THE TRANSACTION PRESENTATION*02890084
029000*  MODULE (DPKUT901) OF THE DB2 CHECKPOINT RESTART SYSTEM.       *02900084
029100******************************************************************02910084
029200     COPY DPPD001.                                                02920084
