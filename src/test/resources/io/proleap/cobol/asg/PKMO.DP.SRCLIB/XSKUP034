000100*----------------------------------------------------------       00010002
000200 IDENTIFICATION DIVISION.                                         00020002
000300*----------------------------------------------------------       00030002
000400 PROGRAM-ID.    XSKUP034.                                         00040002
000500 AUTHOR.        ALEXIS KEIKER.                                    00050002
000600 DATE-WRITTEN.  OCTOBER 1, 2002.                                  00060002
000700                                                                  00070002
000800*----------------------------------------------------------       00080002
000900*          ADHOC STORE LIST BUSINESS EVENT LOADER                 00090002
001000*----------------------------------------------------------       00100002
001010* THIS PROGRAM WILL PERFORM THE NECESSARY BUSINESS EVENT          00101004
001020* LOAD FOR THE ADHOC STORE LIST BUSINESS EVENT.  THIS PROGRAM     00102004
001030* IS A MODULE AND WILL BE CALLED BY ANOTHER PROGRAM(XSKUT034).    00103010
001040* THERE ARE 5 PARAMETERS PASSED IN THIS PROGRAM.  ONE WILL        00104004
001050* BE THE ACTUAL ADHOC STORE LIST BUSINESS RECORD, MAXIMUM FUTURE  00105004
001060* OFFSET DATE IN CCYYMMDD, A LOAD SQL RETURN CODE FIELD,          00106004
001070* A PROGRAM STATUS CODE, AND A LOAD SEVERITY LEVEL.  THIS         00107004
001080* PROGRAM WILL EITHER UPDATE OR INSERT A RECORD TO THE            00108004
001090* XST_PROMO_ADHC_STR (ADHOC STORE LIST TABLE). THIS PROGRAM       00109004
001091* WILL ALWAYS RETURN BACK A LOAD SQL RETURN CODE, A PROGRAM       00109104
001092* STATUS CODE AND A LOAD SEVERITY CODE.  IF THIS PROGRAM          00109204
001093* DOES NOT UPDATE OR INSERT THE RECORD CORRECTLY IT WILL          00109304
001094* SELECT THE CORRECT ERROR CODES, FIND THE LOAD SEVERITY          00109404
001095* LEVEL, AND EXIT OUT OF THE PROGRAM.                             00109504
001100*                                                                 00110002
001101*          SQL CODES - LOAD SQL RETURN CODE                       00110105
001102*             - THIS IS THE LAST SQL RETURN CODE RECEIVED         00110202
001103*               FROM A DATABASE ACTION.                           00110302
001104*                                                                 00110402
001105*          PROGRAM CODES - PROGRAM STATUS CODE                    00110505
001106*           - 00 - ALL DATABASE ACTION WAS SUCCESSFUL AND         00110602
001107*                  WORKED ACCORDING TO THE MESSAGE TYPE.          00110702
001108*           - 01 - AN 'ADD' RECORD WAS TURNED INTO AN             00110802
001109*                  UPDATE AND THE BUSINESS EVENT WAS FOUND        00110902
001110*                  TO BE THE ONE NEEDED ON THE DATABASE.          00111002
001111*           - 02 - AN 'ADD' RECORD WAS TURNED INTO AN UPDATE      00111102
001112*                  AND THE BUSINESS EVENT WAS FOUND TO BE         00111202
001113*                  THE ONE NOT NEEDED ON THE DATABASE.            00111302
001114*           - 03 - AN 'UPDATE' RECORD WAS TURNED INTO AN ADD.     00111402
001115*           - 04 - AN 'UPDATE' RECORD WAS BYPASSED BECAUSE THE    00111510
001116*                  RECORD CURRENTLY ON THE DATABASE WAS THE       00111610
001117*                  MOST RECENT DATA.                              00111710
001118*           - 05 - THE DATABASE ACTION WAS NOT SUCCESSFUL DUE     00111810
001119*                  TO THE RETURNED SQL CODE.                      00111902
001120*           - 06 - UNEXPECTED ACTION CODE RECEIVED.               00112010
001121*                                                                 00112102
001122*          ERROR CODES - LOAD SEVERITY LEVEL                      00112202
001123*            THIS CODE IS FOUND BY TAKING THE MAXIMUM OFFSET      00112304
001124*            DATE AND COMPARING IT TO THE ADHOC STORE LIST START  00112404
001125*            DATE.  IF THE MAXIMUM OFFSET DATE IS LESS THAN       00112504
001126*            THE ADHOC STORE LIST START DATE THE LOAD IS NOT      00112604
001127*            CRITICAL, OTHERWISE IT IS CRITICAL TO THE SYSTEM.    00112704
001128*           - 00 - THE LOAD OF THE DATA WAS SUCCESSFUL AND        00112804
001129*                  THEREFORE THE SEVERITY OF THE LOAD DID         00112904
001130*                  NOT NEED TO BE DETERMINED.                     00113004
001131*           - 01 - THE LOAD IS CRITICAL TO A SYSTEM AND           00113102
001132*                  THEREFORE MUST BE RESOLVED ASAP.               00113202
001133*           - 02 - THE LOAD IS NOT CRITICAL AND THEREFORE CAN     00113302
001134*                  WAIT UNTIL A LATER TIME TO BE RESOLVED.        00113402
001135*                                                                 00113502
001136*----------------------------------------------------------       00113602
001137* HISTORY LOG:                                                    00113702
001138*                                                                 00113802
001139*----------------------------------------------------------       00113902
001140* DATE:                                                           00114002
001141* WR/IR#:                                                         00114102
001142* PROGRAMMER:                                                     00114202
001143* DESCRIPTION:                                                    00114302
001144*                                                                 00114402
001145*----------------------------------------------------------       00114502
001146 ENVIRONMENT DIVISION.                                            00114602
001147*----------------------------------------------------------       00114702
001148 CONFIGURATION SECTION.                                           00114802
001149 SOURCE-COMPUTER. IBM-3090.                                       00114902
001150 OBJECT-COMPUTER. IBM-3090.                                       00115002
001151                                                                  00115102
001152 INPUT-OUTPUT SECTION.                                            00115202
001160                                                                  00116002
001170 FILE-CONTROL.                                                    00117002
001180                                                                  00118002
001190*----------------------------------------------------------       00119002
001200 DATA DIVISION.                                                   00120002
001300*----------------------------------------------------------       00130002
001400 FILE SECTION.                                                    00140002
001500                                                                  00150002
001600                                                                  00160002
001700*---------------------------------------------------------        00170002
001800                                                                  00180002
001900 WORKING-STORAGE SECTION.                                         00190002
002000*---------------------------------------------------------        00200002
002100* PC- PROGRAM CONSTANTS                                           00210002
002200*----------------------------------------------------------       00220002
002300 01  PC-PROGRAM-CONSTANTS.                                        00230002
002400     05  PC-PROGRAM-NAME              PIC X(08) VALUE 'XSKUP034'. 00240002
002500     05  PC-MAX-RETRIES               PIC S9(04) VALUE +5 COMP.   00250002
002600                                                                  00260002
002700*----------------------------------------------------------       00270002
002800* PS- PROGRAM SWITCHES                                            00280002
002900*----------------------------------------------------------       00290002
003000 01  PS-PROGRAM-SWITCHES.                                         00300002
003100     05  PS-PROCESS-CONTINUE-SW       PIC X(01)  VALUE 'Y'.       00310002
003200         88  PS-PROCESS-CONTINUE                 VALUE 'Y'.       00320002
003300         88  PS-PROCESS-COMPLETE                 VALUE 'N'.       00330002
003400                                                                  00340002
003500*----------------------------------------------------------       00350002
003600* PV- PROGRAM VARIABLES                                           00360002
003700*----------------------------------------------------------       00370002
003800 01 PV-PROGRAM-VARIABLES.                                         00380002
003900    05  PV-SQL-SUB                    PIC S9(4)  VALUE +0 COMP.   00390002
003910    05  PV-SQL-CODE                   PIC S9(4)  VALUE +0.        00391018
004000    05  PV-MAX-OFFSET-DTE             PIC 9(08)  VALUE 0.         00400002
004100    05  PV-LAST-UPD-TMST              PIC X(26)  VALUE SPACES.    00410002
004220    05  PV-ACTION-CODE                PIC X(01).                  00422002
004230        88  PV-INSERT-DATA                       VALUE 'I'.       00423002
004240        88  PV-UPDATE-DATA                       VALUE 'U'.       00424002
004250    05  PV-LD-STATUS-CDE              PIC X(02).                  00425002
004260        88  PV-NO-ERROR                          VALUE '00'.      00426002
004270        88  PV-CRITICAL-ERROR                    VALUE '01'.      00427002
004280        88  PV-NOT-CRITICAL-ERROR                VALUE '02'.      00428002
004290    05  PV-PGM-STATUS-CDE             PIC X(02).                  00429002
004300        88  PV-SUCCESS-CDE                       VALUE '00'.      00430002
004400        88  PV-UPDATE-NEED                       VALUE '01'.      00440002
004500        88  PV-UPDATE-NOT-NEED                   VALUE '02'.      00450002
004600        88  PV-ADD-CDE                           VALUE '03'.      00460002
004610        88  PV-UPDATE-BYPASS                     VALUE '04'.      00461010
004700        88  PV-NO-SUCCESS-CDE                    VALUE '05'.      00470010
004800        88  PV-UNEXPECT-CDE                      VALUE '06'.      00480010
004900                                                                  00490002
004910    05  PV-NULLS-INDICATORS.                                      00491010
004920        10  PV-END-TMST-IND           PIC S9(4) COMP VALUE +0.    00492010
004940                                                                  00494010
005000    05  PV-AD-STR-LT-STRT-DTE-NBR.                                00500002
005100        10  PV-AD-STR-LT-DTE-CCYY         PIC 9(04).              00510002
005200        10  PV-AD-STR-LT-DTE-MM           PIC 9(02).              00520002
005300        10  PV-AD-STR-LT-DTE-DD           PIC 9(02).              00530002
005400                                                                  00540002
005500    05  PV-AD-STR-LT-STRT-DTE-TM.                                 00550002
005600        10  PV-AD-STR-LT-STRT-DTE.                                00560002
005700            15  PV-AD-STR-LT-DTE-TM-CCYY  PIC X(04).              00570002
005800            15  FILLER                    PIC X(01).              00580002
005900            15  PV-AD-STR-LT-DTE-TM-MM    PIC X(02).              00590002
006000            15  FILLER                    PIC X(01).              00600002
006100            15  PV-AD-STR-LT-DTE-TM-DD    PIC X(02).              00610002
006200        10  PV-AD-STR-LT-STRT-TM          PIC X(16).              00620002
006300                                                                  00630002
006400    05  PV-AD-STR-LT-END-DTE-TM.                                  00640002
006500        10  PV-AD-STR-LT-END-DTE.                                 00650002
006600            15  PV-AD-STR-LT-DTE-TM2-CCYY PIC X(04).              00660002
006700            15  FILLER                    PIC X(01).              00670002
006800            15  PV-AD-STR-LT-DTE-TM2-MM   PIC X(02).              00680002
006900            15  FILLER                    PIC X(01).              00690002
007000            15  PV-AD-STR-LT-DTE-TM2-DD   PIC X(02).              00700002
007100        10  PV-AD-STR-LT-END-TM           PIC X(16).              00710002
007200                                                                  00720002
007300*----------------------------------------------------------       00730002
007400* ADHOC STORE LIST BUSINESS EVENT RECORD LAYOUT                   00740002
007500*----------------------------------------------------------       00750002
007600     COPY XSRD024.                                                00760002
007700                                                                  00770002
008300*----------------------------------------------------------       00830002
008400* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         00840002
008500*----------------------------------------------------------       00850002
008600     COPY DPWS004.                                                00860002
008700                                                                  00870002
008800*---------------------------------------------                    00880002
008900*  DB2 COMMUNICATION AREA.                                        00890002
009000*---------------------------------------------                    00900002
009100     EXEC SQL                                                     00910002
009200          INCLUDE SQLCA                                           00920002
009300     END-EXEC.                                                    00930002
009400                                                                  00940002
009500*---------------------------------------------                    00950002
009600*  DB2 TABLE XST00033(XST_PROMO_ADHC_STR) - ADHOC STORE LIST      00960002
009610*                                                TABLE            00961003
009700*---------------------------------------------                    00970002
009800     EXEC SQL                                                     00980002
009900          INCLUDE XST00033                                        00990002
010000     END-EXEC.                                                    01000002
010100                                                                  01010002
010200 LINKAGE SECTION.                                                 01020002
010300                                                                  01030002
010400*----------------------------------------------------------       01040002
010500* FILE INFORMATION BEING PASSED TO AND FROM THIS MODULE.          01050002
010600*----------------------------------------------------------       01060002
010700 01 LV-LINKAGE-VARIABLES.                                         01070002
010800    05  LV-ADHOC-STR-LIST-BUS-REC  PIC X(300).                    01080002
010900    05  LV-MAX-OFFSET-DTE          PIC X(08).                     01090002
011000    05  LV-LD-SQL-RETURN-CDE       PIC S9(4).                     01100002
011100    05  LV-PGM-STATUS-CDE          PIC X(02).                     01110002
011200    05  LV-LD-SEVERITY-LVL         PIC X(02).                     01120002
011300                                                                  01130002
011400                                                                  01140002
011500*----------------------------------------------------------       01150002
011600 PROCEDURE DIVISION USING LV-LINKAGE-VARIABLES.                   01160002
011700*----------------------------------------------------------       01170002
011800 0000-MAINLINE.                                                   01180002
011900                                                                  01190002
012000     PERFORM 1000-INITIALIZATION.                                 01200002
012100                                                                  01210002
012200     PERFORM 2000-PROCESS-MESSAGE                                 01220002
012300             UNTIL PS-PROCESS-COMPLETE.                           01230002
012400                                                                  01240002
012500     PERFORM 9999-WRAPUP.                                         01250002
012600                                                                  01260002
012700     EXIT PROGRAM.                                                01270020
012800                                                                  01280002
012900*0000-EXIT.                                                       01290002
013000 EJECT.                                                           01300002
013100                                                                  01310002
013200*----------------------------------------------------------       01320002
013300* 1000-INITIALIZATION.                                            01330002
013400*     INTIALIZES OR MOVES ANY VARIABLES BEFORE IT WILL            01340002
013500*     UPDATE OR INSERT A RECORD.                                  01350002
013600*----------------------------------------------------------       01360002
013700 1000-INITIALIZATION.                                             01370002
013800                                                                  01380002
013900     INITIALIZE DCLXST00033                                       01390010
013901                PV-SQL-CODE                                       01390118
013910                PV-NULLS-INDICATORS.                              01391010
014000     MOVE LV-ADHOC-STR-LIST-BUS-REC TO XS024-ADHOC-STR-LST-RECORD.01400017
014100     MOVE XS024-ACTION-CDE          TO PV-ACTION-CODE.            01410002
014200     MOVE XS024-STRT-TMST           TO PV-AD-STR-LT-STRT-DTE-TM.  01420002
014600     SET PV-NO-ERROR                TO TRUE.                      01460002
014700     SET PV-SUCCESS-CDE             TO TRUE.                      01470002
014800     SET PS-PROCESS-CONTINUE        TO TRUE.                      01480002
014900                                                                  01490002
014910     IF LV-MAX-OFFSET-DTE = SPACES                                01491002
014920        INITIALIZE PV-MAX-OFFSET-DTE                              01492002
014930     ELSE                                                         01493002
014940        MOVE LV-MAX-OFFSET-DTE    TO PV-MAX-OFFSET-DTE            01494002
014950     END-IF.                                                      01495002
014970                                                                  01497002
014980     PERFORM 1100-POPULATE-DCLGEN.                                01498002
014990                                                                  01499002
015000*1000-EXIT.                                                       01500002
015100 EJECT.                                                           01510002
015200                                                                  01520002
015300*----------------------------------------------------------       01530002
015400* 1100-POPULATE-DCLGEN.                                           01540002
015500*     POPULATES THE ADHOC STORE LIST TABLE VARIABLES.             01550019
015700*----------------------------------------------------------       01570002
015800 1100-POPULATE-DCLGEN.                                            01580002
015900                                                                  01590002
016000     MOVE XS024-ADHC-STR-GP-ID  TO XST00033-ADHC-STR-GP-ID.       01600009
016100     MOVE XS024-STR-NBR         TO XST00033-STR-NBR.              01610010
016300     MOVE XS024-STRT-TMST       TO XST00033-EFF-STRT-TMST.        01630013
016700     MOVE XS024-STAT-CDE        TO XST00033-STAT-CDE.             01670002
017200     MOVE XS024-LAST-UPD-TMST   TO XST00033-SOR-LAST-UPD-TMST.    01720010
017201                                                                  01720110
017210     IF XS024-END-TMST = SPACES                                   01721010
017220        MOVE -1                 TO PV-END-TMST-IND                01722013
017230     ELSE                                                         01723010
017240        MOVE XS024-END-TMST     TO XST00033-EFF-END-TMST          01724013
017250     END-IF.                                                      01725010
017300                                                                  01730002
017400*1100-EXIT.                                                       01740002
017500 EJECT.                                                           01750002
017600                                                                  01760002
017700*----------------------------------------------------------       01770002
017800* 2000-PROCESS-MESSAGE.                                           01780002
017900*     THIS CHECKS THE ACTION TO SEE WHETHER THE RECORD            01790002
018000*     SHOULD BE INSERTED INTO THE ADHOC STORE LIST TABLE OR       01800002
018100*     UPDATED. IF SOMETHING IS WRONG WITH THE ACTION CODE IT      01810002
018200*     WILL PROCESS AN ERROR AND EXIT THE PROGRAM.                 01820002
018300*----------------------------------------------------------       01830002
018400 2000-PROCESS-MESSAGE.                                            01840002
018500                                                                  01850002
018600     EVALUATE TRUE                                                01860002
018700        WHEN PV-INSERT-DATA                                       01870002
018800             PERFORM 2100-INSERT-DATA                             01880002
018900        WHEN PV-UPDATE-DATA                                       01890002
019000             PERFORM 2200-UPDATE-DATA                             01900002
019100        WHEN OTHER                                                01910002
019200             SET PS-PROCESS-COMPLETE TO TRUE                      01920002
019300             SET PV-UNEXPECT-CDE     TO TRUE                      01930002
019400             PERFORM 9000-LOAD-SEVERITY-ERROR                     01940002
019500     END-EVALUATE.                                                01950002
019600                                                                  01960002
019700*2000-EXIT.                                                       01970002
019800 EJECT.                                                           01980002
019900                                                                  01990002
020000*------------------------------------------------------           02000002
020100* 2100-INSERT-DATA.                                               02010002
020200*     INSERT THE ADHOC STORE LIST RECORD.                         02020002
020300*------------------------------------------------------           02030002
020400 2100-INSERT-DATA.                                                02040002
020500                                                                  02050002
020600     PERFORM                                                      02060002
020700         WITH TEST AFTER                                          02070002
020800         VARYING PV-SQL-SUB                                       02080002
020900         FROM 1 BY 1                                              02090002
021000         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 02100002
021100                   OR  SQLCODE NOT = -904 AND -911 AND -913)      02110007
021400                                                                  02140002
021500         EXEC SQL                                                 02150002
021600             INSERT INTO XST_PROMO_ADHC_STR                       02160002
021610                                      (ADHC_STR_GP_ID             02161003
021700                                      ,STR_NBR                    02170010
021900                                      ,STAT_CDE                   02190002
022000                                      ,EFF_STRT_TMST              02200010
022100                                      ,EFF_END_TMST               02210010
022200                                      ,LAST_UPD_TMST              02220010
022300                                      ,SOR_LAST_UPD_TMST)         02230010
022700             VALUES                                               02270002
022800                (:XST00033-ADHC-STR-GP-ID                         02280002
022900                ,:XST00033-STR-NBR                                02290010
023100                ,:XST00033-STAT-CDE                               02310002
023200                ,:XST00033-EFF-STRT-TMST                          02320010
023300                ,:XST00033-EFF-END-TMST :PV-END-TMST-IND          02330010
023310                ,CURRENT TIMESTAMP                                02331010
023400                ,:XST00033-SOR-LAST-UPD-TMST)                     02340010
023450         END-EXEC                                                 02345002
023460                                                                  02346002
023461         MOVE SQLCODE TO PV-SQL-CODE                              02346118
023462                                                                  02346218
023470         EVALUATE TRUE                                            02347002
023480             WHEN SQLCODE = -904                                  02348002
023490             WHEN SQLCODE = -911                                  02349002
023500             WHEN SQLCODE = -913                                  02350002
023600                  CONTINUE                                        02360002
023700             WHEN SQLCODE = 0                                     02370002
023800                  SET PS-PROCESS-COMPLETE TO TRUE                 02380002
023900             WHEN SQLCODE = -803                                  02390002
024000                  PERFORM 2300-SELECT-DATA                        02400010
024010                  MOVE -803 TO SQLCODE                            02401018
024100             WHEN OTHER                                           02410002
024200                  SET PS-PROCESS-COMPLETE TO TRUE                 02420002
024300                  SET PV-NO-SUCCESS-CDE TO TRUE                   02430002
024400                  PERFORM 9000-LOAD-SEVERITY-ERROR                02440002
024500         END-EVALUATE                                             02450002
024600     END-PERFORM.                                                 02460002
024700                                                                  02470002
024800     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         02480002
024900        SET PS-PROCESS-COMPLETE TO TRUE                           02490002
025000        SET PV-NO-SUCCESS-CDE TO TRUE                             02500002
025100        PERFORM 9000-LOAD-SEVERITY-ERROR                          02510002
025200     END-IF.                                                      02520002
025300                                                                  02530002
025400*2100-EXIT.                                                       02540002
025500 EJECT.                                                           02550002
025600                                                                  02560002
032100*------------------------------------------------------           03210002
032200* 2200-UPDATE-DATA.                                               03220002
032300*     UPDATE THE ADHOC STORE LIST RECORD.                         03230002
032400*------------------------------------------------------           03240002
032500 2200-UPDATE-DATA.                                                03250002
032600                                                                  03260002
032700     PERFORM                                                      03270002
032800         WITH TEST AFTER                                          03280002
032900         VARYING PV-SQL-SUB                                       03290002
033000         FROM 1 BY 1                                              03300002
033100         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 03310002
033200                   OR  SQLCODE NOT = -904 AND -911 AND -913)      03320007
033500                                                                  03350002
033600         EXEC SQL                                                 03360002
033700             UPDATE XST_PROMO_ADHC_STR                            03370002
033800             SET  ADHC_STR_GP_ID    = :XST00033-ADHC-STR-GP-ID,   03380002
034000                  STR_NBR           = :XST00033-STR-NBR,          03400010
034100                  STAT_CDE          = :XST00033-STAT-CDE,         03410002
034200                  EFF_STRT_TMST     = :XST00033-EFF-STRT-TMST,    03420011
034300                  EFF_END_TMST      = :XST00033-EFF-END-TMST      03430011
034400                                         :PV-END-TMST-IND,        03440010
034800                  LAST_UPD_TMST     = CURRENT TIMESTAMP,          03480012
034801                  SOR_LAST_UPD_TMST = :XST00033-SOR-LAST-UPD-TMST 03480112
034810            WHERE ADHC_STR_GP_ID    = :XST00033-ADHC-STR-GP-ID    03481010
034821              AND STR_NBR           = :XST00033-STR-NBR           03482110
034822              AND SOR_LAST_UPD_TMST <= :XST00033-SOR-LAST-UPD-TMST03482214
034830         END-EXEC                                                 03483002
034840                                                                  03484002
034841         MOVE SQLCODE TO PV-SQL-CODE                              03484118
034842                                                                  03484218
034850         EVALUATE TRUE                                            03485002
034860             WHEN SQLCODE = -904                                  03486002
034870             WHEN SQLCODE = -911                                  03487002
034880             WHEN SQLCODE = -913                                  03488002
034890                  CONTINUE                                        03489002
034900             WHEN SQLCODE = 0                                     03490002
035000                  SET PS-PROCESS-COMPLETE TO TRUE                 03500002
035100             WHEN SQLCODE = +100                                  03510002
035200                  PERFORM 2300-SELECT-DATA                        03520010
035300                  MOVE +100 TO SQLCODE                            03530018
035400             WHEN OTHER                                           03540002
035500                  SET PS-PROCESS-COMPLETE TO TRUE                 03550002
035600                  SET PV-NO-SUCCESS-CDE TO TRUE                   03560002
035700                  PERFORM 9000-LOAD-SEVERITY-ERROR                03570002
035800         END-EVALUATE                                             03580002
035900     END-PERFORM.                                                 03590002
036000                                                                  03600002
036100     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         03610002
036200        SET PS-PROCESS-COMPLETE TO TRUE                           03620002
036300        SET PV-NO-SUCCESS-CDE TO TRUE                             03630002
036400        PERFORM 9000-LOAD-SEVERITY-ERROR                          03640002
036500     END-IF.                                                      03650002
036600                                                                  03660002
036700*2200-EXIT.                                                       03670002
036800 EJECT.                                                           03680002
036900                                                                  03690002
036910*------------------------------------------------------           03691010
036920* 2300-SELECT-DATA.                                               03692010
036930*     SELECT THE TIMESTAMP IN THE ADHOC STORE LIST RECORD.        03693010
036940*------------------------------------------------------           03694010
036950 2300-SELECT-DATA.                                                03695010
036960                                                                  03696010
036970     PERFORM                                                      03697010
036980         WITH TEST AFTER                                          03698010
036990         VARYING PV-SQL-SUB                                       03699010
036991         FROM 1 BY 1                                              03699110
036992         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 03699210
036993                   OR  SQLCODE NOT = -904 AND -911 AND -913)      03699310
036994                                                                  03699410
036995         EXEC SQL                                                 03699510
036996             SELECT  SOR_LAST_UPD_TMST                            03699610
036997               INTO :PV-LAST-UPD-TMST                             03699710
036998               FROM  XST_PROMO_ADHC_STR                           03699810
036999              WHERE  ADHC_STR_GP_ID  = :XST00033-ADHC-STR-GP-ID   03699910
037001                AND  STR_NBR         = :XST00033-STR-NBR          03700110
037002         END-EXEC                                                 03700210
037003                                                                  03700310
037004         MOVE SQLCODE TO PV-SQL-CODE                              03700418
037005                                                                  03700518
037006         EVALUATE TRUE                                            03700610
037007             WHEN SQLCODE = -904                                  03700710
037008             WHEN SQLCODE = -911                                  03700810
037009             WHEN SQLCODE = -913                                  03700910
037010                  CONTINUE                                        03701010
037011             WHEN SQLCODE = 0                                     03701110
037012                  IF PV-UPDATE-DATA                               03701210
037013                     SET PS-PROCESS-COMPLETE TO TRUE              03701310
037014                     SET PV-UPDATE-BYPASS TO TRUE                 03701410
037015                  ELSE                                            03701510
037016                     PERFORM 2350-TMST-COMPARE                    03701619
037017                  END-IF                                          03701710
037018             WHEN SQLCODE = +100                                  03701810
037019                  SET PV-INSERT-DATA TO TRUE                      03701910
037020                  SET PV-ADD-CDE TO TRUE                          03702010
037021             WHEN OTHER                                           03702110
037022                  SET PS-PROCESS-COMPLETE TO TRUE                 03702210
037023                  SET PV-NO-SUCCESS-CDE TO TRUE                   03702310
037024                  PERFORM 9000-LOAD-SEVERITY-ERROR                03702410
037025         END-EVALUATE                                             03702510
037026     END-PERFORM.                                                 03702610
037027                                                                  03702710
037028     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         03702810
037029        SET PS-PROCESS-COMPLETE TO TRUE                           03702910
037030        SET PV-NO-SUCCESS-CDE TO TRUE                             03703010
037031        PERFORM 9000-LOAD-SEVERITY-ERROR                          03703110
037032     END-IF.                                                      03703210
037033                                                                  03703310
037034*2300-EXIT.                                                       03703410
037035 EJECT.                                                           03703510
037036                                                                  03703610
037037*--------------------------------------------------------         03703710
037038* 2350-TMST-COMPARE.                                              03703819
037039*     COMPARE TIMESTAMP OF EXISTING ROW TO MESSAGE RECORD         03703919
037040*     AND UPDATE IF MESSAGE HAS A NEWER TIMESTAMP.                03704019
037041*--------------------------------------------------------         03704110
037042 2350-TMST-COMPARE.                                               03704219
037043                                                                  03704310
037044     IF XS024-LAST-UPD-TMST >= PV-LAST-UPD-TMST                   03704410
037045        SET PV-UPDATE-DATA      TO TRUE                           03704510
037046        SET PV-UPDATE-NEED      TO TRUE                           03704610
037047     ELSE                                                         03704710
037048        SET PS-PROCESS-COMPLETE TO TRUE                           03704810
037049        SET PV-UPDATE-NOT-NEED  TO TRUE                           03704910
037050     END-IF.                                                      03705010
037051                                                                  03705110
037052*2350-EXIT.                                                       03705210
037053 EJECT.                                                           03705310
037054                                                                  03705410
037060*----------------------------------------------------------       03706002
037100* 9000-LOAD-SEVERITY-ERROR.                                       03710002
037200*     THIS PROCEDURE IS CALLED IF THE RECORD WAS NOT UPDATED      03720002
037300*     OR INSERTED INTO THE ADHOC STORE LIST TABLE.  COMPARES      03730002
037400*     THE MAXIMUM OFFSET DATE TO THE ADHOC STORE LIST BUSINESS    03740002
037500*     EVENT START DATE.  IF THE MAXIMUM OFFSET DATE IS LESS       03750002
037600*     THAN THE ADHOC STORE LIST START DATE THE ERROR IS           03760002
037700*     UNCRITICAL, OTHERWISE IT IS CRITICAL.                       03770002
037800*----------------------------------------------------------       03780002
037900 9000-LOAD-SEVERITY-ERROR.                                        03790002
038000                                                                  03800002
038100     IF PV-AD-STR-LT-STRT-DTE = SPACES                            03810002
038200        MOVE ZEROES TO PV-AD-STR-LT-STRT-DTE-NBR                  03820002
038300     ELSE                                                         03830002
038400        PERFORM 9100-FORMAT-DATE-INFO                             03840002
038500     END-IF.                                                      03850002
038600                                                                  03860002
038700     IF (PV-MAX-OFFSET-DTE < PV-AD-STR-LT-STRT-DTE-NBR) AND       03870002
038800       (PV-MAX-OFFSET-DTE NOT = ZEROES) AND                       03880002
038900       (PV-AD-STR-LT-STRT-DTE-NBR NOT = ZEROES)                   03890002
039000        SET PV-NOT-CRITICAL-ERROR TO TRUE                         03900002
039100     ELSE                                                         03910002
039200        SET PV-CRITICAL-ERROR TO TRUE                             03920002
039300     END-IF.                                                      03930002
039400                                                                  03940002
039410     INITIALIZE PV-SQL-SUB.                                       03941008
039420                                                                  03942008
039500*9000-EXIT.                                                       03950002
039600 EJECT.                                                           03960002
039700                                                                  03970002
039800*----------------------------------------------------------       03980002
039900* 9100-FORMAT-DATE-INFO.                                          03990002
040000*     FORMATS THE DATE FOR COMPARING.                             04000002
040100*----------------------------------------------------------       04010002
040200 9100-FORMAT-DATE-INFO.                                           04020002
040300                                                                  04030002
040400     MOVE PV-AD-STR-LT-DTE-TM-CCYY TO PV-AD-STR-LT-DTE-CCYY.      04040002
040500     MOVE PV-AD-STR-LT-DTE-TM-MM   TO PV-AD-STR-LT-DTE-MM.        04050002
040600     MOVE PV-AD-STR-LT-DTE-TM-DD   TO PV-AD-STR-LT-DTE-DD.        04060002
040700                                                                  04070002
040800*9100-EXIT.                                                       04080002
040900 EJECT.                                                           04090002
041000                                                                  04100002
041100*----------------------------------------------------------       04110002
041200* 9999-WRAPUP.                                                    04120002
041300*     MOVES ALL ERROR CODES TO THE LINKAGE VARIABLES TO           04130002
041400*     BE PASSED BACK TO THE CALLING PROGRAM.  EXITS THE           04140002
041500*     PROGRAM.                                                    04150002
041600*----------------------------------------------------------       04160002
041700 9999-WRAPUP.                                                     04170002
041800                                                                  04180002
041900     MOVE PV-PGM-STATUS-CDE TO LV-PGM-STATUS-CDE.                 04190002
042000     MOVE PV-SQL-CODE       TO LV-LD-SQL-RETURN-CDE.              04200018
042100     MOVE PV-LD-STATUS-CDE  TO LV-LD-SEVERITY-LVL.                04210002
042200                                                                  04220002
042300*9999-EXIT.                                                       04230002
042400 EJECT.                                                           04240002
042500                                                                  04250002
