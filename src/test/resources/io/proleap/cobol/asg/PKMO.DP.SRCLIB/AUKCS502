000100******************************************************************00000100
000200 IDENTIFICATION DIVISION.                                         00000200
000300******************************************************************00000300
000400                                                                  00000400
000500 PROGRAM-ID.        AUKCS502.                                     00000500
000600 AUTHOR.            BRAD GROCHOWSKI TKMA557.                      00000600
000700 INSTALLATION.      KOHLS.                                        00000700
000800 DATE-WRITTEN       07/07/2003.                                   00000800
000900 DATE-COMPILED.                                                   00000900
001000                                                                  00001000
001100******************************************************************00001100
001200*  CICS PROGRAM - AUKCS502 - A502                                *00001200
001300*                                                                *00001300
001400*       STORED VALUE AUTHORIZATION PROCESSOR.                    *00001400
001500*                                                                *00001500
001600*  RECEIVE GIFT CARD AUTHORIZATION REQUESTS FROM THE TCP/IP      *00001600
001700*  LISTENER PROGRAM AUKCS500, PERFORM THE AUTHORIZATION, AND     *00001700
001800*  SEND RESPONSE TO TEMP STORAGE QUEUE TO BE PICKED UP BY THE    *00001800
001900*  LISTENER PROGRAM.                                             *00001900
002000*  THE KMC ACTIVITY TABLE WILL BE UPDATED WITH ANY APPROVED      *00002000
002100*  RESPONSES.                                                    *00002100
002200*  THIS PROGRAM IS STARTED BY THE LISTENER AUKCS500.             *00002200
002300*                                                                *00002300
002400*  Note: This program must be compiled with DB2 option on.       *00002400
002500******************************************************************00002500
      ******************************************************************00002600
      * CHANGE DATE: 05/17/2016                                         00002700
      * CHANGE MADE: RECOMPILE FOR SVWS004 AND SVRD022                  00002800
      * MADE BY    : ACCENTURE                   CHANGE# CHG0141575     00002900
003400******************************************************************00003000
PGC   * CHANGE DATE: 09/19/2016                                         00003100
PGC   * CHANGE MADE: CHANGED PROGRAM TO ISSUE PLASTIC GIFT CARDS USING  00003200
PGC   *   ATG. TO DO THIS WE ARE USING FIELD 21 TO COME FROM ATG WITH   00003300
PGC   *   '*PlasticGC'. THIS FIELD WILL ALWAYS BE BLANK EXCEPT WHEN AN  00003400
PGC   *   ISSUE OF A PLASTIC GIFT CARD IS DONE. ALSO A DECLINE MESSAGE  00003500
PGC   *   IS BEING RETURNED WHEN A PLASTIC GIFT CARD ISSUANCE IS        00003600
PGC   *   DECLINED AND THE CARD IS ALREADY ACTIVATED, ACTION CODE = 7,  00003700
PGC   *   ISO RESPONSE CODE = 70. WHEN THE CARD IS DECLINED BECAUSE OF  00003800
PGC   *   AN INCORRECT OR BAD CARD AN ACTION CODE OF 7 AND ISO RESPONSE 00003900
PGC   *   CODE = 71 IS RETURNED TO AJB. CHANGES WERE ALSO MADE IN       00004000
PGC   *   SVPD005 TO SET THE FLAG SV005-PS-NOT-ADD-ON TO TRUE WHEN AN   00004100
PGC   *   ISSUE OF A PLASTIC CARD IS ATTEMPTED AND IT'S ALREADY BEEN    00004200
PGC   *   ISSUED. ALSO HAD TO ADD A SWITCH FOR PLASTIC GIFTCARD IN      00004300
PGC   *   SVWS005.                                                      00004400
PGC   * MADE BY    : BARB SCHULTZ                CHANGE# CHG0149521     00004500
003400******************************************************************00004600
2018  * CHANGE DATE: 09/20/2018                                         00004700
2018  * CHANGE MADE: Mainframe Refactoring - replace CGU042MC with      00004800
2018  *              DPWS036 and CGU040MC with DPPD036.                 00004900
2018  * MADE BY    : Jim Hunter                  CHANGE# CHG0??????     00005000
2018  ******************************************************************00005100
P12431* CHANGE DATE: 28/28/2018                                         00005200
P12431* CHANGE MADE: MODIFIED THE PROGRAM TO HANDLE NEWLY ADDED         00005300
P12431*   ORD_NBR FIELD IN THE SVT TABLES.                              00005400
P12431* MADE BY    : COGNIZANT                   CHANGE# CHG0208643     00005500
P12431******************************************************************00005600
090821* CHANGE DATE: 09/02/2021                                         00005700
090821* CHANGE MADE: MODIFIED THE PROGRAM TO ONLY ALLOCATE VIRTUAL      00005800
090821*   GIFT CARDS (IN ORDER TO AVOID ACCIDENTIALLY ALLOCATING A      00005900
090821*   A VIRTUAL KMC)                                                00006000
090821* MADE BY    : DAN PAYNTER                 CHANGE# CHG0260917     00006100
090821******************************************************************00006200
268131* CHANGE DATE: 03/18/2022                                         00006300
268131* CHANGE MADE: MODIFIED THE PROGRAM TO SEND A HARD DECLINE IF     00006400
268131*   THE ERROR IS AN INVALID PIN.                                  00006500
268131* MADE BY    : BARB SCHULTZ                CHANGE# CHG0268131     00006700
268131******************************************************************00006800
051722* CHANGE DATE: 05/17/2022                                         00006900
051722* CHANGE MADE: LOCK CREDIT CARD BALANCE INQUIRY AND REDEMPTION    00007000
051722*   IF THESHOLD FOR FAILED ATTEMPTS IS MET.                       00007100
051722* MADE BY    : DAN PAYNTER                 CHANGE# CHG0270185     00007200
051722******************************************************************00007300
051722* CHANGE DATE: 02/14/2023                                         00007401
051722* CHANGE MADE: Make call to UPC Check Digit routine dynamic       00007502
051722* MADE BY    : Jean Kurk                   CHANGE# CHG0281369     00007701
051722******************************************************************00007801
003500 ENVIRONMENT DIVISION.                                            00007900
003600******************************************************************00008000
003700                                                                  00008100
003800******************************************************************00008200
003900 DATA DIVISION.                                                   00008300
004000******************************************************************00008400
004100                                                                  00008500
004200 WORKING-STORAGE SECTION.                                         00008600
004300                                                                  00008700
004400*                                                                 00008800
004500*  LISTENER QUEUE NAMES                                           00008900
004600*                                                                 00009000
004700     COPY AUWS001.                                                00010000
004800                                                                  00010900
004900*                                                                 00011000
005000*  RECORD LAYOUT BEING TRANSMITTED FROM THE REQUESTING PLATFORM   00011100
005100*                                                                 00011200
005200     COPY AURD001.                                                00011300
005300                                                                  00013000
005400*                                                                 00013100
005500*  RECORD LAYOUT BEING TRANSMITTED TO THE REQUESTING PLATFORM     00013200
005600*                                                                 00013300
005700     COPY AURD002.                                                00013400
005800*                                                                 00014900
005900*  WORKING-STORAGE VARIABLES REQUIRED FOR THE USE OF THE          00015000
006000*  LOG MESSAGE ROUTING (EPPD000).                                 00015100
006100*                                                                 00015200
006200     COPY EPWS000.                                                00015300
006300                                                                  00031600
006400*                                                                 00031700
006500* STORED VALUE CONSTANTS                                          00031800
006600*                                                                 00031900
006700     COPY SVWS004.                                                00032000
006800                                                                  00088500
006900 01  PS-PROGRAM-SWITCHES.                                         00088600
007000     05  PS-SYSTEM-ERROR-IND     PIC X(1)     VALUE 'N'.          00088700
007100         88  PS-SYSTEM-ERROR-DETECTED         VALUE 'Y'.          00088800
007200         88  PS-NO-SYSTEM-ERROR-DETECTED      VALUE 'N'.          00088900
007300     05  PS-ERROR-TYPE           PIC X(1).                        00089000
007400         88  PS-DB2-ERROR                     VALUE 'D'.          00089100
007500         88  PS-AUTH-MESSAGE-ERROR            VALUE 'M'.          00089200
007600         88  PS-SYSTEM-ERROR                  VALUE 'S'.          00089300
007700     05  PS-TXN-SW               PIC X(1)     VALUE 'N'.          00089400
007800         88  PS-HAVE-TXN                      VALUE 'Y'.          00089500
007900         88  PS-DONT-HAVE-TXN                 VALUE 'N'.          00089600
008000     05  PS-FETCH-SW             PIC X(1)     VALUE 'N'.          00089700
008100         88  PS-FETCH-OK                      VALUE 'Y'.          00089800
008200         88  PS-FETCH-AGAIN                   VALUE 'N'.          00089900
008300     05  PS-FETCH-1ST-CSR-SW     PIC X(1)     VALUE 'N'.          00090000
008400         88  PS-FETCH-1ST-CSR-AGAIN           VALUE 'Y'.          00090100
008500         88  PS-FETCH-1ST-CSR-OFF             VALUE 'N'.          00090200
008600     05  PS-VIRTUAL-UPD-CSR-SW   PIC X(1)     VALUE 'N'.          00090300
008700         88  PS-VIRTUAL-UPD-CSR-AT-END        VALUE 'Y'.          00090400
008800         88  PS-VIRTUAL-UPD-CSR-NOT-AT-END    VALUE 'N'.          00090500
008900     05  PS-VIRTUAL-CSR-AT-END-SW PIC X(1)    VALUE 'N'.          00090600
009000         88  PS-VIRTUAL-CSR-AT-END            VALUE 'Y'.          00090700
009100         88  PS-VIRTUAL-CSR-NOT-AT-END        VALUE 'N'.          00090800
051722     05  PS-FRAUD-PARM-SW         PIC X(1)    VALUE 'N'.          00090900
051722         88  PS-FRAUD-PARM-FOUND              VALUE 'Y'.          00091000
051722         88  PS-FRAUD-PARM-NOT-FOUND          VALUE 'N'.          00091100
051722     05  PS-CARD-FAILED-ATT-SW    PIC X(1)    VALUE 'N'.          00091200
051722         88  PS-CARD-FAILED-FOUND             VALUE 'Y'.          00091300
051722         88  PS-CARD-FAILED-NOT-FOUND         VALUE 'N'.          00091400
051722     05  PS-CRD-FLD-ATT-INS-SW    PIC X(1)    VALUE 'N'.          00091500
051722         88  PS-CRD-FLD-ATT-INSERTED          VALUE 'Y'.          00091600
051722         88  PS-CRD-FLD-ATT-NOT-INSERTED      VALUE 'N'.          00091700
009200                                                                  00091800
009300 01  PC-PROGRAM-CONSTANTS.                                        00091900
009400     05  PC-CURRENT-PROGRAM-NAME PIC X(8)     VALUE 'AUKCS502'.   00092000
009500     05  PC-COMMUNICATIONS-IN-LENGTH                              00092100
009600                                 PIC S9(4)    VALUE +4121         00092200
009700                                 COMP SYNC.                       00092300
051722     05  PC-MAX-SMALLINT         PIC S9(5)    VALUE +32767        00092500
051722                                 COMP SYNC.                       00092600
009800     05  PC-MAXIMUM-RETRY-COUNT  PIC S9(4)    VALUE +2            00092700
009900                                 COMP SYNC.                       00092800
010000     05  PC-ONE                  PIC S9(1)    VALUE  +1.          00092900
010100     05  PC-MINUS-ONE            PIC S9(1)    VALUE -1.           00093000
010200     05  PC-RESP-CODE-1          PIC  9(01)   VALUE 1.            00093100
010300     05  PC-TRNG-KMRC-1000000008 PIC  9(10)   VALUE 1000000008.   00093200
010400     05  PC-TRNG-KMRC-1000000016 PIC  9(10)   VALUE 1000000016.   00093300
010500     05  PC-TRNG-KMRC-1000000024 PIC  9(10)   VALUE 1000000024.   00093400
010600     05  PC-TRNG-KMRC-1000000032 PIC  9(10)   VALUE 1000000032.   00093500
010700     05  PC-TRNG-KMRC-1000000040 PIC  9(10)   VALUE 1000000040.   00093600
010800     05  PC-TRNG-KMRC-1000000057 PIC  9(10)   VALUE 1000000057.   00093700
010900     05  PC-TRNG-KMRC-1000000065 PIC  9(10)   VALUE 1000000065.   00093800
011000     05  PC-TRNG-KMRC-1000000149 PIC  9(10)   VALUE 1000000149.   00093900
011100     05  PC-TRNG-KMRC-1000000420 PIC  9(10)   VALUE 1000000420.   00094000
011200     05  PC-TRNG-KMRC-101000000006 PIC 9(12) VALUE 101000000006.  00094100
011210     05  PC-TRNG-KMRC-101000000014 PIC 9(12) VALUE 101000000014.  00094200
011220     05  PC-TRNG-KMRC-101000000022 PIC 9(12) VALUE 101000000022.  00094300
011230     05  PC-TRNG-KMRC-101000000030 PIC 9(12) VALUE 101000000030.  00094400
011240     05  PC-TRNG-KMRC-101000000048 PIC 9(12) VALUE 101000000048.  00094500
011250     05  PC-TRNG-KMRC-101000000055 PIC 9(12) VALUE 101000000055.  00094600
011260     05  PC-TRNG-KMRC-101000000063 PIC 9(12) VALUE 101000000063.  00094700
011270     05  PC-TRNG-KMRC-101000000147 PIC 9(12) VALUE 101000000147.  00094800
011280     05  PC-TRNG-KMRC-101000000428 PIC 9(12) VALUE 101000000428.  00094900
011291                                                                  00095000
011300     05  PC-TRNG-GIFT-1000000164 PIC  9(10)   VALUE 1000000164.   00095100
011400     05  PC-TRNG-GIFT-1000000172 PIC  9(10)   VALUE 1000000172.   00095200
011500     05  PC-TRNG-GIFT-1000000180 PIC  9(10)   VALUE 1000000180.   00095300
011600     05  PC-TRNG-GIFT-1000000198 PIC  9(10)   VALUE 1000000198.   00095400
011700     05  PC-TRNG-GIFT-1000000206 PIC  9(10)   VALUE 1000000206.   00095500
011800     05  PC-TRNG-GIFT-1000000214 PIC  9(10)   VALUE 1000000214.   00095600
011900     05  PC-TRNG-GIFT-1000000222 PIC  9(10)   VALUE 1000000222.   00095700
012000     05  PC-TRNG-GIFT-1000000230 PIC  9(10)   VALUE 1000000230.   00095800
012100     05  PC-TRNG-GIFT-1000000248 PIC  9(10)   VALUE 1000000248.   00095900
012200     05  PC-TRNG-GIFT-1000000255 PIC  9(10)   VALUE 1000000255.   00096000
012300     05  PC-TRNG-GIFT-1000000263 PIC  9(10)   VALUE 1000000263.   00096100
012400     05  PC-TRNG-GIFT-1000000271 PIC  9(10)   VALUE 1000000271.   00096200
012500     05  PC-TRNG-GIFT-1000000438 PIC  9(10)   VALUE 1000000438.   00096300
012600     05  PC-TRNG-GIFT-101000000162 PIC 9(12) VALUE 101000000162.  00096400
012610     05  PC-TRNG-GIFT-101000000170 PIC 9(12) VALUE 101000000170.  00096500
012620     05  PC-TRNG-GIFT-101000000188 PIC 9(12) VALUE 101000000188.  00096600
012621     05  PC-TRNG-GIFT-101000000196 PIC 9(12) VALUE 101000000196.  00096700
012622     05  PC-TRNG-GIFT-101000000204 PIC 9(12) VALUE 101000000204.  00096800
012623     05  PC-TRNG-GIFT-101000000212 PIC 9(12) VALUE 101000000212.  00096900
012624     05  PC-TRNG-GIFT-101000000220 PIC 9(12) VALUE 101000000220.  00097000
012630     05  PC-TRNG-GIFT-101000000238 PIC 9(12) VALUE 101000000238.  00097100
012640     05  PC-TRNG-GIFT-101000000246 PIC 9(12) VALUE 101000000246.  00097200
012650     05  PC-TRNG-GIFT-101000000253 PIC 9(12) VALUE 101000000253.  00097300
012660     05  PC-TRNG-GIFT-101000000261 PIC 9(12) VALUE 101000000261.  00097400
012670     05  PC-TRNG-GIFT-101000000279 PIC 9(12) VALUE 101000000279.  00097500
012680     05  PC-TRNG-GIFT-101000000436 PIC 9(12) VALUE 101000000436.  00097600
012691                                                                  00097700
012700     05  PC-TEST-KMRC-1000000073 PIC  9(10)   VALUE 1000000073.   00097800
012800     05  PC-TEST-KMRC-1000000081 PIC  9(10)   VALUE 1000000081.   00097900
012900     05  PC-TEST-KMRC-1000000099 PIC  9(10)   VALUE 1000000099.   00098000
013000     05  PC-TEST-KMRC-1000000107 PIC  9(10)   VALUE 1000000107.   00098100
013100     05  PC-TEST-KMRC-1000000115 PIC  9(10)   VALUE 1000000115.   00098200
013200     05  PC-TEST-KMRC-1000000123 PIC  9(10)   VALUE 1000000123.   00098300
013300     05  PC-TEST-KMRC-1000000131 PIC  9(10)   VALUE 1000000131.   00098400
013400     05  PC-TEST-KMRC-1000000156 PIC  9(10)   VALUE 1000000156.   00098500
013500     05  PC-TEST-KMRC-1000000404 PIC  9(10)   VALUE 1000000404.   00098600
013610     05  PC-TEST-KMRC-101000000071 PIC 9(12) VALUE 101000000071.  00098700
013620     05  PC-TEST-KMRC-101000000089 PIC 9(12) VALUE 101000000089.  00098800
013630     05  PC-TEST-KMRC-101000000097 PIC 9(12) VALUE 101000000097.  00098900
013640     05  PC-TEST-KMRC-101000000105 PIC 9(12) VALUE 101000000105.  00099000
013650     05  PC-TEST-KMRC-101000000113 PIC 9(12) VALUE 101000000113.  00099100
013660     05  PC-TEST-KMRC-101000000121 PIC 9(12) VALUE 101000000121.  00099200
013670     05  PC-TEST-KMRC-101000000139 PIC 9(12) VALUE 101000000139.  00099300
013680     05  PC-TEST-KMRC-101000000154 PIC 9(12) VALUE 101000000154.  00099400
013690     05  PC-TEST-KMRC-101000000402 PIC 9(12) VALUE 101000000402.  00099500
013691                                                                  00099600
013700     05  PC-TEST-GIFT-1000000289 PIC  9(10)   VALUE 1000000289.   00099700
013800     05  PC-TEST-GIFT-1000000297 PIC  9(10)   VALUE 1000000297.   00099800
013900     05  PC-TEST-GIFT-1000000305 PIC  9(10)   VALUE 1000000305.   00099900
014000     05  PC-TEST-GIFT-1000000313 PIC  9(10)   VALUE 1000000313.   00100000
014100     05  PC-TEST-GIFT-1000000321 PIC  9(10)   VALUE 1000000321.   00100100
014200     05  PC-TEST-GIFT-1000000339 PIC  9(10)   VALUE 1000000339.   00100200
014300     05  PC-TEST-GIFT-1000000347 PIC  9(10)   VALUE 1000000347.   00100300
014400     05  PC-TEST-GIFT-1000000354 PIC  9(10)   VALUE 1000000354.   00100400
014500     05  PC-TEST-GIFT-1000000362 PIC  9(10)   VALUE 1000000362.   00100500
014600     05  PC-TEST-GIFT-1000000370 PIC  9(10)   VALUE 1000000370.   00100600
014700     05  PC-TEST-GIFT-1000000388 PIC  9(10)   VALUE 1000000388.   00100700
014800     05  PC-TEST-GIFT-1000000396 PIC  9(10)   VALUE 1000000396.   00100800
014900     05  PC-TEST-GIFT-1000000412 PIC  9(10)   VALUE 1000000412.   00100900
014983     05  PC-TEST-GIFT-101000000287 PIC 9(12) VALUE 101000000287.  00101000
014984     05  PC-TEST-GIFT-101000000295 PIC 9(12) VALUE 101000000295.  00101100
014985     05  PC-TEST-GIFT-101000000303 PIC 9(12) VALUE 101000000303.  00101200
014986     05  PC-TEST-GIFT-101000000311 PIC 9(12) VALUE 101000000311.  00101300
014987     05  PC-TEST-GIFT-101000000329 PIC 9(12) VALUE 101000000329.  00101400
014988     05  PC-TEST-GIFT-101000000337 PIC 9(12) VALUE 101000000337.  00101500
014989     05  PC-TEST-GIFT-101000000345 PIC 9(12) VALUE 101000000345.  00101600
014990     05  PC-TEST-GIFT-101000000352 PIC 9(12) VALUE 101000000352.  00101700
014991     05  PC-TEST-GIFT-101000000360 PIC 9(12) VALUE 101000000360.  00101800
014992     05  PC-TEST-GIFT-101000000378 PIC 9(12) VALUE 101000000378.  00101900
014993     05  PC-TEST-GIFT-101000000386 PIC 9(12) VALUE 101000000386.  00102000
014994     05  PC-TEST-GIFT-101000000394 PIC 9(12) VALUE 101000000394.  00102100
014995     05  PC-TEST-GIFT-101000000410 PIC 9(12) VALUE 101000000410.  00102200
015000     05  PC-TWO-DOLLARS          PIC  9V99    VALUE 2.00.         00102300
015100     05  PC-MAX-FIELDS           PIC 9(3)     VALUE 150.          00102400
015200     05  PC-DEFAULT-SPACE        PIC  X(01)   VALUE SPACES.       00102500
015300*                                                                 00102600
015400                                                                  00102700
015500 01  PV-PROGRAM-VARIABLES.                                        00102800
015600     05  PV-CICS-RESPONSE        PIC S9(9)    VALUE ZERO          00102900
015700                                 COMP SYNC.                       00103000
015800     05  PV-CICS-RESPONSE-DISP   PIC ZZZZZ9999-.                  00103100
015900     05  PV-RETRY-COUNT          PIC S9(4)         VALUE ZERO     00103200
016000                                 COMP SYNC.                       00103300
P12431     05  PV-ORD-NBR-NULL-IND     PIC S9(04)  COMP  VALUE ZERO.    00103400
P12431     05  PV-SPACE-COUNT          PIC S9(04) VALUE +0 COMP SYNC.   00103500
P12431     05  PV-ZERO-COUNT           PIC S9(04) VALUE +0 COMP SYNC.   00103600
P12431     05  PV-OPRT-ID-LEN          PIC S9(04) VALUE +0 COMP SYNC.   00103700
016100     05  PV-DRIVERS-LICENSE-NBR                                   00103800
016200                                 PIC X(21)         VALUE SPACES.  00103900
016300     05  PV-KMC-AMT              PIC 9(7)V99 COMP-3 VALUE ZERO.   00104000
016310     05  PV-CARD-NUMBER-30.                                       00104100
016320         10  PV-UPC-11-30        PIC 9(11)         VALUE ZERO.    00104200
016321         10  PV-BIN-6-30         PIC 9(06)         VALUE ZERO.    00104300
016322         10  PV-CARD-TYPE-1-30   PIC 9(01)         VALUE ZERO.    00104400
016330         10  PV-CARD-NBR-12-30   PIC 9(12)         VALUE ZERO.    00104500
PGC        05  PV-KMC-ID-COMP          PIC  S9(12)V COMP-3.             00104600
016400     05  PV-KMC-ID               PIC  9(12)        VALUE 0.       00104700
016500         88 PV-TRAINING-KMRC-ACCOUNTS              VALUE          00104800
016600         1000000008, 1000000016, 1000000024, 1000000032,          00104900
016700         1000000040, 1000000057, 1000000065, 1000000149,          00105000
016800         1000000420,                                              00105100
016810         101000000006, 101000000014, 101000000022, 101000000030,  00105200
016820         101000000048, 101000000055, 101000000063, 101000000147,  00105300
016830         101000000428.                                            00105400
016900         88 PV-TRAINING-GIFT-CARD-ACCOUNTS         VALUE          00105500
017000         1000000164, 1000000172, 1000000180, 1000000198,          00105600
017100         1000000206, 1000000214, 1000000222, 1000000230,          00105700
017200         1000000248, 1000000255, 1000000263, 1000000271,          00105800
017300         1000000438,                                              00105900
017310         101000000162, 101000000170, 101000000188, 101000000196,  00106000
017320         101000000204, 101000000212, 101000000220, 101000000238,  00106100
017330         101000000246, 101000000253, 101000000261, 101000000279,  00106200
017340         101000000436.                                            00106300
017400         88 PV-TEST-KMRC-ACCOUNTS                  VALUE          00106400
017500         1000000073, 1000000081, 1000000099, 1000000107,          00106500
017600         1000000115, 1000000123, 1000000131, 1000000156,          00106600
017700         1999123456, 1000000404,                                  00106700
017710         101000000071, 101000000089, 101000000097, 101000000105,  00106800
017720         101000000113, 101000000121, 101000000139, 101000000154,  00106900
017730         101999123454, 101000000402.                              00107000
017800         88 PV-TEST-GIFT-CARD-ACCOUNTS             VALUE          00107100
017900         1000000289, 1000000297, 1000000305, 1000000313,          00107200
018000         1000000321, 1000000339, 1000000347, 1000000354,          00107300
018100         1000000362, 1000000370, 1000000388, 1000000396,          00107400
018200         1000000412,                                              00107500
018210         101000000287, 101000000295, 101000000303, 101000000311,  00107600
018220         101000000329, 101000000337, 101000000345, 101000000352,  00107700
018230         101000000360, 101000000378, 101000000386, 101000000394,  00107800
018240         101000000410.                                            00107900
019000                                                                  00108000
018300     05  PV-REFERRAL-CODE-NUMBER PIC 9(1)  VALUE ZERO.            00108100
018400         88  PV-SUCCESSFUL-AUTHORIZATION      VALUE ZERO.         00108200
018500         88  PV-EDIT-ERROR                    VALUE 2.            00108300
018600         88  PV-INVALID-PIN                   VALUE 6.            00108400
018700         88  PV-CODE-HARD-DECLINE             VALUE 7.            00108500
018800         88  PV-REFERRAL-CODE                 VALUE 8.            00108600
018900         88  PV-SYSTEM-ERROR-REFERRAL-CODE    VALUE 9.            00108700
019000                                                                  00108800
PGC        05  PV-DECLINE-REASON    PIC  X(02)      VALUE '00'.         00108900
PGC            88  PV-CARD-ALREADY-ACTIVE  VALUE  '70'.                 00109000
PGC            88  PV-CARD-NOT-ACTIVE      VALUE  '71'.                 00109100
PGC            88  PV-CARD-ALREADY-CLOSED  VALUE  '72'.                 00109200
PGC            88  PV-OVER-MAX-BALANCE     VALUE  '73'.                 00109300
PGC            88  PV-INVALID-ACTIVATE     VALUE  '74'.                 00109400
PGC            88  PV-PIN-INVALID          VALUE  '75'.                 00109500
PGC                                                                     00109600
PGC        05 PV-ISSUE-SW           PIC X(01)    VALUE 'Y'.             00109700
PGC            88  PV-ISSUE-ALREADY-DONE VALUE 'Y'.                     00109800
PGC            88  PV-NO-ISSUE-DONE      VALUE 'N'.                     00109900
PGC        05 PV-VIRTUAL-CARD-SW  PIC X(01)    VALUE 'Y'.               00110000
PGC            88  PV-VIRTUAL          VALUE  'Y'.                      00110100
PGC            88  PV-PLASTIC-CARD     VALUE  'N'.                      00110200
PGC            88  PV-KMC              VALUE  'K'.                      00110300
PGC            88  PV-OAKMC            VALUE  'O'.                      00110400
PGC            88  PV-FILAKMC          VALUE  'F'.                      00110500
PGC        05 PV-PLASTIC-SW  PIC X(01)    VALUE 'N'.                    00110600
PGC            88  PV-PLASTIC          VALUE 'Y'.                       00110700
PGC            88  PV-NOT-PLASTIC      VALUE 'N'.                       00110800
PGC                                                                     00110900
PGC        05 PV-REQUEST-TYPE-DIS   PIC  9(1) VALUE 0.                  00111000
019100     05 PV-REQUEST-TYPE-INFO.                                     00111100
019200        10 PV-REVERSAL-IND       PIC S9(1) COMP-3.                00111200
019300           88 PV-NORMAL          VALUE  0.                        00111300
019400           88 PV-REVERSAL        VALUE  1.                        00111400
019400           88 PV-REAUTH          VALUE  2.                        00111500
019400           88 PV-REVERSAL-REAUTH VALUE  3.                        00111600
019510        10 PV-REQUEST-TYPE       PIC S9(1) COMP-3.                00111700
019600           88 PV-BALANCE-INQUIRY       VALUE 0.                   00111800
019700           88 PV-ISSUANCE-AS-KMRC      VALUE 1.                   00111900
019800           88 PV-ISSUANCE-AS-GIFT-CARD VALUE 2.                   00112000
019900           88 PV-TENDER                VALUE 3.                   00112100
020000           88 PV-INVALID-REQUEST-TYPE  VALUE 9.                   00112200
020100     05 PV-SCAN-SOURCE-CODE      PIC X(02).                       00112300
020200        88  PV-KMC-KEY-ENTERED                VALUE '00'.         00112400
P12431     05 PV-OPERATOR-ID           PIC X(40).                       00112500
020400     05 PV-APPROVAL-NBR          PIC 9(6).                        00112600
020500     05 PV-DISPLAY-ACCT-LENGTH   PIC  9(3).                       00112700
020600     05  PV-TSQ-DATA-RECORD.                                      00112800
020700         10  PV-TSQ-DATA-PORTION         PIC X(4120) VALUE SPACE. 00112900
020800                                                                  00113000
020900     05  PV-ITEM-NBR                     PIC S9(04)  VALUE ZEROS  00113100
021000                                                     COMP SYNC.   00113200
021100     05  PV-TSQ-LENGTH                   PIC S9(04)  VALUE ZEROS  00113300
021200                                                     COMP SYNC.   00113400
021300     05  PV-TSQ-NAME                     PIC  X(08)  VALUE SPACES.00113500
021400                                                                  00113600
021500     05  PV-TCPIPPRQ-RECORD1.                                     00113700
021600         10  PV-NEXT-RECORD              PIC  9(08)  VALUE ZEROS. 00113800
021700         10  PV-TOTAL-RECORDS            PIC  9(08)  VALUE ZEROS. 00113900
021800         10  FILLER                      PIC X(4104) VALUE SPACES.00114000
021900                                                                  00114100
022000     05  PV-CHAR-AMT                     PIC X(9)    VALUE SPACES.00114200
022100     05  PV-CTR                          PIC 9(3)    VALUE ZERO.  00114300
022200     05  PV-CTR2                         PIC 9(3)    VALUE ZERO.  00114400
022300     05  PV-LAST-ISUD-CNTL-NBR      PIC  S9(9) COMP.              00114500
022310     05  PV-LAST-ISUD-CNTL-NBR-D    PIC   9(9).                   00114600
022400     05  PV-CRD-PROD-YR             PIC  S9(4) COMP  VALUE 0.     00114700
022410     05  PV-CRD-PROD-YR-D           PIC   9(4)       VALUE 0.     00114800
022420     05  PV-CRD-NBR-D               PIC   9(12)      VALUE 0.     00114900
022500     05  PV-SHIPT-REQ-NBR           PIC  S9(4) COMP  VALUE 0.     00115000
022510     05  PV-SHIPT-REQ-NBR-D         PIC   9(4)       VALUE 0.     00115100
022600     05  PV-E-BUS-IND                    PIC X(1)    VALUE 'N'.   00115200
022700         88  PV-E-ECOMMERCE-STORE             VALUE 'Y'.          00115300
022800         88  PV-E-NON-ECOMM-STORE             VALUE 'N'.          00115400
022900     05  PV-WS-CTR                       PIC 9(04)   VALUE ZEROS. 00115500
PGC        05  PV-SAVE-WS-CTR                  PIC 9(04)   VALUE ZEROS. 00115600
023000     05  PV-MSG-LEN-WHDR                 PIC 9(04)   VALUE ZEROS. 00115700
023100     05  PV-MSG-LEN-WOHDR                PIC 9(04)   VALUE ZEROS. 00115800
023200     05  PV-TOTAL-NO-FIELDS              PIC 9(04)   VALUE ZEROS. 00115900
023300     05  PV-HEX-BINARY                   PIC 9(04) BINARY.        00116000
023400     05  PV-HEX-CHAR REDEFINES PV-HEX-BINARY.                     00116100
023500         10  PV-HEX-LENGTH               PIC X(02).               00116200
023600     05  PV-GIFT-CRD-NBR-FULL.                                    00116300
023700         10  PV-GIFT-CRD-PREFIX      PIC  9(02) VALUE 20.         00116400
023800         10  PV-GIFT-CRD-NBR         PIC  9(10) VALUE ZEROES.     00116500
023900         10  PV-GIFT-CRD-CHECK-DIGIT PIC  9(01) VALUE ZERO.       00116600
024000     05  PV-GIFT-CRD-NBR-N                                        00116700
024100                       REDEFINES  PV-GIFT-CRD-NBR-FULL            00116800
024200                                     PIC  9(13).                  00116900
024300                                                                  00117000
024400 01  PV-SYSTEM-ID.                                                00117100
024500     05  PV-CICS-REGION         PIC  X(06)  VALUE SPACE.          00117200
024600     05  FILLER                 PIC  X(02)  VALUE SPACE.          00117300
024700                                                                  00117400
024800*---------------------------------------------------------        00117500
024900* AUTHORIZATION MESSAGE DETAIL FIELDS                             00117600
025000* THIS TABLE WILL HOLD THE AUTHORIZATION MESSAGE.                 00117700
025100* MESSAGE CAN BE UP TO 150 FIELDS OF 50 BYTES EACH.               00117800
025200*---------------------------------------------------------        00117900
025300 01  PT-AUTH-MESSAGE.                                             00118000
025400     05  PT-AUTH-FIELD             OCCURS 150 TIMES               00118100
025500                                   PIC X(50)      VALUE SPACES.   00118200
025600     05  PT-AUTH-INDEX             PIC 9(3)       VALUE ZERO.     00118300
025700*---------------------------------------------------------*       00118400
025800* NETCOOL ERROR MESSAGES DISPLAYED IN CSSL                        00118500
025900*---------------------------------------------------------*       00118600
026000 01  PE-PROGRAM-ERROR-MESSAGES.                                   00118700
026100   05  PE-NETCOOL-ALERT-TO-BE-WRITTEN.                            00118800
026200     10  FILLER                              PIC  X(016)          00118900
026300           VALUE '!NETCOOL ALERT- '.                              00119000
026400     10  PE-IS003-SUMMARY                    PIC  X(255)          00119100
026500                                              VALUE SPACES.       00119200
026600*---------------------------------------------------------*       00119300
026700* NETCOOL MESSAGE COPYBOOK                                        00119400
026800*---------------------------------------------------------*       00119500
026900     COPY ISWS003.                                                00120000
027000*---------------------------------------------------------        00122400
027100* FIPAY FIELDS - SEE AJB FIPAY 100 FORMAT SPEC FOR MORE INFO      00122500
027200*---------------------------------------------------------        00122600
027300 01  FI-FIPAY-FIELDS.                                             00122700
027400     05  FI-01-TRAN-TYPE           PIC X(3)       VALUE '101'.    00122800
027500     05  FI-04-ACTION-CDE          PIC X(1)       VALUE SPACES.   00122900
027600     05  FI-08-STORE-NO            PIC 9(4)       VALUE ZEROS.    00123000
027700     05  FI-09-TERM-NO             PIC 9(4)       VALUE ZEROS.    00123100
027800             88  FI-TRAINING-REGISTER         VALUE 196,          00123200
027900                                                    197,          00123300
028000                                                    198,          00123400
028100                                                    199.          00123500
028200     05  FI-10-TRAN-TYPE           PIC X(15)      VALUE SPACES.   00123600
028300         88 FI-PV-BAL-INQ                         VALUE           00123700
028400         'BALANCEINQUIRY'.                                        00123800
028500         88 FI-PV-BAL-INQ-ADD-ON                  VALUE           00123900
028600         'BALINQADDON   '.                                        00124000
028700         88 FI-PV-SALE                            VALUE           00124100
028800         'SALE', 'VOIDSALE'.                                      00124200
028900         88 FI-PV-REFUND                          VALUE           00124300
029000         'REFUND', 'VOIDREFUND'.                                  00124400
029100         88 FI-PV-ISSUE                           VALUE           00124500
029200         'ISSUE', 'VOIDISSUE'.                                    00124600
030600         88 FI-PV-REAUTH                          VALUE           00124700
030600         'TENDERREAUTH', 'REAUTH'.                                00124800
030600         88 FI-PV-REVERSAL-REAUTH                 VALUE           00124900
030600         'REVERSALREAUTH '.                                       00125000
029300     05  FILLER                    REDEFINES FI-10-TRAN-TYPE.     00125100
029400         10 FI-PV-10-REVERSAL-IND  PIC X(4).                      00125200
029500            88 FI-PV-10-REVERSAL   VALUE 'VOID'.                  00125300
029600         10 FILLER                 PIC X(11).                     00125400
029700     05  FI-13-ACCT-NO-KEY         PIC X(30)      VALUE SPACES.   00125500
029800     05  FI-15-ACCT-NO-SWP         PIC X(30)      VALUE SPACES.   00125600
029900     05  FI-16-AMOUNT              PIC 9(9)       VALUE ZEROS.    00125700
030000     05  FI-17-TRAN-NO             PIC 9(4)       VALUE ZEROS.    00125800
030100     05  FI-21-CARD-TYPE           PIC X(15)      VALUE SPACES.   00125900
030200         88 FI-21-GIFT-CARD                       VALUE           00126000
030300         '*type GiftCard'.                                        00126100
030400         88 FI-21-KMRC                            VALUE           00126200
030500         '*type KMRC'.                                            00126300
PGC            88 FI-21-PLASTIC                         VALUE           00126400
PGC            '*PlasticGC'.                                            00126500
PGC            88 FI-21-VIRTUAL                         VALUE           00126600
PGC            '              '.                                        00126700
P12431     05  FI-24-OPERATOR-ID         PIC X(40)      VALUE ZERO.     00126800
030700     05  FI-28-STATE-ID            PIC X(2)       VALUE SPACES.   00126900
030800     05  FI-29-DRIVERS-LIC-NO      PIC X(30)      VALUE SPACES.   00127000
030900     05  FI-37-AUTH-CODE           PIC 9(6)       VALUE ZEROS.    00127100
031000     05  FI-38-DISPLAY             PIC X(30)      VALUE SPACES.   00127200
031100         88 FI-38-DECLINE                         VALUE           00127300
031200         'DECLINE'.                                               00127400
031300         88 FI-38-APPROVE                         VALUE           00127500
031400         'APPROVE'.                                               00127600
031500         88 FI-38-REFER                           VALUE           00127700
031600         'REFER'.                                                 00127800
031700         88 FI-38-INVALID-PIN                     VALUE           00127900
031800         'INVALID PIN'.                                           00128000
031900         88 FI-38-OFFLINE                         VALUE           00128100
032000         'OFFLINE'.                                               00128200
032100         88 FI-38-EDIT-ERROR                      VALUE           00128300
032200         'EDITERROR'.                                             00128400
032300     05  FI-50-POS-DATE.                                          00128500
032400         10 FI-50-POS-DATE-MM      PIC 9(2)       VALUE ZEROS.    00128600
032500         10 FI-50-POS-DATE-DD      PIC 9(2)       VALUE ZEROS.    00128700
032600         10 FI-50-POS-DATE-YYYY    PIC 9(4)       VALUE ZEROS.    00128800
032700     05  FI-52-BALANCE             PIC 9(9)       VALUE ZEROS.    00128900
PGC        05  FI-53-ISO-RESP            PIC X(2)       VALUE SPACES.   00129000
032900     05  FI-85-PIN                 PIC S9(4)      VALUE ZEROS.    00129100
033000*---------------------------------------------------------        00129200
033100 01  LM-LOG-MESSAGE.                                              00129300
033200     05  LM-MESSAGE-NUMBER            PIC X(02) VALUE '99'.       00129400
033300     05  LM-LOG-DISPLAY-MESSAGE.                                  00129500
033400         10  LM-DM-AUTH-TYPE          PIC X(3)  VALUE 'SV '.      00129600
033500         10  FILLER                   PIC X(3)  VALUE SPACES.     00129700
033600             88  LM-DM-REQ                      VALUE 'REQ'.      00129800
033700             88  LM-DM-RSP                      VALUE 'RSP'.      00129900
051722             88  LM-DM-BLK                      VALUE 'BLK'.      00130000
033800         10  FILLER                   PIC X(1)  VALUE SPACES.     00130100
033900         10  FILLER                   PIC X(3)  VALUE SPACES.     00130200
034000             88  LM-DM-BALINQ                   VALUE 'BAL'.      00130300
034100             88  LM-DM-TENDER                   VALUE 'TND'.      00130400
034200             88  LM-DM-ISSUE                    VALUE 'ISS'.      00130500
034300             88  LM-DM-UNKNOWN                  VALUE '???'.      00130600
034400             88  LM-DM-VOID-ISSUE               VALUE 'VIS'.      00130700
034500             88  LM-DM-VOID-TENDER              VALUE 'VTN'.      00130800
034500             88  LM-DM-REAUTH                   VALUE 'RAU'.      00130900
034500             88  LM-DM-REVERSAL-REAUTH          VALUE 'RRA'.      00131000
034600         10  FILLER                   PIC X(1)  VALUE SPACES.     00131100
034700         10  FILLER                   PIC X(3)  VALUE SPACES.     00131200
034800             88  LM-DM-KMRC-MSG                 VALUE 'KC '.      00131300
034900             88  LM-DM-GC-MSG                   VALUE 'GC '.      00131400
035000             88  LM-DM-REQUEST-MSG              VALUE SPACES.     00131500
035100         10  FILLER                   PIC X(3)  VALUE SPACES.     00131600
035200             88  LM-DM-RC-DISPLAY               VALUE 'RC:'.      00131700
035300         10  LM-DM-RESP-CD            PIC X(1)  VALUE SPACES.     00131800
035400         10  FILLER                   PIC X(1)  VALUE SPACES.     00131900
035500         10  LM-DM-STORE-NBR          PIC X(4)  VALUE SPACES.     00132000
035600         10  FILLER                   PIC X(1)  VALUE '/'.        00132100
035700         10  LM-DM-TERM-NBR           PIC X(4)  VALUE SPACES.     00132200
035800         10  FILLER                   PIC X(1)  VALUE '/'.        00132300
035900         10  LM-DM-TRAN-NBR           PIC X(4)  VALUE SPACES.     00132400
036000         10  FILLER                   PIC X(1)  VALUE SPACES.     00132500
036100         10  LM-DM-ACCOUNT-NBR        PIC X(12) VALUE SPACES.     00132600
036200         10  FILLER                   PIC X(8)  VALUE             00132700
036300                                                ' TRNAMT='.       00132800
036400         10  LM-DM-TRAN-AMOUNT       PIC -Z(3)9.99 VALUE ZERO.    00132900
036500         10  FILLER                   PIC X(10)  VALUE            00133000
036600                                                ' APRVAMT='.      00133100
036700         10  LM-DM-APPROVE-AMOUNT    PIC -Z(3)9.99 VALUE ZERO.    00133200
036800         10  FILLER                   PIC X(5)  VALUE             00133300
036900                                                ' BAL='.          00133400
037000         10  LM-DM-BALANCE           PIC -Z(3)9.99 VALUE ZERO.    00133500
037100                                                                  00133600
037200 01  FW-FIELD-WORK-AREA.                                          00133700
037300     05  FW-DRIVERS-LICENSE-NUMBER                                00133800
037400                                 PIC X(21) VALUE SPACES.          00133900
037500     05  FW-KMC-ID-INT           PIC 9(30) VALUE ZEROES.          00134000
037600                                                                  00134100
037700 01  CD-CURRENT-DATE-AREA.                                        00134200
037800     05  CD-CURRENT-DATE-YYYYMMDD-X.                              00134300
037900         10  CD-CURRENT-YEAR     PIC 9(4)     VALUE ZERO.         00134400
038000         10  CD-CURRENT-MONTH    PIC 9(2)     VALUE ZERO.         00134500
038100         10  CD-CURRENT-DAY      PIC 9(2)     VALUE ZERO.         00134600
038200     05  CD-DB2-DATE-FORMAT.                                      00134700
038300         10  CD-YYYY             PIC 9(4)     VALUE ZEROS.        00134800
038400         10  FILLER              PIC X(1)     VALUE '-'.          00134900
038500         10  CD-MM               PIC 9(2)     VALUE ZEROS.        00135000
038600         10  FILLER              PIC X(1)     VALUE '-'.          00135100
038700         10  CD-DD               PIC 9(2)     VALUE ZEROS.        00135200
038800                                                                  00135300
038900                                                                  00135400
039000 01  AM-AUTH-MESSAGE-ERROR-MESSAGE.                               00136100
039100     05  FILLER                  PIC X(21)    VALUE               00136200
039200         'AUTHORIZATION MSG = ('.                                 00136300
039300     05  AM-POS-INQ-REMOTE-AUTH-MSG                               00136400
039400                                 PIC X(85)    VALUE SPACES.       00136500
039500     05  FILLER                  PIC X(1)     VALUE ')'.          00136600
039600                                                                  00136700
039700 01  DE-DB2-ERROR-MESSAGE.                                        00136800
039800     05  FILLER                  PIC X(11)    VALUE               00136900
039900         'SQLCODE = ('.                                           00137000
040000     05  DE-SQLCODE              PIC Z(8)9-   VALUE ZERO.         00137100
040100     05  FILLER                  PIC X(21)    VALUE               00137200
040200         ')  ROWS PROCESSED = ('.                                 00137300
040300     05  DE-ROWS-PROCESSED       PIC Z(8)9-   VALUE ZERO.         00137400
040400     05  FILLER                  PIC X(25)    VALUE ')'.          00137500
040500                                                                  00137600
040600 01  DW-DB2-WARNING-MESSAGE.                                      00137700
040700     05  FILLER                  PIC X(11)    VALUE               00137800
040800         'SQLCODE = ('.                                           00137900
040900     05  DW-SQLCODE              PIC Z(8)9-   VALUE ZERO.         00138000
041000     05  FILLER                  PIC X(21)    VALUE               00138100
041100         ')  ROWS PROCESSED = ('.                                 00138200
041200     05  DW-ROWS-PROCESSED       PIC Z(8)9-   VALUE ZERO.         00138300
041300     05  FILLER                  PIC X(14)    VALUE               00138400
041400         ')  SQLWARN = ('.                                        00138500
041500     05  DW-SQLWARN              PIC X(8)     VALUE ZERO.         00138600
041600     05  FILLER                  PIC X(3)     VALUE ')'.          00138700
041700                                                                  00138800
051722 01  DB-DB2-ERROR-MESSAGE.                                        00138900
051722     05  FILLER                  PIC X(11)    VALUE               00139000
051722         'SQLCODE = ('.                                           00139100
051722     05  DB-SQLCODE              PIC Z(8)9-   VALUE ZERO.         00139200
051722     05  FILLER                  PIC X(20)    VALUE               00139300
051722         ')  DEFAULT COUNT OF '.                                  00139400
051722     05  DB-FRAUD-COUNTER        PIC Z(8)9-   VALUE ZERO.         00139500
051722     05  FILLER                  PIC X(21)    VALUE               00139600
051722         ' USED.               '.                                 00139700
051722                                                                  00139900
041800 01  DS-DB2-SQLERRMC-MESSAGE.                                     00140000
041900     05  FILLER                  PIC X(11)    VALUE               00140100
042000         'SQLERRMC = '.                                           00140200
042100     05  DS-SQLERRMC             PIC X(66)    VALUE SPACES.       00140300
042200                                                                  00140400
042300 01  AA-ATTEMPTED-ACTION-MESSAGE.                                 00140500
042400     05  FILLER                  PIC X(14)    VALUE               00140600
042500         'ATTEMPTING TO '.                                        00140700
042600     05  AA-ATTEMPTED-ACTION.                                     00140800
042700         10 AA-ATTEMPTED-ACT     PIC X(80)    VALUE SPACES.       00140900
042800         10 AA-ATTEMPTED-CRD     PIC X(10)    VALUE SPACES.       00141000
042900     05  AA-ATTEMPTED-ACTION-R REDEFINES AA-ATTEMPTED-ACTION.     00141100
043000         10 AA-ATTEMPTED-ACTI    PIC X(80).                       00141200
043100         10 AA-ATTEMPTED-YR      PIC X(04).                       00141300
043200         10 AA-ATTEMPTED-SHIP    PIC X(06).                       00141400
043300                                                                  00141500
043400*                                                                 00141600
043500*  STORED VALUE CONTROL TABLE                                     00141700
043600*                                                                 00141800
043700                                                                  00141900
043800     EXEC SQL                                                     00142000
043900         INCLUDE SVT00000                                         00143000
044000     END-EXEC.                                                    00144700
044100*                                                                 00144800
044200*  STORED VALUE CARD TABLE                                        00144900
044300*                                                                 00145000
044400                                                                  00145100
044500     EXEC SQL                                                     00145200
044600         INCLUDE SVT00001                                         00145300
044700     END-EXEC.                                                    00150700
044800*                                                                 00150800
044900*  SQL AND COBOL DECLARATIONS FOR THE STORED VALUE ACTIVITY TABLE 00150900
045000*                                                                 00151000
045100                                                                  00151100
045200     EXEC SQL                                                     00151200
045300         INCLUDE SVT00002                                         00151300
045400     END-EXEC.                                                    00160600
045500                                                                  00160700
045600*                                                                 00160800
045700*  STORED VALUE LOCK TABLE                                        00160900
045800*                                                                 00161000
045900                                                                  00161100
046000     EXEC SQL                                                     00161200
046100         INCLUDE SVT00004                                         00161300
046200     END-EXEC.                                                    00163100
046300                                                                  00163200
046400*                                                                 00163300
046500*  STORED VALUE LAST ISSUED VGC TABLE                             00163400
046600*                                                                 00163500
046700                                                                  00163600
046800     EXEC SQL                                                     00163700
046900         INCLUDE SVT00017                                         00163800
047000     END-EXEC.                                                    00166000
047100                                                                  00166100
047200*                                                                 00166200
047300*  STORED VALUE card stock denomination table                     00166300
047400*                                                                 00166400
047500                                                                  00166500
047600     EXEC SQL                                                     00166600
047700         INCLUDE SVT00008                                         00166700
047800     END-EXEC.                                                    00169900
047900                                                                  00170000
051722*  STORED VALUE FRAUD PARAMETERS TABLE                            00170100
051722     EXEC SQL                                                     00170200
051722         INCLUDE SVT00018                                         00170300
051722     END-EXEC.                                                    00170400
051722                                                                  00170500
051722*  STORED VALUE FAILED ATTEMPTS TABLE                             00170600
051722     EXEC SQL                                                     00170700
051722         INCLUDE SVT00019                                         00170800
051722     END-EXEC.                                                    00170900
051722                                                                  00171000
047900                                                                  00171400
048000*  STANDARD LAYOUT FOR THE SQL COMMUNICATION AREA.                00171500
048100                                                                  00171600
048200     EXEC SQL                                                     00171700
048300         INCLUDE SQLCA                                            00171800
048400     END-EXEC.                                                    00171900
048500                                                                  00172000
048600******************************************************************00172100
048700* CURSOR DECLARATION FOR VIRTUAL ISSUING CARDS                    00172200
048800******************************************************************00172300
048900                                                                  00172400
049000     EXEC SQL                                                     00172500
049100        DECLARE VIRTUAL_CSR CURSOR FOR                            00172600
049200        SELECT A.CRD_PROD_YR                                      00172700
049300             , A.SHIPT_REQ_NBR                                    00172800
049400             , A.END_CNTL_NBR                                     00172900
049420             , C.UPC_NBR                                          00173000
049500        FROM SVT_CRD_PROD        A                                00173100
049600           , SVT_LAST_ISUD_VGC   B                                00173200
049610           , SVT_CRD_STK_DNMNTN  C                                00173300
049700        WHERE  A.CRD_PROD_YR       = B.CRD_PROD_YR                00173400
049800          AND  A.SHIPT_REQ_NBR     = B.SHIPT_REQ_NBR              00173500
049810          AND  A.CRD_TYP_CDE       = C.CRD_TYP_CDE                00173600
049820          AND  A.CRD_STK_TYP_ID    = C.CRD_STK_TYP_ID             00173700
090821          AND  A.CRD_STK_TYP_ID    = 'VIRTUAL'                    00173800
049830          AND  A.PRE_DNNTD_CRD_AMT = C.PRE_DNNTD_CRD_AMT          00173900
049900          AND  B.LAST_ISUD_CNTL_NBR < A.END_CNTL_NBR              00174000
050000        ORDER BY A.CRD_PROD_YR, A.SHIPT_REQ_NBR                   00174100
050100     END-EXEC.                                                    00174200
050200                                                                  00174300
050300******************************************************************00174400
050400* CURSOR DECLARATION FOR UPDATING THE LAST ISSUED CNTL            00174500
050500******************************************************************00174600
050600     EXEC SQL                                                     00174700
050700        DECLARE VIRTUAL_UPD_CSR CURSOR FOR                        00174800
050800        SELECT LAST_ISUD_CNTL_NBR                                 00174900
050900        FROM SVT_LAST_ISUD_VGC                                    00175000
051000        WHERE  CRD_PROD_YR       = :PV-CRD-PROD-YR                00175100
051100          AND  SHIPT_REQ_NBR     = :PV-SHIPT-REQ-NBR              00175200
051200        FOR UPDATE OF LAST_ISUD_CNTL_NBR                          00175300
051300     END-EXEC.                                                    00175400
051400                                                                  00175500
051500* DATA AREA USED BY SV005-A100-MAINLINE.                          00175600
051600     COPY SVWS005.                                                00176000
051700                                                                  00383800
051800* DATA AREA USED BY SV006-A100-MAINLINE.                          00383900
051900     COPY SVWS006.                                                00384000
052000                                                                  00396100
052100*----------------------------------------------------------------*00396200
052200* CONVERT CARD NUMBER WORKING STORAGE AREA                       *00396300
052300*----------------------------------------------------------------*00396400
052400     COPY SVWS007.                                                00396500
052500                                                                  00404500
052600* DATA AREA USED BY THE CHECK DIGIT ROUTINE IN SVPD006.           00404600
2018       COPY DPWS036.                                                00404700
052800                                                                  00406300
052900*-----------------------------------------------------------      00406400
053000*   UPC CHECK DIGIT ROUTINE PARAMETER LIST LAYOUT                 00406502
053100*-----------------------------------------------------------      00406600
053200     COPY DPWS040I.                                               00406700
053300                                                                  00411500
053400*----------------------------------------------------------------*00411600
053500 LINKAGE SECTION.                                                 00411700
053600*----------------------------------------------------------------*00411800
053700******************************************************************00411900
053800 PROCEDURE DIVISION.                                              00412000
053900******************************************************************00412100
054000                                                                  00412200
054100 0000-MAINLINE.                                                   00412300
054200                                                                  00412400
054300     PERFORM 1000-INITIALIZE.                                     00412500
054400                                                                  00412600
054500     PERFORM 2000-AUTHORIZE-REQUEST.                              00412700
054600                                                                  00412800
054700*                                                                 00412900
054800*  FORMAT AND SEND AN AUTHORIZATION RESPONSE TO THE ISP.          00413000
054900*                                                                 00413100
055000     PERFORM 5000-FORMAT-AUTHORIZATION-RESP.                      00413200
055100                                                                  00413300
055200*                                                                 00413400
055300*  AT END OF THE TRANSACTION (WHETHER IT COMPLETES SUCCESSFULLY   00413500
055400*  OR NOT), THE TKMCLCK ROW MUST STILL BE DELETED                 00413600
055500*                                                                 00413700
055600     PERFORM 4050-DELETE-KMC-LOCK-TABLE.                          00413800
055700                                                                  00413900
055800*                                                                 00414000
055900*  IF THE AUTHORIZATION REQUEST WAS ISSUED AT A TRAINING REGISTER,00414100
056000*  TERMINATE THE TRANSACTION AFTER SENDING THE AUTHORIZATION      00414200
056100*  RESPONSE.  SINCE ALL ACTIVITY GENERATED IS FICTITIOUS, NO      00414300
056200*  REFERRALS OR APPROVALS FROM THESE REGISTERS SHOULD BE POSTED   00414400
056300*  TO THE PRODUCTION TABLES.                                      00414500
056400*                                                                 00414600
056500     IF FI-TRAINING-REGISTER                                      00414700
056600         PERFORM 9999-RETURN-TO-NATIVE-CICS                       00414800
056700     END-IF.                                                      00414900
056800                                                                  00415000
056900*                                                                 00415100
057000*  COMMIT ALL CHANGES PERFORM TERMINATING THE TRANSACTION.        00415200
057100*                                                                 00415300
057200     EXEC CICS                                                    00415400
057300         SYNCPOINT                                                00415500
057400     END-EXEC.                                                    00415600
057500                                                                  00415700
057600* DISPLAY EPCL RESPONSE LOG MESSAGE                               00415800
057700     SET LM-DM-RSP TO TRUE.                                       00415900
057800     PERFORM 8500-MESSAGE-MONITORING.                             00416000
057900                                                                  00416100
058000     GOBACK.                                                      00416200
058100*0000-EXIT.                                                       00416300
058200                                                                  00416400
058300*----------------------------------------------------------------*00416500
058400* INITIALIZE                                                     *00416600
058500*----------------------------------------------------------------*00416700
058600 1000-INITIALIZE.                                                 00416800
058800     INITIALIZE SV005-KMC-AUTH-PARAMETERS.                        00416900
058810                                                                  00417000
058900     PERFORM EP000-0000-INITIALIZE.                               00417100
059000                                                                  00417200
059100     MOVE EP000-DT-CURR-DATE-YYYYMMDD                             00417300
059200         TO CD-CURRENT-DATE-YYYYMMDD-X.                           00417400
059300     MOVE CD-CURRENT-YEAR   TO  CD-YYYY.                          00417500
059400     MOVE CD-CURRENT-MONTH  TO  CD-MM.                            00417600
059500     MOVE CD-CURRENT-DAY    TO  CD-DD.                            00417700
059600                                                                  00417800
059700     SET SV005-PS-TENDER-W-ISSUE TO TRUE.                         00417900
059800                                                                  00418000
059900     PERFORM 7000-RETRIEVE-AUTH-REQUEST.                          00418100
060020     PERFORM 1100-UNSTRING-AUTH-DETAIL.                           00418200
060100     PERFORM 1200-VERIFY-DATA.                                    00418300
051722     PERFORM 2180-SELECT-FRAUD-PARM.                              00418400
060200                                                                  00418500
060300*  FOR REGULAR STORES, SET DATE BACK 1 DAY IF                     00418600
060400*  TRANSACTION WAS BETWEEN MIDNIGHT AND 3AM TO MATCH COSA DATE.   00418700
060500*  NOT FOR ECOMM, BECAUSE ECOMM DOES NOT MATCH COSA UNTIL         00418800
060600*  SHIPPED.                                                       00418900
060700                                                                  00419000
060800     IF (EP000-DT-CURRENT-TIME < 030000                           00419100
060900         AND PV-E-NON-ECOMM-STORE)                                00419200
061000         PERFORM 1010-USE-YESTERDAY-DATE                          00419300
061100     END-IF.                                                      00419400
061200*1000-EXIT.                                                       00419500
061300                                                                  00419600
061400*----------------------------------------------------------------*00419700
061500*1010-USE-YESTERDAY-DATE.                                        *00419800
061600*     WHEN THE TIME IS BETWEEN MIDNIGHT AND 3:00 AM, THE POS DATE*00419900
061700*     SHOULD BE SET TO YESTERDAY.  THIS OCCURS DURING THE        *00420000
061800*     CHRISTMAS HOLIDAY WHEN THE STORES ARE OPEN UNTIL MIDNIGHT. *00420100
061900*     NOTE: NOT FOR ECOMMERCE STORES                             *00420200
062000*----------------------------------------------------------------*00420300
062100 1010-USE-YESTERDAY-DATE.                                         00420400
062200                                                                  00420500
062300     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              00420600
062400                                                                  00420700
062500     SET DPG51-ACTUAL-CALENDAR-ONLY TO TRUE.                      00420800
062600     SET DPG51-DECREMENT-DATE       TO TRUE.                      00420900
062700     MOVE 1                         TO DPG51-INCR-DECR-DAYS-9.    00421000
062800                                                                  00421100
062900     SET DPG52-LK-DTE-ISO-FMT       TO TRUE.                      00421200
063000     MOVE CD-DB2-DATE-FORMAT        TO DPG52-LK-DATE-INPUT.       00421300
063100                                                                  00421400
063200     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52          00421500
063300                                DPG53 DPG54                       00421600
063400                                DPG55 DPG56.                      00421700
063500                                                                  00421800
063600     EVALUATE TRUE                                                00421900
063700         WHEN DPG54-SEVERE-ERROR                                  00422000
063800         WHEN DPG54-DATE-INVALID                                  00422100
063900                                                                  00422200
064000         SET PS-SYSTEM-ERROR-DETECTED                             00422300
064100             PV-SYSTEM-ERROR-REFERRAL-CODE                        00422400
064200             EP000-SL-ERROR                                       00422500
064300             PS-AUTH-MESSAGE-ERROR  TO TRUE                       00422600
064400         MOVE AU001-DATA-BUF        TO AM-POS-INQ-REMOTE-AUTH-MSG 00422700
064500         MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                00422800
064600         MOVE AM-AUTH-MESSAGE-ERROR-MESSAGE                       00422900
064700             TO  EP000-MD-SYSTEM-LOG-MESSAGE                      00423000
064800                     (EP000-MESSAGE-LINE-COUNTER)                 00423100
064900         ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                 00423200
065000         MOVE 'CALENDAR DATE ROUTINE ERROR'                       00423300
065100                               TO EP000-MD-SYSTEM-LOG-MESSAGE     00423400
065200                                     (EP000-MESSAGE-LINE-COUNTER) 00423500
065300         PERFORM EP000-1000-POST-MESSAGE                          00423600
065400     END-EVALUATE.                                                00423700
065500                                                                  00423800
065600     IF PS-SYSTEM-ERROR-DETECTED                                  00423900
065700         CONTINUE                                                 00424000
065800     ELSE                                                         00424100
065900         MOVE DPG55-DB2-ISO-DATE-FMT  TO CD-DB2-DATE-FORMAT       00424200
066000     END-IF.                                                      00424300
066100*1010-EXIT.                                                       00424400
066200*----------------------------------------------------------------*00424500
066300* UNSTRING AUTH DETAIL                                           *00424600
066400* The authorization message is in AJB Fipay comma-delimited      *00424700
066500* format. Each field will be 'unstrung' into the pt-auth-field   *00424800
066600* array, which can hold up to 150 50-byte fields.                *00424900
066700*----------------------------------------------------------------*00425000
066800 1100-UNSTRING-AUTH-DETAIL.                                       00425100
066910     MOVE 1 TO PT-AUTH-INDEX.                                     00425200
067000     MOVE 1 TO PV-WS-CTR.                                         00425300
067100     PERFORM UNTIL PV-WS-CTR > AU001-TOT-REC-LENGTH               00425400
067200             OR PT-AUTH-INDEX > PC-MAX-FIELDS                     00425500
067300          UNSTRING AU001-DATA-BUF                                 00425600
067400             DELIMITED BY ','                                     00425700
067500             INTO PT-AUTH-FIELD (PT-AUTH-INDEX)                   00425800
067600             WITH POINTER PV-WS-CTR                               00425900
067700          END-UNSTRING                                            00426000
067800          ADD 1 TO PT-AUTH-INDEX                                  00426100
067900     END-PERFORM.                                                 00426200
068000     COMPUTE PV-TOTAL-NO-FIELDS = PT-AUTH-INDEX - 1.              00426300
068100                                                                  00426400
068200* DISPLAY MESSAGE FOR TESTING PURPOSES                            00426500
068300*    SET EP000-SL-INFORMATION TO  TRUE.                           00426600
068400*    MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER.      00426700
068500*                                                                 00426800
068600*    MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   00426900
068700*    MOVE AU001-DATA-BUF                                          00427000
068800*                     TO EP000-MD-SYSTEM-LOG-MESSAGE              00427100
068900*                (EP000-MESSAGE-LINE-COUNTER).                    00427200
069000*    PERFORM EP000-1000-POST-MESSAGE.                             00427300
069100                                                                  00427400
069200**** DISPLAY MESSAGE FOR TESTING PURPOSES                         00427500
069300*    PERFORM VARYING PV-WS-CTR FROM 1 BY 50                       00427600
069400*             UNTIL PV-WS-CTR > 300                               00427700
069500*       MOVE AU001-DATA-BUF (PV-WS-CTR:50) TO                     00427800
069600*         EP000-MD-SYSTEM-LOG-MESSAGE                             00427900
069700*              (EP000-MESSAGE-LINE-COUNTER)                       00428000
069800*       PERFORM EP000-1000-POST-MESSAGE                           00428100
069900*    END-PERFORM.                                                 00428200
070000*1100-EXIT.                                                       00428300
070100                                                                  00428400
070200*---------------------------------------------------------------* 00428500
070300*  VERIFY DATA                                                  * 00428600
070400* MOVE DATA FROM INPUT MESSAGE INTO WORKING FIELDS.             * 00428700
070500* VERIFY THAT DATA IS VALID.                                    * 00428800
070600*---------------------------------------------------------------* 00428900
070700 1200-VERIFY-DATA.                                                00429000
070800                                                                  00429100
070910* MOVE STORE NUMBER FROM FIELD 8                                  00429200
071000     UNSTRING PT-AUTH-FIELD (8)                                   00429300
071100       DELIMITED BY ' '                                           00429400
071200       INTO FI-08-STORE-NO                                        00429500
071300     END-UNSTRING.                                                00429600
071400                                                                  00429700
071500* MOVE TERMINAL NUMBER FROM FIELD 9                               00429800
071600     UNSTRING PT-AUTH-FIELD (9)                                   00429900
071700       DELIMITED BY ' '                                           00430000
071800       INTO FI-09-TERM-NO                                         00430100
071900     END-UNSTRING.                                                00430200
072000                                                                  00430300
072100* MOVE TRANSACTION NUMBER FROM FIELD 17                           00430400
072200     UNSTRING PT-AUTH-FIELD (17)                                  00430500
072300       DELIMITED BY ' '                                           00430600
072400       INTO FI-17-TRAN-NO                                         00430700
072500     END-UNSTRING.                                                00430800
072600                                                                  00430900
PGC                                                                     00431000
PGC   * MOVE TRANSACTION NUMBER FROM FIELD 21                           00431100
PGC        UNSTRING PT-AUTH-FIELD (21)                                  00431200
PGC          DELIMITED BY ' '                                           00431300
PGC          INTO FI-21-CARD-TYPE                                       00431400
PGC        END-UNSTRING.                                                00431500
PGC                                                                     00431600
PGC        IF FI-21-CARD-TYPE = '*PlasticGC'                            00431700
PGC            SET FI-21-PLASTIC   TO TRUE                              00431800
PGC            SET PV-PLASTIC  TO TRUE                                  00431900
PGC            SET SV005-PLASTIC-CARD  TO TRUE                          00432000
PGC        ELSE                                                         00432100
PGC            SET PV-NOT-PLASTIC  TO TRUE                              00432200
PGC            SET SV005-NOT-PLASTIC  TO TRUE                           00432300
PGC            SET FI-21-VIRTUAL   TO TRUE                              00432400
PGC        END-IF.                                                      00432500
072600                                                                  00432600
072700* MOVE TRANSACTION TYPE FROM FIELD 10 AND                         00432700
072800* DETERMINE TRANSACTION TYPE AND CARD TYPE IF KNOWN               00432800
072900     MOVE FUNCTION UPPER-CASE (PT-AUTH-FIELD (10)) TO             00432900
073000          FI-10-TRAN-TYPE.                                        00433000
073100     EVALUATE TRUE                                                00433100
073200       WHEN FI-PV-BAL-INQ                                         00433200
073300       WHEN FI-PV-BAL-INQ-ADD-ON                                  00433300
073400         SET PV-BALANCE-INQUIRY       TO TRUE                     00433400
073500       WHEN FI-PV-REFUND                                          00433500
073600         SET PV-ISSUANCE-AS-KMRC      TO TRUE                     00433600
073700       WHEN FI-PV-ISSUE                                           00433700
073800         SET PV-ISSUANCE-AS-GIFT-CARD TO TRUE                     00433800
073900       WHEN FI-PV-SALE                                            00433900
074000         SET PV-TENDER                TO TRUE                     00434000
030600       WHEN FI-PV-REAUTH                                          00434100
074000         SET PV-TENDER                                            00434200
074000             PV-REAUTH                TO TRUE                     00434300
030600       WHEN FI-PV-REVERSAL-REAUTH                                 00434400
074000         SET PV-REVERSAL-REAUTH       TO TRUE                     00434500
074100       WHEN OTHER                                                 00434600
074200         SET PV-INVALID-REQUEST-TYPE TO TRUE                      00434700
074300     END-EVALUATE.                                                00434800
074400                                                                  00434900
074500* SET REVERSAL-IND                                                00435000
074600     IF FI-PV-10-REVERSAL                                         00435100
074700        SET PV-REVERSAL TO TRUE                                   00435200
074800     ELSE                                                         00435300
074900        SET PV-NORMAL TO TRUE                                     00435400
075000     END-IF.                                                      00435500
075110                                                                  00435600
075200* MOVE ACCOUNT NUMBER                                             00435700
075300* ACCOUNT NUMBER CAN EITHER BE IN FIELD 13 OR 15 DEPENDING ON     00435800
075400* IF IT WAS KEYED OR SWIPED (SCANNED)                             00435900
075500* After Unstringing ACCT NO, PV-WS-CTR minus 2 equals the         00436000
075600* length of the account number.                                   00436100
075700                                                                  00436200
075800     MOVE PT-AUTH-FIELD (13) TO FI-13-ACCT-NO-KEY.                00436300
075900     MOVE PT-AUTH-FIELD (15) TO FI-15-ACCT-NO-SWP.                00436400
076000                                                                  00436500
076100     MOVE 1 TO PV-WS-CTR.                                         00436600
PGC        IF FI-13-ACCT-NO-KEY NOT = SPACES OR ZEROES                  00436700
076300       SET PV-KMC-KEY-ENTERED TO TRUE                             00436800
076400       UNSTRING FI-13-ACCT-NO-KEY                                 00436900
076500         DELIMITED BY ' '                                         00437000
076600         INTO FW-KMC-ID-INT                                       00437100
076700          WITH POINTER PV-WS-CTR                                  00437200
076800       END-UNSTRING                                               00437300
PGC          MOVE PV-WS-CTR TO PV-SAVE-WS-CTR                           00437400
076900     ELSE                                                         00437500
077000       UNSTRING FI-15-ACCT-NO-SWP                                 00437600
077100         DELIMITED BY ' '                                         00437700
077200         INTO FW-KMC-ID-INT                                       00437800
077300          WITH POINTER PV-WS-CTR                                  00437900
077400       END-UNSTRING                                               00438000
PGC          MOVE PV-WS-CTR TO PV-SAVE-WS-CTR                           00438100
077500     END-IF.                                                      00438200
077600                                                                  00438300
077720* MOVE TRANSACTION AMOUNT                                         00438400
077800* UNSTRING TRANSACTION AMOUNT FROM FIELD 16                       00438500
077900     UNSTRING PT-AUTH-FIELD (16)                                  00438600
078000       DELIMITED BY ' '                                           00438700
078100       INTO FI-16-AMOUNT                                          00438800
078200     END-UNSTRING.                                                00438900
078300     DIVIDE FI-16-AMOUNT BY 100 GIVING PV-KMC-AMT.                00439000
078400                                                                  00439100
078500                                                                  00439200
078600* CHECK FOR INVALID DATA                                          00439300
078700* NOTE: BALANCE INQUIRIES DON'T REQUIRE TERM/TRAN                 00439400
078800     IF (FI-08-STORE-NO = ZERO)                                   00439500
078900           OR (FI-09-TERM-NO = ZERO AND NOT PV-BALANCE-INQUIRY)   00439600
079000           OR (FI-17-TRAN-NO = ZERO AND NOT PV-BALANCE-INQUIRY)   00439700
079100           OR (PV-INVALID-REQUEST-TYPE)                           00439800
079200       SET PS-SYSTEM-ERROR-DETECTED                               00439900
079300           PV-EDIT-ERROR                                          00440000
079400           EP000-SL-ERROR                                         00440100
079500           PS-AUTH-MESSAGE-ERROR  TO TRUE                         00440200
079600       MOVE AU001-DATA-BUF        TO AM-POS-INQ-REMOTE-AUTH-MSG   00440300
079700                                                                  00440400
079800       MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                  00440500
079900       MOVE AM-AUTH-MESSAGE-ERROR-MESSAGE                         00440600
080000           TO  EP000-MD-SYSTEM-LOG-MESSAGE                        00440700
080100                   (EP000-MESSAGE-LINE-COUNTER)                   00440800
080200       ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                   00440900
080300       MOVE 'INVALID OR MISSING STORE/TERM/TRAN OR TRAN TYPE      00441000
080400-                  ' FIELDS'   TO EP000-MD-SYSTEM-LOG-MESSAGE     00441100
080500                                     (EP000-MESSAGE-LINE-COUNTER) 00441200
080600       PERFORM EP000-1000-POST-MESSAGE                            00441300
080700     END-IF.                                                      00441400
080800                                                                  00441500
080910* VERIFY STORE NUMBER                                             00441600
081000     IF PV-SUCCESSFUL-AUTHORIZATION                               00441700
081100       MOVE FI-08-STORE-NO TO XST00001-LOC-NBR                    00441800
081200       PERFORM 4100-DETERMINE-IF-VALID-STR                        00441900
081300     END-IF.                                                      00442000
081501                                                                  00442100
081510     IF FI-PV-ISSUE AND                                           00442200
081600        PV-E-ECOMMERCE-STORE                                      00442300
081700          CONTINUE                                                00442400
081800     ELSE                                                         00442500
081900* CHECK FOR INVALID DATA                                          00442600
082000      IF FW-KMC-ID-INT NUMERIC                                    00442700
082100         CONTINUE                                                 00442800
082200      ELSE                                                        00442900
082300       SET PS-SYSTEM-ERROR-DETECTED                               00443000
082400           PV-EDIT-ERROR                                          00443100
082500           EP000-SL-ERROR                                         00443200
082600           PS-AUTH-MESSAGE-ERROR  TO TRUE                         00443300
082700       MOVE AU001-DATA-BUF        TO AM-POS-INQ-REMOTE-AUTH-MSG   00443400
082800                                                                  00443500
082900       MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                  00443600
083000       MOVE AM-AUTH-MESSAGE-ERROR-MESSAGE                         00443700
083100           TO  EP000-MD-SYSTEM-LOG-MESSAGE                        00443800
083200                   (EP000-MESSAGE-LINE-COUNTER)                   00443900
083300       ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                   00444000
PGC          SET PV-CARD-NOT-ACTIVE TO TRUE                             00444100
083400       MOVE 'NON-NUMERIC CARD NUMBER'                             00444200
083500                               TO EP000-MD-SYSTEM-LOG-MESSAGE     00444300
083600                                     (EP000-MESSAGE-LINE-COUNTER) 00444400
083700       PERFORM EP000-1000-POST-MESSAGE                            00444500
083800      END-IF                                                      00444600
083900     END-IF.                                                      00444700
084000                                                                  00444800
084110* VERIFY ACCOUNT NUMBER                                           00444900
084200* Routine SV002-CONVERT is used to get 12-digit                   00445000
084300* card number that is used on database.                           00445100
084400* ACCOUNT FORMATS:                                                00445200
084500* Examples: Where 999 is card number in SV Database               00445300
084600*                   X is check digit of 999 value                 00445400
084700*                   C is check digit of whole card number         00445500
084800* Current KMRC (10 digit):             999999999X                 00445600
084900* Current GC Non-Denom (13 digit):   20999999999XC                00445700
085000* Current GC Pre-Denom (13 digit):   21999999999XC                00445800
085100* All New Cards (19 or 30 digit)                                  00445900
085101*   19 digit - hand keyed without the upc                         00446000
085102*   30 digit - scanned with the upc                               00446100
085110*       -  11 digit upc                                           00446200
085120*       -   6 digit bin (111021 - Safeway or 639305 - KOHLS)      00446300
085130*       -   1 digit card type (0 - No Specialty, 1 - KCK          00446400
085131*                              2 - Virtual, 3 - KMRC              00446500
PGC   *                              4 - Off Aisle KMRC, 5 - FILA KMRC) 00446600
085140*       -  12 digit card number                                   00446700
085141* PV-WS-CTR minus 2 equals the length of the card number.         00446800
085210     IF FI-PV-ISSUE AND                                           00446900
085300        PV-E-ECOMMERCE-STORE AND                                  00447000
PGC           PV-PLASTIC-SW = 'N'                                       00447100
085400          CONTINUE                                                00447200
085500     ELSE                                                         00447300
085600      IF PV-SUCCESSFUL-AUTHORIZATION                              00447400
PGC          PERFORM 1230-CARD-CHECK                                    00447500
PGC          PERFORM 1240-CARD-CHECK-CONT                               00447600
085600      END-IF                                                      00447700
085600     END-IF.                                                      00447800
089100                                                                  00447900
089210                                                                  00448000
089300* VERIFY DRIVERS LICENSE                                          00448100
089400* REMOVE LEADING ZEROS FROM DRIVERS LICENSE AND LEFT JUSTIFY      00448200
089500* REMAINING DIGITS.                                               00448300
089600     IF PV-SUCCESSFUL-AUTHORIZATION                               00448400
089700        AND PT-AUTH-FIELD (29) NOT = SPACES                       00448500
089800       MOVE PT-AUTH-FIELD (29) TO FW-DRIVERS-LICENSE-NUMBER       00448600
089900       MOVE ZERO TO PV-CTR                                        00448700
090000       INSPECT FW-DRIVERS-LICENSE-NUMBER                          00448800
090100                           TALLYING PV-CTR FOR LEADING ZEROS      00448900
090200       COMPUTE PV-CTR2 = 21 - PV-CTR                              00449000
090300       ADD 1 TO PV-CTR                                            00449100
090400       MOVE FW-DRIVERS-LICENSE-NUMBER (PV-CTR:PV-CTR2)            00449200
090500                                         TO PV-DRIVERS-LICENSE-NBR00449300
090600     END-IF.                                                      00449400
090700                                                                  00449500
090800* MOVE OPERATOR ID                                                00449600
090900     IF PV-SUCCESSFUL-AUTHORIZATION                               00449700
091000       UNSTRING PT-AUTH-FIELD (24)                                00449800
091100         DELIMITED BY ' '                                         00449900
091200           INTO FI-24-OPERATOR-ID                                 00450000
091300           MOVE FI-24-OPERATOR-ID TO PV-OPERATOR-ID               00450100
091400     END-IF.                                                      00450200
091500                                                                  00450300
091600* MOVE STATE ID, IF STATE ID IS BLANK, MOVE ST-CDE FROM XST_LOC   00450400
091700     IF PV-SUCCESSFUL-AUTHORIZATION                               00450500
091800       IF PT-AUTH-FIELD (28) = SPACES                             00450600
091900         MOVE XST00001-ST-CDE    TO FI-28-STATE-ID                00450700
092000       ELSE                                                       00450800
092100         MOVE PT-AUTH-FIELD (28) TO FI-28-STATE-ID                00450900
092200       END-IF                                                     00451000
092300     END-IF.                                                      00451100
092400                                                                  00451200
092500* MOVE POS-DATE FROM FIELD 50                                     00451300
092600     MOVE ZEROS TO FI-50-POS-DATE.                                00451400
092700     IF PV-SUCCESSFUL-AUTHORIZATION                               00451500
092800       IF PT-AUTH-FIELD (50) NOT = SPACES                         00451600
092900         UNSTRING PT-AUTH-FIELD (50)                              00451700
093000           DELIMITED BY ' '                                       00451800
093100           INTO FI-50-POS-DATE                                    00451900
093200         END-UNSTRING                                             00452000
093300       END-IF                                                     00452100
093400     END-IF.                                                      00452200
093500                                                                  00452300
093610* VERIFY PIN FORMAT                                               00452400
093700     IF PV-SUCCESSFUL-AUTHORIZATION                               00452500
093800       IF PT-AUTH-FIELD (85) = SPACES                             00452600
093900         MOVE -1 TO FI-85-PIN                                     00452700
094000       ELSE                                                       00452800
094100         UNSTRING PT-AUTH-FIELD (85)                              00452900
094200           DELIMITED BY ' '                                       00453000
094300           INTO FI-85-PIN                                         00453100
094400         END-UNSTRING                                             00453200
094510     END-IF.                                                      00453300
094600                                                                  00453400
094700* DISPLAY EPCL REQUEST LOG MESSAGE                                00453500
094800     SET LM-DM-REQ TO TRUE.                                       00453600
094900     PERFORM 8500-MESSAGE-MONITORING.                             00453700
095000                                                                  00453800
P12431     INITIALIZE PV-SPACE-COUNT.                                   00453900
P12431     INSPECT FUNCTION REVERSE(PV-OPERATOR-ID)                     00454000
P12431         TALLYING PV-SPACE-COUNT FOR LEADING SPACES.              00454100
P12431     INITIALIZE PV-ZERO-COUNT.                                    00454200
P12431     INSPECT PV-OPERATOR-ID                                       00454300
P12431       TALLYING PV-ZERO-COUNT FOR LEADING ZEROES.                 00454400
P12431     COMPUTE PV-OPRT-ID-LEN = LENGTH OF PV-OPERATOR-ID            00454500
P12431                           - (PV-ZERO-COUNT + PV-SPACE-COUNT).    00454600
P12431                                                                  00454700
095110* CHECK REQUEST FOR VALID FIELDS BASED ON REQUEST TYPE            00454800
095200     IF PV-SUCCESSFUL-AUTHORIZATION                               00454900
095300       PERFORM 1220-CHECK-REQUEST                                 00455000
095400     END-IF.                                                      00455100
095500*1200-EXIT.                                                       00455200
095600                                                                  00455300
095700*----------------------------------------------------------------*00455400
095800*  CHECK-REQUEST                                                 *00455500
095900*  CHECK REQUEST FOR VALID FIELDS BASED ON REQUEST TYPE          *00455600
096000*----------------------------------------------------------------*00455700
096100 1220-CHECK-REQUEST.                                              00455800
096210     EVALUATE TRUE                                                00455900
096300        WHEN  PV-ISSUANCE-AS-KMRC                                 00456000
096400            IF (( (PV-DRIVERS-LICENSE-NBR = SPACES)               00456100
096500                    OR (PV-KMC-ID = ZEROS)                        00456200
096600                    OR (PV-KMC-AMT NOT > ZERO)                    00456300
P12431                    OR (PV-OPRT-ID-LEN = 0) ))                    00456400
096800                SET PS-SYSTEM-ERROR-DETECTED                      00456500
096900                    PV-EDIT-ERROR                                 00456600
097000                    EP000-SL-ERROR                                00456700
097100                    PS-AUTH-MESSAGE-ERROR TO TRUE                 00456800
097200                MOVE AU001-DATA-BUF TO                            00456900
097300                          AM-POS-INQ-REMOTE-AUTH-MSG              00457000
097400                MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER         00457100
097500                MOVE AM-AUTH-MESSAGE-ERROR-MESSAGE                00457200
097600                    TO  EP000-MD-SYSTEM-LOG-MESSAGE               00457300
097700                            (EP000-MESSAGE-LINE-COUNTER)          00457400
097800                ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER          00457500
097900                MOVE 'NO KMC ID, KMC AMOUNT, OPERATOR ID, OR D    00457600
098000-                  'RIVERS LICENSE DETECTED IN THE '              00457700
098100                    TO  EP000-MD-SYSTEM-LOG-MESSAGE               00457800
098200                            (EP000-MESSAGE-LINE-COUNTER)          00457900
098300                ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER          00458000
098400                MOVE 'AUTHORIZATION REQUEST MESSAGE'              00458100
098500                    TO  EP000-MD-SYSTEM-LOG-MESSAGE               00458200
098600                            (EP000-MESSAGE-LINE-COUNTER)          00458300
098700                PERFORM EP000-1000-POST-MESSAGE                   00458400
098800            END-IF                                                00458500
098900        WHEN  PV-ISSUANCE-AS-GIFT-CARD AND                        00458600
099000              PV-E-NON-ECOMM-STORE                                00458700
099100            IF (( (PV-KMC-ID = ZEROS)                             00458800
P12431               OR (PV-OPRT-ID-LEN = 0)      ))                    00458900
099300                SET PS-SYSTEM-ERROR-DETECTED                      00459000
099400                    PV-EDIT-ERROR                                 00459100
099500                    EP000-SL-ERROR                                00459200
099600                    PS-AUTH-MESSAGE-ERROR TO TRUE                 00459300
099700                MOVE AU001-DATA-BUF TO                            00459400
099800                          AM-POS-INQ-REMOTE-AUTH-MSG              00459500
099900                MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER         00459600
100000                MOVE AM-AUTH-MESSAGE-ERROR-MESSAGE                00459700
100100                    TO  EP000-MD-SYSTEM-LOG-MESSAGE               00459800
100200                            (EP000-MESSAGE-LINE-COUNTER)          00459900
100300                ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER          00460000
100400                MOVE 'NO KMC ID, OR OPERATOR ID DETECTED IN '     00460100
100500                    TO  EP000-MD-SYSTEM-LOG-MESSAGE               00460200
100600                            (EP000-MESSAGE-LINE-COUNTER)          00460300
100700                ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER          00460400
100800                MOVE 'THE AUTHORIZATION REQUEST MESSAGE'          00460500
100900                    TO  EP000-MD-SYSTEM-LOG-MESSAGE               00460600
101000                            (EP000-MESSAGE-LINE-COUNTER)          00460700
101100                PERFORM EP000-1000-POST-MESSAGE                   00460800
101200            END-IF                                                00460900
101300        WHEN PV-TENDER                                            00461000
P12431            IF   ( (   (PV-OPRT-ID-LEN = 0)                       00461100
101500                    OR (PV-KMC-ID = ZEROS )                       00461200
101600                    OR (PV-KMC-AMT NOT > ZERO)))                  00461300
101700                SET PS-SYSTEM-ERROR-DETECTED                      00461400
101800                    PV-EDIT-ERROR                                 00461500
101900                    EP000-SL-ERROR                                00461600
102000                    PS-AUTH-MESSAGE-ERROR TO TRUE                 00461700
102100                MOVE AU001-DATA-BUF TO                            00461800
102200                          AM-POS-INQ-REMOTE-AUTH-MSG              00461900
102300                MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER         00462000
102400                MOVE AM-AUTH-MESSAGE-ERROR-MESSAGE                00462100
102500                    TO  EP000-MD-SYSTEM-LOG-MESSAGE               00462200
102600                            (EP000-MESSAGE-LINE-COUNTER)          00462300
102700                ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER          00462400
102800                MOVE 'NO KMC ID, KMC AMOUNT, OR OPERATOR ID DE    00462500
102900-                    'TECTED IN THE AUTHORIZATION MESSAGE'        00462600
103000                      TO  EP000-MD-SYSTEM-LOG-MESSAGE             00462700
103100                              (EP000-MESSAGE-LINE-COUNTER)        00462800
103200                PERFORM EP000-1000-POST-MESSAGE                   00462900
103300            END-IF                                                00463000
103400        WHEN PV-BALANCE-INQUIRY                                   00463100
103500            IF (PV-KMC-ID = ZEROS )                               00463200
103600                SET PS-SYSTEM-ERROR-DETECTED                      00463300
103700                    PV-EDIT-ERROR                                 00463400
103800                    EP000-SL-ERROR                                00463500
103900                    PS-AUTH-MESSAGE-ERROR TO TRUE                 00463600
104000                MOVE AU001-DATA-BUF TO                            00463700
104100                          AM-POS-INQ-REMOTE-AUTH-MSG              00463800
104200                MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER         00463900
104300                MOVE AM-AUTH-MESSAGE-ERROR-MESSAGE                00464000
104400                    TO  EP000-MD-SYSTEM-LOG-MESSAGE               00464100
104500                            (EP000-MESSAGE-LINE-COUNTER)          00464200
104600                ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER          00464300
104700                MOVE 'NO KMC ID IS DETECTED IN THE AUTHORIZATI    00464400
104800-                     'ION MESSAGE'                               00464500
104900                      TO  EP000-MD-SYSTEM-LOG-MESSAGE             00464600
105000                              (EP000-MESSAGE-LINE-COUNTER)        00464700
105100                PERFORM EP000-1000-POST-MESSAGE                   00464800
105200            END-IF                                                00464900
105300        WHEN  PV-ISSUANCE-AS-GIFT-CARD AND                        00465000
105400              PV-E-ECOMMERCE-STORE AND                            00465100
105500              PV-KMC-AMT = ZERO                                   00465200
105600            SET PS-SYSTEM-ERROR-DETECTED                          00465300
105700                PV-EDIT-ERROR                                     00465400
105800                EP000-SL-ERROR                                    00465500
105900                PS-AUTH-MESSAGE-ERROR TO TRUE                     00465600
106000            MOVE AU001-DATA-BUF TO                                00465700
106100                          AM-POS-INQ-REMOTE-AUTH-MSG              00465800
106200            MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER             00465900
106300            MOVE AM-AUTH-MESSAGE-ERROR-MESSAGE                    00466000
106400                    TO  EP000-MD-SYSTEM-LOG-MESSAGE               00466100
106500                            (EP000-MESSAGE-LINE-COUNTER)          00466200
106600            ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER              00466300
106700            MOVE 'NO AMOUNT FOR VIRTUAL CARD'                     00466400
106800                    TO  EP000-MD-SYSTEM-LOG-MESSAGE               00466500
106900                            (EP000-MESSAGE-LINE-COUNTER)          00466600
107000            ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER              00466700
107100            MOVE 'AUTHORIZATION REQUEST MESSAGE'                  00466800
107200                    TO  EP000-MD-SYSTEM-LOG-MESSAGE               00466900
107300                            (EP000-MESSAGE-LINE-COUNTER)          00467000
107400            PERFORM EP000-1000-POST-MESSAGE                       00467100
107500     END-EVALUATE.                                                00467200
107610*1220-EXIT.                                                       00467300
107700                                                                  00467400
107700***************************************************************** 00467500
107700*  separate out the 12 digit card number from the 19 or 30 digits 00467600
107700***************************************************************** 00467700
107700                                                                  00467800
       1230-CARD-CHECK.                                                 00467900
085602* this is for a 19 digit card - pv-ws-ctr plus 2                  00468000
085610       IF PV-WS-CTR = 21                                          00468100
085702          MOVE FW-KMC-ID-INT TO SV007-CARD-NUMBER-IN              00468200
085703          MOVE 0 TO SV007-CARD-NUMBER-LENGTH                      00468300
085704*         SET SV003-ECOMM-AUTH-PGM  TO TRUE                       00468400
085706          PERFORM SV007-FORMAT-CARD                               00468500
085707* IF CARD IS INVALID LENGTH, SEND AN ERROR.                       00468600
085708          IF SV007-CARD-NBR > 0                                   00468700
085709             MOVE SV007-CARD-NBR TO PV-KMC-ID                     00468800
085710          END-IF                                                  00468900
085774       ELSE                                                       00469000
085776* this is for a 30 digit card - pv-ws-ctr plus 2                  00469100
085777          IF PV-WS-CTR > 29                                       00469200
085780             MOVE FW-KMC-ID-INT TO SV007-CARD-NUMBER-IN           00469300
085781             MOVE 0 TO SV007-CARD-NUMBER-LENGTH                   00469400
085782*            SET SV003-ECOMM-AUTH-PGM  TO TRUE                    00469500
085783             PERFORM SV007-FORMAT-CARD                            00469600
085790* IF CARD IS INVALID LENGTH, SEND AN ERROR.                       00469700
085800             IF SV007-CARD-NBR > 0                                00469800
085801               MOVE SV007-CARD-NBR TO PV-KMC-ID                   00469900
085802             END-IF                                               00470000
085843          END-IF                                                  00470100
085844       END-IF.                                                    00470200
107800                                                                  00470300
107800******************************************************************00470400
107700*  separate out the 13 or 12 digit card number                    00470500
107700*  send an error if the card is not correct                       00470600
107800******************************************************************00470700
       1240-CARD-CHECK-CONT.                                            00470800
085853* this is for a 13 digit, 12 digit, and a 10 digit card           00470900
085854* pv-ws-ctr plus 2                                                00471000
085855     IF PV-WS-CTR = 15 OR                                         00471100
085856        PV-WS-CTR = 14 OR                                         00471200
085857        PV-WS-CTR = 12                                            00471300
085858           MOVE FW-KMC-ID-INT TO SV007-CARD-NUMBER-IN             00471400
085859           MOVE 0 TO SV007-CARD-NUMBER-LENGTH                     00471500
085860           PERFORM SV007-FORMAT-CARD                              00471600
085861* IF CARD IS INVALID LENGTH, SEND AN ERROR.                       00471700
085862           IF SV007-CARD-NBR > 0                                  00471800
085863               MOVE SV007-CARD-NBR TO PV-KMC-ID                   00471900
085864           ELSE                                                   00472000
085865               SET PS-AUTH-MESSAGE-ERROR                          00472100
085866                   PV-EDIT-ERROR                                  00472200
085867                   EP000-SL-ERROR  TO TRUE                        00472300
085868               MOVE AU001-DATA-BUF TO                             00472400
085869                         AM-POS-INQ-REMOTE-AUTH-MSG               00472500
085870               MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER          00472600
085871               MOVE AM-AUTH-MESSAGE-ERROR-MESSAGE                 00472700
085872                   TO   EP000-MD-SYSTEM-LOG-MESSAGE               00472800
085873                           (EP000-MESSAGE-LINE-COUNTER)           00472900
085874               ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER           00473000
085875               MOVE SV007-CARD-NUMBER-LENGTH TO                   00473100
085876                    PV-DISPLAY-ACCT-LENGTH                        00473200
085877               STRING                                             00473300
085878                   'ACCOUNT '                                     00473400
085879                    FW-KMC-ID-INT                                 00473500
085880                   ' IS INVALID LENGTH: '                         00473600
085881                    PV-DISPLAY-ACCT-LENGTH                        00473700
085882                 DELIMITED BY SIZE                                00473800
085883                 INTO EP000-MD-SYSTEM-LOG-MESSAGE                 00473900
085884                          (EP000-MESSAGE-LINE-COUNTER)            00474000
085885             END-STRING                                           00474100
085886             PERFORM EP000-1000-POST-MESSAGE                      00474200
085887         END-IF                                                   00474300
085890     END-IF.                                                      00474400
085890                                                                  00474500
107900*---------------------------------------------------------------* 00474600
108000* AUTHORIZE REQUEST                                             * 00474700
108100*  AUTHORIZE THE STORED VALUE REQUEST                           * 00474800
108200*---------------------------------------------------------------* 00474900
108300 2000-AUTHORIZE-REQUEST.                                          00475000
108400                                                                  00475100
108530     EVALUATE TRUE                                                00475200
108600        WHEN (NOT PV-SUCCESSFUL-AUTHORIZATION)                    00475300
108700            MOVE PV-REFERRAL-CODE-NUMBER                          00475400
108800                                      TO SV005-RESPONSE-CODE      00475500
108900            MOVE ZEROS                TO SV005-APPROVED-TENDER-AMT00475600
109000            MOVE PV-KMC-AMT           TO SV005-TRANS-AMT          00475700
109100            MOVE ZEROS TO SV005-KMC-REMAINING-BALANCE             00475800
109200            MOVE ZEROS TO SV005-CARD-TYPE                         00475900
109300            EVALUATE TRUE                                         00476000
109400              WHEN FI-PV-REFUND                                   00476100
109500                SET SV005-KMRC-CRD           TO TRUE              00476200
109600              WHEN FI-PV-ISSUE                                    00476300
109700                SET SV005-GIFT-CRD           TO TRUE              00476400
109800              WHEN OTHER                                          00476500
109900                MOVE ZERO TO SV005-CARD-TYPE                      00476600
110000            END-EVALUATE                                          00476700
110100                                                                  00476800
110200        WHEN OTHER                                                00476900
110300            PERFORM 2100-AUTHORIZE-KMC                            00477000
110410            IF (PV-TEST-KMRC-ACCOUNTS                             00477100
110500            OR  PV-TEST-GIFT-CARD-ACCOUNTS                        00477200
110600            OR  PV-TRAINING-KMRC-ACCOUNTS                         00477300
110700            OR  PV-TRAINING-GIFT-CARD-ACCOUNTS)                   00477400
110800               CONTINUE                                           00477500
110900            ELSE                                                  00477600
111000              EVALUATE TRUE                                       00477700
111100               WHEN SV005-PGM-ABEND                               00477800
111200                    SET PS-AUTH-MESSAGE-ERROR                     00477900
111300                        PV-SYSTEM-ERROR-REFERRAL-CODE             00478000
111400                        EP000-SL-ERROR TO TRUE                    00478100
111500                    MOVE AU001-DATA-BUF             TO            00478200
111600                                       AM-POS-INQ-REMOTE-AUTH-MSG 00478300
111700                    MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER     00478400
111800                    MOVE AM-AUTH-MESSAGE-ERROR-MESSAGE            00478500
111900                        TO  EP000-MD-SYSTEM-LOG-MESSAGE           00478600
112000                                (EP000-MESSAGE-LINE-COUNTER)      00478700
112100                    IF SV005-MESSAGE-1 = SPACE AND                00478800
112200                        SV005-MESSAGE-2 = SPACE                   00478900
112300                        ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER  00479000
112400                        MOVE 'UNEXPECTED ABEND IN SVPD005 '       00479100
112500                            TO  EP000-MD-SYSTEM-LOG-MESSAGE       00479200
112600                                    (EP000-MESSAGE-LINE-COUNTER)  00479300
112700                    ELSE                                          00479400
112800                        ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER  00479500
112900                        MOVE SV005-MESSAGE-1                      00479600
113000                            TO  EP000-MD-SYSTEM-LOG-MESSAGE       00479700
113100                                    (EP000-MESSAGE-LINE-COUNTER)  00479800
113200                        ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER  00479900
113300                        MOVE SV005-MESSAGE-2                      00480000
113400                            TO  EP000-MD-SYSTEM-LOG-MESSAGE       00480100
113500                                    (EP000-MESSAGE-LINE-COUNTER)  00480200
113600                    END-IF                                        00480300
113700                    PERFORM EP000-1000-POST-MESSAGE               00480400
113800                                                                  00480500
113900               WHEN SV005-DUPLICATE                               00480600
114000               WHEN SV005-INQUIRE                                 00480700
114100               WHEN SV005-HARD-DECLINE                            00480800
114200               WHEN SV005-REFERRAL                                00480900
114300                   IF PV-E-ECOMMERCE-STORE                        00481000
114400                       CONTINUE                                   00481100
114500                   ELSE                                           00481200
114600                       IF SV005-PS-TENDER-W-NO-ISSUE              00481300
114700                           MOVE 9 TO SV005-RESPONSE-CODE          00481400
114800                       END-IF                                     00481500
114900                   END-IF                                         00481600
115000                   MOVE SV005-RESPONSE-CODE TO                    00481700
115100                                       PV-REFERRAL-CODE-NUMBER    00481800
115200               WHEN SV005-APPROVE                                 00481900
115310                   PERFORM 3000-SET-COLUMNS                       00482000
115400                   IF PV-REVERSAL                                 00482100
115500                       INITIALIZE PV-RETRY-COUNT                  00482200
115600                       PERFORM 4005-UPDATE-KMC-ACTIVITY-TABLE     00482300
115700                          WITH TEST AFTER                         00482400
115800                          UNTIL ((SQLCODE = ZERO) OR              00482500
115900                                 (PV-RETRY-COUNT >                00482600
116000                                  PC-MAXIMUM-RETRY-COUNT))        00482700
116100                       IF ((SQLCODE = -904) OR                    00482800
116200                            (SQLCODE = -913))                     00482900
116300                            MOVE                                  00483000
116400                           'UPDATE A ROW (SVT00002)'              00483100
116500                                  TO       AA-ATTEMPTED-ACTION    00483200
116600                           PERFORM 9100-DB2-ERROR                 00483300
116700                           PERFORM 9999-RETURN-TO-NATIVE-CICS     00483400
116800                       END-IF                                     00483500
116900                       SET SV005-REVERSAL TO TRUE                 00483600
116900                       IF SV005-REAUTH OR SV005-NORMAL            00483700
116900                         MOVE '0' TO SVT00002-TRN-RVRSL-CDE       00483800
116900                       ELSE                                       00483900
116900                         IF SV005-REVERSAL-REAUTH OR              00484000
116900                            SV005-REVERSAL                        00484100
116900                            MOVE '1' TO SVT00002-TRN-RVRSL-CDE    00484200
116900                         END-IF                                   00484300
116900                       END-IF                                     00484400
117200                       MOVE SV004-VOID-TRANS                      00484500
117300                                    TO SVT00002-TRN-VOID-IND      00484600
117400                       MOVE SV005-REVERSAL-AMT                    00484700
117500                                    TO SVT00002-APP-AUTH-AMT      00484800
117600                   END-IF                                         00484900
117700                   INITIALIZE PV-RETRY-COUNT                      00485000
117800                   PERFORM 4000-INSERT-KMC-ACTIVITY-TABLE         00485100
117900                                                                  00485200
118000                      WITH TEST AFTER                             00485300
118100                      UNTIL ((SQLCODE = ZERO) OR                  00485400
118200                             (PV-RETRY-COUNT >                    00485500
118300                              PC-MAXIMUM-RETRY-COUNT))            00485600
118400                   IF ((SQLCODE = -904) OR                        00485700
118500                        (SQLCODE = -913))                         00485800
118600                        MOVE                                      00485900
118700                       'INSERT A ROW (SVT00002)'                  00486000
118800                                  TO       AA-ATTEMPTED-ACTION    00486100
118900                      PERFORM 9100-DB2-ERROR                      00486200
119000                      PERFORM 9999-RETURN-TO-NATIVE-CICS          00486300
119100                   END-IF                                         00486400
119200            END-EVALUATE                                          00486500
119300         END-IF                                                   00486600
119400     END-EVALUATE.                                                00486700
119500                                                                  00486800
119610*----------------------------------------------------------------*00486900
119700*  PERFORM THE AUTHORIZATION AGAINST THE SV DATABASE             *00487000
119800*----------------------------------------------------------------*00487100
119900 2100-AUTHORIZE-KMC.                                              00487200
120000                                                                  00487300
120200                                                                  00487400
120310     MOVE FI-08-STORE-NO         TO SV005-STORE-NBR.              00487500
120400     MOVE FI-09-TERM-NO          TO SV005-TERMINAL-NBR.           00487600
120500     MOVE FI-17-TRAN-NO          TO SV005-TRANSACTION-NBR.        00487700
120600     MOVE PV-KMC-ID              TO SV005-KMC-ID.                 00487800
120700     MOVE PV-REQUEST-TYPE        TO SV005-ACTIVITY-TYPE.          00487900
120810                                                                  00488000
120900     IF FI-PV-BAL-INQ-ADD-ON                                      00488100
121000         SET SV005-PS-ADD-ON     TO TRUE                          00488200
121100     ELSE                                                         00488300
121200         SET SV005-PS-NOT-ADD-ON TO TRUE                          00488400
121300     END-IF.                                                      00488500
121400     MOVE PV-REVERSAL-IND        TO SV005-REVERSAL-CODE.          00488600
121500     MOVE PV-KMC-AMT             TO SV005-TRANS-AMT.              00488700
121600     MOVE FI-85-PIN              TO SV005-PIN.                    00488800
121700                                                                  00488900
121800     MOVE PV-E-BUS-IND           TO SV005-E-BUS-LOC-IND.          00489000
121900     IF FI-50-POS-DATE NOT = ZEROS                                00489100
122000       MOVE FI-50-POS-DATE-DD TO CD-DD                            00489200
122100       MOVE FI-50-POS-DATE-MM TO CD-MM                            00489300
122200       MOVE FI-50-POS-DATE-YYYY TO CD-YYYY                        00489400
122300     END-IF.                                                      00489500
122400     MOVE CD-DB2-DATE-FORMAT     TO SV005-POS-DATE.               00489600
122500                                                                  00489700
122600     IF SV005-REVERSAL                                            00489800
122700         SET SV005-VOID TO TRUE                                   00489900
122800     ELSE                                                         00490000
122900         SET SV005-NOT-VOID TO TRUE                               00490100
123000     END-IF.                                                      00490200
123100******                                                            00490300
123200* IF CARD IS BEING ISSUED, SET CARD TYPE TO EITHER KMRC OR        00490400
123300* GIFT CARD. FOR TENDERS, CARD TYPE WILL BE LOOKED UP IN          00490500
123400* SVPD005, SO NO NEED TO SEND IT.                                 00490600
123500******                                                            00490700
123600     EVALUATE TRUE                                                00490800
123700       WHEN FI-PV-REFUND                                          00490900
123800         SET SV005-KMRC-CRD           TO TRUE                     00491000
123900       WHEN FI-PV-ISSUE                                           00491100
124000         SET SV005-GIFT-CRD           TO TRUE                     00491200
124100     END-EVALUATE.                                                00491300
124200                                                                  00491400
124300     SET SV005-PV-FROM-AUKCS502 TO TRUE.                          00491500
124400                                                                  00491600
124500     IF (PV-TEST-KMRC-ACCOUNTS                                    00491700
124600     OR  PV-TEST-GIFT-CARD-ACCOUNTS                               00491800
124700     OR  PV-TRAINING-KMRC-ACCOUNTS                                00491900
124800     OR  PV-TRAINING-GIFT-CARD-ACCOUNTS)                          00492000
124900                                                                  00492100
125000* TEST ACCOUNTS GET FIXED RESPONSES                               00492200
125100       IF EP000-PV-KOHLS-PROD-SYSTEM                              00492300
125200           MOVE 7      TO SV005-RESPONSE-CODE                     00492400
125300           MOVE 0      TO SV005-TRANS-AMT                         00492500
125400       ELSE                                                       00492600
125500         IF PV-E-NON-ECOMM-STORE                                  00492700
125600            PERFORM 2200-TEST-ACCOUNTS                            00492800
125700         ELSE                                                     00492900
125800            PERFORM 2300-ECOMM-TEST-ACCOUNTS                      00493000
125900         END-IF                                                   00493100
126000       END-IF                                                     00493200
126100     ELSE                                                         00493300
126200* NON-TEST ACCOUNTS GET REAL DATABASE AUTHORIZATIONS              00493400
126300* NOTE: KEY-ENTERED SALES ARE ONLY ALLOWED FOR ECOMMERCE STORE    00493500
126400        IF PV-KMC-KEY-ENTERED                                     00493600
126500        AND NOT PV-BALANCE-INQUIRY                                00493700
126600        AND NOT PV-ISSUANCE-AS-KMRC                               00493800
126700        AND NOT PV-ISSUANCE-AS-GIFT-CARD                          00493900
126800        AND NOT SV005-REVERSAL                                    00494000
126900        AND NOT PV-E-ECOMMERCE-STORE                              00494100
127000               MOVE 0      TO SV005-TRANS-AMT                     00494200
127100               SET SV005-REFERRAL                                 00494300
127200                   PV-REFERRAL-CODE TO TRUE                       00494400
127300        ELSE                                                      00494500
127400           IF PV-E-ECOMMERCE-STORE AND                            00494600
127500              PV-ISSUANCE-AS-GIFT-CARD AND                        00494700
PGC                 PV-SAVE-WS-CTR > 2 AND                              00494800
PGC                 PV-KMC-ID > 0                                       00494900
PGC   *  PLASTIC CARD - CHECK IF THE CARD HAS BEEN ISSUED.  IF IT HAS   00495000
PGC   *   SET EDIT ERROR                                                00495100
PGC                   PERFORM 2175-SELECT-TXN                           00495200
PGC                   IF SQLCODE = +100                                 00495300
PGC                    SET PV-PLASTIC-CARD TO TRUE                      00495400
PGC                    SET SV005-APPROVE TO TRUE                        00495500
PGC                    MOVE PV-KMC-ID        TO SV005-KMC-ID            00495600
PGC                    MOVE SV005-TRANS-AMT TO                          00495700
PGC                                       SV005-APPROVED-TENDER-AMT     00495800
PGC                                       SV005-KMC-REMAINING-BALANCE   00495900
PGC                    PERFORM 2150-SELECT-SPEC                         00496000
PGC                    IF SQLCODE = 0                                   00496100
PGC                       EVALUATE SVT00001-CRD-SPCTY-TYP-CDE           00496200
PGC                       WHEN 0                                        00496300
PGC                         SET PV-PLASTIC-CARD TO TRUE                 00496400
PGC                       WHEN 2                                        00496500
PGC                         SET PV-VIRTUAL      TO TRUE                 00496600
PGC                       WHEN 3                                        00496700
PGC                         SET PV-KMC          TO TRUE                 00496800
PGC                       WHEN 4                                        00496900
PGC                         SET PV-OAKMC        TO TRUE                 00497000
PGC                       WHEN 5                                        00497100
PGC                         SET PV-FILAKMC      TO TRUE                 00497200
PGC                       END-EVALUATE                                  00497300
PGC                    END-IF                                           00497400
PGC                   ELSE                                              00497500
PGC                    SET SV005-HARD-DECLINE TO TRUE                   00497600
PGC                   END-IF                                            00497700
PGC              ELSE                                                   00497800
120200                                                                  00497900
127400*  virtual gift card issue                                        00498000
127400           IF PV-E-ECOMMERCE-STORE AND                            00498100
127500              PV-ISSUANCE-AS-GIFT-CARD AND                        00498200
PGC                 PV-KMC-ID = ZEROES                                  00498300
                                                                        00498400
PGC   *     PV-VIRTUAL LOOKING FOR THE LAST ISSUED VIRTUAL              00498500
PGC   *                CARD, DO NOT NEED THIS FOR PLASTIC CARD          00498600
PGC                    SET PV-VIRTUAL      TO TRUE                      00498700
127600                 SET SV005-APPROVE TO TRUE                        00498800
127700                 INITIALIZE SV005-PA-RETRY-COUNT                  00498900
127800                 MOVE ZEROES       TO PV-CRD-PROD-YR              00499000
127900                                     PV-SHIPT-REQ-NBR             00499100
128000                 SET PS-VIRTUAL-CSR-NOT-AT-END TO TRUE            00499200
128100                 SET PS-FETCH-AGAIN            TO TRUE            00499300
128200                 PERFORM 2410-OPEN-CURSOR                         00499400
128300                 PERFORM 2400-VIRTUAL-ISSUE                       00499500
128400                  UNTIL PS-FETCH-OK  OR                           00499600
128500                        PS-VIRTUAL-CSR-AT-END                     00499700
128600                 IF PS-VIRTUAL-CSR-AT-END                         00499800
128700                  PERFORM 9300-NETCOOL-MESSAGE                    00499900
128800                  SET PS-SYSTEM-ERROR-DETECTED                    00500000
128900                      PV-CODE-HARD-DECLINE                        00500100
129000                      EP000-SL-ERROR                              00500200
129100                      PS-AUTH-MESSAGE-ERROR  TO TRUE              00500300
129200                  MOVE AU001-DATA-BUF                             00500400
129300                          TO AM-POS-INQ-REMOTE-AUTH-MSG           00500500
129400                  ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER        00500600
129500                  MOVE 'NO VIRTUAL GIFT CARD LEFT TO ISSUE '      00500700
129600                          TO EP000-MD-SYSTEM-LOG-MESSAGE          00500800
129700                                   (EP000-MESSAGE-LINE-COUNTER)   00500900
129800                  PERFORM EP000-1000-POST-MESSAGE                 00501000
129900                  MOVE SVT00001-CRD-NBR TO PV-KMC-ID              00501100
130000                                           SV005-KMC-ID           00501200
130100                  MOVE SVT00001-CRD-PIN-NBR TO SV005-PIN          00501300
130200                 ELSE                                             00501400
330300                  IF PS-FETCH-OK                                  00501500
130400                     MOVE SVT00001-CRD-NBR TO PV-KMC-ID           00501600
130500                                              SV005-KMC-ID        00501700
130600                     MOVE SVT00001-CRD-PIN-NBR TO SV005-PIN       00501800
130700                     MOVE SV005-TRANS-AMT TO                      00501900
130800                                    SV005-APPROVED-TENDER-AMT     00502000
130900                     COMPUTE SV005-KMC-REMAINING-BALANCE =        00502100
131000                         SV005-KMC-ORIGINAL-BALANCE               00502200
131100                       + SV005-TRANS-AMT                          00502300
131200                     SET SV005-PS-VIRTUAL-OK TO TRUE              00502400
131300                     SET SV005-APPROVE TO TRUE                    00502500
131400                     PERFORM 2460-CLOSE-CURSOR                    00502600
131500                  END-IF                                          00502700
131600                 END-IF                                           00502800
131700           ELSE                                                   00502900
                    IF PV-SUCCESSFUL-AUTHORIZATION                      00503000
131810                 PERFORM SV005-A100-MAINLINE                      00503100
051722* ONLY EXECUTE FRAUD CARD CHECKS WHEN FRAUD ACTIVE = 'Y'          00503200
051722* THIS AVOID UNNECESSARY DB2 CALLS WHEN NO FRAUD ATTACKS          00503300
051722* ARE PRESENTLY UNDERWAY.                                         00503400
051722                 IF SVT00018-FRAUD-ACTIVE-IND = 'Y'               00503500
051722                     PERFORM 6000-FRAUD-CARD-LOCK-CHECK           00503600
051722                 END-IF                                           00503700
268131* THIS WAS DONE TO MAKE SURE INVALID ACCOUNT AND INVALID PIN      00503800
268131* DONT RESULT IN TWO DIFFERENT RESPONSE CODES, BOTH SHOULD HAVE   00503900
268131* A HARD DECLINE = 7.                                             00504000
268131                 IF SV005-INVALID-PIN                             00505800
268131                     SET SV005-HARD-DECLINE TO TRUE               00506000
268131                 END-IF                                           00506100
131600              END-IF                                              00506200
131900           END-IF                                                 00506300
132000        END-IF                                                    00506400
332100     END-IF.                                                      00506500
132200                                                                  00506600
132200                                                                  00506700
PGC   *----------------------------------------------------------------*00506800
PGC   *  FIND THE SPECIALTY CODE OF THE CARD                           *00506900
PGC   *  IF IT'S A 2 THEN IT'S A VIRTUAL GIFT CARD OTHERWISE IT'S      *00507000
PGC   *     PLASTIC                                                    *00507100
PGC   *----------------------------------------------------------------*00507200
PGC    2150-SELECT-SPEC.                                                00507300
PGC                                                                     00507400
PGC        MOVE PV-KMC-ID TO PV-KMC-ID-COMP.                            00507500
PGC                                                                     00507600
PGC        EXEC SQL                                                     00507700
PGC           SELECT  CRD_NBR                                           00507800
PGC                ,  CRD_SPCTY_TYP_CDE                                 00507900
PGC           INTO  :SVT00001-CRD-NBR                                   00508000
PGC              ,  :SVT00001-CRD-SPCTY-TYP-CDE                         00508100
PGC           FROM  SVT_KOHLS_CRD_ACCT                                  00508200
PGC           WHERE  CRD_NBR = :PV-KMC-ID-COMP                          00508300
PGC        END-EXEC.                                                    00508400
PGC                                                                     00508500
PGC        EVALUATE TRUE                                                00508600
PGC                                                                     00508700
PGC          WHEN SQLCODE = 0                                           00508800
PGC               SET PV-SUCCESSFUL-AUTHORIZATION TO TRUE               00508900
PGC                                                                     00509000
PGC          WHEN SQLCODE = +100                                        00509100
PGC            SET PS-SYSTEM-ERROR-DETECTED                             00509200
PGC                PV-EDIT-ERROR                                        00509300
PGC                EP000-SL-ERROR                                       00509400
PGC                PS-AUTH-MESSAGE-ERROR  TO TRUE                       00509500
PGC            MOVE AU001-DATA-BUF      TO AM-POS-INQ-REMOTE-AUTH-MSG   00509600
PGC                                                                     00509700
PGC            MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                00509800
PGC            MOVE AM-AUTH-MESSAGE-ERROR-MESSAGE                       00509900
PGC                   TO  EP000-MD-SYSTEM-LOG-MESSAGE                   00510000
PGC                      (EP000-MESSAGE-LINE-COUNTER)                   00510100
PGC            MOVE 'CARD DOES NOT EXIST '                              00510200
PGC                       TO EP000-MD-SYSTEM-LOG-MESSAGE                00510300
PGC                                        (EP000-MESSAGE-LINE-COUNTER) 00510400
PGC            ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                 00510500
PGC            PERFORM EP000-1000-POST-MESSAGE                          00510600
PGC            MOVE 2 TO PV-REFERRAL-CODE-NUMBER                        00510700
PGC            SET SV005-HARD-DECLINE TO TRUE                           00510800
PGC            SET PV-CARD-NOT-ACTIVE TO TRUE                           00510900
PGC                                                                     00511100
PGC          WHEN OTHER                                                 00511200
PGC            SET PS-SYSTEM-ERROR-DETECTED                             00511300
PGC                PV-EDIT-ERROR                                        00511400
PGC                EP000-SL-ERROR                                       00511500
PGC                PS-AUTH-MESSAGE-ERROR  TO TRUE                       00511600
PGC            MOVE AU001-DATA-BUF      TO AM-POS-INQ-REMOTE-AUTH-MSG   00511700
PGC                                                                     00511800
PGC            MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                00511900
PGC            MOVE AM-AUTH-MESSAGE-ERROR-MESSAGE                       00512000
PGC                   TO  EP000-MD-SYSTEM-LOG-MESSAGE                   00512100
PGC                      (EP000-MESSAGE-LINE-COUNTER)                   00512200
PGC            ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                 00512300
PGC            MOVE 'GET THE SPECIALTY CODE ON CARD '                   00512400
PGC                            TO EP000-MD-SYSTEM-LOG-MESSAGE           00512500
PGC                                        (EP000-MESSAGE-LINE-COUNTER) 00512600
PGC            PERFORM EP000-1000-POST-MESSAGE                          00512700
PGC            MOVE 2 TO PV-REFERRAL-CODE-NUMBER                        00512800
PGC            SET PV-CARD-NOT-ACTIVE TO TRUE                           00512900
PGC            SET SV005-HARD-DECLINE TO TRUE                           00513000
PGC          END-EVALUATE.                                              00513100
PGC                                                                     00513200
PGC                                                                     00513300
PGC   *----------------------------------------------------------------*00513400
PGC   *  FIND IF THERE ALREADY IS AN ISSUE OF THE CARD                 *00513500
PGC   *----------------------------------------------------------------*00513600
PGC    2175-SELECT-TXN.                                                 00513700
PGC                                                                     00513800
PGC        MOVE PV-KMC-ID TO PV-KMC-ID-COMP.                            00513900
PGC                                                                     00514000
PGC        EXEC SQL                                                     00514100
PGC           SELECT  CRD_NBR                                           00514200
PGC           INTO  :SVT00002-CRD-NBR                                   00514300
PGC           FROM  SVT_KOHLS_CRD_TXN                                   00514400
PGC           WHERE  CRD_NBR = :PV-KMC-ID-COMP                          00514500
PGC             AND  ACTVY_TYP_CDE = 2                                  00514600
PGC        END-EXEC.                                                    00514700
PGC                                                                     00514800
PGC        EVALUATE TRUE                                                00514900
PGC                                                                     00515000
PGC          WHEN SQLCODE = 0                                           00515100
PGC            SET PS-SYSTEM-ERROR-DETECTED                             00515200
PGC                PV-EDIT-ERROR                                        00515300
PGC                EP000-SL-ERROR                                       00515400
PGC                PS-AUTH-MESSAGE-ERROR  TO TRUE                       00515500
PGC        MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER       00515600
PGC        MOVE PC-ONE             TO  EP000-MESSAGE-LINE-COUNTER       00515700
PGC        MOVE AU002-DATA-BUF     TO  EP000-MD-SYSTEM-LOG-MESSAGE      00515800
PGC                                (EP000-MESSAGE-LINE-COUNTER)         00515900
PGC        STRING 'ISSUE ALREADY DONE '                                 00516000
PGC                  DELIMITED BY SIZE                                  00516100
PGC                  INTO  EP000-MD-SYSTEM-LOG-MESSAGE                  00516200
PGC                       (EP000-MESSAGE-LINE-COUNTER)                  00516300
PGC        END-STRING                                                   00516400
PGC        ADD  PC-ONE             TO  EP000-MESSAGE-LINE-COUNTER       00516500
PGC        PERFORM EP000-1000-POST-MESSAGE                              00516600
PGC            MOVE 2 TO PV-REFERRAL-CODE-NUMBER                        00516700
PGC            SET SV005-HARD-DECLINE TO TRUE                           00516800
PGC            SET PV-CARD-ALREADY-ACTIVE  TO TRUE                      00516900
PGC                                                                     00517000
PGC          WHEN SQLCODE = +100                                        00517100
PGC            SET PV-NO-ISSUE-DONE  TO TRUE                            00517200
PGC                                                                     00517300
PGC                                                                     00517400
PGC                                                                     00517500
PGC          WHEN OTHER                                                 00517600
PGC            SET PS-SYSTEM-ERROR-DETECTED                             00517700
PGC                PV-EDIT-ERROR                                        00517800
PGC                EP000-SL-ERROR                                       00517900
PGC                PS-AUTH-MESSAGE-ERROR  TO TRUE                       00518000
PGC            MOVE AU001-DATA-BUF      TO AM-POS-INQ-REMOTE-AUTH-MSG   00518100
PGC                                                                     00518200
PGC            MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                00518300
PGC            MOVE AM-AUTH-MESSAGE-ERROR-MESSAGE                       00518400
PGC                   TO  EP000-MD-SYSTEM-LOG-MESSAGE                   00518500
PGC                      (EP000-MESSAGE-LINE-COUNTER)                   00518600
PGC            ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                 00518700
PGC            MOVE 'CHECK TXN TABLE FOR ISSUE '                        00518800
PGC                            TO EP000-MD-SYSTEM-LOG-MESSAGE           00518900
PGC                                        (EP000-MESSAGE-LINE-COUNTER) 00519000
PGC            PERFORM EP000-1000-POST-MESSAGE                          00519100
PGC          END-EVALUATE.                                              00519200
PGC                                                                     00519300
051722*----------------------------------------------------------------*00519400
051722*  SELECT THE FRAUD PARAMETERS FROM THE SVT_FRAUD_PARM TABLE     *00519500
051722*----------------------------------------------------------------*00519600
051722 2180-SELECT-FRAUD-PARM.                                          00519700
051722                                                                  00519800
051722     EXEC SQL                                                     00520500
051722        SELECT  FRAUD_ACTIVE_IND                                  00520600
051722             ,  LOCK_THRESHOLD                                    00520700
051722        INTO  :SVT00018-FRAUD-ACTIVE-IND                          00520800
051722           ,  :SVT00018-LOCK-THRESHOLD                            00520900
051722        FROM  SVT_FRAUD_PARM                                      00521000
051722     END-EXEC.                                                    00521200
051722                                                                  00521300
051722     EVALUATE TRUE                                                00521400
051722       WHEN SQLCODE = 0                                           00521600
051722            SET PS-FRAUD-PARM-FOUND TO TRUE                       00521700
051722       WHEN OTHER                                                 00521900
051722           SET PS-FRAUD-PARM-NOT-FOUND TO TRUE                    00522000
051722           MOVE 'Y'                 TO SVT00018-FRAUD-ACTIVE-IND  00522200
051722           MOVE 20                  TO SVT00018-LOCK-THRESHOLD    00522300
051722                                       DB-FRAUD-COUNTER           00522400
051722           MOVE SQLCODE             TO DB-SQLCODE                 00522500
051722                                                                  00522900
051722           MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER              00523000
051722           MOVE DB-DB2-ERROR-MESSAGE                              00523100
051722                TO  EP000-MD-SYSTEM-LOG-MESSAGE                   00523200
051722                   (EP000-MESSAGE-LINE-COUNTER)                   00523300
051722           ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER               00523400
051722           MOVE 'DEFAULT FRAUD PARMS USED   '                     00523500
051722                               TO EP000-MD-SYSTEM-LOG-MESSAGE     00523600
051722                                     (EP000-MESSAGE-LINE-COUNTER) 00523700
051722           PERFORM EP000-1000-POST-MESSAGE                        00523800
051722       END-EVALUATE.                                              00526200
051722                                                                  00526300
051722*2180-EXIT.                                                       00526400
051722                                                                  00526500
051722*----------------------------------------------------------------*00526600
051722*  SELECT THE CARD FAILED ATTEMPTS FROM SVT_CARD_FAILED_ATTAMPTS *00526700
051722*----------------------------------------------------------------*00526800
051722 2185-SELECT-CARD-FAILED-ATT.                                     00526900
051722                                                                  00527000
051722     SET PS-CARD-FAILED-NOT-FOUND TO TRUE.                        00527100
051722     MOVE 'N'              TO SVT00019-CARD-LOCK-INDICATOR.       00527200
051722     MOVE SV005-KMC-ID     TO SVT00019-CRD-NBR.                   00527300
051722     IF PV-BALANCE-INQUIRY                                        00527400
051722         MOVE 'BI'         TO SVT00019-TRAN-TYPE-CODE             00527500
051722     ELSE                                                         00527600
051722         MOVE 'RE'         TO SVT00019-TRAN-TYPE-CODE             00527700
051722     END-IF.                                                      00527800
051722                                                                  00527900
051722     EXEC SQL                                                     00528000
051722        SELECT                                                    00528100
051722                CARD_LOCK_INDICATOR                               00528300
051722             ,  FAIL_COUNT                                        00528400
051722        INTO                                                      00528500
051722              :SVT00019-CARD-LOCK-INDICATOR                       00528700
051722           ,  :SVT00019-FAIL-COUNT                                00528800
051722        FROM  SVT_CARD_FAILED_ATTEMPTS                            00528900
051722        WHERE   CRD_NBR       = :SVT00019-CRD-NBR                 00529100
051722            AND TRAN_TYPE_CODE = :SVT00019-TRAN-TYPE-CODE         00529200
051722     END-EXEC.                                                    00529300
051722                                                                  00529400
051722     EVALUATE TRUE                                                00529500
051722                                                                  00529600
051722       WHEN SQLCODE = 0                                           00529700
051722            SET PS-CARD-FAILED-FOUND TO TRUE                      00529800
051722       WHEN SQLCODE = +100                                        00529900
051722            SET PS-CARD-FAILED-NOT-FOUND TO TRUE                  00530000
051722            PERFORM 6200-CHECK-FOR-INSERT-FLD-ATT                 00531000
051722       WHEN OTHER                                                 00534000
051722            SET PS-CARD-FAILED-NOT-FOUND TO TRUE                  00534100
051722     END-EVALUATE.                                                00534200
051722                                                                  00534300
051722*2185-EXIT.                                                       00535000
051722                                                                  00535200
051722*----------------------------------------------------------------*00535300
051722* INSERT SVT_CARD_FAILED_ATTEMPTS TABLE                          *00535400
051722*----------------------------------------------------------------*00535700
051722 2190-INSERT-CRD-FLD-ATT-TABLE.                                   00535800
051722                                                                  00535900
051722     SET PS-CRD-FLD-ATT-NOT-INSERTED TO TRUE.                     00536000
051722     MOVE 'N'  TO SVT00019-CARD-LOCK-INDICATOR.                   00536100
051722     MOVE +1   TO SVT00019-FAIL-COUNT.                            00536200
051722     MOVE SV005-KMC-ID     TO SVT00019-CRD-NBR.                   00536700
051722     IF PV-BALANCE-INQUIRY                                        00537400
051722         MOVE 'BI'         TO SVT00019-TRAN-TYPE-CODE             00537500
051722     ELSE                                                         00537600
051722         MOVE 'RE'         TO SVT00019-TRAN-TYPE-CODE             00537700
051722     END-IF.                                                      00537800
051722                                                                  00537900
051722     EXEC SQL INSERT                                              00538000
051722              INTO SVT_CARD_FAILED_ATTEMPTS                       00538100
051722                  (CRD_NBR                                        00538200
051722                  ,TRAN_TYPE_CODE                                 00538300
051722                  ,CARD_LOCK_INDICATOR                            00538400
051722                  ,FAIL_COUNT)                                    00538500
051722           VALUES                                                 00538600
051722              (:SVT00019-CRD-NBR                                  00538700
051722              ,:SVT00019-TRAN-TYPE-CODE                           00538800
051722              ,:SVT00019-CARD-LOCK-INDICATOR                      00538900
051722              ,:SVT00019-FAIL-COUNT)                              00539000
051722      END-EXEC.                                                   00540300
051722                                                                  00540400
051722      EVALUATE TRUE                                               00540500
051722               WHEN SQLCODE = -904                                00540600
051722               WHEN SQLCODE = -913                                00540700
051722                    ADD 1 TO PV-RETRY-COUNT                       00540800
051722               WHEN SQLCODE < 0                                   00540900
051722                    MOVE SV005-KMC-ID  TO  AA-ATTEMPTED-CRD       00541000
051722                    MOVE                                          00541100
051722                      ' INSERT CRD_FLD ATT ROW  (SVT00019)'       00541200
051722                                 TO AA-ATTEMPTED-ACT              00541300
051722                    PERFORM 9100-DB2-ERROR                        00541400
051722                    PERFORM 9999-RETURN-TO-NATIVE-CICS            00541500
051722               WHEN SQLCODE > 0                                   00541600
051722               WHEN SQLWARN0 NOT = SPACES                         00541700
051722                    MOVE 'INSERT CRD FLD_ATT ROW  (SVT00019)'     00541800
051722                                 TO AA-ATTEMPTED-ACTION           00541900
051722                    PERFORM 9200-DB2-WARNING                      00542000
051722                    PERFORM 9999-RETURN-TO-NATIVE-CICS            00542100
051722               WHEN SQLCODE = 0                                   00542200
051722                    SET PS-CRD-FLD-ATT-INSERTED TO TRUE           00542300
051722               WHEN OTHER                                         00542400
051722                    CONTINUE                                      00542500
051722      END-EVALUATE.                                               00542600
051722                                                                  00542700
051722*2190-EXIT.                                                       00542800
051722                                                                  00542900
051722*----------------------------------------------------------------*00543000
051722* UPDATE SVT_CARD_FAILED_ATTEMPTS TABLE                          *00543100
051722*----------------------------------------------------------------*00543200
051722 2195-UPDATE-CRD-FLD-ATT-TABLE.                                   00543300
051722                                                                  00543400
051722     IF SVT00019-FAIL-COUNT <= PC-MAX-SMALLINT                    00543500
051722         ADD +1 TO SVT00019-FAIL-COUNT                            00543600
051722     END-IF.                                                      00543700
051722     MOVE 'N'              TO SVT00019-CARD-LOCK-INDICATOR.       00543800
051722     IF SVT00019-FAIL-COUNT >= SVT00018-LOCK-THRESHOLD            00543900
051722* INITIALLY WE DON'T WANT TO LOCK REDEMPTIONS, ONLY BAL INQ       00544000
051722         IF PV-BALANCE-INQUIRY                                    00544100
051722             MOVE 'Y'      TO SVT00019-CARD-LOCK-INDICATOR        00544200
051722         END-IF                                                   00544300
051722     END-IF.                                                      00544400
051722     MOVE SV005-KMC-ID     TO SVT00019-CRD-NBR.                   00544500
051722     IF PV-BALANCE-INQUIRY                                        00544900
051722         MOVE 'BI'         TO SVT00019-TRAN-TYPE-CODE             00545000
051722     ELSE                                                         00545100
051722*        PV-TENDER OR PV-REAUTH                                   00545200
051722         MOVE 'RE'         TO SVT00019-TRAN-TYPE-CODE             00545400
051722     END-IF.                                                      00545500
051722                                                                  00545600
051722     EXEC SQL                                                     00545700
051722         UPDATE SVT_CARD_FAILED_ATTEMPTS                          00545800
051722           SET                                                    00545900
051722              FAIL_COUNT          = :SVT00019-FAIL-COUNT          00546000
051722             ,CARD_LOCK_INDICATOR = :SVT00019-CARD-LOCK-INDICATOR 00546100
051722           WHERE                                                  00546200
051722               CRD_NBR       = :SVT00019-CRD-NBR                  00546300
051722           AND TRAN_TYPE_CODE = :SVT00019-TRAN-TYPE-CODE          00546400
051722      END-EXEC.                                                   00546500
051722                                                                  00546600
051722     EVALUATE TRUE                                                00546700
051722              WHEN SQLCODE = -904                                 00546800
051722              WHEN SQLCODE = -913                                 00546900
051722                   ADD 1 TO PV-RETRY-COUNT                        00547000
051722              WHEN SQLCODE < 0                                    00547100
051722                    MOVE 'UPDATE CRD_FLD ATT ROW (SVT00019) '     00547200
051722                                 TO AA-ATTEMPTED-ACTION           00547300
051722                    PERFORM 9100-DB2-ERROR                        00547400
051722                    PERFORM 9999-RETURN-TO-NATIVE-CICS            00547500
051722               WHEN SQLCODE > 0                                   00547600
051722               WHEN SQLWARN0 NOT = SPACES                         00547700
051722                    MOVE 'UPDATE CRD FLD_ATT ROW (SVT00019) '     00547800
051722                                 TO AA-ATTEMPTED-ACTION           00547900
051722                    PERFORM 9200-DB2-WARNING                      00548000
051722                    PERFORM 9999-RETURN-TO-NATIVE-CICS            00548100
051722               WHEN OTHER                                         00548200
051722                    CONTINUE                                      00548300
051722      END-EVALUATE.                                               00548400
051722                                                                  00548500
051722*2195-EXIT.                                                       00548600
051722                                                                  00548700
132310*----------------------------------------------------------------*00548800
132400* POS TEST ACCOUNT RESPONSES                                     *00548900
132500* STANDARD TEST RESPONSES USED BY POS SYSTEM TESTING             *00549000
132600* RESPONSES ARE THE SAME NO MATTER WHAT TRANSACTION AMOUNT IS.   *00549100
132700*----------------------------------------------------------------*00549200
132800 2200-TEST-ACCOUNTS.                                              00549300
132900            EVALUATE TRUE                                         00549400
133000             WHEN  PV-BALANCE-INQUIRY                             00549500
133100                 IF (PV-KMC-ID = PC-TRNG-KMRC-1000000008          00549600
133200                 OR  PV-KMC-ID = PC-TEST-KMRC-1000000073          00549700
133300                 OR  PV-KMC-ID = PC-TRNG-GIFT-1000000164          00549800
133400                 OR  PV-KMC-ID = PC-TRNG-GIFT-1000000248          00549900
133500                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000321          00550000
133600                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000289          00550100
133610                 OR  PV-KMC-ID = PC-TRNG-KMRC-101000000006        00550200
133620                 OR  PV-KMC-ID = PC-TEST-KMRC-101000000071        00550300
133640                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000162        00550400
133650                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000246        00550500
133660                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000329        00550600
133680                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000287)       00550700
133700                    MOVE 0      TO SV005-RESPONSE-CODE            00550800
133800                    MOVE 10.00  TO SV005-TRANS-AMT                00550900
133900                 END-IF                                           00551000
134000                 IF (PV-KMC-ID = PC-TRNG-KMRC-1000000016          00551100
134100                 OR  PV-KMC-ID = PC-TEST-KMRC-1000000081          00551200
134110                 OR  PV-KMC-ID = PC-TRNG-KMRC-101000000014        00551300
134120                 OR  PV-KMC-ID = PC-TEST-KMRC-101000000089)       00551400
134200                    MOVE 0      TO SV005-RESPONSE-CODE            00551500
134300                    MOVE 15.00  TO SV005-TRANS-AMT                00551600
134400                 END-IF                                           00551700
134500                 IF (PV-KMC-ID = PC-TRNG-KMRC-1000000024          00551800
134600                 OR  PV-KMC-ID = PC-TEST-KMRC-1000000099          00551900
134610                 OR  PV-KMC-ID = PC-TRNG-KMRC-101000000022        00552000
134620                 OR  PV-KMC-ID = PC-TEST-KMRC-101000000097)       00552100
134700                    MOVE 0      TO SV005-RESPONSE-CODE            00552200
134800                    MOVE 20.00  TO SV005-TRANS-AMT                00552300
134900                 END-IF                                           00552400
135000                 IF (PV-KMC-ID = PC-TRNG-KMRC-1000000149          00552500
135100                 OR  PV-KMC-ID = PC-TEST-KMRC-1000000156          00552600
135200                 OR  PV-KMC-ID = PC-TRNG-GIFT-1000000172          00552700
135300                 OR  PV-KMC-ID = PC-TRNG-GIFT-1000000255          00552800
135400                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000339          00552900
135500                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000297          00553000
135510                 OR  PV-KMC-ID = PC-TRNG-KMRC-101000000147        00553100
135520                 OR  PV-KMC-ID = PC-TEST-KMRC-101000000154        00553200
135540                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000170        00553300
135550                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000253        00553400
135560                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000337        00553500
135580                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000295)       00553600
135600                    MOVE 0      TO SV005-RESPONSE-CODE            00553700
135700                    MOVE 25.00  TO SV005-TRANS-AMT                00553800
135800                 END-IF                                           00553900
135900                 IF (PV-KMC-ID = PC-TRNG-GIFT-1000000180          00554000
136000                 OR  PV-KMC-ID = PC-TRNG-GIFT-1000000263          00554100
136100                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000347          00554200
136200                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000305          00554300
136210                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000188        00554400
136220                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000261        00554500
136230                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000345        00554600
136260                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000303)       00554700
136300                    MOVE 0      TO SV005-RESPONSE-CODE            00554800
136400                    MOVE 50.00  TO SV005-TRANS-AMT                00554900
136500                 END-IF                                           00555000
136600                 IF (PV-KMC-ID = PC-TRNG-GIFT-1000000198          00555100
136700                 OR  PV-KMC-ID = PC-TRNG-GIFT-1000000271          00555200
136800                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000354          00555300
136900                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000313          00555400
136910                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000196        00555500
136920                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000279        00555600
136930                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000352        00555700
136940                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000311)       00555800
137000                    MOVE 0      TO SV005-RESPONSE-CODE            00555900
137100                    MOVE 100.00  TO SV005-TRANS-AMT               00556000
137200                 END-IF                                           00556100
137300                 IF (PV-KMC-ID = PC-TRNG-GIFT-1000000438          00556200
137400                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000412          00556300
137500                 OR  PV-KMC-ID = PC-TRNG-KMRC-1000000420          00556400
137600                 OR  PV-KMC-ID = PC-TEST-KMRC-1000000404          00556500
137610                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000436        00556600
137620                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000410        00556700
137630                 OR  PV-KMC-ID = PC-TRNG-KMRC-101000000428        00556800
137640                 OR  PV-KMC-ID = PC-TEST-KMRC-101000000402)       00556900
137700                    MOVE 0      TO SV005-RESPONSE-CODE            00557000
137800                    MOVE 200.00  TO SV005-TRANS-AMT               00557100
137900                 END-IF                                           00557200
138000             WHEN  PV-ISSUANCE-AS-KMRC                            00557300
138100                 IF (PV-KMC-ID = PC-TRNG-KMRC-1000000008          00557400
138200                 OR  PV-KMC-ID = PC-TRNG-KMRC-1000000016          00557500
138300                 OR  PV-KMC-ID = PC-TRNG-KMRC-1000000024          00557600
138400                 OR  PV-KMC-ID = PC-TRNG-KMRC-1000000149          00557700
138500                 OR  PV-KMC-ID = PC-TEST-KMRC-1000000073          00557800
138600                 OR  PV-KMC-ID = PC-TEST-KMRC-1000000081          00557900
138700                 OR  PV-KMC-ID = PC-TEST-KMRC-1000000099          00558000
138800                 OR  PV-KMC-ID = PC-TEST-KMRC-1000000156          00558100
138810                 OR  PV-KMC-ID = PC-TRNG-KMRC-101000000006        00558200
138811                 OR  PV-KMC-ID = PC-TRNG-KMRC-101000000014        00558300
138812                 OR  PV-KMC-ID = PC-TRNG-KMRC-101000000022        00558400
138813                 OR  PV-KMC-ID = PC-TRNG-KMRC-101000000147        00558500
138820                 OR  PV-KMC-ID = PC-TEST-KMRC-101000000071        00558600
138870                 OR  PV-KMC-ID = PC-TEST-KMRC-101000000089        00558700
138871                 OR  PV-KMC-ID = PC-TEST-KMRC-101000000097        00558800
138876                 OR  PV-KMC-ID = PC-TEST-KMRC-101000000154)       00558900
138900                    MOVE 0              TO SV005-RESPONSE-CODE    00559000
139000                    MOVE PV-KMC-AMT     TO SV005-TRANS-AMT        00559100
139100                 END-IF                                           00559200
139200                 IF (PV-KMC-ID = PC-TRNG-KMRC-1000000420          00559300
139300                 OR  PV-KMC-ID = PC-TEST-KMRC-1000000404          00559400
139310                 OR  PV-KMC-ID = PC-TRNG-KMRC-101000000428        00559500
139320                 OR  PV-KMC-ID = PC-TEST-KMRC-101000000402)       00559600
139400                     MOVE 0             TO SV005-RESPONSE-CODE    00559700
139500                     COMPUTE SV005-TRANS-AMT = SV005-TRANS-AMT    00559800
139600                                             + 10.00              00559900
139700                 END-IF                                           00560000
139800             WHEN  PV-ISSUANCE-AS-GIFT-CARD                       00560100
139900                 IF (PV-KMC-ID = PC-TEST-GIFT-1000000321          00560200
140000                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000339          00560300
140100                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000347          00560400
140200                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000354          00560500
140300                 OR  PV-KMC-ID = PC-TRNG-GIFT-1000000164          00560600
140400                 OR  PV-KMC-ID = PC-TRNG-GIFT-1000000172          00560700
140500                 OR  PV-KMC-ID = PC-TRNG-GIFT-1000000180          00560800
140600                 OR  PV-KMC-ID = PC-TRNG-GIFT-1000000198          00560900
140610                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000329        00561000
140611                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000337        00561100
140612                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000345        00561200
140613                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000352        00561300
140620                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000162        00561400
140630                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000170        00561500
140640                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000188        00561600
140650                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000196)       00561700
140700                    MOVE 0              TO SV005-RESPONSE-CODE    00561800
140800                    MOVE PV-KMC-AMT     TO SV005-TRANS-AMT        00561900
140900                 END-IF                                           00562000
141000                 IF (PV-KMC-ID = PC-TRNG-GIFT-1000000248          00562100
141100                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000289          00562200
141110                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000246        00562300
141120                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000287)       00562400
141200                    MOVE 0      TO SV005-RESPONSE-CODE            00562500
141300                    MOVE 10.00  TO SV005-TRANS-AMT                00562600
141400                 END-IF                                           00562700
141500                 IF (PV-KMC-ID = PC-TRNG-GIFT-1000000255          00562800
141600                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000297          00562900
141610                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000253        00563000
141620                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000295)       00563100
141700                    MOVE 0      TO SV005-RESPONSE-CODE            00563200
141800                    MOVE 25.00  TO SV005-TRANS-AMT                00563300
141900                 END-IF                                           00563400
142000                 IF (PV-KMC-ID = PC-TRNG-GIFT-1000000263          00563500
142100                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000305          00563600
142110                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000261        00563700
142120                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000303)       00563800
142200                    MOVE 0      TO SV005-RESPONSE-CODE            00563900
142300                    MOVE 50.00  TO SV005-TRANS-AMT                00564000
142400                 END-IF                                           00564100
142500                 IF (PV-KMC-ID = PC-TRNG-GIFT-1000000271          00564200
142600                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000313          00564300
142610                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000279        00564400
142620                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000311)       00564500
142700                    MOVE 0      TO SV005-RESPONSE-CODE            00564600
142800                    MOVE 100.00  TO SV005-TRANS-AMT               00564700
142900                 END-IF                                           00564800
143000                 IF (PV-KMC-ID = PC-TRNG-GIFT-1000000438          00564900
143100                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000412          00565000
143110                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000436        00565100
143120                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000410)       00565200
143200                     MOVE 0             TO SV005-RESPONSE-CODE    00565300
143300                     COMPUTE SV005-TRANS-AMT = SV005-TRANS-AMT    00565400
143400                                             + 10.00              00565500
143500                 END-IF                                           00565600
143600             WHEN  PV-TENDER                                      00565700
143700                 IF (PV-KMC-ID = PC-TRNG-KMRC-1000000008          00565800
143800                 OR  PV-KMC-ID = PC-TEST-KMRC-1000000073          00565900
143900                 OR  PV-KMC-ID = PC-TRNG-GIFT-1000000248          00566000
144000                 OR  PV-KMC-ID = PC-TRNG-GIFT-1000000164          00566100
144100                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000321          00566200
144200                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000289          00566300
144300                 OR  PV-KMC-ID = PC-TRNG-GIFT-1000000438          00566400
144400                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000412          00566500
144410                 OR  PV-KMC-ID = PC-TRNG-KMRC-101000000006        00566600
144420                 OR  PV-KMC-ID = PC-TEST-KMRC-101000000071        00566700
144430                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000162        00566800
144440                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000246        00566900
144450                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000329        00567000
144460                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000287        00567100
144470                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000436        00567200
144480                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000410)       00567300
144500                    IF PV-KMC-AMT <= PC-TWO-DOLLARS               00567400
144600                        MOVE 1  TO SV005-RESPONSE-CODE            00567500
144700                        MOVE 0  TO SV005-TRANS-AMT                00567600
144800                    ELSE                                          00567700
144900                        MOVE 0  TO SV005-RESPONSE-CODE            00567800
145000                        SUBTRACT PC-TWO-DOLLARS                   00567900
145100                           FROM PV-KMC-AMT                        00568000
145200                           GIVING SV005-TRANS-AMT                 00568100
145300                    END-IF                                        00568200
145400                 END-IF                                           00568300
145500                 IF (PV-KMC-ID = PC-TRNG-KMRC-1000000149          00568400
145600                 OR  PV-KMC-ID = PC-TEST-KMRC-1000000156          00568500
145700                 OR  PV-KMC-ID = PC-TRNG-GIFT-1000000271          00568600
145800                 OR  PV-KMC-ID = PC-TRNG-GIFT-1000000198          00568700
145900                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000354          00568800
146000                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000313          00568900
146010                 OR  PV-KMC-ID = PC-TRNG-KMRC-101000000147        00569000
146020                 OR  PV-KMC-ID = PC-TEST-KMRC-101000000154        00569100
146070                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000279        00569200
146080                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000196        00569300
146091                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000352        00569400
146092                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000311)       00569500
146100                    MOVE 0      TO SV005-RESPONSE-CODE            00569600
146200                    COMPUTE SV005-TRANS-AMT =                     00569700
146300                        PC-TWO-DOLLARS + PV-KMC-AMT               00569800
146400                 END-IF                                           00569900
146500                 IF (PV-KMC-ID = PC-TRNG-KMRC-1000000016          00570000
146600                 OR  PV-KMC-ID = PC-TEST-KMRC-1000000081          00570100
146700                 OR  PV-KMC-ID = PC-TRNG-GIFT-1000000255          00570200
146800                 OR  PV-KMC-ID = PC-TRNG-GIFT-1000000172          00570300
146900                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000339          00570400
147000                 OR  PV-KMC-ID = PC-TRNG-KMRC-101000000014        00570500
147010                 OR  PV-KMC-ID = PC-TEST-KMRC-101000000089        00570600
147020                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000253        00570700
147021                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000170        00570800
147030                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000337)       00570900
147100                    MOVE 1      TO SV005-RESPONSE-CODE            00571000
147200                    MOVE 0      TO SV005-TRANS-AMT                00571100
147300                 END-IF                                           00571200
147400                 IF (PV-KMC-ID = PC-TRNG-KMRC-1000000024          00571300
147500                 OR  PV-KMC-ID = PC-TEST-KMRC-1000000099          00571400
147600                 OR  PV-KMC-ID = PC-TRNG-GIFT-1000000263          00571500
147700                 OR  PV-KMC-ID = PC-TRNG-GIFT-1000000180          00571600
147800                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000347          00571700
147900                 OR  PV-KMC-ID = PC-TEST-GIFT-1000000305          00571800
147910                 OR  PV-KMC-ID = PC-TRNG-KMRC-101000000022        00571900
147920                 OR  PV-KMC-ID = PC-TEST-KMRC-101000000097        00572000
147930                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000261        00572100
147940                 OR  PV-KMC-ID = PC-TRNG-GIFT-101000000188        00572200
147950                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000345        00572300
147960                 OR  PV-KMC-ID = PC-TEST-GIFT-101000000303)       00572400
148000                    MOVE 1      TO SV005-RESPONSE-CODE            00572500
148100                    MOVE 5.00   TO SV005-TRANS-AMT                00572600
148200                 END-IF                                           00572700
148300            END-EVALUATE.                                         00572800
148400                                                                  00572900
148500            IF (PV-KMC-ID = PC-TRNG-KMRC-1000000032               00573000
148600            OR  PV-KMC-ID = PC-TEST-KMRC-1000000107               00573100
148700            OR  PV-KMC-ID = PC-TRNG-GIFT-1000000206               00573200
148800            OR  PV-KMC-ID = PC-TEST-GIFT-1000000362               00573300
148810            OR  PV-KMC-ID = PC-TRNG-KMRC-101000000030             00573400
148820            OR  PV-KMC-ID = PC-TEST-KMRC-101000000105             00573500
148830            OR  PV-KMC-ID = PC-TRNG-GIFT-101000000204             00573600
148840            OR  PV-KMC-ID = PC-TEST-GIFT-101000000360)            00573700
148900               MOVE 7      TO SV005-RESPONSE-CODE                 00573800
149000               MOVE 0      TO SV005-TRANS-AMT                     00573900
149100            END-IF.                                               00574000
149200                                                                  00574100
149300            IF (PV-KMC-ID = PC-TRNG-KMRC-1000000040               00574200
149400            OR  PV-KMC-ID = PC-TEST-KMRC-1000000115               00574300
149500            OR  PV-KMC-ID = PC-TRNG-GIFT-1000000214               00574400
149600            OR  PV-KMC-ID = PC-TEST-GIFT-1000000370               00574500
149610            OR  PV-KMC-ID = PC-TRNG-KMRC-101000000048             00574600
149620            OR  PV-KMC-ID = PC-TEST-KMRC-101000000113             00574700
149630            OR  PV-KMC-ID = PC-TRNG-GIFT-101000000212             00574800
149640            OR  PV-KMC-ID = PC-TEST-GIFT-101000000378)            00574900
149700               MOVE 8      TO SV005-RESPONSE-CODE                 00575000
149800               MOVE 0      TO SV005-TRANS-AMT                     00575100
149900            END-IF.                                               00575200
150000                                                                  00575300
150100            IF (PV-KMC-ID = PC-TRNG-KMRC-1000000057               00575400
150200            OR  PV-KMC-ID = PC-TEST-KMRC-1000000123               00575500
150300            OR  PV-KMC-ID = PC-TRNG-GIFT-1000000222               00575600
150400            OR  PV-KMC-ID = PC-TEST-GIFT-1000000388               00575700
150410            OR  PV-KMC-ID = PC-TRNG-KMRC-101000000055             00575800
150420            OR  PV-KMC-ID = PC-TEST-KMRC-101000000121             00575900
150430            OR  PV-KMC-ID = PC-TRNG-GIFT-101000000220             00576000
150440            OR  PV-KMC-ID = PC-TEST-GIFT-101000000386)            00576100
150500               MOVE 9      TO SV005-RESPONSE-CODE                 00576200
150600               MOVE 0      TO SV005-TRANS-AMT                     00576300
150700            END-IF.                                               00576400
150800                                                                  00576500
150900            IF (PV-KMC-ID = PC-TRNG-KMRC-1000000065               00576600
151000            OR  PV-KMC-ID = PC-TEST-KMRC-1000000131               00576700
151100            OR  PV-KMC-ID = PC-TRNG-GIFT-1000000230               00576800
151200            OR  PV-KMC-ID = PC-TEST-GIFT-1000000396               00576900
151210            OR  PV-KMC-ID = PC-TRNG-KMRC-101000000063             00577000
151220            OR  PV-KMC-ID = PC-TEST-KMRC-101000000139             00577100
151230            OR  PV-KMC-ID = PC-TRNG-GIFT-101000000238             00577200
151240            OR  PV-KMC-ID = PC-TEST-GIFT-101000000394)            00577300
151300               MOVE 2      TO SV005-RESPONSE-CODE                 00577400
151400               MOVE 0      TO SV005-TRANS-AMT                     00577500
151500            END-IF.                                               00577600
151600                                                                  00577700
151700*----------------------------------------------------------------*00577800
151800*  ECOMMERCE TEST-ACCOUNTS RESPONSES                             *00577900
151900* RESPONSES ACT LIKE THEY ARE REAL DATABASE ACCOUNTS             *00578000
152000* I.E. FOR A $25 GIFT CARD, AND A $10 TENDER, YOU GET $15 BALANCE*00578100
152100*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*00578200
152200*  NOTE: ALL TEST ACCOUNTS USE PIN NUMBER '0123' ON WEB SITE.    *00578300
152300*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*00578400
152400*----------------------------------------------------------------*00578500
152500 2300-ECOMM-TEST-ACCOUNTS.                                        00578600
152600* DECLINE TEST CARD                                               00578700
152700     EVALUATE TRUE                                                00578800
152800       WHEN PV-KMC-ID = 1000000107                                00578900
152810       WHEN PV-KMC-ID = 101000000105                              00579000
152900           SET SV005-HARD-DECLINE TO TRUE                         00579100
153000           MOVE ZERO TO PV-APPROVAL-NBR                           00579200
153100                      SV005-KMC-REMAINING-BALANCE                 00579300
153200           SET FI-38-DECLINE TO TRUE                              00579400
153300* REFERRAL                                                        00579500
153400       WHEN PV-KMC-ID = 1000000115                                00579600
153410       WHEN PV-KMC-ID = 101000000113                              00579700
153500           SET SV005-REFERRAL TO TRUE                             00579800
153600           MOVE ZERO TO PV-APPROVAL-NBR                           00579900
153700                      SV005-KMC-REMAINING-BALANCE                 00580000
153800           SET FI-38-REFER TO TRUE                                00580100
153900* OFFLINE                                                         00580200
154000       WHEN PV-KMC-ID = 1000000123                                00580300
154010       WHEN PV-KMC-ID = 101000000121                              00580400
154100           MOVE 9 TO SV005-RESPONSE-CODE                          00580500
154200           MOVE ZERO   TO PV-APPROVAL-NBR                         00580600
154300                        SV005-KMC-REMAINING-BALANCE               00580700
154400           SET FI-38-OFFLINE TO TRUE                              00580800
154500* EDIT ERROR                                                      00580900
154600       WHEN PV-KMC-ID = 1000000131                                00581000
154610       WHEN PV-KMC-ID = 101000000139                              00581100
154700           MOVE 2 TO SV005-RESPONSE-CODE                          00581200
154800           MOVE ZERO   TO PV-APPROVAL-NBR                         00581300
154900                        SV005-KMC-REMAINING-BALANCE               00581400
155000           SET FI-38-EDIT-ERROR TO TRUE                           00581500
155100* INVALID PIN                                                     00581600
155200       WHEN PV-KMC-ID = 1999123456                                00581700
155210       WHEN PV-KMC-ID = 101999123454                              00581800
155300           MOVE 6 TO SV005-RESPONSE-CODE                          00581900
155400           MOVE ZERO   TO PV-APPROVAL-NBR                         00582000
155500                        SV005-KMC-REMAINING-BALANCE               00582100
155600           SET FI-38-INVALID-PIN TO TRUE                          00582200
155700                                                                  00582300
155800* $10 KMRC                                                        00582400
155900       WHEN PV-KMC-ID = 1000000073                                00582500
155910       WHEN PV-KMC-ID = 101000000071                              00582600
156000           SET FI-21-KMRC TO TRUE                                 00582700
156100           SET SV005-KMRC-CRD TO TRUE                             00582800
156200           MOVE ZERO TO SV005-RESPONSE-CODE                       00582900
156300           SET FI-38-APPROVE TO TRUE                              00583000
156400           IF FI-PV-SALE AND NOT FI-PV-10-REVERSAL                00583100
156500               IF PV-KMC-AMT > 10                                 00583200
156600                   MOVE ZERO TO SV005-KMC-REMAINING-BALANCE       00583300
156700                   MOVE 10 TO SV005-APPROVED-TENDER-AMT           00583400
156800               ELSE                                               00583500
156900                   COMPUTE SV005-KMC-REMAINING-BALANCE = 10       00583600
157000                                                      - PV-KMC-AMT00583700
157100                   MOVE PV-KMC-AMT TO SV005-APPROVED-TENDER-AMT   00583800
157200                   MOVE 1 TO SV005-RESPONSE-CODE                  00583900
157300               END-IF                                             00584000
157400           ELSE                                                   00584100
157500*        BALANCE INQUIRY OR VOID OR ISSUE                         00584200
157600               IF FI-PV-BAL-INQ-ADD-ON                            00584300
157700                   SET SV005-CARD-STOCK-INV-ADD-ON TO TRUE        00584400
157800                   MOVE 0 TO SV005-KMC-REMAINING-BALANCE          00584500
157900                             SV005-APPROVED-TENDER-AMT            00584600
158000               ELSE                                               00584700
158100                   MOVE 10 TO SV005-KMC-REMAINING-BALANCE         00584800
158200                   MOVE ZERO TO SV005-APPROVED-TENDER-AMT         00584900
158300                   IF FI-PV-10-REVERSAL                           00585000
158400                      MOVE PV-KMC-AMT TO SV005-APPROVED-TENDER-AMT00585100
158500                   END-IF                                         00585200
158600               END-IF                                             00585300
158700           END-IF                                                 00585400
158800                                                                  00585500
158900* $10 KMRC                                                        00585600
159000       WHEN PV-KMC-ID = 1000000404                                00585700
159100       WHEN PV-KMC-ID = 1000000420                                00585800
159110       WHEN PV-KMC-ID = 101000000402                              00585900
159120       WHEN PV-KMC-ID = 101000000428                              00586000
159200           SET FI-21-KMRC TO TRUE                                 00586100
159300           SET SV005-KMRC-CRD TO TRUE                             00586200
159400           MOVE ZERO TO SV005-RESPONSE-CODE                       00586300
159500           SET FI-38-APPROVE TO TRUE                              00586400
159600           IF FI-PV-SALE AND NOT FI-PV-10-REVERSAL                00586500
159700               IF PV-KMC-AMT > 10                                 00586600
159800                   MOVE ZERO TO SV005-KMC-REMAINING-BALANCE       00586700
159900                   MOVE 10 TO SV005-APPROVED-TENDER-AMT           00586800
160000               ELSE                                               00586900
160100                   COMPUTE SV005-KMC-REMAINING-BALANCE = 10       00587000
160200                                                      - PV-KMC-AMT00587100
160300                   MOVE PV-KMC-AMT TO SV005-APPROVED-TENDER-AMT   00587200
160400                   MOVE 1 TO SV005-RESPONSE-CODE                  00587300
160500               END-IF                                             00587400
160600           ELSE                                                   00587500
160700*        BALANCE INQUIRY OR VOID OR ISSUE                         00587600
160800               MOVE 10 TO SV005-KMC-REMAINING-BALANCE             00587700
160900               MOVE ZERO TO SV005-APPROVED-TENDER-AMT             00587800
161000               IF FI-PV-10-REVERSAL                               00587900
161100                   MOVE PV-KMC-AMT TO SV005-APPROVED-TENDER-AMT   00588000
161200               END-IF                                             00588100
161300           END-IF                                                 00588200
161400                                                                  00588300
161500* $25 KMRC                                                        00588400
161600       WHEN (PV-KMC-ID = 1000000156 OR                            00588500
161700             PV-KMC-ID = 1000000081 OR                            00588600
161800             PV-KMC-ID = 1000000099 OR                            00588700
161810             PV-KMC-ID = 101000000154 OR                          00588800
161820             PV-KMC-ID = 101000000089 OR                          00588900
161830             PV-KMC-ID = 101000000097)                            00589000
161900           SET FI-21-KMRC TO TRUE                                 00589100
162000           SET SV005-KMRC-CRD TO TRUE                             00589200
162100           MOVE ZERO TO SV005-RESPONSE-CODE                       00589300
162200           SET FI-38-APPROVE TO TRUE                              00589400
162300           IF FI-PV-SALE AND NOT FI-PV-10-REVERSAL                00589500
162400               IF PV-KMC-AMT > 25                                 00589600
162500                   MOVE ZERO TO SV005-KMC-REMAINING-BALANCE       00589700
162600                   MOVE 25 TO SV005-APPROVED-TENDER-AMT           00589800
162700               ELSE                                               00589900
162800                   COMPUTE SV005-KMC-REMAINING-BALANCE = 25       00590000
162900                                                      - PV-KMC-AMT00590100
163000                   MOVE PV-KMC-AMT TO SV005-APPROVED-TENDER-AMT   00590200
163100                   MOVE 1 TO SV005-RESPONSE-CODE                  00590300
163200               END-IF                                             00590400
163300           ELSE                                                   00590500
163400*        BALANCE INQUIRY OR VOID OR ISSUE                         00590600
163500               IF FI-PV-BAL-INQ-ADD-ON                            00590700
163600                   SET SV005-CARD-STOCK-INV-ADD-ON TO TRUE        00590800
163700                   MOVE 0 TO SV005-KMC-REMAINING-BALANCE          00590900
163800                             SV005-APPROVED-TENDER-AMT            00591000
163900               ELSE                                               00591100
164000                   MOVE 25 TO SV005-KMC-REMAINING-BALANCE         00591200
164100                   MOVE ZERO TO SV005-APPROVED-TENDER-AMT         00591300
164200                   IF FI-PV-10-REVERSAL                           00591400
164300                       MOVE 1 TO SV005-RESPONSE-CODE              00591500
164400                      MOVE PV-KMC-AMT TO SV005-APPROVED-TENDER-AMT00591600
164500                   END-IF                                         00591700
164600               END-IF                                             00591800
164700           END-IF                                                 00591900
164800                                                                  00592000
164900* $50 GIFT CARD                                                   00592100
165000       WHEN PV-KMC-ID = 1000000339                                00592200
165010       WHEN PV-KMC-ID = 101000000337                              00592300
165100           SET FI-21-GIFT-CARD TO TRUE                            00592400
165200           SET SV005-GIFT-CRD TO TRUE                             00592500
165300           MOVE 0 TO SV005-RESPONSE-CODE                          00592600
165400           SET FI-38-APPROVE TO TRUE                              00592700
165500           IF FI-PV-SALE AND NOT FI-PV-10-REVERSAL                00592800
165600               IF PV-KMC-AMT > 50                                 00592900
165700                   MOVE ZERO TO SV005-KMC-REMAINING-BALANCE       00593000
165800                   MOVE 50 TO SV005-APPROVED-TENDER-AMT           00593100
165900               ELSE                                               00593200
166000                   COMPUTE SV005-KMC-REMAINING-BALANCE = 50       00593300
166100                                                     - PV-KMC-AMT 00593400
166200                   MOVE PV-KMC-AMT TO SV005-APPROVED-TENDER-AMT   00593500
166300                   MOVE 1 TO SV005-RESPONSE-CODE                  00593600
166400               END-IF                                             00593700
166500           ELSE                                                   00593800
166600*        BALANCE INQUIRY OR VOID OR ISSUE                         00593900
166700               IF FI-PV-BAL-INQ-ADD-ON                            00594000
166800                   SET SV005-CARD-STOCK-INV-ADD-ON TO TRUE        00594100
166900                   MOVE 0 TO SV005-KMC-REMAINING-BALANCE          00594200
167000                             SV005-APPROVED-TENDER-AMT            00594300
167100               ELSE                                               00594400
167200                   MOVE 50 TO SV005-KMC-REMAINING-BALANCE         00594500
167300                   MOVE ZERO TO SV005-APPROVED-TENDER-AMT         00594600
167400                   IF FI-PV-10-REVERSAL                           00594700
167500                       MOVE 1 TO SV005-RESPONSE-CODE              00594800
167600                      MOVE PV-KMC-AMT TO SV005-APPROVED-TENDER-AMT00594900
167700                   END-IF                                         00595000
167800               END-IF                                             00595100
167900           END-IF                                                 00595200
168000                                                                  00595300
168100* $50 GIFT CARD                                                   00595400
168200       WHEN PV-KMC-ID = 1000000412                                00595500
168300       WHEN PV-KMC-ID = 1000000438                                00595600
168310       WHEN PV-KMC-ID = 101000000410                              00595700
168320       WHEN PV-KMC-ID = 101000000436                              00595800
168400           SET FI-21-GIFT-CARD TO TRUE                            00595900
168500           SET SV005-GIFT-CRD TO TRUE                             00596000
168600           MOVE 0 TO SV005-RESPONSE-CODE                          00596100
168700           SET FI-38-APPROVE TO TRUE                              00596200
168800           IF FI-PV-SALE AND NOT FI-PV-10-REVERSAL                00596300
168900               IF PV-KMC-AMT > 50                                 00596400
169000                   MOVE ZERO TO SV005-KMC-REMAINING-BALANCE       00596500
169100                   MOVE 50 TO SV005-APPROVED-TENDER-AMT           00596600
169200               ELSE                                               00596700
169300                   COMPUTE SV005-KMC-REMAINING-BALANCE = 50       00596800
169400                                                     - PV-KMC-AMT 00596900
169500                   MOVE PV-KMC-AMT TO SV005-APPROVED-TENDER-AMT   00597000
169600                   MOVE 1 TO SV005-RESPONSE-CODE                  00597100
169700               END-IF                                             00597200
169800           ELSE                                                   00597300
169900*        BALANCE INQUIRY OR VOID OR ISSUE                         00597400
170000               MOVE 50 TO SV005-KMC-REMAINING-BALANCE             00597500
170100               MOVE ZERO TO SV005-APPROVED-TENDER-AMT             00597600
170200               IF FI-PV-10-REVERSAL                               00597700
170300                   MOVE 1 TO SV005-RESPONSE-CODE                  00597800
170400                   MOVE PV-KMC-AMT TO SV005-APPROVED-TENDER-AMT   00597900
170500               END-IF                                             00598000
170600           END-IF                                                 00598100
170700                                                                  00598200
170800* $100 GIFT CARD                                                  00598300
170900       WHEN (PV-KMC-ID = 1000000354 OR                            00598400
171000             PV-KMC-ID = 1000000297 OR                            00598500
171100             PV-KMC-ID = 1000000305 OR                            00598600
171110             PV-KMC-ID = 101000000352 OR                          00598700
171120             PV-KMC-ID = 101000000295 OR                          00598800
171130             PV-KMC-ID = 101000000303)                            00598900
171200           SET FI-21-GIFT-CARD TO TRUE                            00599000
171300           SET SV005-GIFT-CRD TO TRUE                             00599100
171400           MOVE 0 TO SV005-RESPONSE-CODE                          00599200
171500           SET FI-38-APPROVE TO TRUE                              00599300
171600           IF FI-PV-SALE AND NOT FI-PV-10-REVERSAL                00599400
171700               IF PV-KMC-AMT > 100                                00599500
171800                   MOVE ZERO TO SV005-KMC-REMAINING-BALANCE       00599600
171900                   MOVE 100 TO SV005-APPROVED-TENDER-AMT          00599700
172000               ELSE                                               00599800
172100                   COMPUTE SV005-KMC-REMAINING-BALANCE =          00599900
172200                                                  100 - PV-KMC-AMT00600000
172300                   MOVE PV-KMC-AMT TO SV005-APPROVED-TENDER-AMT   00600100
172400                   MOVE 1 TO SV005-RESPONSE-CODE                  00600200
172500               END-IF                                             00600300
172600           ELSE                                                   00600400
172700*        BALANCE INQUIRY OR VOID OR ISSUE                         00600500
172800               IF FI-PV-BAL-INQ-ADD-ON                            00600600
172900                   SET SV005-CARD-STOCK-INV-ADD-ON TO TRUE        00600700
173000                   MOVE 0 TO SV005-KMC-REMAINING-BALANCE          00600800
173100                             SV005-APPROVED-TENDER-AMT            00600900
173200               ELSE                                               00601000
173300                   MOVE 100 TO SV005-KMC-REMAINING-BALANCE        00601100
173400                   MOVE ZERO TO SV005-APPROVED-TENDER-AMT         00601200
173500                   IF FI-PV-10-REVERSAL                           00601300
173600                       MOVE 1 TO SV005-RESPONSE-CODE              00601400
173700                      MOVE PV-KMC-AMT TO SV005-APPROVED-TENDER-AMT00601500
173800                   END-IF                                         00601600
173900               END-IF                                             00601700
174000           END-IF                                                 00601800
174100     END-EVALUATE.                                                00601900
174200                                                                  00602000
174300* VERIFY PIN IF IT IS FILLED IN                                   00602100
174400* PIN 0123 = 4210 ENCRYPTED                                       00602200
174500*                                                                 00602300
174610     IF PV-E-ECOMMERCE-STORE                                      00602400
174700         IF (FI-PV-SALE AND NOT FI-PV-10-REVERSAL) OR             00602500
174800            (FI-PV-BAL-INQ AND                                    00602600
174900             FI-85-PIN NOT EQUAL -1)                              00602700
175000             IF FI-85-PIN NOT = 4210                              00602800
175100                 MOVE '6' TO SV005-RESPONSE-CODE                  00602900
175200                 SET FI-38-INVALID-PIN TO TRUE                    00603000
175300             END-IF                                               00603100
175400         END-IF                                                   00603200
175500     END-IF.                                                      00603300
175600                                                                  00603400
175710******************************************************************00603500
175800*  PERFORM THIS PARAGRAPH UNTIL A CARD IS FOUND TO ISSUE OR      *00603600
175900*    NO CARDS ARE LEFT TO ISSUE                                  *00603700
176000*     -PERFORMS THE PARAGRAPH TO OPEN THE CURSOR                 *00603800
176100*     -PERFORMS THE PARAGRAPH TO FETCH THE VIRTUAL CURSOR        *00603900
176200*           UNTIL A CARD IS FOUND OR NO CARDS ARE LEFT TO ISSUE  *00604000
176300*         WITHIN THIS PERFORM ---                                 00604100
176400*           ADD +1 TO THE LAST ISSUED VGC                         00604200
176500*           DETERMINE IF THE LAST CNTL ISSUED IS BEYOND THE END   00604300
176600*           IF NOT BEYOND THE END                                 00604400
176700*             OPEN THE VIRTUAL-UPD-CSR                            00604500
176800*             FETCH THE CURSOR - SELECT LAST                      00604600
176900*                     ISSUE TABLE FOR UPDATE                      00604700
177000*             SELECT THE ACCT TABLE                               00604800
177100*             SELECT THE TXN TABLE                                00604900
177200*             IF THE CARD DOES NOT EXIST ON THIS TABLE            00605000
177300*               ADD THIS CARD TO THE LAST ISSUE TABLE AND PASS    00605100
177400*               THE CARD NUMBER ON, SET THE SWITCHES              00605200
177500*             CLOSE THE VIRTUAL-UPD-CSR                           00605300
177600*        CLOSE THE VIRTUAL-CSR                                    00605400
177700******************************************************************00605500
177800 2400-VIRTUAL-ISSUE.                                              00605600
177900                                                                  00605700
178000     PERFORM 2420-FETCH-CURSOR.                                   00605800
178100     IF PS-VIRTUAL-CSR-NOT-AT-END                                 00605900
178200         SET PS-VIRTUAL-UPD-CSR-NOT-AT-END TO TRUE                00606000
178300         SET PS-FETCH-1ST-CSR-OFF          TO TRUE                00606100
178400         PERFORM 2422-PROCESS-CURSOR                              00606200
178500         UNTIL PS-FETCH-OK                                        00606300
178600            OR PS-VIRTUAL-CSR-AT-END                              00606400
178700            OR PS-VIRTUAL-UPD-CSR-AT-END                          00606500
178800            OR PS-FETCH-1ST-CSR-AGAIN                             00606600
178900     END-IF.                                                      00606700
179000                                                                  00606800
179100******************************************************************00606900
179200*      PERFORMS THE PARAGRAPH TO OPEN THE CURSOR                 *00607000
179300******************************************************************00607100
179400 2410-OPEN-CURSOR.                                                00607200
179500                                                                  00607300
179600     EXEC SQL                                                     00607400
179700         OPEN VIRTUAL_CSR                                         00607500
179800     END-EXEC.                                                    00607600
179900                                                                  00607700
180000     EVALUATE TRUE                                                00607800
180100         WHEN SQLCODE = 0                                         00607900
180200             CONTINUE                                             00608000
180300         WHEN OTHER                                               00608100
180400             MOVE SPACES                TO AA-ATTEMPTED-YR        00608200
180500             MOVE SPACES                TO AA-ATTEMPTED-SHIP      00608300
180600             MOVE 'OPEN VIRTUAL CURSOR' TO AA-ATTEMPTED-ACT       00608400
180700             PERFORM 9100-DB2-ERROR                               00608500
180800             PERFORM 9999-RETURN-TO-NATIVE-CICS                   00608600
180900      END-EVALUATE.                                               00608700
181000                                                                  00608800
181100******************************************************************00608900
181200*     -FETCHS THE CURSOR                                         *00609000
181300******************************************************************00609100
181400 2420-FETCH-CURSOR.                                               00609200
181500                                                                  00609300
181600     EXEC SQL                                                     00609400
181700        FETCH  VIRTUAL_CSR                                        00609500
181800        INTO :SVT00000-CRD-PROD-YR                                00609600
181900           , :SVT00000-SHIPT-REQ-NBR                              00609700
182000           , :SVT00000-END-CNTL-NBR                               00609800
182010           , :SVT00008-UPC-NBR                                    00609900
182100     END-EXEC.                                                    00610000
182200                                                                  00610100
182300     EVALUATE TRUE                                                00610200
182400        WHEN SQLCODE = 0                                          00610300
182500           SET PS-VIRTUAL-CSR-NOT-AT-END TO TRUE                  00610400
182600        WHEN SQLCODE = +100                                       00610500
182700           SET PS-VIRTUAL-CSR-AT-END TO TRUE                      00610600
182800        WHEN OTHER                                                00610700
182900           MOVE SPACES                 TO AA-ATTEMPTED-CRD        00610800
183000           MOVE 'FETCH VIRTUAL CURSOR' TO AA-ATTEMPTED-ACT        00610900
183100           PERFORM 9100-DB2-ERROR                                 00611000
183200           PERFORM 9999-RETURN-TO-NATIVE-CICS                     00611100
183300     END-EVALUATE.                                                00611200
183400                                                                  00611300
183500***************************************************************** 00611400
183600* IF SQLCODE = 0 FROM THE VIRTUAL CURSOR, DO BELOW                00611500
183700***************************************************************** 00611600
183800 2422-PROCESS-CURSOR.                                             00611700
183900                                                                  00611800
184000     MOVE SVT00000-CRD-PROD-YR   TO PV-CRD-PROD-YR                00611900
184010                                    PV-CRD-PROD-YR-D.             00612000
184100     MOVE SVT00000-SHIPT-REQ-NBR TO PV-SHIPT-REQ-NBR              00612100
184110                                    PV-SHIPT-REQ-NBR-D.           00612200
184200     PERFORM 2425-DETERMINE-LAST-CNTL                             00612300
184300        UNTIL PS-HAVE-TXN                                         00612400
184400          OR  PS-FETCH-1ST-CSR-AGAIN                              00612500
184500          OR  PS-VIRTUAL-UPD-CSR-AT-END.                          00612600
184600     PERFORM 2452-CLOSE-VIRTUAL-UPD-CSR.                          00612700
184700                                                                  00612800
184800******************************************************************00612900
184900*  OPEN THE VIRTUAL-UPD-CSR                                       00613000
185000*  FETCH THE CURSOR - SELECT LAST ISSUE TABLE FOR UPDATE          00613100
185100*  PERFORM THE LOOP OF THE 2ND CURSOR                             00613200
185200*  CLOSE THE VIRTUAL-UPD-CSR                                      00613300
185300******************************************************************00613400
185400 2425-DETERMINE-LAST-CNTL.                                        00613500
185500                                                                  00613600
185600     PERFORM 2445-OPEN-VIRTUAL-UPD-CSR.                           00613700
185700     PERFORM 2447-FETCH-VIRTUAL-UPD-CSR.                          00613800
185800     MOVE SVT00017-LAST-ISUD-CNTL-NBR                             00613900
185900                                 TO PV-LAST-ISUD-CNTL-NBR         00614000
185910                                    PV-LAST-ISUD-CNTL-NBR-D.      00614100
120200                                                                  00614200
186000     SET PS-DONT-HAVE-TXN  TO TRUE.                               00614300
186100     PERFORM 2428-CHECK-TXN-TABLE                                 00614400
186200             UNTIL PS-HAVE-TXN OR                                 00614500
186300                   PS-FETCH-1ST-CSR-AGAIN OR                      00614600
186400                   PS-VIRTUAL-UPD-CSR-AT-END.                     00614700
186500                                                                  00614800
186600******************************************************************00614900
186700*  LOOP THROUGH THE 2ND CURSOR - VIRTUAL UPD CURSOR               00615000
186800*    ADD 1 TO THE LAST CNTL NBR                                   00615100
186900*    MAKE SURE IT'S NOT BEYOND THE LAST CNTL NBR                  00615200
187000*    SELECT THE ACCT TABLE                                        00615300
187100*    SELECT THE TXN TABLE                                         00615400
187200*      IF THE CARD DOES NOT EXIST ON THIS TABLE                   00615500
187300*          ADD THIS CARD TO THE LAST ISSUE TABLE AND PASS THE     00615600
187400*              CARD NUMBER ON, SET THE SWITCHES                   00615700
187500******************************************************************00615800
187600 2428-CHECK-TXN-TABLE.                                            00615900
187700                                                                  00616000
187800     ADD +1 TO PV-LAST-ISUD-CNTL-NBR                              00616100
187810               PV-LAST-ISUD-CNTL-NBR-D.                           00616200
187900     IF PV-LAST-ISUD-CNTL-NBR > SVT00000-END-CNTL-NBR             00616300
188000         SET PS-FETCH-1ST-CSR-AGAIN TO TRUE                       00616400
188100     ELSE                                                         00616500
188200         PERFORM 2430-SELECT-ACCT                                 00616600
188300         PERFORM 2440-SELECT-TXN                                  00616700
188400         IF PS-HAVE-TXN                                           00616800
188500            PERFORM 2450-UPDATE-LAST-ISUD-CNTL                    00616900
188600            SET PS-FETCH-OK TO TRUE                               00617000
188700         END-IF                                                   00617100
188800     END-IF.                                                      00617200
188900                                                                  00617300
189000******************************************************************00617400
189100*     -SELECT THE SV ACCT TABLE                                  *00617500
189200*     -MAKE SURE THE CARD DOES NOT EXIST ON THE LOCK TABLE       *00617600
189300******************************************************************00617700
189400 2430-SELECT-ACCT.                                                00617800
189500                                                                  00617900
189610      EXEC SQL                                                    00618000
189700          SELECT CRD_NBR                                          00618100
189800               , CRD_PIN_NBR                                      00618200
189810               , CRD_SPCTY_TYP_CDE                                00618300
189900          INTO   :SVT00001-CRD-NBR                                00618400
190000               , :SVT00001-CRD-PIN-NBR                            00618500
190010               , :SVT00001-CRD-SPCTY-TYP-CDE                      00618600
190100          FROM SVT_KOHLS_CRD_ACCT A                               00618700
190200          WHERE A.CRD_PROD_YR   = :PV-CRD-PROD-YR                 00618800
190300            AND A.SHIPT_REQ_NBR = :PV-SHIPT-REQ-NBR               00618900
190400            AND A.CNTL_NBR      = :PV-LAST-ISUD-CNTL-NBR          00619000
190500            AND NOT EXISTS                                        00619100
190600                (SELECT 1                                         00619200
190700                 FROM SVT_CRD_ACCT_LCK C                          00619300
190800                 WHERE A.CRD_NBR = C.CRD_NBR)                     00619400
190900      END-EXEC.                                                   00619500
191000                                                                  00619600
191100      EVALUATE TRUE                                               00619700
191200         WHEN SQLCODE = 0                                         00619800
191300             CONTINUE                                             00619900
191400         WHEN OTHER                                               00620000
191500             MOVE PV-CRD-PROD-YR         TO AA-ATTEMPTED-YR       00620100
191600             MOVE PV-SHIPT-REQ-NBR       TO AA-ATTEMPTED-SHIP     00620200
191700             MOVE 'SELECT ACCT TABLE'    TO AA-ATTEMPTED-ACTI     00620300
191800             PERFORM 9100-DB2-ERROR                               00620400
191900             PERFORM 9999-RETURN-TO-NATIVE-CICS                   00620500
192000      END-EVALUATE.                                               00620600
192100                                                                  00620700
192200******************************************************************00620800
192300*     -SELECT THE SV TXN TABLE                                   *00620900
192400*     -MAKE SURE THE CARD DOES NOT EXIST ON THE TXN TABLE        *00621000
192500******************************************************************00621100
192600 2440-SELECT-TXN.                                                 00621200
192700                                                                  00621300
192800      EXEC SQL                                                    00621400
192900          SELECT CRD_NBR                                          00621500
193000          INTO  :SVT00002-CRD-NBR                                 00621600
193100          FROM SVT_KOHLS_CRD_TXN  A                               00621700
193200          WHERE A.CRD_NBR  = :SVT00001-CRD-NBR                    00621800
193300      END-EXEC.                                                   00621900
193400                                                                  00622000
193500      EVALUATE TRUE                                               00622100
193600         WHEN SQLCODE = 0                                         00622200
193601             SET PS-DONT-HAVE-TXN TO TRUE                         00622300
193800         WHEN SQLCODE = +100                                      00622400
193900             SET PS-HAVE-TXN  TO TRUE                             00622500
194000         WHEN SQLCODE = -811                                      00622600
194100             SET PS-DONT-HAVE-TXN TO TRUE                         00622700
194200         WHEN OTHER                                               00622800
194300             MOVE SVT00001-CRD-NBR       TO AA-ATTEMPTED-CRD      00622900
194400             MOVE 'SELECT TXN TABLE '    TO AA-ATTEMPTED-ACT      00623000
194500             PERFORM 9100-DB2-ERROR                               00623100
194600             PERFORM 9999-RETURN-TO-NATIVE-CICS                   00623200
194700      END-EVALUATE.                                               00623300
194800                                                                  00623400
194900******************************************************************00623500
195000*      PERFORMS THE PARAGRAPH TO OPEN THE VIRTUAL UPDATE CURSOR  *00623600
195100******************************************************************00623700
195200 2445-OPEN-VIRTUAL-UPD-CSR.                                       00623800
195300                                                                  00623900
195400     EXEC SQL                                                     00624000
195500         OPEN VIRTUAL_UPD_CSR                                     00624100
195600     END-EXEC.                                                    00624200
195700                                                                  00624300
195800     EVALUATE TRUE                                                00624400
195900         WHEN SQLCODE = 0                                         00624500
196000             CONTINUE                                             00624600
196100         WHEN OTHER                                               00624700
196200             MOVE SPACES                TO AA-ATTEMPTED-YR        00624800
196300             MOVE SPACES                TO AA-ATTEMPTED-SHIP      00624900
196400             MOVE 'OPEN VIRTUAL CURSOR' TO AA-ATTEMPTED-ACTI      00625000
196500             PERFORM 9100-DB2-ERROR                               00625100
196600             PERFORM 9999-RETURN-TO-NATIVE-CICS                   00625200
196700      END-EVALUATE.                                               00625300
196800                                                                  00625400
196900******************************************************************00625500
197000*     -FETCHS THE VIRTUAL UPDATE CURSOR                          *00625600
197100******************************************************************00625700
197200 2447-FETCH-VIRTUAL-UPD-CSR.                                      00625800
197300                                                                  00625900
197400     EXEC SQL                                                     00626000
197500        FETCH  VIRTUAL_UPD_CSR                                    00626100
197600        INTO :SVT00017-LAST-ISUD-CNTL-NBR                         00626200
197700     END-EXEC.                                                    00626300
197800                                                                  00626400
197900     EVALUATE TRUE                                                00626500
198000        WHEN SQLCODE = 0                                          00626600
198100            CONTINUE                                              00626700
198200        WHEN SQLCODE = +100                                       00626800
198300           SET PS-VIRTUAL-UPD-CSR-AT-END TO TRUE                  00626900
198400        WHEN OTHER                                                00627000
198500           MOVE PV-LAST-ISUD-CNTL-NBR  TO AA-ATTEMPTED-CRD        00627100
198600           MOVE 'FETCH VIRTUAL UPD CURSOR' TO AA-ATTEMPTED-ACT    00627200
198700           PERFORM 9100-DB2-ERROR                                 00627300
198800           PERFORM 9999-RETURN-TO-NATIVE-CICS                     00627400
198900     END-EVALUATE.                                                00627500
199000                                                                  00627600
199100*----------------------------------------------------------------*00627700
199200* UPDATE THE LAST ISSUED CNTL TABLE                              *00627800
199300*----------------------------------------------------------------*00627900
199400 2450-UPDATE-LAST-ISUD-CNTL.                                      00628000
199500                                                                  00628100
199600      EXEC SQL                                                    00628200
199700          UPDATE SVT_LAST_ISUD_VGC                                00628300
199800             SET LAST_ISUD_CNTL_NBR = :PV-LAST-ISUD-CNTL-NBR      00628400
199900          WHERE CURRENT OF VIRTUAL_UPD_CSR                        00628500
200000      END-EXEC.                                                   00628600
200100                                                                  00628700
200200      EVALUATE TRUE                                               00628800
200300         WHEN SQLCODE = 0                                         00628900
200400             CONTINUE                                             00629000
200500         WHEN OTHER                                               00629100
200600             MOVE PV-CRD-PROD-YR         TO AA-ATTEMPTED-YR       00629200
200700             MOVE PV-SHIPT-REQ-NBR       TO AA-ATTEMPTED-SHIP     00629300
200800             MOVE 'UPDATE SVT_LAST_ISUD_VGC' TO AA-ATTEMPTED-ACTI 00629400
200900             PERFORM 9100-DB2-ERROR                               00629500
201000             PERFORM 9999-RETURN-TO-NATIVE-CICS                   00629600
201100      END-EVALUATE.                                               00629700
201200                                                                  00629800
201300******************************************************************00629900
201400*      PERFORMS THE PARAGRAPH TO CLOSE THE CURSOR                *00630000
201500******************************************************************00630100
201600 2452-CLOSE-VIRTUAL-UPD-CSR.                                      00630200
201700                                                                  00630300
201800     EXEC SQL                                                     00630400
201900         CLOSE VIRTUAL_UPD_CSR                                    00630500
202000     END-EXEC.                                                    00630600
202100                                                                  00630700
202200     EVALUATE TRUE                                                00630800
202300         WHEN SQLCODE = 0                                         00630900
202400             CONTINUE                                             00631000
202500         WHEN OTHER                                               00631100
202600             MOVE SPACES                 TO AA-ATTEMPTED-YR       00631200
202700             MOVE SPACES                 TO AA-ATTEMPTED-SHIP     00631300
202800             MOVE 'CLOSE UPD VIRTUAL CURSOR' TO AA-ATTEMPTED-ACTI 00631400
202900             PERFORM 9100-DB2-ERROR                               00631500
203000             PERFORM 9999-RETURN-TO-NATIVE-CICS                   00631600
203100      END-EVALUATE.                                               00631700
203200                                                                  00631800
203300******************************************************************00631900
203400*      PERFORMS THE PARAGRAPH TO CLOSE THE CURSOR                *00632000
203500******************************************************************00632100
203600 2460-CLOSE-CURSOR.                                               00632200
203700                                                                  00632300
203800     EXEC SQL                                                     00632400
203900         CLOSE VIRTUAL_CSR                                        00632500
204000     END-EXEC.                                                    00632600
204100                                                                  00632700
204200     EVALUATE TRUE                                                00632800
204300         WHEN SQLCODE = 0                                         00632900
204400             CONTINUE                                             00633000
204500         WHEN OTHER                                               00633100
204600             MOVE SPACES                 TO AA-ATTEMPTED-YR       00633200
204700             MOVE SPACES                 TO AA-ATTEMPTED-SHIP     00633300
204800             MOVE 'CLOSE VIRTUAL CURSOR' TO AA-ATTEMPTED-ACTI     00633400
204900             PERFORM 9100-DB2-ERROR                               00633500
205000             PERFORM 9999-RETURN-TO-NATIVE-CICS                   00633600
205100      END-EVALUATE.                                               00633700
205200                                                                  00633800
205300*----------------------------------------------------------------*00633900
205400* SET-COLUMNS                                                    *00634000
205500* POPULATE DATABASE VARIABLES                                    *00634100
205600*----------------------------------------------------------------*00634200
205700 3000-SET-COLUMNS.                                                00634300
205800         MOVE SV005-KMC-ID            TO SVT00002-CRD-NBR.        00634400
205900         MOVE PV-DRIVERS-LICENSE-NBR  TO SVT00002-DRV-LIC-NBR.    00634500
206000         IF SV005-REAUTH OR SV005-NORMAL                          00634600
206000           MOVE '0' TO SVT00002-TRN-RVRSL-CDE                     00634700
206000         ELSE                                                     00634800
206000           IF SV005-REVERSAL-REAUTH OR                            00634900
206000              SV005-REVERSAL                                      00635000
206000              MOVE '1' TO SVT00002-TRN-RVRSL-CDE                  00635100
206000           END-IF                                                 00635200
206000         END-IF                                                   00635300
206100         MOVE 'N'                     TO SVT00002-TRN-VOID-IND.   00635400
206200         MOVE SV005-ACTIVITY-TYPE     TO SVT00002-ACTVY-TYP-CDE.  00635500
206300         MOVE SV005-POS-DATE          TO SVT00002-POS-DTE.        00635600
206400         MOVE SV005-STORE-NBR         TO SVT00002-STR-NBR.        00635700
206500         MOVE SV005-TERMINAL-NBR      TO SVT00002-POS-TRMNL-NBR.  00635800
206600         MOVE SV005-TRANSACTION-NBR   TO SVT00002-POS-TRN-NBR.    00635900
206700         MOVE SV004-DEFAULT-TIMESTAMP TO SVT00002-TRN-PSTD-TMST.  00636000
206800         EVALUATE TRUE                                            00636100
206900             WHEN SV005-NORMAL                                    00636200
206900             WHEN SV005-REAUTH                                    00636300
206900             WHEN SV005-REVERSAL-REAUTH                           00636400
207000               IF PV-TENDER                                       00636500
207100                  MULTIPLY PC-MINUS-ONE BY                        00636600
207200                           SV005-APPROVED-TENDER-AMT              00636700
207300               END-IF                                             00636800
207400             WHEN PV-REVERSAL                                     00636900
207500               IF PV-ISSUANCE-AS-KMRC                             00637000
207600               OR PV-ISSUANCE-AS-GIFT-CARD                        00637100
207700                  MULTIPLY PC-MINUS-ONE BY                        00637200
207800                           SV005-APPROVED-TENDER-AMT              00637300
207900               END-IF                                             00637400
208000         END-EVALUATE                                             00637500
208100         MOVE SV005-APPROVED-TENDER-AMT TO SVT00002-APP-AUTH-AMT  00637600
208200                                           SVT00002-ORIG-AUTH-AMT.00637700
P12431         MOVE ZERO                      TO SVT00002-POS-OPRT-ID.  00637800
P12431         IF PV-OPRT-ID-LEN = 0                                    00637900
P12431           MOVE -1                      TO PV-ORD-NBR-NULL-IND    00638000
P12431         ELSE                                                     00638100
P12431           ADD +1 TO PV-ZERO-COUNT                                00638200
P12431           MOVE PV-OPRT-ID-LEN          TO SVT00002-ORD-NBR-LEN   00638300
P12431           MOVE PV-OPERATOR-ID(PV-ZERO-COUNT:SVT00002-ORD-NBR-LEN)00638400
P12431                                        TO SVT00002-ORD-NBR-TEXT  00638500
P12431           MOVE 0                       TO PV-ORD-NBR-NULL-IND    00638600
P12431         END-IF.                                                  00638700
208400         MOVE SPACE                     TO SVT00002-APVL-USR-ID.  00638800
208500         MOVE SV004-STAT-AUTH-RECEIVED-CD                         00638900
208600                                      TO SVT00002-ACTVY-STAT-CDE. 00639000
208700         IF SV005-APPROVED-TENDER-AMT < ZERO                      00639100
208800             MULTIPLY PC-MINUS-ONE BY                             00639200
208900                 SV005-APPROVED-TENDER-AMT                        00639300
209000         END-IF.                                                  00639400
209100* FOR VOID TRANSACTIONS, SET THE STATE CODE TO THE STATE THAT     00639500
209200* WAS ON THE ORIGINAL "NORMAL" TRANSACTION, AS RETURNED FROM      00639600
209300* THE NORMAL TRANSACTION LOOKUP IN SVPD005.                       00639700
209400         IF PV-REVERSAL                                           00639800
209500            MOVE SV005-VOID-STATE-CD    TO SVT00002-ST-CDE        00639900
209600         ELSE                                                     00640000
209700            MOVE FI-28-STATE-ID         TO SVT00002-ST-CDE        00640100
209800         END-IF.                                                  00640200
209900                                                                  00640300
210000     PERFORM EP000-1000-POST-MESSAGE.                             00640400
210100*3000-EXIT.                                                       00640500
210200                                                                  00640600
210300*----------------------------------------------------------------*00640700
210400* INSERT-KMC-ACTIVITY-TABLE                                      *00640800
210500* INSERT THE TRANSACTION INTO THE SVT_KOHLS_CRD_TXN TABLE        *00640900
210600*----------------------------------------------------------------*00641000
210700 4000-INSERT-KMC-ACTIVITY-TABLE.                                  00641100
210800                                                                  00641200
210900     IF SVT00002-ACTVY-TYP-CDE = SV004-ISSUE-KMRC-ACT-TYP         00641300
211000         CONTINUE                                                 00641400
211100     ELSE                                                         00641500
211200         MOVE SPACES               TO SVT00002-DRV-LIC-NBR        00641600
211300     END-IF.                                                      00641700
211400                                                                  00641800
211500     EXEC SQL INSERT                                              00641900
211600              INTO SVT_KOHLS_CRD_TXN                              00642000
211700                  (CRD_NBR                                        00642100
211800                  ,DRV_LIC_NBR                                    00642200
211900                  ,TRN_RVRSL_CDE                                  00642300
212000                  ,TRN_VOID_IND                                   00642400
212100                  ,ACTVY_TYP_CDE                                  00642500
212200                  ,POS_DTE                                        00642600
212300                  ,STR_NBR                                        00642700
212400                  ,POS_TRMNL_NBR                                  00642800
212500                  ,POS_TRN_NBR                                    00642900
212600                  ,TRN_PSTD_TMST                                  00643000
212700                  ,APP_AUTH_AMT                                   00643100
212800                  ,POS_OPRT_ID                                    00643200
212900                  ,APVL_USR_ID                                    00643300
213000                  ,ACTVY_STAT_CDE                                 00643400
213100                  ,ORIG_AUTH_AMT                                  00643500
213200                  ,ST_CDE                                         00643600
P12431                  ,ORD_NBR)                                       00643700
213300           VALUES                                                 00643800
213400              (:SVT00002-CRD-NBR                                  00643900
213500              ,:SVT00002-DRV-LIC-NBR                              00644000
213600              ,:SVT00002-TRN-RVRSL-CDE                            00644100
213700              ,:SVT00002-TRN-VOID-IND                             00644200
213800              ,:SVT00002-ACTVY-TYP-CDE                            00644300
213900              ,:SVT00002-POS-DTE                                  00644400
214000              ,:SVT00002-STR-NBR                                  00644500
214100              ,:SVT00002-POS-TRMNL-NBR                            00644600
214200              ,:SVT00002-POS-TRN-NBR                              00644700
214300              ,:SVT00002-TRN-PSTD-TMST                            00644800
214400              ,:SVT00002-APP-AUTH-AMT                             00644900
214500              ,:SVT00002-POS-OPRT-ID                              00645000
214600              ,:SVT00002-APVL-USR-ID                              00645100
214700              ,:SVT00002-ACTVY-STAT-CDE                           00645200
214800              ,:SVT00002-ORIG-AUTH-AMT                            00645300
214900              ,:SVT00002-ST-CDE                                   00645400
P12431              ,:SVT00002-ORD-NBR :PV-ORD-NBR-NULL-IND)            00645500
215000      END-EXEC.                                                   00645600
215100                                                                  00645700
215200      EVALUATE TRUE                                               00645800
215300               WHEN SQLCODE = -904                                00645900
215400               WHEN SQLCODE = -913                                00646000
215500                    ADD 1 TO PV-RETRY-COUNT                       00646100
215600               WHEN SQLCODE < 0                                   00646200
215700                    MOVE SV005-KMC-ID  TO  AA-ATTEMPTED-CRD       00646300
215800                    MOVE                                          00646400
215900                      ' INSERT KMC ACTIVITY ROW (SVT00002)'       00646500
216000                                 TO AA-ATTEMPTED-ACT              00646600
216100                    PERFORM 9100-DB2-ERROR                        00646700
216200                    PERFORM 9999-RETURN-TO-NATIVE-CICS            00646800
216300               WHEN SQLCODE > 0                                   00646900
216400               WHEN SQLWARN0 NOT = SPACES                         00647000
216500                    MOVE 'INSERT KMC ACTIVITY ROW (SVT00002)'     00647100
216600                                 TO AA-ATTEMPTED-ACTION           00647200
216700                    PERFORM 9200-DB2-WARNING                      00647300
216800                    PERFORM 9999-RETURN-TO-NATIVE-CICS            00647400
216900               WHEN OTHER                                         00647500
217000                    CONTINUE                                      00647600
217100      END-EVALUATE.                                               00647700
217200                                                                  00647800
217300*----------------------------------------------------------------*00647900
217400* UPDATE-KMC-ACTIVITY-TABLE                                      *00648000
217500*----------------------------------------------------------------*00648100
217600 4005-UPDATE-KMC-ACTIVITY-TABLE.                                  00648200
217700                                                                  00648300
217800         SET SV005-NORMAL TO TRUE                                 00648400
217900         MOVE SV005-REVERSAL-CODE TO SVT00002-TRN-RVRSL-CDE.      00648500
218000         COMPUTE SVT00002-APP-AUTH-AMT = SVT00002-APP-AUTH-AMT    00648600
218100                                       * -1.                      00648700
218200                                                                  00648800
218300     EXEC SQL                                                     00648900
218400         UPDATE SVT_KOHLS_CRD_TXN                                 00649000
218500           SET TRN_VOID_IND  = :SV004-VOID-TRANS                  00649100
218600         WHERE CRD_NBR       = :SVT00002-CRD-NBR                  00649200
218700           AND TRN_RVRSL_CDE = :SVT00002-TRN-RVRSL-CDE            00649300
218800           AND TRN_VOID_IND  = :SV004-NOT-VOID-TRANS              00649400
218900           AND ACTVY_TYP_CDE = :SVT00002-ACTVY-TYP-CDE            00649500
219000           AND POS_DTE       = :SVT00002-POS-DTE                  00649600
219100           AND STR_NBR       = :SVT00002-STR-NBR                  00649700
219200           AND POS_TRMNL_NBR = :SVT00002-POS-TRMNL-NBR            00649800
219300           AND POS_TRN_NBR   = :SVT00002-POS-TRN-NBR              00649900
219400           AND APP_AUTH_AMT  = :SVT00002-APP-AUTH-AMT             00650000
219500      END-EXEC.                                                   00650100
219600                                                                  00650200
219700     EVALUATE TRUE                                                00650300
219800              WHEN SQLCODE = -904                                 00650400
219900              WHEN SQLCODE = -913                                 00650500
220000                   ADD 1 TO PV-RETRY-COUNT                        00650600
220100              WHEN SQLCODE < 0                                    00650700
220200                    MOVE 'UPDATE KMC ACTIVITY ROW (SVT00002)'     00650800
220300                                 TO AA-ATTEMPTED-ACTION           00650900
220400                    PERFORM 9100-DB2-ERROR                        00651000
220500                    PERFORM 9999-RETURN-TO-NATIVE-CICS            00651100
220600               WHEN SQLCODE > 0                                   00651200
220700               WHEN SQLWARN0 NOT = SPACES                         00651300
220820                    MOVE 'UPDATE KMC ACTIVITY ROW (SVT00002)'     00651400
220900                                 TO AA-ATTEMPTED-ACTION           00651500
221000                    PERFORM 9200-DB2-WARNING                      00651600
221100                    PERFORM 9999-RETURN-TO-NATIVE-CICS            00651700
221200               WHEN OTHER                                         00651800
221300                    CONTINUE                                      00651900
221400      END-EVALUATE.                                               00652000
221500*4005-EXIT.                                                       00652100
221600                                                                  00652200
221700*----------------------------------------------------------------*00652300
221800* DELETE-KMC-LOCK-TABLE                                          *00652400
221900*----------------------------------------------------------------*00652500
222000 4050-DELETE-KMC-LOCK-TABLE.                                      00652600
222100                                                                  00652700
222200     EXEC SQL DELETE                                              00652800
222300              FROM SVT_CRD_ACCT_LCK                               00652900
222400         WHERE CRD_NBR       = :SV005-KMC-ID                      00653000
222500     END-EXEC.                                                    00653100
222600                                                                  00653200
222700     EVALUATE TRUE                                                00653300
222800              WHEN SQLCODE = 0                                    00653400
222900              WHEN SQLCODE = +100                                 00653500
223000              WHEN SQLCODE = -310                                 00653600
223100              WHEN SQLCODE = -904                                 00653700
223200              WHEN SQLCODE = -913                                 00653800
223300                  CONTINUE                                        00653900
223400              WHEN SQLCODE < 0                                    00654000
223500                   MOVE 'DELETE KMC LOCK ROW (SVT00004)'          00654100
223600                                TO AA-ATTEMPTED-ACTION            00654200
223700                   PERFORM 9100-DB2-ERROR                         00654300
223800                   PERFORM 9999-RETURN-TO-NATIVE-CICS             00654400
223900              WHEN SQLCODE > 0                                    00654500
224000              WHEN SQLWARN0 NOT = SPACES                          00654600
224100                   MOVE 'DELETE KMC LOCK ROW (SVT00004)'          00654700
224200                                TO AA-ATTEMPTED-ACTION            00654800
224300                   PERFORM 9200-DB2-WARNING                       00654900
224400                   PERFORM 9999-RETURN-TO-NATIVE-CICS             00655000
224500              WHEN OTHER                                          00655100
224600                   CONTINUE                                       00655200
224700     END-EVALUATE.                                                00655300
224800*4050-EXIT.                                                       00655400
224900                                                                  00655500
225000*----------------------------------------------------------------*00655600
225100* DETERMINE IF VALID STORE                                       *00655700
225200* LOOK UP STORE IN DATABASE, IF FOUND, ITS VALID.                *00655800
225300*----------------------------------------------------------------*00655900
225400 4100-DETERMINE-IF-VALID-STR.                                     00656000
225500     EXEC SQL                                                     00656100
225600         SELECT   LOC_NBR                                         00656200
225700                 ,ST_CDE                                          00656300
225800                 ,COALESCE(E_BUS_IND, :PC-DEFAULT-SPACE)          00656400
225900                                                                  00656500
226000           INTO  :XST00001-LOC-NBR                                00656600
226100                ,:XST00001-ST-CDE                                 00656700
226200                ,:XST00001-E-BUS-IND                              00656800
226300           FROM  XST_LOC                                          00656900
226400          WHERE  LOC_NBR = :XST00001-LOC-NBR                      00657000
226500            AND  LOC_TYP_CDE = 'DS'                               00657100
226600     END-EXEC.                                                    00657200
226700     EVALUATE TRUE                                                00657300
226800         WHEN SQLCODE = ZERO                                      00657400
226900             IF XST00001-E-BUS-IND NOT = PC-DEFAULT-SPACE         00657500
227000               MOVE XST00001-E-BUS-IND TO PV-E-BUS-IND            00657600
227100             ELSE                                                 00657700
227200               SET PS-AUTH-MESSAGE-ERROR                          00657800
227300                   PV-EDIT-ERROR                                  00657900
227400                   EP000-SL-ERROR TO TRUE                         00658000
227500               MOVE AU001-DATA-BUF                                00658100
227600                                  TO AM-POS-INQ-REMOTE-AUTH-MSG   00658200
227700               MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER          00658300
227800               MOVE AM-AUTH-MESSAGE-ERROR-MESSAGE                 00658400
227900                   TO  EP000-MD-SYSTEM-LOG-MESSAGE                00658500
228000                           (EP000-MESSAGE-LINE-COUNTER)           00658600
228100               ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER           00658700
228200               STRING 'ERROR: STORE ' FI-08-STORE-NO              00658800
228300                      ' HAS A NULL ECOMM BUS INDICATOR IN '       00658900
228400                      'MAINFRAME DB'                              00659000
228500                         DELIMITED BY SIZE                        00659100
228600                         INTO  EP000-MD-SYSTEM-LOG-MESSAGE        00659200
228700                                   (EP000-MESSAGE-LINE-COUNTER)   00659300
228800               END-STRING                                         00659400
228900               PERFORM EP000-1000-POST-MESSAGE                    00659500
229000             END-IF                                               00659600
229100         WHEN SQLCODE = +100                                      00659700
229200             SET PS-AUTH-MESSAGE-ERROR                            00659800
229300                 PV-EDIT-ERROR                                    00659900
229400                 EP000-SL-ERROR TO TRUE                           00660000
229500             MOVE AU001-DATA-BUF                                  00660100
229600                                   TO AM-POS-INQ-REMOTE-AUTH-MSG  00660200
229700             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            00660300
229800             MOVE AM-AUTH-MESSAGE-ERROR-MESSAGE                   00660400
229900                 TO  EP000-MD-SYSTEM-LOG-MESSAGE                  00660500
230000                         (EP000-MESSAGE-LINE-COUNTER)             00660600
230100             ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER             00660700
230200             STRING 'ERROR: A REGISTER HAS AN INCORRECT STORE'    00660800
230300                       ' NUMBER PROGRAMMED: '                     00660900
230400                       FI-08-STORE-NO                             00661000
230500                       DELIMITED BY SIZE                          00661100
230600                       INTO  EP000-MD-SYSTEM-LOG-MESSAGE          00661200
230700                                 (EP000-MESSAGE-LINE-COUNTER)     00661300
230800             END-STRING                                           00661400
230900             PERFORM EP000-1000-POST-MESSAGE                      00661500
231000         WHEN OTHER                                               00661600
231100             MOVE 'READ STORE TABLE FOR STORE'                    00661700
231200                                 TO AA-ATTEMPTED-ACTION           00661800
231300             PERFORM 9100-DB2-ERROR                               00661900
231400             PERFORM 9999-RETURN-TO-NATIVE-CICS                   00662000
231500      END-EVALUATE.                                               00662100
231600*4100-EXIT.                                                       00662200
231700                                                                  00662300
231800*----------------------------------------------------------------*00662400
231900*  FORMAT-AUTHORIZATION-RESP                                     *00662500
232000*  FORMAT THE FIPAY AUTHORIZATION RESPONSE MESSAGE, WHICH WILL   *00662600
232100*  BE SENT BACK TO THE STORE ISP.                                *00662700
232200*----------------------------------------------------------------*00662800
232300 5000-FORMAT-AUTHORIZATION-RESP.                                  00662900
232400     INITIALIZE AU002-TOT-REC-LENGTH                              00663000
232500                AU002-MATCHING-NBR-FIELD.                         00663100
232600                                                                  00663200
232710     IF (NOT PV-TEST-KMRC-ACCOUNTS                                00663300
232800     AND NOT PV-TEST-GIFT-CARD-ACCOUNTS                           00663400
232900     AND NOT PV-TRAINING-KMRC-ACCOUNTS                            00663500
233000     AND NOT PV-TRAINING-GIFT-CARD-ACCOUNTS)                      00663600
233100       IF PV-SUCCESSFUL-AUTHORIZATION                             00663700
233200           INITIALIZE PV-APPROVAL-NBR                             00663800
233300                                                                  00663900
233400           IF SV005-TENDER                                        00664000
233500             IF PV-REVERSAL                                       00664100
233600               MOVE 1              TO SV005-RESPONSE-CODE         00664200
233700               MULTIPLY SV005-KMC-REMAINING-BALANCE BY 100        00664300
233800                                   GIVING PV-APPROVAL-NBR         00664400
233900             ELSE                                                 00664500
234000               IF SV005-APPROVED-TENDER-AMT > SV005-TRANS-AMT     00664600
234100                 MOVE 0            TO SV005-RESPONSE-CODE         00664700
234200                 MULTIPLY SV005-APPROVED-TENDER-AMT BY 100        00664800
234300                                   GIVING PV-APPROVAL-NBR         00664900
234400               ELSE                                               00665000
234500                 IF SV005-KMC-ORIGINAL-BALANCE < SV005-TRANS-AMT  00665100
234600                    MULTIPLY SV005-APPROVED-TENDER-AMT BY 100     00665200
234700                                   GIVING PV-APPROVAL-NBR         00665300
234800                 END-IF                                           00665400
234900                 IF SV005-KMC-ORIGINAL-BALANCE > SV005-TRANS-AMT  00665500
235000                 OR SV005-KMC-ORIGINAL-BALANCE = SV005-TRANS-AMT  00665600
235100                    MULTIPLY SV005-KMC-REMAINING-BALANCE BY 100   00665700
235200                                   GIVING PV-APPROVAL-NBR         00665800
235300                    MOVE PC-RESP-CODE-1 TO SV005-RESPONSE-CODE    00665900
235400                 END-IF                                           00666000
235500               END-IF                                             00666100
235600             END-IF                                               00666200
235700           END-IF                                                 00666300
235810           IF (SV005-ISSUE                                        00666400
235900           OR  SV005-ISSUE-GIFT-CRD)                              00666500
236000             IF PV-REVERSAL                                       00666600
236100               MULTIPLY SV005-TRANS-AMT BY 100                    00666700
236200                                    GIVING PV-APPROVAL-NBR        00666800
236300             ELSE                                                 00666900
236400               MULTIPLY SV005-KMC-REMAINING-BALANCE BY 100        00667000
236500                                    GIVING PV-APPROVAL-NBR        00667100
236600             END-IF                                               00667200
236700           END-IF                                                 00667300
236800           IF SV005-INQUIRE                                       00667400
236900               MULTIPLY SV005-KMC-REMAINING-BALANCE BY 100        00667500
237000                                    GIVING PV-APPROVAL-NBR        00667600
237100           END-IF                                                 00667700
237200       ELSE                                                       00667800
237300           MOVE ZEROS                  TO PV-APPROVAL-NBR         00667900
237400       END-IF                                                     00668000
237500     ELSE                                                         00668100
237600         MULTIPLY SV005-TRANS-AMT BY 100                          00668200
237700                                GIVING PV-APPROVAL-NBR            00668300
237800     END-IF.                                                      00668400
237900                                                                  00668500
238010* FORMAT RESPONSE FIELDS INTO FIPAY FORMAT AND MOVE INTO          00668600
238100* PT-AUTH-FIELD ARRAY TABLE                                       00668700
238200                                                                  00668800
238300* MOVE '101' RESPONSE TO FIPAY FIELD 1                            00668900
238400     MOVE FI-01-TRAN-TYPE TO PT-AUTH-FIELD (1).                   00669000
238500                                                                  00669100
238600* FORMAT RESPONSE CODE FIELDS, FIPAY FIELDS 4 AND 53              00669200
238700     MOVE SV005-RESPONSE-CODE  TO FI-04-ACTION-CDE.               00669300
PGC        IF SV005-RESPONSE-CODE = 6                                   00669400
PGC            SET PV-PIN-INVALID TO TRUE                               00669500
PGC        END-IF.                                                      00669600
PGC        MOVE PV-DECLINE-REASON    TO FI-53-ISO-RESP.                 00669700
PGC   *    MOVE SV005-DECLINE-REASON TO FI-53-ISO-RESP.                 00669800
238900     MOVE FI-04-ACTION-CDE     TO PT-AUTH-FIELD (4).              00669900
239000     MOVE FI-53-ISO-RESP       TO PT-AUTH-FIELD (53).             00670000
239100                                                                  00670100
239200* FORMAT ACCOUNT NBR FIELD, FIPAY FIELD 13                        00670200
239300     IF FI-PV-ISSUE AND                                           00670300
239400        PV-E-ECOMMERCE-STORE                                      00670400
239500****************************************************************  00670500
239600*  CALCULATE THE CHECK DIGIT FOR THE 13 DIGIT VGC NUMBER.      *  00670600
239700*  THIS IS THE FULL NUMBER INCLUDING THE DENOMINATION PREFIX.  *  00670700
239800*  A 0 IS PUT IN THE LAST POSITION(CHECK DIGIT POSITION)       *  00670800
239900*  JUST TO HOLD THE POSITION UNTIL THE NUMBER IS CALCULATED.   *  00670900
239910*  IF THE VIRTUAL GIFT CARD IS A 12 DIGIT NUMBER THEN WE DON'T *  00671000
239920*  WANT TO GET THE CHECK DIGIT.                                *  00671100
240000****************************************************************  00671200
240010        IF PV-KMC-ID < 10000000000                                00671300
240100          INITIALIZE DP040I-UPC-CHECK-DIGIT-PARMS                 00671400
240200          SET DP040I-COMP-CHECK-DIGIT-OPTION TO TRUE              00671500
240300          MOVE PV-KMC-ID  TO PV-GIFT-CRD-NBR                      00671600
240400          MOVE PV-GIFT-CRD-NBR-N TO DP040I-UPC-CODE               00671700
240500          CALL DP040I-UPC-CHECK-DIGIT-WO-IUPC                     00671801
240500                           USING DP040I-UPC-CHECK-DIGIT-PARMS     00671901
240600          IF DP040I-NO-ERROR-DETECTED                             00672001
240700             MOVE DP040I-COMPUTED-UPC-CHK-DIGIT                   00672101
240800                        TO PV-GIFT-CRD-CHECK-DIGIT                00672201
240900          END-IF                                                  00672301
241000          MOVE PV-GIFT-CRD-NBR-N TO PT-AUTH-FIELD(13)             00672401
241100          MOVE SV005-KMC-ID      TO PV-KMC-ID                     00672501
241200        ELSE                                                      00672601
241204          MOVE SVT00008-UPC-NBR  TO PV-UPC-11-30                  00672701
241208          MOVE SV004-KOHLS-IIN   TO PV-BIN-6-30                   00672801
241210          MOVE SVT00001-CRD-SPCTY-TYP-CDE  TO PV-CARD-TYPE-1-30   00672901
241212          MOVE PV-KMC-ID         TO PV-CARD-NBR-12-30             00673001
241213          MOVE PV-CARD-NUMBER-30 TO PT-AUTH-FIELD(13)             00673101
241214* DISPLAY MESSAGE IN EPCL (for testing purposes)                  00673201
241215*    SET EP000-SL-INFORMATION TO  TRUE                            00673301
241216*    MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER       00673401
241217*    MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                    00673501
241218*    MOVE AU002-DATA-BUF                                          00673601
241219*                     TO EP000-MD-SYSTEM-LOG-MESSAGE              00673701
241220*                (EP000-MESSAGE-LINE-COUNTER)                     00673801
241221*    STRING '30 DIGIT VGC ' PV-CARD-NUMBER-30                     00673901
241222*           'PV-KMC-IC ' PV-KMC-ID                                00674001
241223*              DELIMITED BY SIZE                                  00674101
241224*              INTO  EP000-MD-SYSTEM-LOG-MESSAGE                  00674201
241225*                   (EP000-MESSAGE-LINE-COUNTER)                  00674301
241226*    END-STRING                                                   00674401
241227*    PERFORM EP000-1000-POST-MESSAGE                              00674501
241228        END-IF                                                    00674601
241230     END-IF.                                                      00674701
241310                                                                  00674801
241400* FORMAT APPROVED AMOUNT, FIPAY FIELD 16                          00674901
241500     MULTIPLY SV005-APPROVED-TENDER-AMT BY 100                    00675001
241600              GIVING FI-16-AMOUNT.                                00675101
241700     MOVE FI-16-AMOUNT TO PV-CHAR-AMT.                            00675201
241800     MOVE ZERO TO PV-CTR.                                         00675301
241900     INSPECT PV-CHAR-AMT TALLYING PV-CTR FOR LEADING ZEROS.       00675401
242000     COMPUTE PV-CTR2 = 9 - PV-CTR.                                00675501
242100     ADD 1 TO PV-CTR.                                             00675601
242200     MOVE PV-CHAR-AMT (PV-CTR:PV-CTR2) TO PT-AUTH-FIELD (16).     00675701
242300                                                                  00675801
242400* FORMAT CARD TYPE, FIPAY FIELD 21                                00675901
242500     EVALUATE TRUE                                                00676001
242600       WHEN SV005-KMRC-CRD                                        00676101
242700         SET FI-21-KMRC TO TRUE                                   00676201
242800       WHEN SV005-GIFT-CRD                                        00676301
PGC            IF FI-21-CARD-TYPE = '*PlasticGC'                        00676401
PGC               SET FI-21-PLASTIC   TO TRUE                           00676501
PGC            ELSE                                                     00676601
242900            SET FI-21-GIFT-CARD TO TRUE                           00676701
PGC            END-IF                                                   00676801
243000     END-EVALUATE.                                                00676901
                                                                        00677001
243100     MOVE FI-21-CARD-TYPE TO PT-AUTH-FIELD (21).                  00677101
243200                                                                  00677201
243300* FORMAT AUTH CODE, FIPAY FIELD 37                                00677301
243400     MOVE PV-APPROVAL-NBR TO FI-37-AUTH-CODE.                     00677401
243500     MOVE FI-37-AUTH-CODE TO PT-AUTH-FIELD (37).                  00677501
243600                                                                  00677601
243710* FORMAT DISPLAY FIELD, FIPAY FIELD 38                            00677701
243800     EVALUATE SV005-RESPONSE-CODE                                 00677801
243900       WHEN 0                                                     00677901
244000         SET FI-38-APPROVE TO TRUE                                00678001
244100       WHEN 1                                                     00678101
244200         SET FI-38-APPROVE TO TRUE                                00678201
244300       WHEN 2                                                     00678301
244400         SET FI-38-EDIT-ERROR TO TRUE                             00678401
244500       WHEN 6                                                     00678501
244600         SET FI-38-INVALID-PIN TO TRUE                            00678601
244700       WHEN 7                                                     00678701
244800         SET FI-38-DECLINE TO TRUE                                00678801
244900       WHEN 8                                                     00678901
245000         SET FI-38-REFER TO TRUE                                  00679001
245100       WHEN 9                                                     00679101
245200         SET FI-38-OFFLINE TO TRUE                                00679201
245300     END-EVALUATE.                                                00679301
245400                                                                  00679401
245500     MOVE FI-38-DISPLAY TO PT-AUTH-FIELD (38).                    00679501
245600                                                                  00679601
245700* FORMAT REMAINING BALANCE, FIPAY FIELD 52                        00679701
245800     MULTIPLY SV005-KMC-REMAINING-BALANCE BY 100                  00679801
245900              GIVING FI-52-BALANCE.                               00679901
246000     MOVE FI-52-BALANCE TO PV-CHAR-AMT.                           00680001
246100     MOVE ZERO TO PV-CTR.                                         00680101
246200     INSPECT PV-CHAR-AMT TALLYING PV-CTR FOR LEADING ZEROS.       00680201
246300     COMPUTE PV-CTR2 = 9 - PV-CTR.                                00680301
246400     ADD 1 TO PV-CTR.                                             00680401
246500     MOVE PV-CHAR-AMT (PV-CTR:PV-CTR2) TO PT-AUTH-FIELD (52).     00680501
246600                                                                  00680601
246700                                                                  00680701
246800* IF ECOMM ISSUE, SEND A PIN, OTHERWISE                           00680801
246900* DO NOT SEND PIN NUMBER BACK IN RESPONSE                         00680901
247000* MOVE SPACES TO PIN, FIPAY FIELD 85                              00681001
247100     IF FI-PV-ISSUE AND                                           00681101
247200        PV-E-ECOMMERCE-STORE AND                                  00681201
PGC           PV-VIRTUAL                                                00681301
247300        MOVE SV005-PIN TO FI-85-PIN                               00681401
247400        MOVE FI-85-PIN TO PT-AUTH-FIELD (85)                      00681501
247500     ELSE                                                         00681601
247600        MOVE ZEROS TO FI-85-PIN                                   00681701
247700        MOVE SPACES TO PT-AUTH-FIELD (85)                         00681801
247800     END-IF.                                                      00681901
247900                                                                  00682001
247910* DISPLAY MESSAGE IN EPCL (for testing purposes)                  00682101
247920*    SET EP000-SL-INFORMATION TO  TRUE.                           00682201
247930*    MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER.      00682301
247940*    MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   00682401
247950*    MOVE AU002-DATA-BUF                                          00682501
247960*                     TO EP000-MD-SYSTEM-LOG-MESSAGE              00682601
247970*                (EP000-MESSAGE-LINE-COUNTER).                    00682701
247980*    STRING '30 DIGIT VGC ' PV-CARD-NUMBER-30                     00682801
247990*           'PIN ' SV005-PIN                                      00682901
247992*              DELIMITED BY SIZE                                  00683001
247993*              INTO  EP000-MD-SYSTEM-LOG-MESSAGE                  00683101
247994*                   (EP000-MESSAGE-LINE-COUNTER)                  00683201
247995*    END-STRING.                                                  00683301
247996*    PERFORM EP000-1000-POST-MESSAGE.                             00683401
248000** STRING RESPONSE TOGETHER                                       00683501
248100     MOVE 1 TO PV-WS-CTR.                                         00683601
248200     PERFORM VARYING PT-AUTH-INDEX FROM 1 BY 1 UNTIL              00683701
248300             PT-AUTH-INDEX > PV-TOTAL-NO-FIELDS                   00683801
248400       STRING PT-AUTH-FIELD (PT-AUTH-INDEX)                       00683901
248500                 DELIMITED BY '  '                                00684001
248600              ',' DELIMITED BY SIZE                               00684101
248700              INTO AU002-DATA-BUF                                 00684201
248800              WITH POINTER PV-WS-CTR                              00684301
248900       END-STRING                                                 00684401
249000     END-PERFORM.                                                 00684501
249100                                                                  00684601
249200** NOW YOU CAN CALCULATE THE HEX LENGTH OF THE RESPONSE.          00684701
249300** THE FINAL PV-WS-CTR VALUE IS THE LENGTH + 1 SO SUBTRACT        00684801
249400** 1 FROM IT TO GET THE MESSAGE LENGTH WITHOUT HEADER.            00684901
249500     COMPUTE PV-MSG-LEN-WOHDR = PV-WS-CTR - 1.                    00685001
249600** FOR MESSAGE LENGTH WITH HEADER, ADD 2.                         00685101
249700     COMPUTE PV-MSG-LEN-WHDR = PV-MSG-LEN-WOHDR + 2.              00685201
249800** CONVERT MESSAGE LENGTH WITHOUT HEADER TO HEX AND INSERT        00685301
249900** INTO THE RESPONSE MESSAGE.                                     00685401
250000     MOVE PV-MSG-LEN-WOHDR TO PV-HEX-BINARY.                      00685501
250100                                                                  00685601
250200     MOVE PV-HEX-LENGTH TO AU002-DATA-LEN-HEX.                    00685701
250300                                                                  00685801
250400** THE TOTAL MESSAGE LENGTH TO BE SENT BACK INCLUDES THE          00685901
250500** HEADER.                                                        00686001
250600     MOVE PV-MSG-LEN-WHDR TO AU002-TOT-REC-LENGTH.                00686101
250700                                                                  00686201
250800* DISPLAY MESSAGE IN EPCL (for testing purposes)                  00686301
250900*    SET EP000-SL-INFORMATION TO  TRUE.                           00686401
251000*    MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER.      00686501
251100*    MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   00686601
251200*    MOVE AU002-DATA-BUF                                          00686701
251300*                     TO EP000-MD-SYSTEM-LOG-MESSAGE              00686801
251400*                (EP000-MESSAGE-LINE-COUNTER).                    00686901
251500*    PERFORM EP000-1000-POST-MESSAGE.                             00687001
251600                                                                  00687101
251700* SEND DATA TO LISTENER                                           00687201
251800     PERFORM 8000-SEND-DATA-TO-LISTENER.                          00687301
251900                                                                  00687401
252000*5000-EXIT.                                                       00687501
051722                                                                  00687601
051722*----------------------------------------------------------------*00687701
051722* FRAUD CARD LOCK CHECK                                          *00687801
051722*  THIS CARD HAS JUST FAILED TO AUTH DUE TO INVALID PIN AND      *00687901
051722*  MAYBE THE RESULT OF A FRAUD BOT ATTACK.  THE NUMBER OF FAILED *00688001
051722*  PIN ATTEMPTS WILL BE TRACKED IN THE SVT_CARD_FAILED_ATTEMPTS  *00688101
051722*  DB2 TABLE AND IF THE NUMBER OF ATTEMPTS EXCEEDS THE           *00688201
051722*  PREDETERMINED THRESHOLD, THEN THE CARD WILL RECEIVE A HARD    *00688301
051722*  DECLINE RESPONSE UNTIL THE SVT_CARD_FAILED_ATTEMPTS ROW IS    *00688401
051722*  RESET OR REMOVED. THIS PARAGRAPH WILL:                        *00688501
051722*    1. CHECK THE CURRENT AMOUNT OF FAILED ATTEMPTS ON THE TABLE *00688601
051722*       AND COMPARE IT WITH THE THRESHOLD AMOUNT                 *00688701
051722*    2. UPDATE THE NUMBER OF FAILED ATTEMPTS IN THE DB2 TABLE    *00688801
051722*    3. ALTER THE RESPONSE TO 'HARD DECLINE' (7)                 *00688901
051722*----------------------------------------------------------------*00689001
051722 6000-FRAUD-CARD-LOCK-CHECK.                                      00689101
051722                                                                  00689201
051722*  ATTEMPT TO SELECT SVT_CARD_FAILED_ATTEMPTS                     00689301
051722*  TO SEE IF THE CARD IS ALREADY LOCKED                           00689401
051722     PERFORM 2185-SELECT-CARD-FAILED-ATT                          00689501
051722     IF SVT00019-CARD-LOCK-INDICATOR = 'Y'                        00689601
051722*  IF LOCKED AND VALID CARD/PIN INQUIRY, LOG                      00689701
051722*  THE FACT THAT A SUCCESSFUL RESPONSE WAS BLOCKED                00689801
051722        IF SV005-APPROVE                                          00689901
051722            SET SV005-HARD-DECLINE TO TRUE                        00690001
051722            PERFORM 6100-LOG-FRAUD-BLOCK-MESSAGE                  00690101
051722        END-IF                                                    00690201
051722*  LOCKED CARDS MUST ALWAYS RECEIVE HARD DECLINE RESPONSE         00690301
051722        SET SV005-HARD-DECLINE TO TRUE                            00690401
051722*  UPDATE THE FAILED ATTEMPTS DB2 TABLE COUNTER FOR THIS CARD     00690501
051722        INITIALIZE PV-RETRY-COUNT                                 00690601
051722        PERFORM 2195-UPDATE-CRD-FLD-ATT-TABLE                     00690701
051722           WITH TEST AFTER                                        00690801
051722           UNTIL ((SQLCODE = ZERO) OR                             00690901
051722                  (PV-RETRY-COUNT >                               00691001
051722                   PC-MAXIMUM-RETRY-COUNT))                       00691101
051722        IF ((SQLCODE = -904) OR                                   00691201
051722             (SQLCODE = -913))                                    00691301
051722             MOVE 'UPDATE CRD FLD ATT ROW (SVT00019) '            00691401
051722                   TO AA-ATTEMPTED-ACTION                         00691501
051722            PERFORM 9100-DB2-ERROR                                00691601
051722            PERFORM 9999-RETURN-TO-NATIVE-CICS                    00691701
051722        END-IF                                                    00691801
051722     ELSE                                                         00691901
051722* CARD LOCK INDICATOR = 'N'                                       00692001
051722* IF ROW ALREADY FOUND ON FAILED ATTEMPTS TABLE                   00692101
051722        IF PS-CARD-FAILED-FOUND AND                               00692201
051722* ONLY UPDATE IF FAILED TO AUTHORIZE DUE TO INVALID CARD/PIN      00692600
051722* APPROVED AUTHS OR REFERRALS SHOULD NOT UPDATE TO                00692700
051722* THE SVT_CARD_FAILED_ATTEMPTS TABLE                              00692800
051722           (SV005-INVALID-PIN OR                                  00692900
051722            SV005-HARD-DECLINE)                                   00693000
051722*  UPDATE THE FAILED ATTEMPTS DB2 TABLE COUNTER FOR THIS CARD     00693100
051722            INITIALIZE PV-RETRY-COUNT                             00693200
051722            PERFORM 2195-UPDATE-CRD-FLD-ATT-TABLE                 00693300
051722               WITH TEST AFTER                                    00693400
051722               UNTIL ((SQLCODE = ZERO) OR                         00693500
051722                      (PV-RETRY-COUNT >                           00693600
051722                       PC-MAXIMUM-RETRY-COUNT))                   00693700
051722            IF ((SQLCODE = -904) OR                               00693800
051722                 (SQLCODE = -913))                                00693900
051722                 MOVE 'UPDATE CRD FLD ATT ROW (SVT00019) '        00694000
051722                       TO AA-ATTEMPTED-ACTION                     00694100
051722                PERFORM 9100-DB2-ERROR                            00694200
051722                PERFORM 9999-RETURN-TO-NATIVE-CICS                00694300
051722            END-IF                                                00694400
051722        END-IF                                                    00694500
051722     END-IF.                                                      00694600
051722                                                                  00694700
051722*6000-EXIT.                                                       00694800
051722                                                                  00698200
051722*----------------------------------------------------------------*00698300
051722* FRAUD CARD LOCKED BLOCKED STOLEN CARD MESSAGING                *00698400
051722*  THIS CARD WOULD'VE BEEN COMPROMISED IF IT WEREN'T FOR THE     *00698500
051722*  FRAUD PROTECTION LOCKING MECHANISM.  THIS PARAGRAPH WILL LOG  *00698600
051722*  A MESSAGE INDICATING THAT THIS CARD WAS PREVENTED FROM BEING  *00698700
051722*  COMPROMISED.                                                  *00698800
051722*----------------------------------------------------------------*00698900
051722 6100-LOG-FRAUD-BLOCK-MESSAGE.                                    00699000
051722                                                                  00699100
051722* DISPLAY EPCL RESPONSE LOG MESSAGE                               00699200
051722                                                                  00699300
051722     SET LM-DM-BLK TO TRUE.                                       00699400
051722     PERFORM 8500-MESSAGE-MONITORING.                             00699500
051722                                                                  00699600
051722*6100-EXIT.                                                       00699700
051722                                                                  00699800
051722*----------------------------------------------------------------*00699900
051722* DETERMINE IF THE CARD NUMBER IS ACTUALLY A VALID KOHLS         *00700000
051722* STORED VALUE CARD BEFORE ATTEMPTING TO INSERT A ROW INTO       *00700100
051722* SVT_CARD_FAILED_ATTEMPTS. ONLY INSERT IF FAILED TO AUTHORIZE   *00700200
051722* WAS DUE TO INVALID CARD OR INVALID PIN (FRAUD ERRORS).         *00700300
051722*----------------------------------------------------------------*00700400
051722 6200-CHECK-FOR-INSERT-FLD-ATT.                                   00700500
051722                                                                  00700600
051722* IF THIS ISN'T A VALID CARD NUMBER, WE DO NOT WANT TO INSERT     00700700
051722* TO THE SVT_CARD_FAILED_ATTEMPTS TABLE                           00700800
051722     IF PV-CARD-NOT-ACTIVE                                        00700900
051722         NEXT SENTENCE                                            00701000
051722     ELSE                                                         00701100
051722* ONLY INSERT IF FAILED TO AUTHORIZE DUE TO INVALID CARD/PIN      00701200
051722* APPROVED AUTHS OR REFERRALS SHOULD NOT INSERT TO                00701300
051722* THE SVT_CARD_FAILED_ATTEMPTS TABLE                              00701400
051722         IF SV005-INVALID-PIN OR                                  00701500
051722            SV005-HARD-DECLINE                                    00701600
051722             INITIALIZE PV-RETRY-COUNT                            00701700
051722             PERFORM 2190-INSERT-CRD-FLD-ATT-TABLE                00701800
051722                WITH TEST AFTER                                   00701900
051722               UNTIL ((SQLCODE = ZERO) OR                         00702000
051722                      (PV-RETRY-COUNT >                           00702100
051722                                 PC-MAXIMUM-RETRY-COUNT))         00702200
051722             IF ((SQLCODE = -904) OR                              00702300
051722                 (SQLCODE = -913))                                00702400
051722                  MOVE 'INSERT CRD FLD ATT ROW  (SVT00019)'       00702500
051722                              TO AA-ATTEMPTED-ACTION              00702600
051722                  PERFORM 9100-DB2-ERROR                          00702700
051722                  PERFORM 9999-RETURN-TO-NATIVE-CICS              00702800
051722             END-IF                                               00702900
051722         END-IF                                                   00703000
051722     END-IF.                                                      00703100
051722                                                                  00703200
051722*6200-EXIT.                                                       00703300
051722                                                                  00703400
252100                                                                  00703500
252200*----------------------------------------------------------------*00703600
252300* RETRIEVE AUTH REQUEST                                          *00703700
252400*  RETRIEVE THE AUTHORIZATION REQUEST FROM THE LISTENER.         *00703800
252500*   ERROR CHECKING:                                              *00703900
252600*  IF A CONDITION OTHER THAN END-OF-DATA (RECEIVED DATA WAS LESS *00704000
252700*  THAN EXPLICITYLY STATED LENGTH, WHICH IS NORMAL), AN ERROR    *00704100
252800*  WILL BE POSTED, AND THE TRANSACTION WILL BE TERMINATED,       *00704200
252900*  WITHOUT A RESPONSE TO THE ISP.  BECAUSE THERE IS NO RESPONSE, *00704300
253000*  FLOOR LIMITS WILL THEN BE USED BY THE ISP, AFTER THE REQUEST  *00704400
253100*  TIMES OUT.                                                    *00704500
253200*----------------------------------------------------------------*00704600
253300 7000-RETRIEVE-AUTH-REQUEST.                                      00704700
253400                                                                  00704800
253500     EXEC CICS                                                    00704900
253600         RETRIEVE                                                 00705000
253700             INTO    (AU001-GC-AUTH-REQ-RECORD)                   00705100
253800             LENGTH  (PC-COMMUNICATIONS-IN-LENGTH)                00705200
253900             RESP    (PV-CICS-RESPONSE)                           00705300
254000     END-EXEC.                                                    00705400
254100                                                                  00705500
254200     EVALUATE TRUE                                                00705600
254300         WHEN ((PV-CICS-RESPONSE NOT = DFHRESP(NORMAL))           00705700
254400                      AND (PV-CICS-RESPONSE NOT = DFHRESP(EOC)))  00705800
254500             SET EP000-SL-ERROR TO TRUE                           00705900
254600             MOVE PV-CICS-RESPONSE TO PV-CICS-RESPONSE-DISP       00706000
254700             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            00706100
254800             STRING 'ERROR RETRIEVING RESPONSE MESSAGE '          00706200
254900                                         DELIMITED BY SIZE        00706300
255000                ' - CICS RESPONSE = '    DELIMITED BY SIZE        00706400
255100                PV-CICS-RESPONSE-DISP    DELIMITED BY SIZE        00706500
255200                 INTO  EP000-MD-SYSTEM-LOG-MESSAGE                00706600
255300                           (EP000-MESSAGE-LINE-COUNTER)           00706700
255400             PERFORM EP000-1000-POST-MESSAGE                      00706800
255500             PERFORM 9999-RETURN-TO-NATIVE-CICS                   00706900
255600     END-EVALUATE.                                                00707000
255700     MOVE AU001-LISTENER-CODE TO AUWS001-QUEUE-PARM.              00707100
255800                                                                  00707200
255900* CHECK FOR VALID PARM, AND FILL IN TSQ NAME.                     00707300
256000     IF  AUWS001-VALID-PARM                                       00707400
256100         MOVE AUWS001-QUEUE-NAME(AUWS001-QUEUE-PARM-N)            00707500
256200                TO PV-TSQ-NAME                                    00707600
256300                                                                  00707700
256400     ELSE                                                         00707800
256500             SET EP000-SL-ERROR TO TRUE                           00707900
256600             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            00708000
256700             STRING '7000-RETRIEVE-AUTH-REQUEST '                 00708100
256800                                         DELIMITED BY SIZE        00708200
256900                'INVALID PARM VALUE= '   DELIMITED BY SIZE        00708300
257000                AU001-LISTENER-CODE      DELIMITED BY SIZE        00708400
257100                 INTO  EP000-MD-SYSTEM-LOG-MESSAGE                00708500
257200                           (EP000-MESSAGE-LINE-COUNTER)           00708600
257300             PERFORM EP000-1000-POST-MESSAGE                      00708700
257400             PERFORM 9999-RETURN-TO-NATIVE-CICS                   00708800
257500     END-IF.                                                      00708900
257600                                                                  00709000
257700*7000-EXIT.                                                       00709100
257800*----------------------------------------------------------------*00709200
257900* SEND DATA TO LISTENER.                                         *00709300
258000* PUT THE RESPONSE ON THE TEMP STORAGE QUEUE TO BE READ BY       *00709400
258100* BY THE LISTENER PROGRAM.                                       *00709500
258200*  QUEUE FORMAT:                                                 *00709600
258300*  LINE 1: # OF NEXT RECORD TO BE WRITTEN TO THE QUEUE BY THE    *00709700
258400*          CHILD PROGRAM, FOLLOWED BY THE TOTAL NUMBER OF        *00709800
258500*          POSSIBLE ENTRIES IN THE QUEUE (100)                   *00709900
258600*  LINE 2: # OF NEXT RECORD TO BE READ BY LISTENER FOLLOWED BY   *00710000
258700*          TOTAL NUMBER OF POSSIBLE ENTRIES IN THE QUEUE (100)   *00710100
258800*          (ONLY USED BY LISTENER)                               *00710200
258900*  LINES 3 TO 100: RESPONSES FROM CHILD PROGRAMS IN FORMAT       *00710300
259000*                  TCP-BUF-OUT                                   *00710400
259100*----------------------------------------------------------------*00710500
259200 8000-SEND-DATA-TO-LISTENER.                                      00710600
259300     PERFORM 8110-ENQ-TCPIPPRQ.                                   00710700
259400     PERFORM 8120-READQ-TCPIPPRQ-RECORD1.                         00710800
259500                                                                  00710900
259600     PERFORM 8140-REWRITE-TCPIPPRQ-NEXT-REC.                      00711000
259700     ADD 1 TO PV-NEXT-RECORD.                                     00711100
259800                                                                  00711200
259900     IF PV-NEXT-RECORD > PV-TOTAL-RECORDS                         00711300
260000         MOVE 3 TO PV-NEXT-RECORD                                 00711400
260100     END-IF.                                                      00711500
260200                                                                  00711600
260300     PERFORM 8150-REWRITE-TCPIPPRQ-RECORD1.                       00711700
260400     PERFORM 8160-DEQ-TCPIPPRQ.                                   00711800
260500*8000-EXIT                                                        00711900
260600*----------------------------------------------------------------*00712000
260700 8110-ENQ-TCPIPPRQ.                                               00712100
260800     EXEC CICS                                                    00712200
260900         ENQ                                                      00712300
261000             RESOURCE  (PV-TSQ-NAME)                              00712400
261100             RESP      (PV-CICS-RESPONSE)                         00712500
261200     END-EXEC.                                                    00712600
261300                                                                  00712700
261400     EVALUATE TRUE                                                00712800
261500         WHEN PV-CICS-RESPONSE = DFHRESP (NORMAL)                 00712900
261600             CONTINUE                                             00713000
261700         WHEN OTHER                                               00713100
261800             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            00713200
261900             SET EP000-SL-ERROR TO TRUE                           00713300
262000             STRING '8110-ENQ-TCPIPPRQ'                           00713400
262100                    ' ERROR ON ENQ TEMP STORAGE QUEUE: '          00713500
262200                     PV-TSQ-NAME                                  00713600
262300                     ' RESP:'                                     00713700
262400                     PV-CICS-RESPONSE-DISP                        00713800
262500                       DELIMITED BY SIZE                          00713900
262600                       INTO EP000-MD-SYSTEM-LOG-MESSAGE           00714000
262700                                (EP000-MESSAGE-LINE-COUNTER)      00714100
262800             END-STRING                                           00714200
262900             PERFORM EP000-1000-POST-MESSAGE                      00714300
263000             PERFORM 9999-RETURN-TO-NATIVE-CICS                   00714400
263100     END-EVALUATE.                                                00714500
263200*8110-EXIT.                                                       00714600
263300*----------------------------------------------------------------*00714700
263400 8120-READQ-TCPIPPRQ-RECORD1.                                     00714800
263500     MOVE LENGTH OF PV-TCPIPPRQ-RECORD1 TO PV-TSQ-LENGTH.         00714900
263600                                                                  00715000
263700     EXEC CICS                                                    00715100
263800         READQ TS                                                 00715200
263900             QUEUE   (PV-TSQ-NAME)                                00715300
264000             INTO    (PV-TCPIPPRQ-RECORD1)                        00715400
264100             LENGTH  (PV-TSQ-LENGTH)                              00715500
264200             ITEM    (1)                                          00715600
264300             RESP    (PV-CICS-RESPONSE)                           00715700
264400     END-EXEC.                                                    00715800
264500                                                                  00715900
264600     EVALUATE TRUE                                                00716000
264700         WHEN PV-CICS-RESPONSE = DFHRESP (NORMAL)                 00716100
264800             CONTINUE                                             00716200
264900         WHEN OTHER                                               00716300
265000             SET EP000-SL-ERROR         TO TRUE                   00716400
265100             MOVE PV-CICS-RESPONSE TO PV-CICS-RESPONSE-DISP       00716500
265200             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            00716600
265300             STRING '8120-READQ-TCPIPPRQ-RECORD1'                 00716700
265400                    ' ERROR ON READ TEMP STORAGE QUEUE: '         00716800
265500                     PV-TSQ-NAME                                  00716900
265600                     ' RESP:'                                     00717000
265700                     PV-CICS-RESPONSE-DISP                        00717100
265800                       DELIMITED BY SIZE                          00717200
265900                       INTO EP000-MD-SYSTEM-LOG-MESSAGE           00717300
266000                                (EP000-MESSAGE-LINE-COUNTER)      00717400
266100             END-STRING                                           00717500
266200             PERFORM EP000-1000-POST-MESSAGE                      00717600
266300             PERFORM 9999-RETURN-TO-NATIVE-CICS                   00717700
266400     END-EVALUATE.                                                00717800
266500*8120-EXIT.                                                       00717900
266600*----------------------------------------------------------------*00718000
266700 8140-REWRITE-TCPIPPRQ-NEXT-REC.                                  00718100
266800                                                                  00718200
266900     INITIALIZE   PV-TSQ-DATA-RECORD.                             00718300
267000     MOVE +4120                      TO  PV-TSQ-LENGTH.           00718400
267100     MOVE AU001-MATCHING-NBR-FIELD   TO  AU002-MATCHING-NBR-FIELD.00718500
267200     MOVE AU002-GC-RESP-TSQ-RECORD   TO  PV-TSQ-DATA-PORTION.     00718600
267300     MOVE PV-NEXT-RECORD             TO  PV-ITEM-NBR.             00718700
267400                                                                  00718800
267500     EXEC CICS                                                    00718900
267600         WRITEQ TS                                                00719000
267700             QUEUE   (PV-TSQ-NAME)                                00719100
267800             FROM    (PV-TSQ-DATA-RECORD)                         00719200
267900             LENGTH  (PV-TSQ-LENGTH)                              00719300
268000             ITEM    (PV-ITEM-NBR)                                00719400
268100                 REWRITE                                          00719500
268200             RESP    (PV-CICS-RESPONSE)                           00719600
268300     END-EXEC.                                                    00719700
268400                                                                  00719800
268500     EVALUATE TRUE                                                00719900
268600         WHEN PV-CICS-RESPONSE = DFHRESP (NORMAL)                 00720000
268700             CONTINUE                                             00720100
268800         WHEN OTHER                                               00720200
268900             SET EP000-SL-ERROR         TO TRUE                   00720300
269000             MOVE PV-CICS-RESPONSE TO PV-CICS-RESPONSE-DISP       00720400
269100             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            00720500
269200             STRING '8140-REWRITE-TCPIPPRQ-NEXT-REC'              00720600
269300                    ' ERROR WRITING TO TEMP STORAGE QUEUE: '      00720700
269400                     PV-TSQ-NAME                                  00720800
269500                     ' RESP:'                                     00720900
269600                     PV-CICS-RESPONSE-DISP                        00721000
269700                       DELIMITED BY SIZE                          00721100
269800                       INTO EP000-MD-SYSTEM-LOG-MESSAGE           00721200
269900                                (EP000-MESSAGE-LINE-COUNTER)      00721300
270000             END-STRING                                           00721400
270100             PERFORM EP000-1000-POST-MESSAGE                      00721500
270200             PERFORM 9999-RETURN-TO-NATIVE-CICS                   00721600
270300     END-EVALUATE.                                                00721700
270400*8140-EXIT.                                                       00721800
270500*----------------------------------------------------------------*00721900
270600 8150-REWRITE-TCPIPPRQ-RECORD1.                                   00722000
270700     MOVE LENGTH OF PV-TCPIPPRQ-RECORD1 TO PV-TSQ-LENGTH.         00722100
270800     MOVE +1 TO PV-ITEM-NBR.                                      00722200
270900                                                                  00722300
271000     EXEC CICS                                                    00722400
271100         WRITEQ TS                                                00722500
271200             QUEUE   (PV-TSQ-NAME)                                00722600
271300             FROM    (PV-TCPIPPRQ-RECORD1)                        00722700
271400             LENGTH  (PV-TSQ-LENGTH)                              00722800
271500             ITEM    (PV-ITEM-NBR)                                00722900
271600                 REWRITE                                          00723000
271700             RESP    (PV-CICS-RESPONSE)                           00723100
271800     END-EXEC.                                                    00723200
271900                                                                  00723300
272000     EVALUATE TRUE                                                00723400
272100         WHEN PV-CICS-RESPONSE = DFHRESP (NORMAL)                 00723500
272200             CONTINUE                                             00723600
272300         WHEN OTHER                                               00723700
272400             SET EP000-SL-ERROR         TO TRUE                   00723800
272500             MOVE PV-CICS-RESPONSE TO PV-CICS-RESPONSE-DISP       00723900
272600             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            00724000
272700             STRING '8140-REWRITE-TCPIPPRQ-RECORD1'               00724100
272800                    ' ERROR WRITING TO TEMP STORAGE QUEUE: '      00724200
272900                     PV-TSQ-NAME                                  00724300
273000                     ' RESP:'                                     00724400
273100                     PV-CICS-RESPONSE-DISP                        00724500
273200                       DELIMITED BY SIZE                          00724600
273300                       INTO EP000-MD-SYSTEM-LOG-MESSAGE           00724700
273400                                (EP000-MESSAGE-LINE-COUNTER)      00724800
273500             END-STRING                                           00724900
273600             PERFORM EP000-1000-POST-MESSAGE                      00725000
273700             PERFORM 9999-RETURN-TO-NATIVE-CICS                   00725100
273800     END-EVALUATE.                                                00725200
273900*8150-EXIT.                                                       00725300
274000*----------------------------------------------------------------*00725400
274100 8160-DEQ-TCPIPPRQ.                                               00725500
274200     EXEC CICS                                                    00725600
274300         DEQ                                                      00725700
274400             RESOURCE  (PV-TSQ-NAME)                              00725800
274500             RESP      (PV-CICS-RESPONSE)                         00725900
274600     END-EXEC.                                                    00726000
274700                                                                  00726100
274800     EVALUATE TRUE                                                00726200
274900         WHEN PV-CICS-RESPONSE = DFHRESP (NORMAL)                 00726300
275000             CONTINUE                                             00726400
275100         WHEN OTHER                                               00726500
275200             SET EP000-SL-ERROR         TO TRUE                   00726600
275300             MOVE PV-CICS-RESPONSE TO PV-CICS-RESPONSE-DISP       00726700
275400             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            00726800
275500             STRING '8160-DEQ-TCPIPPRQ'                           00726900
275600                    ' ERROR ON DEQ TEMP STORAGE QUEUE: '          00727000
275700                     PV-TSQ-NAME                                  00727100
275800                     ' RESP:'                                     00727200
275900                     PV-CICS-RESPONSE-DISP                        00727300
276000                       DELIMITED BY SIZE                          00727400
276100                       INTO EP000-MD-SYSTEM-LOG-MESSAGE           00727500
276200                                (EP000-MESSAGE-LINE-COUNTER)      00727600
276300             END-STRING                                           00727700
276400             PERFORM EP000-1000-POST-MESSAGE                      00727800
276500             PERFORM 9999-RETURN-TO-NATIVE-CICS                   00727900
276600     END-EVALUATE.                                                00728000
276700*8160-EXIT.                                                       00728100
276800                                                                  00728200
276900*----------------------------------------------------------------*00728300
277000* MESSAGE MONITORING                                             *00728400
277100* DISPLAY A MESSAGE TO THE EPCL LOG                              *00728500
277200*----------------------------------------------------------------*00728600
277300 8500-MESSAGE-MONITORING.                                         00728700
277400                                                                  00728800
277500     SET EP000-SL-INFORMATION TO  TRUE.                           00728900
277600     MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER.      00729000
277700                                                                  00729100
277800     EVALUATE TRUE                                                00729200
277900       WHEN FI-PV-BAL-INQ                                         00729300
278000       WHEN FI-PV-BAL-INQ-ADD-ON                                  00729400
278100         SET LM-DM-BALINQ             TO TRUE                     00729500
278200       WHEN FI-PV-REFUND OR                                       00729600
278300            FI-PV-ISSUE                                           00729700
278400          IF FI-PV-10-REVERSAL                                    00729800
278500            SET LM-DM-VOID-ISSUE      TO TRUE                     00729900
278600          ELSE                                                    00730000
278700            SET LM-DM-ISSUE           TO TRUE                     00730100
278800          END-IF                                                  00730200
278900       WHEN FI-PV-SALE                                            00730300
279000         IF FI-PV-10-REVERSAL                                     00730400
279100           SET LM-DM-VOID-TENDER      TO TRUE                     00730500
279200         ELSE                                                     00730600
030600           IF FI-PV-REAUTH                                        00730700
279100             SET LM-DM-REAUTH           TO TRUE                   00730800
279200           ELSE                                                   00730900
030600             IF FI-PV-REVERSAL-REAUTH                             00731000
279100               SET LM-DM-REVERSAL-REAUTH  TO TRUE                 00731100
279200             ELSE                                                 00731200
279300               SET LM-DM-TENDER           TO TRUE                 00731300
279400             END-IF                                               00731400
279400           END-IF                                                 00731500
279400         END-IF                                                   00731600
279500       WHEN OTHER                                                 00731700
279600         SET LM-DM-UNKNOWN            TO TRUE                     00731800
279700     END-EVALUATE.                                                00731900
279800                                                                  00732000
279900     SET LM-DM-REQUEST-MSG TO TRUE.                               00732100
280000     IF SV005-CARD-TYPE NOT = ZERO                                00732200
280100       EVALUATE TRUE                                              00732300
280200         WHEN SV005-KMRC-CRD                                      00732400
280300           SET LM-DM-KMRC-MSG TO  TRUE                            00732500
280400         WHEN SV005-GIFT-CRD                                      00732600
280500           SET LM-DM-GC-MSG TO  TRUE                              00732700
280600       END-EVALUATE                                               00732800
280700     END-IF.                                                      00732900
280800                                                                  00733000
280900     MOVE ZERO TO LM-DM-APPROVE-AMOUNT.                           00733100
281000     MOVE ZERO TO LM-DM-BALANCE.                                  00733200
281100     IF LM-DM-RSP                                                 00733300
281200         SET LM-DM-RC-DISPLAY TO TRUE                             00733400
281300         IF PV-EDIT-ERROR                                         00733500
281400             MOVE PV-REFERRAL-CODE-NUMBER TO LM-DM-RESP-CD        00733600
281500         ELSE                                                     00733700
281600             MOVE SV005-RESPONSE-CODE  TO  LM-DM-RESP-CD          00733800
281700             MOVE SV005-APPROVED-TENDER-AMT                       00733900
281800                                       TO LM-DM-APPROVE-AMOUNT    00734000
281900             MOVE SV005-KMC-REMAINING-BALANCE TO LM-DM-BALANCE    00734100
282000         END-IF                                                   00734200
282100     END-IF.                                                      00734300
282200                                                                  00734400
282300     MOVE FI-08-STORE-NO         TO  LM-DM-STORE-NBR.             00734500
282400     MOVE FI-09-TERM-NO          TO  LM-DM-TERM-NBR.              00734600
282500     MOVE FI-17-TRAN-NO          TO  LM-DM-TRAN-NBR.              00734700
282600     MOVE PV-KMC-AMT             TO  LM-DM-TRAN-AMOUNT.           00734800
282700     MOVE PV-KMC-ID              TO  LM-DM-ACCOUNT-NBR.           00734900
282910     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   00735000
283000     MOVE LM-LOG-DISPLAY-MESSAGE                                  00735100
283100         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          00735200
283200                 (EP000-MESSAGE-LINE-COUNTER).                    00735300
283300     PERFORM EP000-1000-POST-MESSAGE.                             00735400
283400*8500-EXIT.                                                       00735500
283500*----------------------------------------------------------------*00735600
283600*  FORMAT AND POST INFORMATION RELATIVE TO A DB2 ERROR.  ROLL    *00735700
283700*  BACK ALL RESOURCES.                                           *00735800
283800*----------------------------------------------------------------*00735900
283900                                                                  00736000
284000 9100-DB2-ERROR.                                                  00736100
284100     SET PS-DB2-ERROR                                             00736200
284200         EP000-SL-ERROR TO TRUE.                                  00736300
284300                                                                  00736400
284400     MOVE SQLCODE TO DE-SQLCODE.                                  00736500
284500     MOVE SQLERRD(3) TO DE-ROWS-PROCESSED.                        00736600
284600     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                    00736700
284700     MOVE DE-DB2-ERROR-MESSAGE                                    00736800
284800         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          00736900
284900                 (EP000-MESSAGE-LINE-COUNTER).                    00737000
285000                                                                  00737100
285100     MOVE SQLERRMC TO DS-SQLERRMC.                                00737200
285200     ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                     00737300
285300     MOVE DS-DB2-SQLERRMC-MESSAGE                                 00737400
285400         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          00737500
285500                 (EP000-MESSAGE-LINE-COUNTER).                    00737600
285600                                                                  00737700
285700     ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                     00737800
285800     MOVE AA-ATTEMPTED-ACTION-MESSAGE                             00737900
285900         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          00738000
286000                 (EP000-MESSAGE-LINE-COUNTER).                    00738100
286100                                                                  00738200
286200     PERFORM EP000-1000-POST-MESSAGE.                             00738300
286300                                                                  00738400
286400     EXEC CICS                                                    00738500
286500         SYNCPOINT                                                00738600
286600             ROLLBACK                                             00738700
286700     END-EXEC.                                                    00738800
286800 9100-EXIT.     EXIT.                                             00738900
286900                                                                  00739000
287000*----------------------------------------------------------------*00739100
287100*  FORMAT AND POST INFORMATION RELATIVE TO A DB2 WARNING.  ROLL  *00739200
287200*  BACK ALL RESOURCES.                                           *00739300
287300*----------------------------------------------------------------*00739400
287400                                                                  00739500
287500 9200-DB2-WARNING.                                                00739600
287600     SET PS-DB2-ERROR                                             00739700
287700         EP000-SL-ERROR TO TRUE.                                  00739800
287800                                                                  00739900
287900     MOVE SQLCODE TO DW-SQLCODE.                                  00740000
288000     MOVE SQLERRD(3) TO DW-ROWS-PROCESSED.                        00740100
288100     MOVE SQLWARN TO DW-SQLWARN.                                  00740200
288200     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                    00740300
288300     MOVE DW-DB2-WARNING-MESSAGE                                  00740400
288400         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          00740500
288500                 (EP000-MESSAGE-LINE-COUNTER)                     00740600
288600                                                                  00740700
288700     MOVE SQLERRMC TO DS-SQLERRMC.                                00740800
288800     ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                     00740900
288900     MOVE DS-DB2-SQLERRMC-MESSAGE                                 00741000
289000         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          00741100
289100                 (EP000-MESSAGE-LINE-COUNTER)                     00741200
289200                                                                  00741300
289300     ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                     00741400
289400     MOVE AA-ATTEMPTED-ACTION-MESSAGE                             00741500
289500         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          00741600
289600                 (EP000-MESSAGE-LINE-COUNTER)                     00741700
289700                                                                  00741800
289800     PERFORM EP000-1000-POST-MESSAGE.                             00741900
289900                                                                  00742000
290000     EXEC CICS                                                    00742100
290100         SYNCPOINT                                                00742200
290200             ROLLBACK                                             00742300
290300     END-EXEC.                                                    00742400
290400 9200-EXIT.   EXIT.                                               00742500
290500                                                                  00742600
290600***************************************************************** 00742700
290700* SEND NETCOOL MAJOR MESSAGE HERE                                 00742800
290800* THERE ARE NO VIRTUAL GIFTCARDS TO ISSUE, RUN SVK170             00742900
290900* TO CREATE MORE CARDS                                            00743000
291000***************************************************************** 00743100
291100                                                                  00743200
291200 9300-NETCOOL-MESSAGE.                                            00743300
291300     SET IS003-MAJOR-ALERT TO TRUE.                               00743400
291400     SET IS003-PROBLEM-ALERT TO TRUE.                             00743500
291500*** CONSTRUCT NETCOOL MESSAGE                                     00743600
291600     STRING                                                       00743700
291700       'AUKCS502:NO VIRTUAL'       DELIMITED BY SIZE              00743800
291800       ' GIFTCARDS TO ISSUE'       DELIMITED BY SIZE              00743900
291900         INTO IS003-SUMMARY.                                      00744000
292000                                                                  00744100
292100     SET IS003-CICS                                               00744200
292200         IS003-VERSION-1 TO TRUE.                                 00744300
292300     MOVE 'AU'                 TO IS003-SYSTEM-ID.                00744400
292400                                                                  00744500
292500     IF PV-CICS-REGION = 'CICSPS'                                 00744600
292600       MOVE 'AUTO LAB'         TO IS003-AUTOMATION-LABEL          00744700
292700     ELSE                                                         00744800
292800       MOVE 'CICS TST'         TO IS003-AUTOMATION-LABEL          00744900
292900     END-IF.                                                      00745000
293000                                                                  00745100
293100     CALL IS003-ALERT-PROGRAM                                     00745200
293200         USING DFHEIBLK                                           00745300
293300               IS003-CICS-COMMAREA                                00745400
293400               IS003-NETCOOL-ALERT.                               00745500
293500                                                                  00745600
293600     IF NOT IS003-OK                                              00745700
293700        STRING '!ERROR WRITING NETCOOL ALERT. '                   00745800
293800               'NETCOOL RETURN CODE='                             00745900
293900          IS003-RETURN-CODE DELIMITED BY SIZE                     00746000
294000          INTO IS003-SUMMARY                                      00746100
294100        END-STRING                                                00746200
294200        STRING '!IS003-MESSAGE='                                  00746300
294300          IS003-MESSAGE DELIMITED BY SIZE                         00746400
294400          INTO IS003-SUMMARY                                      00746500
294500        END-STRING                                                00746600
294600** FOR TESTING PURPOSES ONLY                                      00746700
294700     ELSE                                                         00746800
294800        STRING '!NETCOOL RETURN CODE IS GOOD. '                   00746900
294900               'NETCOOL RETURN CODE='                             00747000
295000          IS003-RETURN-CODE DELIMITED BY SIZE                     00747100
295100          INTO IS003-SUMMARY                                      00747200
295200        END-STRING                                                00747300
295300        STRING '!IS003-MESSAGE='                                  00747400
295400          IS003-MESSAGE DELIMITED BY SIZE                         00747500
295500          INTO IS003-SUMMARY                                      00747600
295600        END-STRING                                                00747700
295700     END-IF.                                                      00747800
295800                                                                  00747900
295900*** WRITE ALL NETCOOL MESSAGES TO THE CICS LOG                    00748000
296000*** IF NOT IN PRODUCTION, ONLY WRITE NETCOOL MESSAGES             00748100
296100*** TO THE CICS LOG, NOT TO NETCOOL                               00748200
296200     MOVE IS003-SUMMARY       TO PE-IS003-SUMMARY.                00748300
296300     MOVE PE-NETCOOL-ALERT-TO-BE-WRITTEN TO IS003-SUMMARY.        00748400
296400*                                                                 00748500
296500* PERFORM A COMMIT TO GET NETCOOL ALERT WRITTEN.                  00748600
296600*                                                                 00748700
296700     EXEC CICS                                                    00748800
296800         SYNCPOINT                                                00748900
296900     END-EXEC.                                                    00749000
297000                                                                  00749100
297100*----------------------------------------------------------------*00749200
297200*  TERMINATE THE TRANSACTION.                                    *00749300
297300*----------------------------------------------------------------*00749400
297400                                                                  00749500
297500 9999-RETURN-TO-NATIVE-CICS.                                      00749600
297600     EXEC CICS                                                    00749700
297700         RETURN                                                   00749800
297800     END-EXEC.                                                    00749900
297900 9999-EXIT.    EXIT.                                              00750000
298000                                                                  00750100
298100*----------------------------------------------------------------*00751000
298200     COPY SVPD005.                                                00760000
298300                                                                  01034000
298400*----------------------------------------------------------------*01034100
298500*    CONVERSION OF CARD NUMBER                                   *01034200
298600*----------------------------------------------------------------*01034300
298710     COPY SVPD007.                                                01034400
298800                                                                  01053900
298900*----------------------------------------------------------------*01054000
299000*  POST ALERT/ERROR ROUTINE.                                      01054100
299100*                                                                 01054200
299200     COPY EPPD000.                                                01054300
299300                                                                  01071100
299400*----------------------------------------------------------------*01071200
299500*      CREATE THE CHECK DIGIT FOR THE VIRTUAL GIFT CARD          *01071300
299600*----------------------------------------------------------------*01071400
299700*                                                                 01071500
2018  *    COPY DPPD036.                                                01072000
299900*                                                                 01080000
