000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400                                                                  00040000
000500 PROGRAM-ID.             TFKUP478.                                00050000
000600 AUTHOR.                 DAVID SAUCEDA.                           00060000
000700 INSTALLATION.           KOHL'S DEPARTMENT STORES.                00070000
000800 DATE-WRITTEN            FEBRUARY, 1997.                          00080000
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100******************************************************************00110000
001200*  PURPOSE: THIS PROGRAM RETRIEVES ALL INCOMPLETE TRANSFERS. FOR  00120000
001300*  EACH RECORD, ITS ITEM, CUSTOMER, AND MASTER RECORD ARE DELETED.00130000
001400*  THIS PROGRAM RUNS DAILY.                                       00140000
001500******************************************************************00150000
001600*  ADDED UNION TO THE CURSOR TO INCLUDE DELETE OF TRANSFERS WHICH 00160000
001700*  HAVE ITEMS BUT NO MASTERS. ALSO CHANGED THE SELECT OF NULL SEQ 00170000
001710*  NUMBERS TO INCLUDE ONLY THOSE THAT ARE MORE THAN 1 DAY OLD.    00180000
001800******************************************************************00190000
001801*  CHANGED PROGRAM BACK TO DELETING ALL TRANSFERS WITH NULL      *00200000
001802*  SEQUENCE NUMBERS; DO NOT WAIT 1 DAY. JACK KRAMER 7/10/97      *00210000
001810******************************************************************00220000
001500******************************************************************00230000
001600*  REMOVED UNION FROM CURSOR TO SHORTEN PROCESSING TIME FOR       00240000
001700*  TRISTATE GRAND OPENING. PLACE LOGIC FOR DELETION OF TRANSFERS  00250000
001710*  WITH ITEMS BUT NO MASTERS IN ANOTHER PROGRAM R.GRAF  04/06/00  00260000
002000******************************************************************00270000
P11247******************************************************************00271038
P11247* 12/01/2010    COGNIZANT      P11247                            *00272038
P11247* - REMOVE AN EXCLUSIVE LOCK FROM THE TABLE TTFMSTR              *00273038
P11247*   TO AVOID CONTENTION WITH OTHER PROCESS USING  SAME TABLE     *00274038
P11247******************************************************************00275038
002100 ENVIRONMENT DIVISION.                                            00280000
002200******************************************************************00290000
002300                                                                  00300000
002400 CONFIGURATION SECTION.                                           00310000
002500                                                                  00320000
002600 SOURCE-COMPUTER.        IBM-3090.                                00330000
002700 OBJECT-COMPUTER.        IBM-3090.                                00340000
002800                                                                  00350000
002900 INPUT-OUTPUT SECTION.                                            00360000
003000                                                                  00370000
003100 FILE-CONTROL.                                                    00380000
003200                                                                  00390000
003300******************************************************************00400000
003400 DATA DIVISION.                                                   00410000
003500******************************************************************00420000
003600                                                                  00430000
003700 FILE SECTION.                                                    00440000
003800                                                                  00450000
003900******************************************************************00460000
004000 WORKING-STORAGE SECTION.                                         00470000
004100******************************************************************00480000
004900*                                                                 00490000
005000*  DCLGEN LAYOUT AND COBOL DECLARATION FOR THE TRANSFER MASTER    00500000
005100*  TABLE                                                          00510000
005200*                                                                 00520000
005300     EXEC SQL                                                     00530000
005400         INCLUDE TTFMSTR                                          00540000
005500     END-EXEC.                                                    00550000
005600                                                                  00560000
006500*                                                                 00570000
006600*  COMMUNICATIONS AREA FOR DB2                                    00580000
006700*                                                                 00590000
006800     EXEC SQL                                                     00600000
006900         INCLUDE SQLCA                                            00610000
007000     END-EXEC.                                                    00620000
007100                                                                  00630000
007200*                                                                 00640000
007300*  DB2 FORMATTED ERROR MESSAGE                                    00650000
007400*                                                                 00660000
007500     COPY DPWS004.                                                00670000
007600                                                                  00680000
007700 01  ABEND-CODE                          PIC S9(04)  VALUE +0     00690000
007800                                                     COMP SYNC.   00700000
007900                                                                  00710000
008000 01  PC-PROGRAM-CONSTANTS.                                        00720000
008100     05  PC-MAX-DELETES-B4-A-COMMIT      PIC  9(04)  VALUE 1000.  00730000
008200     05  PC-PROGRAM-NAME                 PIC  X(08)  VALUE        00740000
008300                                                     'TFKUP478'.  00750000
008400     05  PC-ZERO                         PIC S9(09)  VALUE ZEROS  00760000
008500                                                     COMP SYNC.   00770000
008600 01  PS-PROGRAM-SWITCHES.                                         00780000
008700     05  PS-END-OF-DELETES-IND           PIC  X(01)  VALUE 'N'.   00790000
008800         88  PS-MORE-DELETES                         VALUE 'N'.   00800000
008900         88  PS-END-OF-DELETES                       VALUE 'Y'.   00810000
009000                                                                  00820000
009100 01  PV-PROGRAM-VARIABLES.                                        00830000
009200     05  PV-PARAGRAPH-NAME               PIC  X(30)  VALUE SPACE. 00840000
009300     05  PV-DB2-OPERATION-ATTEMPTED      PIC  X(30)  VALUE SPACE. 00850000
009400     05  PV-COMMIT-CNT                   PIC  9(04)  VALUE ZEROS. 00860000
009500     05  PV-DISPLAY-XFER-DKEY-ID         PIC  9(09)  VALUE ZEROS. 00870000
009800     05  PV-DEL-MSTR-CNT                 PIC  9(06)  VALUE ZEROS. 00880000
009900                                                                  00890000
010000*                                                                 00900000
010100* CURSOR TO RETRIEVE ALL TRANSFERS THAT WILL BE DELETED, BECAUSE  00910000
010200* THEY ARE INCOMPLETE.                                            00920000
010300*                                                                 00930000
010400     EXEC SQL                                                     00940000
010500        DECLARE  DELETE_CSR CURSOR WITH HOLD FOR                  00950000
010600         SELECT  XFER_DKEY_ID                                     00960000
010700           FROM  TTFMSTR                                          00970000
010800          WHERE  (XFER_SEQ_NBR  IS  NULL)                         00980000
                                                                        00990000
011700       ORDER BY  XFER_DKEY_ID                                     01000000
011800     END-EXEC.                                                    01010000
011900                                                                  01020000
012000***************************************************************** 01030000
012100 PROCEDURE DIVISION.                                              01040000
012200***************************************************************** 01050000
012300                                                                  01060000
012400***************************************************************** 01070000
012500*  0000-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE PROGRAM    01080000
012600***************************************************************** 01090000
012700 0000-PROGRAM-MAINLINE.                                           01100000
012800     PERFORM 1000-INITIALIZE.                                     01110000
012900     PERFORM 2000-PROCESS-DELETES                                 01120000
013000         UNTIL PS-END-OF-DELETES.                                 01130000
013100     PERFORM 9000-EOJ-ROUTINE.                                    01140000
013200     STOP RUN.                                                    01150000
013300*                                                                 01160000
013400***************************************************************** 01170000
013500* 1000-INITIALIZE - OPEN DELETE-CSR. LOCK TABLE TTFMSTR           01180000
013600*      FETCH DELETE-CSR.                                          01190000
013700***************************************************************** 01200000
013800 1000-INITIALIZE.                                                 01210000
014210     PERFORM 2010-OPEN-DELETE-CSR.                                01230000
014300     PERFORM 7300-FETCH-DELETE-CSR.                               01240000
014400*                                                                 01250000
014500***************************************************************** 01260000
014600* 2000-PROCESS-DELETES - RETRIEVE RECORDS FOR PROCESSING          01270000
014700***************************************************************** 01280000
014800 2000-PROCESS-DELETES.                                            01290000
014900                                                                  01300000
015000     IF PS-MORE-DELETES                                           01310000
015100         PERFORM 7400-DELETE-XFER-MSTR                            01320034
015500         IF PV-COMMIT-CNT  >  PC-MAX-DELETES-B4-A-COMMIT          01340000
015600            PERFORM 7700-COMMIT                                   01350000
016000            INITIALIZE PV-COMMIT-CNT                              01370000
016200         END-IF                                                   01380000
016300                                                                  01390000
016400         PERFORM 7300-FETCH-DELETE-CSR                            01400000
016500     ELSE                                                         01410000
016600         PERFORM 2020-CLOSE-DELETE-CSR                            01420000
016700     END-IF.                                                      01430000
016800*                                                                 01440000
016900 2010-OPEN-DELETE-CSR.                                            01450000
017000     EXEC SQL                                                     01460000
017100         OPEN DELETE_CSR                                          01470000
017200     END-EXEC.                                                    01480000
017300                                                                  01490000
017400     EVALUATE TRUE                                                01500000
017500         WHEN SQLWARN0 NOT = SPACES                               01510000
017600         WHEN SQLCODE < ZERO                                      01520000
017700         WHEN SQLCODE > ZERO                                      01530000
017800             MOVE '2010-OPEN-DELETE-CSR'                          01540000
017900                 TO PV-PARAGRAPH-NAME                             01550000
018000             MOVE 'OPEN THE DELETE_CSR'                           01560000
018100                 TO PV-DB2-OPERATION-ATTEMPTED                    01570000
018200             PERFORM 9100-SQL-ABEND                               01580000
018300         WHEN SQLCODE = ZERO                                      01590000
018400             CONTINUE                                             01600000
018500     END-EVALUATE.                                                01610000
018600*                                                                 01620000
018700 2020-CLOSE-DELETE-CSR.                                           01630000
018800     EXEC SQL                                                     01640000
018900         CLOSE DELETE_CSR                                         01650000
019000     END-EXEC.                                                    01660000
019100                                                                  01670000
019200     EVALUATE TRUE                                                01680000
019300         WHEN SQLWARN0 NOT = SPACES                               01690000
019400         WHEN SQLCODE < ZERO                                      01700000
019500         WHEN SQLCODE > ZERO                                      01710000
019600             MOVE '2020-CLOSE-DELETE-CSR'                         01720000
019700                 TO PV-PARAGRAPH-NAME                             01730000
019800             MOVE 'CLOSE THE DELETE_CSR'                          01740000
019900                 TO PV-DB2-OPERATION-ATTEMPTED                    01750000
020000             PERFORM 9100-SQL-ABEND                               01760000
020100         WHEN SQLCODE = ZERO                                      01770000
020200             CONTINUE                                             01780000
020300     END-EVALUATE.                                                01790000
022300*                                                                 01800000
026200 7300-FETCH-DELETE-CSR.                                           02000000
026300     INITIALIZE DCLTTFMSTR.                                       02010000
026400                                                                  02020000
026500     EXEC SQL                                                     02030000
026600         FETCH  DELETE_CSR                                        02040000
026700          INTO  :TFMSTR-XFER-DKEY-ID                              02050000
026800     END-EXEC.                                                    02060000
026900                                                                  02070000
027000     EVALUATE TRUE                                                02080000
027100         WHEN SQLCODE = +100                                      02090000
027200             SET PS-END-OF-DELETES  TO  TRUE                      02100000
027300         WHEN SQLWARN0 NOT = SPACES                               02110000
027400         WHEN SQLCODE < ZERO                                      02120000
027500         WHEN SQLCODE > ZERO                                      02130000
027600             MOVE '7300-FETCH-DELETE-CSR'                         02140000
027700                 TO PV-PARAGRAPH-NAME                             02150000
027800             MOVE 'FETCH THE DELETE_CSR'                          02160000
027900                 TO PV-DB2-OPERATION-ATTEMPTED                    02170000
028000             PERFORM 9100-SQL-ABEND                               02180000
028100         WHEN SQLCODE = ZERO                                      02190000
028200             CONTINUE                                             02200000
028300     END-EVALUATE.                                                02210000
028400                                                                  02220034
028500 7400-DELETE-XFER-MSTR.                                           02230034
028600     EXEC SQL                                                     02240034
028700          DELETE  FROM TTFMSTR                                    02250034
028800           WHERE  (XFER_DKEY_ID  =  :TFMSTR-XFER-DKEY-ID)         02260034
028900     END-EXEC.                                                    02270034
029000                                                                  02280034
029100     EVALUATE TRUE                                                02290034
029110         WHEN SQLCODE = +100                                      02300034
029120             CONTINUE                                             02310034
029200         WHEN SQLWARN0 NOT = SPACES                               02320034
029300         WHEN SQLCODE < ZERO                                      02330034
029400         WHEN SQLCODE > ZERO                                      02340034
029500             MOVE '7400-DELETE-XFER-MSTR'                         02350034
029600                 TO PV-PARAGRAPH-NAME                             02360034
029700             MOVE 'DELETE ROW FROM TTFMSTR'                       02370034
029800                 TO PV-DB2-OPERATION-ATTEMPTED                    02380034
029900             MOVE TFMSTR-XFER-DKEY-ID  TO  PV-DISPLAY-XFER-DKEY-ID02400035
030000             DISPLAY 'DELETING TFMSTR-XFER-DKEY-ID:  '            02410035
030100                 PV-DISPLAY-XFER-DKEY-ID                          02411039
030200             PERFORM 9100-SQL-ABEND                               02420034
030300         WHEN SQLCODE = ZERO                                      02430034
030400             ADD 1  TO  PV-COMMIT-CNT                             02440034
030500                        PV-DEL-MSTR-CNT                           02450034
030600     END-EVALUATE.                                                02460034
035500*                                                                 02470034
035600 7700-COMMIT.                                                     02480000
035700     EXEC SQL                                                     02490000
035800         COMMIT                                                   02500000
035900     END-EXEC.                                                    02510000
036000*                                                                 02520000
036100 9000-EOJ-ROUTINE.                                                02530035
036200     DISPLAY '*** TTFMSTR ROWS DELETED = '  PV-DEL-MSTR-CNT.      02540035
036500*                                                                 02550000
036600******************************************************************02560000
036700*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    02570000
036800*  ERROR OR WARNING CODE OCCURS.                                  02580000
036900******************************************************************02590000
037000 9100-SQL-ABEND.                                                  02600000
037100     DISPLAY '** ABEND     **'.                                   02610000
037200     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                02620000
037300     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              02630000
037400     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     02640000
037500     DISPLAY '** TTFMSTR ROWS DELETED = '  PV-DEL-MSTR-CNT.       02650035
037800                                                                  02660000
037900******************************************************************02670000
038000* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    02680000
038100* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         02690000
038200* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     02700000
038300* FORMAT.                                                         02710000
038400******************************************************************02720000
038500     COPY DPPD004.                                                02730000
038600                                                                  02740000
038700     MOVE +4013  TO  ABEND-CODE.                                  02750000
038800     CALL 'ILBOABN0' USING ABEND-CODE.                            02760000
