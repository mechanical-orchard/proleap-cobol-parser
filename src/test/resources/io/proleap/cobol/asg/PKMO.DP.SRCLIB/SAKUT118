000100 IDENTIFICATION DIVISION.                                         00010000
000200                                                                  00020000
000300 PROGRAM-ID.      SAKUT118.                                       00030000
000400 AUTHOR.          BARB SCHULTZ.                                   00040000
000500 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00050000
000600 DATE-WRITTEN.    02/20/14.                                       00060000
000700 DATE-COMPILED.                                                   00070000
000800                                                                  00080000
000900******************************************************************00090000
001000*            ***  BRICK & MORTAR TSASUM LOADER ***                00100000
001100*=================================================================00110000
001200*                                                                 00120000
001300*  CASH OFFICE SALES ARE NOT BEING LOADED IN THE TSASUM TABLE BY  00130000
BOSS  *  REGISTER FOR SFS, BPS AND BOS. THIS PROGRAM WILL COPY SALES    00131000
BOSS  *  DATA, 'D' SALES, FOR SFS, BPS AND BOS BY REGISTER AND COPY     00132000
001400*  IT ON TO AN EXTRACT FILE.  THIS FILE WILL BE USED TO UPDATE THE00133000
001400*  TSASUM CASH OFFICE SALES.                                      00134000
001700*                                                                 00135000
001800*  THIS PROGRAM WILL RUN ON A DAILY BASIS                         00136000
002000*                                                                 00137000
002100*  INPUT: INP01 - CONTAINS POS DATE, WHICH IS USED AS THE         00138000
002200*                  PROCESS DATE.                                  00139000
002300*                                                                 00140000
002400*========================== CHANGE LOG ===========================00150000
002500*  AUTH      BY       DATE                 DESCRIPTION            00160000
002600*=================================================================00170000
8446E * 8446E      TKMA555  02-20-14   CREATE PROGRAM                   00180000
8446E *                                                                 00190000
260966* CHG0260966 TKMAC09  09-08-21   ADD ECOM EFC STORES TO           00200000
260966*                                TSASUM-CURSOR EXCLUDING REG 0 TO 00210000
260966*                                CORRECT THE PROBLEM OF ECOM      00220000
260966*                                SHOWING ZEROES IN THE CASH OFFICE00230000
260966*                                COLUMN OF THE ONLINE SCREENS.    00240000
260966******************************************************************00250001
284656* CHG0284656 TKMA555  03-23-23   INCLUDING LATES/CORRECTIONS ('S')00251004
284656*                                NUMBERS WITH THE 'D' NUMBERS WHEN00252001
284656*                                SETTING THE 'C' NUMBERS. ALSO    00253008
284656*                                ADDED SUMS IN THE CURSOR TO ADD  00254008
284656*                                THE CTG_AMT AND CTG_NBR_OF_ITEM  00254108
284656*                                OF 'D' AND 'S' TRANSACTIONS      00255008
284656*                                TOGETHER.                        00255108
284656******************************************************************00256001
003000                                                                  00260000
003100 ENVIRONMENT DIVISION.                                            00270000
003200 CONFIGURATION SECTION.                                           00280000
003300                                                                  00281000
003400 SOURCE-COMPUTER.        IBM-3090.                                00282000
003500 OBJECT-COMPUTER.        IBM-3090.                                00283000
003600                                                                  00284000
003700 INPUT-OUTPUT SECTION.                                            00285000
003800 FILE-CONTROL.                                                    00286000
003900                                                                  00287000
004000     SELECT POS-DATE-CARD-FILE ASSIGN TO INP01.                   00288000
004100     SELECT TSASUM-FILE        ASSIGN TO OUT01.                   00289000
004200                                                                  00290000
004300 DATA DIVISION.                                                   00300000
004400 FILE SECTION.                                                    00310000
004500                                                                  00320000
004600 FD  POS-DATE-CARD-FILE                                           00330000
004700     RECORDING MODE IS F                                          00340000
004800     BLOCK CONTAINS 0 RECORDS                                     00350000
004900     LABEL RECORDS ARE STANDARD.                                  00360000
005000                                                                  00370000
005100 01  POS-DATE-CARD-RECORD             PIC  X(80).                 00380000
005200                                                                  00390000
005300 FD  TSASUM-FILE                                                  00400000
005400     RECORDING MODE IS F                                          00410000
005500     BLOCK CONTAINS 0 RECORDS                                     00420000
005600     LABEL RECORDS ARE STANDARD.                                  00430000
005700                                                                  00440000
005800 01  TSASUM-REC                       PIC  X(25).                 00450000
005900                                                                  00460000
006100******************************************************************00470000
006200*                       WORKING STORAGE                           00480000
006300******************************************************************00490000
006400 WORKING-STORAGE SECTION.                                         00500000
006500                                                                  00510000
006600 01  W-START                          PIC  X(50)    VALUE         00520000
006700     ' *** WORKING STORAGE STARTS HERE FOR SAKUT118 *** '.        00530000
006800                                                                  00540000
006900******************************************************************00550000
007000*                          SWITCHES                               00560000
007100******************************************************************00570000
007200 01  PS-PROGRAM-SWITCHES.                                         00580000
007300                                                                  00590000
007600     05  PS-END-OF-TSASUM-CURSOR-SW   PIC  X(01)    VALUE 'N'.    00600000
007700         88  PS-END-OF-TSASUM-CURSOR                VALUE 'Y'.    00610000
007800     05  PS-END-OF-CARD-FILE-SW       PIC  X(01)    VALUE 'N'.    00620000
007900         88  PS-END-OF-CARD-FILE                    VALUE 'Y'.    00630000
008000                                                                  00640000
008100******************************************************************00650000
008200*                         CONSTANTS                               00660000
008300******************************************************************00670000
008400 01  PC-CONSTANTS.                                                00680000
008500                                                                  00690000
008600     05  PC-JOB-NAME                  PIC  X(08)    VALUE         00700000
008700                                                    'SAK051  '.   00710000
008800     05  PC-PGM-NAME                  PIC  X(08)    VALUE         00720000
008900                                                    'SAKUT118'.   00730000
009000                                                                  00740000
009100     05  PC-ROW-NOT-FOUND             PIC S9(04)    VALUE +100    00750000
009200                                                    COMP SYNC.    00760000
012100                                                                  00770000
012200******************************************************************00780000
012300*                      ACCUMULATORS                               00790000
012400******************************************************************00800000
012500 01  PA-ACCULATORS.                                               00810000
012600                                                                  00820000
012800     05  PA-TSASUM-CURSOR-CNT         PIC  9(07)    VALUE ZEROS.  00830000
012900                                                                  00840000
013000     05  PA-TSASUM-WRITTEN            PIC  9(07)    VALUE ZEROS.  00850000
013100                                                                  00860000
013100 01  DK-DB2-KEYS.                                                 00870000
013100     05  DK-PROC-DATE-ISO        PIC X(10)    VALUE SPACES.       00880000
013100                                                                  00890000
013200******************************************************************00900000
013300*                       VARIABLES                                 00910000
013400******************************************************************00920000
013500 01  PV-VARIABLES.                                                00930000
013600     05  PV-SQL                       PIC S9(04)    VALUE ZEROS.  00940000
013700     05  PV-PARAGRAPH-NAME            PIC  X(30)    VALUE SPACES. 00950000
013800     05  PV-DB2-TABLE-NAME            PIC  X(12)    VALUE SPACES. 00960000
013900     05  PV-DB2-OPERATION-MSG         PIC  X(60)    VALUE SPACES. 00970000
014000     05  PV-OPERATION-MSG-1           PIC  X(40)    VALUE SPACES. 00980000
014100     05  PV-OPERATION-MSG-2           PIC  X(40)    VALUE SPACES. 00990000
014200                                                                  01000000
014300     05  PV-ABEND-PARTN-NBR           PIC  9(04)    VALUE ZEROS.  01010000
014300     05  PV-ABEND-RGST-ID             PIC  9(04)    VALUE ZEROS.  01020000
114400     05  PV-ABEND-STR-NBR             PIC  9(04)    VALUE ZEROS.  01030000
014500     05  PV-ABEND-SUM-CTG-CDE         PIC  X(03)    VALUE SPACES. 01040000
014600                                                                  01050000
014700 01  PV-DB2-VARIABLES.                                            01060000
014800                                                                  01070000
015100     05  PV-DB2-SUM                   PIC S9(09)V99 COMP-3        01080000
015200                                                    VALUE ZERO.   01090000
015100     05  PV-DB2-SUM-ITM               PIC S9(09)V99 COMP-3        01100000
015200                                                    VALUE ZERO.   01110000
015300                                                                  01120000
015400******************************************************************01130000
015500*                       WORK AREA                                 01140000
015600******************************************************************01150000
015700 01  PV-MISC-FIELDS.                                              01160000
015800                                                                  01170000
015900     05  PV-SLSDTE                    PIC X(10)     VALUE SPACES. 01180000
015900     05  PV-DPG52-LK-DATE-INPUT       PIC X(10)     VALUE SPACES. 01190000
015900     05  PV-PARTN-NBR                 PIC S9(04)    COMP          01200000
016000                                                    VALUE ZERO.   01210000
015900     05  PV-STR-NBR                   PIC S9(04)    COMP          01220000
016000                                                    VALUE ZERO.   01230000
015900     05  PV-RGST-ID                   PIC S9(04)    COMP          01240000
016000                                                    VALUE ZERO.   01250000
067600     05  PV-SUM-CTG-CDE      PIC X(03)              VALUE SPACES. 01260000
067500     05  PV-CTG-AMT          PIC S9(07)V99 COMP-3   VALUE ZEROS.  01270000
067500     05  PV-CTG-NBR-OF-ITM   PIC S9(09) COMP        VALUE ZEROS.  01280000
016100                                                                  01290000
020900******************************************************************01300000
021000*                       DATE/TIME                                 01310000
021100******************************************************************01320000
021200 01  PV-DATE-AND-TIME-FIELDS.                                     01330000
021300                                                                  01340000
021400     05  PV-POS-CCYY-MM-DD            PIC  X(10)    VALUE SPACE.  01350000
021500     05  FILLER REDEFINES PV-POS-CCYY-MM-DD.                      01360000
021600         10  PV-POS-CCYY              PIC  X(04).                 01370000
021700         10  FILLER                   PIC  X(01).                 01380000
021800         10  PV-POS-MM                PIC  X(02).                 01390000
021900         10  FILLER                   PIC  X(01).                 01400000
022000         10  PV-POS-DD                PIC  X(02).                 01410000
022100                                                                  01420000
022200     05  PV-CURR-DATE-CCYYMMDD.                                   01430000
022300         10  PV-CURR-DATE-CCYY        PIC  9(04).                 01440000
022400         10  PV-CURR-DATE-MM          PIC  9(02).                 01450000
022500         10  PV-CURR-DATE-DD          PIC  9(02).                 01460000
022600                                                                  01470000
022700     05  PV-CURR-TIME.                                            01480000
022800         10  PV-CURR-TIME-HH          PIC  9(02)    VALUE ZERO.   01490000
022900         10  PV-CURR-TIME-MM          PIC  9(02)    VALUE ZERO.   01500000
023000         10  PV-CURR-TIME-SSHH        PIC  9(04)    VALUE ZERO.   01510000
023100                                                                  01520000
023200     05  PV-POS-DATE-FORMATTED        PIC  X(10)    VALUE SPACE.  01530000
023300     05  PV-SLS-DTE-MM-DD-CCYY.                                   01540000
023400         10  PV-SLS-DTE-MM            PIC  X(02)    VALUE SPACE.  01550000
023500         10  FILLER                   PIC  X(01)    VALUE '/'.    01560000
023600         10  PV-SLS-DTE-DD            PIC  X(02)    VALUE SPACE.  01570000
023700         10  FILLER                   PIC  X(01)    VALUE '/'.    01580000
023800         10  PV-SLS-DTE-CCYY          PIC  X(04)    VALUE SPACE.  01590000
023900                                                                  01600000
024000******************************************************************01610000
024100*               SYSTEM TIME AND DATE VARIABLES                    01620000
024200******************************************************************01630000
024300 01  SYS-DATE-TIME.                                               01640000
024400     05  SYS-DATE                     PIC  X(08)    VALUE SPACES. 01650000
024500     05  SYS-TIME                     PIC  X(08)    VALUE SPACES. 01660000
024600                                                                  01670000
024700 01  ST-BEG-TIME.                                                 01680000
024800     05  ST-BEG-HR                    PIC  9(02)    VALUE ZEROS.  01690000
024900     05  FILLER                       PIC  X(01)    VALUE ':'.    01700000
025000     05  ST-BEG-MN                    PIC  9(02)    VALUE ZEROS.  01710000
025100                                                                  01720000
025200 01  ST-END-TIME.                                                 01730000
025300     05  ST-END-HR                    PIC  9(02)    VALUE ZEROS.  01740000
025400     05  FILLER                       PIC  X(01)    VALUE ':'.    01750000
025500     05  ST-END-MN                    PIC  9(02)    VALUE ZEROS.  01760000
025600                                                                  01770000
025700 01  SD-EDIT-DATE.                                                01780000
025800     05  SD-MONTH                     PIC  9(02)    VALUE ZEROS.  01790000
025900     05  FILLER                       PIC  X(01)    VALUE '-'.    01800000
026000     05  SD-DAY                       PIC  9(02)    VALUE ZEROS.  01810000
026100     05  FILLER                       PIC  X(01)    VALUE '-'.    01820000
026200     05  SD-CENT                      PIC  9(02)    VALUE ZEROS.  01830000
026300     05  SD-YEAR                      PIC  9(02)    VALUE ZEROS.  01840000
026400                                                                  01850000
026500******************************************************************01860000
026600*                        ERROR HANDLING                           01870000
026700******************************************************************01880000
026800 01  ABEND-CODE                       PIC S9(04)    VALUE ZEROS   01890000
026900                                                    COMP SYNC.    01900000
027000     88  ABEND-4001-WRITE-ERROR                     VALUE +4001.  01910000
027100     88  ABEND-4002-READ-ERROR                      VALUE +4002.  01920000
027200     88  ABEND-4003-CTRL-CARD-ERROR                 VALUE +4003.  01930000
027300     88  ABEND-4004-TABLE-ERROR                     VALUE +4004.  01940000
027400     88  ABEND-4005-OPEN-ERROR                      VALUE +4005.  01950000
027500     88  ABEND-4006-CLOSE-ERROR                     VALUE +4006.  01960000
027600     88  ABEND-4007-SEQUENCE-ERROR                  VALUE +4007.  01970000
027700     88  ABEND-4008-DATA-ERROR                      VALUE +4008.  01980000
027800     88  ABEND-4009-KEY-DATA-ERROR                  VALUE +4009.  01990000
027900     88  ABEND-4013-DB2-ERROR                       VALUE +4013.  02000000
028000     88  ABEND-4019-CAL-SUB-ERROR                   VALUE +4019.  02010000
028100     88  ABEND-4444-FORCED-ABEND                    VALUE +4444.  02020000
028200                                                                  02030000
028400******************************************************************02040000
028500* RECORD LAYOUT FOR INPUT DATE CARD (POS DATE)                    02050000
028600******************************************************************02060000
028700 01  CC-CONTROL-CARD.                                             02070000
028800                                                                  02080000
029500    05  CC-CONTROL-CARD-DISPLAY.                                  02090000
029500        10  CC-PROC-DTE         PIC X(10)    VALUE SPACES.        02100000
029500        10  FILLER              PIC X(70)    VALUE SPACE.         02110000
029600                                                                  02120000
029700******************************************************************02130000
029800*  TSASUM RECORD LAYOUT                                           02140000
029900******************************************************************02150000
030000     COPY SARD008.                                                02160000
030100                                                                  02170000
030200******************************************************************02180000
030300*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             02190000
030400******************************************************************02200000
030500     COPY DPWS500.                                                02210000
030600                                                                  02220000
030700******************************************************************02230000
030800*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            02240000
030900******************************************************************02250000
031000     COPY DPWS004.                                                02260000
031100                                                                  02270000
031200******************************************************************02280000
031300*  DB2 MESSAGE AREA                                               02290000
031400******************************************************************02300000
031500     COPY SQLCA2.                                                 02310000
031600                                                                  02320000
031700******************************************************************02330000
031800*  DB2 COMMUNICATION AREA.                                        02340000
031900******************************************************************02350000
032000     EXEC SQL                                                     02360000
032100          INCLUDE SQLCA                                           02370000
032200     END-EXEC.                                                    02380000
032300                                                                  02390000
032400******************************************************************02400000
032500*  DB2 TABLE XST_LOC - STORE LOCATION TABLE                       02410000
032600******************************************************************02420000
032700     EXEC SQL                                                     02430000
032800          INCLUDE XST00001                                        02440000
032900     END-EXEC.                                                    02450000
033000                                                                  02460000
033100******************************************************************02470000
033200*  DB2 TABLE TSASUM - TOTALS BY STORE REGISTER TABLE              02480000
033300******************************************************************02490000
033400     EXEC SQL                                                     02500000
033500          INCLUDE TSASUM                                          02510000
033600     END-EXEC.                                                    02520000
033700                                                                  02530000
033800******************************************************************02540000
033900*  DB2 TABLE TEPPART - PARTITION TABLE                            02550000
034000******************************************************************02560000
034100     EXEC SQL                                                     02570000
034200          INCLUDE TEPPART                                         02580000
034300     END-EXEC.                                                    02590000
034400                                                                  02600000
036100******************************************************************02610000
036200*  TSASUM-CURSOR -- CURSOR TO SUM CTG_AMT GROUPED BY THE VARIOUS  02620000
036300*  CATEGORY CODES.                                                02630000
036400******************************************************************02640000
036500     EXEC SQL                                                     02650000
036600       DECLARE TSASUM-CURSOR CURSOR FOR                           02660000
036700            SELECT  A.PARTN_NBR                                   02670000
007900                   ,A.STR_NBR                                     02680000
007900                   ,A.RGST_ID                                     02690000
036800                   ,A.SUM_CTG_CDE                                 02700000
284656                   ,SUM(A.CTG_AMT)                                02710002
284656                   ,SUM(A.CTG_NBR_OF_ITM)                         02720002
036900              FROM  TSASUM  A                                     02730000
036900                 ,  TEPPART B                                     02740000
035100                 ,  XST_LOC C                                     02750000
037000             WHERE  A.PARTN_NBR   = B.PARTN_NBR                   02760000
037000               AND  B.SLS_DTE     = :DK-PROC-DATE-ISO             02770000
037100               AND  A.STR_NBR     = C.LOC_NBR                     02780000
035300               AND  C.LOC_TYP_CDE = 'DS'                          02790000
284656               AND  SUM_TYP_CDE  IN ('D','S')                     02801001
260966               AND ((C.E_BUS_IND   = 'Y'                          02810000
260966               AND  RGST_ID     <> 0)                             02820000
035200                OR (C.E_BUS_IND   = 'N'                           02830000
102913               AND  RGST_ID     IN (90, 91, 92, 93, 94, 95)))     02840000
284656          GROUP BY  A.PARTN_NBR, A.STR_NBR, A.RGST_ID,            02850007
284656                    A.SUM_CTG_CDE                                 02850107
284656          ORDER BY  A.PARTN_NBR, A.STR_NBR, A.RGST_ID,            02851007
284656                    A.SUM_CTG_CDE                                 02851107
037500           WITH UR                                                02860000
037600     END-EXEC.                                                    02870000
037900                                                                  02880000
038000 PROCEDURE DIVISION.                                              02890000
038100******************************************************************02900000
038200* MAINLINE                                                        02910000
038300******************************************************************02920000
038400 0000-MAINLINE-PARAGRAPH.                                         02930000
038500                                                                  02940000
038600     PERFORM 1000-INITIALIZE-PROGRAM.                             02950000
038700                                                                  02960000
038800     PERFORM 2000-PROCESS-SUM-CTG-CDE                             02970000
007700       UNTIL PS-END-OF-TSASUM-CURSOR.                             02980000
039000                                                                  02990000
039100     PERFORM 9900-END-PROC.                                       03000000
039200                                                                  03010000
039300     STOP RUN.                                                    03020000
039400                                                                  03030000
039600******************************************************************03040000
039700* OPEN FILES, PROCESS CONTROL CARD, FORMAT REPORT HEADINGS,       03050000
039800* FIND PARTITION NUMBER, OPEN MASTER-CURSOR                       03060000
039900******************************************************************03070000
040000 1000-INITIALIZE-PROGRAM.                                         03080000
040100                                                                  03090000
040200     OPEN INPUT  POS-DATE-CARD-FILE.                              03100000
040300     OPEN OUTPUT TSASUM-FILE.                                     03110000
040400                                                                  03120000
040500     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 03130000
040600                                                                  03140000
040700     MOVE SYS-TIME (1:2) TO ST-BEG-HR.                            03150000
040800     MOVE SYS-TIME (3:2) TO ST-BEG-MN.                            03160000
040900                                                                  03170000
041000     MOVE SYS-DATE (1:2) TO SD-CENT.                              03180000
041100     MOVE SYS-DATE (3:2) TO SD-YEAR.                              03190000
041200     MOVE SYS-DATE (5:2) TO SD-MONTH.                             03200000
041300     MOVE SYS-DATE (7:2) TO SD-DAY.                               03210000
041400                                                                  03220000
041500     PERFORM 1100-PROCESS-CONTROL-CARD.                           03230000
041600                                                                  03240000
042200******************************************************************03250000
042300* READ CONTROL CARD TO GET POS DATE IN MMDDYY FORMAT.  CALL       03260000
042400* DATE ROUTINE TO CONVERT DATE TO A CCYY-MM-DD PROCESS DATE.      03270000
042500******************************************************************03280000
042600 1100-PROCESS-CONTROL-CARD.                                       03290000
042700                                                                  03300000
042800     PERFORM 1110-READ-POS-DATE-CARD-FILE.                        03310000
042700                                                                  03320000
043200     IF PS-END-OF-CARD-FILE                                       03330000
043300         MOVE '1100-PROCESS-CONTROL-CARD'  TO PV-PARAGRAPH-NAME   03340000
043400         MOVE 'NO CONTROL CARD TO PROCESS' TO PV-OPERATION-MSG-1  03350000
043500                                                                  03360000
043600         SET ABEND-4003-CTRL-CARD-ERROR TO TRUE                   03370000
043700         PERFORM 9200-ABEND                                       03380000
043800     END-IF.                                                      03390000
042900                                                                  03400000
043000     CLOSE POS-DATE-CARD-FILE.                                    03410000
044500                                                                  03420000
044700******************************************************************03430000
044800* READ DATE CONTROL CARD.                                         03440000
044900******************************************************************03450000
045000 1110-READ-POS-DATE-CARD-FILE.                                    03460000
045100                                                                  03470000
045200     READ POS-DATE-CARD-FILE INTO CC-CONTROL-CARD                 03480000
045300        AT END                                                    03490000
045400            SET PS-END-OF-CARD-FILE TO TRUE                       03500000
045500        NOT AT END                                                03510000
045500            MOVE CC-PROC-DTE        TO PV-DPG52-LK-DATE-INPUT     03520000
045500            PERFORM 1125-VALIDATE-INPUT-DATE                      03530000
045500            MOVE CC-PROC-DTE        TO DK-PROC-DATE-ISO           03540000
045500                                                                  03550000
045500            DISPLAY                                               03560000
045500            '** CONTROL CARD = ' CC-CONTROL-CARD-DISPLAY.         03570000
045500                                                                  03580000
045700******************************************************************03590000
045800* CALL KOHLS CALENDAR ROUTINE:                                    03600000
045900*     PASS: CONTROL CARD POS DATE (CCYY-MM-DD FORMAT).            03610000
046000*   RETURN: ACTUAL CALENDAR DB2 ISO DATE (CCYY-MM-DD FORMAT).     03620000
046100******************************************************************03630000
042900 1125-VALIDATE-INPUT-DATE.                                        03640000
046300                                                                  03650000
046400     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              03660000
046500                                                                  03670000
046600     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   03680000
046700     SET  DPG51-DO-NOT-INCR-DECR-DATE  TO TRUE.                   03690000
046800     SET  DPG52-LK-DTE-ISO-FMT         TO TRUE.                   03700000
046900                                                                  03710000
047000     MOVE PV-DPG52-LK-DATE-INPUT       TO DPG52-LK-DATE-INPUT.    03720000
047100                                                                  03730000
047200     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    03740000
047300                                             DPG54 DPG55 DPG56.   03750000
047400     EVALUATE TRUE                                                03760000
047500         WHEN DPG54-SEVERE-ERROR                                  03770000
047600         WHEN DPG54-DATE-INVALID                                  03780000
047700             MOVE '1125-VALIDATE-INPUT-DATE'                      03790000
047800                                       TO PV-PARAGRAPH-NAME       03800000
047900             MOVE 'ERROR CONVERTING INPUT CARD DATE'              03810000
048000                                       TO PV-OPERATION-MSG-1      03820000
048100             SET ABEND-4019-CAL-SUB-ERROR                         03830000
048200                                       TO TRUE                    03840000
048300             MOVE DPG54-ERROR-MESSAGE                             03850000
048400                                       TO PV-OPERATION-MSG-2      03860000
048500             PERFORM 9200-ABEND                                   03870000
048600     END-EVALUATE.                                                03880000
048700                                                                  03890000
049100                                                                  03900000
055500******************************************************************03910000
055600* 2000-PROCESS-SUM-CTG-CDE                                        03920000
055800*     - OPEN, FETCH & CLOSE TSASUM-CURSOR                         03930000
055800*     - WRITE THE STORES CATEGORIES                               03940000
056000******************************************************************03950000
056100 2000-PROCESS-SUM-CTG-CDE.                                        03960000
056200                                                                  03970000
056900     PERFORM 3000-OPEN-TSASUM-CURSOR.                             03980000
057000     PERFORM 3100-FETCH-TSASUM-CURSOR                             03990000
057100        UNTIL PS-END-OF-TSASUM-CURSOR.                            04000000
057200     PERFORM 3200-CLOSE-TSASUM-CURSOR.                            04010000
057300                                                                  04020000
060100                                                                  04030000
063900******************************************************************04040000
064000*  OPEN THE TSASUM-CURSOR                                         04050000
064100******************************************************************04060000
064200 3000-OPEN-TSASUM-CURSOR.                                         04070000
064300                                                                  04080000
064400     EXEC SQL                                                     04090000
064500          OPEN TSASUM-CURSOR                                      04100000
064600     END-EXEC.                                                    04110000
064700                                                                  04120000
064800     EVALUATE TRUE                                                04130000
064900         WHEN SQLCODE = ZERO                                      04140000
065000             CONTINUE                                             04150000
065100                                                                  04160000
065200         WHEN SQLWARN0 NOT EQUAL SPACE                            04170000
065300         WHEN SQLCODE NOT EQUAL ZERO                              04180000
065400             MOVE SQLCODE TO PV-SQL                               04190000
065500                                                                  04200000
065600             MOVE '3000-OPEN-TSASUM-CURSOR' TO PV-PARAGRAPH-NAME  04210000
065700             MOVE 'TSASUM'               TO PV-DB2-TABLE-NAME     04220000
065800                                                                  04230000
065900             STRING 'ERROR ON OPEN OF TSASUM-CURSOR - SQLCODE = ' 04240000
066000                PV-SQL DELIMITED BY SIZE INTO PV-DB2-OPERATION-MSG04250000
066100             END-STRING                                           04260000
066200                                                                  04270000
066300             SET ABEND-4005-OPEN-ERROR TO TRUE                    04280000
066400             PERFORM 9100-SQL-ABEND                               04290000
066500     END-EVALUATE.                                                04300000
066600                                                                  04310000
066700                                                                  04320000
066800******************************************************************04330000
066900*  FETCH THE SUM CURSOR.                                          04340000
067000******************************************************************04350000
067100 3100-FETCH-TSASUM-CURSOR.                                        04360000
067200                                                                  04370000
067300     EXEC SQL                                                     04380000
067400          FETCH TSASUM-CURSOR                                     04390000
067500           INTO :PV-PARTN-NBR                                     04400000
067500               ,:PV-STR-NBR                                       04410000
067500               ,:PV-RGST-ID                                       04420000
067600               ,:PV-SUM-CTG-CDE                                   04430000
067500               ,:PV-CTG-AMT                                       04440000
067500               ,:PV-CTG-NBR-OF-ITM                                04450000
067700     END-EXEC.                                                    04460000
067800                                                                  04470000
067900     EVALUATE TRUE                                                04480000
068000         WHEN SQLCODE = ZERO                                      04490000
068100             ADD 1 TO PA-TSASUM-CURSOR-CNT                        04500000
068200                                                                  04510000
068300         WHEN SQLCODE = PC-ROW-NOT-FOUND                          04520000
068400             SET PS-END-OF-TSASUM-CURSOR TO TRUE                  04530000
068500                                                                  04540000
068600         WHEN SQLWARN0 NOT EQUAL SPACE                            04550000
068700         WHEN SQLCODE NOT EQUAL ZERO                              04560000
068800             MOVE SQLCODE TO PV-SQL                               04570000
068900                                                                  04580000
069100             MOVE PV-STR-NBR        TO PV-ABEND-STR-NBR           04590000
069100             MOVE PV-RGST-ID        TO PV-ABEND-RGST-ID           04600000
069200             MOVE SASUM-SUM-CTG-CDE TO PV-ABEND-SUM-CTG-CDE       04610000
069300                                                                  04620000
069400             MOVE '3100-FETCH-TSASUM-CURSOR' TO PV-PARAGRAPH-NAME 04630000
069500             MOVE 'TSASUM'                TO PV-DB2-TABLE-NAME    04640000
069600                                                                  04650000
069700             STRING 'ERROR ON FETCH OF TSASUM-CURSOR - SQLCODE = '04660000
069800                PV-SQL DELIMITED BY SIZE INTO PV-DB2-OPERATION-MSG04670000
069900             END-STRING                                           04680000
070000                                                                  04690000
070100             SET ABEND-4002-READ-ERROR TO TRUE                    04700000
070200             PERFORM 9100-SQL-ABEND                               04710000
070300     END-EVALUATE.                                                04720000
070400                                                                  04730000
070600     IF SQLCODE = ZERO                                            04740000
083300         MOVE PV-PARTN-NBR             TO SA008-PARTN-NBR         04750000
083400         MOVE PV-STR-NBR               TO SA008-STR-NBR           04760000
083400         MOVE PV-RGST-ID               TO SA008-RGST-ID           04770000
083500         MOVE 'C'                      TO SA008-SUM-TYP-CDE       04780000
070700         MOVE PV-SUM-CTG-CDE           TO SA008-SUM-CTG-CDE       04790000
091700         MOVE PV-CTG-AMT               TO SA008-CTG-AMT           04800000
091700         MOVE PV-CTG-NBR-OF-ITM        TO SA008-CTG-NBR-OF-ITM    04810000
091700         MOVE 'S'                      TO SA008-CTG-SRC-CDE       04820000
091700         MOVE 'INSRT'                  TO SA008-TYPE              04830000
092000         PERFORM 4100-WRITE-TSASUM                                04840000
071000     END-IF.                                                      04850000
071100                                                                  04860000
079700******************************************************************04870000
079800*  CLOSE THE SUM CURSOR.                                          04880000
079900******************************************************************04890000
080000 3200-CLOSE-TSASUM-CURSOR.                                        04900000
080100                                                                  04910000
080200     EXEC SQL                                                     04920000
080300          CLOSE TSASUM-CURSOR                                     04930000
080400     END-EXEC.                                                    04940000
080500                                                                  04950000
080600     EVALUATE TRUE                                                04960000
080700         WHEN SQLCODE = ZERO                                      04970000
080800              CONTINUE                                            04980000
080900                                                                  04990000
081000         WHEN SQLWARN0 NOT EQUAL SPACE                            05000000
081100         WHEN SQLCODE NOT EQUAL ZERO                              05010000
081200             MOVE SQLCODE TO PV-SQL                               05020000
081300                                                                  05030000
081400             MOVE '3200-CLOSE-TSASUM-CURSOR' TO PV-PARAGRAPH-NAME 05040000
081500             MOVE 'TSASUM'                TO PV-DB2-TABLE-NAME    05050000
081600                                                                  05060000
081700             STRING 'ERROR ON CLOSE OF TSASUM-CURSOR - SQLCODE = '05070000
081800                PV-SQL DELIMITED BY SIZE INTO PV-DB2-OPERATION-MSG05080000
081900             END-STRING                                           05090000
082000                                                                  05100000
082100             SET ABEND-4006-CLOSE-ERROR TO TRUE                   05110000
082200             PERFORM 9100-SQL-ABEND                               05120000
082300     END-EVALUATE.                                                05130000
082400                                                                  05140000
097500******************************************************************05150000
097600* WRITE THE TSASUM RECORDS                                        05160000
097700******************************************************************05170000
097800 4100-WRITE-TSASUM.                                               05180000
097900                                                                  05190000
098000     WRITE TSASUM-REC FROM SA008-TSASUM-REC.                      05200000
098100                                                                  05210000
098200     ADD 1 TO PA-TSASUM-WRITTEN.                                  05220000
098300                                                                  05230000
098500******************************************************************05240000
098600* ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.    05250000
098700******************************************************************05260000
098800 9100-SQL-ABEND.                                                  05270000
098900                                                                  05280000
099000     MOVE SQLCODE    TO SQLCODE2.                                 05290000
099100     MOVE SQLERRD(3) TO SQLERRD3.                                 05300000
099200                                                                  05310000
099300     DISPLAY '** ABEND           ** = SQLABEND'.                  05320000
099400     DISPLAY '** PROGRAM         ** = ' PC-PGM-NAME.              05330000
099500     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        05340000
099600     DISPLAY '** TABLES AFFECTED ** = ' PV-DB2-TABLE-NAME.        05350000
099700     DISPLAY '** OPERATION       ** = ' PV-DB2-OPERATION-MSG.     05360000
099800     DISPLAY '** PARTN NBR       ** = ' PV-ABEND-PARTN-NBR.       05370000
099900     DISPLAY '** STORE NBR       ** = ' PV-ABEND-STR-NBR.         05380000
100000     DISPLAY '** CTG CODE        ** = ' PV-ABEND-SUM-CTG-CDE.     05390000
100100     DISPLAY '** SQLCODE         ** = ' SQLCODE2.                 05400000
100200     DISPLAY '** ROWS PROCESSED  ** = ' SQLERRD3.                 05410000
100300     DISPLAY '** SQLERRM         ** = ' SQLERRM.                  05420000
100400     DISPLAY '** SQLERRMC        ** = ' SQLERRMC.                 05430000
100500                                                                  05440000
100600******************************************************************05450000
100700*  THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   05460000
100800*  MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        05470000
100900* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     05480000
101000*  FORMAT.                                                        05490000
101100******************************************************************05500000
101200                                                                  05510000
101300     COPY DPPD004.                                                05520000
101400                                                                  05530000
101500     CALL 'ILBOABN0' USING ABEND-CODE.                            05540000
101600                                                                  05550000
101800******************************************************************05560000
101900*  ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                     05570000
102000******************************************************************05580000
102100 9200-ABEND.                                                      05590000
102200                                                                  05600000
102300     PERFORM 9900-END-PROC.                                       05610000
102400                                                                  05620000
102500     DISPLAY '** ABEND           **'.                             05630000
102600     DISPLAY '** PROGRAM         ** = ' PC-PGM-NAME.              05640000
102700     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        05650000
102800     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       05660000
102900     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       05670000
103000                                                                  05680000
103100     CALL 'ILBOABN0' USING ABEND-CODE.                            05690000
103200                                                                  05700000
103300                                                                  05710000
103400******************************************************************05720000
103500* PREFORMS TASK TERMINATION PROCESSING                            05730000
103600******************************************************************05740000
103700 9900-END-PROC.                                                   05750000
103800                                                                  05760000
103900     CLOSE TSASUM-FILE.                                           05770000
104000                                                                  05780000
104300     PERFORM 9999-CONTROLS.                                       05790000
104400                                                                  05800000
107500******************************************************************05810000
107600* DISPLAY CONTROLS FROM THE PROGRAM                               05820000
107700******************************************************************05830000
107800 9999-CONTROLS.                                                   05840000
107900                                                                  05850000
108000     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 05860000
108100                                                                  05870000
108200     MOVE SYS-TIME (1:2) TO ST-END-HR.                            05880000
108300     MOVE SYS-TIME (3:2) TO ST-END-MN.                            05890000
108400                                                                  05900000
108500     DISPLAY '                    '.                              05910000
108600     DISPLAY '**********************'.                            05920000
108700     DISPLAY '   SAKUT118 CONTROLS  '.                            05930000
108800     DISPLAY '**********************'.                            05940000
108900     DISPLAY 'RUN DATE  = ' SD-EDIT-DATE.                         05950000
109000     DISPLAY 'BEG TIME  = ' ST-BEG-TIME.                          05960000
109100     DISPLAY 'END TIME  = ' ST-END-TIME.                          05970000
109200     DISPLAY '======================'.                            05980000
109500     DISPLAY 'SUM CURSOR ROWS FETCHED    = '                      05990000
109600                                PA-TSASUM-CURSOR-CNT.             06000000
109700     DISPLAY '                    '.                              06010000
109800     DISPLAY 'TSASUM WRITTEN = ' PA-TSASUM-WRITTEN.               06020000
109900     DISPLAY '                    '.                              06030000
110000                                                                  06040000
