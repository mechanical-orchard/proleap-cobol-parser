      ******************************************************************        
       IDENTIFICATION DIVISION.                                                 
      ******************************************************************        
                                                                                
       PROGRAM-ID.       MRKUT158.                                              
       AUTHOR.           KUSHAL BOTHRA.                                         
       INSTALLATION.     KOHLS.                                                 
       DATE-WRITTEN      MAY 30 2012.                                           
       DATE-COMPILED.                                                           
                                                                                
      ******************************************************************        
      *        PROGRAM REQUEST FOR INNER OUTER DATA UPDATION           *        
      ******************************************************************        
      *                                                                *        
      *  THIS PROGRAM WILL RETURN DB2 INNER OUTER PACK INFORMATION     *        
      *  BASED ON THE INPUT SKU VALUES.                                *        
      *                                                                *        
      *                                                                *        
      *   OUTPUT FIELDS:  SKU                                          *        
      *                   DIST TYPE OF  B&M                            *        
      *                   ADDITIONAL HIERARCHICAL DATA                **        
      *                                                                *        
      *   I/O:   TMRITEM            DB2 TABLE   SELECT                 *        
      *          TSK                                                            
      *          TSKXREF                                               *        
      *          TUPCSKU                                               *        
      *          TUPC                                                  *        
      *                                                                *        
      ******************************************************************        
P5207G* CHANGE LOG                                                     *        
P5207G* MADE BY : PRITHIVI (COGNIZANT) DATE:01/21/2014                 *        
P5207G* CHANGED THE FIND SKU CURSOR - ADDED GROUP BY CLAUSE TO THE     *        
P5207G* CURSOR. CHANGED THE OUTPUT FILE LENGTH TO 4576 TO ACCOMADATE   *        
P5207G* GROUPED SKUS, AS OF NOW WE CAN HAVE A MAXIMUM OF 500 SKU'S     *        
P5207G* GROUPED PER RECORD.  COPYBOOK MRRD168 HAD BEEN CHANGED TO MATCH*        
P5207G* OUTPUT LENGTH.   CHANGE TAG : P5207G                           *        
      ******************************************************************        
      ******************************************************************        
       ENVIRONMENT DIVISION.                                                    
      ******************************************************************        
       CONFIGURATION SECTION.                                                   
                                                                                
       SOURCE-COMPUTER.        IBM-3090.                                        
       OBJECT-COMPUTER.        IBM-3090.                                        
                                                                                
       INPUT-OUTPUT SECTION.                                                    
                                                                                
       FILE-CONTROL.                                                            
                                                                                
           SELECT FLAT-FILE-INP                                                 
               ASSIGN                       TO INP01                            
               FILE STATUS                  IS WS-INFILE-SW.                    
                                                                                
           SELECT FLAT-FILE-OUT1                                                
               ASSIGN                       TO OUT01                            
               FILE STATUS                  IS WS-OUTFILE-SW1.                  
                                                                                
           SELECT FLAT-FILE-OUT2                                                
               ASSIGN                       TO OUT02                            
               FILE STATUS                  IS WS-OUTFILE-SW2.                  
                                                                                
           SELECT FLAT-FILE-OUT3                                                
               ASSIGN                       TO OUT03                            
               FILE STATUS                  IS WS-OUTFILE-SW3.                  
                                                                                
           SELECT FLAT-FILE-OUT4                                                
               ASSIGN                       TO OUT04                            
               FILE STATUS                  IS WS-OUTFILE-SW4.                  
                                                                                
           SELECT FLAT-FILE-OUT5                                                
               ASSIGN                       TO OUT05                            
               FILE STATUS                  IS WS-OUTFILE-SW5.                  
           EJECT                                                                
                                                                                
      ******************************************************************        
       DATA DIVISION.                                                           
      ******************************************************************        
                                                                                
       FILE SECTION.                                                            
                                                                                
       FD  FLAT-FILE-INP                                                        
           RECORDING MODE F                                                     
           BLOCK CONTAINS 0 RECORDS                                             
           RECORD CONTAINS 80 CHARACTERS                                        
           DATA RECORD IS  DATE-FILE.                                           
       01  DATE-FILE                       PIC X(80).                           
                                                                                
       FD  FLAT-FILE-OUT1                                                       
           RECORDING MODE F                                                     
           BLOCK CONTAINS 0 RECORDS                                             
P5207G*    RECORD CONTAINS 84 CHARACTERS                                        
P5207G     RECORD CONTAINS 27076 CHARACTERS                                     
           DATA RECORD IS  INOUT-FILE1.                                         
       01  INOUT-FILE1.                                                         
           COPY MRRD168.                                                        
                                                                                
       FD  FLAT-FILE-OUT2                                                       
           RECORDING MODE F                                                     
           BLOCK CONTAINS 0 RECORDS                                             
P5207G*    RECORD CONTAINS 84 CHARACTERS                                        
P5207G     RECORD CONTAINS 27076 CHARACTERS                                     
           DATA RECORD IS  INOUT-FILE2.                                         
       01  INOUT-FILE2.                                                         
           COPY MRRD168.                                                        
                                                                                
       FD  FLAT-FILE-OUT3                                                       
           RECORDING MODE F                                                     
           BLOCK CONTAINS 0 RECORDS                                             
P5207G*    RECORD CONTAINS 84 CHARACTERS                                        
P5207G     RECORD CONTAINS 27076 CHARACTERS                                     
           DATA RECORD IS  INOUT-FILE3.                                         
       01  INOUT-FILE3.                                                         
           COPY MRRD168.                                                        
                                                                                
       FD  FLAT-FILE-OUT4                                                       
           RECORDING MODE F                                                     
           BLOCK CONTAINS 0 RECORDS                                             
P5207G*    RECORD CONTAINS 84 CHARACTERS                                        
P5207G     RECORD CONTAINS 27076 CHARACTERS                                     
           DATA RECORD IS  INOUT-FILE4.                                         
       01  INOUT-FILE4.                                                         
           COPY MRRD168.                                                        
                                                                                
       FD  FLAT-FILE-OUT5                                                       
           RECORDING MODE F                                                     
           BLOCK CONTAINS 0 RECORDS                                             
P5207G*    RECORD CONTAINS 84 CHARACTERS                                        
P5207G     RECORD CONTAINS 27076 CHARACTERS                                     
           DATA RECORD IS  INOUT-FILE5.                                         
       01  INOUT-FILE5.                                                         
           COPY MRRD168.                                                        
                                                                                
       WORKING-STORAGE SECTION.                                                 
                                                                                
                                                                                
       01  DATE-FILE-REC                   PIC X(80).                           
                                                                                
       01  WS-CONSTANTS.                                                        
           05  PGM-LOCATION                PIC  X(04)    VALUE SPACE.           
           05  PC-ROW-NOT-FOUND            PIC S9(04)    VALUE +100.            
           05  OUTPUT-COUNT                PIC 9(09)     VALUE ZEROS.           
           05  COUNTER                     PIC 9(04)     VALUE ZEROS.           
           05  WS-DIV                      PIC 9(10).                           
           05  WS-BEG-DATE                 PIC 9(8).                            
           05  WS-DATE-CONV-CHAR REDEFINES WS-BEG-DATE.                         
               10  WS-DATE                 PIC X(8).                            
           05  WS-QUOTIENT                 PIC 9(10).                           
           05  WS-REM                      PIC 9(01).                           
P5207G     05  WS-CONCAT-SKU               PIC X(27000) VALUE SPACES.           
                                                                                
       01  PV-MISC-FIELDS.                                                      
           05  PV-ABEND-CODE               PIC S9(04)    VALUE ZERO             
                                                         COMP SYNC.             
           05  PV-ABEND-PARAGRAPH          PIC  X(30)    VALUE SPACES.          
           05  PV-SQL-SUB                  PIC  9(03)    VALUE ZERO.            
           05  PC-MAX-RETRIES              PIC S9(04)   COMP SYNC               
                                                        VALUE +3.               
                                                                                
                                                                                
       01  PROGRAM-SWITCHES.                                                    
           05  END-OF-FETCH-CSR-SW         PIC  X(01)    VALUE 'N'.             
               88  END-OF-FETCH-CSR                      VALUE 'Y'.             
                                                                                
       01  WS-INFILE-SW                    PIC X(02)     VALUE SPACES.          
           88  WS-INFILE-SUCESS                          VALUE '00'.            
           88  WS-INFILE-EOF                             VALUE '10'.            
       01  WS-OUTFILE-SW1                  PIC X(02)     VALUE SPACES.          
           88  WS-OUTFILE-SUCESS1                        VALUE '00'.            
           88  WS-OUTFILE-EOF1                           VALUE '10'.            
       01  WS-OUTFILE-SW2                  PIC X(02)     VALUE SPACES.          
           88  WS-OUTFILE-SUCESS2                        VALUE '00'.            
           88  WS-OUTFILE-EOF2                           VALUE '10'.            
       01  WS-OUTFILE-SW3                  PIC X(02)     VALUE SPACES.          
           88  WS-OUTFILE-SUCESS3                        VALUE '00'.            
           88  WS-OUTFILE-EOF3                           VALUE '10'.            
       01  WS-OUTFILE-SW4                  PIC X(02)     VALUE SPACES.          
           88  WS-OUTFILE-SUCESS4                        VALUE '00'.            
           88  WS-OUTFILE-EOF4                           VALUE '10'.            
       01  WS-OUTFILE-SW5                  PIC X(02)     VALUE SPACES.          
           88  WS-OUTFILE-SUCESS5                        VALUE '00'.            
           88  WS-OUTFILE-EOF5                           VALUE '10'.            
                                                                                
       01  WS-CURRENT-DAY.                                                      
           05 WS-YEAR                      PIC 9(04).                           
           05 WS-MONTH                     PIC 9(02).                           
           05 WS-DAY                       PIC 9(02).                           
       01  WS-DATE-CONV                   PIC X(8).                             
       01  WS-DATE-CONV-R                 PIC X(9).                             
       01  WS-DATE-RECORD                 PIC 9(8).                             
      *---------------------------------------------------------------          
      *  DCLGEN LAYOUT AND COBOL DECLARATION FOR THE  TABLES                    
      *---------------------------------------------------------------          
           EXEC SQL                                                             
               INCLUDE TMRITST                                                  
           END-EXEC.                                                            
      *---------------------------------------------------------------          
           EXEC SQL                                                             
               INCLUDE  XMT00001                                                
           END-EXEC.                                                            
      *---------------------------------------------------------------          
           EXEC SQL                                                             
               INCLUDE TMRITEM                                                  
           END-EXEC.                                                            
      *---------------------------------------------------------------          
           EXEC SQL                                                             
               INCLUDE  TSK                                                     
           END-EXEC.                                                            
      *---------------------------------------------------------------          
           EXEC SQL                                                             
               INCLUDE TSKXREF                                                  
           END-EXEC.                                                            
      *---------------------------------------------------------------          
           EXEC SQL                                                             
               INCLUDE TUPCSKU                                                  
           END-EXEC.                                                            
      *---------------------------------------------------------------          
           EXEC SQL                                                             
               INCLUDE TUPC                                                     
           END-EXEC.                                                            
      *---------------------------------------------------------------          
      *  COMMUNICATIONS AREA FOR DB2                                            
      *---------------------------------------------------------------          
           EXEC SQL                                                             
               INCLUDE SQLCA                                                    
           END-EXEC.                                                            
                                                                                
      *---------------------------------------------------------------          
      * DB2 COMMUNICATION AREA2                                                 
      *---------------------------------------------------------------          
                                                                                
           COPY SQLCA2.                                                         
                                                                                
           EXEC SQL                                                             
               DECLARE FIND-SKU CURSOR FOR                                      
                SELECT C.DEPT,                                                  
                       C.CLASS,                                                 
                       C.SUBCLASS,                                              
                       B.ENT_ID,                                                
P5207G*                C.SKU,                                                   
                       B.LONG_VENDOR_STYLE,                                     
P5207G                 SUBSTR( XMLSERIALIZE( XMLAGG( XMLTEXT(                   
P5207G                 CONCAT( ',', C.SKU ) ) ) AS CLOB( 30000 ) ), 2 )         
                    FROM TMRITEM A,                                             
                         TSK B,                                                 
                         TSKXREF C,                                             
                         TUPCSKU D,                                             
                         TUPC E                                                 
                    WHERE A.ITEM_NBR = B.ITEM_NMBR                              
                    AND   C.ITM_NBR = B.ITEM_NMBR                               
                    AND   D.ITEM_NBR = B.ITEM_NMBR                              
                    AND   D.UPC_NBR = E.UPC_NBR                                 
                    AND   E.UPC_ID = E.INTR_UPC_ID                              
                    AND   E.UPC_TYP_CDE = 'I'                                   
                    AND   E.WHSE_RPLNT_IND = 'N'                                
                    AND   RT_NBR > 0                                            
                    AND EXISTS(                                                 
                        SELECT 'X'                                              
                        FROM TMRITST I,                                         
                             XMT_LOC L                                          
                        WHERE I.ITEM_NBR = A.ITEM_NBR                           
                          AND I.STR_NBR = L.LOC_NBR                             
                          AND I.FT_CDE <> 'X'                                   
                          AND LOC_TYP_CDE = 'DS'                                
                          AND E_BUS_IND = 'Y')                                  
P5207G              GROUP BY                                                    
P5207G                   C.DEPT,                                                
P5207G                   C.CLASS,                                               
P5207G                   C.SUBCLASS,                                            
P5207G                   B.ENT_ID,                                              
P5207G                   B.LONG_VENDOR_STYLE                                    
                    FOR FETCH ONLY WITH UR                                      
                END-EXEC.                                                       
                                                                                
                                                                                
      ******************************************************************        
       PROCEDURE DIVISION.                                                      
      ******************************************************************        
       0000-MAINLINE-PROCESSING.                                                
                                                                                
           DISPLAY '******** START OF PROGRAM  ********'.                       
                                                                                
           PERFORM 1000-INITIALIZATION.                                         
                                                                                
           PERFORM 1100-PROCESS-DATE.                                           
                                                                                
           PERFORM 1200-OPEN-SKU-CSR.                                           
                                                                                
           PERFORM 2000-FETCH-QTY-CURSOR                                        
                   UNTIL END-OF-FETCH-CSR.                                      
                                                                                
           PERFORM 3000-CLOSE-SKU-CSR.                                          
                                                                                
           PERFORM 4000-DISPLAY-UPDATES.                                        
                                                                                
           CLOSE  FLAT-FILE-INP.                                                
           CLOSE  FLAT-FILE-OUT1.                                               
           CLOSE  FLAT-FILE-OUT2.                                               
           CLOSE  FLAT-FILE-OUT3.                                               
           CLOSE  FLAT-FILE-OUT4.                                               
           CLOSE  FLAT-FILE-OUT5.                                               
                                                                                
           DISPLAY '******** END OF PROGRAM  ********'.                         
                                                                                
           GOBACK.                                                              
                                                                                
      ******************************************************************        
      ** OPEN THE SYSTEM FILE.                                                  
      ******************************************************************        
                                                                                
       1000-INITIALIZATION.                                                     
           INITIALIZE    WS-INFILE-SW                                           
                         COUNTER                                                
                         WS-OUTFILE-SW1                                         
                         WS-OUTFILE-SW2                                         
                         WS-OUTFILE-SW3                                         
                         WS-OUTFILE-SW4                                         
                         WS-OUTFILE-SW5                                         
                         WS-CONCAT-SKU.                                         
                                                                                
           OPEN INPUT  FLAT-FILE-INP                                            
           OPEN OUTPUT FLAT-FILE-OUT1                                           
                       FLAT-FILE-OUT2                                           
                       FLAT-FILE-OUT3                                           
                       FLAT-FILE-OUT4                                           
                       FLAT-FILE-OUT5.                                          
             IF WS-OUTFILE-SUCESS1 AND WS-OUTFILE-SUCESS2 AND                   
                WS-OUTFILE-SUCESS3 AND WS-OUTFILE-SUCESS4 AND                   
                WS-OUTFILE-SUCESS5 AND WS-INFILE-SUCESS                         
                DISPLAY 'FILE OPEN SUCCESSFULL'                                 
             ELSE                                                               
                DISPLAY '**  ABEND  **'                                         
                DISPLAY 'MRKUT158'                                              
                DISPLAY 'FILE OPEN ERROR'                                       
                MOVE +4008           TO PV-ABEND-CODE                           
                CALL 'ILBOABN0' USING PV-ABEND-CODE                             
           END-IF.                                                              
           INITIALIZE    INOUT-FILE1, INOUT-FILE2, INOUT-FILE3,                 
                         INOUT-FILE4, INOUT-FILE5.                              
             READ  FLAT-FILE-INP INTO   DATE-FILE-REC.                          
                                                                                
      ******************************************************************        
      * THIS PARAGRAPH FETCHES THE ITEM CURSOR FOR UPDATE RECORDS      *        
      ******************************************************************        
      *                                                                         
       2000-FETCH-QTY-CURSOR.                                                   
      *                                                                         
           MOVE '2000'                   TO PGM-LOCATION.                       
           MOVE '2000-FETCH-QTY-CURSOR '                                        
                                         TO PV-ABEND-PARAGRAPH.                 
                                                                                
            PERFORM                                                             
               WITH TEST AFTER                                                  
               VARYING PV-SQL-SUB                                               
               FROM 1 BY 1                                                      
               UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                               
                        OR (SQLCODE = 0 OR 100))                                
              EXEC SQL                                                          
                FETCH FIND-SKU                                                  
                 INTO                                                           
                      :SKXREF-DEPT                                              
                     ,:SKXREF-CLASS                                             
                     ,:SKXREF-SUBCLASS                                          
                     ,:TSK-ENT-ID                                               
P5207G               ,:TSK-LONG-VENDOR-STYLE                                    
P5207G*              ,:SKXREF-SKU                                               
P5207G               ,:WS-CONCAT-SKU                                            
              END-EXEC                                                          
           EVALUATE TRUE                                                        
             WHEN SQLCODE         = ZERO                                        
               PERFORM 2200-POPULATE-OUTPUT                                     
             WHEN SQLCODE         = PC-ROW-NOT-FOUND                            
               MOVE 'Y'  TO END-OF-FETCH-CSR-SW                                 
               CONTINUE                                                         
             WHEN SQLCODE = -904                                                
             WHEN SQLCODE = -911                                                
             WHEN SQLCODE = -913                                                
                CONTINUE                                                        
             WHEN OTHER                                                         
                DISPLAY 'ABENDING IN THE FETCH PARAGRAPH:'                      
                DISPLAY PV-ABEND-PARAGRAPH                                      
                PERFORM 9999-SQL-ERROR                                          
              END-EVALUATE                                                      
            END-PERFORM.                                                        
                                                                                
            IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                               
               MOVE '2200-FETCH-UPC-ITEM-CURSOR'                                
                                      TO  PV-ABEND-PARAGRAPH                    
               DISPLAY  'FETCH CURSOR RETRIES EXCEEDED'                         
                                                                                
               PERFORM 9999-SQL-ERROR                                           
            END-IF.                                                             
                                                                                
                                                                                
      ******************************************************************        
      * POPULATE-OUTPUT                                                *        
      ******************************************************************        
        2200-POPULATE-OUTPUT.                                                   
      *                                                                         
           MOVE '2200'                   TO PGM-LOCATION.                       
           MOVE '2200-POPULATE-OUTPUT'                                          
                                         TO PV-ABEND-PARAGRAPH.                 
      *                                                                         
           IF NOT END-OF-FETCH-CSR                                              
              IF COUNTER = 5                                                    
                 INITIALIZE   COUNTER                                           
              END-IF                                                            
              EVALUATE COUNTER                                                  
                WHEN 0                                                          
                   PERFORM 2300-WRITE-FLAT-FILE1                                
                WHEN 1                                                          
                   PERFORM 2300-WRITE-FLAT-FILE2                                
                WHEN 2                                                          
                   PERFORM 2300-WRITE-FLAT-FILE3                                
                WHEN 3                                                          
                   PERFORM 2300-WRITE-FLAT-FILE4                                
                WHEN 4                                                          
                   PERFORM 2300-WRITE-FLAT-FILE5                                
           END-IF.                                                              
      *                                                                         
      ******************************************************************        
      * THIS PARAGRAPH MAPS THE DATA TO THE SEQUENTIAL OUTPUT FILE              
      ******************************************************************        
      *                                                                         
       2300-WRITE-FLAT-FILE1.                                                   
              MOVE SKXREF-DEPT      TO WS-DEPT     OF INOUT-FILE1               
              MOVE SKXREF-CLASS     TO WS-CLASS    OF INOUT-FILE1               
              MOVE SKXREF-SUBCLASS  TO WS-SUBCLASS OF INOUT-FILE1               
              MOVE TSK-ENT-ID       TO WS-ENT-ID   OF INOUT-FILE1               
P5207G*       MOVE SKXREF-SKU       TO WS-SKU      OF INOUT-FILE1               
P5207G        MOVE WS-CONCAT-SKU    TO WS-SKU      OF INOUT-FILE1               
              MOVE TSK-LONG-VENDOR-STYLE TO  WS-LONG-VENDOR-STYLE               
                                                        OF INOUT-FILE1          
              MOVE 'E'              TO WS-DISTRB-TYP-CDE OF INOUT-FILE1         
              MOVE 'US'             TO WS-COUNTRY-ID OF INOUT-FILE1             
              MOVE 'F'              TO WS-ORD-LCYC-CODE OF INOUT-FILE1          
              MOVE  WS-DATE-CONV-R  TO WS-OTB-EFFECTIVE-DATE                    
                                                  OF INOUT-FILE1                
               WRITE INOUT-FILE1                                                
              ADD  1                TO OUTPUT-COUNT.                            
              ADD  1                TO COUNTER.                                 
      ******************************************************************        
      * THIS PARAGRAPH MAPS THE DATA TO THE SEQUENTIAL OUTPUT FILE              
      ******************************************************************        
      *                                                                         
       2300-WRITE-FLAT-FILE2.                                                   
              MOVE SKXREF-DEPT           TO WS-DEPT     OF INOUT-FILE2          
              MOVE SKXREF-CLASS          TO WS-CLASS    OF INOUT-FILE2          
              MOVE SKXREF-SUBCLASS       TO WS-SUBCLASS OF INOUT-FILE2          
              MOVE TSK-ENT-ID            TO WS-ENT-ID   OF INOUT-FILE2          
P5207G*       MOVE SKXREF-SKU            TO WS-SKU      OF INOUT-FILE2          
P5207G        MOVE WS-CONCAT-SKU         TO WS-SKU      OF INOUT-FILE2          
              MOVE TSK-LONG-VENDOR-STYLE TO  WS-LONG-VENDOR-STYLE               
                                                        OF INOUT-FILE2          
              MOVE 'E'              TO WS-DISTRB-TYP-CDE OF INOUT-FILE2         
              MOVE 'US'             TO WS-COUNTRY-ID OF INOUT-FILE2             
              MOVE 'F'              TO WS-ORD-LCYC-CODE OF INOUT-FILE2          
              MOVE  WS-DATE-CONV-R  TO WS-OTB-EFFECTIVE-DATE                    
                                                  OF INOUT-FILE2                
               WRITE INOUT-FILE2                                                
              ADD  1                     TO OUTPUT-COUNT.                       
              ADD  1                     TO COUNTER.                            
      ******************************************************************        
      * THIS PARAGRAPH MAPS THE DATA TO THE SEQUENTIAL OUTPUT FILE              
      ******************************************************************        
      *                                                                         
       2300-WRITE-FLAT-FILE3.                                                   
              MOVE SKXREF-DEPT           TO WS-DEPT     OF INOUT-FILE3          
              MOVE SKXREF-CLASS          TO WS-CLASS    OF INOUT-FILE3          
              MOVE SKXREF-SUBCLASS       TO WS-SUBCLASS OF INOUT-FILE3          
              MOVE TSK-ENT-ID            TO WS-ENT-ID   OF INOUT-FILE3          
P5207G*       MOVE SKXREF-SKU            TO WS-SKU      OF INOUT-FILE3          
P5207G        MOVE WS-CONCAT-SKU         TO WS-SKU      OF INOUT-FILE3          
              MOVE TSK-LONG-VENDOR-STYLE TO  WS-LONG-VENDOR-STYLE               
                                                        OF INOUT-FILE3          
              MOVE 'E'              TO WS-DISTRB-TYP-CDE OF INOUT-FILE3         
              MOVE 'US'             TO WS-COUNTRY-ID OF INOUT-FILE3             
              MOVE 'F'              TO WS-ORD-LCYC-CODE OF INOUT-FILE3          
              MOVE  WS-DATE-CONV-R  TO WS-OTB-EFFECTIVE-DATE                    
                                                  OF INOUT-FILE3                
               WRITE INOUT-FILE3                                                
              ADD  1                     TO OUTPUT-COUNT.                       
              ADD  1                     TO COUNTER.                            
      ******************************************************************        
      * THIS PARAGRAPH MAPS THE DATA TO THE SEQUENTIAL OUTPUT FILE              
      ******************************************************************        
      *                                                                         
       2300-WRITE-FLAT-FILE4.                                                   
              MOVE SKXREF-DEPT           TO WS-DEPT     OF INOUT-FILE4          
              MOVE SKXREF-CLASS          TO WS-CLASS    OF INOUT-FILE4          
              MOVE SKXREF-SUBCLASS       TO WS-SUBCLASS OF INOUT-FILE4          
              MOVE TSK-ENT-ID            TO WS-ENT-ID   OF INOUT-FILE4          
P5207G*       MOVE SKXREF-SKU            TO WS-SKU      OF INOUT-FILE4          
P5207G        MOVE WS-CONCAT-SKU         TO WS-SKU      OF INOUT-FILE4          
              MOVE TSK-LONG-VENDOR-STYLE TO  WS-LONG-VENDOR-STYLE               
                                                        OF INOUT-FILE4          
              MOVE 'E'              TO WS-DISTRB-TYP-CDE OF INOUT-FILE4         
              MOVE 'US'             TO WS-COUNTRY-ID OF INOUT-FILE4             
              MOVE 'F'              TO WS-ORD-LCYC-CODE OF INOUT-FILE4          
              MOVE  WS-DATE-CONV-R  TO WS-OTB-EFFECTIVE-DATE                    
                                                  OF INOUT-FILE4                
               WRITE INOUT-FILE4                                                
              ADD  1                     TO OUTPUT-COUNT.                       
              ADD  1                     TO COUNTER.                            
      ******************************************************************        
      * THIS PARAGRAPH MAPS THE DATA TO THE SEQUENTIAL OUTPUT FILE              
      ******************************************************************        
      *                                                                         
       2300-WRITE-FLAT-FILE5.                                                   
              MOVE SKXREF-DEPT           TO WS-DEPT     OF INOUT-FILE5          
              MOVE SKXREF-CLASS          TO WS-CLASS    OF INOUT-FILE5          
              MOVE SKXREF-SUBCLASS       TO WS-SUBCLASS OF INOUT-FILE5          
              MOVE TSK-ENT-ID            TO WS-ENT-ID   OF INOUT-FILE5          
P5207G*       MOVE SKXREF-SKU            TO WS-SKU      OF INOUT-FILE5          
P5207G        MOVE WS-CONCAT-SKU         TO WS-SKU      OF INOUT-FILE5          
              MOVE TSK-LONG-VENDOR-STYLE TO  WS-LONG-VENDOR-STYLE               
                                                        OF INOUT-FILE5          
              MOVE 'E'              TO WS-DISTRB-TYP-CDE OF INOUT-FILE5         
              MOVE 'US'             TO WS-COUNTRY-ID OF INOUT-FILE5             
              MOVE 'F'              TO WS-ORD-LCYC-CODE OF INOUT-FILE5          
              MOVE  WS-DATE-CONV-R  TO WS-OTB-EFFECTIVE-DATE                    
                                                  OF INOUT-FILE5                
               WRITE INOUT-FILE5                                                
              ADD  1                     TO OUTPUT-COUNT.                       
              ADD  1                     TO COUNTER.                            
      ******************************************************************        
      * THIS PARAGRAPH MAPS THE DATA TO THE SEQUENTIAL OUTPUT FILE              
      ******************************************************************        
      *                                                                         
       4000-DISPLAY-UPDATES.                                                    
                                                                                
            DISPLAY 'RECORDS WRITTEN TO OUTPUT : '  OUTPUT-COUNT.               
      ******************************************************************        
      * PROCESSING CURRENT DATE                                                 
      ******************************************************************        
       1100-PROCESS-DATE.                                                       
               DISPLAY  'DATE-FILE-REC :' DATE-FILE-REC                         
               MOVE DATE-FILE-REC(1:4)  TO WS-YEAR                              
               MOVE DATE-FILE-REC(6:2)  TO WS-MONTH                             
               MOVE DATE-FILE-REC(9:2)  TO WS-DAY                               
               MOVE WS-CURRENT-DAY      TO WS-DATE-RECORD                       
               DISPLAY  'DATE-FILE-REC :' WS-CURRENT-DAY                        
                                                                                
               COMPUTE WS-DIV = FUNCTION INTEGER-OF-DATE(WS-DATE-RECORD)        
               DIVIDE WS-DIV BY 7 GIVING WS-QUOTIENT REMAINDER WS-REM           
                   EVALUATE WS-REM                                              
      * FOR SUNDAY                                                              
                      WHEN 0                                                    
                         DISPLAY 'PROGRAM NOT MEANT TO RUN ON SUNDAY'           
                         GOBACK                                                 
      * FOR MONDAY                                                              
                      WHEN 1                                                    
                         SUBTRACT 1  FROM WS-DIV                                
      * FOR TUESDAY                                                             
                      WHEN 2                                                    
                         SUBTRACT 2  FROM WS-DIV                                
      * FOR WEDNESDAY                                                           
                      WHEN 3                                                    
                         SUBTRACT 3  FROM WS-DIV                                
      * FOR THRUSDAY                                                            
                      WHEN 4                                                    
                         SUBTRACT 4  FROM WS-DIV                                
      * FOR FRIDAY                                                              
                      WHEN 5                                                    
                         SUBTRACT 5  FROM WS-DIV                                
                         DISPLAY 'PROGRAM NOT MEANT TO RUN ON FRIDAY'           
                         GOBACK                                                 
      * FOR SATURDAY                                                            
                      WHEN 6                                                    
                         SUBTRACT 6  FROM WS-DIV                                
                      WHEN OTHER                                                
                         DISPLAY ' PROGRAM NOT MEANT TO RUN TODAY'              
                         GOBACK                                                 
                 END-EVALUATE                                                   
                                                                                
             COMPUTE WS-BEG-DATE = FUNCTION DATE-OF-INTEGER(WS-DIV)             
             MOVE WS-DATE TO WS-DATE-CONV                                       
                                                                                
           EXEC SQL                                                             
        SELECT TO_CHAR(TO_DATE(:WS-DATE-CONV,'YYYYMMDD'),'DD-MON-YY')           
                     INTO :WS-DATE-CONV-R FROM SYSIBM.SYSDUMMY1                 
           END-EXEC.                                                            
                                                                                
      ******************************************************************        
      * THIS PARAGRAPH OPENS THE SKU CURSOR                                     
      ******************************************************************        
                                                                                
       1200-OPEN-SKU-CSR.                                                       
                                                                                
           MOVE '1200'                   TO PGM-LOCATION.                       
           MOVE '1200-OPEN-SKU-CSR'      TO PV-ABEND-PARAGRAPH.                 
                                                                                
           PERFORM                                                              
             WITH TEST AFTER                                                    
             VARYING PV-SQL-SUB                                                 
             FROM 1 BY 1                                                        
             UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                                 
                       OR SQLCODE = 0)                                          
              EXEC SQL                                                          
                  OPEN FIND-SKU                                                 
              END-EXEC                                                          
                                                                                
              EVALUATE TRUE                                                     
                 WHEN SQLCODE         = ZERO                                    
                 WHEN SQLCODE         = PC-ROW-NOT-FOUND                        
                 WHEN SQLCODE         = -911                                    
                 WHEN SQLCODE         = -913                                    
                 WHEN SQLCODE         = -904                                    
                    CONTINUE                                                    
                 WHEN OTHER                                                     
                    DISPLAY PV-ABEND-PARAGRAPH                                  
                    PERFORM 9999-SQL-ERROR                                      
             END-EVALUATE                                                       
           END-PERFORM.                                                         
                                                                                
           IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                                
               DISPLAY PV-ABEND-PARAGRAPH                                       
               PERFORM 9999-SQL-ERROR                                           
           END-IF.                                                              
      ******************************************************************        
      * THIS PARAGRAPH CLOSES THE UPC CURSOR                           *        
      ******************************************************************        
      *                                                                         
       3000-CLOSE-SKU-CSR.                                                      
      *                                                                         
                                                                                
           MOVE '3000'                   TO PGM-LOCATION.                       
           MOVE '3000-CLOSE-UPC-CSR'                                            
                                         TO PV-ABEND-PARAGRAPH.                 
           PERFORM                                                              
              WITH TEST AFTER                                                   
              VARYING PV-SQL-SUB                                                
              FROM 1 BY 1                                                       
              UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                                
                       OR SQLCODE = 0)                                          
                                                                                
              EXEC SQL                                                          
                  CLOSE FIND-SKU                                                
              END-EXEC                                                          
                                                                                
              EVALUATE TRUE                                                     
                WHEN SQLCODE         = ZERO                                     
                WHEN SQLCODE         = -904                                     
                WHEN SQLCODE         = -911                                     
                WHEN SQLCODE         = -913                                     
                WHEN SQLCODE         = PC-ROW-NOT-FOUND                         
                  CONTINUE                                                      
                WHEN OTHER                                                      
                  DISPLAY PV-ABEND-PARAGRAPH                                    
                  PERFORM 9999-SQL-ERROR                                        
              END-EVALUATE                                                      
           END-PERFORM.                                                         
           IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                                
                  DISPLAY PV-ABEND-PARAGRAPH                                    
                  PERFORM 9999-SQL-ERROR                                        
           END-IF.                                                              
       EJECT                                                                    
                                                                                
      ******************************************************************        
      *   ERROR MESSAGE ROUTINE                                                 
      ******************************************************************        
      *                                                                         
       9999-SQL-ERROR.                                                          
                                                                                
           MOVE SQLCODE    TO SQLCODE2.                                         
           MOVE SQLERRD(3) TO SQLERRD3.                                         
           DISPLAY '** ABEND **       ** = SQLERROR'.                           
           DISPLAY '** PROGRAM        ** = MRKUT158'.                           
           DISPLAY '** SQLCODE        ** = ' SQLCODE2.                          
           DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                          
           DISPLAY '** SQLERRM        ** = ' SQLERRM.                           
           DISPLAY '** SQLERRMC       ** = ' SQLERRMC.                          
           MOVE +4013 TO PV-ABEND-CODE.                                         
           CALL 'ILBOABN0' USING PV-ABEND-CODE.                                 
      ******************************************************************        
                                                                                
