000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.    CEKUP013.                                         00020000
000300 AUTHOR.        DENNIS STEFFEN.                                   00030000
000400 DATE-WRITTEN.  JULY 2000.                                        00040000
000500****************************************************************  00050000
000600* THIS PROGRAM EXTRACTS DATA FROM THE CENTRAL STOCK PULL TABLES   00060000
000700* WHICH WILL THEN BE DOWNLOADED INTO THE RETEK RDM APPLICATION    00070000
000800* IN ORDER TO PURGE ROWS IN 'POSTED' STATUS.                      00080000
000900****************************************************************  00090000
000910*  CHANGE LOG                                                     00091000
000920*  DATE       CHANGED BY    DESC                                  00092000
000930*  ---------- ------------- --------------------------------------00093000
000940*  04/29/2010 BRUCE GRAHAM - KFORCE                               00094000
000950*                           WAREHOUSE TRANSFERS EFC2 PROJECT      00095000
000960*                           (WR38216)                             00096000
000970*                           PROGRAM CHANGES CAN BE FOUND BY       00097000
000980*                           DOING A SEARCH ON X38216 IN COLS      00098000
000990*                           1 THRU 6.                             00099000
000991*                                                                 00099100
000992*  01/09/2020 JEAN KURK                                           00099200
000993*             RENAME FROM WMKUT010 TO CEKUP013                    00099300
000994 ENVIRONMENT DIVISION.                                            00099400
000995 INPUT-OUTPUT SECTION.                                            00099500
000996                                                                  00099600
000997 FILE-CONTROL.                                                    00099700
000998     SELECT SO-DOWNLOAD-FILE  ASSIGN TO OUT01.                    00099800
000999                                                                  00099900
001000 DATA DIVISION.                                                   00100000
001100                                                                  00110000
001200 FILE SECTION.                                                    00120000
001300                                                                  00130000
001400 FD  SO-DOWNLOAD-FILE                                             00140000
001500     RECORDING MODE IS F                                          00150000
001600     LABEL RECORDS ARE STANDARD                                   00160000
001700     RECORD CONTAINS 1156                                         00170000
001800     BLOCK CONTAINS 0 RECORDS                                     00180000
001900     DATA RECORD IS SO-DOWNLOAD-RECORD.                           00190000
002000 01  SO-DOWNLOAD-RECORD          PIC X(1156).                     00200000
002100                                                                  00210000
002200 WORKING-STORAGE SECTION.                                         00220000
002300                                                                  00230000
002400 01  PV-ABEND-CODE                    PIC S9(04)   VALUE +0       00240000
002500                                                   COMP SYNC.     00250000
002600                                                                  00260000
002700 01  PS-PROGRAM-SWITCHES.                                         00270000
002800     05  PS-STOCK-PULL-SW             PIC X(1)   VALUE 'N'.       00280000
002900         88  PS-END-STOCK-PULL                   VALUE 'Y'.       00290000
003000         88  PS-NOT-END-STOCK-PULL               VALUE 'N'.       00300000
003100     05  PS-LINE-DELETE-SW            PIC X(1)   VALUE 'N'.       00310000
003200         88  PS-KEEP-THIS-LINE                   VALUE 'N'.       00320000
003300         88  PS-DELETE-THIS-LINE                 VALUE 'Y'.       00330000
003400     05  PS-RDM-LOCATION-SW           PIC X(1)   VALUE 'N'.       00340000
003500         88  PS-IS-RDM-LOCATION                  VALUE 'Y'.       00350000
003600         88  PS-ISNOT-RDM-LOCATION               VALUE 'N'.       00360000
003700     05  PS-VALID-DC-SW               PIC X(1)   VALUE 'N'.       00370000
003800         88  PS-VALID-DC                         VALUE 'Y'.       00380000
003900         88  PS-NO-VALID-DC                      VALUE 'N'.       00390000
004000                                                                  00400000
004100                                                                  00410000
004200 01  PV-PROGRAM-VARIABLES.                                        00420000
004300     05  PV-RETRY-COUNT               PIC S9(04)  VALUE +0        00430000
004400                                                  COMP SYNC.      00440000
004500     05  PV-PREV-CNSTK-LOC-ID         PIC S9(04) COMP VALUE ZERO. 00450000
004600     05  DK-LOCATION-NUMBER           PIC S9(04) COMP VALUE ZERO. 00460000
004700     05  PV-PARAGRAPH-NAME            PIC X(30)   VALUE SPACES.   00470000
004800     05  PV-ERROR-MESSAGE-1           PIC X(60)   VALUE SPACES.   00480000
004900     05  PV-ERROR-MESSAGE-2           PIC X(60)   VALUE SPACES.   00490000
005000     05  PV-ERROR-MESSAGE-3           PIC X(60)   VALUE SPACES.   00500000
005100     05  PV-SQLCODE                   PIC 9(9)    VALUE ZERO.     00510000
005200     05  PV-TMST                      PIC X(26)   VALUE SPACES.   00520000
005300     05  PV-FETCH-COUNT               PIC 9(7)    VALUE ZERO.     00530000
005400     05  PV-COUNT                     PIC 9(7)    VALUE ZERO.     00540000
005500     05  PV-UPDATE-COUNT              PIC 9(7)    VALUE ZERO.     00550000
005510     05  PV-NOT-DELETE-COUNT          PIC 9(7)    VALUE ZERO.     00551001
005600     05  PV-CNSTK-REQ-PL-NBR          PIC X(9)    VALUE ZEROES.   00560000
005700     05  PV-CEPLIT-PL-LNE-NBR         PIC X(4)    VALUE SPACES.   00570000
005800     05  PV-DISP-NBR                  PIC 999     VALUE ZEROES.   00580000
005900     05  PV-DISP-LOC-ID               PIC  9(4) VALUE 0.          00590000
006000                                                                  00600000
006100 01  PC-PROGRAM-CONSTANTS.                                        00610000
006200     05  PC-PROGRAM-NAME              PIC X(08)  VALUE 'CEKUP013'.00620000
006300     05  PC-MAX-RETRIES               PIC S9(04) VALUE +3         00630000
006400                                                 COMP SYNC.       00640000
006500     05  PC-C                         PIC X(01)  VALUE 'C'.       00650000
006600     05  PC-X                         PIC X(01)  VALUE 'X'.       00660000
006700     05  PC-XF                        PIC X(02)  VALUE 'XF'.      00670000
006800                                                                  00680000
006900 01  PV-ABEND-FIELDS.                                             00690000
006901     05  PV-ABEND-PROGRAM             PIC X(8)   VALUE 'CEKUP013'.00690100
006902     05  PV-ABEND-PARAGRAPH           PIC X(50)  VALUE SPACES.    00690200
006903     05  PV-ABEND-OPERATION           PIC X(50)  VALUE SPACES.    00690300
006904     05  PV-ABEND-STRUCTURE-1         PIC X(8)   VALUE SPACES.    00690400
006905     05  PV-ABEND-STRUCTURE-2         PIC X(8)   VALUE SPACES.    00690500
006906     05  PV-ABEND-STRUCTURE-3         PIC X(8)   VALUE SPACES.    00690600
006907     05  PV-ABEND-STATUS              PIC XX     VALUE SPACES.    00690700
006908     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    00690800
006909     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    00690900
006910     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    00691000
006920     05  PV-DB2-OPERATION-MESSAGE-4   PIC  X(79) VALUE SPACES.    00692000
006930                                                                  00693000
006940     05  PV-REFORMAT-TMST.                                        00694000
006950         10  PV-REFORMAT-TMST-DTE.                                00695000
006960             15  PV-REFORMAT-TMST-DTE-CY  PIC X(04)  VALUE SPACES.00696000
006970             15  PV-REFORMAT-TMST-DTE-MM  PIC X(02)  VALUE SPACES.00697000
006980             15  PV-REFORMAT-TMST-DTE-DD  PIC X(02)  VALUE SPACES.00698000
006990         10  PV-REFORMAT-TMST-TM.                                 00699000
007000             15  PV-REFORMAT-TMST-TM-HH   PIC X(02)  VALUE SPACES.00700000
007100             15  PV-REFORMAT-TMST-TM-MM   PIC X(02)  VALUE SPACES.00710000
007200                                                                  00720000
007300     COPY CERD009.                                                00730000
007400/                                                                 00740000
007500     COPY XLWS071.                                                00750000
007600/                                                                 00760000
007700*  USED FOR DB2 ERROR MESSAGE BUILDING                            00770000
007800     COPY DPWS004.                                                00780000
007900                                                                  00790000
008000*   DB2 SQL COMMUNICATION AREA                                    00800000
008100     EXEC SQL                                                     00810000
008200          INCLUDE SQLCA                                           00820000
008300     END-EXEC.                                                    00830000
008400                                                                  00840000
008500*   CENTRAL STOCK ITEMS                                           00850000
008600     EXEC SQL                                                     00860000
008700          INCLUDE TCEPLIT                                         00870000
008800     END-EXEC.                                                    00880000
008900                                                                  00890000
009000*   CENTRAL STOCK PULL REQUESTS                                   00900000
009100     EXEC SQL                                                     00910000
009200          INCLUDE TCEPLRQ                                         00920000
009300     END-EXEC.                                                    00930000
009400                                                                  00940000
009500*   CENTRAL STOCK STATUS                                          00950000
009600     EXEC SQL                                                     00960000
009700          INCLUDE TCEPLST                                         00970000
009800     END-EXEC.                                                    00980000
009900                                                                  00990000
010000* RETEK CONTROL TABLE                                             01000000
010100     EXEC SQL                                                     01010000
010200          INCLUDE TKRPRPM                                         01020000
010300     END-EXEC.                                                    01030000
010400                                                                  01040000
010500                                                                  01050000
010600******************************************************************01060000
010700* STOCK PULL CURSOR                                               01070000
010800******************************************************************01080000
010900     EXEC SQL                                                     01090000
011000          DECLARE STOCK-PULL CURSOR WITH HOLD FOR                 01100000
011100           SELECT A.CNSTK_LOC_ID                                  01110000
011200                 ,A.SRC_TYP_CDE                                   01120000
011300                 ,B.CNSTK_REQ_PL_NBR                              01130000
011400                 ,B.PL_LNE_NBR                                    01140000
011500           FROM  TCEPLRQ A, TCEPLIT B                             01150000
011600           WHERE     A.CNSTK_REQ_PL_NBR = B.CNSTK_REQ_PL_NBR      01160000
011700                 AND B.STAT_CDE = 'PD'                            01170000
011800                 AND B.DWNLD_RDM_STAT_CDE IN ('R', 'X')           01180000
011900           ORDER BY A.CNSTK_LOC_ID                                01190000
012000                 ,  B.CNSTK_REQ_PL_NBR                            01200000
012100                 ,  B.PL_LNE_NBR                                  01210000
012200     END-EXEC.                                                    01220000
012300                                                                  01230000
012400 PROCEDURE DIVISION.                                              01240000
012500                                                                  01250000
012600     PERFORM 1000-INIT.                                           01260000
012700                                                                  01270000
012800     PERFORM 2000-PROCESS-DOWNLOAD                                01280000
012900        UNTIL PS-END-STOCK-PULL.                                  01290000
013000                                                                  01300000
013100     PERFORM 7020-CLOSE-STOCK-PULL-CURSOR.                        01310000
013200                                                                  01320000
013300     PERFORM 9000-TERMINATE.                                      01330000
013400                                                                  01340000
013500     GOBACK.                                                      01350000
013600                                                                  01360000
013700 1000-INIT.                                                       01370000
013800                                                                  01380000
013900     OPEN OUTPUT SO-DOWNLOAD-FILE.                                01390000
014000                                                                  01400000
014100     PERFORM 8000-GET-TIMESTAMP.                                  01410000
014200     PERFORM 7000-OPEN-STOCK-PULL-CURSOR.                         01420000
014300     PERFORM 7010-FETCH-STOCK-PULL-CURSOR.                        01430000
014400                                                                  01440000
014500                                                                  01450000
014600 2000-PROCESS-DOWNLOAD.                                           01460000
014700                                                                  01470000
014800     IF CEPLRQ-CNSTK-LOC-ID = PV-PREV-CNSTK-LOC-ID                01480000
014900         CONTINUE                                                 01490000
015000     ELSE                                                         01500000
015100         MOVE CEPLRQ-CNSTK-LOC-ID     TO PV-PREV-CNSTK-LOC-ID     01510000
015200         PERFORM 7130-CALL-XLKUT071                               01520000
015300         IF PS-VALID-DC                                           01530000
015400             PERFORM 7100-SELECT-TKRPRPM                          01540000
015500             IF PS-IS-RDM-LOCATION                                01550000
015600                 PERFORM 7150-SELECT-FUNC-QTY                     01560000
015700             END-IF                                               01570000
015800         END-IF                                                   01580000
015900     END-IF.                                                      01590000
016000                                                                  01600000
016100     IF PS-VALID-DC AND                                           01610000
016200        PS-IS-RDM-LOCATION                                        01620000
016300         PERFORM 7200-IS-LINE-DUE-FOR-DELETION                    01630000
016400         IF PS-DELETE-THIS-LINE                                   01640000
016500             PERFORM 7250-UPDATE-STAT-CDE                         01650000
016600             PERFORM 8100-WRITE-DOWNLOAD-REC                      01660000
016700         ELSE                                                     01670000
016710             ADD +1 TO PV-NOT-DELETE-COUNT                        01671001
017200         END-IF                                                   01720000
017300     ELSE                                                         01730000
017400         DISPLAY SPACES                                           01740000
017500         DISPLAY 'CNSTK_REQ_PL_NBR = ' CEPLIT-CNSTK-REQ-PL-NBR    01750000
017600                  '   PL_LNE_NBR       = ' CEPLIT-PL-LNE-NBR      01760000
017700                  ' LOC = ' CEPLRQ-CNSTK-LOC-ID                   01770000
017800                 '   ITEM NOT IN RDM LOCATION'                    01780000
017900     END-IF                                                       01790000
018000                                                                  01800000
018100     PERFORM 7010-FETCH-STOCK-PULL-CURSOR.                        01810000
018200                                                                  01820000
018300 7000-OPEN-STOCK-PULL-CURSOR.                                     01830000
018400     PERFORM                                                      01840000
018500         WITH TEST AFTER                                          01850000
018600         VARYING PV-RETRY-COUNT                                   01860000
018700         FROM 1 BY 1                                              01870000
018800         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 01880000
018900            OR  (SQLCODE = +0))                                   01890000
019000                                                                  01900000
019100         EXEC SQL                                                 01910000
019200             OPEN STOCK-PULL                                      01920000
019300         END-EXEC                                                 01930000
019400                                                                  01940000
019500         EVALUATE TRUE                                            01950000
019600             WHEN SQLCODE = +0                                    01960000
019700             WHEN SQLCODE = -904                                  01970000
019800             WHEN SQLCODE = -911                                  01980000
019900             WHEN SQLCODE = -913                                  01990000
020000                  CONTINUE                                        02000000
020100             WHEN SQLWARN0 NOT = SPACE                            02010000
020200             WHEN SQLCODE  NOT = +0                               02020000
020300                  MOVE '7000-OPEN-STOCK-PULL-CURSOR'              02030000
020400                                 TO PV-ABEND-PARAGRAPH            02040000
020500                  MOVE 'OPEN STOCK-PULL'                          02050000
020600                                 TO PV-ABEND-OPERATION            02060000
020700                  MOVE 'TCEPLIT' TO PV-ABEND-STRUCTURE-1          02070000
020800                  MOVE 'TCEPLRQ' TO PV-ABEND-STRUCTURE-2          02080000
020900                  PERFORM 9900-DB2-ABEND                          02090000
021000         END-EVALUATE                                             02100000
021100     END-PERFORM.                                                 02110000
021200                                                                  02120000
021300     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          02130000
021400         MOVE '7000-OPEN-STOCK-PULL-CURSOR'                       02140000
021500                                 TO PV-ABEND-PARAGRAPH            02150000
021600         MOVE 'MAX RETRIES EXCEEDED'                              02160000
021700                                 TO PV-ABEND-OPERATION            02170000
021800         PERFORM 9900-DB2-ABEND                                   02180000
021900     END-IF.                                                      02190000
022000                                                                  02200000
022100 7010-FETCH-STOCK-PULL-CURSOR.                                    02210000
022200                                                                  02220000
022300     INITIALIZE DCLTCEPLIT                                        02230000
022400                DCLTCEPLRQ.                                       02240000
022500     EXEC SQL                                                     02250000
022600          FETCH STOCK-PULL                                        02260000
022700           INTO   :CEPLRQ-CNSTK-LOC-ID                            02270000
022800                 ,:CEPLRQ-SRC-TYP-CDE                             02280000
022900                 ,:CEPLIT-CNSTK-REQ-PL-NBR                        02290000
023000                 ,:CEPLIT-PL-LNE-NBR                              02300000
023100     END-EXEC.                                                    02310000
023200                                                                  02320000
023300     EVALUATE TRUE                                                02330000
023400         WHEN SQLCODE = +0                                        02340000
023500             ADD 1                    TO PV-FETCH-COUNT           02350000
023600         WHEN SQLCODE = +100                                      02360000
023700              SET PS-END-STOCK-PULL TO TRUE                       02370000
023800         WHEN SQLWARN0 NOT = SPACE                                02380000
023900         WHEN SQLCODE  NOT = +0                                   02390000
024000              MOVE '7010-FETCH-STOCK-PULL-CURSOR'                 02400000
024100                                   TO PV-ABEND-PARAGRAPH          02410000
024200              MOVE 'FETCH STOCK-PULL CURSOR'                      02420000
024300                                   TO PV-ABEND-OPERATION          02430000
024400              MOVE 'TCEPLIT'       TO PV-ABEND-STRUCTURE-1        02440000
024500              MOVE 'TCEPLRQ'       TO PV-ABEND-STRUCTURE-2        02450000
024600              PERFORM 9900-DB2-ABEND                              02460000
024700     END-EVALUATE.                                                02470000
024800                                                                  02480000
024900 7020-CLOSE-STOCK-PULL-CURSOR.                                    02490000
025000                                                                  02500000
025100     PERFORM                                                      02510000
025200         WITH TEST AFTER                                          02520000
025300         VARYING PV-RETRY-COUNT                                   02530000
025400         FROM 1 BY 1                                              02540000
025500         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 02550000
025600            OR  (SQLCODE = +0))                                   02560000
025700                                                                  02570000
025800            EXEC SQL                                              02580000
025900                CLOSE STOCK-PULL                                  02590000
026000            END-EXEC                                              02600000
026100                                                                  02610000
026200            EVALUATE TRUE                                         02620000
026300                WHEN SQLCODE = 0                                  02630000
026400                    CONTINUE                                      02640000
026500                WHEN SQLCODE = -911                               02650000
026600                WHEN SQLCODE = -913                               02660000
026700                WHEN SQLCODE = -904                               02670000
026800                    CONTINUE                                      02680000
026900                WHEN SQLCODE  NOT = +0                            02690000
027000                     MOVE '7020-CLOSE-STOCK-PULL-CURSOR'          02700000
027100                                  TO PV-ABEND-PARAGRAPH           02710000
027200                     MOVE 'CLOSE STOCK-PULL'                      02720000
027300                                  TO PV-ABEND-OPERATION           02730000
027400                     MOVE 'TCEPLIT'   TO PV-ABEND-STRUCTURE-1     02740000
027500                     MOVE 'TCEPLRQ'   TO PV-ABEND-STRUCTURE-2     02750000
027600                     PERFORM 9900-DB2-ABEND                       02760000
027700            END-EVALUATE                                          02770000
027800                                                                  02780000
027900     END-PERFORM.                                                 02790000
028000                                                                  02800000
028100     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          02810000
028200         MOVE '7020-CLOSE-STOCK-PULL-CURSOR'                      02820000
028300                                 TO PV-ABEND-PARAGRAPH            02830000
028400         MOVE 'MAX RETRIES EXCEEDED'                              02840000
028500                                 TO PV-ABEND-OPERATION            02850000
028600         PERFORM 9900-DB2-ABEND                                   02860000
028700     END-IF.                                                      02870000
028800/                                                                 02880000
028900 7100-SELECT-TKRPRPM.                                             02890000
029000                                                                  02900000
029100     INITIALIZE DCLTKRPRPM.                                       02910000
029200                                                                  02920000
029300     PERFORM                                                      02930000
029400         WITH TEST AFTER                                          02940000
029500         VARYING PV-RETRY-COUNT                                   02950000
029600         FROM 1 BY 1                                              02960000
029700         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 02970000
029800            OR  (SQLCODE = +0 OR SQLCODE = +100))                 02980000
029900                                                                  02990000
030000         EXEC SQL                                                 03000000
030100             SELECT LOC_ID                                        03010000
030200             INTO :KRPRPM-LOC-ID                                  03020000
030300             FROM TKRPRPM                                         03030000
030400         WHERE                                                    03040000
030500             LOC_ID = :DK-LOCATION-NUMBER                         03050000
030600         AND INTFC_SYS_CDE = 'RDM'                                03060000
030700         AND FUNC_PRC_STAT_CDE = 'AC'                             03070000
030800         AND SYS_PRC_FUNC_CDE = 'RDMFAC'                          03080000
030900         AND FUNC_TXT = 'Y'                                       03090000
031000         AND (CURRENT DATE                                        03100000
031100         BETWEEN DATE(FUNC_BEG_TMST) AND DATE(FUNC_END_TMST) )    03110000
031200         END-EXEC                                                 03120000
031300                                                                  03130000
031400         EVALUATE TRUE                                            03140000
031500             WHEN SQLCODE = +0                                    03150000
031600                 SET PS-IS-RDM-LOCATION                           03160000
031700                                      TO TRUE                     03170000
031800             WHEN SQLCODE = +100                                  03180000
031900                 SET PS-ISNOT-RDM-LOCATION                        03190000
032000                                      TO TRUE                     03200000
032100             WHEN SQLCODE = -904                                  03210000
032200             WHEN SQLCODE = -911                                  03220000
032300             WHEN SQLCODE = -913                                  03230000
032400                  CONTINUE                                        03240000
032500             WHEN SQLWARN0 NOT = SPACE                            03250000
032600             WHEN SQLCODE  NOT = +0                               03260000
032700                  MOVE '7100-SELECT-TKRPRPM'                      03270000
032800                                 TO PV-ABEND-PARAGRAPH            03280000
032900                  MOVE 'SELECT TKRPRPM - DC NUM'                  03290000
033000                                 TO PV-ABEND-OPERATION            03300000
033100                  MOVE 'TKRPRPM'   TO PV-ABEND-STRUCTURE-1        03310000
033200                  PERFORM 9900-DB2-ABEND                          03320000
033300         END-EVALUATE                                             03330000
033400     END-PERFORM.                                                 03340000
033500                                                                  03350000
033600     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          03360000
033700            AND NOT (SQLCODE = +0 OR SQLCODE = +100)              03370000
033800         MOVE '7100-SELECT-TKRPRPM'                               03380000
033900                                 TO PV-ABEND-PARAGRAPH            03390000
034000         MOVE 'MAX RETRIES EXCEEDED'                              03400000
034100                                 TO PV-ABEND-OPERATION            03410000
034200         PERFORM 9900-DB2-ABEND                                   03420000
034300     END-IF.                                                      03430000
034400                                                                  03440000
034500 7130-CALL-XLKUT071.                                              03450000
034501                                                                  03450102
034510     MOVE CEPLRQ-CNSTK-LOC-ID  TO PV-DISP-LOC-ID.                 03451002
034600     DISPLAY '7130-CALL-XLKUT071 FOR LOCATION NBR:  '             03460002
034610             PV-DISP-LOC-ID.                                      03461002
034700     INITIALIZE XL071-COMMAREA-REC.                               03470000
034800     MOVE CEPLRQ-CNSTK-LOC-ID  TO XL071-LOCATION-NUMBER.          03480000
034900     CALL XL071-LOCATION-MODULE USING XL071-COMMAREA-REC          03490000
035000                                                                  03500000
035100     EVALUATE TRUE                                                03510000
035200         WHEN XL071-NO-ERRORS                                     03520000
035300             IF XL071-ASGMT-EFF-STP-DTE = '9999-09-09' AND        03530000
035400                XL071-ASGMT-PO-STP-DTE = '9999-09-09'             03540000
035500                 MOVE XL071-ASGMT-DC-NBR  TO DK-LOCATION-NUMBER   03550000
035600                 SET PS-VALID-DC     TO TRUE                      03560000
035700             ELSE                                                 03570000
035800                 SET PS-NO-VALID-DC   TO TRUE                     03580000
035900             END-IF                                               03590000
036000         WHEN XL071-LOC-NOT-FOUND                                 03600000
036100             MOVE '7130-CALL-XLKUT071' TO PV-PARAGRAPH-NAME       03610000
036200             MOVE 'NOT FOUND'          TO PV-ERROR-MESSAGE-1      03620000
036300             MOVE CEPLRQ-CNSTK-LOC-ID  TO PV-DISP-LOC-ID          03630000
036400             MOVE PV-DISP-LOC-ID       TO PV-ERROR-MESSAGE-2      03640000
036500             PERFORM 9200-ABEND                                   03650000
036600         WHEN XL071-BAD-DB2-RETURN                                03660000
036700             MOVE '7130-CALL-XLKUT071' TO PV-PARAGRAPH-NAME       03670000
036800             MOVE 'BAD DB2 RETURN'     TO PV-ERROR-MESSAGE-1      03680000
036900             MOVE CEPLRQ-CNSTK-LOC-ID  TO PV-DISP-LOC-ID          03690000
037000             MOVE PV-DISP-LOC-ID       TO PV-ERROR-MESSAGE-2      03700000
037100             MOVE XL071-SQLCODE        TO PV-ERROR-MESSAGE-3      03710000
037200             PERFORM 9200-ABEND                                   03720000
037300     END-EVALUATE.                                                03730000
037400                                                                  03740000
037500 7150-SELECT-FUNC-QTY.                                            03750000
037600     INITIALIZE DCLTKRPRPM                                        03760000
037700                                                                  03770000
037800     PERFORM                                                      03780000
037900         WITH TEST AFTER                                          03790000
038000         VARYING PV-RETRY-COUNT                                   03800000
038100         FROM 1 BY 1                                              03810000
038200         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 03820000
038300            OR  (SQLCODE = +0 OR SQLCODE = +100))                 03830000
038400                                                                  03840000
038500         EXEC SQL                                                 03850000
038600             SELECT FUNC_QTY                                      03860000
038700             INTO :KRPRPM-FUNC-QTY                                03870000
038800             FROM TKRPRPM B                                       03880000
038900         WHERE                                                    03890000
039000             LOC_ID = :DK-LOCATION-NUMBER                         03900000
039100         AND INTFC_SYS_CDE = 'RDM'                                03910000
039200         AND FUNC_PRC_STAT_CDE = 'AC'                             03920000
039300         AND SYS_PRC_FUNC_CDE = 'SOPGDY'                          03930000
039400         AND (CURRENT DATE                                        03940000
039500         BETWEEN DATE(FUNC_BEG_TMST) AND DATE(FUNC_END_TMST) )    03950000
039600         END-EXEC                                                 03960000
039700                                                                  03970000
039800         EVALUATE TRUE                                            03980000
039900             WHEN SQLCODE = ZERO                                  03990000
040000                 DISPLAY 'FUNC-DAYS = ' KRPRPM-FUNC-QTY           04000000
040100                 CONTINUE                                         04010000
040200             WHEN SQLCODE = +100                                  04020000
040300                  MOVE CEPLRQ-CNSTK-LOC-ID TO PV-DISP-NBR         04030000
040400                  MOVE '7150-SELECT-FUNC-QTY'                     04040000
040500                                 TO PV-ABEND-PARAGRAPH            04050000
040600                  STRING 'NO SOPGDY ROW IN TKRPRPM FOR LOC= '     04060000
040700                     PV-DISP-NBR DELIMITED BY SIZE                04070000
040800                                 INTO PV-ABEND-OPERATION          04080000
040900                  MOVE 'TKRPRPM'   TO PV-ABEND-STRUCTURE-1        04090000
041000                  PERFORM 9900-DB2-ABEND                          04100000
041100             WHEN SQLCODE = -904                                  04110000
041200             WHEN SQLCODE = -911                                  04120000
041300             WHEN SQLCODE = -913                                  04130000
041400                  CONTINUE                                        04140000
041500             WHEN SQLWARN0 NOT = SPACE                            04150000
041600             WHEN SQLCODE  NOT = +0                               04160000
041700                  MOVE '7150-SELECT-FUNC-QTY'                     04170000
041800                                 TO PV-ABEND-PARAGRAPH            04180000
041900                  MOVE 'SELECT TKRPRPM - DC NUM'                  04190000
042000                                 TO PV-ABEND-OPERATION            04200000
042100                  MOVE 'TKRPRPM'   TO PV-ABEND-STRUCTURE-1        04210000
042200                  PERFORM 9900-DB2-ABEND                          04220000
042300         END-EVALUATE                                             04230000
042400     END-PERFORM.                                                 04240000
042500                                                                  04250000
042600     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          04260000
042700            AND NOT (SQLCODE = +0 OR SQLCODE = +100)              04270000
042800         MOVE '7150-SELECT-FUNC-QTY'                              04280000
042900                                 TO PV-ABEND-PARAGRAPH            04290000
043000         MOVE 'MAX RETRIES EXCEEDED'                              04300000
043100                                 TO PV-ABEND-OPERATION            04310000
043200         PERFORM 9900-DB2-ABEND                                   04320000
043300     END-IF.                                                      04330000
043400                                                                  04340000
043500                                                                  04350000
043600 7200-IS-LINE-DUE-FOR-DELETION.                                   04360000
043700                                                                  04370000
043800     PERFORM                                                      04380000
043900         WITH TEST AFTER                                          04390000
044000         VARYING PV-RETRY-COUNT                                   04400000
044100         FROM 1 BY 1                                              04410000
044200         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 04420000
044300            OR  (SQLCODE = +0 OR SQLCODE = +100 OR                04430000
044400                SQLCODE = -811))                                  04440000
044500                                                                  04450000
044600         EXEC SQL                                                 04460000
044700             SELECT CNSTK_REQ_PL_NBR                              04470000
044800             INTO :CEPLST-CNSTK-REQ-PL-NBR                        04480000
044900             FROM TCEPLST A                                       04490000
045000         WHERE                                                    04500000
045100             CNSTK_REQ_PL_NBR = :CEPLIT-CNSTK-REQ-PL-NBR          04510000
045200         AND PL_LNE_NBR       = :CEPLIT-PL-LNE-NBR                04520000
045300         AND STAT_CDE = 'PD'                                      04530000
045400         AND DATE(CRE_TMST) <                                     04540000
045500          (CURRENT DATE) -  :KRPRPM-FUNC-QTY DAYS                 04550000
045600         END-EXEC                                                 04560000
045700                                                                  04570000
045800         EVALUATE TRUE                                            04580000
045900             WHEN SQLCODE = ZERO                                  04590000
046000             WHEN SQLCODE = -811                                  04600000
046100                 SET PS-DELETE-THIS-LINE                          04610000
046200                                      TO TRUE                     04620000
046300             WHEN SQLCODE = +100                                  04630000
046400                 SET PS-KEEP-THIS-LINE                            04640000
046500                                      TO TRUE                     04650000
046600             WHEN SQLCODE = -904                                  04660000
046700             WHEN SQLCODE = -911                                  04670000
046800             WHEN SQLCODE = -913                                  04680000
046900                  CONTINUE                                        04690000
047000             WHEN SQLWARN0 NOT = SPACE                            04700000
047100             WHEN SQLCODE  NOT = +0                               04710000
047200                  MOVE '7200-IS-LINE-DUE-FOR-DELETION'            04720000
047300                                 TO PV-ABEND-PARAGRAPH            04730000
047400                  MOVE 'SELECT TCEPLST'                           04740000
047500                                 TO PV-ABEND-OPERATION            04750000
047600                  MOVE 'TCEPLST'   TO PV-ABEND-STRUCTURE-1        04760000
047700                  PERFORM 9900-DB2-ABEND                          04770000
047800         END-EVALUATE                                             04780000
047900     END-PERFORM.                                                 04790000
048000                                                                  04800000
048100     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          04810000
048200            AND NOT (SQLCODE = +0 OR SQLCODE = +100)              04820000
048300         MOVE '7200-IS-LINE-DUE-FOR-DELETION'                     04830000
048400                                 TO PV-ABEND-PARAGRAPH            04840000
048500         MOVE 'MAX RETRIES EXCEEDED'                              04850000
048600                                 TO PV-ABEND-OPERATION            04860000
048700         PERFORM 9900-DB2-ABEND                                   04870000
048800     END-IF.                                                      04880000
048900                                                                  04890000
049000*                                                                 04900000
049100 7250-UPDATE-STAT-CDE.                                            04910000
049200                                                                  04920000
049300     PERFORM                                                      04930000
049400         WITH TEST AFTER                                          04940000
049500         VARYING PV-RETRY-COUNT                                   04950000
049600         FROM 1 BY 1                                              04960000
049700         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 04970000
049800            OR  (SQLCODE = +0))                                   04980000
049900                                                                  04990000
050000         EXEC SQL                                                 05000000
050100             UPDATE TCEPLIT                                       05010000
050200                SET DWNLD_RDM_STAT_CDE = 'D'                      05020000
050300                WHERE                                             05030000
050400                      CNSTK_REQ_PL_NBR = :CEPLIT-CNSTK-REQ-PL-NBR 05040000
050500                 AND  PL_LNE_NBR       = :CEPLIT-PL-LNE-NBR       05050000
050600         END-EXEC                                                 05060000
050700                                                                  05070000
050800         EVALUATE TRUE                                            05080000
050900             WHEN SQLCODE = +0                                    05090000
051000                 ADD 1                TO PV-UPDATE-COUNT          05100000
051100             WHEN SQLCODE = -904                                  05110000
051200             WHEN SQLCODE = -911                                  05120000
051300             WHEN SQLCODE = -913                                  05130000
051400                  CONTINUE                                        05140000
051500             WHEN SQLWARN0 NOT = SPACE                            05150000
051600             WHEN SQLCODE  NOT = +0                               05160000
051700                  MOVE '7250-UPDATE-STAT-CDE'                     05170000
051800                                 TO PV-ABEND-PARAGRAPH            05180000
051900                  MOVE 'UPDATE STOCK-PULL CURSOR'                 05190000
052000                                 TO PV-ABEND-OPERATION            05200000
052100                  MOVE 'TCEPLIT' TO PV-ABEND-STRUCTURE-1          05210000
052200                  MOVE SPACES    TO PV-ABEND-STRUCTURE-2          05220000
052300                  PERFORM 9900-DB2-ABEND                          05230000
052400         END-EVALUATE                                             05240000
052500     END-PERFORM.                                                 05250000
052600                                                                  05260000
052700     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          05270000
052800         MOVE '7250-UPDATE-STAT-CDE'                              05280000
052900                                 TO PV-ABEND-PARAGRAPH            05290000
053000         MOVE 'MAX RETRIES EXCEEDED'                              05300000
053100                                 TO PV-ABEND-OPERATION            05310000
053200         PERFORM 9900-DB2-ABEND                                   05320000
053300     END-IF.                                                      05330000
053400                                                                  05340000
053500 8000-GET-TIMESTAMP.                                              05350000
053600***************************************************************** 05360000
053700*  FORMAT EXAMPLE 2000-01-01-00.00.00.000000                      05370000
053800***************************************************************** 05380000
053900     EXEC SQL                                                     05390000
054000         SET :PV-TMST = CURRENT TIMESTAMP                         05400000
054100     END-EXEC.                                                    05410000
054200                                                                  05420000
054300     EVALUATE TRUE                                                05430000
054400         WHEN SQLCODE = +0                                        05440000
054500              CONTINUE                                            05450000
054600         WHEN SQLWARN0 NOT = SPACE                                05460000
054700         WHEN SQLCODE  NOT = +0                                   05470000
054800              MOVE '8000-GET-TIMESTAMP'                           05480000
054900                             TO PV-ABEND-PARAGRAPH                05490000
055000              MOVE 'GET TIMESTAMP'                                05500000
055100                             TO PV-ABEND-OPERATION                05510000
055200              MOVE 'TIMESTAMP' TO PV-ABEND-STRUCTURE-1            05520000
055300              MOVE SPACES      TO PV-ABEND-STRUCTURE-2            05530000
055400              PERFORM 9900-DB2-ABEND                              05540000
055500     END-EVALUATE.                                                05550000
055600                                                                  05560000
055700     IF SQLCODE = 0                                               05570000
055800        MOVE PV-TMST(1:4)     TO PV-REFORMAT-TMST-DTE-CY          05580000
055900        MOVE PV-TMST(6:2)     TO PV-REFORMAT-TMST-DTE-MM          05590000
056000        MOVE PV-TMST(9:2)     TO PV-REFORMAT-TMST-DTE-DD          05600000
056100        MOVE PV-TMST(12:2)    TO PV-REFORMAT-TMST-TM-HH           05610000
056200        MOVE PV-TMST(15:2)    TO PV-REFORMAT-TMST-TM-MM           05620000
056300     END-IF.                                                      05630000
056400                                                                  05640000
056500 8100-WRITE-DOWNLOAD-REC.                                         05650000
056600                                                                  05660000
056700     MOVE 'M'                      TO CE009-ACTION-TYPE           05670000
056800     MOVE CEPLRQ-CNSTK-LOC-ID      TO CE009-LOCATION.             05680000
056900     MOVE PV-REFORMAT-TMST         TO CE009-TRANS-DATE-TIME.      05690000
057000     MOVE CEPLIT-CNSTK-REQ-PL-NBR  TO PV-CNSTK-REQ-PL-NBR.        05700000
057100     MOVE CEPLIT-PL-LNE-NBR        TO PV-CEPLIT-PL-LNE-NBR.       05710000
057200     IF  XL071-E-BUS-IND = 'Y'                                    05720000
057300         IF  XL071-LOC-TYP-CDE = 'DS'                             05730000
057400         OR  XL071-LOC-TYP-CDE = 'CS'                             05740000
057500             MOVE PV-CNSTK-REQ-PL-NBR(5:5)                        05750000
057600                                   TO CE009-DISTRO-NUMBER(2:5)    05760000
057700             MOVE PV-CEPLIT-PL-LNE-NBR(2:3)                       05770000
057710                                   TO CE009-DISTRO-NUMBER(7:3)    05771000
057720             IF  CEPLRQ-SRC-TYP-CDE = PC-XF                       05772000
057730                 MOVE PC-X         TO CE009-DISTRO-NUMBER(1:1)    05773000
057740             ELSE                                                 05774000
057750                 MOVE PC-C         TO CE009-DISTRO-NUMBER(1:1)    05775000
057760             END-IF                                               05776000
057770         ELSE                                                     05777000
057780             MOVE PV-CNSTK-REQ-PL-NBR(5:5)                        05778000
057790                                   TO CE009-DISTRO-NUMBER(1:5)    05779000
057800             MOVE CEPLIT-PL-LNE-NBR                               05780000
057900                                   TO CE009-DISTRO-NUMBER(6:4)    05790000
058000         END-IF                                                   05800000
058100     ELSE                                                         05810000
058200         MOVE PV-CNSTK-REQ-PL-NBR(5:5)                            05820000
058300                                   TO CE009-DISTRO-NUMBER(1:5)    05830000
058400         MOVE CEPLIT-PL-LNE-NBR    TO CE009-DISTRO-NUMBER(6:4)    05840000
058500     END-IF.                                                      05850000
058600     MOVE SPACES                   TO CE009-DOWNLOAD-COMMENT.     05860000
058700     MOVE 20000101                 TO CE009-PICK-NOT-B4-DATE.     05870000
058800     MOVE 20000102                 TO CE009-PICK-NOT-AFT-DATE.    05880000
058900     ADD 1                         TO PV-COUNT.                   05890000
059000     WRITE SO-DOWNLOAD-RECORD FROM                                05900000
059100           CE009-SOHDR-DOWNLOAD-REC.                              05910000
059200/                                                                 05920000
059300 9000-TERMINATE.                                                  05930000
059400                                                                  05940000
059500     CLOSE SO-DOWNLOAD-FILE.                                      05950000
059600                                                                  05960000
059700     DISPLAY '************************'.                          05970000
059800     DISPLAY '******* CEKUP013 *******'.                          05980000
059900     DISPLAY '************************'.                          05990000
060000     DISPLAY SPACES                                               06000000
060100     DISPLAY 'STOCK ORDERS FETCHED            = ' PV-FETCH-COUNT. 06010000
060200     DISPLAY 'STOCK ORDER DELETE TRANSACTIONS = ' PV-COUNT.       06020000
060300     DISPLAY 'STOCK ORDER ITEMS UPDATED       = '                 06030000
060400                                            PV-UPDATE-COUNT.      06040000
060410     DISPLAY 'STOCK ORDER NOT READY TO DELETE = '                 06041001
060420                                            PV-NOT-DELETE-COUNT.  06042001
060500     DISPLAY SPACES                                               06050000
060600     DISPLAY '************************'.                          06060000
060700                                                                  06070000
060800 9900-DB2-ABEND.                                                  06080000
060900                                                                  06090000
061000     MOVE SQLCODE TO PV-SQLCODE.                                  06100000
061100     DISPLAY '*** DB2 ERROR '.                                    06110000
061200     DISPLAY '*** SQLCODE   = ' PV-SQLCODE.                       06120000
061300     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 06130000
061400     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               06140000
061500     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               06150000
061600     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       06160000
061700     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.       06170000
061800     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-3.       06180000
061900     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.             06190000
062000                                                                  06200000
062100     IF PV-ABEND-STRUCTURE-2 > SPACES                             06210000
062200         DISPLAY '*** TABLE 2   = ' PV-ABEND-STRUCTURE-2          06220000
062300     END-IF.                                                      06230000
062400                                                                  06240000
062500                                                                  06250000
062600     COPY DPPD004.                                                06260000
062700                                                                  06270000
062800     IF SQLCODE NOT = -911                                        06280000
062900         EXEC SQL                                                 06290000
063000              ROLLBACK                                            06300000
063100         END-EXEC                                                 06310000
063200     END-IF.                                                      06320000
063300                                                                  06330000
063400     MOVE +4013                  TO PV-ABEND-CODE.                06340000
063500     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         06350000
063600                                                                  06360000
063700 9200-ABEND.                                                      06370000
063800******************************************************************06380000
063900*  PERFORMS A NON-SQL ABEND FOR THE PROGRAM                       06390000
064000******************************************************************06400000
064100     DISPLAY '***************************'.                       06410000
064200     DISPLAY '**       ABEND           **'.                       06420000
064300     DISPLAY '**  IN PROGRAM CEKUP013  **'.                       06430000
064400     DISPLAY '***************************'.                       06440000
064500     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        06450000
064600     DISPLAY '**                 ** = ' PV-ERROR-MESSAGE-1.       06460000
064700     DISPLAY '**                 ** = ' PV-ERROR-MESSAGE-2.       06470000
064800     DISPLAY '**                 ** = ' PV-ERROR-MESSAGE-3.       06480000
064900                                                                  06490000
065000     MOVE +4014                  TO PV-ABEND-CODE.                06500000
065100     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         06510000
065200*                                                                 06520000
