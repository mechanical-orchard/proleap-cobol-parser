       IDENTIFICATION DIVISION.                                         00010002
       PROGRAM-ID.      MLKUT486.                                       00020002
       AUTHOR.          R. MCDONALD.                                    00030002
       INSTALLATION.    KOHLS DEPARTMENT STORES.                        00040002
       DATE-WRITTEN.    07-31-2003.                                     00050002
      ***************************************************************** 00060002
      *  THE PURPOSE OF THIS PROGRAM IS TO GET MESSAGES FROM THE      * 00070002
      *  VSM ITEM HUB.  THE FILE can THEN BE SORTED BY BUSINESS       * 00080004
      *  EVENT ID.                                                    * 00090002
      *                                                               * 00100002
      *  THE BUSINESS EVENTS WE RETRIEVE ARE AS FOLLOWS:              * 00110002
      *  010 = STYLE RECLASS                                          * 00120002
      *                                                               * 00130002
      *  TO SELECT OTHER BUSINESS EVENT RECORDS, THE SQL THAT         * 00140002
      *  DIRECTS RECORDS TO THE MERCHANDISE LEDGER QUEUE MUST         * 00150002
      *  BE CHANGED.                                                  * 00160002
      *                                                               * 00170002
      *  THIS PROGRAM RETRIEVES RECORDS FROM MQ SERIES QUEUE          * 00180002
      *  ML.VSM.ITEM.Q (QUEUE NAME).  THE WAY THIS QUEUE IS SET UP IS * 00190003
      *  THAT ONCE A MQGET IS DONE, A RECORD WILL BE MARKED AS "READ".* 00200003
      *  ONCE A MQCMIT IS DONE, A RECORD WILL ACTUALLY BE DELETED FROM* 00210003
      *  THE QUEUE.  WHEN A MQBACK IS DONE, ALL RECORDS MARKED AS     * 00220003
      *  "READ" WILL BE CHANGED BACK TO "UNREAD" SO THAT THE PROGRAM  * 00230003
      *  CAN BE RESTARTED.                                            * 00240003
      *                                                               * 00250003
      *  IN THIS PROGRAM, THE MQ WAIT INTERVAL DEFAULT TIME OF 0 WILL * 00270002
      *  BE USED.  IF THE TIME WAS SET TO 1 MINUTE (60000), MQ SERIES * 00280002
      *  WOULD KEEP WAITING FOR NEW MESSAGES FOR ANOTHER MINUTE.  IN  * 00290002
      *  THE EVENT THAT MESSAGES KEPT TRICKLING IN, THE JOB STEP      * 00300002
      *  THAT CONTAINS THIS PROGRAM COULD BE KEPT ACTIVE FOR AN       * 00310002
      *  EXTENDED PERIOD OF TIME.  SO, IT'S BEST TO KEEP THE WAIT     * 00320002
      *  INTERVAL AT 0 SO THAT THE EXECUTION OF THIS PROGRAM ENDS     * 00330002
      *  WITHIN A REASONABLE PERIOD OF TIME.                          * 00340002
      *                                                               * 00350002
      *CHANGE HISTORY:                                                  00352007
      * WR/PROJ   DATE       PGMR        DESCRIPTION OF CHANGES         00353007
      * -------   ---------  ----------- ------------------------------ 00354007
982230*PM00982230 02-12-2007 ROD JANSSEN MLK375 ABENDS - 2/12/2007.     00355010
982230*                                  1. MQ SYNCPOINT ISSUE & COMMIT 00355110
982230*                                     LOGIC. THE GMGR THRESHHOLD  00355210
982230*                                     IS 10,000 RECORDS. WE NEED  00355310
982230*                                     PERFORM A COMMIT PRIOR TO   00355410
982230*                                     THE THRESHOLD IS REACHED.   00355510
982230*                                  2. DATASET EXTENT ISSUES.      00356007
      ***************************************************************** 00390002
                                                                        00400002
       ENVIRONMENT DIVISION.                                            00410002
       CONFIGURATION SECTION.                                           00420002
                                                                        00430002
       SOURCE-COMPUTER.       IBM-3090.                                 00440002
       OBJECT-COMPUTER.       IBM-3090.                                 00450002
                                                                        00460002
       INPUT-OUTPUT SECTION.                                            00470002
                                                                        00480002
       FILE-CONTROL.                                                    00490002
           SELECT CONTROL-CARD-1   ASSIGN TO INP01.                     00500002
           SELECT CONTROL-CARD-2   ASSIGN TO INP02.                     00510002
           SELECT CONTROL-CARD-3   ASSIGN TO INP03.                     00520003
           SELECT ITEM-FILE        ASSIGN TO OUT01.                     00530002
                                                                        00540002
       DATA DIVISION.                                                   00550002
       FILE SECTION.                                                    00560002
                                                                        00570002
       FD  CONTROL-CARD-1                                               00580002
           RECORDING MODE F                                             00590002
           BLOCK CONTAINS 0 RECORDS                                     00600002
           LABEL RECORDS ARE OMITTED.                                   00610002
       01  CONTROL-CARD-1-RECORD        PIC X(80).                      00620002
                                                                        00630002
       FD  CONTROL-CARD-2                                               00640002
           RECORDING MODE F                                             00650002
           BLOCK CONTAINS 0 RECORDS                                     00660002
           LABEL RECORDS ARE OMITTED.                                   00670002
       01  CONTROL-CARD-2-RECORD        PIC X(80).                      00680002
                                                                        00690002
       FD  CONTROL-CARD-3                                               00700003
           RECORDING MODE F                                             00710003
           BLOCK CONTAINS 0 RECORDS                                     00720003
           LABEL RECORDS ARE OMITTED.                                   00730003
       01  CONTROL-CARD-3-RECORD        PIC X(80).                      00740003
                                                                        00750003
       FD  ITEM-FILE                                                    00760002
           RECORDING MODE F                                             00770002
           LABEL RECORDS OMITTED                                        00780002
           BLOCK CONTAINS  0 RECORDS.                                   00790002
       01  ITEM-RECORD                  PIC X(450).                     00800002
                                                                        00810002
       WORKING-STORAGE SECTION.                                         00820002
       01  WS-CONSTANTS.                                                00830002
           05  WS-MQCONN                PIC X(8)  VALUE 'CSQBCONN'.     00840002
           05  WS-MQOPEN                PIC X(8)  VALUE 'CSQBOPEN'.     00850002
           05  WS-MQGET                 PIC X(8)  VALUE 'CSQBGET'.      00860002
           05  WS-MQBACK                PIC X(8)  VALUE 'CSQBBACK'.     00870002
           05  WS-MQCMIT                PIC X(8)  VALUE 'CSQBCOMM'.     00880002
           05  WS-MQCLOSE               PIC X(8)  VALUE 'CSQBCLOS'.     00890002
           05  WS-MQDISC                PIC X(8)  VALUE 'CSQBDISC'.     00900002
                                                                        00910002
      ********************************************************          00920002
      *    API CONTROL BLOCKS                                *          00930002
      ********************************************************          00940002
       01  MQM-OBJECT-DESCRIPTOR.                                       00950002
           COPY CMQODV.                                                 00960002
       01  MQM-MESSAGE-DESCRIPTOR.                                      00970002
           COPY CMQMDV.                                                 00980002
       01  MQM-GET-MESSAGE-OPTIONS.                                     00990002
           COPY CMQGMOV.                                                01000002
                                                                        01010002
       01  MQM-CONSTANTS.                                               01020002
           COPY CMQV.                                                   01030002
                                                                        01040002
982230 01  PC-PROGRAM-CONSTANTS.                                        01041008
982230     05  PC-MAX-COMMITS          PIC S9(15) COMP-3 VALUE 9500.    01042008
982230                                                                  01043008
       01  WS-SWITCHES.                                                 01050002
           05  WS-CONTROL-CARD-1-SW     PIC X(01) VALUE 'N'.            01060002
               88  CONTROL-CARD-1-EOF             VALUE 'Y'.            01070002
               88  CONTROL-CARD-1-NOT-EOF         VALUE 'N'.            01080002
           05  WS-CONTROL-CARD-2-SW     PIC X(01) VALUE 'N'.            01090002
               88  CONTROL-CARD-2-EOF             VALUE 'Y'.            01100002
               88  CONTROL-CARD-2-NOT-EOF         VALUE 'N'.            01110002
           05  WS-CONTROL-CARD-3-SW     PIC X(01) VALUE 'N'.            01120003
               88  CONTROL-CARD-3-EOF             VALUE 'Y'.            01130003
               88  CONTROL-CARD-3-NOT-EOF         VALUE 'N'.            01140003
           05  WS-MQGET-MSG-SW          PIC X(01) VALUE 'Y'.            01150002
               88  MQGET-MORE-MSG                 VALUE 'Y'.            01160002
               88  MQGET-NO-MORE-MSG              VALUE 'N'.            01170002
                                                                        01180002
       01  WS-VARIABLES.                                                01190002
           05  WS-RCDS-WRITTEN          PIC S9(9) VALUE 0.              01200002
982230     05  WS-COMMIT-RECS-ACC       PIC S9(15) COMP-3 VALUE ZEROS.  01201008
           05  WS-RCDS-WRITTEN1         PIC ZZZ,ZZZ,ZZ9.                01210002
           05  WS-QM-NAME               PIC X(48) VALUE SPACES.         01220002
           05  WS-PARAGRAPH             PIC X(30) VALUE SPACES.         01230002
           05  WS-MSGBUFFER             PIC X(450)                      01240002
                                                  VALUE SPACES.         01250002
           05  WS-MSGLENGTH             PIC S9(9) BINARY VALUE +450.    01260002
           05  WS-DATA-LENGTH           PIC S9(9) BINARY.               01270002
           05  WS-HCONN                 PIC S9(9) BINARY VALUE 0.       01280002
           05  WS-OBJECT-HANDLE         PIC S9(9) BINARY VALUE 0.       01290002
           05  WS-OPEN-OPTIONS          PIC S9(9) BINARY.               01300002
           05  WS-COMPLETION-CODE       PIC S9(9) BINARY VALUE 0.       01310002
           05  WS-COMP-CODE1            PIC S9(9) COMP-3.               01320002
           05  WS-COMP-CODE2            PIC S9(9).                      01330002
           05  WS-COMP-CODE3            PIC ZZZZZZZZ9.                  01340002
           05  WS-REASON-CODE           PIC S9(9) BINARY VALUE 0.       01350002
           05  WS-REASON-CODE1          PIC S9(9) COMP-3.               01360002
           05  WS-REASON-CODE2          PIC S9(9).                      01370002
           05  WS-REASON-CODE3          PIC ZZZZZZZZ9.                  01380002
           05  WS-ABEND-CODE            PIC S9(4) VALUE ZEROS           01390002
                                                  COMP SYNC.            01400002
               88  CONTROL-CARD-MISSING           VALUE +4001.          01410002
               88  MQ-ERROR                       VALUE +4020.          01420002
                                                                        01430002
       01  WS-CONTROL-CARD-1.                                           01440002
           05  WS-QMGR-NAME             PIC X(48).                      01450002
           05  FILLER                   PIC X(32).                      01460002
                                                                        01470002
       01  WS-CONTROL-CARD-2.                                           01480002
           05  WS-QUEUE-NAME            PIC X(48).                      01490002
           05  FILLER                   PIC X(32).                      01500002
                                                                        01510002
       01  WS-CONTROL-CARD-3.                                           01520003
           05  WS-MQ-ACTION             PIC X(07).                      01530003
               88 WS-TEST-REREAD        VALUE 'MQBACKT'.                01540003
               88 WS-TEST-COMMIT        VALUE 'MQCMITT'.                01550003
               88 WS-PROD-COMMIT        VALUE 'MQCMITP'.                01560003
           05  FILLER                   PIC X(73).                      01570003
                                                                        01580003
      ********************************************************          01590002
      *  LEGACY ITEM MAINTENANCE INFO COPYBOOK               *          01600002
      ********************************************************          01610002
           COPY IMRD008.                                                01620002
                                                                        01630002
                                                                        01640002
       PROCEDURE DIVISION.                                              01650002
       M0000-MAINLINE.                                                  01660002
                                                                        01670002
           PERFORM A1000-INITIALIZE                                     01680002
              THRU A1000-EXIT.                                          01690002
                                                                        01700002
           PERFORM B1000-PROCESS-MESSAGES                               01710002
              THRU B1000-EXIT                                           01720002
             UNTIL MQGET-NO-MORE-MSG.                                   01730002
                                                                        01740002
           PERFORM C1000-EOJ-PROCESSING                                 01750002
              THRU C1000-EXIT.                                          01760002
                                                                        01770002
           STOP RUN.                                                    01780002
                                                                        01790002
                                                                        01800002
       A1000-INITIALIZE.                                                01810002
                                                                        01820002
           OPEN INPUT  CONTROL-CARD-1                                   01830002
                       CONTROL-CARD-2                                   01840002
                       CONTROL-CARD-3                                   01850003
                OUTPUT ITEM-FILE.                                       01860002
                                                                        01870002
982230     MOVE ZEROS  TO WS-COMMIT-RECS-ACC                            01870107
982230                                                                  01871007
           PERFORM A1100-READ-CONTROL-CARD-1                            01880002
              THRU A1100-EXIT.                                          01890002
                                                                        01900002
           PERFORM A1200-READ-CONTROL-CARD-2                            01910002
              THRU A1200-EXIT.                                          01920002
                                                                        01930002
           PERFORM A1300-READ-CONTROL-CARD-3                            01940003
              THRU A1300-EXIT.                                          01950003
                                                                        01960003
           CLOSE CONTROL-CARD-1                                         01970002
                 CONTROL-CARD-2                                         01980003
                 CONTROL-CARD-3.                                        01990003
                                                                        02000002
           PERFORM A1400-MQCONN                                         02010003
              THRU A1400-EXIT.                                          02020003
                                                                        02030002
           PERFORM A1500-MQOPEN                                         02040003
              THRU A1500-EXIT.                                          02050003
                                                                        02060002
       A1000-EXIT.                                                      02070002
           EXIT.                                                        02080002
                                                                        02090002
                                                                        02100002
       A1100-READ-CONTROL-CARD-1.                                       02110002
                                                                        02120002
      *  OBTAIN THE QUEUE MGR NAME                                      02130002
                                                                        02140002
           READ CONTROL-CARD-1                                          02150002
               INTO WS-CONTROL-CARD-1                                   02160002
                   AT END                                               02170002
                       SET CONTROL-CARD-1-EOF TO TRUE.                  02180002
                                                                        02190002
           IF CONTROL-CARD-1-EOF                                        02200002
               DISPLAY '***********************************'            02210002
               DISPLAY '***  ABEND MLKUT486                '            02220002
               DISPLAY '***  A1100-READ-CONTROL-CARD-1     '            02230002
               DISPLAY '***********************************'            02240002
               SET CONTROL-CARD-MISSING       TO TRUE                   02250002
               CALL 'ILBOABN0' USING WS-ABEND-CODE                      02260002
           END-IF.                                                      02270002
                                                                        02280002
       A1100-EXIT.                                                      02290002
           EXIT.                                                        02300002
                                                                        02310002
                                                                        02320002
       A1200-READ-CONTROL-CARD-2.                                       02330002
                                                                        02340002
      *  OBTAIN THE INPUT QUEUE NAME                                    02350002
                                                                        02360002
           READ CONTROL-CARD-2                                          02370002
               INTO WS-CONTROL-CARD-2                                   02380002
                   AT END                                               02390002
                       SET CONTROL-CARD-2-EOF TO TRUE.                  02400002
                                                                        02410002
           IF CONTROL-CARD-2-EOF                                        02420002
               DISPLAY '***********************************'            02430002
               DISPLAY '***  ABEND MLKUT486                '            02440002
               DISPLAY '***  A1200-READ-CONTROL-CARD-2     '            02450002
               DISPLAY '***********************************'            02460002
               SET CONTROL-CARD-MISSING       TO TRUE                   02470002
               CALL 'ILBOABN0' USING WS-ABEND-CODE                      02480002
           END-IF.                                                      02490002
                                                                        02500002
       A1200-EXIT.                                                      02510002
           EXIT.                                                        02520002
                                                                        02530002
                                                                        02540003
       A1300-READ-CONTROL-CARD-3.                                       02550003
                                                                        02560003
      *  OBTAIN THE INPUT QUEUE NAME                                    02570003
                                                                        02580003
           MOVE SPACES TO WS-CONTROL-CARD-3.                            02590003
                                                                        02600003
           READ CONTROL-CARD-3                                          02610003
               INTO WS-CONTROL-CARD-3                                   02620003
                   AT END                                               02630003
                       SET CONTROL-CARD-3-EOF TO TRUE.                  02640003
                                                                        02650003
           IF WS-TEST-REREAD OR                                         02660003
              WS-TEST-COMMIT OR                                         02670003
              WS-PROD-COMMIT                                            02680003
               DISPLAY '****************************************'       02690003
               DISPLAY '***  Control card 3 is set up with the  '       02700003
               DISPLAY '***  MQSERIES queue action of : ' WS-MQ-ACTION  02710003
               DISPLAY '***    (NOTE : MQBACKT will not delete  '       02720003
               DISPLAY '***                    queue messages   '       02730003
               DISPLAY '***            MQCMITT or               '       02740003
               DISPLAY '***            MQCMITQ will delete      '       02750003
               DISPLAY '***                    queue messages   '       02760003
               DISPLAY '****************************************'       02770003
           END-IF.                                                      02780003
                                                                        02790003
           IF CONTROL-CARD-3-EOF                                        02800003
               DISPLAY '***********************************'            02810003
               DISPLAY '***  ABEND MLKUT486                '            02820003
               DISPLAY '***  A1200-READ-CONTROL-CARD-3     '            02830003
               DISPLAY '***********************************'            02840003
               SET CONTROL-CARD-MISSING       TO TRUE                   02850003
               CALL 'ILBOABN0' USING WS-ABEND-CODE                      02860003
           END-IF.                                                      02870003
                                                                        02880003
       A1300-EXIT.                                                      02890003
           EXIT.                                                        02900003
                                                                        02910002
       A1400-MQCONN.                                                    02920003
                                                                        02930002
           MOVE WS-QMGR-NAME TO WS-QM-NAME.                             02940002
           CALL WS-MQCONN USING WS-QM-NAME                              02950002
                                WS-HCONN                                02960002
                                WS-COMPLETION-CODE                      02970002
                                WS-REASON-CODE.                         02980002
                                                                        02990002
           IF WS-COMPLETION-CODE = MQCC-OK                              03000002
               NEXT SENTENCE                                            03010002
           ELSE                                                         03020002
               MOVE WS-COMPLETION-CODE  TO WS-COMP-CODE1                03030002
               MOVE WS-COMP-CODE1       TO WS-COMP-CODE2                03040002
               MOVE WS-COMP-CODE2       TO WS-COMP-CODE3                03050002
               MOVE WS-REASON-CODE      TO WS-REASON-CODE1              03060002
               MOVE WS-REASON-CODE1     TO WS-REASON-CODE2              03070002
               MOVE WS-REASON-CODE2     TO WS-REASON-CODE3              03080002
               DISPLAY '***********************************'            03090002
               DISPLAY '***  ABEND MLKUT486 - A1400-MQCONN '            03100003
               DISPLAY '***  MQ COMPLETION CODE: ' WS-COMP-CODE3        03110002
               DISPLAY '***  MQ REASON CODE:     ' WS-REASON-CODE3      03120002
               DISPLAY '***********************************'            03130002
               SET MQ-ERROR             TO TRUE                         03140002
               CALL 'ILBOABN0' USING WS-ABEND-CODE                      03150002
           END-IF.                                                      03160002
                                                                        03170002
       A1400-EXIT.                                                      03180003
           EXIT.                                                        03190002
                                                                        03200002
                                                                        03210002
       A1500-MQOPEN.                                                    03220003
                                                                        03230002
           MOVE WS-QMGR-NAME             TO MQOD-OBJECTQMGRNAME.        03240002
           MOVE WS-QUEUE-NAME            TO MQOD-OBJECTNAME.            03250002
           COMPUTE WS-OPEN-OPTIONS = MQOO-INPUT-SHARED +                03260002
                                     MQOO-FAIL-IF-QUIESCING.            03270002
                                                                        03280002
           CALL WS-MQOPEN USING WS-HCONN                                03290002
                                MQM-OBJECT-DESCRIPTOR                   03300002
                                WS-OPEN-OPTIONS                         03310002
                                WS-OBJECT-HANDLE                        03320002
                                WS-COMPLETION-CODE                      03330002
                                WS-REASON-CODE.                         03340002
                                                                        03350002
           IF WS-COMPLETION-CODE = MQCC-OK                              03360002
               NEXT SENTENCE                                            03370002
           ELSE                                                         03380002
               MOVE WS-COMPLETION-CODE  TO WS-COMP-CODE1                03390002
               MOVE WS-COMP-CODE1       TO WS-COMP-CODE2                03400002
               MOVE WS-COMP-CODE2       TO WS-COMP-CODE3                03410002
               MOVE WS-REASON-CODE      TO WS-REASON-CODE1              03420002
               MOVE WS-REASON-CODE1     TO WS-REASON-CODE2              03430002
               MOVE WS-REASON-CODE2     TO WS-REASON-CODE3              03440002
               DISPLAY '***********************************'            03450002
               DISPLAY '***  ABEND MLKUT486 - A1500-MQOPEN '            03460003
               DISPLAY '***  MQ COMPLETION CODE: ' WS-COMP-CODE3        03470002
               DISPLAY '***  MQ REASON CODE:     ' WS-REASON-CODE3      03480002
               DISPLAY '***********************************'            03490002
               PERFORM U9000-MQDISC                                     03500002
                  THRU U9000-EXIT                                       03510002
               SET MQ-ERROR        TO TRUE                              03520002
               CALL 'ILBOABN0' USING WS-ABEND-CODE                      03530002
           END-IF.                                                      03540002
                                                                        03550002
       A1500-EXIT.                                                      03560003
           EXIT.                                                        03570002
                                                                        03580002
                                                                        03590002
       B1000-PROCESS-MESSAGES.                                          03600002
                                                                        03610002
           PERFORM B1100-MQGET                                          03620002
              THRU B1100-EXIT.                                          03630002
                                                                        03640002
           IF MQGET-MORE-MSG                                            03650002
               PERFORM B1200-WRITE-ITEM-RECORD                          03660002
                  THRU B1200-EXIT                                       03670002
           ELSE                                                         03680002
               EVALUATE TRUE                                            03690003
      *           TO BE ABLE TO REREAD MESSAGES IN THE QUEUE            03700003
                  WHEN WS-TEST-REREAD                                   03710003
                      PERFORM U9200-MQBACK                              03720003
                         THRU U9200-EXIT                                03730003
      *           TO DELETE MESSAGES IN THE QUEUE                       03740003
                  WHEN (WS-TEST-COMMIT OR                               03750003
                        WS-PROD-COMMIT)                                 03760003
                      PERFORM B1300-MQCMIT                              03770003
                         THRU B1300-EXIT                                03780003
               END-EVALUATE                                             03790003
           END-IF.                                                      03800002
                                                                        03810002
       B1000-EXIT.                                                      03820002
           EXIT.                                                        03830002
                                                                        03840002
                                                                        03850002
       B1100-MQGET.                                                     03860002
                                                                        03870002
      *  MQGET LEAVES THE RECORD IN THE QUEUE BUT MARKS IT              03880002
      *  AS HAVING BEEN "READ"                                          03890002
                                                                        03900002
           INITIALIZE WS-MSGBUFFER.                                     03910002
           MOVE WS-QUEUE-NAME            TO MQOD-OBJECTNAME.            03920002
           MOVE MQMI-NONE                TO MQMD-MSGID.                 03930002
           MOVE MQCI-NONE                TO MQMD-CORRELID.              03940002
      *    MOVE 60000                    TO MQGMO-WAITINTERVAL.         03950002
           COMPUTE MQGMO-OPTIONS  = MQGMO-SYNCPOINT +                   03960002
                                    MQGMO-CONVERT +                     03970002
                                    MQGMO-WAIT.                         03980002
                                                                        03990002
           CALL WS-MQGET USING WS-HCONN                                 04000002
                               WS-OBJECT-HANDLE                         04010002
                               MQM-MESSAGE-DESCRIPTOR                   04020002
                               MQM-GET-MESSAGE-OPTIONS                  04030002
                               WS-MSGLENGTH                             04040002
                               WS-MSGBUFFER                             04050002
                               WS-DATA-LENGTH                           04060002
                               WS-COMPLETION-CODE                       04070002
                               WS-REASON-CODE.                          04080002
                                                                        04090002
           IF WS-COMPLETION-CODE = MQCC-OK                              04100002
               MOVE WS-MSGBUFFER TO IMRD008-RECORD                      04110002
           ELSE                                                         04120002
               IF WS-REASON-CODE = MQRC-NO-MSG-AVAILABLE                04130002
                   SET MQGET-NO-MORE-MSG TO TRUE                        04140002
               ELSE                                                     04150002
                   MOVE WS-COMPLETION-CODE  TO WS-COMP-CODE1            04160002
                   MOVE WS-COMP-CODE1       TO WS-COMP-CODE2            04170002
                   MOVE WS-COMP-CODE2       TO WS-COMP-CODE3            04180002
                   MOVE WS-REASON-CODE      TO WS-REASON-CODE1          04190002
                   MOVE WS-REASON-CODE1     TO WS-REASON-CODE2          04200002
                   MOVE WS-REASON-CODE2     TO WS-REASON-CODE3          04210002
                   DISPLAY '***********************************'        04220002
                   DISPLAY '***  ABEND MLKUT486 - B1100-MQGET  '        04230002
                   DISPLAY '***  MQ COMPLETION CODE: ' WS-COMP-CODE3    04240002
                   DISPLAY '***  MQ REASON CODE:     ' WS-REASON-CODE3  04250002
                   DISPLAY '***********************************'        04260002
                   PERFORM U9200-MQBACK                                 04270002
                      THRU U9200-EXIT                                   04280002
                   PERFORM U9100-MQCLOSE                                04290002
                      THRU U9100-EXIT                                   04300002
                   PERFORM U9000-MQDISC                                 04310002
                      THRU U9000-EXIT                                   04320002
                   SET MQ-ERROR             TO TRUE                     04330002
                   CALL 'ILBOABN0' USING WS-ABEND-CODE                  04340002
               END-IF                                                   04350002
           END-IF.                                                      04360002
                                                                        04370002
       B1100-EXIT.                                                      04380002
           EXIT.                                                        04390002
                                                                        04400002
                                                                        04410002
       B1200-WRITE-ITEM-RECORD.                                         04420002
                                                                        04430002
           WRITE ITEM-RECORD FROM IMRD008-RECORD.                       04440002
                                                                        04450002
           ADD 1 TO WS-RCDS-WRITTEN.                                    04460002
982230     ADD 1 TO WS-COMMIT-RECS-ACC.                                 04470007
982230                                                                  04470107
982230     IF (WS-TEST-COMMIT OR WS-PROD-COMMIT)                        04470209
982230       IF WS-COMMIT-RECS-ACC > PC-MAX-COMMITS                     04470409
982230         PERFORM B1300-MQCMIT                                     04471007
982230            THRU B1300-EXIT                                       04472007
982230         MOVE ZEROS  TO WS-COMMIT-RECS-ACC                        04472107
982230       END-IF                                                     04472209
982230     END-IF.                                                      04472309
982230                                                                  04473007
       B1200-EXIT.                                                      04480002
           EXIT.                                                        04490002
                                                                        04500002
                                                                        04510002
       B1300-MQCMIT.                                                    04520002
                                                                        04530002
      *  MQCMIT DELETES THE RECORD FROM THE QUEUE - IT CANNOT           04540002
      *  BE REREAD AFTER THIS                                           04550002
                                                                        04560002
           CALL WS-MQCMIT USING WS-HCONN                                04570002
                                WS-COMPLETION-CODE                      04580002
                                WS-REASON-CODE.                         04590002
                                                                        04600002
           IF WS-COMPLETION-CODE = MQCC-OK                              04610002
               NEXT SENTENCE                                            04620002
           ELSE                                                         04630002
               MOVE WS-COMPLETION-CODE  TO WS-COMP-CODE1                04640002
               MOVE WS-COMP-CODE1       TO WS-COMP-CODE2                04650002
               MOVE WS-COMP-CODE2       TO WS-COMP-CODE3                04660002
               MOVE WS-REASON-CODE      TO WS-REASON-CODE1              04670002
               MOVE WS-REASON-CODE1     TO WS-REASON-CODE2              04680002
               MOVE WS-REASON-CODE2     TO WS-REASON-CODE3              04690002
               DISPLAY '***********************************'            04700002
               DISPLAY '***  ABEND MLKUT486 - B1300-MQCMIT '            04710002
               DISPLAY '***  MQ COMPLETION CODE: ' WS-COMP-CODE3        04720002
               DISPLAY '***  MQ REASON CODE:     ' WS-REASON-CODE3      04730002
               DISPLAY '***********************************'            04740002
               PERFORM U9200-MQBACK                                     04750002
                  THRU U9200-EXIT                                       04760002
               SET MQ-ERROR             TO TRUE                         04770002
               CALL 'ILBOABN0' USING WS-ABEND-CODE                      04780002
           END-IF.                                                      04790002
                                                                        04800002
       B1300-EXIT.                                                      04810002
           EXIT.                                                        04820002
                                                                        04830002
                                                                        04840002
       C1000-EOJ-PROCESSING.                                            04850002
                                                                        04860002
           CLOSE ITEM-FILE.                                             04870002
                                                                        04880002
           PERFORM U9100-MQCLOSE                                        04890002
              THRU U9100-EXIT.                                          04900002
           PERFORM U9000-MQDISC                                         04910002
              THRU U9000-EXIT.                                          04920002
                                                                        04930002
           MOVE WS-RCDS-WRITTEN TO WS-RCDS-WRITTEN1.                    04940002
           DISPLAY '**************************************************'.04950002
           DISPLAY 'SUCCESSFUL END OF MLKUT486'.                        04960002
           DISPLAY 'RECORDS WRITTEN:' WS-RCDS-WRITTEN1.                 04970002
           DISPLAY '**************************************************'.04980002
                                                                        04990002
       C1000-EXIT.                                                      05000002
           EXIT.                                                        05010002
                                                                        05020002
                                                                        05030002
       U9000-MQDISC.                                                    05040002
                                                                        05050002
           CALL WS-MQDISC USING WS-HCONN                                05060002
                                WS-COMPLETION-CODE                      05070002
                                WS-REASON-CODE.                         05080002
                                                                        05090002
           IF WS-COMPLETION-CODE = MQCC-OK                              05100002
               NEXT SENTENCE                                            05110002
           ELSE                                                         05120002
               MOVE WS-COMPLETION-CODE  TO WS-COMP-CODE1                05130002
               MOVE WS-COMP-CODE1       TO WS-COMP-CODE2                05140002
               MOVE WS-COMP-CODE2       TO WS-COMP-CODE3                05150002
               MOVE WS-REASON-CODE      TO WS-REASON-CODE1              05160002
               MOVE WS-REASON-CODE1     TO WS-REASON-CODE2              05170002
               MOVE WS-REASON-CODE2     TO WS-REASON-CODE3              05180002
               DISPLAY '***********************************'            05190002
               DISPLAY '***  ABEND MLKUT486 - U9000-MQDISC '            05200002
               DISPLAY '***  MQ COMPLETION CODE: ' WS-COMP-CODE3        05210002
               DISPLAY '***  MQ REASON CODE:     ' WS-REASON-CODE3      05220002
               DISPLAY '***********************************'            05230002
               SET MQ-ERROR             TO TRUE                         05240002
               CALL 'ILBOABN0' USING WS-ABEND-CODE                      05250002
           END-IF.                                                      05260002
                                                                        05270002
       U9000-EXIT.                                                      05280002
           EXIT.                                                        05290002
                                                                        05300002
                                                                        05310002
       U9100-MQCLOSE.                                                   05320002
                                                                        05330002
           CALL WS-MQCLOSE USING WS-HCONN                               05340002
                                 WS-OBJECT-HANDLE                       05350002
                                 MQCO-NONE                              05360002
                                 WS-COMPLETION-CODE                     05370002
                                 WS-REASON-CODE.                        05380002
                                                                        05390002
           IF WS-COMPLETION-CODE = MQCC-OK                              05400002
               NEXT SENTENCE                                            05410002
           ELSE                                                         05420002
               MOVE WS-COMPLETION-CODE  TO WS-COMP-CODE1                05430002
               MOVE WS-COMP-CODE1       TO WS-COMP-CODE2                05440002
               MOVE WS-COMP-CODE2       TO WS-COMP-CODE3                05450002
               MOVE WS-REASON-CODE      TO WS-REASON-CODE1              05460002
               MOVE WS-REASON-CODE1     TO WS-REASON-CODE2              05470002
               MOVE WS-REASON-CODE2     TO WS-REASON-CODE3              05480002
               DISPLAY '***********************************'            05490002
               DISPLAY '***  ABEND MLKUT486 - U9100-MQCLOSE'            05500002
               DISPLAY '***  MQ COMPLETION CODE: ' WS-COMP-CODE3        05510002
               DISPLAY '***  MQ REASON CODE:     ' WS-REASON-CODE3      05520002
               DISPLAY '***********************************'            05530002
               SET MQ-ERROR             TO TRUE                         05540002
               CALL 'ILBOABN0' USING WS-ABEND-CODE                      05550002
           END-IF.                                                      05560002
                                                                        05570002
       U9100-EXIT.                                                      05580002
           EXIT.                                                        05590002
                                                                        05600002
                                                                        05610002
       U9200-MQBACK.                                                    05620002
                                                                        05630002
      *  WHEN MQBACK IS DONE, ALL RECORDS MARKED AS "READ" WILL         05640002
      *  BE CHANGED BACK TO "UNREAD" SO THE PROGRAM CAN BE RESTARTED.   05650002
                                                                        05660002
           CALL WS-MQBACK USING WS-HCONN                                05670002
                                WS-COMPLETION-CODE                      05680002
                                WS-REASON-CODE.                         05690002
                                                                        05700002
           IF WS-COMPLETION-CODE = MQCC-OK                              05710002
               NEXT SENTENCE                                            05720002
           ELSE                                                         05730002
               MOVE WS-COMPLETION-CODE  TO WS-COMP-CODE1                05740002
               MOVE WS-COMP-CODE1       TO WS-COMP-CODE2                05750002
               MOVE WS-COMP-CODE2       TO WS-COMP-CODE3                05760002
               MOVE WS-REASON-CODE      TO WS-REASON-CODE1              05770002
               MOVE WS-REASON-CODE1     TO WS-REASON-CODE2              05780002
               MOVE WS-REASON-CODE2     TO WS-REASON-CODE3              05790002
               DISPLAY '***********************************'            05800002
               DISPLAY '***  ABEND MLKUT486 - U9200-MQBACK '            05810002
               DISPLAY '***  MQ COMPLETION CODE: ' WS-COMP-CODE3        05820002
               DISPLAY '***  MQ REASON CODE:     ' WS-REASON-CODE3      05830002
               DISPLAY '***********************************'            05840002
               SET MQ-ERROR        TO TRUE                              05850002
               CALL 'ILBOABN0' USING WS-ABEND-CODE                      05860002
           END-IF.                                                      05870002
                                                                        05880002
       U9200-EXIT.                                                      05890002
           EXIT.                                                        05900002
