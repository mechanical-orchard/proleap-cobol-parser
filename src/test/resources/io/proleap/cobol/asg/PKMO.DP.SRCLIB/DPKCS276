000100 IDENTIFICATION DIVISION.                                         00010020
000200 TITLE 'OPEN TO RECEIVE CALCULATION MODULE'.                      00020020
000300*                                                                 00030020
000400*********************************************************         00040020
000500* *   IF ANY CHANGES ARE MADE TO THIS PROGRAM         * *         00050020
000600* *   BE SURE TO CHECK THE BATCH PROGRAM (TMKUT017)   * *         00060020
000700* *   TO SEE IF THE SAME CHANGE SHOULD BE MADE        * *         00070020
000800*********************************************************         00080020
000900*                                                                 00090020
001000 PROGRAM-ID.    DPKCS276.                                         00100020
001100 AUTHOR.        DENNIS STEFFEN - OMNI RESOURCES.                  00110020
001200 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00120020
001300 DATE-WRITTEN.  DECEMBER 1995.                                    00130020
001400 DATE-COMPILED.                                                   00140020
001500***************************************************************** 00150000
001600* Change History                                                * 00160020
001700*    CHANGES                                                    * 00170020
001800*     MADE BY: PRITHIVIRAJ SUBRAMANIAN (COGNIZANT)              * 00180020
001900*     DATE:    10/15/2014                                       * 00190020
002000*                                                               * 00200020
002100*      CHANGES THRU OUT THE PROGRAM TO INCREASE THE SIZE OF PO# * 00210020
002101*      FROM 7 DIGITS TO 8 DIGITS. TAGGED WITH *PS 10/15/2014    * 00210120
002102***************************************************************** 00210200
002103 ENVIRONMENT DIVISION.                                            00210320
002104 CONFIGURATION SECTION.                                           00210420
002105 SOURCE-COMPUTER.        IBM-3090.                                00210520
002106 OBJECT-COMPUTER.        IBM-3090.                                00210620
002107 DATA DIVISION.                                                   00210720
002108 WORKING-STORAGE SECTION.                                         00210820
002109                                                                  00210920
002110 01  COUNTERS-AND-STUFF.                                          00211020
002120     10  PV-APP-LINE-NBR         PIC S9(9) COMP VALUE ZERO.       00212020
002130     10  PV-RECEIVED-QTY         PIC S9(9) COMP VALUE ZERO.       00213020
002140     10  PV-SUM-QTY              PIC S9(9) COMP VALUE ZERO.       00214020
002150*PS 10/15/2014 CHANGE STARTS                                      00215020
002160     10  PV-DISP-PO-NBR          PIC 9(8).                        00216020
002170*PS 10/15/2014 CHANGE ENDS                                        00217020
002180     10  PV-DISP-REC-SEQ-NBR     PIC 9(4).                        00218020
002190     10  PV-DISP-PO-LNE-NBR      PIC 9(3).                        00219020
002200     10  PV-DISP-OPER-UNT-ID     PIC 9(4).                        00220020
002300     10  PV-DISP-FCLTY-ID        PIC 9(4).                        00230020
002400     10  PV-DISP-STR-NBR         PIC 9(4).                        00240020
002500     10  PV-RETURN-MSG           PIC X(40).                       00250020
002600     10  PV-SQLCODE               PIC S9(9) COMP-4.               00260020
002700     10  PV-DISPLAY-SQLCODE       PIC -Z(8)9.                     00270020
002800     10  PV-DISPLAY-QTY           PIC Z(4)9.                      00280020
002900                                                                  00290020
003000 01  PROGRAM-SWITCHES.                                            00300020
003100     05  PS-ERRORS-SW                 PIC  X    VALUE 'N'.        00310020
003200         88  PS-NO-ERRORS                       VALUE 'N'.        00320020
003300         88  PS-YES-ERRORS                      VALUE 'Y'.        00330020
003400     05  PS-EOF-PLAN-CSR-SW           PIC  X    VALUE 'N'.        00340020
003500         88  PS-EOF-PLAN-CSR                    VALUE 'Y'.        00350020
003600     05  PS-EOF-BASE-CSR-SW           PIC  X    VALUE 'N'.        00360020
003700         88  PS-EOF-BASE-CSR                    VALUE 'Y'.        00370020
003800     05  PS-EOF-PRIOR-CURSOR-SW       PIC  X    VALUE 'N'.        00380020
003900         88  PS-START-PRIOR-CURSOR              VALUE 'N'.        00390020
004000         88  PS-EOF-PRIOR-CURSOR                VALUE 'Y'.        00400020
004100     05  PS-CURSOR-OPEN-SW            PIC  X    VALUE 'N'.        00410020
004200         88  PS-CURSOR-CLOSED                   VALUE 'N'.        00420020
004300         88  PS-CURSOR-OPEN                     VALUE 'Y'.        00430020
004400     05  PS-LINE-DISTRO-SW            PIC  X    VALUE 'Y'.        00440020
004500         88  PS-LINE-HAS-DISTRO                 VALUE 'Y'.        00450020
004600         88  PS-LINE-HAS-NO-DISTRO              VALUE 'N'.        00460020
004700                                                                  00470020
004800 01  PROGRAM-KEYS.                                                00480020
004900     05  DK-PO-NBR               PIC S9(9) COMP VALUE ZERO.       00490020
005000     05  DK-LINE-NBR             PIC S9(9) COMP VALUE ZERO.       00500020
005100     05  DK-STAT-CDE-AP          PIC  X(02)  VALUE 'AP'.          00510020
005200     05  DK-STAT-CDE-AC          PIC  X(02)  VALUE 'AC'.          00520020
005300     05  DK-STAT-CDE-CM          PIC  X(02)  VALUE 'CM'.          00530020
005400     05  DK-STAT-CDE-RV          PIC  X(02)  VALUE 'RV'.          00540020
005500                                                                  00550020
005600 01  PROGRAM-LITERALS.                                            00560020
005700     05  PC-CURRENT-PROGRAM-NAME PIC X(8)  VALUE 'DPKCS276'.      00570020
005800     05  PC-A                    PIC X     VALUE 'A'.             00580020
005900     05  PC-Y                    PIC X     VALUE 'Y'.             00590020
006000     05  PC-AC                   PIC X(2)  VALUE 'AC'.            00600020
006100     05  PC-IP                   PIC X(2)  VALUE 'IP'.            00610020
006200     05  PC-CM                   PIC X(2)  VALUE 'CM'.            00620020
006300     05  PC-VE                   PIC X(2)  VALUE 'VE'.            00630020
006400     05  PC-SHORT-ONE            PIC S9(4) COMP VALUE +1.         00640020
006500*    MAX OCCURRENCES ARE SET TO THIS VALUE TO KEEP UNDER THE 32K  00650020
006600*    LIMIT FOR CICS LINK                                          00660020
006700     05  PC-MAX-OCCURENCES       PIC S9(5) VALUE +1450            00670020
006800                                                COMP-3.           00680020
006900     05  PC-NULL-TMST            PIC X(26) VALUE                  00690020
007000                       '0001-01-01-00.00.00.000000'.              00700020
007100     05  PC-TSYMSG-00551         PIC  9(05)  VALUE 00551.         00710020
007200     05  PC-TSYMSG-01096         PIC  9(05)  VALUE 01096.         00720020
007300/                                                                 00730020
007400     COPY DPWS276.                                                00740020
007500/                                                                 00750020
007600     COPY DPWS013.                                                00760020
007700     COPY DPWS020.                                                00770020
007800/                                                                 00780020
007900******************************************************************00790020
008000*    DB2 SQL COMMUNICATION AREA                                   00800020
008100******************************************************************00810020
008200     EXEC SQL                                                     00820020
008300          INCLUDE SQLCA                                           00830020
008400     END-EXEC.                                                    00840020
008500/                                                                 00850020
008600******************************************************************00860020
008700*    DB2 DCLGEN FOR MERCHANDISE STORE ALLOCATION PLAN TABLE       00870020
008800******************************************************************00880020
008900     EXEC SQL                                                     00890020
009000          INCLUDE TALLPLN                                         00900020
009100     END-EXEC.                                                    00910020
009200/                                                                 00920020
009300******************************************************************00930020
009400*    DB2 DCLGEN FOR MERCHANDISE STORE DISTRIBUTION PLAN TABLE     00940020
009500******************************************************************00950020
009600     EXEC SQL                                                     00960020
009700          INCLUDE TMESTDS                                         00970020
009800     END-EXEC.                                                    00980020
009900/                                                                 00990020
010000******************************************************************01000020
010100*    DB2 DCLGEN FOR PO PURCHASE ITEM TABLE (PO LINE ITEMS)        01010020
010200******************************************************************01020020
010300     EXEC SQL                                                     01030020
010400          INCLUDE TPURITM                                         01040020
010500     END-EXEC.                                                    01050020
010600/                                                                 01060020
010700******************************************************************01070020
010800*    DB2 DCLGEN FOR RECEIVER TABLE                                01080020
010900******************************************************************01090020
011000     EXEC SQL                                                     01100020
011100          INCLUDE TRECEIV                                         01110020
011200     END-EXEC.                                                    01120020
011300/                                                                 01130020
011400******************************************************************01140020
011500*    DB2 DCLGEN FOR RECEIPT DISTRIBUTION TABLE                    01150020
011600******************************************************************01160020
011700     EXEC SQL                                                     01170020
011800          INCLUDE TRECDIS                                         01180020
011900     END-EXEC.                                                    01190020
012000/                                                                 01200020
012100******************************************************************01210020
012200*    DB2 DCLGEN FOR RECEIVER ITEM                                 01220020
012300******************************************************************01230020
012400     EXEC SQL                                                     01240020
012500          INCLUDE TRECITM                                         01250020
012600     END-EXEC.                                                    01260020
012700/                                                                 01270020
012800******************************************************************01280020
012900******************************************************************01290020
013000*                   BASE NUMBER CURSORS                           01300020
013100*                 ************************                        01310020
013200*    THESE CURSORS ARE USED TO POPULATE                           01320020
013300*    DP276-STORE-NBR OR DP276-LINE-NBR AND                        01330020
013400*    DP276-STR-DISTRO-QTY FOR EACH STORE OR LINE.                 01340020
013500*    SUBTRACTING ALL RECEIPTS FROM THIS WILL GIVE THE OTR.        01350020
013600******************************************************************01360020
013700******************************************************************01370020
013800*    BASE-STORE NUMBER CURSOR                                     01380020
013900*    A LIST OF STORES AND THEIR QTYS FOR A PO, LINE, AND PLAN     01390020
014000*    THIS IS THE BASIS FOR DP276-OTR-TABLE                        01400020
014100******************************************************************01410020
014200     EXEC SQL                                                     01420020
014300          DECLARE BASE-STORE-CSR CURSOR FOR                       01430020
014400          SELECT STR_NBR                                          01440020
014500               , STR_DISTRO_QTY                                   01450020
014600            FROM TMESTDS                                          01460020
014700           WHERE PO_NBR     = :DP276-PO-NBR                       01470020
014800             AND PO_LNE_NBR = :DP276-PO-LNE-NBR                   01480020
014900             AND PLAN_NBR   = :ALLPLN-PLAN-NBR                    01490020
015000     END-EXEC.                                                    01500020
015100                                                                  01510020
015200*  THIS CURSOR IS THE BASIS FOR DP276-OTR-TABLE                   01520020
015300                                                                  01530020
015400     EXEC SQL                                                     01540020
015500         DECLARE PLAN-CSR CURSOR FOR                              01550020
015600         SELECT A.PO_LNE_NBR                                      01560020
015700              , A.APP_PO_LNE_NBR                                  01570020
015800           FROM TPURITM A                                         01580020
015900          WHERE  A.PO_NBR        = :DP276-PO-NBR                  01590020
016000             AND  (STATUS_CDE    = :DK-STAT-CDE-AP                01600020
016100              OR   STATUS_CDE    = :DK-STAT-CDE-CM                01610020
016200              OR   STATUS_CDE    = :DK-STAT-CDE-AC                01620020
016300              OR   STATUS_CDE    = :DK-STAT-CDE-RV)               01630020
016400             AND  VER_STATUS_CDE = :PC-A                          01640020
016500     END-EXEC.                                                    01650020
016600                                                                  01660020
016700/                                                                 01670020
016800******************************************************************01680020
016900******************************************************************01690020
017000*                     RECEIPT CURSORS                             01700020
017100*                 ************************                        01710020
017200*    THESE CURSORS ARE USED RETRIEVE THE PRIOR RECEIPTS TO BE     01720020
017300*    SUBTRACTED FROM DP276-OTR-QTY.                               01730020
017400*    RECEIVER-LEVEL PRIOR RECEIPTS ARE DEFINED AS ANY 'VE'        01740020
017500*    RECEIPT OR 'IP'/'CM' RECEIPT CREATED PRIOR TO THE GIVEN      01750020
017600*    RECEIVER.                                                    01760020
017700*                                                                 01770020
017800*    PO-LEVEL PRIOR RECEIPTS INCLUDE ALL RECEIPTS INCLUDING       01780020
017900*    THE GIVEN RECEIVER.                                          01790020
018000*                                                                 01800020
018100******************************************************************01810020
018200******************************************************************01820020
018300                                                                  01830020
018400******************************************************************01840020
018500*    RECEIVER LEVEL VE CURSOR                                     01850020
018600*    THIS IS A LIST OF RECEIVERS FOR A PO, LINE, AND DC THAT      01860020
018700*    ARE EITHER VERIFIED OR HAD BEEN CREATED PRIOR TO THE         01870020
018800*    CURRENT DATE AND TIME.                                       01880020
018900*    USED IN PARAGRAPH 1300-                                      01890020
019000******************************************************************01900020
019100     EXEC SQL                                                     01910020
019200          DECLARE REC-LVL-VE-CSR CURSOR FOR                       01920020
019300          SELECT  REC_SEQ_NBR                                     01930020
019400                , STATUS_CDE                                      01940020
019500            FROM TRECITM                                          01950020
019600           WHERE ORD_NBR         = :DP276-PO-NBR                  01960020
019700             AND ORD_LNE_NBR     = :DK-LINE-NBR                   01970020
019800             AND OPER_UNT_ID     = :DP276-OPER-UNT-ID             01980020
019900             AND REC_SEQ_NBR    ^= :DP276-REC-SEQ-NBR             01990020
020000             AND VER_STATUS_CDE  = :PC-A                          02000020
020100             AND (CRE_TMST       < :RECITM-CRE-TMST OR            02010020
020200                  STATUS_CDE     = :PC-VE)                        02020020
020300           ORDER BY 1                                             02030020
020400     END-EXEC.                                                    02040020
020500                                                                  02050020
020600******************************************************************02060020
020700*    PO LEVEL IP CURSOR                                           02070020
020800*    THIS IS A LIST OF RECEIVERS AND THEIR STATUSES FOR A         02080020
020900*    PO, LINE AND DC REGARDLESS OF CREATION TIME.                 02090020
021000******************************************************************02100020
021100     EXEC SQL                                                     02110020
021200          DECLARE PO-LVL-IP-CSR CURSOR FOR                        02120020
021300          SELECT REC_SEQ_NBR                                      02130020
021400               , STATUS_CDE                                       02140020
021500            FROM TRECITM                                          02150020
021600           WHERE ORD_NBR         = :DP276-PO-NBR                  02160020
021700             AND ORD_LNE_NBR     = :DK-LINE-NBR                   02170020
021800             AND OPER_UNT_ID     = :DP276-OPER-UNT-ID             02180020
021900             AND VER_STATUS_CDE  = :PC-A                          02190020
022000             AND STATUS_CDE     IN (:PC-IP, :PC-CM, :PC-VE)       02200020
022100           ORDER BY 1                                             02210020
022200     END-EXEC.                                                    02220020
022300/                                                                 02230020
022400 LINKAGE SECTION.                                                 02240020
022500                                                                  02250020
022600 01  DFHCOMMAREA.                                                 02260020
022700     05  FILLER                       OCCURS 1 TO 15000 TIMES     02270020
022800                                      DEPENDING ON EIBCALEN.      02280020
022900         10  FILLER                   PIC X.                      02290020
023000                                                                  02300020
023100/                                                                 02310020
023200 PROCEDURE DIVISION.                                              02320020
023300                                                                  02330020
023400     PERFORM 0001-HOUSEKEEPING.                                   02340020
023500                                                                  02350020
023600     EVALUATE TRUE                                                02360020
023700     WHEN DP276-STORE-LEVEL-OTR OR DP276-PACK-BY-STORE            02370020
023800         PERFORM 1000-STORE-LEVEL-OTR                             02380020
023900     WHEN DP276-LINE-LEVEL-OTR                                    02390020
024000         PERFORM 2000-LINE-LEVEL-OTR                              02400020
024100     WHEN OTHER                                                   02410020
024200         STRING ' INVALID OTR TYPE (' DP276-OTR-TYPE ')'          02420020
024300                 DELIMITED BY SIZE                                02430020
024400                                 INTO PV-RETURN-MSG               02440020
024500         MOVE 1                  TO DP276-RETURN-CODE             02450020
024600         PERFORM DP013-0000-PROCESS-ABEND                         02460020
024700     END-EVALUATE.                                                02470020
024800                                                                  02480020
024900     IF DP276-PACK-BY-STORE                                       02490020
025000         CONTINUE                                                 02500020
025100     ELSE                                                         02510020
025200         PERFORM VARYING DP276-IDX FROM 1 BY 1                    02520020
025300             UNTIL DP276-STORE-NBR(DP276-IDX) = ZERO OR           02530020
025400                   DP276-IDX > PC-MAX-OCCURENCES                  02540020
025500             IF DP276-OTR-QTY (DP276-IDX) < ZERO                  02550020
025600                 MOVE ZERO TO DP276-OTR-QTY (DP276-IDX)           02560020
025700             END-IF                                               02570020
025800         END-PERFORM                                              02580020
025900     END-IF.                                                      02590020
026000                                                                  02600020
026100     MOVE DP276-COMMAREA         TO DFHCOMMAREA.                  02610020
026200     GOBACK.                                                      02620020
026300                                                                  02630020
026400 0001-HOUSEKEEPING.                                               02640020
026500     MOVE DFHCOMMAREA            TO DP276-COMMAREA.               02650020
026600     INITIALIZE DP276-OTR-TABLE                                   02660020
026700                DP276-RETURN-DATA.                                02670020
026800/                                                                 02680020
026900 1000-STORE-LEVEL-OTR.                                            02690020
027000     MOVE DP276-PO-NBR           TO DK-PO-NBR                     02700020
027100     MOVE DP276-PO-LNE-NBR       TO DK-LINE-NBR                   02710020
027200     PERFORM 1100-GET-TALLPLN.                                    02720020
027300                                                                  02730020
027400     IF PS-NO-ERRORS                                              02740020
027500         PERFORM 1200-FILL-BASE-NUMBERS                           02750020
027600     END-IF.                                                      02760020
027700                                                                  02770020
027800     IF PS-NO-ERRORS AND PS-LINE-HAS-DISTRO                       02780020
027900         PERFORM 1110-GET-APP-LINE-NBR                            02790020
028000         EVALUATE TRUE                                            02800020
028100             WHEN DP276-RECEIVER-OTR                              02810020
028200                 PERFORM 1300-RCVR-OTR                            02820020
028300             WHEN DP276-PO-OTR                                    02830020
028400                 PERFORM 1400-PO-OTR                              02840020
028500             WHEN OTHER                                           02850020
028600                 STRING ' INVALID OTR SCOPE FLAG ('               02860020
028700                         DP276-OTR-SCOPE                          02870020
028800                         ')'                                      02880020
028900                     DELIMITED BY SIZE                            02890020
029000                                   INTO PV-RETURN-MSG             02900020
029100                 MOVE 2          TO DP276-RETURN-CODE             02910020
029200                 PERFORM DP013-0000-PROCESS-ABEND                 02920020
029300         END-EVALUATE                                             02930020
029400     END-IF.                                                      02940020
029500/                                                                 02950020
029600 1100-GET-TALLPLN.                                                02960020
029700     EXEC SQL                                                     02970020
029800         SELECT PLAN_NBR                                          02980020
029900              , CURR_SPLIT_QTY                                    02990020
030000             INTO :ALLPLN-PLAN-NBR                                03000020
030100                 , :ALLPLN-CURR-SPLIT-QTY                         03010020
030200             FROM TALLPLN                                         03020020
030300             WHERE PO_NBR     = :DK-PO-NBR                        03030020
030400               AND PO_LNE_NBR = :DK-LINE-NBR                      03040020
030500               AND DEST_NBR   = :DP276-OPER-UNT-ID                03050020
030600*              AND DC_SPLIT_QTY > 0                               03060020
030700         END-EXEC                                                 03070020
030800                                                                  03080020
030900         EVALUATE TRUE                                            03090020
031000             WHEN SQLCODE = ZERO                                  03100020
031100                 SET PS-LINE-HAS-DISTRO                           03110020
031200                                 TO TRUE                          03120020
031300             WHEN SQLCODE = +100                                  03130020
031400                 SET PS-LINE-HAS-NO-DISTRO                        03140020
031500                                 TO TRUE                          03150020
031600                 MOVE 3          TO DP276-RETURN-CODE             03160020
031700                 PERFORM 9000-NO-DISTRO-ERROR                     03170020
031800             WHEN SQLCODE = -904                                  03180020
031900             WHEN SQLCODE = -911                                  03190020
032000             WHEN SQLCODE = -913                                  03200020
032100                 MOVE 4          TO DP276-RETURN-CODE             03210020
032200                 PERFORM 9900-SOFT-ABORT                          03220020
032300             WHEN OTHER                                           03230020
032400                 MOVE 5          TO DP276-RETURN-CODE             03240020
032500                 PERFORM 9800-CROAK                               03250020
032600         END-EVALUATE.                                            03260020
032700/                                                                 03270020
032800 1110-GET-APP-LINE-NBR.                                           03280020
032900*  THE APP LINE NUMBER MAY NOT BE THE SAME AS THE KEY LINE        03290020
033000*  NUMBER DUE TO PO LINES BEING DELETED.  THE RECEIVING SYSTEM    03300020
033100*  IS KEYED BY THE APPROVED LINE NUMBER.  THE PO SYSTEM IS KEYED  03310020
033200*  BY THE LINE NUMBER IN THE KEY.                                 03320020
033300                                                                  03330020
033400     EXEC SQL                                                     03340020
033500         SELECT A.APP_PO_LNE_NBR                                  03350020
033600             INTO :PV-APP-LINE-NBR                                03360020
033700             FROM TPURITM A                                       03370020
033800             WHERE A.PO_NBR         = :DP276-PO-NBR               03380020
033900               AND A.PO_LNE_NBR     = :DK-LINE-NBR                03390020
034000               AND A.VER_STATUS_CDE = :PC-A                       03400020
034100         END-EXEC                                                 03410020
034200                                                                  03420020
034300         EVALUATE TRUE                                            03430020
034400             WHEN SQLCODE = ZERO                                  03440020
034500                 CONTINUE                                         03450020
034600             WHEN SQLCODE = -904                                  03460020
034700             WHEN SQLCODE = -911                                  03470020
034800             WHEN SQLCODE = -913                                  03480020
034900                 MOVE 35         TO DP276-RETURN-CODE             03490020
035000                 PERFORM 9900-SOFT-ABORT                          03500020
035100             WHEN OTHER                                           03510020
035200                 MOVE 36         TO DP276-RETURN-CODE             03520020
035300                 PERFORM 9800-CROAK                               03530020
035400         END-EVALUATE.                                            03540020
035500/                                                                 03550020
035600 1200-FILL-BASE-NUMBERS.                                          03560020
035700                                                                  03570020
035800     PERFORM 1210-OPEN-BASE-STORE-CSR                             03580020
035900                                                                  03590020
036000     IF PS-NO-ERRORS AND PS-LINE-HAS-DISTRO                       03600020
036100         PERFORM 1220-FETCH-BASE-STORE-CSR                        03610020
036200         IF PS-EOF-BASE-CSR                                       03620020
036300             SET PS-YES-ERRORS                                    03630020
036400                 PS-LINE-HAS-NO-DISTRO                            03640020
036500                                 TO TRUE                          03650020
036600             MOVE 6              TO DP276-RETURN-CODE             03660020
036700             PERFORM 9000-NO-DISTRO-ERROR                         03670020
036800         END-IF                                                   03680020
036900     END-IF.                                                      03690020
037000                                                                  03700020
037100     IF PS-NO-ERRORS AND PS-LINE-HAS-DISTRO                       03710020
037200         PERFORM 1230-LOAD-TO-TABLE VARYING DP276-IDX             03720020
037300                   FROM 1 BY 1 UNTIL PS-EOF-BASE-CSR OR           03730020
037400                   PS-YES-ERRORS                                  03740020
037500                   OR DP276-IDX > PC-MAX-OCCURENCES               03750020
037600     END-IF.                                                      03760020
037700                                                                  03770020
037800     IF PS-CURSOR-OPEN                                            03780020
037900         PERFORM 1240-CLOSE-BASE-STORE-CSR                        03790020
038000     END-IF.                                                      03800020
038100/                                                                 03810020
038200 1210-OPEN-BASE-STORE-CSR.                                        03820020
038300     EXEC SQL                                                     03830020
038400          OPEN BASE-STORE-CSR                                     03840020
038500     END-EXEC.                                                    03850020
038600                                                                  03860020
038700     EVALUATE TRUE                                                03870020
038800         WHEN SQLCODE = ZERO                                      03880020
038900             SET PS-CURSOR-OPEN  TO TRUE                          03890020
039000         WHEN SQLCODE = -904                                      03900020
039100         WHEN SQLCODE = -911                                      03910020
039200         WHEN SQLCODE = -913                                      03920020
039300             SET PS-CURSOR-CLOSED                                 03930020
039400                                 TO TRUE                          03940020
039500             MOVE 7              TO DP276-RETURN-CODE             03950020
039600             PERFORM 9900-SOFT-ABORT                              03960020
039700         WHEN OTHER                                               03970020
039800             SET PS-CURSOR-CLOSED                                 03980020
039900                                 TO TRUE                          03990020
040000             MOVE 8              TO DP276-RETURN-CODE             04000020
040100             SET PS-LINE-HAS-NO-DISTRO                            04010020
040200                                 TO TRUE                          04020020
040300             PERFORM 9000-NO-DISTRO-ERROR                         04030020
040400         END-EVALUATE.                                            04040020
040500/                                                                 04050020
040600 1220-FETCH-BASE-STORE-CSR.                                       04060020
040700     EXEC SQL                                                     04070020
040800          FETCH BASE-STORE-CSR                                    04080020
040900          INTO :MESTDS-STR-NBR                                    04090020
041000             , :MESTDS-STR-DISTRO-QTY                             04100020
041100     END-EXEC.                                                    04110020
041200                                                                  04120020
041300     EVALUATE TRUE                                                04130020
041400         WHEN SQLCODE = ZERO                                      04140020
041500              CONTINUE                                            04150020
041600         WHEN SQLCODE = +100                                      04160020
041700             SET PS-EOF-BASE-CSR TO TRUE                          04170020
041800         WHEN OTHER                                               04180020
041900              MOVE 9             TO DP276-RETURN-CODE             04190020
042000             PERFORM 9000-NO-DISTRO-ERROR                         04200020
042100     END-EVALUATE.                                                04210020
042200/                                                                 04220020
042300 1230-LOAD-TO-TABLE.                                              04230020
042400     MOVE MESTDS-STR-NBR         TO DP276-STORE-NBR(DP276-IDX)    04240020
042500                                                                  04250020
042600     IF PS-LINE-HAS-NO-DISTRO                                     04260020
042700         MOVE ALL '*'            TO DP276-OTR-QTY-X               04270020
042800                                        (DP276-IDX)               04280020
042900         MOVE ZERO               TO PV-DISPLAY-QTY                04290020
043000         MOVE PV-DISPLAY-QTY     TO DP276-STR-DISTRO-QTY-X        04300020
043100                                    (DP276-IDX)                   04310020
043200         MOVE ZERO               TO DP276-STR-DISTRO-QTY          04320020
043300                                    (DP276-IDX)                   04330020
043400                                    DP276-OTR-QTY                 04340020
043500                                    (DP276-IDX)                   04350020
043600     ELSE                                                         04360020
043700         MOVE MESTDS-STR-DISTRO-QTY                               04370020
043800                                 TO DP276-STR-DISTRO-QTY          04380020
043900                                    (DP276-IDX)                   04390020
044000                                    DP276-OTR-QTY (DP276-IDX)     04400020
044100                                    PV-DISPLAY-QTY                04410020
044200         MOVE PV-DISPLAY-QTY     TO DP276-STR-DISTRO-QTY-X        04420020
044300                                    (DP276-IDX)                   04430020
044400                                    DP276-OTR-QTY-X               04440020
044500                                    (DP276-IDX)                   04450020
044600     END-IF.                                                      04460020
044700                                                                  04470020
044800     PERFORM 1220-FETCH-BASE-STORE-CSR.                           04480020
044900/                                                                 04490020
045000 1240-CLOSE-BASE-STORE-CSR.                                       04500020
045100     EXEC SQL                                                     04510020
045200          CLOSE BASE-STORE-CSR                                    04520020
045300     END-EXEC.                                                    04530020
045400                                                                  04540020
045500     EVALUATE TRUE                                                04550020
045600         WHEN SQLCODE = ZERO                                      04560020
045700             SET PS-CURSOR-CLOSED                                 04570020
045800                                 TO TRUE                          04580020
045900         WHEN OTHER                                               04590020
046000             MOVE 10             TO DP276-RETURN-CODE             04600020
046100             PERFORM 9000-NO-DISTRO-ERROR                         04610020
046200     END-EVALUATE.                                                04620020
046300/                                                                 04630020
046400 1300-RCVR-OTR.                                                   04640020
046500* RECEIVER OTR AT THE STORE LEVEL                                 04650020
046600                                                                  04660020
046700     MOVE PV-APP-LINE-NBR        TO DK-LINE-NBR                   04670020
046800     PERFORM 7000-GET-RECITM-TMST.                                04680020
046900                                                                  04690020
047000     IF PS-NO-ERRORS                                              04700020
047100         PERFORM 7100-OPEN-RECITM-CURSOR                          04710020
047200     END-IF.                                                      04720020
047300                                                                  04730020
047400     IF PS-NO-ERRORS                                              04740020
047500         PERFORM 7110-FETCH-RECITM-CURSOR                         04750020
047600     END-IF.                                                      04760020
047700                                                                  04770020
047800     IF PS-EOF-PRIOR-CURSOR                                       04780020
047900        SET PS-YES-ERRORS        TO TRUE                          04790020
048000     END-IF.                                                      04800020
048100                                                                  04810020
048200     IF PS-NO-ERRORS                                              04820020
048300         PERFORM 4000-PROCESS-RECITM-CURSOR UNTIL                 04830020
048400                        PS-EOF-PRIOR-CURSOR                       04840020
048500                     OR PS-YES-ERRORS                             04850020
048600     END-IF.                                                      04860020
048700                                                                  04870020
048800     IF PS-CURSOR-OPEN                                            04880020
048900         PERFORM 7120-CLOSE-RECITM-CURSOR                         04890020
049000     END-IF.                                                      04900020
049100/                                                                 04910020
049200 1400-PO-OTR.                                                     04920020
049300* PO OTR AT THE STORE LEVEL                                       04930020
049400                                                                  04940020
049500     IF PS-NO-ERRORS                                              04950020
049600         MOVE PV-APP-LINE-NBR   TO DK-LINE-NBR                    04960020
049700         PERFORM 7200-OPEN-RECITM-CURSOR                          04970020
049800     END-IF.                                                      04980020
049900                                                                  04990020
050000     IF PS-NO-ERRORS                                              05000020
050100         PERFORM 7210-FETCH-RECITM-CURSOR                         05010020
050200     END-IF.                                                      05020020
050300                                                                  05030020
050400     IF PS-NO-ERRORS                                              05040020
050500         PERFORM 4000-PROCESS-RECITM-CURSOR UNTIL                 05050020
050600                        PS-EOF-PRIOR-CURSOR                       05060020
050700                     OR PS-YES-ERRORS                             05070020
050800     END-IF.                                                      05080020
050900                                                                  05090020
051000     IF PS-CURSOR-OPEN                                            05100020
051100         PERFORM 7220-CLOSE-RECITM-CURSOR                         05110020
051200     END-IF.                                                      05120020
051300/                                                                 05130020
051400 2000-LINE-LEVEL-OTR.                                             05140020
051500                                                                  05150020
051600     IF PS-NO-ERRORS                                              05160020
051700         PERFORM 2100-FILL-BASE-NUMBERS                           05170020
051800     END-IF.                                                      05180020
051900                                                                  05190020
052000     IF PS-NO-ERRORS                                              05200020
052100     EVALUATE TRUE                                                05210020
052200         WHEN DP276-RECEIVER-OTR                                  05220020
052300             PERFORM 2200-PROCESS-RCVR-OTR-RCPTS                  05230020
052400                 VARYING DP276-IDX FROM 1 BY 1                    05240020
052500                 UNTIL DP276-LINE-NBR(DP276-IDX) = ZERO           05250020
052600                 OR DP276-IDX > PC-MAX-OCCURENCES                 05260020
052700                 OR DP276-FATAL-ERROR                             05270020
052800         WHEN DP276-PO-OTR                                        05280020
052900             PERFORM 2300-PROCESS-PO-OTR-RCPTS                    05290020
053000                 VARYING DP276-IDX FROM 1 BY 1                    05300020
053100                 UNTIL DP276-LINE-NBR(DP276-IDX) = ZERO           05310020
053200                 OR DP276-IDX > PC-MAX-OCCURENCES                 05320020
053300                 OR DP276-FATAL-ERROR                             05330020
053400         WHEN OTHER                                               05340020
053500             MOVE 'INVALID OTR SCOPE FLAG'                        05350020
053600                                 TO PV-RETURN-MSG                 05360020
053700             MOVE 11             TO DP276-RETURN-CODE             05370020
053800     END-EVALUATE                                                 05380020
053900     END-IF.                                                      05390020
054000                                                                  05400020
054100 2100-FILL-BASE-NUMBERS.                                          05410020
054200                                                                  05420020
054300     PERFORM 2110-OPEN-PLAN-CURSOR.                               05430020
054400                                                                  05440020
054500     IF PS-NO-ERRORS                                              05450020
054600         PERFORM 2120-FETCH-PLAN-CURSOR                           05460020
054700     END-IF.                                                      05470020
054800                                                                  05480020
054900     IF PS-EOF-PLAN-CSR                                           05490020
055000         SET PS-YES-ERRORS       TO TRUE                          05500020
055100     END-IF.                                                      05510020
055200                                                                  05520020
055300     IF PS-NO-ERRORS                                              05530020
055400         PERFORM 2130-LOAD-PLANS VARYING DP276-IDX                05540020
055500                   FROM 1 BY 1 UNTIL PS-EOF-PLAN-CSR              05550020
055600                   OR DP276-SOFT-ABORT                            05560020
055700                   OR DP276-IDX > PC-MAX-OCCURENCES               05570020
055800     END-IF.                                                      05580020
055900                                                                  05590020
056000     IF PS-CURSOR-OPEN                                            05600020
056100         PERFORM 2140-CLOSE-PLAN-CURSOR                           05610020
056200     END-IF.                                                      05620020
056300/                                                                 05630020
056400 2110-OPEN-PLAN-CURSOR.                                           05640020
056500     EXEC SQL                                                     05650020
056600          OPEN PLAN-CSR                                           05660020
056700     END-EXEC.                                                    05670020
056800                                                                  05680020
056900     EVALUATE TRUE                                                05690020
057000         WHEN SQLCODE = ZERO                                      05700020
057100             SET PS-CURSOR-OPEN     TO TRUE                       05710020
057200         WHEN SQLCODE = -904                                      05720020
057300         WHEN SQLCODE = -911                                      05730020
057400         WHEN SQLCODE = -913                                      05740020
057500             SET PS-CURSOR-CLOSED                                 05750020
057600                                 TO TRUE                          05760020
057700             MOVE 12             TO DP276-RETURN-CODE             05770020
057800             PERFORM 9900-SOFT-ABORT                              05780020
057900         WHEN OTHER                                               05790020
058000             SET PS-CURSOR-CLOSED                                 05800020
058100                                 TO TRUE                          05810020
058200             MOVE 13             TO DP276-RETURN-CODE             05820020
058300             PERFORM 9800-CROAK                                   05830020
058400     END-EVALUATE.                                                05840020
058500                                                                  05850020
058600 2120-FETCH-PLAN-CURSOR.                                          05860020
058700     EXEC SQL                                                     05870020
058800         FETCH PLAN-CSR                                           05880020
058900         INTO :PURITM-PO-LNE-NBR                                  05890020
059000            , :PURITM-APP-PO-LNE-NBR                              05900020
059100     END-EXEC                                                     05910020
059200                                                                  05920020
059300     EVALUATE TRUE                                                05930020
059400         WHEN SQLCODE = ZERO                                      05940020
059500              CONTINUE                                            05950020
059600         WHEN SQLCODE = +100                                      05960020
059700             SET PS-EOF-PLAN-CSR TO TRUE                          05970020
059800         WHEN OTHER                                               05980020
059900             MOVE 14              TO DP276-RETURN-CODE            05990020
060000             PERFORM 9800-CROAK                                   06000020
060100     END-EVALUATE.                                                06010020
060200                                                                  06020020
060300 2130-LOAD-PLANS.                                                 06030020
060400     MOVE PURITM-APP-PO-LNE-NBR  TO DP276-LINE-NBR (DP276-IDX)    06040020
060500     MOVE PURITM-PO-LNE-NBR      TO DK-LINE-NBR                   06050020
060600     MOVE DP276-PO-NBR           TO DK-PO-NBR                     06060020
060700     PERFORM 1100-GET-TALLPLN.                                    06070020
060800     IF SQLCODE = ZERO                                            06080020
060900         PERFORM 2150-SUM-ALL-STORES                              06090020
061000         EVALUATE TRUE                                            06100020
061100         WHEN SQLCODE = ZERO OR +100 OR -305                      06110020
061200             MOVE MESTDS-STR-DISTRO-QTY                           06120020
061300                                 TO DP276-STR-DISTRO-QTY          06130020
061400                                       (DP276-IDX)                06140020
061500                                    DP276-OTR-QTY(DP276-IDX)      06150020
061600                                    PV-DISPLAY-QTY                06160020
061700             MOVE PV-DISPLAY-QTY TO DP276-STR-DISTRO-QTY-X        06170020
061800                                       (DP276-IDX)                06180020
061900                                    DP276-OTR-QTY-X               06190020
062000                                       (DP276-IDX)                06200020
062100         WHEN PS-LINE-HAS-NO-DISTRO                               06210020
062200             MOVE ALL '*'        TO DP276-OTR-QTY-X (DP276-IDX)   06220020
062300             MOVE ZERO           TO PV-DISPLAY-QTY                06230020
062400                                    DP276-OTR-QTY (DP276-IDX)     06240020
062500                                    DP276-STR-DISTRO-QTY          06250020
062600                                        (DP276-IDX)               06260020
062700             MOVE PV-DISPLAY-QTY TO DP276-STR-DISTRO-QTY-X        06270020
062800                                        (DP276-IDX)               06280020
062900         WHEN OTHER                                               06290020
063000             MOVE ZERO           TO DP276-STR-DISTRO-QTY          06300020
063100                                       (DP276-IDX)                06310020
063200                                    DP276-OTR-QTY(DP276-IDX)      06320020
063300             MOVE SPACES         TO DP276-OTR-QTY-X(DP276-IDX)    06330020
063400                                    DP276-STR-DISTRO-QTY-X        06340020
063500                                       (DP276-IDX)                06350020
063600         END-EVALUATE                                             06360020
063700     END-IF.                                                      06370020
063800                                                                  06380020
063900     IF PS-NO-ERRORS AND NOT DP276-SOFT-ABORT                     06390020
064000         PERFORM 2120-FETCH-PLAN-CURSOR                           06400020
064100     END-IF.                                                      06410020
064200                                                                  06420020
064300 2140-CLOSE-PLAN-CURSOR.                                          06430020
064400     EXEC SQL                                                     06440020
064500         CLOSE PLAN-CSR                                           06450020
064600     END-EXEC.                                                    06460020
064700     EVALUATE TRUE                                                06470020
064800         WHEN SQLCODE = ZERO                                      06480020
064900             SET PS-CURSOR-CLOSED                                 06490020
065000                                 TO TRUE                          06500020
065100         WHEN OTHER                                               06510020
065200             MOVE 15             TO DP276-RETURN-CODE             06520020
065300             PERFORM 9800-CROAK                                   06530020
065400     END-EVALUATE.                                                06540020
065500                                                                  06550020
065600 2150-SUM-ALL-STORES.                                             06560020
065700                                                                  06570020
065800     MOVE ZERO                   TO MESTDS-STR-DISTRO-QTY         06580020
065900     IF DP276-STR-NBR = ZERO                                      06590020
066000         EXEC SQL                                                 06600020
066100             SELECT SUM(A.STR_DISTRO_QTY)                         06610020
066200               INTO :MESTDS-STR-DISTRO-QTY                        06620020
066300               FROM TMESTDS A                                     06630020
066400              WHERE  A.PO_NBR         = :DK-PO-NBR                06640020
066500                 AND A.PO_LNE_NBR     = :DK-LINE-NBR              06650020
066600                 AND A.PLAN_NBR       = :ALLPLN-PLAN-NBR          06660020
066700         END-EXEC                                                 06670020
066800     ELSE                                                         06680020
066900         EXEC SQL                                                 06690020
067000             SELECT A.STR_DISTRO_QTY                              06700020
067100               INTO :MESTDS-STR-DISTRO-QTY                        06710020
067200               FROM TMESTDS A                                     06720020
067300              WHERE  A.PO_NBR         = :DK-PO-NBR                06730020
067400                 AND A.PO_LNE_NBR     = :DK-LINE-NBR              06740020
067500                 AND A.PLAN_NBR       = :ALLPLN-PLAN-NBR          06750020
067600                 AND A.STR_NBR        = :DP276-STR-NBR            06760020
067700         END-EXEC                                                 06770020
067800     END-IF.                                                      06780020
067900                                                                  06790020
068000     EVALUATE TRUE                                                06800020
068100         WHEN SQLCODE = ZERO                                      06810020
068200             IF DP276-STR-NBR = ZERO                              06820020
068300                 IF MESTDS-STR-DISTRO-QTY                         06830020
068400                              NOT = ALLPLN-CURR-SPLIT-QTY         06840020
068500                     MOVE ALLPLN-CURR-SPLIT-QTY                   06850020
068600                                 TO  MESTDS-STR-DISTRO-QTY        06860020
068700                 END-IF                                           06870020
068800             END-IF                                               06880020
068900         WHEN SQLCODE = +100 OR -305                              06890020
069000             IF DP276-STR-NBR = ZERO                              06900020
069100                 MOVE ALLPLN-CURR-SPLIT-QTY                       06910020
069200                                 TO  MESTDS-STR-DISTRO-QTY        06920020
069300             ELSE                                                 06930020
069400                 MOVE 16         TO DP276-RETURN-CODE             06940020
069500                 SET PS-LINE-HAS-NO-DISTRO                        06950020
069600                                 TO TRUE                          06960020
069700                 PERFORM 9000-NO-DISTRO-ERROR                     06970020
069800             END-IF                                               06980020
069900         WHEN SQLCODE = -904                                      06990020
070000         WHEN SQLCODE = -911                                      07000020
070100         WHEN SQLCODE = -913                                      07010020
070200             MOVE 17             TO DP276-RETURN-CODE             07020020
070300             PERFORM 9900-SOFT-ABORT                              07030020
070400         WHEN OTHER                                               07040020
070500             MOVE 18             TO DP276-RETURN-CODE             07050020
070600             SET PS-LINE-HAS-NO-DISTRO                            07060020
070700                                 TO TRUE                          07070020
070800             PERFORM 9000-NO-DISTRO-ERROR                         07080020
070900     END-EVALUATE.                                                07090020
071000                                                                  07100020
071100/                                                                 07110020
071200 2200-PROCESS-RCVR-OTR-RCPTS.                                     07120020
071300                                                                  07130020
071400     IF DP276-OTR-QTY-X (DP276-IDX) = ALL '*'                     07140020
071500         SET PS-YES-ERRORS       TO TRUE                          07150020
071600     ELSE                                                         07160020
071700         SET PS-NO-ERRORS                                         07170020
071800             PS-START-PRIOR-CURSOR                                07180020
071900                                 TO TRUE                          07190020
072000         MOVE DP276-LINE-NBR(DP276-IDX)                           07200020
072100                                 TO DK-LINE-NBR                   07210020
072200         PERFORM 7000-GET-RECITM-TMST                             07220020
072300     END-IF                                                       07230020
072400                                                                  07240020
072500     IF PS-NO-ERRORS AND NOT DP276-FATAL-ERROR                    07250020
072600         PERFORM 7100-OPEN-RECITM-CURSOR                          07260020
072700     END-IF.                                                      07270020
072800                                                                  07280020
072900     IF PS-NO-ERRORS AND NOT DP276-FATAL-ERROR                    07290020
073000         PERFORM 7110-FETCH-RECITM-CURSOR                         07300020
073100     END-IF.                                                      07310020
073200                                                                  07320020
073300     IF PS-EOF-PRIOR-CURSOR                                       07330020
073400        SET PS-YES-ERRORS        TO TRUE                          07340020
073500     END-IF.                                                      07350020
073600                                                                  07360020
073700     IF PS-NO-ERRORS                                              07370020
073800         PERFORM 6000-PROCESS-RECITM-CURSOR UNTIL                 07380020
073900                        PS-EOF-PRIOR-CURSOR                       07390020
074000                     OR PS-YES-ERRORS OR DP276-FATAL-ERROR        07400020
074100     END-IF.                                                      07410020
074200                                                                  07420020
074300     IF PS-CURSOR-OPEN                                            07430020
074400         PERFORM 7120-CLOSE-RECITM-CURSOR                         07440020
074500     END-IF.                                                      07450020
074600/                                                                 07460020
074700 2300-PROCESS-PO-OTR-RCPTS.                                       07470020
074800* PO OTR AT THE LINE LEVEL                                        07480020
074900                                                                  07490020
075000* ALL '*' INDICATES A 'NO DISTRO' ERROR FOR THE LINE              07500020
075100     IF DP276-OTR-QTY-X (DP276-IDX) = ALL '*'                     07510020
075200         SET PS-YES-ERRORS       TO TRUE                          07520020
075300     ELSE                                                         07530020
075400         SET PS-NO-ERRORS        TO TRUE                          07540020
075500         MOVE DP276-LINE-NBR(DP276-IDX)                           07550020
075600                                 TO DK-LINE-NBR                   07560020
075700         PERFORM 7200-OPEN-RECITM-CURSOR                          07570020
075800     END-IF.                                                      07580020
075900                                                                  07590020
076000     IF PS-NO-ERRORS                                              07600020
076100         SET PS-START-PRIOR-CURSOR                                07610020
076200                                 TO TRUE                          07620020
076300         PERFORM 7210-FETCH-RECITM-CURSOR                         07630020
076400     END-IF.                                                      07640020
076500                                                                  07650020
076600     IF PS-NO-ERRORS                                              07660020
076700         PERFORM 6000-PROCESS-RECITM-CURSOR                       07670020
076800                      UNTIL PS-EOF-PRIOR-CURSOR                   07680020
076900                     OR PS-YES-ERRORS OR DP276-FATAL-ERROR        07690020
077000     END-IF.                                                      07700020
077100                                                                  07710020
077200     IF PS-CURSOR-OPEN                                            07720020
077300         PERFORM 7220-CLOSE-RECITM-CURSOR                         07730020
077400     END-IF.                                                      07740020
077500/                                                                 07750020
077600 4000-PROCESS-RECITM-CURSOR.                                      07760020
077700     PERFORM 4100-APPLY-PRIOR-RECEIPTS VARYING DP276-IDX          07770020
077800                   FROM 1 BY 1 UNTIL                              07780020
077900                   DP276-STORE-NBR(DP276-IDX) = ZERO OR           07790020
078000                   DP276-IDX > PC-MAX-OCCURENCES                  07800020
078100                                                                  07810020
078200     IF PS-NO-ERRORS                                              07820020
078300         IF DP276-RECEIVER-OTR                                    07830020
078400             PERFORM 7110-FETCH-RECITM-CURSOR                     07840020
078500         ELSE                                                     07850020
078600             PERFORM 7210-FETCH-RECITM-CURSOR                     07860020
078700         END-IF                                                   07870020
078800     END-IF.                                                      07880020
078900                                                                  07890020
079000******************************************************************07900020
079100*    THIS PARAGRAPH RETRIEVES THE RECDIS RECORD FOR A GIVEN STORE.07910020
079200*    IT THEN ADDS INTO THE STORE ARRAY THE CORRECT STORE RECEIPTS 07920020
079300*    DEPENDING UPON THE STATUS CODE OF THE RECITM.                07930020
079400******************************************************************07940020
079500 4100-APPLY-PRIOR-RECEIPTS.                                       07950020
079600     MOVE DP276-STORE-NBR(DP276-IDX)                              07960020
079700                                 TO RECDIS-STR-NBR.               07970020
079800                                                                  07980020
079900     IF RECITM-STATUS-CDE = PC-VE                                 07990020
080000         EXEC SQL                                                 08000020
080100              SELECT AP_VERIFY_ITM_QTY                            08010020
080200                INTO :PV-RECEIVED-QTY                             08020020
080300                FROM TRECDIS                                      08030020
080400               WHERE ORD_NBR        = :DP276-PO-NBR               08040020
080500                 AND ORD_LNE_NBR    = :DK-LINE-NBR                08050020
080600                 AND REC_SEQ_NBR    = :RECITM-REC-SEQ-NBR         08060020
080700                 AND OPER_UNT_ID    = :DP276-OPER-UNT-ID          08070020
080800                 AND FCLTY_ID       = :PC-SHORT-ONE               08080022
080900                 AND STR_NBR        = :RECDIS-STR-NBR             08090020
081000                 AND STR_FCLTY_ID   = :PC-SHORT-ONE               08100020
081100         END-EXEC                                                 08110020
081200     ELSE                                                         08120020
081300         EXEC SQL                                                 08130020
081400              SELECT EXPTED_ITM_QTY                               08140020
081500                INTO :PV-RECEIVED-QTY                             08150020
081600                FROM TRECDIS                                      08160020
081700               WHERE ORD_NBR        = :DP276-PO-NBR               08170020
081800                 AND ORD_LNE_NBR    = :DK-LINE-NBR                08180020
081900                 AND REC_SEQ_NBR    = :RECITM-REC-SEQ-NBR         08190020
082000                 AND OPER_UNT_ID    = :DP276-OPER-UNT-ID          08200020
082100                 AND FCLTY_ID       = :PC-SHORT-ONE               08210022
082200                 AND STR_NBR        = :RECDIS-STR-NBR             08220020
082300                 AND STR_FCLTY_ID   = :PC-SHORT-ONE               08230020
082400         END-EXEC                                                 08240020
082500     END-IF                                                       08250020
082600                                                                  08260020
082700     EVALUATE TRUE                                                08270020
082800         WHEN SQLCODE = ZERO                                      08280020
082900             SUBTRACT PV-RECEIVED-QTY                             08290020
083000                               FROM DP276-OTR-QTY (DP276-IDX)     08300020
083100             IF DP276-OTR-QTY (DP276-IDX) > ZERO                  08310020
083200                 MOVE DP276-OTR-QTY (DP276-IDX)                   08320020
083300                                 TO PV-DISPLAY-QTY                08330020
083400             ELSE                                                 08340020
083500                 MOVE ZERO       TO PV-DISPLAY-QTY                08350020
083600             END-IF                                               08360020
083700             MOVE PV-DISPLAY-QTY TO DP276-OTR-QTY-X (DP276-IDX)   08370020
083800         WHEN SQLCODE = +100                                      08380020
083900             CONTINUE                                             08390020
084000         WHEN SQLCODE = -904                                      08400020
084100         WHEN SQLCODE = -911                                      08410020
084200         WHEN SQLCODE = -913                                      08420020
084300             MOVE 19             TO DP276-RETURN-CODE             08430020
084400             PERFORM 9900-SOFT-ABORT                              08440020
084500         WHEN OTHER                                               08450020
084600             MOVE 20             TO DP276-RETURN-CODE             08460020
084700             PERFORM 9800-CROAK                                   08470020
084800     END-EVALUATE.                                                08480020
084900/                                                                 08490020
085000 6000-PROCESS-RECITM-CURSOR.                                      08500020
085100     PERFORM 6100-APPLY-PRIOR-RECEIPTS                            08510020
085200                                                                  08520020
085300     IF PS-NO-ERRORS                                              08530020
085400         IF DP276-RECEIVER-OTR                                    08540020
085500             PERFORM 7110-FETCH-RECITM-CURSOR                     08550020
085600         ELSE                                                     08560020
085700             PERFORM 7210-FETCH-RECITM-CURSOR                     08570020
085800     END-IF.                                                      08580020
085900                                                                  08590020
086000 6100-APPLY-PRIOR-RECEIPTS.                                       08600020
086100     MOVE DP276-LINE-NBR(DP276-IDX)                               08610020
086200                                 TO RECDIS-ORD-LNE-NBR.           08620020
086300                                                                  08630020
086400     EVALUATE RECITM-STATUS-CDE                                   08640020
086500     WHEN PC-VE                                                   08650020
086600         IF DP276-STR-NBR = ZERO                                  08660020
086700             EXEC SQL                                             08670020
086800                  SELECT SUM(AP_VERIFY_ITM_QTY)                   08680020
086900                    INTO :PV-RECEIVED-QTY                         08690020
087000                    FROM TRECDIS                                  08700020
087100                   WHERE ORD_NBR    = :DP276-PO-NBR               08710020
087200                     AND ORD_LNE_NBR = :RECDIS-ORD-LNE-NBR        08720020
087300                     AND REC_SEQ_NBR = :RECITM-REC-SEQ-NBR        08730020
087400                     AND OPER_UNT_ID = :DP276-OPER-UNT-ID         08740020
087500                     AND FCLTY_ID    = :PC-SHORT-ONE              08750022
087600                     AND STR_FCLTY_ID = :PC-SHORT-ONE             08760020
087700             END-EXEC                                             08770020
087800         ELSE                                                     08780020
087900             EXEC SQL                                             08790020
088000                  SELECT AP_VERIFY_ITM_QTY                        08800020
088100                    INTO :PV-RECEIVED-QTY                         08810020
088200                    FROM TRECDIS                                  08820020
088300                   WHERE ORD_NBR     = :DP276-PO-NBR              08830020
088400                     AND ORD_LNE_NBR = :RECDIS-ORD-LNE-NBR        08840020
088500                     AND REC_SEQ_NBR = :RECITM-REC-SEQ-NBR        08850020
088600                     AND OPER_UNT_ID = :DP276-OPER-UNT-ID         08860020
088700                     AND FCLTY_ID    = :DP276-FCLTY-ID            08870020
088800                     AND STR_NBR     = :DP276-STR-NBR             08880020
088900                     AND STR_FCLTY_ID = :PC-SHORT-ONE             08890020
089100             END-EXEC                                             08910020
089200         END-IF                                                   08920020
089300     WHEN PC-IP                                                   08930020
089400     WHEN PC-CM                                                   08940020
089500     IF DP276-STR-NBR = ZERO                                      08950020
089600         EXEC SQL                                                 08960020
089700              SELECT SUM(EXPTED_ITM_QTY)                          08970020
089800                INTO :PV-RECEIVED-QTY                             08980020
089900                FROM TRECDIS                                      08990020
090000               WHERE ORD_NBR        = :DP276-PO-NBR               09000020
090100                 AND ORD_LNE_NBR    = :RECDIS-ORD-LNE-NBR         09010020
090200                 AND REC_SEQ_NBR    = :RECITM-REC-SEQ-NBR         09020020
090300                 AND OPER_UNT_ID    = :DP276-OPER-UNT-ID          09030020
090400                 AND FCLTY_ID       = :DP276-FCLTY-ID             09040020
090600                 AND STR_FCLTY_ID   = :PC-SHORT-ONE               09060020
090700         END-EXEC                                                 09070020
090800     ELSE                                                         09080020
090900         EXEC SQL                                                 09090020
091000              SELECT EXPTED_ITM_QTY                               09100020
091100                INTO :PV-RECEIVED-QTY                             09110020
091200                FROM TRECDIS                                      09120020
091300               WHERE ORD_NBR        = :DP276-PO-NBR               09130020
091400                 AND ORD_LNE_NBR    = :RECDIS-ORD-LNE-NBR         09140020
091500                 AND REC_SEQ_NBR    = :RECITM-REC-SEQ-NBR         09150020
091600                 AND OPER_UNT_ID    = :DP276-OPER-UNT-ID          09160020
091700                 AND FCLTY_ID       = :DP276-FCLTY-ID             09170020
091800                 AND STR_NBR        = :DP276-STR-NBR              09180020
092000                 AND STR_FCLTY_ID   = :PC-SHORT-ONE               09200020
092100         END-EXEC                                                 09210020
092200     END-IF                                                       09220020
092300     END-EVALUATE.                                                09230020
092400                                                                  09240020
092500     EVALUATE TRUE                                                09250020
092600         WHEN SQLCODE = ZERO                                      09260020
092700             SUBTRACT PV-RECEIVED-QTY                             09270020
092800                               FROM DP276-OTR-QTY (DP276-IDX)     09280020
092900             IF DP276-OTR-QTY (DP276-IDX) > ZERO                  09290020
093000                 MOVE DP276-OTR-QTY (DP276-IDX)                   09300020
093100                                 TO PV-DISPLAY-QTY                09310020
093200             ELSE                                                 09320020
093300                 MOVE ZERO       TO PV-DISPLAY-QTY                09330020
093400             END-IF                                               09340020
093500             MOVE PV-DISPLAY-QTY TO DP276-OTR-QTY-X (DP276-IDX)   09350020
093600         WHEN SQLCODE = +100                                      09360020
093700         WHEN SQLCODE = -305                                      09370020
093800             CONTINUE                                             09380020
093900         WHEN SQLCODE = -904                                      09390020
094000         WHEN SQLCODE = -911                                      09400020
094100         WHEN SQLCODE = -913                                      09410020
094200             MOVE 21             TO DP276-RETURN-CODE             09420020
094300             PERFORM 9900-SOFT-ABORT                              09430020
094400         WHEN OTHER                                               09440020
094500             MOVE 22             TO DP276-RETURN-CODE             09450020
094600             PERFORM 9800-CROAK                                   09460020
094700     END-EVALUATE.                                                09470020
094800/                                                                 09480020
094900 7000-GET-RECITM-TMST.                                            09490020
095000******************************************************************09500020
095100*    THIS PARAGRAPH RETRIEVES THE EARLIEST TIMESTAMP FOR A PO     09510020
095200*    AND RECEIVER  WITHIN A DC.                                   09520020
095300******************************************************************09530020
095400                                                                  09540020
095500     EXEC SQL                                                     09550020
095600         SELECT CRE_TMST                                          09560020
095700             INTO :RECITM-CRE-TMST                                09570020
095800             FROM TRECITM                                         09580020
095900             WHERE ORD_NBR          = :DP276-PO-NBR               09590020
096000                 AND REC_SEQ_NBR    = :DP276-REC-SEQ-NBR          09600020
096100                 AND ORD_LNE_NBR    = :DK-LINE-NBR                09610020
096200                 AND OPER_UNT_ID    = :DP276-OPER-UNT-ID          09620020
096300     END-EXEC                                                     09630020
096400                                                                  09640020
096500     EVALUATE TRUE                                                09650020
096600         WHEN SQLCODE = ZERO                                      09660020
096700             CONTINUE                                             09670020
096800         WHEN SQLCODE = +100                                      09680020
096900             EXEC SQL                                             09690020
097000                 SET :RECITM-CRE-TMST = CURRENT TIMESTAMP         09700020
097100             END-EXEC                                             09710020
097200         WHEN SQLCODE = -904                                      09720020
097300         WHEN SQLCODE = -911                                      09730020
097400         WHEN SQLCODE = -913                                      09740020
097500             MOVE 23             TO DP276-RETURN-CODE             09750020
097600             PERFORM 9900-SOFT-ABORT                              09760020
097700         WHEN OTHER                                               09770020
097800             MOVE 24             TO DP276-RETURN-CODE             09780020
097900             PERFORM 9800-CROAK                                   09790020
098000     END-EVALUATE.                                                09800020
098100                                                                  09810020
098200/                                                                 09820020
098300 7100-OPEN-RECITM-CURSOR.                                         09830020
098400     EXEC SQL                                                     09840020
098500         OPEN REC-LVL-VE-CSR                                      09850020
098600     END-EXEC.                                                    09860020
098700                                                                  09870020
098800     EVALUATE TRUE                                                09880020
098900         WHEN SQLCODE = ZERO                                      09890020
099000             SET PS-CURSOR-OPEN  TO TRUE                          09900020
099100         WHEN SQLCODE = -904                                      09910020
099200         WHEN SQLCODE = -911                                      09920020
099300         WHEN SQLCODE = -913                                      09930020
099400             SET PS-CURSOR-CLOSED                                 09940020
099500                                 TO TRUE                          09950020
099600             MOVE 27             TO DP276-RETURN-CODE             09960020
099700             PERFORM 9900-SOFT-ABORT                              09970020
099800         WHEN OTHER                                               09980020
099900             SET PS-CURSOR-CLOSED                                 09990020
100000                                 TO TRUE                          10000020
100100             MOVE 28             TO DP276-RETURN-CODE             10010020
100200             PERFORM 9800-CROAK                                   10020020
100300     END-EVALUATE.                                                10030020
100400                                                                  10040020
100500 7110-FETCH-RECITM-CURSOR.                                        10050020
100600     EXEC SQL                                                     10060020
100700         FETCH REC-LVL-VE-CSR                                     10070020
100800         INTO   :RECITM-REC-SEQ-NBR                               10080020
100900              , :RECITM-STATUS-CDE                                10090020
101000     END-EXEC.                                                    10100020
101100                                                                  10110020
101200     EVALUATE TRUE                                                10120020
101300         WHEN SQLCODE = ZERO                                      10130020
101400             CONTINUE                                             10140020
101500         WHEN SQLCODE = +100                                      10150020
101600             SET PS-EOF-PRIOR-CURSOR TO TRUE                      10160020
101700         WHEN OTHER                                               10170020
101800             MOVE 29             TO DP276-RETURN-CODE             10180020
101900             PERFORM 9800-CROAK                                   10190020
102000     END-EVALUATE.                                                10200020
102100                                                                  10210020
102200/                                                                 10220020
102300 7120-CLOSE-RECITM-CURSOR.                                        10230020
102400     EXEC SQL                                                     10240020
102500         CLOSE REC-LVL-VE-CSR                                     10250020
102600     END-EXEC.                                                    10260020
102700                                                                  10270020
102800     EVALUATE TRUE                                                10280020
102900         WHEN SQLCODE = ZERO                                      10290020
103000             SET PS-CURSOR-CLOSED TO TRUE                         10300020
103100         WHEN OTHER                                               10310020
103200             MOVE 30             TO DP276-RETURN-CODE             10320020
103300             PERFORM 9800-CROAK                                   10330020
103400     END-EVALUATE.                                                10340020
103500/                                                                 10350020
103600 7200-OPEN-RECITM-CURSOR.                                         10360020
103700     EXEC SQL                                                     10370020
103800         OPEN PO-LVL-IP-CSR                                       10380020
103900     END-EXEC.                                                    10390020
104000                                                                  10400020
104100     EVALUATE TRUE                                                10410020
104200         WHEN SQLCODE = ZERO                                      10420020
104300             SET PS-CURSOR-OPEN  TO TRUE                          10430020
104400         WHEN SQLCODE = -904                                      10440020
104500         WHEN SQLCODE = -911                                      10450020
104600         WHEN SQLCODE = -913                                      10460020
104700             SET PS-CURSOR-CLOSED                                 10470020
104800                                 TO TRUE                          10480020
104900             MOVE 31             TO DP276-RETURN-CODE             10490020
105000             PERFORM 9900-SOFT-ABORT                              10500020
105100         WHEN OTHER                                               10510020
105200             SET PS-CURSOR-CLOSED                                 10520020
105300                                 TO TRUE                          10530020
105400             MOVE 32             TO DP276-RETURN-CODE             10540020
105500             PERFORM 9800-CROAK                                   10550020
105600     END-EVALUATE.                                                10560020
105700                                                                  10570020
105800 7210-FETCH-RECITM-CURSOR.                                        10580020
105900     EXEC SQL                                                     10590020
106000         FETCH PO-LVL-IP-CSR                                      10600020
106100         INTO   :RECITM-REC-SEQ-NBR                               10610020
106200              , :RECITM-STATUS-CDE                                10620020
106300     END-EXEC.                                                    10630020
106400                                                                  10640020
106500     EVALUATE TRUE                                                10650020
106600         WHEN SQLCODE = ZERO                                      10660020
106700             CONTINUE                                             10670020
106800         WHEN SQLCODE = +100                                      10680020
106900             SET PS-EOF-PRIOR-CURSOR TO TRUE                      10690020
107000         WHEN OTHER                                               10700020
107100             MOVE 33             TO DP276-RETURN-CODE             10710020
107200             PERFORM 9800-CROAK                                   10720020
107300     END-EVALUATE.                                                10730020
107400                                                                  10740020
107500 7220-CLOSE-RECITM-CURSOR.                                        10750020
107600     EXEC SQL                                                     10760020
107700         CLOSE PO-LVL-IP-CSR                                      10770020
107800     END-EXEC.                                                    10780020
107900                                                                  10790020
108000     EVALUATE TRUE                                                10800020
108100         WHEN SQLCODE = ZERO                                      10810020
108200             SET PS-CURSOR-CLOSED                                 10820020
108300                                 TO TRUE                          10830020
108400         WHEN OTHER                                               10840020
108500             MOVE 34             TO DP276-RETURN-CODE             10850020
108600             PERFORM 9800-CROAK                                   10860020
108700     END-EVALUATE.                                                10870020
108800/                                                                 10880020
108900 9000-NO-DISTRO-ERROR.                                            10890020
109000                                                                  10900020
109100     SET DP276-NO-DISTRO                                          10910020
109200         DP276-WARNING-ERROR     TO TRUE.                         10920020
109300     IF DP276-STORE-LEVEL-OTR                                     10930020
109400         PERFORM VARYING DP276-IDX FROM 1 BY 1                    10940020
109500            UNTIL DP276-IDX > 999                                 10950020
109600             MOVE ALL '*'        TO DP276-OTR-QTY-X (DP276-IDX)   10960020
109700         END-PERFORM                                              10970020
109800     ELSE                                                         10980020
109900         MOVE ALL '*'            TO DP276-OTR-QTY-X (DP276-IDX)   10990020
110000     END-IF.                                                      11000020
110100/                                                                 11010020
110200*----------------------------------------------------------------*11020020
110300*    WHEN A FATAL ERROR OCCURS PASS THE ERROR SWITCHES BACK TO    11030020
110400*    THE HOST PROGRAM AND WRITE TO THE CICS MESSAGE LOG.         *11040020
110500*----------------------------------------------------------------*11050020
110600 9800-CROAK.                                                      11060020
110700                                                                  11070020
110800     PERFORM VARYING DP276-ERR-IDX FROM 1 BY 1 UNTIL              11080020
110900             DP276-ERR-IDX > 999                                  11090020
111000         MOVE SPACES             TO DP276-OTR-QTY-X               11100020
111100                                    (DP276-ERR-IDX)               11110020
111200                                    DP276-STR-DISTRO-QTY-X        11120020
111300                                    (DP276-ERR-IDX)               11130020
111400         MOVE ZEROES             TO DP276-OTR-QTY                 11140020
111500                                    (DP276-ERR-IDX)               11150020
111600                                    DP276-STR-DISTRO-QTY          11160020
111700                                    (DP276-ERR-IDX)               11170020
111800     END-PERFORM.                                                 11180020
111900                                                                  11190020
112000     SET PS-YES-ERRORS           TO TRUE                          11200020
112100                                                                  11210020
112200     SET DP276-FATAL-ERROR                                        11220020
112300         DP276-CROAK             TO TRUE                          11230020
112400     MOVE SQLCODE                TO PV-SQLCODE                    11240020
112500                                                                  11250020
112600     PERFORM 9950-FORMAT-ERROR-MSG.                               11260020
112700                                                                  11270020
112800     SET DP013-LINK-RETURN                                        11280020
112900         DP013-NO-ROLLBACK TO TRUE                                11290020
113000     PERFORM DP013-0000-PROCESS-ABEND.                            11300020
113100                                                                  11310020
113200*----------------------------------------------------------------*11320020
113300*    THE DB2 RESOURCE IS NOT AVAILABLE, PASS THE ERROR SWITCHES  *11330020
113400*    BACK TO THE HOST PROGRAM AND WRITE TO THE CICS MESSAGE LOG  *11340020
113500*----------------------------------------------------------------*11350020
113600 9900-SOFT-ABORT.                                                 11360020
113700     SET PS-YES-ERRORS                                            11370020
113800         DP276-FATAL-ERROR                                        11380020
113900         DP276-SOFT-ABORT        TO TRUE.                         11390020
114000                                                                  11400020
114100     PERFORM 9950-FORMAT-ERROR-MSG.                               11410020
114200                                                                  11420020
114300     SET DP013-LINK-RETURN                                        11430020
114400         DP013-NO-ROLLBACK TO TRUE                                11440020
114500                                                                  11450020
114600     PERFORM DP013-0000-PROCESS-ABEND.                            11460020
114700                                                                  11470020
114800 9950-FORMAT-ERROR-MSG.                                           11480020
114900                                                                  11490020
115000     MOVE SQLCODE                TO PV-SQLCODE                    11500020
115100                                    PV-DISPLAY-SQLCODE.           11510020
115200                                                                  11520020
115300     MOVE DP276-PO-NBR           TO PV-DISP-PO-NBR                11530020
115400     IF DP276-PO-LNE-NBR = ZERO                                   11540020
115500         MOVE DK-LINE-NBR        TO PV-DISP-PO-LNE-NBR            11550020
115600     ELSE                                                         11560020
115700         MOVE DP276-PO-LNE-NBR   TO PV-DISP-PO-LNE-NBR            11570020
115800     END-IF                                                       11580020
115900     MOVE DP276-REC-SEQ-NBR      TO PV-DISP-REC-SEQ-NBR           11590020
116000     MOVE DP276-OPER-UNT-ID      TO PV-DISP-OPER-UNT-ID           11600020
116100     MOVE DP276-FCLTY-ID         TO PV-DISP-FCLTY-ID              11610020
116200     MOVE DP276-STR-NBR          TO PV-DISP-STR-NBR.              11620020
116300                                                                  11630020
116400     STRING '** DPKCS276 ** ERROR; '                              11640020
116500         PV-RETURN-MSG DELIMITED BY SIZE                          11650020
116600                                 INTO DP013-MESSAGE-TEXT (1)      11660020
116700                                                                  11670020
116800     STRING  ' DP276-RC = ' DP276-RETURN-CODE                     11680020
116900             '; SQLCODE = ' PV-DISPLAY-SQLCODE                    11690020
117000                                  DELIMITED BY SIZE               11700020
117100                                 INTO DP013-MESSAGE-TEXT (2)      11710020
117200                                                                  11720020
117300     MOVE '  PO    REC  LNE OPER FCLTY STR'                       11730020
117400                                   TO DP013-MESSAGE-TEXT (3)      11740020
117500                                                                  11750020
117600     STRING                                                       11760020
117700         PV-DISP-PO-NBR '-'                                       11770020
117800         PV-DISP-REC-SEQ-NBR '-'                                  11780020
117900         PV-DISP-PO-LNE-NBR '-'                                   11790020
118000         PV-DISP-OPER-UNT-ID '-'                                  11800020
118100         PV-DISP-FCLTY-ID '-'                                     11810020
118200         PV-DISP-STR-NBR                                          11820020
118300         DELIMITED BY SIZE INTO DP013-MESSAGE-TEXT (4).           11830020
118400*----------------------------------------------------------------*11840020
118500*    ABEND PROCESSOR MODULE                                      *11850020
118600*----------------------------------------------------------------*11860020
118700                                                                  11870020
118800     COPY DPPD013.                                                11880020
