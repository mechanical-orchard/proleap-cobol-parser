000500 IDENTIFICATION DIVISION.                                         00050001
000600 TITLE 'CREATE REPLENISHMENT EXTRACT'.                            00060012
000601                                                                  00060101
000610* WR28890 - REPLENISHMENT 2005                                    00061001
000620* THIS PROGRAM IS USED TO RETRIEVE THE UPC'S IN CARTONS FOR STORE 00062003
000630* UNLOADED TRAILERS AND CREATE AN EXTRACT FILE.                   00063003
000700                                                                  00070001
000800 PROGRAM-ID.             SUKUT109.                                00080001
000900 AUTHOR.                 PATRICK BURKE.                           00090001
001000 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00100001
001100 DATE-WRITTEN            JUNE 2005.                               00110001
001200 DATE-COMPILED.                                                   00120001
001300                                                                  00130001
001400 ENVIRONMENT DIVISION.                                            00140001
001500 CONFIGURATION SECTION.                                           00150001
001600                                                                  00160001
001700 SOURCE-COMPUTER.        IBM-3090.                                00170001
001800 OBJECT-COMPUTER.        IBM-3090.                                00180001
001900 INPUT-OUTPUT SECTION.                                            00190001
002000 FILE-CONTROL.                                                    00200001
002100                                                                  00210001
002200     SELECT STORES-UNLOADED-TRAILERS                              00220004
002300         ASSIGN TO INP01.                                         00230001
002400     SELECT REPORT-EXTRACT-FILE                                   00240001
002500         ASSIGN TO OUT01.                                         00250001
002600                                                                  00260001
002700 DATA DIVISION.                                                   00270001
002800 FILE SECTION.                                                    00280001
002900                                                                  00290001
003000 FD  STORES-UNLOADED-TRAILERS                                     00300002
003100     RECORDING MODE IS F                                          00310001
003200     LABEL RECORDS ARE STANDARD                                   00320001
003300     BLOCK CONTAINS 0 RECORDS.                                    00330001
003400                                                                  00340001
003500 01  STORES-UNLOADED-TRAILERS-REC     PIC X(014).                 00350002
003600                                                                  00360001
003700 FD  REPORT-EXTRACT-FILE                                          00370001
003800     RECORDING MODE IS F                                          00380001
003900     LABEL RECORDS ARE STANDARD                                   00390001
004000     BLOCK CONTAINS 0 RECORDS.                                    00400001
004100                                                                  00410001
004200 01  REPORT-EXTRACT-REC             PIC X(40).                    00420002
004300                                                                  00430001
004400 WORKING-STORAGE SECTION.                                         00440001
004500                                                                  00450001
004600 01  FILLER.                                                      00460001
004700     05  FILLER                      PIC  X(36)    VALUE          00470001
004800         ' ***** WORKING STORAGE PGM=SUKUT109 '.                  00480001
004900     05  PGM-COMPILED                PIC  X(20)    VALUE SPACE.   00490001
005000     05  FILLER                      PIC  X(10)    VALUE          00500001
005100         ' LOCATION='.                                            00510001
005200     05  PGM-LOCATION                PIC  X(04)    VALUE SPACE.   00520001
005300     05  FILLER                      PIC  X(06)    VALUE          00530001
005400         ' *****'.                                                00540001
005500                                                                  00550001
005600 01  PS-SWITCHES.                                                 00560001
005700     05  PS-EOF-SW                    PIC X(01) VALUE 'N'.        00570001
005800         88  PS-EOF-EXTRACT-YES                 VALUE 'Y'.        00580001
005900         88  PS-EOF-EXTRACT-NO                  VALUE 'N'.        00590001
006000     05  PS-TRIP-CSR-SW               PIC X(01) VALUE 'N'.        00600001
006100         88  PS-END-OF-TRIP-CSR                 VALUE 'Y'.        00610001
006200                                                                  00620001
006300 01  PC-CONSTANTS.                                                00630001
006400     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00640001
006500                                                   'SUKUT109'.    00650001
006700     05  PC-ILBOABN0                 PIC  X(08)    VALUE          00670001
006800                                                   'ILBOABN0'.    00680001
006900     05  PC-MAX-RETRIES              PIC S9(04)    VALUE  +3      00690001
007000                                                   COMP.          00700001
007100                                                                  00710001
007200 01  PV-MISC-STUFF.                                               00720001
007300     05  PV-OTBND-TRIP-ID             PIC S9(09) COMP.            00730007
007400     05  PV-ABEND-PARAGRAPH           PIC  X(30) VALUE SPACES.    00740001
007500     05  PV-DB2-OPERATION-ATTEMPTED   PIC  X(60) VALUE SPACE.     00750001
007600     05  PV-SQL-CODE                  PIC  9(04) VALUE ZERO.      00760001
007700     05  PV-ABEND-CODE                PIC S9(04) VALUE ZERO       00770001
007800                                                   COMP SYNC.     00780001
007900     05  PV-RETRY-COUNTER             PIC S9(04) VALUE ZERO       00790001
008000                                                 COMP SYNC.       00800001
008100     05  PV-COMMIT-COUNTER            PIC S9(04) VALUE ZERO       00810001
008200                                                 COMP SYNC.       00820001
008300     05  PV-READ-COUNTER              PIC S9(09) COMP-3           00830001
008400                                              VALUE ZERO.         00840001
008500     05  PV-TRIP-CNT                  PIC S9(09) COMP-3           00850013
008600                                              VALUE ZERO.         00860001
008700     05  PV-NULL-IND-1                PIC S9(04)  VALUE +0  COMP. 00870001
008800     05  PV-WRITE-1-COUNTER           PIC S9(09) COMP-3           00880001
008900                                              VALUE ZERO.         00890001
009000     05  PV-BYPASS-COUNT              PIC S9(09) COMP-3           00900001
009100                                              VALUE ZERO.         00910001
009200     05  PV-DISP-NBR                  PIC ZZZ,ZZZ,ZZ9.            00920001
009300     05  PV-ABEND-OPERATION           PIC X(20) VALUE SPACES.     00930001
009400     05  PV-ABEND-STRUCTURE-1         PIC X(20) VALUE SPACES.     00940001
009500                                                                  00950001
009600 01  ABEND-CODE                       PIC S9(04)     VALUE +0     00960001
009700                                                     COMP SYNC.   00970001
009800     88  ABEND-4001-WRITE-ERROR                      VALUE +4001. 00980001
009900     88  ABEND-4002-READ-ERROR                       VALUE +4002. 00990001
010000     88  ABEND-4003-CTRL-CARD-ERROR                  VALUE +4003. 01000001
010100     88  ABEND-4004-TABLE-ERROR                      VALUE +4004. 01010001
010200     88  ABEND-4005-OPEN-ERROR                       VALUE +4005. 01020001
010300     88  ABEND-4006-CLOSE-ERROR                      VALUE +4006. 01030001
010400     88  ABEND-4007-SEQUENCE-ERROR                   VALUE +4007. 01040001
010500     88  ABEND-4008-DATS-ERROR                       VALUE +4008. 01050001
010600     88  ABEND-4009-KEY-DATS-ERROR                   VALUE +4009. 01060001
010700     88  ABEND-4013-DB2-ERROR                        VALUE +4013. 01070001
010800                                                                  01080001
010900 01  PV-COUNT-MSG-1.                                              01090001
011000     05  FILLER                       PIC X(26) VALUE             01100001
011100         'RECORDS WRITTEN TO OUT01 ='.                            01110001
011200     05  PV-MSG-1-COUNT               PIC Z,ZZZ,ZZZ,ZZ9.          01120001
011300                                                                  01130001
011310 01  PV-COUNT-MSG-2.                                              01131011
011320     05  FILLER                       PIC X(26) VALUE             01132011
011330         'FETCHES                  ='.                            01133011
011340     05  PV-MSG-2-COUNT               PIC Z,ZZZ,ZZZ,ZZ9.          01134011
011350                                                                  01135011
011400 01  PV-COUNT-MSG-4.                                              01140001
011500     05  FILLER                       PIC X(26) VALUE             01150001
011600         'RECORDS READ             ='.                            01160001
011700     05  PV-MSG-READ-COUNT            PIC Z,ZZZ,ZZZ,ZZ9.          01170001
011800                                                                  01180001
011900 01  CC-CONTROL-CARD.                                             01190001
012000     05  CC-PROGRAM-NAME              PIC X(08)    VALUE SPACES.  01200001
012100     05  FILLER                       PIC X(72)    VALUE SPACES.  01210001
012200                                                                  01220001
012300*    STORE TRAILER UNLOADED PREVIOUS DAY FILE.                    01230002
012400     COPY SURD060.                                                01240002
012500                                                                  01250001
012600*    REPORT EXTRACT FILE                                          01260001
012700     COPY SURD061.                                                01270002
012800/                                                                 01280001
012900*    OUTBOUND CARTON TABLE                                        01290003
013000     EXEC SQL                                                     01300001
013100         INCLUDE SUT00024                                         01310003
013200     END-EXEC.                                                    01320001
013300                                                                  01330001
013310*    OUTBOUND UPC TABLE                                           01331003
013320     EXEC SQL                                                     01332003
013330         INCLUDE SUT00028                                         01333003
013340     END-EXEC.                                                    01334003
013350                                                                  01335003
015400     EXEC SQL                                                     01540001
015500         INCLUDE SQLCA                                            01550001
015600     END-EXEC.                                                    01560001
015700                                                                  01570001
015800     COPY SQLCA2.                                                 01580001
015900                                                                  01590001
016000     COPY DPWS004.                                                01600001
016100*---------------------------------------------------------------* 01610001
016200* TRIP CURSOR                                                     01620003
016300*---------------------------------------------------------------* 01630001
016400     EXEC SQL                                                     01640001
016500          DECLARE TRIP-CSR CURSOR FOR                             01650001
016600              SELECT   A.DEST_LOC_NBR                             01660003
016700                     , B.UPC_NBR                                  01670003
016710                     , B.SHPD_UNT_QTY                             01671003
016800                FROM   SUT_OTBND_CART A                           01680003
016810                     , SUT_OTBND_UPC  B                           01681003
016820               WHERE  A.SHIPT_UNT_ID  = B.SHIPT_UNT_ID            01682010
016900                 AND  A.OTBND_TRIP_ID  = :PV-OTBND-TRIP-ID        01690010
017000                 AND  B.SHPD_UNT_QTY   > 0                        01700005
017400     END-EXEC.                                                    01740001
017500                                                                  01750001
017600*---------------------------------------------------------------* 01760001
017700 PROCEDURE DIVISION.                                              01770001
017800                                                                  01780001
017900     PERFORM 1000-INITIALIZATION.                                 01790001
018000                                                                  01800001
018100     PERFORM 2000-PROCESS UNTIL PS-EOF-EXTRACT-YES                01810001
018200                                                                  01820001
018300     PERFORM 9000-QUIT.                                           01830001
018400                                                                  01840001
018500     GOBACK.                                                      01850001
018600/                                                                 01860001
018700 1000-INITIALIZATION.                                             01870001
018800     MOVE '1000-INITIALIZATION         '  TO PV-ABEND-PARAGRAPH.  01880001
018900                                                                  01890001
019000     OPEN INPUT STORES-UNLOADED-TRAILERS                          01900002
019100     OPEN OUTPUT REPORT-EXTRACT-FILE                              01910001
019200                                                                  01920001
019600     PERFORM 8000-READ-EXTRACT.                                   01960001
019700                                                                  01970001
019800     IF PS-EOF-EXTRACT-YES                                        01980001
019900         DISPLAY SPACES                                           01990001
020000         DISPLAY ALL '*'                                          02000001
020100         DISPLAY '  INPUT FILE IS EMPTY '                         02010001
020200         DISPLAY ALL '*'                                          02020001
020300         DISPLAY SPACES                                           02030001
020400     END-IF.                                                      02040001
020500/                                                                 02050001
020600 2000-PROCESS.                                                    02060001
020700                                                                  02070001
020800     MOVE '2000-PROCESS'                  TO PV-ABEND-PARAGRAPH.  02080001
021500                                                                  02150001
021501     PERFORM 7300-PROCESS-TRIP-CURSOR.                            02150104
021540                                                                  02154004
021600     PERFORM 8000-READ-EXTRACT.                                   02160001
021700/                                                                 02170001
021800 2200-BUILD-EXTRACT-REC.                                          02180002
021900                                                                  02190001
022000     INITIALIZE SU061-STR-UNLOAD-ITEM-REC                         02200002
022100     MOVE SU060-STR-UNLOAD-DATE       TO SU061-STR-UNLOAD-DATE.   02210002
022300     MOVE SUT00024-DEST-LOC-NBR       TO SU061-DEST-LOC-NBR.      02230004
022310     MOVE SUT00028-UPC-NBR            TO SU061-UPC-NBR.           02231004
022400     MOVE SUT00028-SHPD-UNT-QTY       TO SU061-SHPD-UNT-QTY.      02240004
028200                                                                  02820001
028300/                                                                 02830001
042300******************************************************************04230001
042400 7300-PROCESS-TRIP-CURSOR.                                        04240004
042500     MOVE 'N'  TO  PS-TRIP-CSR-SW.                                04250001
042700                                                                  04270001
042800     PERFORM 7310-OPEN-TRIP-CSR.                                  04280001
042900                                                                  04290001
043000     PERFORM 7320-FETCH-TRIP-CSR                                  04300001
043100         UNTIL PS-END-OF-TRIP-CSR.                                04310001
043200                                                                  04320001
043300     PERFORM 7330-CLOSE-TRIP-CSR.                                 04330001
043400                                                                  04340001
044400******************************************************************04440001
044500*  OPEN THE CURSOR.                                               04450001
044600******************************************************************04460001
044700 7310-OPEN-TRIP-CSR.                                              04470001
044800                                                                  04480001
044900      EXEC SQL                                                    04490001
045000           OPEN TRIP-CSR                                          04500001
045100      END-EXEC.                                                   04510001
045200                                                                  04520001
045300      EVALUATE TRUE                                               04530001
045400          WHEN SQLCODE = ZERO                                     04540001
045500          WHEN SQLCODE = -904                                     04550001
045600          WHEN SQLCODE = -911                                     04560001
045700              CONTINUE                                            04570001
045800          WHEN SQLWARN0 NOT = SPACES                              04580001
045900          WHEN SQLCODE < ZERO                                     04590001
046000          WHEN SQLCODE > ZERO                                     04600001
046100              MOVE '7310-OPEN-CURSOR' TO PV-ABEND-PARAGRAPH       04610001
046200              MOVE 'OPEN THE TRIP-CSR '                           04620001
046300                                TO PV-DB2-OPERATION-ATTEMPTED     04630001
046400              PERFORM 9100-SQL-ABEND                              04640001
046500      END-EVALUATE.                                               04650001
046600                                                                  04660001
046700******************************************************************04670001
046800*  FETCH THE ROW FROM THE RESULTS TABLE USING THE CURSOR.         04680001
046900******************************************************************04690001
047000 7320-FETCH-TRIP-CSR.                                             04700001
047100                                                                  04710001
047200     EXEC SQL                                                     04720001
047300          FETCH TRIP-CSR                                          04730001
047400           INTO :SUT00024-DEST-LOC-NBR                            04740003
047410               ,:SUT00028-UPC-NBR                                 04741003
047420               ,:SUT00028-SHPD-UNT-QTY                            04742003
047500     END-EXEC.                                                    04750001
047600                                                                  04760001
047700     EVALUATE TRUE                                                04770001
047800         WHEN SQLCODE = ZERO                                      04780001
047810             PERFORM 2200-BUILD-EXTRACT-REC                       04781005
047820             PERFORM 8200-WRITE-SU061                             04782005
047900             ADD +1 TO PV-TRIP-CNT                                04790003
050500         WHEN SQLCODE = +100                                      05050001
050600             SET  PS-END-OF-TRIP-CSR TO TRUE                      05060001
050700         WHEN SQLWARN0 NOT = SPACES                               05070001
050800         WHEN SQLCODE < ZERO                                      05080001
050900         WHEN SQLCODE > ZERO                                      05090001
051000             MOVE '7320-FETCH-TRIP-CSR'  TO PV-ABEND-PARAGRAPH    05100001
051100             MOVE 'FETCH THE TRIP-CSR '                           05110001
051200                                 TO PV-DB2-OPERATION-ATTEMPTED    05120001
051300             PERFORM 9100-SQL-ABEND                               05130001
051400     END-EVALUATE.                                                05140001
051500                                                                  05150001
051600******************************************************************05160001
051700*  CLOSE THE CURSOR.                                              05170001
051800******************************************************************05180001
051900 7330-CLOSE-TRIP-CSR.                                             05190001
052000      EXEC SQL                                                    05200001
052100          CLOSE TRIP-CSR                                          05210001
052200      END-EXEC.                                                   05220001
052300                                                                  05230001
052400      EVALUATE TRUE                                               05240001
052500          WHEN SQLCODE = ZERO                                     05250001
052600          WHEN SQLCODE = -904                                     05260001
052700          WHEN SQLCODE = -911                                     05270001
052800              CONTINUE                                            05280001
052900          WHEN SQLWARN0 NOT = SPACES                              05290001
053000          WHEN SQLCODE < ZERO                                     05300001
053100          WHEN SQLCODE > ZERO                                     05310001
053200              MOVE '7330-CLOSE-TRIP-CSR' TO PV-ABEND-PARAGRAPH    05320001
053300              MOVE 'CLOSE THE TRIP-CSR   '                        05330001
053400                              TO PV-DB2-OPERATION-ATTEMPTED       05340001
053500              PERFORM 9100-SQL-ABEND                              05350001
053600      END-EVALUATE.                                               05360001
053700                                                                  05370001
053800******************************************************************05380001
057500                                                                  05750014
057600 8000-READ-EXTRACT.                                               05760001
057700                                                                  05770001
057800     MOVE '8000-READ-EXTRACT   '  TO PV-ABEND-PARAGRAPH.          05780001
057900*                                                                 05790001
058000     READ STORES-UNLOADED-TRAILERS                                05800005
058100         INTO                                                     05810001
058200             SU060-BMC-UNLOAD-SU-REC                              05820003
058300         AT END                                                   05830001
058400             SET PS-EOF-EXTRACT-YES   TO TRUE                     05840001
058500         NOT AT END                                               05850001
058600             ADD 1                    TO PV-READ-COUNTER          05860001
058700                                         PV-COMMIT-COUNTER        05870001
058710             MOVE SU060-OTBND-TRIP-ID  TO PV-OTBND-TRIP-ID        05871009
058800     END-READ.                                                    05880001
058900                                                                  05890001
059000 8200-WRITE-SU061.                                                05900003
059100     MOVE '8200-WRITE-SU061    '  TO PV-ABEND-PARAGRAPH.          05910003
059200     WRITE                                                        05920001
059300         REPORT-EXTRACT-REC                                       05930001
059400         FROM SU061-STR-UNLOAD-ITEM-REC                           05940003
059500     END-WRITE.                                                   05950001
059600     ADD 1                            TO PV-WRITE-1-COUNTER.      05960001
059700/                                                                 05970001
059800 9000-QUIT.                                                       05980001
059900                                                                  05990001
060000     CLOSE STORES-UNLOADED-TRAILERS                               06000005
060100           REPORT-EXTRACT-FILE                                    06010001
060200                                                                  06020001
060300     MOVE PV-READ-COUNTER             TO PV-MSG-READ-COUNT        06030001
060400     DISPLAY PV-COUNT-MSG-4.                                      06040001
060500                                                                  06050001
060810     MOVE PV-TRIP-CNT                 TO PV-MSG-2-COUNT           06081011
060820     DISPLAY PV-COUNT-MSG-2.                                      06082011
060830                                                                  06083011
060840     MOVE PV-WRITE-1-COUNTER          TO PV-MSG-1-COUNT           06084011
060850     DISPLAY PV-COUNT-MSG-1.                                      06085011
060860                                                                  06086011
060900/                                                                 06090001
061000 9100-SQL-ABEND.                                                  06100001
061100******************************************************************06110001
061200*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    06120001
061300*  ERROR OR WARNING CODE OCCURS.                                  06130001
061400******************************************************************06140001
061500     DISPLAY '9100-SQL-ABEND'.                                    06150001
061600     DISPLAY '** ABEND     **'.                                   06160001
061700     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        06170001
061800     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.             06180001
061900     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     06190001
062000     DISPLAY '**              ** = '                              06200001
062100     MOVE SQLCODE TO PV-SQL-CODE.                                 06210001
062200     DISPLAY '** SQL CODE  ** = ' PV-SQL-CODE.                    06220001
062300     MOVE +4013 TO PV-ABEND-CODE.                                 06230001
062400     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         06240001
062500                                                                  06250001
