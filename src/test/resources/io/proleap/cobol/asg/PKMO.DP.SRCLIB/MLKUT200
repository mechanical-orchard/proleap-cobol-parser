       IDENTIFICATION DIVISION.                                                 
                                                                                
       PROGRAM-ID.    MLKUT200                                                  
       AUTHOR.        BOB FORD.                                                 
       INSTALLATION.  KOHLS DEPARTMENT STORES.                                  
       DATE-WRITTEN.  01-11-2005.                                               
       DATE-COMPILED.                                                           
                                                                                
      ******************************************************************        
      *           MLKUT200 - COMMON CRITERIA AND CONTROL EXTRACT                
      *                                                                         
      * THIS PROGRAM IS USED TO CREATE SELECT CRITERIA FOR USE BY LATER         
      * PROGRAMS.  IT READS AN INPUT FILE CONTAINING THE DB2 TABLE TO           
      * BUILD THE CRITERIA FOR, AN OPTIONAL DATE PARAMETER TO BASE              
      * THE CRITERIA ON, AND AN OPTIONAL DATASET NAME FOR HISTORICAL            
      * DATA EXTRACT.                                                           
      *                                                                         
      *   IF THE DATE PARAMETER IS NOT SUPPLIED THE TMLCNTL TABLE IS            
      *   READ AND USED TO BUILD THE CRITERIA, OTHERWISE THE DATE IS            
      *   VALIDATED AND USED TO READ THE TDTATTR TABLE, AND THE                 
      *   RESULTING DATA IS USED.                                               
      *                                                                         
      *   IF THE HISTORICAL DATASET NAME IS BLANK, ONLY CHECK TO                
      *   SEE WHETHER THE OPERATIONAL DATE IS THE FIRST FISCAL WEEK OF          
      *   THE MONTH OR NOT.                                                     
      *   IF THE HISTORICAL DATASET NAME IS NOT BLANK, CHECK TO                 
      *   SEE WHETHER THE FILE ALREADY EXISTED OR NOT WHEN THE                  
      *   OPERATIONAL DATE IS NOT THE FIRST FISCAL WEEK OF THE MONTH.           
      *   THIS PROGRAM USE 'DYNALC' ASSEMBLER ROUTINE TO TEST                   
      *   ALLOCATING THE OPTIONAL HISTORICAL DATASET TO INP99.                  
      *                                                                         
      * CURRENTLY THE TABLES THAT CRITERIA CAN BE BUILT FOR ARE:                
      *                                                                         
      ****    MLT_WKLY_SUM                                                      
      ****    MLT_MNLY_SUM                                                      
34517 ****    MLT_MNLY_VND                                                      
28582 ****    MLT_WKLY_VND                                                      
      ****    MLT_DEPT_BRND_VEND                                                
      *                                                                         
      * ANY OTHER TABLE ON THE INPUT CARD IS INVALID.                           
      ******************************************************************        
      ******************** HISTORY OF CHANGES **************************        
      *                                                                *        
      * WR/PROJ  DATE        DESCRIPTION OF CHANGES                    *        
      * -------  ----------  ----------------------------------------  *        
      * W20445   01-11-2005  B. FORD - INITIAL INSTALL                 *        
      * W23843   03-09-2005  V. LEE YANG - SET RECOUNT FOR TAPE DATASET*        
X23843* W23843   04-19-2005  V. LEE YANG - ADD TABLE NAME TO REQUEST   *        
      *                      TYPE CC OUTPUT.                           *        
      *          10-16-2005  M. MACHNIK  - ADD MLT_DEPT_BRND_VEND      *        
      *                      TO CC-EXCEPTION-TABLES AND                *        
      *                      CC-WEEKLY-SUMMARY BV DATA SMOOTHING       *        
R28582* W23843   12-21-2006  R.JANSSEN - FCALC IS NOW A MONTHLY TABLE. *        
J28582* W28582   02-12-2007  J.SELWITSCHKA                             *        
J28582*                      WRITE A MONTH-END DATE CONTROL CARD TO    *        
J28582*                      EMBED IN SORTCARD MLSR530. USED IN MLK107A*        
J28582*                      TO BUILD SHRINK FOR B-CALC AND F-CALC.    *        
X28582* W28582   08-08-2007  R.JANSSEN - WKLY VND LVL DETAIL LEDGER    *        
W34517* W34517   10-14-2008  INFOSYS                                   *        
W34517*                      ADDED TABLE MLT_MNLY_VND AS PART OF BV/VA *        
W34517*                      SPLIT.                                    *        
W35378* W35378   03-12-2009  BMC TO DSNTIAUL CONVERSION.               *        
W35378*                      CHANGE CLAUSE FOR PARTITIONS LISTING.     *        
RONNA * RONNA    10-18-2018  REMOVE REFERENCES TO SYSPLAN TABLE        *        
RONNA * RONNA                FOR THE MAINFRAME REFACTORING EFFORT      *        
RONNA * RONNA                                                          *        
RONNA2* RONNA2   12-21-2018  REMOVE ADDITIONAL CODE THAT ISN'T NEEDED  *        
RONNA2* RONNA2               AND DOES NOT WORK WITH THE LUW SYSTEM     *        
RONNA2* RONNA2               THIS INCLUDES:                                     
RONNA2* RONNA2                  4250-CHECK-TABLE-NAME PARAGRAPH        *        
RONNA2* RONNA2                  6100-GET-COLNAME PARAGRAPH             *        
RONNA2* RONNA2                  6000-COUNT-PARTITIONS PARAGRAPH        *        
RONNA2* RONNA2                  THE INCLUDE FOR SYSINDEX, SYSKEY AND   *        
RONNA2* RONNA2                      SYSTABPT                           *        
RONNA2* RONNA2                                                         *        
      ******************************************************************        
                                                                                
       ENVIRONMENT DIVISION.                                                    
                                                                                
       CONFIGURATION SECTION.                                                   
       SOURCE-COMPUTER.        IBM-3090.                                        
       OBJECT-COMPUTER.        IBM-3090.                                        
       INPUT-OUTPUT SECTION.                                                    
       FILE-CONTROL.                                                            
           SELECT CONTROL-CARD-FILE                                             
               ASSIGN TO INP01.                                                 
                                                                                
           SELECT HISTORICAL-DATA-FILE                                          
               ASSIGN TO INP99.                                                 
                                                                                
           SELECT DB2-SYSTEM-CNTL                                               
               ASSIGN TO SYSTSIN.                                               
                                                                                
           SELECT SEASON-TO-DATE-CC                                             
               ASSIGN TO OUT01.                                                 
                                                                                
           SELECT BEGIN-SEASON-CC                                               
               ASSIGN TO OUT02.                                                 
                                                                                
           SELECT PREV-FISCAL-CC                                                
               ASSIGN TO OUT03.                                                 
                                                                                
           SELECT CURR-FISCAL-CC                                                
               ASSIGN TO OUT04.                                                 
                                                                                
           SELECT SHRINK-CC                                                     
               ASSIGN TO OUT05.                                                 
                                                                                
           SELECT REQUEST-TABLE-TYPE                                            
               ASSIGN TO OUT06.                                                 
                                                                                
J28582     SELECT MONTH-END-DATE-CC                                             
J28582         ASSIGN TO OUT07.                                                 
J28582                                                                          
       DATA DIVISION.                                                           
       FILE SECTION.                                                            
                                                                                
       FD  CONTROL-CARD-FILE                                                    
           LABEL RECORDS ARE STANDARD                                           
           RECORDING MODE IS F                                                  
           BLOCK CONTAINS 0 RECORDS.                                            
       01  CONTROL-CARD-RECORD             PIC X(80).                           
                                                                                
       FD  HISTORICAL-DATA-FILE                                                 
           LABEL RECORDS ARE STANDARD                                           
           RECORDING MODE IS F                                                  
           BLOCK CONTAINS 0 RECORDS.                                            
       01  HISTORICAL-DATA-REC             PIC X(400).                          
                                                                                
       FD  DB2-SYSTEM-CNTL                                                      
           LABEL RECORDS ARE STANDARD                                           
           RECORDING MODE IS F                                                  
           BLOCK CONTAINS 0 RECORDS.                                            
       01  DB2-SYSTEM-CNTL-REC             PIC X(80).                           
                                                                                
       FD  SEASON-TO-DATE-CC                                                    
           LABEL RECORDS ARE STANDARD                                           
           RECORDING MODE IS F                                                  
           BLOCK CONTAINS 0 RECORDS.                                            
       01  SEASON-TO-DATE-REC              PIC X(80).                           
                                                                                
       FD  BEGIN-SEASON-CC                                                      
           LABEL RECORDS ARE STANDARD                                           
           RECORDING MODE IS F                                                  
           BLOCK CONTAINS 0 RECORDS.                                            
       01  BEGIN-SEASON-REC                PIC X(80).                           
                                                                                
       FD  PREV-FISCAL-CC                                                       
           LABEL RECORDS ARE STANDARD                                           
           RECORDING MODE IS F                                                  
           BLOCK CONTAINS 0 RECORDS.                                            
       01  PREV-FISCAL-REC                 PIC X(80).                           
                                                                                
       FD  CURR-FISCAL-CC                                                       
           LABEL RECORDS ARE STANDARD                                           
           RECORDING MODE IS F                                                  
           BLOCK CONTAINS 0 RECORDS.                                            
       01  CURR-FISCAL-REC                 PIC X(80).                           
                                                                                
       FD  SHRINK-CC                                                            
           LABEL RECORDS ARE STANDARD                                           
           RECORDING MODE IS F                                                  
           BLOCK CONTAINS 0 RECORDS.                                            
       01  SHRINK-REC                      PIC X(80).                           
                                                                                
       FD  REQUEST-TABLE-TYPE                                                   
           LABEL RECORDS ARE STANDARD                                           
           RECORDING MODE IS F                                                  
           BLOCK CONTAINS 0 RECORDS.                                            
       01  REQUEST-TABLE-TYPE-REC          PIC X(80).                           
                                                                                
J28582 FD  MONTH-END-DATE-CC                                                    
J28582     LABEL RECORDS ARE STANDARD                                           
J28582     RECORDING MODE IS F                                                  
J28582     BLOCK CONTAINS 0 RECORDS.                                            
J28582 01  MONTH-END-DATE-REC              PIC X(80).                           
J28582                                                                          
                                                                                
       WORKING-STORAGE SECTION.                                                 
                                                                                
       01  FILLER                          PIC X(60)       VALUE                
           '**** WORKING STORAGE BEGINS ****'.                                  
                                                                                
       01  ABEND-CODE                      PIC S9(04)      VALUE ZEROES         
                               COMP SYNC.                                       
           88  SQL-ABEND                                   VALUE +4013.         
           88  NON-SQL-ABEND                               VALUE +4003.         
                                                                                
       01  FILLER                          PIC X(60)       VALUE                
           '**** CONTROL CARD AREA BEGINS ****'.                                
                                                                                
       01  CC-DB2-SYSTEM-CNTL-REC          PIC  X(80)      VALUE SPACES.        
                                                                                
       01  CC-CONTROL-CARD-REC.                                                 
           05  CC-COMMENT-IND              PIC  X(01)      VALUE SPACES.        
               88  CC-COMMENT-LINE                         VALUE '*'.           
               88  CC-NOT-COMMENT-LINE                     VALUE ' '.           
           05  CC-TABLE-NAME               PIC  X(18)      VALUE SPACES.        
               88  CC-EXCEPTION-TABLES                     VALUES ARE           
                   'MLT_MNLY_SUM'                                               
                   'MLT_WKLY_SUM'                                               
W34517             'MLT_MNLY_VND'                                               
X28582             'MLT_WKLY_VND'                                               
                   'MLT_DEPT_BRND_VND'.                                         
               88  CC-MONTHLY-SUMMARY                      VALUE                
                   'MLT_MNLY_SUM'                                               
W34517             'MLT_MNLY_VND'                                               
R28582             'MLT_DEPT_BRND_VND'.                                         
               88  CC-WEEKLY-SUMMARY                       VALUE                
X28582             'MLT_WKLY_SUM'                                               
X28582             'MLT_WKLY_VND'.                                              
           05  FILLER                      PIC  X(01)      VALUE SPACES.        
           05  CC-OPT-REQ-DATE             PIC  X(10)      VALUE SPACES.        
           05  FILLER REDEFINES CC-OPT-REQ-DATE.                                
               10  CC-OPT-REQ-DATE-CCYY    PIC  X(04).                          
               10  FILLER                  PIC  X(01).                          
                   88  CC-VALID-OPT-REQ-DASH-1             VALUE '-'.           
               10  CC-OPT-REQ-DATE-MM      PIC  X(02).                          
               10  FILLER                  PIC  X(01).                          
                   88  CC-VALID-OPT-REQ-DASH-2             VALUE '-'.           
               10  CC-OPT-REQ-DATE-DD      PIC  X(02).                          
           05  FILLER                      PIC  X(01)      VALUE SPACES.        
           05  CC-OPT-HIST-DSN             PIC  X(44)      VALUE SPACES.        
           05  FILLER                      PIC  X(05)      VALUE SPACES.        
                                                                                
       01  FILLER                          PIC X(60)       VALUE                
           '**** PROGRAM CONSTANT/SWITCH AREA BEGINS ****'.                     
                                                                                
       01  PC-PROGRAM-CONSTANTS.                                                
           05  PC-PROGRAM-NAME             PIC  X(08)      VALUE                
               'MLKUT200'.                                                      
           05  PC-MONTHLY-TBL-LVL-LIT      PIC  X(01)      VALUE 'M'.           
           05  PC-WEEKLY-TBL-LVL-LIT       PIC  X(01)      VALUE 'W'.           
           05  PC-MONTHLY-PART-COUNT       PIC  S9(04)     VALUE +12            
                               COMP.                                            
           05  PC-WEEKLY-PART-COUNT        PIC  S9(04)     VALUE +53            
                               COMP.                                            
                                                                                
                                                                                
       01  PS-PROGRAM-SWITCHES.                                                 
           05  PS-BUILD-HIST-CNTL-SW       PIC  X(01)      VALUE 'N'.           
               88  PS-BUILD-HIST-CNTL                      VALUE 'Y'.           
               88  PS-NOT-BUILD-HIST-CNTL                  VALUE 'N'.           
           05  PS-EOF-DB2-SYSTEM-CNTL-SW   PIC  X(01)      VALUE 'N'.           
               88  PS-EOF-DB2-SYSTEM-CNTL                  VALUE 'Y'.           
               88  PS-NOT-EOF-DB2-SYSTEM-CNTL              VALUE 'N'.           
           05  PS-EOF-CONTROL-CARD-SW      PIC  X(01)      VALUE 'N'.           
               88  PS-EOF-CONTROL-CARD                     VALUE 'Y'.           
               88  PS-NOT-EOF-CONTROL-CARD                 VALUE 'N'.           
           05  PS-EOF-PARTN-CNTL-SW        PIC  X(01)      VALUE 'N'.           
               88  PS-EOF-PARTN-CNTL                       VALUE 'Y'.           
               88  PS-NOT-EOF-PARTN-CNTL                   VALUE 'N'.           
           05  PS-VALIDATE-CONTROL-SW      PIC  X(01)      VALUE SPACE.         
               88  PS-VALID-CONTROL-FOUND                  VALUE 'F'.           
               88  PS-CONTROL-CARD-ERROR                   VALUE 'E'.           
           05  PS-BUILD-FILE-SW            PIC  X(01)      VALUE SPACE.         
               88  PS-BUILD-SEASON-TO-DATE                 VALUE '1'.           
               88  PS-BUILD-BEGIN-SEASON                   VALUE '2'.           
               88  PS-BUILD-PREV-FISCAL                    VALUE '3'.           
               88  PS-BUILD-CURR-FISCAL                    VALUE '4'.           
               88  PS-BUILD-SHRINK                         VALUE '5'.           
               88  PS-BUILD-REQUEST-TYPE                   VALUE '6'.           
J28582         88  PS-BUILD-MONTH-END-DATE                 VALUE '7'.           
                                                                                
       01  FILLER                          PIC X(60)       VALUE                
           '**** PROGRAM VARIABLE AREA BEGINS ****'.                            
                                                                                
       01  PV-PROGRAM-VARIABLES.                                                
           05  PV-PARAGRAPH-NAME           PIC  X(30)      VALUE SPACES.        
           05  PV-ABEND-MESSAGE            PIC  X(75)      VALUE SPACES.        
           05  PV-OPERATION-ATTEMPTED      PIC  X(40)      VALUE SPACES.        
           05  PV-PROGRAM-MESSAGE          PIC  X(40)      VALUE SPACES.        
               88  PV-MSG-01                               VALUE                
                   'NO VALID CONTROL CARD FOUND           '.                    
               88  PV-MSG-02                               VALUE                
                   'TABLE-NAME ON INPUT CARD INVALID      '.                    
               88  PV-MSG-03                               VALUE                
                   'INPUT DATE INVALID - USE CCYY-MM-DD   '.                    
               88  PV-MSG-04                               VALUE                
                   'MULTIPLE CONTROL CARDS FOUND          '.                    
               88  PV-MSG-05                               VALUE                
                   'ML PARTITION CONTROL TABLE ISSUE      '.                    
           05  PV-REQUEST-DATE             PIC  X(10)      VALUE SPACES.        
           05  PV-INDEX-COLNAME            PIC  X(18)      VALUE SPACES.        
               88  PV-INDEX-WEEKLY-COLNAME                 VALUE                
                   'FSCL_WK_END_DTE'.                                           
               88  PV-INDEX-MONTHLY-COLNAME                VALUE                
                   'FSCL_MN_END_DTE'.                                           
           05  PV-FSCL-MN-NBR              PIC  X(02)      VALUE SPACES.        
           05  PV-FSCL-MN-NBR-9 REDEFINES PV-FSCL-MN-NBR                        
                                           PIC  9(02).                          
           05  PV-FSCL-WK-NBR              PIC  X(02)      VALUE SPACES.        
           05  PV-FSCL-WK-NBR-9 REDEFINES PV-FSCL-WK-NBR                        
                                           PIC  9(02).                          
           05  PV-MLT-BEG-FSCL-DTE         PIC  X(10)      VALUE SPACES.        
           05  PV-MLT-END-FSCL-DTE         PIC  X(10)      VALUE SPACES.        
           05  PV-PARTITION-COUNT          PIC S9(9)       VALUE ZEROES         
                               COMP.                                            
           05  PV-START-PARTITION          PIC S9(04)      VALUE ZEROES         
                               COMP.                                            
           05  PV-STOP-PARTITION           PIC S9(04)      VALUE ZEROES         
                               COMP.                                            
           05  PV-SUB1                     PIC S9(04)      VALUE ZEROES         
                               COMP-3.                                          
           05  PV-DB2-CNTL-HOLD-1          PIC  X(80)      VALUE SPACES.        
           05  PV-DB2-CNTL-HOLD-2          PIC  X(80)      VALUE SPACES.        
           05  PV-DB2-PLAN-NAME            PIC  X(08)      VALUE SPACES.        
           05  PV-FIELDS-COMPLETED         PIC S9(04)      VALUE ZEROES         
                               COMP-3.                                          
                                                                                
       01  PA-PROGRAM-ACCUMULATORS.                                             
           05  PA-INPUT-COUNTS.                                                 
               10  PA-INPUT-COUNT-IN       PIC  9(8)       VALUE ZEROES.        
           05  PA-OUTPUT-COUNTS.                                                
               10  PA-SEASON-TO-DATE-COUNT PIC  9(8)       VALUE ZEROES.        
               10  PA-BEG-SEASON-COUNT     PIC  9(8)       VALUE ZEROES.        
               10  PA-PREV-FSCL-COUNT      PIC  9(8)       VALUE ZEROES.        
               10  PA-CURR-FSCL-COUNT      PIC  9(8)       VALUE ZEROES.        
               10  PA-SHRINK-COUNT         PIC  9(8)       VALUE ZEROES.        
                                                                                
       01  FILLER                          PIC X(60)       VALUE                
           '**** PROGRAM RECORDS AREA BEGINS ****'.                             
                                                                                
       01  PR-PROGRAM-RECORDS.                                                  
           05  PR-WORK-RECORD              PIC  X(80)      VALUE SPACES.        
                                                                                
           05  PR-REQUEST-TYPE.                                                 
               10  PR-REQUEST-TYPE-IND     PIC  X(01)      VALUE SPACE.         
                   88  PR-REQUEST-TYPE-COMMENT             VALUE '*'.           
               10  PR-REQUEST-TYPE-SW      PIC  X(08)      VALUE SPACES.        
                   88  PR-REQUEST-TYPE-WEEKLY              VALUE                
                       'WEEKLY  '.                                              
                   88  PR-REQUEST-TYPE-MONTHLY             VALUE                
                       'MONTHLY '.                                              
               10  FILLER                  PIC  X(01)      VALUE SPACE.         
               10  PR-REQUEST-TYPE-DATE    PIC  X(10)      VALUE SPACES.        
X23843         10  FILLER                  PIC  X(01)      VALUE SPACE.         
X23843         10  PR-REQUEST-TABLE-NAME   PIC  X(18)      VALUE SPACES.        
X23843         10  FILLER                  PIC  X(41)      VALUE SPACES.        
                                                                                
J28582     05  PR-SORT-MONTH-END-DATE.                                          
J28582         10  FILLER                  PIC  X(16)      VALUE SPACES.        
J28582         10  FILLER                  PIC  X(02)      VALUE "C'".          
J28582         10  PR-MONTH-END-DATE       PIC  X(10)      VALUE SPACES.        
J28582         10  FILLER                  PIC  X(02)      VALUE "',".          
J28582         10  FILLER                  PIC  X(12)      VALUE SPACES.        
J28582         10  FILLER                  PIC  X(20)      VALUE                
J28582                 '* ML070-FSCL-END-DTE'.                                  
J28582         10  FILLER                  PIC  X(10)      VALUE SPACES.        
                                                                                
           05  PR-WHERE-RECORD.                                                 
               10  FILLER                  PIC  X(14)      VALUE SPACES.        
                   88  PR-NO-STMT                          VALUE SPACES.        
                   88  PR-WHERE-STMT                       VALUE                
                       '       WHERE '.                                         
                   88  PR-AND-STMT                         VALUE                
                       '         AND '.                                         
               10  PR-COLNAME              PIC  X(18)      VALUE SPACES.        
               10  FILLER                  PIC  X(04)      VALUE SPACES.        
                   88  PR-GREATER-THAN-OR-EQUAL            VALUE ' >= '.        
                   88  PR-LESS-THAN-OR-EQUAL               VALUE ' <= '.        
                   88  PR-EQUAL-TO                         VALUE '  = '.        
               10  FILLER                  PIC  X(01)      VALUE QUOTE.         
               10  PR-FSCL-DATE            PIC  X(10)      VALUE SPACES.        
               10  FILLER                  PIC  X(01)      VALUE QUOTE.         
               10  FILLER                  PIC  X(32)      VALUE SPACES.        
                                                                                
           05  PR-PARTITION-RECORD.                                             
W35378         10  FILLER                  PIC  X(22)      VALUE SPACES.        
                   88  PR-NO-PART-STMT                     VALUE SPACES.        
                   88  PR-PART-STMT                        VALUE                
W35378                 ' WHERE PARTN_NBR IN ( '.                                
W35378         10  PR-PART-NBR-AREA OCCURS 12 TIMES.                            
                   15  PR-PART-NBR         PIC  9(03)      VALUE ZEROES.        
                   15  FILLER              PIC  X(01)      VALUE SPACE.         
                       88  PR-PART-NBR-COMMA               VALUE ','.           
                       88  PR-PART-NBR-NO-COMMA            VALUE SPACE.         
W35378         10  FILLER                  PIC  X(10)      VALUE SPACES.        
W35378     05  PR-PARTITION-RECORD-END.                                         
W35378         10  FILLER                  PIC  X(01)      VALUE SPACE.         
W35378         10  PR-PART-END             PIC  X(03)      VALUE ' );'.         
W35378         10  FILLER                  PIC  X(76)      VALUE SPACE.         
                                                                                
       01  FILLER                          PIC X(60)       VALUE                
           '**** DYNAMIC ALLOCATION AREA BEGINS ****'.                          
                                                                                
      ****************************************************                      
      *  DYNAMIC ALLOCATION COMM OR WORKING STORAGE      *                      
      ****************************************************                      
           COPY DPWS023.                                                        
                                                                                
      ****************************************************                      
      *  COMMON RECALC RECORD LAYOUT                     *                      
      ****************************************************                      
           COPY MLRD070.                                                        
                                                                                
                                                                                
       01  FILLER                          PIC X(60)       VALUE                
           '**** DB2 AND RELATING INFORMATION AREA BEGINS ****'.                
                                                                                
      ****************************************************                      
      *  COMMUNICATION AREAS FOR DB2                     *                      
      ****************************************************                      
           EXEC SQL                                                             
               INCLUDE SQLCA                                                    
           END-EXEC.                                                            
                                                                                
      ****************************************************                      
      *  ERROR MESSAGE AREA FOR DB2                      *                      
      ****************************************************                      
           COPY DPWS004.                                                        
                                                                                
                                                                                
      ****************************************************                      
      * M/L PARTITION CONTROL TABLE                                             
      ****************************************************                      
           EXEC SQL                                                             
               INCLUDE MLT00003                                                 
           END-EXEC.                                                            
                                                                                
      ****************************************************                      
      * M/L OPEN FISCAL DATE INFORMATION TABLE                                  
      ****************************************************                      
           EXEC SQL                                                             
               INCLUDE TMLCNTL                                                  
           END-EXEC.                                                            
                                                                                
      ****************************************************                      
      *  M/L DATE TABLE                                                         
      ****************************************************                      
           EXEC SQL                                                             
               INCLUDE TDTATTR                                                  
           END-EXEC.                                                            
                                                                                
      ****************************************************                      
      *  SYSTEM TABLE INFORMATION                                               
      ****************************************************                      
RONNA2*    EXEC SQL                                                             
RONNA2*        INCLUDE SYSTABLE                                                 
RONNA2*    END-EXEC.                                                            
                                                                                
      ****************************************************                      
      *  SYSTEM TABLE COLUMNS INFORMATION                                       
      ****************************************************                      
RONNA2*    EXEC SQL                                                             
RONNA2*        INCLUDE SYSCOL                                                   
RONNA2*    END-EXEC.                                                            
                                                                                
RONNA ****************************************************                      
RONNA *  SYSTEM PLAN INFORMATION                                                
RONNA ****************************************************                      
RONNA *    EXEC SQL                                                             
RONNA *        INCLUDE SYSPLAN                                                  
RONNA *    END-EXEC.                                                            
                                                                                
      ****************************************************                      
      *  SYSTEM TABLE INDEXES INFORMATION                                       
      ****************************************************                      
RONNA2*    EXEC SQL                                                             
RONNA2*        INCLUDE SYSINDEX                                                 
RONNA2*    END-EXEC.                                                            
                                                                                
      ****************************************************                      
      *  SYSTEM TABLE KEYS INFORMATION                                          
      ****************************************************                      
RONNA2*    EXEC SQL                                                             
RONNA2*        INCLUDE SYSKEY                                                   
RONNA2*    END-EXEC.                                                            
                                                                                
      ****************************************************                      
      *  SYSTEM TABLE PARTITION INFORMATION                                     
      ****************************************************                      
RONNA2*    EXEC SQL                                                             
RONNA2*        INCLUDE SYSTABPT                                                 
RONNA2*    END-EXEC.                                                            
                                                                                
      ****************************************************                      
      *  ML DETAIL LEDGER PARTITION CONTROL CURSOR                              
      ****************************************************                      
           EXEC SQL  DECLARE PARTN-CNTL-CSR CURSOR FOR                          
               SELECT                                                           
                       PARTN_NBR                                                
                 FROM                                                           
                       MLT_PARTN_CNTL                                           
                 WHERE                                                          
                       TBL_TM_LVL_CDE  = :MLT00003-TBL-TM-LVL-CDE               
                   AND FSCL_DTE       >= :PV-MLT-BEG-FSCL-DTE                   
                   AND FSCL_DTE       <= :PV-MLT-END-FSCL-DTE                   
                 ORDER BY                                                       
                       FSCL_DTE                                                 
                 WITH UR                                                        
           END-EXEC.                                                            
      ******************************************************************        
      *------------------*                                                      
       PROCEDURE DIVISION.                                                      
      *------------------*                                                      
                                                                                
       0000-MAIN-MODULE.                                                        
                                                                                
           PERFORM 1000-INITIALIZATION.                                         
                                                                                
           PERFORM 2000-MAIN-PROCESS.                                           
                                                                                
           PERFORM 8000-EOJ-ROUTINE.                                            
                                                                                
           STOP RUN.                                                            
                                                                                
                                                                                
      ******************************************************************        
      * PROCESS CONTROL CARD, INITIALIZE VARIABLES                              
      ******************************************************************        
       1000-INITIALIZATION.                                                     
                                                                                
           OPEN INPUT  CONTROL-CARD-FILE                                        
                       DB2-SYSTEM-CNTL                                          
                OUTPUT SEASON-TO-DATE-CC                                        
                       BEGIN-SEASON-CC                                          
                       PREV-FISCAL-CC                                           
                       CURR-FISCAL-CC                                           
                       SHRINK-CC                                                
J28582*                REQUEST-TABLE-TYPE.                                      
J28582                 REQUEST-TABLE-TYPE                                       
J28582                 MONTH-END-DATE-CC.                                       
                                                                                
           MOVE SPACES  TO SEASON-TO-DATE-REC                                   
           MOVE SPACES  TO BEGIN-SEASON-REC                                     
           MOVE SPACES  TO PREV-FISCAL-REC                                      
           MOVE SPACES  TO CURR-FISCAL-REC                                      
           MOVE ZEROES  TO PA-PROGRAM-ACCUMULATORS.                             
                                                                                
           PERFORM 4000-READ-DB2-SYSTEM-CNTL                                    
               UNTIL PS-EOF-DB2-SYSTEM-CNTL.                                    
           DISPLAY ' '.                                                         
                                                                                
           DISPLAY ' ----+----1----+----2----+----3----+----4'                  
                    '----+----5----+----6----+----7'                            
           PERFORM 4100-READ-CONTROL-CARD-FILE                                  
               UNTIL PS-EOF-CONTROL-CARD                                        
                   OR PS-VALID-CONTROL-FOUND                                    
                   OR PS-CONTROL-CARD-ERROR.                                    
                                                                                
           IF NOT PS-VALID-CONTROL-FOUND                                        
               SET PV-MSG-01            TO TRUE                                 
               DISPLAY '** ABEND IN PROGRAM ' PC-PROGRAM-NAME                   
               DISPLAY '** PARAGRAPH 1000-INITIALIATION'                        
               DISPLAY '** CONTROL CARD ERROR.'                                 
               SET NON-SQL-ABEND          TO TRUE                               
               PERFORM 9999-ABEND-ROUTINE                                       
           ELSE                                                                 
               IF PS-NOT-EOF-CONTROL-CARD                                       
                   SET PV-MSG-04        TO TRUE                                 
                   DISPLAY ' ' PV-PROGRAM-MESSAGE                               
               END-IF                                                           
           END-IF.                                                              
                                                                                
           DISPLAY ' '.                                                         
                                                                                
      ******************************************************************        
      * PROCESS THE DATA FOR THE CONTROL CARD INPUT                             
      ******************************************************************        
       2000-MAIN-PROCESS.                                                       
           IF CC-EXCEPTION-TABLES                                               
               PERFORM 3000-PROCESS-MLT                                         
           ELSE                                                                 
RONNA2         DISPLAY ' *** CONTROL CARD IS NOT SET UP CORRECTLY'              
RONNA2         DISPLAY '             IT MUST CONTAIN A VALID'                   
RONNA2         DISPLAY '             TABLE LISTED IN THE PROGRAM'               
RONNA2         SET PV-MSG-02              TO TRUE                               
RONNA2         SET NON-SQL-ABEND          TO TRUE                               
RONNA2         PERFORM 9999-ABEND-ROUTINE                                       
RONNA2*        PERFORM 6100-GET-COLNAME                                         
RONNA2*        PERFORM 6000-COUNT-PARTITIONS                                    
RONNA2*        IF PV-PARTITION-COUNT = PC-MONTHLY-PART-COUNT                    
RONNA2*            OR PV-PARTITION-COUNT = PC-WEEKLY-PART-COUNT                 
RONNA2*            CONTINUE                                                     
RONNA2*        ELSE                                                             
RONNA2*            MOVE ZEROES  TO PV-PARTITION-COUNT                           
RONNA2*        END-IF                                                           
RONNA2*        IF PV-PARTITION-COUNT = PC-WEEKLY-PART-COUNT                     
RONNA2*            OR PV-INDEX-WEEKLY-COLNAME                                   
RONNA2*            PERFORM 2300-PROCESS-WEEKLY                                  
RONNA2*        ELSE                                                             
RONNA2*            PERFORM 2100-PROCESS-MONTHLY                                 
RONNA2*        END-IF                                                           
           END-IF.                                                              
                                                                                
      ** CREATE RECORDS FOR SHRINK UNLOAD CONTROL                               
           SET PS-BUILD-SHRINK            TO TRUE.                              
           SET PR-WHERE-STMT              TO TRUE.                              
           SET PR-EQUAL-TO                TO TRUE.                              
           MOVE 'FSCL_MN_END_DTE'         TO PR-COLNAME.                        
           MOVE DTATTR-FSCL-MN-END-DTE    TO PR-FSCL-DATE.                      
           MOVE PR-WHERE-RECORD           TO PR-WORK-RECORD.                    
           PERFORM 3500-WRITE-CONTROL-CARD.                                     
           SET PR-AND-STMT                TO TRUE.                              
           SET PR-LESS-THAN-OR-EQUAL      TO TRUE.                              
           MOVE 'FSCL_WK_END_DTE'         TO PR-COLNAME.                        
           MOVE DTATTR-FSCL-WK-END-DTE    TO PR-FSCL-DATE.                      
           MOVE PR-WHERE-RECORD           TO PR-WORK-RECORD.                    
           PERFORM 3500-WRITE-CONTROL-CARD.                                     
                                                                                
           SET PS-BUILD-REQUEST-TYPE      TO TRUE.                              
           IF PV-PARTITION-COUNT = PC-WEEKLY-PART-COUNT                         
               OR PV-INDEX-WEEKLY-COLNAME                                       
               OR CC-WEEKLY-SUMMARY                                             
               SET PR-REQUEST-TYPE-WEEKLY     TO TRUE                           
               MOVE DTATTR-FSCL-WK-END-DTE    TO PR-REQUEST-TYPE-DATE           
           ELSE                                                                 
               SET PR-REQUEST-TYPE-MONTHLY    TO TRUE                           
               MOVE DTATTR-FSCL-MN-END-DTE    TO PR-REQUEST-TYPE-DATE           
           END-IF.                                                              
X23843     MOVE CC-TABLE-NAME             TO PR-REQUEST-TABLE-NAME.             
           MOVE PR-REQUEST-TYPE           TO PR-WORK-RECORD.                    
           PERFORM 3500-WRITE-CONTROL-CARD.                                     
J28582                                                                          
J28582** CREATE MONTH-END DATE RECORD FOR SHRINK UNLOAD SORT. USED IN           
J28582** MLK107A TO CREATE SHRINK UNLOAD FILE FOR B-CALC AND F-CALC.            
J28582     MOVE DTATTR-FSCL-MN-END-DTE    TO PR-MONTH-END-DATE.                 
J28582     SET PS-BUILD-MONTH-END-DATE    TO TRUE.                              
J28582     MOVE PR-SORT-MONTH-END-DATE    TO PR-WORK-RECORD.                    
J28582     PERFORM 3500-WRITE-CONTROL-CARD.                                     
                                                                                
                                                                                
      ******************************************************************        
      * PROCESS THE DATA FOR THE MONTHLY TABLES                                 
      ******************************************************************        
RONNA2*2100-PROCESS-MONTHLY.                                                    
RONNA2*                                                                         
RONNA2*    DISPLAY ' 2100-PROCESS-MONTHLY'                                      
RONNA2*    PERFORM 2325-BUILD-SEASON-TO-DATE.                                   
RONNA2*                                                                         
RONNA2*    MOVE DTATTR-SEA-BEG-DTE TO DTATTR-KY-DTE.                            
RONNA2*    PERFORM 4500-GET-MN-WK-NBR.                                          
RONNA2*    IF DTATTR-SEA-BEG-DTE > DTATTR-PFM-END-DTE                           
RONNA2*        MOVE PV-FSCL-MN-NBR-9   TO PV-STOP-PARTITION                     
RONNA2*    ELSE                                                                 
RONNA2*        MOVE PV-FSCL-MN-NBR-9   TO PV-START-PARTITION                    
RONNA2*    END-IF.                                                              
RONNA2*    MOVE DTATTR-PFM-END-DTE TO DTATTR-KY-DTE.                            
RONNA2*    PERFORM 4500-GET-MN-WK-NBR.                                          
RONNA2*    IF DTATTR-SEA-BEG-DTE > DTATTR-PFM-END-DTE                           
RONNA2*        MOVE PV-FSCL-MN-NBR-9   TO PV-START-PARTITION                    
RONNA2*    ELSE                                                                 
RONNA2*        MOVE PV-FSCL-MN-NBR-9   TO PV-STOP-PARTITION                     
RONNA2*    END-IF.                                                              
RONNA2*    PERFORM 2400-BUILD-PARTITION-REC.                                    
RONNA2*                                                                         
RONNA2*    PERFORM 2350-BUILD-BEGIN-SEASON.                                     
RONNA2*                                                                         
RONNA2*    MOVE DTATTR-PREV-SEA-END-DTE TO DTATTR-KY-DTE.                       
RONNA2*    PERFORM 4500-GET-MN-WK-NBR.                                          
RONNA2*    MOVE PV-FSCL-MN-NBR     TO PV-START-PARTITION                        
RONNA2*                               PV-STOP-PARTITION.                        
RONNA2*    PERFORM 2400-BUILD-PARTITION-REC.                                    
RONNA2*                                                                         
RONNA2*    PERFORM 2375-BUILD-PREV-FISCAL.                                      
RONNA2*                                                                         
RONNA2*    MOVE DTATTR-PFM-END-DTE      TO DTATTR-KY-DTE.                       
RONNA2*    PERFORM 4500-GET-MN-WK-NBR.                                          
RONNA2*    MOVE PV-FSCL-MN-NBR     TO PV-START-PARTITION                        
RONNA2*                               PV-STOP-PARTITION.                        
RONNA2*    PERFORM 2400-BUILD-PARTITION-REC.                                    
RONNA2*                                                                         
      ** CREATE RECORDS FOR CURRENT-FISCAL (MONTH-TO-DATE) CONTROL              
RONNA2*    SET PS-BUILD-CURR-FISCAL       TO TRUE.                              
RONNA2*    SET PR-WHERE-STMT              TO TRUE.                              
RONNA2*    SET PR-GREATER-THAN-OR-EQUAL   TO TRUE.                              
RONNA2*    MOVE DTATTR-FSCL-MN-BEG-DTE    TO PR-FSCL-DATE.                      
RONNA2*    MOVE PR-WHERE-RECORD           TO PR-WORK-RECORD.                    
RONNA2*    PERFORM 3500-WRITE-CONTROL-CARD.                                     
RONNA2*                                                                         
RONNA2*    SET PR-AND-STMT                TO TRUE.                              
RONNA2*    SET PR-LESS-THAN-OR-EQUAL      TO TRUE.                              
RONNA2*    MOVE DTATTR-FSCL-MN-END-DTE    TO PR-FSCL-DATE.                      
RONNA2*    MOVE PR-WHERE-RECORD           TO PR-WORK-RECORD.                    
RONNA2*    PERFORM 3500-WRITE-CONTROL-CARD.                                     
RONNA2*                                                                         
RONNA2*    MOVE DTATTR-FSCL-MN-END-DTE  TO DTATTR-KY-DTE.                       
RONNA2*    PERFORM 4500-GET-MN-WK-NBR.                                          
RONNA2*    MOVE PV-FSCL-MN-NBR     TO PV-START-PARTITION                        
RONNA2*                               PV-STOP-PARTITION.                        
RONNA2*    PERFORM 2400-BUILD-PARTITION-REC.                                    
                                                                                
      ******************************************************************        
      * PROCESS THE DATA FOR THE WEEKLY TABLES                                  
      ******************************************************************        
RONNA2*2300-PROCESS-WEEKLY.                                                     
RONNA2*                                                                         
RONNA2*    DISPLAY ' 2300-PROCESS-WEEKLY'                                       
RONNA2*    PERFORM 2325-BUILD-SEASON-TO-DATE.                                   
RONNA2*                                                                         
RONNA2*    MOVE DTATTR-SEA-BEG-DTE TO DTATTR-KY-DTE.                            
RONNA2*    PERFORM 4500-GET-MN-WK-NBR.                                          
RONNA2*    IF DTATTR-SEA-BEG-DTE > DTATTR-PFM-END-DTE                           
RONNA2*        MOVE PV-FSCL-WK-NBR-9   TO PV-STOP-PARTITION                     
RONNA2*    ELSE                                                                 
RONNA2*        MOVE PV-FSCL-WK-NBR-9   TO PV-START-PARTITION                    
RONNA2*    END-IF.                                                              
RONNA2*    MOVE DTATTR-PFM-END-DTE TO DTATTR-KY-DTE.                            
RONNA2*    PERFORM 4500-GET-MN-WK-NBR.                                          
RONNA2*    IF DTATTR-SEA-BEG-DTE > DTATTR-PFM-END-DTE                           
RONNA2*        MOVE PV-FSCL-WK-NBR-9   TO PV-START-PARTITION                    
RONNA2*    ELSE                                                                 
RONNA2*        MOVE PV-FSCL-WK-NBR-9   TO PV-STOP-PARTITION                     
RONNA2*    END-IF.                                                              
RONNA2*    PERFORM 2400-BUILD-PARTITION-REC.                                    
RONNA2*                                                                         
RONNA2*    PERFORM 2350-BUILD-BEGIN-SEASON.                                     
RONNA2*                                                                         
RONNA2*    MOVE DTATTR-PREV-SEA-END-DTE TO DTATTR-KY-DTE.                       
RONNA2*    PERFORM 4500-GET-MN-WK-NBR.                                          
RONNA2*    MOVE PV-FSCL-WK-NBR     TO PV-START-PARTITION                        
RONNA2*                               PV-STOP-PARTITION.                        
RONNA2*    PERFORM 2400-BUILD-PARTITION-REC.                                    
RONNA2*                                                                         
RONNA2*    PERFORM 2375-BUILD-PREV-FISCAL.                                      
RONNA2*                                                                         
RONNA2*    MOVE DTATTR-PFM-END-DTE      TO DTATTR-KY-DTE.                       
RONNA2*    PERFORM 4500-GET-MN-WK-NBR.                                          
RONNA2*    MOVE PV-FSCL-WK-NBR     TO PV-START-PARTITION                        
RONNA2*                               PV-STOP-PARTITION.                        
RONNA2*    PERFORM 2400-BUILD-PARTITION-REC.                                    
RONNA2*                                                                         
      ** CREATE RECORDS FOR CURRENT-FISCAL (WEEKS W/I MONTH) CONTROL            
RONNA2*    SET PS-BUILD-CURR-FISCAL       TO TRUE.                              
RONNA2*    SET PR-WHERE-STMT              TO TRUE.                              
RONNA2*    SET PR-GREATER-THAN-OR-EQUAL   TO TRUE.                              
RONNA2*    MOVE DTATTR-FSCL-MN-BEG-DTE    TO PR-FSCL-DATE.                      
RONNA2*    MOVE PR-WHERE-RECORD           TO PR-WORK-RECORD.                    
RONNA2*    PERFORM 3500-WRITE-CONTROL-CARD.                                     
RONNA2*                                                                         
RONNA2*    SET PR-AND-STMT                TO TRUE.                              
RONNA2*    SET PR-LESS-THAN-OR-EQUAL      TO TRUE.                              
RONNA2*    MOVE DTATTR-FSCL-WK-END-DTE    TO PR-FSCL-DATE.                      
RONNA2*    MOVE PR-WHERE-RECORD           TO PR-WORK-RECORD.                    
RONNA2*    PERFORM 3500-WRITE-CONTROL-CARD.                                     
RONNA2*                                                                         
RONNA2*    MOVE DTATTR-FSCL-MN-BEG-DTE  TO DTATTR-KY-DTE.                       
RONNA2*    PERFORM 4500-GET-MN-WK-NBR.                                          
RONNA2*    MOVE PV-FSCL-WK-NBR     TO PV-START-PARTITION.                       
RONNA2*    MOVE DTATTR-FSCL-WK-END-DTE  TO DTATTR-KY-DTE.                       
RONNA2*    PERFORM 4500-GET-MN-WK-NBR.                                          
RONNA2*    MOVE PV-FSCL-WK-NBR     TO PV-STOP-PARTITION.                        
RONNA2*    PERFORM 2400-BUILD-PARTITION-REC.                                    
                                                                                
      ******************************************************************        
      * BUILD SEASON-TO-DATE                                                    
      ******************************************************************        
RONNA2*2325-BUILD-SEASON-TO-DATE.                                               
RONNA2*                                                                         
      ** CREATE RECORDS FOR SEASON-TO-DATE CONTROL CARD                         
RONNA2*    SET PS-BUILD-SEASON-TO-DATE    TO TRUE.                              
RONNA2*    SET PR-WHERE-STMT              TO TRUE.                              
RONNA2*    MOVE PV-INDEX-COLNAME          TO PR-COLNAME.                        
RONNA2*    SET PR-GREATER-THAN-OR-EQUAL   TO TRUE.                              
RONNA2*    MOVE DTATTR-SEA-BEG-DTE        TO PR-FSCL-DATE.                      
RONNA2*    MOVE PR-WHERE-RECORD           TO PR-WORK-RECORD.                    
RONNA2*    PERFORM 3500-WRITE-CONTROL-CARD.                                     
                                                                                
      * FIRST MONTH OF THE SEASON WILL RESULT IN EXTRACTING NOTHING             
      * BECAUSE PFM-END-DTE WILL BE LESS THAN SEA-BEG-DTE (INTENTIONAL)         
RONNA2*    SET PR-AND-STMT                TO TRUE.                              
RONNA2*    SET PR-LESS-THAN-OR-EQUAL      TO TRUE.                              
RONNA2*    MOVE DTATTR-PFM-END-DTE        TO PR-FSCL-DATE.                      
RONNA2*    MOVE PR-WHERE-RECORD           TO PR-WORK-RECORD.                    
RONNA2*    PERFORM 3500-WRITE-CONTROL-CARD.                                     
                                                                                
      ******************************************************************        
      * BUILD BEGIN-SEASON                                                      
      ******************************************************************        
RONNA2*2350-BUILD-BEGIN-SEASON.                                                 
RONNA2*                                                                         
RONNA2** CREATE RECORDS FOR BEGINNING-SEASON CONTROL CARD                       
RONNA2*    SET PS-BUILD-BEGIN-SEASON      TO TRUE.                              
RONNA2*    SET PR-WHERE-STMT              TO TRUE.                              
RONNA2*    SET PR-EQUAL-TO                TO TRUE.                              
RONNA2*    MOVE DTATTR-PREV-SEA-END-DTE   TO PR-FSCL-DATE.                      
RONNA2*    MOVE PR-WHERE-RECORD           TO PR-WORK-RECORD.                    
RONNA2*    PERFORM 3500-WRITE-CONTROL-CARD.                                     
                                                                                
      ******************************************************************        
      * BUILD PREVIOUS FISCAL                                                   
      ******************************************************************        
RONNA2*2375-BUILD-PREV-FISCAL.                                                  
RONNA2*                                                                         
RONNA2** CREATE RECORDS FOR PREVIOUS FISCAL (MONTH) CONTROL CARD                
RONNA2*    SET PS-BUILD-PREV-FISCAL       TO TRUE.                              
RONNA2*    SET PR-WHERE-STMT              TO TRUE.                              
RONNA2*    SET PR-EQUAL-TO                TO TRUE.                              
RONNA2*    MOVE DTATTR-PFM-END-DTE        TO PR-FSCL-DATE.                      
RONNA2*    MOVE PR-WHERE-RECORD           TO PR-WORK-RECORD.                    
RONNA2*    PERFORM 3500-WRITE-CONTROL-CARD.                                     
                                                                                
      ******************************************************************        
      * DETERMINE THE PARTITION(S)                                              
      ******************************************************************        
RONNA2*2400-BUILD-PARTITION-REC.                                                
RONNA2*                                                                         
RONNA2*    IF PV-PARTITION-COUNT = ZEROES                                       
RONNA2*        CONTINUE                                                         
RONNA2*    ELSE                                                                 
RONNA2*        MOVE ZEROES            TO PV-SUB1                                
RONNA2*        MOVE SPACES            TO PR-PARTITION-RECORD                    
RONNA2*        SET PR-PART-STMT       TO TRUE                                   
RONNA2*                                                                         
RONNA2*        PERFORM                                                          
RONNA2*            UNTIL PV-START-PARTITION > PV-STOP-PARTITION                 
RONNA2*            ADD +1                   TO PV-SUB1                          
W35378**           IF PV-SUB1 > 12                                              
RONNA2*                MOVE PR-PARTITION-RECORD       TO PR-WORK-RECORD         
RONNA2*                PERFORM 3500-WRITE-CONTROL-CARD                          
RONNA2*                MOVE SPACES             TO PR-PARTITION-RECORD           
RONNA2*                SET PR-NO-PART-STMT    TO TRUE                           
RONNA2*                MOVE +1                 TO PV-SUB1                       
RONNA2*            END-IF                                                       
RONNA2*            MOVE PV-START-PARTITION  TO PR-PART-NBR(PV-SUB1)             
RONNA2*            ADD +1                   TO PV-START-PARTITION               
RONNA2*            IF PV-START-PARTITION > PV-STOP-PARTITION                    
RONNA2*                SET PR-PART-NBR-NO-COMMA(PV-SUB1)  TO TRUE               
RONNA2*                MOVE PR-PARTITION-RECORD TO PR-WORK-RECORD               
RONNA2*                PERFORM 3500-WRITE-CONTROL-CARD                          
W35378*                MOVE PR-PARTITION-RECORD-END TO PR-WORK-RECORD           
W35378*                PERFORM 3500-WRITE-CONTROL-CARD                          
RONNA2*            ELSE                                                         
RONNA2*                SET PR-PART-NBR-COMMA(PV-SUB1)  TO TRUE                  
RONNA2*            END-IF                                                       
RONNA2*        END-PERFORM                                                      
RONNA2*    END-IF.                                                              
                                                                                
      ******************************************************************        
      * PROCESS THE DATA FOR THE MLT TABLES                                     
      ******************************************************************        
       3000-PROCESS-MLT.                                                        
                                                                                
           DISPLAY ' 3000-PROCESS-MLT'                                          
                                                                                
           IF CC-MONTHLY-SUMMARY                                                
               MOVE PC-MONTHLY-TBL-LVL-LIT TO MLT00003-TBL-TM-LVL-CDE           
           ELSE                                                                 
               MOVE PC-WEEKLY-TBL-LVL-LIT  TO MLT00003-TBL-TM-LVL-CDE           
           END-IF.                                                              
                                                                                
      ** CREATE RECORDS FOR SEASON-TO-DATE CONTROL CARD                         
           SET PS-BUILD-SEASON-TO-DATE    TO TRUE.                              
           MOVE DTATTR-SEA-BEG-DTE        TO PV-MLT-BEG-FSCL-DTE.               
           MOVE DTATTR-PFM-END-DTE        TO PV-MLT-END-FSCL-DTE.               
           PERFORM 4400-OPEN-PARTN-CNTL-CSR.                                    
           PERFORM 4450-PROCESS-PART-CNTL-CSR                                   
               UNTIL PS-EOF-PARTN-CNTL.                                         
           IF PV-SUB1 = ZEROES                                                  
               DISPLAY ' *** NO PARTITION CONTROL FOR SEASON-TO-DATE'           
           END-IF.                                                              
           PERFORM 4475-CLOSE-PART-CNTL-CSR.                                    
                                                                                
      ** CREATE RECORDS FOR BEGINNING-SEASON CONTROL CARD                       
           SET PS-BUILD-BEGIN-SEASON      TO TRUE.                              
           MOVE DTATTR-PREV-SEA-END-DTE   TO PV-MLT-BEG-FSCL-DTE                
                                             PV-MLT-END-FSCL-DTE.               
           PERFORM 4400-OPEN-PARTN-CNTL-CSR.                                    
           PERFORM 4450-PROCESS-PART-CNTL-CSR                                   
               UNTIL PS-EOF-PARTN-CNTL.                                         
           IF PV-SUB1 = ZEROES                                                  
               DISPLAY ' *** NO PARTITION CONTROL FOR BEGINNING SEASON'         
               SET PV-MSG-05              TO TRUE                               
               SET NON-SQL-ABEND          TO TRUE                               
               PERFORM 9999-ABEND-ROUTINE                                       
           END-IF.                                                              
           PERFORM 4475-CLOSE-PART-CNTL-CSR.                                    
                                                                                
      ** CREATE RECORDS FOR PREVIOUS FISCAL (MONTH) CONTROL CARD                
           SET PS-BUILD-PREV-FISCAL       TO TRUE.                              
           MOVE DTATTR-PFM-END-DTE        TO PV-MLT-BEG-FSCL-DTE                
                                             PV-MLT-END-FSCL-DTE.               
           PERFORM 4400-OPEN-PARTN-CNTL-CSR.                                    
           PERFORM 4450-PROCESS-PART-CNTL-CSR                                   
               UNTIL PS-EOF-PARTN-CNTL.                                         
           IF PV-SUB1 = ZEROES                                                  
               DISPLAY ' *** PREV FISCAL MONTH MISSING PARTITION INFO'          
               SET PV-MSG-05              TO TRUE                               
               SET NON-SQL-ABEND          TO TRUE                               
               PERFORM 9999-ABEND-ROUTINE                                       
           END-IF.                                                              
           PERFORM 4475-CLOSE-PART-CNTL-CSR.                                    
                                                                                
      ** CREATE RECORDS FOR CURRENT-FISCAL (WEEKS W/I MONTH) CONTROL            
           SET PS-BUILD-CURR-FISCAL       TO TRUE.                              
           MOVE DTATTR-FSCL-MN-BEG-DTE    TO PV-MLT-BEG-FSCL-DTE.               
           IF CC-MONTHLY-SUMMARY                                                
               MOVE DTATTR-FSCL-MN-END-DTE    TO PV-MLT-END-FSCL-DTE            
           ELSE                                                                 
               MOVE DTATTR-FSCL-WK-END-DTE    TO PV-MLT-END-FSCL-DTE            
           END-IF.                                                              
           PERFORM 4400-OPEN-PARTN-CNTL-CSR.                                    
           PERFORM 4450-PROCESS-PART-CNTL-CSR                                   
               UNTIL PS-EOF-PARTN-CNTL.                                         
           IF PV-SUB1 = ZEROES                                                  
               DISPLAY ' *** NO CURRENT FISCAL PARTITION INFO'                  
               SET PV-MSG-05              TO TRUE                               
               SET NON-SQL-ABEND          TO TRUE                               
               PERFORM 9999-ABEND-ROUTINE                                       
           END-IF.                                                              
           PERFORM 4475-CLOSE-PART-CNTL-CSR.                                    
                                                                                
      ******************************************************************        
      * WRITE VARIOUS OUTPUT RECORD FROM WORK RECORD                            
      ******************************************************************        
       3500-WRITE-CONTROL-CARD.                                                 
                                                                                
           EVALUATE TRUE                                                        
               WHEN PS-BUILD-SEASON-TO-DATE                                     
                   IF PS-BUILD-HIST-CNTL                                        
                       WRITE SEASON-TO-DATE-REC FROM PR-WORK-RECORD             
                       ADD +1               TO PA-SEASON-TO-DATE-COUNT          
                   END-IF                                                       
               WHEN PS-BUILD-BEGIN-SEASON                                       
                   IF PS-BUILD-HIST-CNTL                                        
                       WRITE BEGIN-SEASON-REC   FROM PR-WORK-RECORD             
                       ADD +1                   TO PA-BEG-SEASON-COUNT          
                   END-IF                                                       
               WHEN PS-BUILD-PREV-FISCAL                                        
                   IF PS-BUILD-HIST-CNTL                                        
                       WRITE PREV-FISCAL-REC    FROM PR-WORK-RECORD             
                       ADD +1                   TO PA-PREV-FSCL-COUNT           
                   END-IF                                                       
               WHEN PS-BUILD-CURR-FISCAL                                        
                   WRITE CURR-FISCAL-REC    FROM PR-WORK-RECORD                 
                   ADD +1                   TO PA-CURR-FSCL-COUNT               
               WHEN PS-BUILD-SHRINK                                             
                   WRITE SHRINK-REC         FROM PR-WORK-RECORD                 
                   ADD +1                   TO PA-SHRINK-COUNT                  
               WHEN PS-BUILD-REQUEST-TYPE                                       
                   WRITE REQUEST-TABLE-TYPE-REC  FROM PR-WORK-RECORD            
J28582         WHEN PS-BUILD-MONTH-END-DATE                                     
J28582             WRITE MONTH-END-DATE-REC      FROM PR-WORK-RECORD            
           END-EVALUATE.                                                        
                                                                                
      ******************************************************************        
      * READ DB2 SYSTEM CONTROL CARD                                            
      ******************************************************************        
       4000-READ-DB2-SYSTEM-CNTL.                                               
                                                                                
           READ DB2-SYSTEM-CNTL INTO CC-DB2-SYSTEM-CNTL-REC                     
               AT END                                                           
                   SET PS-EOF-DB2-SYSTEM-CNTL TO TRUE                           
               NOT AT END                                                       
                   PERFORM 4050-PARSE-DB2-CNTL.                                 
                                                                                
      ******************************************************************        
      * PARSE THE DB2 SYSTEM CONTROL TO LOOK FOR PLAN                           
      ******************************************************************        
       4050-PARSE-DB2-CNTL.                                                     
                                                                                
           MOVE ZEROES         TO PV-FIELDS-COMPLETED.                          
           UNSTRING CC-DB2-SYSTEM-CNTL-REC                                      
               DELIMITED BY 'PLAN'                                              
               INTO PV-DB2-CNTL-HOLD-1                                          
                    PV-DB2-CNTL-HOLD-2                                          
               TALLYING IN PV-FIELDS-COMPLETED                                  
           END-UNSTRING.                                                        
           IF PV-FIELDS-COMPLETED > +1                                          
               MOVE ZEROES         TO PV-FIELDS-COMPLETED                       
               UNSTRING CC-DB2-SYSTEM-CNTL-REC                                  
                   DELIMITED BY '(' OR ')'                                      
                   INTO PV-DB2-CNTL-HOLD-1                                      
                        PV-DB2-PLAN-NAME                                        
                        PV-DB2-CNTL-HOLD-2                                      
                   TALLYING IN PV-FIELDS-COMPLETED                              
               END-UNSTRING                                                     
RONNA *        IF PV-FIELDS-COMPLETED > +2                                      
RONNA *            PERFORM 4075-GET-DB2-QUALIFIER                               
RONNA *        END-IF                                                           
           END-IF.                                                              
                                                                                
RONNA ******************************************************************        
RONNA * GET DB2 TABLE QUALIFIER FROM PLAN EXECUTING                             
RONNA ******************************************************************        
RONNA *4075-GET-DB2-QUALIFIER.                                                  
RONNA *                                                                         
RONNA *    EXEC SQL                                                             
RONNA *        SELECT                                                           
RONNA *                QUALIFIER                                                
RONNA *          INTO                                                           
RONNA *                :SYSPLAN-QUALIFIER                                       
RONNA *          FROM                                                           
RONNA *                SYSIBM.SYSPLAN                                           
RONNA *          WHERE                                                          
RONNA *                NAME      = :PV-DB2-PLAN-NAME                            
RONNA *        WITH UR                                                          
RONNA *    END-EXEC.                                                            
RONNA *                                                                         
RONNA *    IF SQLCODE = ZEROES                                                  
RONNA *        DISPLAY ' FOUND QUALIFIER ' SYSPLAN-QUALIFIER                    
RONNA *                ' FOR PLAN ' PV-DB2-PLAN-NAME                            
RONNA *    ELSE                                                                 
RONNA *        DISPLAY ' *** PLAN = ' PV-DB2-PLAN-NAME                          
RONNA *        MOVE '4050-PARSE-DB2-CNTL  ' TO PV-PARAGRAPH-NAME                
RONNA *        MOVE 'SELECT FROM SYSPLAN'                                       
RONNA *            TO PV-OPERATION-ATTEMPTED                                    
RONNA *        PERFORM 9990-SQL-ABEND                                           
RONNA *    END-IF.                                                              
                                                                                
                                                                                
      ******************************************************************        
      * READ THE CONTROL CARD INPUT                                             
      ******************************************************************        
       4100-READ-CONTROL-CARD-FILE.                                             
                                                                                
            READ CONTROL-CARD-FILE  INTO CC-CONTROL-CARD-REC                    
                AT END                                                          
                    SET PS-EOF-CONTROL-CARD TO TRUE                             
                NOT AT END                                                      
                    ADD 1 TO PA-INPUT-COUNT-IN                                  
                    PERFORM 4150-VALIDATE-CONTROL-CARD.                         
                                                                                
                                                                                
      ******************************************************************        
      * VALIDATE THE CONTROL CARD                                               
RONNA2* --ADDED A VALIDATION OF THE TABLE SET UP IN THE CONTROL CARD            
RONNA2*   BECAUSE THE CALL TO THE SYSIBM TABLE TO LOOKUP THE TABLE              
RONNA2*   NAME WAS REMOVED.                                                     
      ******************************************************************        
       4150-VALIDATE-CONTROL-CARD.                                              
           DISPLAY ' ' CC-CONTROL-CARD-REC.                                     
           IF CC-COMMENT-LINE                                                   
               CONTINUE                                                         
           ELSE                                                                 
               DISPLAY ' '                                                      
               PERFORM 4175-VALIDATE-DATE                                       
               IF NOT PS-CONTROL-CARD-ERROR                                     
                   IF CC-TABLE-NAME = SPACES                                    
                       SET PS-CONTROL-CARD-ERROR  TO TRUE                       
                       SET PV-MSG-02             TO TRUE                        
RONNA2             ELSE                                                         
RONNA2                 IF CC-EXCEPTION-TABLES                                   
RONNA2                    SET PS-VALID-CONTROL-FOUND TO TRUE                    
RONNA2*                PERFORM 4250-CHECK-TABLE-NAME                            
                   END-IF                                                       
               END-IF                                                           
               PERFORM 4300-CHECK-HIST-BUILD                                    
           END-IF.                                                              
                                                                                
      ******************************************************************        
      * IF THE CONTROL CARD CONTAINS A DATE, VALIDATE THAT IT IS IN             
      * CCYY-MM-DD FORMAT AND READ TDTATTR TO OBTAIN THE CORRECT INFO.          
      * IF THE CONTROL CARD DOES NOT CONTAIN A DATE USE THE DATE FROM           
      * TMLCNTL.                                                                
      ******************************************************************        
       4175-VALIDATE-DATE.                                                      
           IF CC-OPT-REQ-DATE NOT = SPACES                                      
               AND CC-OPT-REQ-DATE-CCYY IS NUMERIC                              
               AND CC-VALID-OPT-REQ-DASH-1                                      
               AND CC-OPT-REQ-DATE-MM IS NUMERIC                                
               AND CC-VALID-OPT-REQ-DASH-2                                      
               AND CC-OPT-REQ-DATE-DD IS NUMERIC                                
               MOVE CC-OPT-REQ-DATE        TO PV-REQUEST-DATE                   
           ELSE                                                                 
               DISPLAY ' INVALID REQUEST DATE: ' CC-OPT-REQ-DATE                
               PERFORM 5000-READ-CONTROL-TABLE                                  
               DISPLAY ' USE DEFAULT ML OPEN FISCAL WEEK END DATE: '            
                       MLCNTL-OPN-FSCL-WK-DTE                                   
               MOVE MLCNTL-OPN-FSCL-WK-DTE TO PV-REQUEST-DATE                   
           END-IF.                                                              
           PERFORM 4200-CHECK-REQ-DATE.                                         
                                                                                
      ******************************************************************        
      * VALIDATE THAT THE CONTROL-CARD DATE IS ON TDTATTR                       
      ******************************************************************        
       4200-CHECK-REQ-DATE.                                                     
           EXEC SQL                                                             
               SELECT                                                           
                       FSCL_MN_BEG_DTE                                          
                      ,FSCL_MN_END_DTE                                          
                      ,FSCL_WK_END_DTE                                          
                      ,SEA_BEG_DTE                                              
                      ,PREV_SEA_END_DTE                                         
                      ,PFM_END_DTE                                              
                      ,WK_IN_MN_NBR                                             
                 INTO                                                           
                       :DTATTR-FSCL-MN-BEG-DTE                                  
                      ,:DTATTR-FSCL-MN-END-DTE                                  
                      ,:DTATTR-FSCL-WK-END-DTE                                  
                      ,:DTATTR-SEA-BEG-DTE                                      
                      ,:DTATTR-PREV-SEA-END-DTE                                 
                      ,:DTATTR-PFM-END-DTE                                      
                      ,:DTATTR-WK-IN-MN-NBR                                     
                 FROM                                                           
                       TDTATTR                                                  
                 WHERE                                                          
                       KY_DTE    = :PV-REQUEST-DATE                             
               WITH UR                                                          
           END-EXEC.                                                            
                                                                                
           EVALUATE SQLCODE                                                     
               WHEN 0                                                           
                   DISPLAY ' USE REQUEST DATE: ' PV-REQUEST-DATE                
                   DISPLAY '   FSCL-MN-BEG:    ' DTATTR-FSCL-MN-BEG-DTE         
                   DISPLAY '   FSCL-MN-END:    ' DTATTR-FSCL-MN-END-DTE         
                   DISPLAY '   FSCL-WK-END:    ' DTATTR-FSCL-WK-END-DTE         
                   DISPLAY '   SEASON-BEG:     ' DTATTR-SEA-BEG-DTE             
                   DISPLAY '   PREV-SEASON-END ' DTATTR-PREV-SEA-END-DTE        
                   DISPLAY '   PREV-FSCL-MONTH ' DTATTR-PFM-END-DTE             
                   DISPLAY '   WEEK IN MONTH   ' DTATTR-WK-IN-MN-NBR            
               WHEN +100                                                        
                   DISPLAY ' *** DATE NOT FOUND IN TDTATTR FOR '                
                           PV-REQUEST-DATE                                      
                   SET PS-CONTROL-CARD-ERROR TO TRUE                            
                   SET PV-MSG-03            TO TRUE                             
               WHEN OTHER                                                       
                   DISPLAY ' *** KY_DTE = ' PV-REQUEST-DATE                     
                   MOVE '4200-CHECK-REQ-DATE' TO PV-PARAGRAPH-NAME              
                   MOVE 'SELECT FROM TDTATTR' TO PV-OPERATION-ATTEMPTED         
                   PERFORM 9990-SQL-ABEND                                       
           END-EVALUATE.                                                        
                                                                                
      *****************************************************************         
      * VALIDATE TABLE NAME                                                     
      ******************************************************************        
RONNA2*4250-CHECK-TABLE-NAME.                                                   
RONNA2*    EXEC SQL                                                             
RONNA2*        SELECT                                                           
RONNA2*                TSNAME                                                   
RONNA2*          INTO                                                           
RONNA2*                :SYSTBL-NAME                                             
RONNA2*          FROM                                                           
RONNA2*                SYSIBM.SYSTABLES                                         
RONNA2*          WHERE                                                          
RONNA2*                NAME      = :CC-TABLE-NAME                               
RONNA2*            AND TYPE      = 'T'                                          
RONNA *            AND CREATOR   = :SYSPLAN-QUALIFIER                           
RONNA2*        WITH UR                                                          
RONNA2*    END-EXEC.                                                            
RONNA2*                                                                         
RONNA2*    EVALUATE SQLCODE                                                     
RONNA2*        WHEN 0                                                           
RONNA2*            SET PS-VALID-CONTROL-FOUND TO TRUE                           
RONNA2*            DISPLAY ' FOUND TABLE ' CC-TABLE-NAME                        
RONNA *                    ' WITH CREATOR ' SYSPLAN-QUALIFIER                   
RONNA *                    ' AND TABLESPACE ' SYSTBL-NAME                       
RONNA2*        WHEN +100                                                        
RONNA2*            DISPLAY ' *** CANNOT FIND TABLE NAME: '                      
RONNA2*                    CC-TABLE-NAME                                        
RONNA2*            SET PS-CONTROL-CARD-ERROR TO TRUE                            
RONNA2*            SET PV-MSG-02            TO TRUE                             
RONNA2*        WHEN OTHER                                                       
RONNA2*            DISPLAY ' *** TABLE = ' CC-TABLE-NAME                        
RONNA2*            MOVE '4250-CHECK-TABLE-NAME' TO PV-PARAGRAPH-NAME            
RONNA2*            MOVE 'SELECT FROM SYSTABLE'                                  
RONNA2*                TO PV-OPERATION-ATTEMPTED                                
RONNA2*            PERFORM 9990-SQL-ABEND                                       
RONNA2*    END-EVALUATE.                                                        
                                                                                
      ******************************************************************        
      * CHECK TO SEE IF CONTROL CARD SHOULD BE GENERATED FOR HISTORICAL         
      ******************************************************************        
       4300-CHECK-HIST-BUILD.                                                   
                                                                                
           DISPLAY ' '.                                                         
           SET PS-NOT-BUILD-HIST-CNTL   TO TRUE.                                
      * FIRST FISCAL WEEK OF THE MONTH?                                         
           IF DTATTR-WK-IN-MN-NBR = '1'                                         
               DISPLAY ' FIRST FISCAL WEEK OF THE MONTH'                        
               SET PS-BUILD-HIST-CNTL       TO TRUE                             
           ELSE                                                                 
      * DATASET EXISTED?                                                        
               IF CC-OPT-HIST-DSN = SPACES                                      
                   DISPLAY ' NO HISTORICAL DATASET NAME TO CHECK'               
               ELSE                                                             
                   PERFORM 4350-CHECK-HIST-DSN                                  
               END-IF                                                           
           END-IF.                                                              
                                                                                
           IF PS-BUILD-HIST-CNTL                                                
               DISPLAY ' HISTORICAL CONTROLS WILL BE BUILT'                     
           ELSE                                                                 
               DISPLAY ' *** WILL NOT BUILD HISTORICAL CONTROLS'                
           END-IF.                                                              
           DISPLAY ' '.                                                         
                                                                                
      ******************************************************************        
      * CHECK TO SEE IF THE OPTIONAL DATASET NAME EXIST                         
      ******************************************************************        
       4350-CHECK-HIST-DSN.                                                     
                                                                                
           INITIALIZE DP023-DYNALC-PARMS.                                       
           MOVE 'INP99'                TO DP023-DDNAME.                         
           MOVE CC-OPT-HIST-DSN        TO DP023-DSNAME.                         
           SET DP023-DISP-SHARE        TO TRUE.                                 
           SET DP023-FREE-CLOSE-NO     TO TRUE.                                 
           SET DP023-RECFM-FIXED-BLOCK TO TRUE.                                 
           MOVE LENGTH OF ML070-COMMON-RECALC-EXTRACT                           
               TO DP023-RECSZ.                                                  
W23843     SET DP023-RECOUNT-ALLOCATE-TAPE TO TRUE.                             
                                                                                
           SET DP023-DISABLE-DISPLAY-ABEND TO TRUE.                             
                                                                                
           DISPLAY ' ALLOCATING ' DP023-DDNAME                                  
                   ' TO '         DP023-DSNAME.                                 
                                                                                
DELETE*    DISPLAY '** PARMS = ' DP023-DYNALC-PARMS.                            
           PERFORM DP023-0000-DYNALC.                                           
DELETE*    DISPLAY '** PARMS = ' DP023-DYNALC-PARMS.                            
           IF DP023-LASTRC = ZERO                                               
               DISPLAY ' *** EXISTING HISTORICAL DSN: ' DP023-DSNAME            
           ELSE                                                                 
               DISPLAY ' *** DYNAMIC ALLOCATION FAIL ***'                       
               DISPLAY ' ' DP023-RC (DP023-SUB)                                 
                       ' ' DP023-DESC (DP023-SUB)                               
               DISPLAY '** PARMS = ' DP023-DYNALC-PARMS                         
               SET PS-BUILD-HIST-CNTL       TO TRUE                             
           END-IF.                                                              
                                                                                
      ******************************************************************        
      * OPEN ML PARTITION CONTROL CURSOR FOR DETAIL LEDGER TABLES               
      ******************************************************************        
       4400-OPEN-PARTN-CNTL-CSR.                                                
                                                                                
           EXEC SQL                                                             
               OPEN PARTN-CNTL-CSR                                              
           END-EXEC.                                                            
                                                                                
           IF SQLCODE = +0                                                      
               SET PS-NOT-EOF-PARTN-CNTL     TO TRUE                            
               MOVE ZEROES            TO PV-SUB1                                
               MOVE SPACES            TO PR-PARTITION-RECORD                    
               SET PR-PART-STMT       TO TRUE                                   
           ELSE                                                                 
               DISPLAY ' *** TM_LVL = ' MLT00003-TBL-TM-LVL-CDE                 
                       ' FSCL_DTE RANGE >= '                                    
                       PV-MLT-BEG-FSCL-DTE                                      
                       ' <= ' PV-MLT-END-FSCL-DTE                               
               MOVE '4400-OPEN-PARTN-CNTL-CSR   ' TO PV-PARAGRAPH-NAME          
               MOVE 'OPEN PARTN-CNTL-CSR   ' TO PV-OPERATION-ATTEMPTED          
               PERFORM 9990-SQL-ABEND                                           
           END-IF.                                                              
                                                                                
      ******************************************************************        
      * FETCH/PROCESS ML PARTITION CONTROL CURSOR FOR DETAIL LEDGER TBL         
      ******************************************************************        
       4450-PROCESS-PART-CNTL-CSR.                                              
                                                                                
           EXEC SQL                                                             
              FETCH PARTN-CNTL-CSR                                              
              INTO                                                              
                   :MLT00003-PARTN-NBR                                          
           END-EXEC.                                                            
                                                                                
           EVALUATE SQLCODE                                                     
               WHEN +0                                                          
                   ADD +1                   TO PV-SUB1                          
W35378             IF PV-SUB1 > 12                                              
                       MOVE PR-PARTITION-RECORD       TO PR-WORK-RECORD         
                       PERFORM 3500-WRITE-CONTROL-CARD                          
                       MOVE SPACES             TO PR-PARTITION-RECORD           
                       SET PR-NO-PART-STMT    TO TRUE                           
                       MOVE +1                 TO PV-SUB1                       
                   END-IF                                                       
                   MOVE MLT00003-PARTN-NBR  TO PR-PART-NBR(PV-SUB1)             
                   SET PR-PART-NBR-COMMA(PV-SUB1)  TO TRUE                      
               WHEN +100                                                        
                   IF PV-SUB1 > ZEROES                                          
                       SET PR-PART-NBR-NO-COMMA(PV-SUB1)  TO TRUE               
                       MOVE PR-PARTITION-RECORD TO PR-WORK-RECORD               
                       PERFORM 3500-WRITE-CONTROL-CARD                          
W35378                 MOVE PR-PARTITION-RECORD-END TO PR-WORK-RECORD           
W35378                 PERFORM 3500-WRITE-CONTROL-CARD                          
                   END-IF                                                       
                   SET PS-EOF-PARTN-CNTL   TO TRUE                              
               WHEN OTHER                                                       
                   DISPLAY ' *** TM_LVL = ' MLT00003-TBL-TM-LVL-CDE             
                           ' FSCL_DTE RANGE >= '                                
                           PV-MLT-BEG-FSCL-DTE                                  
                           ' <= ' PV-MLT-END-FSCL-DTE                           
                   MOVE '4450-PROCESS-PARTN-CNTL-CSR'                           
                       TO PV-PARAGRAPH-NAME                                     
                   MOVE 'FETCH FROM PARTN-CNTL-CSR'                             
                       TO PV-OPERATION-ATTEMPTED                                
                   PERFORM 9990-SQL-ABEND                                       
           END-EVALUATE.                                                        
                                                                                
      ******************************************************************        
      * CLOSE ML PARTITION CONTROL CURSOR FOR DETAIL LEDGER TABLES              
      ******************************************************************        
       4475-CLOSE-PART-CNTL-CSR.                                                
                                                                                
           EXEC SQL                                                             
                CLOSE PARTN-CNTL-CSR                                            
           END-EXEC.                                                            
                                                                                
           IF SQLCODE NOT = +0                                                  
               DISPLAY ' *** TM_LVL = ' MLT00003-TBL-TM-LVL-CDE                 
                       ' FSCL_DTE RANGE >= '                                    
                       PV-MLT-BEG-FSCL-DTE                                      
                       ' <= ' PV-MLT-END-FSCL-DTE                               
               MOVE '4475-CLOSE-PARTN-CNTL-CSR   ' TO PV-PARAGRAPH-NAME         
               MOVE 'CLOSE PARTN-CNTL-CSR   ' TO PV-OPERATION-ATTEMPTED         
               PERFORM 9990-SQL-ABEND                                           
           END-IF.                                                              
                                                                                
      ******************************************************************        
      * OBTAIN THE FSCL-WK/MN FOR A GIVEN DATE                                  
      ******************************************************************        
RONNA2*4500-GET-MN-WK-NBR.                                                      
RONNA2*    EXEC SQL                                                             
RONNA2*        SELECT                                                           
RONNA2*                FSCL_MN_NBR                                              
RONNA2*               ,FSCL_WK_NBR                                              
RONNA2*          INTO                                                           
RONNA2*                :PV-FSCL-MN-NBR                                          
RONNA2*               ,:PV-FSCL-WK-NBR                                          
RONNA2*          FROM                                                           
RONNA2*                TDTATTR                                                  
RONNA2*          WHERE                                                          
RONNA2*                 KY_DTE    = :DTATTR-KY-DTE                              
RONNA2*        WITH UR                                                          
RONNA2*    END-EXEC.                                                            
RONNA2*                                                                         
RONNA2*    EVALUATE SQLCODE                                                     
RONNA2*        WHEN 0                                                           
RONNA2*            CONTINUE                                                     
RONNA2*        WHEN +100                                                        
RONNA2*            DISPLAY 'TDTATTR NOT FOUND'                                  
RONNA2*            MOVE '00' TO PV-FSCL-MN-NBR  PV-FSCL-WK-NBR                  
RONNA2*        WHEN OTHER                                                       
RONNA2*            DISPLAY ' *** KY_DTE = ' DTATTR-KY-DTE                       
RONNA2*           MOVE '4500-GET-MN-WK-NBR' TO PV-PARAGRAPH-NAME                
RONNA2*           MOVE 'SELECT FROM TDTATTR' TO PV-OPERATION-ATTEMPTED          
RONNA2*           PERFORM 9990-SQL-ABEND                                        
RONNA2*    END-EVALUATE.                                                        
                                                                                
                                                                                
      ******************************************************************        
      * READ THE DB2 CONTROL TABLE CONTAINING OPEN FISCAL DATE INFO             
      ******************************************************************        
       5000-READ-CONTROL-TABLE.                                                 
                                                                                
           EXEC SQL                                                             
               SELECT                                                           
                       OPN_FSCL_WK_DTE                                          
                 INTO                                                           
                       :MLCNTL-OPN-FSCL-WK-DTE                                  
                 FROM                                                           
                       TMLCNTL                                                  
                 WITH UR                                                        
           END-EXEC.                                                            
                                                                                
           EVALUATE SQLCODE                                                     
               WHEN 0                                                           
                   CONTINUE                                                     
               WHEN OTHER                                                       
                   MOVE '5000-READ-CONTROL-TABLE' TO PV-PARAGRAPH-NAME          
                   MOVE 'SELECT FROM TMLCNTL'  TO PV-OPERATION-ATTEMPTED        
                   PERFORM 9990-SQL-ABEND                                       
           END-EVALUATE.                                                        
                                                                                
                                                                                
      ******************************************************************        
      * READ THE DB2 SYSTABLEPART TO OBTAIN PARTITION INFO                      
      ******************************************************************        
RONNA2*6000-COUNT-PARTITIONS.                                                   
RONNA2*                                                                         
RONNA2*    EXEC SQL                                                             
RONNA2*        SELECT                                                           
RONNA2*               COUNT(*)                                                  
RONNA2*          INTO                                                           
RONNA2*                :PV-PARTITION-COUNT                                      
RONNA2*          FROM                                                           
RONNA2*                SYSIBM.SYSTABLEPART                                      
RONNA2*          WHERE                                                          
RONNA2*                TSNAME     = :SYSTBL-NAME                                
RONNA *            AND IXCREATOR  = :SYSPLAN-QUALIFIER                          
RONNA2*         WITH UR                                                         
RONNA2*    END-EXEC.                                                            
RONNA2*                                                                         
RONNA2*    EVALUATE SQLCODE                                                     
RONNA2*        WHEN 0                                                           
RONNA2*            CONTINUE                                                     
RONNA2*        WHEN +100                                                        
RONNA2*            MOVE 0 TO PV-PARTITION-COUNT                                 
RONNA2*        WHEN OTHER                                                       
RONNA2*            DISPLAY ' *** TSNAME = ' SYSTBL-NAME                         
RONNA *                    ' IXCREATOR = ' SYSPLAN-QUALIFIER                    
RONNA2*            MOVE '6000-COUNT-PARTITIONS' TO PV-PARAGRAPH-NAME            
RONNA2*            MOVE 'COUNT FROM SYSTABLEPART'                               
RONNA2*                TO PV-OPERATION-ATTEMPTED                                
RONNA2*            PERFORM 9990-SQL-ABEND                                       
RONNA2*    END-EVALUATE.                                                        
                                                                                
                                                                                
      ******************************************************************        
      * FIND EITHER A 'FSCL_MN' OR 'FSCL_WK' COLUMN NAME IN THE INDEX           
      ******************************************************************        
RONNA2*6100-GET-COLNAME.                                                        
RONNA2*                                                                         
RONNA2*    EXEC SQL                                                             
RONNA2*        SELECT DISTINCT                                                  
RONNA2*                C.COLNAME                                                
RONNA2*          INTO                                                           
RONNA2*                :PV-INDEX-COLNAME                                        
RONNA2*          FROM                                                           
RONNA2*                SYSIBM.SYSCOLUMNS     A                                  
RONNA2*               ,SYSIBM.SYSINDEXES     B                                  
RONNA2*               ,SYSIBM.SYSKEYS        C                                  
RONNA2*          WHERE                                                          
RONNA2*                A.TBNAME     = :CC-TABLE-NAME                            
RONNA2*            AND A.TBNAME     = B.TBNAME                                  
RONNA *            AND B.TBCREATOR  = :SYSPLAN-QUALIFIER                        
RONNA2*            AND A.TBCREATOR  = B.TBCREATOR                               
RONNA2*            AND (C.COLNAME LIKE 'FSCL_MN_%' OR                           
RONNA2*                 C.COLNAME LIKE 'FSCL_WK_%')                             
RONNA2*            AND A.NAME       = C.COLNAME                                 
RONNA2*            AND A.COLTYPE    = 'DATE'                                    
RONNA2*            AND B.NAME       = C.IXNAME                                  
RONNA2*            AND B.TBCREATOR  = C.IXCREATOR                               
RONNA2*         WITH UR                                                         
RONNA2*    END-EXEC.                                                            
RONNA2*                                                                         
RONNA2*    EVALUATE SQLCODE                                                     
RONNA2*        WHEN 0                                                           
RONNA2*            CONTINUE                                                     
RONNA2*        WHEN +100                                                        
RONNA2*            MOVE SPACES TO PV-INDEX-COLNAME                              
RONNA2*        WHEN OTHER                                                       
RONNA2*            DISPLAY ' *** TBNAME = ' CC-TABLE-NAME                       
RONNA *                    ' TBCREATOR = ' SYSPLAN-QUALIFIER                    
RONNA2*            MOVE '6100-GET-COLNAME' TO PV-PARAGRAPH-NAME                 
RONNA2*            MOVE 'LOOK FOR COLNAME IN KEY'                               
RONNA2*                TO PV-OPERATION-ATTEMPTED                                
RONNA2*            PERFORM 9990-SQL-ABEND                                       
RONNA2*    END-EVALUATE.                                                        
                                                                                
                                                                                
      ******************************************************************        
      * PROCESS FINAL COUNTS FOR INPUT AND OUTPUT COUNTS                        
      ******************************************************************        
       8000-EOJ-ROUTINE.                                                        
                                                                                
           CLOSE CONTROL-CARD-FILE                                              
                 DB2-SYSTEM-CNTL                                                
                 SEASON-TO-DATE-CC                                              
                 BEGIN-SEASON-CC                                                
                 PREV-FISCAL-CC                                                 
                 CURR-FISCAL-CC                                                 
                 SHRINK-CC                                                      
J28582*          REQUEST-TABLE-TYPE.                                            
J28582           REQUEST-TABLE-TYPE                                             
J28582           MONTH-END-DATE-CC.                                             
                                                                                
           DISPLAY ' '.                                                         
           DISPLAY ' TOTAL INPUT RECORDS    = ' PA-INPUT-COUNT-IN.              
           DISPLAY ' SEASON-TO-DATE CC REC  = ' PA-SEASON-TO-DATE-COUNT.        
           DISPLAY ' BEG SEASON CC REC      = ' PA-BEG-SEASON-COUNT.            
           DISPLAY ' PREVIOUS FISCAL CC REC = ' PA-PREV-FSCL-COUNT.             
           DISPLAY ' CURRENT FISCAL CC REC  = ' PA-CURR-FSCL-COUNT.             
           DISPLAY ' SHRINK CC REC          = ' PA-CURR-FSCL-COUNT.             
           DISPLAY '                                           '.               
           DISPLAY '***** GOOD EOJ *****'.                                      
                                                                                
                                                                                
                                                                                
      ******************************************************************        
      *  STANDARD DB2 ERROR ABEND ROUTINE                                       
      *  THIS ROUTINE FORCES AN ABEND DUE TO A DB2 PROBLEM.                     
      ******************************************************************        
       9990-SQL-ABEND.                                                          
                                                                                
           DISPLAY '**  ABEND     **'.                                          
           DISPLAY '**  PROGRAM   ** => ' PC-PROGRAM-NAME.                      
           DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.                    
           DISPLAY '**  OPERATION **  = ' PV-OPERATION-ATTEMPTED.               
                                                                                
      *    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE                 
      *    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.                
                                                                                
           COPY DPPD004.                                                        
                                                                                
           SET SQL-ABEND              TO TRUE.                                  
           PERFORM 9999-ABEND-ROUTINE.                                          
      *                                                                         
      ******************************************************************        
      * COMMON ABEND MODULE                                                     
      ******************************************************************        
       9999-ABEND-ROUTINE.                                                      
           DISPLAY '** ' PV-PROGRAM-MESSAGE.                                    
           CALL 'ILBOABN0' USING ABEND-CODE.                                    
                                                                                
                                                                                
      ******************************************************************        
      * DYNAMIC ALLOCATION CALL CODE                                            
      ******************************************************************        
           COPY DPPD023.                                                        
