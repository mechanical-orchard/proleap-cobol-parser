000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400                                                                  00040000
000500 PROGRAM-ID.             SVKUT005.                                00050000
000600 AUTHOR.                 BARB SCHULTZ.                            00060000
000700 INSTALLATION.           KOHLS.                                   00070000
000800 DATE-WRITTEN            JULY 2000.                               00080000
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100***************************************************************** 00110000
001200* * * *>>>   THIS PROGRAM MUST BE COMPILED COBOL/390   <<<* * * * 00120000
001300***************************************************************** 00130000
001400*                                                                 00140000
001500*  MODULE TYPE: COBOL2 DB2 BATCH                                  00150004
001600*                                                                 00160002
001700*  THIS PROGRAM WILL CREATE A FILE TO BE SENT TO THE STORE        00170000
001800*  SERVERS WITH STORE VALUES STATUS CHANGES.                      00180000
001900*                                                                 00190000
002000*  THE INPUT SVT_KOHLS_CRD_ACCT, SVT_KOHLS_CRD_TXN AND            00200000
002100*  SVT_CRD_PROD TABLES ARE USED TO GATHER THE INFORMATION TO      00210000
002200*  CREATE AN OUTPUT FILE TO SEND TO THE STORE SERVERS.            00220000
002300*                                                                 00230000
      ******************************************************************00231016
      * CHANGE DATE: 05/17/2016                                         00232016
      * CHANGE MADE: RECOMPILE FOR SVWS004 AND SVRD022                  00233016
      * MADE BY    : ACCENTURE                   CHANGE# CHG0141575     00234017
      ******************************************************************00235016
002400******************************************************************00240000
002500                                                                  00250000
002600 ENVIRONMENT DIVISION.                                            00260000
002700 CONFIGURATION SECTION.                                           00270000
002800                                                                  00280000
002900 SOURCE-COMPUTER.        IBM-3090.                                00290000
003000 OBJECT-COMPUTER.        IBM-3090.                                00300000
003100                                                                  00310000
003200 INPUT-OUTPUT SECTION.                                            00320000
003300 FILE-CONTROL.                                                    00330000
003400                                                                  00340000
003500     SELECT SV-CARD-SQLS-FILE                                     00350005
003600         ASSIGN TO OUT01.                                         00360013
003700                                                                  00370000
003800     SELECT YEAR-PARAMETER-FILE                                   00380000
003900         ASSIGN TO INP01.                                         00390000
004000                                                                  00400000
004100******************************************************************00410000
004200 DATA DIVISION.                                                   00420000
004300******************************************************************00430000
004400                                                                  00440000
004500 FILE SECTION.                                                    00450000
004600                                                                  00460000
004700 FD  SV-CARD-SQLS-FILE                                            00470005
004800     RECORDING MODE IS F                                          00480005
004900     BLOCK CONTAINS 0 RECORDS                                     00490005
005000     LABEL RECORDS ARE STANDARD.                                  00500005
005100                                                                  00510005
005200 01  SV-CARD-SQLS-RECORD             PIC  X(41).                  00520008
005300                                                                  00530000
005400 FD  YEAR-PARAMETER-FILE                                          00540000
005500     RECORDING MODE IS F                                          00550000
005600     BLOCK CONTAINS 0 RECORDS                                     00560000
005700     LABEL RECORDS ARE STANDARD.                                  00570000
005800                                                                  00580000
005900 01  YEAR-PARAMETER-RCD              PIC X(80).                   00590000
006000******************************************************************00600000
006100 WORKING-STORAGE SECTION.                                         00610000
006200******************************************************************00620000
006300 01  FILLER                            PIC X(50)  VALUE           00630000
006400     ' *** WORKING STORAGE STARTS HERE FOR SVKUT005 *** '.        00640000
006500                                                                  00650000
006600 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      00660000
006700                                                  COMP SYNC.      00670000
006800     88  AC-CONTROL-CARD-ERROR                    VALUE +4003.    00680000
006900     88  AC-TABLE-OVERFLOW-ERROR                  VALUE +4004.    00690000
007000     88  AC-DATASET-DATA-ERROR                    VALUE +4008.    00700000
007100     88  AC-DB2-ERROR                             VALUE +4013.    00710000
007200     88  AC-CALENDAR-ROUTINE-ERROR                VALUE +4019.    00720000
007300                                                                  00730000
007400 01  PS-PROGRAM-SWITCHES.                                         00740000
007500     05  PS-END-OF-ACTIVITY-SW         PIC X(01)  VALUE 'N'.      00750000
007600         88  PS-END-OF-ACTIVITY                   VALUE 'Y'.      00760000
007700         88  PS-NOT-END-OF-ACTIVITY         VALUE 'N'.            00770000
007800     05  PS-END-OF-STATUS-CHG-SW       PIC X(01)  VALUE 'N'.      00780000
007900         88  PS-END-OF-STATUS-CHG                 VALUE 'Y'.      00790000
008000     05  PS-ACTIVITY-FOUND-SW          PIC X(01)  VALUE 'N'.      00800000
008100         88  PS-ACTIVITY-FOUND                    VALUE 'Y'.      00810000
008200         88  PS-NO-ACTIVITY-FOUND                 VALUE 'N'.      00820000
008300                                                                  00830000
008400 01  PC-CONSTANTS.                                                00840000
008500     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00850000
008600                                                   'SVKUT005'.    00860000
008700 01  PV-MISC-FIELDS.                                              00870000
008800     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACE.   00880000
008900     05  PV-OPERATION-MSG-1          PIC  X(40)    VALUE SPACE.   00890000
009000     05  PV-OPERATION-MSG-2          PIC  X(40)    VALUE SPACE.   00900000
009100     05  PV-DB2-OPERATION            PIC  X(30)    VALUE SPACE.   00910000
009200     05  PV-YESTERDAY                PIC  X(10)    VALUE SPACE.   00920005
009300                                                                  00930005
009400* ----------------------------------------------------------------00940005
009500*  COUNTERS AND ACCUMULATORS                                      00950005
009600* ----------------------------------------------------------------00960005
009700 01  PV-PC-COUNTERS.                                              00970005
009800     05  PV-PC-STAT-CHG-CARDS-FETCHED  PIC  9(09)  VALUE ZERO.    00980005
009900     05  PV-PC-TRANSACTIONS-FETCHED    PIC  9(09)  VALUE ZERO.    00990005
010000     05  PV-PC-SQLS-CARD-RCDS-WRITTEN  PIC  9(09)  VALUE ZERO.    01000005
010100                                                                  01010005
010200******************************************************************01020000
010300*  WS FIELDS FOR SVPD001                                          01030000
010400******************************************************************01040000
010500     COPY SVWS001.                                                01050011
010600******************************************************************01060010
010700*  TABLES FOR PROCESSING.                                         01070009
010800*-----------------------------------------------------------------01080009
010900*  DB2 TABLE DB2PDBA.SVT_KOHLS_CRD_ACCT                           01090000
011000*                  - KOHLS MERCHANDISE CARD TABLE                 01100000
011100*-----------------------------------------------------------------01110010
011200     EXEC SQL                                                     01120010
011300          INCLUDE SVT00001                                        01130010
011400     END-EXEC.                                                    01140010
011500*-----------------------------------------------------------------01150009
011600*  DB2 TABLE DB2PDBA.SVT_KOHLS_CRD_TXN                            01160000
011700*                  - KOHLS MERCHANDISE CARD ACTIVITY TABLE        01170000
011800*-----------------------------------------------------------------01180009
011900     EXEC SQL                                                     01190000
012000          INCLUDE SVT00002                                        01200000
012100     END-EXEC.                                                    01210000
012200******************************************************************01220000
012300*  MAIN CURSOR - SVT_KOHLS_CRD_ACCT                               01230000
012400*              - CARDS THAT HAD STATUS CHANGE TODAY               01240005
012500*              - OBTAIN DATA FOR BOTH VERSIONS OF OFF-LINE FILE   01250008
012600******************************************************************01260000
012700     EXEC SQL                                                     01270000
012800       DECLARE STATUS-CHG-CSR CURSOR FOR                          01280000
012900           SELECT CRD_NBR                                         01290000
013000                 ,CRD_PROD_YR                                     01300000
013100                 ,SHIPT_REQ_NBR                                   01310000
013200                 ,STR_NBR                                         01320000
013300                 ,CRD_STAT_CDE                                    01330000
013400                 ,CRD_PIN_NBR                                     01340005
013500                 ,CRD_TYP_CDE                                     01350005
013600                 ,CRD_SPCTY_TYP_CDE                               01360005
013700           FROM   SVT_KOHLS_CRD_ACCT                              01370000
013800           WHERE  CRD_NBR > 0                                     01380000
013900             AND (CRD_DISTRB_DTE = :PV-YESTERDAY                  01390000
014000             OR   CRD_CLO_DTE = :PV-YESTERDAY                     01400000
014100             OR   CRD_STAT_CHG_DTE = :PV-YESTERDAY)               01410000
014200           ORDER BY CRD_NBR                                       01420000
014300           WITH UR                                                01430000
014400     END-EXEC.                                                    01440000
014500******************************************************************01450000
014600*  ACTIVITY CURSOR - SVT_KOHLS_CRD_TXN                            01460000
014700******************************************************************01470000
014800     EXEC SQL                                                     01480000
014900       DECLARE ACTIVITY-CSR CURSOR FOR                            01490000
015000           SELECT TRN_VOID_IND                                    01500000
015100                 ,STR_NBR                                         01510000
015200                 ,CRD_NBR                                         01520000
015300                 ,APP_AUTH_AMT                                    01530000
015400                 ,ST_CDE                                          01540000
015500           FROM   SVT_KOHLS_CRD_TXN                               01550000
015600           WHERE  CRD_NBR = :SVT00001-CRD-NBR                     01560000
015700           WITH UR                                                01570000
015800     END-EXEC.                                                    01580000
015900***************************************************************** 01590000
016000* PROCEDURE DIVISION.                                           * 01600000
016100***************************************************************** 01610000
016200 PROCEDURE DIVISION.                                              01620000
016300                                                                  01630000
016400 0000-MAINLINE-PROCESSING.                                        01640000
016500                                                                  01650000
016600     PERFORM 1000-INITIALIZE-PROGRAM.                             01660000
016700                                                                  01670000
016800     PERFORM 2000-CREATE-FILE                                     01680000
016900       UNTIL PS-END-OF-STATUS-CHG.                                01690000
017000                                                                  01700000
017100     PERFORM 9990-DISPLAY-TOTALS.                                 01710005
017200                                                                  01720005
017300     CLOSE SV-CARD-SQLS-FILE.                                     01730014
017400                                                                  01740000
017500     GOBACK.                                                      01750000
017600                                                                  01760000
017700******************************************************************01770000
017800* 1000-INITIALIZE-PROGRAM                                         01780000
017900* OPEN FILE, GET CURRENT DATE                                     01790000
018000******************************************************************01800000
018100 1000-INITIALIZE-PROGRAM.                                         01810000
018200                                                                  01820000
018300     OPEN OUTPUT SV-CARD-SQLS-FILE.                               01830014
018400                                                                  01840000
018500     PERFORM SV001-1000-INITIALIZE.                               01850000
018600     PERFORM SV001-2000-LOAD-STORE-TABLE.                         01860000
018700     PERFORM 1140-GET-COMPARE-DATE.                               01870000
018800                                                                  01880000
018900******************************************************************01890000
019000* 1140-GET-COMPARE-DATE                                           01900000
019100* SELECT TODAYS DATE                                              01910000
019200******************************************************************01920000
019300 1140-GET-COMPARE-DATE.                                           01930000
019400                                                                  01940000
019500     EXEC SQL                                                     01950000
019600         SELECT (CURRENT DATE - 1 DAY)                            01960000
019700           INTO :PV-YESTERDAY                                     01970000
019800           FROM SYSIBM.SYSDUMMY1                                  01980000
019900           WITH UR                                                01990000
020000     END-EXEC.                                                    02000000
020100                                                                  02010000
020200     EVALUATE SQLCODE                                             02020000
020300         WHEN 0                                                   02030000
020400             DISPLAY 'PROCESSING DATE ' PV-YESTERDAY              02040000
020500         WHEN OTHER                                               02050000
020600             MOVE '1140-GET-COMPARE-DATE'                         02060000
020700                                           TO PV-PARAGRAPH-NAME   02070000
020800             MOVE 'ERROR SELECTING YESTERDAY DATE'                02080000
020900                                           TO PV-DB2-OPERATION    02090000
021000             PERFORM 9100-SQL-ABEND                               02100000
021100     END-EVALUATE.                                                02110000
021200                                                                  02120000
021300******************************************************************02130000
021400* 2000-CREATE-FILE                                                02140000
021500******************************************************************02150000
021600 2000-CREATE-FILE.                                                02160000
021700                                                                  02170000
021800     PERFORM 6300-OPEN-STATUS-CHG-CURSOR.                         02180000
021900     PERFORM 6400-FETCH-STATUS-CHG-CURSOR.                        02190000
022000     PERFORM 3000-PROCESS-STATUS-CHG                              02200000
022100         UNTIL PS-END-OF-STATUS-CHG.                              02210000
022200     PERFORM 6500-CLOSE-STATUS-CHG-CURSOR.                        02220000
022300                                                                  02230000
022400******************************************************************02240000
022500* 3000-PROCESS-STATUS-CHG                                         02250000
022600******************************************************************02260000
022700 3000-PROCESS-STATUS-CHG.                                         02270000
022800                                                                  02280000
022900     SET SV001-PS-STORE-NOT-FOUND TO TRUE.                        02290000
023000     INITIALIZE SVWS001-CARD-METRO-TABLE.                         02300000
023100     MOVE ZERO              TO SV001-PV-CARD-METRO-SUB.           02310000
023200     MOVE SVT00001-STR-NBR  TO SV001-PV-ADD-STORE.                02320000
023300     MOVE SPACES            TO SV001-PV-STATE-CDE.                02330000
023400                                                                  02340000
023500     MOVE ZERO TO SV001-PV-STORE-SUB.                             02350000
023600     PERFORM SV001-3000-CHECK-STORE                               02360000
023700         UNTIL SV001-PS-STORE-FOUND                               02370000
023800            OR SV001-PV-STORE-SUB > SV001-PC-STORE-LIMIT.         02380000
023900                                                                  02390000
024000     SET PS-NOT-END-OF-ACTIVITY TO TRUE                           02400000
024100     SET PS-NO-ACTIVITY-FOUND  TO TRUE                            02410000
024200     MOVE ZERO TO SV001-PV-CARD-BALANCE                           02420000
024300                                                                  02430001
024400     PERFORM 6600-OPEN-ACTIVITY-CURSOR                            02440000
024500     PERFORM 6700-FETCH-ACTIVITY-CURSOR                           02450000
024600     PERFORM 4000-PROCESS-ACTIVITY                                02460000
024700       UNTIL PS-END-OF-ACTIVITY                                   02470000
024800     PERFORM 6800-CLOSE-ACTIVITY-CURSOR                           02480000
024900                                                                  02490001
025000     IF  SV001-PS-STORE-FOUND                                     02500001
025100     AND PS-NO-ACTIVITY-FOUND                                     02510001
025200     AND SV001-PV-POS-CAP-LVL-ID > 16                             02520001
025300         CONTINUE                                                 02530004
025400                                                                  02540004
025500     ELSE                                                         02550004
025600         IF PS-NO-ACTIVITY-FOUND                                  02560001
025700             PERFORM 6900-READ-STOCK-INFO                         02570001
025800             MOVE SVT00000-PRE-DNNTD-CRD-AMT                      02580001
025900                                    TO SV001-PV-CARD-BALANCE      02590001
026000             PERFORM 7000-WRITE-RECORD                            02600001
026100         ELSE                                                     02610001
026200             IF SV001-PV-CARD-BALANCE > ZERO                      02620001
026300                 PERFORM 7000-WRITE-RECORD                        02630001
026400             ELSE                                                 02640001
026500                 PERFORM 6900-READ-STOCK-INFO                     02650001
026600                 IF SVT00008-CRD-RPLNT-IND = 'Y'                  02660001
026700                     PERFORM 7000-WRITE-RECORD                    02670001
026800                 END-IF                                           02680001
026900             END-IF                                               02690001
027000         END-IF                                                   02700001
027100     END-IF.                                                      02710001
027200                                                                  02720000
027300     PERFORM 6400-FETCH-STATUS-CHG-CURSOR.                        02730000
027400                                                                  02740000
027500                                                                  02750001
027600******************************************************************02760000
027700* 4000-PROCESS-ACTIVITY                                           02770000
027800******************************************************************02780000
027900 4000-PROCESS-ACTIVITY.                                           02790000
028000                                                                  02800000
028100     IF SVT00002-TRN-VOID-IND = 'Y'                               02810000
028200         CONTINUE                                                 02820000
028300     ELSE                                                         02830000
028400         ADD SVT00002-APP-AUTH-AMT TO SV001-PV-CARD-BALANCE       02840000
028500     END-IF.                                                      02850000
028600                                                                  02860000
028700     SET SV001-PS-STORE-NOT-FOUND TO TRUE.                        02870000
028800                                                                  02880000
028900     MOVE SVT00002-STR-NBR TO SV001-PV-ADD-STORE.                 02890000
029000     MOVE SVT00002-ST-CDE  TO SV001-PV-STATE-CDE.                 02900000
029100     MOVE ZERO             TO SV001-PV-STORE-SUB.                 02910000
029200                                                                  02920000
029300     PERFORM SV001-3000-CHECK-STORE                               02930000
029400         UNTIL SV001-PS-STORE-FOUND                               02940000
029500            OR SV001-PV-STORE-SUB > SV001-PC-STORE-LIMIT.         02950000
029600                                                                  02960000
029700     IF SV001-PS-STORE-NOT-FOUND                                  02970000
029800         IF SV001-PV-STATE-CDE = SPACES                           02980000
029900             CONTINUE                                             02990000
030000         ELSE                                                     03000000
030100             PERFORM SV001-3100-FIND-METRO-BY-STATE               03010000
030200             VARYING SV001-PV-STATE-SUB FROM 1 BY 1               03020000
030300               UNTIL SV001-PV-STATE-SUB > SV001-PV-STORE-MAX      03030000
030400         END-IF                                                   03040000
030500     END-IF.                                                      03050000
030600                                                                  03060000
030700     PERFORM 6700-FETCH-ACTIVITY-CURSOR.                          03070000
030800                                                                  03080000
030900******************************************************************03090000
031000* 6300-OPEN-STATUS-CHG-CURSOR                                     03100000
031100******************************************************************03110000
031200 6300-OPEN-STATUS-CHG-CURSOR.                                     03120000
031300     EXEC SQL                                                     03130000
031400          OPEN STATUS-CHG-CSR                                     03140000
031500     END-EXEC.                                                    03150000
031600                                                                  03160000
031700     EVALUATE TRUE                                                03170000
031800         WHEN SQLCODE = ZERO                                      03180000
031900              CONTINUE                                            03190000
032000         WHEN SQLWARN0 NOT EQUAL SPACE                            03200000
032100         WHEN SQLCODE NOT EQUAL ZERO                              03210000
032200             MOVE '6300-OPEN-STATUS-CHG-CURSOR '                  03220000
032300                                            TO PV-PARAGRAPH-NAME  03230000
032400             MOVE 'ERROR ON OPEN OF STATUS-CHG-CSR '              03240000
032500                                            TO PV-DB2-OPERATION   03250000
032600             PERFORM 9100-SQL-ABEND                               03260000
032700     END-EVALUATE.                                                03270000
032800                                                                  03280000
032900******************************************************************03290000
033000* 6400-FETCH-STATUS-CHG-CURSOR                                    03300000
033100******************************************************************03310000
033200 6400-FETCH-STATUS-CHG-CURSOR.                                    03320000
033300     EXEC SQL                                                     03330000
033400          FETCH STATUS-CHG-CSR                                    03340000
033500           INTO :SVT00001-CRD-NBR                                 03350000
033600               ,:SVT00001-CRD-PROD-YR                             03360000
033700               ,:SVT00001-SHIPT-REQ-NBR                           03370000
033800               ,:SVT00001-STR-NBR                                 03380000
033900               ,:SVT00001-CRD-STAT-CDE                            03390000
034000               ,:SVT00001-CRD-PIN-NBR                             03400005
034100               ,:SVT00001-CRD-TYP-CDE                             03410005
034200               ,:SVT00001-CRD-SPCTY-TYP-CDE                       03420005
034300     END-EXEC.                                                    03430000
034400                                                                  03440000
034500     EVALUATE TRUE                                                03450000
034600         WHEN SQLCODE = ZERO                                      03460000
034700             ADD +1 TO PV-PC-STAT-CHG-CARDS-FETCHED               03470005
034800             CONTINUE                                             03480005
034900         WHEN SQLCODE = +100                                      03490000
035000             SET PS-END-OF-STATUS-CHG TO TRUE                     03500000
035100         WHEN SQLWARN0 NOT EQUAL SPACE                            03510000
035200         WHEN SQLCODE NOT EQUAL ZERO                              03520000
035300             MOVE '6400-FETCH-STATUS-CHG-CURSOR'                  03530000
035400                                            TO PV-PARAGRAPH-NAME  03540000
035500             MOVE 'ERROR ON FETCH OF STATUS-CHG-CSR'              03550000
035600                                            TO PV-DB2-OPERATION   03560000
035700             PERFORM 9100-SQL-ABEND                               03570000
035800     END-EVALUATE.                                                03580000
035900                                                                  03590000
036000******************************************************************03600000
036100* 6500-CLOSE-STATUS-CHG-CURSOR                                    03610000
036200******************************************************************03620000
036300 6500-CLOSE-STATUS-CHG-CURSOR.                                    03630000
036400                                                                  03640000
036500     EXEC SQL                                                     03650000
036600          CLOSE STATUS-CHG-CSR                                    03660000
036700     END-EXEC.                                                    03670000
036800                                                                  03680000
036900     EVALUATE TRUE                                                03690000
037000         WHEN SQLCODE = ZERO                                      03700000
037100              CONTINUE                                            03710000
037200         WHEN SQLWARN0 NOT EQUAL SPACE                            03720000
037300         WHEN SQLCODE NOT EQUAL ZERO                              03730000
037400             MOVE '6500-CLOSE-STATUS-CHG-CURSOR'                  03740000
037500                                            TO PV-PARAGRAPH-NAME  03750000
037600             MOVE 'ERROR ON CLOSE OF STATUS-CHG-CSR'              03760000
037700                                            TO PV-DB2-OPERATION   03770000
037800             PERFORM 9100-SQL-ABEND                               03780000
037900     END-EVALUATE.                                                03790000
038000******************************************************************03800000
038100* 6600-OPEN-ACTIVITY-CURSOR                                       03810000
038200******************************************************************03820000
038300 6600-OPEN-ACTIVITY-CURSOR.                                       03830000
038400     EXEC SQL                                                     03840000
038500          OPEN ACTIVITY-CSR                                       03850000
038600     END-EXEC.                                                    03860000
038700                                                                  03870000
038800     EVALUATE TRUE                                                03880000
038900         WHEN SQLCODE = ZERO                                      03890000
039000              CONTINUE                                            03900000
039100         WHEN SQLWARN0 NOT EQUAL SPACE                            03910000
039200         WHEN SQLCODE NOT EQUAL ZERO                              03920000
039300             MOVE '6600-OPEN-ACTIVITY-CURSOR '                    03930000
039400                                            TO PV-PARAGRAPH-NAME  03940000
039500             MOVE 'ERROR ON OPEN OF ACTIVITY-CSR '                03950000
039600                                            TO PV-DB2-OPERATION   03960000
039700             PERFORM 9100-SQL-ABEND                               03970000
039800     END-EVALUATE.                                                03980000
039900                                                                  03990000
040000******************************************************************04000000
040100* 6700-FETCH-ACTIVITY-CURSOR                                      04010000
040200******************************************************************04020000
040300 6700-FETCH-ACTIVITY-CURSOR.                                      04030000
040400     EXEC SQL                                                     04040000
040500          FETCH ACTIVITY-CSR                                      04050000
040600           INTO :SVT00002-TRN-VOID-IND                            04060000
040700               ,:SVT00002-STR-NBR                                 04070000
040800               ,:SVT00002-CRD-NBR                                 04080000
040900               ,:SVT00002-APP-AUTH-AMT                            04090000
041000               ,:SVT00002-ST-CDE                                  04100000
041100     END-EXEC.                                                    04110000
041200                                                                  04120000
041300     EVALUATE TRUE                                                04130000
041400         WHEN SQLCODE = ZERO                                      04140000
041500             SET PS-ACTIVITY-FOUND TO TRUE                        04150000
041600             ADD +1 TO PV-PC-TRANSACTIONS-FETCHED                 04160005
041700         WHEN SQLCODE = +100                                      04170000
041800             SET PS-END-OF-ACTIVITY TO TRUE                       04180000
041900         WHEN SQLWARN0 NOT EQUAL SPACE                            04190000
042000         WHEN SQLCODE NOT EQUAL ZERO                              04200000
042100             MOVE '6700-FETCH-ACTIVITY-CURSOR'                    04210000
042200                                            TO PV-PARAGRAPH-NAME  04220000
042300             MOVE 'ERROR ON FETCH OF ACTIVITY-CSR'                04230000
042400                                            TO PV-DB2-OPERATION   04240000
042500             PERFORM 9100-SQL-ABEND                               04250000
042600     END-EVALUATE.                                                04260000
042700                                                                  04270000
042800******************************************************************04280000
042900* 6800-CLOSE-ACTIVITY-CURSOR                                      04290000
043000******************************************************************04300000
043100 6800-CLOSE-ACTIVITY-CURSOR.                                      04310000
043200                                                                  04320000
043300     EXEC SQL                                                     04330000
043400          CLOSE ACTIVITY-CSR                                      04340000
043500     END-EXEC.                                                    04350000
043600                                                                  04360000
043700     EVALUATE TRUE                                                04370000
043800         WHEN SQLCODE = ZERO                                      04380000
043900              CONTINUE                                            04390000
044000         WHEN SQLWARN0 NOT EQUAL SPACE                            04400000
044100         WHEN SQLCODE NOT EQUAL ZERO                              04410000
044200             MOVE '6800-CLOSE-ACTIVITY-CURSOR'                    04420000
044300                                            TO PV-PARAGRAPH-NAME  04430000
044400             MOVE 'ERROR ON CLOSE OF ACTIVITY-CSR'                04440000
044500                                            TO PV-DB2-OPERATION   04450000
044600             PERFORM 9100-SQL-ABEND                               04460000
044700     END-EVALUATE.                                                04470000
044800******************************************************************04480000
044900* 6900-READ-STOCK-INFO                                            04490000
045000******************************************************************04500000
045100 6900-READ-STOCK-INFO.                                            04510000
045200     EXEC SQL                                                     04520000
045300          SELECT A.PRE_DNNTD_CRD_AMT                              04530000
045400                ,B.CRD_RPLNT_IND                                  04540000
045500           INTO :SVT00000-PRE-DNNTD-CRD-AMT                       04550000
045600               ,:SVT00008-CRD-RPLNT-IND                           04560000
045700           FROM SVT_CRD_PROD A,                                   04570000
045800                SVT_CRD_STK_DNMNTN B                              04580000
045900          WHERE A.CRD_TYP_CDE       =  B.CRD_TYP_CDE              04590000
046000            AND A.CRD_STK_TYP_ID    =  B.CRD_STK_TYP_ID           04600000
046100            AND A.PRE_DNNTD_CRD_AMT =  B.PRE_DNNTD_CRD_AMT        04610000
046200            AND A.CRD_PROD_YR       = :SVT00001-CRD-PROD-YR       04620000
046300            AND A.SHIPT_REQ_NBR     = :SVT00001-SHIPT-REQ-NBR     04630000
046400           WITH UR                                                04640000
046500     END-EXEC.                                                    04650000
046600                                                                  04660000
046700     EVALUATE TRUE                                                04670000
046800         WHEN SQLCODE = ZERO                                      04680000
046900             CONTINUE                                             04690000
047000         WHEN SQLWARN0 NOT EQUAL SPACE                            04700000
047100         WHEN SQLCODE NOT EQUAL ZERO                              04710000
047200             MOVE '6900-READ-STOCK-INFO'                          04720000
047300                                            TO PV-PARAGRAPH-NAME  04730000
047400             MOVE 'ERROR ON READ OF SVT_CRD_PROD   '              04740000
047500                                            TO PV-DB2-OPERATION   04750000
047600             PERFORM 9100-SQL-ABEND                               04760000
047700     END-EVALUATE.                                                04770000
047800                                                                  04780000
047900******************************************************************04790000
048000* 7000-WRITE-RECORD                                               04800000
048100* WRITE RECORDS FOR CARD TO BE SENT TO STORES                     04810000
048200******************************************************************04820000
048300 7000-WRITE-RECORD.                                               04830000
048400                                                                  04840000
048500     INITIALIZE SV060-CARD-RCD.                                   04850014
048600                                                                  04860000
048700     MOVE SPACES              TO SV060-EXC-STORE.                 04870014
048800     MOVE 'CHG'               TO SV060-FUL-CHG.                   04880014
048900                                                                  04890005
049000     IF SVT00001-CRD-STAT-CDE = 'AV'                              04900000
049100         SET SV060-ACTION-ADD    TO TRUE                          04910005
049200     ELSE                                                         04920000
049300         SET SV060-ACTION-DELETE TO TRUE                          04930005
049400     END-IF.                                                      04940000
049500                                                                  04950000
049600     MOVE SVT00001-CRD-NBR TO SV060-SVC-NBR.                      04960014
049700                                                                  04970000
049800     MOVE SV001-PV-CARD-BALANCE TO SV060-SVC-BAL-AMT.             04980014
049900                                                                  04990005
050000*    POPULATE ADDITIONAL FIELDS FOR SQL SERVER OFF-LINE FILE.     05000005
050100*    MOVE SVT00001-CRD-PIN-NBR       TO SV060-SVC-PIN-NBR.        05010005
050200     MOVE SVT00001-CRD-TYP-CDE       TO SV060-SVC-TYP-CDE.        05020005
050300     MOVE SVT00001-CRD-SPCTY-TYP-CDE TO SV060-SVC-SPCTY-TYP-CDE.  05030005
050400                                                                  05040000
050500     SET SV001-PS-NOT-END-OF-METRO TO TRUE.                       05050000
050600     MOVE ZERO TO SV001-PV-CARD-METRO-SUB.                        05060000
050700                                                                  05070000
050800     PERFORM SV001-5000-GET-METRO-AREA                            05080000
050900         UNTIL SV001-PS-END-OF-METRO                              05090000
051000            OR SV001-PV-CARD-METRO-SUB GREATER THAN               05100000
051100               SV001-PC-METRO-TABLE-LIMIT.                        05110000
051200                                                                  05120000
051300******************************************************************05130000
051400* COPYBOOK FOR PROCEDURE STATEMENTS USED IN CREATING STORED VALUE 05140000
051500* RECORDS TO BE SENT TO STORES FOR OFFLINES.                      05150000
051600******************************************************************05160000
051700     COPY SVPD001.                                                05170011
051800                                                                  05180000
051900******************************************************************05190000
052000* 9100-SQL-ABEND - PERFORMS THE ABEND FOR THE PROGRAM IN THE      05200000
052100* EVENT THAT AN SQL ERROR OR WARNING CODE OCCURS.                 05210000
052200******************************************************************05220000
052300 9100-SQL-ABEND.                                                  05230000
052400     PERFORM 9990-DISPLAY-TOTALS.                                 05240005
052500     DISPLAY '** ABEND     **'.                                   05250000
052600     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        05260000
052700     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              05270000
052800     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               05280000
052900                                                                  05290000
053000******************************************************************05300000
053100* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     05310000
053200* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      05320000
053300******************************************************************05330000
053400     COPY DPPD004.                                                05340000
053500                                                                  05350000
053600     SET AC-DB2-ERROR TO TRUE.                                    05360000
053700     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         05370000
053800                                                                  05380000
053900******************************************************************05390005
054000* 9990-DISPLAY-TOTALS.                                            05400005
054100*  DISPLAY TOTALS AT END OF JOB.                                  05410005
054200******************************************************************05420005
054300 9990-DISPLAY-TOTALS.                                             05430005
054400                                                                  05440005
054500     DISPLAY '*************************************'.             05450005
054600     DISPLAY 'STATUS CHG CARDS ====> '                            05460005
054700                                    PV-PC-STAT-CHG-CARDS-FETCHED. 05470005
054800     DISPLAY 'TRANSACTIONS READ ===> ' PV-PC-TRANSACTIONS-FETCHED.05480005
054900     DISPLAY 'SV001 SQLS RCDS OUT => ' SV001-PV-SV060-WRITE-CNT.  05490005
055000     DISPLAY 'STORE FETCH COUNT ===> ' SV001-PV-STORE-FETCH-CNT.  05500005
055100     DISPLAY '*************************************'.             05510005
055200                                                                  05520005
055300******************************************************************05530000
055400* 9999-ABEND - PERFORMS A NON-SQL-ABEND                           05540000
055500******************************************************************05550000
055600 9999-ABEND.                                                      05560000
055700     DISPLAY '** ABEND           **'.                             05570000
055800     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  05580000
055900     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        05590000
056000     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       05600000
056100     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       05610000
056200     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         05620000
