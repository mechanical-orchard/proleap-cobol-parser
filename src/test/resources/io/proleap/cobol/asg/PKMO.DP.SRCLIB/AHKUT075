000100 ID DIVISION.                                                     00010000
000200 PROGRAM-ID.         AHKUT075.                                    00020000
000300 AUTHOR.             JEAN KURK.                                   00030000
000400 DATE-WRITTEN.       SEPTEMBER 2023.                              00040017
000500 DATE-COMPILED.                                                   00050000
000600*************************************************************     00060000
000800*                                                           *     00080000
000900*   SELECT ANY PO THAT DOES NOT HAVE AN INVOICE AND DOES    *     00090000
000900*   NOT HAVE ANY RECEIVERS.  CREATE A FILE THAT WILL BE     *     00091000
001000*   USED TO PURGE THE PO DATA.                              *     00100000
001100*                                                           *     00110000
001100*   WE ARE REQUIRED TO KEEP 6 YEARS OF IMPORT POS           *     00111003
001100*                                                           *     00112003
001200*   A MAX OF 100,000 ROWS WILL BE SELECTED PER RUN          *     00120000
003200*                                                           *     00220600
003200*   OUTPUT:                                                 *     00220700
003200*      LIST OF PO NUMBERS, AS INPUT TO OTHER PROCESSES      *     00220800
004200*                                                           *     00220900
004300*************************************************************     00221000
004400*   CHANGES:                                                *     00221100
004500*                                                           *     00221200
004600*   09/30/2023  INITIAL VERSION                             *     00221317
010680*************************************************************     00221400
010690/                                                                 00221500
010700 ENVIRONMENT DIVISION.                                            00221600
010800 CONFIGURATION SECTION.                                           00221700
010900 SOURCE-COMPUTER.        IBM-370.                                 00221800
011000 OBJECT-COMPUTER.        IBM-370.                                 00221900
011100                                                                  00222000
011200 INPUT-OUTPUT SECTION.                                            00223000
011300 FILE-CONTROL.                                                    00224000
029900     SELECT PO-LIST-FILE                   ASSIGN TO UT-S-OUT01.  00225000
011600                                                                  00227000
011700 DATA DIVISION.                                                   00228000
011800 FILE SECTION.                                                    00229000
032500                                                                  00230000
032500 FD  PO-LIST-FILE                                                 00240000
032500     RECORDING MODE IS F                                          00250000
032500     BLOCK CONTAINS 0 CHARACTERS                                  00260000
032500     LABEL RECORDS ARE STANDARD                                   00270000
032500     DATA RECORD IS PO-LIST-RECORD.                               00280000
032500 01  PO-LIST-RECORD               PIC X(4).                       00290012
032500                                                                  00291000
013500 WORKING-STORAGE SECTION.                                         00299000
013600                                                                  00300000
013700 01  FILLER                       PIC X(58)     VALUE             00310000
013800     '************WORKING STORAGE STARTS HERE*******************'.00320000
013900                                                                  00330000
014000 01  PV-PROGRAM-VARIABLES.                                        00340000
014100     05  PV-PROGRAM-NAME          PIC X(08)     VALUE 'AHKUT075'. 00350004
014100     05  PV-CURRENT-PARAGRAPH     PIC X(20)     VALUE SPACES.     00360004
015500     05  PV-PO-COUNT              PIC 9(09)     VALUE ZERO.       00370000
015500     05  PV-MAX-REC-CNT           PIC 9(09)     VALUE 100000.     00380013
014100     05  PV-TMST                  PIC X(26)     VALUE SPACES.     00390004
014200     05  PV-TIMESTAMP-DETAIL      REDEFINES PV-TMST.              00391005
014500         10  PV-TIMESTAMP-19.                                     00394005
014700             15  PV-TMS-YEAR      PIC 9(4).                       00396005
014700             15  PV-TMS-REST      PIC X(22).                      00397005
014100     05  PV-YEAR-CHK              PIC 9(4)      VALUE ZERO.       00398005
014100     05  PV-YEAR-CHECK            REDEFINES PV-YEAR-CHK.          00399007
014100         10  PV-YR-CK             PIC X(4).                       00400007
017300                                                                  00550000
018600 01  PS-PROGRAM-SWITCHES.                                         00560000
018610     05  PS-PO-CURSOR-SW          PIC  X(01)    VALUE 'N'.        00570000
018620         88  PS-PO-CSR-END                      VALUE 'Y'.        00580000
018630         88  PS-PO-CSR-NOT-END                  VALUE 'N'.        00590000
019600                                                                  00660000
020800*  OUTPUT RECORD                                                  00672500
030200     COPY AHRD002.                                                00672600
020700                                                                  00672700
020800*----------------------------------------------------------------*00672800
020900*  ABEND DATA AREAS                                              *00672900
021000*----------------------------------------------------------------*00673000
021100 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          00674000
021200                                             COMP SYNC.           00675000
021300     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         00676000
021400     88  AC-BAD-DATA                         VALUE +4008.         00677000
021500     88  AC-DB2-ERROR                        VALUE +4013.         00678000
021600     88  AC-DATE-ERROR                       VALUE +4019.         00679000
021700                                                                  00680000
021800                                                                  00690000
021900 01  ABEND-AREAS.                                                 00700000
022000     05  AA-ABEND-LIT            PIC  X(40)  VALUE                00710000
022100             '*****       ABEND'.                                 00720000
022200     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                00730000
022300             '*****   PROGRAM: AHKUT075'.                         00740000
022400     05  AA-PARAGRAPH-LIT.                                        00750000
022500         10  FILLER              PIC  X(17)  VALUE                00760000
022600             '***** PARAGRAPH: '.                                 00770000
022700         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        00780000
022800     05  AA-MESSAGE-LINE-1.                                       00790000
022900         10  FILLER              PIC  X(06)  VALUE '*****'.       00800000
023000         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        00810000
023100     05  AA-MESSAGE-LINE-2.                                       00820000
023200         10  FILLER              PIC  X(06)  VALUE '*****'.       00830000
023300         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        00840000
023400     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                00850000
023500             '*****    DB2 ERROR'.                                00860000
023600     05  AA-DB2-OPERATION-LIT.                                    00870000
023700         10  FILLER              PIC  X(17)  VALUE                00880000
023800             '***** OPERATION: '.                                 00890000
023900         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        00900000
024000     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        00910000
024100     05  AA-BAD-RECEIVE-DATA-MSG-1.                               00920000
024200         10  FILLER              PIC  X(23)  VALUE                00930000
024300             'INVALID RECORD TYPE OF '.                           00940000
024400         10  AA-BAD-RECEIVE-TYPE PIC  9(01)  VALUE ZERO.          00950000
024500         10  FILLER              PIC  X(30)  VALUE                00960000
024600             ' ON INPUT RECEIVE UPDATES FILE'.                    00970000
025900                                                                  00980000
026000         EXEC SQL                                                 00990000
026100             INCLUDE TPURCHS                                      01000000
026200         END-EXEC.                                                01010000
025900                                                                  01020000
026000         EXEC SQL                                                 01030000
026100             INCLUDE TPLNSHP                                      01040000
026200         END-EXEC.                                                01050000
025900                                                                  01060000
026000         EXEC SQL                                                 01070000
026100             INCLUDE TINVOIC                                      01080000
026200         END-EXEC.                                                01090000
025900                                                                  01100000
026000         EXEC SQL                                                 01110000
026100             INCLUDE TRECEIV                                      01120000
026200         END-EXEC.                                                01130000
025900                                                                  01140000
025900                                                                  01590000
029300******************************************************************01600000
029400*  DB2 COMMUNICATION AREA                                         01610000
029500*                                                                 01620000
029600     EXEC SQL                                                     01630000
029700         INCLUDE SQLCA                                            01640000
029800     END-EXEC.                                                    01650000
029900*                                                                 01660000
030000*  DB2 COMMUNICATION AREA2                                        01670000
030100*                                                                 01680000
030200     COPY DPWS004.                                                01690000
030200     COPY SQLCA2.                                                 01700000
029900*                                                                 01710000
013010*---------------------------------------------------------------* 01720000
013020*    SELECT PO'S TO BE DELETED                                  * 01730000
013020*    NOTE THAT THE STATEMENTS L.PO_NBR = L.PO_NBR AND           * 01731016
013020*    L.DONT_SHIP_BEF_DTE = L.DONT_SHIP_BEF_DTE ARE ADDED TO     * 01732016
013020*    FORCE THE QUERY TO ACCESS THE TABLES IN THE ORDER OF       * 01733016
013020*    TPURCHS-TPLNSHP-TINVOIC-TRECEIV, WHICH USES A BETTER INDEX * 01734016
013020*    AND RUNS SLIGHTLY FASTER, PER THE DBA                      * 01735016
013040*---------------------------------------------------------------* 01740000
013050     EXEC SQL                                                     01750000
013060         DECLARE PO-CURSOR CURSOR FOR                             01760000
013070           SELECT DISTINCT                                        01770000
013070                  P.PO_NBR                                        01780001
013080             FROM TPURCHS P                                       01800000
013080                , TPLNSHP L                                       01801000
013090            WHERE P.VER_STATUS_CDE      = 'A'                     01820000
013090              AND YEAR(P.LAST_UPD_TMST) < :PV-YR-CK               01821007
013090              AND P.PO_NBR              = L.PO_NBR                01822000
013090              AND L.PO_NBR              = L.PO_NBR                01822115
013090              AND L.DONT_SHIP_BEF_DTE   = L.DONT_SHIP_BEF_DTE     01822215
013090              AND L.VER_STATUS_CDE      = 'A'                     01823000
013090              AND YEAR(L.DONT_SHIP_BEF_DTE)                       01824005
013090                                        < :PV-YR-CK               01825007
013090              AND NOT EXISTS                                      01826000
013090                  (SELECT 1                                       01827000
013090                   FROM TINVOIC I                                 01828000
013090                  WHERE P.PO_NBR = I.PO_NBR)                      01829000
013090              AND NOT EXISTS                                      01829100
013090                  (SELECT 1                                       01829200
013090                   FROM TRECEIV R                                 01829300
013090                  WHERE P.PO_NBR = R.ORD_NBR)                     01829400
013094             WITH UR                                              01833009
013095     END-EXEC.                                                    01840000
013097                                                                  01850000
030400 PROCEDURE DIVISION.                                              02150000
030800*----------------------------------------------------------------*02160000
030900 A000-MAINLINE-ROUTINE.                                           02170000
031000                                                                  02180000
031100     PERFORM B100-INITIALIZATION.                                 02190000
031200                                                                  02200000
035400     PERFORM B200-PROCESS-PO-CURSOR                               02210000
035500        UNTIL PS-PO-CSR-END                                       02220000
035500           OR PV-PO-COUNT = PV-MAX-REC-CNT.                       02221000
031800                                                                  02230000
031900     PERFORM B400-EOJ-PROCESSING.                                 02240000
032000                                                                  02250000
032100     GOBACK.                                                      02260000
032200                                                                  02270000
032300*----------------------------------------------------------------*02280000
032800 B100-INITIALIZATION.                                             02290000
010100                                                                  02300000
067500     OPEN OUTPUT PO-LIST-FILE.                                    02340000
067500     INITIALIZE AH002-DRIVER-RECORD-LAYOUT.                       02360000
032900                                                                  02361000
032900     PERFORM S100-GET-DATE.                                       02361104
032900                                                                  02361204
035400     PERFORM C100-OPEN-PO-CSR.                                    02362000
035400     PERFORM C120-FETCH-PO-CSR.                                   02363000
035500     IF PS-PO-CSR-END                                             02364000
035500         DISPLAY 'NOTHING FOUND TO DELETE'                        02365000
035500     END-IF.                                                      02366000
035500                                                                  02367000
035500                                                                  02368000
032300*----------------------------------------------------------------*02369000
032800 B200-PROCESS-PO-CURSOR.                                          02370000
032900                                                                  02380000
032900     IF PV-PO-COUNT < PV-MAX-REC-CNT                              02380400
028166         PERFORM W100-WRITE-PO-RECORD                             02381000
032900     END-IF.                                                      02382000
032900                                                                  02383000
035400     PERFORM C120-FETCH-PO-CSR.                                   02450000
035500                                                                  02460000
035500                                                                  02470000
040500*----------------------------------------------------------------*02480000
040600*    END OF JOB PROCESSING.                                      *02490000
040700*----------------------------------------------------------------*02500000
040800 B400-EOJ-PROCESSING.                                             02510000
040900                                                                  02520000
035400     PERFORM C150-CLOSE-PO-CSR.                                   02521000
087400     CLOSE PO-LIST-FILE.                                          02530000
040900                                                                  02550000
041800     DISPLAY '************'.                                      02560000
041600     DISPLAY '** AHKUT075 SUMMARY **'.                            02630000
041700     DISPLAY '** POS SELECTED         = ' PV-PO-COUNT.            02640000
041800     DISPLAY '************'.                                      02790000
042500                                                                  02820000
042500                                                                  02830000
028117******************************************************************07480000
028118* OPEN PO CURSOR                                                  07490000
028119******************************************************************07500000
028120 C100-OPEN-PO-CSR.                                                07510000
028121                                                                  07520000
097700     MOVE 'C100-OPEN-PO-CSR'     TO PV-CURRENT-PARAGRAPH.         07530000
028123                                                                  07540000
028124     EXEC SQL                                                     07550000
028125          OPEN PO-CURSOR                                          07560000
028126     END-EXEC.                                                    07570000
028127                                                                  07580000
028128     EVALUATE TRUE                                                07590000
028129         WHEN SQLCODE = ZERO                                      07600000
028130              CONTINUE                                            07610000
028136         WHEN SQLWARN0 NOT EQUAL SPACE                            07620000
028137         WHEN SQLCODE  NOT EQUAL ZERO                             07630000
028140              MOVE PV-CURRENT-PARAGRAPH                           07640000
028141                                  TO AA-PARAGRAPH-NAME            07650000
028142              MOVE 'OPEN PO CURSOR'                               07660000
028143                                  TO AA-DB2-OPERATION             07670000
028145              MOVE 'TPURCHS'      TO AA-DB2-TABLE                 07680000
028147              PERFORM Z999-DB2-ABEND                              07690000
028148     END-EVALUATE.                                                07700000
028149                                                                  07710000
028150                                                                  07720000
028151******************************************************************07730000
028152* FETCH PO CURSOR                                                 07740000
028153******************************************************************07750000
028154 C120-FETCH-PO-CSR.                                               07760000
028155                                                                  07770000
097700     MOVE 'C120-FETCH-PO-CSR'    TO PV-CURRENT-PARAGRAPH.         07780000
028157                                                                  07790000
028158     EXEC SQL                                                     07800000
028159         FETCH PO-CURSOR                                          07810000
028160          INTO  :PURCHS-PO-NBR                                    07820000
028162     END-EXEC.                                                    07840000
028163                                                                  07850000
028164     EVALUATE TRUE                                                07860000
028165         WHEN SQLCODE = ZERO                                      07870000
028167              CONTINUE                                            07910000
028168         WHEN SQLCODE = +100                                      07920000
028169              SET PS-PO-CSR-END TO TRUE                           07930000
028170                                                                  07940000
028171         WHEN SQLWARN0 NOT EQUAL SPACE                            07950000
028172         WHEN SQLCODE NOT EQUAL ZERO                              07960000
028174              MOVE PV-CURRENT-PARAGRAPH                           07970000
028175                                  TO AA-PARAGRAPH-NAME            07980000
028176              MOVE 'FETCH PO CURSOR'                              07990000
028177                                  TO AA-DB2-OPERATION             08000000
028179              MOVE 'TPURCHS'      TO AA-DB2-TABLE                 08010000
028181              PERFORM Z999-DB2-ABEND                              08020000
028182     END-EVALUATE.                                                08030000
028183                                                                  08040000
028184                                                                  08050000
028185                                                                  08060000
028186******************************************************************08070000
028187* CLOSE PO CURSOR                                                 08080000
028188******************************************************************08090000
028189 C150-CLOSE-PO-CSR.                                               08100000
028190                                                                  08110000
097700     MOVE 'C150-CLOSE-PO-CSR'    TO PV-CURRENT-PARAGRAPH.         08120000
028192                                                                  08130000
028193     EXEC SQL                                                     08140000
028194          CLOSE PO-CURSOR                                         08150000
028195     END-EXEC.                                                    08160000
028196                                                                  08170000
028197     EVALUATE TRUE                                                08180000
028198         WHEN SQLCODE = ZERO                                      08190000
028199              CONTINUE                                            08200000
028200         WHEN SQLWARN0 NOT EQUAL SPACE                            08210000
028201         WHEN SQLCODE  NOT EQUAL ZERO                             08220000
028203              MOVE PV-CURRENT-PARAGRAPH                           08230000
028204                                  TO AA-PARAGRAPH-NAME            08240000
028205              MOVE 'CLOSE PO CURSOR'                              08250000
028206                                  TO AA-DB2-OPERATION             08260000
028208              MOVE 'TPURCHS'      TO AA-DB2-TABLE                 08270000
028210              PERFORM Z999-DB2-ABEND                              08280000
028211     END-EVALUATE.                                                08290000
028212                                                                  08300000
028213                                                                  08310000
280300*---------------------------------------------------------------- 08341004
280400*    WRITES THE PO LIST RECORD                                    08342004
280500*---------------------------------------------------------------- 08343004
047000 S100-GET-DATE.                                                   08350004
047100                                                                  08360004
047200     EXEC SQL                                                     08370004
047300          SET :PV-TMST = CURRENT TIMESTAMP                        08380004
047400     END-EXEC.                                                    08390004
047500                                                                  08400004
047500     COMPUTE PV-YEAR-CHK = PV-TMS-YEAR - 5.                       08401005
047500     DISPLAY 'AHKUT075 - YEAR CUTOFF ' PV-YR-CK.                  08402012
047500                                                                  08410004
047500                                                                  08420012
280300*---------------------------------------------------------------- 10260000
280400*    WRITES THE PO LIST RECORD                                    10270000
280500*---------------------------------------------------------------- 10280000
280200 W100-WRITE-PO-RECORD.                                            10290000
280600                                                                  10300000
028166     MOVE PURCHS-PO-NBR          TO AH002-PO-NBR.                 10310012
280700     WRITE PO-LIST-RECORD        FROM AH002-DRIVER-RECORD-LAYOUT. 10320012
280800     ADD +1                      TO PV-PO-COUNT.                  10330000
281000                                                                  10340000
145500                                                                  10350000
152000*----------------------------------------------------------------*10580000
152100*    ABEND ROUTINE.                                              *10590000
152200*----------------------------------------------------------------*10600000
152300 Z900-PROCESS-ABEND.                                              10610000
152400                                                                  10620000
152500     DISPLAY '*** ABEND'.                                         10630000
152600     DISPLAY '*** PROGRAM   = AHKUT075'.                          10640000
152700     DISPLAY '*** PARAGRAPH = ' PV-CURRENT-PARAGRAPH.             10650000
152800     DISPLAY AA-MESSAGE-LINE-1.                                   10660000
152900     DISPLAY AA-MESSAGE-LINE-2.                                   10670000
153000     COPY DPPD004.                                                10680000
153100     CALL 'ILBOABN0' USING ABEND-CODE.                            10690000
153200                                                                  10700000
153300*----------------------------------------------------------------*10710000
153400*    DB2 ABEND ROUTINE.                                          *10720000
153500*----------------------------------------------------------------*10730000
153600 Z999-DB2-ABEND.                                                  10740000
153700                                                                  10750000
153800     DISPLAY AA-ABEND-LIT.                                        10760000
153900     DISPLAY AA-DB2-ERROR-LIT.                                    10770000
154000     DISPLAY AA-PROGRAM-LIT.                                      10780000
154100     DISPLAY AA-PARAGRAPH-LIT.                                    10790000
154200     DISPLAY AA-DB2-OPERATION-LIT.                                10800000
154300     DISPLAY AA-DB2-TABLE.                                        10810000
154400     SET AC-DB2-ERROR TO TRUE.                                    10820000
154500                                                                  10830000
154600     COPY DPPD004.                                                10840000
154700                                                                  10850000
154800     CALL 'ILBOABN0' USING ABEND-CODE.                            10860000
