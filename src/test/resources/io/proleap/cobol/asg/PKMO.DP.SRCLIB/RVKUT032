000100 IDENTIFICATION DIVISION.                                         00010099
000200                                                                  00020099
000300 PROGRAM-ID.   RVKUT032.                                          00030099
000400 AUTHOR.       VIRGENE LENNEMAN.                                  00040099
000500 INSTALLATION. KOHLS DEPARTMENT STORES.                           00050099
000600 DATE-WRITTEN. MARCH 2008.                                        00060099
000700 DATE-COMPILED.                                                   00070099
000800                                                                  00080099
000900******************************************************************00090099
001000*  MARK OUT OF STOCK FROM RTV FORMAT FOR IN STORE PERM TABLES     00100099
001100******************************************************************00110099
001200*                                                                 00120099
001300* THIS PROGRAM COMPILES WITH A RET CODE OF 4 BECAUSE OF THE       00130099
001400* UPDATE TO TSPCNBR (WHICH UPDATES THE ENTIRE TABLE - 1 COLUMN)   00140099
001500*-----------------------------------------------------------------00150099
001600* THIS PROGRAM USES AN EXTRACT FILE CREATED BY UNLOADING NEEDED   00160099
001700* DATA FROM TDFCTOR, TDFMEIT, XLT_SKU AND XLT_UPC. IT ALSO USES   00170099
001800* PERM PRICE CONSTANTS FOUND IN COPYBOOK PEWS049 TO FILL IN       00180099
001900* A FILE LAYOUT COMPARABLE TO THE DCLGENS FOR TSTRPPC AND TSPPCDT.00190099
002000*                                                                 00200099
002100* THE UPDATE TO THESE TABLES WILL TAKE PLACE IN A SEPARATE PGM.   00210099
002200*                                                                 00220099
002300* BELOW IS AN EXAMPLE OF WHAT THE EXTRACT PULLS BACK AND          00230099
002400* HOW A EACH EXTRACT REC SHOULD TRANSLATE TO THE PERM TABLES.     00240099
002500* THE TSTRPPC - IS A HDR FOR THE DETAILS IN TSPPCDT.              00250099
002600*                                                                 00260099
002700*-------------- E X A M P L E -----------------------------       00270099
002800*                                |   (SAME DOC_NBR & DEST_LOC)    00280099
002900*             TDFMEIT            | TSTRPPC     |    TSPPCDT       00290099
003000* -------------------------------|-------------|------------------00300099
003100*  DFCT          DFCT      MARK  |       TOT   |ACTL          ACTL00310099
003200*  ORD  SEQ      ITEM     OUT OF | DOC ACTL_PR |PR       ROW PR_CH00320099
003300*   ID  NBR       NBR      STOCK | NBR CHRG_AMT|CHRG_AMT NBR  QTY 00330099
003400* ----- --- -------------- ------| --- --------|-------- ---- ----00340099
003500*   16   1  10230000000001  1473 |31673 2050.00|200.00    1    4  00350099
003600*   16   2  10230000000001  1473 |             |                  00360099
003700*   16   3  10230000000001  1473 |             |                  00370099
003800*   16   4  10230000000001  1473 |             |                  00380099
003900*                                |             |                  00390099
004000*   16   5  10230000000007  1473 |             |250.00    2    5  00400099
004100*   16   6  10230000000007  1473 |             |                  00410099
004200*   16   7  10230000000007  1473 |             |                  00420099
004300*   16   8  10230000000007  1473 |             |                  00430099
004400*   16   9  10230000000007  1473 |             |                  00440099
004500*-----------------------------------------------------------------00450099
004600*   CALC EXPLANATIONS:                                            00460099
004700*                                 $2050.00= ((4*200) + (5*250))   00470099
004800*                                                                 00480099
004900*                             ACT_PR_CHG_QTY = 4 (NBR SAME ITMS   00490099
005000*                                                ROLLING UP INTO  00500099
005100*                                                A SINGLE DTL REC 00510099
005200*                                                ON THE PERM SIDE)00520099
005300******************************************************************00530099
005400******************************************************************00540099
005500*  CHANGE LOG.                                                    00550099
005600*  DATE         CHANGED BY      DESC                              00560099
005700*  -----------  --------------  ----------------------------------00570099
005800*  10/30/2011   C. STRODTHOFF - GENCO / RTV UPGRADE. CHANGE FOR   00580099
005900*                               MULTIPLE RTV LOCS AND REMOVE      00590099
006000*                               HARDCODED '811'.                  00600099
006100*                               PRJ ID 3219 - WR40134.            00610099
006200******************************************************************00620099
006300*                                                                 00630099
006400 ENVIRONMENT DIVISION.                                            00640099
006500*                                                                 00650099
006600 CONFIGURATION SECTION.                                           00660099
006700 SOURCE-COMPUTER.        IBM-3090.                                00670099
006800 OBJECT-COMPUTER.        IBM-3090.                                00680099
006900 INPUT-OUTPUT SECTION.                                            00690099
007000 FILE-CONTROL.                                                    00700099
007100                                                                  00710099
007200     SELECT  RV-MOS-EXTRACT-FILE  ASSIGN TO INP01.                00720099
007300                                                                  00730099
007400     SELECT  RV-HEADER-FILE       ASSIGN TO OUT01.                00740099
007500                                                                  00750099
007600     SELECT  RV-DETAIL-FILE       ASSIGN TO OUT02.                00760099
007700                                                                  00770099
007800 DATA DIVISION.                                                   00780099
007900 FILE SECTION.                                                    00790099
008000                                                                  00800099
008100 FD  RV-MOS-EXTRACT-FILE                                          00810099
008200     RECORDING MODE IS F                                          00820099
008300     LABEL RECORDS ARE STANDARD                                   00830099
008400     BLOCK CONTAINS 0 RECORDS.                                    00840099
008500 01  RV-EXTRACT-RECORD               PIC  X(55).                  00850099
008600*                                                                 00860099
008700 FD  RV-HEADER-FILE                                               00870099
008800     RECORDING MODE IS F                                          00880099
008900     LABEL RECORDS ARE STANDARD                                   00890099
009000     BLOCK CONTAINS 0 RECORDS.                                    00900099
009100 01  RV-HEADER-RECORD                PIC  X(260).                 00910099
009200*                                                                 00920099
009300 FD  RV-DETAIL-FILE                                               00930099
009400     RECORDING MODE IS F                                          00940099
009500     LABEL RECORDS ARE STANDARD                                   00950099
009600     BLOCK CONTAINS 0 RECORDS.                                    00960099
009700 01  RV-DETAIL-RECORD                PIC  X(260).                 00970099
009800*                                                                 00980099
009900 WORKING-STORAGE SECTION.                                         00990099
010000 01  ABEND-CODE                      PIC S9(04)    VALUE +0       01000099
010100                                                   COMP SYNC.     01010099
010200 01  PA-PROGRAM-ACCUMULATORS.                                     01020099
010300     05  PA-TOT-COMMITS-TAKEN        PIC S9(09) VALUE +0 COMP-3.  01030099
010400     05  PA-FIRST-DOC-NBR-COMMITTED  PIC S9(09) VALUE +0 COMP-3.  01040099
010500     05  PA-LAST-DOC-NBR-COMMITTED   PIC S9(09) VALUE +0 COMP-3.  01050099
010600                                                                  01060099
010700 01  PC-PROGRAM-CONSTANTS.                                        01070099
010800     05  PC-CURRENT-PROGRAM-NAME     PIC X(08)  VALUE 'RVKUT032'. 01080099
010900     05  PC-PGS-TO-PRINT             PIC 9(02)  VALUE ZERO.       01090099
011000     05  PC-UID-NBR                  PIC X(04)  VALUE 'RLOG'.     01100099
011100     05  PC-SPACE                    PIC X(01)  VALUE ' '.        01110099
011200     05  PC-SLASH                    PIC X(01)  VALUE '/'.        01120099
011300                                                                  01130099
011400 01  PS-PROGRAM-SWITCHES.                                         01140099
011500     05  PS-END-OF-FILE-SW           PIC X(01)  VALUE 'N'.        01150099
011600         88  PS-EOF-YES                         VALUE 'Y'.        01160099
011700         88  PS-EOF-NO                          VALUE 'N'.        01170099
011800     05  PS-MOS-ID-EXISTS-SW         PIC X(01)  VALUE 'N'.        01180099
011900         88  PS-MOS-ID-EXISTS-YES               VALUE 'Y'.        01190099
012000         88  PS-MOS-ID-EXISTS-NO                VALUE 'N'.        01200099
012100     05  PS-FIRST-TIME-SW            PIC X(01)  VALUE 'Y'.        01210099
012200         88  PS-FIRST-TIME                      VALUE 'Y'.        01220099
012300         88  PS-NOT-FIRST-TIME                  VALUE 'N'.        01230099
012400                                                                  01240099
012500 01  PV-PROGRAM-VARIABLES.                                        01250099
012600       05  PV-MAJ-CLASS-PIC9-WORK.                                01260099
012700           10  FILLER                PIC  9(02) VALUE  0.         01270099
012800           10  PV-MAJ-CLASS-P1       PIC  9(01) VALUE  0.         01280099
012900           10  PV-MAJ-CLASS-P2       PIC  9(01) VALUE  0.         01290099
013000       05  PV-MAJ-CLASS-PIC9         PIC S9(04) VALUE +0.         01300099
013100       05  PV-DEPT-X.                                             01310099
013200           10  PV-DEPT-PIC9          PIC S9(03) VALUE +0.         01320099
013300       05  PV-SUB-CLASS-PIC9         PIC S9(02) VALUE +0.         01330099
013400       05  PV-ACTL-PR-CHG-QTY        PIC S9(9) COMP.              01340099
013500       05  PV-ACTL-PR-CHG-AMT-TOT    PIC S9(9)V9(2) COMP-3.       01350099
013600       05  PV-DOCUMENT-COUNT         PIC  S9(4) COMP.             01360099
013700       05  PV-DISPLAY-RECORD         PIC ZZ,ZZZ,ZZ9-.             01370099
013800       05  PV-RECS-READ              PIC S9(9)  VALUE +0.         01380099
013900       05  PV-HDR-RECS-WRITTEN       PIC S9(9)  VALUE +0.         01390099
014000       05  PV-DTL-RECS-WRITTEN       PIC S9(9)  VALUE +0.         01400099
014100       05  PV-TEMP-DEPT-LIST-AUTH    PIC X(40).                   01410099
014200                                                                  01420099
014300       05  PV-PREV-DEPT              PIC   X(03) VALUE SPACE.     01430099
014400       05  PV-PREV-DFCT-ITEM-NBR     PIC  S9(15)V COMP-3.         01440099
014500       05  PV-PREV-MKOUT-ORD-ID      PIC  S9(11)V COMP-3.         01450099
014600       05  PV-PREV-DFCT-ORD-ID       PIC  S9(12)V COMP-3.         01460099
014700       05  PV-PREV-RTL-COST-AMT      PIC  S9(05)V9(2) COMP-3.     01470099
014800       05  PV-PREV-SUB-CLASS         PIC   X(02).                 01480099
014900       05  PV-PREV-SKU-NBR           PIC S9(8)V COMP-3.           01490099
015000       05  PV-PREV-UPC-NBR           PIC S9(15)V COMP-3.          01500099
015100       05  PV-PREV-OPER-UNT-ID       PIC S9(04)  COMP.            01510099
015200                                                                  01520099
015220       05  PV-DFCT-ORD-ID              PIC 9(12).                 01522099
015230       05  PV-DFCT-ORD-ID-R  REDEFINES                            01523099
015240           PV-DFCT-ORD-ID              PIC X(12).                 01524099
015241       05  PV-STRING                   PIC  X(16).                01524199
015242       05  PV-START                    PIC  S9(04) COMP           01524299
015243                                          VALUE ZEROS.            01524399
015245       05  PV-LENGTH                   PIC   9(04).               01524599
015246       05  PV-LNG                      PIC   9(04).               01524699
015247       05  PV-COUNTER                  PIC   9(04).               01524799
015250                                                                  01525099
015300       05  PV-DUMMY-SKU-X.                                        01530099
015400           10  PV-DUMMY-SKU-DEPT     PIC  9(03).                  01540099
015500           10  PV-DUMMY-SKU-CLASS    PIC  9(02).                  01550099
015600           10  PV-DUMMY-SKU-SEQ      PIC  9(03)  VALUE 0.         01560099
015700       05  PV-DUMMY-SKU-9 REDEFINES PV-DUMMY-SKU-X PIC 9(08).     01570099
015800                                                                  01580099
015900       05  PV-DISPLAY-NO-COMMA       PIC ZZZZZZZ9-.               01590099
016000       05  PV-PARAGRAPH-NAME         PIC  X(30) VALUE SPACE.      01600099
016100       05  PV-ABEND-MESSAGE          PIC  X(30) VALUE SPACE.      01610099
016200       05  PV-SQLCODE                PIC  S9(9) VALUE ZEROES.     01620099
016300       05  PV-DB2-VIEW-NAME          PIC X(10) VALUE SPACES.      01630099
016400                                                                  01640099
016500*  MOS EXTRACT RECORD COPYBOOK                                    01650099
016600     COPY RVRD053.                                                01660099
016700                                                                  01670099
016800*  HEADER RECORD FOR TSTRPPC                                      01680099
016900     COPY RVRD054.                                                01690099
017000                                                                  01700099
017100*  DETAIL RECORD FOR TSPPCDT                                      01710099
017200     COPY RVRD055.                                                01720099
017300                                                                  01730099
017400*  PERMANENT PRICE CHANGE CONSTANTS                               01740099
017500     COPY PEWS049.                                                01750099
017600                                                                  01760099
017700*  DB2 FORMATTED MESSAGE AREA                                     01770099
017800     COPY DPWS004.                                                01780099
017900                                                                  01790099
018000*  COMMUNICATIONS AREA FOR DB2                                    01800099
018100     EXEC SQL                                                     01810099
018200          INCLUDE SQLCA                                           01820099
018300     END-EXEC.                                                    01830099
018400                                                                  01840099
018500*  DECLARATION   PE-NEXT AVAILABLE NUMBER FOR IN-STORE            01850099
018600     EXEC SQL                                                     01860099
018700          INCLUDE TSPCNBR                                         01870099
018800     END-EXEC.                                                    01880099
018900                                                                  01890099
019000*  DECLARATION   PE-NEXT PROPOSED IN-STORE PRICE CHANGE           01900099
019100     EXEC SQL                                                     01910099
019200          INCLUDE TSTRPPC                                         01920099
019300     END-EXEC.                                                    01930099
019400                                                                  01940099
019500 LINKAGE SECTION.                                                 01950099
019600                                                                  01960099
019700 PROCEDURE DIVISION.                                              01970099
019800******************************************************************01980099
019900*  0000-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE PROGRAM.  *01990099
020000******************************************************************02000099
020100 0000-MAINLINE.                                                   02010099
020200     PERFORM 1000-INITIALIZE.                                     02020099
020300                                                                  02030099
020400     PERFORM 2000-PROCESS                                         02040099
020500         UNTIL PS-EOF-YES                                         02050099
020600                                                                  02060099
020700     PERFORM 9000-EOJ.                                            02070099
020800                                                                  02080099
020900     GOBACK.                                                      02090099
021000                                                                  02100099
021100******************************************************************02110099
021200* INITIALIZE VARIABLES.                                           02120099
021300* OPEN INPUT AND OUTPUT FILES                                     02130099
021400* DO A PRIME READ FROM THE INOUT FILE                             02140099
021500******************************************************************02150099
021600 1000-INITIALIZE.                                                 02160099
021700     DISPLAY '************ START OF RVKUT032 ***************'     02170099
021800                                                                  02180099
021900     INITIALIZE   PA-PROGRAM-ACCUMULATORS                         02190099
022000                  PV-PROGRAM-VARIABLES                            02200099
022100                  DCLTSPCNBR.                                     02210099
022200                                                                  02220099
022300     OPEN INPUT RV-MOS-EXTRACT-FILE.                              02230099
022400     OPEN OUTPUT RV-HEADER-FILE                                   02240099
022500                 RV-DETAIL-FILE.                                  02250099
022600                                                                  02260099
022700     PERFORM 6000-READ-MOS-EXTRACT-FILE.                          02270099
022800     IF PS-EOF-NO                                                 02280099
022900         SET PS-NOT-FIRST-TIME TO TRUE                            02290099
023000******** DOCUMENT-COUNT WILL BECOME ROW-NBR ON DETAIL FILE        02300099
023100         MOVE +0                    TO PV-DOCUMENT-COUNT          02310099
023200******** THIS WILL LOCK THE TABLE TO GET THE CURRENT DOC NBR,     02320099
023300******** INCREMENT IT AND THEN UPDATE THE TABLE                   02330099
023400         PERFORM 5000-GET-NEXT-STR-DOC-NBR                        02340099
023500         MOVE SPCNBR-STR-NEXT-DOC-NBR                             02350099
023600                                  TO PA-FIRST-DOC-NBR-COMMITTED   02360099
023700         PERFORM 3000-SETUP-HEADER                                02370099
023800         PERFORM 2100-MOVE-CUR-TO-PREV                            02380099
023900         PERFORM 3200-SETUP-DETAIL                                02390099
024000     ELSE                                                         02400099
024100         DISPLAY '****************************************'       02410099
024200         DISPLAY 'RVKUT032 - NO RECORDS ON MOS EXTRACT FILE'      02420099
024300         DISPLAY '****************************************'       02430099
024400         DISPLAY '   '                                            02440099
024500     END-IF.                                                      02450099
024600                                                                  02460099
024700***************************************************************** 02470099
024800* PROCESS EACH INPUT RECORD, WRITING A HEADER RECORD AND 1 TO   * 02480099
024900* MANY DETAIL RECORDS.                                          * 02490099
025000***************************************************************** 02500099
025100 2000-PROCESS.                                                    02510099
025200     IF RV053-DFCT-ORD-ID NOT = PV-PREV-DFCT-ORD-ID  OR           02520099
025300        RV053-MKOUT-ORD-ID NOT = PV-PREV-MKOUT-ORD-ID             02530099
025400         MOVE PV-ACTL-PR-CHG-AMT-TOT  TO RV054-TOT-ACT-PR-CHG-AMT 02540099
025500         MOVE PV-ACTL-PR-CHG-QTY      TO RV055-ACTL-PR-CHG-QTY    02550099
025600         MOVE PV-PREV-RTL-COST-AMT    TO RV055-ACTL-PR-CHG-AMT    02560099
025700         PERFORM 6100-WRITE-HEADER-FILE                           02570099
025800         ADD  +1                      TO PV-DOCUMENT-COUNT        02580099
025900         PERFORM 3200-SETUP-DETAIL                                02590099
026000         PERFORM 6200-WRITE-DETAIL-FILE                           02600099
026100         MOVE +0                      TO PV-ACTL-PR-CHG-AMT-TOT   02610099
026200         MOVE +0                      TO PV-ACTL-PR-CHG-QTY       02620099
026300         MOVE +0                      TO PV-DOCUMENT-COUNT        02630099
026400         PERFORM 5000-GET-NEXT-STR-DOC-NBR                        02640099
026500         PERFORM 3000-SETUP-HEADER                                02650099
026600         PERFORM 2100-MOVE-CUR-TO-PREV                            02660099
026700         PERFORM 3200-SETUP-DETAIL                                02670099
026800     ELSE                                                         02680099
026900         IF RV053-SKU-NBR NOT = PV-PREV-SKU-NBR                   02690099
027000             ADD  +1                   TO PV-DOCUMENT-COUNT       02700099
027100             MOVE PV-PREV-RTL-COST-AMT TO RV055-OLD-PR            02710099
027200             MOVE PV-ACTL-PR-CHG-QTY TO RV055-ACTL-PR-CHG-QTY     02720099
027300             MOVE PV-DOCUMENT-COUNT  TO RV055-ROW-NBR             02730099
027400             COMPUTE RV055-ACTL-PR-CHG-AMT =                      02740099
027500                   PV-ACTL-PR-CHG-QTY * PV-PREV-RTL-COST-AMT      02750099
027600             PERFORM 6200-WRITE-DETAIL-FILE                       02760099
027700             MOVE +0           TO PV-ACTL-PR-CHG-QTY              02770099
027800             PERFORM 2100-MOVE-CUR-TO-PREV                        02780099
027900             PERFORM 3200-SETUP-DETAIL                            02790099
028000         ELSE                                                     02800099
028100             IF RV053-RTL-COST-AMT NOT = PV-PREV-RTL-COST-AMT     02810099
028200                 ADD +1           TO PV-DOCUMENT-COUNT            02820099
028300                 MOVE PV-ACTL-PR-CHG-QTY                          02830099
028400                                   TO RV055-ACTL-PR-CHG-QTY       02840099
028500                 MOVE PV-DOCUMENT-COUNT  TO RV055-ROW-NBR         02850099
028600                 MOVE PV-PREV-RTL-COST-AMT                        02860099
028700                                   TO RV055-OLD-PR                02870099
028800                 COMPUTE RV055-ACTL-PR-CHG-AMT =                  02880099
028900                   PV-ACTL-PR-CHG-QTY * PV-PREV-RTL-COST-AMT      02890099
029000                 PERFORM 6200-WRITE-DETAIL-FILE                   02900099
029100                 PERFORM 3200-SETUP-DETAIL                        02910099
029200                 MOVE +0           TO PV-ACTL-PR-CHG-QTY          02920099
029300                 PERFORM 2100-MOVE-CUR-TO-PREV                    02930099
029400             END-IF                                               02940099
029500         END-IF                                                   02950099
029600     END-IF.                                                      02960099
029700                                                                  02970099
029800     ADD +1 TO PV-ACTL-PR-CHG-QTY.                                02980099
029900     ADD RV053-RTL-COST-AMT TO PV-ACTL-PR-CHG-AMT-TOT.            02990099
030000     PERFORM 2100-MOVE-CUR-TO-PREV.                               03000099
030100                                                                  03010099
030200     PERFORM 6000-READ-MOS-EXTRACT-FILE.                          03020099
030300                                                                  03030099
030400******************************************************************03040099
030500* MOVE CURRENT KEY FIELDS TO PREV                                 03050099
030600******************************************************************03060099
030700 2100-MOVE-CUR-TO-PREV.                                           03070099
030800     MOVE RV053-DFCT-ORD-ID        TO PV-PREV-DFCT-ORD-ID.        03080099
030900     MOVE RV053-MDSE-DEPT-NBR      TO PV-PREV-DEPT.               03090099
031000     MOVE RV053-MKOUT-ORD-ID       TO PV-PREV-MKOUT-ORD-ID.       03100099
031100     MOVE RV053-MDSE-CLASS-NBR     TO PV-PREV-SUB-CLASS.          03110099
031200     MOVE RV053-SKU-NBR            TO PV-PREV-SKU-NBR.            03120099
031300     MOVE RV053-DFCT-ITEM-NBR      TO PV-PREV-DFCT-ITEM-NBR.      03130099
031400     MOVE RV053-UPC-NBR            TO PV-PREV-UPC-NBR.            03140099
031500     MOVE RV053-RTL-COST-AMT       TO PV-PREV-RTL-COST-AMT.       03150099
031600     MOVE RV053-OPER-UNT-ID        TO PV-PREV-OPER-UNT-ID.        03160099
031700                                                                  03170099
031800******************************************************************03180099
031900* SET UP THE HEADER REC FOR TSTRPPC                               03190099
032000******************************************************************03200099
032100 3000-SETUP-HEADER.                                               03210099
032200     INITIALIZE RV054-HEADER-RECORD.                              03220099
032300                                                                  03230099
032400     PERFORM 3400-CHECK-EXISTING-FOR-MOS-ID                       03240099
032500                                                                  03250099
032600     IF PS-MOS-ID-EXISTS-NO                                       03260099
032700         PERFORM 3100-SETUP-HEADER-CONTENT                        03270099
032800     END-IF.                                                      03280099
032900                                                                  03290099
033000******************************************************************03300099
033100* SET UP HEADER RECORD                                            03310099
033200*    CREATE DATE, ENTER DATE AND ENTER TIME WILL BE FILLED BY     03320099
033300*      CURRENT DATE AND TIME AT THE TIME OF THE INSERT.           03330099
033400******************************************************************03340099
033500 3100-SETUP-HEADER-CONTENT.                                       03350099
033600     MOVE +0                       TO RV054-ROW-NBR.              03360099
033700     SET RV054-HEADER              TO TRUE.                       03370099
033800*    MOVE PC-RTV-LOC               TO RV054-DEST-LOC-NBR.         03380099
033900     MOVE RV053-OPER-UNT-ID        TO RV054-DEST-LOC-NBR.         03390099
034000     MOVE SPCNBR-STR-NEXT-DOC-NBR  TO RV054-DOC-NBR.              03400099
034100     MOVE PE049-STORE-DOC-TYPE-CDE TO RV054-DOC-TYP-CDE.          03410099
034200     MOVE RV053-STATUS-CHG-DTE     TO RV054-EFF-DTE.              03420099
034300     MOVE PC-UID-NBR               TO RV054-PR-CHG-CPL-NAME.      03430099
034400     SET  PE049-IS-RTN-TO-VNDR-RSN TO TRUE.                       03440099
034500     MOVE PE049-WORKING-INSTR-RSN-CDE TO RV054-RSN-CDE.           03450099
034600     MOVE PE049-MARKDOWN-TYPE-CDE  TO RV054-TYP-CDE.              03460099
034700     SET  PE049-IS-CNTS-ENTER-STAT-CDE TO TRUE.                   03470099
034800     MOVE PE049-WORKING-INSTR-STATUS-CDE TO RV054-STATUS-CDE.     03480099
034900     MOVE RV053-MDSE-DEPT-NBR   TO PV-DEPT-PIC9.                  03490099
034910     INITIALIZE PV-TEMP-DEPT-LIST-AUTH                            03491099
034920                PV-START                                          03492099
034931                PV-LENGTH                                         03493199
034940                PV-LNG                                            03494099
034941                PV-COUNTER.                                       03494199
034950                                                                  03495099
035000     MOVE PV-DEPT-PIC9          TO PV-TEMP-DEPT-LIST-AUTH (1:3).  03500099
035100     MOVE PC-SLASH              TO PV-TEMP-DEPT-LIST-AUTH (4:1).  03510099
035115     MOVE RV053-DFCT-ORD-ID  TO PV-DFCT-ORD-ID                    03511599
035116     DISPLAY 'PV-DFCT-ORD-ID ' PV-DFCT-ORD-ID                     03511699
035117     DISPLAY 'PV-DFCT-ORD-ID-R' PV-DFCT-ORD-ID-R                  03511799
035118         INSPECT PV-DFCT-ORD-ID-R TALLYING PV-START               03511899
035119                        FOR LEADING ZEROES                        03511999
035121     DISPLAY 'PV-START ' PV-START                                 03512199
035124     COMPUTE PV-LNG = PV-LNG  + PV-START                          03512499
035125     COMPUTE PV-LENGTH = 12 - PV-START                            03512599
035126     ADD +1 TO  PV-START                                          03512699
035127     DISPLAY 'PV-LENGTH ' PV-LENGTH                               03512799
035128     MOVE PV-DFCT-ORD-ID-R(PV-START:PV-LENGTH)                    03512899
035130                   TO PV-TEMP-DEPT-LIST-AUTH (5:PV-LENGTH)        03513099
035140                                                                  03514099
035141     COMPUTE PV-LNG     = PV-LNG      + PV-LENGTH                 03514199
035300     MOVE PC-SLASH   TO PV-TEMP-DEPT-LIST-AUTH (PV-LNG:1).        03530099
035310     COMPUTE PV-LNG     = PV-LNG + 1                              03531099
035400     MOVE RV053-MKOUT-ORD-ID TO PV-TEMP-DEPT-LIST-AUTH (PV-LNG:11)03540099
035600     MOVE PV-TEMP-DEPT-LIST-AUTH   TO RV054-DEPT-AREA-DEST.       03560099
035700     MOVE RV053-OPER-UNT-ID        TO RV054-ORGN-LOC-NBR.         03570099
035800     MOVE PC-CURRENT-PROGRAM-NAME  TO RV054-CRE-ID.               03580099
035900     MOVE PE049-DEFAULT-DATE       TO RV054-CAN-DTE.              03590099
036000     MOVE PC-SPACE                 TO RV054-CAN-ID.               03600099
036100     MOVE PC-CURRENT-PROGRAM-NAME  TO RV054-ENTR-ID.              03610099
036200     MOVE PE049-DEFAULT-DATE       TO RV054-MGMT-APPRVL-DTE.      03620099
036300     MOVE PC-SPACE                 TO RV054-MGMT-APPRVL-ID.       03630099
036400     MOVE PC-SPACE                 TO RV054-MGMT-APPRVL-NAME.     03640099
036500     MOVE PE049-DEFAULT-DATE       TO RV054-REJ-DTE.              03650099
036600     MOVE PC-SPACE                 TO RV054-REJ-ID.               03660099
036700     MOVE PE049-DEFAULT-DATE       TO RV054-CPL-DTE.              03670099
036800     MOVE PE049-DEFAULT-TIME       TO RV054-CPL-TIME.             03680099
036900     MOVE PC-PGS-TO-PRINT          TO RV054-PGS-TO-PRT-NBR.       03690099
037000                                                                  03700099
037100******************************************************************03710099
037200* SETUP THE DTL REC                                               03720099
037300******************************************************************03730099
037400 3200-SETUP-DETAIL.                                               03740099
037500     INITIALIZE RV055-DETAIL-RECORD.                              03750099
037600                                                                  03760099
037700     IF PS-MOS-ID-EXISTS-NO                                       03770099
037800         PERFORM 3300-SETUP-DETAIL-CONTENT                        03780099
037900     END-IF.                                                      03790099
038000                                                                  03800099
038100******************************************************************03810099
038200* SET UP THE DETAIL RECORD FOR TSPPCDT                            03820099
038300******************************************************************03830099
038400 3300-SETUP-DETAIL-CONTENT.                                       03840099
038500     SET RV055-DETAIL                TO TRUE.                     03850099
038600*    MOVE PC-RTV-LOC                 TO RV055-DEST-LOC-NBR.       03860099
038700     MOVE PV-PREV-OPER-UNT-ID        TO RV055-DEST-LOC-NBR.       03870099
038800     MOVE RV054-DOC-NBR              TO RV055-DOC-NBR.            03880099
038900     IF PV-PREV-SKU-NBR > 0                                       03890099
039000         MOVE PV-PREV-SKU-NBR        TO RV055-SKU-NBR             03900099
039100     ELSE                                                         03910099
039200********** DUMMY SKU                                              03920099
039300         MOVE PV-PREV-DEPT           TO PV-DUMMY-SKU-DEPT         03930099
039400         MOVE PV-PREV-SUB-CLASS      TO PV-DUMMY-SKU-CLASS        03940099
039500         MOVE PV-DUMMY-SKU-9         TO RV055-SKU-NBR             03950099
039600     END-IF.                                                      03960099
039700     MOVE PV-DOCUMENT-COUNT          TO RV055-ROW-NBR.            03970099
039800     MOVE PV-ACTL-PR-CHG-QTY         TO RV055-ACTL-PR-CHG-QTY.    03980099
039900     MOVE PV-PREV-RTL-COST-AMT       TO RV055-OLD-PR.             03990099
040000     MOVE 0                          TO RV055-NEW-PR.             04000099
040100     COMPUTE RV055-ACTL-PR-CHG-AMT =                              04010099
040200               PV-ACTL-PR-CHG-QTY * PV-PREV-RTL-COST-AMT.         04020099
040300     MOVE PV-PREV-UPC-NBR            TO RV055-UPC-NBR.            04030099
040400     MOVE PV-PREV-DFCT-ITEM-NBR      TO RV055-ITEM-NBR.           04040099
040500     MOVE 0                          TO RV055-INV-DKEY.           04050099
040600     MOVE PV-PREV-DEPT               TO RV055-DEPT-NBR.           04060099
040700     MOVE PV-PREV-SUB-CLASS          TO PV-SUB-CLASS-PIC9         04070099
040800                                        RV055-SUB-CL-NBR.         04080099
040900     MOVE PV-SUB-CLASS-PIC9 (1:1)    TO PV-MAJ-CLASS-P1.          04090099
041000     MOVE PV-MAJ-CLASS-PIC9-WORK     TO PV-MAJ-CLASS-PIC9         04100099
041100     MOVE PV-MAJ-CLASS-PIC9          TO RV055-MAJ-CL-NBR.         04110099
041200     MOVE SPACES                     TO RV055-FILLER.             04120099
041300                                                                  04130099
041400******************************************************************04140099
041500* CHECK TSTRPPC TO SEE IF THE MKOUT-ORD-ID ALREADY EXISTS IN THE *04150099
041600* TBL BY SEARCHING FOR A MATCH ON DEST-LOC-NBR & DEPT_AREA_DEST  *04160099
041700* FROM THE CURRENT CSR RECORD                                    *04170099
041800******************************************************************04180099
041900 3400-CHECK-EXISTING-FOR-MOS-ID.                                  04190099
042000     INITIALIZE PS-MOS-ID-EXISTS-SW.                              04200099
042100                                                                  04210099
042200     EXEC SQL                                                     04220099
042300         SELECT DOC_NBR                                           04230099
042400           INTO :STRPPC-DOC-NBR                                   04240099
042500           FROM TSTRPPC                                           04250099
042600          WHERE DEST_LOC_NBR = :STRPPC-DEST-LOC-NBR               04260099
042700            AND   DEPT_AREA_DEST = :STRPPC-DEPT-AREA-DEST         04270099
042800     END-EXEC.                                                    04280099
042900                                                                  04290099
043000     EVALUATE TRUE                                                04300099
043100         WHEN SQLCODE = +0                                        04310099
043200         WHEN SQLCODE = -811                                      04320099
043300             SET PS-MOS-ID-EXISTS-YES TO TRUE                     04330099
043400         WHEN SQLCODE = +100                                      04340099
043500             SET PS-MOS-ID-EXISTS-NO TO TRUE                      04350099
043600         WHEN SQLWARN0 NOT EQUAL SPACE                            04360099
043700         WHEN SQLCODE NOT EQUAL ZERO                              04370099
043800           DISPLAY '******************************************'   04380099
043900           DISPLAY '** ABEND                                **'   04390099
044000           DISPLAY '** PROGRAM = RVKUT032                   **'   04400099
044100           DISPLAY '** PARAGRAPH = 3400-CHECK-EXISTING-FOR-MOS-ID'04410099
044200           DISPLAY '** CHECKING IF MOS ID IS THERE ALREADY  **'   04420099
044300           DISPLAY '******************************************'   04430099
044400           PERFORM 9100-SQL-ABEND                                 04440099
044500     END-EVALUATE.                                                04450099
044600                                                                  04460099
044700******************************************************************04470099
044800*  SELECT THE CURRENT INSTORE DOCUMENT NUMBER FOR USE ON THE NEXT*04480099
044900*  INSERT TO THE INSTORE HEADER TABLE.  ADD +1 TO THE CURRENT    *04490099
045000*  DOCUMENT NUMBER AND UPDATE THE STR_NEXT_DOC_NBR FIELD ON THE  *04500099
045100*  TABLE (THIS CODE WAS MODELED FROM PGM INKUP125, PARA 3000-    *04510099
045200******************************************************************04520099
045300 5000-GET-NEXT-STR-DOC-NBR.                                       04530099
045400     EXEC SQL                                                     04540099
045500         LOCK TABLE TSPCNBR IN                                    04550099
045600         EXCLUSIVE MODE                                           04560099
045700     END-EXEC.                                                    04570099
045800                                                                  04580099
045900     IF SQLCODE = 0                                               04590099
046000         EXEC SQL                                                 04600099
046100             SELECT STR_NEXT_DOC_NBR                              04610099
046200             INTO   :SPCNBR-STR-NEXT-DOC-NBR                      04620099
046300             FROM   TSPCNBR                                       04630099
046400         END-EXEC                                                 04640099
046500                                                                  04650099
046600         IF SQLCODE = 0                                           04660099
046700             IF SPCNBR-STR-NEXT-DOC-NBR = +7999999                04670099
046800                 MOVE +1000000   TO SPCNBR-STR-NEXT-DOC-NBR       04680099
046900             ELSE                                                 04690099
047000                 ADD +1          TO SPCNBR-STR-NEXT-DOC-NBR       04700099
047100             END-IF                                               04710099
047200                                                                  04720099
047300             EXEC SQL                                             04730099
047400                 UPDATE TSPCNBR                                   04740099
047500                    SET STR_NEXT_DOC_NBR                          04750099
047600                                    = :SPCNBR-STR-NEXT-DOC-NBR    04760099
047700             END-EXEC                                             04770099
047800                                                                  04780099
047900             IF SQLCODE = ZERO                                    04790099
048000                PERFORM 5100-COMMIT                               04800099
048100             ELSE                                                 04810099
048200                DISPLAY '***************************************' 04820099
048300                DISPLAY '** ABEND                             **' 04830099
048400                DISPLAY '** PROGRAM = RVKUT032                **' 04840099
048500                DISPLAY '** PARAGRAPH = 5000-GET-NEXT-STR-DOC-NBR'04850099
048600                DISPLAY '** UNSUCCESSFUL UPDATE ON TSPCNBR    **' 04860099
048700                DISPLAY '***************************************' 04870099
048800                PERFORM 9100-SQL-ABEND                            04880099
048900             END-IF                                               04890099
049000         ELSE                                                     04900099
049100             DISPLAY '***************************************'    04910099
049200             DISPLAY '** ABEND                             **'    04920099
049300             DISPLAY '** PROGRAM = RVKUT032                **'    04930099
049400             DISPLAY '** PARAGRAPH = 5000-GET-NEXT-STR-DOC-NBR'   04940099
049500             DISPLAY '** UNSUCCESSFUL SELECT OF TSPCNBR    **'    04950099
049600             DISPLAY '***************************************'    04960099
049700             PERFORM 9100-SQL-ABEND                               04970099
049800         END-IF                                                   04980099
049900     ELSE                                                         04990099
050000         DISPLAY '***************************************'        05000099
050100         DISPLAY '** ABEND                             **'        05010099
050200         DISPLAY '** PROGRAM = RVKUT032                **'        05020099
050300         DISPLAY '** PARAGRAPH = 5000-GET-NEXT-STR-DOC-NBR'       05030099
050400         DISPLAY '** UNSUCCESSFUL LOCK OF TSPCNBR      **'        05040099
050500         DISPLAY '***************************************'        05050099
050600         PERFORM 9100-SQL-ABEND                                   05060099
050700     END-IF.                                                      05070099
050800                                                                  05080099
050900******************************************************************05090099
051000*  COMMIT THE STR-NEXT-DOC-NBR ON TSPCNBR                         05100099
051100******************************************************************05110099
051200 5100-COMMIT.                                                     05120099
051300     EXEC SQL                                                     05130099
051400         COMMIT                                                   05140099
051500     END-EXEC.                                                    05150099
051600                                                                  05160099
051700     EVALUATE TRUE                                                05170099
051800         WHEN SQLCODE EQUAL ZERO                                  05180099
051900             ADD +1 TO PA-TOT-COMMITS-TAKEN                       05190099
052000             MOVE SPCNBR-STR-NEXT-DOC-NBR TO                      05200099
052100                                        PA-LAST-DOC-NBR-COMMITTED 05210099
052200         WHEN SQLWARN0 NOT EQUAL SPACE                            05220099
052300         WHEN SQLCODE NOT EQUAL ZERO                              05230099
052400             DISPLAY '****************************'               05240099
052500             DISPLAY '** ABEND                  **'               05250099
052600             DISPLAY '** PROGRAM = RVKUT032     **'               05260099
052700             DISPLAY '** PARAGRAPH = 5100-COMMIT**'               05270099
052800             DISPLAY '** UNSUCCESSFUL COMMIT    **'               05280099
052900             DISPLAY '****************************'               05290099
053000             PERFORM 9100-SQL-ABEND                               05300099
053100     END-EVALUATE.                                                05310099
053200                                                                  05320099
053300******************************************************************05330099
053400* READ THE MOS EXTRACT FILE                                      *05340099
053500******************************************************************05350099
053600 6000-READ-MOS-EXTRACT-FILE.                                      05360099
053700     READ RV-MOS-EXTRACT-FILE                                     05370099
053800         INTO RV053-MOS-EXTRACT-RECORD                            05380099
053900         AT END                                                   05390099
054000             SET PS-EOF-YES TO TRUE                               05400099
054100         NOT AT END                                               05410099
054200             ADD +1  TO PV-RECS-READ                              05420099
054300     END-READ.                                                    05430099
054400                                                                  05440099
054500******************************************************************05450099
054600* WRITE THE HEADER RECORD                                         05460099
054700******************************************************************05470099
054800 6100-WRITE-HEADER-FILE.                                          05480099
054900     INITIALIZE RV-HEADER-RECORD.                                 05490099
055000                                                                  05500099
055100     WRITE RV-HEADER-RECORD                                       05510099
055200         FROM RV054-HEADER-RECORD.                                05520099
055300                                                                  05530099
055400     ADD +1 TO PV-HDR-RECS-WRITTEN.                               05540099
055500                                                                  05550099
055600******************************************************************05560099
055700* WRITE THE DETAIL RECORD                                         05570099
055800******************************************************************05580099
055900 6200-WRITE-DETAIL-FILE.                                          05590099
056000     INITIALIZE RV-DETAIL-RECORD.                                 05600099
056100                                                                  05610099
056200     WRITE RV-DETAIL-RECORD                                       05620099
056300         FROM RV055-DETAIL-RECORD.                                05630099
056400                                                                  05640099
056500     ADD +1 TO PV-DTL-RECS-WRITTEN.                               05650099
056600                                                                  05660099
056700******************************************************************05670099
056800* WRITE OUT THE LAST HEADER AND DETAIL RECORDS                    05680099
056900* CLOSE FILES                                                     05690099
057000* DISPLAY RECORD COUNTS                                           05700099
057100******************************************************************05710099
057200 9000-EOJ.                                                        05720099
057300     IF PS-NOT-FIRST-TIME                                         05730099
057400         MOVE PV-ACTL-PR-CHG-AMT-TOT TO RV054-TOT-ACT-PR-CHG-AMT  05740099
057500         MOVE PV-ACTL-PR-CHG-QTY     TO RV055-ACTL-PR-CHG-QTY     05750099
057600         MOVE PV-PREV-RTL-COST-AMT   TO RV055-ACTL-PR-CHG-AMT     05760099
057700         PERFORM 6100-WRITE-HEADER-FILE                           05770099
057800         ADD +1                      TO PV-DOCUMENT-COUNT         05780099
057900         PERFORM 3200-SETUP-DETAIL                                05790099
058000         PERFORM 6200-WRITE-DETAIL-FILE                           05800099
058100     END-IF.                                                      05810099
058200                                                                  05820099
058300     CLOSE RV-MOS-EXTRACT-FILE                                    05830099
058400           RV-HEADER-FILE                                         05840099
058500           RV-DETAIL-FILE.                                        05850099
058600                                                                  05860099
058700     DISPLAY '***********************************************'.   05870099
058800     DISPLAY '**    * RVKUT032 SUMMARY STATISTICS *        **'.   05880099
058900     DISPLAY '**                                           **'.   05890099
059000     MOVE PV-RECS-READ               TO PV-DISPLAY-NO-COMMA       05900099
059100     DISPLAY '** TOT RECS READ       :' PV-DISPLAY-NO-COMMA       05910099
059200     MOVE PV-HDR-RECS-WRITTEN        TO PV-DISPLAY-NO-COMMA       05920099
059300     DISPLAY '** HEADER RECS WRITTEN :' PV-DISPLAY-NO-COMMA       05930099
059400     MOVE PV-DTL-RECS-WRITTEN        TO PV-DISPLAY-NO-COMMA       05940099
059500     DISPLAY '** DETAIL RECS WRITTEN :' PV-DISPLAY-NO-COMMA.      05950099
059600     MOVE  PA-FIRST-DOC-NBR-COMMITTED TO PV-DISPLAY-NO-COMMA.     05960099
059700     DISPLAY '** FIRST DOC NBR CREATED:' PV-DISPLAY-NO-COMMA.     05970099
059800     MOVE  PA-LAST-DOC-NBR-COMMITTED TO PV-DISPLAY-NO-COMMA.      05980099
059900     DISPLAY '** LAST DOC NBR CREATED:' PV-DISPLAY-NO-COMMA.      05990099
060000     DISPLAY '***********************************************'.   06000099
060100                                                                  06010099
060200******************************************************************06020099
060300* PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    *06030099
060400* ERROR OR WARNING CODE OCCURS.                                  *06040099
060500******************************************************************06050099
060600 9100-SQL-ABEND.                                                  06060099
060700******************************************************************06070099
060800* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *06080099
060900* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *06090099
061000* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *06100099
061100* FORMAT.                                                        *06110099
061200******************************************************************06120099
061300     COPY DPPD004.                                                06130099
061400                                                                  06140099
061500     DISPLAY '***********************************************'.   06150099
061600     DISPLAY '** ABEND PARAGRAPH **  ' PV-PARAGRAPH-NAME.         06160099
061700     DISPLAY '** ERROR MESSAGE   **  ' PV-ABEND-MESSAGE.          06170099
061800     MOVE PV-SQLCODE                TO PV-DISPLAY-RECORD          06180099
061900     DISPLAY '** SQLCODE         **  ' PV-DISPLAY-RECORD.         06190099
062000     DISPLAY '** VIEW  NAME      **  ' PV-DB2-VIEW-NAME.          06200099
062100     DISPLAY '***********************************************'.   06210099
062200     DISPLAY ' '.                                                 06220099
062300     MOVE +4013 TO ABEND-CODE.                                    06230099
062400     CALL 'ILBOABN0' USING ABEND-CODE.                            06240099
062500                                                                  06250099
062600******************************************************************06260099
062700*                       END OF PROGRAM RVKUT032                   06270099
062800******************************************************************06280099
