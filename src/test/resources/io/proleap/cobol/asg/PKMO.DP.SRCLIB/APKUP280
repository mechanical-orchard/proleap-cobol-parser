000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.     APKUP280.                                        00020000
000300 AUTHOR.         M WILKINSON.                                     00030000
000400*DATE-WRITTEN.   DEC   9, 1994.                                   00040000
000500*DATE-COMPILED.                                                   00050000
000600*************************************************************     00060000
000700*    COBOL 2 WITH SQL                                       *     00070000
000800*                                                           *     00080000
000900*    UPDATE THE STATUS ON TINVOIC FOR THE INPUT PAYMENT     *     00090000
001000*    REQUEST SEQUENCE NUMBERS AS INDICATED ON THE CONTROL   *     00100000
001100*    CARD.                                                  *     00110000
001200*                                                           *     00120000
001300*    TINVOIC - INVOICE TABLE                                *     00130000
001400* INPUT:                                                    *     00140000
001500* 1.  DSN OF PAYT REQ SEQ NBRS TO BE MARKED                 *     00150000
001600*     - GENERATED FROM PGM APKIVEXT -                       *     00160000
001700* OUTPUT:                                                   *     00170000
001800* 1.  UPDATE DB2 TINVOIC TABLE                              *     00180000
001900*************************************************************     00190000
002000* CHANGE LOG:                                               *     00200000
002100*                                                           *     00210000
002200* 03/13/95    ADDED PARM TO PROCESS AS EITHER 'DE' OR 'EN'  *     00220000
002300* MW                                                        *     00230000
002400*                                                           *     00240000
002500* 05/10/95    ADDED LOGIC TO UPDATE TINVOIC STATUS TO 'RL', *     00250000
002600* MKK         'OP', AND 'PD'.  THIS ADDITIONAL LOGIC ASSUMES*     00260000
002700*             THE STATUS HAD PREVIOUSLY BEEN SET TO 'DE'    *     00270000
002800*             AND UPDATES TAUDINC ACCORDINGLY.              *     00280000
002900*                                                           *     00290000
003000* 06/15/98    CHANGED THE INPUT FILE LAYOUT TO APRD067 TO   *     00300000
003100*             COINCIDE WITH THE OUTPUT FILE LAYOUT FROM     *     00310000
003200*             APKIVEXT.                                     *     00320000
003300*             MARK BURNSIDE                                 *     00330000
003400* 04/27/00    ADDED 'BM' AS A VALID STATUS.                 *     00340000
003500*             NANCY EILBES                                  *     00350000
003600*                                                           *     00360006
003700* 02/27/01    ADDED PARAGRAPH S100-SELECT-CURRENT-TMST AND  *     00370000
003800*             MODIFIED THE LOGIC IN B200 TO DETERMINE       *     00380000
003900*             WHETHER TO USE CURRENT TIMESTAMP OR THE       *     00390000
004000*             TIMESTAMP FROM THE INPUT RECORD WHEN UPDATING *     00400000
004100*             STATUS TO 'DE'.  CHANGED THE UPDATE STATEMENT *     00410000
004200*             IN U100 TO USE A HOST VARIABLE ON THE UPDATE  *     00420000
004300*             OF STATUS-CHG-TMST INSTEAD OF HARD-CODING     *     00430000
004400*             CURRENT TIMESTAMP.  ADDED COMMENT BOXES AND   *     00440000
004500*             PERFORMED SOME CLEANUP ON THE PROGRAM LAYOUT. *     00450000
004600* MADE BY:    NANCY EILBES                                  *     00460000
004700*                                                           *     00470000
004800* 03/04/01    ADDED A LOCK TABLE TO TINVOIC TO PREVENT      *     00480000
004900*             UNAVAILABLE RESOURCE DUE TO EXCESSIVE TABLE   *     00490000
005000*             LOCKS.                                        *     00500000
005100* MADE BY:    NANCY EILBES                                  *     00510000
005200*                                                           *     00520000
005300* 06/17/2002                                                *     00530000
005400*    ARK PO PROJECT PHASE 1.  RECOMPILE FROM PRODUCTION.    *     00540000
005500* MADE BY: KEVIN CATLIN                WR#: 23500           *     00550000
005600*                                                           *     00560000
005700* 06/20/2002                                                *     00570000
005800*    REPLACE PAYT_REQ_SEQ_NBR WITH NEW KEYS OF PO_NBR AND   *     00580000
005900*    INVC_ID FOR UPDATES TO TINVOIC TABLE.                  *     00590000
006000* MADE BY: KEVIN CATLIN                WR#: 23500           *     00600000
006100*                                                           *     00610000
006200* 09/09/2002  ARK PO PROJECT PHASE 2.  CHANGED REFERENCES   *     00620008
006300*             OF PAYMENT REQUEST NUMBER TO INVOICE ID AND   *     00630001
006400*             PO NUMBER BECAUSE THE PAYMENT REQUEST NUMBER  *     00640001
006500*             WILL NO LONGER BE USED. EFFECTED PARAGRAPHS   *     00650001
006600*             ARE U100, U200, U300, AND 900.                *     00660001
006700*             ALSO, ANY REFERENCES TO THE APWS900 COPY BOOK *     00670005
006800*             WAS REMOVED BECAUSE IT IS NO LONGER SUPPORTED.*     00680005
006900* MADE BY: BRIAN HASSLINGER            WR#: 23500           *     00690001
006910*                                                           *     00691009
006920* 03/11/2007  REMOVED ALL REFERENCES TO TAUDINC             *     00692013
006930* MADE BY: MICHELE RINDFLEISCH         WR#: 21578           *     00693009
006931*                                                           *     00693114
006932* DATE  11/14/2014                                          *     00693216
006933*      RECOMPILED THE PROGRAM. CHANGES WERE MADE TO APRD067 *     00693317
006934*      COPYBOOK.                                            *     00693417
006935*      MADE BY: COGNIZANT              WR/IR: CHG0094517    *     00693517
006932* DATE  09/21/2015                                          *     00693618
006933*      RECOMPILED THE PROGRAM. CHANGES MADE IN PROGRAM      *     00693718
006934*      TO HANDLE "PJ" CONDITION.                            *     00693818
006935*      MADE BY: COGNIZANT              WR/IR: CHG0122962    *     00693918
007000*************************************************************     00700000
007100                                                                  00710000
007200 ENVIRONMENT DIVISION.                                            00720000
007300                                                                  00730000
007400 INPUT-OUTPUT SECTION.                                            00740000
007500                                                                  00750000
007600 FILE-CONTROL.                                                    00760000
007700                                                                  00770000
007800     SELECT TINVOIC-FILE                                          00780000
007900         ASSIGN         TO UT-S-INP01.                            00790000
008000                                                                  00800000
008100 DATA DIVISION.                                                   00810000
008200                                                                  00820000
008300 FILE SECTION.                                                    00830000
008400                                                                  00840000
008500 FD  TINVOIC-FILE                                                 00850000
008600         LABEL RECORDS  ARE STANDARD                              00860000
008700         RECORDING MODE IS  F                                     00870000
008800         DATA RECORD    IS  TINVOIC-RECORD.                       00880000
008900                                                                  00890000
009000 01  TINVOIC-RECORD                PIC X(80).                     00900000
009100                                                                  00910000
009200/                                                                 00920000
009300 WORKING-STORAGE SECTION.                                         00930000
009400                                                                  00940000
009500 01  FILLER                        PIC X(25) VALUE                00950000
009600                             'WS FOR APKUP280 BEGINS==>'.         00960000
009700 01  ABEND-CODE                    PIC S9(4) COMP SYNC            00970000
009800                                             VALUE ZEROS.         00980000
009900     88 AP-PARM-ERROR              VALUE +4003.                   00990000
010000     88 AP-TABLE-FULL              VALUE +4004.                   01000000
010100     88 AP-EMPTY-FILE              VALUE +4005.                   01010000
010200     88 AP-DB2-ERROR               VALUE +4013.                   01020000
010300                                                                  01030000
010400 01  WS-RETRY-COUNTER              PIC S9(4) COMP VALUE ZERO.     01040000
010500 01  WS-RETRY-MAX                  PIC S9(4) COMP VALUE 3.        01050000
010600 01  WS-CHANGE-TO-CODE             PIC X(02) VALUE SPACE.         01060000
010700     88  WS-VALID-CHANGE-CODES               VALUE 'DE' 'EN' 'RL' 01070000
010800                                                   'BM' 'PJ'      01080017
010900                                                   'OP' 'PD'.     01090000
011000     88  WS-CHANGE-TO-BM                     VALUE 'BM'.          01100000
011100     88  WS-CHANGE-TO-DE                     VALUE 'DE'.          01110000
011200     88  WS-CHANGE-TO-EN                     VALUE 'EN'.          01120000
011300     88  WS-CHANGE-TO-RL                     VALUE 'RL'.          01130000
011400     88  WS-CHANGE-TO-OP                     VALUE 'OP'.          01140000
011500     88  WS-CHANGE-TO-PD                     VALUE 'PD'.          01150000
011600     88  WS-CHANGE-TO-PJ                     VALUE 'PJ'.          01160017
011610                                                                  01161017
011700 01  PROGRAM-TIMESTAMPS.                                          01170000
011800     05  PV-CURRENT-TMST               PIC X(26) VALUE SPACES.    01180000
011900                                                                  01190000
012000     05  PV-UPDATE-TMST                PIC X(26).                 01200000
012100                                                                  01210000
012200     05  PV-STATUS-CHG-TMST.                                      01220000
012300         10 PV-STATUS-CHG-DATE         PIC X(10).                 01230000
012400         10 PV-STATUS-CHG-TIME         PIC X(16).                 01240000
012500            88 USE-INPUT-TMST          VALUE '-00.00.00.000000'.  01250000
012600                                                                  01260000
012700 01  WS-SWITCH-AREA.                                              01270000
012800     05  WS-INPUT-END-SW           PIC X(03)  VALUE 'NO '.        01280000
012900         88  WS-END-OF-INPUT                  VALUE 'YES'.        01290000
013000         88  WS-NOT-END-OF-INPUT              VALUE 'NO '.        01300000
013100                                                                  01310000
013200 01  WS-ABEND-FIELDS.                                             01320000
013300     05  WS-ABEND-PROGRAM             PIC X(8)  VALUE 'APKUP280'. 01330000
013400     05  WS-ABEND-PARAGRAPH           PIC X(50) VALUE SPACES.     01340000
013500     05  WS-ABEND-OPERATION           PIC X(50) VALUE SPACES.     01350000
013600     05  WS-ABEND-STRUCTURE-1         PIC X(8)  VALUE SPACES.     01360000
013700     05  WS-ABEND-STRUCTURE-2         PIC X(8)  VALUE SPACES.     01370000
013800     05  WS-ABEND-STATUS              PIC XX    VALUE SPACES.     01380000
013900                                                                  01390000
015300 01  WS-PROGRAM-COUNTERS.                                         01530000
015400     05  WS-INPUT-COUNT          PIC 9(9)  VALUE ZEROS.           01540000
015500     05  WS-UPDATE-COUNT         PIC 9(9)  VALUE ZEROS.           01550000
015900                                                                  01590000
016000     COPY DPWS004.                                                01600000
016100                                                                  01610000
016200     COPY APRD067.                                                01620000
016300                                                                  01630000
016400 01  FILLER                      PIC X(35)  VALUE                 01640000
016500     'END OF AP WORK RECORD AREA       **'.                       01650000
016600                                                                  01660000
016700                                                                  01670000
016800******************************************************************01680000
016900*  COMMUNICATIONS AREA2 FOR DB2                                   01690000
017000******************************************************************01700000
017100     COPY SQLCA2.                                                 01710000
017200                                                                  01720000
017300                                                                  01730000
017400     EXEC SQL                                                     01740000
017500          INCLUDE SQLCA                                           01750000
017600     END-EXEC.                                                    01760000
017700                                                                  01770000
017800                                                                  01780000
017900     EXEC SQL                                                     01790000
018000          INCLUDE TINVOIC                                         01800000
018100     END-EXEC.                                                    01810000
018600                                                                  01860000
018700 01  FILLER                        PIC X(25) VALUE                01870000
018800          '<====WS FOR APKUP280 ENDS'.                            01880000
018900                                                                  01890000
019000*LINKAGE SECTION.                                                 01900000
019100                                                                  01910000
019200                                                                  01920000
019300 PROCEDURE DIVISION.                                              01930000
019400                                                                  01940000
019500 A100-MAINLINE.                                                   01950000
019600                                                                  01960000
019700     PERFORM B100-INITIAL.                                        01970000
019800                                                                  01980000
019900     PERFORM B200-PROCESSING                                      01990000
020000        UNTIL WS-END-OF-INPUT.                                    02000000
020100                                                                  02010000
020200     PERFORM B300-END-OF-JOB.                                     02020000
020300                                                                  02030000
020400     GOBACK.                                                      02040000
020500        EJECT                                                     02050000
020600***************************************************************** 02060000
020700*    PERFORM ALL OF THE DATE AND FILE OPENING ROUTINES          * 02070000
020800***************************************************************** 02080000
020900 B100-INITIAL.                                                    02090000
021000     ACCEPT WS-CHANGE-TO-CODE.                                    02100000
021100                                                                  02110000
021200     IF WS-VALID-CHANGE-CODES                                     02120000
021300        DISPLAY 'SETTING STATUS TO ' WS-CHANGE-TO-CODE            02130000
021400     ELSE                                                         02140000
021500         DISPLAY 'CHANGE TO CODE = ' WS-CHANGE-TO-CODE            02150000
021600                 '  STATUS CODE NOT VALID'                        02160000
021700         MOVE 'B100-INITIAL'         TO WS-ABEND-PARAGRAPH        02170000
021800         MOVE +4003                  TO ABEND-CODE                02180000
021900         PERFORM Z998-ERROR.                                      02190000
022000                                                                  02200000
022100     OPEN  INPUT   TINVOIC-FILE.                                  02210000
022200                                                                  02220000
022300     INITIALIZE DCLTINVOIC.                                       02230009
022500                                                                  02250000
022600     PERFORM S100-SELECT-CURRENT-TMST.                            02260000
022700                                                                  02270000
022800     PERFORM R100-READ-INVOIC.                                    02280000
022900                                                                  02290000
023000                                                                  02300000
023100     EXEC SQL                                                     02310000
023200         LOCK TABLE TINVOIC IN EXCLUSIVE MODE                     02320000
023300     END-EXEC.                                                    02330000
023400                                                                  02340000
023500                                                                  02350000
023600 B200-PROCESSING.                                                 02360000
023700*                                                                 02370000
023800***************************************************************** 02380000
023900*     PROCESS DATA TO BE UPDATED                                  02390000
024000***************************************************************** 02400000
024100*                                                                 02410000
024200     MOVE AP067-PO-NBR           TO INVOIC-PO-NBR.                02420000
024300     MOVE AP067-INVC-ID          TO INVOIC-INVC-ID.               02430000
024600                                                                  02460000
024700     EVALUATE TRUE                                                02470000
024800         WHEN WS-CHANGE-TO-DE                                     02480000
024900              MOVE AP067-STATUS-CHG-TMST TO PV-STATUS-CHG-TMST    02490000
025000              IF USE-INPUT-TMST                                   02500000
025100                 MOVE AP067-STATUS-CHG-TMST TO PV-UPDATE-TMST     02510000
025200              ELSE                                                02520000
025300                 MOVE PV-CURRENT-TMST TO PV-UPDATE-TMST           02530000
025400              END-IF                                              02540000
025500              PERFORM U100-UPDATE-TINVOIC-DE                      02550000
025600         WHEN WS-CHANGE-TO-EN                                     02560000
025700              PERFORM U200-UPDATE-TINVOIC-EN                      02570000
025800         WHEN WS-CHANGE-TO-RL                                     02580000
025900              PERFORM U300-UPDATE-TINVOIC-RL                      02590000
025910         WHEN WS-CHANGE-TO-PJ                                     02591017
025920              PERFORM U350-UPDATE-TINVOIC-PJ                      02592017
026000         WHEN OTHER                                               02600000
026100              PERFORM U400-UPDATE-TINVOIC-OTHER                   02610000
026200     END-EVALUATE.                                                02620000
026300                                                                  02630000
026400     PERFORM R100-READ-INVOIC.                                    02640000
026500                                                                  02650000
026600***************************************************************** 02660000
026700*     FINISH THE ERROR PROCESS, REPORT ON NECESSARY TOTALS,       02670000
026800*     AND CLOSE ALL FILES                                         02680000
026900***************************************************************** 02690000
027000 B300-END-OF-JOB.                                                 02700000
027100                                                                  02710000
027200     CLOSE TINVOIC-FILE.                                          02720000
027300                                                                  02730000
027400     DISPLAY 'PROGRAM APKUP280 STATISTICS'.                       02740000
027500     DISPLAY 'RECORD READ = ' WS-INPUT-COUNT.                     02750000
027600     DISPLAY 'ROWS UPDATED = ' WS-UPDATE-COUNT.                   02760000
027800 EJECT                                                            02780000
027900*---------------------------------------------------------------* 02790000
028000*  READ THE INPUT FILE.                                         * 02800000
028100*---------------------------------------------------------------* 02810000
028200 R100-READ-INVOIC.                                                02820000
028300                                                                  02830000
028400     READ TINVOIC-FILE INTO AP067-RECORD                          02840000
028500          AT END SET WS-END-OF-INPUT TO TRUE.                     02850000
028600                                                                  02860000
028700     IF WS-END-OF-INPUT                                           02870000
028800        CONTINUE                                                  02880000
028900     ELSE                                                         02890000
029000        ADD +1 TO WS-INPUT-COUNT                                  02900000
029100     END-IF.                                                      02910000
029200                                                                  02920000
029300 EJECT                                                            02930000
029400*---------------------------------------------------------------* 02940000
029500*  SELECT CURRENT TIMESTAMP.  THIS WILL BE USED ONLY FOR UPDATE * 02950000
029600*  TO STATUS 'DE' WHEN THE TIMESTAMP FROM THE INPUT IS NOT USED.* 02960000
029700*---------------------------------------------------------------* 02970000
029800 S100-SELECT-CURRENT-TMST.                                        02980000
029900                                                                  02990000
030000     EXEC SQL                                                     03000000
030100          SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                03010000
030200     END-EXEC                                                     03020000
030300                                                                  03030000
030400     EVALUATE TRUE                                                03040000
030500         WHEN SQLCODE = ZERO                                      03050000
030600              CONTINUE                                            03060000
030700         WHEN SQLWARN0 NOT = SPACES                               03070000
030800         WHEN SQLCODE  NOT = ZERO                                 03080000
030900           MOVE 'S100-SELECT-CURRENT-TMST     '                   03090000
031000                         TO WS-ABEND-PARAGRAPH                    03100000
031100           MOVE 'UNSUCCESSFUL SELECT TMST  '                      03110000
031200                         TO WS-ABEND-OPERATION                    03120000
031300           MOVE '        ' TO WS-ABEND-STRUCTURE-1                03130000
031400           MOVE '        ' TO WS-ABEND-STRUCTURE-2                03140000
031500           PERFORM Z999-SQL-ERROR                                 03150000
031600     END-EVALUATE.                                                03160000
031700                                                                  03170000
031800 EJECT                                                            03180000
031900*---------------------------------------------------------------* 03190000
032000*  UPDATE STATUS TO 'DE'.  THE STATUS CHANGE TIMESTAMP IN THIS  * 03200000
032100*  UPDATE USES A HOST VARIABLE BECAUSE FOR SOME UPDATES, THE    * 03210000
032200*  TIMESTAMP IS PROVIDED ON THE INPUT RECORD, ON OTHERS THE     * 03220000
032300*  CURRENT TIMESTAMP IS USED.                                   * 03230000
032500*---------------------------------------------------------------* 03250000
032600 U100-UPDATE-TINVOIC-DE.                                          03260000
032700                                                                  03270000
032800     PERFORM WITH TEST AFTER                                      03280000
032900        VARYING WS-RETRY-COUNTER FROM 1 BY 1                      03290000
033000        UNTIL   WS-RETRY-COUNTER > WS-RETRY-MAX OR                03300000
033100                SQLCODE = ZERO                                    03310000
033200        EXEC SQL                                                  03320000
033300            UPDATE TINVOIC                                        03330000
033400            SET  STATUS_CDE        = 'DE'                         03340000
033500                ,STATUS_CHG_TMST   = :PV-UPDATE-TMST              03350000
033600            WHERE PO_NBR  = :INVOIC-PO-NBR                        03360000
033700              AND INVC_ID = :INVOIC-INVC-ID                       03370000
033800        END-EXEC                                                  03380000
033900                                                                  03390000
034000        EVALUATE TRUE                                             03400000
034100            WHEN SQLCODE = ZERO                                   03410000
034200                 ADD +1 TO WS-UPDATE-COUNT                        03420000
034300            WHEN SQLCODE = -904                                   03430000
034400            WHEN SQLCODE = -913                                   03440000
034500              CONTINUE                                            03450000
034600            WHEN SQLWARN0 NOT = SPACES                            03460000
034700            WHEN SQLCODE  NOT = ZERO                              03470000
034800              DISPLAY '******* PO: '  INVOIC-PO-NBR               03480000
034900              DISPLAY '** INVOICE: '  INVOIC-INVC-ID              03490000
035000              MOVE 'U100-UPDATE-TINVOIC-DE       '                03500000
035100                            TO WS-ABEND-PARAGRAPH                 03510000
035200              MOVE 'UNSUCCESSFUL UPDATE INVOIC'                   03520000
035300                            TO WS-ABEND-OPERATION                 03530000
035400              MOVE 'TINVOIC ' TO WS-ABEND-STRUCTURE-1             03540000
035500              MOVE SPACES     TO WS-ABEND-STRUCTURE-2             03550000
035600              PERFORM Z999-SQL-ERROR                              03560000
035700           END-EVALUATE                                           03570000
035800     END-PERFORM.                                                 03580000
035900                                                                  03590000
036000     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           03600000
036100         MOVE 'U100-UPDATE-TINVOIC-DE       '                     03610000
036200                       TO WS-ABEND-PARAGRAPH                      03620000
036300         MOVE 'MAX RETRIES EXCEEDED ON UPDATE INVOIC'             03630000
036400                         TO WS-ABEND-OPERATION                    03640000
036500         PERFORM Z999-SQL-ERROR                                   03650000
036600     END-IF.                                                      03660000
036700                                                                  03670000
038400                                                                  03840000
038500 EJECT                                                            03850000
038600*---------------------------------------------------------------* 03860000
038700*  UPDATE STATUS TO 'EN'.  THE STATUS CHANGE TIMESTAMP IS SET   * 03870000
038800*  TO CURRENT TIMESTAMP.                                        * 03880000
039000*---------------------------------------------------------------* 03900000
039100 U200-UPDATE-TINVOIC-EN.                                          03910000
039200                                                                  03920000
039300     PERFORM WITH TEST AFTER                                      03930000
039400        VARYING WS-RETRY-COUNTER FROM 1 BY 1                      03940000
039500        UNTIL   WS-RETRY-COUNTER > WS-RETRY-MAX OR                03950000
039600                SQLCODE = ZERO                                    03960000
039700        EXEC SQL                                                  03970000
039800            UPDATE TINVOIC                                        03980000
039900            SET  STATUS_CDE        = 'EN'                         03990000
040000                ,STATUS_CHG_TMST   = CURRENT TIMESTAMP            04000000
040100            WHERE PO_NBR  = :INVOIC-PO-NBR                        04010000
040200              AND INVC_ID = :INVOIC-INVC-ID                       04020000
040300        END-EXEC                                                  04030000
040400                                                                  04040000
040500        EVALUATE TRUE                                             04050000
040600            WHEN SQLCODE = ZERO                                   04060000
040700                 ADD +1 TO WS-UPDATE-COUNT                        04070000
040800            WHEN SQLCODE = -904                                   04080000
040900            WHEN SQLCODE = -913                                   04090000
041000              CONTINUE                                            04100000
041100            WHEN SQLWARN0 NOT = SPACES                            04110000
041200            WHEN SQLCODE  NOT = ZERO                              04120000
041300              DISPLAY '******* PO: '  INVOIC-PO-NBR               04130000
041400              DISPLAY '** INVOICE: '  INVOIC-INVC-ID              04140000
041500              MOVE 'U200-UPDATE-TINVOIC-EN       '                04150000
041600                            TO WS-ABEND-PARAGRAPH                 04160000
041700              MOVE 'UNSUCCESSFUL UPDATE INVOIC'                   04170000
041800                            TO WS-ABEND-OPERATION                 04180000
041900              MOVE 'TINVOIC ' TO WS-ABEND-STRUCTURE-1             04190000
042000              MOVE SPACES     TO WS-ABEND-STRUCTURE-2             04200000
042100              PERFORM Z999-SQL-ERROR                              04210000
042200           END-EVALUATE                                           04220000
042300     END-PERFORM.                                                 04230000
042400                                                                  04240000
042500     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           04250000
042600         MOVE 'U200-UPDATE-TINVOIC-EN       '                     04260000
042700                       TO WS-ABEND-PARAGRAPH                      04270000
042800         MOVE 'MAX RETRIES EXCEEDED ON UPDATE INVOIC'             04280000
042900                         TO WS-ABEND-OPERATION                    04290000
043000         PERFORM Z999-SQL-ERROR                                   04300000
043100     END-IF.                                                      04310000
043200                                                                  04320000
044900                                                                  04490000
045000 EJECT                                                            04500000
045100*---------------------------------------------------------------* 04510017
045110*  UPDATE STATUS TO 'PJ'.  THE STATUS CHANGE TIMESTAMP IS SET   * 04511017
045120*  TO CURRENT TIMESTAMP.                                        * 04512017
045140*---------------------------------------------------------------* 04514015
045150 U350-UPDATE-TINVOIC-PJ.                                          04515016
045160                                                                  04516015
045170     PERFORM WITH TEST AFTER                                      04517015
045180        VARYING WS-RETRY-COUNTER FROM 1 BY 1                      04518015
045190        UNTIL   WS-RETRY-COUNTER > WS-RETRY-MAX OR                04519015
045191                SQLCODE = ZERO                                    04519115
045192        EXEC SQL                                                  04519215
045193            UPDATE TINVOIC                                        04519315
045194            SET  STATUS_CDE        = 'PJ'                         04519415
045195                ,STATUS_CHG_TMST   = CURRENT TIMESTAMP            04519515
045196            WHERE PO_NBR  = :INVOIC-PO-NBR                        04519615
045197              AND INVC_ID = :INVOIC-INVC-ID                       04519715
045198        END-EXEC                                                  04519815
045199                                                                  04519915
045200        EVALUATE TRUE                                             04520015
045201            WHEN SQLCODE = ZERO                                   04520115
045202                 ADD +1 TO WS-UPDATE-COUNT                        04520215
045203            WHEN SQLCODE = -904                                   04520315
045204            WHEN SQLCODE = -913                                   04520415
045205              CONTINUE                                            04520515
045206            WHEN SQLWARN0 NOT = SPACES                            04520615
045207            WHEN SQLCODE  NOT = ZERO                              04520715
045208              DISPLAY '******* PO: '  INVOIC-PO-NBR               04520815
045209              DISPLAY '** INVOICE: '  INVOIC-INVC-ID              04520915
045210              MOVE 'U350-UPDATE-TINVOIC-PJ'                       04521016
045211                            TO WS-ABEND-PARAGRAPH                 04521115
045212              MOVE 'UNSUCCESSFUL UPDATE TINVOIC'                  04521215
045213                            TO WS-ABEND-OPERATION                 04521315
045214              MOVE 'TINVOIC ' TO WS-ABEND-STRUCTURE-1             04521415
045215              MOVE SPACES     TO WS-ABEND-STRUCTURE-2             04521515
045216              PERFORM Z999-SQL-ERROR                              04521615
045217           END-EVALUATE                                           04521715
045218     END-PERFORM.                                                 04521815
045219                                                                  04521915
045220     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           04522015
045221         MOVE 'U350-UPDATE-TINVOIC-PJ           '                 04522116
045222                       TO WS-ABEND-PARAGRAPH                      04522215
045223         MOVE 'MAX RETRIES EXCEEDED ON UPDATE INVOIC'             04522315
045224                         TO WS-ABEND-OPERATION                    04522415
045225         PERFORM Z999-SQL-ERROR                                   04522515
045226     END-IF.                                                      04522615
045227                                                                  04522715
045228                                                                  04522815
045229 EJECT                                                            04522915
045230*---------------------------------------------------------------* 04523015
045240*  UPDATE STATUS TO 'RL'.  THE STATUS CHANGE TIMESTAMP IS SET   * 04524015
045300*  TO CURRENT TIMESTAMP.                                        * 04530000
045500*---------------------------------------------------------------* 04550000
045600 U300-UPDATE-TINVOIC-RL.                                          04560000
045700                                                                  04570000
045800     PERFORM WITH TEST AFTER                                      04580000
045900        VARYING WS-RETRY-COUNTER FROM 1 BY 1                      04590000
046000        UNTIL   WS-RETRY-COUNTER > WS-RETRY-MAX OR                04600000
046100                SQLCODE = ZERO                                    04610000
046200        EXEC SQL                                                  04620000
046300            UPDATE TINVOIC                                        04630000
046400            SET  STATUS_CDE        = 'RL'                         04640000
046500                ,STATUS_CHG_TMST   = CURRENT TIMESTAMP            04650000
046600            WHERE PO_NBR  = :INVOIC-PO-NBR                        04660000
046700              AND INVC_ID = :INVOIC-INVC-ID                       04670000
046800        END-EXEC                                                  04680000
046900                                                                  04690000
047000        EVALUATE TRUE                                             04700000
047100            WHEN SQLCODE = ZERO                                   04710000
047200                 ADD +1 TO WS-UPDATE-COUNT                        04720000
047300            WHEN SQLCODE = -904                                   04730000
047400            WHEN SQLCODE = -913                                   04740000
047500              CONTINUE                                            04750000
047600            WHEN SQLWARN0 NOT = SPACES                            04760000
047700            WHEN SQLCODE  NOT = ZERO                              04770000
047800              DISPLAY '******* PO: '  INVOIC-PO-NBR               04780000
047900              DISPLAY '** INVOICE: '  INVOIC-INVC-ID              04790000
048000              MOVE 'U300-UPDATE-TINVOIC-RL       '                04800000
048100                            TO WS-ABEND-PARAGRAPH                 04810000
048200              MOVE 'UNSUCCESSFUL UPDATE INVOIC'                   04820000
048300                            TO WS-ABEND-OPERATION                 04830000
048400              MOVE 'TINVOIC ' TO WS-ABEND-STRUCTURE-1             04840000
048500              MOVE SPACES     TO WS-ABEND-STRUCTURE-2             04850000
048600              PERFORM Z999-SQL-ERROR                              04860000
048700           END-EVALUATE                                           04870000
048800     END-PERFORM.                                                 04880000
048900                                                                  04890000
049000     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           04900000
049100         MOVE 'U200-UPDATE-TINVOIC-EN       '                     04910000
049200                       TO WS-ABEND-PARAGRAPH                      04920000
049300         MOVE 'MAX RETRIES EXCEEDED ON UPDATE INVOIC'             04930000
049400                         TO WS-ABEND-OPERATION                    04940000
049500         PERFORM Z999-SQL-ERROR                                   04950000
049600     END-IF.                                                      04960000
049700                                                                  04970000
052700                                                                  05270000
052800 EJECT                                                            05280000
052900*---------------------------------------------------------------* 05290000
053000*  UPDATE STATUS TO ANY OTHER VALID VALUE, BASED ON THE CONTROL * 05300000
053100*  CARD.  SETS STATUS CHANGE TIMESTAMP TO CURRENT TIMESTAMP.    * 05310000
053400*---------------------------------------------------------------* 05340000
053500 U400-UPDATE-TINVOIC-OTHER.                                       05350000
053600                                                                  05360000
053700     PERFORM WITH TEST AFTER                                      05370000
053800        VARYING WS-RETRY-COUNTER FROM 1 BY 1                      05380000
053900        UNTIL   WS-RETRY-COUNTER > WS-RETRY-MAX OR                05390000
054000                SQLCODE = ZERO                                    05400000
054100        EXEC SQL                                                  05410000
054200            UPDATE TINVOIC                                        05420000
054300            SET  STATUS_CDE        = :WS-CHANGE-TO-CODE           05430000
054400                ,STATUS_CHG_TMST   = CURRENT TIMESTAMP            05440000
054500            WHERE PO_NBR  = :INVOIC-PO-NBR                        05450000
054600              AND INVC_ID = :INVOIC-INVC-ID                       05460000
054700        END-EXEC                                                  05470000
054800                                                                  05480000
054900        EVALUATE TRUE                                             05490000
055000            WHEN SQLCODE = ZERO                                   05500000
055100                 ADD +1 TO WS-UPDATE-COUNT                        05510000
055200            WHEN SQLCODE = -904                                   05520000
055300            WHEN SQLCODE = -913                                   05530000
055400              CONTINUE                                            05540000
055500            WHEN SQLWARN0 NOT = SPACES                            05550000
055600            WHEN SQLCODE  NOT = ZERO                              05560000
055700              DISPLAY '******* PO: '  INVOIC-PO-NBR               05570000
055800              DISPLAY '** INVOICE: '  INVOIC-INVC-ID              05580000
055900              MOVE 'U400-UPDATE-TINVOIC-OTHER'                    05590000
056000                            TO WS-ABEND-PARAGRAPH                 05600000
056100              MOVE 'UNSUCCESSFUL UPDATE INVOIC'                   05610000
056200                            TO WS-ABEND-OPERATION                 05620000
056300              MOVE 'TINVOIC ' TO WS-ABEND-STRUCTURE-1             05630000
056400              MOVE SPACES     TO WS-ABEND-STRUCTURE-2             05640000
056500              PERFORM Z999-SQL-ERROR                              05650000
056600           END-EVALUATE                                           05660000
056700     END-PERFORM.                                                 05670000
056800                                                                  05680000
056900     IF WS-RETRY-COUNTER > WS-RETRY-MAX                           05690000
057000         MOVE 'U400-UPDATE-TINVOIC-OTHER'                         05700000
057100                       TO WS-ABEND-PARAGRAPH                      05710000
057200         MOVE 'MAX RETRIES EXCEEDED ON UPDATE INVOIC'             05720000
057300                         TO WS-ABEND-OPERATION                    05730000
057400         PERFORM Z999-SQL-ERROR                                   05740000
057500     END-IF.                                                      05750000
057600                                                                  05760000
057700                                                                  05770000
065700                                                                  06570000
065800 Z998-ERROR.                                                      06580000
065900                                                                  06590000
066000     DISPLAY ABEND-CODE.                                          06600000
066100     DISPLAY WS-ABEND-PROGRAM.                                    06610000
066200     DISPLAY WS-ABEND-OPERATION.                                  06620000
066300     CALL 'ILBOABN0' USING ABEND-CODE.                            06630000
066400                                                                  06640000
066500 Z999-SQL-ERROR.                                                  06650000
066600*                                                                 06660000
066700***************************************************************** 06670000
066800*     PROCESS DB2 ABENDS                                          06680000
066900***************************************************************** 06690000
067000*                                                                 06700000
067100     DISPLAY '*** DB2 ERROR '.                                    06710000
067200     DISPLAY '*** PROGRAM   = ' WS-ABEND-PROGRAM.                 06720000
067300     DISPLAY '*** PARAGRAPH = ' WS-ABEND-PARAGRAPH.               06730000
067400     DISPLAY '*** OPERATION = ' WS-ABEND-OPERATION.               06740000
067500     DISPLAY '*** TABLE 1   = ' WS-ABEND-STRUCTURE-1.             06750000
067600     IF WS-ABEND-STRUCTURE-2 > SPACES                             06760000
067700         DISPLAY '*** TABLE 2   = ' WS-ABEND-STRUCTURE-2.         06770000
067800                                                                  06780000
067900     MOVE +4013                    TO ABEND-CODE.                 06790000
068000                                                                  06800000
068100     COPY DPPD004.                                                06810000
068200     CALL 'ILBOABN0' USING ABEND-CODE.                            06820000
068300                                                                  06830000
