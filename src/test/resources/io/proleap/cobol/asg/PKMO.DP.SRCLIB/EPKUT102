000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400 PROGRAM-ID.    EPKUT102.                                         00040000
000500 AUTHOR.        CHRIS CLARK                                       00050000
000600 DATE-WRITTEN.  JANUARY, 2003.                                    00060000
000700                                                                  00070000
000800******************************************************************00080000
000900* THIS PROGRAM EXTRACTS A FULL SET OF XREF DATA IF ANY STORES HAVE00090000
001000* BEEN FLAGED TO RECEIVE A FULL REFRESH.  ALL RECORDS ARE GLOBAL. 00100000
001100* IT RUNS NIGHTLY AS PART OF THE PLU AND XREF EXTRACT PROCESS.    00110000
001200******************************************************************00120000
001300* HISTORY LOG:                                                    00130000
001400*                                                                 00140000
001500******************************************************************00150003
001600* DATE: 01/16/09                                                  00160000
001700* WR/IR#: WR#35484 (POS FALL 2009)                                00170000
001800* PROGRAMMER: DENORRIS COOKS                                      00180000
001900* DESCRIPTION: BUILD AND WRITE OUT NEW SQL SERVER XREF FILE.      00190000
002000*              NEW PARAGRAPHS ARE 3300-; 5100-; AND 6000-;        00200001
002100*                                                                 00210000
002200* DATE: 02/14/2023                                                00220005
002300* WR/IR#: CHG0281369                                              00230005
002400* PROGRAMMER: JEAN KURK                                           00240005
002500* DESCRIPTION: CHANGE CALL OF UPC CHECK DIGIT ROUTINE TO DYNAMIC  00250006
002700*                                                                 00270000
002800******************************************************************00280000
002900 ENVIRONMENT DIVISION.                                            00290000
003000******************************************************************00300000
003100 CONFIGURATION SECTION.                                           00310000
003200 SOURCE-COMPUTER. IBM-3090.                                       00320000
003300 OBJECT-COMPUTER. IBM-3090.                                       00330000
003400                                                                  00340000
003500 INPUT-OUTPUT SECTION.                                            00350000
003600                                                                  00360000
003700 FILE-CONTROL.                                                    00370000
003800                                                                  00380000
003900     SELECT CC-DATE-FILE                                          00390000
004000       ASSIGN TO INP01.                                           00400000
004100                                                                  00410000
004200     SELECT XREF-INPUT-FILE                                       00420000
004300       ASSIGN TO INP02.                                           00430000
004400                                                                  00440000
004500     SELECT XREF-UPC-SKU-FILE                                     00450000
004600       ASSIGN TO OUT01.                                           00460004
004700                                                                  00470000
004800******************************************************************00480000
004900 DATA DIVISION.                                                   00490000
005000******************************************************************00500000
005100 FILE SECTION.                                                    00510000
005200                                                                  00520000
005300 FD  CC-DATE-FILE                                                 00530000
005400     RECORDING MODE IS F                                          00540000
005500     BLOCK CONTAINS 0 RECORDS                                     00550000
005600     LABEL RECORDS ARE STANDARD.                                  00560000
005700                                                                  00570000
005800 01  CC-DATE-RECORD                         PIC  X(80).           00580000
005900                                                                  00590000
006000 FD  XREF-INPUT-FILE                                              00600000
006100     RECORDING MODE IS F                                          00610000
006200     LABEL RECORDS ARE STANDARD                                   00620000
006300     RECORD CONTAINS 50 CHARACTERS                                00630000
006400     DATA RECORD IS XREF-INPUT-RECORD.                            00640000
006500 01  XREF-INPUT-RECORD                      PIC  X(50).           00650000
006600                                                                  00660000
006700 FD  XREF-UPC-SKU-FILE                                            00670000
006800     RECORDING MODE IS F                                          00680000
006900     BLOCK CONTAINS 0 RECORDS                                     00690000
007000     LABEL RECORDS ARE STANDARD.                                  00700000
007100 01  XREF-UPC-SKU-REC                       PIC  X(80).           00710000
007200                                                                  00720000
007300******************************************************************00730000
007400 WORKING-STORAGE SECTION.                                         00740000
007500******************************************************************00750000
007600                                                                  00760000
007700******************************************************************00770000
007800* PC- PROGRAM CONSTANTS                                           00780000
007900******************************************************************00790000
008000 01  PC-PROGRAM-CONSTANTS.                                        00800000
008100   05  PC-CURRENT-PROGRAM-NAME        PIC  X(008)                 00810000
008200        VALUE 'EPKUT102'.                                         00820000
008300                                                                  00830000
008400 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      00840000
008500                                                  COMP SYNC.      00850000
008600*    88  AC-CONTROL-CARD-ERROR                    VALUE +4003.    00860000
008700     88  AC-DATE-CARD-ERROR                       VALUE +4003.    00870000
008800     88  AC-TABLE-ERROR                           VALUE +4004.    00880000
008900     88  AC-DB2-ERROR                             VALUE +4013.    00890000
009000     88  AC-CALENDAR-ROUTINE-ERROR                VALUE +4019.    00900000
009100                                                                  00910000
009200******************************************************************00920000
009300* PS- PROGRAM SWITCHES                                            00930000
009400******************************************************************00940000
009500 01  PS-PROGRAM-SWITCHES.                                         00950000
009600     05  PS-EOF-DATE-FILE-SW              PIC  X(01) VALUE 'N'.   00960000
009700         88  PS-EOF-DATE-FILE-Y                      VALUE 'Y'.   00970000
009800     05  PS-EOF-INPUT-FILE-SW             PIC  X(01) VALUE 'N'.   00980000
009900         88  PS-EOF-INPUT-FILE-Y                     VALUE 'Y'.   00990000
010000     05  PS-END-OF-UPC-XREF-CURSOR-SW     PIC  X(01) VALUE 'N'.   01000000
010100         88  PS-END-OF-UPC-XREF-CURSOR-Y             VALUE 'Y'.   01010000
010200         88  PS-END-OF-UPC-XREF-CURSOR-N             VALUE 'N'.   01020000
010300******************************************************************01030000
010400* PV- PROGRAM WORKING VARIABLES                                   01040000
010500******************************************************************01050000
010600 01  PV-MISC-FIELDS.                                              01060000
010700     05  PV-OPERATION-MSG-1           PIC  X(40)  VALUE SPACE.    01070000
010800     05  PV-OPERATION-MSG-2           PIC  X(40)  VALUE SPACE.    01080000
010900     05  PV-PARAGRAPH-NAME            PIC  X(30)  VALUE SPACE.    01090000
011000     05  PV-DB2-OPERATION             PIC  X(30)  VALUE SPACE.    01100000
011100     05  PV-SKU-NBR                   PIC  9(08)  VALUE ZEROS.    01110000
011200     05  FILLER REDEFINES PV-SKU-NBR.                             01120000
011300         10  PV-SKU-NBR-DEPT          PIC 9(03).                  01130000
011400         10  PV-SKU-NBR-CLASS         PIC 9(02).                  01140000
011500         10  PV-SKU-NBR-FINAL         PIC 9(03).                  01150000
011600     05  PV-STR-GRP-TYP-CDE-FULL      PIC 9(05)    VALUE 99998.   01160000
011700     05  PV-INTERNAL-UPC-ID-TMP       PIC S9(10) COMP VALUE ZEROS.01170000
011800     05  PV-INTERNAL-UPC-ID           PIC S9(9)  COMP VALUE ZEROS.01180000
011900     05  PV-DRIVER-READ-CNT           PIC  9(9)    VALUE ZEROS.   01190000
012000     05  PV-DRIVER-DUMMY-CNT          PIC  9(9)    VALUE ZEROS.   01200000
012100     05  PV-DRIVER-REAL-CNT           PIC  9(9)    VALUE ZEROS.   01210000
012200     05  PV-NEWXREF-WRITE-CNT         PIC  9(9)    VALUE ZEROS.   01220000
012300                                                                  01230000
012400******************************************************************01240000
012500* FULL XREF DRIVER FILE LAYOUT.                                   01250000
012600******************************************************************01260000
012700     COPY EPRD074.                                                01270000
012800                                                                  01280000
012900******************************************************************01290000
013000* PERM SQL SERVER XREF EXTRACT FILE LAYOUT.                       01300000
013100******************************************************************01310000
013200     COPY EPRD218.                                                01320000
013300                                                                  01330000
013400******************************************************************01340000
013500* PERM XREF EFFECTIVE DATE CONTROL CARD LAYOUT.                   01350000
013600******************************************************************01360000
013700     COPY EPWS112.                                                01370000
013800                                                                  01380000
013900******************************************************************01390000
014000* COPY BOOK FOR CALLING PROGRAM UPC CHECK DIGIT ROUTINE           01400006
014100******************************************************************01410000
014200     COPY DPWS040I.                                               01420000
014300                                                                  01430000
014400******************************************************************01440000
014500*  DB2 COMMUNICATION AREA.                                        01450000
014600******************************************************************01460000
014700     EXEC SQL                                                     01470000
014800          INCLUDE SQLCA                                           01480000
014900     END-EXEC.                                                    01490000
015000                                                                  01500000
015100******************************************************************01510000
015200*  DB2 TABLE DB2PDBA.XST_UPC - UPC XREF TABLE                     01520000
015300******************************************************************01530000
015400     EXEC SQL                                                     01540000
015500          INCLUDE XST00012                                        01550000
015600     END-EXEC.                                                    01560000
015700                                                                  01570000
015800******************************************************************01580000
015900*  UPC XREF CURSOR.                                               01590000
016000******************************************************************01600000
016100                                                                  01610000
016200     EXEC SQL                                                     01620000
016300        DECLARE UPC-XREF-CSR CURSOR FOR                           01630000
016400         SELECT UPC_NBR                                           01640000
016500           FROM XST_UPC                                           01650000
016600          WHERE INTR_UPC_ID          = :PV-INTERNAL-UPC-ID        01660000
016700            AND LAST_ACTN_CDE       <> 'D'                        01670000
016800                WITH UR                                           01680000
016900     END-EXEC.                                                    01690000
017000                                                                  01700000
017100******************************************************************01710000
017200 PROCEDURE DIVISION.                                              01720000
017300******************************************************************01730000
017400 0000-MAINLINE.                                                   01740000
017500                                                                  01750000
017600     PERFORM 1000-INITIALIZE.                                     01760000
017700     PERFORM 2000-PROCESS-INPUT-FILE                              01770000
017800             UNTIL PS-EOF-INPUT-FILE-Y.                           01780000
017900     PERFORM 8000-CLOSE-FILES.                                    01790000
018000     PERFORM 9000-DISPLAY-COUNTS.                                 01800000
018100                                                                  01810000
018200     STOP RUN.                                                    01820000
018300*0000-EXIT.                                                       01830000
018400                                                                  01840000
018500******************************************************************01850000
018600* 1000-INITIALIZE-PROGRAM                                         01860000
018700*     OPEN FILES, PROCESS CONTROL CARD.                           01870000
018800******************************************************************01880000
018900 1000-INITIALIZE.                                                 01890000
019000                                                                  01900000
019100     OPEN INPUT  CC-DATE-FILE                                     01910000
019200                 XREF-INPUT-FILE                                  01920000
019300          OUTPUT XREF-UPC-SKU-FILE.                               01930004
019400                                                                  01940000
019500     PERFORM 1100-READ-DATE-FILE.                                 01950000
019600                                                                  01960000
019700     DISPLAY 'PROGRAM EPKUT102'.                                  01970000
019800     DISPLAY 'CONTROL CARD TOMORROW DATE: '                       01980000
019900             CC-EPCC112-TOMORROW-DATE.                            01990000
020000                                                                  02000000
020100     PERFORM 6000-READ-INPUT-XREF-REC.                            02010000
020200                                                                  02020000
020300******************************************************************02030000
020400* 1100-READ-DATE-FILE                                             02040000
020500*     READ DATE CONTROL CARD.                                     02050000
020600******************************************************************02060000
020700 1100-READ-DATE-FILE.                                             02070000
020800                                                                  02080000
020900     READ CC-DATE-FILE INTO CC-EPCC112-CONTROL-CARD               02090000
021000        AT END                                                    02100000
021100           SET PS-EOF-DATE-FILE-Y TO TRUE                         02110000
021200     END-READ.                                                    02120000
021300                                                                  02130000
021400 EJECT                                                            02140000
021500******************************************************************02150000
021600* 2000-PROCESS-INPUT-FILE.                                        02160000
021700******************************************************************02170000
021800 2000-PROCESS-INPUT-FILE.                                         02180000
021900     MOVE EP074-SKU-NBR TO PV-SKU-NBR.                            02190000
022000                                                                  02200000
022100     IF PV-SKU-NBR-FINAL = 000                                    02210000
022200        ADD +1  TO PV-DRIVER-DUMMY-CNT                            02220000
022300        PERFORM 3300-PROC-DUMMY-SQLSRV-REC                        02230000
022400     ELSE                                                         02240000
022500        ADD +1  TO PV-DRIVER-REAL-CNT                             02250000
022600        PERFORM 3100-PROCESS-VALID-SKU                            02260000
022700     END-IF.                                                      02270000
022800                                                                  02280000
022900     PERFORM 6000-READ-INPUT-XREF-REC.                            02290000
023000                                                                  02300000
023100******************************************************************02310000
023200* 3100-PROCESS-VALID-SKU.                                         02320000
023300******************************************************************02330000
023400 3100-PROCESS-VALID-SKU.                                          02340000
023500                                                                  02350000
023600     MOVE EP074-INTERNAL-UPC-ID       TO PV-INTERNAL-UPC-ID-TMP.  02360000
023700     MOVE PV-INTERNAL-UPC-ID-TMP      TO PV-INTERNAL-UPC-ID.      02370000
023800     PERFORM 4000-OPEN-UPC-XREF-CURSOR.                           02380000
023900     PERFORM 4100-FETCH-UPC-XREF-CURSOR                           02390000
024000         UNTIL PS-END-OF-UPC-XREF-CURSOR-Y.                       02400000
024100     PERFORM 4200-CLOSE-UPC-XREF-CURSOR.                          02410000
024200     SET PS-END-OF-UPC-XREF-CURSOR-N TO TRUE.                     02420000
024300                                                                  02430000
024400******************************************************************02440000
024500*3300-PROC-DUMMY-SQLSRV-REC.                                      02450002
024600*                                                                 02460001
024700* BUILD DUMMY XREF SQLSERVER REC.                                 02470002
024800*                                                                 02480001
024900******************************************************************02490000
025000 3300-PROC-DUMMY-SQLSRV-REC.                                      02500000
025100                                                                  02510000
025200     SET  DP040I-GEN-INTERNAL-UPC-OPTION TO TRUE.                 02520004
025300     MOVE EP074-SKU-NBR           TO DP040I-SKU-NUMBER.           02530004
025400     CALL DP040I-UPC-CHECK-DIGIT-WO-IUPC                          02540005
025400                     USING DP040I-UPC-CHECK-DIGIT-PARMS.          02541005
025500                                                                  02550004
025600     MOVE CC-EPCC112-TOMORROW-DATE  TO EP218-XREF-EFFECT-DTE.     02560000
025700     MOVE PV-STR-GRP-TYP-CDE-FULL TO EP218-STR-GRP-TYP-CDE.       02570000
025800     MOVE ZEROS                   TO EP218-STR-GRP-ID.            02580000
025900     SET EP218-FILE-FULL          TO TRUE.                        02590000
026000     SET EP218-APPLY-NIGHTLY      TO TRUE.                        02600000
026100     SET EP218-RECORD-ADD         TO TRUE.                        02610000
026200     MOVE DP040I-UPC-CODE         TO EP218-UPC-NBR.               02620000
026300     MOVE EP074-SKU-NBR           TO EP218-SKU-NBR.               02630000
026400                                                                  02640000
026500     PERFORM 7100-WRITE-SQLSRVR-XREF-REC.                         02650000
026600                                                                  02660000
026700******************************************************************02670000
026800*                                                                 02680001
026900* 4000-OPEN-UPC-XREF-CURSOR.                                      02690000
027000*                                                                 02700001
027100******************************************************************02710000
027200 4000-OPEN-UPC-XREF-CURSOR.                                       02720000
027300                                                                  02730000
027400     EXEC SQL                                                     02740000
027500          OPEN UPC-XREF-CSR                                       02750000
027600     END-EXEC.                                                    02760000
027700                                                                  02770000
027800     EVALUATE TRUE                                                02780000
027900         WHEN SQLCODE = ZERO                                      02790000
028000              CONTINUE                                            02800000
028100         WHEN SQLWARN0 NOT EQUAL SPACE                            02810000
028200         WHEN SQLCODE NOT EQUAL ZERO                              02820000
028300             MOVE '4000-OPEN-UPC-XREF-CURSOR'                     02830000
028400                                   TO PV-PARAGRAPH-NAME           02840000
028500             MOVE 'ERROR ON OPEN OF UPC-XREF-CSR CURSOR'          02850000
028600                                   TO PV-DB2-OPERATION            02860000
028700             PERFORM 9100-SQL-ABEND                               02870000
028800     END-EVALUATE.                                                02880000
028900 EJECT                                                            02890000
029000                                                                  02900000
029100******************************************************************02910000
029200* 4100-FETCH-UPC-XREF-CURSOR                                      02920000
029300******************************************************************02930000
029400 4100-FETCH-UPC-XREF-CURSOR.                                      02940000
029500                                                                  02950000
029600     EXEC SQL                                                     02960000
029700          FETCH UPC-XREF-CSR                                      02970000
029800           INTO :XST00012-UPC-NBR                                 02980000
029900     END-EXEC.                                                    02990000
030000                                                                  03000000
030100     EVALUATE TRUE                                                03010000
030200         WHEN SQLCODE = ZERO                                      03020000
030300             PERFORM 5100-FORMAT-NEW-UPC-DATA                     03030000
030400         WHEN SQLCODE = +100                                      03040000
030500             SET PS-END-OF-UPC-XREF-CURSOR-Y  TO TRUE             03050000
030600         WHEN SQLWARN0 NOT EQUAL SPACE                            03060000
030700         WHEN SQLCODE NOT EQUAL ZERO                              03070000
030800             MOVE '4100-FETCH-UPC-XREF-CURSOR'                    03080000
030900                                   TO PV-PARAGRAPH-NAME           03090000
031000             MOVE 'ERROR ON FETCH OF UPC-XREF-CSR CURSOR'         03100000
031100                                   TO PV-DB2-OPERATION            03110000
031200             PERFORM 9100-SQL-ABEND                               03120000
031300     END-EVALUATE.                                                03130000
031400 EJECT                                                            03140000
031500                                                                  03150000
031600******************************************************************03160000
031700* 4200-CLOSE-UPC-XREF-CURSOR                                      03170000
031800******************************************************************03180000
031900 4200-CLOSE-UPC-XREF-CURSOR.                                      03190000
032000                                                                  03200000
032100     EXEC SQL                                                     03210000
032200          CLOSE UPC-XREF-CSR                                      03220000
032300     END-EXEC.                                                    03230000
032400                                                                  03240000
032500     EVALUATE TRUE                                                03250000
032600         WHEN SQLCODE = ZERO                                      03260000
032700              CONTINUE                                            03270000
032800         WHEN SQLWARN0 NOT EQUAL SPACE                            03280000
032900         WHEN SQLCODE NOT EQUAL ZERO                              03290000
033000             MOVE '4200-CLOSE-UPC-XREF-CURSOR'                    03300000
033100                                   TO PV-PARAGRAPH-NAME           03310000
033200             MOVE 'ERROR ON CLOSE OF UPC-XREF-CSR CURSOR'         03320000
033300                                   TO PV-DB2-OPERATION            03330000
033400             PERFORM 9100-SQL-ABEND                               03340000
033500     END-EVALUATE.                                                03350000
033600 EJECT                                                            03360000
033700                                                                  03370000
033800******************************************************************03380000
033900*5100-FORMAT-NEW-UPC-DATA.                                        03390002
034000*                                                                 03400002
034100* BUILD XREF SQLSERVER XREF RECORD.                               03410002
034200******************************************************************03420000
034300 5100-FORMAT-NEW-UPC-DATA.                                        03430000
034400                                                                  03440000
034500     MOVE CC-EPCC112-TOMORROW-DATE  TO EP218-XREF-EFFECT-DTE.     03450000
034600     MOVE PV-STR-GRP-TYP-CDE-FULL TO EP218-STR-GRP-TYP-CDE.       03460000
034700     MOVE ZEROS                   TO EP218-STR-GRP-ID.            03470000
034800     SET EP218-FILE-FULL          TO TRUE.                        03480000
034900     SET EP218-APPLY-NIGHTLY      TO TRUE.                        03490000
035000     SET EP218-RECORD-ADD         TO TRUE.                        03500000
035100     MOVE XST00012-UPC-NBR        TO EP218-UPC-NBR.               03510000
035200     MOVE EP074-SKU-NBR           TO EP218-SKU-NBR.               03520000
035300                                                                  03530000
035400     PERFORM 7100-WRITE-SQLSRVR-XREF-REC.                         03540000
035500                                                                  03550000
035600******************************************************************03560000
035700* 6000-READ-INPUT-XREF-REC.                                       03570000
035800*                                                                 03580003
035900*  READ INPUT FILM RECORDS                                        03590002
036000******************************************************************03600000
036100 6000-READ-INPUT-XREF-REC.                                        03610001
036200*                                                                 03620000
036300     READ XREF-INPUT-FILE INTO EP074-XREF-DRIVE-RECORD            03630000
036400        AT END                                                    03640000
036500           SET PS-EOF-INPUT-FILE-Y  TO TRUE                       03650000
036600        NOT AT END                                                03660000
036700           ADD  1     TO PV-DRIVER-READ-CNT                       03670000
036800     END-READ.                                                    03680000
036900*                                                                 03690000
037000******************************************************************03700000
037100**7100-WRITE-SQLSRVR-XREF-REC.                                    03710000
037200******************************************************************03720000
037300 7100-WRITE-SQLSRVR-XREF-REC.                                     03730000
037400                                                                  03740000
037500     WRITE XREF-UPC-SKU-REC                                       03750000
037600           FROM EP218-UPC-SKU-XREF-RECORD.                        03760000
037700                                                                  03770000
037800     ADD 1 TO PV-NEWXREF-WRITE-CNT.                               03780000
037900                                                                  03790000
038000******************************************************************03800000
038100* 8000-CLOSE-FILES.                                               03810000
038200******************************************************************03820000
038300 8000-CLOSE-FILES.                                                03830000
038400                                                                  03840000
038500     CLOSE CC-DATE-FILE                                           03850000
038600           XREF-INPUT-FILE                                        03860000
038700           XREF-UPC-SKU-FILE.                                     03870000
038800                                                                  03880000
038900******************************************************************03890000
039000* 9000-DISPLAY-COUNTS                                             03900000
039100******************************************************************03910000
039200 9000-DISPLAY-COUNTS.                                             03920000
039300                                                                  03930000
039400     DISPLAY '*** PROGRAM COUNTS FOR EPKUT102 ***'.               03940000
039500     DISPLAY ' DRIVER RECORDS READ: ' PV-DRIVER-READ-CNT.         03950000
039600     DISPLAY 'DRIVER DUMMY RECORDS: ' PV-DRIVER-DUMMY-CNT.        03960000
039700     DISPLAY ' DRIVER REAL RECORDS: ' PV-DRIVER-REAL-CNT.         03970000
039800     DISPLAY 'XREF SQLSRVR UPC RECS:' PV-NEWXREF-WRITE-CNT.       03980000
039900                                                                  03990000
040000***************************************************************** 04000000
040100* 9100-SQL-ABEND                                                  04010000
040200*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.04020000
040300***************************************************************** 04030000
040400 9100-SQL-ABEND.                                                  04040000
040500     DISPLAY '** ABEND     **'.                                   04050000
040600     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        04060000
040700     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              04070000
040800     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               04080000
040900     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         04090000
041000                                                                  04100000
