000100 IDENTIFICATION DIVISION.                                         00010000
000200                                                                  00020000
000300 PROGRAM-ID.    IMKUP040                                          00030000
000400 AUTHOR.        SCOTT JACKSON.                                    00040000
000500 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00050000
000600 DATE-WRITTEN.  10-10-2012.                                       00060000
000700 DATE-COMPILED.                                                   00070000
000800                                                                  00080000
000900******************************************************************00090000
001000*     IMKUP040                                                    00100000
001100******************************************************************00110000
002000******************************************************************00120000
002100                                                                  00130000
002200                                                                  00140000
002300 ENVIRONMENT DIVISION.                                            00150000
002400                                                                  00160000
002500 CONFIGURATION SECTION.                                           00170000
002600 SOURCE-COMPUTER.        IBM-3090.                                00180000
002700 OBJECT-COMPUTER.        IBM-3090.                                00190000
002800 INPUT-OUTPUT SECTION.                                            00200000
002900 FILE-CONTROL.                                                    00210000
003000     SELECT MDM-SEQUENCE-CONTROL                                  00220003
003100         ASSIGN TO INP01.                                         00230000
003000     SELECT MDM-BRIDGE-FILE                                       00240003
003100         ASSIGN TO INP02.                                         00250008
003200                                                                  00260000
003300                                                                  00270000
003400 DATA DIVISION.                                                   00280000
003500 FILE SECTION.                                                    00290000
003600                                                                  00300000
003700 FD  MDM-SEQUENCE-CONTROL                                         00310003
003800     LABEL RECORDS ARE STANDARD                                   00320000
003900     RECORDING MODE IS F                                          00330000
004000     BLOCK CONTAINS 0 RECORDS.                                    00340000
004100 01  MDM-MAX-SEQUENCE            PIC X(80).                       00350003
004200*                                                                 00360000
003700 FD  MDM-BRIDGE-FILE                                              00370003
003800     LABEL RECORDS ARE STANDARD                                   00380003
003900     RECORDING MODE IS F                                          00390003
004000     BLOCK CONTAINS 0 RECORDS.                                    00400003
004100 01  MDM-BRIDGE-RECORD           PIC X(628).                      00410009
004200*                                                                 00420003
004300                                                                  00430000
004400                                                                  00440000
004500 WORKING-STORAGE SECTION.                                         00450000
004600                                                                  00460000
004700 01  ABEND-CODE                  PIC S9(04)  VALUE ZERO COMP SYNC.00470000
004800                                                                  00480000
004900 01  PC-PROGRAM-CONSTANTS.                                        00490000
005000     05  PC-JOB-NAME             PIC  X(06)    VALUE 'IMK100'.    00500001
005100     05  PC-PROGRAM-NAME         PIC  X(08)    VALUE 'IMKUP040'.  00510001
005200     05  PC-MAX-RETRIES          PIC S9(03) VALUE +3.             00520000
005300     05  PC-MAX-DEADLOCKS        PIC S9(03) VALUE +3.             00530000
005400                                                                  00540000
005500 01  PC-PROGRAM-COUNTER.                                          00550000
005600     05  PC-UPDATE-CNT           PIC  9(09).                      00560000
005600     05  PC-DISPLAY-CNT          PIC  9(09).                      00570000
005600     05  PC-SEQUENCE-MAX         PIC  9(09).                      00580004
005800                                                                  00590000
       01  INPUT-CONTROL-REC.                                           00600004
           05  INPUT-MAX-SEQUENCE              PIC   9(9) VALUE ZERO.   00610022
           05  FILLER                          PIC  X(71) VALUE SPACES. 00620009
005800                                                                  00630003
005900 01  PE-PROGRAM-ERROR-MESSAGES.                                   00640000
006000     05  PE-MSG-01                       PIC X(50) VALUE          00650000
006100          'ATTEMPT TO SELECT ROW FOR UPDATE/INSERT FAILED   '.    00660000
006200     05  PE-MSG-02                       PIC X(50) VALUE          00670000
006300          'ATTEMPT TO UPDATE ROW ON UPT_PRD_MDM_BRG_NEW     '.    00680000
006400     05  PE-MSG-03                       PIC X(50) VALUE          00690000
006500          'ATTEMPT TO INSERT ROW ON TABLE UPT00002 FAILED    '.   00700000
006600     05  PE-MSG-04                       PIC X(50) VALUE          00710000
006700          'ERROR IN SELECT ''STATUS CODE'' FROM TCKRSTCNTL  '.    00720000
006800     05  PE-MSG-05                       PIC X(50) VALUE          00730000
006900          'UPDATE TO ''WORK_STRG_DESC'' ON TCKRSTINF FAILED '.    00740000
007000     05  PE-MSG-06                       PIC X(50) VALUE          00750000
007100          'PROGRAM ABENDED WHILE TRYING TO PERFORM A COMMIT '.    00760000
007200     05  PE-MSG-07                       PIC X(50) VALUE          00770000
007300          'PROGRAM MAXIMUM DEADLOCK COUNT HAS BEEN EXCEEDED'.     00780000
007400     05  PE-MSG-08                       PIC X(50) VALUE          00790000
007500          'AFTER DEADLOCK ERROR, AN UPDATE OR INSERT FAILED'.     00800000
007600     05  PE-MSG-09                       PIC X(50) VALUE          00810000
007700          'CHECKPNT RESTART FAILED UPON FIRST INSERT/UPDATE'.     00820000
007800     05  PE-MSG-10                       PIC X(50) VALUE          00830000
007900          'UPDATE OF STATUS CODE ON TCKRSTCNTL UNSUCCESSFUL'.     00840000
008000     05  PE-MSG-11                       PIC X(50) VALUE          00850000
008100          'ATTEMPT TO SELECT TIMESTAMP + CKPT_FRQNCY_QTY   '.     00860000
008200*                                                                 00870000
008300 01  PS-PROGRAM-SWITCHES.                                         00880000
008400     05  PS-INPUT-CONTROL-EOF-SW      PIC  X        VALUE 'N'.    00890003
008600         88  PS-NO-CONTROL-RECORD                   VALUE 'Y'.    00900003
008400     05  PS-INPUT-UPDATE-EOF-SW       PIC  X        VALUE 'N'.    00910003
008500         88  PS-MORE-INPUT-RECORDS                  VALUE 'N'.    00920003
008600         88  PS-NO-MORE-INPUT-RECORDS               VALUE 'Y'.    00930003
008700     05  PS-EMPTY-FILE-SW             PIC  X        VALUE 'N'.    00940000
008800         88  PS-EMPTY-INPUT-FILE                    VALUE 'Y'.    00950000
008900     05  PS-FIRST-COMMIT-SW           PIC X         VALUE 'N'.    00960000
009000         88  PS-FIRST-COMMIT                        VALUE 'Y'.    00970000
009100     05  PS-DEADLOCK-RESTART-SW       PIC X         VALUE 'N'.    00980000
009200         88  PS-PROGRAM-DEADLOCKED                  VALUE 'Y'.    00990000
009300     05  PS-PROCESSING-OPTIONS        PIC X         VALUE 'P'.    01000000
009500         88  PS-INSERT-ROW                          VALUE 'I'.    01010000
009600*                                                                 01020000
009800 01  PROGRAM-VARIABLES.                                           01030000
009900     05  PV-DEADLOCK-COUNT               PIC S9(04) VALUE +0.     01040000
010000     05  PV-PARAGRAPH-NAME               PIC  X(30) VALUE SPACES. 01050000
010100     05  PV-ABEND-MESSAGE                PIC  X(75) VALUE SPACES. 01060000
010200     05  PV-OPERATION-ATTEMPTED          PIC  X(50) VALUE SPACES. 01070000
010300     05  PV-CURRENT-TIMESTAMP            PIC  X(26) VALUE SPACES. 01080000
010400     05  PV-COMMIT-TIMESTAMP             PIC  X(26) VALUE SPACES. 01090000
010500     05  PV-SQLCODE-DISPLAY              PIC  ++++9 VALUE ZERO.   01100000
017800     05  PV-SQLERRD3                     PIC S9(09) VALUE ZERO    01110024
017900                                                    COMP-3.       01120024
019600     05  PC-CNT-VOUCHER          PIC  9(09)  VALUE ZEROS          01130024
019700                                             COMP-3.              01140024
010700*                                                                 01150000
010800 01  PA-PROGRAM-ACCUMULATORS.                                     01160000
010900     05  PA-RECORD-COUNTS.                                        01170000
011000         10  PA-INPUT-COUNT              PIC  9(9)  VALUE ZEROES. 01180000
011400         10  PA-COMMIT-COUNT             PIC  9(9)  VALUE ZEROES. 01190000
005600         10  PA-INSERT-NEW-COUNT         PIC  9(11) VALUE ZEROES. 01200015
005600         10  PA-DELETE-COUNT             PIC  9(11) VALUE ZEROES. 01210016
005600         10  PA-DELETE-ACCUM             PIC S9(11) COMP-3.       01220024
011500*                                                                 01230000
011600 01  PD-PROGRAM-DISPLAYS.                                         01240000
011700     05  PD-DEADLOCK-COUNT         PIC  9(04) VALUE 0.            01250000
011800*                                                                 01260000
       01  SAVE-AREA.                                                   01270021
012000     05  SV-DISPLAY-SEQUENCE       PIC  9(09).                    01280026
012000     05  SV-MAX-SEQUENCE-NBR       PIC S9(09).                    01290024
012000     05  SV-SEQUENCE-NBR           PIC S9(09) COMP.               01300022
013700*                                                                 01310000
013800*                                                                 01320000
014400******************************************************************01330000
014500*  DB2 ERROR MESSAGES FORMAT AREA.                                01340000
014600******************************************************************01350000
014700     COPY DPWS004.                                                01360000
014800*                                                                 01370000
014900******************************************************************01380000
015000*  USED FOR DB2 ERRORS                                            01390000
015100******************************************************************01400000
015200     EXEC SQL                                                     01410000
015300         INCLUDE SQLCA                                            01420000
015400     END-EXEC.                                                    01430000
015500*                                                                 01440000
015600******************************************************************01450000
015700*  UPT_PRD_MDM_BRG (SHADOW 1)                                     01460002
015800******************************************************************01470000
015900     EXEC SQL                                                     01480000
016000         INCLUDE UPT00000                                         01490000
016100     END-EXEC.                                                    01500000
015500*                                                                 01510000
015600******************************************************************01520002
015700*  UPT_PRD_MDM_BRG_NEW (SHADOW 2)                                 01530002
015800******************************************************************01540002
015900     EXEC SQL                                                     01550002
016000         INCLUDE UPT00002                                         01560002
016100     END-EXEC.                                                    01570002
015500*                                                                 01580002
016300***************************************************************** 01590000
016400* DB2 CHECKPOINT RESTART CONTROL TABLE AND RESTART INFO TABLE     01600000
016500***************************************************************** 01610000
016600     EXEC SQL                                                     01620000
016700         INCLUDE TCKRSTCN                                         01630000
016800     END-EXEC.                                                    01640000
016900*                                                                 01650000
017000     EXEC SQL                                                     01660000
017100         INCLUDE TCKRSTIN                                         01670000
017200     END-EXEC.                                                    01680000
017300*                                                                 01690000
017400******************************************************************01700000
017500* CHECKPOINT RESTART VARIABLES AND PREV COMMIT VARIABLES.        *01710000
017600******************************************************************01720000
017700 01  CR-CHECKPOINT-RESTART-AREA.                                  01730000
017800     05  CR-AREA-LEN                  PIC S9(04) VALUE +23 COMP.  01740013
017900     05  CR-CHECKPOINT-RESTART-VAR.                               01750000
018000         10  CR-SEQUENCE-NBR          PIC  9(11) VALUE ZEROES.    01760013
018000         10  FILLER                   PIC  X(01) VALUE SPACE.     01770013
018000         10  CR-COMMIT-COUNT          PIC  9(11) VALUE ZEROES.    01780013
019200*                                                                 01790000
D20100*                                                                 01800000
020400*                                                                 01810000
020500*-------------------*                                             01820000
020600 PROCEDURE DIVISION.                                              01830000
020700*-------------------*                                             01840000
020800                                                                  01850000
020900 0000-MAIN-MODULE.                                                01860000
021000                                                                  01870000
021100     PERFORM 1000-INITIALIZATION.                                 01880000
021200*                                                                 01890000
021300     PERFORM 2000-PROCESS-INPUT                                   01900000
021400          UNTIL PS-NO-MORE-INPUT-RECORDS.                         01910000
021500*                                                                 01920000
021600     PERFORM 8000-EOJ-ROUTINE.                                    01930000
021700                                                                  01940000
022900     CLOSE MDM-SEQUENCE-CONTROL                                   01950016
022900           MDM-BRIDGE-FILE.                                       01960016
021900*                                                                 01970016
021800     STOP RUN.                                                    01980000
022000*                                                                 01990000
022100*                                                                 02000000
022200******************************************************************02010000
022300* OPEN INPUT FILE , INITIALIZE COUNTERS , READ FIRST INPUT RECORD 02020000
022400* PREPARE CHECKPOINT RESTART TABLES FOR PROCESSING / RESTART      02030000
022500******************************************************************02040000
022600*                                                                 02050000
022700 1000-INITIALIZATION.                                             02060000
022800*                                                                 02070000
022900     OPEN INPUT MDM-SEQUENCE-CONTROL                              02080016
022900                MDM-BRIDGE-FILE.                                  02090016
023000*                                                                 02100000
           DISPLAY ' '                                                  02110032
           DISPLAY '*** PROGRAM IMKUP040 BEGINS ***'                    02120032
           DISPLAY ' '                                                  02130032
                                                                        02140032
028200     PERFORM 6000-READ-CONTROL-FILE.                              02150016
028200                                                                  02160004
028200     IF  PS-NO-CONTROL-RECORD                                     02170004
028200          DISPLAY '*************************************'         02180010
028200          DISPLAY '****** EMPTY CONTROL RECORD (SHADOW1)'         02190010
028200          DISPLAY '****** NO CHANGES WILL BE PROCESSED  '         02200011
028200          DISPLAY '*************************************'         02210011
028200     ELSE                                                         02220004
028200          MOVE INPUT-MAX-SEQUENCE TO PC-SEQUENCE-MAX              02230004
028200                                     SV-MAX-SEQUENCE-NBR          02240024
028200          DISPLAY '***************************************'       02250004
028200          DISPLAY '***MAX SEQUENCE NUMBER :', PC-SEQUENCE-MAX     02260004
028200          DISPLAY '***************************************'       02270004
028200          DISPLAY ' '                                             02280022
028200     END-IF.                                                      02290004
023200*                                                                 02300013
           MOVE ZEROES TO CR-SEQUENCE-NBR                               02310013
                          PA-INSERT-NEW-COUNT                           02320015
                          PA-DELETE-COUNT                               02330025
                          PA-DELETE-ACCUM.                              02340025
023200*                                                                 02350004
023100     PERFORM 7400-INIT-CHECKPOINT-SELECT.                         02360000
023200*                                                                 02370000
023300* CKPT-STAT-CODE = '9' INDICATES A RESTART CONDITION              02380000
023400     IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           02390000
023400         DISPLAY ' '                                              02400028
023400         DISPLAY 'PROGRAM IS IN RESTART-MODE'                     02410028
023500         PERFORM 7500-SELECT-RESTART-INFO                         02420000
023600         MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO                    02430000
023700                                 CR-CHECKPOINT-RESTART-VAR        02440010
023400         DISPLAY 'RE-STARTING AFTER SEQUENCE NBR...',             02450028
023400                                 CR-SEQUENCE-NBR                  02460028
024400     ELSE                                                         02470000
024500         SET PS-FIRST-COMMIT TO TRUE                              02480000
024600     END-IF.                                                      02490000
024700*                                                                 02500000
024800     DISPLAY ' '                                                  02510028
024800     DISPLAY 'COMMITS TAKEN EVERY ', TCKRSTCNTL-CKPT-FRQNCY-QTY,  02520028
024900             ' INPUT RECORDS...AFTER DELETES '.                   02530028
025000*                                                                 02540000
025100     PERFORM 6100-READ-BRIDGE-FILE UNTIL                          02550016
025200         UPT00002-ADB-SEQUENCE > CR-SEQUENCE-NBR                  02560005
025300      OR PS-NO-MORE-INPUT-RECORDS.                                02570000
025400*                                                                 02580000
027400*                                                                 02590000
027500******************************************************************02600000
027800*2000-PROCESS-INPUT.                                              02610024
027800*                                                                 02620024
027600* READ EXTRACT FILE FROM SHADOW 1 TABLE: UPT_PRD_MDM_BRG          02630024
027600*    INSERT RECORDS INTO SHADOW 2 TABLE: UPT_PRD_MDM_BRG_NEW      02640024
027700*    DELETE RECORDS FROM SHADOW 1 TABLE: UPT_PRD_MDM_BRG          02650024
027600*                                                                 02660024
027700* PROCESS USES CHECKPOINT RESTART LOGIC                           02670024
027700*    COMMITS WILL BE TAKEN BASED ON RECORD COUNT                  02680024
027700*    THE COMMIT FREQUENCY IS BASED ON THE CHECKPOINT RESTART TBLS 02690024
027700*                                                                 02700024
027700******************************************************************02710024
027800 2000-PROCESS-INPUT.                                              02720000
028100*                                                                 02730000
028200     PERFORM 3000-MDM-TABLE-MAINTENANCE.                          02740024
034200*                                                                 02750000
028200     PERFORM 6100-READ-BRIDGE-FILE.                               02760016
038300*                                                                 02770000
034300*                                                                 02780004
034300******************************************************************02790004
034400*                                                                 02800006
034500******************************************************************02810004
034600 3000-MDM-TABLE-MAINTENANCE.                                      02820024
028200*                                                                 02830004
028200     MOVE UPT00002-ADB-SEQUENCE  TO SV-SEQUENCE-NBR.              02840013
028200*                                                                 02850013
028200     PERFORM 5000-INSERT-MDM-BRG-NEW.                             02860016
028200                                                                  02870013
028200     PERFORM 5100-DELETE-MDM-BRG-OLD.                             02880024
034900*                                                                 02890004
034900*    FOLLOWING INSERT OF EXTRACT RECORD TO 'NEW' TABLE            02900030
034900*    ROWS WILL THEN BE DELETED FROM THE 'OLD' TABLE               02910030
034900*    FREQUENCY OF COMMITS ARE DETERMINED BY CHECKPOINT TABLE      02920030
034900*                                                                 02930030
           IF PA-DELETE-COUNT = TCKRSTCNTL-CKPT-FRQNCY-QTY              02940030
034900*                                                                 02950016
028200         PERFORM 7700-COMMIT-PROCESSING                           02960016
069100         MOVE ZEROES TO PA-DELETE-COUNT                           02970016
049600     END-IF.                                                      02980016
049600*                                                                 02990016
049700****************************************************************  03000004
049800* INSERT ROWS TO SHADOW 2 (NEW) UPT_PRD_MDM_BRG_NEW               03010016
049900*                                                                 03020013
050000***************************************************************** 03030002
050100 5000-INSERT-MDM-BRG-NEW.                                         03040016
050200*                                                                 03050002
050400     EXEC SQL                                                     03060002
050500         INSERT INTO UPT_PRD_MDM_BRG_NEW                          03070002
050600             (   ADB_SEQUENCE                                     03080002
050700               , TBL_NM                                           03090002
050800               , KY_1_TXT                                         03100002
050900               , KY_2_TXT                                         03110002
051000               , KY_3_TXT                                         03120002
051100               , KY_4_TXT                                         03130002
051200               , ADB_SUBJECT                                      03140002
051300               , ADB_SET_SEQUENCE                                 03150002
051400               , ADB_TIMESTAMP                                    03160002
051500               , ADB_OPCODE                                       03170002
051600               , ADB_UPDATE_ALL                                   03180002
051700               , ADB_REF_OBJECT                                   03190002
051800               , ADB_L_DELIVERY                                   03200002
051900               , ADB_L_CMSEQUENCE                                 03210002
052000               , ADB_TRACKINGID    )                              03220002
052100         VALUES                                                   03230002
052200             (   :UPT00002-ADB-SEQUENCE                           03240002
052300               , :UPT00002-TBL-NM                                 03250002
052400               , :UPT00002-KY-1-TXT                               03260002
052500               , :UPT00002-KY-2-TXT                               03270002
052600               , :UPT00002-KY-3-TXT                               03280002
052700               , :UPT00002-KY-4-TXT                               03290002
052800               , :UPT00002-ADB-SUBJECT                            03300002
052900               , :UPT00002-ADB-SET-SEQUENCE                       03310002
053000               , :UPT00002-ADB-TIMESTAMP                          03320002
053100               , :UPT00002-ADB-OPCODE                             03330002
053200               , :UPT00002-ADB-UPDATE-ALL                         03340002
053300               , :UPT00002-ADB-REF-OBJECT                         03350002
053400               , :UPT00002-ADB-L-DELIVERY                         03360002
053500               , :UPT00002-ADB-L-CMSEQUENCE                       03370002
053600               , :UPT00002-ADB-TRACKINGID  )                      03380002
053700     END-EXEC.                                                    03390002
053800*                                                                 03400002
053900     EVALUATE SQLCODE                                             03410002
054000         WHEN 0                                                   03420002
054300             MOVE ZERO          TO PV-DEADLOCK-COUNT              03430002
056100             ADD 1              TO PA-INSERT-NEW-COUNT            03440015
054200         WHEN -911                                                03450002
054300             ADD +1             TO PV-DEADLOCK-COUNT              03460002
054400             DISPLAY 'DEADLOCK -911 IN 5000-INSERT-MDM-BRG-NEW'   03470024
054500             IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              03480002
054600                 MOVE '5000-INSERT-MDM-BRG-NEW' TO                03490024
054700                                              PV-PARAGRAPH-NAME   03500002
054800                 PERFORM 9000-DEADLOCK-ERROR                      03510002
054900             ELSE                                                 03520002
055000                 PERFORM 7999-RESTART-PROCESS                     03530002
055100             END-IF                                               03540002
055200         WHEN OTHER                                               03550002
055300             MOVE '5000-INSERT-MDM-BRG-NEW' TO                    03560024
                                                  PV-PARAGRAPH-NAME     03570002
055400             MOVE PE-MSG-03              TO PV-OPERATION-ATTEMPTED03580002
055500             PERFORM 9999-SQL-ABEND                               03590002
055600     END-EVALUATE.                                                03600002
      *                                                                 03610016
      *                                                                 03620016
      ******************************************************************03630002
      * DELETE ROWS FROM SHADOW 1 (OLD) UPT_PRD_MDM_BRG                 03640016
      *                                                                 03650013
      ******************************************************************03660002
      *                                                                 03670013
      ** 1. THE INPUT IS SORTED IN SEQUENCE NUMBER ORDER                03680013
      ** 2. EACH RECORD CONTAINS A UNIQUE UPDATE ENTRY TABLE/KEY FIELD  03690013
      ** 3. DUPLICATE KEY ENTRIES ARE NOT SELECTED FOR MULTIPLE UPDATES 03700013
      ** 4. AFTER A SUCCESSFUL INSERT TO NEW TABLE, ORIGINAL IS DELETED 03710013
      ** 5. DUPLICATES ARE ALSO DELETED. THESE ARE <= CURRENT SEQUENCE  03720013
      *                                                                 03730013
      ******************************************************************03740013
       5100-DELETE-MDM-BRG-OLD.                                         03750016
      *                                                                 03760002
                                                                        03770002
           EXEC SQL                                                     03780002
               DELETE                                                   03790002
                  FROM UPT_PRD_MDM_BRG                                  03800002
               WHERE ADB_SEQUENCE <= :UPT00002-ADB-SEQUENCE             03810013
           END-EXEC.                                                    03820002
                                                                        03830002
           EVALUATE SQLCODE                                             03840002
               WHEN 0                                                   03850002
                   MOVE ZERO          TO PV-DEADLOCK-COUNT              03860002
                   ADD 1              TO PA-DELETE-COUNT                03870016
*********                                                               03880024
                   PERFORM 5200-DISPLAY-COUNTS                          03890028
               WHEN -911                                                03900002
                   ADD +1             TO PV-DEADLOCK-COUNT              03910002
                   DISPLAY 'DEADLOCK -911 IN 5100-DELETE-MDM-BRG-OLD'   03920016
                   IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              03930002
                       MOVE '5100-DELETE-MDM-BRG-OLD'                   03940016
                                      TO PV-PARAGRAPH-NAME              03950002
                       PERFORM 9000-DEADLOCK-ERROR                      03960002
                   ELSE                                                 03970002
                       PERFORM 7999-RESTART-PROCESS                     03980002
                   END-IF                                               03990002
               WHEN OTHER                                               04000002
                   MOVE '5100-DELETE-MDM-BRG-0LD'                       04010016
                                      TO PV-PARAGRAPH-NAME              04020002
                   MOVE PE-MSG-01     TO PV-OPERATION-ATTEMPTED         04030002
                   PERFORM 9999-SQL-ABEND                               04040002
           END-EVALUATE.                                                04050002
      *                                                                 04060002
      *                                                                 04070002
      *                                                                 04080028
      *                                                                 04090028
      ******************************************************************04100028
      *                                                                 04110028
      ******************************************************************04120028
      * DISPLAY THE TOTAL NUMBER OF ROWS DELETED IN 5100-DELETE         04130028
      * DELETES ROWS <= TO CURRENT SEQUENCE (CAN BE MULTIPLE ROWS)      04140028
      ******************************************************************04150028
       5200-DISPLAY-COUNTS.                                             04160028
      *                                                                 04170028
      *  SQLERRD CONATINS THE TOTAL # ROWS IMPACTED BY DELETE SQL       04180028
      *                                                                 04190028
            MOVE UPT00002-ADB-SEQUENCE TO SV-DISPLAY-SEQUENCE           04200028
      *                                                                 04210028
            MOVE SQLERRD(3)    TO PV-SQLERRD3                           04220028
            ADD PV-SQLERRD3    TO PA-DELETE-ACCUM                       04230028
                                                                        04240028
            DISPLAY 'NUMBER OF ROWS DELETED: ', PV-SQLERRD3,            04250028
                    ' SEQUENCE-NUMBER <= ',  SV-DISPLAY-SEQUENCE.       04260028
      *                                                                 04270028
      *                                                                 04280028
034300******************************************************************04290015
034400* READS THE MDM BRIDGE FILE INTO THE WS LAYOUT                    04300015
034500******************************************************************04310015
034600 6000-READ-CONTROL-FILE.                                          04320016
034700     READ MDM-SEQUENCE-CONTROL INTO INPUT-CONTROL-REC             04330015
034800         AT END MOVE 'Y' TO  PS-INPUT-CONTROL-EOF-SW.             04340015
034900*                                                                 04350015
      *                                                                 04360016
034300******************************************************************04370015
034400* READS THE MDM BRIDGE FILE INTO THE TUP00002 LAYOUT              04380015
034500******************************************************************04390015
034600 6100-READ-BRIDGE-FILE.                                           04400016
034700     READ MDM-BRIDGE-FILE INTO DCLUPT00002                        04410015
034800         AT END MOVE 'Y' TO PS-INPUT-UPDATE-EOF-SW.               04420015
034900*                                                                 04430015
059100*                                                                 04440000
059200******************************************************************04450000
059300* 7400-INIT-CHECKPOINT-SELECT                                    *04460000
059400* PROCESSES: SELECTS FROM THE CHECKPOINT RESTART CONTROL TABLE   *04470000
059500*            IF WE ARE IN A RESTART CONDITION.                   *04480000
059600******************************************************************04490000
059700 7400-INIT-CHECKPOINT-SELECT.                                     04500000
059800                                                                  04510000
059900     EXEC SQL                                                     04520000
060000       SELECT  CKPT_STAT_CODE                                     04530000
060100              ,CKPT_FRQNCY_QTY                                    04540000
060200         INTO  :TCKRSTCNTL-CKPT-STAT-CODE                         04550000
060300              ,:TCKRSTCNTL-CKPT-FRQNCY-QTY                        04560000
060400         FROM  TCKRSTCNTL                                         04570000
060500        WHERE  JOB_NAME  = :PC-JOB-NAME                           04580000
060600          AND  PLAN_NAME = :PC-PROGRAM-NAME                       04590000
060700     END-EXEC.                                                    04600000
060800                                                                  04610000
060900     IF SQLCODE = 0                                               04620000
061000         CONTINUE                                                 04630000
061100     ELSE                                                         04640000
061200         MOVE '7400-INIT-CHECKPOINT-SELECT' TO PV-PARAGRAPH-NAME  04650000
061300         MOVE PE-MSG-04             TO PV-OPERATION-ATTEMPTED     04660000
061400         PERFORM 9999-SQL-ABEND                                   04670000
061500     END-IF.                                                      04680000
061600*                                                                 04690000
061700*                                                                 04700000
061800******************************************************************04710000
061900* 7500-SELECT-RESTART-INFO                                       *04720000
062000* PROCESSES: SELECTS FROM THE CHECKPOINT RESTART INFORMATION     *04730000
062100*            TABLE TO OBTAIN THE PROGRAMS SAVED VARIABLES.       *04740000
062200******************************************************************04750000
062300 7500-SELECT-RESTART-INFO.                                        04760000
062400                                                                  04770000
062500     EXEC SQL                                                     04780000
062600       SELECT  WORK_STRG_DESC                                     04790000
062700         INTO  :TCKRSTINF-WORK-STRG-DESC                          04800000
062800         FROM  TCKRSTINF                                          04810000
062900        WHERE  JOB_NAME  = :PC-JOB-NAME                           04820000
063000          AND  PLAN_NAME = :PC-PROGRAM-NAME                       04830000
063100     END-EXEC.                                                    04840000
063200                                                                  04850000
063300     IF SQLCODE = 0                                               04860000
063400         CONTINUE                                                 04870000
063500     ELSE                                                         04880000
063600         MOVE '*7500-SELECT-RESTART-INFO*' TO PV-PARAGRAPH-NAME   04890000
063700         PERFORM 9999-SQL-ABEND                                   04900000
063800     END-IF.                                                      04910000
063900*                                                                 04920000
064000*                                                                 04930000
065900******************************************************************04940000
066000* 7700-COMMIT-PROCESSING.                                        *04950000
066100* PROCESSES: CHECK IF WE NEED TO TAKE A COMMIT.                  *04960000
066200*          PREPARE CHECKPOINT RECORD FOR UPDATE OF WORK_STRG_DESC*04970000
066300******************************************************************04980000
066400 7700-COMMIT-PROCESSING.                                          04990000
066500     MOVE '*7700-COMMIT-PROCESSING*'    TO PV-PARAGRAPH-NAME.     05000000
066600                                                                  05010000
068200*    MOVE COMMIT INFO TO WORKING STORAGE ROW                      05020016
           MOVE  SV-SEQUENCE-NBR TO CR-SEQUENCE-NBR.                    05030016
067100     ADD   1               TO CR-COMMIT-COUNT.                    05040016
                                                                        05050016
068300     MOVE CR-CHECKPOINT-RESTART-AREA TO                           05060016
068400                                   TCKRSTINF-WORK-STRG-DESC.      05070016
                                                                        05080016
068500     IF PS-FIRST-COMMIT                                           05090016
068600         MOVE '9' TO TCKRSTCNTL-CKPT-STAT-CODE                    05100016
068700         PERFORM 7900-UPDATE-CHECKPOINT-STATUS                    05110016
068800         MOVE 'N' TO PS-FIRST-COMMIT-SW                           05120016
068900     END-IF.                                                      05130016
069000                                                                  05140016
069000     PERFORM 7800-COMMIT-CHANGES.                                 05150016
069300*                                                                 05160000
069400*                                                                 05170000
069500******************************************************************05180000
069600* 7800-COMMIT-CHANGES.                                            05190000
069700* PROCESSES: PERFORM UPDATE OF CHECKPOINT INFORMATION TABLE.      05200000
069800*            TAKE A COMMIT.                                       05210000
069900*  ==> PERFORMED FROM: 7700-COMMIT-PROCESSING.                    05220000
070000******************************************************************05230000
070100 7800-COMMIT-CHANGES.                                             05240000
070200                                                                  05250000
070300     EXEC SQL                                                     05260000
070400       UPDATE TCKRSTINF                                           05270000
070500          SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC          05280000
070600        WHERE JOB_NAME       = :PC-JOB-NAME                       05290000
070700          AND PLAN_NAME      = :PC-PROGRAM-NAME                   05300000
070800     END-EXEC.                                                    05310000
070900                                                                  05320000
071000     IF SQLCODE = 0                                               05330000
071100         DISPLAY 'COMMIT ISSUED...COUNT ',  CR-COMMIT-COUNT       05340029
071200     ELSE                                                         05350000
071300         MOVE PE-MSG-05                  TO PV-OPERATION-ATTEMPTED05360000
071400         MOVE  '* 7800-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     05370000
071500         PERFORM 9999-SQL-ABEND                                   05380000
071600     END-IF.                                                      05390000
071700                                                                  05400000
071800     EXEC SQL                                                     05410000
071900         COMMIT                                                   05420000
072000     END-EXEC.                                                    05430000
072100                                                                  05440000
072200     IF SQLCODE = 0                                               05450000
072300         CONTINUE                                                 05460000
072400     ELSE                                                         05470000
072500         MOVE PE-MSG-06                  TO PV-OPERATION-ATTEMPTED05480000
072600         MOVE  '* 7800-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     05490000
072700         PERFORM 9999-SQL-ABEND                                   05500000
072800     END-IF.                                                      05510000
072900*                                                                 05520000
073000*                                                                 05530000
073100******************************************************************05540000
073200* 7900-UPDATE-CHECKPOINT-STATUS                                   05550000
073300* PROCESSES: UPDATES THE STATUS ON THE CHECKPOINT CONTROL TABLE   05560000
073400*                                                                 05570000
073500******************************************************************05580000
073600 7900-UPDATE-CHECKPOINT-STATUS.                                   05590000
073700                                                                  05600000
073800     EXEC SQL                                                     05610000
073900       UPDATE  TCKRSTCNTL                                         05620000
074000          SET  CKPT_STAT_CODE = :TCKRSTCNTL-CKPT-STAT-CODE        05630000
074100        WHERE  JOB_NAME  = :PC-JOB-NAME                           05640000
074200          AND  PLAN_NAME = :PC-PROGRAM-NAME                       05650000
074300     END-EXEC.                                                    05660000
074400                                                                  05670000
074500     IF SQLCODE = 0                                               05680000
074600         CONTINUE                                                 05690000
074700     ELSE                                                         05700000
074800         MOVE '7900-UPDATE-CHECKPOINT-STATUS' TO PV-PARAGRAPH-NAME05710000
074900         MOVE PE-MSG-10                  TO PV-OPERATION-ATTEMPTED05720000
075000         PERFORM 9999-SQL-ABEND                                   05730000
075100     END-IF.                                                      05740000
075200                                                                  05750000
075300     EJECT                                                        05760000
075400*                                                                 05770000
075500*                                                                 05780000
075600******************************************************************05790000
075700* PROGRAM RESTART DUE TO A DEADLOCK AGAINST TWKSCLS ROW FOR UPDATE05800000
075800*  FIND RESTART RECORD AND CKPT RESTART AT POINT OF LAST COMMIT.  05810000
075900******************************************************************05820000
076000 7999-RESTART-PROCESS.                                            05830000
076100*                                                                 05840000
076200     SET PS-PROGRAM-DEADLOCKED TO TRUE.                           05850000
076300*                                                                 05860000
076400     CLOSE MDM-BRIDGE-FILE.                                       05870004
076500*                                                                 05880000
076600     PERFORM 7500-SELECT-RESTART-INFO.                            05890000
076700*                                                                 05900000
076800     DISPLAY '**** RESTART **** '.                                05910000
076900     MOVE PV-DEADLOCK-COUNT TO PD-DEADLOCK-COUNT.                 05920000
077000     DISPLAY '** SQLCODE -911 **  ' PD-DEADLOCK-COUNT ' TIMES'.   05930000
077100*                                                                 05940000
077200*-- THIS CHECK WILL PREVENT THE FILE FROM BEING RESTARTED IN      05950000
077300*-- THE WRONG POSITION IF NO COMMITS HAVE OCCURRED AND THE        05960000
077400*-- RESTART INFORMATION IS NOT CLEARED OUT.                       05970000
077500     IF PS-FIRST-COMMIT                                           05980000
077600         INITIALIZE TCKRSTINF-WORK-STRG-DESC                      05990000
077700         DISPLAY 'NO COMMITS HAVE OCCURRED YET; RESTART FROM'     06000000
077800                ' BEGINNING'                                      06010000
077900     ELSE                                                         06020000
078000         DISPLAY 'TCKRSTINF-LAST CKPT '                           06030000
078100                  TCKRSTINF-WORK-STRG-DESC (1:104)                06040000
078200***    INFO ON LAST CHECKPOINT TAKEN IS IN                        06050000
078300***    CR-CHECKPOINT-RESTART-AREA.                                06060000
078400         MOVE TCKRSTINF-WORK-STRG-DESC TO                         06070000
078500               CR-CHECKPOINT-RESTART-AREA                         06080000
078600         DISPLAY 'CHECKPOINT RESTART INFORMATION:'                06090000
078700         DISPLAY 'SEQUENCE-NBR    ' CR-SEQUENCE-NBR               06100005
079300     END-IF.                                                      06110000
079400*                                                                 06120000
079500     OPEN INPUT MDM-BRIDGE-FILE                                   06130004
079600     MOVE ZEROES                          TO PA-INPUT-COUNT.      06140000
079700*                                                                 06150000
079800*POSITION INPUT FILE TO 1ST RECORD AFTER LAST CHECKPOINT          06160000
079900     PERFORM 6100-READ-BRIDGE-FILE                                06170016
080000         UNTIL UPT00002-ADB-SEQUENCE  > CR-SEQUENCE-NBR           06180005
080100           OR PS-NO-MORE-INPUT-RECORDS.                           06190000
081300*                                                                 06200016
080200     IF PS-NO-MORE-INPUT-RECORDS                                  06210000
080300         DISPLAY 'END OF INPUT FILE ON RESTART'                   06220000
080400     ELSE                                                         06230000
080500         DISPLAY 'INPUT RECORD RESTARTED ON RECORD '              06240000
080600                  PA-INPUT-COUNT                                  06250000
081200     END-IF.                                                      06260000
081300*                                                                 06270000
081400*RE-ESTABLISH COUNTS FOR PROCESSED INPUT (FROM CHECKPOINT RECORD) 06280000
081800     MOVE CR-COMMIT-COUNT TO PA-COMMIT-COUNT.                     06290005
081900*                                                                 06300000
082000*                                                                 06310000
082100******************************************************************06320000
082200*                                                                 06330016
082200*                                                                 06340016
082300******************************************************************06350000
082400 8000-EOJ-ROUTINE.                                                06360000
082500*                                                                 06370000
082200*  FORCE COMMIT OF INSERT/DELETES SINCE LAST CHECKPOINT COMMIT    06380016
083000     DISPLAY ' '                                                  06390016
083000     DISPLAY 'PERFORMING FINAL COMMIT         '.                  06400028
082500     PERFORM 7700-COMMIT-PROCESSING                               06410016
082500*                                                                 06420016
082500*                                                                 06430018
082200*  DELETE ALL REMAINING ROWS LESS THAN OR EQUAL TO THE MAX SEQ    06440016
028200*    MOVE SV-MAX-SEQUENCE-NBR TO SV-SEQUENCE-NBR                  06450027
083000*    MOVE SV-SEQUENCE-NBR     TO UPT00002-ADB-SEQUENCE            06460027
083000*    DISPLAY ' '                                                  06470027
083000*    DISPLAY 'DELETE ALL REMAINING ROWS <= MAX SEQUENCE'.         06480027
082500*    PERFORM 5100-DELETE-MDM-BRG-OLD                              06490027
082500*    PERFORM 7700-COMMIT-PROCESSING                               06500027
082500*                                                                 06510016
082600     MOVE '0' TO TCKRSTCNTL-CKPT-STAT-CODE.                       06520000
082700     PERFORM 7900-UPDATE-CHECKPOINT-STATUS.                       06530000
082800*                                                                 06540000
082900     DISPLAY '                                             '.     06550000
083300     DISPLAY 'INSERTS (NEW)   : ', PA-INSERT-NEW-COUNT.           06560016
083100     DISPLAY 'DELETED (OLD)   : ', PA-DELETE-ACCUM.               06570028
083400     DISPLAY '                                             '.     06580000
083600*                                                                 06590000
083800*                                                                 06600000
083900*                                                                 06610000
084000******************************************************************06620000
084100*  PERFORMED BY 6100-UPDATE AND 7200-INSERT                       06630000
084200*  THIS ROUTINE FORCES AN ABEND DUE TO A SQLCODE -911 (3 TIMES)   06640000
084300******************************************************************06650000
084400 9000-DEADLOCK-ERROR.                                             06660000
084500*                                                                 06670000
084600         MOVE PE-MSG-07             TO PV-OPERATION-ATTEMPTED     06680000
084700         PERFORM 9999-SQL-ABEND.                                  06690000
084800*                                                                 06700000
084900******************************************************************06710000
085000*  STANDARD DB2 ERROR ABEND ROUTINE                               06720000
085100*  THIS ROUTINE FORCES AN ABEND DUE TO A DB2 PROBLEM.             06730000
085200******************************************************************06740000
085300 9999-SQL-ABEND.                                                  06750000
085400                                                                  06760000
085500     MOVE +4013                 TO ABEND-CODE.                    06770000
085600     MOVE SQLCODE               TO PV-SQLCODE-DISPLAY.            06780000
085700     DISPLAY '**  ABEND     **'.                                  06790000
085800     DISPLAY '**  PROGRAM   ** => ' PC-PROGRAM-NAME.              06800000
085900     DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            06810000
086000     DISPLAY '**  OPERATION **  = ' PV-OPERATION-ATTEMPTED.       06820000
086100     DISPLAY '**  SQLCODE   **  = ' PV-SQLCODE-DISPLAY.           06830000
086200                                                                  06840000
086300     EXEC SQL                                                     06850000
086400          ROLLBACK                                                06860000
086500     END-EXEC.                                                    06870000
086600                                                                  06880000
086700*    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE         06890000
086800*    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.        06900000
086900                                                                  06910000
087000     COPY DPPD004.                                                06920000
087100     CALL 'ILBOABN0'  USING ABEND-CODE.                           06930000
