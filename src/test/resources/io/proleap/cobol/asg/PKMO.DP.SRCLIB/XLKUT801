000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.    XLKUT801.                                         00020000
000300 AUTHOR.        AYAN SARKAR.                                      00030000
000400 INSTALLATION.  KOHLS.                                            00040000
000500 DATE-WRITTEN   JAN, 2015.                                        00050000
000600 DATE-COMPILED.                                                   00060000
000700                                                                  00070000
000800******************************************************************00080000
000900* XLKUT801.   XLPO ERROR QUEUE AND DI ERROR REPORT CHECK         *00090000
000910*             AUTOMATION PROGRAM.                                *00091000
001000*                                                                *00100000
001100* PURPOSE:                                                       *00110000
001200* THIS PROGRAM REMOVES MANUAL EFFORT OF CHECKING "XLPO ERROR     *00120000
001300* QUEUE AND DI ERROR REPORT" FOR THE POS MISSING SPLITS AND      *00130000
001310* ALLOCATIONS                                                    *00131000
001400*                                                                *00140000
001500* THIS PROGRAM WILL CREATE AN OUTPUT FILE CONTAINING PO_NBR AND  *00150000
001600* WHETHER SPLITS AND/OR ALLOCATION IS REQUIRED OR NOT FOR THAT PO*00160000
002000******************************************************************00200000
002100 ENVIRONMENT DIVISION.                                            00210000
002200 CONFIGURATION SECTION.                                           00220000
002300 SOURCE-COMPUTER.        IBM-3090.                                00230000
002400 OBJECT-COMPUTER.        IBM-3090.                                00240000
002500                                                                  00250000
002600 INPUT-OUTPUT SECTION.                                            00260000
002700 FILE-CONTROL.                                                    00270000
002800                                                                  00280000
002900     SELECT IN-ERROR-FILE                 ASSIGN TO INP01.        00290000
002900     SELECT IN-MISSING-PO-FILE            ASSIGN TO INP02.        00300001
003100     SELECT OUT-PO-SPLT-ALLOC-FILE        ASSIGN TO OUT01.        00310000
003100     SELECT OUT-PO-COUNT-FILE             ASSIGN TO OUT02.        00311000
003100     SELECT OUT-MISSING-PO-FILE           ASSIGN TO OUT03.        00312000
003200                                                                  00320000
003300******************************************************************00330000
003400 DATA DIVISION.                                                   00340000
003410******************************************************************00341000
003500 FILE SECTION.                                                    00350000
003600                                                                  00360000
003700 FD  IN-ERROR-FILE                                                00370000
003800     RECORDING MODE IS F                                          00380000
003900     LABEL RECORDS ARE STANDARD                                   00390000
004000     BLOCK CONTAINS 0 RECORDS.                                    00400000
004100 01  IN-ERROR-RECORD                 PIC  X(08).                  00410004
004200                                                                  00420000
003700 FD  IN-MISSING-PO-FILE                                           00430001
003800     RECORDING MODE IS F                                          00440001
003900     LABEL RECORDS ARE STANDARD                                   00450001
004000     BLOCK CONTAINS 0 RECORDS.                                    00460001
004100 01  IN-MISSING-PO-RECORD            PIC  X(80).                  00470004
004200                                                                  00480001
004900 FD  OUT-PO-SPLT-ALLOC-FILE                                       00490000
005000     RECORDING MODE IS F                                          00500000
005100     LABEL RECORDS ARE STANDARD                                   00510000
005200     BLOCK CONTAINS 0 RECORDS.                                    00520000
005300 01  OUT-PO-SPLT-ALLOC-RECORD        PIC  X(80).                  00530000
005400                                                                  00540000
004900 FD  OUT-PO-COUNT-FILE                                            00541000
005000     RECORDING MODE IS F                                          00542000
005100     LABEL RECORDS ARE STANDARD                                   00543000
005200     BLOCK CONTAINS 0 RECORDS.                                    00544000
005300 01  OUT-PO-COUNT-RECORD             PIC  X(80).                  00545000
005400                                                                  00546000
004900 FD  OUT-MISSING-PO-FILE                                          00547000
005000     RECORDING MODE IS F                                          00548000
005100     LABEL RECORDS ARE STANDARD                                   00549000
005200     BLOCK CONTAINS 0 RECORDS.                                    00549100
005300 01  OUT-MISSING-PO-RECORD           PIC  X(80).                  00549200
005400                                                                  00549300
005500******************************************************************00550000
005700 WORKING-STORAGE SECTION.                                         00570000
005710******************************************************************00571000
005800                                                                  00580000
005900 01  PC-PROGRAM-CONSTANTS.                                        00590000
006000     05  PC-CURRENT-PROGRAM-NAME     PIC X(08) VALUE 'XLKUT801'.  00600000
006010     05  PC-END-OF-FILE              PIC X(42) VALUE              00601000
006100                                                  'END OF FILE'.  00610000
006200 01  PS-PROGRAM-SWITCHES.                                         00620000
006300     05  PS-IN-ERROR-EOF-SW          PIC X(01) VALUE 'N'.         00630000
006400         88  PS-IN-ERROR-EOF                   VALUE 'Y'.         00640000
006500         88  PS-IN-ERROR-NOT-EOF               VALUE 'N'.         00650000
006300     05  PS-MISSING-PO-SW            PIC X(01) VALUE 'N'.         00650100
006400         88  PS-MISSING-PO-EOF                 VALUE 'Y'.         00650200
006500         88  PS-MISSING-PO-NOT-EOF             VALUE 'N'.         00650300
006510     05  PS-DC-SPLIT-SW              PIC X(01) VALUE 'N'.         00651000
006520         88  PS-DC-SPLIT-YES                   VALUE 'Y'.         00652000
006530         88  PS-DC-SPLIT-NO                    VALUE 'N'.         00653000
006540     05  PS-STR-ALLOC-SW             PIC X(01) VALUE 'N'.         00654000
006550         88  PS-STR-ALLOC-YES                  VALUE 'Y'.         00655000
006560         88  PS-STR-ALLOC-NO                   VALUE 'N'.         00656000
011300     05  PS-FIRST-RECORD-SW          PIC X(01) VALUE 'N'.         00657000
010800         88  PS-FIRST-RECORD-YES               VALUE 'Y'.         00658000
010900         88  PS-FIRST-RECORD-NO                VALUE 'N'.         00659000
011300     05  PS-FIRST-PO-RECORD-SW       PIC X(01) VALUE 'N'.         00659100
010800         88  PS-FIRST-PO-RECORD-YES            VALUE 'Y'.         00659200
010900         88  PS-FIRST-PO-RECORD-NO             VALUE 'N'.         00659300
P44398     05  PS-END-OF-TABLE-SW          PIC X(01) VALUE 'N'.         00659413
P44398         88  PS-END-OF-TABLE                   VALUE 'Y'.         00659513
P44398         88  PS-NOT-END-OF-TABLE               VALUE 'N'.         00659613
P44398     05  PS-DUP-PO-SW                PIC X(01) VALUE 'N'.         00659813
P44398         88  PS-DUP-PO-YES                     VALUE 'Y'.         00659913
P44398         88  PS-DUP-PO-NO                      VALUE 'N'.         00660013
011800                                                                  00660100
006600                                                                  00661000
 06700 01  PV-PROGRAM-VARIABLES.                                        00670000
006800     05  PV-PARAGRAPH-NAME           PIC X(30) VALUE SPACES.      00680000
006900     05  PV-DB2-OPERATION-MSG        PIC X(30) VALUE SPACES.      00690000
007000     05  PV-DB2-TABLE-NAME           PIC X(18) VALUE SPACES.      00700000
007100     05  PV-SQL-CODE                 PIC +999  VALUE ZERO.        00710000
007200     05  PV-TMST                     PIC X(26) VALUE SPACES.      00720000
007201     05  PV-PO-NBR-HOLD              PIC 9(08) VALUE ZERO.        00720100
007202     05  PV-CURR-SPLIT               PIC S9(9) COMP VALUE 0.      00720200
007203     05  PV-SPLIT-DIFF               PIC S9(9) COMP VALUE 0.      00720300
007204     05  PV-CURR-ALLOC               PIC S9(9) COMP VALUE 0.      00720400
007205     05  PV-ALLOC-DIFF               PIC S9(9) COMP VALUE 0.      00720500
007210     05  PV-ERROR-INPUT.                                          00721000
007220         10  PV-ERROR-PO             PIC X(08) VALUE SPACES.      00722000
007250     05  PV-ERROR-PO-NUM             PIC 9(08) VALUE ZERO.        00725000
007260     05  PV-REC-READ-COUNT           PIC 9(09) VALUE ZERO.        00726000
007270     05  PV-REC-WRITE-COUNT          PIC 9(05) VALUE ZERO.        00727000
           05  PV-OUTPUT-LIMIT             PIC 9(09) VALUE 0.           00727217
           05  PV-MISSING-PO-COUNT         PIC 9(09) VALUE ZERO.        00727300
007280     05  PV-DISPLAY-REC              PIC Z(8)9 VALUE ZERO.        00728000
007291     05  PV-PREV-IDX                 PIC 9(09) VALUE  0.          00729100
007292     05  PV-OUTREC-HEADER.                                        00729200
007293         10  PV-HDR-1                PIC X(42) VALUE              00729300
007294             'PO-NBR,SPLT-QTY,SPLT-IND,ALOC-QTY,ALOC-IND'.        00729400
007292     05  PV-OUTREC-HEADER-PO.                                     00729500
007293         10  PV-HDR-1-PO             PIC X(36) VALUE              00729600
007294             'PO-NBR,PO-TYP,SKU-NBR,SKU-TYP,REASON'.              00729700
016600         10  FILLER                  PIC X(44) VALUE SPACES.      00729800
007300                                                                  00730000
007292     05  PV-OUTPUT-COUNT-RECORD.                                  00731000
007294         10  PV-OUTPUT-COUNT-MESSAGE PIC X(46)   VALUE            00733000
007300             "TOTAL NO OF PO'S REQUIRES SPLITS\ALLOCATIONS :".    00734000
007293         10  PV-OUTPUT-PO-COUNT      PIC Z(4)9   VALUE ZERO.      00734120
007293         10 FILLER                   PIC X(29)   VALUE SPACES.    00735000
007291                                                                  00740000
007292     05  PV-OUTPUT-PO-COUNT-RECORD.                               00740100
007294         10  PV-OUTPUT-PO-COUNT-MESSAGE PIC X(37)   VALUE         00740200
007300             "TOTAL NO OF PO'S MISSING IN LEGACY :".              00740300
007293         10  PV-PO-COUNT      PIC ZZZZ9   VALUE ZERO.             00740400
007293         10 FILLER                   PIC X(30)   VALUE SPACES.    00740500
007291                                                                  00740600
      * MATCH THE LAYOUT FROM XLKUT920 PROGRAM                          00741000
016200 01  OR-OUTPUT-PO-RECORD.                                         00750000
016300     05  OR-PO-NBR                   PIC  9(08)      VALUE ZERO.  00760000
016400     05  FILLER                      PIC  X(1)       VALUE ','.   00770000
016400     05  FILLER                      PIC  X(1)       VALUE SPACE. 00771000
016400     05  FILLER                      PIC  X(1)       VALUE ','.   00772000
016400     05  FILLER                      PIC  X(8)       VALUE SPACE. 00773000
016400     05  FILLER                      PIC  X(1)       VALUE ','.   00774000
016400     05  FILLER                      PIC  X(1)       VALUE SPACE. 00775000
016400     05  FILLER                      PIC  X(1)       VALUE ','.   00776000
016500     05  OR-PO-TEXT                  PIC  X(30)      VALUE ZERO.  00777000
016600     05  FILLER                      PIC  X(28)      VALUE SPACE. 00778000
017800                                                                  00779000
007300                                                                  00780000
      * WRITE THE MISSING PO'S FROM XLKUT920 PROGRAM TO AVOID WRITING   00781000
      * DUPLICATE PO'S INTO OUTPUT FILE                                 00782029
P44398 01  WS-MISSING-PO-TABLE.                                         00790000
P44398     05  WS-PO-TABLE     OCCURS 2500 TIMES INDEXED BY CS-IDX.     00800027
P44398         10  WS-PO-NBR                PIC  9(08).                 00810000
                                                                        00822000
008300 01  PV-ABEND-FIELDS.                                             00830000
008400     05  PV-ABEND-CODE               PIC S9(4) VALUE ZEROES       00840000
008500                                               COMP SYNC.         00850000
008600                                                                  00860000
008700*---------------------------------------------------------------* 00870000
008800*  DB2 FORMATTED MESSAGE AREA                                     00880000
008900*---------------------------------------------------------------* 00890000
009000     COPY DPWS004.                                                00900000
009100                                                                  00910000
009200*---------------------------------------------------------------* 00920000
009300*    DB2 AREA FOR TPURCHS.                                      * 00930000
009400*---------------------------------------------------------------* 00940000
009500     EXEC SQL                                                     00950000
009600          INCLUDE TPURCHS                                         00960000
009700     END-EXEC.                                                    00970000
009800                                                                  00980000
009810*---------------------------------------------------------------* 00981000
009820*    DB2 AREA FOR TALLPLN.                                      * 00982000
009830*---------------------------------------------------------------* 00983000
009840     EXEC SQL                                                     00984000
009850          INCLUDE TALLPLN                                         00985000
009860     END-EXEC.                                                    00986000
009870                                                                  00987000
009880*---------------------------------------------------------------* 00988000
009890*    DB2 AREA FOR TMESTDS.                                      * 00989000
009891*---------------------------------------------------------------* 00989100
009892     EXEC SQL                                                     00989200
009893          INCLUDE TMESTDS                                         00989300
009894     END-EXEC.                                                    00989400
009895                                                                  00989500
171410*---------------------------------------------------------------* 00989617
171410*  DB2 TABLE DECLARATION - PARM TABLE                             00989717
171410*      (TKRPRPM)                                                  00989817
171410*---------------------------------------------------------------* 00989917
171410     EXEC SQL                                                     00990017
171410          INCLUDE TKRPRPM                                         00990117
171410     END-EXEC.                                                    00990217
027000                                                                  00990317
009900*---------------------------------------------------------------* 00991000
010000*    DB2 AREA FOR COMMUNICATIONS                                * 01000000
010100*---------------------------------------------------------------* 01010000
010200     EXEC SQL                                                     01020000
010300          INCLUDE SQLCA                                           01030000
010400     END-EXEC.                                                    01040000
010500                                                                  01050000
010600** COPYBOOK OF PO SPLIT-ALLOC OUT FILE **                         01060000
010800     COPY XLRD067.                                                01080000
010900                                                                  01090000
010910******************************************************************01091000
011000 PROCEDURE DIVISION.                                              01100000
011010******************************************************************01101000
011100                                                                  01110000
011200 0000-MAINLINE-ROUTINE.                                           01120000
011300                                                                  01130000
011400     PERFORM 1000-INITIALIZATION.                                 01140000
011500                                                                  01150000
011600     SET PS-IN-ERROR-NOT-EOF       TO TRUE.                       01160000
011700                                                                  01170000
012000     PERFORM 2000-ERROR-FILE-PROCESS                              01200000
012100       UNTIL PS-IN-ERROR-EOF.                                     01210000
012200                                                                  01220000
012300     PERFORM 3000-END-PROCESSING.                                 01230000
012400                                                                  01240000
012500     STOP RUN.                                                    01250000
012600                                                                  01260000
012610******************************************************************01261000
012700 1000-INITIALIZATION.                                             01270000
012710******************************************************************01271000
012800                                                                  01280000
012900     OPEN INPUT  IN-ERROR-FILE                                    01290000
                INPUT  IN-MISSING-PO-FILE                               01300001
013100          OUTPUT OUT-PO-SPLT-ALLOC-FILE                           01310000
013100          OUTPUT OUT-PO-COUNT-FILE.                               01311000
013100     OPEN OUTPUT OUT-MISSING-PO-FILE.                             01312001
013200     INITIALIZE XL918-RECORD.                                     01320000
           SET PS-FIRST-PO-RECORD-NO TO TRUE                            01320113
           SET PS-MISSING-PO-NOT-EOF TO TRUE                            01321000
           SET CS-IDX TO 1                                              01322000
           PERFORM 8000-WRITE-INTERNAL-TABLE                            01330000
014000       UNTIL PS-MISSING-PO-EOF.                                   01400011
014120******************************************************************01412000
014130 8000-WRITE-INTERNAL-TABLE.                                       01413000
014140******************************************************************01414000
             READ IN-MISSING-PO-FILE                                    01414201
                   INTO OR-OUTPUT-PO-RECORD                             01414300
                   AT END                                               01414400
                       SET PS-MISSING-PO-EOF TO TRUE.                   01414507
                                                                        01414600
             IF PS-MISSING-PO-NOT-EOF                                   01414800
                     MOVE OR-PO-NBR TO WS-PO-NBR(CS-IDX)                01414901
                     SET CS-IDX UP BY 1                                 01415205
                     IF OR-PO-TEXT = 'PO NOT IN LEGACY'                 01415308
                       ADD +1 TO PV-MISSING-PO-COUNT                    01415408
                     END-IF                                             01415509
                     PERFORM 8300-WRITE-MISSING-PO                      01415605
            END-IF.                                                     01415700
014120******************************************************************01415800
014130 2000-ERROR-FILE-PROCESS.                                         01416000
014140******************************************************************01417000
014200     MOVE '2000-ERROR-FILE-PROCESS'   TO PV-PARAGRAPH-NAME        01420000
014210                                                                  01421000
014220     INITIALIZE XL918-RECORD                                      01422000
014300     PERFORM 4000-READ-ERROR-FILE                                 01430000
014310                                                                  01431000
014400     IF PS-IN-ERROR-EOF THEN                                      01440000
014500        CONTINUE                                                  01450000
014600     ELSE                                                         01460000
014610        MOVE PV-ERROR-PO              TO PV-ERROR-PO-NUM          01461000
014637*       DISPLAY 'PO-NBR: ' PV-ERROR-PO-NUM                        01463700
014700        PERFORM 5000-CHECK-SPLIT-ALLOCATION                       01470000
014800     END-IF.                                                      01480000
014810                                                                  01481000
014821******************************************************************01482100
014830 3000-END-PROCESSING.                                             01483000
014831******************************************************************01483100
014840                                                                  01484000
           IF PS-FIRST-RECORD-YES                                       01484100
              PERFORM 6100-WRITE-TRAILER-RECORD                         01484200
           END-IF.                                                      01484300
           IF PS-FIRST-PO-RECORD-YES OR PV-MISSING-PO-COUNT >= 1        01484410
              PERFORM 6300-WRITE-TRAILER-RECORD-PO                      01484500
           END-IF.                                                      01484600
           IF PV-REC-WRITE-COUNT >= 1                                   01484700
           MOVE PV-REC-WRITE-COUNT TO PV-OUTPUT-PO-COUNT                01484800
           WRITE OUT-PO-COUNT-RECORD FROM PV-OUTPUT-COUNT-RECORD        01485200
           END-IF.                                                      01485300
           IF PV-MISSING-PO-COUNT >= 1                                  01485400
           MOVE PV-MISSING-PO-COUNT TO PV-PO-COUNT                      01485500
           WRITE OUT-PO-COUNT-RECORD FROM PV-OUTPUT-PO-COUNT-RECORD     01485600
           END-IF.                                                      01485700
014842                                                                  01485800
014850     CLOSE IN-ERROR-FILE                                          01486000
014900           OUT-PO-SPLT-ALLOC-FILE                                 01490000
                 OUT-PO-COUNT-FILE                                      01490100
                 OUT-MISSING-PO-FILE.                                   01490200
           PERFORM 9100-GET-PARM-VALUE                                  01490317
           IF PV-REC-WRITE-COUNT >= PV-OUTPUT-LIMIT                     01490400
              MOVE 4008 TO RETURN-CODE                                  01490500
              DISPLAY ' TODAY PO DISCREPANCY COUNT IS MORE THAN 100 '   01490623
              'WHICH IS ABNORMAL,HENCE FORCE ABENDING THE JOB TO '      01490723
              'UNDERSTAND THE REASON FOR THE HUGE DISCREPANCY.CHECK '   01490823
              'WITH RMS TEAM AND UPON CONFIRMATION, RUN THE'            01490924
              'SUCCESSOR MFT JOB TO REPROCESS THE MESSAGES'             01491024
           END-IF.                                                      01491100
014901                                                                  01491200
014902     MOVE PV-REC-READ-COUNT           TO PV-DISPLAY-REC.          01491300
014903     DISPLAY 'NUMBER OF POS READ : ' PV-DISPLAY-REC.              01491400
014904     MOVE PV-REC-WRITE-COUNT          TO PV-DISPLAY-REC.          01491500
014905     DISPLAY "PO'S NEED SPLITS/ALLOCATIONS: " PV-DISPLAY-REC.     01491615
           MOVE PV-PO-COUNT  TO PV-DISPLAY-REC.                         01491726
014906     DISPLAY "TOTAL NO OF PO'S MISSING IN LEGACY : "              01491826
                                PV-DISPLAY-REC.                         01491926
014910******************************************************************01492000
015000 4000-READ-ERROR-FILE.                                            01500000
015010******************************************************************01501000
015100     MOVE '4000-READ-ERROR-FILE'      TO PV-PARAGRAPH-NAME        01510000
015110                                                                  01511000
015200     READ IN-ERROR-FILE                                           01520000
015300        INTO PV-ERROR-INPUT                                       01530000
015400        AT END                                                    01540000
015500           SET PS-IN-ERROR-EOF        TO TRUE.                    01550000
015600                                                                  01560000
015700     IF PS-IN-ERROR-EOF THEN                                      01570000
015800        CONTINUE                                                  01580000
015810     ELSE                                                         01581000
015820        ADD +1                        TO PV-REC-READ-COUNT        01582000
015900     END-IF.                                                      01590000
016000                                                                  01600000
016010******************************************************************01601000
016100 5000-CHECK-SPLIT-ALLOCATION.                                     01610000
016110******************************************************************01611000
016200     MOVE '5000-CHECK-SPLIT-ALLOCATION'                           01620000
016210                                      TO PV-PARAGRAPH-NAME        01621000
016300                                                                  01630000
018500     PERFORM 5100-CHECK-FOR-SPLIT                                 01850000
018600     IF PS-DC-SPLIT-YES                                           01860000
018700         PERFORM 5200-CHECK-FOR-ALLOC                             01870000
018800     END-IF                                                       01880000
018900                                                                  01890000
018910     IF XL918-SPLIT-REQ-YES OR XL918-ALLOC-REQ-YES                01891000
018920         MOVE PV-ERROR-PO-NUM         TO XL918-PO-NBR             01892000
019000         PERFORM 7000-WRITE-SPLIT-ALLOC-FILE                      01900000
019001     END-IF.                                                      01900100
019010                                                                  01901000
019100******************************************************************01910000
019200 5100-CHECK-FOR-SPLIT.                                            01920000
019210******************************************************************01921000
019310     MOVE '5100-CHECK-FOR-SPLIT'      TO PV-PARAGRAPH-NAME        01931000
019400     MOVE PV-ERROR-PO-NUM             TO PURCHS-PO-NBR            01940000
019500                                                                  01950000
019600     EXEC SQL                                                     01960000
019700         SELECT  A.PO_NBR                                         01970000
019800               , A.STATUS_CDE                                     01980000
019810               , A.TOT_UNT_QTY                                    01981000
019900               , SUM(B.CURR_SPLIT_QTY)                            01990000
020000               , (A.TOT_UNT_QTY - SUM(B.CURR_SPLIT_QTY))          02000000
020010           INTO  :ALLPLN-PO-NBR                                   02001000
020020               , :PURCHS-STATUS-CDE                               02002000
020021               , :PURCHS-TOT-UNT-QTY                              02002100
020030               , :PV-CURR-SPLIT                                   02003000
020040               , :PV-SPLIT-DIFF                                   02004000
020050           FROM  TPURCHS A                                        02005000
020060               , TALLPLN B                                        02006000
020070          WHERE  A.VER_STATUS_CDE = 'A'                           02007000
020080            AND  A.PO_NBR = :PURCHS-PO-NBR                        02008000
020090            AND  B.PO_NBR = A.PO_NBR                              02009000
020091          GROUP BY A.PO_NBR                                       02009100
020100                  ,A.STATUS_CDE                                   02010000
020110                  ,A.TOT_UNT_QTY                                  02011000
020200     END-EXEC.                                                    02020000
020300                                                                  02030000
020400     EVALUATE TRUE                                                02040000
020500        WHEN SQLCODE = +0                                         02050000
020600            SET PS-DC-SPLIT-YES       TO TRUE                     02060000
020700            IF PV-SPLIT-DIFF > 0 AND                              02070000
020710               PURCHS-STATUS-CDE NOT = 'CA'                       02071000
020800                SET XL918-SPLIT-REQ-YES                           02080000
020900                                      TO TRUE                     02090000
020920            ELSE                                                  02092000
020930                SET XL918-SPLIT-REQ-NO                            02093000
020940                                      TO TRUE                     02094000
021000            END-IF                                                02100000
021010                MOVE PV-CURR-SPLIT    TO XL918-CURR-SPLIT         02101000
021100        WHEN SQLCODE = +100                                       02110000
021200            SET PS-DC-SPLIT-NO        TO TRUE                     02120000
021300            PERFORM 5110-CHECK-PO-EXISTS-SPLITS                   02130000
021400        WHEN OTHER                                                02140000
021500            MOVE 'TPURCHS & TALLPLN'  TO PV-DB2-TABLE-NAME        02150000
021600            MOVE SQLCODE              TO PV-SQL-CODE              02160000
021700            MOVE 'ERROR ON SELECT'    TO PV-DB2-OPERATION-MSG     02170000
021800            PERFORM 9999-ABEND-ROUTINE                            02180000
021900     END-EVALUATE.                                                02190000
022000                                                                  02200000
022001******************************************************************02200100
022010 5110-CHECK-PO-EXISTS-SPLITS.                                     02201000
022011******************************************************************02201100
022012     MOVE '5110-CHECK-PO-EXISTS-SPLITS'                           02201200
022020                                      TO PV-PARAGRAPH-NAME        02202000
022021                                                                  02202100
022022     EXEC SQL                                                     02202200
022023         SELECT A.PO_NBR                                          02202300
022030               ,A.STATUS_CDE                                      02203000
022031           INTO :PURCHS-PO-NBR                                    02203100
022032               ,:PURCHS-STATUS-CDE                                02203200
022040           FROM TPURCHS A                                         02204000
022050          WHERE A.PO_NBR = :PURCHS-PO-NBR                         02205000
022060            AND A.VER_STATUS_CDE = 'A'                            02206000
022070            AND NOT EXISTS (SELECT 1                              02207000
022080                              FROM TALLPLN B                      02208000
022100                             WHERE B.PO_NBR = A.PO_NBR)           02210000
022110     END-EXEC.                                                    02211000
022130                                                                  02213000
022140     EVALUATE TRUE                                                02214000
022150        WHEN SQLCODE = +0                                         02215000
022170            IF PURCHS-STATUS-CDE NOT = 'CA'                       02217000
022190                SET XL918-SPLIT-REQ-YES                           02219000
022191                                      TO TRUE                     02219100
022192                SET XL918-ALLOC-REQ-YES                           02219200
022193                                      TO TRUE                     02219300
022194            END-IF                                                02219400
022195        WHEN SQLCODE = +100                                       02219500
022196            DISPLAY 'PO ' PV-ERROR-PO-NUM ' MISSING IN LEGACY'    02219623
022202            PERFORM 8100-WRITE-MISSING-PO                         02219700
022198        WHEN OTHER                                                02219800
022199            MOVE 'TPURCHS & TALLPLN'  TO PV-DB2-TABLE-NAME        02219900
022200            MOVE SQLCODE              TO PV-SQL-CODE              02220000
022201            MOVE 'ERROR ON SELECT'    TO PV-DB2-OPERATION-MSG     02220100
022202            PERFORM 9999-ABEND-ROUTINE                            02220200
022203     END-EVALUATE.                                                02220300
022204                                                                  02220400
022205******************************************************************02220500
022206 5200-CHECK-FOR-ALLOC.                                            02220600
022207******************************************************************02220700
022208     MOVE '5200-CHECK-FOR-ALLOC'      TO PV-PARAGRAPH-NAME        02220800
022209     MOVE PV-ERROR-PO-NUM             TO PURCHS-PO-NBR            02220900
022210                                                                  02221000
022211     EXEC SQL                                                     02221100
022212         SELECT  A.PO_NBR                                         02221200
022213               , A.STATUS_CDE                                     02221300
022214               , A.TOT_UNT_QTY                                    02221400
022215               , SUM(B.STR_DISTRO_QTY)                            02221500
022216               , (A.TOT_UNT_QTY - SUM(B.STR_DISTRO_QTY))          02221600
022217           INTO  :MESTDS-PO-NBR                                   02221700
022218               , :PURCHS-STATUS-CDE                               02221800
022219               , :PURCHS-TOT-UNT-QTY                              02221900
022220               , :PV-CURR-ALLOC                                   02222000
022221               , :PV-ALLOC-DIFF                                   02222100
022222           FROM  TPURCHS A                                        02222200
022223               , TMESTDS B                                        02222300
022224          WHERE  A.VER_STATUS_CDE = 'A'                           02222400
022225            AND  A.PO_NBR = :PURCHS-PO-NBR                        02222500
022226            AND  B.PO_NBR = A.PO_NBR                              02222600
022227          GROUP BY A.PO_NBR                                       02222700
022228                  ,A.STATUS_CDE                                   02222800
022229                  ,A.TOT_UNT_QTY                                  02222900
022230     END-EXEC.                                                    02223000
022231                                                                  02223100
022232     EVALUATE TRUE                                                02223200
022233        WHEN SQLCODE = +0                                         02223300
022234            SET PS-STR-ALLOC-YES      TO TRUE                     02223400
022235            IF PV-ALLOC-DIFF > 0 AND                              02223500
022236               PURCHS-STATUS-CDE NOT = 'CA'                       02223600
022237                SET XL918-ALLOC-REQ-YES                           02223700
022238                                      TO TRUE                     02223800
022240            ELSE                                                  02224000
022241                SET XL918-ALLOC-REQ-NO                            02224100
022242                                      TO TRUE                     02224200
022243            END-IF                                                02224300
022244                MOVE PV-CURR-ALLOC    TO XL918-CURR-ALLOC         02224400
022245        WHEN SQLCODE = +100                                       02224500
022246            SET PS-DC-SPLIT-NO        TO TRUE                     02224600
022247            PERFORM 5210-CHECK-PO-EXISTS-ALLOCS                   02224700
022248        WHEN OTHER                                                02224800
022249            MOVE 'TPURCHS & TMESTDS'  TO PV-DB2-TABLE-NAME        02224900
022250            MOVE SQLCODE              TO PV-SQL-CODE              02225000
022251            MOVE 'ERROR ON SELECT'    TO PV-DB2-OPERATION-MSG     02225100
022252            PERFORM 9999-ABEND-ROUTINE                            02225200
022253     END-EVALUATE.                                                02225300
022254                                                                  02225400
022255******************************************************************02225500
022256 5210-CHECK-PO-EXISTS-ALLOCS.                                     02225600
022257******************************************************************02225700
022258     MOVE '5210-CHECK-PO-EXISTS-ALLOCS'                           02225800
022259                                      TO PV-PARAGRAPH-NAME        02225900
022260                                                                  02226000
022261     EXEC SQL                                                     02226100
022262         SELECT A.PO_NBR                                          02226200
022263               ,A.STATUS_CDE                                      02226300
022264           INTO :PURCHS-PO-NBR                                    02226400
022265               ,:PURCHS-STATUS-CDE                                02226500
022266           FROM TPURCHS A                                         02226600
022267          WHERE A.PO_NBR = :PURCHS-PO-NBR                         02226700
022268            AND A.VER_STATUS_CDE = 'A'                            02226800
022269            AND NOT EXISTS (SELECT 1                              02226900
022270                              FROM TMESTDS B                      02227000
022271                             WHERE B.PO_NBR = A.PO_NBR)           02227100
022272     END-EXEC.                                                    02227200
022273                                                                  02227300
022274     EVALUATE TRUE                                                02227400
022275        WHEN SQLCODE = +0                                         02227500
022276            IF PURCHS-STATUS-CDE NOT = 'CA'                       02227600
022277                SET XL918-ALLOC-REQ-YES                           02227700
022278                                      TO TRUE                     02227800
022279            END-IF                                                02227900
022280        WHEN SQLCODE = +100                                       02228000
022281            DISPLAY 'PO ' PV-ERROR-PO-NUM ' MISSING IN LEGACY'    02228123
022286            PERFORM 8100-WRITE-MISSING-PO                         02228200
022282        WHEN OTHER                                                02228300
022283            MOVE 'TPURCHS & TMESTDS'  TO PV-DB2-TABLE-NAME        02228400
022284            MOVE SQLCODE              TO PV-SQL-CODE              02228500
022285            MOVE 'ERROR ON SELECT'    TO PV-DB2-OPERATION-MSG     02228600
022286            PERFORM 9999-ABEND-ROUTINE                            02228700
022287     END-EVALUATE.                                                02228800
022288                                                                  02228900
022289******************************************************************02229000
022290 7000-WRITE-SPLIT-ALLOC-FILE.                                     02229100
022291******************************************************************02229200
           IF PS-FIRST-RECORD-NO                                        02229300
              SET PS-FIRST-RECORD-YES TO TRUE                           02229400
              PERFORM 6000-WRITE-HEADER-RECORD                          02229500
           END-IF.                                                      02229600
022292     WRITE OUT-PO-SPLT-ALLOC-RECORD FROM XL918-RECORD.            02229700
022293     ADD +1                           TO PV-REC-WRITE-COUNT.      02229800
022295                                                                  02229900
022290 8100-WRITE-MISSING-PO.                                           02230200
              PERFORM 8200-DUPLICATE-PO-CHECK                           02230400
              IF PS-DUP-PO-NO                                           02230500
                 IF PS-FIRST-PO-RECORD-NO AND PV-MISSING-PO-COUNT = 0   02230621
                   SET PS-FIRST-PO-RECORD-YES TO TRUE                   02230700
                   PERFORM 6200-WRITE-HEADER-RECORD-PO                  02230800
                 END-IF                                                 02230900
              INITIALIZE OR-OUTPUT-PO-RECORD                            02231008
              MOVE PV-ERROR-PO TO OR-PO-NBR                             02231100
              MOVE 'PO NOT IN LEGACY' TO OR-PO-TEXT                     02231200
022292        WRITE OUT-MISSING-PO-RECORD FROM OR-OUTPUT-PO-RECORD      02231302
022293        ADD +1                      TO PV-MISSING-PO-COUNT        02231400
              END-IF.                                                   02231500
022290 8300-WRITE-MISSING-PO.                                           02231601
                 IF PS-FIRST-PO-RECORD-NO                               02231712
                   SET PS-FIRST-PO-RECORD-YES TO TRUE                   02231808
                   PERFORM 6200-WRITE-HEADER-RECORD-PO                  02231908
                 END-IF.                                                02232013
022292        WRITE OUT-MISSING-PO-RECORD FROM IN-MISSING-PO-RECORD.    02232416
022295                                                                  02232701
       8200-DUPLICATE-PO-CHECK.                                         02232801
            SET PS-NOT-END-OF-TABLE TO TRUE                             02232901
            SET PS-DUP-PO-NO TO TRUE                                    02233001
            SET CS-IDX TO 1                                             02233101
            SEARCH WS-PO-TABLE                                          02233201
                AT END                                                  02233301
                   SET PS-END-OF-TABLE TO TRUE                          02233401
                WHEN WS-PO-NBR(CS-IDX) = PV-ERROR-PO                    02233501
                   SET PS-DUP-PO-YES TO TRUE                            02233601
            END-SEARCH.                                                 02233701
                                                                        02233801
       6000-WRITE-HEADER-RECORD.                                        02233901
014111     WRITE OUT-PO-SPLT-ALLOC-RECORD FROM PV-OUTREC-HEADER.        02234001
                                                                        02234101
       6200-WRITE-HEADER-RECORD-PO.                                     02234201
014111     WRITE OUT-MISSING-PO-RECORD    FROM PV-OUTREC-HEADER-PO.     02234301
                                                                        02234401
       6100-WRITE-TRAILER-RECORD.                                       02234501
014841     WRITE OUT-PO-SPLT-ALLOC-RECORD FROM PC-END-OF-FILE.          02234601
       6300-WRITE-TRAILER-RECORD-PO.                                    02234701
014841     WRITE OUT-MISSING-PO-RECORD    FROM PC-END-OF-FILE.          02234801
022300*SQL ABEND ROUTINE                                                02235001
171410******************************************************************02236017
171410* 9100-GET-PARM-VALUE.                                           *02237017
171410*  RETRIEVE THE PO LIM VALUE FROM THE PARM TABLE.                *02238017
171410******************************************************************02239017
171410 9100-GET-PARM-VALUE.                                             02239117
171410                                                                  02239217
171410     MOVE ZERO    TO KRPRPM-FUNC-QTY.                             02239317
171410                                                                  02239417
171410     EXEC SQL                                                     02239517
171410          SELECT FUNC_QTY                                         02239617
171410            INTO :KRPRPM-FUNC-QTY                                 02239717
171410            FROM TKRPRPM                                          02239817
171410           WHERE LOC_ID            = 90                           02239917
171410             AND SYS_PRC_FUNC_CDE  = 'XLPO'                       02240022
171410             AND INTFC_SYS_CDE     = 'KHL'                        02240117
171410             AND FUNC_PRC_STAT_CDE = 'AC'                         02240217
171410             AND (CURRENT_DATE BETWEEN DATE(FUNC_BEG_TMST)        02240317
171410                                   AND DATE(FUNC_END_TMST))       02240417
171410           WITH UR                                                02240517
171410     END-EXEC.                                                    02240617
171410                                                                  02240717
171410     EVALUATE TRUE                                                02240817
171410         WHEN SQLCODE = ZERO                                      02240917
171410         WHEN SQLCODE = +100                                      02241017
171410              MOVE KRPRPM-FUNC-QTY  TO PV-OUTPUT-LIMIT            02241117
171410                                                                  02241517
171410         WHEN SQLWARN0 NOT = SPACES                               02241617
171410         WHEN SQLCODE NOT = ZERO                                  02241717
171410         WHEN SQLCODE NOT = +100                                  02241817
171410         WHEN SQLCODE NOT = -811                                  02241917
057600              MOVE '9100-GET-PARM-VALUE'                          02242017
057700                                 TO PV-PARAGRAPH-NAME             02242117
057800              MOVE 'SELECT ON TKRPRPM'                            02242219
057900                                 TO PV-DB2-OPERATION-MSG          02242319
058000              MOVE 'TKRPRPM'     TO PV-DB2-TABLE-NAME             02242417
058100              PERFORM 9999-ABEND-ROUTINE                          02242518
171410     END-EVALUATE.                                                02242617
022400******************************************************************02243000
022500 9999-ABEND-ROUTINE.                                              02250000
022600                                                                  02260000
022700     DISPLAY '** ABEND     **'.                                   02270000
022800     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        02280000
022900     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              02290000
022910     DISPLAY '** SQLCODE   ** = ' PV-SQL-CODE.                    02291000
023000     DISPLAY '** TABLES    ** = ' PV-DB2-TABLE-NAME.              02300000
023010     DISPLAY '** PO-NBR    ** = ' PV-ERROR-PO-NUM                 02301000
023100     DISPLAY '** MESSAGE   ** = ' PV-DB2-OPERATION-MSG.           02310000
023500******************************************************************02350000
023600* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     02360000
023700* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      02370000
023800******************************************************************02380000
023900     COPY DPPD004.                                                02390000
024000     MOVE +4018                       TO PV-ABEND-CODE.           02400000
024100     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         02410000
024200                                                                  02420000
