000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.         APKUT246.                                    00020000
000300 AUTHOR.             CHRIS BOEHNLEIN.                             00030000
000400 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00040000
000500 DATE-WRITTEN.       04-21-98.                                    00050000
000600                                                                  00060000
000610******************************************************************00061000
000620* COBOL II WITH SQL                                              *00062000
000630*----------------------------------------------------------------*00063000
000640* CREATE MONTHLY DETAIL IMPORT REPORTS                           *00064000
000650*----------------------------------------------------------------*00065000
000660* THIS PROGRAM PERFORMS DB2 CALLS AGAINST THE LEGACY SYSTEM TO   *00066000
000670* DETERMINE WHAT ENTRIES WERE MADE FOR THE IMPORT PURCHASE       *00067000
000680* ORDERS FROM THE ADJUSTMENT JOURNAL FOR THE PREVIOUS FISCAL     *00068000
000681* MONTH.  THIS PROGRAM FOCUSES SPECIFICALLY ON ACCOUNT 10301.    *00068100
000690*----------------------------------------------------------------*00069000
000691* DB2 TABLES:                                                    *00069100
000692*  1. INVOICE TABLE                             (TINVOIC)        *00069200
000693*  2. AP CHARGE TYPE TABLE                      (TACCTYP)        *00069300
000694*  3. VENDOR/DEPARTMENT TABLE                   (TVNDDPT)        *00069400
000695*  4. PURCHASE ORDER HEADER TABLE               (TPURCHS)        *00069500
000696*  5. EXTERNAL EXTERPRISE TABLE                 (TEXTENT)        *00069600
000697*  6. AP PAYMENT CONTROL TABLE                  (TAPCNTL)        *00069700
000698*  7. INVOICE CHARGE/ALLOWANCE TABLE            (TALCHRG)        *00069800
000699*                                                                *00069900
000700* INPUT:                                                         *00070000
000701*  1. DETAIL IMPORT FILE                        (APRD047)        *00070100
000702*  2. DETAIL ACCOUNT IMPORT FILE                (APRD047)        *00070200
000703*                                                                *00070300
000704* OUTPUT:                                                        *00070400
000705*  1. IMPORT PURCHASE ORDERS FILE                                *00070500
000706*----------------------------------------------------------------*00070600
000707* PROGRAM CHANGES:                                               *00070700
000708*                                                                *00070800
000709* DATE 08/2005                                                   *00070901
000710*   CHANGE MADE: INITIAL IMPLEMENTATION                          *00071001
000714*   MADE BY: KRYSTEN LEARY                WR/IR: WR24554         *00071400
000715*                                                                 00071508
000716* DATE 09/2018                                                   *00071608
000717*   CHANGE MADE: REMOVE COPYBOOK PJRNLEXT. REPLACE REFERENCE     *00071708
000718*                TO PJR-DETAIL-PONUM WITH PV-DISPLAY-PONUM IN    *00071808
000719*                PARAGRAPH S800-READ-DUNNS-NBR                   *00071908
000720*   MADE BY: GERMAN BANDA                    WR/IR: CHG0209715   *00072009
000721******************************************************************00072100
000722                                                                  00072200
000730 ENVIRONMENT DIVISION.                                            00073000
000800 CONFIGURATION SECTION.                                           00080000
000900 SOURCE-COMPUTER.    IBM-3090.                                    00090000
001000 OBJECT-COMPUTER.    IBM-3090.                                    00100000
001100                                                                  00110000
001200 INPUT-OUTPUT SECTION.                                            00120000
001300 FILE-CONTROL.                                                    00130000
001400                                                                  00140000
001500     SELECT DETAIL-IMPORT-FILE-PJ        ASSIGN TO INP01.         00150000
001700     SELECT DETAIL-ACCT-IMPORT-FILE-PJ   ASSIGN TO INP02.         00170000
001900     SELECT WORK-REPORT-FILE             ASSIGN TO OUT01.         00190000
002100                                                                  00210000
002200 DATA DIVISION.                                                   00220000
002400 FILE SECTION.                                                    00240000
002500                                                                  00250000
002600 FD  DETAIL-IMPORT-FILE-PJ                                        00260000
002700     RECORDING MODE IS F                                          00270000
002800     LABEL RECORDS ARE STANDARD                                   00280000
002900     RECORD CONTAINS 170 CHARACTERS                               00290000
003000     BLOCK CONTAINS 0  RECORDS                                    00300000
003100     DATA RECORD IS DR-DETAIL-IMPORT-RECORD-PJ.                   00310000
003200 01  DR-IMPORT-RECORD-PJ           PIC X(170).                    00320000
003300                                                                  00330000
003400 FD  DETAIL-ACCT-IMPORT-FILE-PJ                                   00340000
003500     RECORDING MODE IS F                                          00350000
003600     LABEL RECORDS ARE STANDARD                                   00360000
003700     RECORD CONTAINS 170 CHARACTERS                               00370000
003800     BLOCK CONTAINS 0  RECORDS                                    00380000
003900     DATA RECORD IS DR-ACCT-IMPORT-RECORD-PJ.                     00390000
004000 01  DR-ACCT-IMPORT-RECORD-PJ      PIC X(170).                    00400000
004100                                                                  00410000
004200 FD  WORK-REPORT-FILE                                             00420000
004300     RECORDING MODE IS F                                          00430000
004400     LABEL RECORDS ARE STANDARD                                   00440000
004500     RECORD CONTAINS 168 CHARACTERS                               00450000
004600     BLOCK CONTAINS 0  RECORDS                                    00460000
004700     DATA RECORD IS WR-WORK-REPORT-RECORD.                        00470000
004800 01  WR-WORK-REPORT-RECORD         PIC X(168).                    00480000
004900                                                                  00490000
005100 WORKING-STORAGE SECTION.                                         00510000
005200*----------------------------------------------------------------*00520000
005210* GL EXTRACT FILE PAYOUT (INPUT)                                 *00521000
005220*----------------------------------------------------------------*00522000
005300     COPY APRD047.                                                00530000
005401                                                                  00540100
005410*----------------------------------------------------------------*00541000
005420* WORKING STORAGE FOR DATE ROUTINE                               *00542000
005430*----------------------------------------------------------------*00543000
005500     COPY DPWS500.                                                00550000
005501                                                                  00550100
005510*----------------------------------------------------------------*00551000
005520* SQLCA FORMATTED MESSAGE AREA                                   *00552000
005530*----------------------------------------------------------------*00553000
005600     COPY DPWS004.                                                00560000
005601                                                                  00560100
005610*----------------------------------------------------------------*00561000
005620* DB2 COMMUNICATIONS                                             *00562000
005630*----------------------------------------------------------------*00563000
005640     COPY SQLCA2.                                                 00564000
005800                                                                  00580000
005950 01  PROGRAM-CONSTANTS.                                           00595000
005960     05  PC-PROGRAM-NAME         PIC X(08)   VALUE 'APKUT246'.    00596000
005970     05  PC-MAX-RETRIES          PIC 9(02)   VALUE 3.             00597000
005980                                                                  00598000
005990 01  PROGRAM-COUNTERS.                                            00599000
006000     05  PV-ACCT-READ-CNT        PIC 9(08)   VALUE ZERO.          00600000
006100     05  PV-IMPORT-READ-CNT      PIC 9(08)   VALUE ZERO.          00610000
006200     05  PV-WRITTEN-CNT          PIC 9(02)   VALUE ZERO.          00620000
006300                                                                  00630000
006400 01  PROGRAM-SWITCHES.                                            00640000
006500     05  END-OF-FILE-IMPORT-PJ   PIC X(01)   VALUE 'N'.           00650000
006600         88 END-OF-FILE-IMPORT               VALUE 'Y'.           00660000
006700     05  PS-MORE-TINVOIC         PIC X(01)   VALUE 'N'.           00670000
006800         88 PS-NO-MORE-TINVOIC               VALUE 'Y'.           00680000
006900     05  END-OF-FILE-NO-ACCT     PIC X(01)   VALUE 'N'.           00690000
007000         88 END-OF-FILE-ACCT                 VALUE 'Y'.           00700000
007100                                                                  00710000
014100 01  PROGRAM-VARIABLES.                                           01410000
014200     05  PV-RETRY-COUNTER        PIC 9(02)   VALUE ZEROS.         01420000
014300     05  PV-FIRST-FISCAL-DATE    PIC X(10)   VALUE SPACES.        01430000
014400     05  PV-LAST-FISCAL-DATE     PIC X(10)   VALUE SPACES.        01440000
014410     05  PV-DISPLAY-PONUM        PIC X(09)   VALUE SPACES.        01441008
014500                                                                  01450000
016500 01  ACCOUNT-TABLE.                                               01650000
016600     05 ACCT-TABLE OCCURS 100000 TIMES INDEXED BY X1.             01660000
016700        10 ACCT-PO               PIC X(09)   VALUE SPACES.        01670000
016800        10 ACCT-DATE             PIC X(10)   VALUE SPACES.        01680000
017100                                                                  01710000
018100 01 WS-WORKING-STORAGE.                                           01810000
018200    05  WS-DB2-ACCOUNT.                                           01820000
018400        10  WS-DB2-ACCT          PIC X(05)    VALUE SPACES.       01840000
018500    05  WS-DB2-ACCOUNT2          PIC X(07)    VALUE SPACES.       01850000
018600    05  WS-DETAIL-PONUM          PIC 9(09)    VALUE ZERO.         01860000
019000    05  WS-DUNNS-NUMBER          PIC X(9)     VALUE SPACES.       01900000
019100    05  WS-DT-PONUM              PIC S9(9)    COMP.               01910000
019200    05  WS-DM-TOTAL              PIC S9(11)V99 COMP-3 VALUE ZERO. 01920000
019400    05  WS-CM-TOTAL              PIC S9(11)V99 VALUE ZERO COMP-3. 01940000
020100    05  WS-JN-DATE               PIC X(10)    VALUE SPACES.       02010000
020200    05  WS-HD-PO                 PIC 9(09)    VALUE ZEROS.        02020000
020800    05  WS-HD-DATE               PIC X(10)    VALUE SPACES.       02080000
021500    05  WS-INVOIC-PO-NBR         PIC S9(9)    COMP.               02150000
021600    05  WS-HOLD-ACCT             PIC X(06)    VALUE SPACES.       02160000
021610    05  WS-REQ-ENTR-TRMNL-ID     PIC X(04)    VALUE SPACES.       02161000
021700                                                                  02170000
023500 01 DH-DETAIL-LINE1.                                              02350000
023600    05  FILLER                   PIC X(02)    VALUE SPACES.       02360000
023700    05  DH-ACCOUNT               PIC X(07)    VALUE SPACES.       02370000
023800    05  FILLER                   PIC X(02)    VALUE SPACES.       02380000
023900    05  DH-PO-DUNNS              PIC X(09)    VALUE SPACES.       02390000
024000    05  FILLER                   PIC X(02)    VALUE SPACES.       02400000
024100    05  DH-PO-NUMBER             PIC X(10)    VALUE SPACES.       02410000
024200    05  FILLER                   PIC X(04)    VALUE SPACES.       02420000
024300    05  DH-PO-INV                PIC X(16)    VALUE SPACES.       02430000
024400    05  FILLER                   PIC X(04)    VALUE SPACES.       02440000
024500    05  DH-PJ-SOURCE             PIC X(02)    VALUE SPACES.       02450000
024800    05  FILLER                   PIC X(02)    VALUE SPACES.       02480000
024900    05  DH-DEBIT-TOTAL           PIC ---,---,---.99.              02490000
025000    05  FILLER                   PIC X(02)    VALUE SPACES.       02500000
025100    05  DH-DM-MONTH              PIC 9(02)    VALUE ZEROS.        02510000
025200    05  FILLER                   PIC X(01)    VALUE '-'.          02520000
025300    05  DH-DM-DAY                PIC 9(02)    VALUE ZEROS.        02530000
025400    05  FILLER                   PIC X(01)    VALUE '-'.          02540000
025500    05  DH-DM-YEAR               PIC 9(02)    VALUE ZEROS.        02550000
025600    05  FILLER                   PIC X(06)    VALUE SPACES.       02560000
025700    05  DH-CREDIT-TOTAL          PIC ---,---,---.99.              02570000
025800    05  FILLER                   PIC X(03)    VALUE SPACES.       02580000
025900    05  DH-CM-MONTH              PIC 9(02)    VALUE ZEROS.        02590000
026000    05  FILLER                   PIC X(01)    VALUE '-'.          02600000
026100    05  DH-CM-DAY                PIC 9(02)    VALUE ZEROS.        02610000
026200    05  FILLER                   PIC X(01)    VALUE '-'.          02620000
026300    05  DH-CM-YEAR               PIC 9(02)    VALUE ZEROS.        02630000
026400    05  FILLER                   PIC X(05)    VALUE SPACES.       02640000
026500    05  DH-JN-MONTH              PIC 9(02)    VALUE ZEROS.        02650000
026600    05  FILLER                   PIC X(01)    VALUE '-'.          02660000
026700    05  DH-JN-DAY                PIC 9(02)    VALUE ZEROS.        02670000
026800    05  FILLER                   PIC X(01)    VALUE '-'.          02680000
026900    05  DH-JN-YEAR               PIC 9(02)    VALUE ZEROS.        02690000
027000    05  FILLER                   PIC X(02)    VALUE SPACES.       02700000
027100    05  DH-INV                   PIC ---,---,---.99.              02710000
027200    05  FILLER                   PIC X(02)    VALUE SPACES.       02720000
027300    05  DH-PPR                   PIC ---,---,---.99.              02730000
027400                                                                  02740000
028502*----------------------------------------------------------------*02850200
028503* ABEND CODE AREA                                                *02850300
028504*----------------------------------------------------------------*02850400
028510 01  ABEND-CODE                  PIC S9(04)   VALUE ZERO.         02851000
028520     88  AC-BAD-DATA                          VALUE +4003.        02852000
028530     88  AC-DB2-ERROR                         VALUE +4013.        02853000
028540                                                                  02854000
028550 01  ABEND-AREAS.                                                 02855000
028560     05  AA-ABEND-LIT            PIC X(40)    VALUE               02856000
028570           '*****       ABEND'.                                   02857000
028580     05  AA-PROGRAM-LIT          PIC X(40)    VALUE               02858000
028590             '*****   PROGRAM:         '.                         02859000
028591     05  AA-PARAGRAPH-LIT.                                        02859100
028592         10  FILLER              PIC X(17)    VALUE               02859200
028593             '***** PARAGRAPH: '.                                 02859300
028594         10  AA-PARAGRAPH-NAME   PIC X(35)    VALUE SPACES.       02859400
028595     05  AA-MESSAGE-LINE.                                         02859500
028596         10  FILLER              PIC X(06)    VALUE '*****'.      02859600
028597         10  AA-MESSAGE          PIC X(127)   VALUE SPACES.       02859700
028598     05  AA-DB2-ERROR-LIT        PIC X(40)    VALUE               02859800
028599             '*****    DB2 ERROR'.                                02859900
028600     05  AA-DB2-OPERATION-LIT.                                    02860000
028601         10  FILLER              PIC X(17)    VALUE               02860100
028602             '***** OPERATION: '.                                 02860200
028603         10  AA-DB2-OPERATION.                                    02860300
028604             15  AA-DB2-OP-1     PIC X(25)    VALUE SPACES.       02860400
028605             15  AA-DB2-OP-2     PIC X(25)    VALUE SPACES.       02860500
028606     05  AA-DB2-TABLE-1          PIC X(08)    VALUE SPACES.       02860600
028607     05  AA-DB2-TABLE-2          PIC X(08)    VALUE SPACES.       02860700
028608     05  AA-DB2-TABLE-3          PIC X(08)    VALUE SPACES.       02860800
028609     05  AA-DB2-TABLE-4          PIC X(08)    VALUE SPACES.       02860900
028610                                                                  02861000
028611*----------------------------------------------------------------*02861100
028612* EXTERNAL ENTERPRISE TABLE                                      *02861200
028613*----------------------------------------------------------------*02861300
028614     EXEC SQL                                                     02861400
028620        INCLUDE TEXTENT                                           02862000
028630     END-EXEC.                                                    02863000
028640                                                                  02864000
028641*----------------------------------------------------------------*02864100
028642* AP PAYMENT CONTROL TABLE                                       *02864200
028643*----------------------------------------------------------------*02864300
028644     EXEC SQL                                                     02864400
028645        INCLUDE TAPCNTL                                           02864500
028646     END-EXEC.                                                    02864600
028647                                                                  02864700
028648*----------------------------------------------------------------*02864800
028649* PURCHASE ORDER HEADER TABLE                                    *02864900
028650*----------------------------------------------------------------*02865000
028651     EXEC SQL                                                     02865100
028660        INCLUDE TPURCHS                                           02866000
028670     END-EXEC.                                                    02867000
028680                                                                  02868000
028681*----------------------------------------------------------------*02868100
028682* INVOICE TABLE                                                  *02868200
028683*----------------------------------------------------------------*02868300
028698     EXEC SQL                                                     02869800
028699        INCLUDE TINVOIC                                           02869900
028700     END-EXEC.                                                    02870000
028701                                                                  02870100
028702*----------------------------------------------------------------*02870200
028703* INVOICE CHARGES/ALLOWANCES TABLE                               *02870300
028704*----------------------------------------------------------------*02870400
028705     EXEC SQL                                                     02870500
028706        INCLUDE TALCHRG                                           02870600
028707     END-EXEC.                                                    02870700
028708                                                                  02870800
028709*----------------------------------------------------------------*02870900
028710* AP CHARGE TYPE TABLE                                           *02871000
028711*----------------------------------------------------------------*02871100
028712     EXEC SQL                                                     02871200
028713        INCLUDE TACCTYP                                           02871300
028714     END-EXEC.                                                    02871400
028715                                                                  02871500
028720*----------------------------------------------------------------*02872000
028721* VENDOR/DEPARTMENT TABLE                                        *02872100
028722*----------------------------------------------------------------*02872200
028723     EXEC SQL                                                     02872300
028724        INCLUDE TVNDDPT                                           02872400
028725     END-EXEC.                                                    02872500
028726                                                                  02872600
028727*----------------------------------------------------------------*02872700
028728* DB2 COMMUNICATIONS                                             *02872800
028729*----------------------------------------------------------------*02872900
028734     EXEC SQL                                                     02873400
028735        INCLUDE SQLCA                                             02873500
028736     END-EXEC.                                                    02873600
028737                                                                  02873700
028740*----------------------------------------------------------------*02874000
028800* CURSOR DECLARATION                                             *02880000
028900*----------------------------------------------------------------*02890000
029000     EXEC SQL                                                     02900000
029100         DECLARE INVOICE_CSR CURSOR FOR                           02910000
029200              SELECT                                              02920000
029300                   I.PO_NBR                                       02930000
029400                  ,A.ALW_CHRG_AMT                                 02940000
029500                  ,'      '                                       02950000
029600                  ,I.INVC_ID                                      02960000
029700                  ,I.PPD_RVRSL_IND                                02970000
029800              FROM TINVOIC I                                      02980000
029900                  ,TALCHRG A                                      02990000
030000                  ,TACCTYP T                                      03000000
030100              WHERE I.PO_NBR = A.PO_NBR                           03010000
030300                AND I.INVC_ID = A.INVC_ID                         03030000
030400                AND A.ALW_CHRG_CDE = T.ALW_CHRG_CDE               03040000
030500                AND I.INVC_TYP_CDE = 'EI'                         03050000
030600                AND I.STATUS_CDE ^= 'DE'                          03060000
030610                AND I.STATUS_CDE ^= 'PR'                          03061000
030700                AND I.CRE_DTE >= :PV-FIRST-FISCAL-DATE            03070007
030800                AND I.CRE_DTE <= :PV-LAST-FISCAL-DATE             03080007
030900                AND T.GL_ACCT_NBR = :WS-DB2-ACCOUNT2              03090000
031000              ORDER BY I.PO_NBR                                   03100000
031100     END-EXEC.                                                    03110000
031200                                                                  03120000
031300*--------------------------*                                      03130000
031400 PROCEDURE DIVISION.                                              03140000
031500*--------------------------*                                      03150000
031600 0000-MAINLINE-PROCESSING.                                        03160000
031700                                                                  03170000
031800     PERFORM B100-INITIALIZATION.                                 03180000
031900     PERFORM B200-PROCESS-EXTRACT                                 03190000
032000             UNTIL END-OF-FILE-IMPORT AND                         03200000
032100                   PS-NO-MORE-TINVOIC.                            03210000
032110     PERFORM B300-TERMINATION.                                    03211000
032600     STOP RUN.                                                    03260000
032610                                                                  03261000
032700*----------------------------------------------------------------*03270000
032710* INITIALIZATION PROCESSING                                      *03271000
032720*----------------------------------------------------------------*03272000
032800 B100-INITIALIZATION.                                             03280000
032900                                                                  03290000
033000     OPEN INPUT  DETAIL-IMPORT-FILE-PJ                            03300000
033100                 DETAIL-ACCT-IMPORT-FILE-PJ                       03310000
033200          OUTPUT WORK-REPORT-FILE.                                03320000
033300                                                                  03330000
033400     INITIALIZE DCLTEXTENT                                        03340000
033410                DCLTVNDDPT                                        03341000
033420                DCLTPURCHS                                        03342000
033430                DCLTINVOIC                                        03343000
033450                DCLTACCTYP                                        03345000
033460                DCLTAPCNTL                                        03346000
033461                DCLTALCHRG.                                       03346100
033470                                                                  03347000
033490     PERFORM S100-SELECT-PREV-FISCAL-DATA.                        03349007
033491     PERFORM S200-GET-FIRST-LAST-FISCAL-DT.                       03349107
033500     PERFORM S300-GET-ACCT-IMPORT-DATA.                           03350000
033700     PERFORM R100-READ-IMPORT-FILE-PJ.                            03370000
033900     MOVE AP047-GL-ACCT-NBR  TO WS-HOLD-ACCT.                     03390000
034000     MOVE WS-HOLD-ACCT       TO WS-DB2-ACCT.                      03400000
035300     MOVE WS-DB2-ACCOUNT     TO WS-DB2-ACCOUNT2.                  03530000
035400     PERFORM Y100-OPEN-INVOICE-CSR.                               03540000
035500     PERFORM S400-FETCH-INVOICE-CSR.                              03550000
035600                                                                  03560000
035610*----------------------------------------------------------------*03561000
035620* THIS ROUTINE HOLDS THE MAIN LOGIC FOR PROCESSING THE OUTPUT    *03562000
035630*----------------------------------------------------------------*03563000
035700 B200-PROCESS-EXTRACT.                                            03570000
035800                                                                  03580000
035900     EVALUATE TRUE                                                03590000
036000     WHEN INVOIC-PO-NBR = WS-DETAIL-PONUM                         03600000
036100        INITIALIZE DH-DETAIL-LINE1                                03610000
036200        MOVE INVOIC-PO-NBR              TO WS-DT-PONUM            03620000
036300        PERFORM S800-READ-DUNNS-NBR                               03630000
036400        MOVE WS-DUNNS-NUMBER            TO DH-PO-DUNNS            03640000
036500        MOVE INVOIC-INVC-ID             TO DH-PO-INV              03650000
036600        MOVE INVOIC-GRO-COST-AMT        TO DH-INV                 03660000
036700        MOVE WS-HOLD-ACCT               TO DH-ACCOUNT             03670000
036800        MOVE INVOIC-PO-NBR              TO DH-PO-NUMBER           03680000
037000        PERFORM W100-WRITE-WORK-REPORT-FILE                       03700000
037100        MOVE ZEROS                      TO DH-INV                 03710000
037300        IF AP047-AP-TRN-CDE = '68' OR '73'                        03730000
037600           MOVE AP047-GRO-COST-AMT      TO DH-DEBIT-TOTAL         03760000
037700           ADD AP047-GRO-COST-AMT       TO WS-DM-TOTAL            03770000
037800        ELSE                                                      03780000
037900           MOVE INVOIC-PO-NBR           TO WS-INVOIC-PO-NBR       03790000
038110           IF INVOIC-PPD-RVRSL-IND = 'Y'                          03811000
038120              MOVE AP047-GRO-COST-AMT   TO DH-PPR                 03812000
038130           END-IF                                                 03813000
038400           MOVE AP047-GRO-COST-AMT      TO DH-CREDIT-TOTAL        03840000
038500           ADD AP047-GRO-COST-AMT       TO WS-CM-TOTAL            03850000
038600        END-IF                                                    03860000
038700        PERFORM S500-GET-DATE-ACTUAL                              03870000
038900        IF AP047-GL-ACCT-NBR NOT EQUAL '10301 '                   03890000
039000           PERFORM S600-GET-JRNL-DATE                             03900000
039100        END-IF                                                    03910000
039400        MOVE AP047-AP-TRN-CDE           TO DH-PJ-SOURCE           03940000
039500        PERFORM W100-WRITE-WORK-REPORT-FILE                       03950000
039600        PERFORM R100-READ-IMPORT-FILE-PJ                          03960000
039700        PERFORM S400-FETCH-INVOICE-CSR                            03970000
039800      WHEN INVOIC-PO-NBR > WS-DETAIL-PONUM                        03980000
039900        INITIALIZE DH-DETAIL-LINE1                                03990000
040100        IF AP047-ENT-NME-DESC (1:9) = SPACES                      04010000
040200           MOVE ZEROS                   TO DH-PO-NUMBER           04020000
040300         ELSE                                                     04030000
040400           MOVE WS-DETAIL-PONUM         TO DH-PO-NUMBER           04040000
040500        END-IF                                                    04050000
040700        IF AP047-GL-ACCT-NBR NOT EQUAL '10301 '                   04070000
040800           PERFORM S600-GET-JRNL-DATE                             04080000
040900        END-IF                                                    04090000
041000        PERFORM S500-GET-DATE-ACTUAL                              04100000
041400        MOVE AP047-DOC-NBR              TO DH-PO-INV              04140000
041500        MOVE AP047-AP-TRN-CDE           TO DH-PJ-SOURCE           04150000
041600        MOVE WS-HOLD-ACCT               TO DH-ACCOUNT             04160000
041800        IF AP047-AP-TRN-CDE = '68' OR '73'                        04180000
042100           MOVE AP047-GRO-COST-AMT      TO DH-DEBIT-TOTAL         04210000
042200           ADD AP047-GRO-COST-AMT       TO WS-DM-TOTAL            04220000
042300        ELSE                                                      04230000
042400           MOVE WS-DETAIL-PONUM         TO WS-INVOIC-PO-NBR       04240000
042610           IF INVOIC-PPD-RVRSL-IND = 'Y'                          04261000
042620              MOVE AP047-GRO-COST-AMT   TO DH-PPR                 04262000
042630           END-IF                                                 04263000
042900           MOVE AP047-GRO-COST-AMT      TO DH-CREDIT-TOTAL        04290000
043000           ADD AP047-GRO-COST-AMT       TO WS-CM-TOTAL            04300000
043100        END-IF                                                    04310000
043300        MOVE AP047-ENT-NME-DESC (1:9)   TO WS-DT-PONUM            04330000
043400        PERFORM S800-READ-DUNNS-NBR                               04340000
043500        MOVE WS-DUNNS-NUMBER            TO DH-PO-DUNNS            04350000
043600        PERFORM W100-WRITE-WORK-REPORT-FILE                       04360000
043700        PERFORM R100-READ-IMPORT-FILE-PJ                          04370000
043800      WHEN INVOIC-PO-NBR < WS-DETAIL-PONUM                        04380000
043900        MOVE INVOIC-PO-NBR              TO WS-DT-PONUM            04390000
044000        INITIALIZE DH-DETAIL-LINE1                                04400000
044100        PERFORM S800-READ-DUNNS-NBR                               04410000
044200        MOVE WS-DUNNS-NUMBER            TO DH-PO-DUNNS            04420000
044300        MOVE INVOIC-INVC-ID             TO DH-PO-INV              04430000
044400        MOVE INVOIC-PO-NBR              TO DH-PO-NUMBER           04440000
044500        MOVE WS-HOLD-ACCT               TO DH-ACCOUNT             04450000
044700        MOVE INVOIC-GRO-COST-AMT        TO DH-INV                 04470000
044800        MOVE INVOIC-PO-NBR              TO WS-INVOIC-PO-NBR       04480000
045010        IF INVOIC-PPD-RVRSL-IND = 'Y'                             04501000
045020           MOVE INVOIC-GRO-COST-AMT     TO DH-PPR                 04502000
045030        END-IF                                                    04503000
045100        PERFORM W100-WRITE-WORK-REPORT-FILE                       04510000
045200        PERFORM S400-FETCH-INVOICE-CSR                            04520000
045300      END-EVALUATE.                                               04530000
045400                                                                  04540000
045500*----------------------------------------------------------------*04550000
045600* END OF PROGRAM PROCESSING                                      *04560000
045700*----------------------------------------------------------------*04570000
045800 B300-TERMINATION.                                                04580000
045900                                                                  04590000
046000      DISPLAY '***********************************************'.  04600000
046100      DISPLAY '**            APKUT246 RECORD COUNTS         **'.  04610000
046200      DISPLAY '***********************************************'.  04620000
046300      DISPLAY 'TOTAL IMPORT RECORDS READ = ' PV-IMPORT-READ-CNT.  04630000
046400      DISPLAY 'TOTAL ACCT RECORDS READ   = ' PV-ACCT-READ-CNT.    04640000
046500      DISPLAY 'TOTAL RECORDS WRITTEN     = ' PV-WRITTEN-CNT.      04650000
046600      DISPLAY '***********************************************'.  04660000
046700      DISPLAY '***********************************************'.  04670000
046800                                                                  04680000
046900      PERFORM Y200-CLOSE-INVOICE-CSR.                             04690000
047000      CLOSE DETAIL-IMPORT-FILE-PJ                                 04700000
047100            DETAIL-ACCT-IMPORT-FILE-PJ                            04710000
047200            WORK-REPORT-FILE.                                     04720000
047300                                                                  04730000
058710*----------------------------------------------------------------*05871000
058720* READS THE INPUT FILE                                           *05872000
058730*----------------------------------------------------------------*05873000
058800 R100-READ-IMPORT-FILE-PJ.                                        05880000
058900                                                                  05890000
059100     READ DETAIL-IMPORT-FILE-PJ INTO AP047-GL-EXTRACT-FILE        05910000
059200          AT END                                                  05920000
059300             SET END-OF-FILE-IMPORT  TO TRUE                      05930000
059400             MOVE '9999999'          TO AP047-ENT-NME-DESC (1:9)  05940000
059500          NOT AT END                                              05950000
059600             ADD 1                   TO PV-IMPORT-READ-CNT.       05960000
059610                                                                  05961000
059700     MOVE AP047-ENT-NME-DESC (1:9)   TO WS-DETAIL-PONUM.          05970000
059900     IF END-OF-FILE-IMPORT                                        05990000
060000        MOVE 999999999               TO WS-DETAIL-PONUM           06000000
060100     END-IF.                                                      06010000
060200                                                                  06020000
060201*----------------------------------------------------------------*06020100
060202* READS THE INPUT FILE CONTAINING ACCOUNT DATA                   *06020200
060203*----------------------------------------------------------------*06020300
060204 R200-READ-ACCT-IMPORT-FILE.                                      06020400
060205                                                                  06020500
060206     READ DETAIL-ACCT-IMPORT-FILE-PJ INTO AP047-GL-EXTRACT-FILE   06020600
060207          AT END                                                  06020700
060208             SET END-OF-FILE-ACCT    TO TRUE                      06020800
060209          NOT AT END                                              06020900
060210             ADD 1                   TO PV-ACCT-READ-CNT.         06021000
060211                                                                  06021100
060212     MOVE AP047-ENT-NME-DESC (1:9)   TO ACCT-PO (X1).             06021200
060213     MOVE AP047-ENT-NME-DESC (10:10) TO ACCT-DATE (X1).           06021300
060214                                                                  06021400
060215*----------------------------------------------------------------*06021500
060216* SELECT THE PREVIOUS FISCAL PERIOD AND YEAR FROM THE TAPCNTL    *06021600
060217* TABLE                                                          *06021700
060218*----------------------------------------------------------------*06021800
060219 S100-SELECT-PREV-FISCAL-DATA.                                    06021900
060220                                                                  06022000
060221     EXEC SQL                                                     06022100
060222        SELECT PREV_PSTG_FYR_NBR                                  06022200
060223             , PREV_PSTG_FMN_NBR                                  06022300
060224          INTO :APCNTL-PREV-PSTG-FYR-NBR                          06022400
060225             , :APCNTL-PREV-PSTG-FMN-NBR                          06022500
060226          FROM TAPCNTL                                            06022600
060227     END-EXEC.                                                    06022700
060228                                                                  06022800
060229     EVALUATE TRUE                                                06022900
060230       WHEN SQLCODE = ZERO                                        06023000
060231         CONTINUE                                                 06023100
060232       WHEN SQLWARN0 NOT = SPACES                                 06023200
060233       WHEN SQLCODE NOT = ZERO                                    06023300
060234         MOVE 'S100-SELECT-PREV-FISCAL-DATA'                      06023400
060235                                         TO AA-PARAGRAPH-NAME     06023500
060236         MOVE 'UNSUCCESSFUL SELECT'      TO AA-DB2-OPERATION      06023600
060237         MOVE 'TAPCNTL'                  TO AA-DB2-TABLE-1        06023700
060238         MOVE SPACES                     TO AA-DB2-TABLE-2        06023800
060239                                            AA-DB2-TABLE-3        06023900
060240                                            AA-DB2-TABLE-4        06024000
060241         PERFORM Z999-DB2-ABEND                                   06024100
060242     END-EVALUATE.                                                06024200
060243                                                                  06024300
060244*----------------------------------------------------------------*06024400
060245* USE THE KOHLS CALENDAR ROUTINE TO GET THE FIRST AND LAST       *06024500
060246* FISCAL DATE OF THE PREVIOUS PERIOD                             *06024600
060247*----------------------------------------------------------------*06024700
060248 S200-GET-FIRST-LAST-FISCAL-DT.                                   06024800
060249                                                                  06024900
060250     INITIALIZE DPG51, DPG52, DPG53, DPG54, DPG55, DPG56.         06025000
060251                                                                  06025100
060252     SET DPG51-FISCAL-454-CALENDAR     TO TRUE.                   06025200
060253     SET DPG52-LK-DTE-FISC-PRD-CC      TO TRUE.                   06025300
060255     MOVE APCNTL-PREV-PSTG-FYR-NBR     TO DPG52-FISCAL-CC-PRD-YR. 06025500
060256     MOVE APCNTL-PREV-PSTG-FMN-NBR     TO DPG52-FISCAL-CC-PRD-PP. 06025600
060257                                                                  06025700
060258     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    06025800
060259                                             DPG54 DPG55 DPG56.   06025900
060260                                                                  06026000
060261     IF DPG54-NO-ERROR                                            06026100
060262        DISPLAY 'PERIOD START DATE: ' DPG56-FIRST-FP-DB2-ISO-FMT  06026200
060263        DISPLAY 'PERIOD END DATE: ' DPG56-LAST-FP-DB2-ISO-FMT     06026300
060264        MOVE DPG56-FIRST-FP-DB2-ISO-FMT TO PV-FIRST-FISCAL-DATE   06026400
060265        MOVE DPG56-LAST-FP-DB2-ISO-FMT  TO PV-LAST-FISCAL-DATE    06026500
060266     ELSE                                                         06026600
060267        MOVE 'S200-GET-FIRST-LAST-FISCAL-DT'                      06026700
060268                                        TO AA-PARAGRAPH-NAME      06026800
060269        MOVE DPG54-ERROR-MESSAGE        TO AA-MESSAGE             06026900
060270        SET AC-BAD-DATA                 TO TRUE                   06027000
060271        PERFORM Z999-DB2-ABEND                                    06027100
060272     END-IF.                                                      06027200
060273                                                                  06027300
060274*----------------------------------------------------------------*06027400
060275* STORES THE ACCOUNT IMPORT DATA INTO INTERNAL TABLE             *06027500
060276*----------------------------------------------------------------*06027600
060277 S300-GET-ACCT-IMPORT-DATA.                                       06027700
060278                                                                  06027800
060279     SET X1 TO 1.                                                 06027900
060280     PERFORM R200-READ-ACCT-IMPORT-FILE                           06028000
060281             VARYING X1 FROM 1 BY 1                               06028100
060282             UNTIL END-OF-FILE-ACCT.                              06028200
060284     MOVE WS-HD-PO         TO ACCT-PO (X1).                       06028400
060285     MOVE WS-HD-DATE       TO ACCT-DATE (X1).                     06028500
060290     INITIALIZE AP047-GL-EXTRACT-FILE.                            06029000
060300                                                                  06030000
065310*----------------------------------------------------------------*06531000
065320* FETCHES THE INVOICE_CSR                                        *06532000
065330*----------------------------------------------------------------*06533000
065400 S400-FETCH-INVOICE-CSR.                                          06540000
065500                                                                  06550000
066100     PERFORM WITH TEST AFTER                                      06610000
066200        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      06620000
066300        UNTIL   PV-RETRY-COUNTER > PC-MAX-RETRIES OR              06630000
066400                SQLCODE = ZERO OR                                 06640000
066500                SQLCODE = +100                                    06650000
066600        EXEC SQL                                                  06660000
066700           FETCH INVOICE_CSR                                      06670000
066800               INTO   :INVOIC-PO-NBR                              06680000
067000                    , :INVOIC-GRO-COST-AMT                        06700000
067100                    , :WS-REQ-ENTR-TRMNL-ID                       06710000
067200                    , :INVOIC-INVC-ID                             06720000
067210                    , :INVOIC-PPD-RVRSL-IND                       06721000
067300        END-EXEC                                                  06730000
067400        DISPLAY INVOIC-PO-NBR ' '                                 06740000
067500                INVOIC-GRO-COST-AMT ' '                           06750000
067600                WS-REQ-ENTR-TRMNL-ID ' '                          06760000
067700                INVOIC-INVC-ID ' '                                06770000
067800                                                                  06780000
067900        EVALUATE TRUE                                             06790000
068000            WHEN SQLCODE = ZERO                                   06800000
068100            WHEN SQLCODE = -904                                   06810000
068200            WHEN SQLCODE = -913                                   06820000
068300                 CONTINUE                                         06830000
068400            WHEN SQLCODE = +100                                   06840000
068500                 SET PS-NO-MORE-TINVOIC   TO TRUE                 06850000
068600                 MOVE 999999999           TO INVOIC-PO-NBR        06860000
068700            WHEN SQLWARN0 NOT = SPACES                            06870000
068800            WHEN SQLCODE  NOT = ZERO                              06880000
068900                 MOVE 'S400-FETCH-INVOICE-CSR'                    06890000
069000                                           TO AA-PARAGRAPH-NAME   06900000
069100                 MOVE 'UNSUCCESSFUL FETCH' TO AA-DB2-OPERATION    06910000
069300                 MOVE 'TINVOIC'            TO AA-DB2-TABLE-1      06930000
069400                 MOVE 'TALCHRG'            TO AA-DB2-TABLE-2      06940000
069410                 MOVE 'TACCTYP'            TO AA-DB2-TABLE-3      06941000
069420                 MOVE SPACES               TO AA-DB2-TABLE-4      06942000
069500                 PERFORM Z999-DB2-ABEND                           06950000
069600        END-EVALUATE                                              06960000
069700     END-PERFORM.                                                 06970000
069800                                                                  06980000
069900     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         06990000
070000         MOVE 'S400-FETCH-INVOICE-CSR'    TO AA-PARAGRAPH-NAME    07000000
070200         MOVE 'MAX RETRIES EXCEEDED ON FETCH TINVOIC'             07020000
070300                                          TO AA-DB2-OPERATION     07030000
070400         PERFORM Z999-DB2-ABEND                                   07040000
070500     END-IF.                                                      07050000
070600                                                                  07060000
070700     EVALUATE TRUE                                                07070000
070800        WHEN SQLCODE = ZEROS                                      07080000
070900        WHEN SQLCODE = +100                                       07090000
071000             CONTINUE                                             07100000
071100        WHEN OTHER                                                07110000
071200             MOVE 'S400-FETCH-INVOICE-CSR' TO AA-PARAGRAPH-NAME   07120000
071400             MOVE 'UNSUCCESSFUL FETCH'     TO AA-DB2-OPERATION    07140000
071600             MOVE 'TINVOIC'                TO AA-DB2-TABLE-1      07160000
071700             MOVE 'TALCHRG'                TO AA-DB2-TABLE-2      07170000
071710             MOVE 'TACCTYP'                TO AA-DB2-TABLE-3      07171000
071720             MOVE SPACES                   TO AA-DB2-TABLE-4      07172000
071800             PERFORM Z999-DB2-ABEND                               07180000
071900     END-EVALUATE.                                                07190000
072000                                                                  07200000
072001*----------------------------------------------------------------*07200100
072002* GET DEBIT, CREDIT, OR JOURNAL DATE                             *07200200
072003*----------------------------------------------------------------*07200300
072004 S500-GET-DATE-ACTUAL.                                            07200400
072005                                                                  07200500
072006     IF AP047-AP-TRN-CDE = '68' OR '73'                           07200600
072007        MOVE AP047-ENT-NME-DESC(15:2)    TO DH-DM-MONTH           07200700
072008        MOVE AP047-ENT-NME-DESC(18:2)    TO DH-DM-DAY             07200800
072009        MOVE AP047-ENT-NME-DESC(12:2)    TO DH-DM-YEAR            07200900
072010        IF AP047-GL-ACCT-NBR = '10301 '                           07201000
072011           MOVE AP047-ENT-NME-DESC(15:2) TO DH-JN-MONTH           07201100
072012           MOVE AP047-ENT-NME-DESC(18:2) TO DH-JN-DAY             07201200
072013           MOVE AP047-ENT-NME-DESC(12:2) TO DH-JN-YEAR            07201300
072014        END-IF                                                    07201400
072015     ELSE                                                         07201500
072016        MOVE AP047-ENT-NME-DESC(15:2)    TO DH-CM-MONTH           07201600
072017        MOVE AP047-ENT-NME-DESC(18:2)    TO DH-CM-DAY             07201700
072018        MOVE AP047-ENT-NME-DESC(12:2)    TO DH-CM-YEAR            07201800
072019     END-IF.                                                      07201900
072020                                                                  07202000
072021*----------------------------------------------------------------*07202100
072022* GET THE JOURNAL DATE                                           *07202200
072023*----------------------------------------------------------------*07202300
072024 S600-GET-JRNL-DATE.                                              07202400
072025                                                                  07202500
072026     PERFORM S700-SEARCH-ACCT-TABLE.                              07202600
072027     MOVE WS-JN-DATE (6:2)        TO DH-JN-MONTH.                 07202700
072028     MOVE WS-JN-DATE (9:2)        TO DH-JN-DAY.                   07202800
072029     MOVE WS-JN-DATE (3:2)        TO DH-JN-YEAR.                  07202900
072030                                                                  07203000
072031*----------------------------------------------------------------*07203100
072032* SEARCHES THE INTERNAL ACCOUNT TABLE                            *07203200
072033*----------------------------------------------------------------*07203300
072034 S700-SEARCH-ACCT-TABLE.                                          07203400
072035                                                                  07203500
072036     SET X1 TO 1.                                                 07203600
072037     SEARCH ACCT-TABLE                                            07203700
072038         AT END                                                   07203800
072039            MOVE '0000-00-00'    TO WS-JN-DATE                    07203900
072040         WHEN AP047-ENT-NME-DESC (1:9) = ACCT-PO(X1)              07204000
072041             MOVE ACCT-DATE(X1)  TO  WS-JN-DATE                   07204100
072042     END-SEARCH.                                                  07204200
072043                                                                  07204300
072044*----------------------------------------------------------------*07204400
072045* GET THE DUNN NUMBER FROM THE TVNDDPT, TPURCHS, AND TEXTENT     *07204500
072046* TABLES                                                         *07204600
072047*----------------------------------------------------------------*07204700
072048 S800-READ-DUNNS-NBR.                                             07204800
072049                                                                  07204900
072054     EXEC SQL                                                     07205400
072055        SELECT C.DUN_NBR                                          07205500
072056        INTO :WS-DUNNS-NUMBER                                     07205600
072057        FROM TVNDDPT A,                                           07205700
072058             TPURCHS B,                                           07205800
072059             TEXTENT C                                            07205900
072060        WHERE  A.ENT_ID = B.ENT_ID                                07206000
072061          AND  B.ENT_ID = C.ENT_ID                                07206100
072062          AND  B.PO_NBR = :WS-DT-PONUM                            07206200
072063          AND  VER_STATUS_CDE = 'A'                               07206300
072064          AND  A.DEPT_NBR = B.DEPT_NBR                            07206400
072065     END-EXEC.                                                    07206500
072066                                                                  07206600
072067     EVALUATE TRUE                                                07206700
072068         WHEN SQLCODE = ZERO                                      07206800
072069              CONTINUE                                            07206900
072070         WHEN SQLCODE = +100                                      07207000
072071              CONTINUE                                            07207100
072072         WHEN SQLWARN0 NOT = SPACES                               07207200
072073         WHEN SQLCODE  NOT = ZERO                                 07207300
072075             MOVE WS-DT-PONUM  TO PV-DISPLAY-PONUM                07207508
072076             DISPLAY 'WS-DT-PONUM ' PV-DISPLAY-PONUM              07207608
072077             MOVE 'S800-READ-DUNNS-NBR'   TO AA-PARAGRAPH-NAME    07207700
072078             MOVE 'UNSUCCESSFUL SELECT'   TO AA-DB2-OPERATION     07207800
072079             MOVE 'TVNDDPT'               TO AA-DB2-TABLE-1       07207900
072080             MOVE 'TPURCHS'               TO AA-DB2-TABLE-2       07208000
072081             MOVE 'TEXTENT'               TO AA-DB2-TABLE-3       07208100
072082             MOVE SPACES                  TO AA-DB2-TABLE-4       07208200
072083             PERFORM Z999-DB2-ABEND                               07208300
072084     END-EVALUATE.                                                07208400
072085                                                                  07208500
072086*----------------------------------------------------------------*07208600
072087* WRITE RECORD TO EXTRACT FILE                                   *07208700
072088*----------------------------------------------------------------*07208800
072089 W100-WRITE-WORK-REPORT-FILE.                                     07208900
072090                                                                  07209000
072091     WRITE WR-WORK-REPORT-RECORD FROM DH-DETAIL-LINE1 AFTER 1.    07209100
072092     ADD 1                       TO PV-WRITTEN-CNT.               07209200
072093                                                                  07209300
072100*----------------------------------------------------------------*07210000
072101* OPENS THE INVOICE_CSR                                          *07210100
072102*----------------------------------------------------------------*07210200
072110 Y100-OPEN-INVOICE-CSR.                                           07211000
072200                                                                  07220000
072300     PERFORM WITH TEST AFTER                                      07230000
072400        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      07240000
072500        UNTIL   PV-RETRY-COUNTER > PC-MAX-RETRIES OR              07250000
072600                SQLCODE = ZERO                                    07260000
072700        EXEC SQL                                                  07270000
072800            OPEN INVOICE_CSR                                      07280000
072900        END-EXEC                                                  07290000
073000                                                                  07300000
073100        EVALUATE TRUE                                             07310000
073200            WHEN SQLCODE = ZERO                                   07320000
073300            WHEN SQLCODE = -904                                   07330000
073400            WHEN SQLCODE = -913                                   07340000
073500                 CONTINUE                                         07350000
073600            WHEN SQLWARN0 NOT = SPACES                            07360000
073700            WHEN SQLCODE  NOT = ZERO                              07370000
073800                 MOVE 'Y100-OPEN-INVOICE-CSR' TO AA-PARAGRAPH-NAME07380000
074000                 MOVE 'UNSUCCESSFUL OPEN'     TO AA-DB2-OPERATION 07400000
074200                 MOVE 'TINVOIC'               TO AA-DB2-TABLE-1   07420000
074300                 MOVE 'TALCHRG'               TO AA-DB2-TABLE-2   07430000
074310                 MOVE 'TACCTYP'               TO AA-DB2-TABLE-3   07431000
074320                 MOVE SPACES                  TO AA-DB2-TABLE-4   07432000
074400                 PERFORM Z999-DB2-ABEND                           07440000
074500        END-EVALUATE                                              07450000
074600     END-PERFORM.                                                 07460000
074700                                                                  07470000
074800     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         07480000
074900         MOVE 'Y100-OPEN-INVOICE-CSR' TO AA-PARAGRAPH-NAME        07490000
075100         MOVE 'MAX RETRIES EXCEEDED ON OPEN TINVOIC'              07510000
075200                                      TO AA-DB2-OPERATION         07520000
075300         PERFORM Z999-DB2-ABEND                                   07530000
075400     END-IF.                                                      07540000
075500                                                                  07550000
075600     EVALUATE TRUE                                                07560000
075700        WHEN SQLCODE = ZEROS                                      07570000
075800             CONTINUE                                             07580000
075900        WHEN OTHER                                                07590000
076000             MOVE 'Y100-OPEN-INVOICE-CSR' TO AA-PARAGRAPH-NAME    07600000
076200             MOVE 'UNSUCCESSFUL OPEN'     TO AA-DB2-OPERATION     07620000
076400             MOVE 'TINVOIC'               TO AA-DB2-TABLE-1       07640000
076500             MOVE 'TALCHRG'               TO AA-DB2-TABLE-2       07650000
076510             MOVE 'TACCTYP'               TO AA-DB2-TABLE-3       07651000
076520             MOVE SPACES                  TO AA-DB2-TABLE-4       07652000
076600             PERFORM Z999-DB2-ABEND                               07660000
076700     END-EVALUATE.                                                07670000
076800                                                                  07680000
076810*----------------------------------------------------------------*07681000
076820* CLOSES THE INVOICE_CSR                                         *07682000
076830*----------------------------------------------------------------*07683000
076900 Y200-CLOSE-INVOICE-CSR.                                          07690000
077000                                                                  07700000
077100     PERFORM WITH TEST AFTER                                      07710000
077200        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      07720000
077300        UNTIL   PV-RETRY-COUNTER > PC-MAX-RETRIES OR              07730000
077400                SQLCODE = ZERO                                    07740000
077500         EXEC SQL                                                 07750000
077600             CLOSE INVOICE_CSR                                    07760000
077700         END-EXEC                                                 07770000
077800                                                                  07780000
077900        EVALUATE TRUE                                             07790000
078000            WHEN SQLCODE = ZERO                                   07800000
078100            WHEN SQLCODE = -904                                   07810000
078200            WHEN SQLCODE = -913                                   07820000
078300                 CONTINUE                                         07830000
078400            WHEN SQLWARN0 NOT = SPACES                            07840000
078500            WHEN SQLCODE  NOT = ZERO                              07850000
078600                 MOVE 'Y200-CLOSE-INVOICE-CSR'                    07860000
078700                                           TO AA-PARAGRAPH-NAME   07870000
078800                 MOVE 'UNSUCCESSFUL CLOSE' TO AA-DB2-OPERATION    07880000
079000                 MOVE 'TINVOIC'            TO AA-DB2-TABLE-1      07900000
079100                 MOVE 'TALCHRG'            TO AA-DB2-TABLE-2      07910000
079110                 MOVE 'TACCTYP'            TO AA-DB2-TABLE-3      07911000
079120                 MOVE SPACES               TO AA-DB2-TABLE-4      07912000
079200                 PERFORM Z999-DB2-ABEND                           07920000
079300        END-EVALUATE                                              07930000
079400     END-PERFORM.                                                 07940000
079500                                                                  07950000
079600     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         07960000
079700         MOVE 'Y200-CLOSE-INVOICE-CSR' TO AA-PARAGRAPH-NAME       07970000
079900         MOVE 'MAX RETRIES EXCEEDED ON CLOSE TINVOIC'             07990000
080000                                       TO AA-DB2-OPERATION        08000000
080100         PERFORM Z999-DB2-ABEND                                   08010000
080200     END-IF.                                                      08020000
080300                                                                  08030000
080400     EVALUATE TRUE                                                08040000
080500        WHEN SQLCODE = ZEROS                                      08050000
080600             CONTINUE                                             08060000
080700        WHEN OTHER                                                08070000
080800             MOVE 'Y200-CLOSE-INVOICE-CSR' TO AA-PARAGRAPH-NAME   08080000
081000             MOVE 'UNSUCCESSFUL CLOSE'     TO AA-DB2-OPERATION    08100000
081200             MOVE 'TINVOIC'                TO AA-DB2-TABLE-1      08120000
081300             MOVE 'TALCHRG'                TO AA-DB2-TABLE-2      08130000
081310             MOVE 'TACCTYP'                TO AA-DB2-TABLE-3      08131000
081320             MOVE SPACES                   TO AA-DB2-TABLE-4      08132000
081400             PERFORM Z999-DB2-ABEND                               08140000
081500     END-EVALUATE.                                                08150000
081501                                                                  08150100
081510*----------------------------------------------------------------*08151000
081520* DB2 ABEND ROUTINE                                              *08152000
081530*----------------------------------------------------------------*08153000
081600 Z999-DB2-ABEND.                                                  08160000
081700                                                                  08170000
081800     DISPLAY AA-ABEND-LIT.                                        08180000
081900     DISPLAY AA-DB2-ERROR-LIT.                                    08190000
082000     DISPLAY AA-PROGRAM-LIT.                                      08200000
082100     DISPLAY AA-PARAGRAPH-LIT.                                    08210000
082200     DISPLAY AA-DB2-OPERATION-LIT.                                08220000
082300     DISPLAY AA-DB2-TABLE-1.                                      08230000
082400     DISPLAY AA-DB2-TABLE-2.                                      08240000
082410     DISPLAY AA-DB2-TABLE-3.                                      08241000
082420     DISPLAY AA-DB2-TABLE-4.                                      08242000
082500     SET AC-DB2-ERROR TO TRUE.                                    08250000
082600                                                                  08260000
082700     COPY DPPD004.                                                08270000
082900     CALL 'ILBOABN0' USING ABEND-CODE.                            08290000
