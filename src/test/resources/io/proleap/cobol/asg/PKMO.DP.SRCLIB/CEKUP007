000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400 PROGRAM-ID.    CEKUP007.                                         00040000
000500 AUTHOR.        JOE LAROSA.                                       00050000
000600 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00060000
000700 DATE-WRITTEN.  01/20/00.                                         00070000
000800 DATE-COMPILED.                                                   00080000
000900*----------------------------------------------------------------*00090000
001000*                 CENTRAL STOCK PURGE PROGRAM                    *00100000
001100*                                                                *00110000
001200* THIS DB2 BATCH PROGRAM WILL PURGE ROWS ON THE CENTRAL STOCK    *00120000
001300* (CE) TABLES FOR PULLS THAT WERE CREATED MORE THAN 14 MONTHS    *00130024
001400* PREVIOUSLY.  THIS PROGRAM ALSO CREATES A REPORT OF THE DELETED *00140024
001500* PULL REQUESTS.                                                 *00150000
001600*                                                                *00160000
001700*----------------------------------------------------------------*00170000
001800                                                                  00180000
001900******************************************************************00190000
002000 ENVIRONMENT DIVISION.                                            00200000
002100******************************************************************00210000
002200 CONFIGURATION SECTION.                                           00220000
002300                                                                  00230000
002400 OBJECT-COMPUTER.  IBM-3090.                                      00240000
002500 SOURCE-COMPUTER.  IBM-3090.                                      00250000
002600                                                                  00260000
002700 INPUT-OUTPUT SECTION.                                            00270000
002800 FILE-CONTROL.                                                    00280000
002900                                                                  00290000
003000     SELECT OUTPUT-REPORT                                         00300005
003100         ASSIGN TO RPT01.                                         00310005
003200                                                                  00320005
003300******************************************************************00330000
003400 DATA DIVISION.                                                   00340000
003500******************************************************************00350000
003600 FILE SECTION.                                                    00360000
003700                                                                  00370005
003800 FD  OUTPUT-REPORT                                                00380005
003900     RECORDING MODE IS F                                          00390005
004000     BLOCK CONTAINS 0  RECORDS.                                   00400005
004100 01  OUTPUT-REC                       PIC X(132).                 00410005
004200                                                                  00420005
004300***************************************************************** 00430005
004400 WORKING-STORAGE SECTION.                                         00440000
004500                                                                  00450005
004600 01  PS-PROGRAM-SWITCHES.                                         00460000
004700     05  PS-STS-CSR-DONE-SW           PIC  X(01) VALUE 'N'.       00470000
004800         88  PS-STS-CSR-DONE-NO                  VALUE 'N'.       00480000
004900         88  PS-STS-CSR-DONE-YES                 VALUE 'Y'.       00490000
005000                                                                  00500000
005100 01  DK-DB-KEYS.                                                  00510005
005200     05  DK-REQ-PL-NBR                PIC S9(09) VALUE +0 COMP.   00520005
005300                                                                  00530005
005400 01  PC-PROGRAM-CONSTANTS.                                        00540000
005500     05  PC-PROGRAM-NAME              PIC  X(08) VALUE 'CEKUP007'.00550000
005600     05  PC-REPORT-NBR                PIC  X(02) VALUE '-1'.      00560005
005700     05  PC-MAX-LINE-COUNT            PIC  S9(3) VALUE +60        00570005
005800                                                 COMP-3.          00580005
005900 01  PV-PROGRAM-VARIABLES.                                        00590000
006000     05  PV-SQLCODE                   PIC  9(09) VALUE ZERO.      00600030
006100                                                                  00610005
006200     05  PV-PAGE-COUNT                PIC  S9(4) VALUE ZERO       00620005
006300                                                 COMP-3.          00630005
006400     05  PV-LINE-COUNT                PIC  S9(3) VALUE ZERO       00640005
006500                                                 COMP-3.          00650005
006600     05  PV-FORMAT-DATE.                                          00660005
006700         10  PV-FORMAT-DATE-MM        PIC  X(02) VALUE SPACES.    00670005
006800         10  FILLER                   PIC  X(01) VALUE '/'.       00680005
006900         10  PV-FORMAT-DATE-DD        PIC  X(02) VALUE SPACES.    00690005
007000         10  FILLER                   PIC  X(01) VALUE '/'.       00700005
007100         10  PV-FORMAT-DATE-CC        PIC  X(02) VALUE SPACES.    00710005
007200         10  PV-FORMAT-DATE-YY        PIC  X(02) VALUE SPACES.    00720005
007300                                                                  00730005
007400     05  PV-TODAYS-DATE-CCYYMMDD.                                 00740005
007500         10  PV-TODAYS-DATE-CC        PIC  9(02) VALUE 20.        00750005
007600         10  PV-TODAYS-DATE-YYMMDD.                               00760005
007700             15  PV-TODAYS-DATE-YY    PIC  9(02) VALUE 0.         00770005
007800             15  PV-TODAYS-DATE-MM    PIC  9(02) VALUE 0.         00780005
007900             15  PV-TODAYS-DATE-DD    PIC  9(02) VALUE 0.         00790005
008000                                                                  00800005
008100     05  PV-TODAYS-DATE-CCYY.                                     00810005
008200         10  FILLER                  PIC 9(02) VALUE 20.          00820005
008300         10  PV-TODAYS-DATE-Y2       PIC 9(02) VALUE ZERO.        00830005
008400                                                                  00840005
008500     05  PV-TODAYS-TIME.                                          00850005
008600         10  PV-TODAYS-TIME-HH       PIC 9(02) VALUE ZERO.        00860005
008700         10  PV-TODAYS-TIME-MM       PIC 9(02) VALUE ZERO.        00870005
008800         10  PV-TODAYS-TIME-SS       PIC 9(02) VALUE ZERO.        00880005
008900         10  FILLER                  PIC 9(02) VALUE ZERO.        00890005
009000                                                                  00900005
009100*PURGE DATE IS 14 MONTHS LESS THAN CURRENT DATE.                  00910000
009200     05  PV-PURGE-TMST                PIC  X(26) VALUE SPACE.     00920026
009300     05  FILLER REDEFINES PV-PURGE-TMST.                          00930026
009400         10  PV-PURGE-DATE            PIC  X(10).                 00940026
009500         10  FILLER REDEFINES PV-PURGE-DATE.                      00950026
009600             15  PV-PURGE-DATE-YYYY   PIC  9999.                  00960021
009700             15  PV-PURGE-DATE-1ST    PIC  X.                     00970021
009800             15  PV-PURGE-DATE-MM     PIC  99.                    00980021
009900             15  PV-PURGE-DATE-2ND    PIC  X.                     00990021
010000             15  PV-PURGE-DATE-DD     PIC  99.                    01000021
010100         10  PV-PURGE-DATE-3RD        PIC  X.                     01010026
010200         10  PV-PURGE-TIMESTAMP       PIC  X(15).                 01020021
010300                                                                  01030000
010400 01  PV-ABEND-FIELDS.                                             01040000
010500     05  PV-ABEND-CODE                PIC S9(04) VALUE +0         01050000
010600                                                 COMP SYNC.       01060000
010700     05  PV-ABEND-PROGRAM             PIC  X(08) VALUE 'CEKUP007'.01070000
010800     05  PV-ABEND-PARAGRAPH           PIC  X(50) VALUE SPACES.    01080000
010900     05  PV-ABEND-OPERATION           PIC  X(50) VALUE SPACES.    01090000
011000     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    01100000
011100     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    01110000
011200     05  PV-DB2-TABLE-NAME            PIC  X(08) VALUE SPACES.    01120000
011300     05  PV-ABEND-PULL-REQ            PIC  9(09) VALUE ZEROES.    01130000
011400                                                                  01140000
011500******************************************************************01150005
011600*  WORK FIELDS FOR PRINTING A 132 CHARACTER REPORT.               01160005
011700******************************************************************01170005
011800     COPY DPWS132.                                                01180005
011900                                                                  01190005
012000 01  WS-BATCH-PROC-DATE.                                          01200005
012100     05  WS-BATCH-PROC-CC            PIC X(02)     VALUE SPACES.  01210005
012200     05  WS-BATCH-PROC-YY            PIC X(02)     VALUE SPACES.  01220005
012300     05  FILLER                      PIC X(01)     VALUE SPACES.  01230005
012400     05  WS-BATCH-PROC-MM            PIC X(02)     VALUE SPACES.  01240005
012500     05  FILLER                      PIC X(01)     VALUE SPACES.  01250005
012600     05  WS-BATCH-PROC-DD            PIC X(02)     VALUE SPACES.  01260005
012700                                                                  01270005
012800 01  HEADING-LINES.                                               01280005
012900     05  HEADING-LINE-1A.                                         01290021
013000         10  FILLER                  PIC  X(49)    VALUE SPACES.  01300005
013100         10  FILLER                  PIC  X(34)    VALUE          01310005
013200             'CENTRAL STOCK PULL REQUESTS PURGED'.                01320005
013300         10  FILLER                  PIC  X(49)    VALUE SPACES.  01330005
013400                                                                  01340005
013500     05  HEADING-LINE-1B.                                         01350021
013600         10  FILLER                  PIC  X(52)    VALUE SPACES.  01360021
013700         10  FILLER                  PIC  X(17)    VALUE          01370021
013800             '(CUT-OFF DATE IS '.                                 01380021
013900         10  HL1-PURGE-DATE          PIC  X(10).                  01390021
014000         10  FILLER                  PIC  X(01)    VALUE ')'.     01400021
014100         10  FILLER                  PIC  X(52)    VALUE SPACES.  01410021
014200                                                                  01420021
014300     05  HEADING-LINE-2.                                          01430005
014400         10  FILLER                  PIC  X(44)    VALUE SPACES.  01440038
014500         10  FILLER                  PIC  X(09)    VALUE          01450005
014600             'PULL NMBR'.                                         01460005
014700         10  FILLER                  PIC  X(10)    VALUE SPACES.  01470005
014800         10  FILLER                  PIC  X(26)    VALUE          01480005
014900             '     CREATE TIMESTAMP     '.                        01490005
015300         10  FILLER                  PIC  X(43)    VALUE SPACES.  01530038
015400                                                                  01540005
015500     05  HEADING-LINE-3.                                          01550005
015600         10  FILLER                  PIC  X(44)    VALUE SPACES.  01560038
015700         10  FILLER                  PIC  X(09)    VALUE          01570005
015800             '---------'.                                         01580005
015900         10  FILLER                  PIC  X(10)    VALUE SPACES.  01590005
016000         10  FILLER                  PIC  X(26)    VALUE          01600005
016100             '--------------------------'.                        01610005
016500         10  FILLER                  PIC  X(43)    VALUE SPACES.  01650038
016600                                                                  01660005
016700 01  DETAIL-LINES.                                                01670005
016800     05  DETAIL-LINE-1.                                           01680005
016900         10  FILLER                  PIC  X(44)    VALUE SPACES.  01690038
017000         10  DL1-PULL-NUMBER         PIC  Z(09).                  01700005
017100         10  FILLER                  PIC  X(10)    VALUE SPACES.  01710005
017200         10  DL1-CREATE-TMST         PIC  X(26).                  01720005
017500         10  FILLER                  PIC  X(43)    VALUE SPACES.  01750038
017600                                                                  01760005
017700 01  MISCELLANEOUS-LINES.                                         01770005
017800     05  BLANK-LINE.                                              01780005
017900         10  FILLER                  PIC X(132)    VALUE SPACES.  01790005
018000                                                                  01800005
018100     05  END-OF-REPORT-LINE.                                      01810005
018200         10  FILLER                  PIC  X(44)    VALUE SPACES.  01820038
018300         10  FILLER                  PIC  X(45)    VALUE          01830005
018400             '*******   E N D   O F   R E P O R T   *******'.     01840005
018500         10  FILLER                  PIC  X(43)    VALUE SPACES.  01850038
018600                                                                  01860005
018700     05  NO-DATA-TO-REPORT-LINE.                                  01870005
018800         10  FILLER                  PIC  X(34)    VALUE SPACES.  01880005
018900         10  FILLER                  PIC  X(40)    VALUE          01890006
019000             '*******  N O   P U L L   R E Q U E S T S'.          01900006
019100         10  FILLER                  PIC  X(24)    VALUE          01910006
019200             '   P U R G E D  ******* '.                          01920006
019300         10  FILLER                  PIC  X(34)    VALUE SPACES.  01930005
019400*                                                                 01940005
019500*-----------------------------------------------------------------01950000
019600*  CALENDAR ROUTINE WORKING STORAGE                               01960000
019700*-----------------------------------------------------------------01970000
019800     COPY DPWS500.                                                01980000
019900                                                                  01990000
020000*-----------------------------------------------------------------02000000
020100*  ABEND ROUTINE WORKING STORAGE                                  02010000
020200*-----------------------------------------------------------------02020000
020300     COPY DPWS004.                                                02030000
020400                                                                  02040000
020500*-----------------------------------------------------------------02050000
020600*  CENTRAL STOCK - PULL REQUEST TABLE                             02060000
020700*-----------------------------------------------------------------02070000
020800     EXEC SQL                                                     02080000
020900        INCLUDE TCEPLRQ                                           02090000
021000     END-EXEC.                                                    02100000
021100                                                                  02110000
021200*-----------------------------------------------------------------02120000
021300*  CENTRAL STOCK - PULL LINE ITEM TABLE                           02130000
021400*-----------------------------------------------------------------02140000
021500     EXEC SQL                                                     02150000
021600        INCLUDE TCEPLIT                                           02160000
021700     END-EXEC.                                                    02170000
021800                                                                  02180000
021900*-----------------------------------------------------------------02190000
022000*  CENTRAL STOCK - PULL DISTRIBUTION TABLE                        02200000
022100*-----------------------------------------------------------------02210000
022200     EXEC SQL                                                     02220000
022300        INCLUDE TCEPLDS                                           02230000
022400     END-EXEC.                                                    02240000
022500                                                                  02250000
022600*-----------------------------------------------------------------02260000
022700*  CENTRAL STOCK - PULL STATUS TABLE                              02270000
022800*-----------------------------------------------------------------02280000
022900     EXEC SQL                                                     02290000
023000        INCLUDE TCEPLST                                           02300000
023100     END-EXEC.                                                    02310000
023200                                                                  02320000
023300*-----------------------------------------------------------------02330000
023400*  COMPANY CONTROL TABLE                                          02340000
023500*-----------------------------------------------------------------02350000
023600     EXEC SQL                                                     02360000
023700        INCLUDE TCOCNTL                                           02370000
023800     END-EXEC.                                                    02380000
023900                                                                  02390000
024000*-----------------------------------------------------------------02400000
024100* CENTRAL STOCK PULL REQUEST STATUS CURSOR                        02410000
024200*   - SELECT ALL PULLS 14 MONTHS OR OLDER.                        02420000
024300*-----------------------------------------------------------------02430000
024400     EXEC SQL                                                     02440000
024500         DECLARE CEPLST-CSR CURSOR FOR                            02450000
024600          SELECT A.CNSTK_REQ_PL_NBR                               02460000
024700               , MAX(A.CRE_TMST)                                  02470030
024800            FROM TCEPLST A                                        02480000
024900        GROUP BY A.CNSTK_REQ_PL_NBR                               02490030
025000        ORDER BY A.CNSTK_REQ_PL_NBR                               02500030
025100     END-EXEC.                                                    02510000
025200                                                                  02520000
025300*-----------------------------------------------------------------02530000
025400*  DB2 COMMUNICATION AREA                                         02540000
025500*-----------------------------------------------------------------02550000
025600     EXEC SQL                                                     02560000
025700        INCLUDE SQLCA                                             02570000
025800     END-EXEC.                                                    02580000
025900/                                                                 02590000
026000******************************************************************02600000
026100 PROCEDURE DIVISION.                                              02610000
026200******************************************************************02620000
026300     DISPLAY '**** BEGINNING CEKUP007 ****'.                      02630000
026400                                                                  02640000
026500     OPEN OUTPUT OUTPUT-REPORT.                                   02650006
026600                                                                  02660006
026700     PERFORM 1000-INITIALIZATION.                                 02670006
026800                                                                  02680000
026900*GET FIRST QUALIFIED CEPLST TABLE ENTRY.                          02690000
027000     PERFORM 2100-FETCH-CEPLST-CSR.                               02700000
027100                                                                  02710000
027200*PROCESS ALL QUALIFIED CEPLST TABLE ENTRIES.                      02720000
027300     IF PS-STS-CSR-DONE-YES                                       02730005
027400         PERFORM 1300-NO-DETAIL-LINE                              02740005
027500         PERFORM 1400-END-OF-RPT-LINE                             02750005
027600     ELSE                                                         02760005
027700         PERFORM 2000-DELETE-PULLS                                02770005
027800           UNTIL PS-STS-CSR-DONE-YES                              02780005
027900     END-IF.                                                      02790005
028000                                                                  02800000
028100*CLOSE CEPLST CURSOR.                                             02810000
028200     PERFORM 3000-CLOSE-CEPLST-CSR.                               02820000
028300                                                                  02830006
028400     CLOSE OUTPUT-REPORT.                                         02840006
028500                                                                  02850000
028600     GOBACK.                                                      02860000
028700                                                                  02870000
028800******************************************************************02880000
028900 1000-INITIALIZATION.                                             02890000
029000******************************************************************02900005
029100     MOVE '1000-INITIALIZATION     ' TO PV-ABEND-PARAGRAPH.       02910000
029200                                                                  02920000
029300*DECREMENT CURRENT DATE BY 425 DAYS (14 MONTHS APPROX.)           02930005
029400*TO DETERMINE THE PURGE DATE NEEDED FOR CENTRAL STOCK.            02940005
029500                                                                  02950005
029600     ACCEPT PV-TODAYS-DATE-YYMMDD   FROM DATE.                    02960005
029700                                                                  02970000
029800     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              02980005
029900                                                                  02990005
030000     SET  DPG51-ACTUAL-CALENDAR-ONLY TO  TRUE.                    03000005
030100     SET  DPG51-DECREMENT-DATE       TO  TRUE.                    03010005
030200     MOVE 425                        TO  DPG51-INCR-DECR-DAYS-9.  03020005
030300                                                                  03030005
030400     SET  DPG52-LK-DTE-ISO           TO  TRUE.                    03040005
030500     MOVE PV-TODAYS-DATE-CCYYMMDD    TO  DPG52-DB2-ISO-DATE-N.    03050005
030600                                                                  03060005
030700     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    03070005
030800                                             DPG54 DPG55 DPG56.   03080005
030900     EVALUATE TRUE                                                03090005
031000       WHEN DPG54-SEVERE-ERROR                                    03100005
031100       WHEN DPG54-WARNING-ERROR                                   03110005
031200           MOVE '1000-INITIALIZATION' TO PV-ABEND-PARAGRAPH       03120005
031300           MOVE 'DPWS500'             TO PV-DB2-TABLE-NAME        03130005
031400           MOVE 'ERROR CALCULATING PURGE DATE'                    03140005
031500                                   TO PV-DB2-OPERATION-MESSAGE-1  03150005
031600           MOVE DPG54-ERROR-MESSAGE                               03160005
031700                                   TO PV-DB2-OPERATION-MESSAGE-2  03170005
031800           PERFORM Z999-SQL-ABEND                                 03180005
031900     END-EVALUATE.                                                03190005
032000                                                                  03200005
032100     MOVE DPG55-DB2-ISO-DATE-YR        TO PV-PURGE-DATE-YYYY.     03210005
032200     MOVE DPG55-DB2-ISO-DATE-MO        TO PV-PURGE-DATE-MM.       03220005
032300     MOVE DPG55-DB2-ISO-DATE-DY        TO PV-PURGE-DATE-DD.       03230005
032400     MOVE '-'                          TO PV-PURGE-DATE-1ST       03240005
032500                                          PV-PURGE-DATE-2ND       03250005
032600                                          PV-PURGE-DATE-3RD.      03260005
032700     MOVE '23.59.59.999999'            TO PV-PURGE-TIMESTAMP.     03270005
032800                                                                  03280000
032900     DISPLAY '  **** PV-PURGE-DATE = ' PV-PURGE-TMST.             03290036
033000                                                                  03300000
033100*PRINT PURGE REPORT HEADINGS.                                     03310005
033200     ACCEPT PV-TODAYS-TIME   FROM TIME.                           03320005
033300     MOVE PV-TODAYS-TIME-HH    TO DP132-RUN-HOUR.                 03330005
033400     MOVE PV-TODAYS-TIME-MM    TO DP132-RUN-MINUTE.               03340005
033500                                                                  03350005
033600     MOVE PV-TODAYS-DATE-MM    TO DP132-RUN-MONTH.                03360005
033700     MOVE PV-TODAYS-DATE-DD    TO DP132-RUN-DAY.                  03370005
033800     MOVE PV-TODAYS-DATE-YY    TO PV-TODAYS-DATE-Y2.              03380005
033900     MOVE PV-TODAYS-DATE-CCYY  TO DP132-RUN-YEAR.                 03390005
034000                                                                  03400005
034100     MOVE PC-PROGRAM-NAME      TO DP132-PROGRAM-NAME.             03410005
034200     MOVE PC-REPORT-NBR        TO DP132-REPORT-NUMBER.            03420005
034300                                                                  03430005
034400     MOVE +0                   TO PV-PAGE-COUNT.                  03440005
034500                                                                  03450005
034600     PERFORM 1200-PRINT-HDGS.                                     03460005
034700                                                                  03470000
034800*OPEN PROCESSING CURSOR.                                          03480005
034900     PERFORM 1100-OPEN-CEPLST-CSR.                                03490005
035000                                                                  03500005
035100***************************************************************** 03510000
035200 1100-OPEN-CEPLST-CSR.                                            03520000
035300***************************************************************** 03530000
035400     MOVE '1100-OPEN-CEPLST-CSR' TO PV-ABEND-PARAGRAPH.           03540000
035500                                                                  03550000
035600     EXEC SQL                                                     03560000
035700         OPEN CEPLST-CSR                                          03570000
035800     END-EXEC.                                                    03580000
035900                                                                  03590000
036000     EVALUATE TRUE                                                03600000
036100       WHEN SQLCODE = +0                                          03610000
036200           SET PS-STS-CSR-DONE-NO TO TRUE                         03620004
036300           MOVE ZEROES TO DK-REQ-PL-NBR                           03630002
036400                                                                  03640000
036500       WHEN SQLWARN0 NOT = SPACE                                  03650000
036600       WHEN SQLCODE  NOT = +0                                     03660000
036700           SET PS-STS-CSR-DONE-YES TO TRUE                        03670002
036800           MOVE '1100-OPEN-CEPLST-CSR' TO PV-ABEND-PARAGRAPH      03680000
036900           MOVE 'TCEPLST'     TO PV-DB2-TABLE-NAME                03690000
037000           MOVE 'OPEN CURSOR' TO PV-DB2-OPERATION-MESSAGE-1       03700000
037100           PERFORM Z999-SQL-ABEND                                 03710000
037200     END-EVALUATE.                                                03720000
037300                                                                  03730000
037400***************************************************************** 03740005
037500 1200-PRINT-HDGS.                                                 03750005
037600***************************************************************** 03760005
037700     MOVE '1200-PRINT-HDGS      ' TO PV-ABEND-PARAGRAPH.          03770005
037800                                                                  03780005
037900     ADD 1  TO PV-PAGE-COUNT.                                     03790005
038000     MOVE PV-PAGE-COUNT TO DP132-PAGE-NUMBER.                     03800005
038100                                                                  03810005
038200     WRITE OUTPUT-REC                                             03820005
038300       FROM DP132-STANDRD-HEADER-132-COLS                         03830005
038400         AFTER ADVANCING PAGE.                                    03840005
038500                                                                  03850005
038600     WRITE OUTPUT-REC                                             03860005
038700       FROM HEADING-LINE-1A                                       03870022
038800         AFTER ADVANCING 2 LINES.                                 03880005
038900                                                                  03890005
039000     MOVE PV-PURGE-DATE TO HL1-PURGE-DATE.                        03900022
039100     WRITE OUTPUT-REC                                             03910022
039200       FROM HEADING-LINE-1B                                       03920022
039300         AFTER ADVANCING 1 LINES.                                 03930022
039400                                                                  03940022
039500     WRITE OUTPUT-REC                                             03950005
039600       FROM HEADING-LINE-2                                        03960005
039700         AFTER ADVANCING 3 LINES.                                 03970005
039800                                                                  03980005
039900     WRITE OUTPUT-REC                                             03990005
040000       FROM HEADING-LINE-3                                        04000005
040100         AFTER ADVANCING 1 LINES.                                 04010005
040200                                                                  04020005
040300*PRINT BLANK LINE.                                                04030008
040400     WRITE OUTPUT-REC                                             04040005
040500       FROM BLANK-LINE                                            04050005
040600         AFTER ADVANCING 1 LINES.                                 04060005
040700                                                                  04070005
040800     MOVE +8 TO PV-LINE-COUNT.                                    04080008
040900                                                                  04090008
041000******************************************************************04100005
041100*  PRINT A 'NO INPUT' REPORT LINE.                               *04110005
041200******************************************************************04120005
041300 1300-NO-DETAIL-LINE.                                             04130005
041400                                                                  04140005
041500     WRITE OUTPUT-REC                                             04150005
041600       FROM NO-DATA-TO-REPORT-LINE                                04160005
041700         AFTER ADVANCING 3 LINES.                                 04170005
041800                                                                  04180005
041900******************************************************************04190005
042000*  PRINT A 'END OF REPORT' REPORT LINE.                          *04200005
042100******************************************************************04210005
042200 1400-END-OF-RPT-LINE.                                            04220005
042300                                                                  04230005
042400*CHECK FOR OVERFLOW.                                              04240005
042500     ADD 3 TO PV-LINE-COUNT.                                      04250005
042600     IF PV-LINE-COUNT > PC-MAX-LINE-COUNT                         04260005
042700         PERFORM 1200-PRINT-HDGS                                  04270006
042800     END-IF.                                                      04280005
042900                                                                  04290005
043000*PRINT LINE.                                                      04300005
043100     WRITE OUTPUT-REC                                             04310005
043200       FROM END-OF-REPORT-LINE                                    04320005
043300         AFTER ADVANCING 3 LINES.                                 04330005
043400                                                                  04340005
043500***************************************************************** 04350000
043600 2000-DELETE-PULLS.                                               04360003
043700***************************************************************** 04370000
043800     MOVE '2000-DELETE-PULLS     ' TO PV-ABEND-PARAGRAPH.         04380003
043900                                                                  04390000
044001     IF CEPLST-CRE-TMST < PV-PURGE-TMST                           04400136
044010*DELETE PULL REQUESTS.                                            04401036
044100         PERFORM 2200-DELETE-TCEPLRQ                              04410038
044300*DELETE PULL REQUEST ITEMS.                                       04430002
044400         PERFORM 2300-DELETE-TCEPLIT                              04440038
044600*DELETE PULL REQUEST DISTRIBUTIONS.                               04460002
044700         PERFORM 2400-DELETE-TCEPLDS                              04470038
044900*DELETE PULL REQUEST STATUS.                                      04490002
045000         PERFORM 2500-DELETE-TCEPLST                              04500038
045200*COMMIT DB2 DELETES.                                              04520003
045300         PERFORM 2600-COMMIT                                      04530038
045500*PRINT PULL INFORMATION.                                          04550005
045600         PERFORM 2700-PRINT-PULL                                  04560036
045800*RE-OPEN PROCESSING CURSOR.                                       04580014
045900         PERFORM 1100-OPEN-CEPLST-CSR                             04590038
045910     END-IF.                                                      04591036
046000                                                                  04600014
046100*GET NEXT QUALIFIED CEPLST TABLE ENTRY.                           04610002
046200     PERFORM 2100-FETCH-CEPLST-CSR.                               04620002
046300                                                                  04630002
046400     IF PS-STS-CSR-DONE-YES                                       04640011
046500         PERFORM 1400-END-OF-RPT-LINE                             04650011
046600     END-IF.                                                      04660011
046700                                                                  04670011
046800***************************************************************** 04680000
046900 2100-FETCH-CEPLST-CSR.                                           04690000
047000***************************************************************** 04700000
047100     MOVE '2100-FETCH-CEPLST-CSR  ' TO PV-ABEND-PARAGRAPH.        04710000
047200                                                                  04720000
047300     EXEC SQL                                                     04730000
047400         FETCH  CEPLST-CSR                                        04740002
047500          INTO :CEPLST-CNSTK-REQ-PL-NBR                           04750002
047600             , :CEPLST-CRE-TMST                                   04760002
047800     END-EXEC.                                                    04780000
047900                                                                  04790000
048000     EVALUATE TRUE                                                04800000
048100       WHEN SQLCODE = +0                                          04810000
048200           MOVE CEPLST-CNSTK-REQ-PL-NBR TO DK-REQ-PL-NBR          04820002
048300*JPL                                                              04830000
048400*          MOVE SPACES TO PV-DB2-OPERATION-MESSAGE-1              04840038
048500*          MOVE CEPLST-CNSTK-REQ-PL-NBR TO PV-ABEND-PULL-REQ      04850038
048600*          STRING '2100-FETCH (ST) PULL RETRIEVED - '             04860038
048700*                 PV-ABEND-PULL-REQ ' / ' CEPLST-CRE-TMST         04870038
048800*            DELIMITED BY SIZE                                    04880038
048900*            INTO PV-DB2-OPERATION-MESSAGE-1                      04890038
049000*          DISPLAY PV-DB2-OPERATION-MESSAGE-1                     04900038
049100                                                                  04910000
049200       WHEN SQLCODE = +100                                        04920000
049300           SET PS-STS-CSR-DONE-YES TO TRUE                        04930007
049400           MOVE ZEROES             TO DK-REQ-PL-NBR               04940000
049500                                                                  04950000
049600       WHEN SQLWARN0 NOT = SPACE                                  04960000
049700       WHEN SQLCODE  NOT = +0                                     04970000
049800           MOVE '2100-FETCH-PROCESS-CSR' TO PV-ABEND-PARAGRAPH    04980000
049900           MOVE 'FETCH   '               TO PV-ABEND-OPERATION    04990000
050000           MOVE 'TCEPLIT '               TO PV-DB2-TABLE-NAME     05000000
050100           PERFORM Z999-SQL-ABEND                                 05010000
050200     END-EVALUATE.                                                05020000
050300                                                                  05030000
050400***************************************************************** 05040000
050500 2200-DELETE-TCEPLRQ.                                             05050000
050600***************************************************************** 05060000
050700     MOVE '2200-DELETE-TCEPLRQ    ' TO PV-ABEND-PARAGRAPH.        05070000
050800                                                                  05080000
050900     EXEC SQL                                                     05090002
051000          DELETE FROM TCEPLRQ                                     05100002
051100          WHERE CNSTK_REQ_PL_NBR = :DK-REQ-PL-NBR                 05110009
051200     END-EXEC.                                                    05120002
051300                                                                  05130002
051400     EVALUATE TRUE                                                05140002
051500       WHEN SQLCODE = +0                                          05150002
051600       WHEN SQLCODE = +100                                        05160002
051700           CONTINUE                                               05170002
051800                                                                  05180002
051900       WHEN OTHER                                                 05190002
052000           MOVE '2200-DELETE-TCEPLRQ  ' TO PV-ABEND-PARAGRAPH     05200002
052100           MOVE 'TCEPLRQ'               TO PV-DB2-TABLE-NAME      05210002
052200           MOVE DK-REQ-PL-NBR           TO PV-ABEND-PULL-REQ      05220002
052300           STRING 'DELETE CEPLRQ USING PULL# = '                  05230002
052400                  PV-ABEND-PULL-REQ DELIMITED BY SIZE             05240002
052500             INTO PV-DB2-OPERATION-MESSAGE-1                      05250002
052600           PERFORM Z999-SQL-ABEND                                 05260002
052700     END-EVALUATE.                                                05270002
052800                                                                  05280000
052900***************************************************************** 05290000
053000 2300-DELETE-TCEPLIT.                                             05300002
053100***************************************************************** 05310000
053200     MOVE '2300-DELETE-TCEPLIT    ' TO PV-ABEND-PARAGRAPH.        05320002
053300                                                                  05330000
053400     EXEC SQL                                                     05340002
053500          DELETE FROM TCEPLIT                                     05350002
053600          WHERE CNSTK_REQ_PL_NBR = :DK-REQ-PL-NBR                 05360009
053700     END-EXEC.                                                    05370002
053800                                                                  05380002
053900     EVALUATE TRUE                                                05390002
054000       WHEN SQLCODE = +0                                          05400002
054100       WHEN SQLCODE = +100                                        05410002
054200           CONTINUE                                               05420002
054300                                                                  05430002
054400       WHEN OTHER                                                 05440000
054500           MOVE '2300-DELETE-TCEPLIT  ' TO PV-ABEND-PARAGRAPH     05450002
054600           MOVE 'TCEPLIT'               TO PV-DB2-TABLE-NAME      05460000
054700           MOVE DK-REQ-PL-NBR           TO PV-ABEND-PULL-REQ      05470002
054800           STRING 'DELETE CEPLIT USING PULL# = '                  05480002
054900                  PV-ABEND-PULL-REQ DELIMITED BY SIZE             05490002
055000             INTO PV-DB2-OPERATION-MESSAGE-1                      05500002
055100           PERFORM Z999-SQL-ABEND                                 05510000
055200     END-EVALUATE.                                                05520000
055300                                                                  05530000
055400***************************************************************** 05540000
055500 2400-DELETE-TCEPLDS.                                             05550002
055600***************************************************************** 05560000
055700     MOVE '2400-DELETE-TCEPLDS   ' TO PV-ABEND-PARAGRAPH.         05570002
055800                                                                  05580000
055900     EXEC SQL                                                     05590002
056000          DELETE FROM TCEPLDS                                     05600002
056100          WHERE CNSTK_REQ_PL_NBR = :DK-REQ-PL-NBR                 05610009
056200     END-EXEC.                                                    05620002
056300                                                                  05630002
056400     EVALUATE TRUE                                                05640002
056500       WHEN SQLCODE = +0                                          05650002
056600       WHEN SQLCODE = +100                                        05660002
056700           CONTINUE                                               05670002
056800                                                                  05680002
056900       WHEN OTHER                                                 05690002
057000           MOVE '2400-DELETE-TCEPLDS  ' TO PV-ABEND-PARAGRAPH     05700002
057100           MOVE 'TCEPLDS'               TO PV-DB2-TABLE-NAME      05710002
057200           MOVE DK-REQ-PL-NBR           TO PV-ABEND-PULL-REQ      05720002
057300           STRING 'DELETE CEPLDS USING PULL# = '                  05730002
057400                  PV-ABEND-PULL-REQ DELIMITED BY SIZE             05740002
057500             INTO PV-DB2-OPERATION-MESSAGE-1                      05750002
057600           PERFORM Z999-SQL-ABEND                                 05760002
057700     END-EVALUATE.                                                05770002
057800                                                                  05780002
057900***************************************************************** 05790000
058000 2500-DELETE-TCEPLST.                                             05800002
058100***************************************************************** 05810000
058200     MOVE '2500-DELETE-TCEPLST   ' TO PV-ABEND-PARAGRAPH.         05820002
058300                                                                  05830002
058400     EXEC SQL                                                     05840002
058500          DELETE FROM TCEPLST                                     05850002
058600          WHERE CNSTK_REQ_PL_NBR = :DK-REQ-PL-NBR                 05860009
058700     END-EXEC.                                                    05870002
058800                                                                  05880002
058900     EVALUATE TRUE                                                05890002
059000       WHEN SQLCODE = +0                                          05900002
059100           CONTINUE                                               05910002
059200                                                                  05920002
059300       WHEN OTHER                                                 05930002
059400           MOVE '2500-DELETE-TCEPLST  ' TO PV-ABEND-PARAGRAPH     05940002
059500           MOVE 'TCEPLST'               TO PV-DB2-TABLE-NAME      05950002
059600           MOVE DK-REQ-PL-NBR           TO PV-ABEND-PULL-REQ      05960002
059700           STRING 'DELETE CEPLST USING PULL# = '                  05970002
059800                  PV-ABEND-PULL-REQ DELIMITED BY SIZE             05980002
059900             INTO PV-DB2-OPERATION-MESSAGE-1                      05990002
060000           PERFORM Z999-SQL-ABEND                                 06000002
060100     END-EVALUATE.                                                06010002
060200                                                                  06020002
060300***************************************************************** 06030000
060400 2600-COMMIT.                                                     06040003
060500***************************************************************** 06050000
060600     MOVE '2600-COMMIT          ' TO PV-ABEND-PARAGRAPH.          06060003
060700                                                                  06070003
060800     EXEC SQL                                                     06080003
060900         COMMIT                                                   06090003
061000     END-EXEC.                                                    06100003
061100                                                                  06110003
061200     EVALUATE TRUE                                                06120003
061300       WHEN SQLCODE = ZERO                                        06130003
061400           CONTINUE                                               06140003
061500                                                                  06150003
061600       WHEN OTHER                                                 06160003
061700           MOVE '2600-COMMIT          ' TO PV-ABEND-PARAGRAPH     06170003
061800           MOVE 'COMMIT '               TO PV-DB2-TABLE-NAME      06180003
061900           MOVE DK-REQ-PL-NBR           TO PV-ABEND-PULL-REQ      06190003
062000           STRING 'ATTEMPTING TO COMMIT DB2 DELETES / PULL# - '   06200003
062100                  PV-ABEND-PULL-REQ DELIMITED BY SIZE             06210003
062200             INTO PV-DB2-OPERATION-MESSAGE-1                      06220003
062300           PERFORM Z999-SQL-ABEND                                 06230003
062400     END-EVALUATE.                                                06240003
062500                                                                  06250003
062600***************************************************************** 06260005
062700 2700-PRINT-PULL.                                                 06270005
062800***************************************************************** 06280005
062900     MOVE '2700-PRINT-PULL      ' TO PV-ABEND-PARAGRAPH.          06290005
063000                                                                  06300005
063100*FILL DETAIL FIELDS.                                              06310005
063200     MOVE CEPLST-CNSTK-REQ-PL-NBR TO DL1-PULL-NUMBER.             06320005
063300     MOVE CEPLST-CRE-TMST         TO DL1-CREATE-TMST.             06330005
063500                                                                  06350005
063600*CHECK FOR OVERFLOW.                                              06360005
063700     ADD 1 TO PV-LINE-COUNT.                                      06370005
063800     IF PV-LINE-COUNT > PC-MAX-LINE-COUNT                         06380005
063900         PERFORM 1200-PRINT-HDGS                                  06390006
064000     END-IF.                                                      06400005
064100                                                                  06410005
064200*WRITE DETAIL LINE.                                               06420005
064300     WRITE OUTPUT-REC                                             06430005
064400       FROM DETAIL-LINE-1                                         06440005
064500         AFTER ADVANCING 1 LINES.                                 06450005
064600                                                                  06460005
064700***************************************************************** 06470003
064800 3000-CLOSE-CEPLST-CSR.                                           06480003
064900***************************************************************** 06490003
065000     MOVE '3000-CLOSE-CEPLST-CSR' TO PV-ABEND-PARAGRAPH.          06500003
065100                                                                  06510003
065200     EXEC SQL                                                     06520000
065300         CLOSE CEPLST-CSR                                         06530000
065400     END-EXEC                                                     06540000
065500                                                                  06550000
065600     EVALUATE TRUE                                                06560000
065700       WHEN SQLCODE = ZERO                                        06570000
065800           CONTINUE                                               06580000
065900                                                                  06590000
066000       WHEN OTHER                                                 06600000
066100           PERFORM Z999-SQL-ABEND                                 06610000
066200     END-EVALUATE.                                                06620000
066300                                                                  06630000
066400***************************************************************** 06640000
066500 Z999-SQL-ABEND.                                                  06650000
066600***************************************************************** 06660000
066700     MOVE SQLCODE TO PV-SQLCODE.                                  06670000
066800     DISPLAY '*** DB2 ERROR '.                                    06680000
066900     DISPLAY '*** SQLCODE   = ' PV-SQLCODE.                       06690000
067000     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 06700000
067100     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               06710000
067200     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               06720000
067300     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       06730000
067400     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.       06740000
067500                                                                  06750000
067600     COPY DPPD004.                                                06760000
067700                                                                  06770000
067800     MOVE +4013 TO PV-ABEND-CODE.                                 06780000
067900     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         06790000
