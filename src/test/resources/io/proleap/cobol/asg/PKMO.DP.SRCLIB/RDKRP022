000100***************************************************************** 00010001
000200 IDENTIFICATION DIVISION.                                         00020001
000300***************************************************************** 00030001
000400                                                                  00040001
000500 PROGRAM-ID.             RDKRP022.                                00050001
000600 AUTHOR.                 BARB ERTL.                               00060001
000700 INSTALLATION.           KOHLS.                                   00070001
000800 DATE-WRITTEN            MAY 2003.                                00080001
000900 DATE-COMPILED.                                                   00090001
001000                                                                  00100001
001100***************************************************************** 00110001
001200*                                                                 00120001
001300*  THIS PROGRAM WILL CREATE A DAILY CORPORATE REFUNDS REPORT.     00130001
001400*                                                                 00140001
001500*   INPUT: INP01 - CONTAINS POS DATE, WHICH IS USED AS THE        00150001
001600*                  PROCESS DATE TO CREATE THE REPORT.             00160001
001700*  OUTPUT: OUT01 - FILE USED TO INSERT REFUNDS TO RDT_MAL_CK_RFND 00170013
001800*                  TABLE                                          00180005
001900***************************************************************** 00190001
002000*                                                                 00200001
002100*  THE PROGRAM READS A CONTROL CARD FILE TO GET THE POS DATE.     00210001
002200*                                                                 00220001
002300*  THIS DATE IS PASSED TO THE KOHLS CALENDAR ROUTINE.  THE DATE   00230001
002400*  IS VALIDATED AND RETURNED IN DB2 DATE FORMAT.                  00240005
002500*                                                                 00250001
002600*  THE DB2 DATE IS USED IN A CURSOR TO SELECT REFUND DATA FROM    00260005
002700*  DB2 TABLE TEPRFN.  THIS CURSOR IS A UNION OF TWO SELECT        00270005
002800*  STATEMENTS:                                                    00280005
002900*    1. A JOIN OF TABLES TEPPART, TEPRFN, TEPTND AND TEPTRN TO    00290005
003000*       GET REFUND DATA BY STORE FOR THE PROCESS DATE.            00300005
003100*    2. A JOIN OF TABLES TEPDKEY, TEPPART, TEPRFN, TEPTND AND     00310005
003200*       TEPTRN TO GET LATE TRANSACTION DATA BY STORE (THIS IS     00320005
003300*       REFUND DATA FOR DATES PRIOR TO THE PROCESS DATE).         00330005
003400*                                                                 00340001
003500*    TEPPART IS PRESENT IN THE SECOND SELECT TO GET THE SLS_DTE   00350001
003600*    FOR THE PARTN_NBR FOUND ON TEPDKEY.                          00360005
003700*    BOTH SIDES OF THE UNION WILL SELECT TENDERS FROM TEPTND      00370001
003800*    THAT HAVE NOT BEEN VOIDED.                                   00380001
003900*    BOTH SIDES OF THE UNION CONTAIN A SELECT FROM TEPTRN,        00390005
004000*    TO MAKE SURE THE SELECTED REFUNDS DO NOT INCLUDE VOIDED      00400001
004100*    TRANSACTIONS.                                                00410001
004200*                                                                 00420001
004300*  AS THE CURSOR IS PROCESSED, A FILE IS CRATED UNTIL END OF      00430013
004400*  CURSOR.                                                        00440013
004500***************************************************************** 00450005
004600 ENVIRONMENT DIVISION.                                            00460001
004700***************************************************************** 00470001
004800                                                                  00480001
004900 CONFIGURATION SECTION.                                           00490001
005000                                                                  00500001
005100 SOURCE-COMPUTER.        IBM-3090.                                00510001
005200 OBJECT-COMPUTER.        IBM-3090.                                00520001
005300                                                                  00530001
005400 INPUT-OUTPUT SECTION.                                            00540001
005500                                                                  00550001
005600 FILE-CONTROL.                                                    00560001
005700                                                                  00570001
005800     SELECT POS-DATE-CARD-FILE                                    00580001
005900         ASSIGN TO INP01.                                         00590001
006000                                                                  00600001
006100     SELECT REFUND-OUTPUT-FILE                                    00610006
006200         ASSIGN TO OUT01.                                         00620005
006300                                                                  00630005
006400******************************************************************00640001
006500 DATA DIVISION.                                                   00650001
006600******************************************************************00660001
006700                                                                  00670001
006800 FILE SECTION.                                                    00680001
006900                                                                  00690001
007000 FD  POS-DATE-CARD-FILE                                           00700001
007100     RECORDING MODE IS F                                          00710001
007200     BLOCK CONTAINS 0 RECORDS                                     00720001
007300     LABEL RECORDS ARE STANDARD.                                  00730001
007400                                                                  00740001
007500 01  POS-DATE-CARD-RECORD            PIC X(80).                   00750001
007600                                                                  00760001
007700 FD  REFUND-OUTPUT-FILE                                           00770005
007800     RECORDING MODE IS F                                          00780005
007900     BLOCK CONTAINS 0 RECORDS                                     00790005
008000     LABEL RECORDS ARE STANDARD.                                  00800005
008100                                                                  00810005
008200 01  REFUND-OUTPUT-RECORD            PIC X(206).                  00820005
008300                                                                  00830005
008400******************************************************************00840001
008500 WORKING-STORAGE SECTION.                                         00850001
008600******************************************************************00860001
008700 01  FILLER                            PIC X(50)  VALUE           00870001
008800     ' *** WORKING STORAGE STARTS HERE FOR RDKRP022 *** '.        00880001
008900                                                                  00890001
009000******************************************************************00900001
009100* RECORD LAYOUT FOR INPUT DATE CARD (POS DATE)                    00910001
009200******************************************************************00920001
009300 01  CC-CONTROL-CARD.                                             00930001
009400     05  CC-CONTROL-CARD-DISPLAY.                                 00940001
009500         10  CC-POS-DATE         PIC X(10)    VALUE SPACES.       00950001
009600     05  FILLER                  PIC X(70)    VALUE SPACE.        00960001
009700******************************************************************00970001
009800*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             00980001
009900******************************************************************00990001
010000     COPY DPWS500.                                                01000011
010100                                                                  01010001
010200******************************************************************01020005
010300*  OUTPUT FILE LAYOUT FOR UPDATE OF REFUNDS                       01030005
010400******************************************************************01040005
010500     COPY RDRD037.                                                01050011
010600                                                                  01060005
010700 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      01070001
010800                                                  COMP SYNC.      01080001
010900     88  AC-CONTROL-CARD-ERROR                    VALUE +4003.    01090001
011000     88  AC-DB2-ERROR                             VALUE +4013.    01100001
011100     88  AC-CALENDAR-ROUTINE-ERROR                VALUE +4019.    01110001
011200                                                                  01120001
011300                                                                  01130001
011400 01  PS-PROGRAM-SWITCHES.                                         01140001
011500     05  PS-END-OF-CURSOR-SW           PIC X(01)  VALUE 'N'.      01150001
011600         88  PS-END-OF-CURSOR                     VALUE 'Y'.      01160001
011700     05  PS-END-OF-CARD-FILE-SW        PIC X(01)  VALUE 'N'.      01170001
011800         88  PS-END-OF-CARD-FILE                  VALUE 'Y'.      01180001
011900     05  PS-DATA-PRESENT-SW            PIC X(01)  VALUE 'N'.      01190001
012000         88  PS-DATA-PRESENT                      VALUE 'Y'.      01200001
012100                                                                  01210001
012200 01  PC-CONSTANTS.                                                01220001
012300     05  PC-ROW-NOT-FOUND            PIC S9(04)    VALUE +100     01230001
012400                                                   COMP SYNC.     01240001
012500     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          01250001
012600                                                   'RDKRP022'.    01260001
012700                                                                  01270013
012800 01  PV-MISC-COUNT-FIELDS.                                        01280001
012900     05  PV-REFUND-RCDS-WRITTEN      PIC S9(05)    VALUE ZERO     01290005
013000                                                   COMP-3.        01300005
013100     05  PV-REFUND-RCDS-DISPLAY      PIC ZZ,ZZ9    VALUE ZERO.    01310005
013200******************************************************************01320001
013300*  FIELDS TO HOLD TOTALS FOR PRINTING A REPORT TOTAL LINE.        01330001
013400******************************************************************01340001
013500 01  PV-TOT-ACCUM-FIELDS.                                         01350001
013600     05  PV-TOT-STORE-AMOUNT         PIC S9(07)V99 COMP-3         01360001
013700                                                   VALUE ZERO.    01370001
013800     05  PV-TOT-COMPANY-AMOUNT       PIC S9(07)V99 COMP-3         01380001
013900                                                   VALUE ZERO.    01390001
014000                                                                  01400001
014100 01  PV-MISC-FIELDS.                                              01410001
014200     05  PV-EPRFN-STR-NBR            PIC S9(04)    VALUE ZERO     01420001
014300                                                   COMP SYNC.     01430001
014400     05  PV-SAVE-STR-NBR             PIC S9(04)    VALUE ZERO     01440001
014500                                                   COMP SYNC.     01450001
014600     05  PV-PHONE-NBR                PIC 9(07)     VALUE ZERO.    01460001
014700     05  PV-PHONE-RD037.                                          01470008
014800         10  PV-PHONE-AC             PIC X(03)     VALUE SPACES.  01480008
014900         10  FILLER                  PIC X(01)     VALUE '-'.     01490008
015000         10  PV-PHONE-EXCH           PIC X(03)     VALUE SPACES.  01500008
015100         10  FILLER                  PIC X(01)     VALUE '-'.     01510008
015200         10  PV-PHONE-NO             PIC X(04)     VALUE SPACES.  01520008
015300     05  PV-DRV-LIC-NBR.                                          01530005
015400         10  PV-DRV-LIC-FIRST-SEVEN  PIC X(07).                   01540005
015500             88  PV-DUMMY-DL                    VALUE '9810000'   01550005
015600                                                      '0123456'   01560005
015700                                                      '1234567'   01570005
015800                                                      '8738738'   01580007
015900                                                      '1111111'   01590005
016000                                                      '2222222'   01600005
016100                                                      '3333333'   01610005
016200                                                      '4444444'   01620005
016300                                                      '5555555'   01630005
016400                                                      '6666666'   01640005
016500                                                      '7777777'   01650005
016600                                                      '8888888'   01660005
016700                                                      '9999999'   01670005
016800                                                      '0000000'.  01680005
016900         10  PV-DRV-LIC-REST         PIC X(18).                   01690005
017000     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACE.   01700001
017100     05  PV-OPERATION-MSG-1          PIC  X(40)    VALUE SPACE.   01710001
017200     05  PV-OPERATION-MSG-2          PIC  X(40)    VALUE SPACE.   01720001
017300     05  PV-DB2-OPERATION            PIC  X(30)    VALUE SPACE.   01730001
017400                                                                  01740001
017500 01  PV-DATE-AND-TIME-FIELDS.                                     01750001
017600     05  PV-POS-CCYY-MM-DD           PIC X(10)     VALUE SPACE.   01760001
017700     05  FILLER REDEFINES PV-POS-CCYY-MM-DD.                      01770001
017800         10  PV-POS-CCYY             PIC X(04).                   01780001
017900         10  FILLER                  PIC X(01).                   01790001
018000         10  PV-POS-MM               PIC X(02).                   01800001
018100         10  FILLER                  PIC X(01).                   01810001
018200         10  PV-POS-DD               PIC X(02).                   01820001
018300     05  PV-CURR-DATE-CCYYMMDD.                                   01830001
018400         10  PV-CURR-DATE-CCYY       PIC  9(04).                  01840001
018500         10  PV-CURR-DATE-MM         PIC  9(02).                  01850001
018600         10  PV-CURR-DATE-DD         PIC  9(02).                  01860001
018700     05  PV-CURR-TIME.                                            01870001
018800         10  PV-CURR-TIME-HH         PIC  9(02)    VALUE ZERO.    01880001
018900         10  PV-CURR-TIME-MM         PIC  9(02)    VALUE ZERO.    01890001
019000         10  PV-CURR-TIME-SSHH       PIC  9(04)    VALUE ZERO.    01900001
019100                                                                  01910001
019200******************************************************************01920001
019300*  TOP OF PAGE HEADING LINE FOR PRINTING A 132 CHARACTER REPORT.  01930001
019400******************************************************************01940001
019500     COPY DPWS132.                                                01950001
019600                                                                  01960001
019700******************************************************************01970001
019800*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            01980001
019900******************************************************************01990001
020000     COPY DPWS004.                                                02000011
020100******************************************************************02010001
020200*  DB2 COMMUNICATION AREA.                                        02020001
020300******************************************************************02030001
020400     EXEC SQL                                                     02040001
020500          INCLUDE SQLCA                                           02050001
020600     END-EXEC.                                                    02060001
020700******************************************************************02070001
020800*  DB2 TABLE DB2PDBA.TEPPART - COSA-PARTITIONING TABLE            02080001
020900******************************************************************02090001
021000     EXEC SQL                                                     02100001
021100          INCLUDE TEPPART                                         02110001
021200     END-EXEC.                                                    02120001
021300******************************************************************02130001
021400*  DB2 TABLE DB2PDBA.TEPDKEY - COSA-PROCESSING DAY KEY TABLE      02140001
021500******************************************************************02150001
021600     EXEC SQL                                                     02160001
021700          INCLUDE TEPDKEY                                         02170001
021800     END-EXEC.                                                    02180001
021900******************************************************************02190001
022000*  DB2 TABLE DB2PDBA.TEPRFN - COSA-CORPORATE REFUND TABLE         02200001
022100******************************************************************02210001
022200     EXEC SQL                                                     02220001
022300          INCLUDE TEPRFN                                          02230001
022400     END-EXEC.                                                    02240001
022500******************************************************************02250001
022600*  DB2 TABLE DB2PDBA.TEPTND - COSA-TENDER TABLE                   02260001
022700******************************************************************02270001
022800     EXEC SQL                                                     02280001
022900          INCLUDE TEPTND                                          02290001
023000     END-EXEC.                                                    02300001
023100******************************************************************02310001
023200*  DB2 TABLE DB2PDBA.TEPTRN - COSA-TRANSACTION TABLE              02320001
023300******************************************************************02330001
023400     EXEC SQL                                                     02340001
023500          INCLUDE TEPTRN                                          02350001
023600     END-EXEC.                                                    02360001
023700******************************************************************02370001
023800*  CORPORATE REFUND CURSOR (CURSOR TO PRODUCE THE REPORT)         02380001
023900******************************************************************02390001
024000     EXEC SQL                                                     02400001
024100       DECLARE REFUND-CURSOR CURSOR FOR                           02410001
024200            SELECT  B.PARTN_NBR                                   02420001
024300                   ,B.STR_NBR                                     02430001
024400                   ,B.RGST_ID                                     02440001
024500                   ,B.TRN_NBR                                     02450001
024600                   ,B.STRT_TM                                     02460001
024700                   ,B.SLS_CORR_SEQ_NBR                            02470001
024800                   ,B.CUST_1ST_NM                                 02480001
024900                   ,B.CUST_LAST_NM                                02490001
025000                   ,B.ADDR_LNE_DESC                               02500001
025100                   ,B.CTY_NM                                      02510001
025200                   ,B.ST_CDE                                      02520001
025300                   ,B.ZIP_CDE                                     02530001
025400                   ,B.AREA_CDE                                    02540001
025500                   ,B.PHN_NBR                                     02550001
025600                   ,B.DRV_LIC_NBR                                 02560001
025700                   ,C.TNDR_AMT                                    02570001
025800                   ,D.SLS_DTE                                     02580001
025900            FROM  TEPRFN B                                        02590001
026000                 ,TEPTND C                                        02600001
026100                 ,TEPPART D                                       02610001
026200                 ,TEPTRN E                                        02620002
026300            WHERE   B.PARTN_NBR        = C.PARTN_NBR              02630001
026400              AND   B.STR_NBR          = C.STR_NBR                02640001
026500              AND   B.RGST_ID          = C.RGST_ID                02650001
026600              AND   B.TRN_NBR          = C.TRN_NBR                02660001
026700              AND   B.STRT_TM          = C.STRT_TM                02670001
026800              AND   B.SLS_CORR_SEQ_NBR = C.SLS_CORR_SEQ_NBR       02680001
026900              AND   B.TNDR_SEQ_NBR     = C.TNDR_SEQ_NBR           02690001
027000              AND   E.PARTN_NBR        = B.PARTN_NBR              02700002
027100              AND   E.STR_NBR          = B.STR_NBR                02710002
027200              AND   E.RGST_ID          = B.RGST_ID                02720002
027300              AND   E.TRN_NBR          = B.TRN_NBR                02730002
027400              AND   E.STRT_TM          = B.STRT_TM                02740002
027500              AND   E.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR       02750002
027600              AND   B.PARTN_NBR        = D.PARTN_NBR              02760001
027700              AND   D.SLS_DTE          = :PV-POS-CCYY-MM-DD       02770002
027800              AND   D.DB_STRUC_CDE     = 'O'                      02780001
027900              AND   C.TNDR_VOID_IND    = 'N'                      02790001
028000              AND   E.VOID_ABRT_CDE    = 'N'                      02800002
028100              AND   E.TRN_STAT_CDE     = 'Z'                      02810019
028200         UNION ALL                                                02820001
028300            SELECT  B.PARTN_NBR                                   02830001
028400                   ,B.STR_NBR                                     02840001
028500                   ,B.RGST_ID                                     02850001
028600                   ,B.TRN_NBR                                     02860001
028700                   ,B.STRT_TM                                     02870001
028800                   ,B.SLS_CORR_SEQ_NBR                            02880001
028900                   ,B.CUST_1ST_NM                                 02890001
029000                   ,B.CUST_LAST_NM                                02900001
029100                   ,B.ADDR_LNE_DESC                               02910001
029200                   ,B.CTY_NM                                      02920001
029300                   ,B.ST_CDE                                      02930001
029400                   ,B.ZIP_CDE                                     02940001
029500                   ,B.AREA_CDE                                    02950001
029600                   ,B.PHN_NBR                                     02960001
029700                   ,B.DRV_LIC_NBR                                 02970001
029800                   ,C.TNDR_AMT                                    02980001
029900                   ,D.SLS_DTE                                     02990001
030000            FROM  TEPDKEY A                                       03000001
030100                 ,TEPRFN B                                        03010001
030200                 ,TEPTND C                                        03020001
030300                 ,TEPPART D                                       03030001
030400                 ,TEPTRN E                                        03040002
030500            WHERE   A.PRCG_DTE         = :EPDKEY-PRCG-DTE         03050001
030600              AND   A.SLS_DTE          = D.SLS_DTE                03060001
030700              AND   A.STR_NBR          = B.STR_NBR                03070001
030800              AND   A.RGST_ID          = B.RGST_ID                03080001
030900              AND   A.TRN_NBR          = B.TRN_NBR                03090001
031000              AND   A.STRT_TM          = B.STRT_TM                03100001
031100              AND   A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR       03110001
031200              AND   B.PARTN_NBR        = C.PARTN_NBR              03120001
031300              AND   B.STR_NBR          = C.STR_NBR                03130001
031400              AND   B.RGST_ID          = C.RGST_ID                03140001
031500              AND   B.TRN_NBR          = C.TRN_NBR                03150001
031600              AND   B.STRT_TM          = C.STRT_TM                03160001
031700              AND   B.SLS_CORR_SEQ_NBR = C.SLS_CORR_SEQ_NBR       03170001
031800              AND   B.TNDR_SEQ_NBR     = C.TNDR_SEQ_NBR           03180001
031900              AND   E.PARTN_NBR        = B.PARTN_NBR              03190002
032000              AND   E.STR_NBR          = B.STR_NBR                03200002
032100              AND   E.RGST_ID          = B.RGST_ID                03210002
032200              AND   E.TRN_NBR          = B.TRN_NBR                03220002
032300              AND   E.STRT_TM          = B.STRT_TM                03230002
032400              AND   E.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR       03240002
032500              AND   B.PARTN_NBR        = D.PARTN_NBR              03250001
032600              AND   D.DB_STRUC_CDE     = 'O'                      03260001
032700              AND   C.TNDR_VOID_IND    = 'N'                      03270001
032800              AND   E.VOID_ABRT_CDE = 'N'                         03280002
032900              AND   E.TRN_STAT_CDE IN ('V','L')                   03290019
033000              WITH UR                                             03300001
033100     END-EXEC.                                                    03310001
033200                                                                  03320001
033300***************************************************************** 03330001
033400* PROCEDURE DIVISION.                                           * 03340001
033500***************************************************************** 03350001
033600 PROCEDURE DIVISION.                                              03360001
033700                                                                  03370001
033800******************************************************************03380001
033900* 0000-MAINLINE-PARAGRAPH                                         03390001
034000*      PRODUCE CORPORATE REFUNDS REPORT                           03400001
034100******************************************************************03410001
034200 0000-MAINLINE-PARAGRAPH.                                         03420001
034300                                                                  03430001
034400     PERFORM 1000-INITIALIZE-PROGRAM.                             03440001
034500     PERFORM 2000-PROCESS-DATA                                    03450013
034600       UNTIL PS-END-OF-CURSOR.                                    03460001
034700     PERFORM 3000-END-OF-JOB.                                     03470013
034800                                                                  03480001
034900     STOP RUN.                                                    03490001
035000                                                                  03500001
035100******************************************************************03510001
035200* 1000-INITIALIZE-PROGRAM                                         03520001
035300*     OPEN FILES, PROCESS CONTROL CARD, FORMAT REPORT HEADINGS,   03530001
035400*     OPEN REFUND-CURSOR, ATTEMPT FIRST FETCH OF CURSOR.          03540001
035500******************************************************************03550001
035600 1000-INITIALIZE-PROGRAM.                                         03560001
035700                                                                  03570001
035800     OPEN INPUT  POS-DATE-CARD-FILE                               03580001
035900          OUTPUT REFUND-OUTPUT-FILE.                              03590005
036000                                                                  03600001
036100     PERFORM 1100-PROCESS-CONTROL-CARD.                           03610001
036200                                                                  03620013
036300     PERFORM 7000-OPEN-REFUND-CURSOR.                             03630013
036400     PERFORM 7100-FETCH-REFUND-CURSOR.                            03640013
036500                                                                  03650014
036600     IF PS-END-OF-CURSOR                                          03660013
036700         DISPLAY '*** NO REFUND DATA PRESENT ON TEPRFN FOR '      03670013
036800                 'PROCESS DATE '  PV-POS-CCYY-MM-DD    ' ***'     03680013
036900         DISPLAY '*** NO LATE TRANSACTION DATA PRESENT ON T'      03690013
037000                 'EPDKEY           ***'                           03700013
037100         DISPLAY '*** NO CORP REFUND REPORT WILL BE PRODUCE'      03710013
037200                 'D FOR ' CC-POS-DATE '**'                        03720015
037300     ELSE                                                         03730013
037400         SET PS-DATA-PRESENT TO TRUE                              03740013
037500     END-IF.                                                      03750013
037600                                                                  03760002
037700******************************************************************03770001
037800* 1100-PROCESS-CONTROL-CARD                                       03780001
037900*     READ CONTROL CARD TO GET POS DATE.  CALL DATE ROUTINE TO    03790002
038000*     VALIDATE DATE.                                              03800002
038100******************************************************************03810001
038200 1100-PROCESS-CONTROL-CARD.                                       03820001
038300                                                                  03830001
038400     PERFORM 1110-READ-POS-DATE-CARD-FILE.                        03840001
038500     CLOSE POS-DATE-CARD-FILE.                                    03850001
038600     IF PS-END-OF-CARD-FILE                                       03860001
038700         MOVE '1100-PROCESS-CONTROL-CARD'  TO PV-PARAGRAPH-NAME   03870001
038800         MOVE 'NO CONTROL CARD TO PROCESS' TO PV-OPERATION-MSG-1  03880001
038900         SET AC-CONTROL-CARD-ERROR TO TRUE                        03890001
039000         PERFORM 9999-ABEND                                       03900001
039100     END-IF.                                                      03910001
039200     DISPLAY PC-CURRENT-PROGRAM-NAME                              03920001
039300             ' - CONTROL CARD = (' CC-CONTROL-CARD-DISPLAY  ')'.  03930001
039400     PERFORM 1115-VALIDATE-INPUT-DATE.                            03940002
039500                                                                  03950002
039600******************************************************************03960001
039700* 1110-READ-POS-DATE-CARD-FILE                                    03970001
039800*     READ DATE CONTROL CARD.                                     03980001
039900******************************************************************03990001
040000 1110-READ-POS-DATE-CARD-FILE.                                    04000001
040100                                                                  04010002
040200     READ POS-DATE-CARD-FILE INTO CC-CONTROL-CARD                 04020001
040300        AT END                                                    04030001
040400           SET PS-END-OF-CARD-FILE TO TRUE.                       04040001
040500                                                                  04050001
040600******************************************************************04060001
040700* 1115-VALIDATE-INPUT-DATE                                        04070002
040800*     CALL KOHLS CALENDAR ROUTINE:                                04080001
040900*         PASS: CONTROL CARD POS DATE (CCYY-MM-DD FORMAT).        04090002
041000*       RETURN: ACTUAL CALENDAR DB2 ISO DATE (CCYY-MM-DD FORMAT). 04100001
041100******************************************************************04110001
041200 1115-VALIDATE-INPUT-DATE.                                        04120002
041300                                                                  04130001
041400     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              04140001
041500                                                                  04150001
041600     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   04160001
041700     SET  DPG52-LK-DTE-ISO-FMT         TO TRUE.                   04170002
041800     MOVE CC-POS-DATE                  TO DPG52-LK-DATE-INPUT.    04180001
041900     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    04190001
042000                                             DPG54 DPG55 DPG56.   04200001
042100     EVALUATE TRUE                                                04210001
042200         WHEN DPG54-SEVERE-ERROR                                  04220001
042300         WHEN DPG54-DATE-INVALID                                  04230001
042400             MOVE '1115-VALIDATE-INPUT-DATE'                      04240002
042500                                           TO PV-PARAGRAPH-NAME   04250001
042600             MOVE 'ERROR VALIDATING INPUT CARD DATE'              04260002
042700                                           TO PV-OPERATION-MSG-1  04270001
042800             SET AC-CALENDAR-ROUTINE-ERROR TO TRUE                04280001
042900             MOVE DPG54-ERROR-MESSAGE      TO PV-OPERATION-MSG-2  04290001
043000             PERFORM 9999-ABEND                                   04300001
043100     END-EVALUATE.                                                04310001
043200                                                                  04320001
043300     MOVE DPG55-DB2-ISO-DATE-FMT       TO PV-POS-CCYY-MM-DD       04330001
043400                                          EPDKEY-PRCG-DTE.        04340001
043500                                                                  04350001
043600******************************************************************04360001
043700* 2000-PROCESS-DATA                                               04370013
043800*     PROCESS CURSOR DATA                                         04380001
043900******************************************************************04390001
044000 2000-PROCESS-DATA.                                               04400013
044100                                                                  04410001
044200     PERFORM 5000-FORMAT-OUTPUT.                                  04420013
044300     PERFORM 6000-WRITE-REFUND-RECORD.                            04430005
044400     PERFORM 7100-FETCH-REFUND-CURSOR.                            04440001
044500                                                                  04450001
044600******************************************************************04460001
044700* 3000-END-OF-JOB                                                 04470013
044800*     CLOSE CURSOR,                                               04480013
044900*     CLOSE OUTPUT FILE.                                          04490013
045000******************************************************************04500001
045100 3000-END-OF-JOB.                                                 04510013
045200                                                                  04520001
045300     PERFORM 7200-CLOSE-REFUND-CURSOR.                            04530001
045400                                                                  04540001
045500     MOVE PV-REFUND-RCDS-WRITTEN TO PV-REFUND-RCDS-DISPLAY.       04550005
045600     DISPLAY 'REFUND RECORDS WRITTEN ' PV-REFUND-RCDS-DISPLAY.    04560005
045700                                                                  04570005
045800     CLOSE REFUND-OUTPUT-FILE.                                    04580013
045900                                                                  04590001
046000******************************************************************04600001
046100* 5000-FORMAT-OUTPUT                                              04610013
046200*     FORMAT AND PRINT REPORT DETAIL LINE.                        04620001
046300******************************************************************04630001
046400 5000-FORMAT-OUTPUT.                                              04640013
046500                                                                  04650001
046600     MOVE EPPART-SLS-DTE         TO  RD037-RFND-REQ-DTE.          04660005
046700     MOVE EPRFN-STR-NBR          TO  RD037-STR-NBR.               04670005
046800     MOVE EPRFN-RGST-ID          TO  RD037-STR-RGST-ID.           04680013
046900     MOVE EPRFN-TRN-NBR          TO  RD037-RGST-TRN-NBR.          04690013
047000                                                                  04700011
047100     IF EPRFN-SLS-CORR-SEQ-NBR < 0                                04710013
047200         COMPUTE EPRFN-SLS-CORR-SEQ-NBR = EPRFN-SLS-CORR-SEQ-NBR  04720011
047300                                        * -1                      04730011
047400     END-IF.                                                      04740011
047500                                                                  04750011
047600     MOVE EPRFN-SLS-CORR-SEQ-NBR TO  RD037-RFND-SEQ-NBR.          04760005
047700     MOVE EPRFN-CUST-LAST-NM     TO  RD037-LAST-NM.               04770013
047800     MOVE EPRFN-CUST-1ST-NM      TO  RD037-FRST-NM.               04780013
047900     MOVE EPRFN-ADDR-LNE-DESC    TO  RD037-M2A-LNE-1-ADDR.        04790013
048000     MOVE EPRFN-CTY-NM           TO  RD037-M2A-CTY-NM.            04800013
048100     MOVE EPRFN-ST-CDE           TO  RD037-M2A-ST-CDE.            04810013
048200     MOVE EPRFN-ZIP-CDE          TO  RD037-M2A-PSTL-CDE.          04820013
048300                                                                  04830005
048400     MOVE EPRFN-DRV-LIC-NBR      TO  PV-DRV-LIC-NBR.              04840013
048500                                                                  04850013
048600     IF PV-DUMMY-DL                                               04860006
048700         MOVE SPACES             TO  RD037-DRV-LIC-NBR            04870005
048800     ELSE                                                         04880005
048900         MOVE EPRFN-DRV-LIC-NBR  TO  RD037-DRV-LIC-NBR            04890005
049000     END-IF.                                                      04900005
049100                                                                  04910005
049200     MOVE EPRFN-AREA-CDE         TO  PV-PHONE-AC.                 04920013
049300     MOVE EPRFN-PHN-NBR          TO  PV-PHONE-NBR.                04930009
049400     MOVE PV-PHONE-NBR(1:3)      TO  PV-PHONE-EXCH.               04940013
049500     MOVE PV-PHONE-NBR(4:4)      TO  PV-PHONE-NO.                 04950013
049600                                                                  04960009
049700     IF EPRFN-PHN-NBR GREATER THAN 0                              04970008
049800         MOVE PV-PHONE-RD037     TO  RD037-PHN-NBR                04980013
049900     ELSE                                                         04990008
050000         MOVE SPACES             TO  RD037-PHN-NBR                05000013
050100     END-IF.                                                      05010008
050200                                                                  05020008
050300     MOVE EPTND-TNDR-AMT         TO RD037-RFND-AMT.               05030013
050400                                                                  05040001
050500     ADD  EPTND-TNDR-AMT         TO  PV-TOT-STORE-AMOUNT.         05050013
050600                                                                  05060001
050700******************************************************************05070001
050800* 6000-WRITE-REFUND-RECORD.                                       05080005
050900******************************************************************05090001
051000 6000-WRITE-REFUND-RECORD.                                        05100005
051100                                                                  05110002
051200     WRITE REFUND-OUTPUT-RECORD FROM RD037-RECORD.                05120005
051300                                                                  05130005
051400     ADD +1 TO PV-REFUND-RCDS-WRITTEN.                            05140005
051500                                                                  05150005
051600******************************************************************05160005
051700* 7000-OPEN-REFUND-CURSOR                                         05170005
051800******************************************************************05180005
051900 7000-OPEN-REFUND-CURSOR.                                         05190005
052000                                                                  05200005
052100     EXEC SQL                                                     05210001
052200          OPEN REFUND-CURSOR                                      05220001
052300     END-EXEC.                                                    05230001
052400                                                                  05240001
052500     EVALUATE TRUE                                                05250001
052600         WHEN SQLCODE = ZERO                                      05260001
052700              CONTINUE                                            05270001
052800         WHEN SQLWARN0 NOT EQUAL SPACE                            05280001
052900         WHEN SQLCODE NOT EQUAL ZERO                              05290001
053000             MOVE '7000-OPEN-REFUND-CURSOR'                       05300001
053100                                            TO PV-PARAGRAPH-NAME  05310001
053200             MOVE 'ERROR ON OPEN OF REFUND-CURSOR'                05320001
053300                                            TO PV-DB2-OPERATION   05330001
053400             PERFORM 9100-SQL-ABEND                               05340001
053500     END-EVALUATE.                                                05350001
053600                                                                  05360001
053700******************************************************************05370001
053800* 7100-FETCH-REFUND-CURSOR                                        05380001
053900******************************************************************05390001
054000 7100-FETCH-REFUND-CURSOR.                                        05400001
054100                                                                  05410002
054200     EXEC SQL                                                     05420001
054300          FETCH REFUND-CURSOR                                     05430001
054400           INTO :EPRFN-PARTN-NBR                                  05440001
054500               ,:EPRFN-STR-NBR                                    05450001
054600               ,:EPRFN-RGST-ID                                    05460001
054700               ,:EPRFN-TRN-NBR                                    05470001
054800               ,:EPRFN-STRT-TM                                    05480001
054900               ,:EPRFN-SLS-CORR-SEQ-NBR                           05490001
055000               ,:EPRFN-CUST-1ST-NM                                05500001
055100               ,:EPRFN-CUST-LAST-NM                               05510001
055200               ,:EPRFN-ADDR-LNE-DESC                              05520001
055300               ,:EPRFN-CTY-NM                                     05530001
055400               ,:EPRFN-ST-CDE                                     05540001
055500               ,:EPRFN-ZIP-CDE                                    05550001
055600               ,:EPRFN-AREA-CDE                                   05560001
055700               ,:EPRFN-PHN-NBR                                    05570001
055800               ,:EPRFN-DRV-LIC-NBR                                05580001
055900               ,:EPTND-TNDR-AMT                                   05590001
056000               ,:EPPART-SLS-DTE                                   05600001
056100     END-EXEC.                                                    05610001
056200                                                                  05620001
056300     EVALUATE TRUE                                                05630001
056400         WHEN SQLCODE = ZERO                                      05640001
056500             MOVE EPRFN-STR-NBR  TO  PV-EPRFN-STR-NBR             05650001
056600         WHEN SQLCODE = PC-ROW-NOT-FOUND                          05660001
056700             SET PS-END-OF-CURSOR TO TRUE                         05670001
056800         WHEN SQLWARN0 NOT EQUAL SPACE                            05680001
056900         WHEN SQLCODE NOT EQUAL ZERO                              05690001
057000             MOVE '7100-FETCH-REFUND-CURSOR'                      05700001
057100                                            TO PV-PARAGRAPH-NAME  05710001
057200             MOVE 'ERROR ON FETCH OF REFUND-CURSOR'               05720001
057300                                            TO PV-DB2-OPERATION   05730001
057400             PERFORM 9100-SQL-ABEND                               05740001
057500     END-EVALUATE.                                                05750001
057600                                                                  05760001
057700******************************************************************05770001
057800* 7200-CLOSE-REFUND-CURSOR                                        05780001
057900******************************************************************05790001
058000 7200-CLOSE-REFUND-CURSOR.                                        05800001
058100                                                                  05810001
058200     EXEC SQL                                                     05820001
058300          CLOSE REFUND-CURSOR                                     05830001
058400     END-EXEC.                                                    05840001
058500                                                                  05850001
058600     EVALUATE TRUE                                                05860001
058700         WHEN SQLCODE = ZERO                                      05870001
058800              CONTINUE                                            05880001
058900         WHEN SQLWARN0 NOT EQUAL SPACE                            05890001
059000         WHEN SQLCODE NOT EQUAL ZERO                              05900001
059100             MOVE '7200-CLOSE-REFUND-CURSOR'                      05910001
059200                                            TO PV-PARAGRAPH-NAME  05920001
059300             MOVE 'ERROR ON CLOSE OF REFUND-CURSOR'               05930001
059400                                            TO PV-DB2-OPERATION   05940001
059500             PERFORM 9100-SQL-ABEND                               05950001
059600     END-EVALUATE.                                                05960001
059700                                                                  05970001
059800******************************************************************05980001
059900* 9100-SQL-ABEND                                                  05990001
060000*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.06000001
060100******************************************************************06010001
060200 9100-SQL-ABEND.                                                  06020001
060300                                                                  06030002
060400     DISPLAY '** ABEND     **'.                                   06040001
060500     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        06050001
060600     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              06060001
060700     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               06070001
060800                                                                  06080001
060900******************************************************************06090001
061000* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     06100001
061100* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      06110001
061200******************************************************************06120001
061300     COPY DPPD004.                                                06130011
061400                                                                  06140001
061500     SET AC-DB2-ERROR TO TRUE.                                    06150001
061600     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         06160001
061700                                                                  06170001
061800******************************************************************06180001
061900* 9999-ABEND                                                      06190001
062000*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  06200001
062100******************************************************************06210001
062200 9999-ABEND.                                                      06220001
062300                                                                  06230002
062400     DISPLAY '** ABEND           **'.                             06240001
062500     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  06250001
062600     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        06260001
062700     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       06270001
062800     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       06280001
062900     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         06290001
