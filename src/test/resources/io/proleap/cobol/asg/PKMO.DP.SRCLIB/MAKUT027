000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.    MAKUT027.                                         00020000
000300 AUTHOR.        JEFF BOLWERK.                                     00030000
000400 DATE-WRITTEN.  SEPTEMBER 11, 1995.                               00040000
000500******************************************************************00050000
000600*    MA - CREATE WEEKLY SALES LOAD                                00060000
000700******************************************************************00070000
000800*    THE PURPOSE OF THIS PROGRAM IS TO CREATE A SALES TABLE LOAD  00080000
000900*    FILE CONSISTING OF THE ITEM CLUSTER ID, THE ORG UNIT CLUSTER 00090000
001000*    ID, AND THE SALES QUANTITY ASSOCIATED WITH THIS SKU/STORE.   00100000
001100*    THE INPUT EXTRACT FILE SKU AND STORE NUMBERS WILL BE         00110000
001200*    CONVERTED INTO THE ITEM CLUSTER ID AND ORG UNIT CLUSTER ID BY00120000
001300*    RETRIEVING DATE FROM ORACLE TABLES TITMCLT AND TORGCLT.      00130000
001400*                                                                 00140000
001500*    REMOVED TEH PROGRAM CONSTANTS FROM THE SELECT STATEMENTS     00150000
001600*    FOR PERFORMANCE ENHANCEMENT.                                 00160000
001700*                                                                 00170000
001800*    FRANK SANTANDREA     12/30/98                                00180000
001900*                                                                 00190000
002000*  06/17/2003 RON FOX                     WR# 21120               00200000
002100*   - CHANGES FOR NON-INTELLIGENT SKU                             00210000
002200*                                                                 00220000
002300*  11/29/2004 DAVE METZGER                WR# 25478               00230000
002400*   - CHANGES FOR STORE EXPANSION                                 00240000
002500*     1) INCREASED RESTART STORE NUMBER FROM X(3) TO X(4).        00250000
002600*     2) INCREASED EXTRACT OUTPUT FILE LRECL FROM 21 TO 42.       00260000
002700*     3) CHANGED PV-ORG-CLUSTER-NAME-NUM FROM 9(3) TO 9(4).       00270000
002800*     4) REPLACED MARD019 WITH MARD017 SINCE THE SAME AND 2 PGMS  00280000
002900*        ALREADY USED MARD017.                                    00290000
003000*                                                                 00300000
003100* 03/20/2015  COGNIZANT                   PRB0052432              00310000
003200*    MODIFIED THE PROGRAM TO USE THE SKU,DEPT,CLASS AND SUBCLASS  00320000
003300*    FROM THE INPUT FILE INSTEAD OF ACCESING THE TSKXREF.         00330000
003000*                                                                 00340003
003100* 07/30/2018  COGNIZANT                   CHG0205458              00350004
003200*    ORACLE LOGON STANDARDS PROGRAM CHANGE                        00360003
216116*                                                                 00370008
216116* 01/18/2019  JIM HUNTER                  CHG0216116              00380008
216116*    MAINFRAME REFACTORING - INCREASE ORG-CLUSTER-ID (STORE)      00390008
216116*    OCCURS FROM 3000 TO 9999.                                    00400008
003500******************************************************************00410000
003600                                                                  00420000
003700 ENVIRONMENT DIVISION.                                            00430000
003800 INPUT-OUTPUT SECTION.                                            00440000
003900 FILE-CONTROL.                                                    00450000
004000                                                                  00460000
004100     SELECT SKU-STORE-SALES-FILE                                  00470000
004200         ASSIGN TO INP01.                                         00480000
004300                                                                  00490000
004400     SELECT DATE-CONTROL-FILE                                     00500000
004500         ASSIGN TO INP02.                                         00510000
004600                                                                  00520000
004700     SELECT RUN-CONTROL-FILE                                      00530000
004800         ASSIGN TO IO01.                                          00540000
004900                                                                  00550000
005000     SELECT SALES-LOAD-FILE                                       00560000
005100         ASSIGN TO IO02.                                          00570000
005200                                                                  00580001
005300     SELECT ORACLE-LOGON-FILE                                     00590001
005310         ASSIGN TO ORALOGON.                                      00600001
005400                                                                  00610001
005500*                                                                 00620000
005600*                                                                 00630000
005700 DATA DIVISION.                                                   00640000
005800 FILE SECTION.                                                    00650000
005900 FD  SKU-STORE-SALES-FILE                                         00660000
006000     RECORDING MODE IS F                                          00670000
006100     BLOCK CONTAINS 0 RECORDS.                                    00680000
006200 01  SKU-STORE-SALES-RECORD          PIC  X(42).                  00690000
006300*                                                                 00700000
006400*                                                                 00710000
006500 FD  DATE-CONTROL-FILE                                            00720000
006600     RECORDING MODE IS F                                          00730000
006700     BLOCK CONTAINS 0 RECORDS.                                    00740000
006800 01  DATE-CONTROL-RECORD             PIC  X(20).                  00750000
006900*                                                                 00760000
007000*                                                                 00770000
007100 FD  RUN-CONTROL-FILE                                             00780000
007200     RECORDING MODE IS F                                          00790000
007300     BLOCK CONTAINS 0 RECORDS.                                    00800000
007400 01  RUN-CONTROL-RECORD              PIC  X(111).                 00810000
007500*                                                                 00820000
007600*                                                                 00830000
007700 FD  SALES-LOAD-FILE                                              00840000
007800     RECORDING MODE IS F                                          00850000
007900     BLOCK CONTAINS 0 RECORDS.                                    00860000
008000 01  SALES-LOAD-RECORD               PIC  X(52).                  00870000
008010                                                                  00880001
008011 FD  ORACLE-LOGON-FILE                                            00890001
008012     RECORDING MODE IS F                                          00900001
008013     LABEL RECORDS ARE STANDARD                                   00910001
008014     BLOCK CONTAINS 0 RECORDS                                     00920001
008015     RECORD CONTAINS 80 CHARACTERS                                00930001
008016     DATA RECORDS IS OL-ORACLE-LOGON-RECORD.                      00940001
008017                                                                  00950001
008018 01  OL-ORACLE-LOGON-RECORD          PIC X(80).                   00960001
008040                                                                  00970001
008100*                                                                 00980000
008200*                                                                 00990000
008300 WORKING-STORAGE SECTION.                                         01000000
008400                                                                  01010000
008500 01  INPUT-FILE-STATUS           PIC X(2) VALUE SPACES.           01020000
008600                                                                  01030000
008700 01  PROGRAM-CONSTANTS.                                           01040000
008710     05  PC-AUTO-LOGON           PIC  X(01)  VALUE '/'.           01050001
008720     05  PC-PROGRAM-NAME         PIC  X(08)  VALUE 'MAKUT027'.    01060001
008800     05  PC-MAX-ORG-NBR          PIC  S9(04) VALUE +999 COMP.     01070000
008900     05  PC-MAX-RETRIES          PIC  S9(04) VALUE +3   COMP.     01080000
009000     05  PC-ARGUMENT-NUMBER      PIC  9(02)  VALUE 3.             01090000
009100     05  PC-WEEKLY-PERIOD-TYPE-CODE                               01100000
009200                                 PIC  X(01)  VALUE 'W'.           01110000
009300                                                                  01120000
009400 01  PROGRAM-VARIABLES.                                           01130000
009410     05  PV-ORACLE-USERID-LEN    PIC S9(04) VALUE ZEROS           01140001
009420                                            COMP SYNC.            01150001
009430     05  PV-ORACLE-PASSWORD-LEN  PIC S9(04) VALUE ZEROS           01160001
009440                                            COMP SYNC.            01170001
009500     05  PV-CHECKPOINT-REC-COUNT PIC S9(09) VALUE +0 COMP.        01180000
009600     05  PV-EXTRACT-NO-ITEM-COUNT                                 01190000
009700                                 PIC S9(09) VALUE +0 COMP.        01200000
009800     05  PV-SALE-LOAD-REC-COUNT  PIC S9(09) VALUE +0 COMP.        01210000
009900     05  PV-INVALID-STORE-COUNT  PIC S9(09) VALUE +0 COMP.        01220000
010000     05  PV-SKU-MULT-ITEMS-COUNT PIC S9(09) VALUE +0 COMP.        01230000
010100     05  PV-SKU-NO-ITEM-COUNT    PIC S9(09) VALUE +0 COMP.        01240000
010200     05  PV-ITEM-NO-XREF-COUNT   PIC S9(09) VALUE +0 COMP.        01250000
010300     05  PV-SKU-STORE-SALE-COUNT PIC S9(09) VALUE +0 COMP.        01260000
010400     05  PV-STORE-NO-ORG-UNIT-COUNT                               01270000
010500                                 PIC S9(09) VALUE +0 COMP.        01280000
010600     05  PV-ABEND-CODE           PIC S9(04) VALUE +0 COMP.        01290000
010700     05  PV-RETRY-COUNTER        PIC S9(04) VALUE +0 COMP.        01300000
010800     05  PV-SUB                  PIC S9(04) VALUE +0 COMP.        01310000
010900     05  PV-SUB-ORG-CLUSTER      PIC S9(04) VALUE +0 COMP.        01320000
011000     05  PV-SUB-STORE            PIC S9(04) VALUE +0 COMP.        01330000
011100     05  PV-ABEND-PARAGRAPH      PIC X(30)  VALUE SPACES.         01340000
011200     05  PV-HOLD-ITEM-NBR        PIC 9(15)  VALUE 0.              01350000
011300     05  PV-HOLD-ITEM-NBR-X REDEFINES PV-HOLD-ITEM-NBR.           01360000
011400         10  PV-HOLD-ITEM-NBR-S  PIC X(15).                       01370000
011500     05  PV-HOLD-CLUSTER-NAME.                                    01380000
011600         10  PV-HOLD-CLUSTER-NAME-DEPT    PIC X(3) VALUE SPACES.  01390000
011700         10  FILLER                       PIC X(1) VALUE '-'.     01400000
011800         10  PV-HOLD-CLUSTER-NAME-CLASS   PIC X(2) VALUE SPACES.  01410000
011900         10  FILLER                       PIC X(1) VALUE '-'.     01420000
012000         10  PV-HOLD-CLUSTER-NAME-NISKU   PIC X(8) VALUE SPACES.  01430000
012100     05  PV-RESTART-STORE            PIC X(04)  VALUE SPACES.     01440000
012200     05  PV-DCE-ERROR-MESSAGE-OUT                                 01450000
012300                                     PIC X(255) VALUE SPACES.     01460000
012400     05  PV-SALES-BEG-DATE.                                       01470000
012500         10  PV-SALES-DATE           PIC X(10)  VALUE SPACES.     01480000
012600         10  PV-SALES-TIME           PIC X(09)  VALUE '-00.00.00'.01490000
012700     05  PV-DATE-CONTROL-REC.                                     01500000
012800         10  PV-CONTROL-DATE         PIC X(10)  VALUE SPACES.     01510000
012900         10  FILLLER                 PIC X(10)  VALUE SPACES.     01520000
013000     05  PV-EVALUATE-SKU             PIC 9(08)  VALUE ZEROS.      01530000
013100     05  PV-SIGNIF-SKU-8             PIC 9(08)  VALUE ZEROS.      01540000
013200     05  PV-SIGNIF-SKU-7             PIC 9(07)  VALUE ZEROS.      01550000
013300     05  PV-SIGNIF-SKU-6             PIC 9(06)  VALUE ZEROS.      01560000
013400     05  PV-SIGNIF-SKU-5             PIC 9(05)  VALUE ZEROS.      01570000
013500     05  PV-SIGNIF-SKU-4             PIC 9(04)  VALUE ZEROS.      01580000
013600     05  PV-SIGNIF-SKU-3             PIC 9(03)  VALUE ZEROS.      01590000
013700     05  PV-SIGNIF-SKU-2             PIC 9(02)  VALUE ZEROS.      01600000
013800     05  PV-SIGNIF-SKU-1             PIC 9(01)  VALUE ZEROS.      01610000
013900                                                                  01620000
014000 01  PROGRAM-SWITCHES.                                            01630000
014010     05  PS-END-OF-LOGON-FILE-SW      PIC X(01)  VALUE 'N'.       01640001
014020         88  PS-END-OF-LOGON-FILE                VALUE 'Y'.       01650001
014030     05  PS-END-OF-PROC-INST-FILE-SW  PIC X(01)  VALUE 'N'.       01660001
014040         88  PS-END-OF-PROC-INST-FILE            VALUE 'Y'.       01670001
014050         88  PS-NOT-END-OF-PROC-INST-FILE        VALUE 'N'.       01680001
014060     05  PS-ORA-SRC-CTL-DONE-SW       PIC X(01)  VALUE 'N'.       01690001
014070         88  PS-ORA-SRC-EMPTY                    VALUE 'Y'.       01700001
014100     05  PS-SALE-LOAD-EOF-SW     PIC X(01)  VALUE 'N'.            01710000
014200         88 PS-SALE-LOAD-EOF                VALUE 'Y'.            01720000
014300     05  PS-SKU-STORE-SALE-EOF-SW PIC X(01) VALUE 'N'.            01730000
014400         88 PS-SKU-STORE-SALE-EOF           VALUE 'Y'.            01740000
014500     05  PS-ITEM-CLUSTR-FOUND-SW PIC X(01)  VALUE 'N'.            01750000
014600         88 PS-ITEM-CLUSTR-ID-NOT-FOUND     VALUE 'N'.            01760000
014700         88 PS-ITEM-CLUSTR-ID-FOUND         VALUE 'Y'.            01770000
014800     05  PS-ITEM-NBR-XREF-FOUND-SW PIC X(01)  VALUE 'N'.          01780000
014900         88 PS-ITEM-NBR-XREF-NOT-FOUND      VALUE 'N'.            01790000
015000         88 PS-ITEM-NBR-XREF-FOUND          VALUE 'Y'.            01800000
015100     05 PS-ORG-CLUSTS-LEFT-SWITCH PIC X     VALUE 'Y'.            01810000
015200        88 PS-MORE-ORG-CLUSTS-LEFT          VALUE 'Y'.            01820000
015300        88 PS-NO-MORE-ORG-CLUSTS-LEFT       VALUE 'N'.            01830000
015400                                                                  01840000
015401 01  CC-ORACLE-CONNECTION.                                        01850001
015402     05  CC-ORACLE-USERID             PIC X(40).                  01860001
015403         88 CC-AUTO-LOGON                         VALUE '/'.      01870001
015404     05  CC-ORACLE-PASSWORD           PIC X(40).                  01880001
015405                                                                  01890001
015500 01  PV-ORG-CLUSTER-NAME.                                         01900000
015600     05  PV-ORG-CLUSTER-NAME-NUM PIC 9(04)   VALUE ZERO.          01910000
015700     05  PV-ORG-CLUSTER-FILLER   PIC X(16)   VALUE SPACES.        01920000
015800                                                                  01930000
015900 01  RESTART-ITEM-CLUSTER-ID.                                     01940000
016000     05  RICI-ITEM-CLUSTER-NUM   PIC 9(09)   VALUE ZERO.          01950000
016100     05  FILLER                  PIC X(01)   VALUE LOW-VALUE.     01960000
016200                                                                  01970000
016300 01  RESTART-ORG-CLUSTER-ID.                                      01980000
016400     05  ROCI-ORG-CLUSTER-NUM    PIC 9(09)   VALUE ZERO.          01990000
016500     05  FILLER                  PIC X(01)   VALUE LOW-VALUE.     02000000
016600                                                                  02010000
016700 01  RUN-STATUS                  PIC X(10)  VALUE SPACES.         02020000
016800     88  RUN-IN-PROCESS                     VALUE 'IN PROCESS'.   02030000
016900     88  RUN-COMPLETE                       VALUE 'COMPLETE  '.   02040000
017000                                                                  02050000
017100 01  CICN-ITEM-CLUSTER-NAME-WS.                                   02060000
017200     05  CICN-ITEM-CLUSTER-NAME.                                  02070000
017300         10  CICN-ITEM-CLUSTER-NAME-DEPT  PIC 9(03) VALUE 0.      02080000
017400         10  FILLER                       PIC X(01) VALUE '-'.    02090000
017500         10  CICN-ITEM-CLUSTER-NAME-CLASS PIC 9(02) VALUE 0.      02100000
017600         10  FILLER                       PIC X(01) VALUE '-'.    02110000
017700         10  CICN-ITEM-CLUSTER-NAME-SKU   PIC X(08) VALUE SPACES. 02120000
017800     05  FILLER                           PIC X(05) VALUE SPACES. 02130000
017900                                                                  02140000
018000 01  ERROR-CODE                  PIC S9(04) VALUE +0 COMP.        02150000
018100     88  ERROR-1001                         VALUE -1001.          02160000
018200     88  ERROR-1002                         VALUE -1002.          02170000
018300     88  ERROR-1003                         VALUE -1003.          02180000
018400     88  ERROR-1004                         VALUE -1004.          02190000
018500     88  ERROR-1005                         VALUE -1005.          02200000
018600     88  ERROR-1006                         VALUE -1006.          02210000
018700     88  ERROR-1007                         VALUE -1007.          02220000
018800     88  ERROR-1008                         VALUE -1008.          02230000
018900     88  ERROR-1009                         VALUE -1009.          02240000
019000     88  ERROR-1011                         VALUE -1011.          02250000
019100     88  ERROR-1012                         VALUE -1012.          02260000
019200     88  ERROR-1014                         VALUE -1014.          02270000
019300     88  ERROR-1016                         VALUE -1016.          02280000
019400     88  ERROR-1017                         VALUE -1017.          02290000
019500     88  ERROR-1018                         VALUE -1018.          02300000
019600                                                                  02310000
019700 01  ERROR-1004-MESSAGE.                                          02320000
019800     05  FILLER                  PIC X(45)      VALUE             02330000
019900             'RESTART ORG UNIT CLUSTER ID NOT FOUND.  ID = '.     02340000
020000     05  E1004M-ORG-CLUSTR-ID    PIC 9(09)      VALUE ZERO.       02350000
020100                                                                  02360000
020200 01  ERROR-1011-MESSAGE.                                          02370000
020300     05  FILLER                  PIC X(41)                        02380000
020400             VALUE 'RESTART ITEM CLUSTER ID NOT FOUND.  ID = '.   02390000
020500     05  E1011M-ITEM-CLUSTR-ID   PIC 9(09)      VALUE ZERO.       02400000
020600                                                                  02410000
020700 01  ERROR-1017-MESSAGE.                                          02420000
020800     05  FILLER                  PIC X(38)                        02430000
020900             VALUE 'INVALID RUN CONTROL FILE RUN STATUS = '.      02440000
021000     05  E1017M-RUN-STATUS       PIC X(10)      VALUE SPACES.     02450000
021100                                                                  02460000
021200 01  ERROR-1018-MESSAGE.                                          02470000
021300     05  FILLER                  PIC X(33)                        02480000
021400      VALUE  'RESTART CLUSTER NAME NOT FOUND.  '.                 02490000
021500     05  E1018M-CLUSTER-NAME     PIC X(15)      VALUE SPACES.     02500000
021600                                                                  02510000
021700 01  ERROR-MESSAGE.                                               02520000
021800     05  FILLER                  PIC X(29)                        02530000
021900             VALUE '*** ERROR IN PROGRAM MAKUT027'.               02540000
022000     05  FILLER                  PIC X(14)                        02550000
022100                                 VALUE '; ERROR CODE ='.          02560000
022200     05  EM-ERROR-CODE           PIC --------9  VALUE ZERO.       02570000
022300     05  FILLER                  PIC X(15)                        02580000
022400                                 VALUE '; ERROR DESC = '.         02590000
022500     05  EM-ERROR-DESC           PIC X(65)   VALUE SPACES.        02600000
022600                                                                  02610000
022700 01  LOG-MESSAGE.                                                 02620000
022800     05  FILLER                  PIC X(23)                        02630000
022900             VALUE '*** PROGRAM MAKUT027 - '.                     02640000
023000     05  LM-MESSAGE              PIC X(109)  VALUE SPACES.        02650000
023100                                                                  02660000
023200 01  DISCONNECT-SERVER-ERRMSG.                                    02670000
023300     05  DSE-RETURN-CODE-VALUE   PIC X(12)   VALUE SPACES.        02680000
023400     05  FILLER                  PIC X(41)                        02690000
023500             VALUE ' RETURN TRYING TO DISCONNECT FROM SERVER '.   02700000
023600     05  DSE-FUNC-ID             PIC X(07)   VALUE SPACES.        02710000
023700                                                                  02720000
023800 01  ITEM-NOT-FOUND-LOG-MSG.                                      02730000
023900     05  FILLER                  PIC X(41)                        02740000
024000             VALUE 'ITEM CLUSTER ROW NOT FOUND FOR CLUSTER = '.   02750000
024100     05  INF-LM-CLSTR-NAME       PIC X(20)   VALUE SPACES.        02760000
024200                                                                  02770000
024300 01  ITEM-NOT-FOUND-XREF-LOG-MSG.                                 02780000
024400     05  FILLER                  PIC X(37)                        02790000
024500             VALUE 'ITEM NUMBER ROW NOT FOUND ON XREF  = '.       02800000
024600     05  INFXREF-LM-ITM-NBR          PIC 9(15)   VALUE 0.         02810000
024700                                                                  02820000
024800 01  INVALID-STORE-MSG.                                           02830000
024900     05  FILLER                  PIC X(35)                        02840000
025000             VALUE 'INVALID ORG CLUSTER NAME (STORE) = '.         02850000
025100     05  ISM-ORG-CLUSTR-NAME     PIC X(20)      VALUE SPACES.     02860000
025200     05  FILLER                  PIC X(43)                        02870000
025300             VALUE ' RETURNED FROM TORGCLT WITH A CLUSTER ID = '. 02880000
025400     05  ISM-ORG-CLUSTR-ID       PIC X(10)      VALUE SPACES.     02890000
025500                                                                  02900000
025600 01  MULT-ITEMS-FOUND-LOG-MSG.                                    02910000
025700     05  FILLER                  PIC X(43)                        02920000
025800             VALUE 'MULTIPLE ITEM CLUSTER ROWS FOUND FOR SKU = '. 02930000
025900     05  MIF-LM-ITM-NBR          PIC 9(15)   VALUE ZERO.          02940000
026000                                                                  02950000
026100 01  ORG-UNIT-NOT-FOUND-LOG-MSG.                                  02960000
026200     05  FILLER                  PIC X(35)                        02970000
026300             VALUE 'ORG UNIT ROW NOT FOUND FOR STORE = '.         02980000
026400     05  OUNF-LM-STORE           PIC X(03)   VALUE SPACES.        02990000
026500                                                                  03000000
026600 01  RUN-RESTART-LOG-MSG.                                         03010000
026700     05  FILLER                  PIC X(20)                        03020000
026800             VALUE '*** RUN RESTART *** '.                        03030000
026900     05  FILLER                  PIC X(33)                        03040000
027000             VALUE 'AFTER SKU STORE INV RECORD NBR = '.           03050000
027100     05  RRLM-SKU-STOR-SALE-RECS PIC Z(08)9  VALUE ZERO.          03060000
027200     05  FILLER                  PIC X(36)                        03070000
027300             VALUE ', EXISTING SALES LOAD RECORDS = '.            03080000
027400     05  RRLM-SALE-LOAD-RECS     PIC Z(08)9  VALUE ZERO.          03090000
027500                                                                  03100000
027600 01  RUN-SUMMARY-LOG-MSG1.                                        03110000
027700     05  FILLER                  PIC X(35)                        03120000
027800             VALUE 'SKU STORE SALES RECORDS READ = '.             03130000
027900     05  RSLM1-SKU-STOR-SALE-RECS PIC Z(08)9 VALUE ZERO.          03140000
028000                                                                  03150000
028100 01  RUN-SUMMARY-LOG-MSG2.                                        03160000
028200     05  FILLER                  PIC X(33)                        03170000
028300             VALUE 'SALES LOAD RECORDS WRITTEN = '.               03180000
028400     05  RSLM2-SALE-LOAD-RECS    PIC Z(08)9  VALUE ZERO.          03190000
028500                                                                  03200000
028600 01  RUN-SUMMARY-LOG-MSG3.                                        03210000
028700     05  FILLER                  PIC X(37)                        03220000
028800             VALUE 'NUMBER OF SKUS WITH NO MATCHING ITEM '.       03230000
028900     05  FILLER                  PIC X(13)                        03240000
029000             VALUE 'CLUSTER ID = '.                               03250000
029100     05  RSLM3-SKU-NO-ITEM-RECS  PIC Z(08)9  VALUE ZERO.          03260000
029200                                                                  03270000
029300 01  RUN-SUMMARY-LOG-MSG4.                                        03280000
029400     05  FILLER                  PIC X(34)                        03290000
029500             VALUE 'NUMBER OF SKUS WITH MULTIPLE ITEM '.          03300000
029600     05  FILLER                  PIC X(14)                        03310000
029700             VALUE 'CLUSTER IDS = '.                              03320000
029800     05  RSLM4-SKU-MULT-ITEMS-RECS                                03330000
029900                                 PIC Z(08)9  VALUE ZERO.          03340000
030000                                                                  03350000
030100 01  RUN-SUMMARY-LOG-MSG5.                                        03360000
030200     05  FILLER                  PIC X(43)                        03370000
030300             VALUE 'NUMBER OF SKU STORE SALES RECORDS DROPP'.     03380000
030400     05  FILLER                  PIC X(39)                        03390000
030500             VALUE 'ED DUE TO NO MATCHING ITEM CLUSTER ID= '.     03400000
030600     05  RSLM5-EXTRACT-NO-ITEM-RECS                               03410000
030700                                 PIC Z(08)9  VALUE ZERO.          03420000
030800                                                                  03430000
030900 01  RUN-SUMMARY-LOG-MSG6.                                        03440000
031000     05  FILLER                  PIC X(38)                        03450000
031100             VALUE 'NUMBER OF SKU STORE SALES RECORDS '.          03460000
031200     05  FILLER                  PIC X(38)                        03470000
031300             VALUE 'DROPPED DUE TO NO MATCHING ORG UNIT = '.      03480000
031400     05  RSLM6-STORE-NO-ORG-RECS PIC Z(08)9  VALUE ZERO.          03490000
031500                                                                  03500000
031600 01  RUN-SUMMARY-LOG-MSG7.                                        03510000
031700     05  FILLER                  PIC X(42)                        03520000
031800             VALUE 'NUMBER OF ORG CLUSTER IDS NOT LOADED INTO '.  03530000
031900     05  FILLER                  PIC X(35)                        03540000
032000             VALUE 'THE STORE TABLE DUE TO INVALID ORG '.         03550000
032100     05  FILLER                  PIC X(15)                        03560000
032200             VALUE 'CLUSTER NAME = '.                             03570000
032300     05  RSLM7-INVALID-STORE-RECS                                 03580000
032400                                 PIC Z(08)9  VALUE ZERO.          03590000
032500                                                                  03600000
032600 01  RUN-SUMMARY-LOG-MSG8.                                        03610000
032700     05  FILLER                  PIC X(37)                        03620000
032800             VALUE 'NUMBER OF ITEMS NOT FOUND ON TSKXREF '.       03630000
032900     05  FILLER                  PIC X(08)                        03640000
033000             VALUE 'TABLE = '.                                    03650000
033100     05  RSLM8-ITEMS-NOT-ON-XREF  PIC Z(08)9  VALUE ZERO.         03660000
033200                                                                  03670000
033300 01  RUN-CONTROL-WSREC.                                           03680000
033400     05  RC-ID                   PIC X(21)                        03690000
033500             VALUE 'MAKUT027 RUN STATUS= '.                       03700000
033600     05  RC-RUN-STATUS           PIC X(10)   VALUE SPACES.        03710000
033700         88 RC-RUN-IN-PROCESS                VALUE 'IN PROCESS'.  03720000
033800         88 RC-RUN-COMPLETE                  VALUE 'COMPLETE  '.  03730000
033900     05  FILLER                  PIC X(01)   VALUE SPACE.         03740000
034000     05  RC-CHECKPOINT-CNT       PIC 9(09)   VALUE ZERO.          03750000
034100     05  FILLER                  PIC X(01)   VALUE SPACE.         03760000
034200     05  RC-LAST-SKU-STORE-SALE-READ                              03770000
034300                                 PIC 9(09)   VALUE ZERO.          03780000
034400     05  FILLER                  PIC X(01)   VALUE SPACE.         03790000
034500     05  RC-SALE-LOAD-REC-CNT    PIC 9(09)   VALUE ZERO.          03800000
034600     05  FILLER                  PIC X(01)   VALUE SPACE.         03810000
034700     05  RC-SKUS-WITH-NO-ITEM-CNT                                 03820000
034800                                 PIC 9(09)   VALUE ZERO.          03830000
034900     05  FILLER                  PIC X(01)   VALUE SPACE.         03840000
035000     05  RC-SKUS-WITH-MULT-ITEMS-CNT                              03850000
035100                                 PIC 9(09)   VALUE ZERO.          03860000
035200     05  FILLER                  PIC X(01)   VALUE SPACE.         03870000
035300     05  RC-NO-ORG-UNIT-RECS-CNT PIC 9(09)   VALUE ZERO.          03880000
035400     05  FILLER                  PIC X(01)   VALUE SPACE.         03890000
035500     05  RC-EXTRACT-NO-ITEM-CNT  PIC 9(09)   VALUE ZERO.          03900000
035600     05  FILLER                  PIC X(01)   VALUE SPACE.         03910000
035700     05  RC-ITEM-WITH-NO-XREF-CNT PIC 9(09)   VALUE ZERO.         03920000
035800                                                                  03930000
035900 01  ORG-CLUSTER-TABLE.                                           03940000
216116*    05  ORG-CLUSTER-ID    OCCURS 3000 TIMES   PIC S9(9)  COMP.   03950008
216116     05  ORG-CLUSTER-ID    OCCURS 9999 TIMES   PIC S9(9)  COMP.   03960008
036100                                                                  03970000
036200* FIELDS FOR THE SKU STORE SALES EXTRACT FILE                     03980000
036300     COPY MARD017.                                                03990000
036400                                                                  04000000
036500* FIELDS FOR THE SALES LOAD FILE                                  04010000
036600     COPY MARD020.                                                04020000
036700                                                                  04030000
036800* DECLARE VARIABLES FOR SUBROUTINE CALL  (SQLCODE TEXT)           04040000
036900                                                                  04050000
037000 01  WS-MSG-TEXT                   PIC X(512).                    04060000
037100 01  WS-MAX-SIZE                   PIC S9(09) COMP                04070000
037200                                              VALUE 512.          04080000
037300 01  WS-MSG-LENGTH                 PIC S9(09) COMP.               04090000
037400                                                                  04100000
037500*                                                                 04110000
037600     EXEC SQL BEGIN DECLARE SECTION END-EXEC.                     04120000
037700                                                                  04130000
037800 01      USERNAME                   PIC X(10)      VARYING.       04140000
037900 01      PASSWD                     PIC X(10)      VARYING.       04150000
038000 01      PC-DS                      PIC X(02)      VALUE 'DS'.    04160000
038100 01      PV-ORACLE-ID               PIC X(1)       VALUE '/'.     04170000
038200 01      PV-NBR-DAYS                PIC S9(4)      COMP           04180000
038300                                                   VALUE +7.      04190000
038400 01      CALL-ITEM-CLUSTER-NAME     PIC X(20)      VALUE SPACES.  04200000
038500 01      CALL-TSKXREF-ITM-NBR       PIC S9(15)V COMP-3 VALUE 0.   04210000
038600                                                                  04220000
038700*                                                                 04230000
038800******************************************************************04240000
038900* COBOL DECLARATION FOR TABLE TORGCLT                             04250000
039000******************************************************************04260000
039100 01  DCLTORGCLT.                                                  04270000
039200     10 ORGCLT-ORG-CLUSTR-ID          PIC  S9(9) COMP.            04280000
039300     10 ORGCLT-ORG-CLUSTR-NAME-5      PIC   X(5).                 04290000
039400     10 ORGCLT-ORG-CLUSTR-NAME-10     PIC   X(10).                04300000
039500     10 ORGCLT-ORG-CLUSTR-NAME        PIC   X(20).                04310000
039600     10 ORGCLT-ORG-CLUSTR-DESC        PIC   X(40).                04320000
039700     10 ORGCLT-EFF-BEG-TMST           PIC   X(26).                04330000
039800     10 ORGCLT-EFF-END-TMST           PIC   X(26).                04340000
039900     10 ORGCLT-CLUSTR-TYP-CDE         PIC   X(1).                 04350000
040000     10 ORGCLT-HIER-TYP-CDE           PIC   X(1).                 04360000
040100     10 ORGCLT-HIER-CDE               PIC   X(3).                 04370000
040200     10 ORGCLT-ORG-CLUSTR-CDE         PIC   X(1).                 04380000
040300     10 ORGCLT-ORG-TYP-CDE            PIC   X(2).                 04390000
040400     10 ORGCLT-CRE-BY-UID             PIC   X(8).                 04400000
040500     10 ORGCLT-CRE-TMST               PIC   X(26).                04410000
040600     10 ORGCLT-LAST-UPD-BY-UID        PIC   X(8).                 04420000
040700     10 ORGCLT-LAST-UPD-TMST          PIC   X(26).                04430000
040800     10 ORGCLT-ARCH-DTE               PIC   X(26).                04440000
040900     10 ORGCLT-OWNER-ID               PIC  S9(9) COMP.            04450000
041000******************************************************************04460000
041100* THE NUMBER OF COLUMNS DESCRIBED BY THIS DECLARATION IS  18     *04470000
041200******************************************************************04480000
041300                                                                  04490000
041400******************************************************************04500000
041500*     * COBOL DECLARATION FOR TABLE TITMCLT                       04510000
041600******************************************************************04520000
041700 01        DCLTITMCLT.                                            04530000
041800           10   ITMCLT-ITEM-CLUSTR-ID      PIC S9(10) COMP-3.     04540000
041900           10   ITMCLT-ITEM-CLUSTR-NAME    PIC X(20).             04550000
042000           10   ITMCLT-ITEM-CLUSTR-DESC    PIC X(40).             04560000
042100           10   ITMCLT-EFF-BEG-TMST        PIC X(19).             04570000
042200           10   ITMCLT-EFF-END-TMST        PIC X(19).             04580000
042300           10   ITMCLT-CLUSTR-TYP-CDE      PIC X(01).             04590000
042400           10   ITMCLT-HIER-TYP-CDE        PIC X(01).             04600000
042500           10   ITMCLT-HIER-CDE            PIC X(03).             04610000
042600           10   ITMCLT-ITEM-CLUSTR-CDE     PIC X(01).             04620000
042700           10   ITMCLT-MDSE-NM-CDE         PIC X(01).             04630000
042800           10   ITMCLT-PROD-SERV-CDE       PIC X(01).             04640000
042900           10   ITMCLT-CRE-BY-UID          PIC X(08).             04650000
043000           10   ITMCLT-CRE-TMST            PIC X(19).             04660000
043100           10   ITMCLT-LAST-UPD-BY-UID     PIC X(08).             04670000
043200           10   ITMCLT-LAST-UPD-TMST       PIC X(19).             04680000
043300           10   ITMCLT-ARCH-DTE            PIC X(19).             04690000
043400           10   ITMCLT-OWNER-ID            PIC S9(10) COMP-3.     04700000
043500******************************************************************04710000
043600*     * THE NUMBER OF COLUMNS DESCRIBED BY THIS DECLARATION IS 17 04720000
043700******************************************************************04730000
043800*----------------------------------------------------------------*04740000
043900*    SKU CROSS REFERENCE TABLE.                         *         04750000
044000*----------------------------------------------------------------*04760000
044100     EXEC SQL                                                     04770000
044200         INCLUDE TSKXREF                                          04780000
044300     END-EXEC.                                                    04790000
044400                                                                  04800000
044500                                                                  04810000
044600     EXEC SQL END DECLARE SECTION END-EXEC.                       04820000
044700                                                                  04830000
044800     EXEC SQL                                                     04840000
044900         INCLUDE SQLCA                                            04850000
045000     END-EXEC.                                                    04860000
045100*                                                                 04870000
045200* ORA COMMUNICATION AREA                                          04880000
045300*                                                                 04890000
045400 EJECT                                                            04900000
045500*                                                                 04910000
045600                                                                  04920000
045700*    COPY SQLCA2.                                                 04930000
045800     COPY SQLCA2.                                                 04940000
045900                                                                  04950000
046000*---------------------------------------------------------------* 04960000
046100* CURSOR FOR TORGCLT TABLE                                        04970000
046200*---------------------------------------------------------------* 04980000
046300     EXEC SQL                                                     04990000
046400       DECLARE ORG_CLUST_ID_CSR CURSOR FOR                        05000000
046500         SELECT ORG_CLUSTR_ID,                                    05010000
046600                ORG_CLUSTR_NAME                                   05020000
046700         FROM   TORGCLT                                           05030000
046800         WHERE  ORG_TYP_CDE     = 'DS'                            05040000
046900         ORDER BY ORG_CLUSTR_NAME                                 05050000
047000     END-EXEC.                                                    05060000
047100                                                                  05070000
047200*---------------------------------------------------------------* 05080000
047300                                                                  05090000
047400 EJECT                                                            05100000
047500 PROCEDURE DIVISION.                                              05110000
047600                                                                  05120000
047700 0000-MAINLINE.                                                   05130000
047800                                                                  05140000
047900     DISPLAY 'MAKUT027 - START'.                                  05150000
048000     PERFORM 1000-SET-UP.                                         05160000
048100                                                                  05170000
048200     PERFORM 2000-PROCESS-INPUT.                                  05180000
048300                                                                  05190000
048400     PERFORM 3000-WRAP-UP.                                        05200000
048500                                                                  05210000
048600     DISPLAY 'MAKUT027 - SUCCESSFUL END'.                         05220000
048700     MOVE ZERO TO RETURN-CODE.                                    05230000
048800     GOBACK.                                                      05240000
048900                                                                  05250000
049000                                                                  05260000
049100                                                                  05270000
049200*----------------------------------------------------------------*05280000
049300*  THIS PARAGRAPH LOADS THE INTERNAL ORG CLUSTER TABLE AND OPENS  05290000
049400*  ALL FILES.                                                     05300000
049500*----------------------------------------------------------------*05310000
049600 1000-SET-UP.                                                     05320000
049700                                                                  05330000
049800     MOVE '1000-SETUP' TO PV-ABEND-PARAGRAPH.                     05340000
049900****************************************************************  05350000
050000* LOGON                                                        *  05360000
050100****************************************************************  05370000
050200                                                                  05380000
050300     PERFORM 1010-CONNECT-TO-ORACLE.                              05390001
052200                                                                  05400000
052300     EXEC SQL                                                     05410000
052400      ALTER SESSION                                               05420000
052500            SET NLS_DATE_FORMAT = 'YYYY-MM-DD.HH24.MI.SS'         05430000
052600     END-EXEC.                                                    05440000
052700                                                                  05450000
052800     INITIALIZE ORG-CLUSTER-TABLE.                                05460000
052900                                                                  05470000
053000     PERFORM 1100-OPEN-ORG-CLUST-ID-CSR.                          05480000
053100     PERFORM 1110-FETCH-ORG-CLUST-ID-CSR.                         05490000
053200                                                                  05500000
053300     IF PS-NO-MORE-ORG-CLUSTS-LEFT                                05510000
053400*      EMPTY FILE ERROR                                           05520000
053500         SET ERROR-1003          TO TRUE                          05530000
053600         DISPLAY PV-ABEND-PARAGRAPH                               05540000
053700         MOVE ERROR-CODE         TO EM-ERROR-CODE                 05550000
053800         MOVE 'EMPTY ORG UNIT CLUSTER TABLE'  TO EM-ERROR-DESC    05560000
053900         PERFORM 9000-HANDLE-ERROR                                05570000
054000     END-IF.                                                      05580000
054100                                                                  05590000
054200     PERFORM 1200-TABLE-ORG-CLUST-ROWS                            05600000
054300         VARYING PV-SUB FROM 1 BY 1                               05610000
054400         UNTIL PS-NO-MORE-ORG-CLUSTS-LEFT.                        05620000
054500                                                                  05630000
054600     PERFORM 1120-CLOSE-ORG-CLUST-ID-CSR.                         05640000
054700                                                                  05650000
054800     OPEN I-O    RUN-CONTROL-FILE.                                05660000
054900                                                                  05670000
055000     PERFORM 1310-READ-RUN-CONTROL.                               05680000
055100     MOVE RC-RUN-STATUS TO RUN-STATUS.                            05690000
055200                                                                  05700000
055300     IF RUN-IN-PROCESS                                            05710000
055400***      THIS IS A CHECKPOINT RESTART RUN                         05720000
055500         DISPLAY 'MAKUT027 - CHECKPOINT RESTART RUN'              05730000
055600         OPEN INPUT SALES-LOAD-FILE                               05740000
055700         OPEN INPUT DATE-CONTROL-FILE                             05750000
055800         PERFORM 1050-READ-DATE-CONTROL-FILE                      05760000
055900         MOVE PV-CONTROL-DATE TO PV-SALES-DATE                    05770000
056000         PERFORM 1400-CHECKPOINT-RESTART                          05780000
056100     ELSE                                                         05790000
056200***      THIS IS A NORMAL RUN                                     05800000
056300         DISPLAY 'MAKUT027 - NORMAL RUN'                          05810000
056400         OPEN INPUT SKU-STORE-SALES-FILE                          05820000
056500                    DATE-CONTROL-FILE                             05830000
056600         OPEN OUTPUT SALES-LOAD-FILE                              05840000
056700         SET RUN-IN-PROCESS      TO TRUE                          05850000
056800         SET RC-RUN-IN-PROCESS   TO TRUE                          05860000
056900         MOVE ZERO               TO RC-LAST-SKU-STORE-SALE-READ   05870000
057000                                    RC-SALE-LOAD-REC-CNT          05880000
057100                                    RC-SKUS-WITH-NO-ITEM-CNT      05890000
057200                                    RC-SKUS-WITH-MULT-ITEMS-CNT   05900000
057300                                    RC-NO-ORG-UNIT-RECS-CNT       05910000
057400                                    RC-EXTRACT-NO-ITEM-CNT        05920000
057500                                    RC-ITEM-WITH-NO-XREF-CNT      05930000
057600                                                                  05940000
057700         IF RC-CHECKPOINT-CNT NOT NUMERIC                         05950000
057800           OR RC-CHECKPOINT-CNT = ZERO                            05960000
057900             MOVE 10000 TO RC-CHECKPOINT-CNT                      05970000
058000         END-IF                                                   05980000
058100                                                                  05990000
058200         REWRITE RUN-CONTROL-RECORD FROM RUN-CONTROL-WSREC        06000000
058300                                                                  06010000
058400         PERFORM 1050-READ-DATE-CONTROL-FILE                      06020000
058500         MOVE PV-CONTROL-DATE TO PV-SALES-DATE                    06030000
058600     END-IF.                                                      06040000
058700                                                                  06050000
058800     CLOSE DATE-CONTROL-FILE.                                     06060000
058900     CLOSE RUN-CONTROL-FILE.                                      06070000
059000                                                                  06080000
059100                                                                  06090000
059200 EJECT                                                            06100000
059210****************************************************************  06110001
059220*   CONNECT TO THE APPROPRIATE ORACLE SERVER.                  *  06120001
059230****************************************************************  06130001
059240 1010-CONNECT-TO-ORACLE.                                          06140001
059250                                                                  06150001
059290                                                                  06160001
059291     OPEN INPUT ORACLE-LOGON-FILE.                                06170001
059292                                                                  06180001
059293     PERFORM 1020-READ-ORACLE-LOGON.                              06190001
059294                                                                  06200001
059295     CLOSE ORACLE-LOGON-FILE.                                     06210001
059296                                                                  06220001
059297     IF ((PS-END-OF-LOGON-FILE)                                   06230001
059298             OR (CC-ORACLE-CONNECTION = SPACES))                  06240001
059299         DISPLAY '** ABEND **'                                    06250001
059300         DISPLAY PC-PROGRAM-NAME ' - ORACLE LOGON CONTROL CARD '  06260001
059301                   'NOT PROVIDED'                                 06270001
059302         SET PS-ORA-SRC-EMPTY TO TRUE                             06280001
059303         CALL 'ILBOABN0' USING PV-ABEND-CODE                      06290001
059304     END-IF.                                                      06300001
059305                                                                  06310001
059306     IF CC-AUTO-LOGON                                             06320001
059307         DISPLAY PC-PROGRAM-NAME ' - AUTO LOGON TO ORACLE'        06330001
059308         EXEC SQL                                                 06340001
059309              CONNECT :USERNAME                                   06350001
059310         END-EXEC                                                 06360001
059311     ELSE                                                         06370001
059312         INITIALIZE PV-ORACLE-USERID-LEN                          06380001
059313                    PV-ORACLE-PASSWORD-LEN                        06390001
059314         INSPECT CC-ORACLE-USERID                                 06400001
059315             TALLYING PV-ORACLE-USERID-LEN                        06410001
059316          FOR CHARACTERS BEFORE INITIAL SPACE                     06420001
059317      INSPECT CC-ORACLE-PASSWORD                                  06430001
059318          TALLYING PV-ORACLE-PASSWORD-LEN                         06440001
059319          FOR CHARACTERS BEFORE INITIAL SPACE                     06450001
059320      MOVE CC-ORACLE-USERID (1:PV-ORACLE-USERID-LEN) TO           06460001
059321                USERNAME-ARR                                      06470001
059322      MOVE PV-ORACLE-USERID-LEN TO USERNAME-LEN                   06480001
059323      MOVE CC-ORACLE-PASSWORD (1:PV-ORACLE-PASSWORD-LEN) TO       06490001
059324                PASSWD-ARR                                        06500001
059325      MOVE PV-ORACLE-PASSWORD-LEN TO PASSWD-LEN                   06510001
059326      DISPLAY PC-PROGRAM-NAME ' - LOGON TO ORACLE AS USER '       06520001
059327                USERNAME-ARR                                      06530001
059328      EXEC SQL                                                    06540001
059329        CONNECT :USERNAME IDENTIFIED BY :PASSWD                   06550001
059330      END-EXEC                                                    06560001
059331      INITIALIZE CC-ORACLE-PASSWORD                               06570001
059332                 PASSWD                                           06580001
059333      END-IF.                                                     06590001
059334                                                                  06600001
059335     IF (SQLCODE NOT = 0)                                         06610001
059336         DISPLAY PV-ABEND-PARAGRAPH                               06620001
059337         DISPLAY PC-PROGRAM-NAME ' - ERROR LOGGING ON TO ORACLE'  06630001
059338         PERFORM 9999-SQL-ERROR                                   06640001
059339     END-IF.                                                      06650001
059340                                                                  06660001
059341                                                                  06670001
059357                                                                  06680001
059358****************************************************************  06690001
059359** READ THE ORACLE LOGON CONTROL CARD.                        **  06700001
059360****************************************************************  06710001
059361 1020-READ-ORACLE-LOGON.                                          06720001
059362                                                                  06730001
059363     READ ORACLE-LOGON-FILE                                       06740001
059364         INTO CC-ORACLE-CONNECTION                                06750001
059365         AT END                                                   06760001
059366             SET PS-END-OF-LOGON-FILE TO TRUE                     06770001
059367     END-READ.                                                    06780001
059369                                                                  06790001
059370*----------------------------------------------------------------*06800000
059400*  READ THE DATE CONTROL FILE INTO THE DATE FIELD                 06810000
059500*----------------------------------------------------------------*06820000
059600 1050-READ-DATE-CONTROL-FILE.                                     06830000
059700                                                                  06840000
059800     READ DATE-CONTROL-FILE RECORD                                06850000
059900         INTO PV-DATE-CONTROL-REC.                                06860000
060000                                                                  06870000
060100*----------------------------------------------------------------*06880000
060200* 1100-OPEN-ORG-CLUST-ID-CSR.                                   * 06890000
060300*                                                               * 06900000
060400*----------------------------------------------------------------*06910000
060500*                                                                 06920000
060600 1100-OPEN-ORG-CLUST-ID-CSR.                                      06930000
060700                                                                  06940000
060800     MOVE '1100-OPEN-ORG-CLUST-ID-CSR' TO PV-ABEND-PARAGRAPH.     06950000
060900                                                                  06960000
061000     EXEC SQL                                                     06970000
061100         OPEN  ORG_CLUST_ID_CSR                                   06980000
061200     END-EXEC.                                                    06990000
061300                                                                  07000000
061400     EVALUATE TRUE                                                07010000
061500       WHEN SQLCODE = ZEROS                                       07020000
061600       WHEN SQLCODE = 1403                                        07030000
061700         CONTINUE                                                 07040000
061800       WHEN OTHER                                                 07050000
061900         DISPLAY PV-ABEND-PARAGRAPH                               07060000
062000         SET ERROR-1001          TO TRUE                          07070000
062100         PERFORM 9999-SQL-ERROR                                   07080000
062200     END-EVALUATE.                                                07090000
062300                                                                  07100000
062400     EJECT                                                        07110000
062500*----------------------------------------------------------------*07120000
062600* 1110-FETCH-ORG-CLUST-ID-CSR.                                   *07130000
062700*                                                                *07140000
062800*----------------------------------------------------------------*07150000
062900 1110-FETCH-ORG-CLUST-ID-CSR.                                     07160000
063000                                                                  07170000
063100     MOVE '1110-FETCH-ORG-CLUST-ID-CSR' TO PV-ABEND-PARAGRAPH.    07180000
063200                                                                  07190000
063300     EXEC SQL                                                     07200000
063400       FETCH  ORG_CLUST_ID_CSR                                    07210000
063500       INTO  :ORGCLT-ORG-CLUSTR-ID                                07220000
063600            ,:ORGCLT-ORG-CLUSTR-NAME                              07230000
063700     END-EXEC.                                                    07240000
063800                                                                  07250000
063900     EVALUATE TRUE                                                07260000
064000       WHEN SQLCODE = ZEROS                                       07270000
064100                                                                  07280000
064200         CONTINUE                                                 07290000
064300                                                                  07300000
064400       WHEN SQLCODE = 1403                                        07310000
064500         SET PS-NO-MORE-ORG-CLUSTS-LEFT  TO TRUE                  07320000
064600       WHEN OTHER                                                 07330000
064700         DISPLAY PV-ABEND-PARAGRAPH                               07340000
064800         SET ERROR-1002          TO TRUE                          07350000
064900         PERFORM 9999-SQL-ERROR                                   07360000
065000     END-EVALUATE.                                                07370000
065100                                                                  07380000
065200                                                                  07390000
065300*----------------------------------------------------------------*07400000
065400* 1120-CLOSE-ORG-CLUST-ID-CSR.                                  * 07410000
065500*                                                               * 07420000
065600*----------------------------------------------------------------*07430000
065700*                                                                 07440000
065800 1120-CLOSE-ORG-CLUST-ID-CSR.                                     07450000
065900                                                                  07460000
066000     MOVE '1120-CLOSE-ORG-CLUST-ID-CSR' TO PV-ABEND-PARAGRAPH.    07470000
066100                                                                  07480000
066200     EXEC SQL                                                     07490000
066300       CLOSE  ORG_CLUST_ID_CSR                                    07500000
066400     END-EXEC.                                                    07510000
066500                                                                  07520000
066600     EVALUATE TRUE                                                07530000
066700       WHEN SQLCODE = ZEROS                                       07540000
066800       WHEN SQLCODE = 1403                                        07550000
066900         CONTINUE                                                 07560000
067000       WHEN OTHER                                                 07570000
067100         DISPLAY PV-ABEND-PARAGRAPH                               07580000
067200         SET ERROR-1006          TO TRUE                          07590000
067300         PERFORM 9999-SQL-ERROR                                   07600000
067400     END-EVALUATE.                                                07610000
067500                                                                  07620000
067600     EJECT                                                        07630000
067700*----------------------------------------------------------------*07640000
067800* 1200-TABLE-ORG-CLUST-ROWS.                                    * 07650000
067900*                                                               * 07660000
068000*  THIS PARAGRAPH OBTAINS THE ORG UNIT CLUSTER IDS THRU A CURSOR* 07670000
068100*  FETCH AND LOADS THEM INTO THE ORG CLUSTER TABLE.             * 07680000
068200*----------------------------------------------------------------*07690000
068300*                                                                 07700000
068400 1200-TABLE-ORG-CLUST-ROWS.                                       07710000
068500                                                                  07720000
068600     MOVE ORGCLT-ORG-CLUSTR-NAME TO PV-ORG-CLUSTER-NAME.          07730000
068700     IF PV-ORG-CLUSTER-FILLER EQUAL SPACES                        07740000
068800       AND PV-ORG-CLUSTER-NAME-NUM IS NUMERIC                     07750000
068900       AND PV-ORG-CLUSTER-NAME-NUM GREATER THAN ZERO              07760000
069000         MOVE PV-ORG-CLUSTER-NAME-NUM TO PV-SUB-ORG-CLUSTER       07770000
069100         MOVE ORGCLT-ORG-CLUSTR-ID                                07780000
069200               TO ORG-CLUSTER-ID (PV-SUB-ORG-CLUSTER)             07790000
069300     ELSE                                                         07800000
069400         ADD +1                       TO PV-INVALID-STORE-COUNT   07810000
069500         MOVE ORGCLT-ORG-CLUSTR-NAME  TO ISM-ORG-CLUSTR-NAME      07820000
069600         MOVE ORGCLT-ORG-CLUSTR-ID    TO ISM-ORG-CLUSTR-ID        07830000
069700         MOVE INVALID-STORE-MSG       TO LM-MESSAGE               07840000
069800         DISPLAY LOG-MESSAGE UPON SYSOUT                          07850000
069900     END-IF.                                                      07860000
070000                                                                  07870000
070100     PERFORM 1110-FETCH-ORG-CLUST-ID-CSR.                         07880000
070200                                                                  07890000
070300*----------------------------------------------------------------*07900000
070400* 1300-TAKE-CHECKPOINT.                                          *07910000
070500*                                                                *07920000
070600*  THIS PROCEDURE UPDATES THE RUN CONTROL FILE RECORD AT START   *07930000
070700*  THE RUN AND EACH TIME A CHECKPOINT IS TAKEN.                  *07940000
070800*----------------------------------------------------------------*07950000
070900*                                                                 07960000
071000 1300-TAKE-CHECKPOINT.                                            07970000
071100                                                                  07980000
071200     OPEN I-O RUN-CONTROL-FILE.                                   07990000
071300     PERFORM 1310-READ-RUN-CONTROL.                               08000000
071400                                                                  08010000
071500     MOVE RUN-STATUS             TO RC-RUN-STATUS.                08020000
071600     MOVE PV-SKU-STORE-SALE-COUNT TO RC-LAST-SKU-STORE-SALE-READ. 08030000
071700     MOVE PV-SALE-LOAD-REC-COUNT TO RC-SALE-LOAD-REC-CNT.         08040000
071800     MOVE PV-SKU-NO-ITEM-COUNT   TO RC-SKUS-WITH-NO-ITEM-CNT.     08050000
071900     MOVE PV-SKU-MULT-ITEMS-COUNT                                 08060000
072000                                 TO RC-SKUS-WITH-MULT-ITEMS-CNT.  08070000
072100     MOVE PV-STORE-NO-ORG-UNIT-COUNT                              08080000
072200                                 TO RC-NO-ORG-UNIT-RECS-CNT.      08090000
072300     MOVE PV-EXTRACT-NO-ITEM-COUNT                                08100000
072400                                 TO RC-EXTRACT-NO-ITEM-CNT.       08110000
072500     MOVE PV-ITEM-NO-XREF-COUNT  TO RC-ITEM-WITH-NO-XREF-CNT.     08120000
072600                                                                  08130000
072700     REWRITE RUN-CONTROL-RECORD FROM RUN-CONTROL-WSREC.           08140000
072800     CLOSE RUN-CONTROL-FILE.                                      08150000
072900     MOVE ZERO TO PV-CHECKPOINT-REC-COUNT.                        08160000
073000                                                                  08170000
073100                                                                  08180000
073200*----------------------------------------------------------------*08190000
073300*                                                                *08200000
073400*----------------------------------------------------------------*08210000
073500 1310-READ-RUN-CONTROL.                                           08220000
073600                                                                  08230000
073700     READ RUN-CONTROL-FILE RECORD INTO RUN-CONTROL-WSREC          08240000
073800         AT END                                                   08250000
073900             SET ERROR-1008      TO TRUE                          08260000
074000             MOVE ERROR-CODE     TO EM-ERROR-CODE                 08270000
074100             MOVE 'EMPTY RUN CONTROL FILE'                        08280000
074200                                     TO EM-ERROR-DESC             08290000
074300             PERFORM 9000-HANDLE-ERROR.                           08300000
074400                                                                  08310000
074500     IF NOT (RC-RUN-IN-PROCESS OR RC-RUN-COMPLETE)                08320000
074600         SET ERROR-1017          TO TRUE                          08330000
074700         MOVE ERROR-CODE         TO EM-ERROR-CODE                 08340000
074800         MOVE RC-RUN-STATUS      TO E1017M-RUN-STATUS             08350000
074900         MOVE ERROR-1017-MESSAGE TO EM-ERROR-DESC                 08360000
075000         PERFORM 9000-HANDLE-ERROR                                08370000
075100     END-IF.                                                      08380000
075200                                                                  08390000
075300                                                                  08400000
075400*----------------------------------------------------------------*08410000
075500* 1400-CHECKPOINT-RESTART.                                        08420000
075600*                                                                 08430000
075700*  THIS PARAGRAPH WILL BE USED TO RESTART THE PROGRAM AFTER AN    08440000
075800*  ABEND.  WORKING STORAGE COUNTS WILL BE INITIALIZED TO THE LAST 08450000
075900*  VALUES FROM THE RUN CONTROL FILE COUNTS (ANY UPDATES MADE TO   08460000
076000*  THOSE RUN CONTROL COUNTS AFTER THE LAST CHECKPOINT WILL BE     08470000
076100*  LOST -- THEY ARE ONLY USED FOR EOJ SUMMARY MESSAGES).  THE     08480000
076200*  LAST RECORD ON THE SALES LOAD FILE WILL BE READ AND USED       08490000
076300*  TO REPOSITION THE SKU STORE SALES INPUT FILE TO THE NEXT       08500000
076400*  RECORD FOR RESTART PROCESSING.                                 08510000
076500*----------------------------------------------------------------*08520000
076600*                                                                 08530000
076700 1400-CHECKPOINT-RESTART.                                         08540000
076800                                                                  08550000
076900                                                                  08560000
077000     MOVE RC-SKUS-WITH-NO-ITEM-CNT                                08570000
077100                                 TO PV-SKU-NO-ITEM-COUNT.         08580000
077200     MOVE RC-SKUS-WITH-MULT-ITEMS-CNT                             08590000
077300                                 TO PV-SKU-MULT-ITEMS-COUNT.      08600000
077400     MOVE RC-NO-ORG-UNIT-RECS-CNT                                 08610000
077500                                 TO PV-STORE-NO-ORG-UNIT-COUNT.   08620000
077600     MOVE RC-EXTRACT-NO-ITEM-CNT TO PV-EXTRACT-NO-ITEM-COUNT.     08630000
077700                                                                  08640000
077800     MOVE RC-ITEM-WITH-NO-XREF-CNT  TO PV-ITEM-NO-XREF-COUNT.     08650000
077900     PERFORM 1410-READ-SALES-LOAD                                 08660000
078000         UNTIL PS-SALE-LOAD-EOF.                                  08670000
078100                                                                  08680000
078200     CLOSE SALES-LOAD-FILE.                                       08690000
078300     DISPLAY 'LAST SALE LOAD FILE REC: ' MA020-SALES-LOAD.        08700000
078400     DISPLAY 'MAKUT027 - REOPEN SALES LOAD FILE FOR OUTPUT'.      08710000
078500     OPEN EXTEND SALES-LOAD-FILE.                                 08720000
078600     OPEN INPUT SKU-STORE-SALES-FILE.                             08730000
078700                                                                  08740000
078800     IF PV-SALE-LOAD-REC-COUNT > ZERO                             08750000
078900         PERFORM 1420-FIND-SKU-STORE-SALE-REC                     08760000
079000     END-IF.                                                      08770000
079100                                                                  08780000
079200     MOVE PV-SKU-STORE-SALE-COUNT TO RRLM-SKU-STOR-SALE-RECS.     08790000
079300     MOVE PV-SALE-LOAD-REC-COUNT TO RRLM-SALE-LOAD-RECS.          08800000
079400     MOVE RUN-RESTART-LOG-MSG    TO LM-MESSAGE.                   08810000
079500     DISPLAY LOG-MESSAGE UPON SYSOUT.                             08820000
079600                                                                  08830000
079700                                                                  08840000
079800*----------------------------------------------------------------*08850000
079900*                                                                *08860000
080000*----------------------------------------------------------------*08870000
080100 1410-READ-SALES-LOAD.                                            08880000
080200                                                                  08890000
080300     READ SALES-LOAD-FILE RECORD                                  08900000
080400         INTO MA020-SALES-LOAD                                    08910000
080500             AT END      SET PS-SALE-LOAD-EOF TO TRUE             08920000
080600             NOT AT END  ADD +1 TO PV-SALE-LOAD-REC-COUNT.        08930000
080700                                                                  08940000
080800                                                                  08950000
080900*----------------------------------------------------------------*08960000
081000* 1420-FIND-SKU-STORE-SALE-REC.                                   08970000
081100*                                                                 08980000
081200*  THIS PARAGRAPH OBTAINS THE ITEM CLUSTER NAME (SKU) USING THE   08990000
081300*  ITEM CLUSTER ID FROM THE LAST SALES LOAD OUTPUT RECORD.        09000000
081400*  THE ORG CLUSTER NAME (STORE)IS OBTAINED USING THE ORG CLUSTER  09010000
081500*  ID FROM THE LAST SALES LOAD OUTPUT RECORD.  THIS SKU AND       09020000
081600*  STORE ARE USED AS THE KEY TO REPOSITION THE SKU STORE SALES    09030000
081700*  FILE TO THE LAST RECORD PROCESSED.                             09040000
081800*----------------------------------------------------------------*09050000
081900*                                                                 09060000
082000 1420-FIND-SKU-STORE-SALE-REC.                                    09070000
082100                                                                  09080000
082200     MOVE MA020-ITEM-CLUSTER-ID TO ITMCLT-ITEM-CLUSTR-ID.         09090000
082300     MOVE PV-SALES-BEG-DATE     TO ITMCLT-EFF-BEG-TMST.           09100000
082400     MOVE PV-SALES-BEG-DATE     TO ITMCLT-EFF-END-TMST.           09110000
082500                                                                  09120000
082600     EXEC SQL                                                     09130000
082700         SELECT  ITEM_CLUSTR_NAME                                 09140000
082800           INTO :ITMCLT-ITEM-CLUSTR-NAME                          09150000
082900           FROM  TITMCLT                                          09160000
083000          WHERE  ITEM_CLUSTR_ID   = :ITMCLT-ITEM-CLUSTR-ID        09170000
083100            AND  HIER_CDE         IS NULL                         09180000
083200            AND  ITEM_CLUSTR_CDE  = 'I'                           09190000
083300            AND  (EFF_BEG_TMST    <=                              09200000
083400            (TO_DATE(:ITMCLT-EFF-BEG-TMST,'YYYY-MM-DD.HH24.MI.SS')09210000
083500                 + :PV-NBR-DAYS)                                  09220000
083600             OR  EFF_END_TMST     IS NULL)                        09230000
083700     END-EXEC.                                                    09240000
083800                                                                  09250000
083900     EVALUATE TRUE                                                09260000
084000       WHEN SQLCODE = ZEROS OR 1403                               09270000
084100                                                                  09280000
084200         CONTINUE                                                 09290000
084300                                                                  09300000
084400       WHEN OTHER                                                 09310000
084500         MOVE '1420-FIND-SKU-STORE-SALES-REC'                     09320000
084600                                 TO PV-ABEND-PARAGRAPH            09330000
084700         DISPLAY 'END DATE=' ITMCLT-EFF-END-TMST                  09340000
084800         DISPLAY 'BEG DATE=' ITMCLT-EFF-BEG-TMST                  09350000
084900         DISPLAY PV-ABEND-PARAGRAPH                               09360000
085000         SET ERROR-1012          TO TRUE                          09370000
085100         PERFORM 9999-SQL-ERROR                                   09380000
085200     END-EVALUATE.                                                09390000
085300                                                                  09400000
085400     IF  SQLCODE = ZERO                                           09410000
085500         MOVE ITMCLT-ITEM-CLUSTR-ID   TO MA020-ITEM-CLUSTER-ID    09420000
085600         SET PS-ITEM-CLUSTR-ID-FOUND  TO TRUE                     09430000
085700     ELSE                                                         09440000
085800         IF  SQLCODE = 1403                                       09450000
085900*      NO ITEM CLUSTER ROW FOUND FOR THIS SKU                     09460000
086000             SET ERROR-1011          TO TRUE                      09470000
086100             MOVE ERROR-CODE         TO EM-ERROR-CODE             09480000
086200             MOVE MA020-ITEM-CLUSTER-ID                           09490000
086300                                     TO E1011M-ITEM-CLUSTR-ID     09500000
086400             MOVE ERROR-1011-MESSAGE TO EM-ERROR-DESC             09510000
086500             PERFORM 9000-HANDLE-ERROR                            09520000
086600         END-IF                                                   09530000
086700     END-IF.                                                      09540000
086800                                                                  09550000
086900     MOVE ITMCLT-ITEM-CLUSTR-NAME                                 09560000
087000                                 TO PV-HOLD-CLUSTER-NAME.         09570000
087100     SET PS-ITEM-CLUSTR-ID-FOUND  TO TRUE.                        09580000
087200                                                                  09590000
087300     MOVE MA020-ORG-UNIT-CLUSTER-ID                               09600000
087400                                TO ORGCLT-ORG-CLUSTR-ID.          09610000
087500                                                                  09620000
087600     EXEC SQL                                                     09630000
087700         SELECT ORG_CLUSTR_NAME                                   09640000
087800         INTO   :ORGCLT-ORG-CLUSTR-NAME                           09650000
087900         FROM   TORGCLT                                           09660000
088000         WHERE  ORG_CLUSTR_ID      = :ORGCLT-ORG-CLUSTR-ID        09670000
088100          AND   ORG_TYP_CDE        = 'DS'                         09680000
088200     END-EXEC.                                                    09690000
088300                                                                  09700000
088400     EVALUATE TRUE                                                09710000
088500       WHEN SQLCODE = ZEROS OR 1403                               09720000
088600                                                                  09730000
088700         CONTINUE                                                 09740000
088800                                                                  09750000
088900       WHEN OTHER                                                 09760000
089000         DISPLAY PV-ABEND-PARAGRAPH                               09770000
089100         SET ERROR-1009          TO TRUE                          09780000
089200         PERFORM 9999-SQL-ERROR                                   09790000
089300     END-EVALUATE.                                                09800000
089400                                                                  09810000
089500     IF  SQLCODE = ZERO                                           09820000
089600         MOVE ORGCLT-ORG-CLUSTR-NAME  TO PV-RESTART-STORE         09830000
089700     ELSE                                                         09840000
089800         IF  SQLCODE = 1403                                       09850000
089900*      NO ITEM CLUSTER ROW FOUND FOR THIS SKU                     09860000
090000             SET ERROR-1004          TO TRUE                      09870000
090100             MOVE ERROR-CODE         TO EM-ERROR-CODE             09880000
090200             MOVE MA020-ORG-UNIT-CLUSTER-ID                       09890000
090300                                     TO E1004M-ORG-CLUSTR-ID      09900000
090400             MOVE ERROR-1004-MESSAGE TO EM-ERROR-DESC             09910000
090500             PERFORM 9000-HANDLE-ERROR                            09920000
090600         END-IF                                                   09930000
090700     END-IF.                                                      09940000
090800                                                                  09950000
090900*    SEARCH TSKXREF USING CLUSTER NAME NISKU                      09960000
091000*    AND RETURN THE ITM-NBR                                       09970000
091100                                                                  09980000
091200     MOVE PV-HOLD-CLUSTER-NAME-NISKU TO SKXREF-SKU.               09990000
091300     EXEC SQL                                                     10000000
091400         SELECT ITM_NBR                                           10010000
091500         INTO   :SKXREF-ITM-NBR                                   10020000
091600         FROM   TSKXREF                                           10030000
091700         WHERE  SKU  = :SKXREF-SKU                                10040000
091800     END-EXEC.                                                    10050000
091900                                                                  10060000
092000     EVALUATE TRUE                                                10070000
092100       WHEN SQLCODE = ZEROS                                       10080000
092200       WHEN SQLCODE = 1403                                        10090000
092300         CONTINUE                                                 10100000
092400                                                                  10110000
092500       WHEN OTHER                                                 10120000
092600         DISPLAY PV-ABEND-PARAGRAPH                               10130000
092700         SET ERROR-1009          TO TRUE                          10140000
092800         PERFORM 9999-SQL-ERROR                                   10150000
092900     END-EVALUATE.                                                10160000
093000                                                                  10170000
093100     IF  SQLCODE = ZERO                                           10180000
093200         MOVE SKXREF-ITM-NBR          TO PV-HOLD-ITEM-NBR         10190000
093300     ELSE                                                         10200000
093400         IF  SQLCODE = 1403                                       10210000
093500*      NO ITEM NUMBER FOUND FOR THIS SKU                          10220000
093600             SET ERROR-1018          TO TRUE                      10230000
093700             MOVE ERROR-CODE         TO EM-ERROR-CODE             10240000
093800             MOVE PV-HOLD-CLUSTER-NAME                            10250000
093900                                     TO E1018M-CLUSTER-NAME       10260000
094000             MOVE ERROR-1018-MESSAGE TO EM-ERROR-DESC             10270000
094100             PERFORM 9000-HANDLE-ERROR                            10280000
094200         END-IF                                                   10290000
094300     END-IF.                                                      10300000
094400                                                                  10310000
094500     PERFORM 2050-READ-SKU-STORE-SALE-REC                         10320000
094600         UNTIL (MA017-ITM-NBR = PV-HOLD-ITEM-NBR                  10330000
094700                AND MA017-STORE = PV-RESTART-STORE)               10340000
094800           OR  PS-SKU-STORE-SALE-EOF.                             10350000
094900     DISPLAY 'RESTART SKU STORE SALES REC: '                      10360000
095000             MA017-SKU-STORE-SALES.                               10370000
095100                                                                  10380000
095200     IF PS-SKU-STORE-SALE-EOF                                     10390000
095300*      RESTART SKU STORE SALES FILE RECORD NOT FOUND              10400000
095400         SET ERROR-1014          TO TRUE                          10410000
095500         MOVE ERROR-CODE         TO EM-ERROR-CODE                 10420000
095600         MOVE 'RESTART SKU STORE SALES FILE RECORD NOT FOUND'     10430000
095700                                 TO EM-ERROR-DESC                 10440000
095800         PERFORM 9000-HANDLE-ERROR                                10450000
095900     END-IF.                                                      10460000
096000                                                                  10470000
096100                                                                  10480000
096200*----------------------------------------------------------------*10490000
096300* 2000-PROCESS-INPUT.                                             10500000
096400*                                                                 10510000
096500*  THIS PROCEDURE READS EACH SKU STORE SALES EXTRACT RECORD       10520000
096600*  WHICH IS SORTED IN SKU, STORE SEQUENCE.  IF A NEW SKU IS FOUND,10530000
096700*  THE MATCHING ITEM CLUSTER ID IS OBTAINED BY DOING A SELECT ON  10540000
096800*  THE ITEM CLUSTER TABLE.  THE MATCHING ORG UNIT CLUSTER ID      10550000
096900*  IS OBTAINED FROM THE ORG-CLUSTER-ID TABLE.  THE TWO IDS AND    10560000
097000*  THE ONHAND QUANTITY ARE WRITTEN TO THE SALES LOAD OUTPUT       10570000
097100*  FILE.                                                          10580000
097200*----------------------------------------------------------------*10590000
097300*                                                                 10600000
097400 2000-PROCESS-INPUT.                                              10610000
097500                                                                  10620000
097600     PERFORM 2050-READ-SKU-STORE-SALE-REC.                        10630000
097700     IF PS-SKU-STORE-SALE-EOF                                     10640000
097800       AND PV-SKU-STORE-SALE-COUNT = ZERO                         10650000
097900*      EMPTY INPUT FILE                                           10660000
098000         SET ERROR-1005          TO TRUE                          10670000
098100         MOVE ERROR-CODE         TO EM-ERROR-CODE                 10680000
098200         MOVE 'EMPTY SKU STORE SALES EXTRACT FILE'                10690000
098300                                 TO EM-ERROR-DESC                 10700000
098400         PERFORM 9000-HANDLE-ERROR                                10710000
098500     END-IF.                                                      10720000
098600                                                                  10730000
098700     PERFORM 2100-PROCESS-SKU-SALES-REC                           10740000
098800         UNTIL PS-SKU-STORE-SALE-EOF.                             10750000
098900                                                                  10760000
099000     IF PV-SALE-LOAD-REC-COUNT = ZERO                             10770000
099100*      EMPTY OUTPUT LOAD FILE                                     10780000
099200         SET ERROR-1016          TO TRUE                          10790000
099300         MOVE ERROR-CODE         TO EM-ERROR-CODE                 10800000
099400         MOVE 'EMPTY SALES LOAD OUTPUT FILE'                      10810000
099500                                 TO EM-ERROR-DESC                 10820000
099600         PERFORM 9000-HANDLE-ERROR                                10830000
099700     END-IF.                                                      10840000
099800                                                                  10850000
099900*----------------------------------------------------------------*10860000
100000*                                                                *10870000
100100*----------------------------------------------------------------*10880000
100200 2050-READ-SKU-STORE-SALE-REC.                                    10890000
100300                                                                  10900000
100400*  THIS PARAGRAPH READS EACH SKU STORE SALES EXTRACT RECORD       10910000
100500                                                                  10920000
100600     READ SKU-STORE-SALES-FILE RECORD                             10930000
100700         INTO MA017-SKU-STORE-SALES                               10940000
100800             AT END      SET PS-SKU-STORE-SALE-EOF TO TRUE        10950000
100900             NOT AT END  ADD +1 TO PV-SKU-STORE-SALE-COUNT.       10960000
101000                                                                  10970000
101100                                                                  10980000
101200*----------------------------------------------------------------*10990000
101300*  THIS PARAGRAPH PROCESSES EACH SKU STORE SALES EXTRACT          11000000
101400*  RECORD IN ORDER TO CREATE AN SALES LOAD OUTPUT RECORD.         11010000
101500*----------------------------------------------------------------*11020000
101600 2100-PROCESS-SKU-SALES-REC.                                      11030000
101700                                                                  11040000
101800     IF MA017-ITM-NBR NOT = PV-HOLD-ITEM-NBR                      11050000
101900         MOVE MA017-ITM-NBR TO PV-HOLD-ITEM-NBR                   11060000
102000         SET PS-ITEM-NBR-XREF-NOT-FOUND  TO TRUE                  11070000
102100         SET PS-ITEM-CLUSTR-ID-NOT-FOUND  TO TRUE                 11080000
102200         PERFORM 2200-GET-ITEM-CLUSTER-INFO                       11090000
102300     END-IF.                                                      11100000
102400                                                                  11110000
102500     IF PS-ITEM-CLUSTR-ID-FOUND                                   11120000
102600         MOVE MA017-STORE   TO PV-SUB-STORE                       11130000
102700         MOVE ORG-CLUSTER-ID (PV-SUB-STORE)                       11140000
102800               TO MA020-ORG-UNIT-CLUSTER-ID                       11150000
102900         IF MA020-ORG-UNIT-CLUSTER-ID NOT = ZERO                  11160000
103000             MOVE PC-WEEKLY-PERIOD-TYPE-CODE                      11170000
103100                 TO MA020-PER-TYP-CDE                             11180000
103200             MOVE PV-SALES-BEG-DATE TO MA020-SALES-BEG-DTE        11190000
103300             MOVE MA017-SALES-QTY TO MA020-SALES-QTY              11200000
103400                                                                  11210000
103500             WRITE SALES-LOAD-RECORD                              11220000
103600                   FROM MA020-SALES-LOAD                          11230000
103700             ADD +1 TO PV-SALE-LOAD-REC-COUNT                     11240000
103800         ELSE                                                     11250000
103900*          NO ORG UNIT CLUSTER ROW FOUND FOR THIS STORE           11260000
104000             ADD +1                 TO PV-STORE-NO-ORG-UNIT-COUNT 11270000
104100             IF NOT (MA017-STORE = '0085' OR '0810')              11280000
104200                 MOVE MA017-STORE       TO OUNF-LM-STORE          11290000
104300                 MOVE ORG-UNIT-NOT-FOUND-LOG-MSG                  11300000
104400                                        TO LM-MESSAGE             11310000
104500                 DISPLAY LOG-MESSAGE UPON SYSOUT                  11320000
104600             END-IF                                               11330000
104700     ELSE                                                         11340000
104800         ADD +1                 TO PV-EXTRACT-NO-ITEM-COUNT       11350000
104900     END-IF.                                                      11360000
105000                                                                  11370000
105100     ADD +1                     TO PV-CHECKPOINT-REC-COUNT.       11380000
105200     IF PV-CHECKPOINT-REC-COUNT >= RC-CHECKPOINT-CNT              11390000
105300         PERFORM 1300-TAKE-CHECKPOINT                             11400000
105400     END-IF.                                                      11410000
105500                                                                  11420000
105600     PERFORM 2050-READ-SKU-STORE-SALE-REC.                        11430000
105700                                                                  11440000
105800                                                                  11450000
105900                                                                  11460000
106000*----------------------------------------------------------------*11470000
106100*  THIS PARAGRAPH OBTAINS THE ITEM CLUSTER ID FOR A SPECIFIC SKU  11480000
106200*  AND MOVES IT TO THE SALES LOAD OUTPUT RECORD.                  11490000
106300*----------------------------------------------------------------*11500000
106400 2200-GET-ITEM-CLUSTER-INFO.                                      11510000
106500                                                                  11520000
106600*  MUST GET SKU, DEPT, AND CLASS FROM TSKXREF TABLE FIRST         11530000
106700*  USING ITEM NUMBER                                              11540000
106800*    MOVE MA017-ITM-NBR             TO CALL-TSKXREF-ITM-NBR.      11550000
106900                                                                  11560000
107000*    EXEC SQL                                                     11570000
107100*        SELECT  SKU, DEPT, CLASS, SUBCLASS                       11580000
107200*          INTO  :SKXREF-SKU, :SKXREF-DEPT, :SKXREF-CLASS,        11590000
107300*                :SKXREF-SUBCLASS                                 11600000
107400*          FROM  TSKXREF                                          11610000
107500*         WHERE  ITM_NBR = :CALL-TSKXREF-ITM-NBR                  11620000
107600*    END-EXEC.                                                    11630000
107700                                                                  11640000
107800*    EVALUATE TRUE                                                11650000
107900*      WHEN SQLCODE = ZEROS                                       11660000
108000*      WHEN SQLCODE = 1403                                        11670000
108100*                                                                 11680000
108200*        CONTINUE                                                 11690000
108300*                                                                 11700000
108400*      WHEN OTHER                                                 11710000
108500*        MOVE '2200-GET-ITEM-CLUSTER-INFO' TO PV-ABEND-PARAGRAPH  11720000
108600*        DISPLAY PV-ABEND-PARAGRAPH                               11730000
108700*        DISPLAY 'SKXREF ITEM NUMBER ' MA017-ITM-NBR              11740000
108800*        SET ERROR-1007          TO TRUE                          11750000
108900*        PERFORM 9999-SQL-ERROR                                   11760000
109000*    END-EVALUATE.                                                11770000
109100                                                                  11780000
109200*    IF  SQLCODE = ZERO                                           11790000
109300*        MOVE SKXREF-DEPT      TO CICN-ITEM-CLUSTER-NAME-DEPT     11800000
109400         MOVE MA017-SKU-DEPT   TO CICN-ITEM-CLUSTER-NAME-DEPT.    11810000
109500*        MOVE SKXREF-SUBCLASS  TO CICN-ITEM-CLUSTER-NAME-CLASS    11820000
109600         MOVE MA017-SKU-SUBCLS TO CICN-ITEM-CLUSTER-NAME-CLASS.   11830000
109700*        MOVE SKXREF-SKU       TO PV-EVALUATE-SKU                 11840000
109800         MOVE MA017-SKU        TO PV-EVALUATE-SKU.                11850000
109900         PERFORM 2300-FIND-SIGNIF-SKU-DIGITS.                     11860000
110000         SET PS-ITEM-NBR-XREF-FOUND  TO TRUE.                     11870000
110100*    ELSE                                                         11880000
110200*      IF  SQLCODE = 1403                                         11890000
110300*      NO ITEM NUMBER ROW FOUND FOR ON THE SKXREF TABLE           11900000
110400*        ADD +1                      TO PV-ITEM-NO-XREF-COUNT     11910000
110500*        MOVE MA017-ITM-NBR          TO INFXREF-LM-ITM-NBR        11920000
110600*        MOVE ITEM-NOT-FOUND-XREF-LOG-MSG  TO LM-MESSAGE          11930000
110700*        DISPLAY LOG-MESSAGE UPON SYSOUT                          11940000
110800*      END-IF                                                     11950000
110900*    END-IF.                                                      11960000
111000                                                                  11970000
111100*  SEARCH FOR ITEM CLUSTER ID, ONLY IF THE ITEM NUMBER WAS FOUND  11980000
111200*  ON THE CROSS REFERRENCE TABLE, AND THE CLUSTER NAME WAS BUILT  11990000
111300     IF PS-ITEM-NBR-XREF-FOUND                                    12000000
111400         MOVE CICN-ITEM-CLUSTER-NAME-WS TO CALL-ITEM-CLUSTER-NAME 12010000
111500         MOVE PV-SALES-BEG-DATE         TO ITMCLT-EFF-BEG-TMST    12020000
111600         MOVE PV-SALES-BEG-DATE         TO ITMCLT-EFF-END-TMST    12030000
111700                                                                  12040000
111800         EXEC SQL                                                 12050000
111900             SELECT  ITEM_CLUSTR_ID                               12060000
112000               INTO  :ITMCLT-ITEM-CLUSTR-ID                       12070000
112100               FROM  TITMCLT                                      12080000
112200              WHERE  ITEM_CLUSTR_NAME = :CALL-ITEM-CLUSTER-NAME   12090000
112300                AND  HIER_CDE         IS NULL                     12100000
112400                AND  ITEM_CLUSTR_CDE  = 'I'                       12110000
112500                AND  EFF_BEG_TMST    <=                           12120000
112600            (TO_DATE(:ITMCLT-EFF-BEG-TMST,'YYYY-MM-DD.HH24.MI.SS')12130000
112700                  + :PV-NBR-DAYS)                                 12140000
112800              AND  EFF_END_TMST     IS NULL                       12150000
112900         END-EXEC                                                 12160000
113000                                                                  12170000
113100         EVALUATE TRUE                                            12180000
113200           WHEN SQLCODE = ZEROS                                   12190000
113300           WHEN SQLCODE = 2112                                    12200000
113400                                                                  12210000
113500             CONTINUE                                             12220000
113600                                                                  12230000
113700           WHEN SQLCODE = 1403                                    12240000
113800             SET PS-NO-MORE-ORG-CLUSTS-LEFT  TO TRUE              12250000
113900           WHEN OTHER                                             12260000
114000             MOVE '2200-GET-ITEM-CLUSTER-INFO'                    12270000
114100                                  TO PV-ABEND-PARAGRAPH           12280000
114200             DISPLAY PV-ABEND-PARAGRAPH                           12290000
114300             DISPLAY 'ITEM NUMBER: ' MA017-ITM-NBR                12300000
114400             SET ERROR-1007          TO TRUE                      12310000
114500             PERFORM 9999-SQL-ERROR                               12320000
114600         END-EVALUATE                                             12330000
114700                                                                  12340000
114800         IF  SQLCODE = ZERO                                       12350000
114900             MOVE ITMCLT-ITEM-CLUSTR-ID  TO MA020-ITEM-CLUSTER-ID 12360000
115000             SET PS-ITEM-CLUSTR-ID-FOUND TO TRUE                  12370000
115100         ELSE                                                     12380000
115200           IF  SQLCODE = 1403                                     12390000
115300*          NO ITEM CLUSTER ROW FOUND FOR THIS SKU                 12400000
115400             ADD +1                   TO PV-SKU-NO-ITEM-COUNT     12410000
115500             MOVE CALL-ITEM-CLUSTER-NAME                          12420000
115600                                      TO INF-LM-CLSTR-NAME        12430000
115700             MOVE ITEM-NOT-FOUND-LOG-MSG  TO LM-MESSAGE           12440000
115800             DISPLAY LOG-MESSAGE UPON SYSOUT                      12450000
115900           ELSE                                                   12460000
116000            IF  SQLCODE = 2112                                    12470000
116100*          MULTIPLE ITEM CLUSTER ROWS FOUND FOR THIS SKU          12480000
116200             ADD +1                   TO PV-SKU-MULT-ITEMS-COUNT  12490000
116300             MOVE MA017-ITM-NBR       TO MIF-LM-ITM-NBR           12500000
116400             MOVE MULT-ITEMS-FOUND-LOG-MSG TO LM-MESSAGE          12510000
116500             DISPLAY LOG-MESSAGE UPON SYSOUT                      12520000
116600            END-IF                                                12530000
116700           END-IF                                                 12540000
116800         END-IF                                                   12550000
116900     END-IF.                                                      12560000
117000                                                                  12570000
117100*----------------------------------------------------------------*12580000
117200*  THIS PARAGRAPH DETERMINES THE SIGNIFICANT DIGITS IN THE NON-   12590000
117300*  INTELLIGENT SKU TO HELP FIND THE ITEM CLUSTER NAME             12600000
117400*----------------------------------------------------------------*12610000
117500 2300-FIND-SIGNIF-SKU-DIGITS.                                     12620000
117600                                                                  12630000
117700* PARSE THROUGH THE DIGITS, REMOVE THE LEADING ZEROES             12640000
117800     EVALUATE TRUE                                                12650000
117900       WHEN PV-EVALUATE-SKU > 9999999                             12660000
118000            MOVE PV-EVALUATE-SKU TO PV-SIGNIF-SKU-8               12670000
118100            MOVE PV-SIGNIF-SKU-8 TO CICN-ITEM-CLUSTER-NAME-SKU    12680000
118200       WHEN PV-EVALUATE-SKU > 999999                              12690000
118300            MOVE PV-EVALUATE-SKU TO PV-SIGNIF-SKU-7               12700000
118400            MOVE PV-SIGNIF-SKU-7 TO CICN-ITEM-CLUSTER-NAME-SKU    12710000
118500       WHEN PV-EVALUATE-SKU > 99999                               12720000
118600            MOVE PV-EVALUATE-SKU TO PV-SIGNIF-SKU-6               12730000
118700            MOVE PV-SIGNIF-SKU-6 TO CICN-ITEM-CLUSTER-NAME-SKU    12740000
118800       WHEN PV-EVALUATE-SKU > 9999                                12750000
118900            MOVE PV-EVALUATE-SKU TO PV-SIGNIF-SKU-5               12760000
119000            MOVE PV-SIGNIF-SKU-5 TO CICN-ITEM-CLUSTER-NAME-SKU    12770000
119100       WHEN PV-EVALUATE-SKU > 999                                 12780000
119200            MOVE PV-EVALUATE-SKU TO PV-SIGNIF-SKU-4               12790000
119300            MOVE PV-SIGNIF-SKU-4 TO CICN-ITEM-CLUSTER-NAME-SKU    12800000
119400       WHEN PV-EVALUATE-SKU > 99                                  12810000
119500            MOVE PV-EVALUATE-SKU TO PV-SIGNIF-SKU-3               12820000
119600            MOVE PV-SIGNIF-SKU-3 TO CICN-ITEM-CLUSTER-NAME-SKU    12830000
119700       WHEN PV-EVALUATE-SKU > 9                                   12840000
119800            MOVE PV-EVALUATE-SKU TO PV-SIGNIF-SKU-2               12850000
119900            MOVE PV-SIGNIF-SKU-2 TO CICN-ITEM-CLUSTER-NAME-SKU    12860000
120000       WHEN PV-EVALUATE-SKU > 0                                   12870000
120100            MOVE PV-EVALUATE-SKU TO PV-SIGNIF-SKU-1               12880000
120200            MOVE PV-SIGNIF-SKU-1 TO CICN-ITEM-CLUSTER-NAME-SKU    12890000
120300     END-EVALUATE.                                                12900000
120400                                                                  12910000
120500*----------------------------------------------------------------*12920000
120600*  THIS PARAGRAPH WRITE SUMMARY INFORMATION TO THE LOG FILE AND   12930000
120700*  CLOSES THE INPUT AND OUTPUT FILES.                             12940000
120800*----------------------------------------------------------------*12950000
120900 3000-WRAP-UP.                                                    12960000
121000                                                                  12970000
121100     CLOSE SKU-STORE-SALES-FILE                                   12980000
121200           SALES-LOAD-FILE.                                       12990000
121300                                                                  13000000
121400     SET RUN-COMPLETE             TO TRUE.                        13010000
121500     PERFORM 1300-TAKE-CHECKPOINT.                                13020000
121600     DISPLAY RUN-CONTROL-RECORD.                                  13030000
121700                                                                  13040000
121800     MOVE PV-SKU-STORE-SALE-COUNT TO RSLM1-SKU-STOR-SALE-RECS.    13050000
121900     MOVE RUN-SUMMARY-LOG-MSG1    TO LM-MESSAGE.                  13060000
122000     DISPLAY LOG-MESSAGE UPON SYSOUT.                             13070000
122100                                                                  13080000
122200     MOVE PV-SALE-LOAD-REC-COUNT  TO RSLM2-SALE-LOAD-RECS.        13090000
122300     MOVE RUN-SUMMARY-LOG-MSG2    TO LM-MESSAGE.                  13100000
122400     DISPLAY LOG-MESSAGE UPON SYSOUT.                             13110000
122500                                                                  13120000
122600     MOVE PV-SKU-NO-ITEM-COUNT    TO RSLM3-SKU-NO-ITEM-RECS.      13130000
122700     MOVE RUN-SUMMARY-LOG-MSG3    TO LM-MESSAGE.                  13140000
122800     DISPLAY LOG-MESSAGE UPON SYSOUT.                             13150000
122900                                                                  13160000
123000     MOVE PV-SKU-MULT-ITEMS-COUNT TO RSLM4-SKU-MULT-ITEMS-RECS.   13170000
123100     MOVE RUN-SUMMARY-LOG-MSG4    TO LM-MESSAGE.                  13180000
123200     DISPLAY LOG-MESSAGE UPON SYSOUT.                             13190000
123300                                                                  13200000
123400     MOVE PV-EXTRACT-NO-ITEM-COUNT                                13210000
123500                                  TO RSLM5-EXTRACT-NO-ITEM-RECS.  13220000
123600     MOVE RUN-SUMMARY-LOG-MSG5    TO LM-MESSAGE.                  13230000
123700     DISPLAY LOG-MESSAGE UPON SYSOUT.                             13240000
123800                                                                  13250000
123900     MOVE PV-STORE-NO-ORG-UNIT-COUNT                              13260000
124000                                  TO RSLM6-STORE-NO-ORG-RECS.     13270000
124100     MOVE RUN-SUMMARY-LOG-MSG6    TO LM-MESSAGE.                  13280000
124200     DISPLAY LOG-MESSAGE UPON SYSOUT.                             13290000
124300                                                                  13300000
124400     MOVE PV-INVALID-STORE-COUNT  TO RSLM7-INVALID-STORE-RECS.    13310000
124500     MOVE RUN-SUMMARY-LOG-MSG7    TO LM-MESSAGE.                  13320000
124600     DISPLAY LOG-MESSAGE UPON SYSOUT.                             13330000
124700                                                                  13340000
124800     MOVE PV-ITEM-NO-XREF-COUNT  TO RSLM8-ITEMS-NOT-ON-XREF.      13350000
124900     MOVE RUN-SUMMARY-LOG-MSG8   TO LM-MESSAGE.                   13360000
125000     DISPLAY LOG-MESSAGE UPON SYSOUT.                             13370000
125100                                                                  13380000
125200                                                                  13390000
125300                                                                  13400000
125400*----------------------------------------------------------------*13410000
125500*  THIS PARAGRAPH WRITES AN ERROR MESSAGE TO THE SYSTEM LOG AND   13420000
125600*  ENDS THE PROGRAM WITH AN ERROR CODE IN THE RETURN-CODE VALUE.  13430000
125700*----------------------------------------------------------------*13440000
125800 9000-HANDLE-ERROR.                                               13450000
125900                                                                  13460000
126000     MOVE ERROR-MESSAGE TO LOG-MESSAGE.                           13470000
126100     MOVE ERROR-CODE    TO PV-ABEND-CODE.                         13480000
126200                                                                  13490000
126300     DISPLAY LOG-MESSAGE UPON SYSOUT.                             13500000
126400                                                                  13510000
126500     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         13520000
126600                                                                  13530000
126700*----------------------------------------------------------------*13540000
126800*                                                                *13550000
126900*----------------------------------------------------------------*13560000
127000 9999-SQL-ERROR.                                                  13570000
127100                                                                  13580000
127200     MOVE SQLCODE    TO SQLCODE2.                                 13590000
127300     MOVE SQLERRD(3) TO SQLERRD3.                                 13600000
127400     DISPLAY '** ABEND **       ** = SQLERROR'.                   13610000
127500     DISPLAY '** PROGRAM        ** = MAKUT027'.                   13620000
127600     DISPLAY '** SQLCODE        ** = ' SQLCODE2.                  13630000
127700     DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                  13640000
127800     DISPLAY '** SQLERRM        ** = ' SQLERRM.                   13650000
127900     DISPLAY '** SQLERRMC       ** = ' SQLERRMC.                  13660000
128000     DISPLAY '** SQLERRD(5)     ** = ' SQLERRD(5).                13670000
128100                                                                  13680000
128200     MOVE SPACES TO WS-MSG-TEXT.                                  13690000
128300*    GET FULL TEXT OF ERROR MESSAGE                               13700000
128400                                                                  13710000
128500     CALL 'SQLGLM' USING WS-MSG-TEXT,                             13720000
128600                         WS-MAX-SIZE,                             13730000
128700                         WS-MSG-LENGTH.                           13740000
128800     DISPLAY 'MESSAGE TEXT      ** = ' WS-MSG-TEXT.               13750000
128900                                                                  13760000
129000     MOVE ERROR-CODE    TO PV-ABEND-CODE.                         13770000
129100     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         13780000
129200*                                                                 13790000
