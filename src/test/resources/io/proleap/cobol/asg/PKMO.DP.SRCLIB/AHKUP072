000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400                                                                  00040000
000500 PROGRAM-ID.    AHKUP072.                                         00050000
000600 AUTHOR.        DENISE HAHN.                                      00060000
000700 INSTALLATION.  KOHLS.                                            00070000
000800 DATE-WRITTEN   APRIL, 2020.                                      00080000
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100******************************************************************00110000
001200*  THIS PROGRAM DELETES ALL ROWS FROM RCT_PRC_RCPT TABLE FROM    *00120000
001300*  ALL RECORDS FOUND IN THE EXTRACT FILE.  THE EXTRACT FILE IS   *00130000
001400*  CREATED BY AHKUT072.                                          *00140000
001700******************************************************************00170000
001800                                                                  00180000
001900******************************************************************00190000
002000 ENVIRONMENT DIVISION.                                            00200000
002100******************************************************************00210000
002200                                                                  00220000
002300 CONFIGURATION SECTION.                                           00230000
002400                                                                  00240000
002500 SOURCE-COMPUTER.        IBM-3090.                                00250000
002600 OBJECT-COMPUTER.        IBM-3090.                                00260000
002700                                                                  00270000
002800 INPUT-OUTPUT SECTION.                                            00280000
002900                                                                  00290000
003000 FILE-CONTROL.                                                    00300000
003100                                                                  00310000
003200     SELECT RCT00019-FILE                                         00320000
003300         ASSIGN TO INP01.                                         00330000
003400                                                                  00340000
003500******************************************************************00350000
003600 DATA DIVISION.                                                   00360000
003700******************************************************************00370000
003800                                                                  00380000
003900 FILE SECTION.                                                    00390000
004000                                                                  00400000
004100 FD  RCT00019-FILE                                                00410000
004200     RECORDING MODE IS F                                          00420000
004300     LABEL RECORDS ARE STANDARD                                   00430000
004400     BLOCK CONTAINS 0 RECORDS.                                    00440000
004500                                                                  00450000
004600 01  RCT00019-RECORD            PIC  X(31).                       00460007
004700                                                                  00470000
004800                                                                  00480000
004900******************************************************************00490000
005000 WORKING-STORAGE SECTION.                                         00500000
005100******************************************************************00510000
005200                                                                  00520000
005300                                                                  00530000
005400******************************************************************00540000
005500** DB2 FORMATTED MESSAGE AREA                                   **00550000
005600******************************************************************00560000
005700     COPY DPWS004.                                                00570000
005900                                                                  00590000
006000                                                                  00600000
006100******************************************************************00610000
006200** COMMUNICATIONS AREA FOR DB2                                  **00620000
006300******************************************************************00630000
006400     EXEC SQL                                                     00640000
006500          INCLUDE SQLCA                                           00650000
006600     END-EXEC.                                                    00660000
006700                                                                  00670000
006800                                                                  00680000
006900******************************************************************00690000
007000** RCT_PRC_RCPT                                                 **00700000
007200******************************************************************00720000
007300     EXEC SQL                                                     00730000
007400          INCLUDE RCT00019                                        00740000
007500     END-EXEC.                                                    00750000
008700                                                                  00870000
008710                                                                  00871000
008800 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00880000
008900                                                   COMP SYNC.     00890000
009000                                                                  00900000
009100 01  PS-PROGRAM-SWITCHES.                                         00910000
009200     05  PS-EOF-RCT00019-FILE-SW     PIC  X(01)    VALUE 'N'.     00920000
009300         88  PS-EOF-RCT00019-FILE                  VALUE 'Y'.     00930000
009400         88  PS-NOT-EOF-RCT00019-FILE              VALUE 'N'.     00940000
009800                                                                  00980000
009900                                                                  00990000
010000 01  PC-PROGRAM-CONSTANTS.                                        01000000
010100     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          01010000
010200         'AHKUP072'.                                              01020000
010300     05  PC-MAX-RETRIES              PIC S9(04)    VALUE +3       01030000
010400                                                   COMP SYNC.     01040000
010500                                                                  01050000
010600 01  PV-PROGRAM-VARIABLES.                                        01060000
010610     05  PV-SQLERRD3                 PIC S9(09)    VALUE ZERO     01061002
010620                                                   COMP-3.        01062002
010700     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  01070000
010800     05  PV-DB2-TABLE-NAME-1         PIC  X(30)    VALUE SPACES.  01080000
010900     05  PV-DB2-TABLE-NAME-2         PIC  X(30)    VALUE SPACES.  01090000
011000     05  PV-DB2-OPERATION-MESSAGE    PIC  X(50)    VALUE SPACES.  01100000
011100     05  PV-RETRY-COUNTER            PIC S9(04)    VALUE ZERO     01110000
011200                                                   COMP SYNC.     01120000
011300     05  PV-INPUT-COUNTER            PIC S9(07)    VALUE ZERO     01130000
011400                                                   COMP-3.        01140000
011500     05  PV-DELETE-COUNTER           PIC S9(07)    VALUE ZERO     01150000
011600                                                   COMP-3.        01160000
011700     05  PV-COMMIT-COUNTER           PIC S9(07)    VALUE ZERO     01170000
011800                                                   COMP-3.        01180000
012300     05  PV-COMMIT-COUNT             PIC S9(07)    VALUE ZERO     01230000
012400                                                   COMP-3.        01240000
012500     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             01250000
012600                                                                  01260000
012700     05  PV-DB2-COUNT                PIC S9(09)    VALUE ZERO     01270000
012800                                                   COMP-3.        01280000
012900     05  PV-OPER-UNT-ID              PIC 9(04)     VALUE ZERO.    01290000
013000     05  PV-RECV-SEQ-NBR             PIC 9(03)     VALUE ZERO.    01300000
013100     05  PV-PO-NBR                   PIC S9(08)    VALUE ZERO.    01310000
013200     05  PV-PO-LNE-NBR               PIC 9(03)     VALUE ZERO.    01320000
013300     05  PV-CURRENT-TIMESTAMP        PIC X(26)     VALUE SPACES.  01330000
013400     05  PV-COMMIT-TIME-AND-RCVR.                                 01340000
013500         10  FILLER                  PIC X(15)     VALUE          01350000
013600         'RECEIVER/LINE: '.                                       01360000
013700         10  PV-COMMIT-ORD-NBR       PIC 9(08)     VALUE ZEROS.   01370000
013800         10  FILLER                  PIC X(01)     VALUE '-'.     01380000
013900         10  PV-COMMIT-SEQ-NBR       PIC 9(04)     VALUE ZEROS.   01390000
014000         10  FILLER                  PIC X(01)     VALUE '-'.     01400000
014100         10  PV-COMMIT-LINE-NBR      PIC 9(04)     VALUE ZEROS.   01410000
014200         10  FILLER                  PIC X(20)     VALUE          01420000
014300         '      COMMIT COUNT: '.                                  01430004
014400         10  PV-RCT00019-DELETED     PIC ZZZ,ZZZ,ZZZ.             01440004
014600     05  PV-COMMIT-COUNTS.                                        01460000
014700         10  FILLER                  PIC X(22)     VALUE          01470000
014800         'RCT_PRC_RCPT DELETED: '.                                01480000
014900         10  PV-RCT00019-ROWS-DEL    PIC ZZ,ZZZ,ZZ9.              01490000
015300                                                                  01530000
017400                                                                  01740000
017500******************************************************************01750000
017600 PROCEDURE DIVISION.                                              01760000
017700******************************************************************01770000
017800                                                                  01780000
017900******************************************************************01790000
018000* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     01800000
018100*      PROGRAM.                                                   01810000
018200******************************************************************01820000
018300 0000-PROGRAM-MAINLINE.                                           01830000
018400                                                                  01840000
018500     PERFORM 1000-INITIALIZE.                                     01850000
018600                                                                  01860000
018700     SET PS-NOT-EOF-RCT00019-FILE TO TRUE.                        01870000
018800     PERFORM 7000-READ-RCT00019-FILE.                             01880000
018900                                                                  01890000
019000     PERFORM 2000-PROCESS-RCT00019-RECORDS                        01900000
019100        UNTIL PS-EOF-RCT00019-FILE.                               01910000
019200                                                                  01920000
019300     CLOSE RCT00019-FILE.                                         01930000
019400                                                                  01940000
019500     MOVE PV-INPUT-COUNTER TO PV-DISPLAY-COUNT.                   01950001
019600     DISPLAY 'TOTAL RCT00019 ROWS READ...: ' PV-DISPLAY-COUNT.    01960000
019700                                                                  01970000
019800     MOVE PV-DELETE-COUNTER TO PV-DISPLAY-COUNT.                  01980000
019900     DISPLAY 'TOTAL RCT00019 ROWS DELETED: ' PV-DISPLAY-COUNT.    01990000
020000                                                                  02000000
020300     MOVE PV-COMMIT-COUNT        TO PV-DISPLAY-COUNT.             02030000
020400     DISPLAY 'TOTAL COMMITS TAKEN: ' PV-DISPLAY-COUNT.            02040000
020500                                                                  02050000
020600     STOP RUN.                                                    02060000
020900                                                                  02090000
021000                                                                  02100000
021100******************************************************************02110000
021200*                                                                 02120000
021300******************************************************************02130000
021400 1000-INITIALIZE.                                                 02140000
021500                                                                  02150000
021600     INITIALIZE PV-INPUT-COUNTER                                  02160001
021700                PV-DELETE-COUNTER                                 02170001
021800                PV-COMMIT-COUNTER                                 02180000
021900                PV-COMMIT-COUNT.                                  02190000
022100                                                                  02210000
022200     OPEN INPUT RCT00019-FILE.                                    02220000
022300                                                                  02230000
022400                                                                  02240000
022900******************************************************************02290000
023000*  PROCESS THE RCT_PRC_RCPT ROWS THAT ARE IN THE EXTRACT FILE.    02300000
023100*  DELETE THE ROW FROM THE RCT_PRC_RCPT TABLE.                    02310000
023400******************************************************************02340000
023500 2000-PROCESS-RCT00019-RECORDS.                                   02350000
023600                                                                  02360000
023700     ADD +1 TO PV-INPUT-COUNTER.                                  02370001
023800                                                                  02380000
023900     PERFORM 2100-DELETE-RCT00019.                                02390000
024000                                                                  02400000
025100     IF PV-COMMIT-COUNTER   > 1000                                02510000
025300         PERFORM 2200-COMMIT-CHANGES                              02530000
025400         MOVE 0     TO PV-COMMIT-COUNTER                          02540000
025600     END-IF.                                                      02560000
025700                                                                  02570000
025800     PERFORM 7000-READ-RCT00019-FILE.                             02580000
025900                                                                  02590000
026200                                                                  02620000
026300******************************************************************02630000
026400*  DELETE THE CURRENT ROW FROM THE RCT_PRC_RCPT TABLE.            02640000
026500*  IF THE RCT_PRC_RCPT ROW IS NOT FOUND, THAT IS OK.              02650000
026600*  THIS CONDITION HAPPENS, WE ARE IN A RESTART MODE AND THE       02660000
026700*  ROW WAS DELETED IN THE ORIGINAL RUN.                           02670000
026800******************************************************************02680000
026900 2100-DELETE-RCT00019.                                            02690000
027000                                                                  02700000
027100     PERFORM WITH TEST AFTER                                      02710000
027200       VARYING PV-RETRY-COUNTER FROM 1 BY 1                       02720000
027300         UNTIL (PV-RETRY-COUNTER > PC-MAX-RETRIES  OR             02730000
027500                SQLCODE = ZERO                     OR             02750000
027700                SQLCODE = +100)                                   02770000
027800                                                                  02780000
027900         EXEC SQL                                                 02790000
028000              DELETE FROM RCT_PRC_RCPT                            02800008
028100               WHERE ORD_NBR          = :RCT00019-ORD-NBR         02810000
028200                 AND ORD_LNE_NBR      = :RCT00019-ORD-LNE-NBR     02820000
028300                 AND REC_SEQ_NBR      = :RCT00019-REC-SEQ-NBR     02830000
028310                 AND OPER_UNT_ID      = :RCT00019-OPER-UNT-ID     02831000
028320                 AND FCLTY_ID         = :RCT00019-FCLTY-ID        02832000
028330                 AND PRC_RCPT_TYP_CDE = :RCT00019-PRC-RCPT-TYP-CDE02833000
028340                 AND AMT_TYP_CDE      = :RCT00019-AMT-TYP-CDE     02834000
028400         END-EXEC                                                 02840000
028500                                                                  02850000
028600         EVALUATE TRUE                                            02860000
028700             WHEN SQLCODE = ZERO                                  02870000
028800                  MOVE SQLERRD(3) TO PV-SQLERRD3                  02880005
028900                  ADD PV-SQLERRD3 TO PV-DELETE-COUNTER            02890000
028910                                     PV-COMMIT-COUNTER            02891008
029000             WHEN SQLCODE = +100                                  02900000
029100             WHEN SQLCODE = -904                                  02910000
029200             WHEN SQLCODE = -911                                  02920000
029300                 CONTINUE                                         02930000
029400             WHEN SQLWARN0 NOT = SPACES                           02940000
029500             WHEN SQLCODE < ZERO                                  02950000
029600             WHEN SQLCODE > ZERO                                  02960000
029700                 MOVE '2100-DELETE-RCT00019           '           02970000
029800                                      TO PV-PARAGRAPH-NAME        02980000
029900                 MOVE 'ERROR DELETING ROW FROM RCT00019 TABLE'    02990000
030000                                      TO PV-DB2-OPERATION-MESSAGE 03000000
030100                 MOVE 'RCT_PRC_RCPT'  TO PV-DB2-TABLE-NAME-1      03010000
030200                 PERFORM 9100-SQL-ABEND                           03020000
030300         END-EVALUATE                                             03030000
030400     END-PERFORM.                                                 03040000
030500                                                                  03050000
030600     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         03060000
030700         MOVE '2100-DELETE-RCT00019          '                    03070000
030800                                 TO PV-PARAGRAPH-NAME             03080000
030900         MOVE '** DEADLOCK ENCOUNTERED ON THE DELETE **'          03090000
031000                                 TO PV-DB2-OPERATION-MESSAGE      03100000
031100         MOVE 'RCT_PRC_RCPT'     TO PV-DB2-TABLE-NAME-1           03110000
031200         PERFORM 9100-SQL-ABEND                                   03120000
031300     END-IF.                                                      03130000
031500                                                                  03150000
031600                                                                  03160000
031700******************************************************************03170000
031800*  COMMIT THE CHANGES                                             03180000
031900******************************************************************03190000
032000 2200-COMMIT-CHANGES.                                             03200000
032100                                                                  03210000
032200     EXEC SQL                                                     03220000
032300          COMMIT                                                  03230000
032400     END-EXEC.                                                    03240000
032500                                                                  03250000
032600     EVALUATE TRUE                                                03260000
032700         WHEN SQLCODE = ZERO                                      03270000
032800             ADD +1    TO PV-COMMIT-COUNT                         03280000
032900             MOVE RCT00019-ORD-NBR     TO PV-COMMIT-ORD-NBR       03290000
033000             MOVE RCT00019-ORD-LNE-NBR TO PV-COMMIT-SEQ-NBR       03300000
033200             MOVE RCT00019-REC-SEQ-NBR TO PV-COMMIT-LINE-NBR      03320000
033600             MOVE PV-DELETE-COUNTER    TO PV-RCT00019-DELETED     03360003
033610                                                                  03361000
033700             DISPLAY PV-COMMIT-TIME-AND-RCVR                      03370000
033800                                                                  03380000
034000         WHEN SQLWARN0 NOT = SPACES                               03400000
034100         WHEN SQLCODE < ZERO                                      03410000
034200         WHEN SQLCODE > ZERO                                      03420000
034300             MOVE '2200-COMMIT-CHANGES'                           03430000
034400                                 TO PV-PARAGRAPH-NAME             03440000
034500             MOVE 'ERROR ON COMMIT OF THE CHANGES'                03450000
034600                                 TO PV-DB2-OPERATION-MESSAGE      03460000
034700             MOVE 'RCT_PRC_RCPT' TO PV-DB2-TABLE-NAME-1           03470000
034900             PERFORM 9100-SQL-ABEND                               03490000
035000     END-EVALUATE.                                                03500000
035100                                                                  03510000
035200                                                                  03520000
041500******************************************************************04150000
041600*  READ A RECORD FROM THE RCT_PRC_RCPT FILE                       04160000
041700******************************************************************04170000
041800 7000-READ-RCT00019-FILE.                                         04180000
041900                                                                  04190000
042000     READ RCT00019-FILE                                           04200000
042100       INTO DCLRCT00019                                           04210000
042200           AT END                                                 04220000
042300               SET PS-EOF-RCT00019-FILE TO TRUE.                  04230000
042400                                                                  04240000
042700                                                                  04270000
055200 9100-SQL-ABEND.                                                  05520000
055300******************************************************************05530000
055400*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    05540000
055500*  ERROR OR WARNING CODE OCCURS.                                  05550000
055600******************************************************************05560000
055700     DISPLAY '9100-SQL-ABEND'.                                    05570000
055800     DISPLAY '** ABEND             **'.                           05580000
055900     DISPLAY '** PROGRAM           ** = '                         05590000
056000                                       PC-CURRENT-PROGRAM-NAME.   05600000
056100     DISPLAY '** PARAGRAPH         ** = '                         05610000
056200                                       PV-PARAGRAPH-NAME.         05620000
056300     DISPLAY '** TABLE(S) AFFECTED ** = '                         05630000
056400                                       PV-DB2-TABLE-NAME-1.       05640000
056500     DISPLAY '**                   ** = '                         05650000
056600                                       PV-DB2-TABLE-NAME-2.       05660000
056700     DISPLAY '** OPERATION         ** = '                         05670000
056800                                       PV-DB2-OPERATION-MESSAGE.  05680000
056900     DISPLAY '**                   ** = '                         05690000
057000     DISPLAY '** LAST COMMIT INFO  ** = '                         05700000
057100                                       PV-COMMIT-TIME-AND-RCVR.   05710000
057200     DISPLAY '**                   ** = '                         05720000
057300                                       PV-COMMIT-COUNTS.          05730000
057400                                                                  05740000
057500******************************************************************05750000
057600* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    05760000
057700* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         05770000
057800* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     05780000
057900* FORMAT.                                                         05790000
058000******************************************************************05800000
058100     COPY DPPD004.                                                05810000
058200                                                                  05820000
058300     EXEC SQL                                                     05830000
058400         ROLLBACK                                                 05840000
058500     END-EXEC.                                                    05850000
058600                                                                  05860000
058700     MOVE +4013                  TO ABEND-CODE.                   05870000
058800     CALL 'ILBOABN0' USING ABEND-CODE.                            05880000
