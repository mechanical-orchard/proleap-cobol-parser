000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400 PROGRAM-ID.             SSKUT016.                                00040002
000500 AUTHOR.                 KOHLS DEPARTMENT STORES.                 00050000
000600 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00060000
000700 DATE-WRITTEN            DEC 2009.                                00070002
000800 DATE-COMPILED.                                                   00080000
000900***************************************************************** 00090000
001000*                                                                 00100000
001100*  THIS PROGRAM READS A DATE CONTROL CARD AND WRITE INTO AN       00110002
001200*  OUTPUT FILE USING INFORMATION FROM THE TEPTRN, TEPPART,        00120002
001300*  AND TEPITM TABLE. THE OUTPUT FILE IS USED FOR UPDATING         00130002
001400*  THE TABLE EPT_TRN_CTG_SUM.                                     00140002
001400*                                                                 00150002
001500*  INPUT: INP01 - A DATE CONTROL CARD IN CCYY-MM-DD FORMAT.       00160000
001600*                                                                 00170000
001700* NOTE: OCCASIONALLY CTG_TRN_QTY IS NEGATIVE AND/OR GREATER THAN  00180000
001800*       CTG_ITM_QTY. THIS IS CAUSED BY VOID AFTERS AND THE        00190000
001900*       TRANSACTION BEING VOID OCCURED IN TWO DIFFERENT HALF      00200000
002000*       HOURS.                                                    00210000
002100***************************************************************** 00220000
C27938* DATE: 05/24/2012                                                00230019
C27938* WHO: KAREN GIVENS (REFER TO 'C27938' FOR ALL CHANGES)           00240019
C27938* WHY: ADDED NEW TRN_DTE TO EPT_TRN_CTG_SUM                       00250019
C27938******************************************************************00260019
002200 ENVIRONMENT DIVISION.                                            00270000
002300***************************************************************** 00280000
002400                                                                  00290000
002500 CONFIGURATION SECTION.                                           00300000
002600                                                                  00310000
002700 SOURCE-COMPUTER.        IBM-3090.                                00320000
002800 OBJECT-COMPUTER.        IBM-3090.                                00330000
002900                                                                  00340000
003000 INPUT-OUTPUT SECTION.                                            00350000
003100                                                                  00360000
003200 FILE-CONTROL.                                                    00370000
003300                                                                  00380000
003400     SELECT POS-DATE-CARD-FILE                                    00390014
003500         ASSIGN TO INP01.                                         00400000
003600                                                                  00410000
003700     SELECT TRN-CTG-SUM-FILE                                      00420010
003800         ASSIGN TO OUT01.                                         00430014
003600                                                                  00440002
003700******************************************************************00450000
003800 DATA DIVISION.                                                   00460000
003900******************************************************************00470000
004000                                                                  00480000
004100 FILE SECTION.                                                    00490000
004200                                                                  00500000
004300 FD  POS-DATE-CARD-FILE                                           00510000
004400     RECORDING MODE IS F                                          00520000
004500     LABEL RECORDS ARE STANDARD                                   00530000
004600     BLOCK CONTAINS 0 RECORDS                                     00540000
004700     RECORD CONTAINS 80 CHARACTERS                                00550000
004800     DATA RECORD IS CONTROL-DATE-RECORD.                          00560000
004900                                                                  00570000
005000 01  POS-DATE-CARD-RECORD             PIC  X(80).                 00580000
005100                                                                  00590000
007000 FD  TRN-CTG-SUM-FILE                                             00600002
007100     RECORDING MODE IS F                                          00610002
007200     LABEL RECORDS ARE STANDARD                                   00620002
007300     RECORD CONTAINS 47 CHARACTERS                                00630016
007400     DATA RECORD IS TRN-CTG-SUM-RECORD.                           00640005
C27938 01  TRN-CTG-SUM-RECORD              PIC  X(47).                  00650019
005200******************************************************************00660000
005300 WORKING-STORAGE SECTION.                                         00670000
005400******************************************************************00680000
005500 01  FILLER                           PIC  X(50) VALUE            00690000
005600     ' *** WORKING STORAGE STARTS HERE FOR SSKUT016 *** '.        00700002
005700                                                                  00710000
005800******************************************************************00720000
005900* RECORD LAYOUT FOR INPUT DATE CONTROL CARD                       00730000
006000******************************************************************00740000
006100 01  CC-CONTROL-CARD.                                             00750000
006200     05  CC-DB2-FORMAT                PIC  X(10) VALUE SPACES.    00760000
006300     05  FILLER                       PIC  X(70) VALUE SPACES.    00770000
      ***************************************************************   00780003
      * RECORD LAYOUT FOR OUTPUT FILE TRN-CTG-SUM-FILE                  00790003
      ***************************************************************   00800003
006400     COPY SSRD020.                                                00810013
006500******************************************************************00820000
006600*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             00830000
006700******************************************************************00840000
006800     COPY DPWS500.                                                00850000
006900                                                                  00860000
007000******************************************************************00870000
007100 01  AC-ABEND-CODE                    PIC S9(04) VALUE ZEROES     00880000
007200                                                 COMP SYNC.       00890000
007300     88  AC-DATE-CARD-ERROR                      VALUE +4003.     00900000
007400     88  AC-DB2-ERROR                            VALUE +4013.     00910000
007500     88  AC-CALENDAR-ROUTINE-ERROR               VALUE +4019.     00920000
007600                                                                  00930000
008200 01  ABEND-CODE                       PIC S9(04) VALUE +0         00940005
008300                                                 COMP.            00950005
008400                                                                  00960005
                                                                        00970002
007700******************************************************************00980002
007800*  PROGRAM SWITCHES                                               00990002
007900******************************************************************01000002
008000 01  PS-PROGRAM-SWITCHES.                                         01010000
008100     05  PS-END-OF-CURSOR-SW          PIC  X(01) VALUE 'N'.       01020000
008200         88  PS-END-OF-CURSOR-YES                VALUE 'Y'.       01030000
008300     05  PS-END-OF-FILE-SW            PIC  X(01) VALUE 'N'.       01040000
008400         88  PS-END-OF-FILE-YES                  VALUE 'Y'.       01050000
008500     05  PS-TRN-TYP-CDE               PIC  X(02).                 01060000
008600         88  PS-SALES                 VALUE '01', '02'.           01070000
008700         88  PS-RETURNS               VALUE '11', '12'.           01080000
008800         88  PS-MIX-MODE              VALUE '21', '22', '23',     01090000
008900                                            '24', '25'.           01100000
009000                                                                  01110000
009100******************************************************************01120000
009200*  PROGRAM CONSTANTS.                                             01130000
009300******************************************************************01140000
009400 01  PC-CONSTANTS.                                                01150000
009500     05  PC-CURRENT-PROGRAM-NAME      PIC  X(08) VALUE 'SSKUT016'.01160002
009600     05  PC-ROW-NOT-FOUND             PIC S9(03) VALUE +100.      01170000
009700                                                                  01180000
009800     05  PC-SUM-CTG-CDE.                                          01190000
009900         10  PC-SALE                  PIC  X(3) VALUE 'SAL'.      01200000
010000         10  PC-RETURN                PIC  X(3) VALUE 'RET'.      01210000
010100         10  PC-TAX                   PIC  X(3) VALUE 'TAX'.      01220000
010200         10  PC-GIFT-CARDS            PIC  X(3) VALUE 'GDS'.      01230000
010400                                                                  01240000
010500******************************************************************01250000
010600*  PROGRAM VARIABLES.                                             01260000
010700******************************************************************01270000
010800 01  PV-MISC-FIELDS.                                              01280000
010900     05  PV-PARAGRAPH-NAME            PIC  X(30) VALUE SPACE.     01290000
011000     05  PV-DB2-OPERATION             PIC  X(30) VALUE SPACE.     01300000
011100     05  PV-OPERATION-MSG-1           PIC  X(30) VALUE SPACE.     01310000
011200     05  PV-OPERATION-MSG-2           PIC  X(30) VALUE SPACE.     01320000
011300                                                                  01330000
011400     05 PV-DB2-HHMMSS.                                            01340000
011500         10 PV-DB2-HHMMSS-HH          PIC 99 VALUE ZEROES.        01350000
011600         10 FILLER                    PIC X  VALUE '.'.           01360000
011700         10 PV-DB2-HHMMSS-MM          PIC 99 VALUE ZEROES.        01370000
011800         10 FILLER                    PIC X  VALUE '.'.           01380000
011900         10 PV-DB2-HHMMSS-SS          PIC 99 VALUE ZEROES.        01390000
012000                                                                  01400000
012100     05 PV-CTG-HHMMSS-STRT.                                       01410000
012200         10 PV-CTG-HHMMSS-HH-STRT     PIC 99 VALUE ZEROES.        01420000
012300         10 FILLER                    PIC X  VALUE '.'.           01430000
012400         10 PV-CTG-HHMMSS-MM-STRT     PIC 99 VALUE ZEROES.        01440000
012500         10 FILLER                    PIC X  VALUE '.'.           01450000
012600         10 PV-CTG-HHMMSS-SS-STRT     PIC 99 VALUE ZEROES.        01460000
012700                                                                  01470000
012800     05 PV-CTG-HHMMSS-END.                                        01480000
012900         10 PV-CTG-HHMMSS-HH-END      PIC 99 VALUE ZEROES.        01490000
013000         10 FILLER                    PIC X  VALUE '.'.           01500000
013100         10 PV-CTG-HHMMSS-MM-END      PIC 99 VALUE ZEROES.        01510000
013200         10 FILLER                    PIC X  VALUE '.'.           01520000
013300         10 PV-CTG-HHMMSS-SS-END      PIC 99 VALUE ZEROES.        01530000
013400                                                                  01540000
013500******************************************************************01550000
013600*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            01560000
013700******************************************************************01570000
013800     COPY DPWS004.                                                01580000
013900                                                                  01590000
014000******************************************************************01600000
014100*  DB2 COMMUNICATION AREA.                                        01610000
014200******************************************************************01620000
014300     EXEC SQL                                                     01630000
014400          INCLUDE SQLCA                                           01640000
014500     END-EXEC.                                                    01650000
014600                                                                  01660000
014700***************************************************************** 01670000
014800* DB2 TABLE TEPPART - PARTITION TABLE                             01680000
014900***************************************************************** 01690000
015000     EXEC SQL                                                     01700000
015100          INCLUDE TEPPART                                         01710000
015200     END-EXEC.                                                    01720000
015300                                                                  01730000
015400***************************************************************** 01740000
015500*  DB2 TABLE EPT_TRN_CTG_SUM - TRANSACTION SUMMARY TOTALS         01750000
015600*  BY CATEGORY TABLE (SALES BY HOUR)                              01760000
015700***************************************************************** 01770000
015800                                                                  01780000
015900     EXEC SQL                                                     01790000
016000         INCLUDE EPT00004                                         01800000
016100     END-EXEC.                                                    01810000
016200                                                                  01820000
016300***************************************************************** 01830000
016400*  DB2 TABLE TEPTRN - TRANSACTION TABLE                           01840000
016500***************************************************************** 01850000
016600                                                                  01860000
016700     EXEC SQL                                                     01870000
016800         INCLUDE TEPTRN                                           01880000
016900     END-EXEC.                                                    01890000
017000                                                                  01900000
017100***************************************************************** 01910000
017200*  DB2 TABLE TEPITM - ITEM TABLE                                  01920000
017300***************************************************************** 01930000
017400                                                                  01940000
017500     EXEC SQL                                                     01950000
017600         INCLUDE TEPITM                                           01960000
017700     END-EXEC.                                                    01970000
017800                                                                  01980000
017900******************************************************************01990000
018000* DRIVING CURSOR TO PICK UP TRANSACTION AND ITEM INFORMATION.     02000000
018100*                                                                 02010000
018200* THE FOLLOWING CATEGORIES ARE THE VALUES TO BE INSERTED.         02020000
018300*     1) SAL: SALES                                               02030000
018400*     2) RET: RETURNS                                             02040000
018500*     3) GDS: GIFT CARD SOLD                                      02050000
018600*     4) GTS: GIFT CERTIFICATE SOLD                               02060000
018700*     5) TAX: TAX                                                 02070000
018800******************************************************************02080000
018900     EXEC SQL                                                     02090000
019000        DECLARE MAIN-INFO CURSOR FOR                              02100000
019100          SELECT DISTINCT                                         02110000
019200                 A.TRN_STAT_CDE                                   02120000
019300                ,A.TRN_TYP_CDE                                    02130000
019400                ,A.STR_NBR                                        02140000
019500                ,A.RGST_ID                                        02150000
019600                ,A.TRN_NBR                                        02160000
019700                ,A.TRN_TOT_AMT                                    02170000
019800                ,A.SLS_TX_AMT                                     02180000
019900                ,A.STRT_TM                                        02190000
020000                ,A.SLS_CORR_SEQ_NBR                               02200000
C27938                ,A.TRN_DTE                                        02210019
020100            FROM TEPTRN A                                         02220000
020200                ,TEPITM B                                         02230000
020300           WHERE A.PARTN_NBR        = :EPPART-PARTN-NBR           02240000
020400             AND A.PARTN_NBR        = B.PARTN_NBR                 02250000
020500             AND A.STR_NBR          = B.STR_NBR                   02260000
020600             AND A.RGST_ID          = B.RGST_ID                   02270000
020700             AND A.TRN_NBR          = B.TRN_NBR                   02280000
020800             AND A.STRT_TM          = B.STRT_TM                   02290000
020900             AND A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR          02300000
021000             AND A.VOID_ABRT_CDE    = 'N'                         02310000
021100             AND A.TRN_STAT_CDE    IN ('Z', 'L', 'V')             02320000
021200             AND B.LIV_RSLU_CDE    IN ('+', '-')                  02330000
021300             AND ((A.TRN_TYP_CDE   IN                             02340000
021400                  ('01', '02', '21', '22', '23', '24', '25') AND  02350000
021500                   A.TRN_TOT_AMT  > 0)                            02360000
021600******  RETURNS                                                   02370000
021700                         OR                                       02380000
021800                   A.TRN_TYP_CDE   IN                             02390000
021900                   ('11', '12', '21', '22', '23', '24', '25') AND 02400000
022000                   A.TRN_TOT_AMT  < 0)                            02410000
                   ORDER BY A.STR_NBR                                   02420008
022100        WITH UR                                                   02430000
022200        FOR READ ONLY                                             02440000
022300     END-EXEC.                                                    02450000
022400                                                                  02460000
022500***************************************************************** 02470000
022600 PROCEDURE DIVISION.                                              02480000
022700***************************************************************** 02490000
022800 0000-MAINLINE.                                                   02500000
022900***************************************************************** 02510000
023000                                                                  02520000
023100     PERFORM 1000-PROCESS-DATE-CARD.                              02530000
023200                                                                  02540000
023300     PERFORM 1500-SELECT-PARTITION.                               02550000
023400                                                                  02560000
023500     PERFORM 2000-OPEN-CURSOR.                                    02570000
023600                                                                  02580000
023700     PERFORM 3000-FETCH-CURSOR                                    02590000
023800         UNTIL PS-END-OF-CURSOR-YES.                              02600000
023900                                                                  02610000
024000     PERFORM 4000-CLOSE-CURSOR.                                   02620000
024100     PERFORM 4500-CLOSE-FILE.                                     02630009
024200     STOP RUN.                                                    02640000
024300                                                                  02650000
024400******************************************************************02660000
024500 1000-PROCESS-DATE-CARD.                                          02670000
024600*     OPEN AND READ CONTROL CARD. CALL DATE ROUTINE TO CONVERT    02680000
024700*     CONTROL DATE TO A CCYY-MM-DD PROCESS DATE. GET PARTITIONS.  02690000
024800******************************************************************02700000
024900                                                                  02710000
025000     OPEN INPUT  POS-DATE-CARD-FILE                               02720002
025000          OUTPUT TRN-CTG-SUM-FILE.                                02730009
025200     READ POS-DATE-CARD-FILE        INTO CC-CONTROL-CARD          02740000
025300        AT END                                                    02750000
025400           SET PS-END-OF-FILE-YES     TO TRUE.                    02760000
025800     IF PS-END-OF-FILE-YES                                        02770000
025900        MOVE '1000-PROCESS-DATE-CARD' TO PV-PARAGRAPH-NAME        02780000
026000        MOVE 'EMPTY DATE CARD'        TO PV-OPERATION-MSG-1       02790000
026100        SET AC-DATE-CARD-ERROR        TO TRUE                     02800000
026200        PERFORM 9999-ABEND                                        02810000
026300     END-IF.                                                      02820000
026400                                                                  02830000
026500     DISPLAY PC-CURRENT-PROGRAM-NAME                              02840000
026600             ' - CONTROL CARD = (' CC-DB2-FORMAT  ')'.            02850000
026700                                                                  02860000
026800     PERFORM 1115-CONVERT-INPUT-DATE.                             02870000
026900                                                                  02880000
027000******************************************************************02890000
027100 1115-CONVERT-INPUT-DATE.                                         02900000
027200*     KOHLS CALENDAR ROUTINE.                                     02910000
027300******************************************************************02920000
027400                                                                  02930000
027500     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              02940000
027600                                                                  02950000
027700     SET  DPG51-FISCAL-454-CALENDAR   TO TRUE.                    02960000
027800     SET  DPG51-DO-NOT-INCR-DECR-DATE TO TRUE.                    02970000
027900     SET  DPG52-LK-DTE-ISO-FMT        TO TRUE.                    02980000
028000     MOVE CC-DB2-FORMAT               TO DPG52-LK-DATE-INPUT.     02990000
028100     CALL DP500-KOHLS-CALENDAR-ROUTINE                            03000000
028200                                   USING DPG51 DPG52 DPG53        03010000
028300                                         DPG54 DPG55 DPG56.       03020000
028400                                                                  03030000
028500     EVALUATE TRUE                                                03040000
028600         WHEN DPG54-SEVERE-ERROR                                  03050000
028700         WHEN DPG54-DATE-INVALID                                  03060000
028800             MOVE '1115-CONVERT-INPUT-DATE'                       03070000
028900                                      TO PV-PARAGRAPH-NAME        03080000
029000             MOVE 'ERROR ON CONVERTING DATE'                      03090000
029100                                      TO PV-OPERATION-MSG-1       03100000
029200             SET AC-CALENDAR-ROUTINE-ERROR                        03110000
029300                                      TO TRUE                     03120000
029400             MOVE DPG54-ERROR-MESSAGE TO PV-OPERATION-MSG-2       03130000
029500             PERFORM 9999-ABEND                                   03140000
029600     END-EVALUATE.                                                03150000
029700                                                                  03160000
071800***************************************************************** 03170000
072300 1500-SELECT-PARTITION.                                           03180000
072301*      FIND PARTITION NUMBER THAT CORRESPONDS WITH CONTROL CARD   03190000
072302*      DATE AND IT'S DB_STRUC_CDE.                                03200000
072303***************************************************************** 03210000
072400                                                                  03220000
072500     EXEC SQL                                                     03230000
072600        SELECT PARTN_NBR                                          03240000
072610              ,DB_STRUC_CDE                                       03250000
072700          INTO :EPPART-PARTN-NBR                                  03260000
072710              ,:EPPART-DB-STRUC-CDE                               03270000
072800          FROM TEPPART                                            03280000
072900         WHERE SLS_DTE      = :CC-DB2-FORMAT                      03290000
073100           AND STR_GP_CDE   = 'A'                                 03300000
073200               WITH UR                                            03310000
073300     END-EXEC.                                                    03320000
073400                                                                  03330000
073500     IF SQLCODE = ZERO                                            03340000
073600        CONTINUE                                                  03350000
073700     ELSE                                                         03360000
073800        MOVE '1500-SELECT-PARTITION'  TO PV-PARAGRAPH-NAME        03370000
073900        MOVE SQLCODE                  TO PV-DB2-OPERATION         03380000
074000        PERFORM 9100-SQL-ABEND                                    03390000
074100     END-IF.                                                      03400000
074200                                                                  03410000
074300******************************************************************03420000
074400 2000-OPEN-CURSOR.                                                03430000
074500******************************************************************03440000
074600                                                                  03450000
074700     EXEC SQL                                                     03460000
074800          OPEN MAIN-INFO                                          03470000
074900     END-EXEC.                                                    03480000
075000                                                                  03490000
075100     IF SQLCODE = ZERO                                            03500000
075200        CONTINUE                                                  03510000
075300     ELSE                                                         03520000
075400        MOVE '2000-OPEN-CURSOR'       TO PV-PARAGRAPH-NAME        03530000
075500        MOVE SQLCODE                  TO PV-DB2-OPERATION         03540000
075600        PERFORM 9100-SQL-ABEND                                    03550000
075700     END-IF.                                                      03560000
075800                                                                  03570000
075900******************************************************************03580000
076000 3000-FETCH-CURSOR.                                               03590000
076100******************************************************************03600000
076200                                                                  03610000
076300     EXEC SQL                                                     03620000
076400          FETCH MAIN-INFO                                         03630000
076500           INTO :EPTRN-TRN-STAT-CDE                               03640000
076600               ,:EPTRN-TRN-TYP-CDE                                03650000
076700               ,:EPTRN-STR-NBR                                    03660000
076800               ,:EPTRN-RGST-ID                                    03670000
076900               ,:EPTRN-TRN-NBR                                    03680000
077000               ,:EPTRN-TRN-TOT-AMT                                03690000
077100               ,:EPTRN-SLS-TX-AMT                                 03700000
077200               ,:EPTRN-STRT-TM                                    03710000
077300               ,:EPTRN-SLS-CORR-SEQ-NBR                           03720000
C27938               ,:EPTRN-TRN-DTE                                    03730019
077400     END-EXEC.                                                    03740000
077500                                                                  03750000
077600     EVALUATE SQLCODE                                             03760000
077700        WHEN ZERO                                                 03770000
077800           PERFORM 5000-POPULATE-FIELDS                           03780000
077900           PERFORM 5100-COUNT-MDSE                                03790000
078100           PERFORM 5300-GET-GIFT-CARD                             03800000
078200           IF EPTRN-SLS-TX-AMT     NOT = ZERO                     03810000
078300              MOVE PC-TAX             TO EPT00004-SUM-CTG-CDE     03820000
078400              MOVE 1                  TO EPT00004-CTG-ITM-QTY     03830000
078500              PERFORM 5400-WRITE-OUTPUT                           03840002
078600           END-IF                                                 03850000
078700        WHEN PC-ROW-NOT-FOUND                                     03860000
078800           SET PS-END-OF-CURSOR-YES   TO TRUE                     03870000
078900        WHEN OTHER                                                03880000
079100           MOVE '3000-FETCH-CURSOR'   TO PV-PARAGRAPH-NAME        03890000
079300           MOVE SQLCODE               TO PV-DB2-OPERATION         03900000
079500           PERFORM 9100-SQL-ABEND                                 03910000
079600     END-EVALUATE.                                                03920000
079700                                                                  03930000
079800******************************************************************03940000
079900 4000-CLOSE-CURSOR.                                               03950000
080000******************************************************************03960000
080100                                                                  03970000
080200     EXEC SQL                                                     03980000
080300          CLOSE MAIN-INFO                                         03990000
080400     END-EXEC.                                                    04000000
080500                                                                  04010000
080600     IF SQLCODE = ZERO                                            04020000
080700        CONTINUE                                                  04030000
080800     ELSE                                                         04040000
080900        MOVE '4000-CLOSE-CURSOR'      TO PV-PARAGRAPH-NAME        04050000
081000        MOVE SQLCODE                  TO PV-DB2-OPERATION         04060000
081100        PERFORM 9100-SQL-ABEND                                    04070000
081200     END-IF.                                                      04080000
079800******************************************************************04090009
       4500-CLOSE-FILE.                                                 04100009
079800******************************************************************04110009
           CLOSE  POS-DATE-CARD-FILE                                    04120009
                  TRN-CTG-SUM-FILE.                                     04130009
081400******************************************************************04140000
081500 5000-POPULATE-FIELDS.                                            04150000
081600*     DETERMINE THE TIME WHEN TRANSACTION TOOK PLACE.             04160000
081700*     DETERMINE THE SUM_TYP_CDE.                                  04170000
081800******************************************************************04180000
081900                                                                  04190000
148080     MOVE EPTRN-STRT-TM               TO PV-DB2-HHMMSS.           04200000
148081     MOVE PV-DB2-HHMMSS-HH            TO PV-CTG-HHMMSS-HH-STRT    04210000
148082                                         PV-CTG-HHMMSS-HH-END.    04220000
148100                                                                  04230000
148110     IF PV-DB2-HHMMSS-MM               < 30                       04240000
148130        MOVE ZEROS                    TO PV-CTG-HHMMSS-MM-STRT    04250000
148140                                         PV-CTG-HHMMSS-SS-STRT    04260000
148150        MOVE 29                       TO PV-CTG-HHMMSS-MM-END     04270000
148151        MOVE 59                       TO PV-CTG-HHMMSS-SS-END     04280000
148152     ELSE                                                         04290000
148153        MOVE 30                       TO PV-CTG-HHMMSS-MM-STRT    04300000
148154        MOVE ZEROS                    TO PV-CTG-HHMMSS-SS-STRT    04310000
148155        MOVE 59                       TO PV-CTG-HHMMSS-MM-END     04320000
148156        MOVE 59                       TO PV-CTG-HHMMSS-SS-END     04330000
148160     END-IF.                                                      04340000
148300                                                                  04350000
148301     EVALUATE EPTRN-TRN-STAT-CDE                                  04360000
148302        WHEN 'Z'                                                  04370000
148303           MOVE 'D' TO EPT00004-SUM-TYP-CDE                       04380000
148304        WHEN 'L'                                                  04390000
148305           MOVE 'L' TO EPT00004-SUM-TYP-CDE                       04400000
148306        WHEN 'V'                                                  04410000
148307           MOVE 'N' TO EPT00004-SUM-TYP-CDE                       04420000
148308        WHEN OTHER                                                04430000
148309           DISPLAY EPTRN-TRN-STAT-CDE ' IS PROCESSED.'            04440000
148310     END-EVALUATE.                                                04450000
148311                                                                  04460000
148312     MOVE EPPART-PARTN-NBR            TO EPT00004-PARTN-NBR.      04470000
148313     MOVE EPTRN-STR-NBR               TO EPT00004-STR-NBR.        04480000
148314     MOVE PV-CTG-HHMMSS-STRT          TO EPT00004-SUM-STRT-TM.    04490000
148315     MOVE PV-CTG-HHMMSS-END           TO EPT00004-SUM-END-TM.     04500000
C27938     MOVE EPTRN-TRN-DTE               TO EPT00004-TRN-DTE.        04510019
148316     MOVE EPTRN-TRN-TYP-CDE           TO PS-TRN-TYP-CDE.          04520000
148317                                                                  04530000
148318     IF PS-SALES                      OR                          04540000
148319        PS-MIX-MODE                  AND                          04550000
148320        EPTRN-TRN-TOT-AMT              > ZERO                     04560000
148321        MOVE PC-SALE                  TO EPT00004-SUM-CTG-CDE     04570000
148322     ELSE                                                         04580000
148323        MOVE PC-RETURN                TO EPT00004-SUM-CTG-CDE     04590000
148324     END-IF.                                                      04600000
148325                                                                  04610000
148326******************************************************************04620000
148327 5100-COUNT-MDSE.                                                 04630000
148328*     SUM SLD_QTY FOR EACH TRANSACTION.                           04640000
148329******************************************************************04650000
148330                                                                  04660000
148340     EXEC SQL                                                     04670000
148350          SELECT SUM(SLD_QTY)                                     04680000
148360            INTO :EPITM-SLD-QTY                                   04690000
148370            FROM TEPITM                                           04700000
148380           WHERE PARTN_NBR        = :EPPART-PARTN-NBR             04710000
148390             AND STR_NBR          = :EPTRN-STR-NBR                04720000
148400             AND RGST_ID          = :EPTRN-RGST-ID                04730000
148500             AND TRN_NBR          = :EPTRN-TRN-NBR                04740000
148600             AND STRT_TM          = :EPTRN-STRT-TM                04750000
148700             AND SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR       04760000
148800             AND LIV_RSLU_CDE    IN ('+', '-')                    04770000
148900             AND DEPT_NBR NOT    IN ('981','983')                 04780007
149000                 WITH UR                                          04790000
149100     END-EXEC.                                                    04800000
149200                                                                  04810000
149300     EVALUATE SQLCODE                                             04820000
149400        WHEN ZERO                                                 04830000
149500           MOVE EPITM-SLD-QTY         TO EPT00004-CTG-ITM-QTY     04840000
149600           PERFORM 5400-WRITE-OUTPUT                              04850002
149700        WHEN PC-ROW-NOT-FOUND                                     04860000
149800        WHEN -305                                                 04870000
149900           CONTINUE                                               04880000
149901        WHEN OTHER                                                04890000
149902           MOVE '5100-COUNT-MDSE'     TO PV-PARAGRAPH-NAME        04900000
149903           MOVE SQLCODE               TO PV-DB2-OPERATION         04910000
149904           PERFORM 9100-SQL-ABEND                                 04920000
149905     END-EVALUATE.                                                04930000
151807******************************************************************04940000
151808 5300-GET-GIFT-CARD.                                              04950000
151809*     GET QUANTITY OF GIFT CARD SOLD.                             04960000
151810******************************************************************04970000
151820                                                                  04980000
151830     EXEC SQL                                                     04990000
151840        SELECT SUM(SLD_QTY)                                       05000000
151850              ,SUM(NET_CHRGD_AMT)                                 05010000
151860          INTO :EPITM-SLD-QTY                                     05020000
151870              ,:EPITM-NET-CHRGD-AMT                               05030000
151880          FROM TEPITM                                             05040000
151890         WHERE PARTN_NBR        = :EPPART-PARTN-NBR               05050000
151900           AND STR_NBR          = :EPTRN-STR-NBR                  05060000
152000           AND RGST_ID          = :EPTRN-RGST-ID                  05070000
152100           AND TRN_NBR          = :EPTRN-TRN-NBR                  05080000
152200           AND SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR         05090000
152300           AND STRT_TM          = :EPTRN-STRT-TM                  05100000
152400           AND LIV_RSLU_CDE    IN ('+', '-')                      05110000
152500           AND DEPT_NBR         = '983'                           05120007
152600     END-EXEC.                                                    05130000
152700                                                                  05140000
152800     EVALUATE SQLCODE                                             05150000
152900        WHEN ZERO                                                 05160000
153000           IF EPITM-NET-CHRGD-AMT      > ZERO                     05170000
153100              MOVE PC-GIFT-CARDS      TO EPT00004-SUM-CTG-CDE     05180000
153200              MOVE EPITM-SLD-QTY      TO EPT00004-CTG-ITM-QTY     05190000
153300              PERFORM 5400-WRITE-OUTPUT                           05200002
153400           END-IF                                                 05210000
153500        WHEN PC-ROW-NOT-FOUND                                     05220000
153600        WHEN -305                                                 05230000
153700           MOVE 0                     TO EPITM-NET-CHRGD-AMT      05240007
153701        WHEN OTHER                                                05250000
153702           MOVE '5300-GET-GIFT-CARD'  TO PV-PARAGRAPH-NAME        05260000
153703           MOVE SQLCODE               TO PV-DB2-OPERATION         05270000
153704           PERFORM 9100-SQL-ABEND                                 05280000
153705     END-EVALUATE.                                                05290000
153706                                                                  05300000
153707******************************************************************05310000
153708 5400-WRITE-OUTPUT.                                               05320002
153709*     UPDATE THE CTG_ITM_QTY IN EPT_TRN_CTG_SUM.                  05330000
153710******************************************************************05340000
153711                                                                  05350000
           MOVE EPT00004-CTG-ITM-QTY TO SS020-TRN-CTG-ITM-QTY.          05360013
                                                                        05370003
           MOVE EPT00004-PARTN-NBR   TO SS020-TRN-PARTN-NBR.            05380013
                                                                        05390003
           MOVE EPT00004-SUM-TYP-CDE TO SS020-TRN-SUM-TYP-CDE.          05400013
                                                                        05410003
           MOVE EPT00004-SUM-CTG-CDE TO SS020-TRN-SUM-CTG-CDE.          05420013
                                                                        05430003
           MOVE EPT00004-SUM-STRT-TM TO SS020-TRN-SUM-STRT-TM.          05440013
                                                                        05450003
           MOVE EPT00004-STR-NBR     TO SS020-TRN-STR-NBR.              05460013
                                                                        05470014
C27938     MOVE EPT00004-TRN-DTE     TO SS020-TRN-DTE.                  05480019
                                                                        05490014
           MOVE EPT00004-SUM-END-TM  TO SS020-TRN-SUM-END-TM.           05500014
                                                                        05510014
           WRITE TRN-CTG-SUM-RECORD  FROM SS020-TRN-CTG-SUM-RECORD.     05520014
153744                                                                  05530000
153745******************************************************************05540000
153746 9100-SQL-ABEND.                                                  05550000
153747*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.05560000
153748******************************************************************05570000
153749                                                                  05580000
153750     DISPLAY ' '.                                                 05590000
153751     DISPLAY '** ABEND     **'.                                   05600000
153752     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        05610000
153753     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              05620000
153760     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               05630000
153770     DISPLAY '** STORE NBR ** = ' EPT00004-STR-NBR.               05640000
153780     DISPLAY '** TYPE CODE ** = ' EPT00004-SUM-TYP-CDE.           05650000
153790     DISPLAY '** CATG CODE ** = ' EPT00004-SUM-CTG-CDE.           05660000
153800     DISPLAY '** START TIME** = ' EPT00004-SUM-STRT-TM.           05670000
153900     DISPLAY '** END TIME  ** = ' EPT00004-SUM-END-TM.            05680000
154000                                                                  05690000
154100******************************************************************05700000
154200* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     05710000
154300* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      05720000
154400******************************************************************05730000
154500     COPY DPPD004.                                                05740000
154600                                                                  05750000
154700                                                                  05760000
154800     SET AC-DB2-ERROR TO TRUE.                                    05770000
154900     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         05780000
155000                                                                  05790000
155100******************************************************************05800000
155200* 9999-ABEND                                                      05810000
155300*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  05820000
155400******************************************************************05830000
155500 9999-ABEND.                                                      05840000
155600                                                                  05850000
155700     DISPLAY ' '.                                                 05860000
155800     DISPLAY '** ABEND           **'.                             05870000
155900     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  05880000
156000     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        05890000
156100     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       05900000
156200     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       05910000
156300     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         05920000
