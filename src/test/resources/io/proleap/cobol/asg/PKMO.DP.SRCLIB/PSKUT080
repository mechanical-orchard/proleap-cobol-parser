000200 IDENTIFICATION DIVISION.                                         00010099
000300******************************************************************00020099
000400                                                                  00030099
000500 PROGRAM-ID.             PSKUT080.                                00040099
000600 AUTHOR.                 DOUG JONES                               00050099
000700 INSTALLATION.           KOHLS.                                   00060099
000800 DATE-WRITTEN            OCT, 2000.                               00070099
000900 DATE-COMPILED.                                                   00080099
001000                                                                  00090099
001100******************************************************************00100099
001200*  THIS PROGRAM IS THE RE-WRITE OF PROD PSKUT080.  IT WILL PRODUCE00110099
001300*  THE GIFT FILE.                                                 00120099
001400*                                                                 00130099
001500******************************************************************00140099
001510*  01/21/02  MICHELE RINDFLEISCH   WR#: WR23176                   00150099
001520*  MULTI-CHANNEL GIFT CARD CHANGES TO USE NEW STORED VALUE TABLES.00160099
001530*  ALSO CHANGE TO HANDLE CARDS FROM 12 TO 16 IN LENGTH.           00170099
001500******************************************************************00180099
001510*  04/29/03  GAYLE HAUPT           WR#: P000543858                00190099
001520*  CHANGED SELECT ON SVT TABLES TO USE WITH UR IN ORDER TO AVOID  00200099
001530*  CONTENTION WITH STORED VALUE JOBS.                             00210099
001700******************************************************************00220099
FL0902*  04/20/09  JIM HUNTER            WR#: WR36454                   00230099
FL0902*  (REFER TO 'FL0902' FOR ALL CHANGES)                            00240099
FL0902*  THESE ARE THE FALL 2009 POS CHANGES FOR THE EXPANSION OF THE   00250099
FL0902*  KOHL'S GIFT CARDS FROM 13 DIGITS TO 30 DIGITS.  ONLY THE LAST  00260099
FL0902*  12 DIGITS WILL BE REQUIRED FOR REPORTING PURPOSES.             00270099
001700******************************************************************00280099
P10237*  03/27/15  COGNIZANT             WR#: CHG0104429                00290099
P10237*  CHANGES MADE TO DETOKENIZE THE GIFT CARD NUMBER IN TNDR_ID     00300099
P10237*  FIELD. PROTEGRITY WILL BE INVOKED TO DETOKENIZE THE GIFT CARD  00310099
P10237*  NUMBER.                                                        00320099
P10237******************************************************************00330099
C10237*  09/13/15  COGNIZANT             WR#: CHG0122538                00331099
C10237*  CHANGES MADE TO DETOKENIZE GIFT CARD# FOR TNDR-ID-LEN 5        00332099
C10237*  ONLY IF ACTUAL LENGTH IS 8                                     00332199
C10237*  ALSO CHANGES MADE TO MOVE THE CARD NUMBER 1:12 FOR THE 12 DIGIT00332299
C10237*  CARD NUMBER AS REQUESTED BY SERVICE DELIVERY                   00332399
C10237******************************************************************00335099
268841*  04/07/22  BARB SCHULTZ         CHG#: CHG0268841                00336099
268841*  ADDED THE TNDR-ID-SRC-CDE TO THE TENDER-CSR AND ADDED THE DEPT 00337099
268841*  '712' TO WORKING STORAGE AND THE ITEM-CSR.  ALSO ADDED THE     00338099
268841*  TRUNCATION OF THE SEPHORA GIFT CARD WHEN THE MDSE-ID IS 16 OR  00339099
268841*  28 CHARACTERS LONG TO BE 12 CHARACTERS TO FIT ON THE REPORT.   00339199
268841*  ALSO DID THE SAME FOR SEPHORA GIFT CARDS THAT ARE TENDERS      00339299
268841*  ON THE TEPTND TABLE.                                           00339399
268841******************************************************************00339499
273953*  08/30/22  BARB SCHULTZ         CHG#: CHG0273953                00339599
273953*  CHANGED HOW TO PROCESS THE SEPHORA GIFT CARDS.  TOOK OUT THE   00339699
273953*  CODING THAT WAS BASED ON HOW LONG THE GIFT CARD NUMBER IS.     00339799
273953******************************************************************00339899
001800 ENVIRONMENT DIVISION.                                            00340099
001900******************************************************************00350099
002000                                                                  00360099
002100 CONFIGURATION SECTION.                                           00370099
002200                                                                  00380099
002300 SOURCE-COMPUTER.        IBM-3090.                                00390099
002400 OBJECT-COMPUTER.        IBM-3090.                                00400099
002500                                                                  00410099
002600 INPUT-OUTPUT SECTION.                                            00420099
002700                                                                  00430099
002800 FILE-CONTROL.                                                    00440099
002900                                                                  00450099
003000     SELECT POS-DATE-FILE                                         00460099
003100         ASSIGN TO INP01.                                         00470099
003200                                                                  00480099
003300     SELECT GIFT-EXTRACT-FILE                                     00490099
003400         ASSIGN TO OUT01.                                         00500099
003500                                                                  00510099
003600******************************************************************00520099
003700 DATA DIVISION.                                                   00530099
003800******************************************************************00540099
003900                                                                  00550099
004000 FILE SECTION.                                                    00560099
004100                                                                  00570099
004200 FD POS-DATE-FILE                                                 00580099
004300     RECORDING MODE IS F                                          00590099
004400     LABEL RECORDS ARE STANDARD                                   00600099
004500     RECORD CONTAINS 80 CHARACTERS                                00610099
004600     BLOCK CONTAINS 0 RECORDS                                     00620099
004700     DATA RECORD IS POS-DATE-RECORD.                              00630099
004800                                                                  00640099
004900 01 POS-DATE-RECORD        PIC X(80).                             00650099
005000                                                                  00660099
005100 FD  GIFT-EXTRACT-FILE                                            00670099
005200     RECORDING MODE IS F                                          00680099
005300     LABEL RECORDS ARE STANDARD                                   00690099
005400     BLOCK CONTAINS 0 RECORDS                                     00700099
005500     RECORD CONTAINS 050 CHARACTERS                               00710099
005600     DATA RECORD IS GIFT-EXTRACT-RECORD.                          00720099
005700                                                                  00730099
005800 01  GIFT-EXTRACT-RECORD              PIC X(50).                  00740099
005900                                                                  00750099
006000                                                                  00760099
006100 WORKING-STORAGE SECTION.                                         00770099
006200                                                                  00780099
006300 01  FILLER                           PIC X(32)      VALUE        00790099
006400     '   WORKING STORAGE STARTS HERE  '.                          00800099
006500                                                                  00810099
006600 01  PROGRAM-VARIABLE-AREA.                                       00820099
006700     05  PV-CURRENT-DAY-PARTN         PIC S9(04)     COMP         00830099
006800                                                     VALUE ZERO.  00840099
006900     05  PV-DB2-OPERATION            PIC  X(30)   VALUE SPACE.    00850099
007000     05  PV-PARAGRAPH-NAME            PIC  X(30)     VALUE SPACE. 00860099
007100     05  PV-OPERATION-MSG-1           PIC  X(40)     VALUE SPACE. 00870099
007200     05  PV-OPERATION-MSG-2           PIC  X(40)     VALUE SPACE. 00880099
007300     05  PV-ITEM-CSR-CNT              PIC S9(07)     VALUE ZERO.  00890099
007400     05  PV-TENDER-CSR-CNT            PIC S9(07)     VALUE ZERO.  00900099
007500     05  PV-GIFT-CARD-ID              PIC S9(12)V    VALUE +0     00910099
007600                                                     COMP-3.      00920099
273953     05  PV-RESULT                    PIC S9(02)     VALUE ZERO.  00921099
273953     05  PV-START                     PIC S9(02)     VALUE ZERO.  00930099
FL0902     05  PV-MDSE-ID-NUM               PIC  9(30)     VALUE ZERO.  00931099
007800     05  PV-MDSE-ID-NUM-CHAR                                      00940099
FL0902             REDEFINES PV-MDSE-ID-NUM PIC X(30).                  00950099
008000     05  PV-TRN-SLS-DTE.                                          00960099
008100         10 PV-TRN-SLS-DTE-CC         PIC X(02).                  00970099
008200         10 PV-TRN-SLS-DTE-YY         PIC X(02).                  00980099
008300         10 FILLER                    PIC X(01).                  00990099
008400         10 PV-TRN-SLS-DTE-MM         PIC X(02).                  01000099
008500         10 FILLER                    PIC X(01).                  01010099
008600         10 PV-TRN-SLS-DTE-DD         PIC X(02).                  01020099
008700     05  PV-TRN-SLS-DTE-FMT.                                      01030099
008800         10 PV-TRN-SLS-DTE-FMT-MM     PIC 9(02).                  01040099
008900         10 PV-TRN-SLS-DTE-FMT-DD     PIC 9(02).                  01050099
009000         10 PV-TRN-SLS-DTE-FMT-YY     PIC 9(02).                  01060099
009100     05  PV-TRN-TIME.                                             01070099
009200         10 PV-TRN-TIME-HH            PIC X(02).                  01080099
009300         10 FILLER                    PIC X(01).                  01090099
009400         10 PV-TRN-TIME-MM            PIC X(02).                  01100099
009500         10 FILLER                    PIC X(01).                  01110099
009600         10 PV-TRN-TIME-SS            PIC X(02).                  01120099
009700     05  PV-TRN-TIME-NUM.                                         01130099
009800         10 FILLER                    PIC 9(01)     VALUE ZEROS.  01140099
009900         10 PV-TRN-TIME-NUM-HH        PIC 9(02)     VALUE ZEROS.  01150099
010000         10 PV-TRN-TIME-NUM-MM        PIC 9(02)     VALUE ZEROS.  01160099
010100     05  PV-TRN-TIME-NUM-FMT  REDEFINES                           01170099
010200         PV-TRN-TIME-NUM              PIC 9(03)V99.               01180099
010300                                                                  01190099
010400     05  PV-TRN-TIME-FOR-FILE         PIC S9(03)V99 VALUE ZEROS   01200099
010500                                                    COMP-3.       01210099
C10237     05  PV-ACCT-LEN                  PIC  9(09)   VALUE ZEROES.  01211099
010600 01  PV-DATE-AND-TIME-FIELDS.                                     01220099
010700     05  PV-POS-CCYY-MM-DD           PIC X(10)     VALUE SPACE.   01230099
010800     05  FILLER REDEFINES PV-POS-CCYY-MM-DD.                      01240099
010900         10  PV-POS-CCYY             PIC X(04).                   01250099
011000         10  FILLER                  PIC X(01).                   01260099
011100         10  PV-POS-MM               PIC X(02).                   01270099
011200         10  FILLER                  PIC X(01).                   01280099
011300         10  PV-POS-DD               PIC X(02).                   01290099
011400                                                                  01300099
011500     05  PV-POS-DATE-FORMATTED.                                   01310099
011600         10  PV-POS-DATE-FRMT-MM     PIC X(02).                   01320099
011700         10  FILLER                  PIC X(01)     VALUE '/'.     01330099
011800         10  PV-POS-DATE-FRMT-DD     PIC X(02).                   01340099
011900         10  FILLER                  PIC X(01)     VALUE '/'.     01350099
012000         10  PV-POS-DATE-FRMT-CCYY   PIC X(04).                   01360099
012100                                                                  01370099
012200******************************************************************01380099
012300* PSRD003 OUTPUT GIFT CARD/CERTIFICATE EXTRACT RECORD             01390099
012400******************************************************************01400099
012500                                                                  01410099
012600     COPY PSRD003.                                                01420099
012700                                                                  01430099
012800***************************************************************** 01440099
012900*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             01450099
013000***************************************************************** 01460099
013100     COPY DPWS500.                                                01470099
013200                                                                  01480099
013300***************************************************************** 01490099
013400* SVWS004 STORED VALUE CARD CONTENTS                              01500099
013500***************************************************************** 01510099
013600                                                                  01520099
013700     COPY SVWS004.                                                01530099
013800                                                                  01540099
P10237***************************************************************** 01550099
P10237* LAYOUT THAT DEFINES THE PARAMETERS NEEDED TO INVOKE PROTEGRITY  01560099
P10237* MODULE                                                          01570099
P10237******************************************************************01580099
P10237     COPY PTYCCSIP.                                               01590099
P10237                                                                  01600099
P10237******************************************************************01610099
P10237* LAYOUT THAT DEFINES THE WORKING VARIABLES TO INVOKE PROTEGRITY  01620099
P10237* MODULE                                                          01630099
P10237******************************************************************01640099
P10237     COPY DPWS031.                                                01650099
P10237                                                                  01660099
013900***********************************************************       01670099
014000*    PC-PROGRAM CONSTANTS                                 *       01680099
014100***********************************************************       01690099
014200 01  PC-PROGRAM-CONSTANTS.                                        01700099
014300     05  PC-PROGRAM-NAME                 PIC  X(08)               01710099
014400                                              VALUE 'PSKUT080'.   01720099
014500     05  PC-ROW-NOT-FOUND                PIC S9(04)               01730099
014600                                              VALUE +100          01740099
014700                                              COMP SYNC.          01750099
014800                                                                  01760099
268841     05  PC-SEPH-GIFT-CARD-DEPTCL      PIC X(03) VALUE '712'.     01770099
014900     05  PC-GIFT-CERT-DEPTCL           PIC X(03) VALUE '981'.     01771099
015000     05  PC-GIFT-CARD-DEPTCL           PIC X(03) VALUE '983'.     01780099
015100     05  PC-LATE-TRANS                 PIC X(01) VALUE 'L'.       01790099
015200     05  PC-SLS-CORR-TRANS             PIC X(01) VALUE 'V'.       01800099
015300     05  PC-SLS-CORR-RVSL              PIC X(01) VALUE 'R'.       01810099
015400                                                                  01820099
015500 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      01830099
015600                                                  COMP SYNC.      01840099
015700     88  AC-CONTROL-CARD-ERROR                    VALUE +4003.    01850099
015800     88  AC-DB2-ERROR                             VALUE +4013.    01860099
015900     88  AC-CALENDAR-ROUTINE-ERROR                VALUE +4019.    01870099
016000                                                                  01880099
P10237 01  ABEND-CODE                        PIC S9(04) VALUE ZERO      01881099
P10237                                                  COMP SYNC.      01882099
016100                                                                  01890099
016200 01  PS-SWITCHES.                                                 01900099
016300                                                                  01910099
016400     05  PS-END-OF-CARD-FILE-SW        PIC X(01)  VALUE 'N'.      01920099
016500         88  PS-END-OF-CARD-FILE                  VALUE 'Y'.      01930099
016600     05  PS-END-OF-ITEM-CSR-SW         PIC X(01)  VALUE 'N'.      01940099
016700         88  PS-END-OF-ITEM-CSR                   VALUE 'Y'.      01950099
016800     05  PS-END-OF-TENDER-CSR-SW       PIC X(01)  VALUE 'N'.      01960099
016900         88  PS-END-OF-TENDER-CSR                 VALUE 'Y'.      01970099
017000                                                                  01980099
017100******************************************************************01990099
017200* RECORD LAYOUT FOR INPUT DATE CARD (POS DATE)                    02000099
017300******************************************************************02010099
017400 01  CC-CONTROL-CARD.                                             02020099
017500     05  CC-CONTROL-CARD-DISPLAY.                                 02030099
017600         10  CC-CONTROL-NAME     PIC X(14)   VALUE SPACE.         02040099
017700             88  CC-VALID-CONTROL-NAME       VALUE                02050099
017800                                 'P.O.S. DATE = '.                02060099
017900         10  CC-POS-DATE-MMDDYY  PIC 9(6)    VALUE ZERO.          02070099
018000         10  FILLER REDEFINES CC-POS-DATE-MMDDYY.                 02080099
018100             15  CC-POS-DATE-MM  PIC 99.                          02090099
018200             15  CC-POS-DATE-DD  PIC 99.                          02100099
018300             15  CC-POS-DATE-YY  PIC 99.                          02110099
018400     05 FILLER                   PIC X(60)   VALUE SPACE.         02120099
018500***********************************************************       02130099
018600* COSA PARTITION TABLE                                    *       02140099
018700***********************************************************       02150099
018800     EXEC SQL                                                     02160099
018900         INCLUDE TEPPART                                          02170099
019000     END-EXEC.                                                    02180099
019100                                                                  02190099
019200***********************************************************       02200099
019300* COSA DKEY TABLE                                         *       02210099
019400***********************************************************       02220099
019500     EXEC SQL                                                     02230099
019600         INCLUDE TEPDKEY                                          02240099
019700     END-EXEC.                                                    02250099
019800                                                                  02260099
019900***********************************************************       02270099
020000* COSA TRANSACTION TABLE                                  *       02280099
020100***********************************************************       02290099
020200     EXEC SQL                                                     02300099
020300         INCLUDE TEPTRN                                           02310099
020400     END-EXEC.                                                    02320099
020500                                                                  02330099
020600***********************************************************       02340099
020700* COSA ITEM TABLE                                         *       02350099
020800***********************************************************       02360099
020900     EXEC SQL                                                     02370099
021000         INCLUDE TEPITM                                           02380099
021100     END-EXEC.                                                    02390099
021200                                                                  02400099
021300***********************************************************       02410099
021400* COSA TENDER TABLE                                       *       02420099
021500***********************************************************       02430099
021600     EXEC SQL                                                     02440099
021700         INCLUDE TEPTND                                           02450099
021800     END-EXEC.                                                    02460099
021900                                                                  02470099
022000***********************************************************       02480099
022100*  SVT_CRD_PROD TABLE                                     *       02490099
022200***********************************************************       02500099
022300     EXEC SQL                                                     02510099
022400         INCLUDE SVT00000                                         02520099
022500     END-EXEC.                                                    02530099
022600                                                                  02540099
022700***********************************************************       02550099
022800*  SVT_KOHLS_CRD_ACCT TABLE                               *       02560099
022900***********************************************************       02570099
023000     EXEC SQL                                                     02580099
023100         INCLUDE SVT00001                                         02590099
023200     END-EXEC.                                                    02600099
023300                                                                  02610099
023400***********************************************************       02620099
      *  DB2 TABLE XST_LOC - STORE LOCATION TABLE                       02630099
023600***********************************************************       02640099
           EXEC SQL                                                     02650099
              INCLUDE XST00001                                          02660099
           END-EXEC.                                                    02670099
023400***********************************************************       02680099
024100***********************************************************       02690099
024200* ITEM PROCESS CURSOR                                     *       02700099
024300***********************************************************       02710099
024400     EXEC SQL                                                     02720099
024500                                                                  02730099
024600       DECLARE ITEM-CSR CURSOR FOR                                02740099
024700                                                                  02750099
024800         SELECT TRN.STR_NBR                                       02760099
024900               ,TRN.RGST_ID                                       02770099
025000               ,TRN.TRN_NBR                                       02780099
025100               ,TRN.STRT_TM                                       02790099
025200               ,TRN.TRN_STAT_CDE                                  02800099
025300               ,TRN.TRN_TYP_CDE                                   02810099
025400               ,TRN.SLS_DTE                                       02820099
025500               ,TRN.QUAL_CDE                                      02830099
025600               ,TRN.ASSOC_ID                                      02840099
025700               ,ITM.DEPT_NBR                                      02850099
025800               ,ITM.SLD_QTY                                       02860099
025900               ,ITM.NET_CHRGD_AMT                                 02870099
026000               ,ITM.MDSE_ID                                       02880099
FL0902               ,ITM.MDSE_ID_LEN_NBR                               02890099
026100               ,STR.LOC_NBR                                       02900099
026200                                                                  02910099
026300         FROM TEPTRN TRN                                          02920099
026400             ,TEPITM ITM                                          02930099
026500             ,TEPPART PRT                                         02940099
026600             ,XST_LOC STR                                         02950099
026700                                                                  02960099
026800              WHERE PRT.PARTN_NBR = :PV-CURRENT-DAY-PARTN         02970099
026900                AND   PRT.DB_STRUC_CDE = 'O'                      02980099
027000                AND   PRT.PARTN_NBR = TRN.PARTN_NBR               02990099
027100                AND   TRN.PARTN_NBR = ITM.PARTN_NBR               03000099
027200                AND   TRN.STR_NBR = ITM.STR_NBR                   03010099
027300                AND   TRN.RGST_ID = ITM.RGST_ID                   03020099
027400                AND   TRN.TRN_NBR = ITM.TRN_NBR                   03030099
027500                AND   TRN.STRT_TM = ITM.STRT_TM                   03040099
027600                AND   TRN.SLS_CORR_SEQ_NBR = ITM.SLS_CORR_SEQ_NBR 03050099
027700                AND   ITM.LIV_RSLU_CDE IN     ('+', '-')          03060099
027800                AND   TRN.TRN_STAT_CDE = 'Z'                      03070099
027900                AND   TRN.VOID_ABRT_CDE = 'N'                     03080099
268841                AND   ITM.DEPT_NBR IN ('981', '983', '712')       03090099
028100                AND   ITM.NET_CHRGD_AMT <> 0                      03100099
028200                AND   TRN.STR_NBR = STR.LOC_NBR                   03110099
028213                                                                  03120099
028400     UNION ALL                                                    03130099
028500                                                                  03140099
028600         SELECT TRN.STR_NBR                                       03150099
028700               ,TRN.RGST_ID                                       03160099
028800               ,TRN.TRN_NBR                                       03170099
028900               ,TRN.STRT_TM                                       03180099
029000               ,TRN.TRN_STAT_CDE                                  03190099
029100               ,TRN.TRN_TYP_CDE                                   03200099
029200               ,TRN.SLS_DTE                                       03210099
029300               ,TRN.QUAL_CDE                                      03220099
029400               ,TRN.ASSOC_ID                                      03230099
029500               ,ITM.DEPT_NBR                                      03240099
029600               ,ITM.SLD_QTY                                       03250099
029700               ,ITM.NET_CHRGD_AMT                                 03260099
029800               ,ITM.MDSE_ID                                       03270099
FL0902               ,ITM.MDSE_ID_LEN_NBR                               03280099
029900               ,STR.LOC_NBR                                       03290099
030000                                                                  03300099
030100         FROM TEPDKEY DKY                                         03310099
030200             ,TEPTRN  TRN                                         03320099
030300             ,TEPPART PRT                                         03330099
030400             ,TEPITM  ITM                                         03340099
030500             ,XST_LOC STR                                         03350099
030600                                                                  03360099
030700            WHERE   DKY.PRCG_DTE         = :EPDKEY-PRCG-DTE       03370099
030800              AND   DKY.SLS_DTE          = PRT.SLS_DTE            03380099
030900              AND   TRN.PARTN_NBR        = PRT.PARTN_NBR          03390099
031000              AND   DKY.STR_NBR          = TRN.STR_NBR            03400099
031100              AND   DKY.RGST_ID        = TRN.RGST_ID              03410099
031200              AND   DKY.TRN_NBR        = TRN.TRN_NBR              03420099
031300              AND   DKY.STRT_TM        = TRN.STRT_TM              03430099
031400              AND   DKY.SLS_CORR_SEQ_NBR = TRN.SLS_CORR_SEQ_NBR   03440099
031500              AND   TRN.VOID_ABRT_CDE = 'N'                       03450099
031600              AND   TRN.TRN_STAT_CDE IN ('V','R','L')             03460099
031700                                                                  03470099
031800              AND   TRN.PARTN_NBR = ITM.PARTN_NBR                 03480099
031900              AND   TRN.STR_NBR = ITM.STR_NBR                     03490099
032000              AND   TRN.RGST_ID = ITM.RGST_ID                     03500099
032100              AND   TRN.TRN_NBR = ITM.TRN_NBR                     03510099
032200              AND   TRN.STRT_TM = ITM.STRT_TM                     03520099
032300              AND   TRN.SLS_CORR_SEQ_NBR = ITM.SLS_CORR_SEQ_NBR   03530099
273953              AND   ITM.DEPT_NBR IN ('981', '983', '712')         03541099
032500              AND   ITM.NET_CHRGD_AMT <> 0                        03550099
032600              AND   TRN.STR_NBR = STR.LOC_NBR                     03560099
032700                                                                  03570099
032800                ORDER BY 7, 1, 2, 3                               03580099
032900                                                                  03590099
033000         FOR FETCH ONLY                                           03600099
033100         WITH UR                                                  03610099
033200     END-EXEC.                                                    03620099
033300                                                                  03630099
033400***********************************************************       03640099
033500* TENDER PROCESS CURSOR                                   *       03650099
033600*  MAY NEED TO ADD TND ERR IND EXCLUSION                  *       03660099
033700***********************************************************       03670099
033800                                                                  03680099
033900     EXEC SQL                                                     03690099
034000                                                                  03700099
034100       DECLARE TENDER-CSR CURSOR FOR                              03710099
034200                                                                  03720099
034300         SELECT TRN.STR_NBR                                       03730099
034400               ,TRN.RGST_ID                                       03740099
034500               ,TRN.TRN_NBR                                       03750099
034600               ,TRN.STRT_TM                                       03760099
034700               ,TRN.TRN_STAT_CDE                                  03770099
034800               ,TRN.TRN_TYP_CDE                                   03780099
034900               ,TRN.SLS_DTE                                       03790099
035000               ,TRN.QUAL_CDE                                      03800099
035100               ,TRN.ASSOC_ID                                      03810099
035200               ,TND.TNDR_ID                                       03820099
035300               ,TND.TNDR_AMT                                      03830099
268841               ,TND.TNDR_ID_SRC_CDE                               03831099
035400               ,TND.TNDR_ID_LEN_NBR                               03840099
035500               ,STR.LOC_NBR                                       03850099
035600                                                                  03860099
035700         FROM TEPTRN TRN                                          03870099
035800             ,TEPTND TND                                          03880099
035900             ,TEPPART PRT                                         03890099
036000             ,XST_LOC STR                                         03900099
036100                                                                  03910099
036200              WHERE PRT.PARTN_NBR = :PV-CURRENT-DAY-PARTN         03920099
036300                AND   PRT.DB_STRUC_CDE = 'O'                      03930099
036400                AND   PRT.PARTN_NBR = TRN.PARTN_NBR               03940099
036500                AND   TRN.PARTN_NBR = TND.PARTN_NBR               03950099
036600                AND   TRN.STR_NBR = TND.STR_NBR                   03960099
036700                AND   TRN.RGST_ID = TND.RGST_ID                   03970099
036800                AND   TRN.TRN_NBR = TND.TRN_NBR                   03980099
036900                AND   TRN.STRT_TM = TND.STRT_TM                   03990099
037000                AND   TRN.SLS_CORR_SEQ_NBR = TND.SLS_CORR_SEQ_NBR 04000099
037100                AND   TND.TNDR_VOID_IND  ='N'                     04010099
037200                AND   TRN.TRN_STAT_CDE = 'Z'                      04020099
037300                AND   TRN.VOID_ABRT_CDE = 'N'                     04030099
037400                AND   TND.TNDR_TYP_CDE = '13'                     04040099
037600                AND   TRN.STR_NBR = STR.LOC_NBR                   04050099
037700                                                                  04060099
037800     UNION ALL                                                    04070099
037900                                                                  04080099
038000         SELECT TRN.STR_NBR                                       04090099
038100               ,TRN.RGST_ID                                       04100099
038200               ,TRN.TRN_NBR                                       04110099
038300               ,TRN.STRT_TM                                       04120099
038400               ,TRN.TRN_STAT_CDE                                  04130099
038500               ,TRN.TRN_TYP_CDE                                   04140099
038600               ,TRN.SLS_DTE                                       04150099
038700               ,TRN.QUAL_CDE                                      04160099
038800               ,TRN.ASSOC_ID                                      04170099
038900               ,TND.TNDR_ID                                       04180099
039000               ,TND.TNDR_AMT                                      04190099
039000               ,TND.TNDR_ID_SRC_CDE                               04191099
039100               ,TND.TNDR_ID_LEN_NBR                               04200099
039200               ,STR.LOC_NBR                                       04210099
039300                                                                  04220099
039400         FROM TEPDKEY DKY                                         04230099
039500             ,TEPTRN  TRN                                         04240099
039600             ,TEPPART PRT                                         04250099
039700             ,TEPTND  TND                                         04260099
039800             ,XST_LOC STR                                         04270099
039900                                                                  04280099
040000            WHERE   DKY.PRCG_DTE         = :EPDKEY-PRCG-DTE       04290099
040100              AND   DKY.SLS_DTE          = PRT.SLS_DTE            04300099
040200              AND   TRN.PARTN_NBR        = PRT.PARTN_NBR          04310099
040300              AND   DKY.STR_NBR          = TRN.STR_NBR            04320099
040400              AND   DKY.RGST_ID        = TRN.RGST_ID              04330099
040500              AND   DKY.TRN_NBR        = TRN.TRN_NBR              04340099
040600              AND   DKY.STRT_TM        = TRN.STRT_TM              04350099
040700              AND   DKY.SLS_CORR_SEQ_NBR = TRN.SLS_CORR_SEQ_NBR   04360099
040800              AND   TRN.VOID_ABRT_CDE = 'N'                       04370099
040900              AND   TRN.TRN_STAT_CDE IN ('V','R','L')             04380099
041000                                                                  04390099
041100              AND   TRN.PARTN_NBR = TND.PARTN_NBR                 04400099
041200              AND   TRN.STR_NBR = TND.STR_NBR                     04410099
041300              AND   TRN.RGST_ID = TND.RGST_ID                     04420099
041400              AND   TRN.TRN_NBR = TND.TRN_NBR                     04430099
041500              AND   TRN.STRT_TM = TND.STRT_TM                     04440099
041600              AND   TRN.SLS_CORR_SEQ_NBR = TND.SLS_CORR_SEQ_NBR   04450099
041700              AND   TND.TNDR_VOID_IND  ='N'                       04460099
041800              AND   TND.TNDR_TYP_CDE = '13'                       04470099
042000              AND   TRN.STR_NBR = STR.LOC_NBR                     04480099
042100                                                                  04490099
042200                ORDER BY 7, 1, 2, 3                               04500099
042300                                                                  04510099
042400         FOR FETCH ONLY                                           04520099
042500         WITH UR                                                  04530099
042600     END-EXEC.                                                    04540099
042700                                                                  04550099
042800* *********************************************************       04560099
042900* STANDARD LAYOUT FOR THE SQL COMMUNCATIONS AREA          *       04570099
043000***********************************************************       04580099
043100     EXEC SQL                                                     04590099
043200         INCLUDE SQLCA                                            04600099
043300     END-EXEC.                                                    04610099
043400                                                                  04620099
043500                                                                  04630099
043600***  ABEND ERROR MESSAGE WORKING STORAGE.                         04640099
043700     COPY DPWS004.                                                04650099
043800***  ABEND ERROR MESSAGE WORKING STORAGE.                         04660099
043900                                                                  04670099
044000***********************************************************       04680099
044100 PROCEDURE DIVISION.                                              04690099
044200***********************************************************       04700099
044300 0000-MAINLINE.                                                   04710099
044400                                                                  04720099
044500     PERFORM 1000-INITIALIZE.                                     04730099
044600     PERFORM 2000-ITEM-PROCESSING.                                04740099
044700     PERFORM 3000-TENDER-PROCESSING.                              04750099
044800                                                                  04760099
044900     CLOSE GIFT-EXTRACT-FILE.                                     04770099
045000                                                                  04780099
045100     GOBACK.                                                      04790099
045200                                                                  04800099
045300*0000-EXIT.                                                       04810099
045400 EJECT                                                            04820099
045500                                                                  04830099
045600***************************************************************** 04840099
045700* 1000-INITIALIZE                                                 04850099
045800*     OPENS FILES AND GETS THE CURRENT DAY PARTITION NUMBER       04860099
045900*     USING THE CONTROL CARD DATE.                                04870099
046000***************************************************************** 04880099
046100 1000-INITIALIZE.                                                 04890099
046200                                                                  04900099
046300     OPEN INPUT  POS-DATE-FILE                                    04910099
046400          OUTPUT GIFT-EXTRACT-FILE.                               04920099
046500                                                                  04930099
P10237     MOVE PC-PROGRAM-NAME                  TO DP031-PROGRAM-NAME. 04931099
P10237                                                                  04932099
046600     READ POS-DATE-FILE INTO CC-CONTROL-CARD                      04940099
046700        AT END                                                    04950099
046800           SET PS-END-OF-CARD-FILE TO TRUE.                       04960099
046900                                                                  04970099
047000     CLOSE POS-DATE-FILE.                                         04980099
047100                                                                  04990099
047200     IF PS-END-OF-CARD-FILE                                       05000099
047300         MOVE '1000-INITIALIZE'            TO PV-PARAGRAPH-NAME   05010099
047400         MOVE 'NO CONTROL CARD TO PROCESS' TO PV-OPERATION-MSG-1  05020099
047500         SET AC-CONTROL-CARD-ERROR TO TRUE                        05030099
047600         PERFORM 9999-ABEND                                       05040099
047700     END-IF.                                                      05050099
047800     DISPLAY PC-PROGRAM-NAME                                      05060099
047900             ' - CONTROL CARD = (' CC-CONTROL-CARD-DISPLAY  ')'.  05070099
048000                                                                  05080099
048100     PERFORM 1100-CONVERT-INPUT-DATE.                             05090099
048200                                                                  05100099
048300     PERFORM 1500-SLCT-CUR-DAY-PARTN.                             05110099
048400                                                                  05120099
048500***************************************************************** 05150099
048600* 1100-CONVERT-INPUT-DATE                                         05160099
048700*     CALL KOHLS CALENDAR ROUTINE:                                05170099
048800*         PASS: CONTROL CARD POS DATE (MMDDYY FORMAT).            05180099
048900*       RETURN: ACTUAL CALENDAR DB2 ISO DATE (CCYY-MM-DD FORMAT). 05190099
049000***************************************************************** 05200099
049100                                                                  05210099
049200 1100-CONVERT-INPUT-DATE.                                         05220099
049300                                                                  05230099
049400     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              05240099
049500                                                                  05250099
049600     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   05260099
049700     SET  DPG51-DO-NOT-INCR-DECR-DATE  TO TRUE.                   05270099
049800     SET  DPG52-LK-DTE-GREG            TO TRUE.                   05280099
049900     MOVE CC-POS-DATE-MMDDYY           TO DPG52-LK-DATE-INPUT.    05290099
050000     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    05300099
050100                                             DPG54 DPG55 DPG56.   05310099
050200     EVALUATE TRUE                                                05320099
050300         WHEN DPG54-SEVERE-ERROR                                  05330099
050400         WHEN DPG54-DATE-INVALID                                  05340099
050500             MOVE '1100-CONVERT-INPUT-DATE'                       05350099
050600                                   TO PV-PARAGRAPH-NAME           05360099
050700             MOVE 'ERROR CONVERTING INPUT CARD DATE'              05370099
050800                                   TO PV-OPERATION-MSG-1          05380099
050900             SET AC-CALENDAR-ROUTINE-ERROR                        05390099
051000                                   TO TRUE                        05400099
051100             MOVE DPG54-ERROR-MESSAGE                             05410099
051200                                   TO PV-OPERATION-MSG-2          05420099
051300             PERFORM 9999-ABEND                                   05430099
051400     END-EVALUATE.                                                05440099
051500                                                                  05450099
051600     MOVE DPG55-DB2-ISO-DATE-FMT   TO PV-POS-CCYY-MM-DD           05460099
051700                                      EPDKEY-PRCG-DTE.            05470099
051800                                                                  05480099
051900***************************************************************** 05490099
052000* 1500-SLCT-CUR-DAY-PARTN                                         05500099
052100*     FIND PARTITION NUMBER THAT CORRESPONDS WITH CONTROL CARD    05510099
052200*     DATE.                                                       05520099
052300***************************************************************** 05530099
052400 1500-SLCT-CUR-DAY-PARTN.                                         05540099
052500                                                                  05550099
052600     EXEC SQL                                                     05560099
052700          SELECT  PARTN_NBR                                       05570099
052800            INTO :PV-CURRENT-DAY-PARTN                            05580099
052900             FROM TEPPART                                         05590099
053000            WHERE SLS_DTE      = :EPDKEY-PRCG-DTE                 05600099
053100              AND DB_STRUC_CDE = 'O'                              05610099
053200              AND STR_GP_CDE = 'A'                                05620099
053300            WITH UR                                               05630099
053400     END-EXEC.                                                    05640099
053500                                                                  05650099
053600     IF NOT SQLCODE = ZERO                                        05660099
053700        DISPLAY 'SALES DATE= ' EPDKEY-PRCG-DTE                    05670099
053800        DISPLAY 'CUR DAY PARTN NOT FOUND!'                        05680099
053900        MOVE '1500-SLCT-CUR-DAY-PARTN' TO PV-PARAGRAPH-NAME       05690099
054000        MOVE SQLCODE                     TO PV-DB2-OPERATION      05700099
054100        DISPLAY 'SQLCODE= ' SQLCODE                               05710099
054200        PERFORM 9100-SQL-ABEND                                    05720099
054300     END-IF.                                                      05730099
054400                                                                  05740099
054500***********************************************************       05750099
054600* 2000-ITEM-PROCESSING.                                   *       05760099
054700* ==> THIS PROCESS WILL CREATE RECORDS FOR THE GIFT FILE  *       05770099
054800*     - FOR GIFT CARDS AND GIFT CERTIFICATES LISTED ON    *       05780099
054900*       THE ITEM TABLE.                                   *       05790099
055000***********************************************************       05800099
055100 2000-ITEM-PROCESSING.                                            05810099
055200                                                                  05820099
055300     PERFORM 2100-OPEN-ITEM-CURSOR.                               05830099
055400     PERFORM 2800-FETCH-ITEM-CURSOR.                              05840099
055500     PERFORM 2200-PROCESS-ITEMS UNTIL                             05850099
055600              PS-END-OF-ITEM-CSR.                                 05860099
055700     PERFORM 2900-CLOSE-ITEM-CURSOR.                              05870099
055800                                                                  05880099
055900***************************************************************** 05890099
056000* 2100-OPEN-ITEM-CURSOR.                                          05900099
056100*     OPEN THE ITEM CURSOR                                        05910099
056200***************************************************************** 05920099
056300 2100-OPEN-ITEM-CURSOR.                                           05930099
056400                                                                  05940099
056500     EXEC SQL                                                     05950099
056600          OPEN ITEM-CSR                                           05960099
056700     END-EXEC.                                                    05970099
056800                                                                  05980099
056900     EVALUATE TRUE                                                05990099
057000         WHEN SQLCODE = ZERO                                      06000099
057100              CONTINUE                                            06010099
057200         WHEN SQLWARN0 NOT EQUAL SPACE                            06020099
057300         WHEN SQLCODE NOT EQUAL ZERO                              06030099
057400             MOVE '2100-OPEN-ITEM-CURSOR'                         06040099
057500                                   TO PV-PARAGRAPH-NAME           06050099
057600             MOVE 'ERROR ON OPEN OF ITEM-CURSOR'                  06060099
057700                                   TO PV-DB2-OPERATION            06070099
057800             DISPLAY 'SQLCODE= ' SQLCODE                          06080099
057900             PERFORM 9100-SQL-ABEND                               06090099
058000     END-EVALUATE.                                                06100099
058100                                                                  06110099
058200***********************************************************       06120099
058300* 2200-PROCESS-ITEMS.                                     *       06130099
058400* ==> THIS SECTION WILL PROCESS THE ROW FETCHED FROM THE  *       06140099
058500*     ITEM CURSOR.  IT WILL DETERMINE IF THE ROW IS TIED  *       06150099
058600*     TO A GIFT CERTIFICATE OR A GIFT CARD AND PERFORM    *       06160099
058700*     THE APPROPRIATE STEPS.                              *       06170099
058800***********************************************************       06180099
058900 2200-PROCESS-ITEMS.                                              06190099
059000                                                                  06200099
059100     INITIALIZE PS003-GIFT-RECORD.                                06210099
059200     MOVE EPITM-MDSE-ID TO PV-MDSE-ID-NUM.                        06220099
059300                                                                  06230099
059400     IF EPITM-DEPT-NBR = PC-GIFT-CERT-DEPTCL                      06240099
059500        SET PS003-GIFT-CERT-TYPE TO TRUE                          06250099
059600        MOVE ZEROS TO PS003-ZERO-FILL                             06260099
FL0902        MOVE PV-MDSE-ID-NUM-CHAR(23:8) TO PS003-SKU-NBR           06270099
059800     ELSE                                                         06280099
273953*      SEPHORA GIFT CARD                                          06281199
268841       IF EPITM-DEPT-NBR = PC-SEPH-GIFT-CARD-DEPTCL               06281299
268841           SET PS003-SEPH-CARD-TYPE TO TRUE                       06281499
273953           MOVE PV-MDSE-ID-NUM-CHAR(19:12)                        06281599
273953                               TO PS003-GIFT-CARD-ID              06281699
059800       ELSE                                                       06285099
059900         SET PS003-GIFT-CARD-TYPE   TO TRUE                       06290099
060000**      FIX TO CORRECT GIFT CERTIFICATE REPORT ISSUE WHERE LAST   06300099
060001**      DIGIT WAS TRUNCATED.                                      06310099
060002**      IF EPITM-MDSE-ID = 98300000                               06320099
060010         IF EPITM-MDSE-ID  > 98299999 AND EPITM-MDSE-ID < 9840000006330099
FL0902***        12 DIGIT CARD                                          06331099
FL0902           MOVE '0000' TO PS003-ZERO-FILL                         06340099
FL0902           MOVE PV-MDSE-ID-NUM-CHAR(23:8)  TO PS003-SKU-NBR       06350099
060500         ELSE                                                     06360099
FL0902           IF EPITM-MDSE-ID-LEN-NBR > 16                          06370099
FL0902***        30 DIGIT CARD                                          06380099
FL0902              MOVE PV-MDSE-ID-NUM-CHAR(19:12)                     06390099
FL0902                              TO PS003-GIFT-CARD-ID               06400099
FL0902           ELSE                                                   06410099
FL0902***        13 DIGIT CARD                                          06420099
060510              MOVE '00'       TO PS003-GIFT-CARD-ID(1:2)          06430099
FL0902              MOVE PV-MDSE-ID-NUM-CHAR(20:10)                     06440099
060610                              TO PS003-GIFT-CARD-ID(3:10)         06450099
FL0902           END-IF                                                 06460099
060700         END-IF                                                   06470099
060700       END-IF                                                     06471099
060800     END-IF.                                                      06480099
060900                                                                  06490099
061000     MOVE ZEROS                TO PS003-STORE-NBR.                06500099
061100     MOVE XST00001-LOC-NBR     TO PS003-STORE-NBR.                06510099
061200     MOVE EPTRN-RGST-ID        TO PS003-TERMINAL.                 06520099
061300     MOVE EPTRN-TRN-NBR        TO PS003-TRANSACTION.              06530099
061400     MOVE EPTRN-ASSOC-ID       TO PS003-OPERATOR.                 06540099
061500     MOVE EPTRN-SLS-DTE        TO PV-TRN-SLS-DTE.                 06550099
061600     MOVE PV-TRN-SLS-DTE-MM    TO PV-TRN-SLS-DTE-FMT-MM.          06560099
061700     MOVE PV-TRN-SLS-DTE-DD    TO PV-TRN-SLS-DTE-FMT-DD.          06570099
061800     MOVE PV-TRN-SLS-DTE-YY    TO PV-TRN-SLS-DTE-FMT-YY.          06580099
061900     MOVE PV-TRN-SLS-DTE-FMT   TO PS003-GIFT-DATE.                06590099
062000     MOVE EPTRN-STRT-TM        TO PV-TRN-TIME.                    06600099
062100     MOVE PV-TRN-TIME-HH       TO PV-TRN-TIME-NUM-HH.             06610099
062200     MOVE PV-TRN-TIME-MM       TO PV-TRN-TIME-NUM-MM.             06620099
062300     MOVE PV-TRN-TIME-NUM-FMT  TO PS003-GIFT-TIME.                06630099
062400     MOVE EPITM-SLD-QTY        TO PS003-UNITS.                    06640099
062500     MOVE EPITM-NET-CHRGD-AMT  TO PS003-AMOUNT.                   06650099
062600     MOVE EPTRN-TRN-TYP-CDE    TO PS003-TRAN-TYPE.                06660099
062700                                                                  06670099
062800     IF EPTRN-TRN-STAT-CDE = PC-SLS-CORR-TRANS OR PC-SLS-CORR-RVSL06680099
062900        SET PS003-SALES-AUDIT-CORR TO TRUE                        06690099
063000     ELSE                                                         06700099
063100        IF EPTRN-TRN-STAT-CDE = PC-LATE-TRANS                     06710099
063200           SET PS003-SYSTEM-LATE-CORR TO TRUE                     06720099
063300        END-IF                                                    06730099
063400     END-IF.                                                      06740099
063500                                                                  06750099
063600     PERFORM 4000-WRITE-GIFT-FILE.                                06760099
063700                                                                  06770099
063800     PERFORM 2800-FETCH-ITEM-CURSOR.                              06780099
063900                                                                  06790099
064000***************************************************************** 06800099
064100* 2800-FETCH-ITEM-CURSOR                                          06810099
064200*     FETCH ROWS FROM THE ITEM CURSOR                             06820099
064300***************************************************************** 06830099
064400 2800-FETCH-ITEM-CURSOR.                                          06840099
064500                                                                  06850099
064600     EXEC SQL                                                     06860099
064700          FETCH ITEM-CSR                                          06870099
064800           INTO :EPTRN-STR-NBR                                    06880099
064900               ,:EPTRN-RGST-ID                                    06890099
065000               ,:EPTRN-TRN-NBR                                    06900099
065100               ,:EPTRN-STRT-TM                                    06910099
065200               ,:EPTRN-TRN-STAT-CDE                               06920099
065300               ,:EPTRN-TRN-TYP-CDE                                06930099
065400               ,:EPTRN-SLS-DTE                                    06940099
065500               ,:EPTRN-QUAL-CDE                                   06950099
065600               ,:EPTRN-ASSOC-ID                                   06960099
065700               ,:EPITM-DEPT-NBR                                   06970099
065800               ,:EPITM-SLD-QTY                                    06980099
065900               ,:EPITM-NET-CHRGD-AMT                              06990099
066000               ,:EPITM-MDSE-ID                                    07000099
FL0902               ,:EPITM-MDSE-ID-LEN-NBR                            07010099
066100               ,:XST00001-LOC-NBR                                 07020099
066200     END-EXEC.                                                    07030099
066300                                                                  07040099
066400     EVALUATE TRUE                                                07050099
066500         WHEN SQLCODE = ZERO                                      07060099
066600             ADD 1                 TO PV-ITEM-CSR-CNT             07070099
066700         WHEN SQLCODE = PC-ROW-NOT-FOUND                          07080099
066800             SET PS-END-OF-ITEM-CSR TO TRUE                       07090099
066900         WHEN SQLWARN0 NOT EQUAL SPACE                            07100099
067000         WHEN SQLCODE NOT EQUAL ZERO                              07110099
067100             MOVE '2800-FETCH-ITEM-CURSOR'                        07120099
067200                                   TO PV-PARAGRAPH-NAME           07130099
067300             MOVE 'ERROR ON FETCH OF ITEM CURSOR'                 07140099
067400                                   TO PV-DB2-OPERATION            07150099
067500             DISPLAY 'SQLCODE= ' SQLCODE                          07160099
067600             PERFORM 9100-SQL-ABEND                               07170099
067700     END-EVALUATE.                                                07180099
067800                                                                  07190099
067900***************************************************************** 07200099
068000* 2900-CLOSE-ITEM-CURSOR.                                         07210099
068100*                                                                 07220099
068200***************************************************************** 07230099
068300 2900-CLOSE-ITEM-CURSOR.                                          07240099
068400                                                                  07250099
068500     EXEC SQL                                                     07260099
068600          CLOSE ITEM-CSR                                          07270099
068700     END-EXEC.                                                    07280099
068800                                                                  07290099
068900     EVALUATE TRUE                                                07300099
069000         WHEN SQLCODE = ZERO                                      07310099
069100              CONTINUE                                            07320099
069200         WHEN SQLWARN0 NOT EQUAL SPACE                            07330099
069300         WHEN SQLCODE NOT EQUAL ZERO                              07340099
069400             MOVE '2900-CLOSE-ITEM-CURSOR'                        07350099
069500                                   TO PV-PARAGRAPH-NAME           07360099
069600             MOVE 'ERROR ON CLOSE OF ITEM CURSOR'                 07370099
069700                                   TO PV-DB2-OPERATION            07380099
069800             DISPLAY 'SQLCODE= ' SQLCODE                          07390099
069900             PERFORM 9100-SQL-ABEND                               07400099
070000     END-EVALUATE.                                                07410099
070100                                                                  07420099
070200***********************************************************       07430099
070300* 3000-TENDER-PROCESSING                                  *       07440099
070400* ==> THIS PROCESS WILL CREATE RECORDS FOR THE GIFT FILE  *       07450099
070500*     - FOR GIFT CARDS, KCK, AND GIFT CERTIFICATES        *       07460099
070600*       LISTED ON THE TENDER TABLE                        *       07470099
070700***********************************************************       07480099
070800 3000-TENDER-PROCESSING.                                          07490099
070900                                                                  07500099
071000     PERFORM 3100-OPEN-TENDER-CURSOR.                             07510099
071100     PERFORM 3800-FETCH-TENDER-CURSOR.                            07520099
071200     PERFORM 3200-PROCESS-TENDERS UNTIL                           07530099
071300              PS-END-OF-TENDER-CSR.                               07540099
071400     PERFORM 3900-CLOSE-TENDER-CURSOR.                            07550099
071500                                                                  07560099
071600***************************************************************** 07570099
071700* 3100-OPEN-TENDER-CURSOR.                                        07580099
071800*     OPEN THE TENDER CURSOR                                      07590099
071900***************************************************************** 07600099
072000 3100-OPEN-TENDER-CURSOR.                                         07610099
072100                                                                  07620099
072200     EXEC SQL                                                     07630099
072300          OPEN TENDER-CSR                                         07640099
072400     END-EXEC.                                                    07650099
072500                                                                  07660099
072600     EVALUATE TRUE                                                07670099
072700         WHEN SQLCODE = ZERO                                      07680099
072800              CONTINUE                                            07690099
072900         WHEN SQLWARN0 NOT EQUAL SPACE                            07700099
073000         WHEN SQLCODE NOT EQUAL ZERO                              07710099
073100             MOVE '3100-OPEN-TENDER-CURSOR'                       07720099
073200                                   TO PV-PARAGRAPH-NAME           07730099
073300             MOVE 'ERROR ON OPEN OF TENDER-CURSOR'                07740099
073400                                   TO PV-DB2-OPERATION            07750099
073500             DISPLAY 'SQLCODE= ' SQLCODE                          07760099
073600             PERFORM 9100-SQL-ABEND                               07770099
073700     END-EVALUATE.                                                07780099
073800                                                                  07790099
073900***********************************************************       07800099
074000* 3200-PROCESS-TENDERS.                                   *       07810099
074100*     THIS SECTION PROCESSES THE ROW FETCHED FROM THE     *       07820099
074200*     THENDER CURSOR.  IF THE ROW IS DETERMINED NOT TO    *       07830099
074300*     BE A GIFT CERTIFICATED SPECIAL SQL IS NEEDED TO     *       07840099
074400*     DETERMINE IF IT IS A KCK OR GIFT CARD.              *       07850099
074500***********************************************************       07860099
074600 3200-PROCESS-TENDERS.                                            07870099
074700                                                                  07880099
074800     INITIALIZE PS003-GIFT-RECORD                                 07890099
C10237                PV-ACCT-LEN                                       07890199
P10237                PV-GIFT-CARD-ID.                                  07891099
074900                                                                  07900099
P10237     IF EPTND-TNDR-ID = SPACES                                    07910099
P10237        CONTINUE                                                  07911099
P10237     ELSE                                                         07930099
C10237        INSPECT FUNCTION REVERSE(EPTND-TNDR-ID)                   07930299
C10237            TALLYING PV-ACCT-LEN FOR LEADING SPACES               07930399
C10237        COMPUTE PV-ACCT-LEN  = LENGTH OF EPTND-TNDR-ID            07930599
C10237                               - PV-ACCT-LEN                      07930699
C10237        EVALUATE TRUE                                             07933099
C10237          WHEN EPTND-TNDR-ID-LEN-NBR = 5                          07933199
C10237            IF PV-ACCT-LEN = 8                                    07933299
C10237               PERFORM 3300-DETOKENIZE-TNDR-ID                    07933599
C10237            END-IF                                                07933699
C10237          WHEN OTHER                                              07933799
C10237            PERFORM 3300-DETOKENIZE-TNDR-ID                       07933999
C10237        END-EVALUATE                                              07934099
P10237     END-IF.                                                      07950099
P10237                                                                  07960099
075000     IF EPTND-TNDR-ID-LEN-NBR = 5                                 07970099
075100*       HAVE GIFT CERTIFICATE                                     07980099
075200        SET PS003-GIFT-CERT-TYPE TO TRUE                          07990099
075300        MOVE ZEROS TO PS003-ZERO-FILL                             08000099
075400        MOVE '981' TO PS003-SKU-NBR(1:3)                          08010099
P10237*    FIRST THREE BYTES OF EPTND-TNDR-ID ARE ZEROES IN DETOKENIZED 08020099
P10237*    CARD NUMBER FOR 5 BYTE GIFT CARD# ALONE. SO DISCARDING       08030099
P10237*    FIRST THREE BYTES AND REMAINING 5 DIGITS ARE POPULATED       08040099
C10237        IF PV-ACCT-LEN = 8                                        08041099
P10237           MOVE EPTND-TNDR-ID(4:5) TO PS003-GIFT-CERT-NBR         08042099
C10237        ELSE                                                      08051099
C10237           MOVE EPTND-TNDR-ID(1:5) TO PS003-GIFT-CERT-NBR         08052099
C10237        END-IF                                                    08053099
075600     ELSE                                                         08060099
C10237        IF EPTND-TNDR-ID-LEN-NBR = 13 AND                         08070099
273953           EPTND-TNDR-ID-SRC-CDE NOT = '14'                       08080099
075700            MOVE EPTND-TNDR-ID(3:10) TO PV-GIFT-CARD-ID           08090099
075710        ELSE                                                      08100099
273953***         SEPHORA CARDS                                         08111099
273953            IF EPTND-TNDR-ID-SRC-CDE = '14'                       08111299
268841               SET PS003-SEPH-CARD-TYPE TO TRUE                   08111499
273953               COMPUTE PV-RESULT = EPTND-TNDR-ID-LEN-NBR - 11     08111599
273953               MOVE PV-RESULT TO PV-START                         08111699
273953               IF EPTND-TNDR-ID-LEN-NBR < 13                      08111999
273953                  MOVE EPTND-TNDR-ID(1:12) TO PV-GIFT-CARD-ID     08112399
273953               ELSE                                               08112599
273953                  MOVE EPTND-TNDR-ID(PV-START:12)                 08113599
273953                                      TO PV-GIFT-CARD-ID          08113699
273953               END-IF                                             08116099
FL0902            ELSE                                                  08130099
273953***         KOHLS CARDS                                           08131099
FL0902                IF EPTND-TNDR-ID-LEN-NBR = 19                     08140099
FL0902***                 LAST 19 (OF 30) DIGITS ENTERED IF HAND-KEYED  08150099
FL0902                    MOVE EPTND-TNDR-ID(8:12) TO PV-GIFT-CARD-ID   08160099
FL0902                ELSE                                              08170099
FL0902***                 30 DIGIT CARDS                                08180099
FL0902                    IF EPTND-TNDR-ID-LEN-NBR = 30                 08190099
FL0902                        MOVE EPTND-TNDR-ID(19:12)                 08200099
FL0902                                             TO PV-GIFT-CARD-ID   08210099
C10237                    ELSE                                          08211099
C10237***                 12 DIGIT CARDS                                08212099
C10237                        IF EPTND-TNDR-ID-LEN-NBR = 12             08212199
C10237                           MOVE EPTND-TNDR-ID(1:12)               08212299
C10237                                             TO PV-GIFT-CARD-ID   08212399
C10237                        END-IF                                    08213099
FL0902                    END-IF                                        08220099
FL0902                END-IF                                            08230099
FL0902            END-IF                                                08240099
075750        END-IF                                                    08250099
075760                                                                  08260099
075800        PERFORM 3250-DET-IF-KCK-OR-GIFTCRD                        08270099
075801                                                                  08280099
075810        IF PV-GIFT-CARD-ID = ZEROES                               08290099
075811           MOVE 'FF' TO PS003-GIFT-CARD-ID(1:2)                   08300099
075812           MOVE '00' TO PS003-GIFT-CARD-ID(3:2)                   08310099
075820           MOVE '98300000' TO PS003-GIFT-CARD-ID(5:8)             08320099
075830        ELSE                                                      08330099
075840           MOVE PV-GIFT-CARD-ID TO PS003-GIFT-CARD-ID             08340099
075850        END-IF                                                    08350099
075860                                                                  08360099
076400     END-IF.                                                      08370099
076500                                                                  08380099
076600     MOVE ZEROS                TO PS003-STORE-NBR.                08390099
076700     MOVE XST00001-LOC-NBR     TO PS003-STORE-NBR.                08400099
076800     MOVE EPTRN-RGST-ID        TO PS003-TERMINAL.                 08410099
076900     MOVE EPTRN-TRN-NBR        TO PS003-TRANSACTION.              08420099
077000     MOVE EPTRN-ASSOC-ID       TO PS003-OPERATOR.                 08430099
077100     MOVE EPTRN-SLS-DTE        TO PV-TRN-SLS-DTE.                 08440099
077200     MOVE PV-TRN-SLS-DTE-MM    TO PV-TRN-SLS-DTE-FMT-MM.          08450099
077300     MOVE PV-TRN-SLS-DTE-DD    TO PV-TRN-SLS-DTE-FMT-DD.          08460099
077400     MOVE PV-TRN-SLS-DTE-YY    TO PV-TRN-SLS-DTE-FMT-YY.          08470099
077500     MOVE PV-TRN-SLS-DTE-FMT   TO PS003-GIFT-DATE.                08480099
077600     MOVE EPTRN-STRT-TM        TO PV-TRN-TIME.                    08490099
077700     MOVE PV-TRN-TIME-HH       TO PV-TRN-TIME-NUM-HH.             08500099
077800     MOVE PV-TRN-TIME-MM       TO PV-TRN-TIME-NUM-MM.             08510099
077900     MOVE PV-TRN-TIME-NUM-FMT  TO PS003-GIFT-TIME.                08520099
078000     MOVE 1                    TO PS003-UNITS.                    08530099
078100     COMPUTE PS003-AMOUNT = (EPTND-TNDR-AMT * -1).                08540099
078200     MOVE EPTRN-TRN-TYP-CDE    TO PS003-TRAN-TYPE.                08550099
078300                                                                  08560099
078400     IF EPTRN-TRN-STAT-CDE = PC-SLS-CORR-TRANS OR PC-SLS-CORR-RVSL08570099
078500        SET PS003-SALES-AUDIT-CORR TO TRUE                        08580099
078600     ELSE                                                         08590099
078700        IF EPTRN-TRN-STAT-CDE = PC-LATE-TRANS                     08600099
078800           SET PS003-SYSTEM-LATE-CORR TO TRUE                     08610099
078900        END-IF                                                    08620099
079000     END-IF.                                                      08630099
079100                                                                  08640099
079200     PERFORM 4000-WRITE-GIFT-FILE.                                08650099
079300                                                                  08660099
079400     PERFORM 3800-FETCH-TENDER-CURSOR.                            08670099
079500                                                                  08680099
079600******************************************************************08690099
079700* 3250-DET-IF-KCK-OR-GIFTCRD                                      08700099
079800*     CHECKS TO SEE IF WE ARE WORKING WITH A KCK OR GIFT CARD     08710099
079900*                                                                 08720099
080000******************************************************************08730099
080100                                                                  08740099
080200 3250-DET-IF-KCK-OR-GIFTCRD.                                      08750099
080300                                                                  08760099
080400     EXEC SQL                                                     08770099
080500         SELECT  CRD_STK_TYP_ID                                   08780099
080600           INTO  :SVT00000-CRD-STK-TYP-ID                         08790099
080700           FROM  SVT_CRD_PROD C,                                  08800099
080800                 SVT_KOHLS_CRD_ACCT T                             08810099
080900          WHERE  T.CRD_NBR     = :PV-GIFT-CARD-ID                 08820099
081000            AND  T.CRD_PROD_YR = C.CRD_PROD_YR                    08830099
081100            AND  T.SHIPT_REQ_NBR = C.SHIPT_REQ_NBR                08840099
                WITH UR                                                 08850099
081200     END-EXEC.                                                    08860099
081300                                                                  08870099
081400     EVALUATE TRUE                                                08880099
081500         WHEN SQLCODE = +0                                        08890099
081600             IF SVT00000-CRD-STK-TYP-ID =                         08900099
081700                                      SV004-KOHLS-CARES-FOR-KIDS  08910099
081800                 SET PS003-KCK-CARD-TYPE TO TRUE                  08920099
081900             ELSE                                                 08930099
082000                 SET PS003-GIFT-CARD-TYPE TO TRUE                 08940099
082100             END-IF                                               08950099
082200         WHEN SQLCODE = +100                                      08960099
082300             SET PS003-GIFT-CARD-TYPE TO TRUE                     08970099
273953             IF EPTND-TNDR-ID-SRC-CDE = '14'                      08972099
268841                 SET PS003-SEPH-CARD-TYPE TO TRUE                 08973099
082100             END-IF                                               08974099
082400         WHEN OTHER                                               08980099
082500             MOVE '3250-DET-IF-KCK-OR-GIFTCRD    '                08990099
082600                               TO PV-PARAGRAPH-NAME               09000099
082700             MOVE 'ERROR DET IF KCK OR GC' TO PV-DB2-OPERATION    09010099
082800             DISPLAY 'SQLCODE= ' SQLCODE                          09020099
082900             PERFORM 9100-SQL-ABEND                               09030099
083000     END-EVALUATE.                                                09040099
083100                                                                  09050099
P10237***************************************************************** 09060099
P10237* 3300-DETOKENIZE-TNDR-ID.                                        09070099
P10237*      RETRIEVES DE-TOKENIZED VALUE FOR TNDR-ID FIELD             09080099
P10237***************************************************************** 09090099
P10237 3300-DETOKENIZE-TNDR-ID.                                         09100099
P10237                                                                  09110099
P10237     INITIALIZE CSI-PARAMETERS                                    09120099
P10237                DP031-PROTEG-PGM-PARAMETERS.                      09130099
P10237                                                                  09140099
P10237     SET CSI-DECRYPT-FUNCTION      TO TRUE.                       09150099
P10237     SET DP031-ACCTNBR             TO TRUE.                       09160099
P10237     MOVE 'TNDR_ID'                TO DP031-FIELD.                09170099
P10237     MOVE EPTND-TNDR-ID            TO DP031-CIPHER-TEXT.          09180099
C10237     IF EPTND-TNDR-ID-LEN-NBR = 5                                 09181099
P10237        MOVE PV-ACCT-LEN           TO DP031-INPUT-LEN             09182099
C10237     ELSE                                                         09190199
P10237        MOVE EPTND-TNDR-ID-LEN-NBR TO DP031-INPUT-LEN             09190299
C10237     END-IF.                                                      09192099
P10237     PERFORM DP031-0000-PROTG-TOKEN-DETOKEN.                      09200099
P10237     IF CSI-RETURN-CODE NOT = ZERO                                09210099
P10237        DISPLAY "ABEND IN THE FOLLOWING RECORD"                   09220099
P10237        DISPLAY "STORE NUMBER - " EPTRN-STR-NBR                   09230099
P10237        DISPLAY "REGISTER NO  - " EPTRN-RGST-ID                   09240099
P10237        DISPLAY "TRANSACTION  - " EPTRN-TRN-NBR                   09250099
P10237        DISPLAY "TNDR-ID      - " EPTND-TNDR-ID                   09260099
P10237        DISPLAY "TNDR-ID-LEN  - " EPTND-TNDR-ID-LEN-NBR           09270099
P10237        PERFORM DP031-9999-ABEND                                  09280099
P10237     ELSE                                                         09290099
P10237        MOVE DP031-CLEAR-TEXT         TO EPTND-TNDR-ID            09300099
P10237     END-IF.                                                      09301099
P10237                                                                  09310099
083200***************************************************************** 09320099
083300* 3800-FETCH-TENDER-CURSOR                                        09330099
083400*     FETCH ROWS FROM THE TENDER CURSOR                           09340099
083500***************************************************************** 09350099
083600 3800-FETCH-TENDER-CURSOR.                                        09360099
083700                                                                  09370099
083800     EXEC SQL                                                     09380099
083900          FETCH TENDER-CSR                                        09390099
084000           INTO :EPTRN-STR-NBR                                    09400099
084100               ,:EPTRN-RGST-ID                                    09410099
084200               ,:EPTRN-TRN-NBR                                    09420099
084300               ,:EPTRN-STRT-TM                                    09430099
084400               ,:EPTRN-TRN-STAT-CDE                               09440099
084500               ,:EPTRN-TRN-TYP-CDE                                09450099
084600               ,:EPTRN-SLS-DTE                                    09460099
084700               ,:EPTRN-QUAL-CDE                                   09470099
084800               ,:EPTRN-ASSOC-ID                                   09480099
084900               ,:EPTND-TNDR-ID                                    09490099
085000               ,:EPTND-TNDR-AMT                                   09500099
268841               ,:EPTND-TNDR-ID-SRC-CDE                            09501099
085100               ,:EPTND-TNDR-ID-LEN-NBR                            09510099
085200               ,:XST00001-LOC-NBR                                 09520099
085300     END-EXEC.                                                    09530099
085400                                                                  09540099
085500     EVALUATE TRUE                                                09550099
085600         WHEN SQLCODE = ZERO                                      09560099
085700             ADD 1                 TO PV-TENDER-CSR-CNT           09570099
085800         WHEN SQLCODE = PC-ROW-NOT-FOUND                          09580099
085900             SET PS-END-OF-TENDER-CSR TO TRUE                     09590099
086000         WHEN SQLWARN0 NOT EQUAL SPACE                            09600099
086100         WHEN SQLCODE NOT EQUAL ZERO                              09610099
086200             MOVE '3800-FETCH-TENDER-CURSOR'                      09620099
086300                                   TO PV-PARAGRAPH-NAME           09630099
086400             MOVE 'ERROR ON FETCH OF TENDER CURSOR'               09640099
086500                                   TO PV-DB2-OPERATION            09650099
086600             DISPLAY 'SQLCODE= ' SQLCODE                          09660099
086700             PERFORM 9100-SQL-ABEND                               09670099
086800     END-EVALUATE.                                                09680099
086900                                                                  09690099
087000***************************************************************** 09700099
087100* 3900-CLOSE-TENDER-CURSOR.                                       09710099
087200*                                                                 09720099
087300***************************************************************** 09730099
087400 3900-CLOSE-TENDER-CURSOR.                                        09740099
087500                                                                  09750099
087600     EXEC SQL                                                     09760099
087700          CLOSE TENDER-CSR                                        09770099
087800     END-EXEC.                                                    09780099
087900                                                                  09790099
088000     EVALUATE TRUE                                                09800099
088100         WHEN SQLCODE = ZERO                                      09810099
088200              CONTINUE                                            09820099
088300         WHEN SQLWARN0 NOT EQUAL SPACE                            09830099
088400         WHEN SQLCODE NOT EQUAL ZERO                              09840099
088500             MOVE '3900-CLOSE-TENDER-CURSOR'                      09850099
088600                                   TO PV-PARAGRAPH-NAME           09860099
088700             MOVE 'ERROR ON CLOSE OF TENDER CURSOR'               09870099
088800                                   TO PV-DB2-OPERATION            09880099
088900             DISPLAY 'SQLCODE= ' SQLCODE                          09890099
089000             PERFORM 9100-SQL-ABEND                               09900099
089100     END-EVALUATE.                                                09910099
089200                                                                  09920099
089300***********************************************************       09930099
089400* 4000-WRITE-GIFT-FILE.                                   *       09940099
089500*     WRITES OUT A RECORD TO THE GIFT FILE USING THE      *       09950099
089600*     LAYOUT IN PSRD003.                                  *       09960099
089700***********************************************************       09970099
089800 4000-WRITE-GIFT-FILE.                                            09980099
089900                                                                  09990099
090000     WRITE GIFT-EXTRACT-RECORD FROM                               10000099
090100        PS003-GIFT-RECORD.                                        10010099
090200                                                                  10020099
090300***************************************************************** 10030099
090400* 9100-SQL-ABEND                                                  10040099
090500*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.10050099
090600***************************************************************** 10060099
090700 9100-SQL-ABEND.                                                  10070099
090800     DISPLAY '** ABEND     **'.                                   10080099
090900     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                10090099
091000     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              10100099
091100     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               10110099
091200                                                                  10120099
091300******************************************************************10130099
091400* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     10140099
091500* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      10150099
091600******************************************************************10160099
091700     COPY DPPD004.                                                10170099
091800                                                                  10180099
091900     SET AC-DB2-ERROR TO TRUE.                                    10190099
092000     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         10200099
092100                                                                  10210099
092200                                                                  10220099
092300***************************************************************** 10230099
092400* 9999-ABEND                                                      10240099
092500*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  10250099
092600***************************************************************** 10260099
092700 9999-ABEND.                                                      10270099
092800     DISPLAY '** ABEND           **'.                             10280099
092900     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          10290099
093000     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        10300099
093100     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       10310099
093200     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       10320099
093300     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         10330099
P10237                                                                  10340099
P10237****************************************************************  10350099
P10237*      COPY MEMBER DPPD031 CONTAINS STATEMENTS NEEDED TO INVOKE   10360099
P10237*      PROTEGRITY MODULE FOR DETOKENIZATION                       10370099
P10237****************************************************************  10380099
P10237      COPY DPPD031.                                               10390099
P10237                                                                  10400099
P10237****************************************************************  10410099
