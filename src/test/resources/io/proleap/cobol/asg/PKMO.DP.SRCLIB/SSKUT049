000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400                                                                  00040000
000500 PROGRAM-ID.             SSKUT049.                                00050000
000600 AUTHOR.                 KOHLS.                                   00060000
000700 INSTALLATION.           KOHLS.                                   00070000
000800 DATE-WRITTEN            10-23-02.                                00080000
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100***************************************************************** 00110000
001200*                                                                 00120000
001300*  THIS PROGRAM CREATES A FILE CONTAINING LID COUNTS AT DIFFERENT 00130000
001400*  POINTS IN THE DAY.  THIS NEW FILE WILL BE USED TO CREATE       00140000
001500*  A REPORT HIGHLIGHTING WHERE LID'S HAVE BEEN TAKEN              00150000
001600*  MULTIPLE TIMES DURING A SPECIFIED TIME PERIOD OF THE DAY.      00160000
001700*  STORES WILL USE THIS INFORMATION TO FOLLOW UP ON POSSIBLE      00170000
001800*  INTERNAL FRAUD AND OTHER ISSUES CONNECTED WITH MULTIPLE        00180000
001900*  LID'S BEING TAKEN.                                             00190000
002000*                                                                 00200000
002100***************************************************************** 00210000
007100****************************************************************  00220000
007200*  CHANGED 11/08/04 BY JODY TAINTER                               00230000
007300*   REPLACED TSTR000 TABLE REFERENCE WITH THE XST_LOC_DIST TABLE  00240000
007400*   REFERENCE AS PART OF THE XS DOMAIN CONSTRAINTS PROJECT.       00250000
002200***************************************************************** 00260000
W30384*  CHANGES MADE:  ADD SLS-DATE, UNITS, & LID-DISCOUNT TO O/P FILE.00270000
W30384*          REPLACE HARDCODED FLE1- O/P FILE WITH COPYBOOK SSRD007.00271000
W30384*      BY  CAROLE MCCAMMON                     WR: 30384          00272000
W30384*  CHANGES MADE:  DELETE LOOKUP OF ASSOCIATE NAME. THE ASSOCIATE  00272100
W30384*          ID WILL BE USED IN THE REPORT.                         00272200
W30384*      BY  RICH KELLEN                         WR: 36397          00272300
W30384***************************************************************** 00272400
P53833*  CHANGES MADE: REMOVED THE SFS,BOPUS AND ECOMM TRANSACTIONS.    00272500
P53833*                MADE CHANGES TO THE QUERY                        00272600
P53833*      BY  COGNIZANT                           WR: CHG0117746     00272700
XXXXXX***************************************************************** 00272801
XXXXXX*  CHANGES MADE: REMOVED THE PROCESSING OF THE PAYROLL FILE       00272901
XXXXXX*                IN PREPARATION FOR PEOPLESOFT REPLACEMENT PROJEC 00273001
XXXXXX*      BY  JENNIFER ENDRIES                  WR: CHG0140068       00273106
002500***************************************************************** 00273201
002600 ENVIRONMENT DIVISION.                                            00273300
002700***************************************************************** 00273400
002800                                                                  00274000
002900 CONFIGURATION SECTION.                                           00275000
003000                                                                  00276000
003100 SOURCE-COMPUTER.        IBM-3090.                                00277000
003200                                                                  00278000
003300 OBJECT-COMPUTER.        IBM-3090.                                00279000
003400                                                                  00280000
003500 INPUT-OUTPUT SECTION.                                            00290000
003600                                                                  00300000
003700 FILE-CONTROL.                                                    00310000
003800                                                                  00320000
003900     SELECT POS-DATE-CARD-FILE                                    00330000
004000         ASSIGN TO INP01.                                         00340000
004100                                                                  00350000
004200     SELECT CONTROL-CARD-FILE                                     00360000
004300         ASSIGN TO INP02.                                         00370000
004400                                                                  00380000
004500     SELECT LAST-TIME-CARD-FILE                                   00390000
004600         ASSIGN TO INP03.                                         00400000
005000                                                                  00440000
005100     SELECT LINE-ITEM-DISC-FILE                                   00450000
005200         ASSIGN TO OUT01.                                         00460000
005300                                                                  00470000
005400     SELECT NEXT-TIME-CARD-FILE                                   00480000
005500         ASSIGN TO OUT02.                                         00490000
005600                                                                  00500000
005700 EJECT                                                            00510000
005800******************************************************************00520000
005900 DATA DIVISION.                                                   00530000
006000******************************************************************00540000
006100                                                                  00550000
006200 FILE SECTION.                                                    00560000
006300                                                                  00570000
006400 FD  POS-DATE-CARD-FILE                                           00580000
006500     RECORDING MODE IS F                                          00590000
006600     BLOCK CONTAINS 0 RECORDS                                     00600000
006700     LABEL RECORDS ARE STANDARD.                                  00610000
006800                                                                  00620000
006900 01  POS-DATE-CARD-RECORD            PIC X(80).                   00630000
007000                                                                  00640000
007100 FD  CONTROL-CARD-FILE                                            00650000
007200     RECORDING MODE IS F                                          00660000
007300     BLOCK CONTAINS 0 RECORDS                                     00670000
007400     LABEL RECORDS ARE STANDARD.                                  00680000
007500                                                                  00690000
007600 01  CONTROL-CARD-RECORD             PIC X(80).                   00700000
007700                                                                  00710000
007800 FD  LAST-TIME-CARD-FILE                                          00720000
007900     RECORDING MODE IS F                                          00730000
008000     BLOCK CONTAINS 0 RECORDS                                     00740000
008100     LABEL RECORDS ARE STANDARD.                                  00750000
008200                                                                  00760000
008300 01  LAST-TIME-CARD-RECORD           PIC X(80).                   00770000
008400                                                                  00780000
009400 FD  LINE-ITEM-DISC-FILE                                          00880000
009500     RECORDING MODE IS F                                          00890000
009600     BLOCK CONTAINS 0  RECORDS                                    00900000
009700     LABEL RECORDS ARE OMITTED                                    00910000
009800     DATA RECORD IS LINE-ITEM-DISC-RECORD.                        00920000
009900                                                                  00930000
010000 01  LINE-ITEM-DISC-RECORD           PIC  X(200).                 00940000
010100                                                                  00950000
010200 FD  NEXT-TIME-CARD-FILE                                          00960000
010300     RECORDING MODE IS F                                          00970000
010400     BLOCK CONTAINS 0  RECORDS                                    00980000
010500     LABEL RECORDS ARE OMITTED                                    00990000
010600     DATA RECORD IS NEXT-TIME-CARD-RECORD.                        01000000
010700                                                                  01010000
010800 01  NEXT-TIME-CARD-RECORD             PIC  X(80).                01020000
010900 EJECT                                                            01030000
011000******************************************************************01040000
011100 WORKING-STORAGE SECTION.                                         01050000
011200******************************************************************01060000
011300 01  FILLER                            PIC X(50)  VALUE           01070000
011400     ' *** WORKING STORAGE STARTS HERE FOR SSKUT049 *** '.        01080000
011500                                                                  01090000
011600******************************************************************01100000
011700* RECORD LAYOUT FOR INPUT DATE CARD                               01110000
011800******************************************************************01120000
011900 01  CC-DATE-CARD.                                                01130000
012000     05  CC-DATE                       PIC X(10).                 01140000
012100     05  FILLER                        PIC X(70) VALUE SPACES.    01150000
012200******************************************************************01160000
012300* RECORD LAYOUT FOR INPUT TIME CARD                               01170000
012400******************************************************************01180000
012500 01  CC-TIME-CARD.                                                01190000
012600     05  CC-TIME                       PIC X(08).                 01200000
012700     05  FILLER                        PIC X(72) VALUE SPACES.    01210000
012800******************************************************************01220000
012900* RECORD LAYOUT FOR INPUT CONTROL CARD                            01230000
013000******************************************************************01240000
013100                                                                  01250000
013200 01  CC-CONTROL-CARD.                                             01260000
013300     05  CC-CONTROL-CARD-DISPLAY.                                 01270000
013400         10  CC-MAXIMUM-RETAIL-AMOUNT  PIC 9(3)V99 VALUE ZERO.    01280000
013500     05  FILLER                        PIC X(75)   VALUE SPACES.  01290000
013600 EJECT                                                            01300000
013700 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      01310000
013800                                                  COMP SYNC.      01320000
013900     88  AC-CONTROL-CARD-ERROR                    VALUE +4003.    01330000
014000     88  AC-DB2-ERROR                             VALUE +4013.    01340000
014100                                                                  01350000
014900 01  PS-PROGRAM-SWITCHES.                                         01430000
015000     05  PS-END-OF-TEPLID-SW           PIC X(01)  VALUE 'N'.      01440000
015100         88  PS-END-OF-TEPLID                     VALUE 'Y'.      01450000
015200     05  PS-END-OF-CARD-FILE-SW        PIC X(01)  VALUE 'N'.      01460000
015300         88  PS-END-OF-CARD-FILE                  VALUE 'Y'.      01470000
015400     05  PS-END-OF-DATE-FILE-SW        PIC X(01)  VALUE 'N'.      01480000
015500         88  PS-END-OF-DATE-FILE                  VALUE 'Y'.      01490000
015600     05  PS-END-OF-TIME-FILE-SW        PIC X(01)  VALUE 'N'.      01500000
015700         88  PS-END-OF-TIME-FILE                  VALUE 'Y'.      01510000
015800     05  PS-DISTRICT-FOUND-SW          PIC X(01)  VALUE 'N'.      01520000
015900         88  PS-DISTRICT-FOUND                    VALUE 'Y'.      01530000
016000         88  PS-DISTRICT-NOT-FOUND                VALUE 'N'.      01540000
016100     05  PS-SKU-FOUND-SW               PIC X(01)  VALUE 'N'.      01550000
016200         88  PS-SKU-FOUND                         VALUE 'Y'.      01560000
016300         88  PS-SKU-NOT-FOUND                     VALUE 'N'.      01570000
016900                                                                  01630000
017000 01  PC-CONSTANTS.                                                01640000
017100     05  PC-ROW-NOT-FOUND              PIC S9(04) VALUE +100      01650000
017200                                                  COMP SYNC.      01660000
017300     05  PC-CURRENT-PROGRAM-NAME       PIC X(08)  VALUE           01670000
017400                                                 'SSKUT049'.      01680000
017500     05  PC-MAX-VALUE                  PIC  9(6)   VALUE 200000.  01690000
017600                                                                  01700000
017700 01  PV-MISC-FIELDS.                                              01710000
017800     05  PV-PARAGRAPH-NAME             PIC  X(30) VALUE SPACE.    01720000
017900     05  PV-OPERATION-MSG-1            PIC  X(40) VALUE SPACE.    01730000
018000     05  PV-OPERATION-MSG-2            PIC  X(40) VALUE SPACE.    01740000
018100     05  PV-DB2-OPERATION              PIC  X(30) VALUE SPACE.    01750000
018200     05  PV-PARM-DATE                  PIC  X(10).                01760000
018300     05  PV-PARM-CRE-START-TIME        PIC  X(26).                01770000
018400     05  PV-PARM-CRE-STAMP.                                       01780000
018500         10  PV-PARM-CRE-DATE.                                    01790000
018600           15  PV-POS-CCYY             PIC  X(04).                01800000
018700           15  PV-PARM-CRE-DASH1       PIC  X(01).                01810000
018800           15  PV-POS-MM               PIC  X(02).                01820000
018900           15  PV-PARM-CRE-DASH2       PIC  X(01).                01830000
019000           15  PV-POS-DD               PIC  X(02).                01840000
019100         10  PV-PARM-CRE-DASH3         PIC  X(01).                01850000
019200         10  PV-PARM-CRE-TIME.                                    01860000
019300           15  PV-PARM-CRE-HH          PIC  X(02).                01870000
019400           15  PV-PARM-CRE-DOT1        PIC  X(01).                01880000
019500           15  PV-PARM-CRE-MM          PIC  X(02).                01890000
019600           15  PV-PARM-CRE-DOT2        PIC  X(01).                01900000
019700           15  PV-PARM-CRE-SS          PIC  X(02).                01910000
019800         10  PV-PARM-CRE-DOT3          PIC  X(01).                01920000
019900         10  PV-PARM-CRE-SSCC          PIC  X(06).                01930000
020000     05  PV-PARM-START-TIME            PIC  X(08).                01940000
020100     05  PV-PARM-END-TIME              PIC  X(08).                01950000
020200     05  PV-PARM-END-TIME-BRK.                                    01960000
020300         10  PV-PARM-END-HH            PIC  X(02).                01970000
020400         10  PV-PARM-END-DOT1          PIC  X(01).                01980000
020500         10  PV-PARM-END-MM            PIC  X(02).                01990000
020600         10  PV-PARM-END-DOT2          PIC  X(01).                02000000
020700         10  PV-PARM-END-SS            PIC  X(02).                02010000
020800         10  PV-PARM-END-DOT3          PIC  X(01).                02020000
020900     05  PV-NEXT-START-TIME.                                      02030000
021000         10  PV-NEXT-STRT-TIME         PIC X(08).                 02040000
021100         10  FILLER                    PIC X(72)    VALUE SPACES. 02050000
021200     05  PV-MAXIMUM-RETAIL-AMOUNT      PIC S9(7)V99  VALUE ZERO   02060000
021300                                                   COMP-3.        02070000
021400     05  PV-MINIMUM-RETAIL-AMOUNT      PIC S9(7)V99  VALUE ZERO   02080000
021500                                                   COMP-3.        02090000
021600     05  PV-LID-PCT                    PIC 9(3)      VALUE ZERO.  02100000
021700     05  PV-LID-COUNT                  PIC S9(7)     VALUE ZERO   02110000
021800                                                   COMP-3.        02120000
W30384     05  PV-DISCOUNT-PCT               PIC 9(3)V99   VALUE ZERO.  02130002
                                                                        02140002
022400 01  PV-DATE-AND-TIME-FIELDS.                                     02190000
022500     05  PV-POS-CCYY-MM-DD             PIC X(10)     VALUE SPACE. 02200000
022600     05  FILLER REDEFINES PV-POS-CCYY-MM-DD.                      02210000
022700         10  PV-POS-CCYY               PIC X(04).                 02220000
022800         10  FILLER                    PIC X(01).                 02230000
022900         10  PV-POS-MM                 PIC X(02).                 02240000
023000         10  FILLER                    PIC X(01).                 02250000
023100         10  PV-POS-DD                 PIC X(02).                 02260000
023200     05  PV-CURR-DATE-CCYYMMDD.                                   02270000
023300         10  PV-CURR-DATE-CCYY         PIC 9(04).                 02280000
023400         10  PV-CURR-DATE-MM           PIC 9(02).                 02290000
023500         10  PV-CURR-DATE-DD           PIC 9(02).                 02300000
023600     05  PV-CURR-TIME.                                            02310000
023700         10  PV-CURR-TIME-HH           PIC 9(02)  VALUE ZERO.     02320000
023800         10  PV-CURR-TIME-MM           PIC 9(02)  VALUE ZERO.     02330000
023900         10  PV-CURR-TIME-SS           PIC 9(02)  VALUE ZERO.     02340000
024000         10  PV-CURR-TIME-SSHH         PIC 9(02)  VALUE ZERO.     02350000
024100                                                                  02360000
024200 EJECT                                                            02370000
W30384******************************************************************02380000
W30384*   LINE ITEM DISCOUNT FILE OUTPUT LAYOUT                         02390000
W30384******************************************************************02400000
W30384     COPY SSRD007.                                                02410000
026500 EJECT                                                            02420000
027100******************************************************************02480000
027200*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            02490000
027300******************************************************************02500000
027400     COPY DPWS004.                                                02510000
027500 EJECT                                                            02520000
027600******************************************************************02530000
027700*  DB2 COMMUNICATION AREA.                                        02540000
027800******************************************************************02550000
027900     EXEC SQL                                                     02560000
028000          INCLUDE SQLCA                                           02570000
028100     END-EXEC.                                                    02580000
028200 EJECT                                                            02590000
028300******************************************************************02600000
028400*  DB2 TABLE DB2PDBA.TEPLID  - LINE ITEM DISCOUNT TABLE           02610000
028500******************************************************************02620000
028600     EXEC SQL                                                     02630000
028700          INCLUDE TEPLID                                          02640000
028800     END-EXEC.                                                    02650000
028900 EJECT                                                            02660000
029000******************************************************************02670000
029100*  DB2 TABLE DB2PDBA.TEPTRN  - TRANSACTION TABLE                  02680000
029200******************************************************************02690000
029300     EXEC SQL                                                     02700000
029400          INCLUDE TEPTRN                                          02710000
029500     END-EXEC.                                                    02720000
029600 EJECT                                                            02730000
029700******************************************************************02740000
029800*  DB2 TABLE DB2PDBA.TEPITM  - ITEM TABLE                         02750000
029900******************************************************************02760000
030000     EXEC SQL                                                     02770000
030100          INCLUDE TEPITM                                          02780000
030200     END-EXEC.                                                    02790000
030300 EJECT                                                            02800000
030400******************************************************************02810000
030500*  DB2 TABLE DB2PDBA.TEPPART - PARTITION CONTROL TABLE            02820000
030600******************************************************************02830000
030700     EXEC SQL                                                     02840000
030800          INCLUDE TEPPART                                         02850000
030900     END-EXEC.                                                    02860000
031000 EJECT                                                            02870000
044600***************************************************************** 02880000
044700*  DB2 TABLE XST_LOC      -  LOCATION TABLE                       02890000
044800***************************************************************** 02900000
044900     EXEC SQL                                                     02910000
045000          INCLUDE XST00001                                        02920000
045100     END-EXEC.                                                    02930000
031700 EJECT                                                            02940000
044600***************************************************************** 02950000
044700*  DB2 TABLE XST_LOC_DIST - DISTRICT LOCATION TABLE               02960000
044800***************************************************************** 02970000
044900     EXEC SQL                                                     02980000
045000          INCLUDE XST00002                                        02990000
045100     END-EXEC.                                                    02991000
031700 EJECT                                                            02992000
031800******************************************************************02993000
031900*  DB2 TABLE DB2PDBA.XST00010 - SKU INFORMATION                   02994000
032000******************************************************************02995000
032100     EXEC SQL                                                     02996000
032200          INCLUDE XST00010                                        02997000
032300     END-EXEC.                                                    02998000
032400 EJECT                                                            02999000
032500******************************************************************03000000
032600*  CURSOR FOR FETCHING TEPLID                                     03010000
032700******************************************************************03020000
032800     EXEC SQL                                                     03030000
032900         DECLARE TEPLID-CURSOR CURSOR                             03040000
033000         FOR SELECT LID.STR_NBR                                   03050000
033100                   ,LID.RGST_ID                                   03060000
033200                   ,LID.TRN_NBR                                   03070000
033300                   ,LID.STRT_TM                                   03080000
033400                   ,LID.LID_AMT                                   03090000
033500                   ,LID.LID_PCT                                   03100000
033600                   ,LID.LID_RSN_CDE                               03110000
033700                   ,LID.LID_TYP_CDE                               03120000
033800                   ,TRN.TRN_TYP_CDE                               03130000
033900                   ,TRN.ASSOC_ID                                  03140000
034000                   ,ITM.SLD_QTY                                   03150000
034100                   ,ITM.CUST_CHRGD_AMT                            03160000
034200                   ,ITM.NET_CHRGD_AMT                             03170000
034300                   ,ITM.SKU_NBR                                   03180000
034400                   ,ITM.DEPT_NBR                                  03190000
034500                   ,ITM.SUB_CL_NBR                                03200000
034600                   ,ITM.UPC_NBR                                   03210000
W30384                   ,PRT.SLS_DTE                                   03220000
034700         FROM TEPLID  LID                                         03230000
034800             ,TEPTRN  TRN                                         03240000
034900             ,TEPITM  ITM                                         03250000
035000             ,TEPPART PRT                                         03260000
                   ,XST_LOC LOC                                         03270000
035100         WHERE PRT.SLS_DTE = :PV-PARM-DATE                        03280000
035200                                                                  03290000
035300           AND TRN.PARTN_NBR = PRT.PARTN_NBR                      03300000
035400*          AND TRN.STRT_TM >= :PV-PARM-START-TIME                 03310000
035500           AND TRN.CRE_TMST >= :PV-PARM-CRE-START-TIME            03320000
035600           AND TRN.TRN_STAT_CDE = 'Z'                             03330000
035700           AND TRN.VOID_ABRT_CDE = 'N'                            03340000
035800           AND TRN.SLS_CORR_SEQ_NBR = 0                           03350000
035900           AND TRN.TRN_TYP_CDE IN ('01', '02')                    03360000
P53833           AND TRN.OMNI_CHNL_FFLMT_TYP_CDE IS NULL                03370000
036200           AND ITM.PARTN_NBR = TRN.PARTN_NBR                      03380000
036300           AND ITM.STR_NBR = TRN.STR_NBR                          03390000
036400           AND ITM.RGST_ID = TRN.RGST_ID                          03400000
036500           AND ITM.TRN_NBR = TRN.TRN_NBR                          03410000
036600           AND ITM.STRT_TM = TRN.STRT_TM                          03420000
036700           AND ITM.SLS_CORR_SEQ_NBR = TRN.SLS_CORR_SEQ_NBR        03430000
036800           AND ITM.LIV_RSLU_CDE = '+'                             03440000
036900           AND (ITM.CUST_CHRGD_AMT > :PV-MAXIMUM-RETAIL-AMOUNT    03450000
037000            OR ITM.CUST_CHRGD_AMT < :PV-MINIMUM-RETAIL-AMOUNT)    03460000
037100                                                                  03470000
037200           AND LID.PARTN_NBR = ITM.PARTN_NBR                      03480000
037300           AND LID.STR_NBR = ITM.STR_NBR                          03490000
037400           AND LID.RGST_ID = ITM.RGST_ID                          03500000
037500           AND LID.TRN_NBR = ITM.TRN_NBR                          03510000
037600           AND LID.STRT_TM = ITM.STRT_TM                          03520000
037700           AND LID.SLS_CORR_SEQ_NBR = ITM.SLS_CORR_SEQ_NBR        03530000
037800           AND LID.LNE_ITM_SEQ_NBR = ITM.LNE_ITM_SEQ_NBR          03540000
037900           AND LID.LID_TYP_CDE IN ('P','D')                       03550000
038000           AND LID.LID_RSN_CDE IN ('701', '702', '703',           03560000
038100                    '705', '706', '707', '709')                   03570000
P53833           AND LOC.LOC_NBR = TRN.STR_NBR                          03580000
P53833           AND LOC.LOC_TYP_CDE = 'DS'                             03590000
P53833           AND LOC.E_BUS_IND   = 'N'                              03600000
038200                                                                  03610000
038300         ORDER BY LID.PARTN_NBR                                   03620000
038400                 ,LID.STR_NBR                                     03630000
038500                 ,LID.RGST_ID                                     03640000
038600                 ,LID.TRN_NBR                                     03650000
W30384                 ,PRT.SLS_DTE                                     03660000
038700                 ,LID.STRT_TM                                     03670000
038800                 ,LID.SLS_CORR_SEQ_NBR                            03680000
038900                 ,LID.LNE_ITM_SEQ_NBR                             03690000
039000                 ,LID.LID_SEQ_NBR                                 03700000
039100         WITH UR                                                  03710000
039200     END-EXEC.                                                    03720000
039300 EJECT                                                            03730000
039400 EJECT                                                            03740000
039500***************************************************************** 03750000
039600* PROCEDURE DIVISION.                                           * 03760000
039700***************************************************************** 03770000
039800 PROCEDURE DIVISION.                                              03780000
039900 EJECT                                                            03790000
040000******************************************************************03800000
040100* 0000-MAINLINE-PARAGRAPH                                         03810000
040200*      PRODUCE LINE ITEM DISCOUNT REPORT                          03820000
040300******************************************************************03830000
040400 0000-MAINLINE-PARAGRAPH.                                         03840000
040500                                                                  03850000
040600     PERFORM 1000-INITIALIZE-PROGRAM.                             03860000
040700                                                                  03870000
040800     PERFORM 8000-OPEN-TEPLID-CURSOR.                             03880000
040900                                                                  03890000
041000     PERFORM 8100-FETCH-TEPLID-CURSOR.                            03900000
041100                                                                  03910000
041200     PERFORM 2000-PROCESS-TEPLID                                  03920000
041300       UNTIL PS-END-OF-TEPLID.                                    03930000
041400                                                                  03940000
041500     PERFORM 8200-CLOSE-TEPLID-CURSOR.                            03950000
041600                                                                  03960000
041700     CLOSE LINE-ITEM-DISC-FILE.                                   03970001
041900                                                                  03990000
042000     DISPLAY 'LID RECORDS PROCESSED: ' PV-LID-COUNT.              04000000
042100                                                                  04010000
042200     GOBACK.                                                      04020000
042300                                                                  04030000
042400 EJECT                                                            04040000
042500******************************************************************04050000
042600* 1000-INITIALIZE-PROGRAM                                         04060000
042700*     OPEN FILES, PROCESS CONTROL CARD, FORMAT REPORT HEADINGS    04070000
042800******************************************************************04080000
042900                                                                  04090000
043000 1000-INITIALIZE-PROGRAM.                                         04100000
043100                                                                  04110000
043200     OPEN INPUT  POS-DATE-CARD-FILE                               04120000
043300                 CONTROL-CARD-FILE                                04130000
043500          OUTPUT LINE-ITEM-DISC-FILE.                             04150000
043600                                                                  04160000
043700     MOVE +0 TO PV-LID-COUNT.                                     04170000
043800                                                                  04180000
043900     PERFORM 1100-PROCESS-CONTROL-CARD.                           04190000
044000                                                                  04200000
044100     PERFORM 1300-PROCESS-DATE-CARD.                              04210000
044200                                                                  04220000
044300     PERFORM 1400-PROCESS-LAST-TIME-CARD.                         04230000
044400                                                                  04240000
044500     PERFORM 1450-PROCESS-NEXT-TIME-CARD.                         04250000
044600                                                                  04260000
044900     MOVE PV-PARM-CRE-STAMP TO PV-PARM-CRE-START-TIME.            04290000
045000     DISPLAY 'STARTING TIME STAMP: ' PV-PARM-CRE-START-TIME.      04300000
045100                                                                  04310000
045200 EJECT                                                            04320000
045300******************************************************************04330000
045400* 1100-PROCESS-CONTROL-CARD                                       04340000
045500*     READ CONTROL CARD TO GET POS DATE IN MMDDYY FORMAT.  CALL   04350000
045600*     DATE ROUTINE TO CONVERT DATE TO A CCYY-MM-DD PROCESS DATE.  04360000
045700******************************************************************04370000
045800                                                                  04380000
045900 1100-PROCESS-CONTROL-CARD.                                       04390000
046000                                                                  04400000
046100     PERFORM 1200-READ-CONTROL-CARD.                              04410000
046200                                                                  04420000
046300     IF PS-END-OF-CARD-FILE                                       04430000
046400         MOVE '1100-PROCESS-CONTROL-CARD'  TO PV-PARAGRAPH-NAME   04440000
046500         MOVE 'CONTROL CARD MISSING      ' TO PV-OPERATION-MSG-1  04450000
046600         SET AC-CONTROL-CARD-ERROR TO TRUE                        04460000
046700         PERFORM 9999-ABEND                                       04470000
046800     END-IF.                                                      04480000
046900                                                                  04490000
047000     DISPLAY PC-CURRENT-PROGRAM-NAME                              04500000
047100             ' - CONTROL CARD = (' CC-CONTROL-CARD-DISPLAY  ')'.  04510000
047200                                                                  04520000
047300     MOVE CC-MAXIMUM-RETAIL-AMOUNT TO PV-MAXIMUM-RETAIL-AMOUNT.   04530000
047400                                                                  04540000
047500     IF PV-MAXIMUM-RETAIL-AMOUNT NOT NUMERIC                      04550000
047600         MOVE '1100-PROCESS-CONTROL-CARD'  TO PV-PARAGRAPH-NAME   04560000
047700         MOVE 'NON-NUMERIC CONTROL CARD AMOUNT'                   04570000
047800                                           TO PV-OPERATION-MSG-1  04580000
047900         SET AC-CONTROL-CARD-ERROR TO TRUE                        04590000
048000         PERFORM 9999-ABEND                                       04600000
048100     END-IF                                                       04610000
048200                                                                  04620000
048300     COMPUTE PV-MINIMUM-RETAIL-AMOUNT = PV-MAXIMUM-RETAIL-AMOUNT  04630000
048400                                      * -1.                       04640000
048500 EJECT                                                            04650000
048600******************************************************************04660000
048700* 1200-READ-CONTROL-CARD                                          04670000
048800*     READ CONTROL CARD.                                          04680000
048900******************************************************************04690000
049000                                                                  04700000
049100 1200-READ-CONTROL-CARD.                                          04710000
049200                                                                  04720000
049300     READ CONTROL-CARD-FILE INTO CC-CONTROL-CARD                  04730000
049400        AT END                                                    04740000
049500           SET PS-END-OF-CARD-FILE TO TRUE.                       04750000
049600                                                                  04760000
049700     CLOSE CONTROL-CARD-FILE.                                     04770000
049800                                                                  04780000
049900******************************************************************04790000
050000* 1300-PROCESS-DATE-CARD                                          04800000
050100******************************************************************04810000
050200                                                                  04820000
050300 1300-PROCESS-DATE-CARD.                                          04830000
050400                                                                  04840000
050500     READ POS-DATE-CARD-FILE INTO CC-DATE-CARD                    04850000
050600         AT END                                                   04860000
050700             SET PS-END-OF-DATE-FILE TO TRUE.                     04870000
050800                                                                  04880000
050900     IF PS-END-OF-DATE-FILE                                       04890000
051000         MOVE '1300-PROCESS-DATE-CARD'  TO PV-PARAGRAPH-NAME      04900000
051100         MOVE 'DATE CARD MISSING      ' TO PV-OPERATION-MSG-1     04910000
051200         SET AC-CONTROL-CARD-ERROR TO TRUE                        04920000
051300         PERFORM 9999-ABEND                                       04930000
051400     END-IF.                                                      04940000
051500                                                                  04950000
051600     DISPLAY 'PROCESSING DATE ' CC-DATE.                          04960000
051700                                                                  04970000
051800     MOVE CC-DATE TO PV-PARM-DATE                                 04980000
051900                     PV-PARM-CRE-DATE.                            04990000
052000     MOVE '-' TO PV-PARM-CRE-DASH3.                               05000000
052100                                                                  05010000
052200 EJECT                                                            05020000
052300******************************************************************05030000
052400* 1400-PROCESS-LAST-TIME-CARD                                     05040000
052500******************************************************************05050000
052600                                                                  05060000
052700 1400-PROCESS-LAST-TIME-CARD.                                     05070000
052800                                                                  05080000
052900     OPEN INPUT LAST-TIME-CARD-FILE.                              05090000
053000                                                                  05100000
053100     READ LAST-TIME-CARD-FILE INTO CC-TIME-CARD                   05110000
053200         AT END                                                   05120000
053300             SET PS-END-OF-TIME-FILE TO TRUE.                     05130000
053400                                                                  05140000
053500     IF PS-END-OF-DATE-FILE                                       05150000
053600         MOVE '1400-PROCESS-LAST-TIME'  TO PV-PARAGRAPH-NAME      05160000
053700         MOVE 'TIME CARD MISSING      ' TO PV-OPERATION-MSG-1     05170000
053800         SET AC-CONTROL-CARD-ERROR TO TRUE                        05180000
053900         PERFORM 9999-ABEND                                       05190000
054000     END-IF.                                                      05200000
054100                                                                  05210000
054200     DISPLAY 'PROCESSING START TIME ' CC-TIME.                    05220000
054300                                                                  05230000
054400     MOVE CC-TIME TO PV-PARM-START-TIME                           05240000
054500                     PV-PARM-CRE-TIME.                            05250000
054600     MOVE '.' TO PV-PARM-CRE-DOT3.                                05260000
054700     MOVE '000000' TO  PV-PARM-CRE-SSCC.                          05270000
054800                                                                  05280000
054900     CLOSE LAST-TIME-CARD-FILE.                                   05290000
055000                                                                  05300000
055100 EJECT                                                            05310000
055200******************************************************************05320000
055300* 1450-PROCESS-NEXT-TIME-CARD                                     05330000
055400******************************************************************05340000
055500                                                                  05350000
055600 1450-PROCESS-NEXT-TIME-CARD.                                     05360000
055700                                                                  05370000
055800     ACCEPT PV-CURR-TIME FROM TIME.                               05380000
055900                                                                  05390000
056000     MOVE PV-CURR-TIME-HH TO PV-PARM-END-HH.                      05400000
056100     MOVE PV-CURR-TIME-MM TO PV-PARM-END-MM.                      05410000
056200     MOVE PV-CURR-TIME-SS TO PV-PARM-END-SS.                      05420000
056300                                                                  05430000
056400     MOVE '.' TO PV-PARM-END-DOT1.                                05440000
056500     MOVE '.' TO PV-PARM-END-DOT2.                                05450000
056600     MOVE '.' TO PV-PARM-END-DOT3.                                05460000
056700                                                                  05470000
056800     MOVE PV-PARM-END-TIME-BRK TO PV-PARM-END-TIME.               05480000
056900                                                                  05490000
057000     OPEN OUTPUT NEXT-TIME-CARD-FILE.                             05500000
057100                                                                  05510000
057200     MOVE PV-PARM-END-TIME TO PV-NEXT-STRT-TIME.                  05520000
057300                                                                  05530000
057400     DISPLAY 'PROCESSING NEXT TIME ' PV-NEXT-STRT-TIME.           05540000
057500                                                                  05550000
057600     WRITE NEXT-TIME-CARD-RECORD FROM PV-NEXT-START-TIME.         05560000
057700                                                                  05570000
057800     CLOSE NEXT-TIME-CARD-FILE.                                   05580000
057900                                                                  05590000
058000 EJECT                                                            05600000
060100******************************************************************05810000
060200* 2000-PROCESS-TEPLID.                                            05820000
060300*     PROCESS A TRANSACTION RECORD.                               05830000
060400******************************************************************05840000
060500 2000-PROCESS-TEPLID.                                             05850000
060600                                                                  05860000
060700     IF PS-END-OF-TEPLID-SW = 'N'                                 05870000
060800        PERFORM 2100-SELECT-DISTRICT-NUMBER                       05880003
              MOVE EPTRN-ASSOC-ID TO SS007-ASSOCIATE                    05890004
061000        PERFORM 2300-UPC-DESCRIPTION                              05900000
061100        PERFORM 2400-DETAIL                                       05910000
061200                                                                  05920000
061300        WRITE LINE-ITEM-DISC-RECORD                               05930000
W30384         FROM SS007-LINE-DETAIL                                   05940000
061500        ADD +1 TO PV-LID-COUNT                                    05950000
061600     END-IF.                                                      05960000
061700                                                                  05970000
061800     PERFORM 8100-FETCH-TEPLID-CURSOR.                            05980000
061900                                                                  05990000
062000******************************************************************06000000
062100 2100-SELECT-DISTRICT-NUMBER.                                     06010000
062200******************************************************************06020000
062300                                                                  06030000
062400     MOVE EPLID-STR-NBR             TO XST00002-LOC-NBR.          06040000
062500                                                                  06050000
062600     EXEC SQL                                                     06060000
062700          SELECT DIST_NBR                                         06070000
062800            INTO :XST00002-DIST-NBR                               06080000
062900            FROM XST_LOC_DIST                                     06090000
063000           WHERE LOC_NBR = :XST00002-LOC-NBR                      06100000
                  AND  BEG_DTE        <= :CC-DATE                       06110000
                  AND (END_DTE        >= :CC-DATE                       06120000
                   OR  END_DTE        IS NULL)                          06130000
063100     END-EXEC.                                                    06140000
063200                                                                  06150000
063300     EVALUATE SQLCODE                                             06160000
063400        WHEN ZERO                                                 06170000
063500           SET PS-DISTRICT-FOUND TO TRUE                          06180000
063600        WHEN PC-ROW-NOT-FOUND                                     06190000
063700           SET PS-DISTRICT-NOT-FOUND TO TRUE                      06200000
063800        WHEN OTHER                                                06210000
063900           MOVE '2100-SELECT-DISTRICT-N'  TO PV-PARAGRAPH-NAME    06220000
064000           MOVE SQLCODE                   TO PV-DB2-OPERATION     06230000
064100           PERFORM 9100-SQL-ABEND                                 06240000
064200     END-EVALUATE.                                                06250000
064300                                                                  06260000
064400 EJECT                                                            06270000
066400******************************************************************06490000
066500 2300-UPC-DESCRIPTION.                                            06500000
066600******************************************************************06510000
066700                                                                  06520000
066800     MOVE EPITM-SKU-NBR            TO XST00010-SKU-NBR.           06530000
067100                                                                  06540000
067200     EXEC SQL                                                     06550000
067300          SELECT SKU_DESC                                         06560000
067400            INTO :XST00010-SKU-DESC                               06570000
067500            FROM XST_SKU                                          06580000
067600           WHERE SKU_NBR = :XST00010-SKU-NBR                      06590000
067900     END-EXEC.                                                    06600000
068000                                                                  06610000
068100     EVALUATE SQLCODE                                             06620000
068200        WHEN ZERO                                                 06630000
068300           SET PS-SKU-FOUND TO TRUE                               06640000
068400        WHEN PC-ROW-NOT-FOUND                                     06650000
068500           SET PS-SKU-NOT-FOUND TO TRUE                           06660000
068600        WHEN OTHER                                                06670000
068700           MOVE '2300-UPC-DESCRIPTION'  TO PV-PARAGRAPH-NAME      06680000
068800           MOVE SQLCODE                   TO PV-DB2-OPERATION     06690000
068900           PERFORM 9100-SQL-ABEND                                 06700000
069000     END-EVALUATE.                                                06710000
069100                                                                  06720000
069200 EJECT                                                            06730000
069300******************************************************************06740000
069400* 2400-DETAIL                                                     06750000
069500*     GATHER DETAIL FOR QUALIFYING ITEMS                          06760000
069600******************************************************************06770000
069700 2400-DETAIL.                                                     06780000
069800                                                                  06790000
069900     IF PS-DISTRICT-FOUND-SW = 'Y'                                06800000
W30384        MOVE XST00002-DIST-NBR        TO SS007-DISTRICT           06810000
070100     ELSE                                                         06820000
W30384        MOVE 0000 TO SS007-DISTRICT                               06830000
070300     END-IF.                                                      06840000
070400                                                                  06850000
070500     IF PS-SKU-FOUND-SW = 'Y'                                     06860000
W30384        MOVE XST00010-SKU-DESC        TO SS007-UPC-DESC           06870000
070700     ELSE                                                         06880000
W30384        MOVE SPACES TO SS007-UPC-DESC                             06890000
070900     END-IF.                                                      06900000
071000                                                                  06910000
W30384     MOVE EPLID-STR-NBR            TO SS007-STORE.                06920000
W30384     MOVE EPLID-RGST-ID            TO SS007-TERM.                 06930000
W30384     MOVE EPLID-TRN-NBR            TO SS007-TRAN-NBR.             06940000
W30384     MOVE EPLID-STRT-TM            TO SS007-TIME.                 06950000
W30384     MOVE EPPART-SLS-DTE           TO SS007-DATE.                 06960000
W30384     MOVE +1                       TO SS007-UNITS.                06970000
W30384     MOVE 0                        TO SS007-TYP.                  06980000
W30384     MOVE EPLID-LID-AMT            TO SS007-DISCOUNT-AMT.         06990000
071600                                                                  07000000
071700     IF EPLID-LID-TYP-CDE = 'D'                                   07010000
W30384        MOVE ZERO TO SS007-DISCOUNT-PCT                           07020000
071900     ELSE                                                         07030000
072000        MULTIPLY EPLID-LID-PCT BY 100 GIVING PV-LID-PCT           07040000
W30384        MOVE PV-LID-PCT               TO SS007-DISCOUNT-PCT       07050000
072200     END-IF.                                                      07060000
072300                                                                  07070000
W30384     MOVE EPLID-LID-RSN-CDE        TO SS007-LID-REASON.           07080000
072500                                                                  07090000
W30384     MOVE EPITM-SKU-NBR            TO SS007-SKU.                  07100000
W30384     MOVE EPITM-DEPT-NBR           TO SS007-DEPT.                 07110000
W30384     MOVE EPITM-SUB-CL-NBR         TO SS007-SUBC.                 07120000
W30384     MOVE EPITM-UPC-NBR            TO SS007-UPC-NBR.              07130000
W30384     MOVE EPITM-CUST-CHRGD-AMT     TO SS007-SCANNED-PRICE.        07140000
W30384     MOVE EPITM-NET-CHRGD-AMT      TO SS007-NET-AMT.              07150000
073100                                                                  07160000
W30384     MOVE EPTRN-TRN-TYP-CDE        TO SS007-TRN-TYPE-CODE.        07170000
073300                                                                  07180000
W30384      IF SS007-SCANNED-PRICE > 0                                  07190000
W30384         COMPUTE PV-DISCOUNT-PCT =                                07200000
W30384                 SS007-DISCOUNT-AMT / SS007-SCANNED-PRICE         07210000
W30384         COMPUTE PV-DISCOUNT-PCT =                                07220000
W30384                 PV-DISCOUNT-PCT * 100                            07230000
W30384      ELSE                                                        07240000
W30384         MOVE +0                  TO PV-DISCOUNT-PCT              07250000
W30384      END-IF.                                                     07260000
W30384      MOVE PV-DISCOUNT-PCT        TO SS007-LID-DISCOUNT.          07270000
073400 EJECT                                                            07280000
076500******************************************************************07590000
076600* 8000-OPEN-TEPLID-CURSOR.                                        07600000
076700*     OPEN TEPLID CURSOR                                          07610000
076800******************************************************************07620000
076900 8000-OPEN-TEPLID-CURSOR.                                         07630000
077000                                                                  07640000
077100     EXEC SQL                                                     07650000
077200          OPEN TEPLID-CURSOR                                      07660000
077300     END-EXEC.                                                    07670000
077400                                                                  07680000
077500     EVALUATE TRUE                                                07690000
077600         WHEN SQLCODE = ZERO                                      07700000
077700              CONTINUE                                            07710000
077800         WHEN SQLWARN0 NOT EQUAL SPACE                            07720000
077900         WHEN SQLCODE NOT EQUAL ZERO                              07730000
078000             MOVE '8000-OPEN-TEPLID-CURSOR'                       07740000
078100                                            TO PV-PARAGRAPH-NAME  07750000
078200             MOVE 'ERROR ON OPEN OF TEPLID-CURSOR'                07760000
078300                                            TO PV-DB2-OPERATION   07770000
078400             PERFORM 9100-SQL-ABEND                               07780000
078500     END-EVALUATE.                                                07790000
078600                                                                  07800000
078700 EJECT                                                            07810000
078800******************************************************************07820000
078900* 8100-FETCH-TEPLID-CURSOR                                        07830000
079000******************************************************************07840000
079100 8100-FETCH-TEPLID-CURSOR.                                        07850000
079200                                                                  07860000
079300     EXEC SQL                                                     07870000
079400          FETCH TEPLID-CURSOR                                     07880000
079500           INTO :EPLID-STR-NBR                                    07890000
079600               ,:EPLID-RGST-ID                                    07900000
079700               ,:EPLID-TRN-NBR                                    07910000
079800               ,:EPLID-STRT-TM                                    07920000
079900               ,:EPLID-LID-AMT                                    07930000
080000               ,:EPLID-LID-PCT                                    07940000
080100               ,:EPLID-LID-RSN-CDE                                07950000
080200               ,:EPLID-LID-TYP-CDE                                07960000
080300               ,:EPTRN-TRN-TYP-CDE                                07970000
080400               ,:EPTRN-ASSOC-ID                                   07980000
080500               ,:EPITM-SLD-QTY                                    07990000
080600               ,:EPITM-CUST-CHRGD-AMT                             08000000
080700               ,:EPITM-NET-CHRGD-AMT                              08010000
080800               ,:EPITM-SKU-NBR                                    08020000
080900               ,:EPITM-DEPT-NBR                                   08030000
081000               ,:EPITM-SUB-CL-NBR                                 08040000
081100               ,:EPITM-UPC-NBR                                    08050000
W30384               ,:EPPART-SLS-DTE                                   08060000
081200     END-EXEC.                                                    08070000
081300                                                                  08080000
081400     EVALUATE TRUE                                                08090000
081500         WHEN SQLCODE = ZERO                                      08100000
081600             CONTINUE                                             08110000
081700         WHEN SQLCODE = PC-ROW-NOT-FOUND                          08120000
081800             SET PS-END-OF-TEPLID TO TRUE                         08130000
081900         WHEN SQLWARN0 NOT EQUAL SPACE                            08140000
082000         WHEN SQLCODE NOT EQUAL ZERO                              08150000
082100             MOVE '8100-FETCH-TEPLID-CURSOR'                      08160000
082200                                            TO PV-PARAGRAPH-NAME  08170000
082300             MOVE 'ERROR ON FETCH OF TEPLID-CURSOR'               08180000
082400                                            TO PV-DB2-OPERATION   08190000
082500             PERFORM 9100-SQL-ABEND                               08200000
082600     END-EVALUATE.                                                08210000
082700                                                                  08220000
082800 EJECT                                                            08230000
082900******************************************************************08240000
083000* 8200-CLOSE-TEPLID-CURSOR                                        08250000
083100******************************************************************08260000
083200 8200-CLOSE-TEPLID-CURSOR.                                        08270000
083300                                                                  08280000
083400     EXEC SQL                                                     08290000
083500          CLOSE TEPLID-CURSOR                                     08300000
083600     END-EXEC.                                                    08310000
083700                                                                  08320000
083800     EVALUATE TRUE                                                08330000
083900         WHEN SQLCODE = ZERO                                      08340000
084000              CONTINUE                                            08350000
084100         WHEN SQLWARN0 NOT EQUAL SPACE                            08360000
084200         WHEN SQLCODE NOT EQUAL ZERO                              08370000
084300             MOVE '8200-CLOSE-TEPLID-CURSOR'                      08380000
084400                                            TO PV-PARAGRAPH-NAME  08390000
084500             MOVE 'ERROR ON CLOSE OF TEPLID-CURSOR'               08400000
084600                                            TO PV-DB2-OPERATION   08410000
084700             PERFORM 9100-SQL-ABEND                               08420000
084800     END-EVALUATE.                                                08430000
084900 EJECT                                                            08440000
085000******************************************************************08450000
085100* 9100-SQL-ABEND                                                  08460000
085200*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.08470000
085300******************************************************************08480000
085400 9100-SQL-ABEND.                                                  08490000
085500     DISPLAY '** ABEND     **'.                                   08500000
085600     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        08510000
085700     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              08520000
085800     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               08530000
087000     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         08531005
085900                                                                  08540000
086000******************************************************************08550000
086100* 9999-ABEND                                                      08560000
086200*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  08570000
086300******************************************************************08580000
086400 9999-ABEND.                                                      08590000
086500     DISPLAY '** ABEND           **'.                             08600000
086600     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  08610000
086700     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        08620000
086800     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       08630000
086900     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       08640000
087000     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         08650000
