000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400                                                                  00040000
000500 PROGRAM-ID.             XSKUP071.                                00050000
000600 AUTHOR.                 KOHLS.                                   00060000
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070000
000800 DATE-WRITTEN            JULY 2003.                               00080000
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100***************************************************************** 00110000
001200*                                                                 00120000
001300*  THIS PROGRAM IS RESPONSIBLE FOR UPDATING THE POS_CAP_LVL_ID    00130000
001400*  FIELD ON THE XST_LOC_ATTR TABLE IN THE XS DOMAIN. IT USES A    00140000
001500*  CONTROL CARD THAT CONTAINS A STORE NUMBER ALONG WITH THE       00150000
001600*  NEW POS_CAP_LVL_ID THAT THE STORE WILL BE CHANGED TO.          00160000
002100*                                                                 00210000
002200*  THIS PROGRAM RUNS ON REQUEST AND WILL BE USED TO UPDATE STORES 00220000
002300*  AS THEY ARE BROUGHT ON TO THE NEW PROMO SYSTEM.                00230000
002700*                                                                 00270000
002800*                                                                 00280000
002900*   INPUT: INP01 - CONTROL CARD THAT CONTAINS STORE NUMBER AND    00290000
003000*                  THE NEW POS_CAP_LVL_ID.                        00300000
003800*   OUTPUT:OUT01 - CONTAINS ERROR RECORD(S).                      00380000
003900*                                                                 00390000
004000***************************************************************** 00400000
004100* HISTORY LOG:                                                    00410000
004200***************************************************************** 00420000
004300* DATE:                                                           00430000
004400* WR/IR#:                                                         00440000
004500* PROGRAMMER:                                                     00450000
004600* DESCRIPTION:                                                    00460000
004700*                                                                 00470000
004800***************************************************************** 00480000
004900 ENVIRONMENT DIVISION.                                            00490000
005000***************************************************************** 00500000
005100                                                                  00510000
005200 CONFIGURATION SECTION.                                           00520000
005300                                                                  00530000
005400 SOURCE-COMPUTER.        IBM-3090.                                00540000
005500 OBJECT-COMPUTER.        IBM-3090.                                00550000
005600                                                                  00560000
005700 INPUT-OUTPUT SECTION.                                            00570000
005800                                                                  00580000
005900 FILE-CONTROL.                                                    00590000
006000                                                                  00600000
006100     SELECT CONTROL-CARD-CONV-STORES                              00610000
006200         ASSIGN TO INP01.                                         00620000
006300                                                                  00630000
007300     SELECT ERROR-FILE                                            00730000
007400         ASSIGN TO OUT01.                                         00740000
007500                                                                  00750000
007600******************************************************************00760000
007700 DATA DIVISION.                                                   00770000
007800******************************************************************00780000
007900                                                                  00790000
008000 FILE SECTION.                                                    00800000
008100                                                                  00810000
008200 FD  CONTROL-CARD-CONV-STORES                                     00820000
008300     RECORDING MODE IS F                                          00830000
008400     BLOCK CONTAINS 0 RECORDS                                     00840000
008500     LABEL RECORDS ARE STANDARD.                                  00850000
008600                                                                  00860000
008700 01  CONTROL-CARD-STORE-RECORD        PIC X(80).                  00870000
008800                                                                  00880000
010800 FD  ERROR-FILE                                                   01080000
010900     RECORDING MODE IS F                                          01090000
011000     BLOCK CONTAINS 0  RECORDS.                                   01100000
011100                                                                  01110000
011200 01  ERROR-RECORD                     PIC  X(080).                01120001
011300                                                                  01130000
011400******************************************************************01140000
011500 WORKING-STORAGE SECTION.                                         01150000
011600******************************************************************01160000
011700                                                                  01170000
011800******************************************************************01180000
011900* INPUT CONTROL CARD 1 CONTAINS TOMORROWS DATE (SCHEDULED DATE +1)01190000
012000******************************************************************01200000
012100                                                                  01210000
012200 01  CC-CONTROL-CARD-1.                                           01220000
018300     10  PV-CONV-STORE                PIC 9(05)   VALUE 0.        01252001
018400     10  PV-POS-CAP-LVL-ID            PIC 9(05)   VALUE 0.        01253001
018500     10  PV-FILLER                    PIC X(70)   VALUE SPACES.   01254001
                                                                        01255000
013900 01  AC-ABEND-CODE                    PIC S9(04) VALUE ZERO       01390000
014000                                                 COMP SYNC.       01400000
014100     88  AC-CONTROL-CARD-ERROR                   VALUE +4003.     01410000
014200     88  AC-DB2-ERROR                            VALUE +4013.     01420000
014300     88  AC-CALENDAR-ROUTINE-ERROR               VALUE +4019.     01430000
014400                                                                  01440000
014500 01  PS-PROGRAM-SWITCHES.                                         01450000
014600     05  PS-EOF-CC1-SW                PIC  X(01) VALUE 'N'.       01460000
014700         88  PS-EOF-CC1-YES                      VALUE 'Y'.       01470000
015700                                                                  01640000
015800 01  PC-CONSTANTS.                                                01650000
016000     05  PC-MAX-ATTEMPT-COUNT         PIC  9(01) VALUE 5.         01670000
016100     05  PC-CURRENT-PROGRAM-NAME      PIC  X(08) VALUE            01680000
016200                                      'XSKUP071'.                 01690000
016300                                                                  01700000
016400 01  PV-MISC-FIELDS.                                              01710000
016500     05  PV-PARAGRAPH-NAME            PIC  X(30) VALUE SPACE.     01720000
016600     05  PV-ERROR-COUNT               PIC  9(03) VALUE ZERO.      01730000
016700     05  PV-ERROR-RECORD-COUNT        PIC  9(04) VALUE ZERO.      01740000
016800     05  PV-OPERATION-MSG-1           PIC  X(40) VALUE SPACE.     01750000
016900     05  PV-OPERATION-MSG-2           PIC  X(40) VALUE SPACE.     01760000
017000     05  PV-DB2-OPERATION             PIC  X(40) VALUE SPACE.     01770000
017300     05  PV-ATTEMPT-COUNT             PIC  9(04) VALUE ZEROS.     01780000
           05  PV-HOLD-STORE-ID             PIC  S9(04) COMP.           01790002
           05  PV-HOLD-POS-CAP-LVL-ID       PIC  S9(5)V COMP-3.         01800002
           05  PV-LAST-ERR-POS-LVL-ID       PIC  9(05) VALUE ZEROS.     01801001
018200                                                                  02080000
016400 01  PV-ERROR-RECORD.                                             02081001
016500     05  PV-ERROR-STORE-ID            PIC  X(05) VALUE SPACES.    02082001
016700     05  FILLER                       PIC  X(04) VALUE SPACES.    02082101
016600     05  PV-ERROR-POS-LVL-CAP-ID      PIC  X(05) VALUE SPACES.    02083001
016700     05  FILLER                       PIC  X(66) VALUE SPACES.    02084001
                                                                        02086001
018300******************************************************************02090000
018400*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            02100000
018500******************************************************************02110000
018600                                                                  02120000
018700     COPY DPWS004.                                                02130000
018800                                                                  02140000
020100******************************************************************02270000
020200*  DB2 COMMUNICATION AREA.                                        02280000
020300******************************************************************02290000
020400                                                                  02300000
020500     EXEC SQL                                                     02310000
020600          INCLUDE SQLCA                                           02320000
020700     END-EXEC.                                                    02330000
020800                                                                  02340000
020900******************************************************************02350000
021000*  DB2 TABLE DB2PDBA.XST_LOC_ATTR.                                02360000
021100******************************************************************02370000
021200                                                                  02380000
021300     EXEC SQL                                                     02390000
021400          INCLUDE XST00025                                        02400000
021500     END-EXEC.                                                    02410000
021600                                                                  02420000
021700***************************************************************** 02690000
021800 PROCEDURE DIVISION.                                              02700000
021900***************************************************************** 02710000
022000                                                                  02720000
022100******************************************************************02730000
022200*  0000-MAINLINE-PARAGRAPH.                                       02740001
022300******************************************************************02750000
022200 0000-MAINLINE-PARAGRAPH.                                         02751001
022400                                                                  02760000
022500     PERFORM 1000-INITIALIZE.                                     02770000
022600                                                                  02780000
022700     PERFORM 2000-PROCESS-STORES-FILE                             02790002
022800       UNTIL PS-EOF-CC1-YES.                                      02800001
022900                                                                  02810000
           PERFORM 9000-CLOSE-FILES.                                    02820000
                                                                        02830000
023200     STOP RUN.                                                    02840000
023300                                                                  02850000
021986*0000-EXIT.                                                       02851001
021987 EJECT.                                                           02852001
023400******************************************************************02860000
023500*  1000-INITIALIZE.                                               02870001
023600*     OPEN AND READS INPUT FILES AND PROCESSES CONTROL CARDS.     02880001
023700******************************************************************02890000
023500 1000-INITIALIZE.                                                 02891001
023800                                                                  02900000
023900     OPEN INPUT CONTROL-CARD-CONV-STORES                          02910001
024300         OUTPUT ERROR-FILE.                                       02950000
024400                                                                  02960000
024500     READ CONTROL-CARD-CONV-STORES INTO CC-CONTROL-CARD-1         02970001
024600        AT END                                                    02980000
024700           SET PS-EOF-CC1-YES          TO TRUE.                   02990000
024800                                                                  03000000
032600     MOVE PV-CONV-STORE      TO PV-HOLD-STORE-ID                  03020002
032400     MOVE PV-POS-CAP-LVL-ID  TO PV-HOLD-POS-CAP-LVL-ID.           03030002
                                                                        03040002
025600     IF PS-EOF-CC1-YES                                            03180000
025800        MOVE '1000-INITIALIZE'        TO PV-PARAGRAPH-NAME        03200000
025900        MOVE 'CONTROL CARD IS EMPTY'  TO PV-OPERATION-MSG-1       03210000
026000        SET AC-CONTROL-CARD-ERROR     TO TRUE                     03220000
026100        PERFORM 9999-ABEND                                        03230000
026200     END-IF.                                                      03240000
026300                                                                  03250000
026400     DISPLAY 'PROGRAM NAME:       ' PC-CURRENT-PROGRAM-NAME.      03260000
026500     DISPLAY 'CONTROL CARD 1:     ' CC-CONTROL-CARD-1.            03270000
026700                                                                  03290000
021986*1000-EXIT.                                                       03391001
021987 EJECT.                                                           03392001
027800******************************************************************03400000
027900 2000-PROCESS-STORES-FILE.                                        03410001
028000******************************************************************03420000
028100                                                                  03430000
026800     PERFORM                                                      03920000
026900         WITH TEST AFTER                                          03930000
027000         VARYING PV-ATTEMPT-COUNT                                 03940000
027100         FROM 1 BY 1                                              03950000
027200         UNTIL (PV-ATTEMPT-COUNT GREATER PC-MAX-ATTEMPT-COUNT     03960000
027310                   OR  SQLCODE = 0                                03970000
027320                   OR  SQLCODE = +100)                            03980000
027400                                                                  03990000
032200          EXEC SQL                                                04000000
032300             UPDATE XST_LOC_ATTR                                  04010001
032400                SET POS_CAP_LVL_ID    = :PV-HOLD-POS-CAP-LVL-ID   04020002
032600              WHERE LOC_NBR           = :PV-HOLD-STORE-ID         04040002
032700          END-EXEC                                                04050000
032800                                                                  04060000
032900          EVALUATE SQLCODE                                        04070000
033000             WHEN ZERO                                            04080000
033200                CONTINUE                                          04090000
033000             WHEN +100                                            04100000
                      MOVE PV-CONV-STORE      TO PV-ERROR-STORE-ID      04100103
                      MOVE PV-POS-CAP-LVL-ID  TO PV-ERROR-POS-LVL-CAP-ID04100203
035000                PERFORM 8000-WRITE-ERROR-RECORD                   04101001
033300             WHEN -904                                            04120000
033400             WHEN -911                                            04130000
033500             WHEN -913                                            04140000
033600                CONTINUE                                          04150000
034900             WHEN OTHER                                           04160000
                      MOVE PV-CONV-STORE      TO PV-ERROR-STORE-ID      04190001
                      MOVE PV-POS-CAP-LVL-ID  TO PV-ERROR-POS-LVL-CAP-ID04192002
035000                PERFORM 8000-WRITE-ERROR-RECORD                   04200001
035100                ADD 1                   TO PV-ERROR-RECORD-COUNT  04210001
035700                PERFORM 9100-SQL-ABEND                            04270001
035900          END-EVALUATE                                            04300000
           END-PERFORM.                                                 04310000
                                                                        04320000
033700     IF PV-ATTEMPT-COUNT         > PC-MAX-ATTEMPT-COUNT           04330000
033800        PERFORM 8000-WRITE-ERROR-RECORD                           04360001
033900        ADD 1                   TO PV-ERROR-RECORD-COUNT          04370001
034500        MOVE SQLCODE         TO PV-DB2-OPERATION                  04410001
034600        PERFORM 9100-SQL-ABEND                                    04420001
034800     END-IF.                                                      04450000
036000                                                                  04460000
024500     READ CONTROL-CARD-CONV-STORES INTO CC-CONTROL-CARD-1         04461001
024600        AT END                                                    04462001
024700           SET PS-EOF-CC1-YES          TO TRUE.                   04463001
                                                                        04500001
           IF NOT PS-EOF-CC1-YES                                        04500103
026500        DISPLAY 'CONTROL CARD 1:     ' CC-CONTROL-CARD-1          04500203
032600        MOVE PV-CONV-STORE          TO PV-HOLD-STORE-ID           04501003
032400        MOVE PV-POS-CAP-LVL-ID      TO PV-HOLD-POS-CAP-LVL-ID     04502003
           END-IF.                                                      04502103
                                                                        04503002
021986*2000-EXIT.                                                       04510001
021987 EJECT.                                                           04520001
048600******************************************************************08830000
048700 8000-WRITE-ERROR-RECORD.                                         08840000
048800*     WRITE ERROR RECORD OUT TO THE FILE.                         08850000
048900******************************************************************08860000
049000                                                                  08870000
049100     DISPLAY 'STORE NOT FOUND: ' PV-ERROR-STORE-ID.               08880001
           DISPLAY 'POS-CAP-LVL-ID:  ' PV-ERROR-POS-LVL-CAP-ID.         08890001
049200                                                                  08930000
049300     WRITE ERROR-RECORD                                           08940000
049400        FROM PV-ERROR-RECORD.                                     08950001
049500                                                                  08960000
021986*8000-EXIT.                                                       08961001
021987 EJECT.                                                           08962001
036100****************************************************************  08970000
036200*CLOSES FILES                                                     08980000
036300****************************************************************  08990000
       9000-CLOSE-FILES.                                                09000000
036500                                                                  09010000
025300     CLOSE CONTROL-CARD-CONV-STORES                               09020001
007200           ERROR-FILE.                                            09040000
037700                                                                  09050000
021986*9000-EXIT.                                                       09051001
021987 EJECT.                                                           09052001
037800******************************************************************09060000
037900* 9100-SQL-ABEND                                                  09070000
038000*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.09080000
038100******************************************************************09090000
038200 9100-SQL-ABEND.                                                  09100000
038300     DISPLAY '** ABEND     **'.                                   09110000
038400     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        09120000
038500     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              09130000
038600                                                                  09140000
038700******************************************************************09150000
038800* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     09160000
038900* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      09170000
039000******************************************************************09180000
039100     COPY DPPD004.                                                09190004
039200                                                                  09200000
039300     SET AC-DB2-ERROR TO TRUE.                                    09210000
039400     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         09220000
039500                                                                  09230000
021986*9100-EXIT.                                                       09231001
021987 EJECT.                                                           09232001
039600******************************************************************09240000
039700* 9999-ABEND                                                      09250000
039800*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  09260000
039900******************************************************************09270000
040000 9999-ABEND.                                                      09280000
040100     DISPLAY '** ABEND           **'.                             09290000
040200     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  09300000
040300     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        09310000
040400     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       09320000
040500     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       09330000
040600     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         09340000
                                                                        09341001
021986*9999-EXIT.                                                       09350001
021987 EJECT.                                                           09360001
