000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.    AHKUT002.                                         00020000
000300 AUTHOR.        CHERI MASTEL.                                     00030000
000400 INSTALLATION.  KOHLS.                                            00040000
000500 DATE-WRITTEN   AUG, 1997.                                        00050000
000600 DATE-COMPILED.                                                   00060000
000700                                                                  00070000
000800******************************************************************00080000
000900*   AHKUT002.  "ARCHIVE HISTORY" PROJECT. DATA OFFLOAD.          *00090000
001000*                                                                *00100000
001100*   PURPOSE:                                                     *00110000
001200*   THIS PROGRAM CONTINUES THE PROCESS OF DATA SELECTION TO      *00120000
001300*   CREATE A DRIVER FILE.                                        *00130000
001400*   ONCE COMPLETED, THE DRIVER FILE WILL BE USED BY SUBSEQUENT   *00140000
001500*   PROGRAMS TO IDENTIFY AND EXTRACT COMPLETED PO'S FROM         *00150000
001600*   SEVERAL INTERRELATED TABLES FOR ARCHIVING.                   *00160000
001700*                                                                *00170000
001800*   PROCESSING OVERVIEW:                                         *00180000
001900*   THIS PROGRAM APPLIES SELECTION CRITERIA FROM TABLE TPLNSHP   *00190000
002000*   TO THE RECORDS IN THE DRIVER FILE, POTENTIALLY REDUCING THE  *00200000
002100*   NUMBER OF RECORDS IN THE DRIVER FILE.                        *00210000
002200*   ALL RECORDS/ROWS FOR THE PURCHASE ORDER (PO) MUST MEET THE   *00220000
002300*   SELECTION CRITERIA FOR THE PO TO REMAIN IN THE DRIVER FILE.  *00230000
002400*                                                                *00240000
002500*   PROCESSING DETAIL:                                           *00250000
002600*   THIS PROGRAM READS A "DRIVER" FILE. FOR EACH RECORD READ,    *00260000
002700*   1) INCREMENT COUNT OF RECORDS READ.                          *00270000
002800*   2) ATTEMPT TO FIND RELATED ROW(S) ON THE TABLE,              *00280000
002900*      WHICH *DO NOT* MEET THE ARCHIVE CRITERIA.                 *00290000
003000*      2.A) IF NO MATCH(ES):                                     *00300000
003100*           2.A.1) LOOP TO WRITE ALL RECORDS FOR THIS PO         *00310000
003200*                  TO THE DRIVER FILE.                           *00320000
003300*           2.A.2) INCREMENT COUNT OF RECORDS WRITTEN.           *00330000
003400*           2.A.3) DO NOT REMOVE THE ROW(S) FROM THE TABLE       *00340000
003500*                  AT THIS TIME.  THEY WILL BE REMOVED IN OTHER  *00350000
003600*                  PROCESSING, AFTER HAVING BEEN LOADED TO THE   *00360000
003700*                  ARCHIVE/HISTORY TABLE.                        *00370000
003800*      2.B) IF MATCH(ES):                                        *00380000
003900*           2.B.1) PROCESSING CONTINUES:                         *00390000
004000*                  LOOP TO READ ALL RECORDS FOR THIS PO.         *00400000
004100*           2.B.2) THESE RECORDS ARE SCREENED OUT OF THE         *00410000
004200*                  DRIVER FILE.                                  *00420000
004300*   3) EVERY NTH RECORD (IE: INITIAL SETTING 1000), REPORT       *00430000
004400*      RECORD COUNT AND CURRENT DATE/TIME.  THIS WILL ASSIST     *00440000
004500*      WITH RUN-TIME ESTIMATE OF TIME REMAINING TO COMPLETE.     *00450000
004510*----------------------------------------------------------------*00451000
004520*  CHANGE LOG:                                                   *00452000
004530* 06/04/07                                                       *00453001
004540*     INCREASED SIZE OF INPUT AND OUTPUT FILES FROM 186 TO 189.  *00454000
004550*     THIS WAS NEEDED TO ALLOW FOR THE 2 NEW FIELDS IN THE       *00455000
004560*     AHRD001 COPYBOOK: DC-NBR AND MTCH-LVL-CDE.                 *00456000
004570* MADE BY: ROLF NOHE                           WR# 30241         *00457000
004580******************************************************************00458000
004590 ENVIRONMENT DIVISION.                                            00459000
004600 CONFIGURATION SECTION.                                           00460000
004700 SOURCE-COMPUTER.        IBM-3090.                                00470000
004800 OBJECT-COMPUTER.        IBM-3090.                                00480000
004900                                                                  00490000
005000 INPUT-OUTPUT SECTION.                                            00500000
005100 FILE-CONTROL.                                                    00510000
005200                                                                  00520000
005300     SELECT  IN-DRIVER-FILE               ASSIGN TO IN01.         00530000
005400     SELECT  OUT-DRIVER-FILE              ASSIGN TO OUT01.        00540000
005500                                                                  00550000
005600******************************************************************00560000
005700 DATA DIVISION.                                                   00570000
005800 FILE SECTION.                                                    00580000
005900                                                                  00590000
006000 FD  IN-DRIVER-FILE                                               00600000
006100     RECORDING MODE IS F                                          00610000
006200     LABEL RECORDS ARE STANDARD                                   00620000
006300     BLOCK CONTAINS 0 RECORDS.                                    00630000
006400 01  IN-DRIVER-RECORD                PIC  X(189).                 00640000
006500                                                                  00650000
006600 FD  OUT-DRIVER-FILE                                              00660000
006700     RECORDING MODE IS F                                          00670000
006800     LABEL RECORDS ARE STANDARD                                   00680000
006900     BLOCK CONTAINS 0 RECORDS.                                    00690000
007000 01  OUT-DRIVER-RECORD               PIC  X(189).                 00700000
007100                                                                  00710000
007200 WORKING-STORAGE SECTION.                                         00720000
007300                                                                  00730000
007400 01  PC-PROGRAM-CONSTANTS.                                        00740000
007500     05  PC-CURRENT-PROGRAM-NAME     PIC X(08) VALUE 'AHKUT002'.  00750000
007600     05  PC-PGM-PROGRESS-DESC.                                    00760000
007700         10  PC-BEGINNING            PIC X(09) VALUE 'BEGINNING'. 00770000
007800         10  PC-CONTINUING           PIC X(10) VALUE              00780000
007900                                               'CONTINUING'.      00790000
008000         10  PC-ENDING               PIC X(06) VALUE 'ENDING'.    00800000
008100         10  PC-ABENDING             PIC X(08) VALUE 'ABENDING'.  00810000
008200     05  PC-ABEND-INFO.                                           00820000
008300         10  PC-ABEND                PIC X(11) VALUE              00830000
008400                                               '** ABEND **'.     00840000
008500         10  PC-ABEND-MSG-PARA       PIC X(15) VALUE              00850000
008600                                               '- PARA       : '. 00860000
008700         10  PC-ABEND-MSG-DISPLAY-PARA                            00870000
008800                                     PIC X(15) VALUE              00880000
008900                                               '  CALLED PARA: '. 00890000
009000         10  PC-ABEND-MSG-NUMBER     PIC X(15) VALUE              00900000
009100                                               '  FOR ABEND# : '. 00910000
009200         10  PC-ABEND-MSG-DESC       PIC X(15) VALUE              00920000
009300                                               '- ERROR IS   : '. 00930000
009400         10  PC-ABEND-MSG-INDENT-15  PIC X(15) VALUE SPACES.      00940000
009500         10  PC-ABEND-MSG-ACTION     PIC X(15) VALUE              00950000
009600                                               '- ACTION     : '. 00960000
009700     05  PC-HOW-OFTEN-TO-DISPLAY     PIC 9(9)  VALUE 100000.      00970000
009800                                                                  00980000
009900 01  PS-PROGRAM-SWITCHES.                                         00990000
010000     05  PS-CONTROL-BREAK-SW         PIC X(01) VALUE 'N'.         01000000
010100         88  PS-CONTROL-BREAK                  VALUE 'Y'.         01010000
010200         88  PS-RESET-CONTROL-BREAK            VALUE 'N'.         01020000
010300     05  PS-IN-DRIVER-EOF-SW         PIC X(01) VALUE 'N'.         01030000
010400         88  PS-IN-DRIVER-EOF                  VALUE 'Y'.         01040000
010500         88  PS-IN-DRIVER-NOT-EOF              VALUE 'N'.         01050000
010600     05  PS-CURSOR-HAS-DATA-SW       PIC X(01) VALUE 'N'.         01060000
010700         88  PS-CURSOR-HAS-DATA                VALUE 'Y'.         01070000
010800         88  PS-CURSOR-HAS-NO-DATA             VALUE 'N'.         01080000
010900                                                                  01090000
011000 01  PV-PROGRAM-VARIABLES.                                        01100000
011100     05  PV-DRIVER-READ-IN-CNT       PIC  9(9) VALUE 0.           01110000
011200     05  PV-DRIVER-READ-PO-CNT       PIC  9(9) VALUE 0.           01120000
011300     05  PV-CURSORS-TOTAL-CNT        PIC  9(9) VALUE 0.           01130000
011400     05  PV-CURSORS-NONSELECT-CNT    PIC  9(9) VALUE 0.           01140000
011500     05  PV-ROW-COUNT                PIC S9(9) VALUE 0 COMP.      01150000
011600     05  PV-CURSORS-PO-SELECT-CNT    PIC  9(9) VALUE 0.           01160000
011700     05  PV-DRIVER-WRITTEN-CNT       PIC  9(9) VALUE 0.           01170000
011800     05  PV-PO-NBR                   PIC S9(9) VALUE 0 COMP.      01180000
011900     05  PV-PREV-PO-NBR              PIC S9(9) VALUE 0 COMP.      01190000
012000     05  PV-PARAGRAPH-NAME           PIC X(30) VALUE SPACES.      01200000
012100     05  PV-DB2-OPERATION-MSG-1      PIC X(79) VALUE SPACES.      01210000
012200     05  PV-DB2-TABLE-NAME-1         PIC X(18) VALUE SPACES.      01220000
012300     05  PV-DB2-TABLE-NAME-2         PIC X(18) VALUE SPACES.      01230000
012400     05  PV-DISPLAY-NTH-MULTIPLE     PIC  9(9) VALUE 0.           01240000
012500     05  PV-DISPLAY-NTH-REMAINDER    PIC  9(9) VALUE 0.           01250000
012600     05  PV-SQLCODE                  PIC +999  VALUE ZERO.        01260000
012700                                                                  01270000
012800     05  PV-TMST                     PIC X(26) VALUE SPACES.      01280000
012900     05  PV-TIMESTAMP-DETAIL                                      01290000
013000         REDEFINES                                                01300000
013100         PV-TMST.                                                 01310000
013200         10  PV-TIMESTAMP-19.                                     01320000
013300             15  PV-TMS-DATE.                                     01330000
013400                 20  PV-TMS-YEAR.                                 01340000
013500                     25  PV-TMS-CC   PIC X(02).                   01350000
013600                     25  PV-TMS-YY   PIC X(02).                   01360000
013700                 20  FILLER          PIC X(01).                   01370000
013800                 20  PV-TMS-MONTH    PIC X(02).                   01380000
013900                 20  FILLER          PIC X(01).                   01390000
014000                 20  PV-TMS-DAY      PIC X(02).                   01400000
014100             15  FILLER              PIC X(01).                   01410000
014200             15  PV-TMS-HOUR         PIC X(02).                   01420000
014300             15  FILLER              PIC X(01).                   01430000
014400             15  PV-TMS-MINUTE       PIC X(02).                   01440000
014500             15  FILLER              PIC X(01).                   01450000
014600             15  PV-TMS-SECOND       PIC X(02).                   01460000
014700         10  FILLER                  PIC X(01).                   01470000
014800         10  PV-TMS-MSECOND          PIC X(06).                   01480000
014900                                                                  01490000
015000                                                                  01500000
015100*---------------------------------------------------------------* 01510000
015200*  RECORD LAYOUT FOR DRIVER FILE.                               * 01520000
015300*---------------------------------------------------------------* 01530000
015400     COPY AHRD001.                                                01540000
015500                                                                  01550000
015600                                                                  01560000
015700 01  DM-DISPLAY-MESSAGE.                                          01570000
015800     05  DM-01-10.                                                01580000
015900         10  DM-PROGRAM              PIC X(08) VALUE SPACE.       01590000
016000         10  FILLER                  PIC X(02) VALUE ': '.        01600000
016100     05  DM-11-80.                                                01610000
016200         10  FILLER                  PIC X(38) VALUE              01620000
016300                        'APPLY TPLNSHP CRITERIA TO DRIVER FILE.'. 01630000
016400         10  FILLER                  PIC X(01) VALUE SPACE.       01640000
016500         10  FILLER                  PIC X(31) VALUE ALL '*'.     01650000
016600     05  DM-81-120.                                               01660000
016700         10  FILLER                  PIC X(40) VALUE ALL '*'.     01670000
016800                                                                  01680000
016900 01  DP-DISPLAY-PROGRESS-MSG.                                     01690000
017000     05  DP-PROGRAM                  PIC X(08) VALUE SPACE.       01700000
017100     05  FILLER                      PIC X(02) VALUE SPACE.       01710000
017200     05  DP-STATUS-DESCRIPTION       PIC X(10) VALUE SPACE.       01720000
017300     05  FILLER                      PIC X(04) VALUE ' AT '.      01730000
017400     05  DP-TIMESTAMP-19             PIC X(19) VALUE SPACE.       01740000
017500     05  FILLER                      PIC X(03) VALUE '.  '.       01750000
017600     05  FILLER                      PIC X(03) VALUE 'IN:'.       01760000
017700     05  DP-DRIVER-READ-IN-CNT       PIC ZZZ,ZZZ,ZZ9              01770000
017800                                               VALUE ZERO.        01780000
017900     05  FILLER                      PIC X(02) VALUE ', '.        01790000
018000     05  FILLER                      PIC X(05) VALUE 'PO"S:'.     01800000
018100     05  DP-DRIVER-READ-PO-CNT       PIC ZZZ,ZZZ,ZZ9              01810000
018200                                               VALUE ZERO.        01820000
018300     05  FILLER                      PIC X(02) VALUE ', '.        01830000
018400*    05  FILLER                      PIC X(08) VALUE              01840000
018500*                                              'CURSORS:'.        01850000
018600*    05  DP-CURSORS-TOTAL-CNT        PIC ZZZ,ZZZ,ZZ9              01860000
018700*                                              VALUE ZERO.        01870000
018800*    05  FILLER                      PIC X(02) VALUE ', '.        01880000
018900*    05  FILLER                      PIC X(10) VALUE              01890000
019000*                                              'NONSELECT:'.      01900000
019100*    05  DP-CURSORS-NONSELECT-CNT    PIC ZZZ,ZZZ,ZZ9              01910000
019200*                                              VALUE ZERO.        01920000
019300*    05  FILLER                      PIC X(02) VALUE ', '.        01930000
019400     05  FILLER                      PIC X(10) VALUE              01940000
019500                                               'PO SELECT:'.      01950000
019600     05  DP-CURSORS-PO-SELECT-CNT    PIC ZZZ,ZZZ,ZZ9              01960000
019700                                               VALUE ZERO.        01970000
019800     05  FILLER                      PIC X(02) VALUE ', '.        01980000
019900     05  FILLER                      PIC X(04) VALUE 'OUT:'.      01990000
020000     05  DP-DRIVER-WRITTEN-CNT       PIC ZZZ,ZZZ,ZZ9              02000000
020100                                               VALUE ZERO.        02010000
020200     05  FILLER                      PIC X(01) VALUE '.'.         02020000
020300                                                                  02030000
020400 01  ABEND-CODE                      PIC S9(04)                   02040000
020500                                               VALUE ZEROES       02050000
020600                                               COMP SYNC.         02060000
020700                                                                  02070000
020800*---------------------------------------------------------------* 02080000
020900*  DB2 FORMATTED MESSAGE AREA                                     02090000
021000*---------------------------------------------------------------* 02100000
021100     COPY DPWS004.                                                02110000
021200                                                                  02120000
021300*---------------------------------------------------------------* 02130000
021400*    DB2 AREA FOR TPLNSHP                                       * 02140000
021500*---------------------------------------------------------------* 02150000
021600     EXEC SQL                                                     02160000
021700          INCLUDE TPLNSHP                                         02170000
021800     END-EXEC.                                                    02180000
021900                                                                  02190000
022000*---------------------------------------------------------------* 02200000
022100*    DB2 AREA FOR COMMUNICATIONS                                * 02210000
022200*---------------------------------------------------------------* 02220000
022300     EXEC SQL                                                     02230000
022400          INCLUDE SQLCA                                           02240000
022500     END-EXEC.                                                    02250000
022600                                                                  02260000
022700*---------------------------------------------------------------* 02270000
022800*    DEFINE CURSOR FOR PULLING ROW(S) FROM TPLNSHP              * 02280000
022900*    WHICH DO *NOT* MEET THE SELECTION CRITERIA;                * 02290000
023000*    IF ANY ROW(S) ARE RETURNED, THIS PURCHASE ORDER (PO) WILL  * 02300000
023100*    *NOT* REMAIN IN THE DRIVER FILE.                           * 02310000
023200*---------------------------------------------------------------* 02320000
023300     EXEC SQL                                                     02330000
023400         DECLARE   NONSELECT-CURSOR CURSOR FOR                    02340000
023500         SELECT    COUNT(*)                                       02350000
023600         FROM      TPLNSHP                                        02360000
023700         WHERE    (PO_NBR = :PV-PO-NBR)                           02370000
023800         AND      (DONT_SHIP_BEF_DTE >=                           02380000
023900                                   DATE(CURRENT DATE - 2 YEARS))  02390000
024000         FOR       FETCH ONLY                                     02400000
024100         WITH      UR                                             02410000
024200     END-EXEC.                                                    02420000
024300                                                                  02430000
024400                                                                  02440000
024500 PROCEDURE DIVISION.                                              02450000
024600                                                                  02460000
024700 0000-PROGRAM-MAINLINE.                                           02470000
024800                                                                  02480000
024900     PERFORM 1000-INITIALIZE.                                     02490000
025000                                                                  02500000
025100     PERFORM 2000-PROCESS-ONE-PO                                  02510000
025200         UNTIL PS-IN-DRIVER-EOF.                                  02520000
025300                                                                  02530000
025400     PERFORM 6000-EOJ-ROUTINE.                                    02540000
025500     GOBACK.                                                      02550000
025600                                                                  02560000
025700                                                                  02570000
025800******************************************************************02580000
025900*   INITIALIZATIONS                                              *02590000
026000******************************************************************02600000
026100 1000-INITIALIZE.                                                 02610000
026200                                                                  02620000
026300     MOVE PC-CURRENT-PROGRAM-NAME TO DM-PROGRAM.                  02630000
026400     DISPLAY DM-DISPLAY-MESSAGE.                                  02640000
026500                                                                  02650000
026600     MOVE PC-BEGINNING  TO  DP-STATUS-DESCRIPTION.                02660000
026700     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           02670000
026800                                                                  02680000
026900     OPEN  INPUT  IN-DRIVER-FILE                                  02690000
027000          OUTPUT OUT-DRIVER-FILE.                                 02700000
027100                                                                  02710000
027200     SET PS-IN-DRIVER-NOT-EOF TO TRUE.                            02720000
027300     PERFORM 9050-READ-IN-DRIVER-FILE.                            02730000
027400                                                                  02740000
027500******************************************************************02750000
027600*   PROCESS EACH RECORD FROM THE SEQUENTIAL DRIVER FILE.         *02760000
027700*   - CONTROL BREAK ON PO.                                       *02770000
027800*     PROCESS THE FIRST RECORD IN THE DRIVER FILE FOR THIS PO.   *02780000
027900*   - THIS WILL DETERMINE ACTION TO BE TAKEN FOR EACH            *02790000
028000*     SUBSEQUENT RECORD FOR THIS PO.                             *02800000
028100******************************************************************02810000
028200 2000-PROCESS-ONE-PO.                                             02820000
028300                                                                  02830000
028400     MOVE AH001-B-PO-NBR        TO PV-PREV-PO-NBR                 02840000
028500                                   PV-PO-NBR.                     02850000
028600     SET PS-RESET-CONTROL-BREAK TO TRUE.                          02860000
028700                                                                  02870000
028800     ADD +1                     TO PV-CURSORS-TOTAL-CNT.          02880000
028900     SET PS-CURSOR-HAS-NO-DATA  TO TRUE.                          02890000
029000     PERFORM 9100-OPEN-NONSELECT-CURSOR.                          02900000
029100     PERFORM 9110-FETCH-NONSELECT-CURSOR.                         02910000
029200                                                                  02920000
029300     IF PS-CURSOR-HAS-DATA                                        02930000
029400         ADD +1 TO PV-CURSORS-NONSELECT-CNT                       02940000
029500         PERFORM 9050-READ-IN-DRIVER-FILE                         02950000
029600             UNTIL PS-IN-DRIVER-EOF                               02960000
029700                OR PS-CONTROL-BREAK                               02970000
029800     ELSE                                                         02980000
029900         ADD +1 TO PV-CURSORS-PO-SELECT-CNT                       02990000
030000         PERFORM 2020-LOOP-TIL-NEXT-PO                            03000000
030100             UNTIL PS-IN-DRIVER-EOF                               03010000
030200                OR PS-CONTROL-BREAK                               03020000
030300     END-IF.                                                      03030000
030400                                                                  03040000
030500     PERFORM 9190-CLOSE-NONSELECT-CURSOR.                         03050000
030600                                                                  03060000
030700                                                                  03070000
030800******************************************************************03080000
030900*   COPY EACH RECORD FOR THIS PO FROM THE INPUT DRIVER FILE      *03090000
031000*   TO THE OUTPUT DRIVER FILE.                                   *03100000
031100******************************************************************03110000
031200 2020-LOOP-TIL-NEXT-PO.                                           03120000
031300                                                                  03130000
031400     PERFORM 9650-WRITE-DRIVER-RECORD.                            03140000
031500                                                                  03150000
031600     PERFORM 9050-READ-IN-DRIVER-FILE.                            03160000
031700                                                                  03170000
031800                                                                  03180000
031900******************************************************************03190000
032000*      EVERY NTH RECORD (IE: INITIAL SETTING 1000), REPORT       *03200000
032100*      RECORD COUNT AND CURRENT DATE/TIME.  THIS WILL ASSIST     *03210000
032200*      WITH RUN-TIME ESTIMATE OF TIME REMAINING TO COMPLETE.     *03220000
032300******************************************************************03230000
032400 2100-CHECK-PGM-PROGRESS.                                         03240000
032500                                                                  03250000
032600     DIVIDE    PV-DRIVER-READ-IN-CNT                              03260000
032700         BY        PC-HOW-OFTEN-TO-DISPLAY                        03270000
032800         GIVING    PV-DISPLAY-NTH-MULTIPLE                        03280000
032900         REMAINDER PV-DISPLAY-NTH-REMAINDER.                      03290000
033000                                                                  03300000
033100     IF PV-DISPLAY-NTH-REMAINDER = ZERO                           03310000
033200         MOVE PC-CONTINUING         TO DP-STATUS-DESCRIPTION      03320000
033300         PERFORM 6200-DISPLAY-PGM-PROGRESS                        03330000
033400     END-IF.                                                      03340000
033500                                                                  03350000
033600                                                                  03360000
033700******************************************************************03370000
033800*   CLOSE FILES, CURSOR, AND DISPLAY END OF RUN MESSAGE.         *03380000
033900******************************************************************03390000
034000 6000-EOJ-ROUTINE.                                                03400000
034100                                                                  03410000
034200     MOVE PC-ENDING  TO  DP-STATUS-DESCRIPTION.                   03420000
034300                                                                  03430000
034400     CLOSE IN-DRIVER-FILE                                         03440000
034500           OUT-DRIVER-FILE.                                       03450000
034600                                                                  03460000
034700     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           03470000
034800                                                                  03480000
034900                                                                  03490000
035000******************************************************************03500000
035100*   DISPLAY PROGRAM PROGRESS.                                    *03510000
035200******************************************************************03520000
035300 6200-DISPLAY-PGM-PROGRESS.                                       03530000
035400                                                                  03540000
035500     EXEC SQL                                                     03550000
035600          SET :PV-TMST = CURRENT TIMESTAMP                        03560000
035700     END-EXEC.                                                    03570000
035800                                                                  03580000
035900     MOVE PC-CURRENT-PROGRAM-NAME   TO DP-PROGRAM.                03590000
036000     MOVE PV-TIMESTAMP-19           TO DP-TIMESTAMP-19.           03600000
036100     MOVE PV-DRIVER-READ-IN-CNT     TO DP-DRIVER-READ-IN-CNT.     03610000
036200     MOVE PV-DRIVER-READ-PO-CNT     TO DP-DRIVER-READ-PO-CNT.     03620000
036300*    MOVE PV-CURSORS-TOTAL-CNT      TO DP-CURSORS-TOTAL-CNT.      03630000
036400*    MOVE PV-CURSORS-NONSELECT-CNT  TO DP-CURSORS-NONSELECT-CNT.  03640000
036500     MOVE PV-CURSORS-PO-SELECT-CNT  TO DP-CURSORS-PO-SELECT-CNT.  03650000
036600     MOVE PV-DRIVER-WRITTEN-CNT     TO DP-DRIVER-WRITTEN-CNT.     03660000
036700                                                                  03670000
036800     DISPLAY DP-DISPLAY-PROGRESS-MSG.                             03680000
036900                                                                  03690000
037000                                                                  03700000
037100                                                                  03710000
037200******************************************************************03720000
037300*   READ  INPUT DRIVER FILE OF ELIGIBLE DATA TO EXTRACT          *03730000
037400******************************************************************03740000
037500 9050-READ-IN-DRIVER-FILE.                                        03750000
037600                                                                  03760000
037700     READ IN-DRIVER-FILE                                          03770000
037800          INTO AH001-DRIVER-RECORD-LAYOUT                         03780000
037900          AT END                                                  03790000
038000              SET PS-IN-DRIVER-EOF TO TRUE.                       03800000
038100                                                                  03810000
038200     IF PS-IN-DRIVER-EOF                                          03820000
038300         CONTINUE                                                 03830000
038400     ELSE                                                         03840000
038500         ADD +1                    TO PV-DRIVER-READ-IN-CNT       03850000
038600         PERFORM 2100-CHECK-PGM-PROGRESS                          03860000
038700         IF AH001-B-PO-NBR = PV-PREV-PO-NBR                       03870000
038800             CONTINUE                                             03880000
038900         ELSE                                                     03890000
039000             SET PS-CONTROL-BREAK  TO TRUE                        03900000
039100             ADD +1                TO PV-DRIVER-READ-PO-CNT       03910000
039200         END-IF                                                   03920000
039300     END-IF.                                                      03930000
039400                                                                  03940000
039500                                                                  03950000
039600******************************************************************03960000
039700*   OPEN  TABLE CURSOR                                           *03970000
039800******************************************************************03980000
039900 9100-OPEN-NONSELECT-CURSOR.                                      03990000
040000     EXEC SQL                                                     04000000
040100          OPEN NONSELECT-CURSOR                                   04010000
040200     END-EXEC.                                                    04020000
040300                                                                  04030000
040400     EVALUATE TRUE                                                04040000
040500         WHEN SQLCODE = ZERO                                      04050000
040600              CONTINUE                                            04060000
040700         WHEN SQLWARN0 NOT EQUAL SPACE                            04070000
040800         WHEN SQLCODE  NOT EQUAL ZERO                             04080000
040900              MOVE '9100-OPEN-NONSELECT-CURSOR'                   04090000
041000                                 TO PV-PARAGRAPH-NAME             04100000
041100              MOVE 'OPEN TABLE CURSOR'                            04110000
041200                                 TO PV-DB2-OPERATION-MSG-1        04120000
041300              MOVE 'TPLNSHP'     TO PV-DB2-TABLE-NAME-1           04130000
041400              PERFORM 9999-DB2-ABEND                              04140000
041500     END-EVALUATE.                                                04150000
041600                                                                  04160000
041700                                                                  04170000
041800******************************************************************04180000
041900*   FETCH TABLE CURSOR                                           *04190000
042000******************************************************************04200000
042100 9110-FETCH-NONSELECT-CURSOR.                                     04210000
042200     EXEC SQL                                                     04220000
042300         FETCH NONSELECT-CURSOR                                   04230000
042400          INTO  :PV-ROW-COUNT                                     04240000
042500     END-EXEC.                                                    04250000
042600                                                                  04260000
042700     EVALUATE TRUE                                                04270000
042800         WHEN SQLCODE = ZERO                                      04280000
042900              CONTINUE                                            04290000
043000         WHEN SQLWARN0 NOT EQUAL SPACE                            04300000
043100         WHEN SQLCODE NOT EQUAL ZERO                              04310000
043200              MOVE '9110-FETCH-NONSELECT-CURSOR'                  04320000
043300                                 TO PV-PARAGRAPH-NAME             04330000
043400              MOVE 'FETCH TABLE CURSOR'                           04340000
043500                                 TO PV-DB2-OPERATION-MSG-1        04350000
043600              MOVE 'TPLNSHP'     TO PV-DB2-TABLE-NAME-1           04360000
043700              PERFORM 9999-DB2-ABEND                              04370000
043800     END-EVALUATE.                                                04380000
043900                                                                  04390000
044000     IF PV-ROW-COUNT > 0                                          04400000
044100          SET PS-CURSOR-HAS-DATA    TO TRUE                       04410000
044200     ELSE                                                         04420000
044300          SET PS-CURSOR-HAS-NO-DATA TO TRUE                       04430000
044400     END-IF.                                                      04440000
044500                                                                  04450000
044600******************************************************************04460000
044700*   CLOSE TABLE CURSOR                                           *04470000
044800******************************************************************04480000
044900 9190-CLOSE-NONSELECT-CURSOR.                                     04490000
045000     EXEC SQL                                                     04500000
045100          CLOSE NONSELECT-CURSOR                                  04510000
045200     END-EXEC.                                                    04520000
045300                                                                  04530000
045400     EVALUATE TRUE                                                04540000
045500         WHEN SQLCODE = ZERO                                      04550000
045600              CONTINUE                                            04560000
045700         WHEN SQLWARN0 NOT EQUAL SPACE                            04570000
045800         WHEN SQLCODE NOT EQUAL ZERO                              04580000
045900              MOVE '9190-CLOSE-NONSELECT-CURSOR'                  04590000
046000                                 TO PV-PARAGRAPH-NAME             04600000
046100              MOVE 'CLOSE TABLE CURSOR'                           04610000
046200                                 TO PV-DB2-OPERATION-MSG-1        04620000
046300              MOVE 'TPLNSHP'     TO PV-DB2-TABLE-NAME-1           04630000
046400              PERFORM 9999-DB2-ABEND                              04640000
046500     END-EVALUATE.                                                04650000
046600                                                                  04660000
046700                                                                  04670000
046800                                                                  04680000
046900                                                                  04690000
047000******************************************************************04700000
047100*   WRITE A RECORD TO THE DRIVER FILE                            *04710000
047200******************************************************************04720000
047300 9650-WRITE-DRIVER-RECORD.                                        04730000
047400     WRITE  OUT-DRIVER-RECORD  FROM  AH001-DRIVER-RECORD-LAYOUT.  04740000
047500     ADD +1 TO PV-DRIVER-WRITTEN-CNT.                             04750000
047600                                                                  04760000
047700                                                                  04770000
047800                                                                  04780000
047900                                                                  04790000
048000******************************************************************04800000
048100*   DISPLAY INFORMATION NEEDED FOR DEBUGGING/MAINTENANCE/SUPPORT *04810000
048200*   AND CALL THE ABEND PROCESSOR IN THE EVENT THAT AN            *04820000
048300*   SQL ERROR OR WARNING CODE OCCURS.                            *04830000
048400******************************************************************04840000
048500 9999-DB2-ABEND.                                                  04850000
048600     DISPLAY PC-CURRENT-PROGRAM-NAME                              04860000
048700             ' 9999-DB2-ABEND'.                                   04870000
048800     DISPLAY PC-CURRENT-PROGRAM-NAME                              04880000
048900             ' ** ABEND           **'.                            04890000
049000     DISPLAY PC-CURRENT-PROGRAM-NAME                              04900000
049100             ' ** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.       04910000
049200     DISPLAY PC-CURRENT-PROGRAM-NAME                              04920000
049300             ' ** TABLES AFFECTED ** = ' PV-DB2-TABLE-NAME-1.     04930000
049400     DISPLAY PC-CURRENT-PROGRAM-NAME                              04940000
049500             ' **                 ** = ' PV-DB2-TABLE-NAME-2.     04950000
049600     DISPLAY PC-CURRENT-PROGRAM-NAME                              04960000
049700             ' ** OPERATION       ** = ' PV-DB2-OPERATION-MSG-1.  04970000
049800                                                                  04980000
049900     DISPLAY PC-CURRENT-PROGRAM-NAME                              04990000
050000             ' ** SQLCODE         ** = ' SQLCODE.                 05000000
050100     MOVE SQLCODE TO PV-SQLCODE.                                  05010000
050200     DISPLAY PC-CURRENT-PROGRAM-NAME                              05020000
050300             ' ** PV-SQLCODE      ** = ' PV-SQLCODE '.'.          05030000
050400                                                                  05040000
050500     DISPLAY PC-CURRENT-PROGRAM-NAME                              05050000
050600             ' ** SQLWARN0        ** = ' SQLWARN0 '.'.            05060000
050700                                                                  05070000
050800                                                                  05080000
050900*----------------------------------------------------------------*05090000
051000* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *05100000
051100* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *05110000
051200* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *05120000
051300* FORMAT.                                                        *05130000
051400*----------------------------------------------------------------*05140000
051500     COPY DPPD004.                                                05150000
051600                                                                  05160000
051700     MOVE PC-ABENDING               TO DP-STATUS-DESCRIPTION.     05170000
051800     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           05180000
051900                                                                  05190000
052000                                                                  05200000
052100*----------------------------------------------------------------*05210000
052200* CALL ABEND                                                     *05220000
052300*----------------------------------------------------------------*05230000
052400     MOVE +4013                  TO ABEND-CODE.                   05240000
052500     CALL 'ILBOABN0' USING ABEND-CODE.                            05250000
052600*                                                                 05260000
