       IDENTIFICATION DIVISION.                                         00010000
       PROGRAM-ID.    XSKUP017.                                         00020036
       AUTHOR.        KOHLS DEPARTMENT STORES.                          00030000
       INSTALLATION.  KOHLS DEPARTMENT STORES.                          00040000
       DATE-WRITTEN.  09/27/2002.                                       00050043
       DATE-COMPILED.                                                   00060000
      ******************************************************************00070000
      **       MERCHANDISE HIERARCHY MESSAGE FOR TABLE XST_SUB_CL       00080036
      ******************************************************************00090024
      **THIS IS A CALLED MODULE FOR SUBCLASS MERCH HIER TABLES.  THIS   00100036
      **     PROGRAM WILL PERFORM UPDATES/INSERTS/DELETES FOR THIS      00110036
      **     TABLE.  IT DOES THE FOLLOWING WITH THESE RETURN CODES:     00120036
      **     0000 - END PROGRAM                                         00130024
      **    -0530 - END PROGRAM                                         00140024
      **    -0803 - COMPARE TIMESTAMPS AND UPDATE IF MESSAGE IS NEWER   00150024
      **    -0911 - RETRY INSERT UP TO 5 TIMES AND THEN END PROGRAM     00160024
      ******************************************************************00170000
      **09/27/2002 CHANGED BY:JULIE SMITH          PROGRAM WRITE        00180043
010103**01/01/2003 CHANGED BY:JULIE SMITH  TIMESTAMP ADDITION           00181053
      **05/13/2005 CHANGED BY: NANCY MARTIN WR26916                     00191053
      **                       ADDED SUB CLASS ATTR TABLE               00192053
      ******************************************************************00200000
       ENVIRONMENT DIVISION.                                            00210000
       CONFIGURATION SECTION.                                           00220000
       SOURCE-COMPUTER.  IBM-3090.                                      00230000
       OBJECT-COMPUTER.  IBM-3090.                                      00240000
       DATA DIVISION.                                                   00250000
                                                                        00260017
       WORKING-STORAGE SECTION.                                         00270017
      ******************************************************************00280000
      **PROGRAM SWITCHES                                                00290000
      ******************************************************************00300000
       01  PS-PROGRAM-SWITCHES.                                         00310000
           05  PS-PROCESS-CONTINUE-SW      PIC X(01)  VALUE 'Y'.        00320020
               88  PS-PROCESS-CONTINUE                VALUE 'Y'.        00330018
               88  PS-PROCESS-COMPLETE                VALUE 'N'.        00340018
      ******************************************************************00350000
      **PROGRAM COUNTERS                                                00360018
      ******************************************************************00370000
       01  PC-PROGRAM-COUNTERS.                                         00380018
           05  PC-RETRY-COUNTER            PIC 9(01)  VALUE ZEROS.      00390018
           05  PC-RETRY-COUNTER-2          PIC 9(01)  VALUE ZEROS.      00400019
           05  PC-RETRY-MAX                PIC 9(01)  VALUE 5.          00410024
      ******************************************************************00420018
      **PROGRAM VARIABLES                                               00430018
      ******************************************************************00440018
       01  PV-PROGRAM-VARIABLES.                                        00450018
           05  PV-PARAGRAPH-NAME               PIC X(20)  VALUE SPACES. 00460019
           05  PV-TIME-EVALUATE-INSERT.                                 00470019
               10  PV-TIME-HOUR-IN             PIC  9(02) VALUE ZEROS.  00480019
               10  PV-TIME-MINUTE-IN           PIC  9(02) VALUE ZEROS.  00490019
               10  PV-TIME-SECOND-IN           PIC  9(02) VALUE ZEROS.  00500019
               10  PV-TIME-MICROSEC-IN         PIC  9(06) VALUE ZEROS.  00510019
           05  PV-TIME-EVALUATE-UPDATE.                                 00520019
               10  PV-TIME-HOUR-UP             PIC  9(02) VALUE ZEROS.  00530019
               10  PV-TIME-MINUTE-UP           PIC  9(02) VALUE ZEROS.  00540019
               10  PV-TIME-SECOND-UP           PIC  9(02) VALUE ZEROS.  00550019
               10  PV-TIME-MICROSEC-UP         PIC  9(06) VALUE ZEROS.  00560019
      ******************************************************************00570018
      **TIMESTAMP VARIABLES                                             00580018
      ******************************************************************00590018
       01  SD-TIMESTAMP-COMPARE                PIC  X(26)  VALUE SPACES.00600050
       01  SD-TIMESTAMP.                                                00610050
           05  SD-CURR-DTE                     PIC  X(10).              00620018
           05  FILLER                          PIC  X(01) VALUE '-'.    00630050
           05  SD-HOUR                         PIC  9(02).              00640051
           05  FILLER                          PIC  X(01) VALUE '.'.    00650050
           05  SD-MINUTE                       PIC  9(02).              00660051
           05  FILLER                          PIC  X(01) VALUE '.'.    00670050
           05  SD-SECOND                       PIC  9(02).              00680051
           05  FILLER                          PIC  X(01) VALUE '.'.    00690050
           05  SD-MICROSEC                     PIC  9(06).              00700051
      ******************************************************************00710000
      **COPYBOOKS                                                       00720000
      ******************************************************************00730000
      ***DB2 MESSAGE AREA                                               00740000
           COPY SQLCA2.                                                 00750052
      ***MESSAGE COPYBOOK                                               00760018
           COPY HMRD001.                                                00770052
      ***DATE ROUTINE COPYBOOK                                          00780019
           COPY DPWS500.                                                00790052
      ******************************************************************00800000
      **TABLE INCLUSIONS                                                00810000
      ******************************************************************00820000
      ***DB2 COMMUNICATIONS AREA                                        00830000
           EXEC SQL                                                     00840000
                INCLUDE SQLCA                                           00850000
           END-EXEC.                                                    00860000
      ***XST_SUB_CL TABLE                                               00870041
           EXEC SQL                                                     00880000
                INCLUDE XST00014                                        00890041
           END-EXEC.                                                    00900000
      ***XST_SUB_CL_ATTR TABLE                                          00901052
           EXEC SQL                                                     00902052
                INCLUDE XST00055                                        00903052
           END-EXEC.                                                    00904052
                                                                        00910000
       LINKAGE SECTION.                                                 00920000
      ******************************************************************00930000
      **LINKAGE VARIABLES                                               00940000
      ******************************************************************00950000
       01  LV-HMRD001-RECORD               PIC X(500).                  00960041
       01  LV-RETURN-CODE                  PIC S9(04).                  00970017
010103 01  LV-CURRENT-TIMESTAMP            PIC X(26).                   00980049
                                                                        00990024
       PROCEDURE DIVISION USING LV-HMRD001-RECORD,                      01000036
                                LV-RETURN-CODE,                         01010049
010103                          LV-CURRENT-TIMESTAMP.                   01020049
      ******************************************************************01030000
       0000-MAINLINE.                                                   01040000
                                                                        01050000
            PERFORM 1000-INITIALIZATION.                                01060000
            PERFORM 2000-PROCESS-MESSAGE                                01070037
              UNTIL PS-PROCESS-COMPLETE.                                01080052
            PERFORM 9999-WRAPUP.                                        01090000
                                                                        01100000
       EJECT.                                                           01110018
      ***************************************************************** 01120000
      **INITIALIZATION AREA - ALL MOVES TO UPDATE/INSERT                01130024
      ***************************************************************** 01140000
       1000-INITIALIZATION.                                             01150000
                                                                        01160000
           MOVE '1000-INITIALIZATION'      TO PV-PARAGRAPH-NAME.        01170018
                                                                        01180018
           SET PS-PROCESS-CONTINUE         TO TRUE.                     01190020
           INITIALIZE PC-RETRY-COUNTER.                                 01200018
           INITIALIZE SD-TIMESTAMP.                                     01210042
                                                                        01220023
           MOVE LV-HMRD001-RECORD          TO HMRD001-RECORD.           01230036
           MOVE HM001-SUBCL-DEPT           TO XST00014-DEPT-NBR,        01240052
                                              XST00055-DEPT-NBR.        01241052
           MOVE HM001-SUBCL-CLASS          TO XST00014-MAJ-CL-NBR,      01250052
                                              XST00055-MAJ-CL-NBR.      01251052
           MOVE HM001-SUBCL-SUBCLASS       TO XST00014-SUB-CL-NBR,      01260052
                                              XST00055-SUB-CL-NBR.      01261052
           MOVE HM001-SUBCL-SUB-NAME       TO XST00014-SUB-CL-NM.       01270038
                                                                        01280042
           MOVE LV-CURRENT-TIMESTAMP       TO XST00014-CRE-TMST.        01290049
           MOVE LV-CURRENT-TIMESTAMP       TO XST00014-LAST-UPD-TMST,   01300052
                                              XST00055-LAST-UPD-TMST.   01301056
                                                                        01310049
      ***MERCH HIER MESSAGES ONLY CONTAIN DATE SO DEFAULT TIME TO 12AM  01320049
010103     MOVE HM001-CRE-TMST           TO SD-CURR-DTE.                01330050
010103     MOVE SD-TIMESTAMP             TO XST00014-SOR-LAST-MSG-TMST. 01340049
010103     INITIALIZE SD-TIMESTAMP.                                     01350049
                                                                        01360042
       EJECT.                                                           01370038
      ***************************************************************** 01380001
      **MAIN PROGRAM LOGIC - READS ACTION TYPE ON HMRD001 RECORD        01390044
      ***************************************************************** 01400001
       2000-PROCESS-MESSAGE.                                            01410037
                                                                        01420000
           MOVE '2000-PROCESS-MESSAGE' TO PV-PARAGRAPH-NAME.            01430037
                                                                        01440017
           EVALUATE TRUE                                                01450037
              WHEN HM001-ACTN-TYP-INSERT                                01460037
                   PERFORM 2100-INSERT-DATA                             01470037
              WHEN HM001-ACTN-TYP-UPDATE                                01480037
                   PERFORM 2200-UPDATE-DATA                             01490037
              WHEN HM001-ACTN-TYP-DELETE                                01500037
                   PERFORM 2300-DELETE-DATA                             01510039
           END-EVALUATE.                                                01520037
                                                                        01530037
       EJECT.                                                           01540037
      ***************************************************************** 01550037
      **INSERT ACTION TYPE                                              01560044
      ***************************************************************** 01570037
       2100-INSERT-DATA.                                                01580037
                                                                        01590037
           MOVE '2000-PROCESS-MESSAGE' TO PV-PARAGRAPH-NAME.            01600037
                                                                        01610037
           EXEC SQL                                                     01620018
                INSERT INTO XST_SUB_CL (DEPT_NBR                        01630041
                                      , MAJ_CL_NBR                      01640041
                                      , SUB_CL_NBR                      01650041
                                      , SUB_CL_NM                       01660041
                                      , POS_MDSE_DESC                   01670041
                                      , TAX_DFLT_IND                    01680041
                                      , DISC_ELIG_IND                   01690041
                                      , CRE_TMST                        01700041
                                      , LAST_UPD_TMST                   01710049
010103                                , SOR_LAST_MSG_TMST)              01720049
                VALUES (:XST00014-DEPT-NBR                              01730041
                      , :XST00014-MAJ-CL-NBR                            01740041
                      , :XST00014-SUB-CL-NBR                            01750041
                      , :XST00014-SUB-CL-NM                             01760041
010103                , 'MERCHANDISE'                                   01770049
010103                , 'Y'                                             01780049
010103                , 'Y'                                             01790049
                      , :XST00014-CRE-TMST                              01800041
                      , :XST00014-LAST-UPD-TMST                         01810049
010103                , :XST00014-SOR-LAST-MSG-TMST)                    01820049
           END-EXEC.                                                    01830018
                                                                        01840004
           EVALUATE TRUE                                                01850020
      ***SUCCESSFUL PROCESSING                                          01860049
              WHEN SQLCODE = ZEROS                                      01870020
                   SET PS-PROCESS-COMPLETE   TO TRUE                    01870152
                   PERFORM 2125-INSERT-ATTR                             01871052
      ***REFERENTIAL INTEGRITY ISSUES                                   01890049
              WHEN SQLCODE = -530                                       01900020
              WHEN SQLCODE = -532                                       01910049
                   SET PS-PROCESS-COMPLETE   TO TRUE                    01920018
      ***ROW EXISTS ON TABLE                                            01930049
              WHEN SQLCODE = -803                                       01940020
                   PERFORM 2150-SELECT-DATA                             01950038
                   PERFORM 2125-INSERT-ATTR                             01951052
      ***ROW/TABLE LOCK                                                 01960049
              WHEN SQLCODE = -913                                       01970028
              WHEN SQLCODE = -911                                       01980028
                   IF  PC-RETRY-COUNTER >= PC-RETRY-MAX                 01990031
                       SET PS-PROCESS-COMPLETE TO TRUE                  02000018
                   ELSE                                                 02010018
                       ADD +1                  TO PC-RETRY-COUNTER      02020027
                   END-IF                                               02030018
              WHEN OTHER                                                02040018
                   SET PS-PROCESS-COMPLETE     TO TRUE                  02050018
           END-EVALUATE.                                                02060018
                                                                        02070001
       EJECT.                                                           02080018
      ***************************************************************** 02081052
      **INSERT ATTRIBUTE RECORD - DEFAULT EXCL IND TO 'N'               02082052
      ***************************************************************** 02083052
       2125-INSERT-ATTR.                                                02084052
                                                                        02085052
           MOVE '2125-INSERT-ATTR' TO PV-PARAGRAPH-NAME.                02086052
                                                                        02087052
           EXEC SQL                                                     02088052
                INSERT INTO XST_SUB_CL_ATTR                             02089052
                                 (DEPT_NBR                              02089152
                                , MAJ_CL_NBR                            02089252
                                , SUB_CL_NBR                            02089352
                                , PLU_DWNLD_EXCL_IND                    02089752
                                , LAST_UPD_TMST)                        02089956
                VALUES (:XST00055-DEPT-NBR                              02090152
                      , :XST00055-MAJ-CL-NBR                            02090252
                      , :XST00055-SUB-CL-NBR                            02090352
                      , 'N'                                             02090752
                      , :XST00055-LAST-UPD-TMST)                        02090956
           END-EXEC.                                                    02091152
                                                                        02091252
           EVALUATE TRUE                                                02091352
      ***SUCCESSFUL PROCESSING                                          02091452
              WHEN SQLCODE = ZEROS                                      02091552
      ***ROW EXISTS ON TABLE  (DON'T CARE AS LONG AS ROW EXISTS         02091652
                OR SQLCODE = -803                                       02091752
                   SET PS-PROCESS-COMPLETE   TO TRUE                    02091852
      ***REFERENTIAL INTEGRITY ISSUES                                   02091952
              WHEN SQLCODE = -530                                       02092052
              WHEN SQLCODE = -532                                       02092152
                   SET PS-PROCESS-COMPLETE   TO TRUE                    02092252
      ***ROW/TABLE LOCK                                                 02092552
              WHEN SQLCODE = -913                                       02092652
              WHEN SQLCODE = -911                                       02092752
                   IF  PC-RETRY-COUNTER >= PC-RETRY-MAX                 02092852
                       SET PS-PROCESS-COMPLETE TO TRUE                  02092952
                   ELSE                                                 02093052
                       ADD +1                  TO PC-RETRY-COUNTER      02093152
                   END-IF                                               02093252
              WHEN OTHER                                                02093352
                   SET PS-PROCESS-COMPLETE     TO TRUE                  02093452
           END-EVALUATE.                                                02093552
                                                                        02093652
       EJECT.                                                           02093752
      ******************************************************************02094018
      *SELECT DATE FROM EXISTING RECORD FOR COMPARISON TO MESSAGE DATE  02100044
      ******************************************************************02110018
       2150-SELECT-DATA.                                                02120038
                                                                        02130018
           MOVE '2150-SELECT-DATA' TO PV-PARAGRAPH-NAME                 02140038
                                                                        02150018
           EXEC SQL                                                     02160018
                SELECT LAST_UPD_TMST                                    02170018
                INTO  :SD-TIMESTAMP-COMPARE                             02180050
                FROM   XST_SUB_CL                                       02190041
                WHERE DEPT_NBR   = :XST00014-DEPT-NBR                   02200041
                  AND MAJ_CL_NBR = :XST00014-MAJ-CL-NBR                 02210041
                  AND SUB_CL_NBR = :XST00014-SUB-CL-NBR                 02220041
           END-EXEC.                                                    02230018
                                                                        02240018
           EVALUATE TRUE                                                02250020
      ***SUCCESSFUL PROCESSING                                          02260049
              WHEN SQLCODE = ZEROS                                      02270020
                   PERFORM 2153-DATE-COMPARE                            02280038
              WHEN OTHER                                                02290018
                   SET PS-PROCESS-COMPLETE     TO TRUE                  02300018
           END-EVALUATE.                                                02310018
                                                                        02320018
       EJECT.                                                           02330018
      ******************************************************************02340018
      **COMPARE DATE OF EXISTING ROW TO MESSAGE AND UPDATE IF MESSAGE   02350024
      **        HAS A NEWER TIMESTAMP.                                  02360024
      ******************************************************************02370018
       2153-DATE-COMPARE.                                               02380038
                                                                        02390018
           MOVE '2153-DATE-COMPARE' TO PV-PARAGRAPH-NAME                02400038
                                                                        02410018
           INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              02420018
                                                                        02430018
           SET DPG53-LK-CMPR-DTE-ISO-FMT TO TRUE.                       02440018
           SET DPG52-LK-DTE-ISO-FMT       TO TRUE.                      02450033
           SET DPG51-ACTUAL-CALENDAR-ONLY TO TRUE.                      02460033
           MOVE HM001-CRE-TMST           TO DPG52-LK-DATE-INPUT.        02470042
           MOVE SD-TIMESTAMP-COMPARE     TO DPG53-LK-CMPR-DATE-INPUT.   02480050
                                                                        02490018
           CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51                02500018
                                                   DPG52                02510018
                                                   DPG53                02520018
                                                   DPG54                02530018
                                                   DPG55                02540018
                                                   DPG56.               02550018
                                                                        02560018
           EVALUATE TRUE                                                02570019
              WHEN DPG55-DAYS-DIFFERENCE = 0                            02580019
                   PERFORM 2200-UPDATE-DATA                             02590042
                           UNTIL PS-PROCESS-COMPLETE                    02600042
              WHEN DPG55-DAYS-DIFFERENCE < ZERO                         02610019
                   SET PS-PROCESS-COMPLETE     TO TRUE                  02620019
              WHEN DPG55-DAYS-DIFFERENCE > ZERO                         02630019
                   PERFORM 2200-UPDATE-DATA                             02640019
                           UNTIL PS-PROCESS-COMPLETE                    02650024
           END-EVALUATE.                                                02660019
                                                                        02670018
       EJECT.                                                           02680018
      ******************************************************************02690019
      **UPDATE ACTION TYPE                                              02700044
      ******************************************************************02710019
       2200-UPDATE-DATA.                                                02720019
                                                                        02730019
           MOVE '2200-UPDATE-DATA' TO PV-PARAGRAPH-NAME                 02740019
                                                                        02750019
           EXEC SQL                                                     02760019
              UPDATE XST_SUB_CL                                         02770038
                  SET   SUB_CL_NM     = :XST00014-SUB-CL-NM             02780041
                      , LAST_UPD_TMST = :XST00014-LAST-UPD-TMST         02790041
010103                , SOR_LAST_MSG_TMST = :XST00014-SOR-LAST-MSG-TMST 02800049
                  WHERE DEPT_NBR      = :XST00014-DEPT-NBR              02810038
                    AND MAJ_CL_NBR    = :XST00014-MAJ-CL-NBR            02820041
                    AND SUB_CL_NBR    = :XST00014-SUB-CL-NBR            02830041
           END-EXEC.                                                    02840019
                                                                        02850019
           EVALUATE TRUE                                                02860020
      ***SUCCESSFUL PROCESSING                                          02870049
              WHEN SQLCODE = ZEROS                                      02880020
                   SET PS-PROCESS-COMPLETE     TO TRUE                  02890019
      ***ROW/TABLE LOCK                                                 02900049
              WHEN SQLCODE = -911                                       02910020
              WHEN SQLCODE = -913                                       02920048
                   IF  PC-RETRY-COUNTER-2 >= PC-RETRY-MAX               02930035
                       SET PS-PROCESS-COMPLETE TO TRUE                  02940019
                   ELSE                                                 02950019
                       ADD +1                  TO PC-RETRY-COUNTER-2    02960024
                   END-IF                                               02970019
              WHEN OTHER                                                02980019
                   SET PS-PROCESS-COMPLETE     TO TRUE                  02990038
           END-EVALUATE.                                                03000019
                                                                        03010019
       EJECT.                                                           03020019
      ******************************************************************03030039
      **DELETE TYPE ACTION                                              03040044
      **       THERE IS A CASCADE DELETE ON SUB CLASS ATTRIBUTE         03041053
      ******************************************************************03050039
       2300-DELETE-DATA.                                                03060039
                                                                        03070039
           MOVE '2300-DELETE-DATA' TO PV-PARAGRAPH-NAME                 03080039
                                                                        03090039
           EXEC SQL                                                     03100041
                DELETE FROM XST_SUB_CL                                  03110041
                WHERE DEPT_NBR   = :XST00014-DEPT-NBR                   03120041
                  AND MAJ_CL_NBR = :XST00014-MAJ-CL-NBR                 03130041
                  AND SUB_CL_NBR = :XST00014-SUB-CL-NBR                 03140041
           END-EXEC.                                                    03150041
                                                                        03160041
           EVALUATE TRUE                                                03170041
      ***SUCCESSFUL PROCESSING                                          03180049
              WHEN SQLCODE = ZEROS                                      03190041
                   SET PS-PROCESS-COMPLETE     TO TRUE                  03200041
      ***NO ROW TO DELETE                                               03210049
              WHEN SQLCODE = +100                                       03220045
                   SET PS-PROCESS-COMPLETE     TO TRUE                  03230045
              WHEN SQLCODE = -911                                       03240041
              WHEN SQLCODE = -913                                       03250047
                   IF  PC-RETRY-COUNTER-2 >= PC-RETRY-MAX               03260041
                       SET PS-PROCESS-COMPLETE TO TRUE                  03270041
                   ELSE                                                 03280041
                       ADD +1                  TO PC-RETRY-COUNTER-2    03290041
                   END-IF                                               03300041
              WHEN OTHER                                                03310041
                   SET PS-PROCESS-COMPLETE     TO TRUE                  03320041
           END-EVALUATE.                                                03330041
                                                                        03340041
       EJECT.                                                           03350039
      ******************************************************************03360000
      **PASS SQLCODE TO CALLING AND EXIT PROGRAM                        03370024
      ******************************************************************03380000
       9999-WRAPUP.                                                     03390000
                                                                        03400000
           MOVE '9999-WRAPUP' TO PV-PARAGRAPH-NAME                      03410018
                                                                        03420000
           MOVE SQLCODE       TO LV-RETURN-CODE.                        03430018
           DISPLAY 'XSKUP017 - DEPT NBR: ' XST00014-DEPT-NBR            03440046
                             ' MAJ CLASS: ' XST00014-MAJ-CL-NBR         03450052
                             ' SUB CLASS: ' XST00014-SUB-CL-NBR         03460052
                             ' WITH RETURN-CODE ' LV-RETURN-CODE.       03470052
           EXIT PROGRAM.                                                03480000
                                                                        03490000
       EJECT.                                                           03500018
