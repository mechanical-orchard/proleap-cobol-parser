       IDENTIFICATION DIVISION.                                         00010000
       PROGRAM-ID.    MLKUT456.                                         00020000
       AUTHOR.        PAUL KEBER.                                       00030000
       INSTALLATION.  KOHLS DEPARTMENT STORES.                          00040000
       DATE-WRITTEN.  02-22-2000.                                       00050000
       DATE-COMPILED.                                                   00060000
      ******************************************************************00070000
      *                                                                 00080000
      * MLKUT456 - WEEKLY MAJOR CLASS TABLE (TWKMCL) RECALC EXTRACT     00090007
      *                                                                 00100000
      ******************************************************************00101005
      * THIS PROGRAM WILL CREATE THE EXTRACT FOR THE RECALC PROGRAM     00110000
      * ON TABLE TWKMCL.  IT WILL FIND ALL DEPARTMENT/MAJOR CLASS       00120005
      * COMBINATIONS ON THE TMNMCL DB2 TABLE FOR THE CURRENT AND        00130005
      * PREVIOUS FISCAL MONTHS WHICH WILL BE USED TO PROCESS THE TWKMCL 00131005
      * TABLE RECALC.                                                   00132005
      ******************************************************************00140000
      *                                                                 00150000
       ENVIRONMENT DIVISION.                                            00160000
      *                                                                 00170000
       CONFIGURATION SECTION.                                           00180000
      *                                                                 00190000
       SOURCE-COMPUTER.        IBM-3090.                                00200000
       OBJECT-COMPUTER.        IBM-3090.                                00210000
      *                                                                 00220000
       INPUT-OUTPUT SECTION.                                            00230000
       FILE-CONTROL.                                                    00240000
                                                                        00250000
           SELECT WKMCL-EXTR-FILE                                       00260000
               ASSIGN TO OUT01.                                         00270000
                                                                        00280000
      ******************************************************************00290000
       DATA DIVISION.                                                   00300000
      ******************************************************************00310000
                                                                        00320000
       FILE SECTION.                                                    00330000
                                                                        00340000
       FD  WKMCL-EXTR-FILE                                              00350000
           RECORDING MODE IS F                                          00360000
           LABEL RECORDS ARE STANDARD                                   00370000
           BLOCK CONTAINS 0 RECORDS.                                    00380000
                                                                        00390000
       01  WKMCL-EXTR-REC              PIC X(10).                       00400004
                                                                        00410000
      *                                                                 00420000
      ******************************************************************00430000
       WORKING-STORAGE SECTION.                                         00440000
      ******************************************************************00450000
                                                                        00460000
       01  PS-PROGRAM-SWITCHES.                                         00470000
           05  PS-TMNMCL-DONE          PIC X       VALUE 'N'.           00480005
               88  PS-TMNMCL-IS-DONE               VALUE 'Y'.           00490005
               88  PS-TMNMCL-IS-NOT-DONE           VALUE 'N'.           00500005
                                                                        00510000
       01  PA-PROGRAM-ACCUMULATORS                 COMP-3.              00520000
           05  PA-TMNMCL-ROWS-FETCHED  PIC S9(13)  VALUE ZERO.          00530005
           05  PA-OUTPUT-RECS-WRITTEN  PIC S9(13)  VALUE ZERO.          00540000
                                                                        00550000
       01  CD-COUNTER-DISPLAY.                                          00560000
           05  CD-COUNT-HOLD1          PIC Z,ZZZ,ZZZ,ZZZ,ZZ9.           00570000
                                                                        00580000
       01 ABEND-AREAS.                                                  00590000
           05 ABEND-CODE               PIC S9(04)  VALUE ZERO           00600000
                                                   COMP SYNC.           00610000
               88  AC-BAD-DATA                     VALUE +4003.         00620000
               88  AC-DB2-ERROR                    VALUE +4013.         00630000
           05  AA-ABEND-LIT            PIC X(40)   VALUE                00640000
                 '*****       ABEND'.                                   00650000
           05  AA-PROGRAM-LIT          PIC X(40)   VALUE                00660000
                   '*****   PROGRAM: MLKUT456'.                         00670000
           05  AA-PARAGRAPH-LIT.                                        00680000
               10  FILLER              PIC X(17)   VALUE                00690000
                   '***** PARAGRAPH: '.                                 00700000
               10  AA-PARAGRAPH-NAME   PIC X(35)   VALUE SPACES.        00710000
           05  AA-MESSAGE-LINE.                                         00720000
               10  FILLER              PIC X(06)   VALUE '*****'.       00730000
               10  AA-MESSAGE          PIC X(127)  VALUE SPACES.        00740000
           05  AA-DB2-ERROR-LIT        PIC X(40)   VALUE                00750000
                   '*****    DB2 ERROR'.                                00760000
           05  AA-DB2-OPERATION-LIT.                                    00770000
               10  FILLER              PIC X(17)   VALUE                00780000
                   '***** OPERATION: '.                                 00790000
               10  AA-DB2-OPERATION.                                    00800000
                   15  AA-DB2-OP-1     PIC X(25)   VALUE SPACES.        00810000
                   15  AA-DB2-OP-2     PIC X(25)   VALUE SPACES.        00820000
           05  AA-DB2-TABLE-1          PIC X(08)   VALUE SPACES.        00830000
           05  AA-DB2-TABLE-2          PIC X(08)   VALUE SPACES.        00840000
           05  AA-DB2-TABLE-3          PIC X(08)   VALUE SPACES.        00850000
           05  AA-DB2-TABLE-4          PIC X(08)   VALUE SPACES.        00860000
                                                                        00870000
      ***                                                               00880005
       01  EXTR-RECORD                             VALUE SPACES.        00890004
           05  EXTR-DEPT-NBR    PIC X(03).                              00900000
           05  EXTR-MAJ-CL-NBR  PIC X(02).                              00910000
           05  FILLER           PIC X(05).                              00911004
       EJECT                                                            00920000
                                                                        00930000
      ******************************************************************00940000
      *  DB2 ERROR MESSAGES FORMAT AREA.                                00950000
      ******************************************************************00960000
           COPY DPWS004.                                                00970000
                                                                        00980000
      ******************************************************************00990000
      *  DB2 ERRORS                                                     01000000
      ******************************************************************01010000
           COPY SQLCA2.                                                 01020000
                                                                        01030000
      ******************************************************************01040000
      *  DB2 COMMUNICATION AREA                                         01050000
      ******************************************************************01060000
           EXEC SQL                                                     01070000
                INCLUDE SQLCA                                           01080000
           END-EXEC.                                                    01090000
                                                                        01100000
      ******************************************************************01110000
      *  DB2 TMNMCL TABLE LAYOUT                                        01120005
      ******************************************************************01130000
           EXEC SQL                                                     01140000
                INCLUDE TMNMCL                                          01150005
           END-EXEC.                                                    01160000
                                                                        01170000
      ****************************************************              01170100
      * M/L DATE TABLE AND CURRENT OPEN FISCAL DATE INFO *              01170200
      ****************************************************              01170300
           EXEC SQL                                                     01170400
               INCLUDE TDTATTR                                          01170500
           END-EXEC.                                                    01170600
                                                                        01170700
      ****************************************************              01170800
      * M/L DATE CONTROL INFO                            *              01170900
      ****************************************************              01171000
           EXEC SQL                                                     01172000
               INCLUDE TMLCNTL                                          01173000
           END-EXEC.                                                    01174000
                                                                        01175000
      ******************************************************************01176000
      *  DB2 TMNMCL CURSOR                                              01177005
      ******************************************************************01178000
           EXEC SQL                                                     01179000
               DECLARE TMNMCL_CURSOR CURSOR FOR                         01180005
               SELECT DISTINCT DEPT_NBR                                 01190000
                              ,MAJ_CL_NBR                               01200000
               FROM TMNMCL                                              01210005
                   ,TMLCNTL                                             01220000
               WHERE (FSCL_MN_END_DTE BETWEEN                           01230005
                                   OPN_FSCL_MN_DTE                      01240000
                               AND MXPSTG_FSCL_MN_DTE) OR               01250000
                    ((FSCL_MN_END_DTE BETWEEN                           01260005
                      :DTATTR-PFM-END-DTE AND                           01270000
                      MXPSTG_FSCL_MN_DTE) AND                           01280000
                       (END_INV_RTL_AMT  <> 0  OR                       01290000
                        END_INV_COST_AMT <> 0))                         01300000
               ORDER BY DEPT_NBR, MAJ_CL_NBR                            01310000
           END-EXEC.                                                    01320000
                                                                        01330000
       EJECT                                                            01340000
                                                                        01350000
      ******************************************************************01360000
       PROCEDURE DIVISION.                                              01370000
      ******************************************************************01380000
                                                                        01390000
      ******************************************************************01400000
       A000-MAIN-MODULE.                                                01410000
      ******************************************************************01420000
      *                                                                 01430000
           PERFORM B000-INITIALIZE.                                     01440000
                                                                        01450000
           PERFORM B100-PROCESS-DATA.                                   01460000
                                                                        01470000
           PERFORM B900-EOJ-ROUTINE.                                    01480000
                                                                        01490000
           STOP RUN.                                                    01500000
                                                                        01510000
       EJECT                                                            01520000
                                                                        01530000
      ******************************************************************01540000
       B000-INITIALIZE.                                                 01550000
      ******************************************************************01560000
      *                                                                 01570000
           OPEN OUTPUT WKMCL-EXTR-FILE.                                 01580000
           PERFORM 7100-SELECT-DB2-DATES.                               01590000
                                                                        01600000
                                                                        01610000
       EJECT                                                            01620000
                                                                        01630000
      ******************************************************************01640000
       B100-PROCESS-DATA.                                               01650000
      ******************************************************************01660000
      *                                                                 01670000
           PERFORM Z210-OPEN-CURSOR-TMNMCL.                             01680005
                                                                        01690000
           PERFORM Z220-FETCH-TMNMCL.                                   01700005
                                                                        01710000
           PERFORM                                                      01720000
             UNTIL PS-TMNMCL-IS-DONE                                    01730005
               PERFORM C100-WRITE-EXTRACT                               01740000
               PERFORM Z220-FETCH-TMNMCL                                01750005
           END-PERFORM.                                                 01760000
                                                                        01770000
           PERFORM Z230-CLOSE-CURSOR-TMNMCL.                            01780005
                                                                        01790000
       EJECT                                                            01800000
                                                                        01810000
      ******************************************************************01820000
       C100-WRITE-EXTRACT.                                              01830000
      ******************************************************************01840000
      *                                                                 01850000
           MOVE MNMCL-DEPT-NBR         TO EXTR-DEPT-NBR.                01860006
           MOVE MNMCL-MAJ-CL-NBR       TO EXTR-MAJ-CL-NBR.              01870006
           WRITE WKMCL-EXTR-REC                                         01880000
               FROM EXTR-RECORD.                                        01890000
           ADD 1                       TO PA-OUTPUT-RECS-WRITTEN.       01900000
                                                                        01910000
       EJECT                                                            01920000
                                                                        01930000
      ******************************************************************01940000
       B900-EOJ-ROUTINE.                                                01950000
      ******************************************************************01960000
      *                                                                 01970000
           DISPLAY ' '.                                                 01980000
           DISPLAY '  PROGRAM MLKUT456 PROCESSING SUMMARY'.             01990000
           DISPLAY '  -----------------------------------'.             02000000
           DISPLAY ' '.                                                 02010000
      *                                                                 02020000
           MOVE PA-TMNMCL-ROWS-FETCHED TO CD-COUNT-HOLD1.               02030005
           DISPLAY 'TMNMCL ROWS FETCHED =     ' CD-COUNT-HOLD1.         02040005
      *                                                                 02050000
           MOVE PA-OUTPUT-RECS-WRITTEN TO CD-COUNT-HOLD1.               02060000
           DISPLAY 'EXTRACT RECORDS WRITTEN = ' CD-COUNT-HOLD1.         02070003
      *                                                                 02080000
           DISPLAY ' '.                                                 02090000
                                                                        02100000
           CLOSE WKMCL-EXTR-FILE.                                       02110000
                                                                        02120000
       EJECT                                                            02130000
                                                                        02140000
       EJECT                                                            02150000
                                                                        02160000
      ******************************************************************02170000
       Z210-OPEN-CURSOR-TMNMCL.                                         02180005
      ******************************************************************02190000
      *                                                                 02200000
           EXEC SQL                                                     02210000
               OPEN TMNMCL_CURSOR                                       02220005
           END-EXEC.                                                    02230000
                                                                        02240000
           EVALUATE TRUE                                                02250000
               WHEN SQLCODE < 0                                         02260000
                   MOVE 'Z210-OPEN-CURSOR-TMNMCL'                       02270005
                                       TO AA-PARAGRAPH-NAME             02280000
                   MOVE 'TMNMCL TABLE ERROR'                            02290005
                                       TO AA-MESSAGE                    02300000
                   MOVE 'OPEN CURSOR'  TO AA-DB2-OPERATION              02310000
                   PERFORM Z998-SQL-ERROR                               02320000
               WHEN SQLCODE > 0                                         02330000
               WHEN SQLWARN0 NOT = SPACES                               02340000
                   MOVE 'Z210-OPEN-CURSOR-TMNMCL'                       02350005
                                       TO AA-PARAGRAPH-NAME             02360000
                   MOVE 'TMNMCL TABLE WARNING'                          02370005
                                       TO AA-MESSAGE                    02380000
                   MOVE 'OPEN CURSOR'  TO AA-DB2-OPERATION              02390000
                   PERFORM Z998-SQL-ERROR                               02400000
           END-EVALUATE.                                                02410000
                                                                        02420000
       EJECT                                                            02430000
                                                                        02440000
      ******************************************************************02450000
       Z220-FETCH-TMNMCL.                                               02460005
      ******************************************************************02470000
      *                                                                 02480000
           EXEC SQL                                                     02490000
               FETCH TMNMCL_CURSOR                                      02500005
                INTO :MNMCL-DEPT-NBR                                    02510005
                    ,:MNMCL-MAJ-CL-NBR                                  02520005
           END-EXEC.                                                    02540000
                                                                        02550000
           EVALUATE TRUE                                                02560000
               WHEN SQLCODE = 0                                         02570000
                   ADD +1              TO PA-TMNMCL-ROWS-FETCHED        02580005
               WHEN SQLCODE = +100                                      02590000
                   MOVE 'Y'            TO PS-TMNMCL-DONE                02600005
               WHEN SQLCODE < 0                                         02610000
                   MOVE 'Z220-FETCH-TMNMCL'                             02620005
                                       TO AA-PARAGRAPH-NAME             02630000
                   MOVE 'TMNMCL TABLE ERROR'                            02640005
                                       TO AA-MESSAGE                    02650000
                   MOVE 'FETCH'        TO AA-DB2-OPERATION              02660000
                   PERFORM Z998-SQL-ERROR                               02670000
               WHEN ((SQLCODE > 0) AND (SQLCODE NOT = +100))            02680000
               WHEN SQLWARN0 NOT = SPACES                               02690000
                   MOVE 'Z220-FETCH-TMNMCL'                             02700005
                                       TO AA-PARAGRAPH-NAME             02710000
                   MOVE 'TMNMCL TABLE WARNING'                          02720005
                                       TO AA-MESSAGE                    02730000
                   MOVE 'FETCH'        TO AA-DB2-OPERATION              02740000
                   PERFORM Z998-SQL-ERROR                               02750000
           END-EVALUATE.                                                02760000
                                                                        02770000
       EJECT                                                            02780000
                                                                        02790000
      ******************************************************************02800000
       Z230-CLOSE-CURSOR-TMNMCL.                                        02810005
      ******************************************************************02820000
      *                                                                 02830000
           EXEC SQL                                                     02840000
               CLOSE TMNMCL_CURSOR                                      02850005
           END-EXEC.                                                    02860000
                                                                        02870000
           EVALUATE TRUE                                                02880000
               WHEN SQLCODE < 0                                         02890000
                   MOVE 'Z230-CLOSE-CURSOR-TMNMCL'                      02900005
                                       TO AA-PARAGRAPH-NAME             02910000
                   MOVE 'TMNMCL TABLE ERROR'                            02920005
                                       TO AA-MESSAGE                    02930000
                   MOVE 'CLOSE CURSOR' TO AA-DB2-OPERATION              02940000
                   PERFORM Z998-SQL-ERROR                               02950000
               WHEN SQLCODE > 0                                         02960000
               WHEN SQLWARN0 NOT = SPACES                               02970000
                   MOVE 'Z230-CLOSE-CURSOR-TMNMCL'                      02980005
                                       TO AA-PARAGRAPH-NAME             02990000
                   MOVE 'TMNMCL TABLE WARNING'                          03000005
                                       TO AA-MESSAGE                    03010000
                   MOVE 'CLOSE CURSOR' TO AA-DB2-OPERATION              03020000
                   PERFORM Z998-SQL-ERROR                               03030000
           END-EVALUATE.                                                03040000
                                                                        03050000
       EJECT                                                            03060000
                                                                        03070000
       7100-SELECT-DB2-DATES.                                           03080000
      *                                                                 03090000
           EXEC SQL                                                     03100000
               SELECT  PFM_END_DTE                                      03110000
                INTO  :DTATTR-PFM-END-DTE                               03120000
                FROM TDTATTR                                            03121000
                    ,TMLCNTL                                            03121100
                WHERE KY_DTE  = OPN_FSCL_MN_DTE                         03121200
           END-EXEC.                                                    03121300
      *                                                                 03121400
           EVALUATE SQLCODE                                             03121500
               WHEN 0                                                   03121600
                   DISPLAY 'DTATTR-PFM-END-DTE: '                       03121700
                            DTATTR-PFM-END-DTE                          03121800
      *        WHEN +100                                                03121900
      *            DISPLAY 'NO ROWS QUALIFY FOR RECALCULATION'          03122000
               WHEN OTHER                                               03123000
                  MOVE '7100-SELECT-DB2-DATES'                          03124000
                                       TO AA-PARAGRAPH-NAME             03124100
                   PERFORM Z998-SQL-ERROR                               03124200
           END-EVALUATE.                                                03124300
      *                                                                 03124400
      *                                                                 03124500
      ******************************************************************03124600
       Z998-SQL-ERROR.                                                  03124700
      ******************************************************************03124800
      *                                                                 03124900
                                                                        03125000
           CLOSE WKMCL-EXTR-FILE.                                       03126000
                                                                        03127000
           DISPLAY AA-ABEND-LIT.                                        03128000
           DISPLAY AA-DB2-ERROR-LIT.                                    03129000
           DISPLAY AA-PROGRAM-LIT.                                      03130000
           DISPLAY AA-PARAGRAPH-LIT.                                    03140000
           DISPLAY AA-MESSAGE-LINE.                                     03150000
           DISPLAY AA-DB2-OPERATION-LIT.                                03160000
           SET AC-DB2-ERROR TO TRUE.                                    03170000
           MOVE +4013                  TO ABEND-CODE.                   03180000
                                                                        03190000
           COPY DPPD004.                                                03200000
           CALL 'ILBOABN0' USING ABEND-CODE.                            03210000
                                                                        03220000
