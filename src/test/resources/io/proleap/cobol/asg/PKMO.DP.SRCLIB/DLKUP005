000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400                                                                  00040000
000500 PROGRAM-ID.    DLKUP005.                                         00050004
000600 AUTHOR.        THERESE RAMSEYER.                                 00060004
000700 INSTALLATION.  KOHLS.                                            00070000
000800 DATE-WRITTEN   FEBRUARY 2004.                                    00080004
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100******************************************************************00110000
001200*  THIS PROGRAM READS AN INPUT FILE CONTAINING ASGMT PURGE DATA, *00120004
001300*  AND DELETES ASGMT ROWS FROM DLT_ASGMT & DLT_TEM_ASGMT.         00130004
001400******************************************************************00140000
001500                                                                  00150000
001600******************************************************************00160000
001700 ENVIRONMENT DIVISION.                                            00170000
001800******************************************************************00180000
001900                                                                  00190000
002000 CONFIGURATION SECTION.                                           00200000
002100                                                                  00210000
002200 SOURCE-COMPUTER.        IBM-3090.                                00220000
002300 OBJECT-COMPUTER.        IBM-3090.                                00230000
002400                                                                  00240000
002500 INPUT-OUTPUT SECTION.                                            00250000
002600                                                                  00260000
002700 FILE-CONTROL.                                                    00270000
002800                                                                  00280000
002900     SELECT ASGMT-FILE                                            00290004
003000         ASSIGN TO INP01.                                         00300000
003100                                                                  00310000
003200******************************************************************00320000
003300 DATA DIVISION.                                                   00330000
003400******************************************************************00340000
003500                                                                  00350000
003600 FILE SECTION.                                                    00360000
003700                                                                  00370000
003800 FD  ASGMT-FILE                                                   00380004
003900     RECORDING MODE IS F                                          00390000
004000     LABEL RECORDS ARE STANDARD                                   00400000
004100     BLOCK CONTAINS 0 RECORDS.                                    00410000
004200                                                                  00420000
004300 01  ASGMT-RECORD                     PIC X(050).                 00430021
004400                                                                  00440000
004500*                                                                 00450000
004600******************************************************************00460000
004700 WORKING-STORAGE SECTION.                                         00470000
004800******************************************************************00480000
004900******************************************************************00490000
005000*  RECORD LAYOUT FOR PURGE ASGMT PROCESSING                       00500021
005100******************************************************************00510000
005200     COPY DLRD005.                                                00520021
005201                                                                  00520121
005210******************************************************************00521021
005220*  DB2 FORMATTED MESSAGE AREA                                     00522021
005230******************************************************************00523021
005240     COPY DPWS004.                                                00524021
005300     COPY SQLCA2.                                                 00530000
005400******************************************************************00540000
005500*  COMMUNICATIONS AREA FOR DB2                                    00550000
005600******************************************************************00560000
005700                                                                  00570004
005800     EXEC SQL                                                     00580000
005900          INCLUDE SQLCA                                           00590000
006000     END-EXEC.                                                    00600000
006100                                                                  00610004
006200******************************************************************00620000
006300*  COBOL DECLARATION FOR DLT_ASGMT                                00630004
006400******************************************************************00640000
006500     EXEC SQL                                                     00650000
006600          INCLUDE DLT00004                                        00660004
006700     END-EXEC.                                                    00670000
006800                                                                  00680004
006900******************************************************************00690000
007000*  COBOL DECLARATION FOR DLT_TEM_ASGMT                            00700004
007100******************************************************************00710000
007200     EXEC SQL                                                     00720000
007300          INCLUDE DLT00003                                        00730004
007400     END-EXEC.                                                    00740000
007500*                                                                 00750000
007600 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00760000
007700                                                   COMP SYNC.     00770000
007800                                                                  00780000
007900 01  DATABASE-KEYS.                                               00790000
008000     05  DK-EVNT-EXPRT-ID            PIC S9(09)    COMP.          00800000
008100                                                                  00810000
008200 01  PS-PROGRAM-SWITCHES.                                         00820000
008300     05  PS-EOF-SW                   PIC  X(01)    VALUE 'N'.     00830000
008400         88  PS-EOF                                VALUE 'Y'.     00840000
008500         88  PS-NOT-EOF                            VALUE 'N'.     00850000
008600     05  PS-DELETE-SUCCESSFUL-SW     PIC  X(01)    VALUE 'N'.     00860005
008700         88  PS-DELETE-SUCCESSFUL                  VALUE 'Y'.     00870005
008800         88  PS-DELETE-NOT-SUCCESSFUL              VALUE 'N'.     00880005
008900                                                                  00890000
009000 01  PC-PROGRAM-CONSTANTS.                                        00900000
009100     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00910000
009200         'DLKUP005'.                                              00920004
009210     05  PC-COMMIT-HOLD              PIC 9(3)      VALUE 100.     00921005
009300                                                                  00930000
009400 01  PA-PROGRAM-ACCUMULATORS.                                     00940005
009500     05  PA-COMMIT-COUNT             PIC  S9(09)  VALUE +0 COMP-3.00950005
009510     05  PA-COMMIT-COUNTER           PIC  S9(09)  VALUE +0 COMP-3.00951005
009600     05  PA-COMMIT-TOTAL             PIC  S9(09)  VALUE +0 COMP-3.00960005
009700     05  PA-RECS-READ                PIC  S9(09)  VALUE +0 COMP-3.00970005
009900     05  PA-ASGMT-DELETES            PIC  S9(09)  VALUE +0 COMP-3.00990005
010300     05  PA-ASGMT-DEL-FAIL           PIC  S9(09)  VALUE +0 COMP-3.01030005
010700     05  PA-ASGMT-NOT-FOUND          PIC  S9(09)  VALUE +0 COMP-3.01070005
011000                                                                  01100005
011600 01  PV-PROGRAM-VARIABLES.                                        01160005
011700     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  01170005
011800     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  01180000
011900     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             01190000
011910     05  PV-DISPLAY-NBR              PIC ZZZ,ZZZ,ZZ9.             01191009
011920     05  PV-ASGMT-STRT-DTE           PIC  X(10)    VALUE SPACES.  01192022
011930     05  PV-ASGMT-NBR-TXT            PIC  X(10)    VALUE SPACES.  01193022
011940     05  PV-ASGMT-NBR-SEQ-NBR        PIC  S9(9) COMP VALUE +0.    01194024
012000                                                                  01200000
012100 01  PV-COMMIT-INFO.                                              01210000
012200     05  FILLER                      PIC X(10) VALUE 'ASGMT KEY:'.01220006
012400     05  PV-COMMIT-KEY.                                           01240000
012500         10  PV-COMMIT-STRT-DTE      PIC X(10) VALUE SPACE.       01250005
012600         10  FILLER                  PIC X(01) VALUE SPACE.       01260000
012700         10  PV-COMMIT-NBR-TXT       PIC X(10) VALUE SPACE.       01270005
012800         10  FILLER                  PIC X(01) VALUE SPACE.       01280000
012810         10  PV-COMMIT-NBR-SEQ-NBR   PIC 9(09) VALUE 0.           01281005
013300                                                                  01330005
013500******************************************************************01350000
013600 PROCEDURE DIVISION.                                              01360000
013700******************************************************************01370000
013800                                                                  01380000
013900 0000-PROGRAM-MAINLINE.                                           01390000
014000******************************************************************01400000
014100* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     01410000
014200*      PROGRAM.                                                   01420000
014300******************************************************************01430000
014400                                                                  01440000
014500     PERFORM 1000-INITIALIZE.                                     01450000
014600     PERFORM 2000-PROCESS-INPUT                                   01460000
014700       UNTIL PS-EOF.                                              01470000
014800     PERFORM 9000-EOJ-ROUTINE.                                    01480000
014900                                                                  01490000
015000     STOP RUN.                                                    01500000
015100                                                                  01510005
015200******************************************************************01520000
015300*  DO FIRST TIME PROGRAM INITIALIZATION TASKS.                    01530000
015400******************************************************************01540000
015500 1000-INITIALIZE.                                                 01550005
015600                                                                  01560000
015700     OPEN INPUT  ASGMT-FILE.                                      01570005
015800                                                                  01580000
015900     MOVE +0 TO PA-COMMIT-COUNTER                                 01590005
015910                PA-COMMIT-TOTAL                                   01591005
016000                                                                  01600000
016100     PERFORM 7000-READ-INPUT.                                     01610000
016200                                                                  01620000
016300******************************************************************01630000
016400*  PROCESS THE INPUT FILE AND UPDATE THE EXPRT_STAT_CDE ON THE    01640000
016500*  CORRESPONDING TABLE (EITHER SUT_BUS_EVNT_EXPRT OR              01650000
016600*  PCT_BUS_EVNT_EXPRT) TO A VALUE OF "P" WHICH INDICATES THAT     01660000
016700*  THE ROW HAS BEEN EXTRACTED AND PUBLISHED.                      01670000
016800******************************************************************01680000
016900 2000-PROCESS-INPUT.                                              01690005
017000                                                                  01700000
017100     PERFORM 8000-DELETE-ASGMT.                                   01710005
018700                                                                  01870000
018800     IF PA-COMMIT-COUNTER > PC-COMMIT-HOLD                        01880005
018900         EXEC SQL                                                 01890000
019000            COMMIT                                                01900000
019100         END-EXEC                                                 01910000
019200                                                                  01920000
019300         IF SQLCODE NOT = +0                                      01930000
019400             DISPLAY '### COMMIT FAILED ! ###'                    01940000
019500             PERFORM 9100-SQL-ABEND                               01950000
019600         END-IF                                                   01960000
019700                                                                  01970000
019800         ADD PA-COMMIT-COUNTER           TO PA-COMMIT-TOTAL       01980005
019900         MOVE DL005-ASGMT-STRT-DTE       TO PV-COMMIT-STRT-DTE    01990021
019901         MOVE DL005-ASGMT-NBR-TXT        TO PV-COMMIT-NBR-TXT     01990121
019910         MOVE DL005-ASGMT-NBR-SEQ-NBR    TO PV-COMMIT-NBR-SEQ-NBR 01991021
020000                                                                  02000000
020200         DISPLAY 'COMMIT TAKEN: ' PV-COMMIT-INFO                  02020000
020300                                                                  02030000
020400         MOVE +0 TO PA-COMMIT-COUNTER                             02040006
020500     END-IF.                                                      02050000
020600                                                                  02060000
020700     PERFORM 7000-READ-INPUT.                                     02070000
020800                                                                  02080000
020900******************************************************************02090000
021000*  READ   THE INPUT FILE                                          02100000
021100******************************************************************02110000
021200 7000-READ-INPUT.                                                 02120005
021300                                                                  02130005
021310     INITIALIZE DL005-ASGMT-PURGE-LAYOUT.                         02131021
021320                                                                  02132021
021400     READ ASGMT-FILE INTO DL005-ASGMT-PURGE-LAYOUT                02140021
021500       AT END                                                     02150008
021510         SET PS-EOF  TO TRUE                                      02151008
021600       NOT AT END                                                 02160008
021610         ADD +1 TO PA-RECS-READ.                                  02161008
021700                                                                  02170000
021800                                                                  02180000
021810******************************************************************02181005
021820*  DELETE FROM DLT_ASGMT                                          02182005
021830******************************************************************02183005
021900 8000-DELETE-ASGMT.                                               02190005
022000                                                                  02200000
022010     MOVE DL005-ASGMT-STRT-DTE    TO PV-ASGMT-STRT-DTE.           02201022
022011     MOVE DL005-ASGMT-NBR-TXT     TO PV-ASGMT-NBR-TXT.            02201122
022012     MOVE DL005-ASGMT-NBR-SEQ-NBR TO PV-ASGMT-NBR-SEQ-NBR.        02201222
022020                                                                  02202022
022100     EXEC SQL                                                     02210019
022200         DELETE FROM DLT_ASGMT                                    02220019
022300          WHERE ASGMT_STRT_DTE    = :PV-ASGMT-STRT-DTE            02230022
022400            AND ASGMT_NBR_TXT     = :PV-ASGMT-NBR-TXT             02240022
022500            AND ASGMT_NBR_SEQ_NBR = :PV-ASGMT-NBR-SEQ-NBR         02250022
022600     END-EXEC.                                                    02260019
022700                                                                  02270000
022800     EVALUATE TRUE                                                02280000
022900         WHEN SQLCODE = 0                                         02290000
023000             ADD +1           TO PA-ASGMT-DELETES                 02300015
023100             ADD +1           TO PA-COMMIT-COUNTER                02310005
023200         WHEN SQLCODE = +100                                      02320000
023300             ADD +1           TO PA-ASGMT-NOT-FOUND               02330005
023400             DISPLAY ' '                                          02340005
023410             DISPLAY '*******************************************'02341005
023420             DISPLAY '  ASGMT DELETE NOT FOUND (+100)'            02342005
023430             DISPLAY '  ASGMT STRT DTE   : ' DL005-ASGMT-STRT-DTE 02343021
023440             DISPLAY '  ASGMT NBR TXT    : ' DL005-ASGMT-NBR-TXT  02344021
023441             MOVE DL005-ASGMT-NBR-SEQ-NBR TO PV-DISPLAY-NBR       02344121
023450             DISPLAY '  ASGMT NBR SEQ NBR: ' PV-DISPLAY-NBR       02345009
023460             DISPLAY '*******************************************'02346005
023500         WHEN SQLCODE = -904                                      02350000
023600         WHEN SQLCODE = -911                                      02360005
023610         WHEN SQLCODE = -913                                      02361005
023700             ADD +1           TO PA-ASGMT-DEL-FAIL                02370005
023800             DISPLAY ' '                                          02380005
023900             DISPLAY '*******************************************'02390005
023910             DISPLAY '  ASGMT DELETE FAIL ( -904, -911, -913)'    02391005
023920             DISPLAY '  ASGMT STRT DTE   : ' DL005-ASGMT-STRT-DTE 02392021
023930             DISPLAY '  ASGMT NBR TXT    : ' DL005-ASGMT-NBR-TXT  02393021
023950             MOVE DL005-ASGMT-NBR-SEQ-NBR TO PV-DISPLAY-NBR       02395021
023960             DISPLAY '  ASGMT NBR SEQ NBR: ' PV-DISPLAY-NBR       02396009
024000             DISPLAY '*******************************************'02400005
024200         WHEN SQLCODE < 0                                         02420000
024300         WHEN SQLCODE > 0                                         02430000
024400         WHEN SQLWARN0 = 'W'                                      02440000
024500             MOVE '8000-DELETE-ASGMT'                             02450005
024600                         TO PV-PARAGRAPH-NAME                     02460000
024700             MOVE 'DELETE FROM DLT_ASGMT'                         02470005
024800                         TO PV-DB2-OPERATION-ATTEMPTED            02480000
024900             PERFORM 9100-SQL-ABEND                               02490000
025000     END-EVALUATE.                                                02500000
025100                                                                  02510000
028600******************************************************************02860000
028700*  CLOSE OUTPUT FILE.  DISPLAY RECORD COUNTS                      02870000
028800******************************************************************02880000
028810 9000-EOJ-ROUTINE.                                                02881005
028820                                                                  02882005
028900     CLOSE ASGMT-FILE.                                            02890005
028910                                                                  02891005
028920     DISPLAY SPACE.                                               02892005
028930     DISPLAY '****************************************'.          02893005
028940     DISPLAY '**    DLKUP005 SUMMARY STATISTICS     **'.          02894005
028950     DISPLAY '****************************************'.          02895005
029000     MOVE PA-RECS-READ            TO PV-DISPLAY-COUNT.            02900005
029100     DISPLAY 'TOTAL RECORDS READ            : '  PV-DISPLAY-COUNT.02910018
029110                                                                  02911015
029200     MOVE PA-ASGMT-DELETES        TO PV-DISPLAY-COUNT.            02920005
029300     DISPLAY 'TOTAL ASGMT DELETES           : '  PV-DISPLAY-COUNT.02930005
029310                                                                  02931005
029350     MOVE PA-ASGMT-DEL-FAIL       TO PV-DISPLAY-COUNT.            02935005
029360     DISPLAY 'TOTAL ASGMT DELETES FAILED    : '  PV-DISPLAY-COUNT.02936015
029370                                                                  02937005
029392     MOVE PA-ASGMT-NOT-FOUND      TO PV-DISPLAY-COUNT.            02939205
029393     DISPLAY 'TOTAL ASGMT NOT FOUND         : '  PV-DISPLAY-COUNT.02939305
029394                                                                  02939405
029397     DISPLAY '****************************************'.          02939705
029398                                                                  02939805
030800                                                                  03080005
031000******************************************************************03100000
031100*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    03110000
031200*  ERROR OR WARNING CODE OCCURS.                                  03120000
031300******************************************************************03130000
031310 9100-SQL-ABEND.                                                  03131005
031320                                                                  03132005
031400     DISPLAY '9100-SQL-ABEND'.                                    03140000
031500     DISPLAY '** ABEND     **'.                                   03150000
031600     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        03160000
031700     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              03170000
031800     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     03180000
031900     DISPLAY '***'                                                03190000
032000     DISPLAY '*** LAST COMMIT TAKEN **' PV-COMMIT-INFO            03200000
032100     DISPLAY '***'                                                03210000
032200     DISPLAY '*** COMMITTED UPDATE COUNTS FOLLOW: ***'            03220000
032300     DISPLAY '***'                                                03230000
032400     EXEC SQL                                                     03240000
032500          ROLLBACK                                                03250000
032600     END-EXEC.                                                    03260000
032700******************************************************************03270000
032800* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    03280000
032900* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         03290000
033000* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     03300000
033100* FORMAT.                                                         03310000
033200******************************************************************03320000
033300     COPY DPPD004.                                                03330000
033400                                                                  03340000
033500     MOVE +4013                  TO ABEND-CODE.                   03350000
033600     CALL 'ILBOABN0' USING ABEND-CODE.                            03360000
