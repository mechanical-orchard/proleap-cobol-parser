       IDENTIFICATION DIVISION.                                         00010000
       PROGRAM-ID.    MLKUP006.                                         00030099
       INSTALLATION.  KOHLS DEPARTMENT STORES.                          00050000
       DATE-WRITTEN.  08-01-2007.                                       00060099
       DATE-COMPILED.                                                   00070000
                                                                        00080000
      ******************************************************************00090000
      *     MLKUP006 - WEEKLY DETAILED ML ON-ORDER UPDATE PROGRAM      *00100099
      ******************************************************************00110000
      *     THIS PROGRAM WILL MAINTAIN THE WEEKLY DETAIL ML DB2        *00120099
      * TABLE WITH ONORDER RETAIL AND COST FIELDS.  THE TABLE IS READ  *00130000
      * USING THE TABLE KEY FROM EACH SORT-SUMMED INPUT FILE           *00140000
      * RECORD.  IF THE ROW IS FOUND, THE ROW IS UPDATED WITH DATA     *00150000
      * FROM THE INPUT FILE RECORD.  IF THE ROW IS NOT FOUND, A NEW    *00160000
      * ROW IS INSERTED ON THE DB2 TABLE (MLT_WKLY_VND).  COMMITS ARE  *00170099
      * TAKEN EVERY TEN SECONDS, AND CHECKPOINT RESTART LOGIC IS       *00180068
      * INCORPORATED.                                                  *00190000
      *                                                                 00200099
      *CHANGE HISTORY:                                                  00210099
      * WR/PROJ DATE       PGMR        DESCRIPTION OF CHANGES           00220099
      * ------- ---------- ----------- -------------------------------- 00230099
X28582* W28582  08-08-2007 R.JANSSEN   WKLY VND LVL DETAIL LEDGER       00240099
      ******************************************************************00353099
                                                                        00360000
       ENVIRONMENT DIVISION.                                            00370000
                                                                        00380000
       CONFIGURATION SECTION.                                           00390000
       SOURCE-COMPUTER.        IBM-3090.                                00400000
       OBJECT-COMPUTER.        IBM-3090.                                00410000
       INPUT-OUTPUT SECTION.                                            00420000
       FILE-CONTROL.                                                    00430000
           SELECT CONDENSED-FILE                                        00440000
               ASSIGN TO INP01.                                         00450000
                                                                        00460000
           SELECT LEDGER-EXTRACT-DATE-FILE                              00470000
               ASSIGN TO INP02.                                         00480000
                                                                        00490000
       DATA DIVISION.                                                   00500000
       FILE SECTION.                                                    00510000
                                                                        00520000
       FD  CONDENSED-FILE                                               00530000
           LABEL RECORDS ARE STANDARD                                   00540000
           RECORDING MODE IS F                                          00550000
           BLOCK CONTAINS 0 RECORDS.                                    00560000
       01  CONDENSED-RECORD            PIC X(80).                       00570087
      *                                                                 00580000
       FD  LEDGER-EXTRACT-DATE-FILE                                     00590000
           RECORDING MODE IS F                                          00600000
           LABEL RECORDS ARE STANDARD                                   00610000
           BLOCK CONTAINS 0 RECORDS.                                    00620000
       01  LEDGER-EXTRACT-DATE-RECORD       PIC X(80).                  00630000
                                                                        00640000
      *                                                                 00650000
       WORKING-STORAGE SECTION.                                         00660000
                                                                        00680139
       01  ABEND-CODE                  PIC S9(04)  VALUE ZERO COMP SYNC.00681039
                                                                        00690000
       01  PC-PROGRAM-CONSTANTS.                                        00700000
           05  PC-JOB-NAME             PIC  X(06)    VALUE 'MLK110'.    00710000
           05  PC-PROGRAM-NAME         PIC  X(08)    VALUE 'MLKUP006'.  00720099
           05  PC-MAX-RETRIES          PIC S9(03) VALUE +3.             00730000
           05  PC-MAX-DEADLOCKS        PIC S9(03) VALUE +3.             00740000
                                                                        00750000
       01  PC-PROGRAM-COUNTER.                                          00760000
           05  PC-UPDATE-CNT           PIC  9(09).                      00770000
           05  PC-DISPLAY-CNT          PIC  9(09).                      00780000
                                                                        00790000
       01  PE-PROGRAM-ERROR-MESSAGES.                                   00800000
           05  PE-MSG-01                       PIC X(50) VALUE          00810000
                'ATTEMPT TO SELECT ROW FOR UPDATE/INSERT FAILED   '.    00820000
           05  PE-MSG-02                       PIC X(50) VALUE          00830000
                'ATTEMPT TO UPDATE ROW ON TABLE MLT_WKLY_VND FAILED'.   00840099
           05  PE-MSG-03                       PIC X(50) VALUE          00850000
                'ATTEMPT TO INSERT ROW ON TABLE MLT_WKLY_VND FAILED'.   00860099
           05  PE-MSG-04                       PIC X(50) VALUE          00870000
                'ERROR IN SELECT ''STATUS CODE'' FROM TCKRSTCNTL  '.    00880000
           05  PE-MSG-05                       PIC X(50) VALUE          00890000
                'UPDATE TO ''WORK_STRG_DESC'' ON TCKRSTINF FAILED '.    00900000
           05  PE-MSG-06                       PIC X(50) VALUE          00910000
                'PROGRAM ABENDED WHILE TRYING TO PERFORM A COMMIT '.    00920000
           05  PE-MSG-07                       PIC X(50) VALUE          00930000
                'PROGRAM MAXIMUM DEADLOCK COUNT HAS BEEN EXCEEDED'.     00940000
           05  PE-MSG-08                       PIC X(50) VALUE          00950000
                'AFTER DEADLOCK ERROR, AN UPDATE OR INSERT FAILED'.     00960000
           05  PE-MSG-09                       PIC X(50) VALUE          00970000
                'CHECKPNT RESTART FAILED UPON FIRST INSERT/UPDATE'.     00980000
           05  PE-MSG-10                       PIC X(50) VALUE          00990000
                'UPDATE OF STATUS CODE ON TCKRSTCNTL UNSUCCESSFUL'.     01000000
           05  PE-MSG-11                       PIC X(50) VALUE          01010000
                'ATTEMPT TO SELECT TIMESTAMP + CKPT_FRQNCY_QTY   '.     01020000
           05  PE-MSG-12                       PIC X(50) VALUE          01030000
                'UPDATE MLT_WKLY_VND TO INIT ONORD AMOUNT FAILED '.     01040099
           05  PE-MSG-13                       PIC X(50) VALUE          01050000
                'ATTEMPT TO SELECT ROW FROM TDTATTR FAILED       '.     01060000
           05  PE-MSG-14                       PIC X(50) VALUE          01070000
                'ATTEMPT TO OPEN PARTN-CSR FAILED                '.     01080099
           05  PE-MSG-15                       PIC X(50) VALUE          01090000
                'ATTEMPT TO FETCH PARTN-CSR FAILED               '.     01100099
           05  PE-MSG-16                       PIC X(50) VALUE          01110000
                'ATTEMPT TO CLOSE PARTN-CSR FAILED               '.     01120099
           05  PE-MSG-17                       PIC X(50) VALUE          01130000
                'ATTEMPT TO OPEN DEPT-CSR FAILED                 '.     01140017
           05  PE-MSG-18                       PIC X(50) VALUE          01150000
                'ATTEMPT TO FETCH DEPT-CSR FAILED                '.     01160000
           05  PE-MSG-19                       PIC X(50) VALUE          01170000
                'ATTEMPT TO CLOSE DEPT-CSR FAILED                '.     01180000
      *                                                                 01190000
       01  PS-PROGRAM-SWITCHES.                                         01200000
           05  PS-INPUT-FILE-EOF-SW         PIC  X        VALUE 'N'.    01210000
               88  PS-MORE-INPUT-RECORDS                  VALUE 'N'.    01220000
               88  PS-NO-MORE-INPUT-RECORDS               VALUE 'Y'.    01230000
           05  PS-EMPTY-FILE-SW             PIC  X        VALUE 'N'.    01240000
               88  PS-EMPTY-INPUT-FILE                    VALUE 'Y'.    01250000
           05  PS-FIRST-COMMIT-SW           PIC X         VALUE 'N'.    01260000
               88  PS-FIRST-COMMIT                        VALUE 'Y'.    01270000
           05  PS-DEADLOCK-RESTART-SW       PIC X         VALUE 'N'.    01280000
               88  PS-PROGRAM-DEADLOCKED                  VALUE 'Y'.    01290000
           05  PS-PROCESSING-OPTIONS        PIC X         VALUE 'P'.    01300000
               88  PS-UPDATE-MLT00015-ROW                 VALUE 'U'.    01310099
               88  PS-UPDATE-WKSHNK-ROW                   VALUE 'U'.    01320000
               88  PS-INSERT-MLT00015-ROW                 VALUE 'I'.    01330099
               88  PS-INSERT-WKSHNK-ROW                   VALUE 'I'.    01340000
           05  PS-END-OF-LEDGER-DATE-FILE-SW   PIC X      VALUE 'N'.    01350000
               88 PS-END-OF-LEDGER-DATE-FILE              VALUE 'Y'.    01360000
           05  PS-END-OF-PARTN-CSR-SW          PIC X      VALUE 'N'.    01370099
               88 PS-END-OF-PARTN-CSR                     VALUE 'Y'.    01380099
           05  PS-END-OF-DEPT-CSR-SW           PIC X      VALUE 'N'.    01390000
               88 PS-END-OF-DEPT-CSR                      VALUE 'Y'.    01400000
      *                                                                 01410000
      *                                                                 01420000
       01  PROGRAM-VARIABLES.                                           01430000
           05  PV-DEADLOCK-COUNT               PIC S9(04) VALUE +0.     01440000
           05  PV-PARAGRAPH-NAME               PIC  X(30) VALUE SPACES. 01450000
           05  PV-ABEND-MESSAGE                PIC  X(75) VALUE SPACES. 01460000
           05  PV-OPERATION-ATTEMPTED          PIC  X(50) VALUE SPACES. 01470000
           05  PV-CURRENT-TIMESTAMP            PIC  X(26) VALUE SPACES. 01480000
           05  PV-COMMIT-TIMESTAMP             PIC  X(26) VALUE SPACES. 01490000
           05  PV-SQLCODE-DISPLAY              PIC  ++++9 VALUE ZERO.   01500000
           05  PV-MN-END-FSCL-WK-NBR           PIC  X(10) VALUE SPACES. 01510000
           05  PV-MN-BEG-FSCL-WK-NBR           PIC  X(10) VALUE SPACES. 01520000
           05  PV-FSCL-MN-BEG-DTE              PIC  X(10) VALUE SPACES. 01530099
           05  PV-DEPT-CNT                     PIC S9(04) VALUE +0.     01540000
           05  PV-PARTN-CNT                    PIC S9(04) VALUE +0.     01550099
           05  PV-DEPT-MAX                     PIC S9(04) VALUE +0.     01560000
           05  PV-DB2-TEST                     PIC S9(04) VALUE ZEROES  01561088
                                                      COMP.             01561188
           05  PV-EXTRACT-DTE                  PIC  X(10) VALUE SPACES. 01561288
           05  PV-FSCL-END-DTE                 PIC  X(10) VALUE SPACES. 01561399
           05  PV-FSCL-WK-END-DTE              PIC  X(10) VALUE SPACES. 01561499
                                                                        01561699
           05  PV-MAJ-CL-NBR-WORK.                                      01561799
               10  PV-MAJ-CL-NBR-1             PIC 9(01)   VALUE 0.     01561899
               10  PV-MAJ-CL-NBR-2             PIC 9(01)   VALUE 0.     01561999
                                                                        01562099
           05  PV-MAJ-CL-NBR                   REDEFINES                01562199
               PV-MAJ-CL-NBR-WORK              PIC 9(02).               01563099
                                                                        01563199
           05  PV-DEPT-NBR                     PIC S9(4)V COMP-3        01563599
                                                      VALUE ZEROS.      01563699
                                                                        01563799
           05  PV-SUB-CL-NBR                   PIC X(02).               01563899
           05  PV-SUB-CL-NBR-2                 REDEFINES                01563999
               PV-SUB-CL-NBR                   PIC 9(02).               01564099
                                                                        01564199
           05  PV-PARTN-NBR                    PIC S9(4)V COMP.         01564299
           05  PV-FSCL-DTE                     PIC X(10).               01564399
           05  PV-SAVE-WK-PARTN-NBR            PIC S9(4)  COMP          01564499
                                                      VALUE ZEROS.      01564599
                                                                        01564699
      *                                                                 01565099
       01  DEPT-TBL.                                                    01566099
           05  TBL-DEPT-NBRS   OCCURS  1000.                            01567099
               10  TBL-DEPT                    PIC S9(4)V COMP-3        01568099
                                                          VALUE ZEROES. 01568199
      *                                                                 01569099
      *                                                                 01570099
       01  PARTN-TBL.                                                   01580099
           05  TBL-PARTN       OCCURS  11.                              01590099
               10  TBL-PARTN-NBR               PIC  S9(4) COMP VALUE 0. 01600099
      *                                                                 01620099
      *                                                                 01690000
       01  PA-PROGRAM-ACCUMULATORS.                                     01700000
           05  PA-RECORD-COUNTS.                                        01710000
               10  PA-INPUT-COUNT              PIC  9(9)  VALUE ZEROES. 01720000
               10  PA-UPD-MLT00015-COUNT       PIC  9(9)  VALUE ZEROES. 01730099
               10  PA-INS-MLT00015-COUNT       PIC  9(9)  VALUE ZEROES. 01740099
               10  PA-SEL-MLT00015-COUNT       PIC  9(9)  VALUE ZEROES. 01750099
               10  PA-SEL-TDTATTR-COUNT        PIC  9(9)  VALUE ZEROES. 01760000
               10  PA-COMMIT-COUNT             PIC  9(9)  VALUE ZEROES. 01770000
               10  PA-PARTN-REUSE              PIC 9(11)  VALUE ZEROES. 01771099
               10  PA-PARTN-LOOKUP             PIC 9(11)  VALUE ZEROES. 01772099
      *                                                                 01780000
       01  PD-PROGRAM-DISPLAYS.                                         01790000
           05  PD-DEADLOCK-COUNT         PIC  9(04) VALUE 0.            01800000
      *                                                                 01810000
      ******************************************************************01810199
      * MLWS500 - PARTITION                                             01810299
      ******************************************************************01810399
           COPY MLWS500.                                                01810498
                                                                        01810598
      ******************************************************************01820000
      * MLRD132 - PURCHASE ORDER ON ORDER EXTRACT                       01830091
      ******************************************************************01840000
           COPY MLRD132.                                                01850000
      *                                                                 01860000
      ******************************************************************01870000
      * MLRD135 - FISCAL MONTH END DATE                                 01880000
      ******************************************************************01890000
           COPY MLRD135.                                                01900000
      *                                                                 01910000
      ******************************************************************01920000
      *  DB2 ERROR MESSAGES FORMAT AREA.                                01930000
      ******************************************************************01940000
           COPY DPWS004.                                                01950000
      *                                                                 01960000
      ******************************************************************01970000
      *  USED FOR DB2 ERRORS                                            01980000
      ******************************************************************01990000
           EXEC SQL                                                     02000000
               INCLUDE SQLCA                                            02010000
           END-EXEC.                                                    02020000
      *                                                                 02030000
      ******************************************************************02110077
      *  M/L WEEKLY DAILY DETAIL TABLE                                  02111077
      ******************************************************************02112077
           EXEC SQL                                                     02113077
               INCLUDE MLT00015                                         02113199
           END-EXEC.                                                    02113277
      *                                                                 02113377
      ******************************************************************02114000
      *  M/L DATE ATTRIBUTES TABLE                                      02120000
      ******************************************************************02130000
           EXEC SQL                                                     02140000
               INCLUDE TDTATTR                                          02150000
           END-EXEC.                                                    02160000
      *                                                                 02170000
      ***************************************************************** 02180000
      * DB2 CHECKPOINT RESTART CONTROL TABLE AND RESTART INFO TABLE     02190000
      ***************************************************************** 02200000
           EXEC SQL                                                     02210000
               INCLUDE TCKRSTCN                                         02220000
           END-EXEC.                                                    02230000
      *                                                                 02240000
           EXEC SQL                                                     02250000
               INCLUDE TCKRSTIN                                         02260000
           END-EXEC.                                                    02270000
      *                                                                 02280000
      ******************************************************************02290000
      * CHECKPOINT RESTART VARIABLES AND PREV COMMIT VARIABLES.        *02300000
      ******************************************************************02310000
       01  CR-CHECKPOINT-RESTART-AREA.                                  02320000
           05  CR-AREA-LEN                  PIC S9(04) VALUE +104 COMP. 02330000
           05  CR-CHECKPOINT-RESTART-VAR.                               02340000
               10  CR-PREV-DTL-KEY          PIC  X(27) VALUE SPACES.    02350099
               10  FILLER REDEFINES CR-PREV-DTL-KEY.                    02360000
                   15  CR-FISCAL-NBR        PIC  X(02).                 02361099
                   15  CR-FISCAL-WK-END-DTE PIC  X(10).                 02362099
                   15  CR-DEPT-NBR          PIC  S9(4)V COMP-3.         02390030
                   15  CR-MAJ-CL-NBR        PIC  S9(4)V COMP-3.         02400030
                   15  CR-SUB-CL-NBR        PIC  S9(4)V COMP-3.         02401030
                   15  CR-LOC-NBR           PIC  S9(4) COMP.            02402084
                   15  CR-ENT-ID            PIC  S9(9) COMP.            02403084
               10  CR-INPUT-READ-COUNT      PIC  9(09) VALUE ZEROES.    02420000
               10  CR-MLT00015-COMMIT-COUNT PIC 9(09) VALUE ZEROES.     02430099
               10  CR-UPD-MLT00015-COUNT PIC 9(09) VALUE ZEROES.        02440099
               10  CR-INS-MLT00015-COUNT PIC 9(09) VALUE ZEROES.        02450099
               10  CR-SEL-MLT00015-COUNT PIC 9(09) VALUE ZEROES.        02460099
               10  CR-SEL-TDTATTR-COUNT     PIC  9(09) VALUE ZEROES.    02470000
      *                                                                 02480000
       01  CK-CHECKPOINT-SAVE-AREA.                                     02490000
           05  CK-SAVE-PREV-KEY         PIC  X(27) VALUE SPACES.        02500099
           05  FILLER REDEFINES CK-SAVE-PREV-KEY.                       02510000
               10  CK-FISCAL-NBR        PIC  X(02).                     02511099
               10  CK-FISCAL-WK-END-DTE PIC  X(10).                     02512099
               10  CK-DEPT-NBR          PIC  S9(4)V COMP-3.             02540030
               10  CK-MAJ-CL-NBR        PIC  S9(4)V COMP-3.             02550030
               10  CK-SUB-CL-NBR        PIC  S9(4)V COMP-3.             02551030
               10  CK-LOC-NBR           PIC  S9(4) COMP.                02552084
               10  CK-ENT-ID            PIC  S9(9) COMP.                02553084
      *                                                                 02554099
      ****************************************************************  02555099
      *  DEPARTMENT CURSOR FOR MLT_WKLY_VND TABLE                       02556099
      ****************************************************************  02557099
                                                                        02558099
           EXEC SQL                                                     02559099
               DECLARE DEPT-CSR CURSOR FOR                              02559199
                   SELECT DISTINCT DEPT_NBR                             02560099
                   FROM MLT_PARTN_CNTL B,                               02570099
                        MLT_PARTN_BAL C                                 02580099
                   WHERE B.TBL_TM_LVL_CDE = C.TBL_TM_LVL_CDE            02581099
                     AND B.DEPT_GP_CDE = C.DEPT_GP_CDE                  02590099
                     AND B.TBL_TM_LVL_CDE = 'W'                         02600099
                     AND B.FSCL_DTE BETWEEN :PV-FSCL-MN-BEG-DTE         02610099
                                    AND :ML135-EXTRACT-DTE              02620099
                   ORDER BY DEPT_NBR                                    02630099
W26603             WITH UR                                              02640099
           END-EXEC.                                                    02650099
                                                                        02660099
                                                                        02670099
      *                                                                 02680099
      ****************************************************************  02690099
      *  PARTITION CURSOR                                               02700099
      ****************************************************************  02710099
                                                                        02720099
           EXEC SQL                                                     02730099
               DECLARE PARTN-CSR CURSOR FOR                             02731099
                   SELECT DISTINCT B.PARTN_NBR                          02740099
                   FROM MLT_PARTN_CNTL B                                02750099
                       ,MLT_PARTN_BAL C                                 02760099
                   WHERE B.TBL_TM_LVL_CDE = C.TBL_TM_LVL_CDE            02770099
                     AND B.DEPT_GP_CDE = C.DEPT_GP_CDE                  02770199
                     AND B.TBL_TM_LVL_CDE = 'W'                         02771099
                     AND B.FSCL_DTE BETWEEN :PV-FSCL-MN-BEG-DTE         02780099
                                        AND :ML135-EXTRACT-DTE          02800099
                   WITH UR                                              02801099
           END-EXEC.                                                    02810099
      *                                                                 02890000
      *                                                                 02900000
       LINKAGE SECTION.                                                 02910000
      *                                                                 02920000
      *                                                                 02930000
      *-------------------*                                             02940000
       PROCEDURE DIVISION.                                              02950000
      *-------------------*                                             02960000
                                                                        02970000
       0000-MAIN-MODULE.                                                02980000
                                                                        02990000
           PERFORM 1000-INITIALIZATION.                                 03000000
                                                                        03010099
           PERFORM 2000-PROCESS-INPUT                                   03020099
                UNTIL PS-NO-MORE-INPUT-RECORDS.                         03030099
                                                                        03040099
           PERFORM 8000-EOJ-ROUTINE.                                    03050000
                                                                        03060000
           STOP RUN.                                                    03070000
      *                                                                 03080000
      *                                                                 03090000
      *                                                                 03100000
      ******************************************************************03110000
      * OPEN INPUT FILE , INITIALIZE COUNTERS AND THE ONORD VALUES IN   03120000
      * THE MLT_WKLY_VND TABLE, READ FIRST INPUT RECORD PREPARE         03130099
      * CHECKPOINT RESTART TABLES FOR PROCESSING / RESTART              03140068
      ******************************************************************03150000
      *                                                                 03160000
       1000-INITIALIZATION.                                             03170000
      *                                                                 03180000
           OPEN INPUT CONDENSED-FILE                                    03190000
                      LEDGER-EXTRACT-DATE-FILE.                         03200000
      *                                                                 03210000
           PERFORM 7100-INIT-CHECKPOINT-SELECT.                         03220000
      *                                                                 03230000
      * CKPT-STAT-CODE = '9' INDICATES A RESTART CONDITION              03240000
           IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           03250099
               PERFORM 7200-SELECT-RESTART-INFO                         03260099
               MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO                    03270099
                                             CR-CHECKPOINT-RESTART-VAR  03280099
               MOVE CR-PREV-DTL-KEY         TO CK-SAVE-PREV-KEY         03290099
      * MOVE RESTART COUNTS TO PA-FIELDS FOR ACCURATE DISPLAY AT EOJ    03300000
               MOVE CR-UPD-MLT00015-COUNT                               03310099
                                         TO PA-UPD-MLT00015-COUNT       03311099
               MOVE CR-INS-MLT00015-COUNT                               03320099
                                         TO PA-INS-MLT00015-COUNT       03321099
               MOVE CR-SEL-MLT00015-COUNT                               03330099
                                         TO PA-SEL-MLT00015-COUNT       03331099
               MOVE CR-SEL-TDTATTR-COUNT                                03340099
                                         TO PA-SEL-TDTATTR-COUNT        03341099
               MOVE CR-MLT00015-COMMIT-COUNT                            03350099
                                         TO PA-COMMIT-COUNT             03351099
           ELSE                                                         03360099
               PERFORM 4000-READ-LEDGER-EXTRACT-DATE                    03370000
      *                                                                 03380000
               IF PS-END-OF-LEDGER-DATE-FILE                            03390000
                   DISPLAY '** ABEND **'                                03400000
                   DISPLAY '** PROGRAM MLKRP215 **'                     03410000
                   DISPLAY '** PARAGRAPH 1000-INITIALIZATION'           03420000
                   DISPLAY '** LEDGER EXTRACT DATE FILE IS EMPTY.'      03430000
                   MOVE +4003 TO ABEND-CODE                             03440000
                   PERFORM 9999-ABEND                                   03450000
               END-IF                                                   03460000
      *                                                                 03470000
               MOVE ML135-EXTRACT-DTE          TO DTATTR-KY-DTE         03480000
               MOVE ML135-EXTRACT-DTE          TO PV-EXTRACT-DTE        03481088
               MOVE ML135-EXTRACT-DTE          TO PV-FSCL-END-DTE       03482099
      *                                                                 03490000
               PERFORM 6000-GET-DATE-ATTRIBUTES                         03500000
      *                                                                 03510000
               INITIALIZE DEPT-TBL                                      03520099
               PERFORM 1100-BUILD-DEPT-TABLE                            03530099
               INITIALIZE PARTN-TBL                                     03540099
               PERFORM 1400-BUILD-PARTN-TABLE                           03550099
      *                                                                 03560099
      *        THIS IS THE OUTER PROCESSING LOOP THAT PROCESSES         03570000
      *        BY WEEK.  WITHIN 1300-INIT-BY-PARTITION, THERE IS A LOWER03580099
      *        LEVEL OF DEPARTMENT THAT IS PROCESSED.                   03590000
               MOVE +1             TO PV-PARTN-CNT                      03600099
               PERFORM 1300-INIT-BY-PARTITION                           03610099
                   UNTIL PV-PARTN-CNT > 10                              03620099
                      OR TBL-PARTN-NBR(PV-PARTN-CNT) = ZEROES           03630099
      *                                                                 03640000
               SET PS-FIRST-COMMIT TO TRUE                              03650000
           END-IF.                                                      03660000
                                                                        03660199
           MOVE PV-EXTRACT-DTE      TO PV-FSCL-WK-END-DTE               03661099
           MOVE PV-FSCL-MN-BEG-DTE  TO ML500-PV-REQ-FSCL-BEG-DTE        03661199
           MOVE PV-FSCL-END-DTE     TO ML500-PV-REQ-FSCL-END-DTE        03661299
                                                                        03661399
           PERFORM ML500-0100-LOAD-PARTN-TABLE                          03662099
           IF ML500-PV-PARAGRAPH-NAME NOT EQUAL TO SPACES               03663099
             MOVE ML500-PV-PARAGRAPH-NAME TO PV-PARAGRAPH-NAME          03664099
             MOVE ML500-PV-OPERATION-ATTEMPTED                          03665099
                                              TO PV-OPERATION-ATTEMPTED 03666099
             PERFORM 9998-SQL-ABEND                                     03667099
           END-IF                                                       03668099
      *                                                                 03670000
           DISPLAY 'COMMITS WILL BE TAKEN EVERY ',                      03680000
                   TCKRSTCNTL-CKPT-FRQNCY-QTY, ' SECONDS.'.             03690000
      *                                                                 03700000
           PERFORM 4100-READ-CONDENSED-FILE UNTIL                       03710000
               PA-INPUT-COUNT > CR-INPUT-READ-COUNT                     03720000
            OR PS-NO-MORE-INPUT-RECORDS.                                03730000
      *                                                                 03740000
           IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           03750000
               DISPLAY 'FISCAL WEEK NBR      ' ML132-ONORD-FSCL-WK-NBR  03760000
               DISPLAY 'FISCAL WEEK END DATE '                          03770000
                                            ML132-ONORD-FSCL-WK-END-DTE 03780000
               DISPLAY 'DEPARTMENT NBR       ' ML132-ONORD-DEPT-NBR     03800061
               DISPLAY 'SUB CLASS NBR        ' ML132-ONORD-SUB-CL-NBR   03801084
               DISPLAY 'STORE NBR            ' ML132-ONORD-STR-NBR      03802084
               DISPLAY 'ENT ID               ' ML132-ONORD-ENT-ID       03803084
               DISPLAY 'INPUT RECORD RESTARTED ON RECORD '              03820000
                        PA-INPUT-COUNT                                  03830000
           END-IF.                                                      03840000
                                                                        03850000
           IF PS-NO-MORE-INPUT-RECORDS                                  03860000
               IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                       03870000
                   CONTINUE                                             03880000
               ELSE                                                     03890000
                   DISPLAY '** NO RECORDS ON INPUT FILE **'             03900000
               END-IF                                                   03901099
           ELSE                                                         03910000
               PERFORM 7000-GET-COMMIT-TIMESTAMP                        03920000
           END-IF.                                                      03930000
      *                                                                 03940000
      *                                                                 03950000
      ******************************************************************03960099
      * LOOP THROUGH THE DEPARTMENT CURSOR AND POPULATE DEPT TABLE      03970099
      ******************************************************************03980099
       1100-BUILD-DEPT-TABLE.                                           03990099
      *                                                                 04000099
           PERFORM 6100-OPEN-DEPT-CSR.                                  04010099
      *                                                                 04020099
           PERFORM 6110-FETCH-DEPT-CSR.                                 04030099
      *                                                                 04040099
           PERFORM 1200-INSERT-DEPT-TABLE                               04050099
             UNTIL PS-END-OF-DEPT-CSR.                                  04060099
      *                                                                 04070099
           MOVE PV-DEPT-CNT               TO PV-DEPT-MAX.               04080099
      *                                                                 04090099
           PERFORM 6120-CLOSE-DEPT-CSR.                                 04100099
      *                                                                 04110099
      *                                                                 04120099
      ******************************************************************04130099
      * ADD A DEPARTMENT TO THE TABLE                                   04140099
      ******************************************************************04150099
       1200-INSERT-DEPT-TABLE.                                          04160099
      *                                                                 04170099
           ADD +1                         TO PV-DEPT-CNT.               04180099
           MOVE MLT00015-DEPT-NBR         TO TBL-DEPT(PV-DEPT-CNT).     04190099
      *                                                                 04200099
           PERFORM 6110-FETCH-DEPT-CSR.                                 04210099
      *                                                                 04220099
      *                                                                 04230099
      ******************************************************************04240000
      * THE PROCEDURE PROCESSES BY PARTITION, 1310-ZERO-OUT-ONORD-AMTS  04250099
      * PROCESSES BY DEPARTMENT.  THE COMMIT IS DONE BY WEEK.           04260020
      ******************************************************************04270000
       1300-INIT-BY-PARTITION.                                          04280099
      *                                                                 04290000
           MOVE TBL-PARTN-NBR(PV-PARTN-CNT) TO MLT00015-PARTN-NBR.      04291099
                                                                        04330000
           MOVE +1 TO PV-DEPT-CNT.                                      04340000
           PERFORM 1310-ZERO-OUT-ONORD-AMTS                             04350000
               UNTIL PV-DEPT-CNT > PV-DEPT-MAX.                         04360000
                                                                        04370000
           ADD +1  TO PV-PARTN-CNT.                                     04380099
           PERFORM 7510-COMMIT.                                         04390012
      *                                                                 04400000
      *                                                                 04410000
      *                                                                 04420000
      ******************************************************************04430000
      * ZERO OUT THE MLT_WKLY_VND FOR ONE DEPARTMENT FOR THE FISCAL WEEK04440099
      ******************************************************************04450000
       1310-ZERO-OUT-ONORD-AMTS.                                        04460000
                                                                        04470000
           MOVE TBL-DEPT(PV-DEPT-CNT) TO MLT00015-DEPT-NBR.             04480099
           PERFORM 6300-INITIALIZE-ONORD.                               04490000
           PERFORM 7510-COMMIT.                                         04491025
           ADD +1 TO PV-DEPT-CNT.                                       04500000
      *                                                                 04510000
      *                                                                 04520000
      ******************************************************************04530099
      * LOOP THROUGH THE PARTITION CURSOR AND POPULATE                  04540099
      * THE PARTN TABLE                                                 04550099
      ******************************************************************04560099
       1400-BUILD-PARTN-TABLE.                                          04570099
      *                                                                 04580099
           PERFORM 6200-OPEN-PARTN-CSR.                                 04590099
      *                                                                 04600099
           PERFORM 6210-FETCH-PARTN-CSR.                                04610099
      *                                                                 04620099
           PERFORM 1500-INSERT-PARTN-TABLE                              04630099
             UNTIL PS-END-OF-PARTN-CSR                                  04640099
      *                                                                 04650099
           PERFORM 6220-CLOSE-PARTN-CSR.                                04660099
      *                                                                 04670099
      *                                                                 04680099
      ******************************************************************04690099
      * ADD A DEPARTMENT TO THE TABLE                                   04700099
      ******************************************************************04710099
       1500-INSERT-PARTN-TABLE.                                         04720099
      *                                                                 04730099
           ADD +1                      TO PV-PARTN-CNT.                 04740099
           MOVE PV-PARTN-NBR           TO TBL-PARTN-NBR(PV-PARTN-CNT).  04750099
                                                                        04780099
      *                                                                 04790099
           PERFORM 6210-FETCH-PARTN-CSR.                                04800099
      *                                                                 04810099
      *                                                                 04820099
      ******************************************************************04830000
      * PROCESS THE SORTED/CONDENSED FILE - UPDATE OR INSERT AS NEEDED  04840000
      ******************************************************************04850000
       2000-PROCESS-INPUT.                                              04860000
      *                                                                 04870000
           MOVE 'N' TO PS-DEADLOCK-RESTART-SW.                          04880000
      *                                                                 04890000
           MOVE ML132-ONORD-FSCL-WK-END-DTE TO MLT00015-FSCL-WK-END-DTE.04910099
           MOVE ML132-ONORD-FSCL-WK-END-DTE TO ML500-PV-FSCL-END-DTE.   04920099
           MOVE ML132-ONORD-DEPT-NBR        TO PV-DEPT-NBR              04930099
                                               MLT00015-DEPT-NBR.       04930199
           MOVE ML132-ONORD-SUB-CL-NBR      TO PV-SUB-CL-NBR-2.         04931099
           MOVE PV-SUB-CL-NBR-2             TO MLT00015-SUB-CL-NBR.     04931199
           MOVE ML132-ONORD-STR-NBR         TO MLT00015-LOC-NBR.        04932099
           MOVE ML132-ONORD-ENT-ID          TO MLT00015-ENT-ID.         04940199
                                                                        04950000
      * DERIVE MAJOR CLASS NUMBER FROM SUB CLASS NUMBER                 04950199
           MOVE ML132-ONORD-SUB-CL-NBR      TO PV-MAJ-CL-NBR-WORK.      04950299
           MOVE 0                           TO PV-MAJ-CL-NBR-2.         04950399
           MOVE PV-MAJ-CL-NBR               TO MLT00015-MAJ-CL-NBR.     04950499
                                                                        04950599
           PERFORM 7800-FIND-BOTH-PARTN.                                04956099
                                                                        04957098
           PERFORM 6500-SELECT-MLT00015-ROW.                            04960099
      *                                                                 04970000
           IF PS-PROGRAM-DEADLOCKED                                     04980000
               CONTINUE                                                 04990000
           ELSE                                                         05000000
               EVALUATE TRUE                                            05010000
                   WHEN PS-UPDATE-MLT00015-ROW                          05020099
                       PERFORM 6600-UPDATE-MLT00015-ROW                 05030099
                   WHEN PS-INSERT-MLT00015-ROW                          05040099
                       PERFORM 6700-INSERT-MLT00015-ROW                 05050099
               END-EVALUATE                                             05060000
           END-IF.                                                      05070000
      *                                                                 05080000
           IF PS-PROGRAM-DEADLOCKED                                     05090000
               CONTINUE                                                 05100000
           ELSE                                                         05110000
               PERFORM 7400-COMMIT-PROCESSING                           05120000
               PERFORM 4100-READ-CONDENSED-FILE                         05130000
           END-IF.                                                      05140000
      *                                                                 05150000
      ******************************************************************05160000
      * READ THE DATE FILE                                              05170000
      ******************************************************************05180000
       4000-READ-LEDGER-EXTRACT-DATE.                                   05190000
           READ LEDGER-EXTRACT-DATE-FILE                                05200000
              INTO ML135-LEDGER-EXTRACT-DATE-REC                        05210000
               AT END SET PS-END-OF-LEDGER-DATE-FILE TO TRUE.           05220000
      *                                                                 05230000
      ******************************************************************05240000
      * READS THE CONDENSED FILE INTO THE MLT_WKLY_VND LAYOUT           05250099
      ******************************************************************05260000
       4100-READ-CONDENSED-FILE.                                        05270000
           READ CONDENSED-FILE INTO ML132-ONORD-EXTRACT-WK-REC          05280000
               AT END MOVE 'Y' TO PS-INPUT-FILE-EOF-SW.                 05290000
      *                                                                 05300000
           IF PS-NO-MORE-INPUT-RECORDS                                  05310000
               MOVE ML132-ONORD-FSCL-WK-NBR     TO CR-FISCAL-NBR        05320099
               MOVE ML132-ONORD-FSCL-WK-END-DTE TO CR-FISCAL-WK-END-DTE 05330099
               MOVE ML132-ONORD-DEPT-NBR        TO CR-DEPT-NBR          05350061
               MOVE ML132-ONORD-SUB-CL-NBR      TO CR-SUB-CL-NBR        05351031
               MOVE ML132-ONORD-STR-NBR         TO CR-LOC-NBR           05352084
               MOVE ML132-ONORD-ENT-ID          TO CR-ENT-ID            05353084
               MOVE PA-INPUT-COUNT              TO CR-INPUT-READ-COUNT  05370000
      *        MOVE COMMIT INFO TO WORKING STORAGE ROW                  05380000
               MOVE CR-CHECKPOINT-RESTART-AREA  TO                      05390000
                                             TCKRSTINF-WORK-STRG-DESC   05400000
               EXEC SQL                                                 05410000
                 UPDATE TCKRSTINF                                       05420000
                    SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC      05430000
                  WHERE JOB_NAME   = :PC-JOB-NAME                       05440000
                    AND PLAN_NAME  = :PC-PROGRAM-NAME                   05450000
               END-EXEC                                                 05460000
               IF SQLCODE = 0                                           05470000
                   CONTINUE                                             05480000
               ELSE                                                     05490000
                   MOVE PE-MSG-05            TO PV-OPERATION-ATTEMPTED  05500000
                   MOVE '* 4100-READ-CONDENSED-FILE *' TO               05510000
                        PV-PARAGRAPH-NAME                               05520000
                   PERFORM 9998-SQL-ABEND                               05530000
               END-IF                                                   05540000
           ELSE                                                         05550000
               ADD 1                         TO PA-INPUT-COUNT          05560000
                                                PC-UPDATE-CNT           05570000
               IF PC-UPDATE-CNT > 100000                                05580000
                    ADD 1                    TO PC-DISPLAY-CNT          05590000
                    DISPLAY 'UPDATE COUNT: ' PC-DISPLAY-CNT             05600000
                    MOVE +0                  TO PC-UPDATE-CNT           05610000
               END-IF                                                   05620000
           END-IF.                                                      05630000
      *                                                                 05640000
      ******************************************************************05650000
      * GET DATE ATTRIBUTES                                             05660000
      ******************************************************************05670000
       6000-GET-DATE-ATTRIBUTES.                                        05680000
      *                                                                 05690000
           EXEC SQL                                                     05700000
               SELECT                                                   05710000
                     A.FSCL_MN_BEG_DTE                                  05720099
                    ,A.FSCL_WK_NBR                                      05730086
                    ,B.FSCL_WK_NBR                                      05740086
               INTO :PV-FSCL-MN-BEG-DTE                                 05750099
                   ,:PV-MN-END-FSCL-WK-NBR                              05760086
                   ,:PV-MN-BEG-FSCL-WK-NBR                              05770086
               FROM TDTATTR A                                           05780000
                   ,TDTATTR B                                           05790000
               WHERE A.KY_DTE          =:ML135-EXTRACT-DTE              05800000
                 AND A.FSCL_WK_BEG_DTE = B.KY_DTE                       05810020
               WITH UR                                                  05811025
           END-EXEC.                                                    05820000
      *                                                                 05830000
           EVALUATE SQLCODE                                             05840000
               WHEN 0                                                   05850000
                   CONTINUE                                             05860000
               WHEN OTHER                                               05870000
                   DISPLAY 'DTATTR-KY-DTE: ' DTATTR-KY-DTE              05880000
                   MOVE    '6000-GET-DATE-ATTRIBUTES'                   05890000
                                              TO PV-PARAGRAPH-NAME      05900000
                   MOVE PE-MSG-13             TO PV-OPERATION-ATTEMPTED 05910000
                   PERFORM 9998-SQL-ABEND                               05920000
           END-EVALUATE.                                                05930000
      *                                                                 05940000
      ******************************************************************05950099
       6100-OPEN-DEPT-CSR.                                              05960099
      *                                                                 05970099
           EXEC SQL                                                     05980099
                OPEN DEPT-CSR                                           05990099
           END-EXEC.                                                    06000099
      *                                                                 06010099
           EVALUATE SQLCODE                                             06020099
               WHEN 0                                                   06030099
                   CONTINUE                                             06040099
               WHEN OTHER                                               06050099
                   MOVE '6100-OPEN-DEPT-CSR'                            06060099
                                            TO PV-PARAGRAPH-NAME        06070099
                   MOVE PE-MSG-14           TO PV-OPERATION-ATTEMPTED   06080099
                   PERFORM 9998-SQL-ABEND                               06090099
           END-EVALUATE.                                                06100099
      *                                                                 06110099
      *                                                                 06120099
       6110-FETCH-DEPT-CSR.                                             06130099
      *                                                                 06140099
            EXEC SQL                                                    06150099
                FETCH                                                   06160099
                    DEPT-CSR                                            06170099
                INTO                                                    06180099
                   :MLT00015-DEPT-NBR                                   06190099
            END-EXEC.                                                   06200099
      *                                                                 06210099
      *                                                                 06220099
            EVALUATE SQLCODE                                            06230099
               WHEN 0                                                   06240099
                   CONTINUE                                             06250099
               WHEN +100                                                06260099
                   SET PS-END-OF-DEPT-CSR TO TRUE                       06270099
               WHEN OTHER                                               06280099
                   MOVE '6110-FETCH-DEPT-CSR'                           06290099
                                               TO PV-PARAGRAPH-NAME     06300099
                   MOVE PE-MSG-15              TO PV-OPERATION-ATTEMPTED06310099
                   PERFORM 9998-SQL-ABEND                               06320099
            END-EVALUATE.                                               06330099
      *                                                                 06340099
      *                                                                 06350099
       6120-CLOSE-DEPT-CSR.                                             06360099
      *                                                                 06370099
           EXEC SQL                                                     06380099
               CLOSE DEPT-CSR                                           06390099
           END-EXEC.                                                    06400099
      *                                                                 06410099
           EVALUATE SQLCODE                                             06420099
               WHEN 0                                                   06430099
                   CONTINUE                                             06440099
               WHEN OTHER                                               06450099
                   MOVE '6120-CLOSE-DEPT-CSR'                           06460099
                                              TO PV-PARAGRAPH-NAME      06470099
                   MOVE PE-MSG-16             TO PV-OPERATION-ATTEMPTED 06480099
                   PERFORM 9998-SQL-ABEND                               06490099
           END-EVALUATE.                                                06500099
      *                                                                 06510099
      *                                                                 06520099
      ******************************************************************06530099
       6200-OPEN-PARTN-CSR.                                             06540099
      *                                                                 06550099
           EXEC SQL                                                     06560099
                OPEN PARTN-CSR                                          06570099
           END-EXEC.                                                    06580099
      *                                                                 06590099
           EVALUATE SQLCODE                                             06600099
               WHEN 0                                                   06610099
                   CONTINUE                                             06620099
               WHEN OTHER                                               06630099
                   MOVE '6200-OPEN-PARTN-CSR'                           06640099
                                            TO PV-PARAGRAPH-NAME        06650099
                   MOVE PE-MSG-14           TO PV-OPERATION-ATTEMPTED   06660099
                   PERFORM 9998-SQL-ABEND                               06670099
           END-EVALUATE.                                                06680099
      *                                                                 06690099
      *                                                                 06700099
       6210-FETCH-PARTN-CSR.                                            06710099
      *                                                                 06720099
            EXEC SQL                                                    06730099
                FETCH                                                   06740099
                    PARTN-CSR                                           06750099
                INTO                                                    06760099
                   :PV-PARTN-NBR                                        06770099
            END-EXEC.                                                   06790099
      *                                                                 06800099
      *                                                                 06810099
            EVALUATE SQLCODE                                            06820099
               WHEN 0                                                   06830099
                   CONTINUE                                             06840099
               WHEN +100                                                06850099
                   SET PS-END-OF-PARTN-CSR TO TRUE                      06860099
               WHEN OTHER                                               06870099
                   MOVE '6200-OPEN-PARTN-CSR'                           06880099
                                               TO PV-PARAGRAPH-NAME     06890099
                   MOVE PE-MSG-15              TO PV-OPERATION-ATTEMPTED06900099
                   PERFORM 9998-SQL-ABEND                               06910099
            END-EVALUATE.                                               06920099
      *                                                                 06930099
      *                                                                 06940099
       6220-CLOSE-PARTN-CSR.                                            06950099
      *                                                                 06960099
           EXEC SQL                                                     06970099
               CLOSE PARTN-CSR                                          06980099
           END-EXEC.                                                    06990099
      *                                                                 07000099
           EVALUATE SQLCODE                                             07010099
               WHEN 0                                                   07020099
                   CONTINUE                                             07030099
               WHEN OTHER                                               07040099
                   MOVE '6220-CLOSE-PARTN-CSR'                          07050099
                                              TO PV-PARAGRAPH-NAME      07060099
                   MOVE PE-MSG-16             TO PV-OPERATION-ATTEMPTED 07070099
                   PERFORM 9998-SQL-ABEND                               07080099
           END-EVALUATE.                                                07090099
      *                                                                 07100099
      *                                                                 07110099
      ******************************************************************07130000
      * SET ALL ONORDER AMOUNTS TO ZERO FOR ALL WEEKS IN THE FISCAL     07140000
      * MONTH                                                           07150090
      ******************************************************************07160000
       6300-INITIALIZE-ONORD.                                           07170000
      *                                                                 07180000
      *                                                                 07190000
           EXEC SQL                                                     07200000
               UPDATE MLT_WKLY_VND                                      07210099
                 SET ONORD_RTL_AMT       = 0                            07220025
                    ,ONORD_COST_AMT      = 0                            07230025
               WHERE PARTN_NBR           = :MLT00015-PARTN-NBR          07251099
                 AND DEPT_NBR            = :MLT00015-DEPT-NBR           07260099
           END-EXEC.                                                    07270000
      *                                                                 07280000
           EVALUATE SQLCODE                                             07290000
               WHEN 0                                                   07300000
                   CONTINUE                                             07310000
               WHEN +100                                                07320000
                   CONTINUE                                             07330000
               WHEN OTHER                                               07340000
                   MOVE PE-MSG-12           TO PV-OPERATION-ATTEMPTED   07350000
                   MOVE  '6300-INITIALIZE-ONORD'                        07360000
                                            TO PV-PARAGRAPH-NAME        07370000
                   PERFORM 9998-SQL-ABEND                               07380000
           END-EVALUATE.                                                07390000
      *                                                                 07400000
      *                                                                 07410000
      ******************************************************************07420000
      * EXISTENCE CK FROM THE WEEKLY DETAIL TABLE THAT MATCHES INPUT    07430090
      *   KEY SQLCODE FROM 'SELECT' IS EVALUATED IN 2000-PROCESS-INPUT  07440000
      ******************************************************************07450000
       6500-SELECT-MLT00015-ROW.                                        07460099
      *                                                                 07470000
           EXEC SQL                                                     07480000
               SELECT 1                                                 07490025
                 INTO :PV-DB2-TEST                                      07510025
               FROM MLT_WKLY_VND                                        07530099
               WHERE  PARTN_NBR        = :MLT00015-PARTN-NBR            07560099
                 AND  DEPT_NBR         = :MLT00015-DEPT-NBR             07561099
                 AND  MAJ_CL_NBR       = :MLT00015-MAJ-CL-NBR           07570099
                 AND  SUB_CL_NBR       = :MLT00015-SUB-CL-NBR           07571099
                 AND  LOC_NBR          = :MLT00015-LOC-NBR              07572099
                 AND  ENT_ID           = :MLT00015-ENT-ID               07573099
               FETCH FIRST ROW ONLY                                     07581006
           END-EXEC.                                                    07590000
      *                                                                 07600000
           EVALUATE SQLCODE                                             07610000
               WHEN 0                                                   07620000
                   MOVE ZERO                   TO PV-DEADLOCK-COUNT     07630000
                   SET PS-UPDATE-MLT00015-ROW  TO TRUE                  07640099
                   ADD +1               TO PA-SEL-MLT00015-COUNT        07650099
               WHEN +100                                                07660000
                   MOVE ZERO                   TO PV-DEADLOCK-COUNT     07670000
                   SET PS-INSERT-MLT00015-ROW  TO TRUE                  07680099
               WHEN -911                                                07690000
                   ADD +1             TO PV-DEADLOCK-COUNT              07700000
                   DISPLAY 'DEADLOCK -911 IN 6500-SELECT-MLT00015-ROW'  07710099
                   IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              07720000
                       MOVE '6500-SELECT-MLT00015-ROW'                  07730099
                                                 TO PV-PARAGRAPH-NAME   07740000
                       PERFORM 9000-DEADLOCK-ERROR                      07750000
                   ELSE                                                 07760000
                       PERFORM 7999-RESTART-PROCESS                     07770000
                   END-IF                                               07780000
               WHEN OTHER                                               07790000
                   MOVE '6500-SELECT-MLT00015-ROW' TO PV-PARAGRAPH-NAME 07800099
                   MOVE PE-MSG-01 TO PV-OPERATION-ATTEMPTED             07810000
                   PERFORM 9998-SQL-ABEND                               07820000
           END-EVALUATE.                                                07830000
      *                                                                 07840000
      *                                                                 07850000
      ***************************************************************** 07860000
      * THE INPUT RECORD FOUND A MATCHING ROW BASED ON FSCL INFO, DEPT, 07870000
      * MAJ CLASS, SUB CLASS, LOC NUMBER, AND ENT ID.  CURRENT TABLE    07880090
      * VALUES ARE UPDATED TO INCLUDE VALUES FROM THE INPUT RECORD.     07890090
      ***************************************************************** 07900000
       6600-UPDATE-MLT00015-ROW.                                        07910099
      *                                                                 07920000
           MOVE ML132-EXT-RTL-AMT        TO MLT00015-ONORD-RTL-AMT.     07921099
           MOVE ML132-EXT-CST-AMT        TO MLT00015-ONORD-COST-AMT.    07922099
      *                                                                 07923006
           EXEC SQL                                                     07930000
              UPDATE MLT_WKLY_VND                                       07940099
                   SET ONORD_RTL_AMT     = :MLT00015-ONORD-RTL-AMT      07950099
                     , ONORD_COST_AMT    = :MLT00015-ONORD-COST-AMT     07960099
              WHERE   PARTN_NBR          = :MLT00015-PARTN-NBR          07990099
                AND   DEPT_NBR           = :MLT00015-DEPT-NBR           07991099
                AND   MAJ_CL_NBR         = :MLT00015-MAJ-CL-NBR         08000099
                AND   SUB_CL_NBR         = :MLT00015-SUB-CL-NBR         08001099
                AND   LOC_NBR            = :MLT00015-LOC-NBR            08002099
                AND   ENT_ID             = :MLT00015-ENT-ID             08003099
           END-EXEC.                                                    08020000
      *                                                                 08030000
           EVALUATE SQLCODE                                             08040000
               WHEN 0                                                   08050000
                   MOVE ZERO          TO PV-DEADLOCK-COUNT              08060000
                   ADD 1              TO PA-UPD-MLT00015-COUNT          08070099
               WHEN -911                                                08080000
                   ADD +1             TO PV-DEADLOCK-COUNT              08090000
                   DISPLAY 'DEADLOCK -911 IN 6600-UPDATE-MLT00015-ROW'  08100099
                   IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              08110000
                       MOVE '6600-UPDATE-MLT00015-ROW'                  08120099
                                      TO PV-PARAGRAPH-NAME              08130000
                       PERFORM 9000-DEADLOCK-ERROR                      08140000
                   ELSE                                                 08150000
                       PERFORM 7999-RESTART-PROCESS                     08160000
                   END-IF                                               08170000
               WHEN OTHER                                               08180000
                   MOVE '6600-UPDATE-MLT00015-ROW'                      08190099
                                      TO PV-PARAGRAPH-NAME              08200000
                   MOVE PE-MSG-02     TO PV-OPERATION-ATTEMPTED         08210000
                   PERFORM 9998-SQL-ABEND                               08220000
           END-EVALUATE.                                                08230000
      *                                                                 08240000
      *                                                                 08250000
      ***************************************************************** 08260000
      * THERE WAS NO MATCHING ROW ON THE WEEKLY DETAIL TABLE.         * 08270090
      * - ENTRY FOR THIS ENTITY IS INSERTED AS A 'NEW' ROW            * 08280000
      ***************************************************************** 08290000
       6700-INSERT-MLT00015-ROW.                                        08300099
      *                                                                 08310000
           MOVE ML132-EXT-RTL-AMT        TO MLT00015-ONORD-RTL-AMT.     08311099
           MOVE ML132-EXT-CST-AMT        TO MLT00015-ONORD-COST-AMT.    08312099
      *                                                                 08320000
           EXEC SQL                                                     08330000
               INSERT INTO MLT_WKLY_VND                                 08340099
                   (   PARTN_NBR                                        08350061
                     , DEPT_NBR                                         08370000
                     , MAJ_CL_NBR                                       08371025
                     , SUB_CL_NBR                                       08380000
                     , LOC_NBR                                          08380150
                     , ENT_ID                                           08380250
                     , FSCL_WK_END_DTE                                  08380361
                     , SLS_REG_RTL_AMT                                  08400025
                     , SLS_PROMO_RTL_AMT                                08401025
                     , SLS_PROCLR_RTL_AMT                               08402025
                     , SLS_CLR_RTL_AMT                                  08403025
                     , SLS_OTH_RTL_AMT                                  08404025
                     , MKDN_PLU_RTL_AMT                                 08405025
                     , MKDN_PROMO_RTL_AMT                               08406025
                     , MKDN_RGST_RTL_AMT                                08407025
                     , MKDN_GLDST_RTL_AMT                               08408028
                     , MKDN_UMTCH_RTL_AMT                               08409025
                     , MKDN_BYR_RTL_AMT                                 08409125
                     , MKDN_STR_RTL_AMT                                 08409225
                     , MKDN_PRPT_RTL_AMT                                08409328
                     , MKDN_OTH_RTL_AMT                                 08409425
                     , MKDN_RTL_AMT                                     08410000
                     , MKUP_RTL_AMT                                     08420000
                     , XFER_IN_RTL_AMT                                  08430000
                     , XFER_OUT_RTL_AMT                                 08440000
                     , RCPT_RTL_AMT                                     08450000
                     , RCPT_NET_COST_AMT                                08460000
                     , RCPT_GRO_COST_AMT                                08461025
                     , PADJ_RTL_AMT                                     08470000
                     , PADJ_FRGT_COST_AMT                               08471025
                     , PADJ_DISC_COST_AMT                               08472025
                     , PADJ_RTV_COST_AMT                                08473025
                     , PADJ_RTV_RTL_AMT                                 08473146
                     , PADJ_DA_COST_AMT                                 08474025
                     , PADJ_DA_RTL_AMT                                  08475025
                     , PADJ_NET_COST_AMT                                08476046
                     , PADJ_OTH_COST_AMT                                08477046
                     , PADJ_OTH_RTL_AMT                                 08478046
                     , DR_ALW_RTL_AMT                                   08481025
                     , RTV_RTL_AMT                                      08482025
                     , MKUP_INIT_AMT                                    08483025
                     , MKUP_NET_AMT                                     08484025
                     , INV_ADJ_RTL_AMT                                  08490000
                     , ONORD_RTL_AMT                                    08500000
                     , ONORD_COST_AMT                                   08510025
                     , SHNK_RTL_AMT                                     08511025
                     , END_INV_RTL_AMT                                  08512099
                     , END_INV_COST_AMT )                               08513099
               VALUES                                                   08520000
                   (   :MLT00015-PARTN-NBR                              08530099
                     , :MLT00015-DEPT-NBR                               08550099
                     , :MLT00015-MAJ-CL-NBR                             08560099
                     , :MLT00015-SUB-CL-NBR                             08561099
                     , :MLT00015-LOC-NBR                                08570099
                     , :MLT00015-ENT-ID                                 08570199
                     , :MLT00015-FSCL-WK-END-DTE                        08570299
                     , 0                                                08571084
                     , 0                                                08580029
                     , 0                                                08590029
                     , 0                                                08591047
                     , 0                                                08620029
                     , 0                                                08630029
                     , 0                                                08640029
                     , 0                                                08650029
                     , 0                                                08660029
                     , 0                                                08670029
                     , 0                                                08671046
                     , 0                                                08672046
                     , 0                                                08673046
                     , 0                                                08674046
                     , 0                                                08675046
                     , 0                                                08676046
                     , 0                                                08677046
                     , 0                                                08678046
                     , 0                                                08679046
                     , 0                                                08679146
                     , 0                                                08679246
                     , 0                                                08679346
                     , 0                                                08679446
                     , 0                                                08679546
                     , 0                                                08679646
                     , 0                                                08679746
                     , 0                                                08679846
                     , 0                                                08679946
                     , 0                                                08680046
                     , 0                                                08680146
                     , 0                                                08680246
                     , 0                                                08680346
                     , 0                                                08680446
                     , 0                                                08680546
                     , 0                                                08680646
                     , 0                                                08680746
                     , :MLT00015-ONORD-RTL-AMT                          08681099
                     , :MLT00015-ONORD-COST-AMT                         08681199
                     , 0                                                08681246
                     , 0                                                08681399
                     , 0                      )                         08682046
           END-EXEC.                                                    08700000
      *                                                                 08710000
           EVALUATE SQLCODE                                             08720000
               WHEN 0                                                   08730000
                   MOVE ZERO          TO PV-DEADLOCK-COUNT              08740000
                   ADD 1              TO PA-INS-MLT00015-COUNT          08750099
               WHEN -911                                                08760000
                   ADD +1             TO PV-DEADLOCK-COUNT              08770000
                   DISPLAY 'DEADLOCK -911 IN 6700-INSERT-MLT00015-ROW'  08780099
                   IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              08790000
                       MOVE '6700-INSERT-MLT00015-ROW' TO               08800099
                                                    PV-PARAGRAPH-NAME   08810000
                       PERFORM 9000-DEADLOCK-ERROR                      08820000
                   ELSE                                                 08830000
                       PERFORM 7999-RESTART-PROCESS                     08840000
                   END-IF                                               08850000
               WHEN OTHER                                               08860000
                   MOVE '6700-INSERT-MLT00015-ROW' TO PV-PARAGRAPH-NAME 08870099
                   MOVE PE-MSG-03              TO PV-OPERATION-ATTEMPTED08880000
                   PERFORM 9998-SQL-ABEND                               08890000
           END-EVALUATE.                                                08900000
      *                                                                 08910000
      *                                                                 08920000
      ******************************************************************08930000
      * 7000-GET-COMMIT-TIMESTAMP.                                     *08940000
      * PROCESSES: GET THE COMMIT TIMESTAMP FROM THE CHECKPOINT        *08950000
      *            CONTROL TABLE                                       *08960000
      ******************************************************************08970000
       7000-GET-COMMIT-TIMESTAMP.                                       08980000
                                                                        08990000
           EXEC SQL                                                     09000000
      * CHECKPOINT TAKEN BASED ON CHEKPOINT RESTART CICSP1 PANEL        09010000
             SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)       09020000
               INTO :PV-COMMIT-TIMESTAMP                                09030000
               FROM TCKRSTCNTL                                          09040000
              WHERE JOB_NAME  = :PC-JOB-NAME                            09050000
                AND PLAN_NAME = :PC-PROGRAM-NAME                        09060000
           END-EXEC.                                                    09070000
                                                                        09080000
           IF SQLCODE = 0                                               09090000
               CONTINUE                                                 09100000
           ELSE                                                         09110000
               MOVE '7000-GET-COMMIT-TIMESTAMP' TO PV-PARAGRAPH-NAME    09120000
               MOVE PE-MSG-11             TO PV-OPERATION-ATTEMPTED     09130000
               PERFORM 9998-SQL-ABEND                                   09140000
           END-IF.                                                      09150000
      *                                                                 09160000
      *                                                                 09170000
      ******************************************************************09180000
      * 7100-INIT-CHECKPOINT-SELECT                                    *09190000
      * PROCESSES: SELECTS FROM THE CHECKPOINT RESTART CONTROL TABLE   *09200000
      *            IF WE ARE IN A RESTART CONDITION.                   *09210000
      ******************************************************************09220000
       7100-INIT-CHECKPOINT-SELECT.                                     09230000
                                                                        09240000
           EXEC SQL                                                     09250000
             SELECT  CKPT_STAT_CODE                                     09260000
                    ,CKPT_FRQNCY_QTY                                    09270000
               INTO  :TCKRSTCNTL-CKPT-STAT-CODE                         09280000
                    ,:TCKRSTCNTL-CKPT-FRQNCY-QTY                        09290000
               FROM  TCKRSTCNTL                                         09300000
              WHERE  JOB_NAME  = :PC-JOB-NAME                           09310000
                AND  PLAN_NAME = :PC-PROGRAM-NAME                       09320000
           END-EXEC.                                                    09330000
                                                                        09340000
           IF SQLCODE = 0                                               09350000
               CONTINUE                                                 09360000
           ELSE                                                         09370000
               MOVE '7100-INIT-CHECKPOINT-SELECT' TO PV-PARAGRAPH-NAME  09380000
               MOVE PE-MSG-04             TO PV-OPERATION-ATTEMPTED     09390000
               PERFORM 9998-SQL-ABEND                                   09400000
           END-IF.                                                      09410000
      *                                                                 09420000
      *                                                                 09430000
      ******************************************************************09440000
      * 7200-SELECT-RESTART-INFO                                       *09450000
      * PROCESSES: SELECTS FROM THE CHECKPOINT RESTART INFORMATION     *09460000
      *            TABLE TO OBTAIN THE PROGRAMS SAVED VARIABLES.       *09470000
      ******************************************************************09480000
       7200-SELECT-RESTART-INFO.                                        09490000
                                                                        09500000
           EXEC SQL                                                     09510000
             SELECT  WORK_STRG_DESC                                     09520000
               INTO  :TCKRSTINF-WORK-STRG-DESC                          09530000
               FROM  TCKRSTINF                                          09540000
              WHERE  JOB_NAME  = :PC-JOB-NAME                           09550000
                AND  PLAN_NAME = :PC-PROGRAM-NAME                       09560000
           END-EXEC.                                                    09570000
                                                                        09580000
           IF SQLCODE = 0                                               09590000
               CONTINUE                                                 09600000
           ELSE                                                         09610000
               MOVE '*7200-SELECT-RESTART-INFO*' TO PV-PARAGRAPH-NAME   09620000
               PERFORM 9998-SQL-ABEND                                   09630000
           END-IF.                                                      09640000
      *                                                                 09650000
      *                                                                 09660000
      ******************************************************************09670000
      * 7300-SET-CURRENT-TIMESTAMP.                                    *09680000
      * PROCESSES: GET THE CURRENT TIMESTAMP FROM DB2.                 *09690000
      ******************************************************************09700000
       7300-SET-CURRENT-TIMESTAMP.                                      09710000
                                                                        09720000
           EXEC SQL                                                     09730000
                SET :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP           09740000
           END-EXEC.                                                    09750000
      *                                                                 09760000
           IF SQLCODE = 0                                               09770000
               CONTINUE                                                 09780000
           ELSE                                                         09790000
               MOVE '*7300-SET-CURRENT-TIMESTAMP*' TO PV-PARAGRAPH-NAME 09800000
               PERFORM 9998-SQL-ABEND                                   09810000
           END-IF.                                                      09820000
      *                                                                 09830000
      *                                                                 09840000
      ******************************************************************09850000
      * 7400-COMMIT-PROCESSING.                                        *09860000
      * PROCESSES: CHECK IF WE NEED TO TAKE A COMMIT.                  *09870000
      *          PREPARE CHECKPOINT RECORD FOR UPDATE OF WORK_STRG_DESC*09880000
      ******************************************************************09890000
       7400-COMMIT-PROCESSING.                                          09900000
           MOVE '*7400-COMMIT-PROCESSING*'    TO PV-PARAGRAPH-NAME.     09910000
                                                                        09920000
           PERFORM 7300-SET-CURRENT-TIMESTAMP.                          09930000
      *                                                                 09940000
           IF PV-CURRENT-TIMESTAMP > PV-COMMIT-TIMESTAMP                09950000
      *        PREPARE COMMIT RECORD FOR UPDATE                         09960000
               ADD 1                          TO PA-COMMIT-COUNT        09970000
               MOVE ML132-ONORD-FSCL-WK-NBR   TO CR-FISCAL-NBR          09980099
               MOVE ML132-ONORD-FSCL-WK-END-DTE TO CR-FISCAL-WK-END-DTE 09990099
               MOVE ML132-ONORD-DEPT-NBR      TO CR-DEPT-NBR            10010061
               MOVE ML132-ONORD-SUB-CL-NBR    TO CR-SUB-CL-NBR          10011031
               MOVE ML132-ONORD-STR-NBR       TO CR-LOC-NBR             10012084
               MOVE ML132-ONORD-ENT-ID        TO CR-ENT-ID              10013084
               MOVE PA-COMMIT-COUNT                                     10030068
                                         TO CR-MLT00015-COMMIT-COUNT    10031099
               MOVE PA-INPUT-COUNT                                      10040068
                                         TO CR-INPUT-READ-COUNT         10041068
               MOVE PA-UPD-MLT00015-COUNT                               10050099
                                         TO CR-UPD-MLT00015-COUNT       10051099
               MOVE PA-INS-MLT00015-COUNT                               10060099
                                         TO CR-INS-MLT00015-COUNT       10061099
               MOVE PA-SEL-MLT00015-COUNT                               10070099
                                         TO CR-SEL-MLT00015-COUNT       10071099
               MOVE PA-SEL-TDTATTR-COUNT                                10080068
                                         TO CR-SEL-TDTATTR-COUNT        10081068
      *        MOVE COMMIT INFO TO WORKING STORAGE ROW                  10090000
               MOVE CR-CHECKPOINT-RESTART-AREA TO                       10100000
                                             TCKRSTINF-WORK-STRG-DESC   10110000
               IF PS-FIRST-COMMIT                                       10120000
                   MOVE '9' TO TCKRSTCNTL-CKPT-STAT-CODE                10130000
                   PERFORM 7600-UPDATE-CHECKPOINT-STATUS                10140000
                   MOVE 'N' TO PS-FIRST-COMMIT-SW                       10150000
               END-IF                                                   10160000
               PERFORM 7500-COMMIT-CHANGES                              10170000
               PERFORM 7000-GET-COMMIT-TIMESTAMP                        10180000
           END-IF.                                                      10190000
      *                                                                 10200000
      *                                                                 10210000
      ******************************************************************10220000
      * 7500-COMMIT-CHANGES.                                            10230000
      * PROCESSES: PERFORM UPDATE OF CHECKPOINT INFORMATION TABLE.      10240000
      *            TAKE A COMMIT.                                       10250000
      *  ==> PERFORMED FROM: 7400-COMMIT-PROCESSING.                    10260000
      ******************************************************************10270000
       7500-COMMIT-CHANGES.                                             10280000
                                                                        10290000
           EXEC SQL                                                     10300000
             UPDATE TCKRSTINF                                           10310000
                SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC          10320000
              WHERE JOB_NAME       = :PC-JOB-NAME                       10330000
                AND PLAN_NAME      = :PC-PROGRAM-NAME                   10340000
           END-EXEC.                                                    10350000
                                                                        10360000
           IF SQLCODE = 0                                               10370000
               CONTINUE                                                 10380000
           ELSE                                                         10390000
               MOVE PE-MSG-05                  TO PV-OPERATION-ATTEMPTED10400000
               MOVE  '* 7500-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     10410000
               PERFORM 9998-SQL-ABEND                                   10420000
           END-IF.                                                      10430000
                                                                        10440000
           EXEC SQL                                                     10450000
               COMMIT                                                   10460000
           END-EXEC.                                                    10470000
                                                                        10480000
           IF SQLCODE = 0                                               10490000
               CONTINUE                                                 10500000
           ELSE                                                         10510000
               MOVE PE-MSG-06                  TO PV-OPERATION-ATTEMPTED10520000
               MOVE  '* 7500-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     10530000
               PERFORM 9998-SQL-ABEND                                   10540000
           END-IF.                                                      10550000
      *                                                                 10560000
      *                                                                 10570000
      ******************************************************************10580000
      * 7510-COMMIT.                                                    10590000
      * THERE IS NO CHECKPOINT DONE WITH THIS COMMIT.  THIS COMMIT IS   10600000
      * EXECUTED WHEN INITIALIZING THE ONORDER AMOUNT AND COST TO ZERO. 10610000
      *  ==> PERFORMED FROM: 1300-INIT-BY-PARTITION.                    10620099
      ******************************************************************10630000
       7510-COMMIT.                                                     10640000
                                                                        10650000
                                                                        10660000
           EXEC SQL                                                     10670000
               COMMIT                                                   10680000
           END-EXEC.                                                    10690000
                                                                        10700000
           IF SQLCODE = 0                                               10710000
               CONTINUE                                                 10720012
           ELSE                                                         10730000
               MOVE PE-MSG-06                  TO PV-OPERATION-ATTEMPTED10740000
               MOVE  '* 7510-COMMIT         *' TO PV-PARAGRAPH-NAME     10750000
               PERFORM 9998-SQL-ABEND                                   10760000
           END-IF.                                                      10770000
      *                                                                 10780000
      *                                                                 10790000
      ******************************************************************10800000
      * 7600-UPDATE-CHECKPOINT-STATUS                                   10810000
      * PROCESSES: UPDATES THE STATUS ON THE CHECKPOINT CONTROL TABLE   10820000
      *                                                                 10830000
      ******************************************************************10840000
       7600-UPDATE-CHECKPOINT-STATUS.                                   10850000
                                                                        10860000
           EXEC SQL                                                     10870000
             UPDATE  TCKRSTCNTL                                         10880000
                SET  CKPT_STAT_CODE = :TCKRSTCNTL-CKPT-STAT-CODE        10890000
              WHERE  JOB_NAME  = :PC-JOB-NAME                           10900000
                AND  PLAN_NAME = :PC-PROGRAM-NAME                       10910000
           END-EXEC.                                                    10920000
                                                                        10930000
           IF SQLCODE = 0                                               10940000
               CONTINUE                                                 10950000
           ELSE                                                         10960000
               MOVE '7600-UPDATE-CHECKPOINT-STATUS' TO PV-PARAGRAPH-NAME10970000
               MOVE PE-MSG-10                  TO PV-OPERATION-ATTEMPTED10980000
               PERFORM 9998-SQL-ABEND                                   10990000
           END-IF.                                                      11000000
                                                                        11010000
           EJECT                                                        11020000
      *                                                                 11030000
      *                                                                 11040000
      ******************************************************************11040199
      * FIND PARTITION NUMBER FOR BOTH WEEKLY AND MONTHLY FISCAL DATE   11040299
      ******************************************************************11040399
       7800-FIND-BOTH-PARTN.                                            11040499
                                                                        11040599
           IF PV-DEPT-NBR = ML500-PV-DEPT-NBR                           11040699
               ADD +1                      TO PA-PARTN-REUSE            11040799
               MOVE PV-SAVE-WK-PARTN-NBR   TO MLT00015-PARTN-NBR        11040899
           ELSE                                                         11041299
               ADD +1                   TO PA-PARTN-LOOKUP              11041399
               MOVE PV-DEPT-NBR         TO ML500-PV-DEPT-NBR            11041499
                                                                        11041599
               MOVE 'W'                 TO ML500-PV-TM-LVL-CDE          11041799
                                                                        11041899
               PERFORM 7850-FIND-PARTITION                              11041999
                                                                        11042099
               MOVE ML500-PV-PARTN-NBR-OUT TO MLT00015-PARTN-NBR        11042199
                                              PV-SAVE-WK-PARTN-NBR      11042299
                                                                        11042599
           END-IF.                                                      11043599
                                                                        11043699
      ******************************************************************11043799
      * FIND PARTITION NUMBER                                           11043899
      ******************************************************************11043999
       7850-FIND-PARTITION.                                             11044099
                                                                        11044199
           PERFORM ML500-0500-FIND-PARTITION.                           11044299
           IF ML500-PV-PARAGRAPH-NAME NOT EQUAL TO SPACES               11044399
             MOVE ML500-PV-PARAGRAPH-NAME TO PV-PARAGRAPH-NAME          11044499
             MOVE ML500-PV-OPERATION-ATTEMPTED TO PV-OPERATION-ATTEMPTED11044599
             PERFORM 9998-SQL-ABEND                                     11044699
           END-IF.                                                      11044799
                                                                        11044899
      ******************************************************************11050000
      * PROGRAM RESTART DUE TO A DEADLOCK AGAINST MLT_WKLY_VND ROW FOR  11060099
      *  UPDATE.  FIND RESTART RECORD AND CKPT RESTART AT POINT OF LAST 11070068
      *  COMMIT.                                                        11071068
      ******************************************************************11080000
       7999-RESTART-PROCESS.                                            11090000
      *                                                                 11100000
           SET PS-PROGRAM-DEADLOCKED TO TRUE.                           11110000
      *                                                                 11120000
           CLOSE CONDENSED-FILE                                         11130000
                 LEDGER-EXTRACT-DATE-FILE.                              11140000
      *                                                                 11150000
           PERFORM 7200-SELECT-RESTART-INFO.                            11160000
      *                                                                 11170000
           DISPLAY '**** RESTART **** '.                                11180000
           MOVE PV-DEADLOCK-COUNT TO PD-DEADLOCK-COUNT.                 11190000
           DISPLAY '** SQLCODE -911 **  ' PD-DEADLOCK-COUNT ' TIMES'.   11200000
      *                                                                 11210000
      *-- THIS CHECK WILL PREVENT THE FILE FROM BEING RESTARTED IN      11220000
      *-- THE WRONG POSITION IF NO COMMITS HAVE OCCURRED AND THE        11230000
      *-- RESTART INFORMATION IS NOT CLEARED OUT.                       11240000
           IF PS-FIRST-COMMIT                                           11250000
               INITIALIZE TCKRSTINF-WORK-STRG-DESC                      11260000
               DISPLAY 'NO COMMITS HAVE OCCURRED YET; RESTART FROM'     11270000
                      ' BEGINNING'                                      11280000
           ELSE                                                         11290000
               DISPLAY 'TCKRSTINF-LAST CKPT '                           11300000
                        TCKRSTINF-WORK-STRG-DESC (1:104)                11310000
      ***    INFO ON LAST CHECKPOINT TAKEN IS IN                        11320000
      ***    CR-CHECKPOINT-RESTART-AREA.                                11330000
               MOVE TCKRSTINF-WORK-STRG-DESC TO                         11340000
                     CR-CHECKPOINT-RESTART-AREA                         11350000
               DISPLAY 'CHECKPOINT RESTART INFORMATION:'                11360000
               DISPLAY 'WEEK NBR        ' CR-FISCAL-NBR                 11370099
               DISPLAY 'WEEK END DATE   ' CR-FISCAL-WK-END-DTE          11380099
               DISPLAY 'DEPARTMENT NBR  ' CR-DEPT-NBR                   11400061
               DISPLAY 'SUB CLASS NBR   ' CR-SUB-CL-NBR                 11401031
               DISPLAY 'STORE NBR       ' CR-LOC-NBR                    11402084
               DISPLAY 'ENT ID          ' CR-ENT-ID                     11403084
               DISPLAY 'INPUT RECS READ ' CR-INPUT-READ-COUNT           11420000
           END-IF.                                                      11430000
      *                                                                 11440000
           OPEN INPUT CONDENSED-FILE.                                   11450000
           MOVE ZEROES                          TO PA-INPUT-COUNT.      11460000
      *                                                                 11470000
      *POSITION INPUT FILE TO 1ST RECORD AFTER LAST CHECKPOINT          11480000
           PERFORM 4100-READ-CONDENSED-FILE                             11490000
               UNTIL PA-INPUT-COUNT > CR-INPUT-READ-COUNT               11500000
                 OR PS-NO-MORE-INPUT-RECORDS.                           11510000
           IF PS-NO-MORE-INPUT-RECORDS                                  11520000
               DISPLAY 'END OF INPUT FILE ON RESTART'                   11530000
           ELSE                                                         11540000
               DISPLAY 'INPUT RECORD RESTARTED ON RECORD '              11550000
                        PA-INPUT-COUNT                                  11560000
               DISPLAY 'FISCAL WEEK NBR       ' ML132-ONORD-FSCL-WK-NBR 11570000
               DISPLAY 'FISCAL WEEK END DATE  '                         11580000
                                            ML132-ONORD-FSCL-WK-END-DTE 11590000
               DISPLAY 'DEPARTMENT NBR        ' ML132-ONORD-DEPT-NBR    11610061
               DISPLAY 'SUB CLASS NBR         ' ML132-ONORD-SUB-CL-NBR  11611031
               DISPLAY 'STORE NBR             ' ML132-ONORD-STR-NBR     11612084
               DISPLAY 'ENT ID                ' ML132-ONORD-ENT-ID      11613084
           END-IF.                                                      11630000
      *                                                                 11640000
      *RE-ESTABLISH COUNTS FOR PROCESSED INPUT (FROM CHECKPOINT RECORD) 11650000
           MOVE CR-UPD-MLT00015-COUNT TO PA-UPD-MLT00015-COUNT.         11660099
           MOVE CR-INS-MLT00015-COUNT TO PA-INS-MLT00015-COUNT.         11670099
           MOVE CR-SEL-MLT00015-COUNT TO PA-SEL-MLT00015-COUNT.         11680099
           MOVE CR-SEL-TDTATTR-COUNT    TO PA-SEL-TDTATTR-COUNT.        11690000
           MOVE CR-MLT00015-COMMIT-COUNT TO PA-COMMIT-COUNT.            11700099
      *                                                                 11710000
      *                                                                 11720000
      ******************************************************************11730000
      *  RESET STATUS CODE, DISPLAY FINAL COUNTS , CLOSE INPUT FILE    *11740000
      ******************************************************************11750000
       8000-EOJ-ROUTINE.                                                11760000
      *                                                                 11770000
           MOVE '0' TO TCKRSTCNTL-CKPT-STAT-CODE.                       11780000
           PERFORM 7600-UPDATE-CHECKPOINT-STATUS.                       11790000
      *                                                                 11800000
           DISPLAY '                                             '.     11810000
           DISPLAY 'INPUT RECORDS   ', PA-INPUT-COUNT.                  11820000
           DISPLAY 'SELECT MLT_WKLY_VND  ', PA-SEL-MLT00015-COUNT.      11830099
           DISPLAY 'UPDATE MLT_WKLY_VND  ', PA-UPD-MLT00015-COUNT.      11840099
           DISPLAY 'INSERT MLT_WKLY_VND  ', PA-INS-MLT00015-COUNT.      11850099
           DISPLAY 'SELECT TDTATTR  ', PA-SEL-TDTATTR-COUNT.            11860000
           DISPLAY '                                             '.     11870000
           DISPLAY 'COMMITS TAKEN   ', PA-COMMIT-COUNT.                 11880000
      *                                                                 11890000
           CLOSE CONDENSED-FILE                                         11900000
                 LEDGER-EXTRACT-DATE-FILE.                              11910000
      *                                                                 11920000
      *                                                                 11930000
      ******************************************************************11931098
      * MLPD500 - PARTITION                                             11932098
      ******************************************************************11933098
           COPY MLPD500.                                                11934098
      *                                                                 11935098
      ******************************************************************11940000
      *  PERFORMED BY 6500-SELECT AND 6600-UPDATE AND 6700-INSERT       11950000
      *  THIS ROUTINE FORCES AN ABEND DUE TO A SQLCODE -911 (3 TIMES)   11960000
      ******************************************************************11970000
       9000-DEADLOCK-ERROR.                                             11980000
      *                                                                 11990000
               MOVE PE-MSG-07             TO PV-OPERATION-ATTEMPTED     12000000
               PERFORM 9998-SQL-ABEND.                                  12010000
      *                                                                 12020000
      ******************************************************************12030000
      *  STANDARD DB2 ERROR ABEND ROUTINE                               12040000
      *  THIS ROUTINE FORCES AN ABEND DUE TO A DB2 PROBLEM.             12050000
      ******************************************************************12060000
       9998-SQL-ABEND.                                                  12070000
      *                                                                 12080000
           MOVE +4013                 TO ABEND-CODE.                    12090000
           MOVE SQLCODE               TO PV-SQLCODE-DISPLAY.            12100000
           DISPLAY '**  ABEND     **'.                                  12110000
           DISPLAY '**  PROGRAM   ** => ' PC-PROGRAM-NAME.              12120000
           DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            12130000
           DISPLAY '**  OPERATION **  = ' PV-OPERATION-ATTEMPTED.       12140000
           DISPLAY '**  SQLCODE   **  = ' PV-SQLCODE-DISPLAY.           12150000
      *                                                                 12160000
      *    EXEC SQL                                                     12170099
      *         ROLLBACK                                                12180099
      *    END-EXEC.                                                    12190099
      *                                                                 12200000
      *    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE         12210000
      *    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.        12220000
           COPY DPPD004.                                                12230000
           PERFORM 9999-ABEND.                                          12240000
      *                                                                 12250000
      *                                                                 12260000
       9999-ABEND.                                                      12270000
      *                                                                 12280000
           CALL 'ILBOABN0'  USING ABEND-CODE.                           12290000
