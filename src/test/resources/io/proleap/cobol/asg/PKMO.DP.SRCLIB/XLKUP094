000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400 PROGRAM-ID.    XLKUP094.                                         00040022
000500 AUTHOR.        SIVARAMAKRISHNAN.                                 00050023
000600 INSTALLATION.  KOHLS.                                            00060000
000700 DATE-WRITTEN   OCTOBER 2017.                                     00070023
000800 DATE-COMPILED.                                                   00080000
000900***************************************************************** 00090000
001000*  THIS BATCH DB2 PROGRAM PERFORMS INSERT/UPDATE/DELETE ON        00100023
001100*  PACK SKU TABLE (XLT_PK) BASED ON ERROR TEXT IN THE INPUT       00101023
001200*  FILE                                                           00102023
001300***************************************************************** 00105000
001400 ENVIRONMENT DIVISION.                                            00106000
001500 INPUT-OUTPUT SECTION.                                            00107000
001600                                                                  00108000
001700 FILE-CONTROL.                                                    00109000
001800                                                                  00110000
001900     SELECT XLT-PK-IN                                             00120000
002000         ASSIGN TO INP01.                                         00130000
002100                                                                  00140000
002200                                                                  00141008
002300     SELECT SUMMARY-FILE                                          00142008
002400         ASSIGN TO OUT01.                                         00143008
002500                                                                  00144008
002600***************************************************************** 00150000
002700 DATA DIVISION.                                                   00160000
002800***************************************************************** 00170000
002900 FILE SECTION.                                                    00180000
003000                                                                  00190000
003100 FD  XLT-PK-IN                                                    00200000
003200     RECORDING MODE IS F                                          00210000
003300     BLOCK CONTAINS 0 RECORDS                                     00220000
003400     LABEL RECORDS ARE STANDARD.                                  00230000
003500                                                                  00240000
003600 01  XLT-PK-IN-RECORD                 PIC X(144).                 00250000
003700                                                                  00260000
003800 FD  SUMMARY-FILE                                                 00261008
003900     RECORDING MODE IS F                                          00262008
004000     BLOCK CONTAINS 0 RECORDS                                     00263008
004100     LABEL RECORDS ARE STANDARD.                                  00264008
004200                                                                  00265008
004300 01  SUMMARY-FILE-RECORD              PIC X(24).                  00266020
004400                                                                  00270000
004500***************************************************************** 00280000
004600 WORKING-STORAGE SECTION.                                         00290000
004700                                                                  00300000
004800 01  PA-DB2-COMMIT-COUNT              PIC S9(09) VALUE +0         00310000
004900                                                    COMP-3.       00320000
005000 01  PS-PROGRAM-SWITCHES.                                         00330000
005100     05  PS-EOF-INPUT-SW              PIC X(01)  VALUE 'N'.       00340000
005200         88  PS-EOF-INPUT-YES                    VALUE 'Y'.       00350000
005300         88  PS-EOF-INPUT-NO                     VALUE 'N'.       00360000
005400                                                                  00370000
005500 01  PC-PROGRAM-CONSTANTS.                                        00380000
005600     05  PC-PROGRAM-NAME              PIC  X(08) VALUE 'XLKUP094'.00390022
005700                                                                  00400000
005800 01  PV-PROGRAM-VARIABLES.                                        00410000
005900     05  PV-RECORDS-READ              PIC  9(09) VALUE  0.        00420000
006000     05  PV-RECORDS-INSERTED          PIC  9(09) VALUE  0.        00430000
006100     05  PV-RECORDS-SKIP              PIC  9(09) VALUE  0.        00440000
006200     05  PV-RECORDS-UPDATED           PIC  9(09) VALUE  0.        00441006
006300     05  PV-UPDATES-SKIPPED           PIC  9(09) VALUE  0.        00442006
006400     05  PV-RECORDS-DELETED           PIC  9(09) VALUE  0.        00443006
006500     05  PV-DELETES-SKIPPED           PIC  9(09) VALUE  0.        00444006
006600     05  PV-DISP-UPC-ID               PIC  9(09) VALUE  0.        00450000
006700     05  PV-DISP-UPC-NBR              PIC  9(15) VALUE  0.        00460000
006800     05  PV-SQLCODE                   PIC  S9(9) VALUE +0.        00470000
006900     05  PV-DISP-SQLCODE              PIC ZZZZZZ9-.               00480000
007000     05  PV-ZERO-LINE                 PIC X(24)                   00480220
007100                                           VALUE 'XLT_PK'.        00480318
007200     05  PV-FIRST-LINE                PIC X(24)  VALUE SPACES.    00481020
007300     05  PV-SECOND-LINE               PIC X(24)  VALUE SPACES.    00482020
007400     05  PV-THIRD-LINE                PIC X(24)  VALUE SPACES.    00483020
007500                                                                  00490000
007600                                                                  00500000
007700 01  PV-ABEND-FIELDS.                                             00510000
007800     05  PV-ABEND-CODE                PIC  S9(4) VALUE +0         00520000
007900                                                 COMP SYNC.       00530000
008000     05  PV-ABEND-PROGRAM             PIC  X(08) VALUE 'XLKUP094'.00540022
008100     05  PV-ABEND-PARAGRAPH           PIC  X(50) VALUE SPACES.    00550000
008200     05  PV-ABEND-OPERATION           PIC  X(50) VALUE SPACES.    00560000
008300     05  PV-ABEND-TABLE               PIC  X(12) VALUE SPACES.    00570000
008400     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    00580000
008500     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    00590000
008600     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    00600000
008700                                                                  00610000
008800                                                                  00620000
008900***********************************************************       00630000
009000*  COPYBOOK USED FOR THE PACKHEAD INPUT FILE              *       00640000
009100***********************************************************       00650000
009200     COPY XLRD027.                                                00660000
009300                                                                  00670000
009400***********************************************************       00680000
009500*  USED FOR DB2 ERROR MESSAGE BUILDING                    *       00690000
009600***********************************************************       00700000
009700     COPY DPWS004.                                                00710000
009800                                                                  00720000
009900***********************************************************       00730000
010000*  DB2 SQL COMMUNICATION AREA                             *       00740000
010100***********************************************************       00750000
010200     EXEC SQL                                                     00760000
010300          INCLUDE SQLCA                                           00770000
010400     END-EXEC.                                                    00780000
010500                                                                  00790000
010600***********************************************************       00800000
010700*  XLT_PK TABLE                                          *        00810000
010800***********************************************************       00820000
010900     EXEC SQL                                                     00830000
011000          INCLUDE XLT00007                                        00840000
011100     END-EXEC.                                                    00850000
011200                                                                  00860000
011300***************************************************************** 00870000
011400 PROCEDURE DIVISION.                                              00880000
011500***************************************************************** 00890000
011600     DISPLAY '**** BEGINNING XLKUP094 ****'.                      00900022
011700     DISPLAY ' '.                                                 00910000
011800                                                                  00920000
011900     OPEN INPUT  XLT-PK-IN.                                       00930000
012000     OPEN OUTPUT SUMMARY-FILE.                                    00931009
012100                                                                  00940000
012200     PERFORM 1000-READ-INPUT-FILE.                                00950000
012300                                                                  00960000
012400     PERFORM 2000-PROCESS-INPUT-FILE                              00970000
012500       UNTIL PS-EOF-INPUT-YES.                                    00980000
012600                                                                  00990000
012700     CLOSE XLT-PK-IN.                                             01000000
012800                                                                  01010000
012900     PERFORM 3000-TABLE-COMMIT.                                   01020000
013000                                                                  01030000
013100     PERFORM 4000-WRITE-SUMMARY.                                  01031008
013200     DISPLAY '  INPUT PK RECS READ    = ' PV-RECORDS-READ.        01040000
013300     DISPLAY '  XLT_PK ROWS INSERTED    = ' PV-RECORDS-INSERTED.  01050021
013400     DISPLAY '  XLT_PK INSERT SKIPPED   = ' PV-RECORDS-SKIP.      01050121
013500     DISPLAY '  XLT_PK ROWS UPDATED     = ' PV-RECORDS-UPDATED.   01051021
013600     DISPLAY '  XLT_PK UPDATE SKIPPED   = ' PV-UPDATES-SKIPPED.   01052021
013700     DISPLAY '  XLT_PK ROWS DELETED     = ' PV-RECORDS-DELETED.   01053021
013800     DISPLAY '  XLT_PK DELETE SKIPPED   = ' PV-DELETES-SKIPPED.   01054021
013900     DISPLAY ' '.                                                 01070000
014000     DISPLAY '****  END OF  XLKUP094  ****'.                      01080022
014100                                                                  01090000
014200     CLOSE SUMMARY-FILE.                                          01091009
014300     STOP RUN.                                                    01100000
014400                                                                  01110000
014500                                                                  01120000
014600***************************************************************** 01130000
014700*  READ A PACKHEAD EXTRACT RECORD THAT WILL BE USED TO INSERT    *01140000
014800*  A ROW OF DATA INTO THE XLT_PK TABLE.                        *  01150000
014900***************************************************************** 01160000
015000 1000-READ-INPUT-FILE.                                            01170000
015100                                                                  01180000
015200     MOVE '1000-READ-INPUT-FILE    ' TO PV-ABEND-PARAGRAPH.       01190000
015300                                                                  01200000
015400     INITIALIZE PA-DB2-COMMIT-COUNT.                              01210000
015500                                                                  01220000
015600     READ XLT-PK-IN                                               01230000
015700          INTO XL027-PACK-DATA                                    01240000
015800            AT END                                                01250000
015900               SET PS-EOF-INPUT-YES TO TRUE                       01260000
016000                                                                  01270000
016100            NOT AT END                                            01280000
016200               SET PS-EOF-INPUT-NO  TO TRUE                       01290000
016300               ADD +1 TO PV-RECORDS-READ                          01300000
016400     END-READ.                                                    01310000
016500                                                                  01320000
016600                                                                  01330000
016700***************************************************************** 01340000
016800*  LOAD THE INFORMATION FROM THE PACKHEAD EXTRACT FILE INTO THE * 01350000
016900*  HOST VARIABLES AND PERFORM A PARAGRAPH TO INSERT THE NEW ROW * 01360000
017000*  INTO THE XLT_PK  TABLE.                                      * 01370000
017100***************************************************************** 01380000
017200 2000-PROCESS-INPUT-FILE.                                         01390000
017300                                                                  01400000
017400     MOVE '2000-PROCESS-INPUT-FILE ' TO PV-ABEND-PARAGRAPH.       01410000
017500                                                                  01420000
017600     MOVE XL027-PACK-PK-SKU-NBR      TO XLT00007-PK-SKU-NBR.      01430000
017700     MOVE XL027-PACK-DEPT-NBR        TO XLT00007-DEPT-NBR.        01440000
017800     MOVE XL027-PACK-MAJ-CL-NBR      TO XLT00007-MAJ-CL-NBR.      01450000
017900     MOVE XL027-PACK-SUB-CL-NBR      TO XLT00007-SUB-CL-NBR.      01460000
018000     MOVE XL027-PACK-PK-DESC         TO XLT00007-PK-DESC.         01470000
018100     MOVE XL027-PACK-DC-ORD-MULT-QTY TO XLT00007-DC-ORD-MULT-QTY. 01480000
018200                                                                  01490000
018300     IF  XL027-PACK-ERROR-MESSAGE = 'NOT ON DOMAIN PACK HEADER'   01500000
018400         PERFORM 2100-INSERT-XLT-PK                               01510000
018500     END-IF.                                                      01520000
018600                                                                  01530000
018700     IF  XL027-PACK-ERROR-MESSAGE = 'DATA MISMATCH - RMS'         01531006
018800         PERFORM 2200-UPDATE-XLT-PK                               01532006
018900     END-IF.                                                      01533006
019000                                                                  01534006
019100     IF  XL027-PACK-ERROR-MESSAGE = 'NOT ON RMS PACK HEADER'      01535006
019200         PERFORM 2300-DELETE-XLT-PK                               01536006
019300     END-IF.                                                      01537006
019400                                                                  01538006
019500     PERFORM 1000-READ-INPUT-FILE.                                01540000
019600                                                                  01550000
019700                                                                  01560000
019800***************************************************************** 01570000
019900*  INSERT A ROW TO THE XLT_PK TABLE.                           *  01580000
020000***************************************************************** 01590000
020100 2100-INSERT-XLT-PK.                                              01600000
020200                                                                  01610000
020300     EXEC SQL                                                     01620000
020400          INSERT                                                  01630000
020500          INTO  XLT_PK                                            01640000
020600              ( PK_SKU_NBR                                        01650000
020700               ,PK_DESC                                           01660000
020800               ,DEPT_NBR                                          01670000
020900               ,MAJ_CL_NBR                                        01680000
021000               ,SUB_CL_NBR                                        01690000
021100               ,DC_ORD_MULT_QTY                                   01700005
021200               ,LAST_UPD_TMST)                                    01701005
021300          VALUES                                                  01710000
021400             (  :XLT00007-PK-SKU-NBR                              01720000
021500               ,:XLT00007-PK-DESC                                 01730000
021600               ,:XLT00007-DEPT-NBR                                01740000
021700               ,:XLT00007-MAJ-CL-NBR                              01750000
021800               ,:XLT00007-SUB-CL-NBR                              01760000
021900               ,:XLT00007-DC-ORD-MULT-QTY                         01770005
022000               ,CURRENT TIMESTAMP)                                01771005
022100     END-EXEC.                                                    01780000
022200                                                                  01790000
022300     EVALUATE TRUE                                                01800000
022400         WHEN SQLCODE = ZERO                                      01810000
022500              ADD +1                 TO PV-RECORDS-INSERTED       01820000
022600              ADD +1                 TO PA-DB2-COMMIT-COUNT       01830000
022700              IF PA-DB2-COMMIT-COUNT > 4500                       01840000
022800                  PERFORM 3000-TABLE-COMMIT                       01850000
022900                  MOVE 0 TO PA-DB2-COMMIT-COUNT                   01860000
023000              END-IF                                              01870000
023100         WHEN SQLCODE = -803                                      01880000
023200         WHEN SQLCODE = -530                                      01890000
023300              ADD +1                 TO PV-RECORDS-SKIP           01900000
023400         WHEN SQLCODE NOT = +0                                    01910000
023500              MOVE '2100-INSERT-XLT-PK'                           01920000
023600                                     TO PV-ABEND-PARAGRAPH        01930000
023700              MOVE 'INSERT XLT_PK'                                01940000
023800                                     TO PV-ABEND-OPERATION        01950000
023900              STRING 'SKU NBR: '           DELIMITED BY SIZE      01960000
024000                     XL027-PACK-PK-SKU-NBR DELIMITED BY SIZE      01970000
024100                                   INTO PV-DB2-OPERATION-MESSAGE-101980000
024200                                                                  01990000
024300              MOVE 'XLT_PK'          TO PV-ABEND-TABLE            02000000
024400              PERFORM Z999-SQL-ABEND                              02010000
024500     END-EVALUATE.                                                02020000
024600                                                                  02030000
024700                                                                  02040000
024800***************************************************************** 02041006
024900*  UPDATE A ROW TO THE XLT_PK TABLE.                           *  02042006
025000***************************************************************** 02043006
025100 2200-UPDATE-XLT-PK.                                              02044006
025200                                                                  02045006
025300     EXEC SQL                                                     02046006
025400          UPDATE                                                  02047006
025500             XLT_PK                                               02048006
025600          SET                                                     02049006
025700                PK_DESC         = :XLT00007-PK-DESC               02049206
025800               ,DEPT_NBR        = :XLT00007-DEPT-NBR              02049306
025900               ,MAJ_CL_NBR      = :XLT00007-MAJ-CL-NBR            02049406
026000               ,SUB_CL_NBR      = :XLT00007-SUB-CL-NBR            02049506
026100               ,DC_ORD_MULT_QTY = :XLT00007-DC-ORD-MULT-QTY       02049606
026200               ,LAST_UPD_TMST   = CURRENT TIMESTAMP               02049706
026300          WHERE                                                   02049806
026400               PK_SKU_NBR       = :XLT00007-PK-SKU-NBR            02049906
026500     END-EXEC.                                                    02050606
026600                                                                  02050706
026700     EVALUATE TRUE                                                02050806
026800         WHEN SQLCODE = ZERO                                      02050906
026900              ADD +1                 TO PV-RECORDS-UPDATED        02051006
027000              ADD +1                 TO PA-DB2-COMMIT-COUNT       02051106
027100              IF PA-DB2-COMMIT-COUNT > 4500                       02051206
027200                  PERFORM 3000-TABLE-COMMIT                       02051306
027300                  MOVE 0 TO PA-DB2-COMMIT-COUNT                   02051406
027400              END-IF                                              02051506
027500         WHEN SQLCODE = +100                                      02051606
027600              ADD +1                 TO PV-UPDATES-SKIPPED        02051806
027700         WHEN SQLCODE NOT = +0                                    02051906
027800              MOVE '2200-UPDATE-XLT-PK'                           02052006
027900                                     TO PV-ABEND-PARAGRAPH        02052106
028000              MOVE 'UPDATE XLT_PK'                                02052206
028100                                     TO PV-ABEND-OPERATION        02052306
028200              STRING 'SKU NBR: '           DELIMITED BY SIZE      02052406
028300                     XL027-PACK-PK-SKU-NBR DELIMITED BY SIZE      02052506
028400                                   INTO PV-DB2-OPERATION-MESSAGE-102052606
028500                                                                  02052706
028600              MOVE 'XLT_PK'          TO PV-ABEND-TABLE            02052806
028700              PERFORM Z999-SQL-ABEND                              02052906
028800     END-EVALUATE.                                                02053006
028900                                                                  02053106
029000                                                                  02053206
029100***************************************************************** 02053306
029200*  DELETE A ROW TO THE XLT_PK TABLE.                           *  02053406
029300***************************************************************** 02053506
029400 2300-DELETE-XLT-PK.                                              02053606
029500                                                                  02053706
029600     EXEC SQL                                                     02053806
029700          DELETE                                                  02053906
029800             FROM XLT_PK                                          02054006
029900          WHERE                                                   02054806
030000               PK_SKU_NBR       = :XLT00007-PK-SKU-NBR            02054906
030100     END-EXEC.                                                    02055006
030200                                                                  02055106
030300     EVALUATE TRUE                                                02055206
030400         WHEN SQLCODE = ZERO                                      02055306
030500              ADD +1                 TO PV-RECORDS-DELETED        02055406
030600              ADD +1                 TO PA-DB2-COMMIT-COUNT       02055506
030700              IF PA-DB2-COMMIT-COUNT > 4500                       02055606
030800                  PERFORM 3000-TABLE-COMMIT                       02055706
030900                  MOVE 0 TO PA-DB2-COMMIT-COUNT                   02055806
031000              END-IF                                              02055906
031100         WHEN SQLCODE = +100                                      02056006
031200              ADD +1                 TO PV-DELETES-SKIPPED        02056106
031300         WHEN SQLCODE NOT = +0                                    02056206
031400              MOVE '2300-DELETE-XLT-PK'                           02056306
031500                                     TO PV-ABEND-PARAGRAPH        02056406
031600              MOVE 'DELETE XLT_PK'                                02056506
031700                                     TO PV-ABEND-OPERATION        02056606
031800              STRING 'SKU NBR: '           DELIMITED BY SIZE      02056706
031900                     XL027-PACK-PK-SKU-NBR DELIMITED BY SIZE      02056806
032000                                   INTO PV-DB2-OPERATION-MESSAGE-102056906
032100                                                                  02057006
032200              MOVE 'XLT_PK'          TO PV-ABEND-TABLE            02057106
032300              PERFORM Z999-SQL-ABEND                              02057206
032400     END-EVALUATE.                                                02057306
032500                                                                  02057406
032600                                                                  02057506
032700***************************************************************** 02058006
032800* COMMIT THE PENDING TABLE CHANGES.                             * 02060000
032900***************************************************************** 02070000
033000 3000-TABLE-COMMIT.                                               02080000
033100                                                                  02090000
033200     EXEC SQL                                                     02100000
033300          COMMIT                                                  02110000
033400     END-EXEC.                                                    02120000
033500                                                                  02130000
033600***************************************************************** 02141008
033700* WRITE RECORDS PROCESSED COUNT TO COUNT FILE                 *   02142011
033800***************************************************************** 02143008
033900 4000-WRITE-SUMMARY.                                              02144008
034000                                                                  02145008
034100     STRING "NO. OF INSERTS:"     DELIMITED BY SIZE               02146611
034200             PV-RECORDS-INSERTED  DELIMITED BY SPACE              02146713
034300      INTO PV-FIRST-LINE                                          02146811
034400                                                                  02146910
034500     STRING "NO. OF UPDATES:"     DELIMITED BY SIZE               02147011
034600             PV-RECORDS-UPDATED   DELIMITED BY SPACE              02147113
034700      INTO PV-SECOND-LINE                                         02147211
034800                                                                  02147311
034900     STRING "NO. OF DELETES:"     DELIMITED BY SIZE               02147411
035000             PV-RECORDS-DELETED   DELIMITED BY SPACE              02147513
035100      INTO PV-THIRD-LINE                                          02147612
035200                                                                  02147711
035300     WRITE SUMMARY-FILE-RECORD FROM PV-ZERO-LINE.                 02148018
035400     WRITE SUMMARY-FILE-RECORD FROM PV-FIRST-LINE.                02148118
035500     WRITE SUMMARY-FILE-RECORD FROM PV-SECOND-LINE.               02149017
035600     WRITE SUMMARY-FILE-RECORD FROM PV-THIRD-LINE.                02149117
035700                                                                  02149317
035800***************************************************************** 02150000
035900*  DISPLAY DB2 ERROR INFORMATION, ROLLBACK ANY PENDING CHANGES, * 02160000
036000*  AND ABEND THE PROGRAM.                                       * 02170000
036100***************************************************************** 02180000
036200 Z999-SQL-ABEND.                                                  02190000
036300                                                                  02200000
036400     MOVE SQLCODE            TO PV-SQLCODE.                       02210000
036500     MOVE PV-SQLCODE         TO PV-DISP-SQLCODE.                  02220000
036600     DISPLAY '*** DB2 ERROR '.                                    02230000
036700     DISPLAY '*** SQLCODE   = ' PV-DISP-SQLCODE.                  02240000
036800     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 02250000
036900     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               02260000
037000     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               02270000
037100     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       02280000
037200     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.       02290000
037300     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-3.       02300000
037400     DISPLAY '*** TABLE 1   = ' PV-ABEND-TABLE.                   02310000
037500                                                                  02320000
037600     COPY DPPD004.                                                02330000
037700                                                                  02340000
037800     MOVE +4013         TO PV-ABEND-CODE.                         02350000
037900     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         02360000
