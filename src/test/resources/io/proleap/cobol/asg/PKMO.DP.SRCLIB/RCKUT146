000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020001
000300***************************************************************** 00030001
000400 PROGRAM-ID.             RCKUT146.                                00040001
000500 AUTHOR.                 V.SUDHAN.                                00050001
000600 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00060001
000700 DATE-WRITTEN.           MARCH, 2010.                             00070001
000800 DATE-COMPILED.                                                   00080001
000900***************************************************************** 00090001
001000*                                                               * 00100001
001100*  THIS PROGRAM WILL USE A CURSOR TO DETERMINE THE PO-RCVR'S    * 00110001
001200*  THAT HAVE BEEN VERIFIED BETWEEN A SET OF DATES.              * 00120001
001300*                                                               * 00130001
001400*  DATE PARAMETERS WILL BE USED TO DETERMINE WHAT VERIFIED      * 00140001
001410*  RECEIVERS WE WILL BE PURGING THE DATA FOR. THE DATES WILL BE * 00141001
001420*  DETERMINED BY WST INTEGRATION TABLES - PARM "TRKGPURG1".     * 00142001
001430*                                                               * 00143001
001440*  OUTPUT FILE WILL BE CREATED IN THE RCRD089 LAYOUT.           * 00144001
001450*                                                               * 00145001
001460*  OUTPUT OF THIS MODULE WILL BE USED BY MODULE RCKUT147 TO     * 00146001
001470*  DETERMINE DATA TO BE PURGED.                                 * 00147001
001480*                                                               * 00148001
001490***************************************************************** 00149001
001500 ENVIRONMENT DIVISION.                                            00150001
001600***************************************************************** 00160001
001700*                                                                 00170001
001800 CONFIGURATION SECTION.                                           00180001
001900*                                                                 00190001
002000 SOURCE-COMPUTER.        IBM-3090.                                00200001
002100 OBJECT-COMPUTER.        IBM-3090.                                00210001
002200*                                                                 00220001
002300 INPUT-OUTPUT SECTION.                                            00230001
002400*                                                                 00240001
002500 FILE-CONTROL.                                                    00250001
002600*                                                                 00260001
002700     SELECT RCVR-PURGE-EXT-FILE                                   00270001
002800            ASSIGN TO OUT01.                                      00280001
002900*                                                                 00290001
003000***************************************************************** 00300001
003100 DATA DIVISION.                                                   00310001
003200***************************************************************** 00320001
003300*                                                                 00330001
003400 FILE SECTION.                                                    00340001
003500*                                                                 00350001
003600 FD  RCVR-PURGE-EXT-FILE                                          00360001
003700     RECORDING MODE IS F                                          00370001
003800     BLOCK CONTAINS 0  RECORDS.                                   00380001
003900 01  RCVR-PURGE-EXT-REC              PIC  X(075).                 00390001
004000*                                                                 00400001
004100                                                                  00410001
004200 WORKING-STORAGE SECTION.                                         00420001
004300*                                                                 00430001
004400 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00440001
004500                                                   COMP SYNC.     00450001
004600*                                                                 00460001
004700 01  PROGRAM-SWITCHES.                                            00470001
004800     05  PS-EOF-RCVR-CSR-SW          PIC  X(01)    VALUE 'N'.     00480001
004900         88  PS-EOF-RCVR-DATA-CSR                  VALUE 'Y'.     00490001
005000         88  PS-NOT-EOF-RCVR-DATA-CSR              VALUE 'N'.     00500001
005100*                                                                 00510001
005200 01  PC-PROGRAM-CONSTANTS.                                        00520001
005300     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00530001
005400                                                   'RCKUT146'.    00540001
005500     05  PC-FROM-DATE                PIC  X(10)  VALUE SPACES.    00550001
005600     05  PC-TO-DATE                  PIC  X(10)  VALUE SPACES.    00560001
005700     05  PC-VERIFY-B4-DATE           PIC  X(10)  VALUE SPACES.    00570001
005800*                                                                 00580001
005900 01  PV-PROGRAM-VARIABLES.                                        00590001
006000     05  PV-ABEND-PARAGRAPH          PIC  X(30)  VALUE SPACES.    00600001
006100     05  PV-PARAGRAPH-NAME           PIC  X(30)  VALUE SPACES.    00610001
006200     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)  VALUE SPACES.    00620001
006300                                                                  00630001
006400     05  PV-RCVR-DATA-CNT            PIC  9(09)  VALUE ZEROS.     00640001
006500     05  PV-RCVR-TOTAL-CNT           PIC  9(09)  VALUE ZEROS.     00650001
006600*                                                                 00660001
006700******************************************************************00670001
006800*  COPY BOOK FOR THE RECEIVER TRACKING TABLE                      00680001
006900******************************************************************00690001
007000     COPY RCRD089.                                                00700001
007100******************************************************************00710001
007200*  DB2 FORMATTED MESSAGE AREA                                     00720001
007300******************************************************************00730001
007400     COPY DPWS004.                                                00740001
007500******************************************************************00750001
007600*  DB2 COMMUNICATION AREA                                         00760001
007700******************************************************************00770001
007800     EXEC SQL                                                     00780001
007900         INCLUDE SQLCA                                            00790001
008000     END-EXEC.                                                    00800001
008100******************************************************************00810001
008200*  DB2 COMMUNICATION AREA2                                        00820001
008300******************************************************************00830001
008400     COPY SQLCA2.                                                 00840001
008500******************************************************************00850001
008600*  COPY BOOK FOR THE RECEIVER TABLE                               00860001
008700******************************************************************00870001
008800     EXEC SQL                                                     00880001
008900          INCLUDE WST00008                                        00890001
009000     END-EXEC.                                                    00900001
009100*                                                                 00910001
009200     EXEC SQL                                                     00920001
009300          INCLUDE WST00009                                        00930001
009400     END-EXEC.                                                    00940001
009500*                                                                 00950001
009600     EXEC SQL                                                     00960001
009700          INCLUDE WST00010                                        00970001
009800     END-EXEC.                                                    00980001
009900*                                                                 00990001
010000     EXEC SQL                                                     01000001
010100          INCLUDE TRECEIV                                         01010001
010200     END-EXEC.                                                    01020001
010300*                                                                 01030001
010400     EXEC SQL                                                     01040001
010500          INCLUDE TRECITM                                         01050001
010600     END-EXEC.                                                    01060001
010700*                                                                 01070001
010800     EXEC SQL                                                     01080001
010900       DECLARE RCVR-DATA-CSR CURSOR FOR                           01090001
011000           SELECT A.ORD_NBR                                       01100001
011100                 ,A.REC_SEQ_NBR                                   01110001
011200                 ,A.STATUS_CDE                                    01120001
011300                 ,A.VERFYD_TMST                                   01130001
011400                 ,B.ORD_LNE_NBR                                   01140001
011500                 ,B.PREPK_ID                                      01150001
011600                  FROM TRECEIV A,                                 01160001
011700                       TRECITM B                                  01170001
011800           WHERE DATE(A.VERFYD_TMST) >= :PC-FROM-DATE             01180003
011900            AND  DATE(A.VERFYD_TMST) <= :PC-TO-DATE               01190003
012000            AND  DATE(A.VERFYD_TMST) <  :PC-VERIFY-B4-DATE        01200003
012100            AND  A.ORD_NBR           =  B.ORD_NBR                 01210001
012200            AND  A.REC_SEQ_NBR       =  B.REC_SEQ_NBR             01220001
012300              ORDER BY A.ORD_NBR,                                 01230001
012400                       A.REC_SEQ_NBR,                             01240001
012500                       B.ORD_LNE_NBR,                             01250001
012510                       B.PREPK_ID                                 01251001
012520     END-EXEC.                                                    01252001
012530*                                                                 01253001
012540 PROCEDURE DIVISION.                                              01254001
012550*                                                                 01255001
012560******************************************************************01256001
012570**  THIS IS THE MAIN DRIVER FOR THE PROGRAM.                    **01257001
012580******************************************************************01258001
012590*                                                                 01259001
012600 0000-MAINLINE-PROCESSING.                                        01260001
012700*                                                                 01270001
012800     PERFORM 1000-INITIALIZATION.                                 01280001
012900*                                                                 01290001
013000     PERFORM 2000-PROCESS-RCVR-EXT-DATA UNTIL                     01300001
013100             PS-EOF-RCVR-DATA-CSR.                                01310001
013200*                                                                 01320001
013300     IF PV-RCVR-DATA-CNT  EQUAL ZEROES                            01330001
013400        DISPLAY '** RCKUT146-NO RECRODS FOUND FOR THE DATE : '    01340001
013500        DISPLAY 'VERIFY BEFORE DATE : ' PC-VERIFY-B4-DATE         01350001
013600        DISPLAY 'FROM DATE          : ' PC-FROM-DATE              01360001
013700        DISPLAY 'TO DATE            : ' PC-TO-DATE                01370001
013800     END-IF                                                       01380001
013900*                                                                 01390001
014000     DISPLAY '                                             '.     01400001
014100     DISPLAY '** RCKUT146-TOTAL NO OF RECORDS FETCHED    : '      01410001
014200             PV-RCVR-DATA-CNT                                     01420001
014300     DISPLAY '** RCKUT146-TOTAL OUTPUT RECORDS WRITTEN   : '      01430001
014400             PV-RCVR-TOTAL-CNT.                                   01440001
014500     DISPLAY '                                             '.     01450001
014600     DISPLAY '** PROGRAM RCKUT146 EXECUTION ENDED   **     '.     01460001
014700*                                                                 01470001
014800     PERFORM 3000-CLOSE-RCVR-DATA-CSR.                            01480001
014900     CLOSE RCVR-PURGE-EXT-FILE.                                   01490001
015000*                                                                 01500001
015100     GOBACK.                                                      01510001
015200*                                                                 01520001
015300******************************************************************01530001
015400** PERFORM THE INITIAL PROCESSING FOR THE PROGRAM.              **01540001
015500******************************************************************01550001
015600*                                                                 01560001
015700 1000-INITIALIZATION.                                             01570001
015800*                                                                 01580001
015900     DISPLAY '** PROGRAM RCKUT146 EXECUTION STARTED **'.          01590001
016000*                                                                 01600001
016100     OPEN OUTPUT RCVR-PURGE-EXT-FILE.                             01610001
016200     PERFORM 1100-SELECT-DATE-VALUES.                             01620001
016300*                                                                 01630001
016400     SET  PS-NOT-EOF-RCVR-DATA-CSR TO TRUE.                       01640001
016500*                                                                 01650001
016600     INITIALIZE  RC089-PO-RCVR-TRKG-DELETE.                       01660001
016700     PERFORM 1200-OPEN-RCVR-DATA-CSR.                             01670001
016800     PERFORM 8100-FETCH-RCVR-DATA-CSR.                            01680001
016900*                                                                 01690001
017000******************************************************************01700001
017100** THIS PARAGRAPH WILL SELECT THE DATE RANGE TO FETCH THE       **01710001
017110** RECORDS FROM THE RECEIVER TABLES (TRECEIV AND TRECITM)       **01711001
017120******************************************************************01712001
017130*                                                                 01713001
017140 1100-SELECT-DATE-VALUES.                                         01714001
017150*                                                                 01715001
017160      EXEC SQL                                                    01716001
017170      SELECT CURRENT DATE - C.ATTR_ELEM_NBR DAYS AS VERIFY_BEFORE 01717001
017180           , CURRENT DATE - D.ATTR_ELEM_NBR DAYS AS FROM_DATE     01718001
017190           , CURRENT DATE - E.ATTR_ELEM_NBR DAYS AS TO_DATE       01719001
017200         INTO :PC-VERIFY-B4-DATE                                  01720001
017300            , :PC-FROM-DATE                                       01730001
017400            , :PC-TO-DATE                                         01740001
017500        FROM WST_INTGRTN_TYP A                                    01750001
017600           , WST_ATTR_DEFN   B                                    01760001
017700           , WST_ATTR_ELEM   C                                    01770001
017800           , WST_ATTR_ELEM   D                                    01780001
017900           , WST_ATTR_ELEM   E                                    01790001
018000       WHERE A.APPL_FUNC_DESC    = 'TRKGPURGE'                    01800001
018100         AND A.INTGRTN_TYP_CDE   = 'TRKGPURGE1'                   01810001
018200         AND A.INTGRTN_TYP_CDE   = B.INTGRTN_TYP_CDE              01820001
018300         AND B.ATTR_DEFN_SEQ_NBR = 1                              01830001
018400         AND A.INTGRTN_TYP_CDE   = C.INTGRTN_TYP_CDE              01840001
018500         AND C.ATTR_DEFN_SEQ_NBR = 1                              01850001
018600         AND A.INTGRTN_TYP_CDE   = D.INTGRTN_TYP_CDE              01860001
018700         AND D.ATTR_DEFN_SEQ_NBR = 2                              01870001
018800         AND A.INTGRTN_TYP_CDE   = E.INTGRTN_TYP_CDE              01880001
018900         AND E.ATTR_DEFN_SEQ_NBR = 3                              01890001
019000      END-EXEC.                                                   01900001
019100*                                                                 01910001
019200     EVALUATE TRUE                                                01920001
019300         WHEN SQLCODE = 0                                         01930001
019400              DISPLAY 'VERIFY BEFORE DATE : ' PC-VERIFY-B4-DATE   01940001
019500              DISPLAY 'FROM DATE          : ' PC-FROM-DATE        01950001
019600              DISPLAY 'TO DATE            : ' PC-TO-DATE          01960001
019700         WHEN SQLCODE = +100                                      01970001
019710           DISPLAY 'RCKUT146 - NO RECORDS SELECTED FOR THE INPUT' 01971001
019720         WHEN SQLWARN0 NOT = SPACES                               01972001
019730         WHEN SQLCODE < ZERO                                      01973001
019740         WHEN SQLCODE > ZERO                                      01974001
019750             MOVE '1100-SELECT-DATE-VALUES'                       01975001
019760                             TO PV-PARAGRAPH-NAME                 01976001
019770             MOVE 'SELECT THE DATE RANGE FROM ATTR '              01977001
019780                             TO PV-DB2-OPERATION-ATTEMPTED        01978001
019790             PERFORM 9000-SQL-ABEND                               01979001
019800     END-EVALUATE.                                                01980001
019900*                                                                 01990001
020000******************************************************************02000001
020100**  THIS PARAGRAPH OPENS THE CURSOR WHICH WILL CONTAIN THE NO   **02010001
020200**  OF PO ORD THAT CAN BEOLD ENOUGH AND CAN BE PURGED.          **02020001
020300******************************************************************02030001
020400*                                                                 02040001
020500 1200-OPEN-RCVR-DATA-CSR.                                         02050001
020600*                                                                 02060001
020700     EXEC SQL                                                     02070001
020800          OPEN RCVR-DATA-CSR                                      02080001
020900     END-EXEC.                                                    02090001
021000*                                                                 02100001
021100     EVALUATE TRUE                                                02110001
021200         WHEN SQLCODE = 0                                         02120001
021300             CONTINUE                                             02130001
021400         WHEN SQLWARN0 NOT = SPACES                               02140001
021500         WHEN SQLCODE < ZERO                                      02150001
021600         WHEN SQLCODE > ZERO                                      02160001
021700             MOVE '1200-OPEN-RCVR-DATA-CSR'                       02170001
021800                             TO PV-PARAGRAPH-NAME                 02180001
021900             MOVE 'OPEN THE RCVR-DATA-CSR        '                02190001
022000                             TO PV-DB2-OPERATION-ATTEMPTED        02200001
022100             PERFORM 9000-SQL-ABEND                               02210001
022200     END-EVALUATE.                                                02220001
022300*                                                                 02230001
022400******************************************************************02240001
022500**  THIS PARAGRAPH READS THE RECORDS FROM PO ORD NBR PURGE CSR  **02250001
022600**  RCVR-DATA-CSR  AND WRITE A RECORD TO THE OUTPUT FILE.       **02260001
022700******************************************************************02270001
022800*                                                                 02280001
022900 2000-PROCESS-RCVR-EXT-DATA.                                      02290001
023000*                                                                 02300001
023100      MOVE RECEIV-ORD-NBR     TO RC089-ORD-NBR                    02310001
023200      MOVE RECEIV-REC-SEQ-NBR TO RC089-REC-SEQ-NBR                02320001
023210      MOVE RECEIV-STATUS-CDE  TO RC089-STATUS-CDE                 02321001
023220      MOVE RECEIV-VERFYD-TMST TO RC089-VERFYD-TMST                02322001
023230      MOVE RECITM-ORD-LNE-NBR TO RC089-ORD-LNE-NBR                02323001
023240      MOVE RECITM-PREPK-ID    TO RC089-PREPK-ID                   02324001
023250      PERFORM 8000-WRITE-EXTRACT-RECORD                           02325001
023260      PERFORM 8100-FETCH-RCVR-DATA-CSR.                           02326001
023270*                                                                 02327001
023280******************************************************************02328001
023290**  THIS PARAGRAPH CLOSES THE CURSOR WHICH WILL CONTAIN THE PO  **02329001
023300**  ORDERS THAT CAN HAVE THE DATA WHICH CAN BE PURGED.          **02330001
023400******************************************************************02340001
023500*                                                                 02350001
023600 3000-CLOSE-RCVR-DATA-CSR.                                        02360001
023700*                                                                 02370001
023800     EXEC SQL                                                     02380001
023900         CLOSE RCVR-DATA-CSR                                      02390001
024000     END-EXEC.                                                    02400001
024100*                                                                 02410001
024200     EVALUATE TRUE                                                02420001
024300         WHEN SQLCODE = ZERO                                      02430001
024400         WHEN SQLCODE = -904                                      02440001
024500         WHEN SQLCODE = -911                                      02450001
024600              CONTINUE                                            02460001
024700         WHEN SQLWARN0 NOT = SPACES                               02470001
024800         WHEN SQLCODE < ZERO                                      02480001
024900         WHEN SQLCODE > ZERO                                      02490001
025000              MOVE '3000-CLOSE-RCVR-DATA-CSR'                     02500001
025100                              TO PV-PARAGRAPH-NAME                02510001
025200              MOVE 'CLOSE THE RCVR-DATA-CSR              '        02520001
025300                              TO PV-DB2-OPERATION-ATTEMPTED       02530001
025400              PERFORM 9000-SQL-ABEND                              02540001
025500     END-EVALUATE.                                                02550001
025600*                                                                 02560001
025700******************************************************************02570001
025800**  THIS PARAGRAPH WRITES THE RECORDS IN TO THE OUTPUT FILE     **02580001
025900**  IN AHRD002 LAYOUT.                                          **02590001
026000******************************************************************02600001
026100*                                                                 02610001
026200 8000-WRITE-EXTRACT-RECORD.                                       02620001
026300*                                                                 02630001
026400      WRITE RCVR-PURGE-EXT-REC                                    02640001
026500       FROM RC089-PO-RCVR-TRKG-DELETE.                            02650001
026600        ADD 1 TO PV-RCVR-TOTAL-CNT.                               02660001
026700*                                                                 02670001
026800******************************************************************02680001
026900**  THIS PARAGRAPH FETCHES THE CURSOR WHICH WILL CONTAIN THE PO **02690001
027000**  ORDERS THAT CAN HAVE THE DATA WHICH CAN BE PURGED.          **02700001
027100******************************************************************02710001
027200*                                                                 02720001
027300 8100-FETCH-RCVR-DATA-CSR.                                        02730001
027400*                                                                 02740001
027500     EXEC SQL                                                     02750001
027600          FETCH RCVR-DATA-CSR                                     02760001
027700          INTO  :RECEIV-ORD-NBR                                   02770001
027800             ,  :RECEIV-REC-SEQ-NBR                               02780001
027900             ,  :RECEIV-STATUS-CDE                                02790001
028000             ,  :RECEIV-VERFYD-TMST                               02800001
028100             ,  :RECITM-ORD-LNE-NBR                               02810001
028200             ,  :RECITM-PREPK-ID                                  02820001
028300     END-EXEC.                                                    02830001
028400*                                                                 02840001
028500     EVALUATE TRUE                                                02850001
028600       WHEN SQLCODE = ZEROS                                       02860001
028700            ADD  1  TO  PV-RCVR-DATA-CNT                          02870001
028800       WHEN SQLCODE = +100                                        02880001
028900            SET PS-EOF-RCVR-DATA-CSR TO TRUE                      02890001
029000       WHEN SQLWARN0 NOT = SPACES                                 02900001
029100       WHEN SQLCODE < ZERO                                        02910001
029200       WHEN SQLCODE > ZERO                                        02920001
029300           MOVE '8100-FETCH-RCVR-DATA-CSR'                        02930001
029400                               TO PV-PARAGRAPH-NAME               02940001
029500           MOVE 'FETCH RCVR-DATA-CSR CURSOR '                     02950001
029600                               TO PV-DB2-OPERATION-ATTEMPTED      02960001
029700           PERFORM 9000-SQL-ABEND                                 02970001
029800     END-EVALUATE.                                                02980001
029900*                                                                 02990001
030000******************************************************************03000001
030100*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL   *03010001
030200*  ERROR OR WARNING CODE OCCURS.                                 *03020001
030300******************************************************************03030001
030400*                                                                 03040001
030500 9000-SQL-ABEND.                                                  03050001
030600*                                                                 03060001
030700     DISPLAY '9000-SQL-ABEND'.                                    03070001
030800     DISPLAY '** ABEND     **'.                                   03080001
030900     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        03090001
031000     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              03100001
031100     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     03110001
031200*                                                                 03120001
031300******************************************************************03130001
031400* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *03140001
031500* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *03150001
031600* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *03160001
031700* FORMAT.                                                        *03170001
031800******************************************************************03180001
031900*                                                                 03190001
032000     COPY DPPD004.                                                03200001
032100*                                                                 03210001
032200     MOVE +4013         TO ABEND-CODE.                            03220001
032300     CALL 'ILBOABN0' USING ABEND-CODE.                            03230001
032400*                                                                 03240001
