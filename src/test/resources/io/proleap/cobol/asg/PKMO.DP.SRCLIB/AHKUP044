000100 IDENTIFICATION DIVISION.                                         00010016
000200 PROGRAM-ID.         AHKUP044.                                    00020016
000300 AUTHOR.             NANCY EILBES.                                00030016
000400 DATE-WRITTEN.       APRIL 2000.                                  00040016
000500 DATE-COMPILED.                                                   00050016
000600*************************************************************     00060016
000700*    COBOL 2 WITH SQL                                       *     00070016
000800*                                                           *     00080016
000900*   AHKUP044 - ARCHIVE HISTORY DATA DELETION - TPOPRPK      *     00090016
001000*                                                           *     00100016
001100*   PROGRAM OVERVIEW:                                       *     00110016
001200*                                                           *     00120016
001300*  THIS PROGRAM DELETES "OLD" ROWS FROM DB2 TABLE TPOPRPK.  *     00130016
001400*  ROWS DELETED ARE THOSE PREVIOUSLY - IDENTIFIED/EXTRACTED *     00140016
001500*  WITHIN THE ARCHIVE/HISTORY SYSTEM.                       *     00150016
001600*                                                           *     00160016
001700*  THE EXTRACT FILE USED AS INPUT WILL BE SORTED BY THE     *     00170016
001800*  UNIQUE INDEX COLUMNS TO SPEED THE DELETION PROCESS.      *     00180016
001900*  THESE COLUMNS ARE PO_NBR, VER_NBR, PO_PREPK_ID.          *     00190016
002000*                                                           *     00200016
002100*   INPUT:                                                  *     00210016
002200*                                                           *     00220016
002300*     1. TPOPRPK DELETION FILE  COPYBOOK DCLTPOPRPK         *     00230016
002400*                                                           *     00240016
002500*   DB2 TABLES:                                             *     00250016
002600*                                                           *     00260016
002700*        TPOPRPK - PURCHASE ORDER PREPACK TABLE             *     00270016
002800*        TCKRSTIN - CHECKPOINT/RESTART INFO TABLE           *     00280016
002900*        TCKRSTCN - CHECKPOINT/RESTART CONTROL TABLE        *     00290016
003000*                                                           *     00300016
003100*************************************************************     00310016
P5207 * DATE: 11/18/2013 CHANGE MADE BY: COGNIZANT(SHEBENA)       *     00320023
P5207 * CHANGE MADE: MODIFIED THE PROGRAM TO REMOVE THE           *     00321023
P5207 *              PO_IN_RMS_IND CHECK BEFORE DELETE.           *     00322023
P5207 * CHANGE TAG - P5207, CR NO - CHG0081355                    *     00323024
003300*************************************************************     00330016
003400 EJECT                                                            00340016
003500 ENVIRONMENT DIVISION.                                            00350016
003600 CONFIGURATION SECTION.                                           00360016
003700 SOURCE-COMPUTER.        IBM-370.                                 00370016
003800 OBJECT-COMPUTER.        IBM-370.                                 00380016
003900                                                                  00390016
004000 INPUT-OUTPUT SECTION.                                            00400016
004100 FILE-CONTROL.                                                    00410016
004200     SELECT TPOPRPK-EXTRACT-FILE ASSIGN TO INP01.                 00420016
004300                                                                  00430016
004400 DATA DIVISION.                                                   00440016
004500 FILE SECTION.                                                    00450016
004600 FD  TPOPRPK-EXTRACT-FILE                                         00460016
004700     RECORDING MODE IS F                                          00470016
004800     LABEL RECORDS ARE STANDARD                                   00480016
004900     BLOCK CONTAINS 0 RECORDS                                     00490016
005000     RECORD CONTAINS 104 CHARACTERS                               00500016
005100     DATA RECORD IS TPOPRPK-EXTRACT-DATA.                         00510016
005200 01  TPOPRPK-EXTRACT-DATA       PIC X(104).                       00520016
005300                                                                  00530016
005400                                                                  00540016
005500 EJECT                                                            00550016
005600 WORKING-STORAGE SECTION.                                         00560016
005700                                                                  00570016
005800 01  FILLER                       PIC X(58)     VALUE             00580016
005900     '************WORKING STORAGE STARTS HERE*******************'.00590016
006000                                                                  00600016
006100 01  PV-PROGRAM-VARIABLES.                                        00610016
006200     05  PV-PROGRAM-NAME          PIC  X(08)    VALUE 'AHKUP044'. 00620016
006300     05  PV-CKPT-STAT-CODE        PIC X(01)     VALUE SPACE.      00630016
006400     05  PV-CURRENT-PARAGRAPH     PIC X(50)     VALUE SPACES.     00640016
006500     05  PV-CURRENT-TMST          PIC X(26)     VALUE SPACES.     00650016
006600                                                                  00660016
006700     05  PV-TPOPRPK-INPUT-COUNT   PIC 9(09)     VALUE ZERO        00670016
006800                                                COMP-3.           00680016
006900     05  PV-TPOPRPK-DELETE-COUNT  PIC 9(09)     VALUE ZERO        00690016
007000                                                COMP-3.           00700016
007100     05  PV-SQL-DELETE-COUNT      PIC 9(09)     VALUE ZERO        00710016
007200                                                COMP-3.           00720016
007300     05  PV-SQLERRD3              PIC S9(09)    VALUE ZERO        00730016
007400                                                COMP-3.           00740016
007500     05  PV-DISP-PO-NBR           PIC X(09)    VALUE SPACES.      00750016
007600     05  PV-DISP-VER-NBR          PIC X(09)    VALUE SPACES.      00760016
007700     05  PV-DISP-PREPK-ID         PIC X(09)    VALUE SPACES.      00770016
007900     05  PV-SAVE-PO-NBR           PIC S9(09) COMP                 00790016
008000                                               VALUE ZEROES.      00800016
008100 01  PC-PROGRAM-CONSTANTS.                                        00810016
008200     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          00820016
008300                                                COMP SYNC.        00830016
008400     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      00840016
008500     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00850016
008600     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00860016
008700                                                                  00870016
008800 01  PS-PROGRAM-SWITCHES.                                         00880016
008900     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.        00890016
009000         88  COMMITS-TAKEN                      VALUE 'T'.        00900016
009100         88  NO-COMMITS-TAKEN                   VALUE 'N'.        00910016
009200     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.        00920016
009300         88  MORE-EXTRACT                       VALUE 'M'.        00930016
009400         88  END-OF-EXTRACT                     VALUE 'E'.        00940016
009500     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        00950016
009600         88  NORMAL-RUN                         VALUE '0'.        00960016
009700         88  RESTART-RUN                        VALUE '9'.        00970016
010100                                                                  01010016
010200 01  WS-COUNTER.                                                  01020016
010300     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.     01030016
010400     05  WS-TMST                  PIC X(26)     VALUE SPACES.     01040016
010500                                                                  01050016
010600 01  CKPT-RESTART-INFO.                                           01060016
010700     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.       01070016
010800                                                                  01080016
010900*----------------------------------------------------------------*01090016
011000*  ABEND DATA AREAS                                              *01100016
011100*----------------------------------------------------------------*01110016
011200 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01120016
011300                                             COMP SYNC.           01130016
011400     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         01140016
011500     88  AC-BAD-DATA                         VALUE +4008.         01150016
011600     88  AC-DB2-ERROR                        VALUE +4013.         01160016
011700     88  AC-DATE-ERROR                       VALUE +4019.         01170016
011800                                                                  01180016
011900                                                                  01190016
012000 01  ABEND-AREAS.                                                 01200016
012100     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01210016
012200             '*****       ABEND'.                                 01220016
012300     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01230016
012400             '*****   PROGRAM: AHKUP044'.                         01240016
012500     05  AA-PARAGRAPH-LIT.                                        01250016
012600         10  FILLER              PIC  X(17)  VALUE                01260016
012700             '***** PARAGRAPH: '.                                 01270016
012800         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01280016
012900     05  AA-MESSAGE-LINE-1.                                       01290016
013000         10  FILLER              PIC  X(06)  VALUE '*****'.       01300016
013100         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01310016
013200     05  AA-MESSAGE-LINE-2.                                       01320016
013300         10  FILLER              PIC  X(06)  VALUE '*****'.       01330016
013400         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01340016
013500     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01350016
013600             '*****    DB2 ERROR'.                                01360016
013700     05  AA-DB2-OPERATION-LIT.                                    01370016
013800         10  FILLER              PIC  X(17)  VALUE                01380016
013900             '***** OPERATION: '.                                 01390016
014000         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01400016
014100     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01410016
014200     EJECT                                                        01420016
014300                                                                  01430016
014400     COPY DPWS004.                                                01440016
014500     EJECT                                                        01450016
014600*----------------------------------------------------------------*01460016
014700*      TPOPRPK TABLE LAYOUT                                       01470016
014800*----------------------------------------------------------------*01480016
014900         EXEC SQL                                                 01490016
015000             INCLUDE TPOPRPK                                      01500016
015100         END-EXEC.                                                01510016
015200                                                                  01520016
015300*----------------------------------------------------------------*01530016
015400*      TPURCHS TABLE LAYOUT                                       01540016
015500*----------------------------------------------------------------*01550016
015600         EXEC SQL                                                 01560016
015700             INCLUDE TPURCHS                                      01570016
015800         END-EXEC.                                                01580016
015900                                                                  01590016
016000*----------------------------------------------------------------*01600016
016100*      TCKRSTCNTL TABLE LAYOUT                                    01610016
016200*----------------------------------------------------------------*01620016
016300         EXEC SQL                                                 01630016
016400             INCLUDE TCKRSTCN                                     01640016
016500         END-EXEC.                                                01650016
016600                                                                  01660016
016700*----------------------------------------------------------------*01670016
016800*      TCKRSTINF TABLE LAYOUT                                     01680016
016900*----------------------------------------------------------------*01690016
017000         EXEC SQL                                                 01700016
017100             INCLUDE TCKRSTIN                                     01710016
017200         END-EXEC.                                                01720016
017300 EJECT                                                            01730016
017400*----------------------------------------------------------------*01740016
017500*  DB2 COMMUNICATION AREA                                         01750016
017600*----------------------------------------------------------------*01760016
017700*                                                                 01770016
017800     EXEC SQL                                                     01780016
017900         INCLUDE SQLCA                                            01790016
018000     END-EXEC.                                                    01800016
018100                                                                  01810016
018200*----------------------------------------------------------------*01820016
018300*  DB2 COMMUNICATION AREA2                                        01830016
018400*----------------------------------------------------------------*01840016
018500*                                                                 01850016
018600     COPY SQLCA2.                                                 01860016
018700     EJECT                                                        01870016
018800 PROCEDURE DIVISION.                                              01880016
018900 A100-MAINLINE-ROUTINE.                                           01890016
019000                                                                  01900016
019100     PERFORM B100-INITIALIZATION.                                 01910016
019200                                                                  01920016
019300     PERFORM B200-TPOPRPK-EXTRACT-PROCESS                         01930016
019400       UNTIL END-OF-EXTRACT.                                      01940016
019500                                                                  01950016
019600     PERFORM B300-EOJ-PROCESSING.                                 01960016
019700                                                                  01970016
019800     GOBACK.                                                      01980016
019900 EJECT                                                            01990016
020000 B100-INITIALIZATION.                                             02000016
020100                                                                  02010016
020200     EXEC SQL                                                     02020016
020300         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 02030016
020400     END-EXEC.                                                    02040016
020500                                                                  02050016
020600     PERFORM X300-GET-CHECKPOINT-CNTL.                            02060016
020700     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    02070016
020800                                                                  02080016
020900     OPEN INPUT TPOPRPK-EXTRACT-FILE.                             02090016
021000                                                                  02100016
021100     IF RESTART-RUN                                               02110016
021200         PERFORM X200-CHECKPOINT-RESTART                          02120016
021300     ELSE                                                         02130016
021400         PERFORM R100-READ-EXTRACT-FILE                           02140016
021500     END-IF.                                                      02150016
021600                                                                  02160016
021700     PERFORM X500-SET-CHECKPOINT-TIME.                            02170016
021800                                                                  02180016
021900                                                                  02190016
022000     EJECT                                                        02200016
022100 B200-TPOPRPK-EXTRACT-PROCESS.                                    02210016
022200                                                                  02220016
022300     MOVE POPRPK-PO-NBR             TO PV-DISP-PO-NBR.            02230016
022400     MOVE POPRPK-VER-NBR            TO PV-DISP-VER-NBR.           02240016
022500     MOVE POPRPK-PO-PREPK-ID        TO PV-DISP-PREPK-ID.          02250016
022600     IF POPRPK-PO-NBR NOT = PV-SAVE-PO-NBR                        02260016
022700         MOVE POPRPK-PO-NBR TO PV-SAVE-PO-NBR                     02270016
022900     END-IF.                                                      02290016
023000                                                                  02300016
023200     PERFORM D100-DELETE-TPOPRPK                                  02320022
023400                                                                  02340016
023500     PERFORM X100-CHECKPOINT-CHECK.                               02350016
023600                                                                  02360016
023700     PERFORM R100-READ-EXTRACT-FILE.                              02370016
023800     EJECT                                                        02380016
023900                                                                  02390016
024000                                                                  02400016
024100 B300-EOJ-PROCESSING.                                             02410016
024200                                                                  02420016
024300     DISPLAY '** AHKUP044 SUMMARY **'.                            02430016
024400     DISPLAY '** TPOPRPK INPUT COUNT = ' PV-TPOPRPK-INPUT-COUNT.  02440016
024500     DISPLAY '** TPOPRPK DELETE COUNT = ' PV-TPOPRPK-DELETE-COUNT.02450016
024600     DISPLAY '** SQL DELETE COUNT = ' PV-SQL-DELETE-COUNT.        02460016
024700                                                                  02470016
024800     CLOSE  TPOPRPK-EXTRACT-FILE.                                 02480016
024900                                                                  02490016
025000     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02500016
025100     PERFORM X600-UPDATE-TCKRSTCNTL.                              02510016
025200                                                                  02520016
025300     EJECT                                                        02530016
032500*                                                                 03250017
032600*----------------------------------------------------------------*03260016
032700*    DELETES FROM THE TPOPRPK TABLE.  CASCADE DELETE WILL ALSO   *03270016
032800*    CAUSE ROWS TO BE DELETED FROM TMIITEM, TVNDINV AND TEXINVC  *03280016
032900*    TABLES.                                                     *03290016
033000*----------------------------------------------------------------*03300016
033100 D100-DELETE-TPOPRPK.                                             03310016
033200                                                                  03320016
033300     MOVE 'D100-DELETE-TPOPRPK' TO PV-CURRENT-PARAGRAPH.          03330016
033400                                                                  03340016
033500     PERFORM WITH TEST AFTER                                      03350016
033600        VARYING PC-RETRY-COUNT FROM 1 BY 1                        03360016
033700          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                     03370016
033800             OR SQLCODE = ZERO                                    03380016
033900                                                                  03390016
034000         EXEC SQL                                                 03400016
034100              DELETE                                              03410016
034200                FROM TPOPRPK                                      03420016
034300               WHERE PO_NBR      = :POPRPK-PO-NBR                 03430016
034400                 AND VER_NBR     = :POPRPK-VER-NBR                03440016
034500                 AND PO_PREPK_ID = :POPRPK-PO-PREPK-ID            03450016
034600         END-EXEC                                                 03460016
034700                                                                  03470016
034800         EVALUATE TRUE                                            03480016
034900             WHEN SQLCODE = ZERO                                  03490016
035000                 ADD 1 TO PV-TPOPRPK-DELETE-COUNT                 03500016
035100                 MOVE SQLERRD(3) TO PV-SQLERRD3                   03510016
035200                 ADD PV-SQLERRD3 TO PV-SQL-DELETE-COUNT           03520016
035300                                                                  03530016
035400             WHEN SQLCODE = -904                                  03540016
035500             WHEN SQLCODE = -913                                  03550016
035600             WHEN SQLCODE = +100                                  03560016
035700                  CONTINUE                                        03570016
035800                                                                  03580016
035900             WHEN SQLWARN0 NOT = SPACES                           03590016
036000             WHEN SQLCODE  NOT = ZERO                             03600016
036100                 MOVE PV-CURRENT-PARAGRAPH                        03610016
036200                                     TO AA-PARAGRAPH-NAME         03620016
036300                 DISPLAY '******** PO NUMBER:'                    03630016
036400                          PV-DISP-PO-NBR                          03640016
036500                 DISPLAY '******** PO VER NBR:'                   03650016
036600                          PV-DISP-VER-NBR                         03660016
036700                 DISPLAY '******** PO PREPK ID:'                  03670016
036800                          PV-DISP-PREPK-ID                        03680016
036900                 MOVE SPACES TO AA-MESSAGE-1                      03690016
037000                                AA-MESSAGE-2                      03700016
037100                 MOVE 'UNSUCCESSFUL DELETE'                       03710016
037200                                     TO AA-DB2-OPERATION          03720016
037300                 MOVE 'TPOPRPK'      TO AA-DB2-TABLE              03730016
037400                 PERFORM Z999-DB2-ABEND                           03740016
037500         END-EVALUATE                                             03750016
037600     END-PERFORM.                                                 03760016
037700                                                                  03770016
037800     IF PC-RETRY-COUNT > PC-RETRY-MAX                             03780016
037900         MOVE PV-CURRENT-PARAGRAPH                                03790016
038000                             TO AA-PARAGRAPH-NAME                 03800016
038100         DISPLAY '******** PO NUMBER:'                            03810016
038200                          PV-DISP-PO-NBR                          03820016
038300         DISPLAY '******** PO VER NBR :'                          03830016
038400                          PV-DISP-VER-NBR                         03840016
038500         DISPLAY '******** PO PREPK ID :'                         03850016
038600                          PV-DISP-PREPK-ID                        03860016
038700         MOVE SPACES TO AA-MESSAGE-1                              03870016
038800                        AA-MESSAGE-2                              03880016
038900         MOVE 'MAX RETRIES EXCEEDED ON DELETE'                    03890016
039000                             TO AA-DB2-OPERATION                  03900016
039100         MOVE 'TPOPRPK'      TO AA-DB2-TABLE                      03910016
039200         PERFORM Z999-DB2-ABEND                                   03920016
039300     END-IF.                                                      03930016
039400                                                                  03940016
039500     EJECT                                                        03950016
039600 R100-READ-EXTRACT-FILE.                                          03960016
039700                                                                  03970016
039800     READ TPOPRPK-EXTRACT-FILE                                    03980016
039900          INTO DCLTPOPRPK                                         03990016
040000          AT END SET END-OF-EXTRACT TO TRUE.                      04000016
040100                                                                  04010016
040200     IF MORE-EXTRACT                                              04020016
040300         ADD 1 TO PV-TPOPRPK-INPUT-COUNT                          04030016
040400     END-IF.                                                      04040016
040500                                                                  04050016
040600                                                                  04060016
040700     EJECT                                                        04070016
040800*----------------------------------------------------------------*04080016
040900*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *04090016
041000*----------------------------------------------------------------*04100016
041100 X100-CHECKPOINT-CHECK.                                           04110016
041200                                                                  04120016
041300     MOVE 'X100-CHECKPOINT-CHECK' TO PV-CURRENT-PARAGRAPH.        04130016
041400                                                                  04140016
041500     EXEC SQL                                                     04150016
041600       SET :WS-TMST = CURRENT TIMESTAMP                           04160016
041700     END-EXEC.                                                    04170016
041800                                                                  04180016
041900     IF SQLCODE = +0                                              04190016
042000         CONTINUE                                                 04200016
042100     ELSE                                                         04210016
042200         MOVE PV-CURRENT-PARAGRAPH                                04220016
042300                             TO AA-PARAGRAPH-NAME                 04230016
042400         MOVE SPACES TO AA-MESSAGE-1                              04240016
042500                        AA-MESSAGE-2                              04250016
042600         MOVE 'BAD SET COMMAND'                                   04260016
042700                             TO AA-DB2-OPERATION                  04270016
042800         MOVE SPACES             TO AA-DB2-TABLE                  04280016
042900         PERFORM Z999-DB2-ABEND                                   04290016
043000     END-IF.                                                      04300016
043100                                                                  04310016
043200     IF WS-TMST > WS-HOLD-TMST                                    04320016
043300         IF NO-COMMITS-TAKEN                                      04330016
043400             MOVE PC-IN-PROCESS-CODE TO PV-CKPT-STAT-CODE         04340016
043500             PERFORM X600-UPDATE-TCKRSTCNTL                       04350016
043600             SET COMMITS-TAKEN TO TRUE                            04360016
043700         END-IF                                                   04370016
043800         PERFORM X700-UPDATE-TCKRSTINF                            04380016
043900         PERFORM Y100-COMMIT                                      04390016
044000         PERFORM X500-SET-CHECKPOINT-TIME                         04400016
044100     END-IF.                                                      04410016
044200                                                                  04420016
044300 EJECT                                                            04430016
044400*----------------------------------------------------------------*04440016
044500*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *04450016
044600*----------------------------------------------------------------*04460016
044700 X200-CHECKPOINT-RESTART.                                         04470016
044800                                                                  04480016
044900     MOVE 'X200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.      04490016
045000                                                                  04500016
045100     PERFORM X400-GET-CHECKPOINT-INFO.                            04510016
045200     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     04520016
045300                                                                  04530016
045400     DISPLAY '** AHKUP044 CHECKPOINT RESTART **'                  04540016
045500     DISPLAY '** EXTRACT RECS BYPASSED ON RESTART = '             04550016
045600              CR-EXTRACT-RECS-WORKED.                             04560016
045700     DISPLAY '***********************************************'    04570016
045800                                                                  04580016
045900     PERFORM R100-READ-EXTRACT-FILE                               04590016
046000         CR-EXTRACT-RECS-WORKED TIMES.                            04600016
046100     PERFORM R100-READ-EXTRACT-FILE.                              04610016
046200 EJECT                                                            04620016
046300*----------------------------------------------------------------*04630016
046400*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *04640016
046500*----------------------------------------------------------------*04650016
046600 X300-GET-CHECKPOINT-CNTL.                                        04660016
046700                                                                  04670016
046800     MOVE 'X300-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     04680016
046900                                                                  04690016
047000     PERFORM WITH TEST AFTER                                      04700016
047100             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04710016
047200             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04720016
047300                     SQLCODE = ZERO                               04730016
047400                                                                  04740016
047500             EXEC SQL                                             04750016
047600              SELECT CKPT_STAT_CODE                               04760016
047700               INTO :PV-CKPT-STAT-CODE                            04770016
047800               FROM TCKRSTCNTL                                    04780016
047900               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04790016
048000             END-EXEC                                             04800016
048100                                                                  04810016
048200             EVALUATE TRUE                                        04820016
048300                 WHEN SQLCODE = ZERO                              04830016
048400                 WHEN SQLCODE = -904                              04840016
048500                 WHEN SQLCODE = -913                              04850016
048600                      CONTINUE                                    04860016
048700                                                                  04870016
048800                 WHEN SQLWARN0 NOT = SPACES                       04880016
048900                 WHEN SQLCODE  NOT = ZERO                         04890016
049000                     MOVE PV-CURRENT-PARAGRAPH                    04900016
049100                                         TO AA-PARAGRAPH-NAME     04910016
049200                     DISPLAY '******** PLAN_NAME:'                04920016
049300                              PV-PROGRAM-NAME                     04930016
049400                     MOVE SPACES TO AA-MESSAGE-1                  04940016
049500                                    AA-MESSAGE-2                  04950016
049600                     MOVE 'UNSUCCESSFUL SELECT'                   04960016
049700                                         TO AA-DB2-OPERATION      04970016
049800                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          04980016
049900                     PERFORM Z999-DB2-ABEND                       04990016
050000             END-EVALUATE                                         05000016
050100     END-PERFORM.                                                 05010016
050200                                                                  05020016
050300     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05030016
050400         MOVE PV-CURRENT-PARAGRAPH                                05040016
050500                             TO AA-PARAGRAPH-NAME                 05050016
050600         DISPLAY '******** PLAN_NAME:'                            05060016
050700                  PV-PROGRAM-NAME                                 05070016
050800         MOVE SPACES TO AA-MESSAGE-1                              05080016
050900                        AA-MESSAGE-2                              05090016
051000         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05100016
051100                             TO AA-DB2-OPERATION                  05110016
051200         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05120016
051300         PERFORM Z999-DB2-ABEND                                   05130016
051400     END-IF.                                                      05140016
051500                                                                  05150016
051600 EJECT                                                            05160016
051700*----------------------------------------------------------------*05170016
051800*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *05180016
051900*----------------------------------------------------------------*05190016
052000 X400-GET-CHECKPOINT-INFO.                                        05200016
052100                                                                  05210016
052200     MOVE 'X400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     05220016
052300                                                                  05230016
052400     PERFORM WITH TEST AFTER                                      05240016
052500             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05250016
052600             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05260016
052700                     SQLCODE = ZERO                               05270016
052800                                                                  05280016
052900             EXEC SQL                                             05290016
053000              SELECT WORK_STRG_DESC                               05300016
053100               INTO :TCKRSTINF-WORK-STRG-DESC                     05310016
053200               FROM TCKRSTINF                                     05320016
053300               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05330016
053400             END-EXEC                                             05340016
053500                                                                  05350016
053600             EVALUATE TRUE                                        05360016
053700                 WHEN SQLCODE = ZERO                              05370016
053800                 WHEN SQLCODE = -904                              05380016
053900                 WHEN SQLCODE = -913                              05390016
054000                      CONTINUE                                    05400016
054100                                                                  05410016
054200                 WHEN SQLWARN0 NOT = SPACES                       05420016
054300                 WHEN SQLCODE  NOT = ZERO                         05430016
054400                     MOVE PV-CURRENT-PARAGRAPH                    05440016
054500                                         TO AA-PARAGRAPH-NAME     05450016
054600                     DISPLAY '******** PLAN_NAME:'                05460016
054700                              PV-PROGRAM-NAME                     05470016
054800                     MOVE SPACES TO AA-MESSAGE-1                  05480016
054900                                    AA-MESSAGE-2                  05490016
055000                     MOVE 'UNSUCCESSFUL SELECT'                   05500016
055100                                         TO AA-DB2-OPERATION      05510016
055200                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          05520016
055300                     PERFORM Z999-DB2-ABEND                       05530016
055400             END-EVALUATE                                         05540016
055500     END-PERFORM.                                                 05550016
055600                                                                  05560016
055700     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05570016
055800         MOVE PV-CURRENT-PARAGRAPH                                05580016
055900                             TO AA-PARAGRAPH-NAME                 05590016
056000         DISPLAY '******** PLAN_NAME:'                            05600016
056100                  PV-PROGRAM-NAME                                 05610016
056200         MOVE SPACES TO AA-MESSAGE-1                              05620016
056300                        AA-MESSAGE-2                              05630016
056400         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05640016
056500                             TO AA-DB2-OPERATION                  05650016
056600         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      05660016
056700         PERFORM Z999-DB2-ABEND                                   05670016
056800     END-IF.                                                      05680016
056900                                                                  05690016
057000 EJECT                                                            05700016
057100*----------------------------------------------------------------*05710016
057200*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *05720016
057300*----------------------------------------------------------------*05730016
057400 X500-SET-CHECKPOINT-TIME.                                        05740016
057500                                                                  05750016
057600     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-CURRENT-PARAGRAPH.     05760016
057700                                                                  05770016
057800     PERFORM WITH TEST AFTER                                      05780016
057900             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05790016
058000             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05800016
058100                     SQLCODE = ZERO                               05810016
058200                                                                  05820016
058300             EXEC SQL                                             05830016
058400              SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)05840016
058500               INTO :WS-HOLD-TMST                                 05850016
058600               FROM TCKRSTCNTL                                    05860016
058700               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05870016
058800             END-EXEC                                             05880016
058900                                                                  05890016
059000             EVALUATE TRUE                                        05900016
059100                 WHEN SQLCODE = ZERO                              05910016
059200                 WHEN SQLCODE = -904                              05920016
059300                 WHEN SQLCODE = -913                              05930016
059400                      CONTINUE                                    05940016
059500                                                                  05950016
059600                 WHEN SQLWARN0 NOT = SPACES                       05960016
059700                 WHEN SQLCODE  NOT = ZERO                         05970016
059800                     MOVE PV-CURRENT-PARAGRAPH                    05980016
059900                                         TO AA-PARAGRAPH-NAME     05990016
060000                     DISPLAY '******** PLAN_NAME:'                06000016
060100                              PV-PROGRAM-NAME                     06010016
060200                     MOVE SPACES TO AA-MESSAGE-1                  06020016
060300                                    AA-MESSAGE-2                  06030016
060400                     MOVE 'UNSUCCESSFUL SELECT'                   06040016
060500                                         TO AA-DB2-OPERATION      06050016
060600                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          06060016
060700                     PERFORM Z999-DB2-ABEND                       06070016
060800             END-EVALUATE                                         06080016
060900     END-PERFORM.                                                 06090016
061000                                                                  06100016
061100     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06110016
061200         MOVE PV-CURRENT-PARAGRAPH                                06120016
061300                             TO AA-PARAGRAPH-NAME                 06130016
061400         DISPLAY '******** PLAN_NAME:'                            06140016
061500                  PV-PROGRAM-NAME                                 06150016
061600         MOVE SPACES TO AA-MESSAGE-1                              06160016
061700                        AA-MESSAGE-2                              06170016
061800         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    06180016
061900                             TO AA-DB2-OPERATION                  06190016
062000         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06200016
062100         PERFORM Z999-DB2-ABEND                                   06210016
062200     END-IF.                                                      06220016
062300                                                                  06230016
062400 EJECT                                                            06240016
062500*----------------------------------------------------------------*06250016
062600*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *06260016
062700*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *06270016
062800*----------------------------------------------------------------*06280016
062900 X600-UPDATE-TCKRSTCNTL.                                          06290016
063000                                                                  06300016
063100     MOVE 'X600-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       06310016
063200                                                                  06320016
063300     PERFORM WITH TEST AFTER                                      06330016
063400             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06340016
063500             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06350016
063600                     SQLCODE = ZERO                               06360016
063700                                                                  06370016
063800             EXEC SQL                                             06380016
063900                 UPDATE TCKRSTCNTL                                06390016
064000                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          06400016
064100                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06410016
064200             END-EXEC                                             06420016
064300                                                                  06430016
064400             EVALUATE TRUE                                        06440016
064500                 WHEN SQLCODE = ZERO                              06450016
064600                 WHEN SQLCODE = -904                              06460016
064700                 WHEN SQLCODE = -913                              06470016
064800                      CONTINUE                                    06480016
064900                                                                  06490016
065000                 WHEN SQLWARN0 NOT = SPACES                       06500016
065100                 WHEN SQLCODE  NOT = ZERO                         06510016
065200                     MOVE PV-CURRENT-PARAGRAPH                    06520016
065300                                         TO AA-PARAGRAPH-NAME     06530016
065400                     DISPLAY '******** PLAN_NAME:'                06540016
065500                              PV-PROGRAM-NAME                     06550016
065600                     MOVE SPACES TO AA-MESSAGE-1                  06560016
065700                                    AA-MESSAGE-2                  06570016
065800                     MOVE 'UNSUCCESSFUL UPDATE'                   06580016
065900                                         TO AA-DB2-OPERATION      06590016
066000                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          06600016
066100                     PERFORM Z999-DB2-ABEND                       06610016
066200             END-EVALUATE                                         06620016
066300     END-PERFORM.                                                 06630016
066400                                                                  06640016
066500     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06650016
066600         MOVE PV-CURRENT-PARAGRAPH                                06660016
066700                             TO AA-PARAGRAPH-NAME                 06670016
066800         DISPLAY '******** PLAN_NAME:'                            06680016
066900                  PV-PROGRAM-NAME                                 06690016
067000         MOVE SPACES TO AA-MESSAGE-1                              06700016
067100                        AA-MESSAGE-2                              06710016
067200         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06720016
067300                             TO AA-DB2-OPERATION                  06730016
067400         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06740016
067500         PERFORM Z999-DB2-ABEND                                   06750016
067600     END-IF.                                                      06760016
067700                                                                  06770016
067800     EJECT                                                        06780016
067900*----------------------------------------------------------------*06790016
068000*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *06800016
068100*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *06810016
068200*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *06820016
068300*----------------------------------------------------------------*06830016
068400 X700-UPDATE-TCKRSTINF.                                           06840016
068500                                                                  06850016
068600     MOVE 'X700-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        06860016
068700                                                                  06870016
068800     MOVE PV-TPOPRPK-INPUT-COUNT TO CR-EXTRACT-RECS-WORKED.       06880016
068900     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   06890016
069000     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    06900016
069100                                                                  06910016
069200     PERFORM WITH TEST AFTER                                      06920016
069300             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06930016
069400             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06940016
069500                     SQLCODE = ZERO                               06950016
069600                                                                  06960016
069700             EXEC SQL                                             06970016
069800                 UPDATE TCKRSTINF                                 06980016
069900                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 06990016
070000                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          07000016
070100             END-EXEC                                             07010016
070200                                                                  07020016
070300             EVALUATE TRUE                                        07030016
070400                 WHEN SQLCODE = ZERO                              07040016
070500                 WHEN SQLCODE = -904                              07050016
070600                 WHEN SQLCODE = -913                              07060016
070700                      CONTINUE                                    07070016
070800                                                                  07080016
070900                 WHEN SQLWARN0 NOT = SPACES                       07090016
071000                 WHEN SQLCODE  NOT = ZERO                         07100016
071100                     MOVE PV-CURRENT-PARAGRAPH                    07110016
071200                                         TO AA-PARAGRAPH-NAME     07120016
071300                     DISPLAY '******** PLAN_NAME:'                07130016
071400                              PV-PROGRAM-NAME                     07140016
071500                     MOVE SPACES TO AA-MESSAGE-1                  07150016
071600                                    AA-MESSAGE-2                  07160016
071700                     MOVE 'UNSUCCESSFUL UPDATE'                   07170016
071800                                         TO AA-DB2-OPERATION      07180016
071900                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          07190016
072000                     PERFORM Z999-DB2-ABEND                       07200016
072100             END-EVALUATE                                         07210016
072200     END-PERFORM.                                                 07220016
072300                                                                  07230016
072400     IF PC-RETRY-COUNT > PC-RETRY-MAX                             07240016
072500         MOVE PV-CURRENT-PARAGRAPH                                07250016
072600                             TO AA-PARAGRAPH-NAME                 07260016
072700         DISPLAY '******** PLAN_NAME:'                            07270016
072800                  PV-PROGRAM-NAME                                 07280016
072900         MOVE SPACES TO AA-MESSAGE-1                              07290016
073000                        AA-MESSAGE-2                              07300016
073100         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    07310016
073200                             TO AA-DB2-OPERATION                  07320016
073300         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      07330016
073400         PERFORM Z999-DB2-ABEND                                   07340016
073500     END-IF.                                                      07350016
073600                                                                  07360016
073700 EJECT                                                            07370016
073800                                                                  07380016
073900*----------------------------------------------------------------*07390016
074000*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *07400016
074100*----------------------------------------------------------------*07410016
074200 Y100-COMMIT.                                                     07420016
074300                                                                  07430016
074400     MOVE 'Y100-COMMIT'    TO PV-CURRENT-PARAGRAPH.               07440016
074500                                                                  07450016
074600     EXEC SQL                                                     07460016
074700         COMMIT                                                   07470016
074800     END-EXEC.                                                    07480016
074900                                                                  07490016
075000     EVALUATE TRUE                                                07500016
075100         WHEN SQLCODE = ZEROS                                     07510016
075200             CONTINUE                                             07520016
075300         WHEN OTHER                                               07530016
075400             MOVE PV-CURRENT-PARAGRAPH                            07540016
075500                                 TO AA-PARAGRAPH-NAME             07550016
075600             MOVE SPACES TO AA-MESSAGE-1                          07560016
075700                            AA-MESSAGE-2                          07570016
075800             MOVE 'UNSUCCESSFUL COMMIT'                           07580016
075900                                 TO AA-DB2-OPERATION              07590016
076000             MOVE SPACES         TO AA-DB2-TABLE                  07600016
076100             PERFORM Z999-DB2-ABEND                               07610016
076200     END-EVALUATE.                                                07620016
076300 EJECT                                                            07630016
076400 Z999-DB2-ABEND.                                                  07640016
076500                                                                  07650016
076600     DISPLAY AA-ABEND-LIT.                                        07660016
076700     DISPLAY AA-DB2-ERROR-LIT.                                    07670016
076800     DISPLAY AA-PROGRAM-LIT.                                      07680016
076900     DISPLAY AA-PARAGRAPH-LIT.                                    07690016
077000     DISPLAY AA-DB2-OPERATION-LIT.                                07700016
077100     DISPLAY AA-DB2-TABLE.                                        07710016
077200     SET AC-DB2-ERROR TO TRUE.                                    07720016
077300                                                                  07730016
077400     COPY DPPD004.                                                07740016
077500                                                                  07750016
077600     CALL 'ILBOABN0' USING ABEND-CODE.                            07760016
