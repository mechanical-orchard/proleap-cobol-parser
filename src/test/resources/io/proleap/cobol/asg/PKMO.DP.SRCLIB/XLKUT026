000800* ************************************************************** *00001011
000100 IDENTIFICATION DIVISION.                                         00010002
000200 PROGRAM-ID.    XLKUT026.                                         00020002
000300 AUTHOR.        RON KRIER.                                        00030002
000400 INSTALLATION.  KOHLS.                                            00040002
000500 DATE-WRITTEN   MARCH 30, 2003.                                   00050002
000600 DATE-COMPILED.                                                   00060002
000700                                                                  00070002
000800* ************************************************************** *00080002
000900* * XLKUT026.  "PURCHASE ORDER DOMAIN INTEGRITY"               * *00090002
001000* *                                                            * *00100002
001100* * PURPOSE:                                                   * *00110002
001200* * THIS PROGRAM WILL CREATE THE DRIVER FILE OF PO'S TO BE     * *00120002
001300* * CHECKED AS PART OF THE DATA INTEGRITY PROCESS TO VALIDATE  * *00130002
001400* * THE PO DATA BETWEEN THE LOGISTICS DOMAIN PO TABLES AND     * *00140002
001500* * SYSTEM OF RECORD RMS TABLES.                               * *00150002
001600* *                                                            * *00160002
001700* * PROCESSING OVERVIEW:                                       * *00170002
001800* *   THIS PROGRAM WILL READ AN INPUT FILE CONTAINING A TIME-  * *00180002
001900* *   STAMP AND USE THIS THE TIMESTAMP TO EXTRACT PURCAHSE     * *00190002
002000* *   ORDERS FROM THE LOGISTICS DOMAIN TABLE THAT HAVE         * *00200002
002010* *   CHANGED SINCE THE LAST EXTRACT RAN.                      * *00201002
002020* *                                                            * *00202002
002030* *   WHEN THE EXTRACT IS DONE, THE CURRENT TIMESTAMP WILL BE  * *00203002
002040* *   RETRIEVED AND A NEW DATE CONTROL FILE WILL BE WRITTEN    * *00204002
002050* *   FOR THE NEXT EXTRACT.                                    * *00205002
002100**************************************************************** *00210002
002200 ENVIRONMENT DIVISION.                                            00220002
002300 CONFIGURATION SECTION.                                           00230002
002400 SOURCE-COMPUTER.        IBM-3090.                                00240002
002500 OBJECT-COMPUTER.        IBM-3090.                                00250002
002600                                                                  00260002
002700 INPUT-OUTPUT SECTION.                                            00270002
002800 FILE-CONTROL.                                                    00280002
002900                                                                  00290002
003000     SELECT IN-DATE-FILE                  ASSIGN TO IN01.         00300002
003100     SELECT OUT-PO-DRIVER-FILE            ASSIGN TO OUT01.        00310002
003110     SELECT OUT-DATE-FILE                 ASSIGN TO OUT02.        00311002
003200                                                                  00320002
003300******************************************************************00330002
003400 DATA DIVISION.                                                   00340002
003500 FILE SECTION.                                                    00350002
003600                                                                  00360002
003700 FD  IN-DATE-FILE                                                 00370002
003800     RECORDING MODE IS F                                          00380002
003900     LABEL RECORDS ARE STANDARD                                   00390002
004000     BLOCK CONTAINS 0 RECORDS.                                    00400002
004100 01  IN-DATE-RECORD                  PIC  X(050).                 00410002
004200                                                                  00420002
004400 FD  OUT-PO-DRIVER-FILE                                           00440002
004500     RECORDING MODE IS F                                          00450002
004600     LABEL RECORDS ARE STANDARD                                   00460002
004700     BLOCK CONTAINS 0 RECORDS.                                    00470002
004800 01  OUT-PO-DRIVER-RECORD            PIC  X(030).                 00480002
004810                                                                  00481002
004820 FD  OUT-DATE-FILE                                                00482002
004830     RECORDING MODE IS F                                          00483002
004840     LABEL RECORDS ARE STANDARD                                   00484002
004850     BLOCK CONTAINS 0 RECORDS.                                    00485002
004860 01  OUT-DATE-RECORD                 PIC  X(050).                 00486002
004900                                                                  00490002
005100                                                                  00510002
005200 WORKING-STORAGE SECTION.                                         00520002
005300                                                                  00530002
005400 01  PC-PROGRAM-CONSTANTS.                                        00540002
005500     05  PC-CURRENT-PROGRAM-NAME     PIC X(08) VALUE 'XLKUT026'.  00550002
005600     05  PC-PGM-PROGRESS-DESC.                                    00560002
005700         10  PC-BEGINNING            PIC X(09) VALUE 'BEGINNING'. 00570002
005800         10  PC-CONTINUING           PIC X(10) VALUE              00580002
005900                                               'CONTINUING'.      00590002
006000         10  PC-ENDING               PIC X(06) VALUE 'ENDING'.    00600002
006100         10  PC-ABENDING             PIC X(08) VALUE 'ABENDING'.  00610002
006200     05  PC-ABEND-INFO.                                           00620002
006300         10  PC-ABEND                PIC X(11) VALUE              00630002
006400                                               '** ABEND **'.     00640002
006500         10  PC-ABEND-MSG-PARA       PIC X(15) VALUE              00650002
006600                                               '- PARA       : '. 00660002
006700         10  PC-ABEND-MSG-DISPLAY-PARA                            00670002
006800                                     PIC X(15) VALUE              00680002
006900                                               '  CALLED PARA: '. 00690002
007000         10  PC-ABEND-MSG-NUMBER     PIC X(15) VALUE              00700002
007100                                               '  FOR ABEND# : '. 00710002
007200         10  PC-ABEND-MSG-DESC       PIC X(15) VALUE              00720002
007300                                               '- ERROR IS   : '. 00730002
007400         10  PC-ABEND-MSG-INDENT-15  PIC X(15) VALUE SPACES.      00740002
007500         10  PC-ABEND-MSG-ACTION     PIC X(15) VALUE              00750002
007600                                               '- ACTION     : '. 00760002
007700     05  PC-HOW-OFTEN-TO-DISPLAY     PIC 9(9)  VALUE 5000.        00770002
007800                                                                  00780002
007900 01  PS-PROGRAM-SWITCHES.                                         00790002
008000     05  PS-IN-DATE-EOF-SW           PIC X(01) VALUE 'N'.         00800002
008100         88  PS-IN-DATE-EOF                    VALUE 'Y'.         00810002
008200         88  PS-IN-DATE-NOT-EOF                VALUE 'N'.         00820002
008210     05  PS-END-OF-PO-CURSOR-SW      PIC X(01) VALUE 'N'.         00821003
008220         88  PS-END-OF-PO-CURSOR               VALUE 'Y'.         00822003
008230         88  PS-NOT-END-OF-PO-CURSOR           VALUE 'N'.         00823003
008300     05  PS-CURSOR-HAS-DATA-SW       PIC X(01) VALUE 'N'.         00830002
008400         88  PS-CURSOR-HAS-DATA                VALUE 'Y'.         00840002
008500         88  PS-CURSOR-HAS-NO-DATA             VALUE 'N'.         00850002
008600     05  PS-TABLE-LOOP-DONE-SW       PIC X(01) VALUE 'N'.         00860002
008700         88  PS-TABLE-LOOP-DONE                VALUE 'Y'.         00870002
008800         88  PS-TABLE-LOOP-NOT-DONE            VALUE 'N'.         00880002
008900                                                                  00890002
009000 01  PV-PROGRAM-VARIABLES.                                        00900002
009100     05  PV-CURSOR-TIMESTAMP         PIC X(26) VALUE SPACES.      00910002
009300     05  PV-IN-DATE-RECS-READ-CNT    PIC  9(9) VALUE 0.           00930002
009400     05  PV-RECS-WITH-MATCHES-CNT    PIC  9(9) VALUE 0.           00940002
009500     05  PV-TABLE-ROW-SELECT-CNT     PIC  9(9) VALUE 0.           00950002
009600     05  PV-EXTRACT-WRITTEN-CNT      PIC  9(9) VALUE 0.           00960002
009610     05  PV-EXTRACT-DISPLAY-CNT      PIC  9(9) VALUE 0.           00961003
009700                                                                  00970002
009800     05  PV-PARAGRAPH-NAME           PIC X(30) VALUE SPACES.      00980002
009900     05  PV-DB2-OPERATION-MSG-1      PIC X(79) VALUE SPACES.      00990002
010000     05  PV-DB2-TABLE-NAME           PIC X(18) VALUE SPACES.      01000002
010100     05  PV-DISPLAY-NTH-MULTIPLE     PIC 9(9)  VALUE 0.           01010002
010200     05  PV-DISPLAY-NTH-REMAINDER    PIC 9(9)  VALUE 0.           01020002
010300     05  PV-SQLCODE                  PIC +999  VALUE ZERO.        01030002
010400                                                                  01040002
010500     05  PV-TMST                     PIC X(26) VALUE SPACES.      01050002
010600     05  PV-TIMESTAMP-DETAIL                                      01060002
010700         REDEFINES                                                01070002
010800         PV-TMST.                                                 01080002
010900         10  PV-TIMESTAMP-19.                                     01090002
011000             15  PV-TMS-DATE.                                     01100002
011100                 20  PV-TMS-YEAR.                                 01110002
011200                     25  PV-TMS-CC   PIC X(02).                   01120002
011300                     25  PV-TMS-YY   PIC X(02).                   01130002
011400                 20  FILLER          PIC X(01).                   01140002
011500                 20  PV-TMS-MONTH    PIC X(02).                   01150002
011600                 20  FILLER          PIC X(01).                   01160002
011700                 20  PV-TMS-DAY      PIC X(02).                   01170002
011800             15  FILLER              PIC X(01).                   01180002
011900             15  PV-TMS-HOUR         PIC X(02).                   01190002
012000             15  FILLER              PIC X(01).                   01200002
012100             15  PV-TMS-MINUTE       PIC X(02).                   01210002
012200             15  FILLER              PIC X(01).                   01220002
012300             15  PV-TMS-SECOND       PIC X(02).                   01230002
012400         10  FILLER                  PIC X(01).                   01240002
012500         10  PV-TMS-MSECOND          PIC X(06).                   01250002
012600                                                                  01260002
012700 01  DM-DISPLAY-MESSAGE.                                          01270002
012800     05  DM-01-10.                                                01280002
012900         10  DM-PROGRAM              PIC X(08) VALUE SPACE.       01290002
013000         10  FILLER                  PIC X(02) VALUE ': '.        01300002
013100     05  DM-11-80.                                                01310002
013200         10  FILLER                  PIC X(37) VALUE              01320002
013300                        'SELECT ROWS FROM TPURCHS BASED ON DAT'.  01330002
013400         10  FILLER                  PIC X(30) VALUE              01340002
013500                        'E FILE TIMESTAMP             .'.         01350002
013600         10  FILLER                  PIC X(01) VALUE SPACE.       01360002
013700         10  FILLER                  PIC X(01) VALUE ALL '*'.     01370002
013800     05  DM-81-120.                                               01380002
013900         10  FILLER                  PIC X(40) VALUE ALL '*'.     01390002
014000                                                                  01400002
014010 01  DM-DISPLAY-MESSAGE-2.                                        01401002
014020     05  DM-01-10.                                                01402002
014030         10  DM-PROGRAM-2            PIC X(08) VALUE SPACE.       01403002
014040         10  FILLER                  PIC X(02) VALUE ': '.        01404002
014050     05  DM-11-80.                                                01405002
014060         10  FILLER                  PIC X(25) VALUE              01406002
014070                        'TIMESTAMP ON INPUT FILE: '.              01407002
014080         10  DM-TIMESTAMP-2          PIC X(26) VALUE SPACE.       01408002
014091         10  FILLER                  PIC X(01) VALUE SPACE.       01409102
014092         10  FILLER                  PIC X(01) VALUE ALL '*'.     01409202
014093     05  DM-81-120.                                               01409302
014094         10  FILLER                  PIC X(40) VALUE ALL '*'.     01409402
014095                                                                  01409502
014097 01  DM-DISPLAY-MESSAGE-3.                                        01409702
014098     05  DM-01-10.                                                01409802
014099         10  DM-PROGRAM-3            PIC X(08) VALUE SPACE.       01409902
014100         10  FILLER                  PIC X(02) VALUE ': '.        01410002
014101     05  DM-11-80.                                                01410102
014102         10  FILLER                  PIC X(25) VALUE              01410202
014103                        'TIMESTAMP INPUT FILE IS E'.              01410302
014104         10  FILLER                  PIC X(05) VALUE              01410402
014105                        'MPTY'.                                   01410502
014107         10  FILLER                  PIC X(01) VALUE SPACE.       01410702
014108         10  FILLER                  PIC X(01) VALUE ALL '*'.     01410802
014109     05  DM-81-120.                                               01410902
014110         10  FILLER                  PIC X(40) VALUE ALL '*'.     01411002
014111                                                                  01411102
014120 01  DP-DISPLAY-PROGRESS-MSG.                                     01412002
014200     05  DP-PROGRAM                  PIC X(08) VALUE SPACE.       01420002
014300     05  FILLER                      PIC X(02) VALUE SPACE.       01430002
014400     05  DP-STATUS-DESCRIPTION       PIC X(10) VALUE SPACE.       01440002
014500     05  FILLER                      PIC X(04) VALUE ' AT '.      01450002
014600     05  DP-TIMESTAMP-19             PIC X(19) VALUE SPACE.       01460002
014700     05  FILLER                      PIC X(03) VALUE '.  '.       01470002
014800     05  FILLER                      PIC X(03) VALUE              01480002
014900                                         'IN:'.                   01490002
015000     05  DP-IN-CNT                   PIC ZZZ,ZZZ,ZZ9              01500002
015100                                               VALUE ZERO.        01510002
015200     05  FILLER                      PIC X(02) VALUE ', '.        01520002
015300*    05  FILLER                      PIC X(16) VALUE              01530002
015400*                                        'DRIVER W/ROW(S):'.      01540002
015500*    05  DP-MATCHES-FOUND-CNT        PIC ZZZ,ZZZ,ZZ9              01550002
015600*                                              VALUE ZERO.        01560002
015700*    05  FILLER                      PIC X(02) VALUE ', '.        01570002
015800     05  FILLER                      PIC X(14) VALUE              01580002
015900                                         'ROWS SELECTED:'.        01590002
016000     05  DP-ROWS-SELECTED-CNT        PIC ZZZ,ZZZ,ZZ9              01600002
016100                                               VALUE ZERO.        01610002
016200     05  FILLER                      PIC X(02) VALUE ', '.        01620002
016300     05  FILLER                      PIC X(04) VALUE              01630002
016400                                         'OUT:'.                  01640002
016500     05  DP-OUT-CNT                  PIC ZZZ,ZZZ,ZZ9              01650002
016600                                               VALUE ZERO.        01660002
016700     05  FILLER                      PIC X(01) VALUE '.'.         01670002
016800                                                                  01680002
016900 01  ABEND-CODE                      PIC S9(04)                   01690002
017000                                               VALUE ZEROES       01700002
017100                                               COMP SYNC.         01710002
017200                                                                  01720002
017300*---------------------------------------------------------------* 01730002
017400*  DB2 FORMATTED MESSAGE AREA                                     01740002
017500*---------------------------------------------------------------* 01750002
017600     COPY DPWS004.                                                01760002
017700                                                                  01770002
017900*---------------------------------------------------------------* 01790002
018000*  XLRD013  - RECORD LAYOUT FOR PO DRIVER FILE, INPUT.          * 01800002
018100*---------------------------------------------------------------* 01810002
018200     COPY XLRD013.                                                01820002
018210                                                                  01821002
018230*---------------------------------------------------------------* 01823002
018240*  XLRD014  - RECORD LAYOUT FOR DATE FILE , INPUT AND OUTPUT.   * 01824002
018250*---------------------------------------------------------------* 01825002
018260     COPY XLRD014.                                                01826002
018300                                                                  01830002
018500*---------------------------------------------------------------* 01850002
018600*    DB2 AREA FOR TPURCHS                                       * 01860002
018700*---------------------------------------------------------------* 01870002
018800     EXEC SQL                                                     01880002
018900          INCLUDE TPURCHS                                         01890002
019000     END-EXEC.                                                    01900002
019100                                                                  01910002
019200*---------------------------------------------------------------* 01920002
019300*    DB2 AREA FOR COMMUNICATIONS                                * 01930002
019400*---------------------------------------------------------------* 01940002
019500     EXEC SQL                                                     01950002
019600          INCLUDE SQLCA                                           01960002
019700     END-EXEC.                                                    01970002
019800                                                                  01980002
019900*---------------------------------------------------------------* 01990002
020000*    DEFINE CURSOR FOR TPURCHS :                                * 02000002
020100*    PULL ALL AVAILABLE COLUMNS, SO EXTRACT FILE WILL CONTAIN   * 02010002
020200*    ALL DATA TO POPULATE "ARCHIVE HISTORY" COPY OF THIS TABLE. * 02020002
020300*---------------------------------------------------------------* 02030002
020400     EXEC SQL                                                     02040002
020500          DECLARE TABLE-CURSOR CURSOR FOR                         02050002
020600           SELECT PO_NBR                                          02060002
020700                 ,RMS_PO_UPD_TMST                                 02080012
023300           FROM   TPURCHS                                         02330002
023400          WHERE  RMS_PO_UPD_TMST >= :PV-CURSOR-TIMESTAMP          02341012
023500            AND  VER_STATUS_CDE = 'A'                             02350002
023600            FOR  FETCH ONLY                                       02360002
023700           WITH  UR                                               02370002
023800     END-EXEC.                                                    02380002
023900                                                                  02390002
024000                                                                  02400002
024100 PROCEDURE DIVISION.                                              02410002
024200********************                                              02420002
024300                                                                  02430002
024400 0000-PROGRAM-MAINLINE.                                           02440002
024500                                                                  02450002
024600     PERFORM 1000-INITIALIZE.                                     02460002
024700                                                                  02470002
024810     IF  PS-IN-DATE-EOF                                           02481003
024820         CONTINUE                                                 02482003
024830     ELSE                                                         02483003
024900         PERFORM 2000-PROCESS-DATE-FILE                           02490003
025000             UNTIL PS-END-OF-PO-CURSOR                            02500003
025010     END-IF.                                                      02501003
025100                                                                  02510002
025200     PERFORM 6000-EOJ-ROUTINE.                                    02520002
025210                                                                  02521003
025300     STOP RUN.                                                    02530002
025400                                                                  02540002
025500                                                                  02550002
025600* ************************************************************** *02560002
025700* * INITIALIZATIONS                                            * *02570002
025800* ************************************************************** *02580002
025900 1000-INITIALIZE.                                                 02590002
026000                                                                  02600002
026100     MOVE PC-CURRENT-PROGRAM-NAME TO DM-PROGRAM                   02610002
026110                                     DM-PROGRAM-2                 02611002
026120                                     DM-PROGRAM-3.                02612002
026200     DISPLAY DM-DISPLAY-MESSAGE.                                  02620002
026300                                                                  02630002
026700     PERFORM 9000-OPEN-IN-DATE-FILE.                              02670002
026800     PERFORM 9700-OPEN-OUT-FILES.                                 02680002
026801                                                                  02680102
026810     PERFORM 9050-READ-IN-DATE-FILE.                              02681002
026820                                                                  02682002
026830     IF  PS-IN-DATE-EOF                                           02683002
026831         DISPLAY DM-DISPLAY-MESSAGE-3                             02683102
026850     ELSE                                                         02685002
026860         MOVE XL014-CONTROL-TMST TO DM-TIMESTAMP-2                02686002
026861                                    PV-CURSOR-TIMESTAMP           02686105
026870         DISPLAY DM-DISPLAY-MESSAGE-2                             02687002
026880     END-IF.                                                      02688002
026900                                                                  02690002
027000                                                                  02700002
028200 2000-PROCESS-DATE-FILE.                                          02820003
028300                                                                  02830002
029300     PERFORM 9100-OPEN-TABLE-CURSOR.                              02930003
029310                                                                  02931003
029400     PERFORM 3000-EXTRACT-ROWS-FROM-TABLE                         02940003
029500         UNTIL PS-END-OF-PO-CURSOR.                               02950003
029510                                                                  02951003
029600     PERFORM 9190-CLOSE-TABLE-CURSOR.                             02960003
029800                                                                  02980002
029900                                                                  02990002
031700* ************************************************************** *03170002
031800* * EXTRACT ROWS FROM TABLE, FOR THE CURRENT DRIVER RECORD     * *03180002
031900* ************************************************************** *03190002
031910                                                                  03191003
032000 3000-EXTRACT-ROWS-FROM-TABLE.                                    03200002
032010                                                                  03201003
032100     INITIALIZE DCLTPURCHS.                                       03210002
032110                                                                  03211003
032200     PERFORM 9150-FETCH-TABLE-CURSOR.                             03220002
032210                                                                  03221003
032300     IF PS-END-OF-PO-CURSOR                                       03230003
032400         CONTINUE                                                 03240002
032500     ELSE                                                         03250002
032510         MOVE PURCHS-PO-NBR TO                                    03251003
032511              XL013-PO-NBR                                        03251103
032520         MOVE PURCHS-RMS-PO-UPD-TMST TO                           03252003
032530              XL013-PURCHS-RMS-PO-UPD-TMST                        03253003
032600         PERFORM 9750-WRITE-EXTRACT-RECORD                        03260002
032700     END-IF.                                                      03270002
032800                                                                  03280002
032900                                                                  03290002
033000* ************************************************************** *03300002
033100* * DISPLAY END OF RUN MESSAGE, CLOSE THE OUTPUT FILES         * *03310002
033200* ************************************************************** *03320002
033300 6000-EOJ-ROUTINE.                                                03330002
033400                                                                  03340002
033610     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           03361005
033620                                                                  03362006
033621     INITIALIZE XL014-CONTROL-RECORD.                             03362107
033630     MOVE PV-TMST TO XL014-CONTROL-TMST.                          03363006
033640     PERFORM 9760-WRITE-DATE-RECORD.                              03364006
033650                                                                  03365006
033660     DISPLAY 'NEW TIMESTAMP WRITTEN TO DATE FILE '                03366006
033670             PV-TMST.                                             03367006
033700                                                                  03370002
033800     PERFORM 9790-CLOSE-FILES.                                    03380010
034100                                                                  03410002
034200* ************************************************************** *03420002
034300* * DISPLAY PROGRAM PROGRESS.                                  * *03430002
034400* ************************************************************** *03440002
034410                                                                  03441003
034500 6200-DISPLAY-PGM-PROGRESS.                                       03450002
034600                                                                  03460002
034700     EXEC SQL                                                     03470002
034800          SET :PV-TMST = CURRENT TIMESTAMP                        03480002
034900     END-EXEC.                                                    03490002
035000                                                                  03500002
035100     MOVE PC-CURRENT-PROGRAM-NAME   TO DP-PROGRAM.                03510002
035200     MOVE PV-TIMESTAMP-19           TO DP-TIMESTAMP-19.           03520002
035400     MOVE PV-IN-DATE-RECS-READ-CNT  TO DP-IN-CNT.                 03540003
035600     MOVE PV-TABLE-ROW-SELECT-CNT   TO DP-ROWS-SELECTED-CNT.      03560002
035700     MOVE PV-EXTRACT-WRITTEN-CNT    TO DP-OUT-CNT.                03570002
035800                                                                  03580002
035900     DISPLAY DP-DISPLAY-PROGRESS-MSG.                             03590002
036000                                                                  03600002
036100                                                                  03610002
036900* ************************************************************** *03690002
037000* * OPEN  INPUT DRIVER FILE                                    * *03700002
037100* ************************************************************** *03710002
037110                                                                  03711003
037200 9000-OPEN-IN-DATE-FILE.                                          03720002
037210                                                                  03721003
037300     OPEN  INPUT  IN-DATE-FILE.                                   03730002
037400                                                                  03740002
037500                                                                  03750002
037600* ************************************************************** *03760002
037700* * READ  INPUT DRIVER FILE OF ELIGIBLE DATA TO EXTRACT        * *03770002
037800* ************************************************************** *03780002
037810                                                                  03781003
037900 9050-READ-IN-DATE-FILE.                                          03790002
037910                                                                  03791003
038000     READ IN-DATE-FILE                                            03800002
038100          INTO XL014-CONTROL-RECORD                               03810002
038200          AT END                                                  03820002
038300              SET PS-IN-DATE-EOF TO TRUE.                         03830002
038400                                                                  03840002
038500     IF PS-IN-DATE-EOF                                            03850002
038600         CONTINUE                                                 03860002
038700     ELSE                                                         03870002
038800         ADD +1 TO PV-IN-DATE-RECS-READ-CNT                       03880002
038900     END-IF.                                                      03890002
039000                                                                  03900002
039100                                                                  03910002
039900* ************************************************************** *03990002
040000* * OPEN  TABLE CURSOR                                         * *04000002
040100* ************************************************************** *04010002
040110                                                                  04011003
040200 9100-OPEN-TABLE-CURSOR.                                          04020002
040210                                                                  04021003
040300     EXEC SQL                                                     04030002
040400          OPEN TABLE-CURSOR                                       04040002
040500     END-EXEC.                                                    04050002
040600                                                                  04060002
040700     EVALUATE TRUE                                                04070002
040800         WHEN SQLCODE = ZERO                                      04080002
041000              CONTINUE                                            04100003
041100         WHEN SQLCODE = +100                                      04110002
041200              SET PS-END-OF-PO-CURSOR TO TRUE                     04120003
041300         WHEN SQLWARN0 NOT EQUAL SPACE                            04130002
041400         WHEN SQLCODE  NOT EQUAL ZERO                             04140002
041500              MOVE '9100-OPEN-TABLE-CURSOR'                       04150002
041600                                 TO PV-PARAGRAPH-NAME             04160002
041700              MOVE 'OPEN TABLE CURSOR'                            04170002
041800                                 TO PV-DB2-OPERATION-MSG-1        04180002
041900              MOVE 'TPURCHS'     TO PV-DB2-TABLE-NAME             04190002
042000              PERFORM 9999-DB2-ABEND                              04200002
042100     END-EVALUATE.                                                04210002
042200                                                                  04220002
042300                                                                  04230002
042400* ************************************************************** *04240002
042500* * FETCH TABLE CURSOR                                         * *04250002
042600* ************************************************************** *04260002
042610                                                                  04261003
042700 9150-FETCH-TABLE-CURSOR.                                         04270002
042710                                                                  04271003
042800     EXEC SQL                                                     04280002
042900         FETCH TABLE-CURSOR                                       04290002
043000          INTO  :PURCHS-PO-NBR                                    04300003
043100               ,:PURCHS-RMS-PO-UPD-TMST                           04310003
045700     END-EXEC.                                                    04570002
045800                                                                  04580002
045900     EVALUATE TRUE                                                04590002
046000         WHEN SQLCODE = ZERO                                      04600002
046100              ADD +1                 TO PV-TABLE-ROW-SELECT-CNT   04610002
046300         WHEN SQLCODE = +100                                      04630002
046310              SET PS-END-OF-PO-CURSOR TO TRUE                     04631003
046500         WHEN SQLWARN0 NOT EQUAL SPACE                            04650002
046600         WHEN SQLCODE NOT EQUAL ZERO                              04660002
046700              MOVE '9150-FETCH-TABLE-CURSOR'                      04670002
046800                                 TO PV-PARAGRAPH-NAME             04680002
046900              MOVE 'FETCH TABLE CURSOR'                           04690002
047000                                 TO PV-DB2-OPERATION-MSG-1        04700002
047100              MOVE 'TPURCHS'     TO PV-DB2-TABLE-NAME             04710002
047200              PERFORM 9999-DB2-ABEND                              04720002
047300     END-EVALUATE.                                                04730002
047400                                                                  04740002
047500                                                                  04750002
047600* ************************************************************** *04760002
047700* * CLOSE TABLE CURSOR                                         * *04770002
047800* ************************************************************** *04780002
047810                                                                  04781003
047900 9190-CLOSE-TABLE-CURSOR.                                         04790002
047910                                                                  04791003
048000     EXEC SQL                                                     04800002
048100          CLOSE TABLE-CURSOR                                      04810002
048200     END-EXEC.                                                    04820002
048300                                                                  04830002
048400     EVALUATE TRUE                                                04840002
048500         WHEN SQLCODE = ZERO                                      04850002
048600              CONTINUE                                            04860002
048700         WHEN SQLWARN0 NOT EQUAL SPACE                            04870002
048800         WHEN SQLCODE NOT EQUAL ZERO                              04880002
048900              MOVE '9190-CLOSE-TABLE-CURSOR'                      04890002
049000                                 TO PV-PARAGRAPH-NAME             04900002
049100              MOVE 'CLOSE TABLE CURSOR'                           04910002
049200                                 TO PV-DB2-OPERATION-MSG-1        04920002
049300              MOVE 'TPURCHS'     TO PV-DB2-TABLE-NAME             04930002
049400              PERFORM 9999-DB2-ABEND                              04940002
049500     END-EVALUATE.                                                04950002
049600                                                                  04960002
049700                                                                  04970002
049800* ************************************************************** *04980002
049900* * OPEN OUTPUT FILES                                          * *04990002
050000* ************************************************************** *05000002
050010                                                                  05001002
050100 9700-OPEN-OUT-FILES.                                             05010002
050110                                                                  05011002
050200     OPEN OUTPUT OUT-PO-DRIVER-FILE.                              05020002
050210     OPEN OUTPUT OUT-DATE-FILE.                                   05021002
050300                                                                  05030002
050400                                                                  05040002
050500* ************************************************************** *05050002
050600* * WRITE A RECORD TO THE TABLE EXTRACT FILE                   * *05060002
050700* ************************************************************** *05070002
050710                                                                  05071003
050800 9750-WRITE-EXTRACT-RECORD.                                       05080002
050810                                                                  05081003
050900     WRITE  OUT-PO-DRIVER-RECORD FROM                             05090003
050910            XL013-DRIVER-RECORD-LAYOUT.                           05091003
050920                                                                  05092003
051000     ADD +1 TO PV-EXTRACT-WRITTEN-CNT                             05100003
051010               PV-EXTRACT-DISPLAY-CNT.                            05101003
051020                                                                  05102003
051030     IF  PV-EXTRACT-DISPLAY-CNT = 50                              05103003
051031         PERFORM 6200-DISPLAY-PGM-PROGRESS                        05103103
051032         MOVE ZEROS TO PV-EXTRACT-DISPLAY-CNT                     05103203
051080     END-IF.                                                      05108003
051100                                                                  05110002
051110                                                                  05111006
051120* ************************************************************** *05112006
051130* * WRITE NEW DATE CONTROL RECORD FOR NEXT EXTRACT RUN            05113006
051140* ************************************************************** *05114006
051150                                                                  05115006
051160 9760-WRITE-DATE-RECORD.                                          05116006
051170                                                                  05117006
051180     WRITE  OUT-DATE-RECORD FROM                                  05118006
051190            XL014-CONTROL-RECORD.                                 05119006
051191                                                                  05119106
051200                                                                  05120002
051300* ************************************************************** *05130002
051400* * CLOSE FILES                                                   05140003
051500* ************************************************************** *05150002
051600 9790-CLOSE-FILES.                                                05160003
051710                                                                  05171003
051720     CLOSE OUT-PO-DRIVER-FILE.                                    05172003
051730     CLOSE OUT-DATE-FILE.                                         05173003
051740     CLOSE IN-DATE-FILE.                                          05174003
051800                                                                  05180002
051900                                                                  05190002
052000* ************************************************************** *05200002
052100* * DISPLAY INFORMATION NEEDED FOR DEBUGGING/MAINTENANCE/SUPPORT *05210002
052200* * AND CALL THE ABEND PROCESSOR IN THE EVENT THAT AN          * *05220002
052300* * SQL ERROR OR WARNING CODE OCCURS.                          * *05230002
052400* ************************************************************** *05240002
052410                                                                  05241003
052500 9999-DB2-ABEND.                                                  05250002
052600                                                                  05260002
052700     DISPLAY PC-CURRENT-PROGRAM-NAME                              05270002
052800             ' 9999-DB2-ABEND'.                                   05280002
052900     DISPLAY PC-CURRENT-PROGRAM-NAME                              05290002
053000             ' ** ABEND           **'.                            05300002
053100     DISPLAY PC-CURRENT-PROGRAM-NAME                              05310002
053200             ' ** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.       05320002
053300     DISPLAY PC-CURRENT-PROGRAM-NAME                              05330002
053400             ' ** TABLES AFFECTED ** = ' PV-DB2-TABLE-NAME.       05340002
053500     DISPLAY PC-CURRENT-PROGRAM-NAME                              05350002
053600             ' ** OPERATION       ** = ' PV-DB2-OPERATION-MSG-1.  05360002
053700                                                                  05370002
053800     DISPLAY PC-CURRENT-PROGRAM-NAME                              05380002
053900             ' ** SQLCODE         ** = ' SQLCODE.                 05390002
054000     MOVE SQLCODE TO PV-SQLCODE.                                  05400002
054100     DISPLAY PC-CURRENT-PROGRAM-NAME                              05410002
054200             ' ** PV-SQLCODE      ** = ' PV-SQLCODE '.'.          05420002
054300                                                                  05430002
054400     DISPLAY PC-CURRENT-PROGRAM-NAME                              05440002
054500             ' ** SQLWARN0        ** = ' SQLWARN0 '.'.            05450002
054600                                                                  05460002
054700                                                                  05470002
054800*----------------------------------------------------------------*05480002
054900* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *05490002
055000* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *05500002
055100* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *05510002
055200* FORMAT.                                                        *05520002
055300*----------------------------------------------------------------*05530002
055400     COPY DPPD004.                                                05540002
055500                                                                  05550002
055600     MOVE PC-ABENDING               TO DP-STATUS-DESCRIPTION.     05560002
055700     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           05570002
055900     PERFORM 9790-CLOSE-FILES.                                    05590003
056000                                                                  05600002
056100*----------------------------------------------------------------*05610002
056200* CALL ABEND                                                     *05620002
056300*----------------------------------------------------------------*05630002
056400     MOVE +4013                  TO ABEND-CODE.                   05640002
056500     CALL 'ILBOABN0' USING ABEND-CODE.                            05650002
056600*                                                                 05660002
