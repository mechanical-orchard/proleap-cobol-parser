000100******************************************************************00010004
000200 IDENTIFICATION DIVISION.                                         00020004
000300******************************************************************00030004
000400                                                                  00040004
000500 PROGRAM-ID.    RCKUT069.                                         00050004
000600 AUTHOR.        DENISE HAHN                                       00060004
000700 INSTALLATION.  KOHLS.                                            00070004
000800 DATE-WRITTEN   OCTOBER, 1999.                                    00080004
000900 DATE-COMPILED.                                                   00090004
001000                                                                  00100004
001100******************************************************************00110004
001200*  THIS PROGRAM DELETE THE SPECIFIED ROWS FROM THE TLBTKHS TABLE. 00120004
001300*  CASCADE DELETE TO TLBTKID & TLBTKIN                            00130004
001400******************************************************************00140004
001500                                                                  00150004
001600******************************************************************00160004
001700 ENVIRONMENT DIVISION.                                            00170004
001800******************************************************************00180004
001900                                                                  00190004
002000 CONFIGURATION SECTION.                                           00200004
002100                                                                  00210004
002200 SOURCE-COMPUTER.        IBM-3090.                                00220004
002300 OBJECT-COMPUTER.        IBM-3090.                                00230004
002400                                                                  00240004
002500 INPUT-OUTPUT SECTION.                                            00250004
002600                                                                  00260004
002700 FILE-CONTROL.                                                    00270004
002800                                                                  00280004
002900                                                                  00290004
003000     SELECT TIMESTAMP-FILE                                        00300005
003100         ASSIGN TO INP01.                                         00310004
003200******************************************************************00320004
003300 DATA DIVISION.                                                   00330004
003400******************************************************************00340004
003500                                                                  00350004
003600 FILE SECTION.                                                    00360004
003700                                                                  00370004
003800                                                                  00380004
003900 FD  TIMESTAMP-FILE                                               00390004
004000     RECORDING MODE IS F                                          00400004
004100     LABEL RECORDS ARE STANDARD                                   00410004
004200     BLOCK CONTAINS 0 RECORDS.                                    00420004
004300                                                                  00430004
004400 01  TIMESTAMP-RECORD           PIC  X(50).                       00440004
004500*                                                                 00450004
004600*                                                                 00460004
004700******************************************************************00470004
004800 WORKING-STORAGE SECTION.                                         00480004
004900******************************************************************00490004
005000 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00500005
005100                                                   COMP SYNC.     00510005
005200                                                                  00520005
005300 01  DK-DATABASE-KEYS.                                            00530005
005400     05  DK-LBL-REQ-TRN-ID           PIC S9(09)    VALUE +0 COMP. 00540005
005500                                                                  00550005
005600 01  PS-PROGRAM-SWITCHES.                                         00560005
005700     05  PS-DELETE-CSR-SW            PIC  X(01)    VALUE 'N'.     00570005
005800         88  PS-END-OF-CSR-YES                     VALUE 'Y'.     00580005
005900         88  PS-END-OF-CSR-NO                      VALUE 'N'.     00590005
006000                                                                  00600005
006100 01  PC-PROGRAM-CONSTANTS.                                        00610005
006200     05  PC-ROW-NOT-FOUND            PIC S9(04)    VALUE +100     00620005
006300                                                   COMP SYNC.     00630005
006400     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00640005
006500         'RCKUT069'.                                              00650005
006600     05  PC-COMMIT-HOLD              PIC 9(3)      VALUE 100.     00660005
006700                                                                  00670005
006800 01  PV-PROGRAM-VARIABLES.                                        00680005
006900     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  00690005
007000     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  00700005
007100     05  PV-DELETE-COUNT             PIC S9(09)    VALUE ZEROES.  00710005
007200     05  PV-TOTAL-DELETE-COUNT       PIC S9(09)    VALUE ZEROES.  00720005
007300     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             00730005
007400     05  PV-DELETE-THRU-DATE         PIC X(10).                   00740005
007500                                                                  00750005
007600*-----------------------------------------------------------------00760004
007700*  RECORD LAYOUT FOR THE DATE FILE                                00770004
007800*-----------------------------------------------------------------00780004
007900     COPY RCRD049.                                                00790004
008000                                                                  00800004
008100******************************************************************00810004
008200*  DB2 FORMATTED MESSAGE AREA                                     00820004
008300******************************************************************00830004
008400     COPY DPWS004.                                                00840012
008500                                                                  00850005
008600******************************************************************00860004
008700*  COMMUNICATIONS AREA FOR DB2                                    00870004
008800******************************************************************00880004
008900     EXEC SQL                                                     00890004
009000          INCLUDE SQLCA                                           00900004
009100     END-EXEC.                                                    00910004
009200                                                                  00920004
009300******************************************************************00930004
009400*  COBOL DECLARATION AND DCLGEN MEMBER FOR THE LABEL TRACKING     00940004
009500*  HISTORY TABLE                                                  00950004
009600******************************************************************00960004
009700     EXEC SQL                                                     00970004
009800          INCLUDE TLBTKHS                                         00980004
009900     END-EXEC.                                                    00990004
010000                                                                  01000005
010100     EXEC SQL                                                     01010005
010200         DECLARE DELETE-CSR CURSOR FOR                            01020005
010300          SELECT LBL_REQ_TRN_ID                                   01030005
010400            FROM TLBTKHS                                          01040005
010500           WHERE DATE(CRE_TMST)  <=  :PV-DELETE-THRU-DATE         01050005
010600     END-EXEC.                                                    01060005
010700                                                                  01070005
010800/*****************************************************************01080005
010900 PROCEDURE DIVISION.                                              01090004
011000******************************************************************01100004
011100                                                                  01110004
011200******************************************************************01120004
011300* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     01130004
011400*      PROGRAM.                                                   01140004
011500******************************************************************01150004
011600 0000-PROGRAM-MAINLINE.                                           01160005
011700                                                                  01170004
011800     DISPLAY '**** START RCKUT069 ****'.                          01180005
011900                                                                  01190005
012000     PERFORM 1000-INITIALIZE.                                     01200004
012100     PERFORM 2000-PROCESS-LABEL-DELETE                            01210004
012200     PERFORM 9000-EOJ-ROUTINE.                                    01220004
012300                                                                  01230004
012400     STOP RUN.                                                    01240004
012500                                                                  01250004
012600******************************************************************01260004
012700*  DO FIRST TIME PROGRAM INITIALIZATION TASKS.                    01270004
012800*    -- OPEN INPUT FILE                                           01280004
012900*    -- READ FILE                                                 01290004
013000******************************************************************01300004
013100 1000-INITIALIZE.                                                 01310005
013200                                                                  01320004
013300     OPEN INPUT  TIMESTAMP-FILE.                                  01330004
013400     READ TIMESTAMP-FILE                                          01340004
013500          INTO RC049-CONTROL-RECORD.                              01350004
013600                                                                  01360004
013700     MOVE RC049-CONTROL-DATE TO PV-DELETE-THRU-DATE.              01370006
013800                                                                  01380005
013900     DISPLAY ' '.                                                 01390006
014000     DISPLAY '  DELETE DATE USED ==> ' PV-DELETE-THRU-DATE.       01400006
014100     DISPLAY ' '.                                                 01410010
014200                                                                  01420006
014300******************************************************************01430004
014400 2000-PROCESS-LABEL-DELETE.                                       01440004
014500                                                                  01450004
014600     PERFORM 7000-OPEN-DELETE-CSR.                                01460005
014700                                                                  01470005
014800     PERFORM 7200-FETCH-DELETE-CSR.                               01480005
014900     IF PS-END-OF-CSR-NO                                          01490005
015000         PERFORM 8000-DELETE-LABEL-DATA                           01500005
015100           UNTIL PS-END-OF-CSR-YES                                01510005
015200     END-IF.                                                      01520005
015300                                                                  01530004
015400     PERFORM 7100-CLOSE-DELETE-CSR.                               01540005
015500                                                                  01550005
015600******************************************************************01560004
015700 7000-OPEN-DELETE-CSR.                                            01570005
015800                                                                  01580004
015900     EXEC SQL                                                     01590005
016000         OPEN DELETE-CSR                                          01600005
016100     END-EXEC                                                     01610005
016200                                                                  01620005
016300     EVALUATE TRUE                                                01630004
016400         WHEN SQLCODE = ZERO                                      01640004
016500             CONTINUE                                             01650004
016600         WHEN SQLWARN0 NOT = SPACES                               01660004
016700         WHEN SQLCODE < ZERO                                      01670004
016800         WHEN SQLCODE > ZERO                                      01680004
016900             MOVE '7000-OPEN-DELETE-CSR' TO PV-PARAGRAPH-NAME     01690005
017000             MOVE 'OPEN CURSOR' TO PV-DB2-OPERATION-ATTEMPTED     01700005
017100             PERFORM 9100-SQL-ABEND                               01710004
017200     END-EVALUATE.                                                01720004
017300                                                                  01730004
017400******************************************************************01740005
017500 7100-CLOSE-DELETE-CSR.                                           01750005
017600                                                                  01760005
017700     EXEC SQL                                                     01770005
017800         CLOSE DELETE-CSR                                         01780005
017900     END-EXEC                                                     01790005
018000                                                                  01800005
018100     EVALUATE TRUE                                                01810005
018200         WHEN SQLCODE = ZERO                                      01820005
018300             CONTINUE                                             01830005
018400         WHEN SQLWARN0 NOT = SPACES                               01840005
018500         WHEN SQLCODE < ZERO                                      01850005
018600         WHEN SQLCODE > ZERO                                      01860005
018700             MOVE '7100-CLOSE-DELETE-CSR' TO PV-PARAGRAPH-NAME    01870005
018800             MOVE 'CLOSE CURSOR' TO PV-DB2-OPERATION-ATTEMPTED    01880005
018900             PERFORM 9100-SQL-ABEND                               01890005
019000     END-EVALUATE.                                                01900005
019100                                                                  01910004
019200******************************************************************01920005
019300 7200-FETCH-DELETE-CSR.                                           01930005
019400                                                                  01940005
019500     EXEC SQL                                                     01950005
019600         FETCH DELETE-CSR                                         01960005
019700          INTO :LBTKHS-LBL-REQ-TRN-ID                             01970005
019800     END-EXEC.                                                    01980005
019900                                                                  01990005
020000     EVALUATE TRUE                                                02000005
020100         WHEN SQLCODE = ZERO                                      02010005
020200             SET PS-END-OF-CSR-NO  TO TRUE                        02020005
020300                                                                  02030005
020400         WHEN SQLCODE = +100                                      02040005
020500             SET PS-END-OF-CSR-YES TO TRUE                        02050005
020600                                                                  02060005
020700         WHEN SQLWARN0 NOT = SPACES                               02070005
020800         WHEN SQLCODE < ZERO                                      02080005
020900         WHEN SQLCODE > ZERO                                      02090005
021000             MOVE '7200-FETCH-DELETE-CSR' TO PV-PARAGRAPH-NAME    02100005
021100             MOVE 'FETCH CURSOR' TO PV-DB2-OPERATION-ATTEMPTED    02110005
021200             PERFORM 9100-SQL-ABEND                               02120005
021300     END-EVALUATE.                                                02130005
021400                                                                  02140005
021500******************************************************************02150004
021600*  DELETE THE ROW FROM THE LABEL PRINT DATA TABLE                 02160004
021700******************************************************************02170004
021800 8000-DELETE-LABEL-DATA.                                          02180004
021900                                                                  02190004
022000     MOVE LBTKHS-LBL-REQ-TRN-ID TO DK-LBL-REQ-TRN-ID.             02200005
022100                                                                  02210005
022200     EXEC SQL                                                     02220005
022300         DELETE                                                   02230005
022400             FROM  TLBTKHS                                        02240005
022500             WHERE LBL_REQ_TRN_ID = :DK-LBL-REQ-TRN-ID            02250005
022600     END-EXEC.                                                    02260005
022700                                                                  02270005
022800     EVALUATE TRUE                                                02280004
022900         WHEN SQLCODE = 0                                         02290005
023000             ADD +1           TO PV-DELETE-COUNT                  02300005
023100             ADD +1           TO PV-TOTAL-DELETE-COUNT            02310005
023200                                                                  02320005
023300         WHEN SQLWARN0 NOT = SPACES                               02330004
023400         WHEN SQLCODE < ZERO                                      02340004
023500         WHEN SQLCODE > ZERO                                      02350004
023600             MOVE '8000-DELETE-LABEL-DATA'  TO PV-PARAGRAPH-NAME  02360005
023700             MOVE 'DELETE TLBTKHS' TO PV-DB2-OPERATION-ATTEMPTED  02370005
023800             PERFORM 9100-SQL-ABEND                               02380004
023900     END-EVALUATE.                                                02390004
024000                                                                  02400004
024100*PERFORM A COMMIT ON EVERY 100 DELETES.                           02410005
024200     IF PV-DELETE-COUNT > PC-COMMIT-HOLD                          02420005
024300         EXEC SQL                                                 02430005
024400            COMMIT                                                02440005
024500         END-EXEC                                                 02450005
024600                                                                  02460005
024700         IF SQLCODE NOT = +0                                      02470005
024800             DISPLAY '### COMMIT FAILED ! ###'                    02480005
024900             MOVE '8000-DELETE-LABEL-DATA'  TO PV-PARAGRAPH-NAME  02490005
025000             MOVE 'COMMIT TLBTKHS' TO PV-DB2-OPERATION-ATTEMPTED  02500005
025100             PERFORM 9100-SQL-ABEND                               02510005
025200         END-IF                                                   02520005
025300                                                                  02530005
025400***      MOVE PV-TOTAL-DELETE-COUNT TO PV-DISPLAY-COUNT           02540011
025500***      DISPLAY 'COMMIT EXECUTED!  COUNT = ' PV-DISPLAY-COUNT    02550011
025600                                                                  02560007
025700         MOVE +0 TO PV-DELETE-COUNT                               02570005
025800         PERFORM 7000-OPEN-DELETE-CSR                             02580009
025900     END-IF.                                                      02590005
026000                                                                  02600005
026100*GET NEXT RECORD.                                                 02610008
026200     PERFORM 7200-FETCH-DELETE-CSR.                               02620008
026300                                                                  02630008
026400******************************************************************02640004
026500*  CLOSE OUTPUT FILE.  CLOSE THE CURSOR.                          02650004
026600******************************************************************02660004
026700 9000-EOJ-ROUTINE.                                                02670005
026800                                                                  02680005
026900     CLOSE TIMESTAMP-FILE.                                        02690004
027000                                                                  02700004
027100     DISPLAY ' '.                                                 02710005
027200     MOVE PV-TOTAL-DELETE-COUNT TO PV-DISPLAY-COUNT.              02720005
027300     DISPLAY 'TOTAL LABEL DATA RECORDS DELETED ' PV-DISPLAY-COUNT.02730005
027400     DISPLAY ' '.                                                 02740005
027500                                                                  02750005
027600     DISPLAY '**** END OF RCKUT069 ****'.                         02760005
027700                                                                  02770005
027800******************************************************************02780004
027900*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    02790004
028000*  ERROR OR WARNING CODE OCCURS.                                  02800004
028100******************************************************************02810004
028200 9100-SQL-ABEND.                                                  02820005
028300                                                                  02830005
028400     DISPLAY '9100-SQL-ABEND'.                                    02840004
028500     DISPLAY '** ABEND     **'.                                   02850004
028600     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        02860004
028700     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              02870004
028800     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     02880004
028900                                                                  02890004
029000******************************************************************02900004
029100* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    02910004
029200* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         02920004
029300* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     02930004
029400* FORMAT.                                                         02940004
029500******************************************************************02950004
029600     COPY DPPD004.                                                02960004
029700                                                                  02970004
029800     MOVE +4013                  TO ABEND-CODE.                   02980004
029900     CALL 'ILBOABN0' USING ABEND-CODE.                            02990004
