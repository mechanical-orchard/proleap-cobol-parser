       IDENTIFICATION DIVISION.                                         00010000
       PROGRAM-ID.    MLKUP976.                                         00020000
       AUTHOR.        B. GRAHAM - STRATAGEM.                            00030000
       INSTALLATION.  KOHLS DEPARTMENT STORES.                          00040000
       DATE-WRITTEN.  02/04/08.                                         00050000
       DATE-COMPILED.                                                   00060000
                                                                        00070000
      ******************************************************************00080000
      * THE PURPOSE OF THIS PROGRAM IS TO MOVE ROWS FROM ONE DKEY       00090000
      * IN A DEPT TO ANOTHER DKEY AS INDICATED BY INPUT CONTROL         00100000
      * INFORMATION                                                     00110000
      * 1.READ FROM/TO DEPT AND DKEY FROM CONTROL FILE                  00120000
      * 2.RETRIEVE ROWS FROM MLT_DEPT_BRND_VND WITH FROM DEPT AND DKEY  00130000
      * 3.LOOK UP THE DKEY OF THE 'TO' DEPT AND DKEY TO SEE THAT IT IS  00140000
      *   VALID                                                         00150000
      * 4.INSERT THE ROW WITH THE NEW DKEY                              00160000
      * 5.DELETE THE ROW WITH THE OLD DKEY                              00170000
      * 6.IF THE ROW WITH THE NEW DKEY ALREADY EXISTS, RETRIEVE THAT    00180000
      *   ROW AND COMBINE THE MONEYS FROM THE 'FROM' DKEY ROW WITH      00190000
      *   'TO' DKEY AND REPLACE IT IN THE TABLE, THEN DELETE            00200000
      *   ORIGINAL 'FROM'  DKEY ROW.                                    00210000
      *                                                                 00220000
      * THE PROCESS NOTED ABOVE WILL BE DONE BASED UPON AN INPUT        00230000
      * MONTH END CONTROL CARD DATE.                                    00240000
      *                                                                 00250000
      ******************************************************************00260000
                                                                        00270000
      ******************** HISTORY OF CHANGES **************************00271007
      * CHG ID/                                                        *00272007
      * WR/PROJ  DATE        DESCRIPTION OF CHANGES                    *00273007
      * -------  ----------  ----------------------------------------  *00274007
      * W32898   02-14-2008  B.GRAHAM - STRATAGEM                       00275011
      *                      INITIAL IMPLEMENTATION                     00276007
      * 238672   03-10-2008  B.GRAHAM - STRATAGEM                       00276111
      *                      QUALIFY MNLY-SUM CURSOR BY DEPT            00276211
      *                      CHG DKEY VALIDATION TO USE DEPT            00276311
      ******************************************************************00277007
      ******************************************************************00280000
       ENVIRONMENT DIVISION.                                            00290000
      ******************************************************************00300000
                                                                        00310000
       CONFIGURATION SECTION.                                           00320000
                                                                        00330000
       SOURCE-COMPUTER.        IBM-3090.                                00340000
       OBJECT-COMPUTER.        IMB-3090.                                00350000
                                                                        00360000
       INPUT-OUTPUT SECTION.                                            00370000
                                                                        00380000
       FILE-CONTROL.                                                    00390000
                                                                        00400000
           SELECT CNTL-DATE-FILE                                        00410000
               ASSIGN TO INP01.                                         00420000
                                                                        00430000
           SELECT FROM-TO-DKEY-FILE                                     00440000
               ASSIGN TO INP02.                                         00450000
                                                                        00460000
           SELECT AUDIT-FILE                                            00470000
               ASSIGN TO OUT01.                                         00480000
                                                                        00490000
      ******************************************************************00500000
       DATA DIVISION.                                                   00510000
      ******************************************************************00520000
                                                                        00530000
       FILE SECTION.                                                    00540000
                                                                        00550000
       FD  CNTL-DATE-FILE                                               00560000
           RECORDING  MODE IS F.                                        00570000
       01  CNTL-DATE-REC                    PIC X(80).                  00580000
                                                                        00590000
       FD  FROM-TO-DKEY-FILE                                            00600000
           RECORDING  MODE IS F.                                        00610000
       01  FROM-TO-DKEY-REC                 PIC X(80).                  00620000
                                                                        00630000
       FD  AUDIT-FILE                                                   00640000
           RECORDING  MODE IS F.                                        00650000
       01  AUDIT-REC                        PIC X(80).                  00660000
                                                                        00670000
                                                                        00680000
       WORKING-STORAGE SECTION.                                         00690000
                                                                        00700000
                                                                        00710000
       01  PS-PROGRAM-SWITCHES.                                         00720000
           05  PS-FROM-DKEY-CSR-AT-END-SW    PIC X     VALUE 'N'.       00730000
               88  PS-FROM-DKEY-CSR-AT-END-NO          VALUE 'N'.       00740000
               88  PS-FROM-DKEY-CSR-AT-END-YES         VALUE 'Y'.       00750000
           05  PS-FROM-TO-FILE-AT-END-SW     PIC X     VALUE 'N'.       00760000
               88  PS-FROM-TO-FILE-AT-END-NO           VALUE 'N'.       00770000
               88  PS-FROM-TO-FILE-AT-END-YES          VALUE 'Y'.       00780000
                                                                        00790000
       01  PC-PROGRAM-CONSTANTS.                                        00800000
           05 PC-PGM-NAME                  PIC X(8)  VALUE 'MLKUP976'.  00810000
           05 PC-MAX-RETRIES               PIC S9(03) VALUE 3 COMP-3.   00820000
           05 PC-M                         PIC X(01)  VALUE 'M'.        00830000
           05 PC-4001                      PIC S9(04) VALUE +4001 COMP. 00840000
           05 PC-4002                      PIC S9(04) VALUE +4002 COMP. 00850000
           05 PC-4003                      PIC S9(04) VALUE +4003 COMP. 00860000
           05 PC-4004                      PIC S9(04) VALUE +4004 COMP. 00870000
           05 PC-4005                      PIC S9(04) VALUE +4005 COMP. 00880000
           05 PC-INSERT                    PIC X(10) VALUE              00890000
                                                         'INSERT    '.  00900000
           05 PC-UPDATE                    PIC X(10) VALUE              00910000
                                                         'UPDATE    '.  00920000
           05 PC-DELETE                    PIC X(10) VALUE              00930000
                                                         'DELETE    '.  00940000
           05 PC-ERROR                     PIC X(10) VALUE              00950000
                                                         'ERROR     '.  00960000
                                                                        00970000
       01  PV-PROGRAM-VARIABLES.                                        00980000
           05 PV-PROCESS-DATE              PIC   X(10) VALUE SPACES.    00990000
                                                                        01000000
           05 PV-RETRY-COUNTER             PIC S9(04) COMP.             01010000
           05 PV-PARAGRAPH-NAME            PIC X(30)  VALUE SPACES.     01020000
           05 PV-DB2-DATE-EXISTS           PIC X(01).                   01030000
                                                                        01040000
           05  PV-FROM-DKEY-NBR-COMP       PIC S9(09) VALUE +0 COMP.    01050000
           05  PV-SAVE-FROM-DKEY-NBR       PIC S9(09) VALUE +0 COMP.    01060000
           05  PV-SAVE-TO-DKEY-NBR         PIC S9(09) VALUE +0 COMP.    01070000
           05  PV-TO-DKEY-NBR-COMP         PIC S9(09) VALUE +0 COMP.    01080000
           05  PV-FROM-TO-DEPT-NBR-COMP3   PIC S9(4)V VALUE +0 COMP-3.  01090000
                                                                        01100000
       01  PA-PROGRAM-ACCUMULATORS.                                     01110000
           05  PA-INPUT-COUNT              PIC  9(11) VALUE ZEROS.      01120000
           05  PA-INSERT-COUNT             PIC  9(11) VALUE ZEROS.      01130000
           05  PA-UPDATE-COUNT             PIC  9(11) VALUE ZEROS.      01140000
           05  PA-DELETE-COUNT             PIC  9(11) VALUE ZEROS.      01150000
           05  PA-FROM-DKEY-ROW-COUNT      PIC  9(11) VALUE ZEROS.      01160000
                                                                        01170000
       01  ABEND-CODE                        PIC S9(4) VALUE ZEROS      01180000
                                                       COMP SYNC.       01190000
                                                                        01200000
       01  ABEND-CODE-SQL              PIC S9(04)  VALUE ZERO COMP SYNC.01210000
                                                                        01220000
      ***************************************************************** 01230000
      *  CONTROL CARD WITH DATE                                         01240000
      ***************************************************************** 01250000
       01  CC-CONTROL-CARD.                                             01260000
           05  CC-PROC-DATE-ISO                PIC X(10).               01270000
           05  CC-PROC-DATE-RDF  REDEFINES                              01280000
               CC-PROC-DATE-ISO.                                        01290000
               10  CC-PROC-CC                  PIC X(02).               01300000
               10  CC-PROC-YY                  PIC X(02).               01310000
               10  FILLER                      PIC X(01).               01320000
               10  CC-PROC-MM                  PIC X(02).               01330000
               10  FILLER                      PIC X(01).               01340000
               10  CC-PROC-DD                  PIC X(02).               01350000
           05  FILLER                          PIC X(70).               01360000
                                                                        01370000
      ***************************************************************** 01380000
      *  FROM/TO DEPT AND DKEY                                          01390000
      ***************************************************************** 01400000
       01  PV-FROM-TO-DKEY-REC.                                         01410000
           05  PV-FROM-TO-DEPT-NBR             PIC 9(04).               01420000
           05  FILLER                          PIC X(01).               01430000
           05  PV-FROM-DKEY-NBR                PIC 9(09).               01440000
           05  FILLER                          PIC X(01).               01450000
           05  PV-TO-DKEY-NBR                  PIC 9(09).               01460000
           05  FILLER                          PIC X(56).               01470000
                                                                        01480000
      ***************************************************************** 01490000
      *  AUDIT FILE OF ACTION TAKEN                                     01500000
      ***************************************************************** 01510000
       01  PV-AUDIT-REC.                                                01520000
           05  PV-AUDIT-ACTION                 PIC X(10).               01530000
           05  PV-AUDIT-PARTN-NBR              PIC 9(04).               01540000
           05  PV-AUDIT-DEPT-NBR               PIC 9(04).               01550000
           05  PV-AUDIT-MAJ-CL-NBR             PIC 9(04).               01560000
           05  PV-AUDIT-SUB-CL-NBR             PIC 9(04).               01570000
           05  PV-AUDIT-LOC-NBR                PIC 9(04).               01580000
           05  PV-AUDIT-ML-LO-MDSE-LVL-ID      PIC 9(09).               01590000
           05  PV-AUDIT-FSCL-MN-END-DTE        PIC X(10).               01600000
           05  FILLER                          PIC X(31).               01610000
                                                                        01620000
      ******************************************************************01630000
      *  DB2 SQL ERROR MESSAGE FORMAT AREA                              01640000
      ******************************************************************01650000
           COPY DPWS004.                                                01660000
                                                                        01670000
      ******************************************************************01680000
      * DATE ATTRIBUTE TABLE                                            01690000
      ******************************************************************01700000
           EXEC SQL                                                     01710000
             INCLUDE TDTATTR                                            01720000
           END-EXEC.                                                    01730000
      ******************************************************************01740000
      *  MLV00000  MLV_BRND_VND VIEW                                    01750000
      ******************************************************************01760000
           EXEC SQL                                                     01770000
                INCLUDE MLV00000                                        01780000
           END-EXEC.                                                    01790000
      ******************************************************************01800000
      * PARTITION NUMBER TABLE                                          01810000
      ******************************************************************01820000
           EXEC SQL                                                     01830000
             INCLUDE MLT00003                                           01840000
           END-EXEC.                                                    01850000
      ******************************************************************01860000
      * PARTITION BAL TABLE                                             01870000
      ******************************************************************01880000
           EXEC SQL                                                     01890000
             INCLUDE MLT00002                                           01900000
           END-EXEC.                                                    01910000
      ******************************************************************01920000
      * MLT_DEPT_BRND_VND TABLE                                         01930000
      ******************************************************************01940000
           EXEC SQL                                                     01950000
             INCLUDE MLT00010                                           01960000
           END-EXEC.                                                    01970000
      ***************************************************************** 01980000
      *    DB2 AREA FOR COMMUNICATIONS                                * 01990000
      ***************************************************************** 02000000
           EXEC SQL                                                     02010000
                INCLUDE SQLCA                                           02020000
           END-EXEC.                                                    02030000
                                                                        02040000
                                                                        02050000
           EXEC SQL                                                     02060000
              DECLARE FROM_DKEY_CSR CURSOR FOR                          02070000
                SELECT                                                  02080000
                       PARTN_NBR                                        02090000
                     , DEPT_NBR                                         02100000
                     , ML_LO_MDSE_LVL_ID                                02110000
                     , FSCL_MN_END_DTE                                  02120000
                     , SHNK_RTL_AMT                                     02130000
                     , END_INV_RTL_AMT                                  02140000
                     , END_INV_COST_AMT                                 02150000
                     , GRO_MRGN_AMT                                     02160001
                     , INV_COST_ADJ1_AMT                                02170000
                     , INV_COST_ADJ2_AMT                                02180000
                     , END_INV_COST1_AMT                                02190000
                     , END_INV_COST2_AMT                                02200000
                    FROM  MLT_DEPT_BRND_VND                             02210000
                WHERE PARTN_NBR         = :MLT00003-PARTN-NBR           02220000
238672            AND DEPT_NBR          = :PV-FROM-TO-DEPT-NBR-COMP3    02230011
                  AND ML_LO_MDSE_LVL_ID = :PV-FROM-DKEY-NBR-COMP        02231009
                  AND FSCL_MN_END_DTE   = :PV-PROCESS-DATE              02240000
                   ORDER BY PARTN_NBR                                   02250000
                           ,DEPT_NBR                                    02260000
                           ,ML_LO_MDSE_LVL_ID                           02270000
                                                                        02280000
           END-EXEC.                                                    02290000
      ******************************************************************02300000
       PROCEDURE DIVISION.                                              02310000
      ******************************************************************02320000
                                                                        02330000
       0000-MAINLINE.                                                   02340000
                                                                        02350000
           PERFORM 1000-INITIALIZE.                                     02360000
                                                                        02370000
           PERFORM 1100-PROCESS-FROM-TO-FILE                            02380000
               UNTIL PS-FROM-TO-FILE-AT-END-YES.                        02390000
                                                                        02400000
           DISPLAY 'PA-INPUT-COUNT     ' PA-INPUT-COUNT.                02410000
           DISPLAY 'PA-FROM-DKEY-COUNT ' PA-FROM-DKEY-ROW-COUNT         02420000
           DISPLAY 'PA-INSERT-COUNT    ' PA-INSERT-COUNT.               02430000
           DISPLAY 'PA-UPDATE-COUNT    ' PA-UPDATE-COUNT.               02440000
           DISPLAY 'PA-DELETE-COUNT    ' PA-DELETE-COUNT.               02450000
                                                                        02460000
           CLOSE CNTL-DATE-FILE                                         02470000
                 FROM-TO-DKEY-FILE                                      02480000
                 AUDIT-FILE.                                            02490000
                                                                        02500000
           STOP RUN.                                                    02510000
                                                                        02520000
                                                                        02530000
      ******************************************************************02540000
      *  PERFORM THE NECESSARY INITIALIZATION STEPS                     02550000
      ******************************************************************02560000
       1000-INITIALIZE.                                                 02570000
                                                                        02580000
           OPEN INPUT  CNTL-DATE-FILE                                   02590000
                       FROM-TO-DKEY-FILE                                02600000
                OUTPUT AUDIT-FILE.                                      02610000
                                                                        02620000
           INITIALIZE PV-AUDIT-REC.                                     02630000
                                                                        02640000
           PERFORM 8000-READ-CNTL-DTE.                                  02650000
                                                                        02660000
           PERFORM 8100-GET-PROCESS-DATE-INFO.                          02670000
                                                                        02680000
                                                                        02690000
       1100-PROCESS-FROM-TO-FILE.                                       02700000
                                                                        02710000
           PERFORM 8200-READ-FROM-TO-FILE.                              02720000
                                                                        02730000
           IF PS-FROM-TO-FILE-AT-END-NO                                 02740000
               PERFORM 1200-EDIT-FROM-TO-DATA                           02750000
               PERFORM 1500-GET-PARTN-NBR                               02760000
               PERFORM 1600-PROCESS-DKEYS                               02770000
           END-IF.                                                      02780000
                                                                        02790000
                                                                        02800000
       1200-EDIT-FROM-TO-DATA.                                          02810000
                                                                        02820000
           IF PV-FROM-TO-DEPT-NBR NOT NUMERIC                           02830000
               MOVE PC-4001 TO ABEND-CODE                               02840000
               DISPLAY '** PROGRAM ABEND **'                            02850000
               DISPLAY 'INPUT DEPT NOT NUMERIC FOR REC # '              02860000
                                                 PA-INPUT-COUNT         02870000
               CALL 'ILBOABN0' USING ABEND-CODE.                        02880000
                                                                        02890000
           IF PV-FROM-DKEY-NBR NOT NUMERIC                              02900000
               MOVE PC-4002 TO ABEND-CODE                               02910000
               DISPLAY '** PROGRAM ABEND **'                            02920000
               DISPLAY 'INPUT FROM DKEY NOT NUMERIC FOR REC # '         02930000
                                                 PA-INPUT-COUNT         02940000
               CALL 'ILBOABN0' USING ABEND-CODE.                        02950000
                                                                        02960000
           IF PV-TO-DKEY-NBR NOT NUMERIC                                02970000
               MOVE PC-4003 TO ABEND-CODE                               02980000
               DISPLAY '** PROGRAM ABEND **'                            02990000
               DISPLAY 'INPUT TO DKEY NOT NUMERIC FOR REC # '           03000000
                                                 PA-INPUT-COUNT         03010000
               CALL 'ILBOABN0' USING ABEND-CODE.                        03020000
                                                                        03030000
                                                                        03030110
238672     DISPLAY 'INPUT CONTROL RECORD ' PA-INPUT-COUNT.              03030211
238672     DISPLAY 'PV-FROM-TO-DEPT-NBR ' PV-FROM-TO-DEPT-NBR.          03030311
238672     DISPLAY 'PV-FROM-DKEY-NBR    ' PV-FROM-DKEY-NBR.             03030411
238672     DISPLAY 'PV-TO-DKEY-NBR      ' PV-TO-DKEY-NBR.               03030511
                                                                        03030610
238672     MOVE PV-FROM-TO-DEPT-NBR  TO PV-FROM-TO-DEPT-NBR-COMP3.      03030711
                                                                        03030810
           MOVE PV-FROM-DKEY-NBR TO  PV-FROM-DKEY-NBR-COMP.             03031008
                                                                        03032008
      *    IF PV-FROM-DKEY-NBR > ZEROS                                  03040008
      *        PERFORM 1205-CHECK-VALID-FROM-DKEY                       03050008
      *    END-IF.                                                      03060008
                                                                        03070000
           MOVE PV-TO-DKEY-NBR   TO PV-TO-DKEY-NBR-COMP.                03080000
                                                                        03090000
           EXEC SQL                                                     03100000
               SELECT ML_LO_MDSE_LVL_ID                                 03110000
                 INTO :PV-SAVE-TO-DKEY-NBR                              03120000
                 FROM MLV_BRND_VND                                      03130000
                 WHERE  ML_LO_MDSE_LVL_ID = :PV-TO-DKEY-NBR-COMP        03140000
238672             AND  DEPT_NBR          = :PV-FROM-TO-DEPT-NBR-COMP3  03141011
                   AND  EFF_BEG_DTE <= :PV-PROCESS-DATE                 03150000
                   AND (EFF_END_DTE >= :PV-PROCESS-DATE                 03160000
                    OR  EFF_END_DTE IS NULL)                            03170000
               WITH UR                                                  03180000
           END-EXEC.                                                    03190000
                                                                        03200000
           EVALUATE TRUE                                                03210000
               WHEN SQLCODE = ZERO                                      03220000
                   CONTINUE                                             03230000
               WHEN SQLCODE = +100                                      03240000
                   MOVE PC-4004 TO ABEND-CODE                           03250000
                   DISPLAY '** PROGRAM ABEND **'                        03260000
                   DISPLAY 'INPUT TO DKEY NOT FOUND FOR REC # '         03270000
                                                 PA-INPUT-COUNT         03280000
                   CALL 'ILBOABN0' USING ABEND-CODE                     03290000
               WHEN OTHER                                               03300000
                   MOVE '1200-EDIT-FROM-TO-DATA     '                   03310000
                                       TO PV-PARAGRAPH-NAME             03320000
                   PERFORM 9999-SQL-ABEND                               03330000
           END-EVALUATE.                                                03340000
                                                                        03350000
                                                                        03360000
      *1205-CHECK-VALID-FROM-DKEY.                                      03370008
      *                                                                 03380008
      *    MOVE PV-FROM-DKEY-NBR TO  PV-FROM-DKEY-NBR-COMP.             03390008
      *                                                                 03400008
      *    EXEC SQL                                                     03410008
      *        SELECT ML_LO_MDSE_LVL_ID                                 03420008
      *          INTO :PV-SAVE-FROM-DKEY-NBR                            03430008
      *          FROM MLV_BRND_VND                                      03440008
      *          WHERE  ML_LO_MDSE_LVL_ID = :PV-FROM-DKEY-NBR-COMP      03450008
      *            AND  EFF_BEG_DTE <= :PV-PROCESS-DATE                 03460008
      *            AND (EFF_END_DTE >= :PV-PROCESS-DATE                 03470008
      *             OR  EFF_END_DTE IS NULL)                            03480008
      *        WITH UR                                                  03490008
      *    END-EXEC.                                                    03500008
      *                                                                 03510008
      *    EVALUATE TRUE                                                03520008
      *        WHEN SQLCODE = ZERO                                      03530008
      *            CONTINUE                                             03540008
      *        WHEN SQLCODE = +100                                      03550008
      *            MOVE PC-4004 TO ABEND-CODE                           03560008
      *            DISPLAY '** PROGRAM ABEND **'                        03570008
      *            DISPLAY 'INPUT FROM DKEY NOT FOUND FOR REC # '       03580008
      *                                          PA-INPUT-COUNT         03590008
      *            CALL 'ILBOABN0' USING ABEND-CODE                     03600008
      *        WHEN OTHER                                               03610008
      *            MOVE '1205-CHECK-VALID-FROM-DKEY '                   03620008
      *                                TO PV-PARAGRAPH-NAME             03630008
      *            PERFORM 9999-SQL-ABEND                               03640008
      *    END-EVALUATE.                                                03650008
      *                                                                 03660008
                                                                        03670000
      ******************************************************************03680000
      *  1500-GET-PARTN-NBR                                             03690000
      ******************************************************************03700000
                                                                        03710000
       1500-GET-PARTN-NBR.                                              03720000
                                                                        03750000
           EXEC SQL                                                     03760000
                SELECT PARTN_NBR                                        03770000
                    INTO   :MLT00003-PARTN-NBR                          03780000
                FROM MLT_PARTN_CNTL A                                   03790000
                    ,MLT_PARTN_BAL  B                                   03800000
                WHERE B.DEPT_NBR = :PV-FROM-TO-DEPT-NBR-COMP3           03810000
                  AND A.TBL_TM_LVL_CDE = B.TBL_TM_LVL_CDE               03820000
                  AND A.TBL_TM_LVL_CDE = :PC-M                          03830000
                  AND A.DEPT_GP_CDE = B.DEPT_GP_CDE                     03840000
                  AND A.FSCL_DTE = :PV-PROCESS-DATE                     03850000
                  AND B.EFF_BEG_DTE <= :PV-PROCESS-DATE                 03860000
                  AND B.EFF_END_DTE >= :PV-PROCESS-DATE                 03870000
                                                                        03880000
           END-EXEC.                                                    03890000
                                                                        03900000
           EVALUATE TRUE                                                03910000
               WHEN SQLCODE = 0                                         03920000
                    CONTINUE                                            03930000
               WHEN SQLWARN0 NOT = SPACES                               03940000
               WHEN SQLCODE < +0                                        03950000
               WHEN SQLCODE > +0                                        03960000
                    MOVE '1500-GET-PARTN-NBR        '                   03970000
                          TO PV-PARAGRAPH-NAME                          03980000
                    PERFORM 9999-SQL-ABEND                              03990000
           END-EVALUATE.                                                04000000
                                                                        04010000
                                                                        04020000
       1600-PROCESS-DKEYS.                                              04030000
                                                                        04040000
           PERFORM 2200-OPEN-FROM-DKEY-CSR.                             04050000
                                                                        04060000
           SET PS-FROM-DKEY-CSR-AT-END-NO TO TRUE.                      04070000
                                                                        04080000
           PERFORM 2400-PROCESS-FROM-DKEY-CSR                           04090000
              UNTIL PS-FROM-DKEY-CSR-AT-END-YES.                        04100000
                                                                        04110000
           PERFORM 2300-CLOSE-FROM-DKEY-CSR.                            04120000
                                                                        04130000
                                                                        04140000
       2200-OPEN-FROM-DKEY-CSR.                                         04150000
                                                                        04160000
           EXEC SQL                                                     04170000
               OPEN FROM_DKEY_CSR                                       04180000
           END-EXEC.                                                    04190000
                                                                        04200000
           IF SQLCODE NOT = ZERO                                        04210000
               MOVE '2200-OPEN-FROM-DKEY-CSR '                          04220000
                                       TO PV-PARAGRAPH-NAME             04230000
               PERFORM 9999-SQL-ABEND                                   04240000
           END-IF.                                                      04250000
                                                                        04260000
       2300-CLOSE-FROM-DKEY-CSR.                                        04270000
                                                                        04280000
           EXEC SQL                                                     04290000
               CLOSE FROM_DKEY_CSR                                      04300000
           END-EXEC.                                                    04310000
                                                                        04320000
           IF SQLCODE NOT = ZERO                                        04330000
               MOVE '2300-CLOSE-FROM-DKEY-CSR '                         04340000
                                       TO PV-PARAGRAPH-NAME             04350000
               PERFORM 9999-SQL-ABEND                                   04360000
           END-IF.                                                      04370000
                                                                        04380000
                                                                        04390000
       2400-PROCESS-FROM-DKEY-CSR.                                      04400000
                                                                        04410000
           PERFORM 2500-FETCH-FROM-DKEY.                                04420000
                                                                        04430000
           IF PS-FROM-DKEY-CSR-AT-END-NO                                04440000
               ADD 1               TO PA-FROM-DKEY-ROW-COUNT            04450000
               MOVE MLT00010-PARTN-NBR                                  04460000
                                   TO PV-AUDIT-PARTN-NBR                04470000
               MOVE MLT00010-DEPT-NBR                                   04480000
                                   TO PV-AUDIT-DEPT-NBR                 04490000
               MOVE MLT00010-ML-LO-MDSE-LVL-ID                          04500000
                                   TO PV-AUDIT-ML-LO-MDSE-LVL-ID        04510000
               MOVE MLT00010-FSCL-MN-END-DTE                            04520000
                                   TO PV-AUDIT-FSCL-MN-END-DTE          04530000
                                                                        04540000
               PERFORM 2700-INSERT-NEW-DKEY-ROW                         04550000
                                                                        04560000
               PERFORM 2900-DELETE-OLD-FROM-DKEY-ROW                    04570000
           END-IF.                                                      04580000
                                                                        04590000
                                                                        04600000
       2500-FETCH-FROM-DKEY.                                            04610000
                                                                        04620000
           EXEC SQL                                                     04630000
               FETCH FROM_DKEY_CSR                                      04640000
               INTO    :MLT00010-PARTN-NBR                              04650000
                      ,:MLT00010-DEPT-NBR                               04660000
                      ,:MLT00010-ML-LO-MDSE-LVL-ID                      04662005
                      ,:MLT00010-FSCL-MN-END-DTE                        04663006
                      ,:MLT00010-SHNK-RTL-AMT                           04670000
                      ,:MLT00010-END-INV-RTL-AMT                        04680000
                      ,:MLT00010-END-INV-COST-AMT                       04690000
                      ,:MLT00010-GRO-MRGN-AMT                           04700000
                      ,:MLT00010-INV-COST-ADJ1-AMT                      04710000
                      ,:MLT00010-INV-COST-ADJ2-AMT                      04720000
                      ,:MLT00010-END-INV-COST1-AMT                      04730000
                      ,:MLT00010-END-INV-COST2-AMT                      04740000
           END-EXEC.                                                    04750000
                                                                        04760000
           EVALUATE TRUE                                                04770000
               WHEN SQLCODE = ZERO                                      04780000
                   SET PS-FROM-DKEY-CSR-AT-END-NO TO TRUE               04790000
               WHEN SQLCODE = +100                                      04800000
                   SET PS-FROM-DKEY-CSR-AT-END-YES TO TRUE              04810000
               WHEN OTHER                                               04820000
                   MOVE '2500-FETCH-FROM-DKEY       '                   04830003
                                       TO PV-PARAGRAPH-NAME             04840000
                   PERFORM 9999-SQL-ABEND                               04850000
           END-EVALUATE.                                                04860000
                                                                        04870000
                                                                        04880000
                                                                        04890000
                                                                        04900000
       2700-INSERT-NEW-DKEY-ROW.                                        04910000
                                                                        04920000
           EXEC SQL                                                     04930000
               INSERT INTO MLT_DEPT_BRND_VND                            04940000
                    (  PARTN_NBR                                        04950000
                     , DEPT_NBR                                         04960000
                     , ML_LO_MDSE_LVL_ID                                04970000
                     , FSCL_MN_END_DTE                                  04980000
                     , SHNK_RTL_AMT                                     04990000
                     , END_INV_RTL_AMT                                  05000000
                     , END_INV_COST_AMT                                 05010000
                     , GRO_MRGN_AMT                                     05020000
                     , INV_COST_ADJ1_AMT                                05030000
                     , INV_COST_ADJ2_AMT                                05040000
                     , END_INV_COST1_AMT                                05050000
                     , END_INV_COST2_AMT)                               05060000
               VALUES (:MLT00010-PARTN-NBR                              05070000
                      ,:MLT00010-DEPT-NBR                               05080000
                      ,:PV-SAVE-TO-DKEY-NBR                             05090000
                      ,:MLT00010-FSCL-MN-END-DTE                        05100000
                      ,:MLT00010-SHNK-RTL-AMT                           05110000
                      ,:MLT00010-END-INV-RTL-AMT                        05120000
                      ,:MLT00010-END-INV-COST-AMT                       05130000
                      ,:MLT00010-GRO-MRGN-AMT                           05140000
                      ,:MLT00010-INV-COST-ADJ1-AMT                      05150000
                      ,:MLT00010-INV-COST-ADJ2-AMT                      05160000
                      ,:MLT00010-END-INV-COST1-AMT                      05170000
                      ,:MLT00010-END-INV-COST2-AMT)                     05180000
           END-EXEC.                                                    05190000
                                                                        05200000
           EVALUATE TRUE                                                05210000
               WHEN SQLCODE = ZERO                                      05220000
                   ADD 1                      TO PA-INSERT-COUNT        05230000
                   MOVE PV-SAVE-TO-DKEY-NBR   TO                        05240000
                                           PV-AUDIT-ML-LO-MDSE-LVL-ID   05250000
                   MOVE PC-INSERT             TO PV-AUDIT-ACTION        05260000
                   PERFORM 8300-WRITE-AUDIT-REC                         05270000
               WHEN SQLCODE = -803                                      05280000
                   PERFORM 2800-UPDATE-EXISTING-UNK-ROW                 05290000
               WHEN OTHER                                               05300000
                   DISPLAY                                              05310000
                        ' PARTN: ' MLT00010-PARTN-NBR,                  05320000
                        ' DEPT:  ' MLT00010-DEPT-NBR,                   05330000
                        ' ML-LWST-ID: ' PV-SAVE-TO-DKEY-NBR             05340000
                   MOVE '2700-INSERT-NEW-DKEY ROW '                     05350000
                                         TO PV-PARAGRAPH-NAME           05360000
                   PERFORM 9999-SQL-ABEND                               05370000
           END-EVALUATE.                                                05380000
                                                                        05390000
                                                                        05400000
       2800-UPDATE-EXISTING-UNK-ROW.                                    05410000
                                                                        05420000
           EXEC SQL                                                     05430000
             UPDATE MLT_DEPT_BRND_VND                                   05440000
               SET SHNK_RTL_AMT       = SHNK_RTL_AMT                    05450000
                            + :MLT00010-SHNK-RTL-AMT                    05460000
                  ,END_INV_RTL_AMT    = END_INV_RTL_AMT                 05470000
                            + :MLT00010-END-INV-RTL-AMT                 05480000
                  ,END_INV_COST_AMT   = END_INV_COST_AMT                05490000
                            + :MLT00010-END-INV-COST-AMT                05500000
                  ,GRO_MRGN_AMT       = GRO_MRGN_AMT                    05510000
                            + :MLT00010-GRO-MRGN-AMT                    05520000
                  ,INV_COST_ADJ1_AMT  = INV_COST_ADJ1_AMT               05530000
                            + :MLT00010-INV-COST-ADJ1-AMT               05540000
                  ,INV_COST_ADJ2_AMT  = INV_COST_ADJ2_AMT               05550000
                            + :MLT00010-INV-COST-ADJ2-AMT               05560000
                  ,END_INV_COST1_AMT  = END_INV_COST1_AMT               05570000
                            + :MLT00010-END-INV-COST1-AMT               05580000
                  ,END_INV_COST2_AMT  = END_INV_COST2_AMT               05590000
                            + :MLT00010-END-INV-COST2-AMT               05600000
                 WHERE PARTN_NBR       = :MLT00010-PARTN-NBR            05610000
                   AND DEPT_NBR        = :MLT00010-DEPT-NBR             05620000
                   AND ML_LO_MDSE_LVL_ID = :PV-SAVE-TO-DKEY-NBR         05630000
           END-EXEC.                                                    05640000
                                                                        05650000
           EVALUATE SQLCODE                                             05660000
               WHEN ZERO                                                05670000
                   ADD 1                      TO PA-UPDATE-COUNT        05680000
                   MOVE PV-SAVE-TO-DKEY-NBR   TO                        05690000
                                           PV-AUDIT-ML-LO-MDSE-LVL-ID   05700000
                   MOVE PC-UPDATE             TO PV-AUDIT-ACTION        05710000
                   PERFORM 8300-WRITE-AUDIT-REC                         05720000
               WHEN OTHER                                               05730000
                    DISPLAY '*************************************'     05740000
                    DISPLAY 'ROW IN PROCESS : '                         05750000
                         ' PARTN: ' MLT00010-PARTN-NBR,                 05760000
                         ' DEPT:  ' MLT00010-DEPT-NBR,                  05770000
                         ' ML-LWST-ID: ' PV-SAVE-TO-DKEY-NBR            05790000
                    DISPLAY '*************************************'     05800000
                    MOVE '2800-UPDATE-EXISTING-UNK-ROW '                05810000
                                          TO PV-PARAGRAPH-NAME          05820000
                    PERFORM 9999-SQL-ABEND                              05830000
           END-EVALUATE.                                                05840000
                                                                        05850000
                                                                        05860000
      ****************************************************************  05870000
      * 2900-DELETE-OLD-FROM-DKEY-ROW.                                  05880000
      ****************************************************************  05890000
                                                                        05900000
       2900-DELETE-OLD-FROM-DKEY-ROW.                                   05910000
                                                                        05920000
           EXEC SQL                                                     05930000
             DELETE FROM MLT_DEPT_BRND_VND                              05940000
                 WHERE PARTN_NBR       = :MLT00010-PARTN-NBR            05950000
                   AND DEPT_NBR        = :MLT00010-DEPT-NBR             05960000
                   AND ML_LO_MDSE_LVL_ID                                05970000
                                       = :MLT00010-ML-LO-MDSE-LVL-ID    05980000
           END-EXEC.                                                    05990000
                                                                        06000000
           EVALUATE SQLCODE                                             06010000
               WHEN ZERO                                                06020000
                   ADD 1                      TO PA-DELETE-COUNT        06030000
                   MOVE MLT00010-ML-LO-MDSE-LVL-ID  TO                  06040000
                                           PV-AUDIT-ML-LO-MDSE-LVL-ID   06050000
                   MOVE PC-DELETE             TO PV-AUDIT-ACTION        06060000
                   PERFORM 8300-WRITE-AUDIT-REC                         06070000
               WHEN OTHER                                               06080000
                    DISPLAY '*************************************'     06090000
                    DISPLAY 'ROW IN PROCESS : '                         06100000
                         ' PARTN: ' MLT00010-PARTN-NBR,                 06110000
                         ' DEPT:  ' MLT00010-DEPT-NBR,                  06120000
                         ' ML-LWST-ID: '                                06130000
                                    MLT00010-ML-LO-MDSE-LVL-ID          06140000
                    DISPLAY '*************************************'     06150000
                    MOVE '2900-DELETE-OLD-FROM-DKEY-ROW'                06160000
                                          TO PV-PARAGRAPH-NAME          06170000
                    PERFORM 9999-SQL-ABEND                              06180000
           END-EVALUATE.                                                06190000
                                                                        06200000
                                                                        06210000
      ******************************************************************06220000
      * 8000-READ-CNTL-DTE.                                             06230000
      ******************************************************************06240000
                                                                        06250000
       8000-READ-CNTL-DTE.                                              06260000
           READ CNTL-DATE-FILE INTO CC-CONTROL-CARD                     06270000
               AT END                                                   06280000
                   DISPLAY '** PROGRAM ABEND **'                        06290000
                   DISPLAY 'MLKUP976  - CONTROL DATE EMPTY'             06300000
                   MOVE PC-4005 TO ABEND-CODE                           06310000
                   CALL 'ILBOABN0' USING ABEND-CODE.                    06320000
                                                                        06330000
           DISPLAY '** MLKUP976 CONTROL CARD:' CNTL-DATE-REC.           06340000
                                                                        06350000
           MOVE CC-PROC-DATE-ISO TO PV-PROCESS-DATE.                    06360000
                                                                        06370000
      ****************************************************************  06380000
      * VALIDATE THE PROCESS DATE.                                      06390000
      ****************************************************************  06400000
                                                                        06410000
       8100-GET-PROCESS-DATE-INFO.                                      06420000
                                                                        06430000
           PERFORM                                                      06440000
               WITH TEST AFTER                                          06450000
               VARYING PV-RETRY-COUNTER                                 06460000
               FROM 1 BY 1                                              06470000
               UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               06480000
                         OR (SQLCODE = ZERO)                            06490000
                         OR (SQLCODE = 100))                            06500000
                  EXEC SQL                                              06510000
                      SELECT 'Y'                                        06520000
                        INTO :PV-DB2-DATE-EXISTS                        06530000
                        FROM TDTATTR                                    06540000
                       WHERE KY_DTE          = :PV-PROCESS-DATE         06550000
                       AND   FSCL_MN_END_DTE = :PV-PROCESS-DATE         06560000
                  END-EXEC                                              06570000
                                                                        06580000
                  EVALUATE TRUE                                         06590000
                      WHEN SQLCODE = ZERO                               06600000
                           DISPLAY 'DATE SELECT: '                      06610000
                                  PV-PROCESS-DATE                       06620000
                                  ' SUCCESSFUL'                         06630000
                           CONTINUE                                     06640000
                      WHEN SQLCODE = -904                               06650000
                      WHEN SQLCODE = -913                               06660000
                           CONTINUE                                     06670000
                      WHEN SQLWARN0 NOT = SPACES                        06680000
                      WHEN SQLCODE < ZERO                               06690000
                      WHEN SQLCODE > ZERO                               06700000
                           MOVE '3000-GET-PROCESS-DATE-INFO'            06710000
                                 TO PV-PARAGRAPH-NAME                   06720000
                           PERFORM 9999-SQL-ABEND                       06730000
                  END-EVALUATE                                          06740000
           END-PERFORM.                                                 06750000
                                                                        06760000
           IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         06770000
              DISPLAY 'RETRIES EXCEEDED FOR PROCESS DATE '              06780000
           END-IF.                                                      06790000
                                                                        06800000
      ******************************************************************06810000
      * 8200-READ-FROM-TO-FILE                                          06820000
      ******************************************************************06830000
                                                                        06840000
       8200-READ-FROM-TO-FILE.                                          06850000
                                                                        06860000
           READ FROM-TO-DKEY-FILE INTO PV-FROM-TO-DKEY-REC              06870000
               AT END                                                   06880000
                   SET PS-FROM-TO-FILE-AT-END-YES TO TRUE.              06890000
                                                                        06900000
           IF PS-FROM-TO-FILE-AT-END-NO                                 06910000
               ADD 1 TO PA-INPUT-COUNT                                  06920000
           END-IF.                                                      06930000
                                                                        06940000
      ******************************************************************06950000
      * 8300-WRITE-AUDIT-REC.                                           06960000
      ******************************************************************06970000
                                                                        06980000
       8300-WRITE-AUDIT-REC.                                            06990000
                                                                        07000000
           WRITE AUDIT-REC FROM PV-AUDIT-REC.                           07010000
                                                                        07020000
                                                                        07030000
                                                                        07040000
      ******************************************************************07050000
      *  STANDARD DB2 ERROR ABEND ROUTINE                               07060000
      *  THIS ROUTINE FORCES AN ABEND DUE TO A DB2 PROBLEM.             07070000
      ******************************************************************07080000
       9999-SQL-ABEND.                                                  07090000
                                                                        07100000
           DISPLAY '**  ABEND     **'.                                  07110000
           DISPLAY '**  PROGRAM   **  = ' PC-PGM-NAME.                  07120000
           DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            07130000
                                                                        07140000
      *    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE         07150000
      *    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.        07160000
                                                                        07170000
           COPY DPPD004.                                                07180000
                                                                        07190000
           CALL 'ILBOABN0'  USING ABEND-CODE.                           07200000
                                                                        07210000
