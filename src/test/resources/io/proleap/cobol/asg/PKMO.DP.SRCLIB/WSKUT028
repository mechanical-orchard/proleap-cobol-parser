000200* ------------------------------------------------------------- * 00020003
000300 IDENTIFICATION DIVISION.                                         00030003
000400* ------------------------------------------------------------- * 00040003
000500 PROGRAM-ID.      WSKUT028                                        00050019
000600 AUTHOR.          TKMA479                                         00060003
000700 INSTALLATION.    KOHLS DEPARTMENT STORES                         00070003
000800 DATE-WRITTEN.    05-03-2007                                      00080019
000900                                                                  00090003
000910***************************************************************** 00091004
000920*  THIS PROGRAM WILL PUT A MESSAGE ONTO THE SPECIFIED QUEUE.    * 00092004
000930*  THIS MESSAGE IS RECOGNIZED BY THE APPLICATION.               * 00093004
000940*  THE APPLICATION WILL THEN END ITS EXECUTION.                 * 00094004
001400*                                                               * 00140003
001410*                           PIXALL                              * 00141019
001500*                       Program  Logic                          * 00150003
001600*                       --------------                          * 00160003
001700*  main                                                         * 00170003
001800*  ----                                                         * 00180003
001900*                                                               * 00190003
002000*   Connect to the queue manager.                               * 00200003
002100*   If connection failed then                                   * 00210003
002200*            Call 9000-DISPLAY-ERROR-MESSAGE and exit           * 00220003
002300*                                                               * 00230003
002400*   Open the queue manager           (MQOPEN).                  * 00240003
002500*   If open failed then                                         * 00250003
002600*            Disconnect from queue manager                      * 00260003
002700*            Call 9000-DISPLAY-ERROR-MESSAGE and exit           * 00270003
002800*   Endif.                                                      * 00280003
002900*                                                               * 00290003
003000*   Close the queue manager.                                    * 00300003
003100*   If close failed then                                        * 00310003
003200*            Call 9000-DISPLAY-ERROR-MESSAGE.                   * 00320003
003300*                                                               * 00330003
003400*                                                               * 00340003
003500*   Open the specified message queue (MQOPEN).                  * 00350003
003600*   If open failed then                                         * 00360003
003700*            Disconnect from queue manager                      * 00370003
003800*            Call 9000-DISPLAY-ERROR-MESSAGE and exit           * 00380003
003900*   Endif.                                                      * 00390003
004000*                                                               * 00400003
004100*   Close the message queue.                                    * 00410003
004200*   If close failed then                                        * 00420003
004300*            Call 9000-DISPLAY-ERROR-MESSAGE.                   * 00430003
004400*                                                               * 00440003
004500*   Set the put message options.                                * 00450003
004600*            Put message to queue (MQPUT)                       * 00460003
004700*            If put failed                                      * 00470003
004800*                     Call 9000-DISPLAY-ERROR-MESSAGE           * 00480003
004900*                     Break from loop                           * 00490003
005000*            Endif                                              * 00500003
005100*                                                               * 00510003
005200*   Close the message queue.                                    * 00520003
005300*   If close failed then                                        * 00530003
005400*            Call 9000-DISPLAY-ERROR-MESSAGE.                   * 00540003
005500*                                                               * 00550003
005600*   Disconnect from the queue manager.                          * 00560003
005700*   If disconnect failed then                                   * 00570003
005800*            Call 9000-DISPLAY-ERROR-MESSAGE.                   * 00580003
005900*                                                               * 00590003
006000*   Exit program.                                               * 00600003
006100*                                                               * 00610003
006200***************************************************************** 00620003
006400 ENVIRONMENT DIVISION.                                            00640003
006600                                                                  00660003
006700 CONFIGURATION SECTION.                                           00670003
006800                                                                  00680003
006900 SOURCE-COMPUTER.       IBM-3090.                                 00690003
007000 OBJECT-COMPUTER.       IBM-3090.                                 00700003
007100                                                                  00710003
007200 INPUT-OUTPUT SECTION.                                            00720003
007900 DATA DIVISION.                                                   00790003
009000 WORKING-STORAGE SECTION.                                         00900003
009200******************************************************************00920005
009210*  COMMUNICATIONS AREA FOR DB2                                    00921005
009220******************************************************************00922005
009230     EXEC SQL                                                     00923005
009240          INCLUDE SQLCA                                           00924005
009250     END-EXEC.                                                    00925005
009260                                                                  00926005
009270     COPY SQLCA2.                                                 00927010
009310******************************************************************00931006
009320*  DB2 VIEW DECLARATION -                                         00932006
009330*      (WSV_PRVDR_QUE)  MQ INFO                                   00933021
009340******************************************************************00934006
009350     EXEC SQL                                                     00935006
009360          INCLUDE WSV00005                                        00936021
009370     END-EXEC.                                                    00937006
009380******************************************************************00938011
009390*  WORK AREA FOR SQL ERROR ROUTINE 'DSNTIAR'.                     00939011
009391******************************************************************00939111
009392     COPY DPWS004.                                                00939211
009400                                                                  00940003
009410 01  WS-VARIABLES.                                                00941010
009411     05  PV-RETRY-COUNTER           PIC S9(04) VALUE +0 COMP SYNC.00941110
009412     05  PC-MAX-RETRIES             PIC S9(03) VALUE +5 COMP-3.   00941210
009413     05  PC-CURRENT-PROGRAM-NAME    PIC X(08)  VALUE 'WSKUT028'.  00941323
009414     05  PV-ERROR-MESSAGE           PIC X(48) VALUE SPACES.       00941410
009420     05  PV-Q-MGR-NULL              PIC S9(04) VALUE 0 COMP.      00942010
009440     05  PV-Q-NAME-NULL             PIC S9(04) VALUE 0 COMP.      00944010
009441     05  PC-END-RUN-MSG              PIC  X(18) VALUE             00944120
009442                                    'END RUN OF PROGRAM'.         00944220
009443                                                                  00944312
009444 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00944412
009445                                                   COMP SYNC.     00944512
009450                                                                  00945009
009500*  Abend codes                                                    00950003
009600 01  PV-ABEND-VARIABLES.                                          00960003
009700     05  PV-ABEND-CODE              PIC S9(04) VALUE +0 COMP SYNC.00970003
009800     88  ABEND-4001-WRITE-ERROR                      VALUE +4001. 00980003
009900     88  ABEND-4002-READ-ERROR                       VALUE +4002. 00990003
010000     88  ABEND-4003-CTRL-CARD-ERROR                  VALUE +4003. 01000003
010100     88  ABEND-4004-TABLE-ERROR                      VALUE +4004. 01010003
010200     88  ABEND-4005-OPEN-ERROR                       VALUE +4005. 01020003
010300     88  ABEND-4006-CLOSE-ERROR                      VALUE +4006. 01030003
010400     88  ABEND-4007-SEQUENCE-ERROR                   VALUE +4007. 01040003
010500     88  ABEND-4008-DATA-ERROR                       VALUE +4008. 01050003
010600     88  ABEND-4009-KEY-DATA-ERROR                   VALUE +4009. 01060003
010700     88  ABEND-4013-DB2-ERROR                        VALUE +4013. 01070003
010800     88  ABEND-4019-CAL-SUB-ERROR                    VALUE +4019. 01080003
010900     88  ABEND-4020-MQ-ERROR                         VALUE +4020. 01090003
011000     88  ABEND-4444-FORCED-ABEND                     VALUE +4444. 01100003
011100                                                                  01110003
011200                                                                  01120003
011300 01  PE-MQ-ABEND-VARIABLES.                                       01130003
011400     10  PE-MQ-QMANAGER           PIC X(05) VALUE SPACES.         01140003
011500     10  PE-MQ-QNAME              PIC X(30) VALUE SPACES.         01150003
011600     10  PE-MQ-COMPLETION-CODE    PIC 9(04) VALUE ZEROS.          01160003
011700     10  PE-MQ-REASON-CODE        PIC 9(04) VALUE ZEROS.          01170003
011800                                                                  01180003
011900                                                                  01190003
012000 01  WS-MQCONN               PIC X(8)  VALUE 'CSQBCONN'.          01200003
012100 01  WS-MQOPEN               PIC X(8)  VALUE 'CSQBOPEN'.          01210003
012200 01  WS-MQINQ                PIC X(8)  VALUE 'CSQBINQ'.           01220003
012300 01  WS-MQPUT                PIC X(8)  VALUE 'CSQBPUT'.           01230003
012400 01  WS-MQCLOSE              PIC X(8)  VALUE 'CSQBCLOS'.          01240003
012500 01  WS-MQDISC               PIC X(8)  VALUE 'CSQBDISC'.          01250003
012600 01  WS-MQCHECK              PIC X(8)  VALUE 'MQR2C'.             01260003
012700 01  WS-MQCMIT               PIC X(8)  VALUE 'CSQBCOMM'.          01270003
012800 01  WS-MQBACK               PIC X(8)  VALUE 'CSQBBACK'.          01280003
012900*                                                                 01290003
013000*    General work fields                                          01300003
013100*                                                                 01310003
013200 01  NUMEXTS                 PIC 9(9)  VALUE ZEROS.               01320003
013300 01  NUMRECS                 PIC 9(9)  VALUE ZEROS.               01330003
013400 01  NUMPUTS                 PIC S9(9) BINARY VALUE 0.            01340003
013500 01  NUMCMTS                 PIC 9(9)  VALUE ZEROS.               01350003
013600 01  ERROR-MESSAGE           PIC X(48) VALUE SPACES.              01360003
013700 01  PV-PARAGRAPH            PIC X(48) VALUE SPACES.              01370003
013800 01  WS-MQ-TEXT-REASON       PIC X(30) VALUE SPACES.              01380003
013900                                                                  01390003
014000*   Parameter variables                                           01400003
014100                                                                  01410003
014200 01  QM-NAME               PIC X(48).                             01420003
014300 01  QNAME                 PIC X(48).                             01430003
014400 01  PADCHAR               PIC X(1) VALUE '*'.                    01440003
014500 01  MSGBUFFER             PIC X(450) VALUE SPACES.               01450003
014600 01  MSGLENGTH             PIC S9(9) BINARY.                      01460003
014700 01  MQ-REASON-TEXT        PIC X(30) VALUE SPACES.                01470003
014800 01  HOLD-REASON           PIC S9(9) BINARY.                      01480003
014900 01  HOLD-COMPLETION-CODE  PIC S9(9) BINARY.                      01490003
015000                                                                  01500003
015100*    API fields                                                   01510003
015200                                                                  01520003
015300 01  HCONN                   PIC S9(9) BINARY VALUE 0.            01530003
015400 01  PQ-HANDLE               PIC S9(9) BINARY VALUE 0.            01540003
015800 01  OPEN-OPTIONS            PIC S9(9) BINARY.                    01580003
015900 01  COMPLETION-CODE         PIC S9(9) BINARY.                    01590003
016000 01  REASON                  PIC S9(9) BINARY.                    01600003
016100 01  CON-REASON              PIC S9(9) BINARY.                    01610003
016200*                                                                 01620003
016300*    API control blocks                                           01630003
016400*                                                                 01640003
016500 01  MQM-OBJECT-DESCRIPTOR.                                       01650003
016600     COPY CMQODV.                                                 01660003
016700 01  MQM-MESSAGE-DESCRIPTOR.                                      01670003
016800     COPY CMQMDV.                                                 01680003
016900 01  MQM-PUT-MESSAGE-OPTIONS.                                     01690003
017000     COPY CMQPMOV.                                                01700003
017100*                                                                 01710003
017200*    MQV contains constants (for filling in the control blocks)   01720003
017300*    and return codes (for testing the result of a call)          01730003
017400*                                                                 01740003
017500 01  MQM-CONSTANTS.                                               01750003
017600     COPY CMQV.                                                   01760003
017700*                                                                 01770003
017800*----------------------------------------------------------------*01780003
017900*    CONTROL CARDS                                                01790003
018000*----------------------------------------------------------------*01800003
018100 01  CC-CONTROL-CARD-1.                                           01810003
018200     05  CC-QMGR-NAME              PIC X(48).                     01820003
018300     05  FILLER                    PIC X(32).                     01830003
018400                                                                  01840003
018500 01  CC-CONTROL-CARD-2.                                           01850003
018600     05  CC-QNAME-PIXALL           PIC X(48).                     01860020
018700     05  FILLER                    PIC X(32).                     01870003
018800                                                                  01880003
019700*----------------------------------------------------------------*01970003
019800*    PROGRAM CONSTANTS                                            01980003
019900*----------------------------------------------------------------*01990003
020000     05  PC-PGM-NAME               PIC X(09) VALUE 'WSKUT028 '.   02000020
020100     05  PC-FIFTY-STARS            PIC X(50) VALUE ALL '*'.       02010003
020200                                                                  02020003
020300     05  PS-END-OF-MSG-SW          PIC X(01) VALUE 'N'.           02030003
020400         88  PS-END-OF-MSG-YES               VALUE 'Y'.           02040003
020500         88  PS-END-OF-MSG-NO                VALUE 'N'.           02050003
020600* ------------------------------------------------------------- * 02060003
020700 PROCEDURE DIVISION.                                              02070003
020800* ------------------------------------------------------------- * 02080003
020900 1000-MAIN.                                                       02090017
021700                                                                  02170003
021710     PERFORM 7001-GET-MQ-INFO.                                    02171004
021800* ------------------------------------------------------------- * 02180003
021900*                                                                 02190003
022000*    Connect to the queue manager                                 02200003
022100*                                                                 02210003
022200     MOVE CC-QMGR-NAME TO QM-NAME.                                02220003
022300     CALL WS-MQCONN USING QM-NAME                                 02230003
022400                         HCONN                                    02240003
022500                         COMPLETION-CODE                          02250003
022600                         REASON.                                  02260003
022700*                                                                 02270003
022800*    If connection failed then display error message              02280003
022900*    and exit                                                     02290003
023000*                                                                 02300003
023100     MOVE REASON TO CON-REASON.                                   02310003
023200     IF (COMPLETION-CODE NOT = MQCC-OK) THEN                      02320003
023300        MOVE 'MQCONN ERROR'   TO ERROR-MESSAGE                    02330003
023400        PERFORM 9000-DISPLAY-ERROR-MESSAGE                        02340003
023500        GO TO 4000-END-PROGRAM                                    02350003
023600     END-IF.                                                      02360003
023700     DISPLAY 'MQCONN SUCCESSFUL TO ', QM-NAME.                    02370003
023800                                                                  02380003
023900*    OPEN THE QUEUE FOR OUTPUT - PIXALL                           02390020
024000                                                                  02400003
024100     COMPUTE OPEN-OPTIONS = MQOO-OUTPUT +                         02410003
024200                            MQOO-FAIL-IF-QUIESCING +              02420003
024300                            MQOO-SET-IDENTITY-CONTEXT.            02430003
024400     MOVE CC-QNAME-PIXALL          TO MQOD-OBJECTNAME.            02440020
024500     MOVE QM-NAME                  TO MQOD-OBJECTQMGRNAME.        02450003
024600                                                                  02460003
024700     CALL WS-MQOPEN USING HCONN                                   02470003
024800                         MQM-OBJECT-DESCRIPTOR                    02480003
024900                         OPEN-OPTIONS                             02490003
025000                         PQ-HANDLE                                02500003
025100                         COMPLETION-CODE                          02510003
025200                         REASON.                                  02520003
025300*                                                                 02530003
025400*    If open failed then display error message                    02540003
025500*    and exit.                                                    02550003
025600*                                                                 02560003
025700     IF (COMPLETION-CODE NOT = MQCC-OK) THEN                      02570003
025800        CALL WS-MQCHECK USING REASON                              02580003
025900                              WS-MQ-TEXT-REASON                   02590003
026000        MOVE 'MQOPEN ERROR'   TO ERROR-MESSAGE                    02600003
026100        PERFORM 9000-DISPLAY-ERROR-MESSAGE                        02610003
026200        GO TO 3000-DISCONNECT-QMGR                                02620003
026300     END-IF.                                                      02630003
026500     DISPLAY 'MQOPEN SUCCESSFUL-PIXALL'.                          02650020
032000                                                                  03200003
032200     PERFORM 2000-MQPUT-MSG.                                      03220004
032300                                                                  03230003
032400*    CLOSE THE QUEUE                                              03240004
032600     CALL WS-MQCLOSE USING HCONN                                  03260003
032700                          PQ-HANDLE                               03270003
032800                          MQCO-NONE                               03280003
032900                          COMPLETION-CODE                         03290003
033000                          REASON.                                 03300003
033100     IF (COMPLETION-CODE NOT = MQCC-OK) THEN                      03310003
033200        CALL WS-MQCHECK USING REASON                              03320003
033300                              WS-MQ-TEXT-REASON                   03330003
033400        MOVE 'MQCLOSE ERROR'  TO ERROR-MESSAGE                    03340003
033500        PERFORM 9000-DISPLAY-ERROR-MESSAGE                        03350003
033600     ELSE                                                         03360003
033700        DISPLAY 'MQCLOSE SUCCESSFUL'                              03370003
033800     END-IF.                                                      03380003
033900                                                                  03390003
036900*                                                                 03690003
037000     PERFORM 3000-DISCONNECT-QMGR.                                03700003
037100     GO TO 4000-END-PROGRAM.                                      03710003
037200*                                                                 03720003
037300* ------------------------------------------------------------- * 03730003
037400* PUT MESSAGE ON LOCAL QUEUE TO END THE DATA COLLECT PROCESS      03740003
037500* ------------------------------------------------------------- * 03750003
037600 2000-MQPUT-MSG.                                                  03760003
037700                                                                  03770003
038800*                                                                 03880003
038900*    Set persistence                                              03890003
039000*                                                                 03900003
039100     MOVE MQMI-NONE TO MQMD-MSGID.                                03910003
039200*    MOVE MQCI-NONE TO MQMD-CORRELID.                             03920003
039300     MOVE 'WSKUT028 '            TO MQMD-CORRELID.                03930020
039400     MOVE 'USERIDENTFIR'         TO MQMD-USERIDENTIFIER.          03940003
039500     MOVE 'PUTAPPLNAME'          TO MQMD-PUTAPPLNAME.             03950003
039600     MOVE 'APPLIDENTITYDATA'     TO MQMD-APPLIDENTITYDATA.        03960003
039700     MOVE +18                    TO MSGLENGTH.                    03970020
039900     MOVE PC-END-RUN-MSG         TO MSGBUFFER.                    03990020
040000     MOVE MQFMT-STRING           TO MQMD-FORMAT.                  04000003
040100     MOVE MQPER-PERSISTENT       TO MQMD-PERSISTENCE.             04010003
040200     COMPUTE MQPMO-OPTIONS  = MQPMO-SYNCPOINT +                   04020003
040300                              MQPMO-SET-IDENTITY-CONTEXT.         04030003
040400*                                                                 04040003
040500     CALL WS-MQPUT USING HCONN                                    04050003
040600                        PQ-HANDLE                                 04060003
040700                        MQMD                                      04070003
040800                        MQPMO                                     04080003
040900                        MSGLENGTH                                 04090003
041000                        MSGBUFFER                                 04100003
041100                        COMPLETION-CODE                           04110003
041200                        REASON                                    04120003
041300*                                                                 04130003
041400*        If put failed then display error message                 04140003
041500*        and break out of loop                                    04150003
041600*                                                                 04160003
041700     IF (COMPLETION-CODE NOT = MQCC-OK) THEN                      04170003
041800        CALL WS-MQCHECK USING REASON                              04180003
041900                              WS-MQ-TEXT-REASON                   04190003
042000        MOVE 'MQPUT ERROR'     TO ERROR-MESSAGE                   04200003
042100        PERFORM 9000-DISPLAY-ERROR-MESSAGE                        04210003
042200     ELSE                                                         04220003
042210        DISPLAY 'OUTPUT BUFFER => ' MSGBUFFER                     04221015
042220        DISPLAY '** END QUEUE **'                                 04222018
042300        ADD 1 TO NUMRECS                                          04230003
042500        PERFORM 3600-MQ-COMMIT                                    04250008
042800        ADD 1 TO NUMPUTS                                          04280003
043000     END-IF.                                                      04300003
043100*                                                                 04310003
043200* 2000-END-MQPUT-MSG.                                             04320003
043300*                                                                 04330003
043400* ------------------------------------------------------------- * 04340003
043500* CLOSE AND DISCONNECT FROM THE MQ QUEUE MANAGER                  04350003
043600* ------------------------------------------------------------- * 04360003
043700 3000-DISCONNECT-QMGR.                                            04370003
043800*                                                                 04380003
043900*    Disconnect from the queue manager                            04390003
044000*                                                                 04400003
044100     IF CON-REASON IS NOT EQUAL TO MQRC-ALREADY-CONNECTED         04410003
044200        CALL WS-MQDISC USING HCONN                                04420003
044300                            COMPLETION-CODE                       04430003
044400                            REASON                                04440003
044500        IF (COMPLETION-CODE NOT = MQCC-OK) THEN                   04450003
044600           MOVE 'MQDISC ERROR'   TO ERROR-MESSAGE                 04460003
044700           PERFORM 9000-DISPLAY-ERROR-MESSAGE                     04470003
044800        ELSE                                                      04480003
044900           DISPLAY 'MQDISC SUCCESSFUL'                            04490003
045000        END-IF                                                    04500003
045100     END-IF.                                                      04510003
045200*                                                                 04520003
045300* 3000-END-DISCONNECT.                                            04530003
045400******************************************************************04540003
045500*  COMMIT MQ PROCESSING SINCE THE POINT OF THE LAST COMMIT        04550003
045600******************************************************************04560003
045700 3600-MQ-COMMIT.                                                  04570003
045800                                                                  04580003
045900     CALL WS-MQCMIT USING HCONN                                   04590003
046000                          COMPLETION-CODE                         04600003
046100                          REASON.                                 04610003
046200                                                                  04620003
046300     IF (COMPLETION-CODE NOT = MQCC-OK)                           04630003
046400         CALL WS-MQCHECK USING REASON                             04640003
046500                               MQ-REASON-TEXT                     04650003
046600        MOVE '3600-COMMIT-MQ'   TO PV-PARAGRAPH                   04660003
046700        MOVE 'MQCMIT ERROR'     TO ERROR-MESSAGE                  04670003
046800        MOVE COMPLETION-CODE    TO HOLD-COMPLETION-CODE           04680003
046900        MOVE REASON             TO HOLD-REASON                    04690003
047000        PERFORM 3700-BACK-OUT-MQ                                  04700003
047100        MOVE HOLD-COMPLETION-CODE TO COMPLETION-CODE              04710003
047200                                        PE-MQ-COMPLETION-CODE     04720003
047300        MOVE HOLD-REASON          TO REASON                       04730003
047400                                        PE-MQ-REASON-CODE         04740003
047500        PERFORM 9200-MQ-ABEND                                     04750003
047600     ELSE                                                         04760003
047610        DISPLAY '*** MQ COMMIT ***'                               04761016
047700        ADD +1 TO NUMCMTS                                         04770003
047800     END-IF.                                                      04780003
047900                                                                  04790003
048000******************************************************************04800003
048100* BACK OUT MQ PROCESSING SINCE THE POINT OF THE LAST COMMIT       04810003
048200******************************************************************04820003
048300 3700-BACK-OUT-MQ.                                                04830003
048400                                                                  04840003
048500     CALL WS-MQBACK USING HCONN                                   04850003
048600                          COMPLETION-CODE                         04860003
048700                          REASON.                                 04870003
048800                                                                  04880003
048900     IF (COMPLETION-CODE NOT = MQCC-OK) THEN                      04890003
049000         CALL WS-MQCHECK USING REASON                             04900003
049100                            MQ-REASON-TEXT                        04910003
049200        MOVE '3700-BACK-OUT-MQ'  TO PV-PARAGRAPH                  04920003
049300        MOVE 'MQBACK ERROR'      TO ERROR-MESSAGE                 04930003
049400        PERFORM 9200-MQ-ABEND                                     04940003
049500     END-IF.                                                      04950003
049600******************************************************************04960003
049700* ------------------------------------------------------------- * 04970003
049800* END THE PROGRAM                                                 04980003
049900* ------------------------------------------------------------- * 04990003
050000 4000-END-PROGRAM.                                                05000003
050100                                                                  05010003
050400*                                                                 05040003
050500*    Display the number of messages successfully put              05050003
050600*    to the queue                                                 05060003
050700*                                                                 05070003
050900     DISPLAY NUMPUTS, ' MESSAGES PUT TO QUEUE'.                   05090003
051000     DISPLAY NUMCMTS, ' NO. OF COMMITS TAKEN '.                   05100003
051100*                                                                 05110003
051200     STOP RUN.                                                    05120003
051300*                                                                 05130003
051400******************************************************************05140003
051500* GETS MQ INFO FROM WSV_PRVDR_QUE-PIXALL                          05150020
051600******************************************************************05160003
051700 7001-GET-MQ-INFO.                                                05170003
051800                                                                  05180003
051900     PERFORM WITH TEST AFTER                                      05190003
052000             VARYING PV-RETRY-COUNTER FROM 1 BY 1                 05200003
052100             UNTIL   PV-RETRY-COUNTER > PC-MAX-RETRIES OR         05210003
052200                     SQLCODE = ZERO                               05220003
052300                                                                  05230003
052400       EXEC SQL                                                   05240003
052500        SELECT LCL_QUE_MGR,                                       05250003
052600               QUE_NM                                             05260003
052700         INTO :WSV00005-LCL-QUE-MGR:PV-Q-MGR-NULL                 05270003
052800             ,:WSV00005-QUE-NM:PV-Q-NAME-NULL                     05280003
052900         FROM WSV_PRVDR_QUE                                       05290003
053000        WHERE APPL_FUNC_DESC  = 'PIXALL'                          05300021
053100          AND INTGRTN_TYP_CDE = 'PIXREPSTRY'                      05310021
053200       END-EXEC                                                   05320003
053300                                                                  05330003
053400       EVALUATE TRUE                                              05340003
053500           WHEN SQLCODE = 0                                       05350003
053600              IF PV-Q-MGR-NULL = -1                               05360003
053700                 DISPLAY PC-CURRENT-PROGRAM-NAME                  05370003
053800                    ' - Q MGR MISSING FROM PIXALL/PIXREPSTRY'     05380021
053900                 MOVE 'Q MGR MISSING FROM PIXALL/PIXREPSTRY'      05390021
054000                    TO PV-ERROR-MESSAGE                           05400003
054100                 PERFORM 9200-MQ-ABEND                            05410003
054200              ELSE                                                05420003
054300                 IF PV-Q-MGR-NULL = 0                             05430003
054400                    INITIALIZE CC-CONTROL-CARD-1                  05440003
054500                    MOVE WSV00005-LCL-QUE-MGR-TEXT TO             05450003
054600                       CC-CONTROL-CARD-1                          05460003
054700                    DISPLAY PC-CURRENT-PROGRAM-NAME               05470003
054800                       ' MQ INFO: '                               05480023
054900                        CC-CONTROL-CARD-1                         05490003
055000                 END-IF                                           05500003
055100              END-IF                                              05510003
055200              IF PV-Q-NAME-NULL = -1                              05520003
055300                 DISPLAY PC-CURRENT-PROGRAM-NAME                  05530003
055400                    ' - Q NME MISSING FROM PIXALL/PIXREPSTRY'     05540021
055500                 MOVE 'Q NME MISSING FROM PIXALL/PIXREPSTRY'      05550021
055600                    TO PV-ERROR-MESSAGE                           05560003
055700                 PERFORM 9200-MQ-ABEND                            05570003
055800              ELSE                                                05580003
055900                 IF PV-Q-NAME-NULL = 0                            05590003
056000                    INITIALIZE CC-CONTROL-CARD-2                  05600003
056100                    MOVE WSV00005-QUE-NM-TEXT TO                  05610003
056200                       CC-CONTROL-CARD-2                          05620003
056300                    DISPLAY PC-CURRENT-PROGRAM-NAME               05630003
056400                       ' MQ INFO: '                               05640023
056500                        CC-CONTROL-CARD-2                         05650003
056600                 END-IF                                           05660003
056700              END-IF                                              05670003
056800                                                                  05680003
056900           WHEN OTHER                                             05690003
057000             MOVE SQLCODE TO SQLCODE2                             05700003
057100             DISPLAY '******************************************' 05710003
057200             DISPLAY '* ABEND                                   ' 05720003
057300             DISPLAY '* PROGRAM = WSKUT012                      ' 05730003
057400             DISPLAY '* PARAGRAPH = 7100-GET-MQ-INFO'             05740003
057500             DISPLAY '* GET MQ INFO FOR PIXALL'                   05750022
057600             DISPLAY '** SQLCODE   = ' SQLCODE2                   05760003
057700             DISPLAY '******************************************' 05770003
057800             PERFORM 9100-SQL-ABEND                               05780003
057900       END-EVALUATE                                               05790003
058000     END-PERFORM.                                                 05800003
058100                                                                  05810003
058200     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                    05820003
058300         SQLCODE NOT = ZERO                                       05830003
058400         MOVE SQLCODE TO SQLCODE2                                 05840003
058500         DISPLAY '****************************************'       05850003
058600         DISPLAY '** MAX RETRIES EXCEEDED ATTEMPTING TO **'       05860003
058700         DISPLAY '** SELECT WSV_PRVDR_QUE               **'       05870003
058800         DISPLAY '** PARAGRAPH = 7001-GET-MQ-INFO'                05880003
058900         DISPLAY '** SQLCODE   = ' SQLCODE2                       05890003
059000         DISPLAY '****************************************'       05900003
059100         PERFORM 9100-SQL-ABEND                                   05910003
059200     END-IF.                                                      05920003
073200*                                                                 07320003
073300* ------------------------------------------------------------- * 07330003
073400* DISPLAY THE VALUES OF A FAILED MQ API COMMAND                   07340003
073500* ------------------------------------------------------------- * 07350003
073600 9000-DISPLAY-ERROR-MESSAGE.                                      07360003
073700* ------------------------------------------------------------- * 07370003
073800*                                                                 07380003
073900     DISPLAY '**** ABEND *************************************'.  07390003
074000     DISPLAY '* ', PC-PGM-NAME.                                   07400003
074100     DISPLAY '* ', ERROR-MESSAGE.                                 07410003
074200     DISPLAY '* COMPLETION CODE : ', COMPLETION-CODE.             07420003
074300     DISPLAY '* REASON CODE     : ', REASON.                      07430003
074400     DISPLAY '* TEXT REASON     : ', WS-MQ-TEXT-REASON.           07440003
074500     DISPLAY '************************************************'.  07450003
074600     MOVE +4020 TO PV-ABEND-CODE.                                 07460003
074700     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         07470003
074800*                                                                 07480003
074900* 9000-DISPLAY-ERROR-MSG-END.                                     07490003
074910******************************************************************07491010
074920* 9100-SQL-ABEND - PERFORMS THE ABEND FOR THE PROGRAM IN THE      07492010
074930* EVENT THAT AN SQL ERROR OR WARNING CODE OCCURS.                 07493010
074940******************************************************************07494010
074950 9100-SQL-ABEND.                                                  07495010
074960                                                                  07496010
074970* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    07497010
074980* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         07498010
074990* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     07499010
074991* FORMAT                                                          07499110
074992     COPY DPPD004.                                                07499210
074993                                                                  07499310
075033     MOVE +4013 TO ABEND-CODE.                                    07503310
075034     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         07503410
075040****************************************************************  07504003
075100** PERFORM MQ-SERIES ABEND PROCESSING                             07510003
075200****************************************************************  07520003
075300 9200-MQ-ABEND.                                                   07530003
075400                                                                  07540003
075500     DISPLAY '**** ABEND *************************************'.  07550003
075600     DISPLAY '** MQSERIES ERROR **'.                              07560003
075700     DISPLAY '** PROGRAM:    ', PC-PGM-NAME.                      07570003
075800     DISPLAY '** ABEND CODE: ', PV-ABEND-CODE.                    07580003
075900     DISPLAY '** PARAGRAPH:  ', PV-PARAGRAPH.                     07590003
076000     DISPLAY '** MESSAGE:    ', ERROR-MESSAGE.                    07600003
076100     DISPLAY '** COMP CODE:  ', PE-MQ-COMPLETION-CODE.            07610003
076200     DISPLAY '** RSN CODE:   ', PE-MQ-REASON-CODE.                07620003
076300     DISPLAY '** RSN TEXT:   ', MQ-REASON-TEXT.                   07630003
076400                                                                  07640003
076500     MOVE +4013 TO PV-ABEND-CODE.                                 07650003
076600     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         07660003
