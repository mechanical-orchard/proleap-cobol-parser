000100 TITLE 'EXTRACT BUSINESS EVENT DATA'.                             00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300 PROGRAM-ID.    DLKUT008.                                         00030001
000400 AUTHOR.        BUDDY BARNES.                                     00040000
000500 DATE-WRITTEN.  JUNE 2004.                                        00050000
000600******************************************************************00060000
000700***************************************************************** 00070000
000800* THIS PROGRAM WILL EXTRACT RECORDS FROM PCT_BUS_EVNT_EXPRT     * 00080000
000900* TABLES AND WRITE THOSE RECORDS TO AN OUTPUT FILE.             * 00090000
001000***************************************************************** 00100000
001100 ENVIRONMENT DIVISION.                                            00110000
001200 INPUT-OUTPUT SECTION.                                            00120000
001300                                                                  00130000
001400 FILE-CONTROL.                                                    00140000
001500     SELECT BUSEV-EXTRACT-FILE     ASSIGN TO OUT01.               00150000
001600                                                                  00160000
001700 DATA DIVISION.                                                   00170000
001800 FILE SECTION.                                                    00180000
001900                                                                  00190000
002000 FD  BUSEV-EXTRACT-FILE                                           00200000
002100     RECORDING MODE IS F                                          00210000
002200     LABEL RECORDS ARE STANDARD                                   00220000
002300     BLOCK CONTAINS 0 RECORDS.                                    00230000
002400                                                                  00240000
002500 01  BUSEV-EXTRACT-RECORD             PIC X(50).                  00250000
002600                                                                  00260000
002700 WORKING-STORAGE SECTION.                                         00270000
002800                                                                  00280000
002900 01  PV-ABEND-CODE                    PIC S9(04)   VALUE ZERO     00290000
003000                                                   COMP SYNC.     00300000
003100                                                                  00310000
003200 01  PS-PROGRAM-SWITCHES.                                         00320000
003300     05  PS-END-CSR-SW                PIC X(1)   VALUE 'N'.       00330000
003400         88  PS-END-CSR                          VALUE 'Y'.       00340000
003500     05  PS-BUSEV-DETAIL-SW           PIC X(1)   VALUE 'N'.       00350000
003600         88  PS-BUSEV-DETAIL-FOUND               VALUE 'Y'.       00360000
003700         88  PS-BUSEV-DETAIL-NOT-FOUND           VALUE 'N'.       00370000
003800                                                                  00380000
003900 01  PA-PROGRAM-ACCUMULATORS.                                     00390000
004000     05  PA-BUSEV-RECS-FETCHED        PIC S9(9)   COMP-3          00400000
004100                                                  VALUE ZEROS.    00410000
004200     05  PA-OUTPUT-RECS-WRITTEN       PIC S9(9)   COMP-3          00420000
004300                                                  VALUE ZEROS.    00430000
004400                                                                  00440000
004500 01  PV-PROGRAM-VARIABLES.                                        00450000
004510     05  PV-EVNT-EXPRT-ID-HOLD        PIC S9(18)  COMP.           00451002
004600     05  PV-RETRY-COUNT               PIC S9(04)  VALUE ZERO      00460000
004700                                                  COMP SYNC.      00470000
004800     05  PV-CNTL-TMST                 PIC X(26)   VALUE SPACES.   00480000
004810     05  PV-CNTL-TMST2                PIC X(26)   VALUE SPACES.   00481003
004820     05  PV-FUNC-QTY2                 PIC S9(9) COMP.             00482003
004900     05  PV-PARAGRAPH-NAME            PIC X(30)   VALUE SPACES.   00490000
005000     05  PV-ERROR-MESSAGE-1           PIC X(60)   VALUE SPACES.   00500000
005100     05  PV-ERROR-MESSAGE-2           PIC X(60)   VALUE SPACES.   00510000
005200     05  PV-SQLCODE                   PIC 9(9)    VALUE ZERO.     00520000
005300     05  PV-DISPLAY-NUMBER            PIC 9999999999.             00530000
005400     05  PV-DISPLAY-COUNT             PIC ZZZ,ZZZ,ZZ9.            00540000
005500                                                                  00550000
005600 01  PC-PROGRAM-CONSTANTS.                                        00560000
005700     05  PC-PROGRAM-NAME              PIC X(08)  VALUE 'DLKUT008'.00570001
005800     05  PC-MAX-RETRIES               PIC S9(04) VALUE +3         00580000
005900                                                 COMP SYNC.       00590000
006000 01  PV-ABEND-FIELDS.                                             00600000
006100     05  PV-ABEND-PROGRAM             PIC X(8)   VALUE 'DLKUT008'.00610001
006200     05  PV-ABEND-PARAGRAPH           PIC X(50)  VALUE SPACES.    00620000
006300     05  PV-ABEND-OPERATION           PIC X(50)  VALUE SPACES.    00630000
006400     05  PV-ABEND-STRUCTURE-1         PIC X(15)  VALUE SPACES.    00640000
006500     05  PV-ABEND-STRUCTURE-2         PIC X(15)  VALUE SPACES.    00650000
006600     05  PV-ABEND-STRUCTURE-3         PIC X(15)  VALUE SPACES.    00660000
006700     05  PV-ABEND-STATUS              PIC XX     VALUE SPACES.    00670000
006800     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    00680000
006900     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    00690000
007000     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    00700000
007100     05  PV-DB2-OPERATION-MESSAGE-4   PIC  X(79) VALUE SPACES.    00710000
007200                                                                  00720000
007300*    DCLGEN FOR PARAMETERS                                        00730000
007400     EXEC SQL                                                     00740000
007500         INCLUDE TKRPRPM                                          00750000
007600     END-EXEC                                                     00760000
007700                                                                  00770000
007800*    DCLGEN FOR PCT_BUS_EVNT_EXPRT                                00780000
007900     EXEC SQL                                                     00790000
008000         INCLUDE PCT00011                                         00800000
008100     END-EXEC                                                     00810000
008200                                                                  00820000
008300     EXEC SQL                                                     00830000
008400         DECLARE BUSEV-CSR CURSOR FOR                             00840000
008500             SELECT EVNT_EXPRT_ID                                 00850000
008600             FROM   PCT_BUS_EVNT_EXPRT                            00860000
008700             WHERE (EXPRT_STAT_CDE = 'P'  AND                     00870003
008800                    CRE_TMST < :PV-CNTL-TMST)                     00880003
008810                OR (CRE_TMST < :PV-CNTL-TMST2)                    00881003
008900         ORDER BY 1 ASC                                           00890000
009000     END-EXEC                                                     00900000
009100/                                                                 00910000
009200*  USED FOR DB2 ERROR MESSAGE BUILDING                            00920000
009300     COPY DPWS004.                                                00930000
009400                                                                  00940000
009500*  USED FOR BUILDING OUTPUT FILE OF BUSEV KEY DATA.               00950000
009600     COPY DLRD007.                                                00960000
009700                                                                  00970000
009800*   DB2 SQL COMMUNICATION AREA                                    00980000
009900     EXEC SQL                                                     00990000
010000          INCLUDE SQLCA                                           01000000
010100     END-EXEC.                                                    01010000
010200*                                                                 01020000
010300 PROCEDURE DIVISION.                                              01030000
010400                                                                  01040000
010500     PERFORM 1000-INIT.                                           01050000
010600     PERFORM 2000-PROCESS UNTIL PS-END-CSR.                       01060000
010700     PERFORM 9000-TERMINATE.                                      01070000
010800                                                                  01080000
010900     STOP RUN.                                                    01090000
011000                                                                  01100000
011100 1000-INIT.                                                       01110000
011200     OPEN OUTPUT BUSEV-EXTRACT-FILE.                              01120000
011210     MOVE ZEROS TO PV-EVNT-EXPRT-ID-HOLD.                         01121002
011300                                                                  01130000
011400     PERFORM 3000-CALC-PURGE-TMST.                                01140000
011410     PERFORM 3010-CALC-PURGE-TMST2.                               01141003
011500     PERFORM 7000-OPEN-BUSEV-CSR.                                 01150000
011600     PERFORM 7010-FETCH-BUSEV-CSR.                                01160000
011700                                                                  01170000
011800 2000-PROCESS.                                                    01180000
011900     PERFORM 8000-WRITE-EXTRACT-REC.                              01190000
012000                                                                  01200000
012100     PERFORM 7010-FETCH-BUSEV-CSR.                                01210000
012200                                                                  01220000
012300 3000-CALC-PURGE-TMST.                                            01230000
012400                                                                  01240000
012500     EXEC SQL                                                     01250000
012600         SELECT FUNC_QTY                                          01260000
012700               ,CHAR((CURRENT TIMESTAMP) - FUNC_QTY DAYS)         01270000
012800           INTO :KRPRPM-FUNC-QTY                                  01280000
012900               ,:PV-CNTL-TMST                                     01290000
013000           FROM TKRPRPM                                           01300000
013100               ,SYSIBM.SYSDUMMY1                                  01310000
013200          WHERE LOC_ID            = 90                            01320000
013300            AND INTFC_SYS_CDE     = 'DLX'                         01330000
013400            AND SYS_PRC_FUNC_CDE  = 'DLBEPG'                      01340000
013500            AND FUNC_PRC_STAT_CDE = 'AC'                          01350000
013600     END-EXEC.                                                    01360000
013700                                                                  01370000
013800     EVALUATE TRUE                                                01380000
013900         WHEN SQLCODE = ZERO                                      01390000
014000             CONTINUE                                             01400000
014100         WHEN SQLCODE = +100                                      01410000
014200         WHEN SQLWARN0 NOT = SPACE                                01420000
014300         WHEN SQLCODE  NOT = ZERO                                 01430000
014400             MOVE '3000-CALC-PURGE-TMST' TO PV-ABEND-PARAGRAPH    01440000
014500             MOVE 'SELECT'               TO PV-ABEND-OPERATION    01450000
014600             MOVE 'CALC PURGE TMST    '  TO PV-ABEND-STRUCTURE-1  01460000
014700             MOVE 'DB2 - TKRPRPM     '   TO PV-ABEND-STRUCTURE-2  01470000
014800             PERFORM 9900-DB2-ABEND                               01480000
014900     END-EVALUATE.                                                01490000
015000                                                                  01500000
015010 3010-CALC-PURGE-TMST2.                                           01501003
015020                                                                  01502003
015030     EXEC SQL                                                     01503003
015040         SELECT FUNC_QTY                                          01504003
015050               ,CHAR((CURRENT TIMESTAMP) - FUNC_QTY DAYS)         01505003
015060           INTO :PV-FUNC-QTY2                                     01506003
015070               ,:PV-CNTL-TMST2                                    01507003
015080           FROM TKRPRPM                                           01508003
015090          WHERE LOC_ID            = 90                            01509003
015091            AND INTFC_SYS_CDE     = 'DLX'                         01509103
015092            AND SYS_PRC_FUNC_CDE  = 'DLBEP2'                      01509203
015093            AND FUNC_PRC_STAT_CDE = 'AC'                          01509303
015094     END-EXEC.                                                    01509403
015095                                                                  01509503
015096     EVALUATE TRUE                                                01509603
015097         WHEN SQLCODE = ZERO                                      01509703
015098             CONTINUE                                             01509803
015099         WHEN SQLCODE = +100                                      01509903
015100         WHEN SQLWARN0 NOT = SPACE                                01510003
015101         WHEN SQLCODE  NOT = ZERO                                 01510103
015102             MOVE '3010-CALC-PURGE-TMST2' TO PV-ABEND-PARAGRAPH   01510203
015103             MOVE 'SELECT'               TO PV-ABEND-OPERATION    01510303
015104             MOVE 'CALC PURGE TMST2   '  TO PV-ABEND-STRUCTURE-1  01510403
015105             MOVE 'DB2 - TKRPRPM     '   TO PV-ABEND-STRUCTURE-2  01510503
015106             PERFORM 9900-DB2-ABEND                               01510603
015107     END-EVALUATE.                                                01510703
015108                                                                  01510803
015109                                                                  01510903
015110 7000-OPEN-BUSEV-CSR.                                             01511000
015200     EXEC SQL                                                     01520000
015300         OPEN BUSEV-CSR                                           01530000
015400     END-EXEC.                                                    01540000
015500                                                                  01550000
015600     EVALUATE TRUE                                                01560000
015700         WHEN SQLCODE = ZERO                                      01570000
015800             CONTINUE                                             01580000
015900         WHEN SQLWARN0 NOT = SPACE                                01590000
016000         WHEN SQLCODE  NOT = ZERO                                 01600000
016100             MOVE '7000-OPEN-BUSEV-CSR'  TO PV-ABEND-PARAGRAPH    01610000
016200             MOVE 'OPEN CURSOR'          TO PV-ABEND-OPERATION    01620000
016300             MOVE 'BUSEV PURGE PROCESS'  TO PV-ABEND-STRUCTURE-1  01630000
016400             MOVE 'DB2 - PCT_BUS_EVNT'   TO PV-ABEND-STRUCTURE-2  01640000
016500             PERFORM 9900-DB2-ABEND                               01650000
016600     END-EVALUATE.                                                01660000
016700                                                                  01670000
016800 7010-FETCH-BUSEV-CSR.                                            01680000
016900     EXEC SQL                                                     01690000
017000         FETCH BUSEV-CSR                                          01700000
017100         INTO                                                     01710000
017200             :PCT00011-EVNT-EXPRT-ID                              01720000
017300     END-EXEC.                                                    01730000
017400                                                                  01740000
017500     EVALUATE TRUE                                                01750000
017600         WHEN SQLCODE = ZERO                                      01760000
017700             ADD 1                    TO PA-BUSEV-RECS-FETCHED    01770000
017800                                                                  01780000
017900         WHEN SQLCODE = +100                                      01790000
018000             SET PS-END-CSR           TO TRUE                     01800000
018100         WHEN SQLWARN0 NOT = SPACE                                01810000
018200         WHEN SQLCODE  NOT = ZERO                                 01820000
018300             MOVE '7010-FETCH-BUSEV-CSR' TO PV-ABEND-PARAGRAPH    01830000
018400             MOVE 'FETCH CURSOR'         TO PV-ABEND-OPERATION    01840000
018500             MOVE 'BUSEV PURGE PROCESS'  TO PV-ABEND-STRUCTURE-1  01850000
018600             MOVE 'DB2 - PCT_BUS_EVNT'   TO PV-ABEND-STRUCTURE-2  01860000
018700             PERFORM 9900-DB2-ABEND                               01870000
018800     END-EVALUATE.                                                01880000
018900                                                                  01890000
019000 7020-CLOSE-BUSEV-CSR.                                            01900000
019100     EXEC SQL                                                     01910000
019200         CLOSE BUSEV-CSR                                          01920000
019300     END-EXEC.                                                    01930000
019400                                                                  01940000
019500     EVALUATE TRUE                                                01950000
019600         WHEN SQLCODE = ZERO                                      01960000
019700             CONTINUE                                             01970000
019800         WHEN SQLWARN0 NOT = SPACE                                01980000
019900         WHEN SQLCODE  NOT = ZERO                                 01990000
020000             MOVE '7020-CLOSE-BUSEV-CSR' TO PV-ABEND-PARAGRAPH    02000000
020100             MOVE 'CLOSE CURSOR'         TO PV-ABEND-OPERATION    02010000
020200             MOVE 'BUSEV PURGE PROCESS'  TO PV-ABEND-STRUCTURE-1  02020000
020300             MOVE 'DB2 - PCT_BUS_EVNT'   TO PV-ABEND-STRUCTURE-2  02030000
020400             PERFORM 9900-DB2-ABEND                               02040000
020500     END-EVALUATE.                                                02050000
020600                                                                  02060000
020700 8000-WRITE-EXTRACT-REC.                                          02070000
020800                                                                  02080000
020900     INITIALIZE DL007-BUSEV-PURGE-LAYOUT.                         02090000
021000                                                                  02100000
021100     MOVE PCT00011-EVNT-EXPRT-ID     TO PV-EVNT-EXPRT-ID-HOLD.    02110002
021110     MOVE PV-EVNT-EXPRT-ID-HOLD      TO DL007-EVNT-EXPRT-ID.      02111002
021200                                                                  02120000
021300     ADD 1 TO PA-OUTPUT-RECS-WRITTEN.                             02130000
021400     WRITE BUSEV-EXTRACT-RECORD FROM DL007-BUSEV-PURGE-LAYOUT.    02140000
021500                                                                  02150000
021600 9000-TERMINATE.                                                  02160000
021700                                                                  02170000
021800     PERFORM 7020-CLOSE-BUSEV-CSR.                                02180000
021900                                                                  02190000
022000     CLOSE BUSEV-EXTRACT-FILE.                                    02200000
022100                                                                  02210000
022200     DISPLAY 'TMST :'  PV-CNTL-TMST.                              02220000
022210     DISPLAY 'TMST2:'  PV-CNTL-TMST.                              02221004
022300                                                                  02230000
022400     DISPLAY '************************'.                          02240000
022500     DISPLAY '******* DLKUT008 *******'.                          02250001
022600     DISPLAY '************************'.                          02260000
022700     DISPLAY SPACES                                               02270000
022800                                                                  02280000
022900     MOVE PA-BUSEV-RECS-FETCHED       TO PV-DISPLAY-COUNT.        02290000
023000     DISPLAY 'TOTAL BUSEV RECS FETCHED      = ' PV-DISPLAY-COUNT. 02300000
023100                                                                  02310000
023200     MOVE PA-OUTPUT-RECS-WRITTEN      TO PV-DISPLAY-COUNT.        02320000
023300     DISPLAY 'TOTAL OUTPUT RECS WRITTEN     = ' PV-DISPLAY-COUNT. 02330000
023400                                                                  02340000
023500     DISPLAY SPACES                                               02350000
023600     DISPLAY '************************'.                          02360000
023700                                                                  02370000
023800 9900-DB2-ABEND.                                                  02380000
023900                                                                  02390000
024000     MOVE SQLCODE TO PV-SQLCODE.                                  02400000
024100     DISPLAY '*** DB2 ERROR '.                                    02410000
024200     DISPLAY '*** SQLCODE   = ' PV-SQLCODE.                       02420000
024300     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 02430000
024400     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               02440000
024500     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               02450000
024600     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       02460000
024700     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.       02470000
024800     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-3.       02480000
024900     DISPLAY '*** PROCESS   = ' PV-ABEND-STRUCTURE-1.             02490000
025000     DISPLAY '*** TABLE     = ' PV-ABEND-STRUCTURE-2.             02500000
025100                                                                  02510000
025200     COPY DPPD004.                                                02520000
025300                                                                  02530000
025400     MOVE +4013                  TO PV-ABEND-CODE.                02540000
025500     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         02550000
025600                                                                  02560000
