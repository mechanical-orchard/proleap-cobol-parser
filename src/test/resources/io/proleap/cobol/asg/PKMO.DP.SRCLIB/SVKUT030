000100******************************************************************00010026
000200 IDENTIFICATION DIVISION.                                         00020026
000300******************************************************************00030026
000400 PROGRAM-ID.         SVKUT030.                                    00040026
000500 AUTHOR.             KARI SUTTON.                                 00050026
000600 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00060026
000700 DATE-WRITTEN.       MAY 1996.                                    00070026
000800 DATE-COMPILED.                                                   00080026
000900                                                                  00090026
001000******************************************************************00100026
001100* THIS PROGRAM PREPARES THE UPDATE POSTING FILE TO BE PROCESSED  *00110026
001200* BY SVKUP014 UNDER THE DB2 CHECKPOINT RESTART SYSTEM.           *00120026
001300*                                                                *00130026
001400* THE PROGRAM READS THE UPDATE POSTING FILE, REFORMATS THE       *00140026
001500* RECORDS AND SETS A CHECKPOINT INDICATOR ON THE RECORD BASED    *00150026
001600* ON HOW CHECKPOINTS WILL BE TAKEN BY THE MAINTENANCE PROGRAM.   *00160026
001700* AFTER A RECORD HAS BEEN REFORMATTED IT IS PASSED TO THE        *00170026
001800* TRANSACTION PREPARATION MODULE (DPKUT900) WHICH DOES SOME MORE *00180026
001900* PROCESSING ON THE RECORDS AND WRITES THE REFORMATTED RECORDS   *00190026
002000* OUT TO A SEQUENTIAL FILE.                                      *00200026
002100*                                                                *00210026
002200* THE PROGRAM COMMUNICATES WITH THE TRANSACTION PREPARATION      *00220026
002300* MODULE USING FUNCTION CODES (OPEN, WRITE, & CLOSE) AND CHECKS  *00230026
002400* THE RETURN CODE AFTER EACH REQUEST.  IF AN INVALID RETURN CODE *00240026
002500* IS RECEIVED, ANY INFORMATION THAT MAY BE HELPFUL IN RESOLVING  *00250026
002600* THE BAD RETURN CODE IS DISPLAYED ON SYSOUT AND THE PROGRAM     *00260026
002700* ABENDS.                                                        *00270026
002800*                                                                *00280026
002900* INPUT FILES:   UPDATE-POSTING-FILE       DDNAME = INP01        *00290026
003000*                                                                *00300026
003100* OUTPUT FILES:  N/A                                             *00310026
003200*                                                                *00320026
003300******************************************************************00330026
P10237*  06/15/2015  COSA DATA SECURITY PROJECT.                       *00331029
P10237*     CHANGES MADE TO ACCOMMODATE THE ENCRYPTED DL#.             *00332029
P10237*  MADE BY: COGNIZANT                   WR#: CHG0104429          *00337029
P10237******************************************************************00338029
P12431*  08/27/2018  MODIFIED THE PROGRAM TO HANDLE NEWLY ADDED        *00339032
P12431*              ORD_NBR FIELD IN THE SVT TABLES.                  *00339132
P12431*  MADE BY: COGNIZANT                   WR#: CHG0208643          *00339234
P12431******************************************************************00339332
260107* CHG0260107   JIM HUNTER   08-19-21   ADD COPYBOOK DPWS990 TO    00339435
260107*                                      MAKE DPKUT900 CALL DYNAMIC.00339535
003500******************************************************************00350026
003600 ENVIRONMENT DIVISION.                                            00360026
003700******************************************************************00370026
003800                                                                  00380026
003900 CONFIGURATION SECTION.                                           00390026
004000                                                                  00400026
004100 SOURCE-COMPUTER.    IBM-3090.                                    00410026
004200 OBJECT-COMPUTER.    IBM-3090.                                    00420026
004300                                                                  00430026
004400 INPUT-OUTPUT SECTION.                                            00440026
004500                                                                  00450026
004600 FILE-CONTROL.                                                    00460026
004700                                                                  00470026
004800     SELECT UPDATE-POSTING-FILE  ASSIGN TO INP01.                 00480026
004900                                                                  00490026
005000******************************************************************00500026
005100 DATA DIVISION.                                                   00510026
005200******************************************************************00520026
005300                                                                  00530026
005400 FILE SECTION.                                                    00540026
005500                                                                  00550026
005600 FD  UPDATE-POSTING-FILE                                          00560026
005700     RECORDING MODE IS F                                          00570026
005800     BLOCK CONTAINS 0 RECORDS                                     00580026
005900     LABEL RECORDS ARE OMITTED.                                   00590026
006000                                                                  00600026
P12431 01  UPDATE-POSTING-RECORD       PIC  X(198).                     00610032
006200                                                                  00620026
006300 WORKING-STORAGE SECTION.                                         00630026
006400                                                                  00640026
006500 01  ABEND-CODE                  PIC S9(04)     VALUE +0  COMP.   00650026
006600                                                                  00660026
006700******************************************************************00670026
006800*PC - PROGRAM CONSTANTS                                           00680026
006900******************************************************************00690026
007000 01  PROGRAM-CONSTANTS.                                           00700026
007100     05  PC-PROGRAM-NAME         PIC X(08)      VALUE 'SVKUT030'. 00710026
007200     05  PC-TRAN-PREP-FUNC-CODES.                                 00720026
007300         10  PC-TRAN-PREP-FUNC-OPEN                               00730026
007400                                 PIC X(05)      VALUE 'OPEN '.    00740026
007500         10  PC-TRAN-PREP-FUNC-WRITE                              00750026
007600                                 PIC X(05)      VALUE 'WRITE'.    00760026
007700         10  PC-TRAN-PREP-FUNC-CLOSE                              00770026
007800                                 PIC X(05)      VALUE 'CLOSE'.    00780026
007900     05  PC-JOB-NAME             PIC X(08)      VALUE 'SVK065  '. 00790026
008000     05  PC-PLAN-NAME            PIC X(08)      VALUE 'SVKUP014'. 00800026
P12431     05  PC-TRANS-RECORD-LENGTH  PIC S9(04)     VALUE +198 COMP.  00810034
008200                                                                  00820026
008300******************************************************************00830026
008400*PV - PROGRAM VARIABLES                                           00840026
008500******************************************************************00850026
008600 01  PROGRAM-VARIABLES.                                           00860026
008700     05  PV-CHECKPOINT-TYPE      PIC X(01)      VALUE SPACE.      00870026
008800         88  CONTROL-BREAK                      VALUE 'C'.        00880026
008900         88  LOGICAL-TRANSACTION                VALUE 'L'.        00890026
009000         88  TIME-INTERVAL                      VALUE 'T'.        00900026
009100         88  REQUESTED-BY-PROGRAM               VALUE 'R'.        00910026
009200     05  PV-HOLD-KMC-CRD-NBR     PIC S9(12)V    VALUE ZERO COMP-3.00920026
009300                                                                  00930026
009400******************************************************************00940026
009500*PA - PROGRAM ACCUMULATORS                                        00950026
009600******************************************************************00960026
009700 01  PROGRAM-ACCUMULATORS.                                        00970026
009800     05  PA-POSTING-RECORDS-READ PIC S9(11)     COMP-3            00980026
009900                                                VALUE ZEROES.     00990026
010000     05  PA-POSTING-RECS-WRITTEN PIC S9(11)     COMP-3            01000026
010100                                                VALUE ZEROES.     01010026
010200                                                                  01020026
010300******************************************************************01030026
010400*PS - PROGRAM SWITCHES                                            01040026
010500******************************************************************01050026
010600 01  PROGRAM-SWITCHES.                                            01060026
010700     05  PS-UPD-POSTING-EOF-SW   PIC X(01)      VALUE 'N'.        01070026
010800         88  PS-UPD-POSTING-EOF                 VALUE 'Y'.        01080026
010900     05  PS-FIRST-TRANS-READ-SW  PIC X(01)      VALUE 'Y'.        01090026
011000         88  FIRST-TRANS-READ                   VALUE 'Y'.        01100026
011100                                                                  01110026
011200******************************************************************01120026
011300*  KMC UPDATE POSTING RECORD LAYOUT                              *01130026
011400******************************************************************01140026
011500     COPY SVRD018.                                                01150026
011600                                                                  01160026
011700******************************************************************01170026
011800*  TRANSACTION PREPARATION MODULE LINKAGE SECTION                *01180026
011900******************************************************************01190026
260107     COPY DPWS990.                                                01200035
012100                                                                  01210026
012000     COPY DPLS000.                                                01211035
012100                                                                  01212035
012200******************************************************************01220026
012300*  SQL COMMUNICATIONS WORK AREA                                  *01230026
012400******************************************************************01240026
012500     COPY SQLCA2.                                                 01250026
012600                                                                  01260026
012700 EJECT                                                            01270026
012800******************************************************************01280026
012900 PROCEDURE DIVISION.                                              01290026
013000******************************************************************01300026
013100* A100-MAINLINE-PROCESSING                                        01310026
013200*    CONTROLS FLOW OF THE PROGRAM                                *01320026
013300******************************************************************01330026
013400 A100-MAINLINE-PROCESSING.                                        01340026
013500                                                                  01350026
013600     PERFORM B100-INITIALIZE.                                     01360026
013700                                                                  01370026
013800     PERFORM B200-PROCESS-UPD-POSTING-FILE                        01380026
013900         UNTIL PS-UPD-POSTING-EOF.                                01390026
014000                                                                  01400026
014100     PERFORM B300-END-OF-JOB-ROUTINE.                             01410026
014200                                                                  01420026
014300     GOBACK.                                                      01430026
014400 EJECT                                                            01440026
014500******************************************************************01450026
014600* B100-INITIALIZE                                                *01460026
014700******************************************************************01470026
014800 B100-INITIALIZE.                                                 01480026
014900                                                                  01490026
015000     PERFORM C100-ISSUE-OPEN-REQUEST.                             01500026
015100                                                                  01510026
015200     OPEN INPUT UPDATE-POSTING-FILE.                              01520026
015300                                                                  01530026
015400     PERFORM C200-READ-UPDATE-POSTING-FILE.                       01540026
015500     IF PS-UPD-POSTING-EOF                                        01550026
015600         DISPLAY ' '                                              01560026
015700         DISPLAY 'MESSAGES FOR PROGRAM ' PC-PROGRAM-NAME          01570026
015800         DISPLAY 'UPDATE POSTING FILE IS EMPTY'                   01580026
015900         DISPLAY ' '                                              01590026
016000     END-IF.                                                      01600026
016100                                                                  01610026
016200******************************************************************01620026
016300* B200-PROCESS-UPD-POSTING-FILE                                  *01630026
016400*     READ AN UPDATE POSTING RECORD.  IF END-OF-FILE, STOP PRO-  *01640026
016500*     CESSING.  IF A RECORD IS READ, GATHER WHATEVER OTHER DATA  *01650026
016600*     IS NECESSARY TO TAKE CHECKPOINTS BASED ON THE TYPE OF      *01660026
016700*     CHECKPOINTS BEING TAKEN BY SVKUP014 AND ISSUE A WRITE      *01670026
016800*     REQUEST TO THE TRANSACTION PREPARATION PROGRAM.            *01680026
016900******************************************************************01690026
017000 B200-PROCESS-UPD-POSTING-FILE.                                   01700026
017100                                                                  01710026
017200     IF FIRST-TRANS-READ                                          01720026
017300         MOVE SV018-KMC-CRD-NBR TO PV-HOLD-KMC-CRD-NBR            01730026
017400         MOVE 'N' TO PS-FIRST-TRANS-READ-SW                       01740026
017500     END-IF.                                                      01750026
017600                                                                  01760026
017700     IF CONTROL-BREAK                                             01770026
017800         PERFORM C300-CKPT-BY-CNTL-BREAK                          01780026
017900     ELSE                                                         01790026
018000         IF LOGICAL-TRANSACTION                                   01800026
018100             PERFORM C400-CKPT-BY-LOGICAL-TRANS                   01810026
018200         ELSE                                                     01820026
018300             PERFORM C500-CKPT-BY-TIME-OR-REQUEST                 01830026
018400         END-IF                                                   01840026
018500     END-IF.                                                      01850026
018600                                                                  01860026
018700     PERFORM C200-READ-UPDATE-POSTING-FILE.                       01870026
018800                                                                  01880026
018900 EJECT                                                            01890026
019000******************************************************************01900026
019100* B300-END-OF-JOB-ROUTINE                                        *01910026
019200*                                                                *01920026
019300*                                                                *01930026
019400******************************************************************01940026
019500 B300-END-OF-JOB-ROUTINE.                                         01950026
019600                                                                  01960026
019700     CLOSE UPDATE-POSTING-FILE.                                   01970026
019800                                                                  01980026
019900     DISPLAY ' '.                                                 01990026
020000     DISPLAY 'MESSAGES FOR PROGRAM ' PC-PROGRAM-NAME.             02000026
020100     DISPLAY 'NUMBER OF POSTING RECORDS READ:        '            02010026
020200             PA-POSTING-RECORDS-READ.                             02020026
020300     DISPLAY 'NUMBER OF TRANS/PREP RECORDS WRITTEN:  '            02030026
020400             PA-POSTING-RECS-WRITTEN.                             02040026
020500     DISPLAY ' '.                                                 02050026
020600                                                                  02060026
020700     PERFORM C600-ISSUE-CLOSE-REQUEST.                            02070026
020800                                                                  02080026
020900******************************************************************02090026
021000* C100-ISSUE-OPEN-REQUEST                                        *02100026
021100*     ISSUE AN 'OPEN' REQUEST TO THE TRANSACTION PREPARATION     *02110026
021200*     MODULE.                                                    *02120026
021300******************************************************************02130026
021400 C100-ISSUE-OPEN-REQUEST.                                         02140026
021500                                                                  02150026
021600     MOVE PC-TRAN-PREP-FUNC-OPEN TO DP000-FUNC-CODE.              02160026
021700     MOVE PC-JOB-NAME            TO DP000-JOB-NAME.               02170026
021800     MOVE PC-PLAN-NAME           TO DP000-PLAN-NAME.              02180026
021900                                                                  02190026
022000     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02200026
022100                                                                  02210026
022200     MOVE DP000-CKPT-TYPE-CODE   TO PV-CHECKPOINT-TYPE.           02220026
022300                                                                  02230026
022400******************************************************************02240026
022500* C200-READ-UPDATE-POSTING-FILE                                  *02250026
022600******************************************************************02260026
022700 C200-READ-UPDATE-POSTING-FILE.                                   02270026
022800                                                                  02280026
022900     READ UPDATE-POSTING-FILE INTO SV018-UPDATE-POSTING-RECORD    02290026
023000         AT END                                                   02300026
023100             SET PS-UPD-POSTING-EOF TO TRUE.                      02310026
023200                                                                  02320026
023300     IF PS-UPD-POSTING-EOF                                        02330026
023400         CONTINUE                                                 02340026
023500     ELSE                                                         02350026
023600         ADD +1 TO PA-POSTING-RECORDS-READ                        02360026
023700     END-IF.                                                      02370026
023800                                                                  02380026
023900******************************************************************02390026
024000* C300-CKPT-BY-CNTL-BREAK                                        *02400026
024100*     THIS ROUTINE SETS THE CHECKPOINT INDICATOR ON THE TRANSAC- *02410026
024200*     TION RECORD "ON" IF THERE IS A CHANGE IN THE KMC CARD      *02420026
024300*     NUMBER.  AFTER THE TRANSACTION RECORD HAS BEEN FORMATTED,  *02430026
024400*     A WRITE REQUEST IS ISSUED TO THE TRANSACTION PREPARATION   *02440026
024500*     MODULE.                                                    *02450026
024600* NOTE: AT THIS TIME CONTROL/LOGIC BREAK PROCESSING IS IDENTICAL.*02460026
024700******************************************************************02470026
024800 C300-CKPT-BY-CNTL-BREAK.                                         02480026
024900                                                                  02490026
025000     IF SV018-KMC-CRD-NBR = PV-HOLD-KMC-CRD-NBR                   02500026
025100         MOVE 'N' TO DP000-CHECKPOINT-IND                         02510026
025200     ELSE                                                         02520026
025300         MOVE 'Y' TO DP000-CHECKPOINT-IND                         02530026
025400         MOVE SV018-KMC-CRD-NBR TO PV-HOLD-KMC-CRD-NBR            02540026
025500     END-IF.                                                      02550026
025600                                                                  02560026
025700     MOVE PC-TRANS-RECORD-LENGTH  TO DP000-TRANS-REC-LENGTH.      02570026
025800     MOVE SV018-UPDATE-POSTING-RECORD                             02580026
025900                                  TO DP000-TRANS-REC.             02590026
026000     MOVE PC-TRAN-PREP-FUNC-WRITE TO DP000-FUNC-CODE.             02600026
026100     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              02610026
026200     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             02620026
026300                                                                  02630026
026400     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02640026
026500     ADD +1 TO PA-POSTING-RECS-WRITTEN.                           02650026
026600                                                                  02660026
026700******************************************************************02670026
026800* C400-CKPT-BY-LOGICAL-TRANS.                                    *02680026
026900*     THIS ROUTINE SETS THE CHECKPOINT INDICATOR ON THE TRANSAC- *02690026
027000*     TION RECORD "ON" IF THERE IS A CHANGE IN THE KMC CARD      *02700026
027100*     NUMBER.  AFTER THE TRANSACTION RECORD HAS BEEN FORMATTED,  *02710026
027200*     A WRITE REQUEST IS ISSUED TO THE TRANSACTION PREPARATION   *02720026
027300*     MODULE.                                                    *02730026
027400* NOTE: AT THIS TIME CONTROL/LOGIC BREAK PROCESSING IS IDENTICAL.*02740026
027500******************************************************************02750026
027600 C400-CKPT-BY-LOGICAL-TRANS.                                      02760026
027700                                                                  02770026
027800     IF SV018-KMC-CRD-NBR  = PV-HOLD-KMC-CRD-NBR                  02780026
027900         MOVE 'N' TO DP000-CHECKPOINT-IND                         02790026
028000     ELSE                                                         02800026
028100         MOVE 'Y' TO DP000-CHECKPOINT-IND                         02810026
028200         MOVE SV018-KMC-CRD-NBR   TO PV-HOLD-KMC-CRD-NBR          02820026
028300     END-IF.                                                      02830026
028400                                                                  02840026
028500     MOVE PC-TRANS-RECORD-LENGTH  TO DP000-TRANS-REC-LENGTH.      02850026
028600     MOVE SV018-UPDATE-POSTING-RECORD                             02860026
028700                                  TO DP000-TRANS-REC.             02870026
028800     MOVE PC-TRAN-PREP-FUNC-WRITE TO DP000-FUNC-CODE.             02880026
028900     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              02890026
029000     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             02900026
029100                                                                  02910026
029200     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02920026
029300     ADD +1 TO PA-POSTING-RECS-WRITTEN.                           02930026
029400                                                                  02940026
029500******************************************************************02950026
029600* C500-CKPT-BY-TIME-OR-REQUEST.                                  *02960026
029700*     THIS ROUTINE BUILDS THE TRANSACTION RECORD AND ISSUES A    *02970026
029800*     WRITE REQUEST TO THE TRANSACTION PREPARATION MODULE IF     *02980026
029900*     CHECKPOINTS ARE TAKEN BY TIME INTERVAL (SECONDS) OR        *02990026
030000*     REQUESTED BY THE MAINTENANCE PROGRAM.                      *03000026
030100******************************************************************03010026
030200 C500-CKPT-BY-TIME-OR-REQUEST.                                    03020026
030300                                                                  03030026
030400     MOVE 'N' TO DP000-CHECKPOINT-IND.                            03040026
030500     MOVE PC-TRANS-RECORD-LENGTH  TO DP000-TRANS-REC-LENGTH.      03050026
030600     MOVE SV018-UPDATE-POSTING-RECORD                             03060026
030700                                  TO DP000-TRANS-REC.             03070026
030800     MOVE PC-TRAN-PREP-FUNC-WRITE TO DP000-FUNC-CODE.             03080026
030900     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              03090026
031000     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             03100026
031100                                                                  03110026
031200     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         03120026
031300     ADD +1 TO PA-POSTING-RECS-WRITTEN.                           03130026
031400                                                                  03140026
031500******************************************************************03150026
031600* C600-ISSUE-CLOSE-REQUEST                                       *03160026
031700*     ISSUE A 'CLOSE' REQUEST TO THE TRANSACTION PREPARATION     *03170026
031800*     MODULE.                                                    *03180026
031900******************************************************************03190026
032000 C600-ISSUE-CLOSE-REQUEST.                                        03200026
032100                                                                  03210026
032200     MOVE PC-TRAN-PREP-FUNC-CLOSE TO DP000-FUNC-CODE.             03220026
032300     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              03230026
032400     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             03240026
032500                                                                  03250026
032600     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         03260026
032700                                                                  03270026
032800******************************************************************03280026
032900*  TRANSACTION PREPARATION MODULE CALL AND ERROR ROUTINES        *03290026
033000******************************************************************03300026
033100     COPY DPPD000.                                                03310026
033200                                                                  03320026
