       IDENTIFICATION DIVISION.                                         00010000
       PROGRAM-ID.    MAKUT013.                                         00020000
       AUTHOR.        LINDA GRIESBACH.                                  00030000
      ***************************************************************** 00050000
      *    BRIDGE CENTRAL STOCK CLEARANCE ON HAND.                    * 00080000
      *                                                               * 00090000
      *   WR21120 - LINDA GRIESBACH                                   * 00100000
      *             NI SKU                                            * 00110000
      *   WR25478 - LINDA GRIESBACH                                   * 00111099
      *             STORE NBR EXPANSION                               * 00112099
      ***************************************************************** 00120000
       ENVIRONMENT DIVISION.                                            00240000
       INPUT-OUTPUT SECTION.                                            00250000
       FILE-CONTROL.                                                    00260000
           SELECT INV-FILE                                              00360000
               ASSIGN TO INP01.                                         00370000
           SELECT CENTRAL-STK-FILE                                      00371099
               ASSIGN TO INP02.                                         00372099
           SELECT CS-CLR-EXTRACT-FILE                                   00380000
               ASSIGN TO OUT01.                                         00380100
                                                                        00381000
       DATA DIVISION.                                                   00390000
       FILE SECTION.                                                    00400000
       FD  INV-FILE                                                     00560000
           RECORDING MODE IS F                                          00570000
           BLOCK CONTAINS 0 RECORDS.                                    00580000
21120  01  INV-RECORD                      PIC  X(35).                  00590000
                                                                        00591000
       FD  CENTRAL-STK-FILE                                             00592099
           RECORDING MODE IS F                                          00593099
           BLOCK CONTAINS 0 RECORDS.                                    00594099
       01  CENTRAL-STK-RECORD              PIC  X(80).                  00595099
                                                                        00596099
       FD  CS-CLR-EXTRACT-FILE                                          00600000
           RECORDING MODE IS F                                          00600100
           BLOCK CONTAINS 0 RECORDS.                                    00600200
       01  CS-CLR-EXTRACT-RECORD           PIC X(109).                  00600399
                                                                        00601000
       WORKING-STORAGE SECTION.                                         00610000
                                                                        00620000
       01  PV-PROGRAM-VARIABLES.                                        00630000
           05  PV-MSG-TEXT                 PIC X(512).                  00630199
           05  PV-MSG-LENGTH               PIC S9(9)   COMP.            00630299
           05  PV-ABEND-CODE               PIC S9(4)   VALUE +0         00630399
                                                       COMP SYNC.       00630499
           05  PV-SUB                      PIC S9(4)   COMP-3           00630599
                                                       VALUE 0.         00630699
           05  PV-STORE-COUNT              PIC S9(4)   COMP-3.          00630799
           05  PV-ONHAND-QTY               PIC S9(7)   COMP-3.          00632099
           05  PV-CS-CLR-RECS              PIC 9(11)   VALUE ZERO.      00640099
           05  PV-STR-NBR                  PIC X(4)    VALUE ZERO.      00650099
           05  PV-STR-NBR-1                PIC 9(4).                    00660099
           05  PV-STR-NBR-2                PIC S9(4).                   00661099
           05  PV-STR-NBR-3                PIC S9(4)   COMP-3.          00670099
           05  PV-STR-NBR-4                PIC S9(4)   COMP.            00680099
21120      05  PV-WORK-ITEM-NBR            PIC 9(15).                   00721099
21120      05  PV-WORK-DEPT-X              PIC 9(4).                    00721199
21120      05  PV-WORK-SUBCLASS-X          PIC 9(4).                    00721299
21120      05  PV-WORK-SKU-X               PIC 9(8).                    00721399
21120      05  PV-WORK-DEPT-Y.                                          00722000
21120          10  PV-WORK-DEPT-Y-1        PIC X(1).                    00723099
21120          10  PV-WORK-DEPT-Y-2-4      PIC X(3).                    00724099
21120      05  PV-WORK-SUBCLASS-Y.                                      00725000
21120          10  PV-WORK-SUBCLASS-Y-1-2  PIC X(2).                    00726099
21120          10  PV-WORK-SUBCLASS-Y-3-4  PIC X(2).                    00727099
21120      05  PV-WORK-SKU-Y.                                           00728000
21120          10  PV-WORK-SKU-Y-1         PIC X(1).                    00728199
21120          10  PV-WORK-SKU-Y-2-8       PIC X(7).                    00728299
                                                                        00731000
           05  PV-SKU.                                                  00740000
               10  PV-SKU-DEPT             PIC X(3)    VALUE SPACE.     00750099
               10  FILLER                  PIC X(1)    VALUE '-'.       00760099
               10  PV-SKU-CLASS            PIC X(2)    VALUE SPACE.     00770099
               10  FILLER                  PIC X(1)    VALUE '-'.       00780099
21120          10  PV-SKU-NI-SKU           PIC X(8)    VALUE SPACE.     00790099
21120          10  FILLER                  PIC X(5)    VALUE SPACE.     00800099
                                                                        00801000
       01  PV-INV-RECORD.                                               00802000
           05  PV-INV-ITEM-NMBR            PIC S9(15)  COMP-3.          00803099
           05  PV-INV-GROUP-CODE           PIC X(3).                    00807099
           05  PV-INV-LONG-VENDOR-STYLE    PIC X(20).                   00808099
           05  PV-INV-ENT-ID               PIC S9(9)   COMP.            00809099
                                                                        00809199
       01  PV-CS-RECORD.                                                00809299
           05  PV-CS-LOC                   PIC X(4).                    00809399
           05  FILLER                      PIC X(76).                   00809499
                                                                        00810000
       01  PV-STORE-TABLE.                                              00820000
           05  PV-STORE                    OCCURS 50 TIMES.             00821000
               10  PV-STORE-NMBR           PIC X(4).                    00822099
                                                                        00823000
       01  PC-PROGRAM-CONSTANTS.                                        00830000
           05  PC-ECOMMERCE-STORE          PIC X(4)    VALUE '0873'.    00831099
           05  PC-I                        PIC X(1)    VALUE 'I'.       00840099
           05  PC-CURRENT-PROGRAM-NAME     PIC X(10)   VALUE            00860099
                                                       'MAKUT013'.      00870000
           05  PC-ABEND-CODE               PIC S9(4)   COMP SYNC        00880099
                                                       VALUE +4001.     00890000
           05  PC-MAX-SIZE                 PIC S9(9)   COMP             00900099
                                                       VALUE 512.       00901099
                                                                        00910000
       01  PS-PROGRAM-SWITCHES.                                         00920000
21120      05  PS-ITEM-SW                  PIC X(1)    VALUE 'N'.       00990099
21120          88  PS-ITEM-FOUND                       VALUE 'Y'.       01000000
21120          88  PS-ITEM-NOT-FOUND                   VALUE 'N'.       01000100
           05  PS-CS-SW                    PIC X(1)    VALUE 'N'.       01000299
               88  PS-CS-EOF                           VALUE 'Y'.       01000399
               88  PS-CS-NOT-EOF                       VALUE 'N'.       01000499
           05  PS-END-INV-SW               PIC X(1)    VALUE 'N'.       01001099
               88  PS-INV-EOF                          VALUE 'Y'.       01002000
               88  PS-INV-NOT-EOF                      VALUE 'N'.       01003000
           05  PS-WRITE-SW                 PIC X(1)    VALUE 'N'.       01004099
               88  PS-WRITE-RCD                        VALUE 'Y'.       01005000
               88  PS-DO-NOT-WRITE-RCD                 VALUE 'N'.       01006000
                                                                        01010000
      ******************************************************************01180000
      *  RECORD LAYOUT FOR THE SKU STORE INVENTORY EXTRACT FILE.        01190000
      ******************************************************************01200000
           COPY MARD021.                                                01210000
                                                                        01220000
      ******************************************************************01230000
      *    WORK AREA FOR THE ABEND ROUTINE.                             01240000
      ******************************************************************01250000
           COPY DPWS004.                                                01260000
                                                                        01260199
                                                                        01261999
       01  DCLTSKST.                                                    01262099
           10 TSKST-NMBR.                                               01262199
               15 TSKST-ITEM-NMBR          PIC S9(15)V COMP-3.          01262299
               15 TSKST-STORE-NMBR         PIC X(3).                    01262399
           10 TSKST-LAST-SALE-DATE         PIC S9(7)V  COMP-3.          01262499
           10 TSKST-LAST-RCVD-DATE         PIC S9(7)V  COMP-3.          01262599
           10 TSKST-ONHAND-QTY             PIC S9(7)V  COMP-3.          01262699
           10 TSKST-FIRST-RCVD-DATE        PIC S9(7)V  COMP-3.          01262799
           10 TSKST-FIRST-SALE-DATE        PIC S9(7)V  COMP-3.          01262899
           10 TSKST-MDL-STOCK-UNIT-QTY     PIC S9(5)V  COMP-3.          01262999
           10 TSKST-YTD-SALES-UNIT-QTY     PIC S9(7)V  COMP-3.          01263099
           10 TSKST-YTD-SALES-AMT          PIC S9(7)V9(2) COMP-3.       01263199
           10 TSKST-INV-CUTOFF-OH-QTY      PIC S9(9)   COMP.            01263299
           10 TSKST-POST-FL-AFT-REC        PIC S9(9)   COMP.            01263399
           10 TSKST-LOC-NBR                PIC S9(4)   COMP.            01263499
           10 TSKST-LAST-UPD-TMST          PIC X(26).                   01263599
                                                                        01264399
                                                                        01264499
21120      EXEC SQL                                                     01264599
21120          INCLUDE TSKXREF                                          01264699
21120      END-EXEC.                                                    01264799
                                                                        01264899
           EXEC SQL                                                     01265299
               INCLUDE SQLCA                                            01266099
           END-EXEC.                                                    01267099
                                                                        01267199
           COPY SQLCA2.                                                 01268099
                                                                        01270000
                                                                        01522000
       PROCEDURE DIVISION.                                              01530000
       0000-MAINLINE.                                                   01550000
                                                                        01560000
           PERFORM 1000-INTIALIZATION                                   01570000
              THRU 1000-EXIT.                                           01580000
                                                                        01680000
           PERFORM 2000-GET-CS-CLR-DATA                                 01710000
              THRU 2000-EXIT                                            01710100
             UNTIL PS-INV-EOF.                                          01710200
                                                                        01710300
           CLOSE INV-FILE                                               01720000
                 CENTRAL-STK-FILE                                       01721099
                 CS-CLR-EXTRACT-FILE.                                   01730000
                                                                        01760000
           DISPLAY 'EXTRACT RECORDS WRITTEN -- '                        01770000
                   PV-CS-CLR-RECS.                                      01780000
                                                                        01790000
           STOP RUN.                                                    01800000
                                                                        01801000
       0000-MAINLINE-EXIT.                                              01810000
           EXIT.                                                        01820000
                                                                        02710000
                                                                        02720000
       1000-INTIALIZATION.                                              02730000
                                                                        02730100
           OPEN INPUT INV-FILE                                          02731000
                      CENTRAL-STK-FILE                                  02731199
               OUTPUT CS-CLR-EXTRACT-FILE.                              02732000
                                                                        02733000
           PERFORM VARYING PV-SUB FROM 1 BY 1                           02734000
             UNTIL PV-SUB > 50                                          02735000
                 MOVE SPACES TO PV-STORE-NMBR(PV-SUB)                   02735100
           END-PERFORM.                                                 02735200
                                                                        02738799
           MOVE 0 TO PV-SUB.                                            02738899
           PERFORM 1100-LOAD-CENTRAL-STK                                02740099
              THRU 1100-EXIT                                            02740199
             UNTIL PS-CS-EOF.                                           02740999
                                                                        02741099
       1000-EXIT.                                                       02742099
           EXIT.                                                        02750000
                                                                        02760000
                                                                        02770000
       1100-LOAD-CENTRAL-STK.                                           02840099
                                                                        02850000
           READ CENTRAL-STK-FILE INTO PV-CS-RECORD                      02851099
               AT END                                                   02852099
                   MOVE PV-SUB   TO PV-STORE-COUNT                      02852199
                   SET PS-CS-EOF TO TRUE                                02853099
                   GO TO 1100-EXIT                                      02854099
           END-READ.                                                    02854199
                                                                        02854299
           ADD 1 TO PV-SUB.                                             02854399
                                                                        02854499
           MOVE PV-CS-LOC TO PV-STORE-NMBR(PV-SUB).                     02854999
                                                                        02855099
       1100-EXIT.                                                       02860000
           EXIT.                                                        02870000
                                                                        02880000
                                                                        02905000
       2000-GET-CS-CLR-DATA.                                            02910000
                                                                        02971000
           READ INV-FILE INTO PV-INV-RECORD                             02991000
               AT END                                                   02993000
                   SET PS-INV-EOF TO TRUE                               02994000
                   GO TO 2000-EXIT                                      02994100
           END-READ.                                                    02995000
                                                                        03000000
           MOVE 1 TO PV-SUB.                                            03240600
                                                                        03240700
           PERFORM 2100-PROCESS-ITEM-NMBR                               03240800
              THRU 2100-EXIT                                            03240900
             UNTIL PV-SUB > PV-STORE-COUNT.                             03241000
                                                                        03281000
       2000-EXIT.                                                       03282000
           EXIT.                                                        03283000
                                                                        03284000
                                                                        03514000
       2100-PROCESS-ITEM-NMBR.                                          03520400
                                                                        03520900
           PERFORM 2110-SELECT-CS-CLR-DATA                              03521200
              THRU 2110-EXIT.                                           03521300
                                                                        03521400
           IF PS-WRITE-RCD                                              03521500
21120          SET PS-ITEM-NOT-FOUND TO TRUE                            03521600
21120          MOVE PV-INV-ITEM-NMBR TO SKXREF-ITM-NBR                  03521700
21120          PERFORM 3000-SELECT-TSKXREF                              03521800
21120             THRU 3000-EXIT                                        03521900
21120          IF PS-ITEM-FOUND                                         03522000
                   PERFORM 2120-WRITE-CS-CLR-RECORD                     03522100
                      THRU 2120-EXIT                                    03522200
21120          END-IF                                                   03522300
           END-IF.                                                      03522400
                                                                        03522500
           ADD 1 TO PV-SUB.                                             03522600
                                                                        03522700
       2100-EXIT.                                                       03522800
           EXIT.                                                        03522900
                                                                        03523000
                                                                        03523100
       2110-SELECT-CS-CLR-DATA.                                         03523200
                                                                        03523300
           MOVE PV-STORE-NMBR(PV-SUB) TO PV-STR-NBR.                    03523400
           MOVE PV-STR-NBR            TO PV-STR-NBR-1.                  03523599
           MOVE PV-STR-NBR-1          TO PV-STR-NBR-2.                  03523699
           MOVE PV-STR-NBR-2          TO PV-STR-NBR-3.                  03523799
           MOVE PV-STR-NBR-3          TO PV-STR-NBR-4.                  03523899
                                                                        03523900
           EXEC SQL                                                     03524000
               SELECT ONHAND_QTY                                        03524100
                 INTO :PV-ONHAND-QTY                                    03524200
                 FROM TSKST                                             03524399
                WHERE ITEM_NMBR = :PV-INV-ITEM-NMBR                     03524499
                  AND LOC_NBR   = :PV-STR-NBR-4                         03524599
                  AND ONHAND_QTY > 0                                    03524600
           END-EXEC.                                                    03524700
                                                                        03524800
           EVALUATE TRUE                                                03524900
               WHEN SQLCODE = 0                                         03525000
                   SET PS-WRITE-RCD        TO TRUE                      03525100
               WHEN SQLCODE = +100                                      03525299
                   SET PS-DO-NOT-WRITE-RCD TO TRUE                      03525300
               WHEN OTHER                                               03525400
                   DISPLAY '2110-SELECT-CS-CLR-DATA'                    03525599
                   PERFORM 9900-SQL-ABEND                               03525700
           END-EVALUATE.                                                03525800
                                                                        03525900
       2110-EXIT.                                                       03526000
           EXIT.                                                        03526100
                                                                        03527000
                                                                        03528000
       2120-WRITE-CS-CLR-RECORD.                                        03529000
                                                                        03529100
21120      MOVE SKXREF-DEPT         TO  PV-WORK-DEPT-X.                 03529200
21120      MOVE PV-WORK-DEPT-X      TO  PV-WORK-DEPT-Y.                 03529300
21120      MOVE PV-WORK-DEPT-Y-2-4  TO  PV-SKU-DEPT                     03529400
21120                                   MA021-OWNER-DEPT.               03529500
                                                                        03529600
21120      MOVE SKXREF-SUBCLASS     TO  PV-WORK-SUBCLASS-X.             03529700
21120      MOVE PV-WORK-SUBCLASS-X  TO  PV-WORK-SUBCLASS-Y.             03529800
21120      MOVE PV-WORK-SUBCLASS-Y-3-4                                  03529900
21120                               TO  PV-SKU-CLASS.                   03530000
                                                                        03530100
21120 *                                                                 03530200
21120 *        SKXREF-SKU IS DEFINED AS 8 DIGIT NUMERIC -               03530300
21120 *        HOWEVER, IF A 7 DIGIT SKU IS RETRIEVED THE               03530400
21120 *        COBOL CODE PLACES A LEADING ZERO IN SKXREF-SKU.          03530500
21120 *        THIS LEADING ZERO MUST BE REMOVED BEFORE WE              03530600
21120 *        FORMAT THE ITEM-CLUSTR-NAME.                             03530700
21120 *                                                                 03530800
21120      MOVE SKXREF-SKU          TO  PV-WORK-SKU-X.                  03530900
21120      MOVE PV-WORK-SKU-X       TO  PV-WORK-SKU-Y.                  03531000
21120      MOVE SPACES              TO  PV-SKU-NI-SKU.                  03531100
21120      IF PV-WORK-SKU-Y-1 = '0'                                     03531200
21120          MOVE PV-WORK-SKU-Y-2-8 TO  PV-SKU-NI-SKU                 03531300
21120      ELSE                                                         03531400
21120          MOVE PV-WORK-SKU-Y     TO  PV-SKU-NI-SKU                 03531500
21120      END-IF.                                                      03531600
                                                                        03531700
21120      MOVE PV-SKU              TO  MA021-SKU.                      03531800
           MOVE PV-INV-GROUP-CODE   TO  MA021-GROUP-CODE.               03531900
           MOVE PV-INV-LONG-VENDOR-STYLE                                03532000
                                    TO  MA021-LONG-VENDOR-STYLE.        03532100
           MOVE PV-INV-ENT-ID       TO  MA021-ENT-ID.                   03532200
           MOVE PV-STR-NBR          TO  MA021-STORE.                    03532300
           MOVE PV-ONHAND-QTY       TO  MA021-ONHAND-QTY.               03532400
           MOVE ZEROES              TO  MA021-ONORD-QTY.                03532500
           MOVE PC-I                TO  MA021-CLUSTR-CDE.               03532600
           MOVE SPACES              TO  MA021-HIER-CDE.                 03532700
           ADD 1                    TO  PV-CS-CLR-RECS.                 03532800
                                                                        03532900
           WRITE CS-CLR-EXTRACT-RECORD                                  03533000
                     FROM MA021-SKU-STORE-INVENTORY.                    03533100
                                                                        03533200
       2120-EXIT.                                                       03533300
           EXIT.                                                        03533400
                                                                        03533500
                                                                        03534000
21120  3000-SELECT-TSKXREF.                                             04320000
                                                                        04320100
21120      EXEC SQL                                                     04320200
21120          SELECT DEPT,                                             04320300
21120                 SUBCLASS,                                         04320400
21120                 SKU                                               04320500
21120            INTO :SKXREF-DEPT,                                     04320600
21120                 :SKXREF-SUBCLASS,                                 04320700
21120                 :SKXREF-SKU                                       04320800
21120            FROM TSKXREF                                           04320999
21120           WHERE ITM_NBR = :SKXREF-ITM-NBR                         04321000
21120             AND SKU_STAT_CDE NOT IN ('00','98')                   04321100
21120      END-EXEC.                                                    04321200
                                                                        04321300
21120      EVALUATE TRUE                                                04321400
21120          WHEN SQLCODE = ZEROS                                     04321500
21120              SET PS-ITEM-FOUND TO TRUE                            04321600
21120          WHEN SQLCODE = +100                                      04321799
21120              MOVE SKXREF-ITM-NBR TO PV-WORK-ITEM-NBR              04321800
21120              DISPLAY '*******************************'            04321900
21120              DISPLAY 'ITEM NBR NOT FOUND ON TSKXREF'              04322000
21120              DISPLAY 'SKXREF-ITM-NBR: ' PV-WORK-ITEM-NBR          04322100
21120              DISPLAY '*******************************'            04322200
21120          WHEN OTHER                                               04322300
                   DISPLAY '3000-SELECT-TSKXREF'                        04322499
21120              MOVE SKXREF-ITM-NBR TO PV-WORK-ITEM-NBR              04322800
21120              DISPLAY 'SKXREF-ITM-NBR: ' PV-WORK-ITEM-NBR          04322900
21120              PERFORM 9900-SQL-ABEND                               04323000
21120      END-EVALUATE.                                                04323100
                                                                        04323200
21120  3000-EXIT.                                                       04323300
21120      EXIT.                                                        04323400
                                                                        04323500
                                                                        04323600
       9900-SQL-ABEND.                                                  04324000
                                                                        04325099
           MOVE SQLCODE    TO SQLCODE2.                                 04330099
           MOVE SQLERRD(3) TO SQLERRD3.                                 04340099
           DISPLAY '** ABEND **       ** = SQLERROR'.                   04350099
           DISPLAY '** PROGRAM        ** = MAKUT013'.                   04360099
           DISPLAY '** SQLCODE        ** = ' SQLCODE2.                  04361099
           DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                  04362099
           DISPLAY '** SQLERRM        ** = ' SQLERRM.                   04363099
           DISPLAY '** SQLERRMC       ** = ' SQLERRMC.                  04364099
           DISPLAY '** SQLERRD(5)     ** = ' SQLERRD(5).                04365099
                                                                        04365199
           MOVE SPACES TO PV-MSG-TEXT.                                  04366099
                                                                        04366199
      *    GET FULL TEXT OF ERROR MESSAGE                               04366299
                                                                        04366399
           CALL 'SQLGLM' USING PV-MSG-TEXT,                             04366499
                               PC-MAX-SIZE,                             04366599
                               PV-MSG-LENGTH.                           04366699
           DISPLAY 'MESSAGE TEXT      ** = ' PV-MSG-TEXT.               04366799
                                                                        04366899
           CALL 'ILBOABN0' USING PV-ABEND-CODE.                         04367099
                                                                        04450000
