000100***************************************************************** 00010001
000200 IDENTIFICATION DIVISION.                                         00020001
000300***************************************************************** 00030001
000400*                                                                 00040001
000500 PROGRAM-ID.             SUKUP012.                                00050001
000600 AUTHOR.                 TOM BOYD                                 00060001
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070001
000800 DATE-WRITTEN.           JUNE 2002.                               00080001
000900 DATE-COMPILED.                                                   00090001
001000*                                                                 00100001
001100***************************************************************** 00110001
001200* THIS PROGRAM WILL BE USED TO DELETE MULITPLE ENTRIES WITH THE   00120001
001300* SAME TRIP_OCRNC_ID IN TABLES SUT_TRIP_SUM AND SUT_TRIP_DTL_SUM  00130011
001301* LEAVING ONLY THE MOST RECENT ENTRY ON THE TABLE.                00130111
001400***************************************************************** 00140001
001500 ENVIRONMENT DIVISION.                                            00150001
001600***************************************************************** 00160001
001700 CONFIGURATION SECTION.                                           00170001
001800 SOURCE-COMPUTER.                        IBM-3090.                00180001
001900 OBJECT-COMPUTER.                        IBM-3090.                00190001
002000 INPUT-OUTPUT SECTION.                                            00200001
002100 FILE-CONTROL.                                                    00210001
002200                                                                  00220001
002300     SELECT EXTRACT-FILE                                          00230001
002400         ASSIGN TO INP04.                                         00240008
002500/                                                                 00250001
002600***************************************************************** 00260001
002700 DATA DIVISION.                                                   00270001
002800***************************************************************** 00280001
002900 FILE SECTION.                                                    00290001
003000                                                                  00300001
003100 FD  EXTRACT-FILE                                                 00310001
003200     RECORDING MODE IS F                                          00320001
003300     LABEL RECORDS ARE STANDARD                                   00330001
003400     BLOCK CONTAINS 0 RECORDS.                                    00340001
003500 01  EXTRACT-RECORD                   PIC X(50).                  00350001
003600/                                                                 00360001
003700***************************************************************** 00370001
003800 WORKING-STORAGE SECTION.                                         00380001
003900***************************************************************** 00390001
004000                                                                  00400001
004100 01  PS-SWITCHES.                                                 00410001
004200     05  PS-END-OF-INPUT-FILE-SW      PIC X(01) VALUE 'N'.        00420001
004300         88  PS-END-OF-INPUT                    VALUE 'Y'.        00430001
004400         88  PS-NOT-END-OF-INPUT                VALUE 'N'.        00440001
004500                                                                  00450001
004600 01  PV-VARIABLES.                                                00460001
004700     05  PV-READ-COUNT                PIC S9(7) COMP-3            00470001
004800                                                VALUE ZERO.       00480001
004900     05  PV-REC-READ-QTY              PIC S9(7) COMP-3            00490001
005000                                                VALUE ZERO.       00500001
005100     05  PV-WRITE-COUNT               PIC S9(7) COMP-3            00510001
005200                                                VALUE ZERO.       00520001
005300     05  PV-PAGE-COUNT                PIC S9(3) COMP-3            00530001
005400                                                VALUE ZERO.       00540001
005500     05  PV-LINE-COUNT                PIC S9(04) VALUE ZERO       00550001
005600                                                 COMP SYNC.       00560001
005700     05  PV-DB2-FUNCTION              PIC X(30) VALUE SPACES.     00570001
005800     05  PV-PARAGRAPH                 PIC X(30) VALUE SPACES.     00580001
005900     05  PV-DISP-NUMBER               PIC Z,ZZZ,ZZ9.              00590001
006000                                                                  00600001
006100     05  PV-RUN-DATE                  PIC X(10) VALUE SPACES.     00610001
006200     05  PV-SAVE-START-DATE           PIC X(10) VALUE SPACES.     00620001
006300     05  PV-ERROR-MESSAGE-1           PIC X(60)  VALUE SPACES.    00630001
006400     05  PV-ERROR-MESSAGE-2           PIC X(60)  VALUE SPACES.    00640001
006500     05  PV-DB2-YEAR                  PIC S9(08) COMP             00650001
006600                                          VALUE ZERO.             00660001
006700     05  PV-DB2-MONTH                 PIC S9(08) COMP             00670001
006800                                          VALUE ZERO.             00680001
006900     05  PV-DB2-DAY                   PIC S9(08) COMP             00690001
007000                                          VALUE ZERO.             00700001
007100     05  PV-DB2-HOUR                  PIC S9(08) COMP             00710001
007200                                          VALUE ZERO.             00720001
007300     05  PV-DB2-MINUTE                PIC S9(08) COMP             00730001
007400                                          VALUE ZERO.             00740001
007500     05  PV-DB2-SECOND                PIC S9(08) COMP             00750001
007600                                          VALUE ZERO.             00760001
007700                                                                  00770001
007800     05  PV-DISPLAY-COUNT             PIC ZZZ,ZZZ,ZZ9.            00780001
007900     05  PV-COMMIT-COUNT              PIC S9(09)    VALUE +0      00790001
008000                                                   COMP SYNC.     00800001
008300     05  PV-COMMIT-COUNTER            PIC 9(03)     VALUE ZERO.   00830001
008310                                                                  00831011
008400     05  PV-DELETE-SUT00007           PIC S9(09)    VALUE ZERO    00840011
008500                                                   COMP SYNC.     00850001
008501     05  PV-NOT-FOUND-SUT00007        PIC S9(09)    VALUE +0      00850111
008502                                                   COMP SYNC.     00850211
008510     05  PV-DELETE-SUT00095           PIC S9(09)    VALUE ZERO    00851011
008520                                                   COMP SYNC.     00852011
008530     05  PV-NOT-FOUND-SUT00095        PIC S9(09)    VALUE +0      00853011
008540                                                   COMP SYNC.     00854011
008600                                                                  00860001
008700******************************************************************00870001
008800 01  PV-ABEND-FIELDS.                                             00880001
008900     05  PV-ABEND-CODE                PIC S9(04) VALUE +0         00890001
009000                                                 COMP SYNC.       00900001
009100     05  PV-ABEND-PROGRAM             PIC  X(08) VALUE 'SUKUP012'.00910001
009200     05  PV-ABEND-PARAGRAPH           PIC  X(50) VALUE SPACES.    00920001
009300     05  PV-ABEND-OPERATION           PIC  X(51) VALUE SPACES.    00930001
009400     05  PV-ABEND-STRUCTURE-1         PIC X(8)   VALUE SPACES.    00940001
009500     05  PV-ABEND-STRUCTURE-2         PIC X(8)   VALUE SPACES.    00950001
009600     05  PV-ABEND-STRUCTURE-3         PIC X(8)   VALUE SPACES.    00960001
009700     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    00970001
009800     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    00980001
009900     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    00990001
010000/                                                                 01000001
010100 01  PC-CONSTANTS.                                                01010001
010200     05  PC-CURRENT-PROGRAM-NAME      PIC X(08) VALUE 'SUKUP012'. 01020001
010300     05  PC-ROW-NOT-FOUND             PIC S9(04)    VALUE +100    01030001
010400                                                   COMP SYNC.     01040001
010500     05  PC-COMMIT-HOLD               PIC 9(3)      VALUE 200.    01050001
010600/                                                                 01060001
010700******************************************************************01070001
010800*  COPYBOOK FOR UPLOAD TRANSACTION CODES AND ERROR CODES.         01080001
010900******************************************************************01090001
011000     COPY PCWS208.                                                01100001
011100*                                                                 01110001
011200******************************************************************01120001
011300*  COPYBOOK USED BY MBS SYSTEM                                    01130001
011400******************************************************************01140001
011500     COPY DPWS003.                                                01150001
011600*                                                                 01160001
011700******************************************************************01170001
011800*  WORKING STORAGE AREA FOR NAME REFORMAT DPPD024                 01180001
011900******************************************************************01190001
012000     COPY DPWS024.                                                01200011
012100/                                                                 01210001
012200******************************************************************01220001
012300*  DB2 FORMATTED MESSAGE AREA                                     01230001
012400******************************************************************01240001
012500     COPY DPWS004.                                                01250001
012600/                                                                 01260001
012700******************************************************************01270001
012800* CORPORATE DATE ROUTINES                                         01280001
012900******************************************************************01290001
013000     COPY DPWS500.                                                01300001
013100/                                                                 01310001
013200******************************************************************01320001
013300*   DB2 SQL COMMUNICATION AREA                                    01330001
013400******************************************************************01340001
013500     EXEC SQL                                                     01350001
013600         INCLUDE SQLCA                                            01360001
013700     END-EXEC.                                                    01370001
013800*                                                                 01380001
013900     COPY SQLCA2.                                                 01390001
014000*                                                                 01400001
014100******************************************************************01410001
014200*   UPLOAD ERROR TABLE                                            01420001
014300******************************************************************01430001
014400*                                                                 01440001
014500     EXEC SQL                                                     01450001
014600         INCLUDE SUT00007                                         01460004
014700     END-EXEC.                                                    01470001
014800*                                                                 01480001
014810******************************************************************01481011
014820*   TRIP DETAIL SUM TABLE (SUT_TRIP_DTL_SUM)                      01482011
014830******************************************************************01483011
014840*                                                                 01484011
014850     EXEC SQL                                                     01485011
014860         INCLUDE SUT00095                                         01486011
014870     END-EXEC.                                                    01487011
014880*                                                                 01488011
014900******************************************************************01490001
015000 PROCEDURE DIVISION.                                              01500001
015100******************************************************************01510001
015200 0000-MAINLINE.                                                   01520001
015300                                                                  01530001
015400     PERFORM 1000-INITIALIZE.                                     01540001
015500                                                                  01550001
015600     PERFORM 2000-PROCESS-EXTRACT                                 01560001
015700         UNTIL PS-END-OF-INPUT.                                   01570001
015800                                                                  01580001
015900     PERFORM 9000-EOJ.                                            01590001
016000                                                                  01600001
016100      GOBACK.                                                     01610001
016200                                                                  01620001
016300******************************************************************01630001
016400*  INITIALIZATION TASKS.                                          01640001
016500*    -- OPEN INPUT FILE                                           01650001
016600*    -- READ FILE                                                 01660001
016700******************************************************************01670001
016800 1000-INITIALIZE.                                                 01680001
016900                                                                  01690001
017000     OPEN INPUT  EXTRACT-FILE.                                    01700001
017100                                                                  01710001
017200     PERFORM 2100-READ-EXTRACT.                                   01720001
017300/                                                                 01730001
017400******************************************************************01740001
017500 2000-PROCESS-EXTRACT.                                            01750001
017600******************************************************************01760001
017700*                                                                 01770001
017800     PERFORM 8000-DELETE-MULTIPLES                                01780001
017900     PERFORM 8100-DELETE-TRIP-DTL                                 01790011
018000                                                                  01800001
018200     PERFORM 2200-COMMIT-DELETE                                   01820001
018400                                                                  01840001
018500     PERFORM 2100-READ-EXTRACT.                                   01850001
018600*                                                                 01860001
018700******************************************************************01870001
018800*  READ NEXT INPUT FILE RECORD.                                   01880001
018900******************************************************************01890001
019000 2100-READ-EXTRACT.                                               01900001
019100                                                                  01910001
019200     READ EXTRACT-FILE INTO DCLSUT00007                           01920001
019300        AT END                                                    01930001
019400           SET PS-END-OF-INPUT TO TRUE                            01940001
019600        NOT AT END                                                01960001
019700           ADD +1                   TO PV-READ-COUNT              01970001
019800     END-READ.                                                    01980001
019900*                                                                 01990001
020000******************************************************************02000001
020100* COMMIT THE DELETE FROM ERROR TABLE                              02010001
020200******************************************************************02020001
020300 2200-COMMIT-DELETE.                                              02030001
020400                                                                  02040001
020500      EXEC SQL                                                    02050001
020600         COMMIT                                                   02060001
020700      END-EXEC                                                    02070001
020800                                                                  02080001
020900      ADD +1                          TO PV-COMMIT-COUNT          02090001
021000      MOVE +0 TO PV-COMMIT-COUNTER.                               02100001
021100                                                                  02110001
021200*                                                                 02120001
021300******************************************************************02130001
021400* DELETE THE ROWS FROM THE SUT_TRIP_ID TABLE LEAVING ONLY THE     02140011
021410* MOST RECENT OCCURANCE OF OTBND_TRIP_ID                          02141001
021500******************************************************************02150001
021600 8000-DELETE-MULTIPLES.                                           02160001
021700                                                                  02170001
021800     EXEC SQL                                                     02180001
021900         DELETE                                                   02190001
022000             FROM  SUT_TRIP_SUM                                   02200005
022100             WHERE TRIP_OCRNC_ID   = :SUT00007-TRIP-OCRNC-ID      02210001
022700     END-EXEC.                                                    02270001
022800                                                                  02280001
022900     EVALUATE TRUE                                                02290001
023000         WHEN SQLCODE = 0                                         02300001
023100             ADD +1           TO PV-DELETE-SUT00007               02310011
023200         WHEN SQLCODE = +100                                      02320001
023300             ADD +1           TO PV-NOT-FOUND-SUT00007            02330011
023400         WHEN SQLCODE < 0                                         02340001
023500         WHEN SQLCODE > 0                                         02350001
023600         WHEN SQLWARN0 = 'W'                                      02360001
023700             MOVE '8000-DELETE-MULTIPLES'                         02370001
023800                         TO PV-PARAGRAPH                          02380001
023900             MOVE 'DELETE OF SUT00007'                            02390009
024000                         TO PV-DB2-FUNCTION                       02400001
024100             PERFORM 9200-SQL-ABEND                               02410001
024200     END-EVALUATE.                                                02420001
024300/                                                                 02430001
024310******************************************************************02431011
024320* DELETE THE ROWS FROM THE SUM_TRIP_DTL_SUM TABLE LEAVING ONLY THE02432011
024330* MOST RECENT OCCURANCE OF OTBND_TRIP_ID                          02433011
024340******************************************************************02434011
024350 8100-DELETE-TRIP-DTL.                                            02435011
024360                                                                  02436011
024361     MOVE SUT00007-TRIP-OCRNC-ID   TO SUT00095-TRIP-OCRNC-ID.     02436111
024362                                                                  02436211
024370     EXEC SQL                                                     02437011
024380         DELETE                                                   02438011
024390             FROM  SUT_TRIP_DTL_SUM                               02439011
024391             WHERE TRIP_OCRNC_ID   = :SUT00095-TRIP-OCRNC-ID      02439111
024399     END-EXEC.                                                    02439911
024400                                                                  02440011
024401     EVALUATE TRUE                                                02440111
024402         WHEN SQLCODE = 0                                         02440211
024403             ADD +1           TO PV-DELETE-SUT00095               02440311
024404         WHEN SQLCODE = +100                                      02440411
024405             ADD +1           TO PV-NOT-FOUND-SUT00095            02440511
024406         WHEN SQLCODE < 0                                         02440611
024407         WHEN SQLCODE > 0                                         02440711
024408         WHEN SQLWARN0 = 'W'                                      02440811
024409             MOVE '8100-DELETE-TRIP-DTL'                          02440911
024410                         TO PV-PARAGRAPH                          02441011
024411             MOVE 'DELETE OF SUT00095'                            02441111
024412                         TO PV-DB2-FUNCTION                       02441211
024413             PERFORM 9200-SQL-ABEND                               02441311
024414     END-EVALUATE.                                                02441411
024415/                                                                 02441511
024420******************************************************************02442001
024500*CLOSE INPUT FILE.                                                02450001
024600******************************************************************02460001
024700 9000-EOJ.                                                        02470001
024800*                                                                 02480001
024900     CLOSE EXTRACT-FILE.                                          02490001
025000                                                                  02500001
025100     MOVE PV-DELETE-SUT00007  TO PV-DISPLAY-COUNT.                02510011
025200     DISPLAY 'TOTAL SUT_TRIP_SUM DELETED   ' PV-DISPLAY-COUNT.    02520012
025300     MOVE PV-NOT-FOUND-SUT00007 TO PV-DISPLAY-COUNT.              02530011
025400     DISPLAY 'TOTAL SUT_TRIP_SUM NOT FOUND ' PV-DISPLAY-COUNT.    02540012
025401                                                                  02540111
025410     MOVE PV-DELETE-SUT00095  TO PV-DISPLAY-COUNT.                02541011
025420     DISPLAY 'TOTAL SUT_TRIP_DTL_SUM DELETED   ' PV-DISPLAY-COUNT.02542011
025430     MOVE PV-NOT-FOUND-SUT00095 TO PV-DISPLAY-COUNT.              02543011
025440     DISPLAY 'TOTAL SUT_TRIP_DTL_SUM NOT FOUND ' PV-DISPLAY-COUNT.02544011
025450                                                                  02545011
025500     MOVE PV-COMMIT-COUNT  TO PV-DISPLAY-COUNT.                   02550001
025600     DISPLAY 'TOTAL COMMITS TAKEN              ' PV-DISPLAY-COUNT.02560001
025700/                                                                 02570001
025800******************************************************************02580001
025900 9200-SQL-ABEND.                                                  02590001
026000******************************************************************02600001
026100                                                                  02610001
026200     MOVE SQLCODE                     TO SQLCODE2.                02620001
026300     MOVE SQLERRD(3)                  TO SQLERRD3.                02630001
026400                                                                  02640001
026500     DISPLAY '** ABEND **         ** = SQLERROR'.                 02650001
026600     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        02660001
026700     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH.                   02670001
026800     DISPLAY '** OPERATION ** = ' PV-DB2-FUNCTION.                02680001
026900     DISPLAY '*** MESSAGE     = ' PV-DB2-OPERATION-MESSAGE-1.     02690001
027000     DISPLAY '***             = ' PV-DB2-OPERATION-MESSAGE-2.     02700001
027100     DISPLAY '***             = ' PV-DB2-OPERATION-MESSAGE-3.     02710001
027200                                                                  02720001
027300     DISPLAY '** SQLCODE          ** = ' SQLCODE2.                02730001
027400     DISPLAY '** ROWS PROCESSED   ** = ' SQLERRD3.                02740001
027500     DISPLAY '** SQLERRM          ** = ' SQLERRM.                 02750001
027600     DISPLAY '** SQLERRMC         ** = ' SQLERRMC.                02760001
027700                                                                  02770001
027800                                                                  02780001
027900     MOVE +4013                       TO PV-ABEND-CODE.           02790001
028000     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         02800001
028100                                                                  02810001
