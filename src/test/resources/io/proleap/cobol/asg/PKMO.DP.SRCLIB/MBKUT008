000100*************************                                         00010009
000200 IDENTIFICATION DIVISION.                                         00020009
000300*************************                                         00030009
000400 PROGRAM-ID.    MBKUT008.                                         00040009
000500 AUTHOR.        MIKE FURLICK.                                     00050009
000600 DATE-WRITTEN.  MARCH, 1992.                                      00060009
000700*                                                                 00070009
000800***************************************************************** 00080009
000900*         MBS DATE CHANGE PROCESS.                              * 00090009
001000*                                                               * 00100009
001100*    THIS PROGRAM PROCESSES THE 'MBKUT008' RECORD TYPES FROM    * 00110009
001200*    THE VSAM BATCH CONTROL DATASET.                            * 00120009
001300*                                                               * 00130009
001400*    FOR EACH BATCH CONTROL RECORD, VALIDATE THE RECORD'S       * 00140009
001500*    CONTENTS.  IF OK, BEGIN THE DATE CHANGES.  THERE ARE       * 00150009
001600*    THREE TABLES THAT ARE AFFECTED: TMDSEAR, TAPLAVL, AND      * 00160009
001700*    TRSPBAR.  THERE ARE NO INSERTS PERFORMED.  PRIMARILY,      * 00170009
001800*    ROW WILL BE UPDATED.  THERE ARE CASES, HOWEVER, WHERE      * 00180009
001900*    A ROW MAY BE DELETED (ITS START DATE IS BEYOND THE NEW     * 00190009
002000*    END DATE, THEREFORE, IT WAS AND NEVER WILL BE ACTIVE).     * 00200009
002100*                                                               * 00210009
002200***************************************************************** 00220009
002300*    06/16/98  DOUG DOUGLAS   STRATAGEM     WR#: 6041           * 00230009
002400*              - UPGRADE FOR Y2K                                * 00240009
002500*              - REPLACE ++INCLUDES WITH COPY'S (STANDARDS)     * 00250009
002600***************************************************************** 00260009
002700*                                                                 00270009
002800 ENVIRONMENT DIVISION.                                            00280009
002900 CONFIGURATION SECTION.                                           00290009
003000 SOURCE-COMPUTER. IBM-3090.                                       00300009
003100 OBJECT-COMPUTER. IBM-3090.                                       00310009
003200                                                                  00320009
003300 INPUT-OUTPUT SECTION.                                            00330009
003400 FILE-CONTROL.                                                    00340009
003500                                                                  00350009
003600     SELECT BATCH-CONTROL-FILE                                    00360009
003700         ORGANIZATION IS INDEXED                                  00370009
003800         RECORD KEY IS BCR-KEY                                    00380009
003900         FILE STATUS IS PV-VSAM-STATUS                            00390009
004000         ACCESS IS SEQUENTIAL                                     00400009
004100         ASSIGN TO INP01.                                         00410009
004200                                                                  00420009
004300 DATA DIVISION.                                                   00430009
004400 FILE SECTION.                                                    00440009
004500*                                                                 00450009
004600*                                                                 00460009
004700 FD  BATCH-CONTROL-FILE.                                          00470009
004800                                                                  00480009
004900 01  BATCH-CONTROL-RECORD.                                        00490009
005000     05  BCR-KEY               PIC X(30).                         00500009
005100     05  BCR-DATA              PIC X(70).                         00510009
005200                                                                  00520009
005300 EJECT                                                            00530009
005400 WORKING-STORAGE SECTION.                                         00540009
005500                                                                  00550009
005600 01  PC-PROGRAM-CONSTANTS.                                        00560009
005700     05  PC-MAX-RETRIES            PIC S9(3)  VALUE +3            00570009
005800                                              COMP-3.             00580009
005900     05  PC-NINES                  PIC 9(03)  VALUE 999.          00590009
006000     05  PC-CO                     PIC X(03)  VALUE 'CO '.        00600009
006100     05  PC-GMA                    PIC X(03)  VALUE 'GMA'.        00610009
006200     05  PC-DMA                    PIC X(03)  VALUE 'DMA'.        00620009
006300     05  PC-DPT                    PIC X(03)  VALUE 'DPT'.        00630009
006400     05  PC-MCL                    PIC X(03)  VALUE 'MCL'.        00640009
006500     05  PC-SCL                    PIC X(03)  VALUE 'SCL'.        00650009
006600     05  PC-COMPANY                PIC X(02)  VALUE '03'.         00660009
006700                                                                  00670009
006800 01  PS-PROGRAM-SWITCHES.                                         00680009
006900     05  PS-CONTINUE-SW            PIC X      VALUE 'Y'.          00690009
007000         88  PS-CONTINUE                      VALUE 'Y'.          00700009
007100         88  PS-DONT-PROCESS                  VALUE 'N'.          00710009
007200     05  PS-DATE-SW                PIC X      VALUE 'N'.          00720009
007300         88  PS-VALID-DATE                    VALUE 'Y'.          00730009
007400         88  PS-INVALID-DATE                  VALUE 'N'.          00740009
007500                                                                  00750009
007600 01  PV-PROGRAM-VARIABLES.                                        00760009
007700     05  PV-DB2-COUNT              PIC S9(9)  VALUE ZERO          00770009
007800                                              COMP-3.             00780009
007900     05  PV-DELETE-COUNT           PIC S9(9)  VALUE ZERO          00790009
008000                                              COMP-3.             00800009
008100     05  PV-UPDATE-COUNT           PIC S9(9)  VALUE ZERO          00810009
008200                                              COMP-3.             00820009
008300     05  PV-UPDATE-APLAVL-COUNT    PIC S9(9)  VALUE ZERO          00830009
008400                                              COMP-3.             00840009
008500     05  PV-DELETE-APLAVL-COUNT    PIC S9(9)  VALUE ZERO          00850009
008600                                              COMP-3.             00860009
008700     05  PV-UPDATE-RSPBAR-COUNT    PIC S9(9)  VALUE ZERO          00870009
008800                                              COMP-3.             00880009
008900     05  PV-DELETE-RSPBAR-COUNT    PIC S9(9)  VALUE ZERO          00890009
009000                                              COMP-3.             00900009
009100     05  PV-BATCH-CNTL-COUNT       PIC S9(9)  VALUE ZERO          00910009
009200                                              COMP-3.             00920009
009300     05  PV-TOT-DELETES            PIC S9(9)  VALUE ZERO          00930009
009400                                              COMP-3.             00940009
009500     05  PV-TOT-UPDATES            PIC S9(9)  VALUE ZERO          00950009
009600                                              COMP-3.             00960009
009700     05  PV-TOT-APLAVLS-UPDATED    PIC S9(9)  VALUE ZERO          00970009
009800                                              COMP-3.             00980009
009900     05  PV-TOT-APLAVLS-DELETED    PIC S9(9)  VALUE ZERO          00990009
010000                                              COMP-3.             01000009
010100     05  PV-TOT-APLAVLS            PIC S9(9)  VALUE ZERO          01010009
010200                                              COMP-3.             01020009
010300     05  PV-TOT-RSPBARS-UPDATED    PIC S9(9)  VALUE ZERO          01030009
010400                                              COMP-3.             01040009
010500     05  PV-TOT-RSPBARS-DELETED    PIC S9(9)  VALUE ZERO          01050009
010600                                              COMP-3.             01060009
010700     05  PV-TOT-RSPBARS            PIC S9(9)  VALUE ZERO          01070009
010800                                              COMP-3.             01080009
010900     05  PV-TOT-MDSEDPS            PIC S9(9)  VALUE ZERO          01090009
011000                                              COMP-3.             01100009
011100     05  PV-TOT-MDSECLS            PIC S9(9)  VALUE ZERO          01110009
011200                                              COMP-3.             01120009
011300                                                                  01130009
011400     05  PV-PARAGRAPH-NAME         PIC X(30)  VALUE SPACE.        01140009
011500     05  PV-DB2-OPER-ATTEMPTED     PIC X(30)  VALUE SPACE.        01150009
011600     05  PV-SQL-SUB                PIC S9(4)  VALUE ZERO          01160009
011700                                              COMP.               01170009
011800     05  PV-VSAM-STATUS            PIC XX     VALUE SPACE.        01180009
011900         88  PV-GOOD-STATUS                   VALUE '00'.         01190009
012000         88  PV-AT-END                        VALUE '10'.         01200009
012100         88  PV-NO-RECORDS                    VALUE '23'.         01210009
012200         88  PV-VERIFIED                      VALUE '97'.         01220009
012300                                                                  01230009
012400     05  PV-LIST-SEQ-NBR           PIC S9(15) VALUE ZERO          01240009
012500                                              COMP-3.             01250009
012600     05  PV-MAX-SEQ-NBR            PIC S9(15) VALUE ZERO          01260009
012700                                              COMP-3.             01270009
012800     05  PV-WORK-SEQ-NBR           PIC S9(15) VALUE ZERO.         01280009
012900     05  FILLER  REDEFINES  PV-WORK-SEQ-NBR.                      01290009
013000         10  PV-WS-OPERCO          PIC 99.                        01300009
013100         10  PV-CONTROL-DATA.                                     01310009
013200             15  PV-WS-GMA         PIC 99.                        01320009
013300             15  PV-WS-DMA         PIC 99.                        01330009
013400             15  PV-WS-DEPT        PIC 999.                       01340009
013500             15  PV-WS-MAJ-CL      PIC 99.                        01350009
013600             15  PV-WS-SUB-CL      PIC 999.                       01360009
013700         10  PV-WS-ZERO            PIC 9.                         01370009
013800                                                                  01380009
013900     05  PV-REQUEST-LEVEL          PIC X(3)   VALUE SPACES.       01390009
014000         88  PV-REQUEST-GMA                   VALUE 'GMA'.        01400009
014100         88  PV-REQUEST-DMA                   VALUE 'DMA'.        01410009
014200         88  PV-REQUEST-DPT                   VALUE 'DPT'.        01420009
014300         88  PV-REQUEST-MCL                   VALUE 'MCL'.        01430009
014400         88  PV-REQUEST-SCL                   VALUE 'SCL'.        01440009
014500     05  PV-LEVEL                  PIC X(3)   VALUE SPACES.       01450009
014600         88  PV-CO-LIT                        VALUE 'CO '.        01460009
014700         88  PV-GMA-LIT                       VALUE 'GMA'.        01470009
014800         88  PV-DMA-LIT                       VALUE 'DMA'.        01480009
014900         88  PV-DPT-LIT                       VALUE 'DPT'.        01490009
015000         88  PV-MCL-LIT                       VALUE 'MCL'.        01500009
015100                                                                  01510009
015200     05  PV-LAST-LEVEL             PIC X(3)   VALUE SPACES.       01520009
015300     05  PV-LAST-CO-DKEY           PIC S9(6)  VALUE ZERO          01530009
015400                                              COMP-3.             01540009
015500     05  PV-LAST-GMA-DKEY          PIC S9(6)  VALUE ZERO          01550009
015600                                              COMP-3.             01560009
015700     05  PV-LAST-DMA-DKEY          PIC S9(6)  VALUE ZERO          01570009
015800                                              COMP-3.             01580009
015900     05  PV-LAST-DPT-DKEY          PIC S9(6)  VALUE ZERO          01590009
016000                                              COMP-3.             01600009
016100     05  PV-LAST-MCL-DKEY          PIC S9(6)  VALUE ZERO          01610009
016200                                              COMP-3.             01620009
016300     05  PV-APLAVL-DKEY            PIC S9(6)  VALUE ZERO          01630009
016400                                              COMP-3.             01640009
016500     05  PV-APLAVL-START-DATE      PIC X(10).                     01650009
016600     05  PV-APLAVL-END-DATE        PIC X(10).                     01660009
016700                                                                  01670009
016800     05  PV-PARENT-DKEY            PIC S9(15) VALUE ZERO          01680009
016900                                              COMP-3.             01690009
017000                                                                  01700009
017100     05  PV-ORIG-START-DATE        PIC X(10).                     01710009
017200     05  PV-ORIG-END-DATE          PIC X(10).                     01720009
017300     05  PV-PARENT-START-DATE      PIC X(10).                     01730012
017400     05  PV-PARENT-END-DATE        PIC X(10).                     01740012
017500     05  PV-CURRENT-DATE.                                         01750009
017600         10  PV-CD-YY              PIC 99.                        01760009
017700         10  PV-CD-MM              PIC XX.                        01770009
017800         10  PV-CD-DD              PIC XX.                        01780009
017900     05  PV-DB2-WORK-DATE.                                        01790009
018000         10  PV-WD-CCYY            PIC 9(4).                      01800009
018100         10  FILLER  REDEFINES  PV-WD-CCYY.                       01810009
018200             15  PV-WD-CC          PIC XX.                        01820009
018300             15  PV-WD-YY          PIC XX.                        01830009
018400         10  FILLER                PIC X.                         01840009
018500         10  PV-WD-MM              PIC XX.                        01850009
018600         10  FILLER                PIC X.                         01860009
018700         10  PV-WD-DD              PIC XX.                        01870009
018800                                                                  01880009
019000 01  PV-NEW-START-DATE             PIC X(10).                     01900009
019100 01  PV-NEW-END-DATE               PIC X(10).                     01910009
019200                                                                  01920009
019300 01  PV-DB2-CHANGE-DATE            PIC X(10).                     01930009
019400*                                                                 01940009
019500 01  ABEND-CODE                    PIC S9(4)  VALUE ZERO          01950009
019600                                              COMP.               01960009
019700     88  ABEND-4001                           VALUE 4001.         01970009
019800     88  ABEND-4002                           VALUE 4002.         01980009
019900     88  ABEND-4003                           VALUE 4003.         01990009
020000     88  ABEND-4004                           VALUE 4004.         02000009
020100     88  ABEND-4005                           VALUE 4005.         02010009
020200     88  ABEND-4006                           VALUE 4006.         02020009
020300     88  ABEND-4013                           VALUE 4013.         02030009
020400     EJECT                                                        02040009
020500*                                                                 02050009
020600*    RECORD LAYOUT FOR THE BATCH CONTROL FILE                     02060009
020700*                                                                 02070009
020800     COPY MBWS018.                                                02080009
020900*                                                                 02090009
021000*    WORKING STORAGE FOR THE DATE VALIDATION ROUTINE              02100009
021100*                                                                 02110009
021200     COPY DPWS500.                                                02120009
021300*                                                                 02130009
021400*    MDSEAR DCLGEN                                                02140009
021500*                                                                 02150009
021600     EXEC SQL                                                     02160009
021700         INCLUDE TMDSEAR                                          02170009
021800     END-EXEC.                                                    02180009
021900*                                                                 02190009
022000*    APLAVL DCLGEN                                                02200009
022100*                                                                 02210009
022200     EXEC SQL                                                     02220009
022300         INCLUDE TAPLAVL                                          02230009
022400     END-EXEC.                                                    02240009
022500*                                                                 02250009
022600*    RSPBAR DCLGEN                                                02260009
022700*                                                                 02270009
022800     EXEC SQL                                                     02280009
022900         INCLUDE TRSPBAR                                          02290009
023000     END-EXEC.                                                    02300009
023100*                                                                 02310009
023200*    SQL COMMUNICATIONS AREA DCLGEN                               02320009
023300*                                                                 02330009
023400     EXEC SQL                                                     02340009
023500         INCLUDE SQLCA                                            02350009
023600     END-EXEC.                                                    02360009
023700*                                                                 02370009
023800*    ERROR MESSAGE AREA FOR DB2                                   02380009
023900*                                                                 02390009
024000     COPY DPWS004.                                                02400009
024100*                                                                 02410009
024200*    MDSEAR LIST CURSOR.                                          02420009
024300*                                                                 02430009
024400     EXEC SQL                                                     02440009
024500         DECLARE MDSEAR-LIST CURSOR                               02450009
024600             FOR SELECT                                           02460009
024700                         MDSELV_CDE                               02470009
024800                      ,  MDSEAR_DKEY                              02480009
024900                      ,  CHG_DTE                                  02490009
025000                      ,  STRT_DTE                                 02500009
025100                      ,  END_DTE                                  02510009
025200                      ,  LIST_SEQ_NBR                             02520009
025300         FROM                                                     02530009
025400              TMDSEAR                                             02540009
025500            WHERE                                                 02550009
025600                      (OPERCO_NBR   =  :MB018-OPERATING-CO-008    02560009
025700              AND     (LIST_SEQ_NBR                               02570009
025800                         BETWEEN       :PV-LIST-SEQ-NBR           02580009
025900                         AND           :PV-MAX-SEQ-NBR)           02590009
026000              AND      END_DTE      >  (CURRENT DATE))            02600009
026100         ORDER BY                                                 02610009
026200                       LIST_SEQ_NBR                               02620009
026300     END-EXEC.                                                    02630009
026400*                                                                 02640009
026500*    APLAVL LIST CURSOR.                                          02650009
026600*                                                                 02660009
026700     EXEC SQL                                                     02670009
026800         DECLARE APLAVL-LIST CURSOR                               02680009
026900             FOR SELECT                                           02690009
027000                         MDSEAR_STRT_DTE                          02700009
027100                      ,  MDSEAR_END_DTE                           02710009
027200         FROM                                                     02720009
027300              TAPLAVL                                             02730009
027400            WHERE                                                 02740009
027500                     (OPERCO_NBR     = :MB018-OPERATING-CO-008    02750009
027600              AND     MDSEAR_DKEY    = :MDSEAR-DKEY               02760009
027700              AND     MDSEAR_END_DTE > (CURRENT DATE))            02770009
027800         FOR UPDATE OF                                            02780009
027900                      MDSEAR_STRT_DTE                             02790009
028000                    , MDSEAR_END_DTE                              02800009
028100     END-EXEC.                                                    02810009
028200*                                                                 02820009
028300*    RSPBAR LIST CURSOR.                                          02830009
028400*                                                                 02840009
028500     EXEC SQL                                                     02850009
028600         DECLARE RSPBAR-LIST CURSOR                               02860009
028700             FOR SELECT                                           02870009
028800                         MDSEAR_DKEY                              02880009
028900                      ,  WORKER_NBR                               02890009
029000                      ,  RSPLVL_CDE                               02900009
029100                      ,  WORKER_STRT_DTE                          02910009
029200                      ,  WORKER_END_DTE                           02920009
029300                      ,  WORKER_FIR_NAME                          02930009
029400                      ,  WORKER_LAST_NAME                         02940009
029500                      ,  OPERCO_NBR                               02950009
029600         FROM                                                     02960009
029700              TRSPBAR                                             02970009
029800            WHERE                                                 02980009
029900                     (OPERCO_NBR     = :MB018-OPERATING-CO-008    02990009
030000              AND     MDSEAR_DKEY    = :MDSEAR-DKEY               03000009
030100              AND     WORKER_END_DTE > (CURRENT DATE))            03010009
030200     END-EXEC.                                                    03020009
030300*                                                                 03030009
030400 EJECT                                                            03040009
030500 PROCEDURE DIVISION.                                              03050009
030600                                                                  03060009
030700     PERFORM 1000-MAINLINE.                                       03070009
030800     GOBACK.                                                      03080009
030900 1000-MAINLINE.                                                   03090009
031000                                                                  03100009
031100     PERFORM 2000-OPEN-BATCH-CONTROL.                             03110009
031200     IF  PV-GOOD-STATUS                                           03120009
031300         PERFORM 3000-PROCESS-BATCH-CONTROL                       03130009
031400             UNTIL NOT MB018-MBS-DATE-CHANGE                      03140009
031500         PERFORM 6000-CLOSE-BATCH-CONTROL                         03150009
031600         PERFORM 9000-DISPLAY-TOTALS                              03160009
031700     ELSE                                                         03170009
031800         DISPLAY '*******************************'                03180009
031900         DISPLAY '*                             *'                03190009
032000         DISPLAY '* NO MBS DATE CHANGE RECORDS  *'                03200009
032100         DISPLAY '*                             *'                03210009
032200         DISPLAY '* FOR PROCESSING IN MBKUT008. *'                03220009
032300         DISPLAY '*                             *'                03230009
032400         DISPLAY '*   ***NORMAL END OF JOB***   *'                03240009
032500         DISPLAY '*******************************'                03250009
032600     END-IF.                                                      03260009
032700                                                                  03270009
032800 EJECT                                                            03280009
032900***************************************************************** 03290009
033000*                                                               * 03300009
033100*    THIS ROUTINE OPENS THE BATCH CONTROL FILE AND POSITIONS IT * 03310009
033200*    TO THE FIRST MBS REALIGNMENT RECORD.                       * 03320009
033300*                                                               * 03330009
033400***************************************************************** 03340009
033500                                                                  03350009
033600 2000-OPEN-BATCH-CONTROL.                                         03360009
033700                                                                  03370009
033800     OPEN I-O BATCH-CONTROL-FILE.                                 03380009
033900                                                                  03390009
034000     IF (PV-GOOD-STATUS                                           03400009
034100     OR  PV-AT-END                                                03410009
034200     OR  PV-VERIFIED)                                             03420009
034300         CONTINUE                                                 03430009
034400     ELSE                                                         03440009
034500         DISPLAY '* * * * * * * * * * * * * * * * *'              03450009
034600         DISPLAY '*    ***MBKUT008 ABEND***       *'              03460009
034700         DISPLAY '*                               *'              03470009
034800         DISPLAY '*   INVALID STATUS ON THE BATCH *'              03480009
034900         DISPLAY '*   CONTROL DATASET - OPEN.     *'              03490009
035000         DISPLAY '*                               *'              03500009
035100         DISPLAY '* STATUS = '                                    03510009
035200                 PV-VSAM-STATUS                                   03520009
035300                 '                  *'                            03530009
035400         DISPLAY '*                               *'              03540009
035500         DISPLAY '* * * * * * * * * * * * * * * * *'              03550009
035600         SET ABEND-4005        TO  TRUE                           03560009
035700         CALL 'ILBOABN0'    USING  ABEND-CODE                     03570009
035800     END-IF.                                                      03580009
035900                                                                  03590009
036000     MOVE LOW-VALUES           TO  MB018-BCR-KEY.                 03600009
036100     SET MB018-MBS-DATE-CHANGE TO  TRUE.                          03610009
036200     MOVE MB018-BCR-KEY-008    TO  BCR-KEY.                       03620009
036300     START BATCH-CONTROL-FILE                                     03630009
036400           KEY IS GREATER THAN BCR-KEY.                           03640009
036500                                                                  03650009
036600     IF  PV-GOOD-STATUS                                           03660009
036700         PERFORM 3100-READ-BATCH-CONTROL                          03670009
036800     ELSE                                                         03680009
036900         IF  PV-NO-RECORDS                                        03690009
037000             CONTINUE                                             03700009
037100         ELSE                                                     03710009
037200             DISPLAY '* * * * * * * * * * * * * * * * *'          03720009
037300             DISPLAY '*    ***MBKUT008 ABEND***       *'          03730009
037400             DISPLAY '*                               *'          03740009
037500             DISPLAY '*   INVALID STATUS ON THE BATCH *'          03750009
037600             DISPLAY '*   CONTROL DATASET - START.    *'          03760009
037700             DISPLAY '*                               *'          03770009
037800             DISPLAY '* STATUS = '                                03780009
037900                     PV-VSAM-STATUS                               03790009
038000                     '                  *'                        03800009
038100             DISPLAY '*                               *'          03810009
038200             DISPLAY '* * * * * * * * * * * * * * * * *'          03820009
038300             SET ABEND-4002        TO  TRUE                       03830009
038400             CALL 'ILBOABN0'    USING  ABEND-CODE                 03840009
038500         END-IF                                                   03850009
038600     END-IF.                                                      03860009
038700                                                                  03870009
038800 EJECT                                                            03880009
038900****************************************************************  03890009
039000*                                                              *  03900009
039100*    PROCESS THE BATCH CONTROL RECORD, VALIDATE THE DATA, IF   *  03910009
039200*    OK, UPDATE MDSEAR.                                        *  03920009
039300*                                                              *  03930009
039400****************************************************************  03940009
039500*                                                                 03950009
039600 3000-PROCESS-BATCH-CONTROL.                                      03960009
039700*                                                                 03970009
039800     DISPLAY '* * * * * * * * * * * * * * * * * * * * * * * * *'. 03980009
039900     DISPLAY '* CONTROL RECORD:'.                                 03990009
040000     DISPLAY '* ' MB018-BATCH-CNTL-RECORD.                        04000009
040100     DISPLAY '*'.                                                 04010009
040200     ADD 1                     TO  PV-BATCH-CNTL-COUNT.           04020009
040300*                                                                 04030009
040400     SET PS-CONTINUE           TO  TRUE.                          04040009
040500     PERFORM 3200-VALIDATE-DATA.                                  04050009
040600     PERFORM 3900-OBTAIN-PARENT-DATES.                            04060009
040700*                                                                 04070009
040800     IF  PS-CONTINUE                                              04080009
040900         PERFORM 4000-UPDATE-MDSEAR                               04090009
041000     ELSE                                                         04100009
041100         MOVE 4008             TO  RETURN-CODE                    04110009
041200     END-IF.                                                      04120009
041300*                                                                 04130009
041400     PERFORM 3800-DELETE-BATCH-CONTROL.                           04140009
041500     PERFORM 3100-READ-BATCH-CONTROL.                             04150009
041600*                                                                 04160009
041700 EJECT                                                            04170009
041800****************************************************************  04180009
041900*                                                              *  04190009
042000*    HERE WE READ THE BATCH CONTROL FILE.                      *  04200009
042100*                                                              *  04210009
042200****************************************************************  04220009
042300*                                                                 04230009
042400 3100-READ-BATCH-CONTROL.                                         04240009
042500*                                                                 04250009
042600     READ BATCH-CONTROL-FILE                                      04260009
042700          INTO MB018-BATCH-CNTL-RECORD.                           04270009
042800     IF  PV-GOOD-STATUS                                           04280009
042900     OR  PV-AT-END                                                04290009
043000         CONTINUE                                                 04300009
043100     ELSE                                                         04310009
043200         DISPLAY '* * * * * * * * * * * * * * * * *'              04320009
043300         DISPLAY '*    ***MBKUT008 ABEND***       *'              04330009
043400         DISPLAY '*                               *'              04340009
043500         DISPLAY '*   INVALID STATUS ON THE BATCH *'              04350009
043600         DISPLAY '*   CONTROL DATASET - READ.     *'              04360009
043700         DISPLAY '*                               *'              04370009
043800         DISPLAY '* STATUS = '                                    04380009
043900                 PV-VSAM-STATUS                                   04390009
044000                 '                  *'                            04400009
044100         DISPLAY '*                               *'              04410009
044200         DISPLAY '* * * * * * * * * * * * * * * * *'              04420009
044300         SET ABEND-4002        TO  TRUE                           04430009
044400         CALL 'ILBOABN0'    USING  ABEND-CODE                     04440009
044500     END-IF.                                                      04450009
044600*                                                                 04460009
044700     IF  PV-AT-END                                                04470009
044800         MOVE LOW-VALUE        TO  MB018-BATCH-CNTL-RECORD        04480009
044900     END-IF.                                                      04490009
045000*                                                                 04500009
045100 EJECT                                                            04510009
045200****************************************************************  04520009
045300*                                                              *  04530009
045400*    ENSURE THE DATA, ALBEIT PREVIOUSLY VALIDATED ON-LINE,     *  04540009
045500*    IS OKAY.                                                  *  04550009
045600*                                                              *  04560009
045700****************************************************************  04570009
045800*                                                                 04580009
045900 3200-VALIDATE-DATA.                                              04590009
046000*                                                                 04600009
046100     IF  MB018-OPERATING-CO-008 NOT NUMERIC                       04610009
046200         SET PS-DONT-PROCESS   TO  TRUE                           04620009
046300         DISPLAY '* COMPANY NUMBER NOT NUMERIC = '                04630009
046400                 MB018-OPERATING-CO-008 '.'                       04640009
046500         DISPLAY '*'                                              04650009
046600     END-IF.                                                      04660009
046700*                                                                 04670009
046800     IF  MB018-MERCH-AREA-008 GREATER THAN SPACES                 04680009
046900         PERFORM 3300-EXISTANCE-CHECK                             04690009
047000     ELSE                                                         04700009
047100         SET PS-DONT-PROCESS   TO  TRUE                           04710009
047200         DISPLAY '* NO MERCHANDISE AREA SELECTED = '              04720009
047300                 MB018-MERCH-AREA-008 '.'                         04730009
047400         DISPLAY '*'                                              04740009
047500     END-IF.                                                      04750009
047600                                                                  04760009
047700********************************************************          04770009
047800*    BEGIN THE DATE CHECK                                         04780009
047900********************************************************          04790009
048000                                                                  04800009
048100     INITIALIZE DPG51, DPG52, DPG53, DPG54, DPG55, DPG56.         04810009
048200                                                                  04820009
048300     ACCEPT PV-CURRENT-DATE      FROM DATE.                       04830009
048400     SET PS-VALID-DATE                TO TRUE.                    04840009
048500                                                                  04850009
048600     SET DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                    04860009
048700     SET DPG52-LK-DTE-GREG            TO TRUE.                    04870009
048800     MOVE PV-CD-MM                    TO DPG52-GREG-DATE-MO-X.    04880009
048900     MOVE PV-CD-DD                    TO DPG52-GREG-DATE-DY-X.    04890009
049000     MOVE PV-CD-YY                    TO DPG52-GREG-DATE-YR-X.    04900009
049100                                                                  04910009
049200     CALL  DP500-KOHLS-CALENDAR-ROUTINE                           04920009
049300           USING DPG51, DPG52, DPG53, DPG54, DPG55, DPG56.        04930009
049400                                                                  04940009
049500     IF DPG54-SEVERE-ERROR OR DPG54-WARNING-ERROR                 04950009
049600        DISPLAY '* * * * * * * * * * * * * * * * *'               04960009
049700        DISPLAY '*    ***MBKUT008-1 ABEND***     *'               04970009
049800        DISPLAY '*                               *'               04980009
049900        DISPLAY '*                               *'               04990009
050000        DISPLAY '*  INVALID RETURN FROM DPKUT500 *'               05000009
050100        DISPLAY '* * * * * * * * * * * * * * * * *'               05010009
050200        DISPLAY 'ERROR IND.:  '      DPG54-ERROR-IND              05020009
050300        DISPLAY 'DATE IND.:   '      DPG54-DATE-VALID-IND         05030009
050400        DISPLAY 'ERROR MSG:   '      DPG54-ERROR-MESSAGE          05040009
050500        SET ABEND-4002            TO  TRUE                        05050009
050600        CALL 'ILBOABN0'        USING  ABEND-CODE                  05060009
050700     ELSE                                                         05070009
050800        MOVE DPG55-DB2-ISO-DATE-FMT TO PV-DB2-CHANGE-DATE         05080009
050900     END-IF.                                                      05090009
051000                                                                  05100009
051100     MOVE PV-DB2-CHANGE-DATE   TO  PV-DB2-WORK-DATE.              05110009
051200                                                                  05120009
051800     ADD 1                     TO  PV-WD-CCYY.                    05180009
051900                                                                  05190009
052000     IF  MB018-NEW-START-DATE-008 GREATER THAN SPACES             05200009
052100         IF  MB018-NEW-START-DATE-008 GREATER PV-DB2-WORK-DATE    05210009
052200             SET PS-INVALID-DATE                                  05220009
052300                               TO  TRUE                           05230009
052400             DISPLAY '* START DATE MORE THAN 1 YEAR IN FUTURE, = '05240009
052500                 MB018-NEW-START-DATE-008 '.'                     05250009
052600             DISPLAY '*'                                          05260009
052700         END-IF                                                   05270009
052800     END-IF.                                                      05280009
052900                                                                  05290009
053000     IF  MB018-NEW-END-DATE-008 GREATER THAN SPACES               05300009
053100         IF  MB018-NEW-END-DATE-008 = '9999-09-09'                05310009
053200             CONTINUE                                             05320009
053300         ELSE                                                     05330009
053400             IF  MB018-NEW-END-DATE-008 GREATER PV-DB2-WORK-DATE  05340009
053500                 SET PS-INVALID-DATE                              05350009
053600                               TO  TRUE                           05360009
053700               DISPLAY '* END DATE MORE THAN 1 YEAR IN FUTURE, = '05370009
053800                 MB018-NEW-END-DATE-008 '.'                       05380009
053900                 DISPLAY '*'                                      05390009
054000             END-IF                                               05400009
054100         END-IF                                                   05410009
054200     END-IF.                                                      05420009
054300                                                                  05430009
054400     IF  PS-INVALID-DATE                                          05440009
054500         SET PS-DONT-PROCESS   TO  TRUE                           05450009
054600     ELSE                                                         05460009
054700                                                                  05470009
054800         IF  MB018-NEW-START-DATE-008 GREATER THAN SPACES         05480009
054900             INITIALIZE DPG51, DPG52, DPG53, DPG54, DPG55, DPG56  05490009
055000                                                                  05500009
055100             SET DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE             05510009
055200             SET DPG52-LK-DTE-ISO-FMT         TO TRUE             05520009
055300             MOVE MB018-NEW-START-DATE-008                        05530009
055400                               TO DPG52-DB2-ISO-DATE-FMT          05540009
055500                                                                  05550009
055600             CALL  DP500-KOHLS-CALENDAR-ROUTINE                   05560009
055700                   USING DPG51, DPG52, DPG53,                     05570009
055800                         DPG54, DPG55, DPG56                      05580009
055900                                                                  05590009
056000             IF  DPG54-SEVERE-ERROR OR DPG54-WARNING-ERROR        05600009
056100                 SET PS-DONT-PROCESS                              05610009
056200                               TO  TRUE                           05620009
056300                 SET PS-INVALID-DATE                              05630009
056400                               TO  TRUE                           05640009
056500                 DISPLAY '* INVALID START DATE. DATE = '          05650009
056600                     MB018-NEW-START-DATE-008 '.'                 05660009
056700                 DISPLAY '*'                                      05670009
056800             END-IF                                               05680009
056900         END-IF                                                   05690009
057000                                                                  05700009
057100         IF  MB018-NEW-END-DATE-008 GREATER THAN SPACES           05710009
057110                 AND  MB018-NEW-END-DATE-008 NOT = '9999-09-09'   05711009
057200             INITIALIZE DPG51, DPG52, DPG53, DPG54, DPG55, DPG56  05720009
057300                                                                  05730009
057400             SET DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE             05740009
057500             SET DPG52-LK-DTE-ISO-FMT         TO TRUE             05750009
057610             MOVE MB018-NEW-END-DATE-008                          05761009
057620                               TO DPG52-DB2-ISO-DATE-FMT          05762009
057700                                                                  05770009
057800             CALL  DP500-KOHLS-CALENDAR-ROUTINE                   05780009
057900                   USING DPG51, DPG52, DPG53,                     05790009
058000                         DPG54, DPG55, DPG56                      05800009
058100                                                                  05810009
058200             IF  DPG54-SEVERE-ERROR OR DPG54-WARNING-ERROR        05820009
058300                 SET PS-DONT-PROCESS                              05830009
058400                               TO  TRUE                           05840009
058500                 SET PS-INVALID-DATE                              05850009
058600                               TO  TRUE                           05860009
058700                 DISPLAY '* INVALID END DATE. DATE = '            05870009
058800                     MB018-NEW-END-DATE-008 '.'                   05880009
058900                 DISPLAY '*'                                      05890009
059000             END-IF                                               05900009
059100         END-IF                                                   05910009
059200     END-IF.                                                      05920009
059300                                                                  05930009
059400     IF  MB018-MERCH-AREA-008 GREATER THAN SPACES                 05940009
059500                                                                  05950009
059600         IF  MB018-NEW-START-DATE-008 GREATER THAN SPACES         05960009
059700             PERFORM 3500-CHECK-START-DATE-DELETES                05970009
059800                                                                  05980009
059900             IF  PV-DB2-COUNT GREATER THAN ZERO                   05990009
060000                 SET PS-DONT-PROCESS                              06000009
060100                               TO  TRUE                           06010009
060200                 SET PS-INVALID-DATE                              06020009
060300                               TO  TRUE                           06030009
060400                 DISPLAY '* A SUBORDINATE MERCHANDISE AREA '      06040009
060500                         'ENDS BEFORE NEW START DATE.'            06050009
060600                 DISPLAY '*'                                      06060009
060700             END-IF                                               06070009
060800                                                                  06080009
060900         END-IF                                                   06090009
061000                                                                  06100009
061100         IF  MB018-NEW-END-DATE-008 GREATER THAN SPACES           06110009
061200             PERFORM 3600-CHECK-END-DATE-DELETES                  06120009
061300                                                                  06130009
061400             IF  PV-DB2-COUNT GREATER THAN ZERO                   06140009
061500                 SET PS-DONT-PROCESS                              06150009
061600                               TO  TRUE                           06160009
061700                 SET PS-INVALID-DATE                              06170009
061800                               TO  TRUE                           06180009
061900                 DISPLAY '* A SUBORDINATE MERCHANDISE AREA '      06190009
062000                         'STARTS AFTER NEW END DATE.'             06200009
062100                 DISPLAY '*'                                      06210009
062200             END-IF                                               06220009
062300                                                                  06230009
062400         END-IF                                                   06240009
062500                                                                  06250009
062600     END-IF.                                                      06260009
062700                                                                  06270009
062800 EJECT                                                            06280009
062900******************************************************************06290009
063000*    ENSURE THE DATA EXISTS.                                      06300009
063100*                                                                 06310009
063200*    PERFORMED BY 3200                                            06320009
063300******************************************************************06330009
063400                                                                  06340009
063500 3300-EXISTANCE-CHECK.                                            06350009
063600                                                                  06360009
063700     MOVE MB018-OPERATING-CO-008                                  06370009
063800                               TO  PV-WS-OPERCO.                  06380009
063900     MOVE MB018-MERCH-AREA-008                                    06390009
064000                               TO  PV-CONTROL-DATA.               06400009
064100     MOVE ZERO                 TO  PV-WS-ZERO.                    06410009
064200     SET PV-REQUEST-GMA        TO  TRUE.                          06420009
064300                                                                  06430009
064400     IF  MB018-DMA-008 NOT GREATER THAN ZERO                      06440009
064500         MOVE ZERO             TO  PV-WS-DMA                      06450009
064600     ELSE                                                         06460009
064700         SET PV-REQUEST-DMA    TO  TRUE                           06470009
064800     END-IF.                                                      06480009
064900                                                                  06490009
065000     IF  MB018-DEPT-008 NOT GREATER THAN ZERO                     06500009
065100         MOVE ZERO             TO  PV-WS-DEPT                     06510009
065200     ELSE                                                         06520009
065300         SET PV-REQUEST-DPT    TO  TRUE                           06530009
065400     END-IF.                                                      06540009
065500                                                                  06550009
065600     IF  MB018-MAJ-CL-008 NOT GREATER THAN ZERO                   06560009
065700         MOVE ZERO             TO  PV-WS-MAJ-CL                   06570009
065800     ELSE                                                         06580009
065900         SET PV-REQUEST-MCL    TO  TRUE                           06590009
066000     END-IF.                                                      06600009
066100                                                                  06610009
066200     IF  MB018-SUB-CL-008 NOT GREATER THAN ZERO                   06620009
066300         MOVE ZERO             TO  PV-WS-SUB-CL                   06630009
066400     ELSE                                                         06640009
066500         SET PV-REQUEST-SCL    TO  TRUE                           06650009
066600     END-IF.                                                      06660009
066700                                                                  06670009
066800     MOVE PV-WORK-SEQ-NBR      TO  PV-LIST-SEQ-NBR.               06680009
066900                                                                  06690009
067000*    NOW THE MAX SEQUENCE NUMBER.                                 06700009
067100                                                                  06710009
067200     MOVE PC-NINES             TO  PV-WS-ZERO.                    06720009
067300     IF  MB018-SUB-CL-008 NOT GREATER THAN ZERO                   06730009
067400         MOVE PC-NINES         TO  PV-WS-SUB-CL                   06740009
067500     END-IF.                                                      06750009
067600                                                                  06760009
067700     IF  MB018-MAJ-CL-008 NOT GREATER THAN ZERO                   06770009
067800         MOVE PC-NINES         TO  PV-WS-MAJ-CL                   06780009
067900     END-IF.                                                      06790009
068000                                                                  06800009
068100     IF  MB018-DEPT-008 NOT GREATER THAN ZERO                     06810009
068200         MOVE PC-NINES         TO  PV-WS-DEPT                     06820009
068300     END-IF.                                                      06830009
068400                                                                  06840009
068500     IF  MB018-DMA-008 NOT GREATER THAN ZERO                      06850009
068600         MOVE PC-NINES         TO  PV-WS-DMA                      06860009
068700     END-IF.                                                      06870009
068800                                                                  06880009
068900     IF  MB018-GMA-008 NOT GREATER THAN ZERO                      06890009
069000         MOVE PC-NINES         TO  PV-WS-GMA                      06900009
069100     END-IF.                                                      06910009
069200                                                                  06920009
069300     MOVE PV-WORK-SEQ-NBR      TO  PV-MAX-SEQ-NBR.                06930009
069400                                                                  06940009
069500     PERFORM 3400-CHECK-EXISTANCE.                                06950009
069600                                                                  06960009
069700     IF  PV-DB2-COUNT EQUAL ZERO                                  06970009
069800         SET PS-DONT-PROCESS TO  TRUE                             06980009
069900         DISPLAY '* MERCHANDISE AREA DOES NOT EXIST-'             06990009
070000                     MB018-MERCH-AREA-008 '.'                     07000009
070100         DISPLAY '* KEYS USED: '                                  07010009
070200                 PV-LIST-SEQ-NBR ' - ' PV-MAX-SEQ-NBR             07020009
070300     END-IF.                                                      07030009
070400                                                                  07040009
070500 EJECT                                                            07050009
070600******************************************************************07060009
070700*    CHECK IF THE NEW STRUCTURE ALREADY EXISTS.                   07070009
070800*                                                                 07080009
070900*    PERFORMED BY 3300                                            07090009
071000******************************************************************07100009
071100*                                                                 07110009
071200 3400-CHECK-EXISTANCE.                                            07120009
071300*                                                                 07130009
071400     MOVE ZERO                 TO  PV-DB2-COUNT.                  07140009
071500*                                                                 07150009
071600     PERFORM                                                      07160009
071700         WITH TEST AFTER                                          07170009
071800         VARYING PV-SQL-SUB                                       07180009
071900         FROM 1 BY 1                                              07190009
072000         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       07200009
072100                   OR SQLCODE = 0                                 07210009
072200                   OR SQLCODE = +100)                             07220009
072300*                                                                 07230009
072400         EXEC SQL                                                 07240009
072500              SELECT                                              07250009
072600                     COUNT(DISTINCT GMA_NBR)                      07260009
072700              INTO                                                07270009
072800                     :PV-DB2-COUNT                                07280009
072900              FROM                                                07290009
073000                     TMDSEAR                                      07300009
073100              WHERE                                               07310009
073200                     OPERCO_NBR     = :MB018-OPERATING-CO-008     07320009
073300                AND (LIST_SEQ_NBR                                 07330009
073400                     BETWEEN          :PV-LIST-SEQ-NBR            07340009
073500                     AND              :PV-MAX-SEQ-NBR)            07350009
073600         END-EXEC                                                 07360009
073700*                                                                 07370009
073800         EVALUATE TRUE                                            07380009
073900             WHEN SQLCODE = -904                                  07390009
074000             WHEN SQLCODE = -911                                  07400009
074100             WHEN SQLCODE = +100                                  07410009
074200             WHEN SQLCODE = 0                                     07420009
074300                 CONTINUE                                         07430009
074400             WHEN SQLWARN NOT = SPACES                            07440009
074500             WHEN SQLCODE NOT = ZERO                              07450009
074600                 MOVE '3400-CHECK-EXISTANCE'                      07460009
074700                               TO  PV-PARAGRAPH-NAME              07470009
074800                 MOVE 'COUNT GMA'                                 07480009
074900                               TO  PV-DB2-OPER-ATTEMPTED          07490009
075000                 PERFORM 9900-SQL-ABEND                           07500009
075100         END-EVALUATE                                             07510009
075200     END-PERFORM.                                                 07520009
075300*                                                                 07530009
075400     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        07540009
075500         MOVE '3400-CHECK-EXISTANCE'                              07550009
075600                               TO  PV-PARAGRAPH-NAME              07560009
075700         MOVE 'COUNT RETRIES EXCEEDED'                            07570009
075800                               TO  PV-DB2-OPER-ATTEMPTED          07580009
075900         PERFORM 9900-SQL-ABEND                                   07590009
076000     END-IF.                                                      07600009
076100                                                                  07610009
076200 EJECT                                                            07620009
076300******************************************************************07630009
076400*    SEE IF THE NEW END DATE IS BEFORE A SUBORDINATE START DATE.  07640009
076500*                                                                 07650009
076600*    PERFORMED BY 3200                                            07660009
076700******************************************************************07670009
076800                                                                  07680009
076900 3500-CHECK-START-DATE-DELETES.                                   07690009
077000                                                                  07700009
077100     MOVE ZERO                 TO  PV-DB2-COUNT.                  07710009
077200     PERFORM                                                      07720009
077300         WITH TEST AFTER                                          07730009
077400         VARYING PV-SQL-SUB                                       07740009
077500         FROM 1 BY 1                                              07750009
077600         UNTIL PV-SQL-SUB GREATER THAN PC-MAX-RETRIES             07760009
077700            OR SQLCODE = 0                                        07770009
077800            OR SQLCODE = +100                                     07780009
077900                                                                  07790009
078000         EXEC SQL                                                 07800009
078100              SELECT                                              07810009
078200                     COUNT(*)                                     07820009
078300              INTO                                                07830009
078400                     :PV-DB2-COUNT                                07840009
078500              FROM                                                07850009
078600                     TMDSEAR                                      07860009
078700              WHERE                                               07870009
078800                     OPERCO_NBR     = :PC-COMPANY                 07880009
078900                AND (LIST_SEQ_NBR                                 07890009
079000                     BETWEEN          :PV-LIST-SEQ-NBR            07900009
079100                     AND              :PV-MAX-SEQ-NBR)            07910009
079200                AND (END_DTE        < :MB018-NEW-START-DATE-008)  07920009
079300         END-EXEC                                                 07930009
079400                                                                  07940009
079500         EVALUATE TRUE                                            07950009
079600             WHEN SQLCODE = -904                                  07960009
079700             WHEN SQLCODE = -911                                  07970009
079800             WHEN SQLCODE = +100                                  07980009
079900             WHEN SQLCODE = 0                                     07990009
080000                 CONTINUE                                         08000009
080100             WHEN SQLWARN NOT = SPACES                            08010009
080200             WHEN SQLCODE NOT = ZERO                              08020009
080300                 MOVE '3500-CHECK-START-DATE-DELETES'             08030009
080400                               TO  PV-PARAGRAPH-NAME              08040009
080500                 MOVE 'COUNT GMA'                                 08050009
080600                               TO  PV-DB2-OPER-ATTEMPTED          08060009
080700                 PERFORM 9900-SQL-ABEND                           08070009
080800         END-EVALUATE                                             08080009
080900     END-PERFORM.                                                 08090009
081000                                                                  08100009
081100     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        08110009
081200         MOVE '3500-CHECK-START-DATE-DELETES'                     08120009
081300                               TO  PV-PARAGRAPH-NAME              08130009
081400         MOVE 'COUNT RETRIES EXCEEDED'                            08140009
081500                               TO  PV-DB2-OPER-ATTEMPTED          08150009
081600         PERFORM 9900-SQL-ABEND                                   08160009
081700     END-IF.                                                      08170009
081800                                                                  08180009
081900 EJECT                                                            08190009
082000******************************************************************08200009
082100*    SEE IF THE NEW START DATE IS AFTER A SUBORDINATE END DATE.   08210009
082200*                                                                 08220009
082300*    PERFORMED BY 3200                                            08230009
082400******************************************************************08240009
082500                                                                  08250009
082600 3600-CHECK-END-DATE-DELETES.                                     08260009
082700                                                                  08270009
082800     MOVE ZERO                 TO  PV-DB2-COUNT.                  08280009
082900     PERFORM                                                      08290009
083000         WITH TEST AFTER                                          08300009
083100         VARYING PV-SQL-SUB                                       08310009
083200         FROM 1 BY 1                                              08320009
083300         UNTIL PV-SQL-SUB GREATER THAN PC-MAX-RETRIES             08330009
083400            OR SQLCODE = 0                                        08340009
083500            OR SQLCODE = +100                                     08350009
083600                                                                  08360009
083700         EXEC SQL                                                 08370009
083800              SELECT                                              08380009
083900                     COUNT(*)                                     08390009
084000              INTO                                                08400009
084100                     :PV-DB2-COUNT                                08410009
084200              FROM                                                08420009
084300                     TMDSEAR                                      08430009
084400              WHERE                                               08440009
084500                     OPERCO_NBR     = :PC-COMPANY                 08450009
084600                AND (LIST_SEQ_NBR                                 08460009
084700                     BETWEEN          :PV-LIST-SEQ-NBR            08470009
084800                     AND              :PV-MAX-SEQ-NBR)            08480009
084900                AND (STRT_DTE       > :MB018-NEW-END-DATE-008)    08490009
085000         END-EXEC                                                 08500009
085100                                                                  08510009
085200         EVALUATE TRUE                                            08520009
085300             WHEN SQLCODE = -904                                  08530009
085400             WHEN SQLCODE = -911                                  08540009
085500             WHEN SQLCODE = +100                                  08550009
085600             WHEN SQLCODE = 0                                     08560009
085700                 CONTINUE                                         08570009
085800             WHEN SQLWARN NOT = SPACES                            08580009
085900             WHEN SQLCODE NOT = ZERO                              08590009
086000                 MOVE '3600-CHECK-END-DATE-DELETES'               08600009
086100                               TO  PV-PARAGRAPH-NAME              08610009
086200                 MOVE 'COUNT GMA'                                 08620009
086300                               TO  PV-DB2-OPER-ATTEMPTED          08630009
086400                 PERFORM 9900-SQL-ABEND                           08640009
086500         END-EVALUATE                                             08650009
086600     END-PERFORM.                                                 08660009
086700                                                                  08670009
086800     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        08680009
086900         MOVE '3600-CHECK-END-DATE-DELETES'                       08690009
087000                               TO  PV-PARAGRAPH-NAME              08700009
087100         MOVE 'COUNT RETRIES EXCEEDED'                            08710009
087200                               TO  PV-DB2-OPER-ATTEMPTED          08720009
087300         PERFORM 9900-SQL-ABEND                                   08730009
087400     END-IF.                                                      08740009
087500                                                                  08750009
087600 EJECT                                                            08760009
087700****************************************************************  08770009
087800*                                                              *  08780009
087900*    DELETE THE CURRENT BATCH CONTROL RECORD.                  *  08790009
088000*                                                              *  08800009
088100****************************************************************  08810009
088200*                                                                 08820009
088300 3800-DELETE-BATCH-CONTROL.                                       08830009
088400*                                                                 08840009
088500     IF  PS-CONTINUE                                              08850009
088600         DISPLAY '* '                                             08860009
088700             PV-UPDATE-COUNT ' TMDSEAR UPDATED'                   08870009
088800         DISPLAY '* '                                             08880009
088900             PV-DELETE-COUNT ' TMDSEAR DELETED'                   08890009
089000         DISPLAY '* '                                             08900009
089100         DISPLAY '* '                                             08910009
089200             PV-UPDATE-APLAVL-COUNT ' TAPLAVL UPDATED'            08920009
089300         DISPLAY '* '                                             08930009
089400             PV-DELETE-APLAVL-COUNT ' TAPLAVL DELETED'            08940009
089500         DISPLAY '* '                                             08950009
089600         DISPLAY '* '                                             08960009
089700             PV-UPDATE-RSPBAR-COUNT ' TRSPBAR UPDATED'            08970009
089800         DISPLAY '* '                                             08980009
089900             PV-DELETE-RSPBAR-COUNT ' TRSPBAR DELETED'            08990009
090000         DISPLAY '* '                                             09000009
090100         DISPLAY '* FOR THIS CONTROL RECORD.'                     09010009
090200         DISPLAY '*'                                              09020009
090300                                                                  09030009
090400         ADD PV-UPDATE-COUNT   TO  PV-TOT-UPDATES                 09040009
090500         ADD PV-DELETE-COUNT   TO  PV-TOT-DELETES                 09050009
090600         ADD PV-DELETE-APLAVL-COUNT                               09060009
090700                               TO  PV-TOT-APLAVLS-DELETED         09070009
090800         ADD PV-UPDATE-APLAVL-COUNT                               09080009
090900                               TO  PV-TOT-APLAVLS-UPDATED         09090009
091000         ADD PV-DELETE-RSPBAR-COUNT                               09100009
091100                               TO  PV-TOT-RSPBARS-DELETED         09110009
091200         ADD PV-UPDATE-RSPBAR-COUNT                               09120009
091300                               TO  PV-TOT-RSPBARS-UPDATED         09130009
091400     END-IF.                                                      09140009
091500*                                                                 09150009
091600     MOVE ZERO                 TO  PV-UPDATE-COUNT                09160009
091700                                   PV-DELETE-COUNT                09170009
091800                                   PV-DELETE-APLAVL-COUNT         09180009
091900                                   PV-UPDATE-APLAVL-COUNT         09190009
092000                                   PV-DELETE-RSPBAR-COUNT         09200009
092100                                   PV-UPDATE-RSPBAR-COUNT         09210009
092200                                                                  09220009
092300     DELETE BATCH-CONTROL-FILE RECORD.                            09230009
092400*                                                                 09240009
092500     IF  PV-GOOD-STATUS                                           09250009
092600         CONTINUE                                                 09260009
092700     ELSE                                                         09270009
092800         DISPLAY '* * * * * * * * * * * * * * * * *'              09280009
092900         DISPLAY '*    ***MBKUT008 ABEND***       *'              09290009
093000         DISPLAY '*                               *'              09300009
093100         DISPLAY '*   INVALID STATUS ON THE BATCH *'              09310009
093200         DISPLAY '*   CONTROL DATASET - DELETE    *'              09320009
093300         DISPLAY '*                               *'              09330009
093400         DISPLAY '* STATUS = '                                    09340009
093500                 PV-VSAM-STATUS                                   09350009
093600                 '                  *'                            09360009
093700         DISPLAY '*                               *'              09370009
093800         DISPLAY '* * * * * * * * * * * * * * * * *'              09380009
093900         SET ABEND-4003        TO  TRUE                           09390009
094000         CALL 'ILBOABN0'    USING  ABEND-CODE                     09400009
094100     END-IF.                                                      09410009
094200                                                                  09420009
094300 EJECT                                                            09430009
094400****************************************************************  09440009
094500*                                                              *  09450009
094600*    READ THE PARENT ROW FOR THE NEW DATA.  SAVE THE           *  09460009
094700*    DATES TO ENSURE ALL NEWLY ADDED ROWS EXIST WITHIN         *  09470009
094800*    THEIR PARENT.  FIRST, DETERMINE WHICH LEVEL WE NEED       *  09480009
094900*    AND THEN ISSUE THE SQL.                                   *  09490009
095000*                                                              *  09500009
095100*    PERFORMED BY 3000                                         *  09510009
095200****************************************************************  09520009
095300                                                                  09530009
095400 3900-OBTAIN-PARENT-DATES.                                        09540009
095500                                                                  09550009
095600     MOVE ZERO                 TO  MDSEAR-SUB-CL-NBR.             09560009
095700     MOVE MB018-MAJ-CL-008     TO  MDSEAR-MAJ-CL-NBR.             09570009
095800     MOVE MB018-DEPT-008       TO  MDSEAR-DEPT-NBR.               09580009
095900     MOVE MB018-DMA-008        TO  MDSEAR-DMA-NBR.                09590009
096000     MOVE MB018-GMA-008        TO  MDSEAR-GMA-NBR.                09600009
096100                                                                  09610009
096200     SET PV-MCL-LIT            TO  TRUE.                          09620009
096300     IF  MB018-MAJ-CL-008 NOT GREATER THAN ZERO                   09630009
096400         MOVE ZERO             TO  MDSEAR-MAJ-CL-NBR              09640009
096500         MOVE ZERO             TO  MDSEAR-DEPT-NBR                09650009
096600         SET PV-DMA-LIT        TO  TRUE                           09660009
096700         IF  MB018-DEPT-008 NOT GREATER THAN ZERO                 09670009
096800             SET PV-GMA-LIT    TO  TRUE                           09680009
096900             MOVE ZERO         TO  MDSEAR-DMA-NBR                 09690009
097000             IF  MB018-DMA-008 NOT GREATER THAN ZERO              09700009
097100                 MOVE ZERO     TO  MDSEAR-GMA-NBR                 09710009
097200                 SET PV-CO-LIT TO  TRUE                           09720009
097300             END-IF                                               09730009
097400         END-IF                                                   09740009
097500     ELSE                                                         09750009
097600         IF  MB018-SUB-CL-008 NOT GREATER THAN ZERO               09760009
097700             MOVE ZERO         TO  MDSEAR-MAJ-CL-NBR              09770009
097800             SET PV-DPT-LIT    TO  TRUE                           09780009
097900         END-IF                                                   09790009
098000     END-IF.                                                      09800009
098100                                                                  09810009
098200     PERFORM                                                      09820009
098300         WITH TEST AFTER                                          09830009
098400         VARYING PV-SQL-SUB                                       09840009
098500         FROM 1 BY 1                                              09850009
098600         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       09860009
098700                   OR SQLCODE = 0                                 09870009
098800                   OR SQLCODE = +100)                             09880009
098900                                                                  09890009
099000         EXEC SQL                                                 09900009
099100              SELECT STRT_DTE                                     09910009
099200                   , END_DTE                                      09920009
099300                   , MDSEAR_DKEY                                  09930009
099400              INTO                                                09940009
099500                     :PV-PARENT-START-DATE                        09950011
099600                   , :PV-PARENT-END-DATE                          09960011
099700                   , :PV-PARENT-DKEY                              09970011
099800              FROM                                                09980009
099900                     TMDSEAR                                      09990009
100000              WHERE                                               10000009
100100                     OPERCO_NBR     =  :MB018-OPERATING-CO-008    10010009
100200                AND  GMA_NBR        =  :MDSEAR-GMA-NBR            10020009
100300                AND  DMA_NBR        =  :MDSEAR-DMA-NBR            10030009
100400                AND  DEPT_NBR       =  :MDSEAR-DEPT-NBR           10040009
100500                AND  MAJ_CL_NBR     =  :MDSEAR-MAJ-CL-NBR         10050009
100600                AND  SUB_CL_NBR     =  :MDSEAR-SUB-CL-NBR         10060009
100700                AND  MDSELV_CDE     =  :PV-LEVEL                  10070009
100800         END-EXEC                                                 10080009
100900                                                                  10090009
101000         EVALUATE TRUE                                            10100009
101100             WHEN SQLCODE = -904                                  10110009
101200             WHEN SQLCODE = -911                                  10120009
101300             WHEN SQLCODE = +100                                  10130009
101400             WHEN SQLCODE = 0                                     10140009
101500                 CONTINUE                                         10150009
101600             WHEN SQLWARN NOT = SPACES                            10160009
101700             WHEN SQLCODE NOT = ZERO                              10170009
101800                 MOVE '3900-OBTAIN-PARENT-DATES'                  10180009
101900                               TO  PV-PARAGRAPH-NAME              10190009
102000                 MOVE 'SELECT TMDSEAR FOR PARENT DATES'           10200009
102100                               TO  PV-DB2-OPER-ATTEMPTED          10210009
102200                 PERFORM 9900-SQL-ABEND                           10220009
102300         END-EVALUATE                                             10230009
102400     END-PERFORM.                                                 10240009
102500                                                                  10250009
102600     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        10260009
102700         MOVE '3900-OBTAIN-PARENT-DATES'                          10270009
102800                               TO  PV-PARAGRAPH-NAME              10280009
102900         MOVE 'SELECT FOR TMDSEAR PARENT DATES EXCEEDED'          10290009
103000                               TO  PV-DB2-OPER-ATTEMPTED          10300009
103100         PERFORM 9900-SQL-ABEND                                   10310009
103200     END-IF.                                                      10320009
103300                                                                  10330009
103400     DISPLAY '*  KEYS USED = OPERCO ='                            10340009
103500             MB018-OPERATING-CO-008  ', GMA='                     10350009
103600             MDSEAR-GMA-NBR          ', DMA='                     10360009
103700             MDSEAR-DMA-NBR          ', DPT='                     10370009
103800             MDSEAR-DEPT-NBR         ', MCL='                     10380009
103900             MDSEAR-MAJ-CL-NBR       ', SCL='                     10390009
104000             MDSEAR-SUB-CL-NBR       ', LVL='                     10400009
104100             PV-LEVEL.                                            10410009
104200                                                                  10420009
104300     IF  SQLCODE EQUAL ZERO                                       10430009
104400         DISPLAY '*  PARENT START DATE = ' PV-PARENT-START-DATE   10440009
104500         DISPLAY '*  PARENT END   DATE = ' PV-PARENT-END-DATE     10450009
104600         PERFORM 3950-CHECK-PARENT-DATES                          10460009
104700     ELSE                                                         10470009
104800         SET PS-DONT-PROCESS   TO  TRUE                           10480009
104900         DISPLAY '*  PARENT NOT FOUND FOR THIS CONTROL RECORD'    10490009
105000     END-IF.                                                      10500009
105100                                                                  10510009
105200 EJECT                                                            10520009
105300****************************************************************  10530009
105400*                                                              *  10540009
105500*    NOW ENSURE THE CHANGES DATES ARE WITHING THE PARENT       *  10550009
105600*    DATES.                                                    *  10560009
105700*                                                              *  10570009
105800*    PERFORMED BY 3900                                         *  10580009
105900****************************************************************  10590009
106000                                                                  10600009
106100 3950-CHECK-PARENT-DATES.                                         10610009
106200                                                                  10620009
106300     IF  MB018-NEW-START-DATE-008 GREATER THAN SPACES             10630009
106400         IF  MB018-NEW-START-DATE-008 LESS PV-PARENT-START-DATE   10640009
106500             SET PS-DONT-PROCESS                                  10650009
106600                               TO  TRUE                           10660009
106700             DISPLAY '* NEW START DATE LESS THAN PARENT DATE, '   10670009
106800                     'NEW = '                                     10680009
106900                     MB018-NEW-START-DATE-008                     10690009
107000                     '. PARENT = '                                10700009
107100                     PV-PARENT-START-DATE '.'                     10710009
107200         END-IF                                                   10720009
107300     END-IF.                                                      10730009
107400                                                                  10740009
107500     IF  MB018-NEW-END-DATE-008 GREATER THAN SPACES               10750009
107600         IF  MB018-NEW-END-DATE-008 GREATER PV-PARENT-END-DATE    10760009
107700             SET PS-DONT-PROCESS                                  10770009
107800                               TO  TRUE                           10780009
107900             DISPLAY '* NEW END DATE GREATER THAN PARENT DATE, '  10790009
108000                     'NEW = '                                     10800009
108100                     MB018-NEW-END-DATE-008                       10810009
108200                     '. PARENT = '                                10820009
108300                     PV-PARENT-END-DATE '.'                       10830009
108400         END-IF                                                   10840009
108500     END-IF.                                                      10850009
108600                                                                  10860009
108700     IF  PS-CONTINUE                                              10870009
108800         EVALUATE TRUE                                            10880009
108900                                                                  10890009
109000             WHEN PV-CO-LIT                                       10900009
109100                  MOVE PV-PARENT-DKEY                             10910009
109200                               TO  PV-LAST-CO-DKEY                10920009
109300                                                                  10930009
109400             WHEN PV-GMA-LIT                                      10940009
109500                  MOVE PV-PARENT-DKEY                             10950009
109600                               TO  PV-LAST-GMA-DKEY               10960009
109700                                                                  10970009
109800             WHEN PV-DMA-LIT                                      10980009
109900                  MOVE PV-PARENT-DKEY                             10990009
110000                               TO  PV-LAST-DMA-DKEY               11000009
110100                                                                  11010009
110200             WHEN PV-DPT-LIT                                      11020009
110300                  MOVE PV-PARENT-DKEY                             11030009
110400                               TO  PV-LAST-DPT-DKEY               11040009
110500                                                                  11050009
110600             WHEN PV-MCL-LIT                                      11060009
110700                  MOVE PV-PARENT-DKEY                             11070009
110800                               TO  PV-LAST-MCL-DKEY               11080009
110900         END-EVALUATE                                             11090009
111000     END-IF.                                                      11100009
111100                                                                  11110009
111200 EJECT                                                            11120009
111300****************************************************************  11130009
111400*                                                              *  11140009
111500*    HERE BEGINS THE ACTUAL UPDATE PROCESS.  FIRST, WE MUST    *  11150009
111600*    OPEN THE CURSOR.  NEXT UPDATE THE ROW WITH THE NEW DATES. *  11160009
111700*                                                              *  11170009
111800*    PERFORMED BY 3000-                                        *  11180009
111900****************************************************************  11190009
112000                                                                  11200009
112100 4000-UPDATE-MDSEAR.                                              11210009
112200                                                                  11220009
112300     PERFORM 4100-OPEN-CURSOR.                                    11230009
112400     PERFORM 4200-PROCESS-CURSOR                                  11240009
112500         UNTIL SQLCODE NOT EQUAL ZERO.                            11250009
112600     PERFORM 4600-CLOSE-CURSOR.                                   11260009
112700     PERFORM 4800-COMMIT.                                         11270009
112800                                                                  11280009
112900 EJECT                                                            11290009
113000****************************************************************  11300009
113100*                                                              *  11310009
113200*    OPEN THE MERCHANDISE LIST CURSOR.                         *  11320009
113300*                                                              *  11330009
113400****************************************************************  11340009
113500                                                                  11350009
113600 4100-OPEN-CURSOR.                                                11360009
113700                                                                  11370009
113800     PERFORM                                                      11380009
113900         WITH TEST AFTER                                          11390009
114000         VARYING PV-SQL-SUB                                       11400009
114100         FROM 1 BY 1                                              11410009
114200         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       11420009
114300                   OR SQLCODE = 0                                 11430009
114400                   OR SQLCODE = +100)                             11440009
114500                                                                  11450009
114600         EXEC SQL                                                 11460009
114700            OPEN  MDSEAR-LIST                                     11470009
114800         END-EXEC                                                 11480009
114900                                                                  11490009
115000         EVALUATE TRUE                                            11500009
115100             WHEN SQLCODE = -904                                  11510009
115200             WHEN SQLCODE = -911                                  11520009
115300             WHEN SQLCODE = +100                                  11530009
115400             WHEN SQLCODE = 0                                     11540009
115500                 CONTINUE                                         11550009
115600             WHEN SQLWARN NOT = SPACES                            11560009
115700             WHEN SQLCODE NOT = ZERO                              11570009
115800                 MOVE '4100-OPEN-CURSOR'                          11580009
115900                               TO  PV-PARAGRAPH-NAME              11590009
116000                 MOVE 'OPEN MDSEAR CURSOR'                        11600009
116100                               TO  PV-DB2-OPER-ATTEMPTED          11610009
116200                 PERFORM 9900-SQL-ABEND                           11620009
116300         END-EVALUATE                                             11630009
116400     END-PERFORM.                                                 11640009
116500                                                                  11650009
116600     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        11660009
116700         MOVE '4100-OPEN-CURSOR'                                  11670009
116800                               TO  PV-PARAGRAPH-NAME              11680009
116900         MOVE 'OPEN CURSOR RETRIES EXCEEDED'                      11690009
117000                               TO  PV-DB2-OPER-ATTEMPTED          11700009
117100         PERFORM 9900-SQL-ABEND                                   11710009
117200     END-IF.                                                      11720009
117300                                                                  11730009
117400 EJECT                                                            11740009
117500****************************************************************  11750009
117600*                                                              *  11760009
117700*    FETCH THE CURSOR AND UPDATE THE ROW.                      *  11770009
117800*                                                              *  11780009
117900****************************************************************  11790009
118000                                                                  11800009
118100 4200-PROCESS-CURSOR.                                             11810009
118200                                                                  11820009
118300     PERFORM 4300-FETCH-CURSOR.                                   11830009
118400                                                                  11840009
118500     IF  SQLCODE EQUAL ZERO                                       11850009
118600         MOVE MDSEAR-STRT-DTE  TO  PV-ORIG-START-DATE             11860009
118700         MOVE MDSEAR-END-DTE   TO  PV-ORIG-END-DATE               11870009
118800                                                                  11880009
118900         IF  MB018-NEW-START-DATE-008 GREATER THAN SPACES         11890009
119000             MOVE MB018-NEW-START-DATE-008                        11900009
119100                               TO  PV-NEW-START-DATE              11910009
119200         ELSE                                                     11920009
119300             MOVE MDSEAR-STRT-DTE                                 11930009
119400                               TO  PV-NEW-START-DATE              11940009
119500         END-IF                                                   11950009
119600                                                                  11960009
119700         IF  MB018-NEW-END-DATE-008 GREATER THAN SPACES           11970009
119800             MOVE MB018-NEW-END-DATE-008                          11980009
119900                               TO  PV-NEW-END-DATE                11990009
120000         ELSE                                                     12000009
120100             MOVE MDSEAR-END-DTE                                  12010009
120200                               TO  PV-NEW-END-DATE                12020009
120300         END-IF                                                   12030009
120400                                                                  12040009
120500         IF  PV-REQUEST-LEVEL NOT EQUAL MDSEAR-MDSELV-CDE         12050009
120600             IF  PV-NEW-START-DATE LESS THAN MDSEAR-STRT-DTE      12060009
120700                 MOVE MDSEAR-STRT-DTE                             12070009
120800                               TO  PV-NEW-START-DATE              12080009
120900             END-IF                                               12090009
121000                                                                  12100009
121100             IF  PV-NEW-END-DATE GREATER THAN MDSEAR-END-DTE      12110009
121200                 MOVE MDSEAR-END-DTE                              12120009
121300                               TO  PV-NEW-END-DATE                12130009
121400             END-IF                                               12140009
121500         END-IF                                                   12150009
121600                                                                  12160009
121700         IF (PV-NEW-END-DATE NOT EQUAL MDSEAR-END-DTE             12170009
121800         OR  PV-NEW-START-DATE NOT EQUAL MDSEAR-STRT-DTE)         12180009
121900             PERFORM 4700-UPDATE-CURRENT-ROW                      12190009
122000             PERFORM 5100-PROCESS-APLAVL                          12200009
122100             PERFORM 5200-PROCESS-RSPBAR                          12210009
122200         END-IF                                                   12220009
122300                                                                  12230009
122400     END-IF.                                                      12240009
122500                                                                  12250009
122600 EJECT                                                            12260009
122700****************************************************************  12270009
122800*                                                              *  12280009
122900*    FETCH THE MERCHANDISE LIST CURSOR.                        *  12290009
123000*                                                              *  12300009
123100****************************************************************  12310009
123200                                                                  12320009
123300 4300-FETCH-CURSOR.                                               12330009
123400                                                                  12340009
123500     PERFORM                                                      12350009
123600         WITH TEST AFTER                                          12360009
123700         VARYING PV-SQL-SUB                                       12370009
123800         FROM 1 BY 1                                              12380009
123900         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       12390009
124000                   OR SQLCODE = 0                                 12400009
124100                   OR SQLCODE = +100)                             12410009
124200                                                                  12420009
124300         EXEC SQL                                                 12430009
124400            FETCH                                                 12440009
124500                  MDSEAR-LIST                                     12450009
124600             INTO                                                 12460009
124700                         :MDSEAR-MDSELV-CDE                       12470009
124800                      ,  :MDSEAR-DKEY                             12480009
124900                      ,  :MDSEAR-CHG-DTE                          12490009
125000                      ,  :MDSEAR-STRT-DTE                         12500009
125100                      ,  :MDSEAR-END-DTE                          12510009
125200                      ,  :MDSEAR-LIST-SEQ-NBR                     12520009
125300         END-EXEC                                                 12530009
125400                                                                  12540009
125500         EVALUATE TRUE                                            12550009
125600             WHEN SQLCODE = -904                                  12560009
125700             WHEN SQLCODE = -911                                  12570009
125800             WHEN SQLCODE = +100                                  12580009
125900             WHEN SQLCODE = 0                                     12590009
126000                 CONTINUE                                         12600009
126100             WHEN SQLWARN NOT = SPACES                            12610009
126200             WHEN SQLCODE NOT = ZERO                              12620009
126300                 MOVE '4300-FETCH-CURSOR'                         12630009
126400                               TO  PV-PARAGRAPH-NAME              12640009
126500                 MOVE 'FETCH MDSEAR CURSOR'                       12650009
126600                               TO  PV-DB2-OPER-ATTEMPTED          12660009
126700                 PERFORM 9900-SQL-ABEND                           12670009
126800         END-EVALUATE                                             12680009
126900     END-PERFORM.                                                 12690009
127000                                                                  12700009
127100     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        12710009
127200         MOVE '4300-FETCH-CURSOR'                                 12720009
127300                               TO  PV-PARAGRAPH-NAME              12730009
127400         MOVE 'FETCH CURSOR RETRIES EXCEEDED'                     12740009
127500                               TO  PV-DB2-OPER-ATTEMPTED          12750009
127600         PERFORM 9900-SQL-ABEND                                   12760009
127700     END-IF.                                                      12770009
127800                                                                  12780009
127900 EJECT                                                            12790009
128000****************************************************************  12800009
128100*                                                              *  12810009
128200*    CLOSE THE MERCHANDISE LIST CURSOR.                        *  12820009
128300*                                                              *  12830009
128400****************************************************************  12840009
128500                                                                  12850009
128600 4600-CLOSE-CURSOR.                                               12860009
128700                                                                  12870009
128800     PERFORM                                                      12880009
128900         WITH TEST AFTER                                          12890009
129000         VARYING PV-SQL-SUB                                       12900009
129100         FROM 1 BY 1                                              12910009
129200         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       12920009
129300                   OR SQLCODE = 0                                 12930009
129400                   OR SQLCODE = +100)                             12940009
129500                                                                  12950009
129600         EXEC SQL                                                 12960009
129700            CLOSE MDSEAR-LIST                                     12970009
129800         END-EXEC                                                 12980009
129900                                                                  12990009
130000         EVALUATE TRUE                                            13000009
130100             WHEN SQLCODE = -904                                  13010009
130200             WHEN SQLCODE = -911                                  13020009
130300             WHEN SQLCODE = 0                                     13030009
130400                 CONTINUE                                         13040009
130500             WHEN SQLWARN NOT = SPACES                            13050009
130600             WHEN SQLCODE NOT = ZERO                              13060009
130700                 MOVE '4600-CLOSE-CURSOR'                         13070009
130800                               TO  PV-PARAGRAPH-NAME              13080009
130900                 MOVE 'CLOSE MDSEAR CURSOR'                       13090009
131000                               TO  PV-DB2-OPER-ATTEMPTED          13100009
131100                 PERFORM 9900-SQL-ABEND                           13110009
131200         END-EVALUATE                                             13120009
131300     END-PERFORM.                                                 13130009
131400                                                                  13140009
131500     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        13150009
131600         MOVE '4600-CLOSE-CURSOR'                                 13160009
131700                               TO  PV-PARAGRAPH-NAME              13170009
131800         MOVE 'CLOSE CURSOR RETRIES EXCEEDED'                     13180009
131900                               TO  PV-DB2-OPER-ATTEMPTED          13190009
132000         PERFORM 9900-SQL-ABEND                                   13200009
132100     END-IF.                                                      13210009
132200                                                                  13220009
132300 EJECT                                                            13230009
132400****************************************************************  13240009
132500*                                                              *  13250009
132600*    UPDATE THE DATES FOR THE MDSEAR ROW.                      *  13260009
132700*                                                              *  13270009
132800****************************************************************  13280009
132900                                                                  13290009
133000 4700-UPDATE-CURRENT-ROW.                                         13300009
133100                                                                  13310009
133200     PERFORM                                                      13320009
133300         WITH TEST AFTER                                          13330009
133400         VARYING PV-SQL-SUB                                       13340009
133500         FROM 1 BY 1                                              13350009
133600         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       13360009
133700                   OR SQLCODE = 0                                 13370009
133800                   OR SQLCODE = +100)                             13380009
133900                                                                  13390009
134000         EXEC SQL                                                 13400009
134100            UPDATE                                                13410009
134200                   TMDSEAR                                        13420009
134300              SET                                                 13430009
134400                   STRT_DTE     =  :PV-NEW-START-DATE,            13440009
134500                   END_DTE      =  :PV-NEW-END-DATE,              13450009
134600                   CHG_DTE      =  CURRENT DATE                   13460009
134700              WHERE                                               13470009
134800                   LIST_SEQ_NBR =  :MDSEAR-LIST-SEQ-NBR           13480009
134900         END-EXEC                                                 13490009
135000                                                                  13500009
135100         EVALUATE TRUE                                            13510009
135200             WHEN SQLCODE = -904                                  13520009
135300             WHEN SQLCODE = -911                                  13530009
135400             WHEN SQLCODE = 0                                     13540009
135500                 CONTINUE                                         13550009
135600             WHEN SQLWARN NOT = SPACES                            13560009
135700             WHEN SQLCODE NOT = ZERO                              13570009
135800                 MOVE '4700-UPDATE-CURRENT-ROW'                   13580009
135900                               TO  PV-PARAGRAPH-NAME              13590009
136000                 MOVE 'UPDATE CURRENT CURSOR'                     13600009
136100                               TO  PV-DB2-OPER-ATTEMPTED          13610009
136200                 PERFORM 9900-SQL-ABEND                           13620009
136300         END-EVALUATE                                             13630009
136400     END-PERFORM.                                                 13640009
136500                                                                  13650009
136600     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        13660009
136700         MOVE '4700-UPDATE-CURRENT-ROW'                           13670009
136800                               TO  PV-PARAGRAPH-NAME              13680009
136900         MOVE 'UPDATE CURRENT ROW RETRIES EXCEEDED'               13690009
137000                               TO  PV-DB2-OPER-ATTEMPTED          13700009
137100         PERFORM 9900-SQL-ABEND                                   13710009
137200     END-IF.                                                      13720009
137300                                                                  13730009
137400     IF  SQLCODE EQUAL ZERO                                       13740009
137500         ADD 1                 TO  PV-UPDATE-COUNT                13750009
137600         MOVE PV-NEW-START-DATE                                   13760009
137700                               TO  MDSEAR-STRT-DTE                13770009
137800         MOVE PV-NEW-END-DATE  TO  MDSEAR-END-DTE                 13780009
137900     END-IF.                                                      13790009
138000                                                                  13800009
138100 EJECT                                                            13810009
138200****************************************************************  13820009
138300*                                                              *  13830009
138400*    WE ARE DONE PROCESSING THIS CONTROL RECORD.  COMMIT THE   *  13840009
138500*    DB2 CHANGES.                                              *  13850009
138600*                                                              *  13860009
138700****************************************************************  13870009
138800                                                                  13880009
138900 4800-COMMIT.                                                     13890009
139000                                                                  13900009
139100     PERFORM                                                      13910009
139200         WITH TEST AFTER                                          13920009
139300         VARYING PV-SQL-SUB                                       13930009
139400         FROM 1 BY 1                                              13940009
139500         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       13950009
139600                   OR SQLCODE = 0                                 13960009
139700                   OR SQLCODE = +100)                             13970009
139800                                                                  13980009
139900         EXEC SQL                                                 13990009
140000            COMMIT                                                14000009
140100         END-EXEC                                                 14010009
140200                                                                  14020009
140300         EVALUATE TRUE                                            14030009
140400             WHEN SQLCODE = -904                                  14040009
140500             WHEN SQLCODE = -911                                  14050009
140600             WHEN SQLCODE = 0                                     14060009
140700                 CONTINUE                                         14070009
140800             WHEN SQLWARN NOT = SPACES                            14080009
140900             WHEN SQLCODE NOT = ZERO                              14090009
141000                 MOVE '4800-COMMIT'                               14100009
141100                               TO  PV-PARAGRAPH-NAME              14110009
141200                 MOVE 'COMMIT - MDSEAR'                           14120009
141300                               TO  PV-DB2-OPER-ATTEMPTED          14130009
141400                 PERFORM 9900-SQL-ABEND                           14140009
141500         END-EVALUATE                                             14150009
141600     END-PERFORM.                                                 14160009
141700                                                                  14170009
141800     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        14180009
141900         MOVE '4800-COMMIT'                                       14190009
142000                               TO  PV-PARAGRAPH-NAME              14200009
142100         MOVE 'COMMIT RETRIES EXCEEDED'                           14210009
142200                               TO  PV-DB2-OPER-ATTEMPTED          14220009
142300         PERFORM 9900-SQL-ABEND                                   14230009
142400     END-IF.                                                      14240009
142500                                                                  14250009
142600 EJECT                                                            14260009
142700****************************************************************  14270009
142800*                                                              *  14280009
142900*    PROCESS THE APPLICATION AVAILABLE TABLE.                  *  14290009
143000*    OPEN THE CURSOR FIRST, THEN, FOR EACH ROW RETURNED,       *  14300009
143100*    UPDATE THE END DATE AND/OR START DATE.                    *  14310009
143200*                                                              *  14320009
143300*    PERFORMED BY 4200                                         *  14330009
143400****************************************************************  14340009
143500                                                                  14350009
143600 5100-PROCESS-APLAVL.                                             14360009
143700                                                                  14370009
143800     PERFORM 5110-OPEN-APLAVL-CURSOR.                             14380009
143900                                                                  14390009
144000     PERFORM                                                      14400009
144100         UNTIL SQLCODE NOT EQUAL ZERO                             14410009
144200             PERFORM 5120-FETCH-APLAVL-CURSOR                     14420009
144300             IF  SQLCODE EQUAL ZERO                               14430009
144400                                                                  14440009
144500                 IF  MB018-NEW-START-DATE-008 GREATER SPACES      14450009
144600                     MOVE MDSEAR-STRT-DTE                         14460009
144700                               TO  PV-NEW-START-DATE              14470009
144800                 ELSE                                             14480009
144900                     MOVE APLAVL-MDSEAR-STRT-DTE                  14490009
145000                               TO  PV-NEW-START-DATE              14500009
145100                 END-IF                                           14510009
145200                                                                  14520009
145300                 IF  MB018-NEW-END-DATE-008 GREATER SPACES        14530009
145400                     MOVE MDSEAR-END-DTE                          14540009
145500                               TO  PV-NEW-END-DATE                14550009
145600                 ELSE                                             14560009
145700                     MOVE APLAVL-MDSEAR-END-DTE                   14570009
145800                               TO  PV-NEW-END-DATE                14580009
145900                 END-IF                                           14590009
146000                                                                  14600009
146100                 PERFORM 5105-DETERMINE-PROCESS                   14610009
146200             END-IF                                               14620009
146300     END-PERFORM.                                                 14630009
146400                                                                  14640009
146500     PERFORM 5150-CLOSE-APLAVL-CURSOR.                            14650009
146600                                                                  14660009
146700 EJECT                                                            14670009
146800****************************************************************  14680009
146900*                                                              *  14690009
147000*    DETERMINE THE PROCESSING PATH FOR APLAVL ROWS.  BASED     *  14700009
147100*    UPON THE COMBINATION OF NEW START/END AND THE CURRENT     *  14710009
147200*    START/END DATES, DELETE UPDATE, OR IGNORE THE ROW.        *  14720009
147300*                                                              *  14730009
147400*    NEW START DATE GREATER CURRENT END DATE    -- DELETE.     *  14740009
147500*    CURRENT START DATE GREATER NEW END DATE    -- DELETE.     *  14750009
147600*    NEW END DATE LESS THAN CURRENT END DATE    -- UPDATE.     *  14760009
147700*    NEW START DATE GREATER CURRENT START DATE  -- UPDATE.     *  14770009
147800*    NO CHANGED TO EITHER DATE                  -- IGNORE.     *  14780009
147900*                                                              *  14790009
148000*    PERFORMED BY 5100                                         *  14800009
148100****************************************************************  14810009
148200                                                                  14820009
148300 5105-DETERMINE-PROCESS.                                          14830009
148400                                                                  14840009
148500     EVALUATE TRUE                                                14850009
148600                                                                  14860009
148700         WHEN MDSEAR-MDSELV-CDE EQUAL PC-GMA                      14870009
148800              MOVE PV-LAST-CO-DKEY                                14880009
148900                               TO  PV-APLAVL-DKEY                 14890009
149000                                                                  14900009
149100         WHEN MDSEAR-MDSELV-CDE EQUAL PC-DMA                      14910009
149200              MOVE PV-LAST-GMA-DKEY                               14920009
149300                               TO  PV-APLAVL-DKEY                 14930009
149400                                                                  14940009
149500         WHEN MDSEAR-MDSELV-CDE EQUAL PC-DPT                      14950009
149600              MOVE PV-LAST-DMA-DKEY                               14960009
149700                               TO  PV-APLAVL-DKEY                 14970009
149800                                                                  14980009
149900         WHEN MDSEAR-MDSELV-CDE EQUAL PC-MCL                      14990009
150000              MOVE PV-LAST-DPT-DKEY                               15000009
150100                               TO  PV-APLAVL-DKEY                 15010009
150200                                                                  15020009
150300         WHEN MDSEAR-MDSELV-CDE EQUAL PC-SCL                      15030009
150400              MOVE PV-LAST-MCL-DKEY                               15040009
150500                               TO  PV-APLAVL-DKEY                 15050009
150600     END-EVALUATE.                                                15060009
150700                                                                  15070009
150800*    PERFORM 5160-OBTAIN-APLAVL-PARENT.                           15080009
150900                                                                  15090009
151000     IF (APLAVL-MDSEAR-STRT-DTE GREATER THAN PV-NEW-END-DATE      15100009
151100     OR  APLAVL-MDSEAR-END-DTE LESS THAN PV-NEW-START-DATE)       15110009
151200         PERFORM 5135-DELETE-APLAVL                               15120009
151300     ELSE                                                         15130009
151400         IF  PV-NEW-START-DATE LESS THAN                          15140009
151500                               APLAVL-MDSEAR-STRT-DTE             15150009
151600             MOVE APLAVL-MDSEAR-STRT-DTE                          15160009
151700                               TO  PV-NEW-START-DATE              15170009
151800         END-IF                                                   15180009
151900                                                                  15190009
152000         IF  PV-NEW-END-DATE GREATER THAN                         15200009
152100                               APLAVL-MDSEAR-END-DTE              15210009
152200             MOVE APLAVL-MDSEAR-END-DTE                           15220009
152300                               TO  PV-NEW-END-DATE                15230009
152400         END-IF                                                   15240009
152500                                                                  15250009
152600         IF (PV-NEW-END-DATE NOT EQUAL APLAVL-MDSEAR-END-DTE      15260009
152700         OR  PV-NEW-START-DATE NOT EQUAL APLAVL-MDSEAR-STRT-DTE)  15270009
152800             PERFORM 5130-UPDATE-APLAVL                           15280009
152900         END-IF                                                   15290009
153000     END-IF.                                                      15300009
153100                                                                  15310009
153200 EJECT                                                            15320009
153300****************************************************************  15330009
153400*                                                              *  15340009
153500*    OPEN THE APPLICATION AVAILABILITY CURSOR.                 *  15350009
153600*                                                              *  15360009
153700****************************************************************  15370009
153800                                                                  15380009
153900 5110-OPEN-APLAVL-CURSOR.                                         15390009
154000                                                                  15400009
154100     PERFORM                                                      15410009
154200         WITH TEST AFTER                                          15420009
154300         VARYING PV-SQL-SUB                                       15430009
154400         FROM 1 BY 1                                              15440009
154500         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       15450009
154600                   OR SQLCODE = 0                                 15460009
154700                   OR SQLCODE = +100)                             15470009
154800                                                                  15480009
154900         EXEC SQL                                                 15490009
155000            OPEN APLAVL-LIST                                      15500009
155100         END-EXEC                                                 15510009
155200                                                                  15520009
155300         EVALUATE TRUE                                            15530009
155400             WHEN SQLCODE = -904                                  15540009
155500             WHEN SQLCODE = -911                                  15550009
155600             WHEN SQLCODE = +100                                  15560009
155700             WHEN SQLCODE = 0                                     15570009
155800                 CONTINUE                                         15580009
155900             WHEN SQLWARN NOT = SPACES                            15590009
156000             WHEN SQLCODE NOT = ZERO                              15600009
156100                 MOVE '5110-OPEN-APLAVL'                          15610009
156200                               TO  PV-PARAGRAPH-NAME              15620009
156300                 MOVE 'OPEN APLAVL CURSOR'                        15630009
156400                               TO  PV-DB2-OPER-ATTEMPTED          15640009
156500                 PERFORM 9900-SQL-ABEND                           15650009
156600         END-EVALUATE                                             15660009
156700     END-PERFORM.                                                 15670009
156800                                                                  15680009
156900     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        15690009
157000         MOVE '5110-OPEN-APLAVL-CURSOR'                           15700009
157100                               TO  PV-PARAGRAPH-NAME              15710009
157200         MOVE 'OPEN CURSOR RETRIES EXCEEDED'                      15720009
157300                               TO  PV-DB2-OPER-ATTEMPTED          15730009
157400         PERFORM 9900-SQL-ABEND                                   15740009
157500     END-IF.                                                      15750009
157600                                                                  15760009
157700 EJECT                                                            15770009
157800****************************************************************  15780009
157900*                                                              *  15790009
158000*    FETCH THE APPLICATION AVAILABILITY CURSOR.                *  15800009
158100*                                                              *  15810009
158200****************************************************************  15820009
158300                                                                  15830009
158400 5120-FETCH-APLAVL-CURSOR.                                        15840009
158500                                                                  15850009
158600     PERFORM                                                      15860009
158700         WITH TEST AFTER                                          15870009
158800         VARYING PV-SQL-SUB                                       15880009
158900         FROM 1 BY 1                                              15890009
159000         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       15900009
159100                   OR SQLCODE = 0                                 15910009
159200                   OR SQLCODE = +100)                             15920009
159300                                                                  15930009
159400         EXEC SQL                                                 15940009
159500            FETCH                                                 15950009
159600                  APLAVL-LIST                                     15960009
159700             INTO                                                 15970009
159800                         :APLAVL-MDSEAR-STRT-DTE                  15980009
159900                      ,  :APLAVL-MDSEAR-END-DTE                   15990009
160000         END-EXEC                                                 16000009
160100                                                                  16010009
160200         EVALUATE TRUE                                            16020009
160300             WHEN SQLCODE = -904                                  16030009
160400             WHEN SQLCODE = -911                                  16040009
160500             WHEN SQLCODE = +100                                  16050009
160600             WHEN SQLCODE = 0                                     16060009
160700                 CONTINUE                                         16070009
160800             WHEN SQLWARN NOT = SPACES                            16080009
160900             WHEN SQLCODE NOT = ZERO                              16090009
161000                 MOVE '5120-FETCH-APLAVL-CURSOR'                  16100009
161100                               TO  PV-PARAGRAPH-NAME              16110009
161200                 MOVE 'FETCH APLAVL CURSOR'                       16120009
161300                               TO  PV-DB2-OPER-ATTEMPTED          16130009
161400                 PERFORM 9900-SQL-ABEND                           16140009
161500         END-EVALUATE                                             16150009
161600     END-PERFORM.                                                 16160009
161700                                                                  16170009
161800     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        16180009
161900         MOVE '5120-FETCH-APLAVL-CURSOR'                          16190009
162000                               TO  PV-PARAGRAPH-NAME              16200009
162100         MOVE 'FETCH CURSOR RETRIES EXCEEDED'                     16210009
162200                               TO  PV-DB2-OPER-ATTEMPTED          16220009
162300         PERFORM 9900-SQL-ABEND                                   16230009
162400     END-IF.                                                      16240009
162500                                                                  16250009
162600 EJECT                                                            16260009
162700****************************************************************  16270009
162800*                                                              *  16280009
162900*    UPDATE THE START AND/OR END DATE FOR THE APLAVL ROW.      *  16290009
163000*                                                              *  16300009
163100****************************************************************  16310009
163200                                                                  16320009
163300 5130-UPDATE-APLAVL.                                              16330009
163400                                                                  16340009
163500     PERFORM                                                      16350009
163600         WITH TEST AFTER                                          16360009
163700         VARYING PV-SQL-SUB                                       16370009
163800         FROM 1 BY 1                                              16380009
163900         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       16390009
164000                   OR SQLCODE = 0                                 16400009
164100                   OR SQLCODE = +100)                             16410009
164200                                                                  16420009
164300         EXEC SQL                                                 16430009
164400            UPDATE                                                16440009
164500                   TAPLAVL                                        16450009
164600              SET                                                 16460009
164700                   MDSEAR_STRT_DTE =  :PV-NEW-START-DATE,         16470009
164800                   MDSEAR_END_DTE  =  :PV-NEW-END-DATE            16480009
164900              WHERE                                               16490009
165000                   CURRENT OF APLAVL-LIST                         16500009
165100         END-EXEC                                                 16510009
165200                                                                  16520009
165300         EVALUATE TRUE                                            16530009
165400             WHEN SQLCODE = -904                                  16540009
165500             WHEN SQLCODE = -911                                  16550009
165600             WHEN SQLCODE = 0                                     16560009
165700                 CONTINUE                                         16570009
165800             WHEN SQLWARN NOT = SPACES                            16580009
165900             WHEN SQLCODE NOT = ZERO                              16590009
166000                 MOVE '5130-UPDATE-APLAVL'                        16600009
166100                               TO  PV-PARAGRAPH-NAME              16610009
166200                 MOVE 'UPDATE APLAVL  CURSOR'                     16620009
166300                               TO  PV-DB2-OPER-ATTEMPTED          16630009
166400                 PERFORM 9900-SQL-ABEND                           16640009
166500         END-EVALUATE                                             16650009
166600     END-PERFORM.                                                 16660009
166700                                                                  16670009
166800     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        16680009
166900         MOVE '5130-UPDATE-APLAVL'                                16690009
167000                               TO  PV-PARAGRAPH-NAME              16700009
167100         MOVE 'UPDATE APLAVL  ROW RETRIES EXCEEDED'               16710009
167200                               TO  PV-DB2-OPER-ATTEMPTED          16720009
167300         PERFORM 9900-SQL-ABEND                                   16730009
167400     END-IF.                                                      16740009
167500                                                                  16750009
167600     ADD 1                     TO  PV-UPDATE-APLAVL-COUNT.        16760009
167700                                                                  16770009
167800 EJECT                                                            16780009
167900****************************************************************  16790009
168000*                                                              *  16800009
168100*    DELETE THE CURRENT ROW.                                   *  16810009
168200*                                                              *  16820009
168300****************************************************************  16830009
168400                                                                  16840009
168500 5135-DELETE-APLAVL.                                              16850009
168600                                                                  16860009
168700     PERFORM                                                      16870009
168800         WITH TEST AFTER                                          16880009
168900         VARYING PV-SQL-SUB                                       16890009
169000         FROM 1 BY 1                                              16900009
169100         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       16910009
169200                   OR SQLCODE = 0                                 16920009
169300                   OR SQLCODE = +100)                             16930009
169400                                                                  16940009
169500         EXEC SQL                                                 16950009
169600            DELETE                                                16960009
169700              FROM                                                16970009
169800                   TAPLAVL                                        16980009
169900              WHERE                                               16990009
170000                   CURRENT OF APLAVL-LIST                         17000009
170100         END-EXEC                                                 17010009
170200                                                                  17020009
170300         EVALUATE TRUE                                            17030009
170400             WHEN SQLCODE = -904                                  17040009
170500             WHEN SQLCODE = -911                                  17050009
170600             WHEN SQLCODE = 0                                     17060009
170700                 CONTINUE                                         17070009
170800             WHEN SQLWARN NOT = SPACES                            17080009
170900             WHEN SQLCODE NOT = ZERO                              17090009
171000                 MOVE '5135-DELETE-APLAVL'                        17100009
171100                               TO  PV-PARAGRAPH-NAME              17110009
171200                 MOVE 'DELETE CURRENT APLAVL'                     17120009
171300                               TO  PV-DB2-OPER-ATTEMPTED          17130009
171400                 PERFORM 9900-SQL-ABEND                           17140009
171500         END-EVALUATE                                             17150009
171600     END-PERFORM.                                                 17160009
171700                                                                  17170009
171800     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        17180009
171900         MOVE '5135-DELETE-APLAVL'                                17190009
172000                               TO  PV-PARAGRAPH-NAME              17200009
172100         MOVE 'DELETE CURRENT APLAVL RETRIES EXCEEDED'            17210009
172200                               TO  PV-DB2-OPER-ATTEMPTED          17220009
172300         PERFORM 9900-SQL-ABEND                                   17230009
172400     END-IF.                                                      17240009
172500                                                                  17250009
172600     DISPLAY '* TAPLAVL DELETED -' DCLTAPLAVL.                    17260009
172700     ADD 1                     TO  PV-DELETE-APLAVL-COUNT.        17270009
172800                                                                  17280009
172900 EJECT                                                            17290009
173000****************************************************************  17300009
173100*                                                              *  17310009
173200*    CLOSE THE APLAVL LIST CURSOR.                             *  17320009
173300*                                                              *  17330009
173400****************************************************************  17340009
173500                                                                  17350009
173600 5150-CLOSE-APLAVL-CURSOR.                                        17360009
173700                                                                  17370009
173800     PERFORM                                                      17380009
173900         WITH TEST AFTER                                          17390009
174000         VARYING PV-SQL-SUB                                       17400009
174100         FROM 1 BY 1                                              17410009
174200         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       17420009
174300                   OR SQLCODE = 0                                 17430009
174400                   OR SQLCODE = +100)                             17440009
174500                                                                  17450009
174600         EXEC SQL                                                 17460009
174700            CLOSE APLAVL-LIST                                     17470009
174800         END-EXEC                                                 17480009
174900                                                                  17490009
175000         EVALUATE TRUE                                            17500009
175100             WHEN SQLCODE = -904                                  17510009
175200             WHEN SQLCODE = -911                                  17520009
175300             WHEN SQLCODE = 0                                     17530009
175400                 CONTINUE                                         17540009
175500             WHEN SQLWARN NOT = SPACES                            17550009
175600             WHEN SQLCODE NOT = ZERO                              17560009
175700                 MOVE '5150-CLOSE-APLAVL-CURSOR'                  17570009
175800                               TO  PV-PARAGRAPH-NAME              17580009
175900                 MOVE 'CLOSE APLAVL CURSOR'                       17590009
176000                               TO  PV-DB2-OPER-ATTEMPTED          17600009
176100                 PERFORM 9900-SQL-ABEND                           17610009
176200         END-EVALUATE                                             17620009
176300     END-PERFORM.                                                 17630009
176400                                                                  17640009
176500     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        17650009
176600         MOVE '5150-CLOSE-APLAVL-CURSOR'                          17660009
176700                               TO  PV-PARAGRAPH-NAME              17670009
176800         MOVE 'CLOSE APLAVL CURSOR RETRIES EXCEEDED'              17680009
176900                               TO  PV-DB2-OPER-ATTEMPTED          17690009
177000         PERFORM 9900-SQL-ABEND                                   17700009
177100     END-IF.                                                      17710009
177200                                                                  17720009
177300 EJECT                                                            17730009
177400****************************************************************  17740009
177500*                                                              *  17750009
177600*    OBTAIN THE PARENT DATES FOR THE ROW BEING PROCESSED.      *  17760009
177700*                                                              *  17770009
177800****************************************************************  17780009
177900*                                                                 17790009
178000*5160-OBTAIN-APLAVL-PARENT.                                       17800009
178100*                                                                 17810009
178200*    PERFORM                                                      17820009
178300*        WITH TEST AFTER                                          17830009
178400*        VARYING PV-SQL-SUB                                       17840009
178500*        FROM 1 BY 1                                              17850009
178600*        UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       17860009
178700*                  OR SQLCODE = 0                                 17870009
178800*                  OR SQLCODE = +100)                             17880009
178900*                                                                 17890009
179000*        EXEC SQL                                                 17900009
179100*             SELECT                                              17910009
179200*                    MDSEAR_STRT_DTE                              17920009
179300*                  , MDSEAR_END_DTE                               17930009
179400*             INTO                                                17940009
179500*                    PV-APLAVL-START-DATE                         17950009
179600*                  , PV-APLAVL-END-DATE                           17960009
179700*             FROM                                                17970009
179800*                    TAPLAVL                                      17980009
179900*             WHERE                                               17990009
180000*                    OPERCO_NBR     =  :MB018-OPERATING-CO-008    18000009
180100*               AND  MDSEAR_DKEY    =  :PV-APLAVL-DKEY            18010009
180200*               AND  APLSYS_CDE     =  :APLAVL-APLSYS-CDE         18020009
180300*        END-EXEC                                                 18030009
180400*                                                                 18040009
180500*        EVALUATE TRUE                                            18050009
180600*            WHEN SQLCODE = -904                                  18060009
180700*            WHEN SQLCODE = -911                                  18070009
180800*            WHEN SQLCODE = +100                                  18080009
180900*            WHEN SQLCODE = 0                                     18090009
181000*                CONTINUE                                         18100009
181100*            WHEN SQLWARN NOT = SPACES                            18110009
181200*            WHEN SQLCODE NOT = ZERO                              18120009
181300*                MOVE '5160-OBTAIN-APLAVL-PARENT'                 18130009
181400*                              TO  PV-PARAGRAPH-NAME              18140009
181500*                MOVE 'SELECT APLAVL'                             18150009
181600*                              TO  PV-DB2-OPER-ATTEMPTED          18160009
181700*                PERFORM 9900-SQL-ABEND                           18170009
181800*        END-EVALUATE                                             18180009
181900*    END-PERFORM.                                                 18190009
182000*                                                                 18200009
182100*    IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        18210009
182200*        MOVE '5160-OBTAIN-APLAVL-PARENT'                         18220009
182300*                              TO  PV-PARAGRAPH-NAME              18230009
182400*        MOVE 'SELECT APLAVL - PARENT'                            18240009
182500*                              TO  PV-DB2-OPER-ATTEMPTED          18250009
182600*        PERFORM 9900-SQL-ABEND                                   18260009
182700*    END-IF.                                                      18270009
182800*                                                                 18280009
182900*    IF  SQLCODE = +100                                           18290009
183000*        MOVE MDSEAR-STRT-DTE  TO  PV-APLAVL-START-DATE           18300009
183100*        MOVE MDSEAR-END-DTE   TO  PV-APLAVL-END-DATE             18310009
183200*    END-IF.                                                      18320009
183300                                                                  18330009
183400 EJECT                                                            18340009
183500****************************************************************  18350009
183600*                                                              *  18360009
183700*    PROCESS THE RESPONSIBILITY AREA TABLE.                    *  18370009
183800*    OPEN THE CURSOR FIRST, THEN, FOR EACH ROW RETURNED,       *  18380009
183900*    IGNORE OR DELETE IT, OR UPDATE THE START AND/OR END       *  18390009
184000*    DATES.                                                    *  18400009
184100*                                                              *  18410009
184200*    PERFORMED BY 4200                                         *  18420009
184300****************************************************************  18430009
184400                                                                  18440009
184500 5200-PROCESS-RSPBAR.                                             18450009
184600                                                                  18460009
184700     PERFORM 5210-OPEN-RSPBAR-CURSOR.                             18470009
184800     PERFORM                                                      18480009
184900         UNTIL SQLCODE NOT EQUAL ZERO                             18490009
185000             PERFORM 5220-FETCH-RSPBAR-CURSOR                     18500009
185100             IF  SQLCODE EQUAL ZERO                               18510009
185200                                                                  18520009
185300                 IF  MB018-NEW-START-DATE-008 GREATER SPACES      18530009
185400                     MOVE MDSEAR-STRT-DTE                         18540009
185500                               TO  PV-NEW-START-DATE              18550009
185600                 ELSE                                             18560009
185700                     MOVE RSPBAR-WORKER-STRT-DTE                  18570009
185800                               TO  PV-NEW-START-DATE              18580009
185900                 END-IF                                           18590009
186000                                                                  18600009
186100                 IF  MB018-NEW-END-DATE-008 GREATER SPACES        18610009
186200                     MOVE MDSEAR-END-DTE                          18620009
186300                               TO  PV-NEW-END-DATE                18630009
186400                 ELSE                                             18640009
186500                     MOVE RSPBAR-WORKER-END-DTE                   18650009
186600                               TO  PV-NEW-END-DATE                18660009
186700                 END-IF                                           18670009
186800                                                                  18680009
186900                 IF (RSPBAR-WORKER-STRT-DTE GREATER THAN          18690009
187000                               PV-NEW-END-DATE                    18700009
187100                 OR  RSPBAR-WORKER-END-DTE LESS THAN              18710009
187200                               PV-NEW-START-DATE)                 18720009
187300                     PERFORM 5235-DELETE-RSPBAR                   18730009
187400                     DISPLAY '* TRSPBAR DELETED -'                18740009
187500                             DCLTRSPBAR                           18750009
187600                     ADD 1     TO  PV-DELETE-RSPBAR-COUNT         18760009
187700                                                                  18770009
187800                 ELSE                                             18780009
187900                                                                  18790009
188000                     IF (PV-NEW-START-DATE LESS THAN              18800009
188100                               RSPBAR-WORKER-STRT-DTE             18810009
188200                     AND RSPBAR-WORKER-STRT-DTE EQUAL             18820009
188300                               PV-ORIG-START-DATE)                18830009
188400                     OR  RSPBAR-WORKER-STRT-DTE LESS THAN         18840009
188500                               PV-NEW-START-DATE                  18850009
188600                         CONTINUE                                 18860009
188700                     ELSE                                         18870009
188800                         MOVE RSPBAR-WORKER-STRT-DTE              18880009
188900                               TO  PV-NEW-START-DATE              18890009
189000                     END-IF                                       18900009
189100                                                                  18910009
189200                     IF (PV-NEW-END-DATE GREATER THAN             18920009
189300                               RSPBAR-WORKER-END-DTE              18930009
189400                     AND RSPBAR-WORKER-END-DTE EQUAL              18940009
189500                               PV-ORIG-END-DATE)                  18950009
189600                     OR  RSPBAR-WORKER-END-DTE GREATER THAN       18960009
189700                               PV-NEW-END-DATE                    18970009
189800                         CONTINUE                                 18980009
189900                     ELSE                                         18990009
190000                         MOVE RSPBAR-WORKER-END-DTE               19000009
190100                               TO  PV-NEW-END-DATE                19010009
190200                     END-IF                                       19020009
190300                                                                  19030009
190400                                                                  19040009
190500                     IF (PV-NEW-END-DATE NOT EQUAL                19050009
190600                               RSPBAR-WORKER-END-DTE              19060009
190700                     OR  PV-NEW-START-DATE NOT EQUAL              19070009
190800                               RSPBAR-WORKER-STRT-DTE)            19080009
190900                                                                  19090009
191000                         IF  PV-NEW-START-DATE EQUAL              19100009
191100                               RSPBAR-WORKER-STRT-DTE             19110009
191200                             PERFORM 5225-UPDATE-END-DATE         19120009
191300                         ELSE                                     19130009
191400                             PERFORM 5235-DELETE-RSPBAR           19140009
191500                             PERFORM 5230-INSERT-RSPBAR           19150009
191600                         END-IF                                   19160009
191700                     END-IF                                       19170009
191800                 END-IF                                           19180009
191900             END-IF                                               19190009
192000     END-PERFORM.                                                 19200009
192100     PERFORM 5250-CLOSE-RSPBAR-CURSOR.                            19210009
192200                                                                  19220009
192300 EJECT                                                            19230009
192400****************************************************************  19240009
192500*                                                              *  19250009
192600*    OPEN THE RESPONSIBILITY AREA CURSOR.                      *  19260009
192700*                                                              *  19270009
192800****************************************************************  19280009
192900                                                                  19290009
193000 5210-OPEN-RSPBAR-CURSOR.                                         19300009
193100                                                                  19310009
193200     PERFORM                                                      19320009
193300         WITH TEST AFTER                                          19330009
193400         VARYING PV-SQL-SUB                                       19340009
193500         FROM 1 BY 1                                              19350009
193600         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       19360009
193700                   OR SQLCODE = 0                                 19370009
193800                   OR SQLCODE = +100)                             19380009
193900                                                                  19390009
194000         EXEC SQL                                                 19400009
194100            OPEN RSPBAR-LIST                                      19410009
194200         END-EXEC                                                 19420009
194300                                                                  19430009
194400         EVALUATE TRUE                                            19440009
194500             WHEN SQLCODE = -904                                  19450009
194600             WHEN SQLCODE = -911                                  19460009
194700             WHEN SQLCODE = +100                                  19470009
194800             WHEN SQLCODE = 0                                     19480009
194900                 CONTINUE                                         19490009
195000             WHEN SQLWARN NOT = SPACES                            19500009
195100             WHEN SQLCODE NOT = ZERO                              19510009
195200                 MOVE '5210-OPEN-RSPBAR'                          19520009
195300                               TO  PV-PARAGRAPH-NAME              19530009
195400                 MOVE 'OPEN RSPBAR CURSOR'                        19540009
195500                               TO  PV-DB2-OPER-ATTEMPTED          19550009
195600                 PERFORM 9900-SQL-ABEND                           19560009
195700         END-EVALUATE                                             19570009
195800     END-PERFORM.                                                 19580009
195900                                                                  19590009
196000     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        19600009
196100         MOVE '5210-OPEN-RSPBAR-CURSOR'                           19610009
196200                               TO  PV-PARAGRAPH-NAME              19620009
196300         MOVE 'OPEN CURSOR RETRIES EXCEEDED'                      19630009
196400                               TO  PV-DB2-OPER-ATTEMPTED          19640009
196500         PERFORM 9900-SQL-ABEND                                   19650009
196600     END-IF.                                                      19660009
196700                                                                  19670009
196800 EJECT                                                            19680009
196900****************************************************************  19690009
197000*                                                              *  19700009
197100*    FETCH THE RESPONSIBILITY AREA CURSOR.                     *  19710009
197200*                                                              *  19720009
197300****************************************************************  19730009
197400                                                                  19740009
197500 5220-FETCH-RSPBAR-CURSOR.                                        19750009
197600                                                                  19760009
197700     PERFORM                                                      19770009
197800         WITH TEST AFTER                                          19780009
197900         VARYING PV-SQL-SUB                                       19790009
198000         FROM 1 BY 1                                              19800009
198100         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       19810009
198200                   OR SQLCODE = 0                                 19820009
198300                   OR SQLCODE = +100)                             19830009
198400                                                                  19840009
198500         EXEC SQL                                                 19850009
198600            FETCH                                                 19860009
198700                  RSPBAR-LIST                                     19870009
198800             INTO                                                 19880009
198900                         :RSPBAR-MDSEAR-DKEY                      19890009
199000                      ,  :RSPBAR-WORKER-NBR                       19900009
199100                      ,  :RSPBAR-RSPLVL-CDE                       19910009
199200                      ,  :RSPBAR-WORKER-STRT-DTE                  19920009
199300                      ,  :RSPBAR-WORKER-END-DTE                   19930009
199400                      ,  :RSPBAR-WORKER-FIR-NAME                  19940009
199500                      ,  :RSPBAR-WORKER-LAST-NAME                 19950009
199600                      ,  :RSPBAR-OPERCO-NBR                       19960009
199700         END-EXEC                                                 19970009
199800                                                                  19980009
199900         EVALUATE TRUE                                            19990009
200000             WHEN SQLCODE = -904                                  20000009
200100             WHEN SQLCODE = -911                                  20010009
200200             WHEN SQLCODE = +100                                  20020009
200300             WHEN SQLCODE = 0                                     20030009
200400                 CONTINUE                                         20040009
200500             WHEN SQLWARN NOT = SPACES                            20050009
200600             WHEN SQLCODE NOT = ZERO                              20060009
200700                 MOVE '5220-FETCH-RSPBAR-CURSOR'                  20070009
200800                               TO  PV-PARAGRAPH-NAME              20080009
200900                 MOVE 'FETCH RSPBAR CURSOR'                       20090009
201000                               TO  PV-DB2-OPER-ATTEMPTED          20100009
201100                 PERFORM 9900-SQL-ABEND                           20110009
201200         END-EVALUATE                                             20120009
201300     END-PERFORM.                                                 20130009
201400                                                                  20140009
201500     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        20150009
201600         MOVE '5220-FETCH-RSPBAR-CURSOR'                          20160009
201700                               TO  PV-PARAGRAPH-NAME              20170009
201800         MOVE 'FETCH RSPBAR CURSOR RETRIES EXCEEDED'              20180009
201900                               TO  PV-DB2-OPER-ATTEMPTED          20190009
202000         PERFORM 9900-SQL-ABEND                                   20200009
202100     END-IF.                                                      20210009
202200                                                                  20220009
202300 EJECT                                                            20230009
202400****************************************************************  20240009
202500*                                                              *  20250009
202600*    UPDATE THE END DATE FOR THE RSPBAR ROW.                   *  20260009
202700*                                                              *  20270009
202800****************************************************************  20280009
202900                                                                  20290009
203000 5225-UPDATE-END-DATE.                                            20300009
203100                                                                  20310009
203200     PERFORM                                                      20320009
203300         WITH TEST AFTER                                          20330009
203400         VARYING PV-SQL-SUB                                       20340009
203500         FROM 1 BY 1                                              20350009
203600         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       20360009
203700                   OR SQLCODE = 0                                 20370009
203800                   OR SQLCODE = +100)                             20380009
203900                                                                  20390009
204000         EXEC SQL                                                 20400009
204100            UPDATE                                                20410009
204200                   TRSPBAR                                        20420009
204300              SET                                                 20430009
204400                   WORKER_END_DTE  =  :PV-NEW-END-DATE            20440009
204500              WHERE                                               20450009
204600                   MDSEAR_DKEY     =  :RSPBAR-MDSEAR-DKEY         20460009
204700               AND WORKER_NBR      =  :RSPBAR-WORKER-NBR          20470009
204800               AND RSPLVL_CDE      =  :RSPBAR-RSPLVL-CDE          20480009
204900               AND WORKER_STRT_DTE =  :RSPBAR-WORKER-STRT-DTE     20490009
205000         END-EXEC                                                 20500009
205100                                                                  20510009
205200         EVALUATE TRUE                                            20520009
205300             WHEN SQLCODE = -904                                  20530009
205400             WHEN SQLCODE = -911                                  20540009
205500             WHEN SQLCODE = 0                                     20550009
205600                 CONTINUE                                         20560009
205700             WHEN SQLWARN NOT = SPACES                            20570009
205800             WHEN SQLCODE NOT = ZERO                              20580009
205900                 MOVE '5225-UPDATE-END-DATE'                      20590009
206000                               TO  PV-PARAGRAPH-NAME              20600009
206100                 MOVE 'UPDATE RSPBAR END DATE'                    20610009
206200                               TO  PV-DB2-OPER-ATTEMPTED          20620009
206300                 PERFORM 9900-SQL-ABEND                           20630009
206400         END-EVALUATE                                             20640009
206500     END-PERFORM.                                                 20650009
206600                                                                  20660009
206700     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        20670009
206800         MOVE '5225-UPDATE-END-DATE'                              20680009
206900                               TO  PV-PARAGRAPH-NAME              20690009
207000         MOVE 'UPDATE RSPBAR END DATE RETRIES EXCEEDED'           20700009
207100                               TO  PV-DB2-OPER-ATTEMPTED          20710009
207200         PERFORM 9900-SQL-ABEND                                   20720009
207300     END-IF.                                                      20730009
207400                                                                  20740009
207500     ADD 1                     TO  PV-UPDATE-RSPBAR-COUNT.        20750009
207600                                                                  20760009
207700 EJECT                                                            20770009
207800****************************************************************  20780009
207900*                                                              *  20790009
208000*    TO UPDATE THE START DATE, WE FIRST DELETED THE CURRENT    *  20800009
208100*    ROW, NOW WE MUST INSERT IT.  THIS IS BECAUSE THE START    *  20810009
208200*    DATE IS PART OF THE PRIMARY KEY.                          *  20820009
208300*                                                              *  20830009
208400****************************************************************  20840009
208500                                                                  20850009
208600 5230-INSERT-RSPBAR.                                              20860009
208700                                                                  20870009
208800     PERFORM                                                      20880009
208900         WITH TEST AFTER                                          20890009
209000         VARYING PV-SQL-SUB                                       20900009
209100         FROM 1 BY 1                                              20910009
209200         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       20920009
209300                   OR SQLCODE = 0)                                20930009
209400                                                                  20940009
209500         EXEC SQL INSERT                                          20950009
209600              INTO                                                20960009
209700                  TRSPBAR                                         20970009
209800                         (MDSEAR_DKEY                             20980009
209900                      ,   WORKER_NBR                              20990009
210000                      ,   WORKER_STRT_DTE                         21000009
210100                      ,   WORKER_END_DTE                          21010009
210200                      ,   RSPLVL_CDE                              21020009
210300                      ,   WORKER_FIR_NAME                         21030009
210400                      ,   WORKER_LAST_NAME                        21040009
210500                      ,   OPERCO_NBR)                             21050009
210600                 VALUES                                           21060009
210700                        (:RSPBAR-MDSEAR-DKEY                      21070009
210800                      ,  :RSPBAR-WORKER-NBR                       21080009
210900                      ,  :PV-NEW-START-DATE                       21090009
211000                      ,  :PV-NEW-END-DATE                         21100009
211100                      ,  :RSPBAR-RSPLVL-CDE                       21110009
211200                      ,  :RSPBAR-WORKER-FIR-NAME                  21120009
211300                      ,  :RSPBAR-WORKER-LAST-NAME                 21130009
211400                      ,  :RSPBAR-OPERCO-NBR)                      21140009
211500         END-EXEC                                                 21150009
211600                                                                  21160009
211700         EVALUATE TRUE                                            21170009
211800             WHEN SQLCODE = -904                                  21180009
211900             WHEN SQLCODE = -911                                  21190009
212000             WHEN SQLCODE = 0                                     21200009
212100                 CONTINUE                                         21210009
212200             WHEN SQLWARN NOT = SPACES                            21220009
212300             WHEN SQLCODE NOT = ZERO                              21230009
212400                 MOVE '5230-INSERT-RSPBAR'                        21240009
212500                               TO  PV-PARAGRAPH-NAME              21250009
212600                 MOVE 'INSERT RSPBAR-START/END DATES'             21260009
212700                               TO  PV-DB2-OPER-ATTEMPTED          21270009
212800                 PERFORM 9900-SQL-ABEND                           21280009
212900         END-EVALUATE                                             21290009
213000     END-PERFORM.                                                 21300009
213100                                                                  21310009
213200     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        21320009
213300         MOVE '5230-INSERT-RSPBAR'                                21330009
213400                               TO  PV-PARAGRAPH-NAME              21340009
213500         MOVE 'RETRIES EXCEEDED FOR START/END DATE ISRT'          21350009
213600                               TO  PV-DB2-OPER-ATTEMPTED          21360009
213700         PERFORM 9900-SQL-ABEND                                   21370009
213800     END-IF.                                                      21380009
213900                                                                  21390009
214000     ADD 1                     TO  PV-UPDATE-RSPBAR-COUNT.        21400009
214100                                                                  21410009
214200 EJECT                                                            21420009
214300****************************************************************  21430009
214400*                                                              *  21440009
214500*    DELETE THE CURRENT ROW BECAUSE IT IS NOT YET IN EFFECT.   *  21450009
214600*    THE START DATE IS GREATER THAN THE NEW EFFECTIVE DATE.    *  21460009
214700*                                                              *  21470009
214800****************************************************************  21480009
214900                                                                  21490009
215000 5235-DELETE-RSPBAR.                                              21500009
215100                                                                  21510009
215200     PERFORM                                                      21520009
215300         WITH TEST AFTER                                          21530009
215400         VARYING PV-SQL-SUB                                       21540009
215500         FROM 1 BY 1                                              21550009
215600         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       21560009
215700                   OR SQLCODE = 0                                 21570009
215800                   OR SQLCODE = +100)                             21580009
215900                                                                  21590009
216000         EXEC SQL                                                 21600009
216100            DELETE                                                21610009
216200              FROM                                                21620009
216300                   TRSPBAR                                        21630009
216400              WHERE                                               21640009
216500                   CURRENT OF RSPBAR-LIST                         21650009
216600         END-EXEC                                                 21660009
216700                                                                  21670009
216800         EVALUATE TRUE                                            21680009
216900             WHEN SQLCODE = -904                                  21690009
217000             WHEN SQLCODE = -911                                  21700009
217100             WHEN SQLCODE = 0                                     21710009
217200                 CONTINUE                                         21720009
217300             WHEN SQLWARN NOT = SPACES                            21730009
217400             WHEN SQLCODE NOT = ZERO                              21740009
217500                 MOVE '5235-DELETE-RSPBAR'                        21750009
217600                               TO  PV-PARAGRAPH-NAME              21760009
217700                 MOVE 'DELETE CURRENT RSPBAR'                     21770009
217800                               TO  PV-DB2-OPER-ATTEMPTED          21780009
217900                 PERFORM 9900-SQL-ABEND                           21790009
218000         END-EVALUATE                                             21800009
218100     END-PERFORM.                                                 21810009
218200                                                                  21820009
218300     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        21830009
218400         MOVE '5235-DELETE-RSPBAR'                                21840009
218500                               TO  PV-PARAGRAPH-NAME              21850009
218600         MOVE 'DELETE CURRENT RSPBAR RETRIES EXCEEDED'            21860009
218700                               TO  PV-DB2-OPER-ATTEMPTED          21870009
218800         PERFORM 9900-SQL-ABEND                                   21880009
218900     END-IF.                                                      21890009
219000                                                                  21900009
219100 EJECT                                                            21910009
219200****************************************************************  21920009
219300*                                                              *  21930009
219400*    CLOSE THE RSPBAR LIST CURSOR.                             *  21940009
219500*                                                              *  21950009
219600****************************************************************  21960009
219700                                                                  21970009
219800 5250-CLOSE-RSPBAR-CURSOR.                                        21980009
219900                                                                  21990009
220000     PERFORM                                                      22000009
220100         WITH TEST AFTER                                          22010009
220200         VARYING PV-SQL-SUB                                       22020009
220300         FROM 1 BY 1                                              22030009
220400         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       22040009
220500                   OR SQLCODE = 0                                 22050009
220600                   OR SQLCODE = +100)                             22060009
220700                                                                  22070009
220800         EXEC SQL                                                 22080009
220900            CLOSE RSPBAR-LIST                                     22090009
221000         END-EXEC                                                 22100009
221100                                                                  22110009
221200         EVALUATE TRUE                                            22120009
221300             WHEN SQLCODE = -904                                  22130009
221400             WHEN SQLCODE = -911                                  22140009
221500             WHEN SQLCODE = 0                                     22150009
221600                 CONTINUE                                         22160009
221700             WHEN SQLWARN NOT = SPACES                            22170009
221800             WHEN SQLCODE NOT = ZERO                              22180009
221900                 MOVE '5250-CLOSE-RSPBAR-CURSOR'                  22190009
222000                               TO  PV-PARAGRAPH-NAME              22200009
222100                 MOVE 'CLOSE RSPBAR CURSOR'                       22210009
222200                               TO  PV-DB2-OPER-ATTEMPTED          22220009
222300                 PERFORM 9900-SQL-ABEND                           22230009
222400         END-EVALUATE                                             22240009
222500     END-PERFORM.                                                 22250009
222600                                                                  22260009
222700     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        22270009
222800         MOVE '5250-CLOSE-RSPBAR-CURSOR'                          22280009
222900                               TO  PV-PARAGRAPH-NAME              22290009
223000         MOVE 'CLOSE RSPBAR CURSOR RETRIES EXCEEDED'              22300009
223100                               TO  PV-DB2-OPER-ATTEMPTED          22310009
223200         PERFORM 9900-SQL-ABEND                                   22320009
223300     END-IF.                                                      22330009
223400                                                                  22340009
223500 EJECT                                                            22350009
223600****************************************************************  22360009
223700*                                                              *  22370009
223800*    CLOSE THE BATCH CONTROL FILE.                             *  22380009
223900*                                                              *  22390009
224000****************************************************************  22400009
224100*                                                                 22410009
224200 6000-CLOSE-BATCH-CONTROL.                                        22420009
224300*                                                                 22430009
224400     CLOSE BATCH-CONTROL-FILE.                                    22440009
224500*                                                                 22450009
224600     IF  PV-GOOD-STATUS                                           22460009
224700         CONTINUE                                                 22470009
224800     ELSE                                                         22480009
224900         DISPLAY '* * * * * * * * * * * * * * * * *'              22490009
225000         DISPLAY '*    ***MBKUT008 ABEND***       *'              22500009
225100         DISPLAY '*                               *'              22510009
225200         DISPLAY '*   INVALID STATUS ON THE BATCH *'              22520009
225300         DISPLAY '*   CONTROL DATASET - CLOSE     *'              22530009
225400         DISPLAY '*                               *'              22540009
225500         DISPLAY '* STATUS = '                                    22550009
225600                 PV-VSAM-STATUS                                   22560009
225700                 '                  *'                            22570009
225800         DISPLAY '*                               *'              22580009
225900         DISPLAY '* * * * * * * * * * * * * * * * *'              22590009
226000         SET ABEND-4006        TO  TRUE                           22600009
226100         CALL 'ILBOABN0'    USING  ABEND-CODE                     22610009
226200     END-IF.                                                      22620009
226300                                                                  22630009
226400 EJECT                                                            22640009
226500****************************************************************  22650009
226600*                                                              *  22660009
226700*    DISPLAY THE NUMBER OF RECORDS READ/WRITTEN.               *  22670009
226800*                                                              *  22680009
226900****************************************************************  22690009
227000*                                                                 22700009
227100 9000-DISPLAY-TOTALS.                                             22710009
227200*                                                                 22720009
227300     DISPLAY '*'.                                                 22730009
227400     DISPLAY '* * * * * * * * * * * * * * * * * * * * * * * * *'. 22740009
227500     DISPLAY ' '.                                                 22750009
227600     DISPLAY '* * * * * * * * * * * * * * *'.                     22760009
227700     DISPLAY '*                           *'.                     22770009
227800     DISPLAY '*   **MBKUT008 COUNTS**     *'.                     22780009
227900     DISPLAY '* '                                                 22790009
228000             PV-BATCH-CNTL-COUNT                                  22800009
228100             ' RECORDS READ    *'.                                22810009
228200     DISPLAY '* '                                                 22820009
228300             PV-TOT-UPDATES                                       22830009
228400             ' TMDSEAR UPDATED *'.                                22840009
228500     DISPLAY '* '                                                 22850009
228600             PV-TOT-DELETES                                       22860009
228700             ' TMDSEAR DELETED *'.                                22870009
228800     DISPLAY '*                           *'.                     22880009
228900     DISPLAY '* '                                                 22890009
229000             PV-TOT-APLAVLS-UPDATED                               22900009
229100             ' TAPLAVL UPDATED *'.                                22910009
229200     DISPLAY '* '                                                 22920009
229300             PV-TOT-APLAVLS-DELETED                               22930009
229400             ' TAPLAVL DELETED *'.                                22940009
229500     DISPLAY '*                           *'.                     22950009
229600     DISPLAY '* '                                                 22960009
229700             PV-TOT-RSPBARS-UPDATED                               22970009
229800             ' TRSPBAR UPDATED *'.                                22980009
229900     DISPLAY '* '                                                 22990009
230000             PV-TOT-RSPBARS-DELETED                               23000009
230100             ' TRSPBAR DELETED *'.                                23010009
230200     DISPLAY '*                           *'.                     23020009
230300     DISPLAY '* * * * * * * * * * * * * * *'.                     23030009
230400                                                                  23040009
230500 EJECT                                                            23050009
230600****************************************************************  23060009
230700*                                                              *  23070009
230800*    THIS ROUTINE FORCES AN ABEND DUE TO A DB2 PROBLEM.        *  23080009
230900*                                                              *  23090009
231000****************************************************************  23100009
231100                                                                  23110009
231200 9900-SQL-ABEND.                                                  23120009
231300                                                                  23130009
231400     SET ABEND-4013             TO TRUE.                          23140009
231500     DISPLAY '**  ABEND     **'.                                  23150009
231600     DISPLAY '**  PROGRAM   **  =  MBKUT008'.                     23160009
231700     DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            23170009
231800     DISPLAY '**  OPERATION **  = ' PV-DB2-OPER-ATTEMPTED.        23180009
231900                                                                  23190009
232000*    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE         23200009
232100*    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.        23210009
232200                                                                  23220009
232300     COPY DPPD004.                                                23230009
232400                                                                  23240009
232500     CALL 'ILBOABN0'  USING ABEND-CODE.                           23250009
232600                                                                  23260009
