000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400                                                                  00040000
000500 PROGRAM-ID.             SVKUP028.                                00050000
000600 AUTHOR.                 BARB SCHULTZ.                            00060000
000700 INSTALLATION.           KOHLS.                                   00070000
000800 DATE-WRITTEN            SEPTEMBER 2005.                          00080000
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100******************************************************************00110000
001200*  LOOKS TO SEE IF THERE ARE ENOUGH AVAILABLE VIRTUAL GIFT CARDS *00120000
001210*  AND IF NOT, INSERTS A REQUEST TO THE STORED VALUE CARD PROD   *00130000
001220*  TABLE.                                                        *00140000
001230******************************************************************00150000
CH0880* HISTORY LOG:                                                   *00160000
CH0880* CHANGE ID       DATE        DESCRIPTION OF CHANGES             *00170000
CH0880* --------------- ----------  --------------------------------   *00180000
CH0880* CHG0CH0880      01/29/2014  MODIFIED THE PROGRAM TO GET THE    *00190000
CH0880*                             AVAILABLE VGC FROM SVT_CRD_PROD AND*00200000
CH0880*                             SVT_LAST_ISUD_VGC.                 *00210000
C05514* CHG0105514      02/23/2015  INCREASED SPACE OF MINIMUM REORD   *00211000
C05514*                             POINT TO HOLD MAXIMUM COUNT OF     *00212000
C05514*                             RECORDS FROM SVT_CRD_INV_PARMS     *00213000
100421******************************************************************00213100
100421* CHG0262102      10/04/2021  ONLY LOCATE SVT_LAST_ISUD_VGC ROWS *00214000
100421*                             FOR CARD STOCK TYPE IDS WITH       *00215000
100421*                             'VIRTUAL' SO THAT WE ARE ONLY      *00216000
100421*                             CHECKING VIRTUAL GIFT CARDS AND    *00217000
100421*                             NOT VIRTUAL KMC (KMCVIR)           *00218000
CH0880******************************************************************00220000
001240                                                                  00230000
001250******************************************************************00240000
001260 ENVIRONMENT DIVISION.                                            00250000
001270******************************************************************00260000
001280                                                                  00270000
001290 CONFIGURATION SECTION.                                           00280000
001300                                                                  00290000
001400 SOURCE-COMPUTER.        IBM-3090.                                00300000
001500 OBJECT-COMPUTER.        IBM-3090.                                00310000
001600                                                                  00320000
001700 INPUT-OUTPUT SECTION.                                            00330000
001800                                                                  00340000
001900 FILE-CONTROL.                                                    00350000
002000                                                                  00360000
002100     SELECT PARM-CARD-FILE                                        00370000
002200         ASSIGN TO INP01.                                         00380000
002300                                                                  00390000
002400******************************************************************00400000
002500 DATA DIVISION.                                                   00410000
002600******************************************************************00420000
002700                                                                  00430000
002800 FILE SECTION.                                                    00440000
002900                                                                  00450000
003000 FD  PARM-CARD-FILE                                               00460000
003100     RECORDING MODE IS F                                          00470000
003200     BLOCK CONTAINS 0 RECORDS                                     00480000
003300     LABEL RECORDS ARE STANDARD.                                  00490000
003400                                                                  00500000
003500 01  PARM-CARD-RECORD                       PIC X(80).            00510000
003600                                                                  00520000
003700******************************************************************00530000
003800 WORKING-STORAGE SECTION.                                         00540000
003900******************************************************************00550000
004000                                                                  00560000
004100                                                                  00570000
004200 01  PC-PROGRAM-CONSTANTS.                                        00580000
004300     05  PC-PROGRAM-NAME              PIC  X(08)  VALUE           00590000
004400                                                    'SVKUP028'.   00600000
004410     05  PC-ZEROES                    PIC  S9(04)V  COMP          00610000
004420                                                  VALUE ZEROES.   00620000
004500                                                                  00630000
004600 01  PS-PROGRAM-SWITCHES.                                         00640000
004700     05  PS-END-OF-CARD-FILE-SW       PIC X(01)   VALUE 'N'.      00650000
004800         88  PS-END-OF-CARD-FILE                  VALUE 'Y'.      00660000
CH0880     05  PS-VGC-CARD-FOUND-SW         PIC X(01)  VALUE 'N'.       00670000
CH0880         88  PS-VGC-CARD-FOUND                   VALUE 'Y'.       00680000
CH0880         88  PS-NOT-VGC-CARD-FOUND               VALUE 'N'.       00690000
004900                                                                  00700000
005000 01  PV-PROGRAM-VARIABLES.                                        00720000
005100     05  PV-PARAGRAPH-NAME            PIC  X(30)  VALUE SPACE.    00730000
005200     05  PV-OPERATION-MSG-1           PIC  X(40)  VALUE SPACE.    00740000
CH0880     05  PV-AVAI-CARD-COUNT           PIC S9(09)  VALUE ZEROES    00750000
005400                                                  COMP-3.         00760000
005500     05  PV-CRD-PROD-YR               PIC S9(04)  COMP.           00770000
005600     05  PV-SHIPT-REQ-NBR             PIC S9(04)  COMP.           00780000
005610     05  PV-CURRENT-YEAR              PIC S9(04)  VALUE ZEROES    00790000
005620                                                  COMP.           00800000
CH0880     05  PV-CRD-REQ-QTY               PIC S9(9)   VALUE ZEROES    00810000
CH0880                                                  COMP.           00820000
005700     05  PV-SHIP-REQ-NBR              PIC S9(04)  VALUE ZEROES    00830000
005800                                                  COMP.           00840000
C05514     05  PV-MIN-REORD-QTY             PIC 9(10)   VALUE ZEROES.   00850000
006000     05  PV-CURR-TIMESTAMP.                                       00860000
006100         10  PV-CURRENT-DATE.                                     00870000
006200             15  PV-CURR-YEAR         PIC  9(04)  VALUE ZEROES.   00880000
006300             15  FILLER               PIC  X(01)  VALUE SPACES.   00890000
006400             15  PV-CURR-DAY          PIC  9(02)  VALUE ZEROES.   00900000
006500             15  FILLER               PIC  X(01)  VALUE SPACES.   00910000
006600             15  PV-CURR-MONTH        PIC  9(02)  VALUE ZEROES.   00920000
006700             15  FILLER               PIC  X(01)  VALUE SPACES.   00930000
006800         10  PV-CURRENT-TIME          PIC  X(08)  VALUE SPACES.   00940000
006900         10  FILLER                   PIC  X(07)  VALUE SPACES.   00950000
007000     05  PV-CURRENT-TIMESTAMP REDEFINES PV-CURR-TIMESTAMP         00960000
007100                                      PIC  X(26).                 00970000
C05514 01  PV-REORD-CUTOFF-QTY              PIC S9(10) COMP VALUE       00980000
C05514                                                     ZEROES.      00990000
007110                                                                  01000000
007200******************************************************************01010000
007300* RECORD LAYOUT FOR INPUT DATE CARD                               01020000
007400******************************************************************01030000
007500 01  CC-CONTROL-CARD.                                             01040000
007600     05  CC-NBR-OF-CARDS-TO-ORDER     PIC  9(08)   VALUE ZEROES.  01050000
007700     05  FILLER                       PIC  X(72)   VALUE SPACES.  01060000
007800                                                                  01070000
007900 01  AC-ABEND-CODE                    PIC S9(04) VALUE ZERO       01080000
008000                                                 COMP SYNC.       01090000
008100     88  AC-CONTROL-CARD-ERROR                   VALUE +4003.     01100000
008200     88  AC-SQL-ERROR                            VALUE +4013.     01110000
008300     88  AC-DATE-ERROR                           VALUE +4019.     01120000
008400                                                                  01130000
008500******************************************************************01140000
008600*  WS FIELDS FOR STORED VALUE                                     01150000
008700******************************************************************01160000
008800     COPY SVWS004.                                                01170000
008900                                                                  01180000
009000******************************************************************01190000
009100*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            01200000
009200******************************************************************01210000
009300     COPY DPWS004.                                                01220000
009400                                                                  01230000
009500******************************************************************01240000
009600*  DB2 TABLE SVT_CRD_PROD                                         01250000
009700******************************************************************01260000
009800     EXEC SQL                                                     01270000
009900         INCLUDE SVT00000                                         01280000
010000     END-EXEC.                                                    01290000
010100                                                                  01300000
010200******************************************************************01310000
010300*  DB2 TABLE SVT_KOHLS_CRD_TXN                                    01320000
010400******************************************************************01330000
010500     EXEC SQL                                                     01340000
010600         INCLUDE SVT00002                                         01350000
010700     END-EXEC.                                                    01360000
010800                                                                  01370000
010900******************************************************************01380000
011000*    DB2 AREA FOR SVT_KOHLS_CRD_ACCT                             *01390000
011100******************************************************************01400000
011200     EXEC SQL                                                     01410000
011300         INCLUDE SVT00001                                         01420000
011400     END-EXEC.                                                    01430000
011500                                                                  01440000
011600******************************************************************01450000
011700*    DB2 AREA FOR SVT_CRD_STK_DNMNTN                             *01460000
011800******************************************************************01470000
011900     EXEC SQL                                                     01480000
012000         INCLUDE SVT00008                                         01490000
012100     END-EXEC.                                                    01500000
012200                                                                  01510000
012210******************************************************************01520000
012220*    DB2 AREA FOR SVT_CRD_INV_PARMS                              *01530000
012230******************************************************************01540000
012240     EXEC SQL                                                     01550000
012250         INCLUDE SVT00009                                         01560000
012260     END-EXEC.                                                    01570000
012270                                                                  01580000
012280******************************************************************01590000
012290*    DB2 AREA FOR SVT_LAST_ISUD_VGC                              *01600000
012291******************************************************************01610000
012292     EXEC SQL                                                     01620000
012293         INCLUDE SVT00017                                         01630000
012294     END-EXEC.                                                    01640000
012295                                                                  01650000
012300******************************************************************01660000
012400*  DB2 COMMUNICATION AREA.                                        01670000
012500******************************************************************01680000
012600     EXEC SQL                                                     01690000
012700         INCLUDE SQLCA                                            01700000
012800     END-EXEC.                                                    01710000
012900                                                                  01720000
013000******************************************************************01730000
013100 PROCEDURE DIVISION.                                              01740000
013200******************************************************************01750000
013300 0000-PROGRAM-MAINLINE.                                           01760000
013400                                                                  01770000
013500     PERFORM 1000-INITIALIZE.                                     01780000
013600                                                                  01790000
013700     PERFORM 2000-PROCESSING.                                     01800000
013800                                                                  01810000
013900     PERFORM 9000-EOJ-ROUTINE.                                    01820000
014000                                                                  01830000
014100     STOP RUN.                                                    01840000
014200                                                                  01850000
014300******************************************************************01860000
014400*  OPEN CARD FILE AND PROCESS IT                                  01870000
014500******************************************************************01880000
014600 1000-INITIALIZE.                                                 01890000
014700                                                                  01900000
014800     OPEN INPUT  PARM-CARD-FILE.                                  01910000
014900                                                                  01920000
015000     PERFORM 1400-PROCESS-CONTROL-CARD.                           01930000
015100                                                                  01940000
015200***************************************************************** 01950000
015300* READ DATE CONTROL CARD                                          01960000
015400***************************************************************** 01970000
015500 1400-PROCESS-CONTROL-CARD.                                       01980000
015600                                                                  01990000
015700     PERFORM 1410-READ-PARM-CARD-FILE.                            02000000
015800                                                                  02010000
015900     IF PS-END-OF-CARD-FILE                                       02020000
016000         MOVE '1400-PROCESS-CONTROL-CARD'  TO PV-PARAGRAPH-NAME   02030000
016100         MOVE 'NO CONTROL CARD TO PROCESS' TO PV-OPERATION-MSG-1  02040000
016200         SET AC-CONTROL-CARD-ERROR TO TRUE                        02050000
016300         PERFORM 9999-ABEND                                       02060000
016400     END-IF.                                                      02070000
016500                                                                  02080000
016510     IF CC-NBR-OF-CARDS-TO-ORDER NUMERIC                          02090000
016520         CONTINUE                                                 02100000
016530     ELSE                                                         02110000
016540         MOVE '1400-PROCESS-CONTROL-CARD'  TO PV-PARAGRAPH-NAME   02120000
016550         MOVE 'CONTROL CARD NOT NUMERIC ' TO PV-OPERATION-MSG-1   02130000
016560         SET AC-CONTROL-CARD-ERROR TO TRUE                        02140000
016570         PERFORM 9999-ABEND                                       02150000
016580     END-IF.                                                      02160000
016581                                                                  02170000
016582     IF CC-NBR-OF-CARDS-TO-ORDER > 0                              02180000
016583         CONTINUE                                                 02190000
016584     ELSE                                                         02200000
016585         MOVE '1400-PROCESS-CONTROL-CARD'  TO PV-PARAGRAPH-NAME   02210000
016586         MOVE 'CONTROL CARD VALUE = 0 ' TO PV-OPERATION-MSG-1     02220000
016587         SET AC-CONTROL-CARD-ERROR TO TRUE                        02230000
016588         PERFORM 9999-ABEND                                       02240000
016589     END-IF.                                                      02250000
016590                                                                  02260000
016600     DISPLAY 'SVKUP028 CONTROL PARM: '                            02270000
016710         CC-NBR-OF-CARDS-TO-ORDER.                                02280000
016800                                                                  02290000
016900******************************************************************02300000
017000* READ THE PARM CARD                                              02310000
017100******************************************************************02320000
017200 1410-READ-PARM-CARD-FILE.                                        02330000
017300                                                                  02340000
017400     READ PARM-CARD-FILE INTO CC-CONTROL-CARD                     02350000
017500       AT END                                                     02360000
017600           SET PS-END-OF-CARD-FILE TO TRUE.                       02370000
017700                                                                  02380000
017800******************************************************************02390000
017900*  COUNT THE VIRTUAL CARDS, IF THERE'S LESS THAN WHAT THE        *02400000
018000*  MINIMUM COUNT OF CARDS, THEN REQUEST CARDS (THE AMOUNT THAT   *02410000
018010*  IS ON THE CONTROL CARD).                                      *02420000
018100******************************************************************02430000
018200 2000-PROCESSING.                                                 02440000
018300                                                                  02450000
CH0880     PERFORM 3500-MAX-CARD-PRD-YEAR.                              02460000
018400     PERFORM 2200-SELECT-COUNT-VIRTUAL.                           02470000
CH0880     IF PS-VGC-CARD-FOUND                                         02480000
CH0880        MOVE SVT00000-CRD-REQ-QTY TO PV-CRD-REQ-QTY               02490000
CH0880        COMPUTE PV-AVAI-CARD-COUNT = PV-CRD-REQ-QTY -             02500000
CH0880                                     SVT00017-LAST-ISUD-CNTL-NBR  02510000
CH0880     END-IF                                                       02520000
018410     PERFORM 2300-SELECT-SVT00009.                                02540000
C05514     MOVE PV-REORD-CUTOFF-QTY TO PV-MIN-REORD-QTY                 02571000
C05514     IF PV-AVAI-CARD-COUNT < PV-MIN-REORD-QTY                     02580000
018600         PERFORM 2100-WRITE-REQUEST                               02590000
018610     ELSE                                                         02600000
018620        DISPLAY 'NO CARDS HAVE BEEN REQUESTED'                    02610000
CH0880        DISPLAY 'TOTAL VIRTUAL CARDS ' PV-AVAI-CARD-COUNT         02620000
C05514        DISPLAY 'MIN REORDER QTY ' PV-MIN-REORD-QTY               02630000
018640        DISPLAY 'REORDER QUANTITY ' CC-NBR-OF-CARDS-TO-ORDER      02640000
018700     END-IF.                                                      02650000
018800                                                                  02660000
018900******************************************************************02670000
019000*   ADD A ROW OUT IN THE SVT00000 TABLE                          *02680000
019100* - FIND THE CURRENT YEAR                                        *02690000
019200* - FIND THE MAXIMUM SHIP_REQ_NBR FOR THE YEAR                   *02700000
019300*      ADD +1 TO THE SHIP_REQ_NBR                                 02710000
019400* - ADD THE REQUEST TO SVT00000                                   02720000
019500******************************************************************02730000
019600 2100-WRITE-REQUEST.                                              02740000
019700                                                                  02750000
019800     PERFORM 3000-FIND-CURRENT-YEAR.                              02760000
019900     PERFORM 3100-MAX-SHIP-REQ-NBR.                               02770000
020100     PERFORM 3300-INSERT-SVT00000.                                02780000
020110     IF SQLCODE = +0                                              02790000
020120        DISPLAY 'INSERTED YEAR ' SVT00000-CRD-PROD-YR             02800000
020121        DISPLAY 'SHIP REQ NBR ' SVT00000-SHIPT-REQ-NBR            02810000
020130        DISPLAY 'STRT CNTL NBR ' SVT00000-STRT-CNTL-NBR           02820000
020131        DISPLAY 'END CNTL NBR ' SVT00000-END-CNTL-NBR             02830000
020132        PERFORM 3400-ADD-LAST-ISSUE                               02840000
020140     END-IF.                                                      02850000
020200                                                                  02860000
020300******************************************************************02870000
020400*    SQL TO FIND OUT HOW MANY VIRTUAL AVAILABLE CARDS             02880000
020500*       THERE ARE THAT HAVE NOT BEEN ISSUED YET                   02890000
020600******************************************************************02900000
020700 2200-SELECT-COUNT-VIRTUAL.                                       02910000
020800                                                                  02920000
020900     EXEC SQL                                                     02930000
CH0880         SELECT CRD_REQ_QTY                                       02940000
CH0880           INTO :SVT00000-CRD-REQ-QTY                             02950000
CH0880         FROM SVT_CRD_PROD                                        02960000
CH0880         WHERE CRD_PROD_YR    = :SVT00017-CRD-PROD-YR             02970000
CH0880           AND SHIPT_REQ_NBR  = :SVT00017-SHIPT-REQ-NBR           02980000
CH0880           AND CRD_STK_TYP_ID = 'VIRTUAL'                         02990000
CH0880          WITH UR                                                 03000000
CH0880     END-EXEC.                                                    03010000
012900                                                                  03020000
022300     EVALUATE TRUE                                                03030000
CH0880         WHEN SQLCODE = 0                                         03040000
CH0880             SET PS-VGC-CARD-FOUND TO TRUE                        03050000
022400         WHEN SQLCODE NOT = 0                                     03060000
022800             MOVE '2200-SELECT-COUNT-VIRTUAL' TO PV-PARAGRAPH-NAME03070000
022900             DISPLAY '** SELECT COUNT OF '                        03080000
023000             DISPLAY '** VIRTUAL CARDS '                          03090000
023100             PERFORM 9985-SQL-ABEND                               03100000
023200     END-EVALUATE.                                                03110000
023300                                                                  03120000
023301******************************************************************03130000
023302*    SQL TO FIND THE REORDER POINT FOR VIRTUAL CARDS              03140000
023304******************************************************************03150000
023306 2300-SELECT-SVT00009.                                            03160000
023307                                                                  03170000
023308     EXEC SQL                                                     03180000
023309         SELECT REORD_PT_QTY                                      03190000
C05514         INTO :PV-REORD-CUTOFF-QTY                                03200000
023311         FROM SVT_CRD_STK_DNMNTN   A                              03210000
023312            , SVT_CRD_INV_PARMS    B                              03220000
023313         WHERE A.CRD_INV_PARM_ID   = B.CRD_INV_PARM_ID            03230000
023314           AND A.CRD_TYP_CDE       = 2                            03240000
023315           AND A.CRD_STK_TYP_ID    = 'VIRTUAL'                    03250000
023316           AND A.PRE_DNNTD_CRD_AMT = 0                            03260000
023321           WITH UR                                                03270000
023322     END-EXEC.                                                    03280000
023323                                                                  03290000
023324     EVALUATE TRUE                                                03300000
023325         WHEN SQLCODE NOT = 0                                     03310000
023329             MOVE '2300-SELECT-SVT00009' TO PV-PARAGRAPH-NAME     03320000
023330             DISPLAY '** SELECT REORDER POINT'                    03330000
023332             PERFORM 9985-SQL-ABEND                               03340000
023333     END-EVALUATE.                                                03350000
023334                                                                  03360000
023400******************************************************************03370000
023500*   FIND THE CURRENT YEAR                                        *03380000
023600******************************************************************03390000
023700 3000-FIND-CURRENT-YEAR.                                          03400000
023800                                                                  03410000
023900     EXEC SQL                                                     03420000
024000         SELECT CURRENT TIMESTAMP                                 03430000
024100           INTO :PV-CURRENT-TIMESTAMP                             03440000
024200         FROM SYSIBM.SYSDUMMY1                                    03450000
024300         WITH UR                                                  03460000
024400     END-EXEC.                                                    03470000
024500                                                                  03480000
024600     EVALUATE TRUE                                                03490000
024700         WHEN SQLCODE = +0                                        03500000
024800             CONTINUE                                             03510000
024900         WHEN OTHER                                               03520000
025000             MOVE '3000-FIND-CURRENT-YEAR '                       03530000
025100                               TO PV-PARAGRAPH-NAME               03540000
025200             PERFORM 9985-SQL-ABEND                               03550000
025300     END-EVALUATE.                                                03560000
025400                                                                  03570000
025500******************************************************************03580000
025600*   FIND THE MAX SHIPMENT NUMBER                                 *03590000
025700******************************************************************03600000
025800 3100-MAX-SHIP-REQ-NBR.                                           03610000
025900                                                                  03620000
025910     MOVE PV-CURR-YEAR TO PV-CURRENT-YEAR.                        03630000
025920                                                                  03640000
026000     EXEC SQL                                                     03650000
026100         SELECT COALESCE(MAX(SHIPT_REQ_NBR), :PC-ZEROES)          03660000
026200           INTO :PV-SHIP-REQ-NBR                                  03670000
026300         FROM SVT_CRD_PROD                                        03680000
026400         WHERE CRD_PROD_YR = :PV-CURRENT-YEAR                     03690000
026500         WITH UR                                                  03700000
026600     END-EXEC.                                                    03710000
026700                                                                  03720000
026800     EVALUATE TRUE                                                03730000
026900         WHEN SQLCODE = +0                                        03740000
027000             CONTINUE                                             03750000
027100         WHEN OTHER                                               03760000
027200             MOVE '3100-MAX-SHIP-REQ-NBR  '                       03770000
027300                               TO PV-PARAGRAPH-NAME               03780000
027400             PERFORM 9985-SQL-ABEND                               03790000
027500     END-EVALUATE.                                                03800000
027600                                                                  03810000
030100******************************************************************03820000
030200* INSERT REQUEST FOR VIRTUAL CARDS                               *03830000
030300******************************************************************03840000
030400 3300-INSERT-SVT00000.                                            03850000
030410                                                                  03860000
030500     MOVE PV-CURR-YEAR        TO SVT00000-CRD-PROD-YR.            03870000
030510                                                                  03880000
030600     ADD +1 TO PV-SHIP-REQ-NBR.                                   03890000
030700     MOVE PV-SHIP-REQ-NBR     TO SVT00000-SHIPT-REQ-NBR.          03900000
030710                                                                  03910000
030810     MOVE +1                  TO SVT00000-STRT-CNTL-NBR.          03920000
030820                                                                  03930000
031100     MOVE CC-NBR-OF-CARDS-TO-ORDER TO SVT00000-END-CNTL-NBR.      03940000
031110                                                                  03950000
031200     MOVE 2                   TO SVT00000-CRD-TYP-CDE.            03960000
031300     MOVE 0                   TO SVT00000-PRE-DNNTD-CRD-AMT.      03970000
031400     MOVE 'VIRTUAL'           TO SVT00000-CRD-STK-TYP-ID.         03980000
031500     MOVE CC-NBR-OF-CARDS-TO-ORDER TO SVT00000-CRD-REQ-QTY.       03990000
031600     MOVE PV-CURRENT-DATE     TO SVT00000-CRD-REQD-DTE.           04000000
031700     MOVE PV-CURRENT-TIME     TO SVT00000-CRD-REQD-TM.            04010000
031800     MOVE 'PN'                TO SVT00000-CRD-PROD-STAT-CDE.      04020000
031900     MOVE 'SVKUP028'          TO SVT00000-RQSTR-USR-ID.           04030000
032000     MOVE SV004-DEFAULT-DATE  TO SVT00000-CRD-EXPRN-DTE.          04040000
032100     MOVE 'K'                 TO SVT00000-CRD-PRDR-CDE.           04050000
032200                                                                  04060000
032300     EXEC SQL                                                     04070000
032400         INSERT INTO SVT_CRD_PROD                                 04080000
032500            (CRD_PROD_YR                                          04090000
032600            ,SHIPT_REQ_NBR                                        04100000
032700            ,STRT_CNTL_NBR                                        04110000
032800            ,END_CNTL_NBR                                         04120000
032900            ,CRD_TYP_CDE                                          04130000
033000            ,PRE_DNNTD_CRD_AMT                                    04140000
033100            ,CRD_STK_TYP_ID                                       04150000
033200            ,CRD_REQ_QTY                                          04160000
033300            ,CRD_REQD_DTE                                         04170000
033400            ,CRD_REQD_TM                                          04180000
033500            ,CRD_PROD_STAT_CDE                                    04190000
033600            ,RQSTR_USR_ID                                         04200000
033700            ,CRD_EXPRN_DTE                                        04210000
033800            ,CRD_PRDR_CDE)                                        04220000
033900         VALUES                                                   04230000
034000           ( :SVT00000-CRD-PROD-YR                                04240000
034100            ,:SVT00000-SHIPT-REQ-NBR                              04250000
034110            ,:SVT00000-STRT-CNTL-NBR                              04260000
034120            ,:SVT00000-END-CNTL-NBR                               04270000
034130            ,:SVT00000-CRD-TYP-CDE                                04280000
034140            ,:SVT00000-PRE-DNNTD-CRD-AMT                          04290000
034150            ,:SVT00000-CRD-STK-TYP-ID                             04300000
034160            ,:SVT00000-CRD-REQ-QTY                                04310000
034170            ,:SVT00000-CRD-REQD-DTE                               04320000
034180            ,:SVT00000-CRD-REQD-TM                                04330000
034190            ,:SVT00000-CRD-PROD-STAT-CDE                          04340000
034191            ,:SVT00000-RQSTR-USR-ID                               04350000
034192            ,:SVT00000-CRD-EXPRN-DTE                              04360000
034193            ,:SVT00000-CRD-PRDR-CDE)                              04370000
034194     END-EXEC.                                                    04380000
034195                                                                  04390000
034196     EVALUATE TRUE                                                04400000
034197         WHEN SQLCODE = +0                                        04410000
034198             CONTINUE                                             04420000
034199         WHEN OTHER                                               04430000
034200             MOVE '3300-INSERT-SVT00000   '                       04440000
034300                               TO PV-PARAGRAPH-NAME               04450000
034400             PERFORM 9985-SQL-ABEND                               04460000
034500     END-EVALUATE.                                                04470000
034600                                                                  04480000
034601*----------------------------------------------------------------*04490000
034602*  ADD A ROW TO THE SVT_LAST_ISUD_VGC TABLE                      *04500000
034603*----------------------------------------------------------------*04510000
034604 3400-ADD-LAST-ISSUE.                                             04520000
034610                                                                  04530000
034651     MOVE  PV-CURR-YEAR        TO PV-CRD-PROD-YR.                 04540000
034652     MOVE  PV-SHIP-REQ-NBR     TO PV-SHIPT-REQ-NBR.               04550000
034654                                                                  04560000
034660     EXEC SQL                                                     04570000
034670         INSERT INTO SVT_LAST_ISUD_VGC                            04580000
034680            (CRD_PROD_YR                                          04590000
034690            ,SHIPT_REQ_NBR                                        04600000
034691            ,LAST_ISUD_CNTL_NBR)                                  04610000
034692         VALUES                                                   04620000
034693            ( :PV-CRD-PROD-YR                                     04630000
034694             ,:PV-SHIPT-REQ-NBR                                   04640000
034695             ,+0)                                                 04650000
034696     END-EXEC.                                                    04660000
034697                                                                  04670000
034698     EVALUATE TRUE                                                04680000
034699        WHEN SQLCODE = 0                                          04690000
034700            CONTINUE                                              04700000
034701        WHEN OTHER                                                04710000
034703            MOVE '3400-ADD-LAST-ISSUE    '                        04720000
034704                               TO PV-PARAGRAPH-NAME               04730000
034705            PERFORM 9985-SQL-ABEND                                04740000
034713     END-EVALUATE.                                                04750000
034714                                                                  04760000
CH0880******************************************************************04770000
CH0880*   FIND THE MAX CARD PROD YEAR                                   04780000
CH0880******************************************************************04790000
CH0880 3500-MAX-CARD-PRD-YEAR.                                          04800000
CH0880                                                                  04810000
CH0880     EXEC SQL                                                     04820000
100421         SELECT LIV.CRD_PROD_YR,                                  04830000
100421                LIV.SHIPT_REQ_NBR,                                04840000
100421                LIV.LAST_ISUD_CNTL_NBR                            04850000
CH0880           INTO :SVT00017-CRD-PROD-YR,                            04860000
CH0880                :SVT00017-SHIPT-REQ-NBR,                          04870000
CH0880                :SVT00017-LAST-ISUD-CNTL-NBR                      04880000
CH0880           FROM SVT_LAST_ISUD_VGC LIV                             04890000
100421               ,SVT_CRD_PROD      PRD                             04890100
100421         WHERE LIV.CRD_PROD_YR    = PRD.CRD_PROD_YR               04891000
100421           AND LIV.SHIPT_REQ_NBR  = PRD.SHIPT_REQ_NBR             04892000
100421           AND PRD.CRD_STK_TYP_ID = 'VIRTUAL'                     04893000
CH0880           ORDER BY LIV.CRD_PROD_YR   DESC,                       04900000
CH0880                    LIV.SHIPT_REQ_NBR DESC                        04910000
CH0880           FETCH FIRST ROW ONLY                                   04920000
CH0880         WITH UR                                                  04930000
CH0880     END-EXEC.                                                    04940000
CH0880                                                                  04950000
CH0880     EVALUATE TRUE                                                04960000
CH0880         WHEN SQLCODE = +0                                        04970000
CH0880             CONTINUE                                             04980000
CH0880         WHEN OTHER                                               04990000
CH0880             MOVE '3500-MAX-CARD-PRD-YEAR '                       05000000
CH0880                               TO PV-PARAGRAPH-NAME               05010000
CH0880             PERFORM 9985-SQL-ABEND                               05020000
CH0880     END-EVALUATE.                                                05030000
CH0880                                                                  05040000
034720******************************************************************05050000
034800* CLOSE THE PARM-CARD-FILE                                       *05060000
034900******************************************************************05070000
035000 9000-EOJ-ROUTINE.                                                05080000
035100                                                                  05090000
035200     CLOSE PARM-CARD-FILE.                                        05100000
035300                                                                  05110000
035400***************************************************************** 05120000
035500*     -PERFORMS ABEND PROCESSING FOR SQL ERRORS.                  05130000
035600***************************************************************** 05140000
035700 9985-SQL-ABEND.                                                  05150000
035800                                                                  05160000
035900     DISPLAY '9985-SQL-ABEND'.                                    05170000
036000     DISPLAY '**  ABEND     **'.                                  05180000
036100     DISPLAY '**  PROGRAM   ** = ' PC-PROGRAM-NAME.               05190000
036200     DISPLAY '**  PARAGRAPH ** = ' PV-PARAGRAPH-NAME.             05200000
036300     DISPLAY '**  SQLCODE   ** = ' SQLCODE.                       05210000
036400******************************************************************05220000
036500* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *05230000
036600* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *05240000
036700* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *05250000
036800* FORMAT.                                                        *05260000
036900******************************************************************05270000
037000                                                                  05280000
037100     COPY DPPD004.                                                05290000
037200                                                                  05300000
037300     MOVE +4013 TO AC-ABEND-CODE.                                 05310000
037400     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         05320000
037500                                                                  05330000
037600******************************************************************05340000
037700* 9999-ABEND - PERFORMS A NON-SQL-ABEND                           05350000
037800******************************************************************05360000
037900 9999-ABEND.                                                      05370000
038000     DISPLAY '** ABEND           **'.                             05380000
038100     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          05390000
038200     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        05400000
038300     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       05410000
038400     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         05420000
