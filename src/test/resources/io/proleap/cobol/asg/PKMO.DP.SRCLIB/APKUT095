000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.      APKUT095.                                       00020000
000300 AUTHOR.          ROLF NOHE.                                      00030000
000400 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00040000
000500 DATE-WRITTEN.    SEPTEMBER 2006.                                 00050000
000600*----------------------------------------------------------------*00060000
000700*   AUTOMATE DAILY VERIFIED PRICE DIFFERENCE ADJUSTMENTS.        *00070000
000800*----------------------------------------------------------------*00080000
000900*                  COBOL390 WITH DB2 SQL                         *00090000
001000*----------------------------------------------------------------*00100000
001100*                                                                *00110000
001200* THIS PROGRAM WILL CREATE AP ADJUSTMENTS FROM A FILE THAT IS    *00120000
001300* CREATED IN THE RECEIVING SYSTEM TO REPORT ON VERIFIED PRICE    *00130000
001400* DIFFERENCES.  EVERY RECORD ON THIS FILE NEEDS TO CREATE A      *00140000
001500* PRICE ADJUSTMENT, SO NO MANUAL INTERVENTION IS NECESSARY.      *00150000
001600*----------------------------------------------------------------*00160000
001700*                                                                *00170000
001800* DB2 TABLES:                                                    *00180000
001900*  1. ACCOUNTS PAYABLE CONTROL TABLE  (DCLGEN TAPCNTL)           *00190035
002000*  2. EXTERNAL ENTITY TABLE           (DCLGEN TEXTENT )          *00200035
002100*  3. ENTITY NAME TABLE               (DCLGEN TENTNME )          *00210035
002200*  4. PO-PURCHASE TABLE               (DCLGEN TPURCHS )          *00220035
002300*  5. SKU CROSS REFERENCE TABLE       (DCLGEN TSKXREF)           *00230035
002400*  6. UPC TABLE                       (DCLGEN TUPC)              *00240035
002410*  7. MDSE AREA VENDOR STYLE TABLE    (DCLGEN TMDSARV)           *00241035
002420*  8. VENDOR STYLE TABLE              (DCLGEN TVNDSTL)           *00242035
002500*                                                                *00250000
002600* INPUT FILE:                                                    *00260000
002700*  1. DAILY VERIFIED PRICE DIFFERENCES (COPYBOOK RCRD048)        *00270000
002800*                                                                *00280000
002900* OUTPUT FILE:                                                   *00290000
003000*  1. AP DETAIL ADJUSTMENTS            (COPYBOOK APRD045)        *00300025
003100*                                                                *00310000
003200*----------------------------------------------------------------*00320000
003300* CHANGE LOG:                                                    *00330000
003400*                                                                *00340000
003500* DATE  09/14/2006                                               *00350000
003600*     CHANGE MADE: INITIAL VERSION.                              *00360000
003700*     MADE BY: ROLF NOHE               WR/IR #: WR31209          *00370000
003800*                                                                *00380022
003900* DATE  09/22/2006                                               *00390025
004000*     CHANGE MADE: MODIFIED PROGRAM TO BYPASS STOCK PULL NUMBERS *00400024
004100*                  THAT MAY EXIST ON THE INPUT FILE.             *00410024
004200*     MADE BY: ROLF NOHE               WR/IR #: P000926448       *00420024
004300*                                                                *00430027
004400* DATE  09/26/2006                                               *00440027
004500*     CHANGE MADE: MODIFIED PARAGRAPH B200- TO ADD THE VERIFIED  *00450029
004600*                  DATE ON THE FIRST NON STOCK PULL NUMBER       *00460029
004700*                  RECORD.                                       *00470029
004800*     MADE BY: ROLF NOHE               WR/IR #: P000929345       *00480027
004810*                                                                *00481031
004820* DATE  09/14/2010                                               *00482042
004830*     CHANGE MADE: MODIFIED PROGRAM TO OBTAIN VERIFIED DATE FROM *00483031
004840*     THE INPUT FILE - REMOVED ALL LOGIC REFERRING  TO TRECEIV   *00484035
004850*     TABLE AS IT IS NO LONGER NEEDED. REMOVED ALL LOGIC THAT    *00485035
004851*     BYPASSED STOCK PULLS. ADDED LOGIC TO GET VENDOR INFO BASED *00485135
004852*     ON SKU WHEN PROCESSING A STOCK PULL VS USING PO WHEN       *00485235
004853*     PROCESSING PRICE CHANGES FOR A VERIFIED RECEIPT. THIS      *00485335
004854*     REQUIRED ADDING DB2 TABLES TSKXREF, TUPC, TMDSARV, TVNDSTL.*00485435
004855*     CONDENSED ADJUSTMENT CREATION PARAGRAPHS FROM 4 DOWN TO 1. *00485535
004856*     REMOVED ALL REFERENCES TO TTRNCDE - NOT USED.              *00485635
004857*     REMOVED ALL RETRY LOGIC ON DB ACCESS.                      *00485735
004860*     MADE BY: NANCY EILBES            WR/IR #: PKE000000004474  *00486031
004861*                                                                *00486144
004870* DATE  09/23/2010                                               *00487044
004880*     CHANGE MADE: MODIFIED PARAGRAPH C100-FORMAT-ADJ-DETAIL     *00488044
004890*     TO INCLUDE VERIFIED DATE IN THE LOGIC CHECKING WHETHER A   *00489044
004891*     NEW DOC NUMBER NEEDS TO BE ASSIGNED.                       *00489144
004892*     MADE BY: NANCY EILBES            WR/IR #: INC000001403902  *00489244
004893*                                                                *00489344
004870* DATE  02/21/2023                                               *00489445
004880*     CHANGE MADE: CHANGE CALL TO DPKUT151 FROM STATIC TO DYNAMIC*00489545
004892*     MADE BY: JEAN KURK               WR/IR #: CHG0282641       *00489845
004900*----------------------------------------------------------------*00490000
005000                                                                  00500000
005100 ENVIRONMENT DIVISION.                                            00510000
005200                                                                  00520000
005300 CONFIGURATION SECTION.                                           00530000
005400 SOURCE-COMPUTER. IBM-3090.                                       00540000
005500 OBJECT-COMPUTER. IBM-3090.                                       00550000
005600                                                                  00560000
005700 INPUT-OUTPUT SECTION.                                            00570000
005800 FILE-CONTROL.                                                    00580000
005900     SELECT DLY-PRICE-DIFF-FILE    ASSIGN TO INP01.               00590000
006000     SELECT RETAIL-PRICE-ADJ-FILE  ASSIGN TO OUT01.               00600000
006100                                                                  00610000
006200 DATA DIVISION.                                                   00620000
006300                                                                  00630000
006400 FILE SECTION.                                                    00640000
006500                                                                  00650000
006600 FD  DLY-PRICE-DIFF-FILE                                          00660000
006700     RECORDING MODE IS F                                          00670000
006800     LABEL RECORDS ARE STANDARD                                   00680000
006900     BLOCK CONTAINS 0 RECORDS                                     00690000
007000     DATA RECORD IS DLY-PRICE-DIFF-RECORD.                        00700000
007100                                                                  00710000
007200 01  DLY-PRICE-DIFF-RECORD      PIC X(140).                       00720000
007300                                                                  00730000
007400 FD  RETAIL-PRICE-ADJ-FILE                                        00740000
007500     RECORDING MODE IS F                                          00750000
007600     LABEL RECORDS ARE STANDARD                                   00760000
007700     DATA RECORD IS RETAIL-PRICE-ADJ-RECORD.                      00770000
007800                                                                  00780000
007900 01  RETAIL-PRICE-ADJ-RECORD    PIC X(500).                       00790000
008000                                                                  00800000
008100                                                                  00810000
008200 WORKING-STORAGE SECTION.                                         00820000
008300                                                                  00830000
008400 01  WS-RETRY-COUNTER               PIC S9(04)    COMP VALUE +0.  00840000
008500 01  WS-RETRY-MAX                   PIC S9(04)    COMP VALUE +3.  00850000
008600                                                                  00860000
008700 01  DISPLAY-PO-NBR                 PIC 9(09).                    00870000
008800                                                                  00880000
008900 01  PV-PROGRAM-VARIABLES.                                        00890000
009000     05  PV-PREV-PO-NBR             PIC S9(09)    COMP VALUE +0.  00900000
009100     05  PV-CURR-TMST               PIC X(26)     VALUE SPACES.   00910000
009200     05  SAVE-PO-NBR                PIC S9(09)    COMP VALUE +0.  00920000
009600     05  SAVE-AP-TRN-CDE            PIC X(03)     VALUE SPACES.   00960000
009610     05  SAVE-VND-NBR               PIC X(09)     VALUE SPACES.   00961037
009620     05  SAVE-VERIFY-DATE           PIC X(10)     VALUE SPACES.   00962043
009700     05  PV-RETL-AMT                PIC S9(07)V99 COMP-3 VALUE +0.00970000
009800     05  PV-CTL-RETAIL-AMT          PIC S9(11)V99 COMP-3 VALUE +0.00980000
009900     05  PV-CTL-NET-COST-AMT        PIC S9(11)V99 COMP-3 VALUE +0.00990000
010000     05  PV-VERFYD-TMST.                                          01000000
010100         10 PV-VERFYD-DTE           PIC X(10)     VALUE SPACES.   01010000
010200         10 FILLER                  PIC X(16)     VALUE SPACES.   01020000
010300                                                                  01030000
010400 01  PROGRAM-COUNTERS.                                            01040000
010500     05  INPUT-COUNT                PIC 9(09)     VALUE 0.        01050000
010510     05  STOCK-PULL-COUNT           PIC 9(09)     VALUE 0.        01051035
010600     05  OUT-ADJUSTMENT-COUNT       PIC 9(09)     VALUE 0.        01060000
010700                                                                  01070000
010300                                                                  01071046
010900 01  PS-PROGRAM-SWITCHES.                                         01090000
011000     05  PS-DLY-PRICE-DIFF-EOF      PIC X(01)     VALUE 'N'.      01100000
011100         88  DLY-PRICE-DIFF-EOF                   VALUE 'Y'.      01110000
011200     05  PS-STOCK-PULL-NBR          PIC X(01)     VALUE 'N'.      01120009
011300         88  STOCK-PULL                           VALUE 'Y'.      01130035
011400         88  NOT-STOCK-PULL                       VALUE 'N'.      01140035
011500                                                                  01150000
011600 01  WS-ABEND-FIELDS.                                             01160000
011700     05  WS-ABEND-LITERAL           PIC X(40)     VALUE           01170000
011800             '*****       ABEND'.                                 01180000
011900     05  WS-ABEND-PROGRAM-MSG.                                    01190000
012000         10  FILLER                 PIC X(17)     VALUE           01200000
012100             '*****   PROGRAM: '.                                 01210000
012200         10  WS-ABEND-PROGRAM       PIC X(8)      VALUE           01220000
012300             'APKUT095'.                                          01230000
012400     05  WS-ABEND-PARAGRAPH-MSG.                                  01240000
012500         10  FILLER                 PIC X(17)     VALUE           01250000
012600             '***** PARAGRAPH: '.                                 01260000
012700         10  WS-ABEND-PARAGRAPH     PIC X(35)     VALUE SPACES.   01270000
012800     05  WS-ABEND-OPERATION-MSG.                                  01280000
012900         10  FILLER                 PIC X(17)     VALUE           01290000
013000             '***** OPERATION: '.                                 01300000
013100         10  WS-ABEND-OPERATION     PIC X(50)     VALUE SPACES.   01310000
013200     05  WS-ABEND-TABLE1-MSG.                                     01320000
013300         10  FILLER                 PIC X(15)     VALUE           01330000
013400             '***** TABLE 1: '.                                   01340000
013500         10  WS-ABEND-STRUCTURE-1   PIC X(08)     VALUE SPACES.   01350000
013600     05  WS-ABEND-TABLE2-MSG.                                     01360000
013700         10  FILLER                 PIC X(15)     VALUE           01370000
013800             '***** TABLE 2: '.                                   01380000
013900         10  WS-ABEND-STRUCTURE-2   PIC X(08)     VALUE SPACES.   01390000
014000     05  WS-ABEND-TABLE3-MSG.                                     01400000
014100         10  FILLER                 PIC X(15)     VALUE           01410000
014200             '***** TABLE 3: '.                                   01420000
014300         10  WS-ABEND-STRUCTURE-3   PIC X(08)     VALUE SPACES.   01430000
014310     05  WS-ABEND-TABLE4-MSG.                                     01431035
014320         10  FILLER                 PIC X(15)     VALUE           01432035
014330             '***** TABLE 4: '.                                   01433035
014340         10  WS-ABEND-STRUCTURE-4   PIC X(08)     VALUE SPACES.   01434035
014350     05  WS-ABEND-TABLE5-MSG.                                     01435035
014360         10  FILLER                 PIC X(15)     VALUE           01436035
014370             '***** TABLE 5: '.                                   01437035
014380         10  WS-ABEND-STRUCTURE-5   PIC X(08)     VALUE SPACES.   01438035
014390     05  WS-ABEND-TABLE6-MSG.                                     01439035
014391         10  FILLER                 PIC X(15)     VALUE           01439135
014392             '***** TABLE 6: '.                                   01439235
014393         10  WS-ABEND-STRUCTURE-6   PIC X(08)     VALUE SPACES.   01439335
014400     05  WS-ABEND-PO-NBR-MSG.                                     01440000
014500         10  FILLER                 PIC X(15)     VALUE           01450000
014600             '***** PO NBR:  '.                                   01460000
014700         10  WS-ABEND-PO-NBR        PIC X(09)     VALUE SPACES.   01470016
014800     05  WS-ABEND-SKU-NBR-MSG.                                    01480035
014900         10  FILLER                 PIC X(20)     VALUE           01490014
015000             '***** SKU NBR:  '.                                  01500035
015100         10  WS-ABEND-SKU-NBR       PIC X(09)     VALUE SPACES.   01510035
015200     05  WS-ABEND-STATUS            PIC X(02)     VALUE SPACES.   01520000
015300     05  WS-MESSAGE-LINE-1.                                       01530000
015400         10  FILLER                 PIC X(06)     VALUE '*****'.  01540000
015500         10  WS-MESSAGE-1           PIC X(80)     VALUE SPACES.   01550000
015600     05  WS-MESSAGE-LINE-2.                                       01560000
015700         10  FILLER                 PIC X(06)     VALUE '*****'.  01570000
015800         10  WS-MESSAGE-2           PIC X(80)     VALUE SPACES.   01580000
015900                                                                  01590000
016000 01  ABEND-CODE                    PIC S9(04)     COMP SYNC       01600000
016100                                                  VALUE ZEROS.    01610000
016200     88 AP-TABLE-FULL                             VALUE +4004.    01620000
016300     88 AP-EMPTY-FILE                             VALUE +4005.    01630000
016400     88 AP-TABLE-NOTFND                           VALUE +4006.    01640000
016500     88 AC-BAD-DATA                               VALUE +4008.    01650000
016600     88 AP-DB2-ERROR                              VALUE +4013.    01660000
016700                                                                  01670000
016800                                                                  01680000
016900*----------------------------------------------------------------*01690000
017000* DB2 SQL ERROR MESSAGE FORMAT AREA                               01700000
017100*----------------------------------------------------------------*01710000
017200                                                                  01720000
017300     COPY DPWS004.                                                01730000
017400                                                                  01740000
017500*----------------------------------------------------------------*01750000
017600* DAILY VERIFIED PRICE DIFFERENCES FILE LAYOUT.                   01760000
017700*----------------------------------------------------------------*01770000
017800                                                                  01780000
017900     COPY RCRD048.                                                01790000
018000                                                                  01800000
018100*----------------------------------------------------------------*01810000
018200* AP DETAIL ADJUSTMENTS FILE LAYOUT.                              01820000
018300*----------------------------------------------------------------*01830000
018400                                                                  01840000
018500     COPY APRD045.                                                01850000
018600                                                                  01860000
018700*---------------------------------------------------------------- 01870000
018800*  WORKING STORAGE AREA FOR DPKUP151                              01880000
018900*---------------------------------------------------------------- 01890000
019000     COPY APWS151.                                                01900000
019000     COPY DPWS951.                                                01901047
019100                                                                  01910000
019200*----------------------------------------------------------------*01920000
019300* ACCOUNTS PAYABLE CONTROL TABLE                                  01930000
019400*----------------------------------------------------------------*01940000
019500                                                                  01950000
019600     EXEC SQL                                                     01960000
019700         INCLUDE TAPCNTL                                          01970000
019800     END-EXEC.                                                    01980000
019900                                                                  01990000
020000*----------------------------------------------------------------*02000000
020100* EXTERNAL ENTITY TABLE                                           02010000
020200*----------------------------------------------------------------*02020000
020300                                                                  02030000
020400     EXEC SQL                                                     02040000
020500         INCLUDE TEXTENT                                          02050000
020600     END-EXEC.                                                    02060000
020700                                                                  02070000
020800*----------------------------------------------------------------*02080000
020900* EXTERNAL ENTITY NAME TABLE                                      02090000
021000*----------------------------------------------------------------*02100000
021100                                                                  02110000
021200     EXEC SQL                                                     02120000
021300         INCLUDE TENTNME                                          02130000
021400     END-EXEC.                                                    02140000
021500                                                                  02150000
021600*----------------------------------------------------------------*02160000
021700* PO - PURCHASE TABLE                                             02170000
021800*----------------------------------------------------------------*02180000
021900                                                                  02190000
022000     EXEC SQL                                                     02200000
022100         INCLUDE TPURCHS                                          02210000
022200     END-EXEC.                                                    02220000
022300                                                                  02230000
022310*----------------------------------------------------------------*02231035
022400*  SKU CROSS REFERENCE TABLE                                      02240035
022410*----------------------------------------------------------------*02241035
022500                                                                  02250035
022600     EXEC SQL                                                     02260035
022700          INCLUDE TSKXREF                                         02270035
022800     END-EXEC.                                                    02280035
022900                                                                  02290035
022910*----------------------------------------------------------------*02291035
023000*  UPC TABLE                                                      02300035
023010*----------------------------------------------------------------*02301035
023100                                                                  02310035
023200     EXEC SQL                                                     02320035
023300          INCLUDE TUPC                                            02330035
023400     END-EXEC.                                                    02340035
023500                                                                  02350035
023510*----------------------------------------------------------------*02351035
023600*    MERCHANDISE AREA VENDOR STYLE TABLE                          02360035
023610*----------------------------------------------------------------*02361035
023700                                                                  02370035
023800     EXEC SQL                                                     02380035
023900          INCLUDE TMDARVS                                         02390035
023910     END-EXEC.                                                    02391035
023920                                                                  02392035
023921*----------------------------------------------------------------*02392135
023930*    VENDOR STYLE TABLE                                           02393035
023931*----------------------------------------------------------------*02393135
023940                                                                  02394035
023950     EXEC SQL                                                     02395035
023960          INCLUDE TVNDSTL                                         02396035
023970     END-EXEC.                                                    02397035
023980                                                                  02398035
024000*----------------------------------------------------------------*02400000
024100* DB2 COMMUNICATION AREA                                          02410000
024200*----------------------------------------------------------------*02420000
024300                                                                  02430000
024400     EXEC SQL                                                     02440000
024500         INCLUDE SQLCA                                            02450000
024600     END-EXEC.                                                    02460000
024700                                                                  02470000
024800*----------------------------------------------------------------*02480000
024900* DB2 COMMUNICATION AREA2                                         02490000
025000*----------------------------------------------------------------*02500000
025100                                                                  02510000
025200     COPY SQLCA2.                                                 02520000
025300                                                                  02530000
025400 PROCEDURE DIVISION.                                              02540000
025500                                                                  02550000
025600 A100-PROGRAM-MAINLINE.                                           02560000
025700                                                                  02570000
025800     PERFORM B100-HOUSEKEEPING.                                   02580011
025900                                                                  02590000
026000     PERFORM B200-PROCESS-PRICE-DIFF                              02600030
026100         UNTIL DLY-PRICE-DIFF-EOF.                                02610000
026200                                                                  02620000
026300     PERFORM B300-END-OF-JOB.                                     02630000
026400                                                                  02640000
026500     GOBACK.                                                      02650000
026600                                                                  02660000
026700*----------------------------------------------------------------*02670000
026800*  B100-HOUSEKEEPING  OPEN FILES, INITIALIZE THE NECESSARY        02680000
026900*  FIELDS, PROCESS THE INVOICE FILE FOR THE FIRST RECORD, AND     02690000
027000*  OPENS THE CURSOR FOR THE FIRST RECORD.                         02700000
027100*----------------------------------------------------------------*02710000
027200                                                                  02720000
027300 B100-HOUSEKEEPING.                                               02730000
027400                                                                  02740000
027500     OPEN INPUT  DLY-PRICE-DIFF-FILE                              02750000
027600          OUTPUT RETAIL-PRICE-ADJ-FILE.                           02760000
027700                                                                  02770000
027800     INITIALIZE AP045-TRANSACTION-FILE                            02780031
027810                DCLTAPCNTL                                        02781031
027820                DCLTENTNME                                        02782031
027830                DCLTEXTENT                                        02783031
027840                DCLTPURCHS.                                       02784031
027900                                                                  02790000
028000     PERFORM S300-SELECT-DATES.                                   02800022
028100     PERFORM S400-SET-CURRENT-TMST.                               02810022
028200                                                                  02820000
028300     PERFORM R100-READ-DLY-PRICE-DIFF-FILE.                       02830000
028400                                                                  02840000
029000                                                                  02900000
029100*---------------------------------------------------------------* 02910000
029200*  B200-PROCESS-PRICE-DIFF.                                     * 02920034
029300*  CONTROLS PROCESSING OF INPUT FILE, GETTING VENDOR INFO       * 02930034
029400*  WHEN THE PO NUMBER CHANGES OR WHEN PROCESSING A STOCK PULL.  * 02940043
029500*---------------------------------------------------------------* 02950000
029600                                                                  02960000
029700 B200-PROCESS-PRICE-DIFF.                                         02970030
029800                                                                  02980030
029810     IF  STOCK-PULL                                               02981035
029820         MOVE RC048-CLASS   TO SKXREF-SUBCLASS                    02982035
029830         MOVE RC048-DEPT    TO SKXREF-DEPT                        02983035
029840         MOVE RC048-SKU-NBR TO SKXREF-SKU                         02984035
029850         PERFORM S500-SELECT-VENDOR-FOR-SKU                       02985037
029860     ELSE                                                         02986035
029900         IF  RC048-PO = SAVE-PO-NBR                               02990035
030000             CONTINUE                                             03000035
030201         ELSE                                                     03020135
030210             MOVE RC048-PO TO PURCHS-PO-NBR                       03021035
030220             PERFORM S200-SELECT-VENDOR-INFO                      03022035
030300         END-IF                                                   03030035
030310     END-IF.                                                      03031035
030400                                                                  03040030
030500     PERFORM C100-FORMAT-ADJ-DETAIL.                              03050031
030600                                                                  03060030
030700     PERFORM R100-READ-DLY-PRICE-DIFF-FILE.                       03070030
030800                                                                  03080030
030900*---------------------------------------------------------------* 03090000
031000*  B300-END-OF-JOB  FORMATS AND WRITES THE CONTROL RECORD AND     03100000
031100*  CLOSES THE INPUT FILE AND OUTPUT FILES.                        03110000
031200*---------------------------------------------------------------* 03120000
031300                                                                  03130000
031400 B300-END-OF-JOB.                                                 03140000
031500                                                                  03150000
031600     IF  OUT-ADJUSTMENT-COUNT > 0                                 03160000
031700         INITIALIZE AP045-KEY-FIELDS                              03170000
031800                    AP045-COMMON-FIELDS                           03180000
031900                    AP045-CONTROL-FIELDS                          03190000
032000         SET AP045-CONTROL-RECORD    TO TRUE                      03200000
032100         MOVE OUT-ADJUSTMENT-COUNT   TO AP045-CTL-RECORD-COUNT    03210000
032200         MOVE PV-CTL-RETAIL-AMT      TO AP045-CTL-RETL-AMT        03220000
032300         PERFORM W100-WRITE-RETL-PRICE-ADJ-REC                    03230000
032400     END-IF.                                                      03240000
032500                                                                  03250000
032600     CLOSE DLY-PRICE-DIFF-FILE                                    03260000
032700           RETAIL-PRICE-ADJ-FILE.                                 03270000
032800                                                                  03280000
032900     DISPLAY 'PRICE CHANGE RECORDS READ  = ' INPUT-COUNT.         03290035
032910     DISPLAY 'STOCK PULL RECORDS READ    = ' STOCK-PULL-COUNT.    03291035
033000     DISPLAY 'ADJUSTMENT RECORDS WRITTEN = ' OUT-ADJUSTMENT-COUNT.03300000
033100                                                                  03310000
033200                                                                  03320006
033300*----------------------------------------------------------------*03330010
033400*  C100-FORMAT-ADJ-DETAIL FORMATS THE 2 OFFSETTING FREIGHT       *03340031
033500*  ADJUSTMENTS (FROM AND TO) AND WRITES THEM TO THE OUT FILE.    *03350000
033600*----------------------------------------------------------------*03360000
033700                                                                  03370000
033800 C100-FORMAT-ADJ-DETAIL.                                          03380031
033810                                                                  03381041
033812     INITIALIZE AP045-KEY-FIELDS                                  03381241
033813                AP045-COMMON-FIELDS                               03381341
033814                AP045-DETAIL-FIELDS.                              03381441
033815                                                                  03381541
033820     COMPUTE PV-RETL-AMT = ((RC048-STORE-UNIT-RETAIL -            03382041
033830                            RC048-PO-UNIT-RETAIL) *               03383041
033840                            RC048-RETAIL-UNITS-MARK).             03384041
033850                                                                  03385041
033860     IF  PV-RETL-AMT < 0                                          03386041
033870         MOVE '4B' TO AP045-AP-TRN-CDE                            03387041
033880         MOVE 'CR' TO AP045-PSTG-TYP-CDE                          03388041
033890     ELSE                                                         03389041
033891         MOVE '4C' TO AP045-AP-TRN-CDE                            03389141
033892         MOVE 'CH' TO AP045-PSTG-TYP-CDE                          03389241
033893     END-IF.                                                      03389341
033894                                                                  03389441
033895     MOVE PV-RETL-AMT               TO AP045-RETL-AMT.            03389541
033900                                                                  03390000
035400     IF  RC048-PO = SAVE-PO-NBR                                   03540030
035500     AND AP045-AP-TRN-CDE = SAVE-AP-TRN-CDE                       03550030
035510     AND EXTENT-DUN-NBR   = SAVE-VND-NBR                          03551037
035520     AND RC048-VERIFY-DATE = SAVE-VERIFY-DATE                     03552043
035600         CONTINUE                                                 03560030
035700     ELSE                                                         03570000
035800         PERFORM S100-GET-NEXT-DOC-NBR                            03580000
035900         MOVE RC048-PO          TO SAVE-PO-NBR                    03590031
036000         MOVE AP045-AP-TRN-CDE  TO SAVE-AP-TRN-CDE                03600031
036010         MOVE EXTENT-DUN-NBR    TO SAVE-VND-NBR                   03601037
036020         MOVE RC048-VERIFY-DATE TO SAVE-VERIFY-DATE               03602043
036100     END-IF.                                                      03610043
036593                                                                  03659340
036700     MOVE EXTENT-DUN-NBR            TO AP045-VND-NBR.             03670000
036800     MOVE WS151-NEXT-DOC-NBR        TO AP045-DOC-NBR.             03680000
036900     MOVE RC048-STORE               TO AP045-STR-NBR.             03690000
036901                                                                  03690135
036910     IF  STOCK-PULL                                               03691035
036920         MOVE SPACES                TO AP045-PO-NBR               03692035
036930     ELSE                                                         03693035
037000         MOVE PURCHS-PO-NBR         TO AP045-PO-NBR               03700035
037010     END-IF.                                                      03701035
037020                                                                  03702035
037100     MOVE RC048-DEPT                TO AP045-DEPT-NBR.            03710000
037200     MOVE RC048-CLASS               TO AP045-CL-NBR.              03720000
037300     MOVE RC048-SKU-NBR             TO AP045-SKU-NBR.             03730000
037400     MOVE PV-CURR-TMST              TO AP045-ENTR-TMST.           03740000
037500     MOVE APCNTL-NEXT-BTCH-PRC-DTE  TO AP045-ENTR-DTE             03750031
037600                                       AP045-PYMT-DUE-DTE         03760031
037700                                       AP045-PS-BTCH-DTE.         03770031
037800     MOVE RC048-VERIFY-DATE         TO AP045-INV-CUTOFF-DTE       03780032
037900                                       AP045-DOC-DTE.             03790031
038000     MOVE 'APKUT095'                TO AP045-ENTR-ID.             03800000
038100     MOVE 'ADJ'                     TO AP045-PS-BTCH-SRC-CDE.     03810000
038200     MOVE '00'                      TO AP045-PS-BTCH-SEQ-NBR.     03820000
038300     MOVE EXTENT-ENT-ID             TO AP045-ENT-ID.              03830000
038400     MOVE ENTNME-ENT-NAME-DESC      TO AP045-ENT-NME-DESC.        03840000
038500     MOVE APCNTL-CURR-PSTG-FYR-NBR  TO AP045-PSTG-FYR-NBR.        03850000
038600     MOVE APCNTL-CURR-PSTG-FMN-NBR  TO AP045-PSTG-FMN-NBR.        03860000
038700     MOVE APCNTL-CURR-PSTG-FWK-NBR  TO AP045-PSTG-FWK-NBR.        03870000
038800     SET AP045-ORGN-ADJUST          TO TRUE.                      03880040
038900     SET AP045-DETAIL-RECORD        TO TRUE.                      03890040
039000     SET AP045-MERCHANDISE          TO TRUE.                      03900040
039300     PERFORM W100-WRITE-RETL-PRICE-ADJ-REC.                       03930000
039400                                                                  03940000
039500     ADD PV-RETL-AMT                TO PV-CTL-RETAIL-AMT          03950000
039600                                       PV-CTL-NET-COST-AMT.       03960000
039700                                                                  03970000
039800*----------------------------------------------------------------*03980000
039900*  R100-READ-DLY-PRICE-DIFF-FILE.                                *03990000
040000*  READS THE DAILY PRICE DIFFERENCE FILE INTO THE RCRD048        *04000000
040100*  COPY BOOK.                                                    *04010000
040200*----------------------------------------------------------------*04020000
040300                                                                  04030000
040400 R100-READ-DLY-PRICE-DIFF-FILE.                                   04040000
040500                                                                  04050000
040600     READ DLY-PRICE-DIFF-FILE INTO RC048-PRICE-DIFFERENCES        04060002
040700         AT END                                                   04070000
040800            SET DLY-PRICE-DIFF-EOF TO TRUE.                       04080000
040900                                                                  04090000
041000     IF  DLY-PRICE-DIFF-EOF                                       04100035
041010         CONTINUE                                                 04101035
041020     ELSE                                                         04102035
041100         ADD 1 TO INPUT-COUNT                                     04110035
041110         IF RC048-REC-SEQ-NBR = 0                                 04111035
041120            SET STOCK-PULL     TO TRUE                            04112035
041121            ADD 1 TO STOCK-PULL-COUNT                             04112135
041130         ELSE                                                     04113035
041140            SET NOT-STOCK-PULL TO TRUE                            04114035
041150         END-IF                                                   04115035
041200     END-IF.                                                      04120000
041300                                                                  04130000
041360                                                                  04136035
041400*----------------------------------------------------------------*04140000
041500*  S100-GET-NEXT-DOC-NBR                                         *04150000
041600*  SELECT THE NEXT AVAILABLE DOC NUMBER FROM THE TAPCNTL TABLE.  *04160000
041700*----------------------------------------------------------------*04170000
041800                                                                  04180000
041900 S100-GET-NEXT-DOC-NBR.                                           04190000
042000                                                                  04200000
042100     CALL DP951-AJ-NEXT-DOC-NBR-ROUTINE                           04210047
042100                     USING WS151-DOC-NBR-PARAMETERS.              04211045
042200                                                                  04220000
042300     IF WS151-ERRORS-FOUND                                        04230000
042400        SET AC-BAD-DATA TO TRUE                                   04240000
042500        MOVE 'S100-GET-NEXT-DOC-NBR' TO WS-ABEND-PARAGRAPH        04250030
042600        MOVE WS151-ERROR-MESSAGE     TO WS-MESSAGE-1              04260030
042700        MOVE WS151-SQLCODE           TO WS-MESSAGE-2              04270030
042800        PERFORM Z998-ABEND                                        04280000
042900     END-IF.                                                      04290000
043000                                                                  04300000
043100*----------------------------------------------------------------*04310000
043200*  S200-SELECT-VENDOR-INFO                                       *04320035
043300*  SELECT ENTITY ID AND THE ENTITY NAME DESCRIPTION FROM A JOIN  *04330000
043400*  OF TEXTENT AND TENTNME TABLES.                                *04340000
043500*----------------------------------------------------------------*04350000
043600                                                                  04360000
043700 S200-SELECT-VENDOR-INFO.                                         04370035
043800                                                                  04380000
043900     EXEC SQL                                                     04390030
044000          SELECT A.PO_NBR                                         04400030
044100               , B.ENT_ID                                         04410030
044200               , B.DUN_NBR                                        04420030
044300               , C.ENT_NAME_DESC                                  04430030
044400            INTO :PURCHS-PO-NBR                                   04440030
044500               , :EXTENT-ENT-ID                                   04450030
044600               , :EXTENT-DUN-NBR                                  04460030
044700               , :ENTNME-ENT-NAME-DESC                            04470030
044800            FROM TPURCHS A                                        04480030
044900               , TEXTENT B                                        04490030
045000               , TENTNME C                                        04500030
045100           WHERE A.PO_NBR = :PURCHS-PO-NBR                        04510033
045200             AND A.ENT_ID = B.ENT_ID                              04520030
045300             AND B.ENT_ID = C.ENT_ID                              04530030
045400             AND C.TYPE_CDE = '01'                                04540030
045500             AND A.VER_STATUS_CDE = 'A'                           04550030
045600     END-EXEC.                                                    04560030
045700                                                                  04570000
045800     EVALUATE TRUE                                                04580030
045900         WHEN SQLCODE = +0                                        04590030
046000              IF ENTNME-ENT-NAME-DESC = SPACE                     04600030
046100                 MOVE 'NO VENDOR PRIMARY NAME FOUND  '            04610030
046200                               TO ENTNME-ENT-NAME-DESC            04620030
046300              END-IF                                              04630030
046400         WHEN SQLWARN0 NOT = SPACES                               04640030
046500         WHEN SQLCODE < +0                                        04650030
046600         WHEN SQLCODE > +0                                        04660030
046700              MOVE 'S200-SELECT-VENDOR-INFO' TO WS-ABEND-PARAGRAPH04670035
046800              MOVE 'UNSUCCESSFUL SELECT' TO WS-ABEND-OPERATION    04680030
046900              MOVE 'TPURCHS '            TO WS-ABEND-STRUCTURE-1  04690030
047000              MOVE 'TEXTENT '            TO WS-ABEND-STRUCTURE-2  04700030
047100              MOVE 'TENTNME '            TO WS-ABEND-STRUCTURE-3  04710030
047200              MOVE RC048-PO              TO WS-ABEND-PO-NBR       04720037
047210              DISPLAY WS-ABEND-PO-NBR-MSG                         04721035
047300              PERFORM Z999-SQL-ERROR                              04730030
047400     END-EVALUATE.                                                04740030
047500                                                                  04750000
047600                                                                  04760000
047700*----------------------------------------------------------------*04770000
047800*  S300-SELECT-DATES                                             *04780000
047900*  SELECT BATCH PROCESS DATE, CURRENT POSTING FISCAL YEAR,       *04790000
048000*  CURRENT POSTING FISCAL MONTH, AND CURRENT POSTING FISCAL WEEK *04800000
048100*  FROM THE TAPCNTL TABLE.                                       *04810000
048200*----------------------------------------------------------------*04820000
048300                                                                  04830000
048400 S300-SELECT-DATES.                                               04840000
048500                                                                  04850000
048600     EXEC SQL                                                     04860030
048700          SELECT BTCH_PRC_DTE                                     04870030
048800               , NEXT_BTCH_PRC_DTE                                04880030
048900               , CURR_PSTG_FYR_NBR                                04890030
049000               , CURR_PSTG_FMN_NBR                                04900030
049100               , CURR_PSTG_FWK_NBR                                04910030
049200          INTO   :APCNTL-BTCH-PRC-DTE                             04920030
049300               , :APCNTL-NEXT-BTCH-PRC-DTE                        04930030
049400               , :APCNTL-CURR-PSTG-FYR-NBR                        04940030
049500               , :APCNTL-CURR-PSTG-FMN-NBR                        04950030
049600               , :APCNTL-CURR-PSTG-FWK-NBR                        04960030
049700          FROM   TAPCNTL                                          04970030
049800     END-EXEC.                                                    04980030
049900                                                                  04990000
050000     EVALUATE TRUE                                                05000030
050100         WHEN SQLCODE = +0                                        05010030
050200              CONTINUE                                            05020030
050300                                                                  05030030
050400         WHEN SQLWARN0 NOT = SPACES                               05040030
050500         WHEN SQLCODE < +0                                        05050030
050600         WHEN SQLCODE > +0                                        05060030
050700              MOVE 'S300-SELECT-DATES' TO WS-ABEND-PARAGRAPH      05070030
050800              MOVE 'UNSUCCESSFUL SELECT' TO WS-ABEND-OPERATION    05080030
050900              MOVE 'TAPCNTL '   TO WS-ABEND-STRUCTURE-1           05090030
051000              PERFORM Z999-SQL-ERROR                              05100030
051100     END-EVALUATE.                                                05110030
051200                                                                  05120000
051300                                                                  05130000
051400*----------------------------------------------------------------*05140000
051500*  S400-SET-CURENT-TMST  GETS THE CURRENT TIMESTAMP FROM DB2.    *05150000
051600*----------------------------------------------------------------*05160000
051700                                                                  05170000
051800 S400-SET-CURRENT-TMST.                                           05180000
051900                                                                  05190000
052000     EXEC SQL                                                     05200030
052100          SET :PV-CURR-TMST = CURRENT TIMESTAMP                   05210030
052200     END-EXEC                                                     05220030
052300                                                                  05230000
052400     EVALUATE TRUE                                                05240030
052500         WHEN SQLCODE = +0                                        05250030
052600              CONTINUE                                            05260030
052700         WHEN SQLWARN0 NOT = SPACES                               05270030
052800         WHEN SQLCODE < +0                                        05280030
052900         WHEN SQLCODE > +0                                        05290030
053000              MOVE 'S400-SET-CURRENT-TMST' TO WS-ABEND-PARAGRAPH  05300030
053100              MOVE 'UNSUCCESSFUL SET TMST' TO WS-ABEND-OPERATION  05310030
053200              PERFORM Z999-SQL-ERROR                              05320030
053300     END-EVALUATE.                                                05330033
053400                                                                  05340000
053401*----------------------------------------------------------------*05340135
053402*  S500-SELECT-VENDOR-FOR-SKU                                    *05340237
053403*  SELECT ENTITY ID AND THE ENTITY NAME DESCRIPTION FROM A JOIN  *05340335
053404*  OF TEXTENT,TSKXREF, TUPC, TMDARV AND TVNDSTL TABLES.          *05340435
053405*----------------------------------------------------------------*05340535
053406                                                                  05340635
053407 S500-SELECT-VENDOR-FOR-SKU.                                      05340737
053408                                                                  05340835
053410     EXEC SQL                                                     05341035
053420          SELECT  E.ENT_ID                                        05342035
053430                 ,E.DUN_NBR                                       05343035
053431                 ,N.ENT_NAME_DESC                                 05343135
053440            INTO :EXTENT-ENT-ID                                   05344035
053450                ,:EXTENT-DUN-NBR                                  05345035
053451                ,:ENTNME-ENT-NAME-DESC                            05345135
053460            FROM  TSKXREF   A                                     05346035
053470                 ,TUPC      B                                     05347035
053480                 ,TMDARVS   C                                     05348035
053490                 ,TVNDSTL   D                                     05349035
053491                 ,TEXTENT   E                                     05349135
053492                 ,TENTNME   N                                     05349235
053493           WHERE  A.SKU              = :SKXREF-SKU                05349336
053494***          AND  A.SUBCLASS         = :SKXREF-SUBCLASS           05349436
053495***          AND  A.DEPT             = :SKXREF-DEPT               05349536
053497             AND  A.SKU_STAT_CDE NOT IN ('98')                    05349736
053498             AND  A.INTR_UPC_ID      = B.INTR_UPC_ID              05349836
053499             AND  B.SUB_CL_MDSEAR_ID = C.SUB_CL_MDSEAR_ID         05349936
053500             AND  B.VS_ID            = C.VS_ID                    05350036
053501             AND  C.VS_ID            = D.VS_ID                    05350136
053502             AND  D.ENT_ID           = E.ENT_ID                   05350236
053503             AND  D.ENT_ID           = N.ENT_ID                   05350336
053504             AND  N.TYPE_CDE         = '01'                       05350436
053505             AND  B.UPC_TYP_CDE      = 'I'                        05350538
053506             AND  B.EFF_END_DTE IS NULL                           05350638
053507             AND  D.EFF_END_DTE IS NULL                           05350738
053508     END-EXEC.                                                    05350838
053509                                                                  05350938
053510     EVALUATE TRUE                                                05351038
053511         WHEN SQLCODE = +0                                        05351138
053512              IF ENTNME-ENT-NAME-DESC = SPACE                     05351238
053513                 MOVE 'NO VENDOR PRIMARY NAME FOUND  '            05351338
053514                               TO ENTNME-ENT-NAME-DESC            05351438
053515              END-IF                                              05351538
053516         WHEN SQLWARN0 NOT = SPACES                               05351638
053517         WHEN SQLCODE < +0                                        05351738
053518         WHEN SQLCODE > +0                                        05351838
053519              MOVE 'S500-SELECT-VENDOR-INFO' TO WS-ABEND-PARAGRAPH05351938
053520              MOVE 'UNSUCCESSFUL SELECT' TO WS-ABEND-OPERATION    05352038
053521              MOVE 'TSKXREF '            TO WS-ABEND-STRUCTURE-1  05352138
053522              MOVE 'TUPC    '            TO WS-ABEND-STRUCTURE-2  05352238
053523              MOVE 'TMDARVS '            TO WS-ABEND-STRUCTURE-3  05352338
053524              MOVE 'TVNDSTL '            TO WS-ABEND-STRUCTURE-4  05352438
053525              MOVE 'TEXTENT '            TO WS-ABEND-STRUCTURE-5  05352538
053526              MOVE 'TENTNME '            TO WS-ABEND-STRUCTURE-6  05352638
053527              MOVE RC048-SKU-NBR         TO WS-ABEND-SKU-NBR      05352738
053528              DISPLAY WS-ABEND-SKU-NBR-MSG                        05352838
053529              PERFORM Z999-SQL-ERROR                              05352938
053530     END-EVALUATE.                                                05353038
053531                                                                  05353138
053540*----------------------------------------------------------------*05354036
053600*  W100-WRITE-RETL-PRICE-ADJ-REC.                                *05360000
053700*  WRITES TO THE RETAIL PRICE ADJUSTMENT OUTPUT FILE.            *05370000
053800*----------------------------------------------------------------*05380000
053900                                                                  05390000
054000 W100-WRITE-RETL-PRICE-ADJ-REC.                                   05400000
054100                                                                  05410000
054200     WRITE RETAIL-PRICE-ADJ-RECORD FROM AP045-TRANSACTION-FILE.   05420000
054300                                                                  05430000
054400     ADD 1 TO OUT-ADJUSTMENT-COUNT.                               05440000
054500                                                                  05450000
054600                                                                  05460000
054700*----------------------------------------------------------------*05470000
054800* Z998-ABEND                                                     *05480000
054900*  ABEND ROUTINE.                                                *05490000
055000*----------------------------------------------------------------*05500000
055100 Z998-ABEND.                                                      05510000
055200                                                                  05520000
055300     DISPLAY WS-ABEND-LITERAL.                                    05530000
055400     DISPLAY WS-ABEND-PROGRAM-MSG.                                05540000
055500     DISPLAY WS-ABEND-PARAGRAPH-MSG.                              05550000
055600     DISPLAY WS-MESSAGE-LINE-1.                                   05560000
055700     DISPLAY WS-MESSAGE-LINE-2.                                   05570000
055800                                                                  05580000
055900     CALL 'ILBOABN0' USING ABEND-CODE.                            05590000
056000                                                                  05600000
056100*----------------------------------------------------------------*05610000
056200*  PROCESS DB2 ABENDS.                                           *05620000
056300*----------------------------------------------------------------*05630000
056400                                                                  05640000
056500 Z999-SQL-ERROR.                                                  05650000
056600                                                                  05660000
056700     DISPLAY '*** DB2 ERROR '.                                    05670000
056800     DISPLAY WS-ABEND-PROGRAM-MSG.                                05680000
056900     DISPLAY WS-ABEND-PARAGRAPH-MSG.                              05690000
057000     DISPLAY WS-ABEND-OPERATION-MSG.                              05700000
057100     DISPLAY WS-ABEND-TABLE1-MSG.                                 05710000
057200     IF WS-ABEND-STRUCTURE-2 > SPACES                             05720000
057300         DISPLAY WS-ABEND-TABLE2-MSG                              05730023
057400     END-IF.                                                      05740023
057500     IF WS-ABEND-STRUCTURE-3 > SPACES                             05750015
057600         DISPLAY WS-ABEND-TABLE3-MSG                              05760023
057700     END-IF.                                                      05770023
057800     IF WS-ABEND-STRUCTURE-4 > SPACES                             05780036
057810         DISPLAY WS-ABEND-TABLE4-MSG                              05781036
057820     END-IF.                                                      05782035
057830     IF WS-ABEND-STRUCTURE-5 > SPACES                             05783036
057840         DISPLAY WS-ABEND-TABLE5-MSG                              05784036
057850     END-IF.                                                      05785036
057860     IF WS-ABEND-STRUCTURE-6 > SPACES                             05786036
057870         DISPLAY WS-ABEND-TABLE6-MSG                              05787036
057880     END-IF.                                                      05788036
057900                                                                  05790000
058000     SET AP-DB2-ERROR              TO TRUE.                       05800000
058100                                                                  05810000
058200     COPY DPPD004.                                                05820000
058300     CALL 'ILBOABN0' USING ABEND-CODE.                            05830000
