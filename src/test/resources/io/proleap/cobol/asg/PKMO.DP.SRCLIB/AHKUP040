000100 IDENTIFICATION DIVISION.                                         00010012
000200 PROGRAM-ID.         AHKUP040.                                    00020012
000300 AUTHOR.             NANCY EILBES.                                00030012
000400 DATE-WRITTEN.       APRIL 2000.                                  00040012
000500 DATE-COMPILED.                                                   00050012
000600*************************************************************     00060012
000700*    COBOL 2 WITH SQL                                       *     00070012
000800*                                                           *     00080012
000900*   AHKUP040 - ARCHIVE HISTORY DATA DELETION - TMESTDS      *     00090012
001000*                                                           *     00100012
001100*   PROGRAM OVERVIEW:                                       *     00110012
001200*                                                           *     00120012
001300*  THIS PROGRAM DELETES "OLD" ROWS FROM DB2 TABLE TMESTDS.  *     00130012
001400*  ROWS DELETED ARE THOSE PREVIOUSLY - IDENTIFIED/EXTRACTED *     00140012
001500*  WITHIN THE ARCHIVE/HISTORY SYSTEM.                       *     00150012
001600*                                                           *     00160012
001700*  THE EXTRACT FILE USED AS INPUT WILL BE SORTED BY THE     *     00170012
001800*  UNIQUE INDEX COLUMNS TO SPEED THE DELETION PROCESS.      *     00180012
001900*  THESE COLUMNS ARE PO_NBR, PO_LNE_NBR, PLAN_NBR, STR_NBR. *     00190012
002000*                                                           *     00200012
002100*   INPUT:                                                  *     00210012
002200*                                                           *     00220012
002300*     1. TMESTDS DELETION FILE  COPYBOOK DCLTMESTDS         *     00230012
002400*                                                           *     00240012
002500*   DB2 TABLES:                                             *     00250012
002600*                                                           *     00260012
002700*        TMESTDS - PO MDS STORE DISTRO TABLE                *     00270012
002800*        TCKRSTIN - CHECKPOINT/RESTART INFO TABLE           *     00280012
002900*        TCKRSTCN - CHECKPOINT/RESTART CONTROL TABLE        *     00290012
003000*                                                           *     00300012
003100*************************************************************     00310012
P5207 * DATE: 11/18/2013 CHANGE MADE BY: COGNIZANT(SHEBENA)       *     00320019
P5207 * CHANGE MADE: MODIFIED THE PROGRAM TO REMOVE THE           *     00321019
P5207 *              PO_IN_RMS_IND CHECK BEFORE DELETE.           *     00322019
P5207 * CHANGE TAG - P5207, CR NO - CHG0081355                    *     00323020
003300*************************************************************     00330012
003400 EJECT                                                            00340012
003500 ENVIRONMENT DIVISION.                                            00350012
003600 CONFIGURATION SECTION.                                           00360012
003700 SOURCE-COMPUTER.        IBM-370.                                 00370012
003800 OBJECT-COMPUTER.        IBM-370.                                 00380012
003900                                                                  00390012
004000 INPUT-OUTPUT SECTION.                                            00400012
004100 FILE-CONTROL.                                                    00410012
004200     SELECT TMESTDS-EXTRACT-FILE ASSIGN TO INP01.                 00420012
004300                                                                  00430012
004400 DATA DIVISION.                                                   00440012
004500 FILE SECTION.                                                    00450012
004600 FD  TMESTDS-EXTRACT-FILE                                         00460012
004700     RECORDING MODE IS F                                          00470012
004800     LABEL RECORDS ARE STANDARD                                   00480012
004900     BLOCK CONTAINS 0 RECORDS                                     00490012
005000     RECORD CONTAINS 24 CHARACTERS                                00500012
005100     DATA RECORD IS TMESTDS-EXTRACT-DATA.                         00510012
005200 01  TMESTDS-EXTRACT-DATA       PIC X(24).                        00520012
005300                                                                  00530012
005400                                                                  00540012
005500 EJECT                                                            00550012
005600 WORKING-STORAGE SECTION.                                         00560012
005700                                                                  00570012
005800 01  FILLER                       PIC X(58)     VALUE             00580012
005900     '************WORKING STORAGE STARTS HERE*******************'.00590012
006000                                                                  00600012
006100 01  PV-PROGRAM-VARIABLES.                                        00610012
006200     05  PV-PROGRAM-NAME          PIC  X(08)    VALUE 'AHKUP040'. 00620012
006300     05  PV-CKPT-STAT-CODE        PIC X(01)     VALUE SPACE.      00630012
006400     05  PV-CURRENT-PARAGRAPH     PIC X(50)     VALUE SPACES.     00640012
006500     05  PV-CURRENT-TMST          PIC X(26)     VALUE SPACES.     00650012
006600                                                                  00660012
006700     05  PV-TMESTDS-INPUT-COUNT   PIC 9(09)     VALUE ZERO        00670012
006800                                                COMP-3.           00680012
006900     05  PV-TMESTDS-DELETE-COUNT  PIC 9(09)     VALUE ZERO        00690012
007000                                                COMP-3.           00700012
007100     05  PV-SQL-DELETE-COUNT      PIC 9(09)     VALUE ZERO        00710012
007200                                                COMP-3.           00720012
007300     05  PV-SQLERRD3              PIC S9(09)    VALUE ZERO        00730012
007400                                                COMP-3.           00740012
007500     05  PV-DISP-PO-NBR           PIC X(09)    VALUE SPACES.      00750012
007600     05  PV-DISP-LNE-NBR          PIC X(09)    VALUE SPACES.      00760012
007700     05  PV-DISP-PLAN-NBR         PIC X(09)    VALUE SPACES.      00770012
007800     05  PV-DISP-STR-NBR          PIC X(09)    VALUE SPACES.      00780012
008000     05  PV-SAVE-PO-NBR           PIC S9(09) COMP                 00800012
008100                                               VALUE ZEROES.      00810012
008200 01  PC-PROGRAM-CONSTANTS.                                        00820012
008300     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          00830012
008400                                                COMP SYNC.        00840012
008500     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      00850012
008600     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00860012
008700     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00870012
008800                                                                  00880012
008900 01  PS-PROGRAM-SWITCHES.                                         00890012
009000     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.        00900012
009100         88  COMMITS-TAKEN                      VALUE 'T'.        00910012
009200         88  NO-COMMITS-TAKEN                   VALUE 'N'.        00920012
009300     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.        00930012
009400         88  MORE-EXTRACT                       VALUE 'M'.        00940012
009500         88  END-OF-EXTRACT                     VALUE 'E'.        00950012
009600     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        00960012
009700         88  NORMAL-RUN                         VALUE '0'.        00970012
009800         88  RESTART-RUN                        VALUE '9'.        00980012
010200                                                                  01020012
010300 01  WS-COUNTER.                                                  01030012
010400     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.     01040012
010500     05  WS-TMST                  PIC X(26)     VALUE SPACES.     01050012
010600                                                                  01060012
010700 01  CKPT-RESTART-INFO.                                           01070012
010800     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.       01080012
010900                                                                  01090012
011000*----------------------------------------------------------------*01100012
011100*  ABEND DATA AREAS                                              *01110012
011200*----------------------------------------------------------------*01120012
011300 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01130012
011400                                             COMP SYNC.           01140012
011500     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         01150012
011600     88  AC-BAD-DATA                         VALUE +4008.         01160012
011700     88  AC-DB2-ERROR                        VALUE +4013.         01170012
011800     88  AC-DATE-ERROR                       VALUE +4019.         01180012
011900                                                                  01190012
012000                                                                  01200012
012100 01  ABEND-AREAS.                                                 01210012
012200     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01220012
012300             '*****       ABEND'.                                 01230012
012400     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01240012
012500             '*****   PROGRAM: AHKUP040'.                         01250012
012600     05  AA-PARAGRAPH-LIT.                                        01260012
012700         10  FILLER              PIC  X(17)  VALUE                01270012
012800             '***** PARAGRAPH: '.                                 01280012
012900         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01290012
013000     05  AA-MESSAGE-LINE-1.                                       01300012
013100         10  FILLER              PIC  X(06)  VALUE '*****'.       01310012
013200         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01320012
013300     05  AA-MESSAGE-LINE-2.                                       01330012
013400         10  FILLER              PIC  X(06)  VALUE '*****'.       01340012
013500         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01350012
013600     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01360012
013700             '*****    DB2 ERROR'.                                01370012
013800     05  AA-DB2-OPERATION-LIT.                                    01380012
013900         10  FILLER              PIC  X(17)  VALUE                01390012
014000             '***** OPERATION: '.                                 01400012
014100         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01410012
014200     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01420012
014300     EJECT                                                        01430012
014400                                                                  01440012
014500     COPY DPWS004.                                                01450012
014600     EJECT                                                        01460012
014700*----------------------------------------------------------------*01470012
014800*      TMESTDS TABLE LAYOUT                                       01480012
014900*----------------------------------------------------------------*01490012
015000         EXEC SQL                                                 01500012
015100             INCLUDE TMESTDS                                      01510012
015200         END-EXEC.                                                01520012
015300                                                                  01530012
015400*----------------------------------------------------------------*01540012
015500*      TPURCHS TABLE LAYOUT                                       01550012
015600*----------------------------------------------------------------*01560012
015700         EXEC SQL                                                 01570012
015800             INCLUDE TPURCHS                                      01580012
015900         END-EXEC.                                                01590012
016000                                                                  01600012
016100*----------------------------------------------------------------*01610012
016200*      TCKRSTCNTL TABLE LAYOUT                                    01620012
016300*----------------------------------------------------------------*01630012
016400         EXEC SQL                                                 01640012
016500             INCLUDE TCKRSTCN                                     01650012
016600         END-EXEC.                                                01660012
016700                                                                  01670012
016800*----------------------------------------------------------------*01680012
016900*      TCKRSTINF TABLE LAYOUT                                     01690012
017000*----------------------------------------------------------------*01700012
017100         EXEC SQL                                                 01710012
017200             INCLUDE TCKRSTIN                                     01720012
017300         END-EXEC.                                                01730012
017400 EJECT                                                            01740012
017500*----------------------------------------------------------------*01750012
017600*  DB2 COMMUNICATION AREA                                         01760012
017700*----------------------------------------------------------------*01770012
017800*                                                                 01780012
017900     EXEC SQL                                                     01790012
018000         INCLUDE SQLCA                                            01800012
018100     END-EXEC.                                                    01810012
018200                                                                  01820012
018300*----------------------------------------------------------------*01830012
018400*  DB2 COMMUNICATION AREA2                                        01840012
018500*----------------------------------------------------------------*01850012
018600*                                                                 01860012
018700     COPY SQLCA2.                                                 01870012
018800     EJECT                                                        01880012
018900 PROCEDURE DIVISION.                                              01890012
019000 A100-MAINLINE-ROUTINE.                                           01900012
019100                                                                  01910012
019200     PERFORM B100-INITIALIZATION.                                 01920012
019300                                                                  01930012
019400     PERFORM B200-TMESTDS-EXTRACT-PROCESS                         01940012
019500       UNTIL END-OF-EXTRACT.                                      01950012
019600                                                                  01960012
019700     PERFORM B300-EOJ-PROCESSING.                                 01970012
019800                                                                  01980012
019900     GOBACK.                                                      01990012
020000 EJECT                                                            02000012
020100 B100-INITIALIZATION.                                             02010012
020200                                                                  02020012
020300     EXEC SQL                                                     02030012
020400         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 02040012
020500     END-EXEC.                                                    02050012
020600                                                                  02060012
020700     PERFORM X300-GET-CHECKPOINT-CNTL.                            02070012
020800     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    02080012
020900                                                                  02090012
021000     OPEN INPUT TMESTDS-EXTRACT-FILE.                             02100012
021100                                                                  02110012
021200     IF RESTART-RUN                                               02120012
021300         PERFORM X200-CHECKPOINT-RESTART                          02130012
021400     ELSE                                                         02140012
021500         PERFORM R100-READ-EXTRACT-FILE                           02150012
021600     END-IF.                                                      02160012
021700                                                                  02170012
021800     PERFORM X500-SET-CHECKPOINT-TIME.                            02180012
021900                                                                  02190012
022000                                                                  02200012
022100     EJECT                                                        02210012
022200 B200-TMESTDS-EXTRACT-PROCESS.                                    02220012
022300                                                                  02230012
022400     MOVE MESTDS-PO-NBR             TO PV-DISP-PO-NBR.            02240012
022500     MOVE MESTDS-PO-LNE-NBR         TO PV-DISP-LNE-NBR.           02250012
022600     MOVE MESTDS-PLAN-NBR           TO PV-DISP-PLAN-NBR.          02260012
022700     MOVE MESTDS-STR-NBR            TO PV-DISP-STR-NBR.           02270012
022800     IF MESTDS-PO-NBR NOT = PV-SAVE-PO-NBR                        02280012
022900         MOVE MESTDS-PO-NBR TO PV-SAVE-PO-NBR                     02290012
023100     END-IF.                                                      02310012
023200                                                                  02320012
023400     PERFORM D100-DELETE-TMESTDS                                  02340018
023600                                                                  02360012
023700     PERFORM X100-CHECKPOINT-CHECK.                               02370012
023800                                                                  02380012
023900     PERFORM R100-READ-EXTRACT-FILE.                              02390012
024000     EJECT                                                        02400012
024100                                                                  02410012
024200                                                                  02420012
024300 B300-EOJ-PROCESSING.                                             02430012
024400                                                                  02440012
024500     DISPLAY '** AHKUP040 SUMMARY **'.                            02450012
024600     DISPLAY '** TMESTDS INPUT COUNT = ' PV-TMESTDS-INPUT-COUNT.  02460012
024700     DISPLAY '** TMESTDS DELETE COUNT = ' PV-TMESTDS-DELETE-COUNT.02470012
024800     DISPLAY '** SQL DELETE COUNT = ' PV-SQL-DELETE-COUNT.        02480012
024900                                                                  02490012
025000     CLOSE  TMESTDS-EXTRACT-FILE.                                 02500012
025100                                                                  02510012
025200     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02520012
025300     PERFORM X600-UPDATE-TCKRSTCNTL.                              02530012
025400                                                                  02540012
025500     EJECT                                                        02550012
033100*                                                                 03310013
033200*----------------------------------------------------------------*03320012
033300*    DELETES FROM THE TMESTDS TABLE.  CASCADE DELETE WILL ALSO   *03330012
033400*    CAUSE ROWS TO BE DELETED FROM TMIITEM, TVNDINV AND TEXINVC  *03340012
033500*    TABLES.                                                     *03350012
033600*----------------------------------------------------------------*03360012
033700 D100-DELETE-TMESTDS.                                             03370012
033800                                                                  03380012
033900     MOVE 'D100-DELETE-TMESTDS' TO PV-CURRENT-PARAGRAPH.          03390012
034000                                                                  03400012
034100     PERFORM WITH TEST AFTER                                      03410012
034200        VARYING PC-RETRY-COUNT FROM 1 BY 1                        03420012
034300          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                     03430012
034400             OR SQLCODE = ZERO                                    03440012
034500                                                                  03450012
034600         EXEC SQL                                                 03460012
034700              DELETE                                              03470012
034800                FROM TMESTDS                                      03480012
034900               WHERE PO_NBR     = :MESTDS-PO-NBR                  03490012
035000                 AND PO_LNE_NBR = :MESTDS-PO-LNE-NBR              03500012
035100                 AND PLAN_NBR   = :MESTDS-PLAN-NBR                03510012
035200                 AND STR_NBR    = :MESTDS-STR-NBR                 03520012
035300         END-EXEC                                                 03530012
035400                                                                  03540012
035500         EVALUATE TRUE                                            03550012
035600             WHEN SQLCODE = ZERO                                  03560012
035700                 ADD 1 TO PV-TMESTDS-DELETE-COUNT                 03570012
035800                 MOVE SQLERRD(3) TO PV-SQLERRD3                   03580012
035900                 ADD PV-SQLERRD3 TO PV-SQL-DELETE-COUNT           03590012
036000                                                                  03600012
036100             WHEN SQLCODE = -904                                  03610012
036200             WHEN SQLCODE = -913                                  03620012
036300             WHEN SQLCODE = +100                                  03630012
036400                  CONTINUE                                        03640012
036500                                                                  03650012
036600             WHEN SQLWARN0 NOT = SPACES                           03660012
036700             WHEN SQLCODE  NOT = ZERO                             03670012
036800                 MOVE PV-CURRENT-PARAGRAPH                        03680012
036900                                     TO AA-PARAGRAPH-NAME         03690012
037000                 DISPLAY '******** PO NUMBER:'                    03700012
037100                          PV-DISP-PO-NBR                          03710012
037200                 DISPLAY '******** PO LNE NBR:'                   03720012
037300                          PV-DISP-LNE-NBR                         03730012
037400                 DISPLAY '******** PLAN NBR:'                     03740012
037500                          PV-DISP-PLAN-NBR                        03750012
037600                 DISPLAY '******** STR NBR:'                      03760012
037700                          PV-DISP-STR-NBR                         03770012
037800                 MOVE SPACES TO AA-MESSAGE-1                      03780012
037900                                AA-MESSAGE-2                      03790012
038000                 MOVE 'UNSUCCESSFUL DELETE'                       03800012
038100                                     TO AA-DB2-OPERATION          03810012
038200                 MOVE 'TMESTDS'      TO AA-DB2-TABLE              03820012
038300                 PERFORM Z999-DB2-ABEND                           03830012
038400         END-EVALUATE                                             03840012
038500     END-PERFORM.                                                 03850012
038600                                                                  03860012
038700     IF PC-RETRY-COUNT > PC-RETRY-MAX                             03870012
038800         MOVE PV-CURRENT-PARAGRAPH                                03880012
038900                             TO AA-PARAGRAPH-NAME                 03890012
039000         DISPLAY '******** PO NUMBER:'                            03900012
039100                          PV-DISP-PO-NBR                          03910012
039200         DISPLAY '******** PO LNE NBR :'                          03920012
039300                          PV-DISP-LNE-NBR                         03930012
039400         DISPLAY '******** PLAN NBR :'                            03940012
039500                          PV-DISP-PLAN-NBR                        03950012
039600         DISPLAY '******** STR NBR:'                              03960012
039700                          PV-DISP-STR-NBR                         03970012
039800         MOVE SPACES TO AA-MESSAGE-1                              03980012
039900                        AA-MESSAGE-2                              03990012
040000         MOVE 'MAX RETRIES EXCEEDED ON DELETE'                    04000012
040100                             TO AA-DB2-OPERATION                  04010012
040200         MOVE 'TMESTDS'      TO AA-DB2-TABLE                      04020012
040300         PERFORM Z999-DB2-ABEND                                   04030012
040400     END-IF.                                                      04040012
040500                                                                  04050012
040600     EJECT                                                        04060012
040700 R100-READ-EXTRACT-FILE.                                          04070012
040800                                                                  04080012
040900     READ TMESTDS-EXTRACT-FILE                                    04090012
041000          INTO DCLTMESTDS                                         04100012
041100          AT END SET END-OF-EXTRACT TO TRUE.                      04110012
041200                                                                  04120012
041300     IF MORE-EXTRACT                                              04130012
041400         ADD 1 TO PV-TMESTDS-INPUT-COUNT                          04140012
041500     END-IF.                                                      04150012
041600                                                                  04160012
041700                                                                  04170012
041800     EJECT                                                        04180012
041900*----------------------------------------------------------------*04190012
042000*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *04200012
042100*----------------------------------------------------------------*04210012
042200 X100-CHECKPOINT-CHECK.                                           04220012
042300                                                                  04230012
042400     MOVE 'X100-CHECKPOINT-CHECK' TO PV-CURRENT-PARAGRAPH.        04240012
042500                                                                  04250012
042600     EXEC SQL                                                     04260012
042700       SET :WS-TMST = CURRENT TIMESTAMP                           04270012
042800     END-EXEC.                                                    04280012
042900                                                                  04290012
043000     IF SQLCODE = +0                                              04300012
043100         CONTINUE                                                 04310012
043200     ELSE                                                         04320012
043300         MOVE PV-CURRENT-PARAGRAPH                                04330012
043400                             TO AA-PARAGRAPH-NAME                 04340012
043500         MOVE SPACES TO AA-MESSAGE-1                              04350012
043600                        AA-MESSAGE-2                              04360012
043700         MOVE 'BAD SET COMMAND'                                   04370012
043800                             TO AA-DB2-OPERATION                  04380012
043900         MOVE SPACES             TO AA-DB2-TABLE                  04390012
044000         PERFORM Z999-DB2-ABEND                                   04400012
044100     END-IF.                                                      04410012
044200                                                                  04420012
044300     IF WS-TMST > WS-HOLD-TMST                                    04430012
044400         IF NO-COMMITS-TAKEN                                      04440012
044500             MOVE PC-IN-PROCESS-CODE TO PV-CKPT-STAT-CODE         04450012
044600             PERFORM X600-UPDATE-TCKRSTCNTL                       04460012
044700             SET COMMITS-TAKEN TO TRUE                            04470012
044800         END-IF                                                   04480012
044900         PERFORM X700-UPDATE-TCKRSTINF                            04490012
045000         PERFORM Y100-COMMIT                                      04500012
045100         PERFORM X500-SET-CHECKPOINT-TIME                         04510012
045200     END-IF.                                                      04520012
045300                                                                  04530012
045400 EJECT                                                            04540012
045500*----------------------------------------------------------------*04550012
045600*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *04560012
045700*----------------------------------------------------------------*04570012
045800 X200-CHECKPOINT-RESTART.                                         04580012
045900                                                                  04590012
046000     MOVE 'X200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.      04600012
046100                                                                  04610012
046200     PERFORM X400-GET-CHECKPOINT-INFO.                            04620012
046300     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     04630012
046400                                                                  04640012
046500     DISPLAY '** AHKUP040 CHECKPOINT RESTART **'                  04650012
046600     DISPLAY '** EXTRACT RECS BYPASSED ON RESTART = '             04660012
046700              CR-EXTRACT-RECS-WORKED.                             04670012
046800     DISPLAY '***********************************************'    04680012
046900                                                                  04690012
047000     PERFORM R100-READ-EXTRACT-FILE                               04700012
047100         CR-EXTRACT-RECS-WORKED TIMES.                            04710012
047200     PERFORM R100-READ-EXTRACT-FILE.                              04720012
047300 EJECT                                                            04730012
047400*----------------------------------------------------------------*04740012
047500*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *04750012
047600*----------------------------------------------------------------*04760012
047700 X300-GET-CHECKPOINT-CNTL.                                        04770012
047800                                                                  04780012
047900     MOVE 'X300-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     04790012
048000                                                                  04800012
048100     PERFORM WITH TEST AFTER                                      04810012
048200             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04820012
048300             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04830012
048400                     SQLCODE = ZERO                               04840012
048500                                                                  04850012
048600             EXEC SQL                                             04860012
048700              SELECT CKPT_STAT_CODE                               04870012
048800               INTO :PV-CKPT-STAT-CODE                            04880012
048900               FROM TCKRSTCNTL                                    04890012
049000               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04900012
049100             END-EXEC                                             04910012
049200                                                                  04920012
049300             EVALUATE TRUE                                        04930012
049400                 WHEN SQLCODE = ZERO                              04940012
049500                 WHEN SQLCODE = -904                              04950012
049600                 WHEN SQLCODE = -913                              04960012
049700                      CONTINUE                                    04970012
049800                                                                  04980012
049900                 WHEN SQLWARN0 NOT = SPACES                       04990012
050000                 WHEN SQLCODE  NOT = ZERO                         05000012
050100                     MOVE PV-CURRENT-PARAGRAPH                    05010012
050200                                         TO AA-PARAGRAPH-NAME     05020012
050300                     DISPLAY '******** PLAN_NAME:'                05030012
050400                              PV-PROGRAM-NAME                     05040012
050500                     MOVE SPACES TO AA-MESSAGE-1                  05050012
050600                                    AA-MESSAGE-2                  05060012
050700                     MOVE 'UNSUCCESSFUL SELECT'                   05070012
050800                                         TO AA-DB2-OPERATION      05080012
050900                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05090012
051000                     PERFORM Z999-DB2-ABEND                       05100012
051100             END-EVALUATE                                         05110012
051200     END-PERFORM.                                                 05120012
051300                                                                  05130012
051400     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05140012
051500         MOVE PV-CURRENT-PARAGRAPH                                05150012
051600                             TO AA-PARAGRAPH-NAME                 05160012
051700         DISPLAY '******** PLAN_NAME:'                            05170012
051800                  PV-PROGRAM-NAME                                 05180012
051900         MOVE SPACES TO AA-MESSAGE-1                              05190012
052000                        AA-MESSAGE-2                              05200012
052100         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05210012
052200                             TO AA-DB2-OPERATION                  05220012
052300         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05230012
052400         PERFORM Z999-DB2-ABEND                                   05240012
052500     END-IF.                                                      05250012
052600                                                                  05260012
052700 EJECT                                                            05270012
052800*----------------------------------------------------------------*05280012
052900*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *05290012
053000*----------------------------------------------------------------*05300012
053100 X400-GET-CHECKPOINT-INFO.                                        05310012
053200                                                                  05320012
053300     MOVE 'X400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     05330012
053400                                                                  05340012
053500     PERFORM WITH TEST AFTER                                      05350012
053600             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05360012
053700             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05370012
053800                     SQLCODE = ZERO                               05380012
053900                                                                  05390012
054000             EXEC SQL                                             05400012
054100              SELECT WORK_STRG_DESC                               05410012
054200               INTO :TCKRSTINF-WORK-STRG-DESC                     05420012
054300               FROM TCKRSTINF                                     05430012
054400               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05440012
054500             END-EXEC                                             05450012
054600                                                                  05460012
054700             EVALUATE TRUE                                        05470012
054800                 WHEN SQLCODE = ZERO                              05480012
054900                 WHEN SQLCODE = -904                              05490012
055000                 WHEN SQLCODE = -913                              05500012
055100                      CONTINUE                                    05510012
055200                                                                  05520012
055300                 WHEN SQLWARN0 NOT = SPACES                       05530012
055400                 WHEN SQLCODE  NOT = ZERO                         05540012
055500                     MOVE PV-CURRENT-PARAGRAPH                    05550012
055600                                         TO AA-PARAGRAPH-NAME     05560012
055700                     DISPLAY '******** PLAN_NAME:'                05570012
055800                              PV-PROGRAM-NAME                     05580012
055900                     MOVE SPACES TO AA-MESSAGE-1                  05590012
056000                                    AA-MESSAGE-2                  05600012
056100                     MOVE 'UNSUCCESSFUL SELECT'                   05610012
056200                                         TO AA-DB2-OPERATION      05620012
056300                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          05630012
056400                     PERFORM Z999-DB2-ABEND                       05640012
056500             END-EVALUATE                                         05650012
056600     END-PERFORM.                                                 05660012
056700                                                                  05670012
056800     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05680012
056900         MOVE PV-CURRENT-PARAGRAPH                                05690012
057000                             TO AA-PARAGRAPH-NAME                 05700012
057100         DISPLAY '******** PLAN_NAME:'                            05710012
057200                  PV-PROGRAM-NAME                                 05720012
057300         MOVE SPACES TO AA-MESSAGE-1                              05730012
057400                        AA-MESSAGE-2                              05740012
057500         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05750012
057600                             TO AA-DB2-OPERATION                  05760012
057700         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      05770012
057800         PERFORM Z999-DB2-ABEND                                   05780012
057900     END-IF.                                                      05790012
058000                                                                  05800012
058100 EJECT                                                            05810012
058200*----------------------------------------------------------------*05820012
058300*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *05830012
058400*----------------------------------------------------------------*05840012
058500 X500-SET-CHECKPOINT-TIME.                                        05850012
058600                                                                  05860012
058700     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-CURRENT-PARAGRAPH.     05870012
058800                                                                  05880012
058900     PERFORM WITH TEST AFTER                                      05890012
059000             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05900012
059100             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05910012
059200                     SQLCODE = ZERO                               05920012
059300                                                                  05930012
059400             EXEC SQL                                             05940012
059500              SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)05950012
059600               INTO :WS-HOLD-TMST                                 05960012
059700               FROM TCKRSTCNTL                                    05970012
059800               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05980012
059900             END-EXEC                                             05990012
060000                                                                  06000012
060100             EVALUATE TRUE                                        06010012
060200                 WHEN SQLCODE = ZERO                              06020012
060300                 WHEN SQLCODE = -904                              06030012
060400                 WHEN SQLCODE = -913                              06040012
060500                      CONTINUE                                    06050012
060600                                                                  06060012
060700                 WHEN SQLWARN0 NOT = SPACES                       06070012
060800                 WHEN SQLCODE  NOT = ZERO                         06080012
060900                     MOVE PV-CURRENT-PARAGRAPH                    06090012
061000                                         TO AA-PARAGRAPH-NAME     06100012
061100                     DISPLAY '******** PLAN_NAME:'                06110012
061200                              PV-PROGRAM-NAME                     06120012
061300                     MOVE SPACES TO AA-MESSAGE-1                  06130012
061400                                    AA-MESSAGE-2                  06140012
061500                     MOVE 'UNSUCCESSFUL SELECT'                   06150012
061600                                         TO AA-DB2-OPERATION      06160012
061700                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          06170012
061800                     PERFORM Z999-DB2-ABEND                       06180012
061900             END-EVALUATE                                         06190012
062000     END-PERFORM.                                                 06200012
062100                                                                  06210012
062200     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06220012
062300         MOVE PV-CURRENT-PARAGRAPH                                06230012
062400                             TO AA-PARAGRAPH-NAME                 06240012
062500         DISPLAY '******** PLAN_NAME:'                            06250012
062600                  PV-PROGRAM-NAME                                 06260012
062700         MOVE SPACES TO AA-MESSAGE-1                              06270012
062800                        AA-MESSAGE-2                              06280012
062900         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    06290012
063000                             TO AA-DB2-OPERATION                  06300012
063100         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06310012
063200         PERFORM Z999-DB2-ABEND                                   06320012
063300     END-IF.                                                      06330012
063400                                                                  06340012
063500 EJECT                                                            06350012
063600*----------------------------------------------------------------*06360012
063700*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *06370012
063800*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *06380012
063900*----------------------------------------------------------------*06390012
064000 X600-UPDATE-TCKRSTCNTL.                                          06400012
064100                                                                  06410012
064200     MOVE 'X600-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       06420012
064300                                                                  06430012
064400     PERFORM WITH TEST AFTER                                      06440012
064500             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06450012
064600             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06460012
064700                     SQLCODE = ZERO                               06470012
064800                                                                  06480012
064900             EXEC SQL                                             06490012
065000                 UPDATE TCKRSTCNTL                                06500012
065100                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          06510012
065200                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06520012
065300             END-EXEC                                             06530012
065400                                                                  06540012
065500             EVALUATE TRUE                                        06550012
065600                 WHEN SQLCODE = ZERO                              06560012
065700                 WHEN SQLCODE = -904                              06570012
065800                 WHEN SQLCODE = -913                              06580012
065900                      CONTINUE                                    06590012
066000                                                                  06600012
066100                 WHEN SQLWARN0 NOT = SPACES                       06610012
066200                 WHEN SQLCODE  NOT = ZERO                         06620012
066300                     MOVE PV-CURRENT-PARAGRAPH                    06630012
066400                                         TO AA-PARAGRAPH-NAME     06640012
066500                     DISPLAY '******** PLAN_NAME:'                06650012
066600                              PV-PROGRAM-NAME                     06660012
066700                     MOVE SPACES TO AA-MESSAGE-1                  06670012
066800                                    AA-MESSAGE-2                  06680012
066900                     MOVE 'UNSUCCESSFUL UPDATE'                   06690012
067000                                         TO AA-DB2-OPERATION      06700012
067100                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          06710012
067200                     PERFORM Z999-DB2-ABEND                       06720012
067300             END-EVALUATE                                         06730012
067400     END-PERFORM.                                                 06740012
067500                                                                  06750012
067600     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06760012
067700         MOVE PV-CURRENT-PARAGRAPH                                06770012
067800                             TO AA-PARAGRAPH-NAME                 06780012
067900         DISPLAY '******** PLAN_NAME:'                            06790012
068000                  PV-PROGRAM-NAME                                 06800012
068100         MOVE SPACES TO AA-MESSAGE-1                              06810012
068200                        AA-MESSAGE-2                              06820012
068300         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06830012
068400                             TO AA-DB2-OPERATION                  06840012
068500         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06850012
068600         PERFORM Z999-DB2-ABEND                                   06860012
068700     END-IF.                                                      06870012
068800                                                                  06880012
068900     EJECT                                                        06890012
069000*----------------------------------------------------------------*06900012
069100*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *06910012
069200*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *06920012
069300*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *06930012
069400*----------------------------------------------------------------*06940012
069500 X700-UPDATE-TCKRSTINF.                                           06950012
069600                                                                  06960012
069700     MOVE 'X700-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        06970012
069800                                                                  06980012
069900     MOVE PV-TMESTDS-INPUT-COUNT TO CR-EXTRACT-RECS-WORKED.       06990012
070000     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   07000012
070100     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    07010012
070200                                                                  07020012
070300     PERFORM WITH TEST AFTER                                      07030012
070400             VARYING PC-RETRY-COUNT FROM 1 BY 1                   07040012
070500             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             07050012
070600                     SQLCODE = ZERO                               07060012
070700                                                                  07070012
070800             EXEC SQL                                             07080012
070900                 UPDATE TCKRSTINF                                 07090012
071000                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 07100012
071100                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          07110012
071200             END-EXEC                                             07120012
071300                                                                  07130012
071400             EVALUATE TRUE                                        07140012
071500                 WHEN SQLCODE = ZERO                              07150012
071600                 WHEN SQLCODE = -904                              07160012
071700                 WHEN SQLCODE = -913                              07170012
071800                      CONTINUE                                    07180012
071900                                                                  07190012
072000                 WHEN SQLWARN0 NOT = SPACES                       07200012
072100                 WHEN SQLCODE  NOT = ZERO                         07210012
072200                     MOVE PV-CURRENT-PARAGRAPH                    07220012
072300                                         TO AA-PARAGRAPH-NAME     07230012
072400                     DISPLAY '******** PLAN_NAME:'                07240012
072500                              PV-PROGRAM-NAME                     07250012
072600                     MOVE SPACES TO AA-MESSAGE-1                  07260012
072700                                    AA-MESSAGE-2                  07270012
072800                     MOVE 'UNSUCCESSFUL UPDATE'                   07280012
072900                                         TO AA-DB2-OPERATION      07290012
073000                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          07300012
073100                     PERFORM Z999-DB2-ABEND                       07310012
073200             END-EVALUATE                                         07320012
073300     END-PERFORM.                                                 07330012
073400                                                                  07340012
073500     IF PC-RETRY-COUNT > PC-RETRY-MAX                             07350012
073600         MOVE PV-CURRENT-PARAGRAPH                                07360012
073700                             TO AA-PARAGRAPH-NAME                 07370012
073800         DISPLAY '******** PLAN_NAME:'                            07380012
073900                  PV-PROGRAM-NAME                                 07390012
074000         MOVE SPACES TO AA-MESSAGE-1                              07400012
074100                        AA-MESSAGE-2                              07410012
074200         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    07420012
074300                             TO AA-DB2-OPERATION                  07430012
074400         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      07440012
074500         PERFORM Z999-DB2-ABEND                                   07450012
074600     END-IF.                                                      07460012
074700                                                                  07470012
074800 EJECT                                                            07480012
074900                                                                  07490012
075000*----------------------------------------------------------------*07500012
075100*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *07510012
075200*----------------------------------------------------------------*07520012
075300 Y100-COMMIT.                                                     07530012
075400                                                                  07540012
075500     MOVE 'Y100-COMMIT'    TO PV-CURRENT-PARAGRAPH.               07550012
075600                                                                  07560012
075700     EXEC SQL                                                     07570012
075800         COMMIT                                                   07580012
075900     END-EXEC.                                                    07590012
076000                                                                  07600012
076100     EVALUATE TRUE                                                07610012
076200         WHEN SQLCODE = ZEROS                                     07620012
076300             CONTINUE                                             07630012
076400         WHEN OTHER                                               07640012
076500             MOVE PV-CURRENT-PARAGRAPH                            07650012
076600                                 TO AA-PARAGRAPH-NAME             07660012
076700             MOVE SPACES TO AA-MESSAGE-1                          07670012
076800                            AA-MESSAGE-2                          07680012
076900             MOVE 'UNSUCCESSFUL COMMIT'                           07690012
077000                                 TO AA-DB2-OPERATION              07700012
077100             MOVE SPACES         TO AA-DB2-TABLE                  07710012
077200             PERFORM Z999-DB2-ABEND                               07720012
077300     END-EVALUATE.                                                07730012
077400 EJECT                                                            07740012
077500 Z999-DB2-ABEND.                                                  07750012
077600                                                                  07760012
077700     DISPLAY AA-ABEND-LIT.                                        07770012
077800     DISPLAY AA-DB2-ERROR-LIT.                                    07780012
077900     DISPLAY AA-PROGRAM-LIT.                                      07790012
078000     DISPLAY AA-PARAGRAPH-LIT.                                    07800012
078100     DISPLAY AA-DB2-OPERATION-LIT.                                07810012
078200     DISPLAY AA-DB2-TABLE.                                        07820012
078300     SET AC-DB2-ERROR TO TRUE.                                    07830012
078400                                                                  07840012
078500     COPY DPPD004.                                                07850012
078600                                                                  07860012
078700     CALL 'ILBOABN0' USING ABEND-CODE.                            07870012
