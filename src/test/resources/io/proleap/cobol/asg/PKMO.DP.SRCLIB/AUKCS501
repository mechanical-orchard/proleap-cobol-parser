000100 ID DIVISION.                                                     00010013
000200 PROGRAM-ID.   AUKCS501.                                          00020013
000300 AUTHOR.       BRAD GROCHOWSKI TKMA557.                           00030013
000400 INSTALLATION. KOHLS DEPARTMENT STORES.                           00040013
000500 DATE-WRITTEN. 2003-04-16                                         00050013
000600 DATE-COMPILED.                                                   00060013
000700                                                                  00070013
000800*---------------------------------------------------------------* 00080013
000900*         CICS PROGRAM - AUKCS501 - A501                        * 00090013
001000*    AUKCS501 - CONTROL PROGRAM FOR AJB TO MAINFRAME LISTENER   * 00100013
001100*               AUKCS500.                                       * 00110014
001200*                                                               * 00120013
001300*    THIS PROGRAM CONTROLS TRACING ON/OFF, AND CAN CANCEL THE   * 00130013
001400*    AJB TO MAINFRAME TCP/IP LISTENER AUKCS500.                 * 00140013
001500*    SEE PROGRAM DOC FOR USAGE AND SPECIFIC INFORMATION.        * 00150013
001600*                                                               * 00160013
001700*    NOTE: THIS PROGRAM DOES NOT REQUIRE ANY SPECIAL COMPILE    * 00170013
001800*          OPTIONS, IT IS NOT DB2, NOT MQSERIES,                * 00180013
001900*          AND NOT CICS SOCKETS PGM.                            * 00190013
002000*---------------------------------------------------------------* 00200013
002100 ENVIRONMENT DIVISION.                                            00210013
002200 DATA DIVISION.                                                   00220013
002300 WORKING-STORAGE SECTION.                                         00230013
002400                                                                  00240013
002500 01  PC-PROGRAM-CONSTANTS.                                        00250013
002600     05  IPSW-TRAN                  PIC X(4) VALUE 'A501'.        00260013
002700 01  PV-PROGRAM-VARIABLES.                                        00270013
002800     05  DISP-MSGS                  PIC 9(8) COMP VALUE 9999.     00280013
002900     05  RC                         PIC 9(8) COMP.                00290013
003000     05  PV-I                       PIC 9(4) COMP.                00300013
003100     05  PV-J                       PIC 9(4) COMP.                00310013
003200     05  PV-L                       PIC 9(4) COMP.                00320013
003300     05  MAX                        PIC 9(4).                     00330013
003400     05  TSQ-READA                  PIC X(80).                    00340013
003500     05  TSQREC-LENGTH              PIC 9(4) COMP VALUE 80.       00350013
003600     05  EXTRA                      PIC 9(4) COMP VALUE 0.        00360013
003700     05  WS-RECEIVE                 PIC X(80) VALUE SPACES.       00370013
003800     05  WS-LEN                     PIC S9(4) COMP VALUE +80.     00380013
003900     05  FIRST-SPACE                PIC 9(4) COMP VALUE 0.        00390013
004000     05  ERR                        PIC 9(4) COMP VALUE 0.        00400013
004100     05  GWPTR                      PIC S9(8) COMP.               00410013
004200     05  DSTAMP                     PIC 9(16) COMP.               00420013
004300     05  CLENG                      PIC 9(4) BINARY.              00430013
004400     05  HOLD-PORT                  PIC X(4) VALUE SPACES.        00440013
004500                                                                  00450013
004600 01  TCPIPSWQ.                                                    00460013
004700     05  FILLER                 PIC X(7) VALUE 'AUTCPSW'.         00470013
004800     05  TCPIPSWQ-ONE           PIC X(1) VALUE SPACE.             00480013
004900                                                                  00490013
005000 01  TCPCICS-MSG-AREA.                                            00500013
005100    02 TCPCICS-MSG-1.                                             00510013
005200       05 FILLER                PIC X(1) VALUE SPACES.            00520013
005300       05 MSGDATE               PIC 9(8).                         00530013
005400       05 FILLER                PIC X(1) VALUE SPACES.            00540013
005500       05 MSGTIME               PIC 9(8).                         00550013
005600       05 FILLER                PIC X(3) VALUE ' > '.             00560013
005700       05 MODULE                PIC X(4) VALUE 'A501'.            00570013
005800       05 FILLER                PIC X(1) VALUE SPACES.            00580013
005900    02 TCPCICS-MSG-2.                                             00590013
006000       05 MSG-AREA              PIC X(50).                        00600013
006100    02 MSG-OUT REDEFINES TCPCICS-MSG-2.                           00610013
006200       05  CALL-NO              PIC X(10).                        00620013
006300       05  FIELDXX              PIC X(7).                         00630013
006400       05  ERR-CODE             PIC X(8).                         00640013
006500       05  FIELDYY              PIC X(7).                         00650013
006600       05  RET-CODE             PIC X(10).                        00660013
006700       05  FILLER               PIC X(8).                         00670013
006800                                                                  00680013
006900 01  SEND-MSG.                                                    00690013
007000     02  FILLER                 PIC X(6) VALUE X'1140401D4013'.   00700013
007100     02  FILLER                 PIC X(5) VALUE X'115CF01DF8'.     00710013
007200     02  SEND-AREA              PIC X(48).                        00720013
007300     02  FILLER                 PIC X(40) VALUE SPACES.           00730013
007400                                                                  00740013
007500****************************************************************  00750013
007600                                                                  00760013
007700 PROCEDURE DIVISION.                                              00770013
007800                                                                  00780013
007900     PERFORM INITIALIZATION THRU INITIALIZATION-EXIT.             00790013
008000     EXEC CICS EXTRACT EXIT PROGRAM('EZACIC01') GASET(GWPTR)      00800013
008100          GALENGTH(PV-L) RESP(RC) END-EXEC.                       00810013
008200     IF RC NOT = 0 THEN                                           00820013
008300        MOVE 'TCP/IP TRUE INTERFACE NOT ACTIVE' TO SEND-AREA      00830013
008400        PERFORM WRITE-MESSAGE THRU WRITE-MESSAGE-EXIT             00840013
008500        GO TO PGM-EXIT                                            00850013
008600     END-IF.                                                      00860013
008700                                                                  00870013
008800     EXEC CICS RECEIVE INTO(WS-RECEIVE) LENGTH(WS-LEN)            00880013
008900          RESP(RC) END-EXEC.                                      00890013
009000     IF WS-RECEIVE(1:1) = X'11' THEN                              00900013
009100        MOVE 'WRITE STRUCTURE IN PARMS' TO MSG-AREA               00910013
009200        PERFORM WRITE-CICS THRU WRITE-CICS-EXIT                   00920013
009300        MOVE SPACES TO TSQ-READA                                  00930013
009400        MOVE WS-RECEIVE(4:37) TO TSQ-READA                        00940013
009500        MOVE TSQ-READA TO WS-RECEIVE                              00950013
009600     END-IF.                                                      00960013
009700     MOVE 'PARMS=' TO MSG-AREA.                                   00970013
009800     MOVE WS-RECEIVE TO MSG-AREA(7:40).                           00980013
009900     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     00990013
010000     IF WS-RECEIVE(1:4) = 'A501' THEN                             01000013
010100        MOVE WS-RECEIVE(6:31) TO TSQ-READA                        01010013
010200        MOVE TSQ-READA TO WS-RECEIVE                              01020013
010300     END-IF.                                                      01030013
010400     IF RC NOT = 0 THEN                                           01040013
010500        MOVE 'RECV-RC=' TO FIELDXX                                01050013
010600        MOVE RC TO ERR-CODE                                       01060013
010700        PERFORM WRITE-MESSAGE THRU WRITE-MESSAGE-EXIT             01070013
010800*       GO TO PGM-EXIT                                            01080013
010900     END-IF.                                                      01090013
011000                                                                  01100013
011100     MOVE WS-RECEIVE TO MSG-AREA.                                 01110013
011200     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     01120013
011300                                                                  01130013
011400     PERFORM REMOVE-EXTRA-SPACES THRU REMOVE-EXTRA-SPACES-EXIT.   01140013
011500                                                                  01150013
011600     PERFORM VALIDATE-CMD THRU VALIDATE-CMD-EXIT.                 01160013
011700                                                                  01170013
011800     IF HOLD-PORT = '4993' OR                                     01180013
011900        HOLD-PORT = '4996' OR                                     01190013
012000        HOLD-PORT = '4997' OR                                     01200013
012100        HOLD-PORT = '4998' THEN                                   01210013
012200        MOVE '1' TO TCPIPSWQ-ONE                                  01220013
012300     END-IF.                                                      01230013
012400                                                                  01240013
012500     IF TCPIPSWQ-ONE = SPACE THEN                                 01250013
012600        MOVE 'NO PORT / BAD PORT PASSED' TO SEND-AREA             01260013
012700        PERFORM WRITE-MESSAGE THRU WRITE-MESSAGE-EXIT             01270013
012800        GO TO PGM-EXIT                                            01280013
012900     END-IF.                                                      01290013
013000                                                                  01300013
013100     MOVE WS-RECEIVE TO MSG-AREA.                                 01310013
013200     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     01320013
013300                                                                  01330013
013400* SEARCH TO TSQ FOR A DUPLICATE REQUEST                           01340013
013500                                                                  01350013
013600     PERFORM VARYING PV-I FROM 1 BY 1 UNTIL PV-I > 100            01360013
013700        EXEC CICS READQ TS QUEUE(TCPIPSWQ) INTO(TSQ-READA)        01370013
013800             ITEM(PV-I) LENGTH(TSQREC-LENGTH) END-EXEC            01380013
013900        IF TSQ-READA = WS-RECEIVE THEN                            01390013
014000           MOVE 'REQUEST ALREADY IN QUEUE' TO SEND-AREA           01400013
014100           PERFORM WRITE-MESSAGE THRU WRITE-MESSAGE-EXIT          01410013
014200           GO TO PGM-EXIT                                         01420013
014300        END-IF                                                    01430013
014400        IF TSQ-READA = SPACES AND FIRST-SPACE = 0 THEN            01440013
014500           MOVE PV-I TO FIRST-SPACE                               01450013
014600        END-IF                                                    01460013
014700     END-PERFORM.                                                 01470013
014800                                                                  01480013
014900     IF FIRST-SPACE = 0 THEN                                      01490013
015000        MOVE '!TCPIPSWQ IS FULL' TO SEND-AREA                     01500013
015100        PERFORM WRITE-MESSAGE THRU WRITE-MESSAGE-EXIT             01510013
015200        GO TO PGM-EXIT                                            01520013
015300     ELSE                                                         01530013
015400        EXEC CICS WRITEQ TS QUEUE(TCPIPSWQ) FROM(WS-RECEIVE)      01540013
015500             ITEM(FIRST-SPACE) LENGTH(TSQREC-LENGTH)              01550013
015600             MAIN REWRITE END-EXEC                                01560013
015700        MOVE FIRST-SPACE TO MAX                                   01570013
015800        MOVE 'SWQ=' TO MSG-AREA                                   01580013
015900        MOVE MAX TO MSG-AREA(5:4)                                 01590013
016000        MOVE WS-RECEIVE TO MSG-AREA(14:36)                        01600013
016100        PERFORM WRITE-CICS THRU WRITE-CICS-EXIT                   01610013
016200     END-IF.                                                      01620013
016300     GO TO PGM-EXIT.                                              01630013
016400 MAIN-EXIT.                                                       01640013
016500     EXIT.                                                        01650013
016600                                                                  01660013
016700 PGM-EXIT.                                                        01670013
016800     MOVE 'END OF IPSW PROGRAM' TO MSG-AREA.                      01680013
016900     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     01690013
017000     EXEC CICS RETURN  END-EXEC.                                  01700013
017100     GOBACK.                                                      01710013
017200     EXIT.                                                        01720013
017300                                                                  01730013
017400****************************************************************  01740013
017500* THIS ROUTE DOES ALL OF THE INITIALIZATION FOR THIS TASK.     *  01750013
017600****************************************************************  01760013
017700                                                                  01770013
017800 INITIALIZATION.                                                  01780013
017900*    EXEC CICS IGNORE CONDITION TERMERR EOC SIGNAL END-EXEC.      01790013
018000                                                                  01800013
018100     EXEC CICS HANDLE CONDITION                                   01810013
018200                                INVREQ  (INVREQ-ERR-SEC)          01820013
018300                                IOERR   (IOERR-SEC)               01830013
018400                                ENDDATA (ENDDATA-SEC)             01840013
018500                                LENGERR (LENGERR-SEC)             01850013
018600                                NOSPACE (NOSPACE-ERR-SEC)         01860013
018700                                NOSTG   (NOSPACE-ERR-SEC)         01870013
018800                                QIDERR  (QIDERR-SEC)              01880013
018900                                ITEMERR (ITEMERR-SEC)             01890013
019000                                QZERO   (QZERO-SEC)               01900013
019100          END-EXEC.                                               01910013
019200                                                                  01920013
019300     MOVE '!INITIALIZATION DONE' TO MSG-AREA.                     01930013
019400     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     01940013
019500                                                                  01950013
019600 INITIALIZATION-EXIT.                                             01960013
019700     EXIT.                                                        01970013
019800                                                                  01980013
019900****************************************************************  01990013
020000*  THIS ROUTE WILL VALIDATE THE COMMAND FROM THE PARMS         *  02000013
020100****************************************************************  02010013
020200                                                                  02020013
020300 VALIDATE-CMD.                                                    02030013
020400                                                                  02040013
020500     IF WS-RECEIVE(1:5) = 'TRACE' THEN                            02050013
020600        MOVE 'TRACE TURNED ON FOR STORE' TO SEND-AREA             02060013
020700        PERFORM WRITE-MESSAGE THRU WRITE-MESSAGE-EXIT             02070013
020800        MOVE WS-RECEIVE(6:4) TO HOLD-PORT                         02080013
020900        GO TO VALIDATE-CMD-EXIT                                   02090013
021000     END-IF                                                       02100013
021100     IF WS-RECEIVE(1:7) = 'NOTRACE' THEN                          02110013
021200        MOVE 'TRACE TURNED OFF FOR STORE' TO SEND-AREA            02120013
021300        PERFORM WRITE-MESSAGE THRU WRITE-MESSAGE-EXIT             02130013
021400        MOVE WS-RECEIVE(8:4) TO HOLD-PORT                         02140013
021500        GO TO VALIDATE-CMD-EXIT                                   02150013
021600     END-IF                                                       02160013
021700     IF WS-RECEIVE(1:6) = 'CANCEL' THEN                           02170013
021800        MOVE 'CANCEL REQUESTED FOR TRAN' TO SEND-AREA             02180013
021900        PERFORM WRITE-MESSAGE THRU WRITE-MESSAGE-EXIT             02190013
022000        MOVE WS-RECEIVE(7:4) TO HOLD-PORT                         02200013
022100        GO TO VALIDATE-CMD-EXIT                                   02210013
022200     END-IF.                                                      02220013
022300                                                                  02230013
022400     MOVE '!' TO MSG-AREA.                                        02240013
022500     MOVE WS-RECEIVE TO MSG-AREA(2:44).                           02250013
022600     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     02260013
022700     MOVE 'INVALID COMMAND ENTERED - PLEASE RETRY' TO SEND-AREA.  02270013
022800     PERFORM WRITE-MESSAGE THRU WRITE-MESSAGE-EXIT.               02280013
022900     GO TO PGM-EXIT.                                              02290013
023000                                                                  02300013
023100 VALIDATE-CMD-EXIT.                                               02310013
023200     EXIT.                                                        02320013
023300                                                                  02330013
023400****************************************************************  02340013
023500*  THIS ROUTE WILL REMOVE EXTRA SPACES IN THE WS-RECEIVE       *  02350013
023600****************************************************************  02360013
023700 REMOVE-EXTRA-SPACES.                                             02370013
023800     PERFORM VARYING PV-I FROM 1 BY 1 UNTIL PV-I > WS-LEN         02380013
023900        IF EXTRA > 1 AND WS-RECEIVE(PV-I:1) NOT = ' ' THEN        02390013
024000           COMPUTE PV-J = PV-I - EXTRA + 1                        02400013
024100           COMPUTE PV-L = WS-LEN - PV-I + 1                       02410013
024200           MOVE WS-RECEIVE(PV-I:PV-L) TO WS-RECEIVE(PV-J:PV-L)    02420013
024300           COMPUTE PV-J = PV-J + PV-L                             02430013
024400           COMPUTE PV-L = WS-LEN - PV-J + 1                       02440013
024500           MOVE SPACES TO WS-RECEIVE(PV-J:PV-L)                   02450013
024600           MOVE PV-J TO PV-I                                      02460013
024700        END-IF                                                    02470013
024800        IF WS-RECEIVE(PV-I:1) = ' ' THEN                          02480013
024900           ADD 1 TO EXTRA                                         02490013
025000        ELSE                                                      02500013
025100           MOVE 0 TO EXTRA                                        02510013
025200        END-IF                                                    02520013
025300     END-PERFORM.                                                 02530013
025400                                                                  02540013
025500 REMOVE-EXTRA-SPACES-EXIT.                                        02550013
025600     EXIT.                                                        02560013
025700                                                                  02570013
025800****************************************************************  02580013
025900*                                                              *  02590013
026000* THIS ROUTE WRITES OUT A MESSAGE TO THE DISPLAY               *  02600013
026100*                                                              *  02610013
026200****************************************************************  02620013
026300*                                                                 02630013
026400 WRITE-MESSAGE.                                                   02640013
026500                                                                  02650013
026600     MOVE LENGTH OF SEND-MSG TO PV-L.                             02660013
026700     EXEC CICS SEND FROM(SEND-MSG) LENGTH(PV-L) END-EXEC.         02670013
026800     MOVE SEND-AREA TO MSG-AREA.                                  02680013
026900     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     02690013
027000                                                                  02700013
027100 WRITE-MESSAGE-EXIT.                                              02710013
027200     EXIT.                                                        02720013
027300                                                                  02730013
027400                                                                  02740013
027500****************************************************************  02750013
027600* THIS ROUTE WRITES OUT A MESSAGE TO THE CICS LOG              *  02760013
027700****************************************************************  02770013
027800                                                                  02780013
027900 WRITE-CICS.                                                      02790013
028000                                                                  02800013
028100     IF MSG-AREA(1:1) = '!' OR DISP-MSGS > 0                      02810013
028200        MOVE LENGTH OF TCPCICS-MSG-AREA TO CLENG                  02820013
028300        EXEC CICS ASKTIME ABSTIME(DSTAMP) NOHANDLE END-EXEC       02830013
028400        EXEC CICS FORMATTIME ABSTIME(DSTAMP) MMDDYY(MSGDATE)      02840013
028500             TIME(MSGTIME) DATESEP TIMESEP(':') NOHANDLE END-EXEC 02850013
028600        MOVE IPSW-TRAN TO MODULE                                  02860013
028700        EXEC CICS WRITEQ TD QUEUE('CSSL') FROM (TCPCICS-MSG-AREA) 02870013
028800             LENGTH(CLENG) END-EXEC                               02880013
028900     END-IF.                                                      02890013
029000                                                                  02900013
029100     IF DISP-MSGS > 0 AND DISP-MSGS < 9999                        02910013
029200        SUBTRACT 1 FROM DISP-MSGS.                                02920013
029300     MOVE SPACES TO MSG-AREA.                                     02930013
029400                                                                  02940013
029500                                                                  02950013
029600 WRITE-CICS-EXIT.                                                 02960013
029700     EXIT.                                                        02970013
029800                                                                  02980013
029900 EJECT                                                            02990013
030000*---------------------------------------------------------------* 03000013
030100*                                                               * 03010013
030200*  CONTROL IS GIVEN TO THE FOLLOWING ERROR ROUTINES BY 'HANDLES'* 03020013
030300*  ISSUED AT THE BEGINNING OF THE PROGRAM.                      * 03030013
030400*                                                               * 03040013
030500*---------------------------------------------------------------* 03050013
030600                                                                  03060013
030700 INVREQ-ERR-SEC.                                                  03070013
030800     MOVE '!INTERFACE IS NOT ACTIVE' TO MSG-AREA.                 03080013
030900     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     03090013
031000     GO TO PGM-EXIT.                                              03100013
031100                                                                  03110013
031200 IOERR-SEC.                                                       03120013
031300     MOVE '!IOERR OCCURS           ' TO MSG-AREA.                 03130013
031400     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     03140013
031500     GO TO PGM-EXIT.                                              03150013
031600                                                                  03160013
031700 QZERO-SEC.                                                       03170013
031800     MOVE '!QZERO OCCURRS          ' TO MSG-AREA.                 03180013
031900     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     03190013
032000     GO TO PGM-EXIT.                                              03200013
032100                                                                  03210013
032200 LENGERR-SEC.                                                     03220013
032300     MOVE '!*A501* LENGTH ERROR READING TD QUEUE' TO MSG-AREA.    03230013
032400     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     03240013
032500     MOVE '!' TO MSG-AREA.                                        03250013
032600     MOVE 'READQTD' TO FIELDXX.                                   03260013
032700     MOVE CLENG TO ERR-CODE.                                      03270013
032800     MOVE 'READQTD' TO FIELDYY.                                   03280013
032900     MOVE CLENG TO RET-CODE.                                      03290013
033000     MOVE '****' TO CALL-NO.                                      03300013
033100     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     03310013
033200     GO TO PGM-EXIT.                                              03320013
033300                                                                  03330013
033400 NOSPACE-ERR-SEC.                                                 03340013
033500     MOVE '!NOSPACE CONDITION      ' TO MSG-AREA.                 03350013
033600     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     03360013
033700     GO TO PGM-EXIT.                                              03370013
033800                                                                  03380013
033900 QIDERR-SEC.                                                      03390013
034000     MOVE '!QIDERR  CONDITION      ' TO MSG-AREA.                 03400013
034100     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     03410013
034200     GO TO PGM-EXIT.                                              03420013
034300                                                                  03430013
034400 ITEMERR-SEC.                                                     03440013
034500     MOVE 'NO TCPIPSWQ-SOCKET TASK NOT ACTIVE' TO SEND-AREA       03450013
034600     PERFORM WRITE-MESSAGE THRU WRITE-MESSAGE-EXIT.               03460013
034700     GO TO PGM-EXIT.                                              03470013
034800                                                                  03480013
034900 ENDDATA-SEC.                                                     03490013
035000     MOVE '!RETRIEVE DATA CAN NT BE FOUND' TO MSG-AREA.           03500013
035100     PERFORM WRITE-CICS THRU WRITE-CICS-EXIT.                     03510013
035200     GO TO PGM-EXIT.                                              03520013
