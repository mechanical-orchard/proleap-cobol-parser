000500***************************************************************** 00050001
000600 IDENTIFICATION DIVISION.                                         00060001
000700***************************************************************** 00070001
000800*                                                                 00080001
000900 PROGRAM-ID.             SUKUP010.                                00090001
001000 AUTHOR.                 PATRICK BURKE.                           00100001
001100 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00110001
001200 DATE-WRITTEN.           MAY 2002.                                00120001
001300 DATE-COMPILED.                                                   00130001
001400*                                                                 00140001
001500***************************************************************** 00150001
001510* THIS PROGRAM WILL BE USED TO DELETE OLD ENTRIES FROM THE UPLOAD 00151001
001520* ERROR TABLE (TUPLDER).                                          00152001
001800***************************************************************** 00180001
001900 ENVIRONMENT DIVISION.                                            00190001
002000***************************************************************** 00200001
002100 CONFIGURATION SECTION.                                           00210001
002200 SOURCE-COMPUTER.                        IBM-3090.                00220001
002300 OBJECT-COMPUTER.                        IBM-3090.                00230001
002400 INPUT-OUTPUT SECTION.                                            00240001
002500 FILE-CONTROL.                                                    00250001
002600                                                                  00260001
002700     SELECT EXTRACT-FILE                                          00270001
002800         ASSIGN TO INP01.                                         00280001
002900/                                                                 00290001
003300***************************************************************** 00330001
003400 DATA DIVISION.                                                   00340001
003500***************************************************************** 00350001
003600 FILE SECTION.                                                    00360001
003700                                                                  00370001
003800 FD  EXTRACT-FILE                                                 00380001
003900     RECORDING MODE IS F                                          00390001
004000     LABEL RECORDS ARE STANDARD                                   00400001
004100     BLOCK CONTAINS 0 RECORDS.                                    00410001
004200 01  EXTRACT-RECORD                   PIC X(136).                 00420006
004800/                                                                 00480001
004900***************************************************************** 00490001
005000 WORKING-STORAGE SECTION.                                         00500001
005100***************************************************************** 00510001
005200                                                                  00520001
005300 01  PS-SWITCHES.                                                 00530001
005700     05  PS-END-OF-INPUT-FILE-SW      PIC X(01) VALUE 'N'.        00570001
005800         88  PS-END-OF-INPUT                    VALUE 'Y'.        00580001
005900         88  PS-NOT-END-OF-INPUT                VALUE 'N'.        00590001
006600                                                                  00660001
008700 01  PV-VARIABLES.                                                00870001
008800     05  PV-READ-COUNT                PIC S9(7) COMP-3            00880001
008900                                                VALUE ZERO.       00890001
009000     05  PV-REC-READ-QTY              PIC S9(7) COMP-3            00900001
009100                                                VALUE ZERO.       00910001
009200     05  PV-WRITE-COUNT               PIC S9(7) COMP-3            00920001
009300                                                VALUE ZERO.       00930001
009400     05  PV-PAGE-COUNT                PIC S9(3) COMP-3            00940001
009500                                                VALUE ZERO.       00950001
009600     05  PV-LINE-COUNT                PIC S9(04) VALUE ZERO       00960001
009700                                                 COMP SYNC.       00970001
010900                                                                  01090001
011000     05  PV-DB2-FUNCTION              PIC X(30) VALUE SPACES.     01100001
011100     05  PV-PARAGRAPH                 PIC X(30) VALUE SPACES.     01110001
011200     05  PV-DISP-NUMBER               PIC Z,ZZZ,ZZ9.              01120001
011300                                                                  01130001
011400     05  PV-RUN-DATE                  PIC X(10) VALUE SPACES.     01140001
011500     05  PV-SAVE-START-DATE           PIC X(10) VALUE SPACES.     01150001
011600     05  PV-ERROR-MESSAGE-1           PIC X(60)  VALUE SPACES.    01160001
011700     05  PV-ERROR-MESSAGE-2           PIC X(60)  VALUE SPACES.    01170001
011800     05  PV-DB2-YEAR                  PIC S9(08) COMP             01180001
011900                                          VALUE ZERO.             01190001
012000     05  PV-DB2-MONTH                 PIC S9(08) COMP             01200001
012100                                          VALUE ZERO.             01210001
012200     05  PV-DB2-DAY                   PIC S9(08) COMP             01220001
012300                                          VALUE ZERO.             01230001
012400     05  PV-DB2-HOUR                  PIC S9(08) COMP             01240001
012500                                          VALUE ZERO.             01250001
012600     05  PV-DB2-MINUTE                PIC S9(08) COMP             01260001
012700                                          VALUE ZERO.             01270001
012800     05  PV-DB2-SECOND                PIC S9(08) COMP             01280001
012900                                          VALUE ZERO.             01290001
013000                                                                  01300001
013100     05  PV-DIVIDEND                  PIC 9(03)V9999.             01310001
013101                                                                  01310102
013102     05  PV-DISPLAY-COUNT             PIC ZZZ,ZZZ,ZZ9.            01310202
013110     05  PV-COMMIT-COUNT              PIC S9(09)    VALUE +0      01311001
013120                                                   COMP SYNC.     01312001
013121     05  PV-NOT-FOUND-COUNT           PIC S9(09)    VALUE +0      01312102
013122                                                   COMP SYNC.     01312202
013130     05  PV-COMMIT-COUNTER            PIC 9(03)     VALUE ZERO.   01313001
013140     05  PV-DELETE-COUNT              PIC S9(09)    VALUE ZERO    01314001
013150                                                   COMP SYNC.     01315001
013200                                                                  01320001
013300******************************************************************01330001
015400 01  PV-ABEND-FIELDS.                                             01540001
015500     05  PV-ABEND-CODE                PIC S9(04) VALUE +0         01550001
015600                                                 COMP SYNC.       01560001
015700     05  PV-ABEND-PROGRAM             PIC  X(08) VALUE 'SUKUP010'.01570001
015800     05  PV-ABEND-PARAGRAPH           PIC  X(50) VALUE SPACES.    01580001
015900     05  PV-ABEND-OPERATION           PIC  X(51) VALUE SPACES.    01590001
016000     05  PV-ABEND-STRUCTURE-1         PIC X(8)   VALUE SPACES.    01600001
016100     05  PV-ABEND-STRUCTURE-2         PIC X(8)   VALUE SPACES.    01610001
016200     05  PV-ABEND-STRUCTURE-3         PIC X(8)   VALUE SPACES.    01620001
016300     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    01630001
016400     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    01640001
016500     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    01650001
016600/                                                                 01660001
016700 01  PC-CONSTANTS.                                                01670001
016900     05  PC-CURRENT-PROGRAM-NAME      PIC X(08) VALUE 'SUKUP010'. 01690001
017000     05  PC-ROW-NOT-FOUND             PIC S9(04)    VALUE +100    01700001
017100                                                   COMP SYNC.     01710001
017220     05  PC-COMMIT-HOLD               PIC 9(3)      VALUE 200.    01722001
017230     05  PC-READ-VALUE                PIC 9(6)      VALUE 200000. 01723001
017300/                                                                 01730001
027600******************************************************************02760001
027700*  RECORD LAYOUT FOR INPUT FILE                                   02770001
027800******************************************************************02780001
027900*    COPY DCLTUPLDER.                                             02790001
028000/                                                                 02800001
028100******************************************************************02810001
028200*  COPYBOOK FOR UPLOAD TRANSACTION CODES AND ERROR CODES.         02820001
028300******************************************************************02830001
028400     COPY PCWS208.                                                02840001
028500*                                                                 02850001
028600******************************************************************02860001
028700*  COPYBOOK USED BY MBS SYSTEM                                    02870001
028800******************************************************************02880001
028900     COPY DPWS003.                                                02890001
029000*                                                                 02900001
029100******************************************************************02910001
029200*  WORKING STORAGE AREA FOR NAME REFORMAT DPPD024                 02920001
029300******************************************************************02930001
029400     COPY DPWS024.                                                02940007
029500/                                                                 02950001
029600******************************************************************02960001
029700*  DB2 FORMATTED MESSAGE AREA                                     02970001
029800******************************************************************02980001
029900     COPY DPWS004.                                                02990001
030000/                                                                 03000001
030100******************************************************************03010001
030200* CORPORATE DATE ROUTINES                                         03020001
030300******************************************************************03030001
030400     COPY DPWS500.                                                03040001
030500/                                                                 03050001
030600******************************************************************03060001
030700*   DB2 SQL COMMUNICATION AREA                                    03070001
030800******************************************************************03080001
030900     EXEC SQL                                                     03090001
031000         INCLUDE SQLCA                                            03100001
031100     END-EXEC.                                                    03110001
031200*                                                                 03120001
031300     COPY SQLCA2.                                                 03130001
031400*                                                                 03140001
032300******************************************************************03230001
032400*   UPLOAD ERROR TABLE                                            03240001
032500******************************************************************03250001
032600*                                                                 03260001
032700     EXEC SQL                                                     03270001
032800         INCLUDE TUPLDER                                          03280001
032900     END-EXEC.                                                    03290001
033000*                                                                 03300001
033100******************************************************************03310001
033200 PROCEDURE DIVISION.                                              03320001
033300******************************************************************03330001
033400 0000-MAINLINE.                                                   03340001
033500                                                                  03350001
033910     PERFORM 1000-INITIALIZE.                                     03391001
034000                                                                  03400001
034200     PERFORM 2000-PROCESS-EXTRACT                                 03420001
034300         UNTIL PS-END-OF-INPUT.                                   03430001
034400                                                                  03440001
034500     PERFORM 9000-EOJ.                                            03450001
034600                                                                  03460001
034700      GOBACK.                                                     03470001
034800                                                                  03480001
034810******************************************************************03481001
034820*  DO FIRST TIME PROGRAM INITIALIZATION TASKS.                    03482001
034830*    -- OPEN INPUT FILE                                           03483001
034840*    -- READ FILE                                                 03484001
034900******************************************************************03490001
035000 1000-INITIALIZE.                                                 03500001
035100                                                                  03510001
035202     OPEN INPUT  EXTRACT-FILE.                                    03520201
035203                                                                  03520301
035204     PERFORM 2100-READ-EXTRACT.                                   03520401
035300/                                                                 03530001
044400******************************************************************04440001
044500 2000-PROCESS-EXTRACT.                                            04450001
044600******************************************************************04460001
044700*                                                                 04470001
044800     PERFORM 8000-DELETE-UPLOAD-ERROR-RECS                        04480002
044900     ADD +1 TO PV-COMMIT-COUNTER.                                 04490001
045000                                                                  04500001
045100     IF PV-COMMIT-COUNTER > PC-COMMIT-HOLD                        04510001
045200         EXEC SQL                                                 04520001
045300            COMMIT                                                04530001
045400         END-EXEC                                                 04540001
045500                                                                  04550001
046100         ADD +1                          TO PV-COMMIT-COUNT       04610001
046110         MOVE +0 TO PV-COMMIT-COUNTER                             04611001
046120     END-IF.                                                      04612001
046200                                                                  04620001
046300     PERFORM 2100-READ-EXTRACT.                                   04630001
046400*                                                                 04640001
046500******************************************************************04650001
046600*  READ NEXT INPUT FILE RECORD.                                   04660001
046700******************************************************************04670001
046800 2100-READ-EXTRACT.                                               04680001
046900                                                                  04690001
047000     READ EXTRACT-FILE INTO DCLTUPLDER                            04700001
047100        AT END                                                    04710001
047200           SET PS-END-OF-INPUT TO TRUE                            04720001
047300        NOT AT END                                                04730001
047400           ADD +1                   TO PV-READ-COUNT              04740001
047800     END-READ.                                                    04780001
047900*                                                                 04790001
051220******************************************************************05122001
051230* DELETE THE ROW FROM THE UPLOAD ERROR TABLE                      05123002
051240******************************************************************05124001
051241 8000-DELETE-UPLOAD-ERROR-RECS.                                   05124101
051250                                                                  05125001
051260     EXEC SQL                                                     05126001
051270         DELETE                                                   05127001
051280             FROM  TUPLDER                                        05128001
051290             WHERE OPER_UNT_ID   = :UPLDER-OPER-UNT-ID            05129002
051291               AND UPLD_TRN_CDE  = :UPLDER-UPLD-TRN-CDE           05129102
051292               AND ERR_CDE       = :UPLDER-ERR-CDE                05129202
051293               AND PRC_TMST      = :UPLDER-PRC-TMST               05129302
051294               AND UPLD_SEQ_NBR   = :UPLDER-UPLD-SEQ-NBR          05129402
051295     END-EXEC.                                                    05129502
051296                                                                  05129602
051297     EVALUATE TRUE                                                05129702
051298         WHEN SQLCODE = 0                                         05129802
051299             ADD +1           TO PV-DELETE-COUNT                  05129902
051300         WHEN SQLCODE = +100                                      05130002
051301             ADD +1           TO PV-NOT-FOUND-COUNT               05130102
051302         WHEN SQLCODE < 0                                         05130202
051303         WHEN SQLCODE > 0                                         05130302
051304         WHEN SQLWARN0 = 'W'                                      05130402
051305             MOVE '8000-DELETE-UPLOAD-ERROR-RECS'                 05130502
051306                         TO PV-PARAGRAPH                          05130602
051307             MOVE 'DELETE OF TUPLDER'                             05130702
051308                         TO PV-DB2-FUNCTION                       05130802
051309             PERFORM 9200-SQL-ABEND                               05130902
051310     END-EVALUATE.                                                05131002
051320/                                                                 05132002
053800******************************************************************05380001
053820*CLOSE INPUT FILE.                                                05382001
054000******************************************************************05400001
054100 9000-EOJ.                                                        05410001
054200*                                                                 05420001
054600     CLOSE EXTRACT-FILE.                                          05460001
054700                                                                  05470001
054710     MOVE PV-READ-COUNT      TO PV-DISPLAY-COUNT.                 05471004
054720     DISPLAY 'TOTAL INPUT RECORDS READ' PV-DISPLAY-COUNT.         05472004
054800     MOVE PV-DELETE-COUNT  TO PV-DISPLAY-COUNT.                   05480001
054810     DISPLAY 'TOTAL RECORDS DELETED   ' PV-DISPLAY-COUNT.         05481004
054820     MOVE PV-NOT-FOUND-COUNT TO PV-DISPLAY-COUNT.                 05482004
054830     DISPLAY 'TOTAL +100 DELETES      ' PV-DISPLAY-COUNT.         05483004
054840     MOVE PV-COMMIT-COUNT  TO PV-DISPLAY-COUNT.                   05484001
054850     DISPLAY 'TOTAL COMMITS TAKEN     ' PV-DISPLAY-COUNT.         05485004
054900/                                                                 05490001
055000******************************************************************05500001
055100 9200-SQL-ABEND.                                                  05510001
055200******************************************************************05520001
055300                                                                  05530001
055400     MOVE SQLCODE                     TO SQLCODE2.                05540001
055500     MOVE SQLERRD(3)                  TO SQLERRD3.                05550001
055600                                                                  05560001
055700     DISPLAY '** ABEND **         ** = SQLERROR'.                 05570001
055800     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        05580001
055900     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH.                   05590001
056000     DISPLAY '** OPERATION ** = ' PV-DB2-FUNCTION.                05600001
056100     DISPLAY '*** MESSAGE     = ' PV-DB2-OPERATION-MESSAGE-1.     05610001
056200     DISPLAY '***             = ' PV-DB2-OPERATION-MESSAGE-2.     05620001
056300     DISPLAY '***             = ' PV-DB2-OPERATION-MESSAGE-3.     05630001
056400                                                                  05640001
056500     DISPLAY '** SQLCODE          ** = ' SQLCODE2.                05650001
056600     DISPLAY '** ROWS PROCESSED   ** = ' SQLERRD3.                05660001
056700     DISPLAY '** SQLERRM          ** = ' SQLERRM.                 05670001
056800     DISPLAY '** SQLERRMC         ** = ' SQLERRMC.                05680001
056900                                                                  05690001
057000                                                                  05700001
057100     MOVE +4013                       TO PV-ABEND-CODE.           05710001
057200     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         05720001
057300                                                                  05730001
057400******************************************************************05740001
057500 9300-SQL-WARNING.                                                05750001
057600******************************************************************05760001
057700                                                                  05770001
057800     DISPLAY '9300-SQL-WARNING'.                                  05780001
057900     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        05790001
058000     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH.                   05800001
058100     DISPLAY '** OPERATION ** = ' PV-DB2-FUNCTION.                05810001
058200                                                                  05820001
058300     MOVE SQLCODE                     TO SQLCODE2.                05830001
058400     MOVE SQLERRD(3)                  TO SQLERRD3.                05840001
058500     DISPLAY '** ABEND **       ** = SQLWARNING'.                 05850001
058600     DISPLAY '** SQLCODE        ** = ' SQLCODE2.                  05860001
058700     DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                  05870001
058800     DISPLAY '** SQLWARN0       ** = ' SQLWARN0.                  05880001
058900     DISPLAY '** SQLWARN1       ** = ' SQLWARN1.                  05890001
059000     DISPLAY '** SQLWARN2       ** = ' SQLWARN2.                  05900001
059100     DISPLAY '** SQLWARN3       ** = ' SQLWARN3.                  05910001
059200     DISPLAY '** SQLWARN4       ** = ' SQLWARN4.                  05920001
059300     DISPLAY '** SQLWARN5       ** = ' SQLWARN5.                  05930001
059400     DISPLAY '** SQLWARN6       ** = ' SQLWARN6.                  05940001
059500     DISPLAY '** SQLWARN7       ** = ' SQLWARN7.                  05950001
059600                                                                  05960001
059700     MOVE +4013                       TO PV-ABEND-CODE.           05970001
059800     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         05980001
059900*                                                                 05990001
060000******************************************************************06000001
060100*  PERFORMS A NON-SQL ABEND FOR THE PROGRAM                       06010001
060200******************************************************************06020001
060300 9400-ABEND.                                                      06030001
060400*                                                                 06040001
060500     DISPLAY '***************************'.                       06050001
060600     DISPLAY '**       ABEND           **'.                       06060001
060700     DISPLAY '**  IN PROGRAM SUKUP010  **'.                       06070001
060800     DISPLAY '***************************'.                       06080001
060900     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH.             06090001
061000     DISPLAY '**   ERROR         ** = ' DP003-RETURN-MSG.         06100001
061100     DISPLAY '**                 ** = ' PV-ERROR-MESSAGE-1.       06110001
061200     DISPLAY '**                 ** = ' PV-ERROR-MESSAGE-2.       06120001
061300                                                                  06130001
061400     MOVE +4014                  TO PV-ABEND-CODE.                06140001
061500     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         06150001
061600*                                                                 06160001
061700******************************************************************06170001
