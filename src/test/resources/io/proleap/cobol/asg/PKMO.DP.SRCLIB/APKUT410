000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.     APKUT410.                                        00020000
000300 AUTHOR.         N EILBES.                                        00030000
000400*DATE-WRITTEN.   JUNE 1, 1995.                                    00040000
000500*DATE-COMPILED.                                                   00050000
000600*************************************************************     00060000
000700*    COBOL 2 WITH SQL                                       *     00070000
000800*                                                           *     00080000
000900*    INVOICE EXTRACT PROGRAM :                              *     00090000
001000*    PULL SPECIFIC TINVOIC INFORMATION FOR DATES PROVIDED   *     00100000
001100*    ON CONTROL CARD.                                       *     00110000
001200*                                                           *     00120000
001300* INPUT:                                                    *     00130000
001400*    TINVOIC - INVOICE TABLE                                *     00140000
001500*    TMDINVC - MERCHANDISE INVOICE TABLE                    *     00150000
001600*    TPURCHS - PURCHASE ORDER TABLE                         *     00160000
001700*    TPREQIT - PAYMENT REQUEST ITEM TABLE                   *     00170000
001800*    TPOAGMT - PO AGREEMENT TABLE                           *     00180000
001900*    TPAYTRM - PAYMENT TERMS TABLE                          *     00190000
002000*    TINVCTM - INVOICE ITEM TABLE                           *     00200000
002100*    TALCHRG - ALLOWANCE/CHARGE TABLE                       *     00210000
002200*    TEXTENT - EXTERNAL ENTITY TABLE                        *     00220000
002300*    TENTNME - EXTERNAL ENTITY NAME TABLE                   *     00230000
002400*                                                           *     00240000
002500* OUTPUT:                                                   *     00250000
002600* 1.  PKMO.AP.INVOICES.YR9999 --                            *     00260000
002700*     TAPE OF INVOICE INFORMATION FOR SPECIFIC DATE RANGE.  *     00270000
002800*************************************************************     00280000
002900* CHANGE LOG:                                               *     00290000
003000*                                                           *     00300000
003100* 06/01/95    INITIAL VERSION.                              *     00310000
003200*                                                           *     00320000
003300* 11/10/00 - THIS PROGRAM WAS MODIFIED TO PROCESS THE       *     00330000
003400*            ADDITIONAL EXTEDED DAYS IN THE PO TERMS.       *     00340000
003500*            THE NEW LOGIC WAS ADDED TO THE END OF          *     00350000
003600*            R600-GET-PO-TERMS.                             *     00360000
003700*        BY: JILL JUEL                         WR#: 20224   *     00370000
003800*                                                           *     00380000
003900* 06/04/01 - ADDED EXTRA () IN THE IF STMT TO CHECK THE     *     00390000
004000*            VALIDITY OF THE CONTROL CARD DATES.            *     00400000
004100*        BY: MIKE BESKE                        WR#: 22200   *     00410000
004200*                                                           *     00420000
004300* 06/17/02 - ARK PO PROJECT PHASE 1.  REMOVED TABLE TPAYREQ *     00430000
004400*            FROM INVOICE_CSR AND REPLACED WHERE CONDITION  *     00440000
004500*            WITH APPROPRIATE TINVOIC COLUMNS.              *     00450000
004600*        BY: KEVIN CATLIN                      WR#: 23500   *     00460000
004700*                                                           *     00470000
004800* 09/09/02 - ARK PO PROJECT PHASE 2.  CHANGED ALLOWANCE     *     00480000
004900*            CHARGE CURSOR AND R700 TO USE THE INVOICE ID   *     00490000
005000*            AND PO NUMBER BECAUSE PAMENT REQ NUMBER IS NO  *     00500000
005100*            LONGER USED.                                   *     00510000
005200*        BY: BRIAN HASSLINGER                  WR#: 23500   *     00520000
005300*                                                           *     00530000
005400* 06/19/03 - ADDED 'WITH UR' TO ALL SQL TO AVOID CONTENTION *     00540000
005500*            PROBLEMS.                                      *     00550000
005600*        BY: MIKE BESKE                        WR#: 24481   *     00560000
005700*                                                           *     00570000
005800* DATE  10/26/2005                                          *     00580000
005900*     CHANGE MADE: ADDED 2 FIELDS TO THE APRD410 COPYBOOK & *     00590000
006000*     THEIR ASSOCIATED MOVES IN THIS PROGRAM.  THE 2 NEW    *     00600000
006100*     FIELDS ARE: AP410-AP-PRC-CDE & AP410-AP-PRC-DTE.      *     00610000
006200*     MADE BY: MIKE BESKE              WR/IR #: WR29302     *     00620000
006210*                                                           *     00621000
006220* DATE  08/07/2006                                          *     00622002
006230*     CHANGE MADE: COPYBOOK APRD410 HAS BEEN MOTIFIED TO    *     00623000
006240*     HAVE THE # OF ALLOW CHARGES INCREASED FROM 5 TO 12    *     00624000
006250*     OCCURANCES WHICH REQUIRES THE # OF RECORDS EXTACTED   *     00625000
006251*     FROM THE AP410-ALW-CHRG-TABLE TO BE MODIFIED AS WELL  *     00625100
006252*     AS THE RECORD LENGTH OF THE AP-INVC-EXTRACT-FILE      *     00625201
006253*     FROM 347 TO 522.                                      *     00625301
006254*     MADE BY: MICHELE RINDFLEISCH     WR/IR #: WR31102     *     00625400
006220* DATE  01/03/2007                                          *     00625503
006230*     CHANGE MADE: ADDED DC-NBR AND MTCH-LVL-CDE LOGIC      *     00625603
006240*     FOR DC MATCH LEVEL ENHANCEMENT.  THIS WILL MOVE THE   *     00625703
006250*     FIELDS FOR HISTORY.                                   *     00625803
006254*     MADE BY: GREG WISIALOWSKI        WR/IR #: WR21578     *     00626203
006255*************************************************************     00626303
006256                                                                  00626403
006257 ENVIRONMENT DIVISION.                                            00626503
006258                                                                  00626603
006259 INPUT-OUTPUT SECTION.                                            00626703
006260                                                                  00626803
006261 FILE-CONTROL.                                                    00626903
006270                                                                  00627000
006280     SELECT AP-INVC-EXTRACT-FILE                                  00628000
006290         ASSIGN TO UT-S-OUT01.                                    00629000
006300                                                                  00630000
006400     SELECT CONTROL-CARD-FILE                                     00640000
006500         ASSIGN TO CARDIN.                                        00650000
006600                                                                  00660000
006700 DATA DIVISION.                                                   00670000
006800                                                                  00680000
006900 FILE SECTION.                                                    00690000
007000                                                                  00700000
007100 FD  AP-INVC-EXTRACT-FILE                                         00710000
007200         LABEL RECORDS  ARE STANDARD                              00720000
007300         RECORDING MODE IS  F                                     00730000
007400         DATA RECORD    IS  AP-INVC-EXTRACT-RECORD.               00740000
007500                                                                  00750000
007600 01  AP-INVC-EXTRACT-RECORD        PIC X(522).                    00760000
007700                                                                  00770000
007800                                                                  00780000
007900 FD  CONTROL-CARD-FILE                                            00790000
008000     RECORDING MODE IS F                                          00800000
008100     BLOCK CONTAINS 0 RECORDS.                                    00810000
008200 01  CC-RECORD                       PIC X(80).                   00820000
008300*                                                                 00830000
008400/                                                                 00840000
008500 WORKING-STORAGE SECTION.                                         00850000
008600                                                                  00860000
008700 01  FILLER                        PIC X(25) VALUE                00870000
008800                             'WS FOR APKUT410 BEGINS==>'.         00880000
008900 01  ABEND-CODE                    PIC S9(4) COMP SYNC            00890000
009000                                             VALUE ZEROS.         00900000
009100     88 AP-TABLE-FULL              VALUE +4004.                   00910000
009200     88 AP-EMPTY-FILE              VALUE +4005.                   00920000
009300     88 AP-INVALID-CONTROL-CARD    VALUE +4006.                   00930000
009400     88 AP-DB2-ERROR               VALUE +4013.                   00940000
009500                                                                  00950000
009600 01  WS-RETRY-COUNT                PIC S9(4) COMP VALUE ZERO.     00960000
009700 01  WS-RETRY-MAX                  PIC S9(4) COMP VALUE 3.        00970000
009800 01  WS-START-DATE                 PIC X(10) VALUE SPACES.        00980000
009900 01  WS-END-DATE                   PIC X(10) VALUE SPACES.        00990000
010000                                                                  01000000
010100 01  WS-SWITCH-AREA.                                              01010000
010200     05  WS-INVOICE-CSR-SW         PIC X   VALUE 'N'.             01020000
010300         88  END-OF-INVOICES               VALUE 'Y'.             01030000
010400         88  NOT-END-OF-INVOICES           VALUE 'N'.             01040000
010500     05  WS-ALCHRG-CSR-SW          PIC X   VALUE 'S'.             01050000
010600         88  END-OF-ALCHRG                 VALUE 'E'.             01060000
010700         88  START-OF-ALCHRG               VALUE 'S'.             01070000
010800     05  WS-CONTROL-CARD-SW        PIC X   VALUE ' '.             01080000
010900         88  END-OF-CONTROL-CARD           VALUE 'E'.             01090000
011000     05  PC-PURCHASE-TERMS         PIC X   VALUE 'P'.             01100000
011100     05  PC-INVOICE-TERMS          PIC X   VALUE 'I'.             01110000
011200                                                                  01120000
011300 01  WS-ABEND-FIELDS.                                             01130000
011400     05  WS-ABEND-PROGRAM             PIC X(8)  VALUE 'APKUT410'. 01140000
011500     05  WS-ABEND-PARAGRAPH           PIC X(50) VALUE SPACES.     01150000
011600     05  WS-ABEND-OPERATION           PIC X(50) VALUE SPACES.     01160000
011700     05  WS-ABEND-STRUCTURE-1         PIC X(8)  VALUE SPACES.     01170000
011800     05  WS-ABEND-STRUCTURE-2         PIC X(8)  VALUE SPACES.     01180000
011900     05  WS-ABEND-STATUS              PIC XX    VALUE SPACES.     01190000
012000                                                                  01200000
012100*                                                                 01210000
012200                                                                  01220000
012300 01  CONTROL-CARD-RECORD.                                         01230000
012400     05  CC-START-DATE.                                           01240000
012500         10  CC-START-YEAR           PIC X(04).                   01250000
012600             88  CC-ST-YEAR-VALID    VALUE '1990' THRU '2099'.    01260000
012700         10  CC-START-HYPHEN1        PIC X.                       01270000
012800             88  CC-ST-HYPEN1-VALID  VALUE '-'.                   01280000
012900         10  CC-START-MONTH          PIC X(02).                   01290000
013000             88  CC-ST-MONTH-VALID   VALUE '01' THRU '12'.        01300000
013100         10  CC-START-HYPHEN2        PIC X.                       01310000
013200             88  CC-ST-HYPEN2-VALID  VALUE '-'.                   01320000
013300         10  CC-START-DAY            PIC X(02).                   01330000
013400             88  CC-ST-DAY-VALID     VALUE '01' THRU '31'.        01340000
013500     05  FILLER                      PIC X(01).                   01350000
013600     05  CC-END-DATE.                                             01360000
013700         10  CC-END-YEAR             PIC X(04).                   01370000
013800             88  CC-END-YEAR-VALID   VALUE '1990' THRU '2099'.    01380000
013900         10  CC-END-HYPHEN1          PIC X.                       01390000
014000             88  CC-END-HYPEN1-VALID VALUE '-'.                   01400000
014100         10  CC-END-MONTH            PIC X(02).                   01410000
014200             88  CC-END-MONTH-VALID  VALUE '01' THRU '12'.        01420000
014300         10  CC-END-HYPHEN2          PIC X.                       01430000
014400             88  CC-END-HYPEN2-VALID VALUE '-'.                   01440000
014500         10  CC-END-DAY              PIC X(02).                   01450000
014600             88  CC-END-DAY-VALID    VALUE '01' THRU '31'.        01460000
014700     05  FILLER                      PIC X(58).                   01470000
014800                                                                  01480000
014900 01  WS-PROGRAM-COUNTERS.                                         01490000
015000     05  INVOICE-COUNT           PIC 9(9)  VALUE ZEROS.           01500000
015100     05  INVOICE-COUNT-DISPLAY   PIC ZZZZZZZZ9.                   01510000
015200                                                                  01520000
015300 01  PV-PROGRAM-VARIABLES.                                        01530000
015400     05  PV-DISC-EXTENDED-DAYS   PIC S9(4)  COMP.                 01540000
015500                                                                  01550000
015600     COPY DPWS004.                                                01560000
015700                                                                  01570000
015800 01  FILLER                      PIC X(35)  VALUE                 01580000
015900     'INVOICE EXTRACT FILE BEGINS HERE   '.                       01590000
016000     COPY APRD410.                                                01600000
016100                                                                  01610000
016200 01  FILLER                      PIC X(35)  VALUE                 01620000
016300     'END OF AP WORK RECORD AREA       **'.                       01630000
016400                                                                  01640000
016500                                                                  01650000
016600******************************************************************01660000
016700*  COMMUNICATIONS AREA2 FOR DB2                                   01670000
016800******************************************************************01680000
016900     COPY SQLCA2.                                                 01690000
017000                                                                  01700000
017100*---------------------------------------------------------------* 01710000
017200*    DB2 AREA FOR INVOICE TABLE                                 * 01720000
017300*---------------------------------------------------------------* 01730000
017400     EXEC SQL                                                     01740000
017500          INCLUDE TINVOIC                                         01750000
017600     END-EXEC.                                                    01760000
017700                                                                  01770000
017800*---------------------------------------------------------------* 01780000
017900*    DB2 AREA FOR MERCHANDISE INVOICE TABLE                     * 01790000
018000*---------------------------------------------------------------* 01800000
018100     EXEC SQL                                                     01810000
018200          INCLUDE TMDINVC                                         01820000
018300     END-EXEC.                                                    01830000
018400                                                                  01840000
018500*---------------------------------------------------------------* 01850000
018600*    DB2 AREA FOR PURCHASE TABLE                                * 01860000
018700*---------------------------------------------------------------* 01870000
018800     EXEC SQL                                                     01880000
018900          INCLUDE TPURCHS                                         01890000
019000     END-EXEC.                                                    01900000
019100                                                                  01910000
019200*---------------------------------------------------------------* 01920000
019300*    DB2 AREA FOR EXTERNAL ENTERPRISE TABLE                     * 01930000
019400*---------------------------------------------------------------* 01940000
019500     EXEC SQL                                                     01950000
019600          INCLUDE TEXTENT                                         01960000
019700     END-EXEC.                                                    01970000
019800                                                                  01980000
019900*---------------------------------------------------------------* 01990000
020000*    DB2 AREA FOR EXTERNAL ENTERPRISE NAME TABLE                * 02000000
020100*---------------------------------------------------------------* 02010000
020200     EXEC SQL                                                     02020000
020300          INCLUDE TENTNME                                         02030000
020400     END-EXEC.                                                    02040000
020500                                                                  02050000
020600*---------------------------------------------------------------* 02060000
020700*    DB2 AREA FOR PAYMENT REQUEST ITEM TABLE                    * 02070000
020800*---------------------------------------------------------------* 02080000
020900     EXEC SQL                                                     02090000
021000          INCLUDE TPREQIT                                         02100000
021100     END-EXEC.                                                    02110000
021200                                                                  02120000
021300*---------------------------------------------------------------* 02130000
021400*    DB2 AREA FOR ALLOWANCE/CHARGE TABLE                        * 02140000
021500*---------------------------------------------------------------* 02150000
021600     EXEC SQL                                                     02160000
021700          INCLUDE TALCHRG                                         02170000
021800     END-EXEC.                                                    02180000
021900                                                                  02190000
022000*---------------------------------------------------------------* 02200000
022100*    DB2 AREA FOR PO AGREEMENT TABLE                            * 02210000
022200*---------------------------------------------------------------* 02220000
022300     EXEC SQL                                                     02230000
022400          INCLUDE TPOAGMT                                         02240000
022500     END-EXEC.                                                    02250000
022600                                                                  02260000
022700*---------------------------------------------------------------* 02270000
022800*    DB2 AREA FOR PAYMENT TERMS TABLE                           * 02280000
022900*---------------------------------------------------------------* 02290000
023000     EXEC SQL                                                     02300000
023100          INCLUDE TPAYTRM                                         02310000
023200     END-EXEC.                                                    02320000
023300                                                                  02330000
023400*---------------------------------------------------------------* 02340000
023500*    DB2 AREA FOR INVOICE TERMS TABLE                           * 02350000
023600*---------------------------------------------------------------* 02360000
023700     EXEC SQL                                                     02370000
023800          INCLUDE TINVCTM                                         02380000
023900     END-EXEC.                                                    02390000
024000                                                                  02400000
024100*---------------------------------------------------------------* 02410000
024200*    DB2 AREA FOR COMMUNICATIONS                                * 02420000
024300*---------------------------------------------------------------* 02430000
024400     EXEC SQL                                                     02440000
024500          INCLUDE SQLCA                                           02450000
024600     END-EXEC.                                                    02460000
024700                                                                  02470000
024800         EXEC SQL                                                 02480000
024900         DECLARE INVOICE_CSR CURSOR FOR                           02490000
025000           SELECT  A.PAYT_REQ_SEQ_NBR                             02500000
025100                  ,A.INVC_ID                                      02510000
025200                  ,STR_NBR                                        02520000
025300                  ,INVC_TYP_CDE                                   02530000
025400                  ,STATUS_CDE                                     02540000
025500                  ,INVC_DTE                                       02550000
025600                  ,HOLD_IND                                       02560000
025700                  ,ENTR_MTHD_CDE                                  02570000
025800                  ,PAYT_RLSE_TMST                                 02580000
025900                  ,PAYT_DTE                                       02590000
026000                  ,GRO_COST_AMT                                   02600000
026100                  ,BAR_CDE                                        02610000
026200                  ,SPLIT_TERMS_IND                                02620000
026300                  ,RMIT_VND_ID                                    02630000
026400                  ,CRE_DTE                                        02640000
026500                  ,A.PO_NBR                                       02650000
026600                  ,TERM_SEL_CDE                                   02660000
026700                  ,VEND_FRGT_PCT                                  02670000
026800                  ,KOHLS_FRGT_PCT                                 02680000
026900                  ,BOL_ID                                         02690000
027000                  ,A.AP_PRC_CDE                                   02700000
027100                  ,A.AP_PRC_DTE                                   02710000
027100                  ,A.DC_NBR                                       02711003
027100                  ,A.MTCH_LVL_CDE                                 02712003
027200             FROM   TINVOIC A                                     02720000
027300                   ,TMDINVC B                                     02730000
027310            WHERE A.PO_NBR          = B.PO_NBR                    02731000
027320              AND A.INVC_ID         = B.INVC_ID                   02732000
027321              AND A.STATUS_CDE      IN ('PD','OP')                02732100
027322              AND DATE(A.PAYT_RLSE_TMST) BETWEEN :WS-START-DATE   02732200
027323                                             AND :WS-END-DATE     02732300
027324            WITH UR                                               02732400
027325         END-EXEC.                                                02732500
027326                                                                  02732600
027327     EXEC SQL                                                     02732700
027328          DECLARE ALCHRG_CSR CURSOR FOR                           02732800
027329          SELECT                                                  02732900
027330                 ALW_CHRG_SEQ_NBR                                 02733000
027340               , ALW_CHRG_TYP_CDE                                 02734000
027350               , ALW_CHRG_CDE                                     02735000
027360               , ALW_CHRG_SER_CDE                                 02736000
027370               , ALW_CHRG_PCT                                     02737000
027380               , ALW_CHRG_AMT                                     02738000
027390          FROM  TALCHRG A                                         02739000
027400          WHERE A.PO_NBR           = :INVOIC-PO-NBR               02740000
027500            AND A.INVC_ID          = :INVOIC-INVC-ID              02750000
027600          WITH UR                                                 02760000
027700     END-EXEC.                                                    02770000
027800                                                                  02780000
027900                                                                  02790000
028000                                                                  02800000
028100 01  FILLER                        PIC X(25) VALUE                02810000
028200          '<====WS FOR APKUT410 ENDS'.                            02820000
028300                                                                  02830000
028400*LINKAGE SECTION.                                                 02840000
028500                                                                  02850000
028600                                                                  02860000
028700 PROCEDURE DIVISION.                                              02870000
028800                                                                  02880000
028900                                                                  02890000
029000     PERFORM A100-HOUSEKEEPING.                                   02900000
029100                                                                  02910000
029200     PERFORM B100-PROCESSING                                      02920000
029300       UNTIL END-OF-INVOICES.                                     02930000
029400                                                                  02940000
029500     PERFORM R500-CLOSE-INVOICE-CURSOR.                           02950000
029600                                                                  02960000
029700     PERFORM Z900-END-OF-JOB.                                     02970000
029800                                                                  02980000
029900     GOBACK.                                                      02990000
030000        EJECT                                                     03000000
030100 A100-HOUSEKEEPING.                                               03010000
030200***************************************************************** 03020000
030300*    PERFORM ALL OF THE DATE AND FILE OPENING ROUTINES          * 03030000
030400***************************************************************** 03040000
030500*                                                                 03050000
030600     DISPLAY '*************** PROGRAM: APKUT410 **************'   03060000
030700     OPEN  OUTPUT  AP-INVC-EXTRACT-FILE                           03070000
030800           INPUT   CONTROL-CARD-FILE.                             03080000
030900                                                                  03090000
031000     INITIALIZE DCLTINVOIC.                                       03100000
031100     INITIALIZE DCLTMDINVC.                                       03110000
031200     INITIALIZE DCLTALCHRG.                                       03120000
031300     INITIALIZE DCLTINVCTM.                                       03130000
031400     INITIALIZE DCLTPAYTRM.                                       03140000
031500     INITIALIZE DCLTPOAGMT.                                       03150000
031600                                                                  03160000
031700     PERFORM Y100-READ-CONTROL-CARD.                              03170000
031800                                                                  03180000
031900     IF  END-OF-CONTROL-CARD                                      03190000
032000         DISPLAY '** APKUT410 ABEND **'                           03200000
032100         DISPLAY '** CONTROL CARD FILE IS EMPTY **'               03210000
032200         SET AP-EMPTY-FILE TO TRUE                                03220000
032300         CALL 'ILBOABN0' USING ABEND-CODE                         03230000
032400     END-IF.                                                      03240000
032500                                                                  03250000
032600     DISPLAY 'CONTROL CARD VALUES =======> '.                     03260000
032700     DISPLAY CONTROL-CARD-RECORD.                                 03270000
032800                                                                  03280000
032900     IF  CC-ST-YEAR-VALID                                         03290000
033000     AND CC-ST-HYPEN1-VALID                                       03300000
033100     AND CC-ST-MONTH-VALID                                        03310000
033200     AND CC-ST-HYPEN2-VALID                                       03320000
033300     AND CC-ST-DAY-VALID                                          03330000
033400     AND CC-END-YEAR-VALID                                        03340000
033500     AND CC-END-HYPEN1-VALID                                      03350000
033600     AND CC-END-MONTH-VALID                                       03360000
033700     AND CC-END-HYPEN2-VALID                                      03370000
033800     AND CC-END-DAY-VALID                                         03380000
033900         IF  (CC-START-MONTH = '02' AND CC-START-DAY > '29')      03390000
034000         OR  (CC-END-MONTH = '02' AND CC-END-DAY > '29')          03400000
034100         OR  ((CC-END-MONTH = '04' OR '06' OR '09' OR '11')       03410000
034200              AND CC-END-DAY > '30')                              03420000
034300         OR  ((CC-START-MONTH = '04' OR '06' OR '09' OR '11')     03430000
034400              AND CC-START-DAY > '30')                            03440000
034500             DISPLAY '** APKUT410 ABEND **'                       03450000
034600             DISPLAY '** CONTROL CARD DATES INVALID  **'          03460000
034700             SET AP-INVALID-CONTROL-CARD TO TRUE                  03470000
034800             CALL 'ILBOABN0' USING ABEND-CODE                     03480000
034900         ELSE                                                     03490000
035000             MOVE CC-START-DATE TO WS-START-DATE                  03500000
035100             MOVE CC-END-DATE TO WS-END-DATE                      03510000
035200     ELSE                                                         03520000
035300         DISPLAY '** APKUT410 ABEND **'                           03530000
035400         DISPLAY '** CONTROL CARD DATES INVALID  **'              03540000
035500         SET AP-INVALID-CONTROL-CARD TO TRUE                      03550000
035600         CALL 'ILBOABN0' USING ABEND-CODE                         03560000
035700     END-IF.                                                      03570000
035800                                                                  03580000
035900     PERFORM R050-OPEN-INVOICE-CURSOR.                            03590000
036000                                                                  03600000
036100     PERFORM R100-FETCH-INVOICE-CURSOR.                           03610000
036200                                                                  03620000
036300     IF   END-OF-INVOICES                                         03630000
036400          DISPLAY '**********************************'            03640000
036500          DISPLAY '*   EMPTY INVOICE TABLE          *'            03650000
036600          DISPLAY '*   PROGRAM ** = APKUT410        *'            03660000
036700          DISPLAY '**********************************'            03670000
036800     END-IF.                                                      03680000
036900 EJECT                                                            03690000
037000 B100-PROCESSING.                                                 03700000
037100*                                                                 03710000
037200***************************************************************** 03720000
037300*     PROCESS FETCHED INVOICES TO WRITE TO OUTPUT                 03730000
037400***************************************************************** 03740000
037500*                                                                 03750000
037600     INITIALIZE AP410-INVOICE-EXTRACT-RECORD.                     03760000
037700                                                                  03770000
037800     MOVE INVOIC-PAYT-REQ-SEQ-NBR   TO AP410-PAYT-REQ-SEQ-NBR.    03780000
037900     MOVE INVOIC-INVC-ID            TO AP410-INVC-ID.             03790000
038000     MOVE INVOIC-STR-NBR            TO AP410-STR-NBR.             03800000
038100     MOVE INVOIC-INVC-TYP-CDE       TO AP410-INVC-TYP-CDE.        03810000
038200     MOVE INVOIC-STATUS-CDE         TO AP410-STATUS-CDE.          03820000
038300     MOVE INVOIC-INVC-DTE           TO AP410-INVC-DTE.            03830000
038400     MOVE INVOIC-HOLD-IND           TO AP410-HOLD-IND.            03840000
038500     MOVE INVOIC-ENTR-MTHD-CDE      TO AP410-ENTR-MTHD-CDE.       03850000
038600     MOVE INVOIC-PAYT-RLSE-TMST     TO AP410-PAYT-RLSE-TMST.      03860000
038700     MOVE INVOIC-PAYT-DTE           TO AP410-PAYT-DTE.            03870000
038800     MOVE INVOIC-GRO-COST-AMT       TO AP410-GRO-COST-AMT.        03880000
038900     MOVE INVOIC-BAR-CDE            TO AP410-BAR-CDE.             03890000
039000     MOVE INVOIC-SPLIT-TERMS-IND    TO AP410-SPLIT-TERMS-IND.     03900000
039100     MOVE INVOIC-RMIT-VND-ID        TO AP410-REMIT-TO-DUN-NBR.    03910000
039200     MOVE INVOIC-CRE-DTE            TO AP410-ENTR-DTE.            03920000
039300     MOVE INVOIC-PO-NBR             TO AP410-PO-NBR.              03930000
039400     MOVE MDINVC-VEND-FRGT-PCT      TO AP410-VEND-FRGT-PCT.       03940000
039500     MOVE MDINVC-KOHLS-FRGT-PCT     TO AP410-KOHLS-FRGT-PCT.      03950000
039600     MOVE MDINVC-BOL-ID             TO AP410-BOL-ID.              03960000
039700     MOVE INVOIC-AP-PRC-DTE         TO AP410-AP-PRC-DTE.          03970000
039800     MOVE INVOIC-AP-PRC-CDE         TO AP410-AP-PRC-CDE.          03980000
039800     MOVE INVOIC-DC-NBR             TO AP410-DC-NBR.              03981003
039800     MOVE INVOIC-MTCH-LVL-CDE       TO AP410-MTCH-LVL-CDE.        03982003
039900                                                                  03990000
040000     PERFORM R200-OPEN-ALCHRG-CURSOR.                             04000000
040100                                                                  04010000
040200     SET ALW-INDX TO 1.                                           04020000
040300     SET START-OF-ALCHRG TO TRUE.                                 04030000
040400                                                                  04040000
040500     PERFORM R300-FETCH-ALCHRG-CURSOR                             04050000
040600       UNTIL END-OF-ALCHRG                                        04060000
040700          OR ALW-INDX > 12.                                       04070000
040800                                                                  04080000
040900     PERFORM R400-CLOSE-ALCHRG-CURSOR.                            04090000
041000                                                                  04100000
041100     IF MDINVC-TERM-SEL-CDE EQUAL PC-PURCHASE-TERMS               04110000
041200         PERFORM R600-GET-PO-TERMS                                04120000
041300     ELSE                                                         04130000
041400         IF MDINVC-TERM-SEL-CDE EQUAL PC-INVOICE-TERMS            04140000
041500             PERFORM R700-GET-INVOICE-TERMS                       04150000
041600         END-IF                                                   04160000
041700     END-IF.                                                      04170000
041800                                                                  04180000
041900     PERFORM R800-GET-DEPT-DUNS-DATA.                             04190000
042000                                                                  04200000
042100     WRITE AP-INVC-EXTRACT-RECORD                                 04210000
042200         FROM AP410-INVOICE-EXTRACT-RECORD.                       04220000
042300                                                                  04230000
042400     ADD +1 TO INVOICE-COUNT.                                     04240000
042500                                                                  04250000
042600     PERFORM R100-FETCH-INVOICE-CURSOR.                           04260000
042700 EJECT                                                            04270000
042800 R050-OPEN-INVOICE-CURSOR.                                        04280000
042900                                                                  04290000
043000     PERFORM WITH TEST AFTER                                      04300000
043100         VARYING WS-RETRY-COUNT FROM 1 BY 1                       04310000
043200         UNTIL   WS-RETRY-COUNT > WS-RETRY-MAX                    04320000
043300            OR   SQLCODE = ZERO                                   04330000
043400            OR   SQLCODE = +100                                   04340000
043500                                                                  04350000
043600         EXEC SQL                                                 04360000
043700            OPEN INVOICE_CSR                                      04370000
043800         END-EXEC                                                 04380000
043900                                                                  04390000
044000         EVALUATE TRUE                                            04400000
044100             WHEN SQLCODE = ZERO                                  04410000
044200             WHEN SQLCODE = +100                                  04420000
044300             WHEN SQLCODE = -904                                  04430000
044400             WHEN SQLCODE = -913                                  04440000
044500                  CONTINUE                                        04450000
044600                                                                  04460000
044700             WHEN SQLWARN0 NOT = SPACES                           04470000
044800             WHEN SQLCODE  NOT = ZERO                             04480000
044900                  MOVE 'R050-OPEN-INVOICE-CURSOR      '           04490000
045000                                TO WS-ABEND-PARAGRAPH             04500000
045100                  MOVE 'UNSUCCESSFUL OPEN   INVOIC'               04510000
045200                                TO WS-ABEND-OPERATION             04520000
045300                  MOVE 'TINVOIC ' TO WS-ABEND-STRUCTURE-1         04530000
045400                  MOVE 'TMDINVC ' TO WS-ABEND-STRUCTURE-2         04540000
045500                  PERFORM Z999-SQL-ERROR                          04550000
045600         END-EVALUATE                                             04560000
045700     END-PERFORM.                                                 04570000
045800                                                                  04580000
045900     IF WS-RETRY-COUNT > WS-RETRY-MAX                             04590000
046000         MOVE 'R050-OPEN-INVOICE-CURSOR      '                    04600000
046100                       TO WS-ABEND-PARAGRAPH                      04610000
046200         MOVE 'MAX RETRIES EXCEEDED ON OPEN   INVOIC'             04620000
046300                         TO WS-ABEND-OPERATION                    04630000
046400         PERFORM Z999-SQL-ERROR.                                  04640000
046500                                                                  04650000
046600                                                                  04660000
046700 R100-FETCH-INVOICE-CURSOR.                                       04670000
046800                                                                  04680000
046900     PERFORM WITH TEST AFTER                                      04690000
047000        VARYING WS-RETRY-COUNT FROM 1 BY 1                        04700000
047100          UNTIL WS-RETRY-COUNT > WS-RETRY-MAX                     04710000
047200             OR SQLCODE = ZERO                                    04720000
047300             OR SQLCODE = +100                                    04730000
047400        EXEC SQL                                                  04740000
047500            FETCH INVOICE_CSR                                     04750000
047600            INTO   :INVOIC-PAYT-REQ-SEQ-NBR                       04760000
047700                  ,:INVOIC-INVC-ID                                04770000
047800                  ,:INVOIC-STR-NBR                                04780000
047900                  ,:INVOIC-INVC-TYP-CDE                           04790000
048000                  ,:INVOIC-STATUS-CDE                             04800000
048100                  ,:INVOIC-INVC-DTE                               04810000
048200                  ,:INVOIC-HOLD-IND                               04820000
048300                  ,:INVOIC-ENTR-MTHD-CDE                          04830000
048400                  ,:INVOIC-PAYT-RLSE-TMST                         04840000
048500                  ,:INVOIC-PAYT-DTE                               04850000
048600                  ,:INVOIC-GRO-COST-AMT                           04860000
048700                  ,:INVOIC-BAR-CDE                                04870000
048800                  ,:INVOIC-SPLIT-TERMS-IND                        04880000
048900                  ,:INVOIC-RMIT-VND-ID                            04890000
049000                  ,:INVOIC-CRE-DTE                                04900000
049100                  ,:INVOIC-PO-NBR                                 04910000
049200                  ,:MDINVC-TERM-SEL-CDE                           04920000
049300                  ,:MDINVC-VEND-FRGT-PCT                          04930000
049400                  ,:MDINVC-KOHLS-FRGT-PCT                         04940000
049500                  ,:MDINVC-BOL-ID                                 04950000
049600                  ,:INVOIC-AP-PRC-CDE                             04960000
049700                  ,:INVOIC-AP-PRC-DTE                             04970000
049700                  ,:INVOIC-DC-NBR                                 04971003
049700                  ,:INVOIC-MTCH-LVL-CDE                           04972003
049800        END-EXEC                                                  04980000
049900                                                                  04990000
050000        EVALUATE TRUE                                             05000000
050100            WHEN SQLCODE = ZERO                                   05010000
050200                 CONTINUE                                         05020000
050300            WHEN SQLCODE = +100                                   05030000
050400                 SET END-OF-INVOICES TO TRUE                      05040000
050500            WHEN SQLCODE = -904                                   05050000
050600            WHEN SQLCODE = -913                                   05060000
050700              CONTINUE                                            05070000
050800            WHEN SQLWARN0 NOT = SPACES                            05080000
050900            WHEN SQLCODE  NOT = ZERO                              05090000
051000              MOVE 'R100-FETCH-INVOICE-CURSOR             '       05100000
051100                            TO WS-ABEND-PARAGRAPH                 05110000
051200              MOVE 'UNSUCCESSFUL FETCH  INVOIC'                   05120000
051300                            TO WS-ABEND-OPERATION                 05130000
051400              MOVE 'TINVOIC ' TO WS-ABEND-STRUCTURE-1             05140000
051500              MOVE 'TMDINVC ' TO WS-ABEND-STRUCTURE-2             05150000
051600              PERFORM Z999-SQL-ERROR                              05160000
051700           END-EVALUATE                                           05170000
051800     END-PERFORM.                                                 05180000
051900                                                                  05190000
052000     IF WS-RETRY-COUNT > 3                                        05200000
052100         MOVE 'R100-FETCH                    '                    05210000
052200                       TO WS-ABEND-PARAGRAPH                      05220000
052300         MOVE 'MAX RETRIES EXCEEDED ON FETCH  INVOIC'             05230000
052400                         TO WS-ABEND-OPERATION                    05240000
052500         PERFORM Z999-SQL-ERROR                                   05250000
052600     END-IF.                                                      05260000
052700                                                                  05270000
052800                                                                  05280000
052900 R200-OPEN-ALCHRG-CURSOR.                                         05290000
053000                                                                  05300000
053100     PERFORM WITH TEST AFTER                                      05310000
053200         VARYING WS-RETRY-COUNT FROM 1 BY 1                       05320000
053300         UNTIL   WS-RETRY-COUNT > 3    OR                         05330000
053400                 SQLCODE = ZERO OR                                05340000
053500                 SQLCODE = +100                                   05350000
053600                                                                  05360000
053700         EXEC SQL                                                 05370000
053800            OPEN ALCHRG_CSR                                       05380000
053900         END-EXEC                                                 05390000
054000                                                                  05400000
054100         EVALUATE TRUE                                            05410000
054200             WHEN SQLCODE = ZERO                                  05420000
054300             WHEN SQLCODE = +100                                  05430000
054400             WHEN SQLCODE = -904                                  05440000
054500             WHEN SQLCODE = -913                                  05450000
054600                  CONTINUE                                        05460000
054700                                                                  05470000
054800             WHEN SQLWARN0 NOT = SPACES                           05480000
054900             WHEN SQLCODE  NOT = ZERO                             05490000
055000                  MOVE 'R200-OPEN-ALCHRG-CURSOR       '           05500000
055100                                TO WS-ABEND-PARAGRAPH             05510000
055200                  MOVE 'UNSUCCESSFUL OPEN  ALCHRG '               05520000
055300                                TO WS-ABEND-OPERATION             05530000
055400                  MOVE 'TALCHRG ' TO WS-ABEND-STRUCTURE-1         05540000
055500                  MOVE  SPACES    TO WS-ABEND-STRUCTURE-2         05550000
055600                  PERFORM Z999-SQL-ERROR                          05560000
055700         END-EVALUATE                                             05570000
055800     END-PERFORM.                                                 05580000
055900                                                                  05590000
056000     IF WS-RETRY-COUNT > 3                                        05600000
056100         MOVE 'R200-OPEN-ALCHRG-CURSOR       '                    05610000
056200                       TO WS-ABEND-PARAGRAPH                      05620000
056300         MOVE 'MAX RETRIES EXCEEDED ON OPEN   ALCHRG'             05630000
056400                         TO WS-ABEND-OPERATION                    05640000
056500         PERFORM Z999-SQL-ERROR.                                  05650000
056600 EJECT                                                            05660000
056700 R300-FETCH-ALCHRG-CURSOR.                                        05670000
056800                                                                  05680000
056900     PERFORM WITH TEST AFTER                                      05690000
057000        VARYING WS-RETRY-COUNT FROM 1 BY 1                        05700000
057100        UNTIL   WS-RETRY-COUNT > 3    OR                          05710000
057200                SQLCODE = ZERO OR                                 05720000
057300                SQLCODE = +100                                    05730000
057400        EXEC SQL                                                  05740000
057500            FETCH  ALCHRG_CSR                                     05750000
057600             INTO :ALCHRG-ALW-CHRG-SEQ-NBR                        05760000
057700                , :ALCHRG-ALW-CHRG-TYP-CDE                        05770000
057800                , :ALCHRG-ALW-CHRG-CDE                            05780000
057900                , :ALCHRG-ALW-CHRG-SER-CDE                        05790000
058000                , :ALCHRG-ALW-CHRG-PCT                            05800000
058100                , :ALCHRG-ALW-CHRG-AMT                            05810000
058200        END-EXEC                                                  05820000
058300                                                                  05830000
058400        EVALUATE TRUE                                             05840000
058500            WHEN SQLCODE = ZERO                                   05850000
058600                 CONTINUE                                         05860000
058700            WHEN SQLCODE = +100                                   05870000
058800                 SET END-OF-ALCHRG TO TRUE                        05880000
058900            WHEN SQLCODE = -904                                   05890000
059000            WHEN SQLCODE = -913                                   05900000
059100              CONTINUE                                            05910000
059200            WHEN SQLWARN0 NOT = SPACES                            05920000
059300            WHEN SQLCODE  NOT = ZERO                              05930000
059400              MOVE 'R300-FETCH-ALCHRG-CURSOR      '               05940000
059500                            TO WS-ABEND-PARAGRAPH                 05950000
059600              MOVE 'UNSUCCESSFUL FETCH  ALCHRG'                   05960000
059700                            TO WS-ABEND-OPERATION                 05970000
059800              MOVE 'TALCHRG ' TO WS-ABEND-STRUCTURE-1             05980000
059900              MOVE SPACES     TO WS-ABEND-STRUCTURE-2             05990000
060000              PERFORM Z999-SQL-ERROR                              06000000
060100           END-EVALUATE                                           06010000
060200     END-PERFORM.                                                 06020000
060300                                                                  06030000
060400     IF WS-RETRY-COUNT > 3                                        06040000
060500         MOVE 'R100-FETCH-ALCHRG-CURSOR      '                    06050000
060600                       TO WS-ABEND-PARAGRAPH                      06060000
060700         MOVE 'MAX RETRIES EXCEEDED ON FETCH  INVOIC'             06070000
060800                         TO WS-ABEND-OPERATION                    06080000
060900         PERFORM Z999-SQL-ERROR                                   06090000
061000     END-IF.                                                      06100000
061100                                                                  06110000
061200     IF  SQLCODE = ZERO                                           06120000
061300         IF  ALW-INDX > 12                                        06130000
061400             MOVE 'R100-FETCH-ALCHRG-CURSOR      '                06140000
061500               TO WS-ABEND-PARAGRAPH                              06150000
061600             MOVE 'ALW-CHRG NUMBER OF ENTRIES EXCEEDED'           06160000
061700               TO WS-ABEND-OPERATION                              06170000
061800             SET AP-TABLE-FULL TO TRUE                            06180000
061900             CALL 'ILBOABN0' USING ABEND-CODE                     06190000
062000         ELSE                                                     06200000
062100             MOVE ALCHRG-ALW-CHRG-SEQ-NBR                         06210000
062200               TO AP410-ALW-CHRG-SEQ-NBR (ALW-INDX)               06220000
062300             MOVE ALCHRG-ALW-CHRG-TYP-CDE                         06230000
062400               TO AP410-ALW-CHRG-TYP-CDE (ALW-INDX)               06240000
062500             MOVE ALCHRG-ALW-CHRG-CDE                             06250000
062600               TO AP410-ALW-CHRG-CDE (ALW-INDX)                   06260000
062700             MOVE ALCHRG-ALW-CHRG-SER-CDE                         06270000
062800               TO AP410-ALW-CHRG-SER-CDE (ALW-INDX)               06280000
062900             MOVE ALCHRG-ALW-CHRG-PCT                             06290000
063000               TO AP410-ALW-CHRG-PCT (ALW-INDX)                   06300000
063100             MOVE ALCHRG-ALW-CHRG-AMT                             06310000
063200               TO AP410-ALW-CHRG-AMT (ALW-INDX)                   06320000
063300             SET ALW-INDX UP BY 1                                 06330000
063400         END-IF                                                   06340000
063500     END-IF.                                                      06350000
063600                                                                  06360000
063700  EJECT                                                           06370000
063800 R400-CLOSE-ALCHRG-CURSOR.                                        06380000
063900                                                                  06390000
064000     PERFORM WITH TEST AFTER                                      06400000
064100         VARYING WS-RETRY-COUNT FROM 1 BY 1                       06410000
064200           UNTIL WS-RETRY-COUNT > WS-RETRY-MAX                    06420000
064300              OR SQLCODE = ZERO                                   06430000
064400              OR SQLCODE = +100                                   06440000
064500                                                                  06450000
064600         EXEC SQL                                                 06460000
064700            CLOSE ALCHRG_CSR                                      06470000
064800         END-EXEC                                                 06480000
064900                                                                  06490000
065000         EVALUATE TRUE                                            06500000
065100             WHEN SQLCODE = ZERO                                  06510000
065200             WHEN SQLCODE = +100                                  06520000
065300             WHEN SQLCODE = -904                                  06530000
065400             WHEN SQLCODE = -913                                  06540000
065500                  CONTINUE                                        06550000
065600             WHEN SQLWARN0 NOT = SPACES                           06560000
065700             WHEN SQLCODE  NOT = ZERO                             06570000
065800                  MOVE 'R400-CLOSE-TALCHRG-CURSOR     '           06580000
065900                                TO WS-ABEND-PARAGRAPH             06590000
066000                  MOVE 'UNSUCCESSFUL CLOSE TALCHRG'               06600000
066100                                TO WS-ABEND-OPERATION             06610000
066200                  MOVE 'TALCHRG ' TO WS-ABEND-STRUCTURE-1         06620000
066300                  MOVE SPACES     TO WS-ABEND-STRUCTURE-2         06630000
066400                  PERFORM Z999-SQL-ERROR                          06640000
066500         END-EVALUATE                                             06650000
066600     END-PERFORM.                                                 06660000
066700                                                                  06670000
066800     IF WS-RETRY-COUNT > WS-RETRY-MAX                             06680000
066900         MOVE 'R400-CLOSE-TALCHRG-CURSOR     '                    06690000
067000                       TO WS-ABEND-PARAGRAPH                      06700000
067100         MOVE 'MAX RETRIES EXCEEDED ON CLOSE TALCHRG'             06710000
067200                         TO WS-ABEND-OPERATION                    06720000
067300         PERFORM Z999-SQL-ERROR.                                  06730000
067400                                                                  06740000
067500  EJECT                                                           06750000
067600 R500-CLOSE-INVOICE-CURSOR.                                       06760000
067700                                                                  06770000
067800     PERFORM WITH TEST AFTER                                      06780000
067900         VARYING WS-RETRY-COUNT FROM 1 BY 1                       06790000
068000           UNTIL WS-RETRY-COUNT > WS-RETRY-MAX                    06800000
068100              OR SQLCODE = ZERO                                   06810000
068200              OR SQLCODE = +100                                   06820000
068300                                                                  06830000
068400         EXEC SQL                                                 06840000
068500            CLOSE INVOICE_CSR                                     06850000
068600         END-EXEC                                                 06860000
068700                                                                  06870000
068800         EVALUATE TRUE                                            06880000
068900             WHEN SQLCODE = ZERO                                  06890000
069000             WHEN SQLCODE = +100                                  06900000
069100             WHEN SQLCODE = -904                                  06910000
069200             WHEN SQLCODE = -913                                  06920000
069300                  CONTINUE                                        06930000
069400             WHEN SQLWARN0 NOT = SPACES                           06940000
069500             WHEN SQLCODE  NOT = ZERO                             06950000
069600                  MOVE 'R500-CLOSE-INVOICE-CURSOR     '           06960000
069700                                TO WS-ABEND-PARAGRAPH             06970000
069800                  MOVE 'UNSUCCESSFUL CLOSE  INVOIC'               06980000
069900                                TO WS-ABEND-OPERATION             06990000
070000                  MOVE 'TINVOIC ' TO WS-ABEND-STRUCTURE-1         07000000
070100                  MOVE 'TMDINVC ' TO WS-ABEND-STRUCTURE-2         07010000
070200                  PERFORM Z999-SQL-ERROR                          07020000
070300         END-EVALUATE                                             07030000
070400     END-PERFORM.                                                 07040000
070500                                                                  07050000
070600     IF WS-RETRY-COUNT > WS-RETRY-MAX                             07060000
070700         MOVE 'R500-CLOSE-INVOICE-CURSOR     '                    07070000
070800                       TO WS-ABEND-PARAGRAPH                      07080000
070900         MOVE 'MAX RETRIES EXCEEDED ON CLOSE  INVOIC'             07090000
071000                         TO WS-ABEND-OPERATION                    07100000
071100         PERFORM Z999-SQL-ERROR.                                  07110000
071200                                                                  07120000
071300  EJECT                                                           07130000
071400 R600-GET-PO-TERMS.                                               07140000
071500                                                                  07150000
071600     PERFORM WITH TEST AFTER                                      07160000
071700         VARYING WS-RETRY-COUNT FROM 1 BY 1                       07170000
071800           UNTIL WS-RETRY-COUNT >  WS-RETRY-MAX                   07180000
071900              OR SQLCODE = +0                                     07190000
072000              OR SQLCODE = +100                                   07200000
072100                                                                  07210000
072200        EXEC SQL                                                  07220000
072300            SELECT                                                07230000
072400                  PA.DISC_PAY_DAY_QTY,                            07240000
072500                  PT.DISCOUNT_PCT,                                07250000
072600                  PT.DUE_DAY_QTY,                                 07260000
072700                  PT.DISCOUNT_DAYS_QTY,                           07270000
072800                  PT.DUE_DAY_FR_DTE_TXT                           07280000
072900              INTO                                                07290000
073000                  :POAGMT-DISC-PAY-DAY-QTY,                       07300000
073100                  :PAYTRM-DISCOUNT-PCT,                           07310000
073200                  :PAYTRM-DUE-DAY-QTY,                            07320000
073300                  :PAYTRM-DISCOUNT-DAYS-QTY,                      07330000
073400                  :PAYTRM-DUE-DAY-FR-DTE-TXT                      07340000
073500              FROM                                                07350000
073600                  TPOAGMT PA,                                     07360000
073700                  TPAYTRM PT                                      07370000
073800              WHERE PA.PO_NBR         = :INVOIC-PO-NBR            07380000
073900                AND PA.PAYT_TERM_ID   = PT.PAY_TERM_ID            07390000
074000                AND PA.AGRMT_TYP_ID   = '2'                       07400000
074100                AND PA.VER_STATUS_CDE = 'A'                       07410000
074200             WITH UR                                              07420000
074300        END-EXEC                                                  07430000
074400                                                                  07440000
074500        EVALUATE TRUE                                             07450000
074600           WHEN SQLCODE = ZERO                                    07460000
074700           WHEN SQLCODE = +100                                    07470000
074800           WHEN SQLCODE = -904                                    07480000
074900           WHEN SQLCODE = -911                                    07490000
075000           WHEN SQLCODE = -913                                    07500000
075100                CONTINUE                                          07510000
075200                                                                  07520000
075300           WHEN SQLWARN0 NOT = SPACES                             07530000
075400           WHEN SQLCODE  NOT = ZERO                               07540000
075500               MOVE 'R600-GET-PO-TERMS             '              07550000
075600                                   TO WS-ABEND-PARAGRAPH          07560000
075700               MOVE 'UNSUCCESSFUL SELECT'                         07570000
075800                                   TO WS-ABEND-OPERATION          07580000
075900               MOVE 'TPOAGMT'      TO WS-ABEND-STRUCTURE-1        07590000
076000               MOVE 'TPAYTRM'      TO WS-ABEND-STRUCTURE-2        07600000
076100               PERFORM Z999-SQL-ERROR                             07610000
076200        END-EVALUATE                                              07620000
076300     END-PERFORM.                                                 07630000
076400                                                                  07640000
076500     IF WS-RETRY-COUNT >  WS-RETRY-MAX                            07650000
076600         MOVE 'R600-GET-PO-TERMS             '                    07660000
076700                             TO WS-ABEND-PARAGRAPH                07670000
076800         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    07680000
076900                             TO WS-ABEND-OPERATION                07690000
077000         MOVE 'TPOAGMT'      TO WS-ABEND-STRUCTURE-1              07700000
077100         MOVE 'TPAYTRM'      TO WS-ABEND-STRUCTURE-2              07710000
077200         PERFORM Z999-SQL-ERROR                                   07720000
077300     END-IF.                                                      07730000
077400                                                                  07740000
077500     IF  SQLCODE = ZERO                                           07750000
077600         MOVE PAYTRM-DISCOUNT-PCT      TO AP410-DISC-PCT          07760000
077700         MOVE PAYTRM-DISCOUNT-DAYS-QTY TO AP410-DISC-DUE-DAY-QTY  07770000
077800         MOVE PAYTRM-DUE-DAY-QTY       TO AP410-NET-DUE-DAY-QTY   07780000
077900         MOVE POAGMT-DISC-PAY-DAY-QTY  TO AP410-EXTD-DAYS-QTY     07790000
078000         IF  PAYTRM-DUE-DAY-FR-DTE-TXT = 'EOM'                    07800000
078100             MOVE '02'                 TO AP410-TERM-TYP-CDE      07810000
078200         ELSE                                                     07820000
078300             MOVE '01'                 TO AP410-TERM-TYP-CDE      07830000
078400         END-IF                                                   07840000
078500     END-IF.                                                      07850000
078600                                                                  07860000
078700     EXEC SQL                                                     07870000
078800         SELECT  PA.DISC_PAY_DAY_QTY                              07880000
078900           INTO :PV-DISC-EXTENDED-DAYS                            07890000
079000           FROM  TPOAGMT PA                                       07900000
079100          WHERE  PA.PO_NBR         = :INVOIC-PO-NBR               07910000
079200            AND  PA.VER_STATUS_CDE = 'A'                          07920000
079300            AND  PA.AGRMT_TYP_ID   = '5'                          07930000
079400            AND  PA.TYP_CDE        =  1                           07940000
079500          WITH UR                                                 07950000
079600     END-EXEC.                                                    07960000
079700                                                                  07970000
079800     EVALUATE TRUE                                                07980000
079900         WHEN SQLCODE = ZERO                                      07990000
080000              ADD PV-DISC-EXTENDED-DAYS TO AP410-EXTD-DAYS-QTY    08000000
080100         WHEN SQLCODE = +100                                      08010000
080200              CONTINUE                                            08020000
080300         WHEN SQLWARN0 NOT = SPACES                               08030000
080400         WHEN SQLCODE  NOT = ZERO                                 08040000
080500             MOVE 'R600-GET-PO-TERMS'    TO WS-ABEND-PARAGRAPH    08050000
080600             MOVE 'UNSUCCESSFUL SELECT'  TO WS-ABEND-OPERATION    08060000
080700             MOVE 'TPOAGMT'              TO WS-ABEND-STRUCTURE-1  08070000
080800             MOVE SPACES                 TO WS-ABEND-STRUCTURE-2  08080000
080900             PERFORM Z999-SQL-ERROR                               08090000
081000     END-EVALUATE.                                                08100000
081100 EJECT                                                            08110000
081200*----------------------------------------------------------------*08120000
081300*    RETRIEVES THE TERMS WHEN THE TERM SELECT CODE INDICATES     *08130000
081400*    THEY EXIST ON THE INVOICE TERMS TABLE.                      *08140000
081500*    NOTE:  A NOT FOUND CONDITION IN THIS INSTANCE PREVENTS THE  *08150000
081600*           CALCULATION OF THE PAYMENT DUE DATE SO PROCESSING    *08160000
081700*           CANNOT PROCEED AND THE PROGRAM MUST ABEND.           *08170000
081800*----------------------------------------------------------------*08180000
081900 R700-GET-INVOICE-TERMS.                                          08190000
082000                                                                  08200000
082100     PERFORM WITH TEST AFTER                                      08210000
082200         VARYING WS-RETRY-COUNT FROM 1 BY 1                       08220000
082300           UNTIL WS-RETRY-COUNT >  WS-RETRY-MAX                   08230000
082400              OR SQLCODE = ZERO                                   08240000
082500              OR SQLCODE = +100                                   08250000
082600                                                                  08260000
082700         EXEC SQL                                                 08270000
082800             SELECT                                               08280000
082900                 DISC_PCT,                                        08290000
083000                 DISC_DUE_DAY_QTY,                                08300000
083100                 EXTD_DAYS_QTY,                                   08310000
083200                 TERM_TYP_CDE,                                    08320000
083300                 NET_DUE_DAY_QTY                                  08330000
083400             INTO                                                 08340000
083500                 :INVCTM-DISC-PCT,                                08350000
083600                 :INVCTM-DISC-DUE-DAY-QTY,                        08360000
083700                 :INVCTM-EXTD-DAYS-QTY,                           08370000
083800                 :INVCTM-TERM-TYP-CDE,                            08380000
083900                 :INVCTM-NET-DUE-DAY-QTY                          08390000
084000                FROM TINVCTM                                      08400000
084100                WHERE PO_NBR       = :INVOIC-PO-NBR               08410000
084200                  AND INVC_ID      = :INVOIC-INVC-ID              08420000
084300                  AND TERM_SEQ_NBR     = 1                        08430000
084400                WITH UR                                           08440000
084500         END-EXEC                                                 08450000
084600                                                                  08460000
084700         EVALUATE TRUE                                            08470000
084800             WHEN SQLCODE = ZERO                                  08480000
084900             WHEN SQLCODE = +100                                  08490000
085000             WHEN SQLCODE = -904                                  08500000
085100             WHEN SQLCODE = -911                                  08510000
085200             WHEN SQLCODE = -913                                  08520000
085300                  CONTINUE                                        08530000
085400                                                                  08540000
085500             WHEN SQLWARN0 NOT = SPACES                           08550000
085600             WHEN SQLCODE  NOT = ZERO                             08560000
085700                 MOVE 'R700-GET-INVOICE-TERMS       '             08570000
085800                   TO WS-ABEND-PARAGRAPH                          08580000
085900                 MOVE 'UNSUCCESSFUL SELECT'                       08590000
086000                                     TO WS-ABEND-OPERATION        08600000
086100                 MOVE 'TINVCTM'      TO WS-ABEND-STRUCTURE-1      08610000
086200                 MOVE SPACES         TO WS-ABEND-STRUCTURE-2      08620000
086300                 PERFORM Z999-SQL-ERROR                           08630000
086400         END-EVALUATE                                             08640000
086500     END-PERFORM.                                                 08650000
086600                                                                  08660000
086700     IF WS-RETRY-COUNT >  WS-RETRY-MAX                            08670000
086800         MOVE 'R700-GET-INVOICE-TERMS        '                    08680000
086900                             TO WS-ABEND-PARAGRAPH                08690000
087000         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    08700000
087100                             TO WS-ABEND-OPERATION                08710000
087200         MOVE 'TINVCTM'      TO WS-ABEND-STRUCTURE-1              08720000
087300         MOVE SPACES         TO WS-ABEND-STRUCTURE-2              08730000
087400         PERFORM Z999-SQL-ERROR                                   08740000
087500     END-IF.                                                      08750000
087600                                                                  08760000
087700     IF  SQLCODE = ZERO                                           08770000
087800         MOVE INVCTM-DISC-PCT         TO AP410-DISC-PCT           08780000
087900         MOVE INVCTM-DISC-DUE-DAY-QTY TO AP410-DISC-DUE-DAY-QTY   08790000
088000         MOVE INVCTM-EXTD-DAYS-QTY    TO AP410-EXTD-DAYS-QTY      08800000
088100         MOVE INVCTM-TERM-TYP-CDE     TO AP410-TERM-TYP-CDE       08810000
088200         MOVE INVCTM-NET-DUE-DAY-QTY  TO AP410-NET-DUE-DAY-QTY    08820000
088300     END-IF.                                                      08830000
088400                                                                  08840000
088500 EJECT                                                            08850000
088600 R800-GET-DEPT-DUNS-DATA.                                         08860000
088700                                                                  08870000
088800     PERFORM WITH TEST AFTER                                      08880000
088900         VARYING WS-RETRY-COUNT FROM 1 BY 1                       08890000
089000           UNTIL WS-RETRY-COUNT > WS-RETRY-MAX                    08900000
089100              OR SQLCODE = ZERO                                   08910000
089200                                                                  08920000
089300         EXEC SQL                                                 08930000
089400             SELECT                                               08940000
089500                 PU.ENT_ID,                                       08950000
089600                 PU.DEPT_NBR,                                     08960000
089700                 EE.DUN_NBR                                       08970000
089800             INTO                                                 08980000
089900                 :PURCHS-ENT-ID,                                  08990000
090000                 :PURCHS-DEPT-NBR,                                09000000
090100                 :EXTENT-DUN-NBR                                  09010000
090200             FROM TPURCHS PU,                                     09020000
090300                  TEXTENT EE                                      09030000
090400             WHERE PU.PO_NBR = :INVOIC-PO-NBR                     09040000
090500               AND PU.ENT_ID = EE.ENT_ID                          09050000
090600               AND PU.VER_STATUS_CDE = 'A'                        09060000
090700             WITH UR                                              09070000
090800         END-EXEC                                                 09080000
090900                                                                  09090000
091000         EVALUATE TRUE                                            09100000
091100             WHEN SQLCODE = ZERO                                  09110000
091200                 MOVE PURCHS-DEPT-NBR TO AP410-DEPT               09120000
091300                 MOVE EXTENT-DUN-NBR  TO AP410-DUNS-NO            09130000
091400             WHEN SQLCODE = -904                                  09140000
091500             WHEN SQLCODE = -911                                  09150000
091600             WHEN SQLCODE = -913                                  09160000
091700                  CONTINUE                                        09170000
091800             WHEN OTHER                                           09180000
091900                 MOVE 'R800-GET-DEPT-DUNS-DATA       '            09190000
092000                                     TO WS-ABEND-PARAGRAPH        09200000
092100                 MOVE 'DUNS NBR NOT FOUND ON TEXTENT TABLE'       09210000
092200                                     TO WS-ABEND-OPERATION        09220000
092300                 MOVE 'TPURCHS'      TO WS-ABEND-STRUCTURE-1      09230000
092400                 MOVE 'TEXTENT'      TO WS-ABEND-STRUCTURE-2      09240000
092500                 PERFORM Z999-SQL-ERROR                           09250000
092600         END-EVALUATE                                             09260000
092700     END-PERFORM.                                                 09270000
092800                                                                  09280000
092900     IF WS-RETRY-COUNT > WS-RETRY-MAX                             09290000
093000         MOVE 'R800-GET-DEPT-DUNS-DATA       '                    09300000
093100                             TO WS-ABEND-PARAGRAPH                09310000
093200         MOVE 'MAX RETRIES EXCEEDED ON SELECT OF DEPT/DUNS'       09320000
093300                             TO WS-ABEND-OPERATION                09330000
093400         MOVE 'TPURCHS'      TO WS-ABEND-STRUCTURE-1              09340000
093500         MOVE 'TEXTENT'      TO WS-ABEND-STRUCTURE-2              09350000
093600         PERFORM Z999-SQL-ERROR                                   09360000
093700     END-IF.                                                      09370000
093800 EJECT                                                            09380000
093900                                                                  09390000
094000******************************************************************09400000
094100* Y100-READ-CONTROL-CARD                                          09410000
094200******************************************************************09420000
094300 Y100-READ-CONTROL-CARD.                                          09430000
094400     READ CONTROL-CARD-FILE INTO CONTROL-CARD-RECORD              09440000
094500        AT END                                                    09450000
094600           SET END-OF-CONTROL-CARD TO TRUE.                       09460000
094700                                                                  09470000
094800 Z900-END-OF-JOB.                                                 09480000
094900*                                                                 09490000
095000***************************************************************** 09500000
095100*     FINISH THE ERROR PROCESS, REPORT ON NECESSARY TOTALS,       09510000
095200*     AND CLOSE ALL FILES                                         09520000
095300***************************************************************** 09530000
095400*                                                                 09540000
095500     CLOSE AP-INVC-EXTRACT-FILE                                   09550000
095600           CONTROL-CARD-FILE.                                     09560000
095700                                                                  09570000
095800     MOVE INVOICE-COUNT TO INVOICE-COUNT-DISPLAY.                 09580000
095900     DISPLAY '*****************************************'.         09590000
096000     DISPLAY 'TOTAL INVOICES EXTRACTED = ' INVOICE-COUNT-DISPLAY. 09600000
096100     DISPLAY '*****************************************'.         09610000
096200                                                                  09620000
096300 Z999-SQL-ERROR.                                                  09630000
096400*                                                                 09640000
096500***************************************************************** 09650000
096600*     PROCESS DB2 ABENDS                                          09660000
096700***************************************************************** 09670000
096800*                                                                 09680000
096900     DISPLAY '*** DB2 ERROR '.                                    09690000
097000     DISPLAY '*** PROGRAM   = ' WS-ABEND-PROGRAM.                 09700000
097100     DISPLAY '*** PARAGRAPH = ' WS-ABEND-PARAGRAPH.               09710000
097200     DISPLAY '*** OPERATION = ' WS-ABEND-OPERATION.               09720000
097300     DISPLAY '*** TABLE 1   = ' WS-ABEND-STRUCTURE-1.             09730000
097400     IF WS-ABEND-STRUCTURE-2 > SPACES                             09740000
097500         DISPLAY '*** TABLE 2   = ' WS-ABEND-STRUCTURE-2.         09750000
097600                                                                  09760000
097700     MOVE +4013                    TO ABEND-CODE.                 09770000
097800                                                                  09780000
097900     COPY DPPD004.                                                09790000
098000     CALL 'ILBOABN0' USING ABEND-CODE.                            09800000
098100                                                                  09810000
