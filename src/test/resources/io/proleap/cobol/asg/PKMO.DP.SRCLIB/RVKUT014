000100 IDENTIFICATION DIVISION.                                         00010061
000200 PROGRAM-ID.    RVKUT014.                                         00020061
000300 AUTHOR.        ALAN PETERS.                                      00030061
000400 DATE-WRITTEN.  04/04.                                            00040061
000500****************************************************************  00050061
000600*   THIS PROGRAM WILL CREATE A FILE OF ALL RTV'S AGED          *  00060061
000700*   30 DAY'S AND OLDER BASED ON THE CURRENT RUN DATE.          *  00070061
000800*   THIS EXTRACT FILE WILL BE INPUT TO RCKRP018 AGED           *  00080061
000900*   LISTING REPORT.                                            *  00090061
001000****************************************************************  00100061
001100 ENVIRONMENT DIVISION.                                            00110061
001200****************************************************************  00120061
001300 INPUT-OUTPUT SECTION.                                            00130061
001400                                                                  00140061
001500 FILE-CONTROL.                                                    00150061
001600     SELECT RTV-EXTRACT-FILE    ASSIGN TO UT-S-OUT01.             00160061
001700                                                                  00170061
001800****************************************************************  00180061
001900 DATA DIVISION.                                                   00190061
002000****************************************************************  00200061
002100                                                                  00210061
002200 FILE SECTION.                                                    00220061
002300*                                                                 00230061
002400 FD  RTV-EXTRACT-FILE                                             00240061
002500     RECORDING MODE IS F                                          00250061
002600     LABEL RECORDS ARE STANDARD                                   00260061
002700     RECORD CONTAINS 200                                          00270061
002800     BLOCK CONTAINS 0 RECORDS                                     00280061
002900     DATA RECORD IS RTV-EXTRACT-RECORD.                           00290061
003000 01  RTV-EXTRACT-RECORD          PIC X(200).                      00300061
003100*                                                                 00310061
003200/                                                                 00320061
003300****************************************************************  00330061
003400 WORKING-STORAGE SECTION.                                         00340061
003500****************************************************************  00350061
003600                                                                  00360061
003700 01  PV-ABEND-CODE                    PIC S9(04)   VALUE +0       00370061
003800                                                   COMP SYNC.     00380061
003900*                                                                 00390061
004000*                                                                 00400061
004100 01  PS-PROGRAM-SWITCHES.                                         00410061
004200     05  PS-TDFCTOR-CURSOR-SW         PIC X(01)  VALUE 'N'.       00420061
004300         88  PS-EOF-TDFCTOR-CSR                  VALUE 'Y'.       00430061
004400     05  PS-ERROR-SW                  PIC X(01)  VALUE 'N'.       00440061
004500         88  PS-ERROR                            VALUE 'Y'.       00450061
004600                                                                  00460061
004700 01  PV-PROGRAM-VARIABLES.                                        00470061
004800     05  PV-CICS-RESPONSE             PIC S9(09)  VALUE +0        00480061
004900                                                  COMP SYNC.      00490061
005000     05  PV-RETRY-COUNT               PIC S9(04)  VALUE +0        00500061
005100                                                  COMP SYNC.      00510061
005200     05  PV-HOLD-DEPT-NBR             PIC X(03)   VALUE SPACE.    00520061
005300     05  PV-UNITS                     PIC S9(09)  VALUE +0        00530061
005400                                                  COMP.           00540061
005500     05  PV-RTL-AMT                   PIC S9(07)V9(02)            00550061
005600                                                  VALUE ZERO      00560061
005700                                                  COMP-3.         00570061
005800     05  PV-RTL-NULL-IND              PIC S9(04)  VALUE ZEROS     00580061
005900                                                  COMP.           00590061
006000     05  PV-COST-AMT                  PIC S9(07)V9(02)            00600061
006100                                                  VALUE ZERO      00610061
006200                                                  COMP-3.         00620061
006300     05  PV-COST-NULL-IND             PIC S9(04)  VALUE ZEROS     00630061
006400                                                  COMP.           00640061
006500     05  PV-STA-DTE                   PIC X(10)   VALUE SPACES.   00650061
006600     05  PV-NBR-DAYS                  PIC S9(04)  VALUE +0        00660061
006700                                                  COMP.           00670061
006800                                                                  00680061
006900     05  PV-CURRENT-DATE              PIC  X(10).                 00690061
007000     05  PV-CURRENT-DATE-RFMT REDEFINES PV-CURRENT-DATE.          00700061
007100         10 PV-CURRENT-DATE-CC        PIC  X(2).                  00710061
007200         10 PV-CURRENT-DATE-YY        PIC  X(2).                  00720061
007300         10 FILLER                    PIC  X.                     00730061
007400         10 PV-CURRENT-DATE-MM        PIC  X(2).                  00740061
007500         10 FILLER                    PIC  X.                     00750061
007600         10 PV-CURRENT-DATE-DD        PIC  X(2).                  00760061
007700                                                                  00770061
032073     05  PV-CURRENT-TMST              PIC X(26).                  03207300
032080     05  PV-CURRENT-TMST-RFMT REDEFINES PV-CURRENT-TMST.          03208000
032091         10  PV-TMST-CCYY-MM-DD       PIC X(10).                  03209100
032092         10  FILLER                   PIC X(01).                  03209200
032093         10  PV-TMST-HH-MM-SS         PIC 9(08).                  03209300
032094         10  FILLER                   PIC X(01).                  03209400
032095         10  PV-TMST-LAST6            PIC 9(06).                  03209500
032096                                                                  03209661
032097     05  PV-PARAGRAPH-NAME            PIC  X(30)  VALUE SPACES.   03209761
032098     05  PV-ERROR-MESSAGE-1           PIC  X(60)  VALUE SPACES.   03209861
032099     05  PV-ERROR-MESSAGE-2           PIC  X(60)  VALUE SPACES.   03209961
032100     05  PV-SQLCODE                   PIC 9(9)  VALUE ZERO.       03210061
032200                                                                  03220061
032300                                                                  03230061
032400 01  PC-PROGRAM-CONSTANTS.                                        03240061
032500     05  PC-PROGRAM-NAME             PIC X(08)  VALUE 'RVKUT014'. 03250061
032600     05  PC-MAX-RETRIES              PIC S9(04) VALUE +3          03260061
032700                                                COMP SYNC.        03270061
032800     05  PC-DEFAULT-DATE             PIC X(26)   VALUE            03280061
032900                                   '9999-09-09-09.09.09.999999'.  03290061
033000     05  PC-DEFAULT-MESSAGE          PIC  X(50)    VALUE          03300061
033100         'RECEIV-VERFYD-TMST = 9999-09-09-09.09.09.999999 '.      03310061
033200     05  PC-PGM-DPKUT039             PIC X(08)  VALUE 'DPKUT039'. 03320061
033300     05  PC-MBS-OP-CO-03             PIC X(02)  VALUE '03'.       03330061
033400     05  PC-MBS-SYSTEM-CODE-RV       PIC X(02)  VALUE 'RV'.       03340061
033500                                                                  03350061
033600 01  PV-ABEND-FIELDS.                                             03360061
033700     05  PV-ABEND-PROGRAM             PIC X(8)   VALUE 'RVKUT014'.03370061
033800     05  PV-ABEND-PARAGRAPH           PIC X(50)  VALUE SPACES.    03380061
033900     05  PV-ABEND-OPERATION           PIC X(50)  VALUE SPACES.    03390061
034000     05  PV-ABEND-STRUCTURE-1         PIC X(8)   VALUE SPACES.    03400061
034100     05  PV-ABEND-STRUCTURE-2         PIC X(8)   VALUE SPACES.    03410061
034200     05  PV-ABEND-STRUCTURE-3         PIC X(8)   VALUE SPACES.    03420061
034300     05  PV-ABEND-STATUS              PIC XX     VALUE SPACES.    03430061
034400     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    03440061
034500     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    03450061
034600     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    03460061
034700     05  PV-DB2-OPERATION-MESSAGE-4   PIC  X(79) VALUE SPACES.    03470061
034800*                                                                 03480061
034900******************************************************************03490061
035000*  USED FOR EXTRACT OUTPUT FILE                                   03500061
035100******************************************************************03510061
035200     COPY RVWS014.                                                03520061
035300*                                                                 03530061
035400******************************************************************03540061
035500*  USED FOR DB2 ERROR MESSAGE BUILDING                            03550061
035600******************************************************************03560061
035700     COPY DPWS004.                                                03570061
035800*                                                                 03580061
035900******************************************************************03590061
036000*   DB2 SQL COMMUNICATION AREA                                    03600061
036100******************************************************************03610061
036200     EXEC SQL                                                     03620061
036300          INCLUDE SQLCA                                           03630061
036400     END-EXEC.                                                    03640061
036500                                                                  03650061
036600******************************************************************03660061
036700*   DB2 DCLGEN FOR TDFCTOR TABLE                                  03670061
036800******************************************************************03680061
036900     EXEC SQL                                                     03690061
037000          INCLUDE TDFCTOR                                         03700061
037100     END-EXEC.                                                    03710061
037200                                                                  03720061
037300******************************************************************03730061
037400*   DB2 DCLGEN FOR TDFMEIT TABLE                                  03740061
037500******************************************************************03750061
037600     EXEC SQL                                                     03760061
037700          INCLUDE TDFMEIT                                         03770061
037800     END-EXEC.                                                    03780061
037900                                                                  03790061
038000******************************************************************03800061
038100* TDFCTOR CURSOR                                                 *03810061
038200******************************************************************03820061
038300     EXEC SQL                                                     03830061
038400          DECLARE TDFCTOR-CSR CURSOR WITH HOLD FOR                03840061
038500           SELECT DFCTOR.OPER_UNT_ID                              03850061
038600                , DFCTOR.DFCT_ORD_ID                              03860061
038700                , DFCTOR.VEND_NAME                                03870061
038800                , DFMEIT.MDSE_DEPT_NBR                            03880061
038900                , COUNT (*) AS UNITS                              03890061
039000                , SUM(DFMEIT.RTL_COST_AMT)                        03900061
039100                , SUM(DFMEIT.UNIT_COST_AMT)                       03910061
039200                , DFCTOR.STATUS_CHG_DTE + 1 DAY AS STADTE         03920061
039300   , DAYS(CURRENT DATE) - DAYS(DFCTOR.STATUS_CHG_DTE) AS NBRDAYS  03930061
039400           FROM   TDFCTOR DFCTOR                                  03940061
039500                 ,TDFMEIT DFMEIT                                  03950061
039600           WHERE  DFCTOR.DFCT_ORD_ID = DFMEIT.DFCT_ORD_ID         03960061
039700            AND DFCTOR.DFCT_ORD_ID_CDE IN ('R', 'D')              03970061
039800            AND DFCTOR.DFCT_ORD_STAT_CDE IN ('C')                 03980061
039900            AND DFCTOR.STATUS_CHG_DTE < (CURRENT DATE - 31 DAYS)  03990061
040000            AND DFCTOR.ORD_DTE > '2004-02-29'                     04000061
040100           GROUP BY DFCTOR.OPER_UNT_ID                            04010061
040200                  , DFCTOR.DFCT_ORD_ID                            04020061
040300                  , DFMEIT.MDSE_DEPT_NBR                          04030061
040400                  , DFCTOR.VEND_NAME                              04040061
040500                  , DFCTOR.STATUS_CHG_DTE                         04050061
040600     END-EXEC.                                                    04060061
040700                                                                  04070061
040800***********************************************************       04080061
040900*  INCLUDE BOOK USED BY MBS SYSTEM                        *       04090061
041000***********************************************************       04100061
041100     COPY DPWS003.                                                04110061
041200*                                                                 04120061
041300* * * * * * * * * * * * * * * * * * * * * * * * * * * * * *       04130061
041400 PROCEDURE DIVISION.                                              04140061
041500* * * * * * * * * * * * * * * * * * * * * * * * * * * * * *       04150061
041600                                                                  04160061
041700***************************************************************   04170061
041800*  0000-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE PROGRAM    04180061
041900***************************************************************   04190061
042000 0000-PROGRAM-MAINLINE.                                           04200061
042100                                                                  04210061
042200     OPEN OUTPUT RTV-EXTRACT-FILE.                                04220061
042300                                                                  04230061
042400     PERFORM 1100-SET-CURRENT-TMST.                               04240061
042500     MOVE PV-TMST-CCYY-MM-DD  TO PV-CURRENT-DATE.                 04250061
042600                                                                  04260061
042700     PERFORM 7000-OPEN-TDFCTOR-CURSOR.                            04270061
042800                                                                  04280061
042900     PERFORM 7100-FETCH-TDFCTOR-CSR                               04290061
043000         UNTIL PS-EOF-TDFCTOR-CSR.                                04300061
043100                                                                  04310061
043200                                                                  04320061
043300     PERFORM 7200-CLOSE-TDFCTOR-CSR.                              04330061
043400                                                                  04340061
043500     CLOSE RTV-EXTRACT-FILE.                                      04350061
043600                                                                  04360061
043700     GOBACK.                                                      04370061
043800                                                                  04380061
043900                                                                  04390061
056000******************************************************************05600000
056100* PROCESS EXTRACTS                                                05610000
056200******************************************************************05620000
056300 1000-PROCESS-EXTRACTS.                                           05630061
056400                                                                  05640061
056500     INITIALIZE RV014-EXTRACT-RECORD.                             05650061
056600     MOVE DFCTOR-OPER-UNT-ID          TO RV014-OPER-UNT-ID.       05660061
056700     MOVE DFCTOR-DFCT-ORD-ID          TO RV014-DFCT-ORD-ID.       05670061
056800     MOVE PV-HOLD-DEPT-NBR            TO RV014-DEPT-NBR.          05680061
056900     MOVE DFCTOR-VEND-NAME            TO RV014-VENDOR-NAME.       05690061
057000     MOVE DFCTOR-VND-AUTH-ID          TO RV014-VEND-AUTH-ID.      05700061
057100     MOVE PV-UNITS                    TO RV014-UNITS.             05710061
057200     MOVE PV-RTL-AMT                  TO RV014-TOTAL-RETAIL.      05720061
057300     MOVE PV-COST-AMT                 TO RV014-TOTAL-COST.        05730061
057400     MOVE PV-STA-DTE                  TO RV014-FIRST-DATE.        05740061
057500     MOVE PV-NBR-DAYS                 TO RV014-DAYS-OLD.          05750061
057600     PERFORM 6000-GET-BUYER-NAME                                  05760061
057700     MOVE DP003-BYR-NAME              TO RV014-BUYER-LAST-NAME.   05770061
057800     MOVE DP003-DMM-NAME              TO RV014-DMM-LAST-NAME.     05780061
057900     PERFORM 5000-WRITE-EXTRACT-REC.                              05790061
057901                                                                  05790161
057902******************************************************************05790200
057903* SET THE CURRENT TIMESTAMP.                                      05790300
057904******************************************************************05790400
057905 1100-SET-CURRENT-TMST.                                           05790500
057906                                                                  05790600
057907     EXEC SQL                                                     05790700
057908         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 05790800
057909     END-EXEC                                                     05790900
057910                                                                  05791000
057911     EVALUATE TRUE                                                05791100
057912        WHEN SQLCODE = ZERO                                       05791200
057913            CONTINUE                                              05791300
057914                                                                  05791400
057915        WHEN SQLWARN0 NOT = SPACES                                05791511
057916        WHEN SQLCODE  NOT = ZERO                                  05791611
057917            DISPLAY '**************************************'      05791700
057918            DISPLAY '** ABEND                            **'      05791800
057919            DISPLAY '** PROGRAM = RVKUT014               **'      05791900
057920            DISPLAY '** PARAGRAPH = 1100-SET-CURRENT-TMST**'      05792000
057921            DISPLAY '** SET CURRENT TIMESTAMP            **'      05792100
057922            DISPLAY '** SQLCODE = ' SQLCODE                       05792228
058000            DISPLAY '**************************************'      05800000
058100            PERFORM 9900-DB2-ABEND                                05810000
058200     END-EVALUATE.                                                05820000
058201                                                                  05820161
058202******************************************************************05820200
058203* WRITE EXTRACT RECORD TO FILE                                    05820300
058204******************************************************************05820400
058205 5000-WRITE-EXTRACT-REC.                                          05820561
058206      WRITE RTV-EXTRACT-RECORD  FROM RV014-EXTRACT-RECORD.        05820661
058207                                                                  05820761
058208***********************************************************       05820861
058209*  CALL MBS SUBROUTINE TO GET BUYER NAME                          05820961
058210***********************************************************       05821061
058220 6000-GET-BUYER-NAME.                                             05822061
058230     INITIALIZE DP003-MBS-SUBROUTINE-FIELDS.                      05823061
058240     SET DP003-BYR-LOOKUP-NAME       TO TRUE.                     05824061
058250     SET DP003-BYR-NAME-LAST-ONLY    TO TRUE.                     05825061
058260     SET DP003-DMM-LOOKUP-NAME       TO TRUE.                     05826061
058270     SET DP003-DMM-NAME-LAST-ONLY    TO TRUE.                     05827061
058280     MOVE PC-MBS-SYSTEM-CODE-RV      TO DP003-SYSTEM-CODE.        05828061
058290     MOVE PC-MBS-OP-CO-03            TO DP003-OP-CO-NMBR.         05829061
058300     MOVE PV-CURRENT-DATE-YY         TO DP003-CURRENT-DATE-YY     05830061
058400                                        DP003-EFF-DATE-YY.        05840061
058500     MOVE PV-CURRENT-DATE-MM         TO DP003-CURRENT-DATE-MM     05850061
058600                                        DP003-EFF-DATE-MM.        05860061
058700     MOVE PV-CURRENT-DATE-DD         TO DP003-CURRENT-DATE-DD     05870061
058800                                        DP003-EFF-DATE-DD.        05880061
058900     MOVE PV-HOLD-DEPT-NBR           TO DP003-DPT-INPUT.          05890061
059000*                                                                 05900061
059100     CALL PC-PGM-DPKUT039 USING DP003-MBS-SUBROUTINE-FIELDS.      05910061
059200*                                                                 05920061
059300     EVALUATE TRUE                                                05930061
059400         WHEN DP003-SUCCESSFUL                                    05940061
059500             CONTINUE                                             05950061
059600         WHEN DP003-BYR-NAME-NOT-FOUND                            05960061
059700             MOVE 'BUYER NOT FOUND'  TO  DP003-BYR-NAME           05970061
059800         WHEN DP003-DMM-NAME-NOT-FOUND                            05980061
059900             MOVE 'DMM  NOT FOUND'   TO  DP003-DMM-NAME           05990061
060000         WHEN OTHER                                               06000061
060100             DISPLAY '** ABEND **'                                06010061
060200             DISPLAY '** PROGRAM = RVKUT014 **'                   06020061
060300             DISPLAY '** PARAGRAPH = 6000-GET-BUYER-NAME **'      06030061
060400             DISPLAY '** INVALID RETURN CODE FROM DPKUT039 **'    06040061
060500             DISPLAY '** INPUT FIELDS: ' DP003-INPUT-FIELDS       06050061
060600             DISPLAY '**  RETURN DATA: ' DP003-RETURN-DATA        06060061
060700             IF DP003-BYR-NAME-DB2-ERROR                          06070061
060800                 DISPLAY '** SQLCA: ' DP003-SQLCA                 06080061
060900                 DISPLAY '** SQLCODE: ' DP003-SQLCODE             06090061
061000             END-IF                                               06100061
061100             IF DP003-DMM-NAME-DB2-ERROR                          06110061
061200                 DISPLAY '** SQLCA: ' DP003-SQLCA                 06120061
061300                 DISPLAY '** SQLCODE: ' DP003-SQLCODE             06130061
061400             END-IF                                               06140061
061500             MOVE +4008 TO PV-ABEND-CODE                          06150061
061600             CALL 'ILBOABN0' USING PV-ABEND-CODE                  06160061
061700     END-EVALUATE.                                                06170061
061701                                                                  06170161
061702******************************************************************06170200
061703* OPEN THE TDFCTOR CURSOR                                         06170300
061704******************************************************************06170400
061705 7000-OPEN-TDFCTOR-CURSOR.                                        06170561
061706     PERFORM                                                      06170661
061707         WITH TEST AFTER                                          06170761
061708         VARYING PV-RETRY-COUNT                                   06170861
061709         FROM 1 BY 1                                              06170961
061710         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 06171061
061720            OR  (SQLCODE = +0))                                   06172061
061730                                                                  06173061
061740         EXEC SQL                                                 06174061
061750             OPEN TDFCTOR-CSR                                     06175061
061760         END-EXEC                                                 06176061
061770                                                                  06177061
061780         EVALUATE TRUE                                            06178061
061790             WHEN SQLCODE = +0                                    06179061
061800             WHEN SQLCODE = -904                                  06180061
061900             WHEN SQLCODE = -913                                  06190061
062000                  CONTINUE                                        06200061
062100             WHEN SQLWARN0 NOT = SPACE                            06210061
062200             WHEN SQLCODE  NOT = +0                               06220061
062300                  MOVE '7000-OPEN-TDFCTOR-CURSOR'                 06230061
062400                                 TO PV-ABEND-PARAGRAPH            06240061
062500                  MOVE 'OPEN TDFCTOR CURSOR'                      06250061
062600                                 TO PV-ABEND-OPERATION            06260061
062700                  MOVE 'TDFCTOR'   TO PV-ABEND-STRUCTURE-1        06270061
062800                  MOVE SPACES      TO PV-ABEND-STRUCTURE-2        06280061
062900                  PERFORM 9900-DB2-ABEND                          06290061
063000         END-EVALUATE                                             06300061
063100     END-PERFORM.                                                 06310061
063200                                                                  06320061
063300     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          06330061
063400         MOVE '7000-OPEN-TDFCTOR-CURSOR'                          06340061
063500                                 TO PV-ABEND-PARAGRAPH            06350061
063600         MOVE 'MAX RETRIES EXCEEDED'                              06360061
063700                                 TO PV-ABEND-OPERATION            06370061
063800         PERFORM 9900-DB2-ABEND                                   06380061
063900     END-IF.                                                      06390061
063901                                                                  06390161
063902******************************************************************06390200
063903* FETCH THE TDFCTOR CURSOR                                        06390300
063904******************************************************************06390400
063905 7100-FETCH-TDFCTOR-CSR.                                          06390561
063906                                                                  06390661
063907     EXEC SQL                                                     06390761
063908          FETCH TDFCTOR-CSR                                       06390861
063909           INTO   :DFCTOR-OPER-UNT-ID                             06390961
063910                 ,:DFCTOR-DFCT-ORD-ID                             06391061
063920                 ,:DFCTOR-VEND-NAME                               06392061
063930                 ,:PV-HOLD-DEPT-NBR                               06393061
063940                 ,:PV-UNITS                                       06394061
063950                 ,:PV-RTL-AMT                                     06395061
063960                      :PV-RTL-NULL-IND                            06396061
063970                 ,:PV-COST-AMT                                    06397061
063980                      :PV-COST-NULL-IND                           06398061
063990                 ,:PV-STA-DTE                                     06399061
064000                 ,:PV-NBR-DAYS                                    06400061
064100     END-EXEC.                                                    06410061
064200                                                                  06420061
064300     EVALUATE TRUE                                                06430061
064400         WHEN SQLCODE = +0                                        06440061
064500              PERFORM 1000-PROCESS-EXTRACTS                       06450061
064600         WHEN SQLCODE = +100                                      06460061
064700              SET PS-EOF-TDFCTOR-CSR TO TRUE                      06470061
064800         WHEN SQLWARN0 NOT = SPACE                                06480061
064900         WHEN SQLCODE  NOT = +0                                   06490061
065000              MOVE '7100-FETCH-TDFCTOR-CSR'                       06500061
065100                                   TO PV-ABEND-PARAGRAPH          06510061
065200              MOVE 'FETCH TDFCTOR CURSOR'                         06520061
065300                                   TO PV-ABEND-OPERATION          06530061
065400              MOVE 'TDFCTOR'       TO PV-ABEND-STRUCTURE-1        06540061
065500              MOVE SPACES          TO PV-ABEND-STRUCTURE-2        06550061
065600              PERFORM 9900-DB2-ABEND                              06560061
065700     END-EVALUATE.                                                06570061
065701                                                                  06570161
065702******************************************************************06570200
065703* CLOSE THE TDFCTOR CURSOR                                        06570300
065704******************************************************************06570400
065705 7200-CLOSE-TDFCTOR-CSR.                                          06570561
065706                                                                  06570661
065707     PERFORM                                                      06570761
065708         WITH TEST AFTER                                          06570861
065709         VARYING PV-RETRY-COUNT                                   06570961
065710         FROM 1 BY 1                                              06571061
065720         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 06572061
065730            OR  (SQLCODE = +0))                                   06573061
065740                                                                  06574061
065750            EXEC SQL                                              06575061
065760                CLOSE TDFCTOR-CSR                                 06576061
065770            END-EXEC                                              06577061
065780                                                                  06578061
065790            EVALUATE TRUE                                         06579061
065800                WHEN SQLCODE = 0                                  06580061
065900                    CONTINUE                                      06590061
066000                WHEN SQLCODE = -911                               06600061
066100                WHEN SQLCODE = -904                               06610061
066200                    CONTINUE                                      06620061
066300                WHEN SQLCODE  NOT = +0                            06630061
066400                     MOVE '7200-CLOSE-TDFCTOR-CSR'                06640061
066500                                  TO PV-ABEND-PARAGRAPH           06650061
066600                     MOVE 'CLOSE TDFCTOR CURSOR'                  06660061
066700                                  TO PV-ABEND-OPERATION           06670061
066800                     MOVE 'TDFCTOR'   TO PV-ABEND-STRUCTURE-1     06680061
066900                     MOVE SPACES      TO PV-ABEND-STRUCTURE-2     06690061
067000                     PERFORM 9900-DB2-ABEND                       06700061
067100            END-EVALUATE                                          06710061
067200                                                                  06720061
067300     END-PERFORM.                                                 06730061
067400                                                                  06740061
067500     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          06750061
067600         MOVE '7200-CLOSE-TDFCTOR-CSR'                            06760061
067700                                 TO PV-ABEND-PARAGRAPH            06770061
067800         MOVE 'MAX RETRIES EXCEEDED'                              06780061
067900                                 TO PV-ABEND-OPERATION            06790061
068000         PERFORM 9900-DB2-ABEND                                   06800061
068100     END-IF.                                                      06810061
068200                                                                  06820061
068300                                                                  06830061
068301                                                                  06830161
068302******************************************************************06830200
068303* DB2 ABEND ROUTINE                                               06830300
068304******************************************************************06830400
068305 9900-DB2-ABEND.                                                  06830561
068306                                                                  06830661
068307     MOVE SQLCODE TO PV-SQLCODE.                                  06830761
068308     DISPLAY '*** DB2 ERROR '.                                    06830861
068309     DISPLAY '*** SQLCODE   = ' PV-SQLCODE.                       06830961
068310     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 06831061
068320     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               06832061
068330     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               06833061
068340     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       06834061
068350     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.       06835061
068360     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-3.       06836061
068370     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.             06837061
068380                                                                  06838061
068390     IF PV-ABEND-STRUCTURE-2 > SPACES                             06839061
068400         DISPLAY '*** TABLE 2   = ' PV-ABEND-STRUCTURE-2          06840061
068500     END-IF.                                                      06850061
068600                                                                  06860061
068700                                                                  06870061
068800     COPY DPPD004.                                                06880061
068900                                                                  06890061
069000     IF SQLCODE NOT = -911                                        06900061
069100         EXEC SQL                                                 06910061
069200              ROLLBACK                                            06920061
069300         END-EXEC                                                 06930061
069400     END-IF.                                                      06940061
069500                                                                  06950061
069600     MOVE +4013                  TO PV-ABEND-CODE.                06960061
069700     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         06970061
069800*                                                                 06980061
069900 9200-ABEND.                                                      06990061
070000******************************************************************07000061
070100*  PERFORMS A NON-SQL ABEND FOR THE PROGRAM                       07010061
070200******************************************************************07020061
070300     DISPLAY '***************************'.                       07030061
070400     DISPLAY '**       ABEND           **'.                       07040061
070500     DISPLAY '**  IN PROGRAM RCKUT014  **'.                       07050061
070600     DISPLAY '***************************'.                       07060061
070700     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        07070061
070800     DISPLAY '**   ERROR         ** = ' DP003-RETURN-MSG.         07080061
070900     DISPLAY '**                 ** = ' PV-ERROR-MESSAGE-1.       07090061
071000     DISPLAY '**                 ** = ' PV-ERROR-MESSAGE-2.       07100061
071100                                                                  07110061
071200     MOVE +4014                  TO PV-ABEND-CODE.                07120061
071300     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         07130061
071400*                                                                 07140061
