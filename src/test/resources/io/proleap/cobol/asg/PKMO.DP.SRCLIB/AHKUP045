000100 IDENTIFICATION DIVISION.                                         00010020
000200 PROGRAM-ID.         AHKUP045.                                    00020020
000300 AUTHOR.             NANCY EILBES.                                00030020
000400 DATE-WRITTEN.       APRIL 2000.                                  00040020
000500 DATE-COMPILED.                                                   00050020
000600*************************************************************     00060020
000700*    COBOL 2 WITH SQL                                       *     00070020
000800*                                                           *     00080020
000900*   AHKUP045 - ARCHIVE HISTORY DATA DELETION - TPOINST      *     00090020
001000*                                                           *     00100020
001100*   PROGRAM OVERVIEW:                                       *     00110020
001200*                                                           *     00120020
001300*  THIS PROGRAM DELETES "OLD" ROWS FROM DB2 TABLE TPOINST.  *     00130020
001400*  ROWS DELETED ARE THOSE PREVIOUSLY - IDENTIFIED/EXTRACTED *     00140020
001500*  WITHIN THE ARCHIVE/HISTORY SYSTEM.                       *     00150020
001600*                                                           *     00160020
001700*  THE EXTRACT FILE USED AS INPUT WILL BE SORTED BY THE     *     00170020
001800*  UNIQUE INDEX COLUMNS TO SPEED THE DELETION PROCESS.      *     00180020
001900*  THESE COLUMNS ARE PO_NBR, RECIP_CDE, INSTR_NBR.          *     00190020
002000*                                                           *     00200020
002100*   INPUT:                                                  *     00210020
002200*                                                           *     00220020
002300*     1. TPOINST DELETION FILE  COPYBOOK DCLTPOINST         *     00230020
002400*                                                           *     00240020
002500*   DB2 TABLES:                                             *     00250020
002600*                                                           *     00260020
002700*        TPOINST - PURCHASE ORDER PREPACK TABLE             *     00270020
002800*        TCKRSTIN - CHECKPOINT/RESTART INFO TABLE           *     00280020
002900*        TCKRSTCN - CHECKPOINT/RESTART CONTROL TABLE        *     00290020
003000*                                                           *     00300020
003100*************************************************************     00310020
P5207 * DATE: 11/18/2013 CHANGE MADE BY: COGNIZANT(SHEBENA)       *     00320027
P5207 * CHANGE MADE: MODIFIED THE PROGRAM TO REMOVE THE           *     00321027
P5207 *              PO_IN_RMS_IND CHECK BEFORE DELETE.           *     00322027
P5207 * CHANGE TAG - P5207, CR NO - CHG0081355                    *     00323028
003300*************************************************************     00330020
003400 EJECT                                                            00340020
003500 ENVIRONMENT DIVISION.                                            00350020
003600 CONFIGURATION SECTION.                                           00360020
003700 SOURCE-COMPUTER.        IBM-370.                                 00370020
003800 OBJECT-COMPUTER.        IBM-370.                                 00380020
003900                                                                  00390020
004000 INPUT-OUTPUT SECTION.                                            00400020
004100 FILE-CONTROL.                                                    00410020
004200     SELECT TPOINST-EXTRACT-FILE ASSIGN TO INP01.                 00420020
004300                                                                  00430020
004400 DATA DIVISION.                                                   00440020
004500 FILE SECTION.                                                    00450020
004600 FD  TPOINST-EXTRACT-FILE                                         00460020
004700     RECORDING MODE IS F                                          00470020
004800     LABEL RECORDS ARE STANDARD                                   00480020
004900     BLOCK CONTAINS 0 RECORDS                                     00490020
005000     RECORD CONTAINS 44 CHARACTERS                                00500020
005100     DATA RECORD IS TPOINST-EXTRACT-DATA.                         00510020
005200 01  TPOINST-EXTRACT-DATA       PIC X(44).                        00520020
005300                                                                  00530020
005400                                                                  00540020
005500 EJECT                                                            00550020
005600 WORKING-STORAGE SECTION.                                         00560020
005700                                                                  00570020
005800 01  FILLER                       PIC X(58)     VALUE             00580020
005900     '************WORKING STORAGE STARTS HERE*******************'.00590020
006000                                                                  00600020
006100 01  PV-PROGRAM-VARIABLES.                                        00610020
006200     05  PV-PROGRAM-NAME          PIC  X(08)    VALUE 'AHKUP045'. 00620020
006300     05  PV-CKPT-STAT-CODE        PIC X(01)     VALUE SPACE.      00630020
006400     05  PV-CURRENT-PARAGRAPH     PIC X(50)     VALUE SPACES.     00640020
006500     05  PV-CURRENT-TMST          PIC X(26)     VALUE SPACES.     00650020
006600                                                                  00660020
006700     05  PV-TPOINST-INPUT-COUNT   PIC 9(09)     VALUE ZERO        00670020
006800                                                COMP-3.           00680020
006900     05  PV-TPOINST-DELETE-COUNT  PIC 9(09)     VALUE ZERO        00690020
007000                                                COMP-3.           00700020
007100     05  PV-SQL-DELETE-COUNT      PIC 9(09)     VALUE ZERO        00710020
007200                                                COMP-3.           00720020
007300     05  PV-SQLERRD3              PIC S9(09)    VALUE ZERO        00730020
007400                                                COMP-3.           00740020
007500     05  PV-DISP-PO-NBR           PIC X(09)    VALUE SPACES.      00750020
007600     05  PV-DISP-RECIP-CDE        PIC X(09)    VALUE SPACES.      00760020
007700     05  PV-DISP-INSTR-NBR        PIC X(09)    VALUE SPACES.      00770020
007900     05  PV-SAVE-PO-NBR           PIC S9(09) COMP                 00790020
008000                                               VALUE ZEROES.      00800020
008100 01  PC-PROGRAM-CONSTANTS.                                        00810020
008200     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          00820020
008300                                                COMP SYNC.        00830020
008400     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      00840020
008500     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00850020
008600     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00860020
008700                                                                  00870020
008800 01  PS-PROGRAM-SWITCHES.                                         00880020
008900     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.        00890020
009000         88  COMMITS-TAKEN                      VALUE 'T'.        00900020
009100         88  NO-COMMITS-TAKEN                   VALUE 'N'.        00910020
009200     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.        00920020
009300         88  MORE-EXTRACT                       VALUE 'M'.        00930020
009400         88  END-OF-EXTRACT                     VALUE 'E'.        00940020
009500     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        00950020
009600         88  NORMAL-RUN                         VALUE '0'.        00960020
009700         88  RESTART-RUN                        VALUE '9'.        00970020
010100                                                                  01010020
010200 01  WS-COUNTER.                                                  01020020
010300     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.     01030020
010400     05  WS-TMST                  PIC X(26)     VALUE SPACES.     01040020
010500                                                                  01050020
010600 01  CKPT-RESTART-INFO.                                           01060020
010700     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.       01070020
010800                                                                  01080020
010900*----------------------------------------------------------------*01090020
011000*  ABEND DATA AREAS                                              *01100020
011100*----------------------------------------------------------------*01110020
011200 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01120020
011300                                             COMP SYNC.           01130020
011400     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         01140020
011500     88  AC-BAD-DATA                         VALUE +4008.         01150020
011600     88  AC-DB2-ERROR                        VALUE +4013.         01160020
011700     88  AC-DATE-ERROR                       VALUE +4019.         01170020
011800                                                                  01180020
011900                                                                  01190020
012000 01  ABEND-AREAS.                                                 01200020
012100     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01210020
012200             '*****       ABEND'.                                 01220020
012300     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01230020
012400             '*****   PROGRAM: AHKUP045'.                         01240020
012500     05  AA-PARAGRAPH-LIT.                                        01250020
012600         10  FILLER              PIC  X(17)  VALUE                01260020
012700             '***** PARAGRAPH: '.                                 01270020
012800         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01280020
012900     05  AA-MESSAGE-LINE-1.                                       01290020
013000         10  FILLER              PIC  X(06)  VALUE '*****'.       01300020
013100         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01310020
013200     05  AA-MESSAGE-LINE-2.                                       01320020
013300         10  FILLER              PIC  X(06)  VALUE '*****'.       01330020
013400         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01340020
013500     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01350020
013600             '*****    DB2 ERROR'.                                01360020
013700     05  AA-DB2-OPERATION-LIT.                                    01370020
013800         10  FILLER              PIC  X(17)  VALUE                01380020
013900             '***** OPERATION: '.                                 01390020
014000         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01400020
014100     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01410020
014200     EJECT                                                        01420020
014300                                                                  01430020
014400     COPY DPWS004.                                                01440020
014500     EJECT                                                        01450020
014600*----------------------------------------------------------------*01460020
014700*      TPOINST TABLE LAYOUT                                       01470020
014800*----------------------------------------------------------------*01480020
014900         EXEC SQL                                                 01490020
015000             INCLUDE TPOINST                                      01500020
015100         END-EXEC.                                                01510020
015200                                                                  01520020
015300*----------------------------------------------------------------*01530020
015400*      TPURCHS TABLE LAYOUT                                       01540020
015500*----------------------------------------------------------------*01550020
015600         EXEC SQL                                                 01560020
015700             INCLUDE TPURCHS                                      01570020
015800         END-EXEC.                                                01580020
015900                                                                  01590020
016000*----------------------------------------------------------------*01600020
016100*      TCKRSTCNTL TABLE LAYOUT                                    01610020
016200*----------------------------------------------------------------*01620020
016300         EXEC SQL                                                 01630020
016400             INCLUDE TCKRSTCN                                     01640020
016500         END-EXEC.                                                01650020
016600                                                                  01660020
016700*----------------------------------------------------------------*01670020
016800*      TCKRSTINF TABLE LAYOUT                                     01680020
016900*----------------------------------------------------------------*01690020
017000         EXEC SQL                                                 01700020
017100             INCLUDE TCKRSTIN                                     01710020
017200         END-EXEC.                                                01720020
017300 EJECT                                                            01730020
017400*----------------------------------------------------------------*01740020
017500*  DB2 COMMUNICATION AREA                                         01750020
017600*----------------------------------------------------------------*01760020
017700*                                                                 01770020
017800     EXEC SQL                                                     01780020
017900         INCLUDE SQLCA                                            01790020
018000     END-EXEC.                                                    01800020
018100                                                                  01810020
018200*----------------------------------------------------------------*01820020
018300*  DB2 COMMUNICATION AREA2                                        01830020
018400*----------------------------------------------------------------*01840020
018500*                                                                 01850020
018600     COPY SQLCA2.                                                 01860020
018700     EJECT                                                        01870020
018800 PROCEDURE DIVISION.                                              01880020
018900 A100-MAINLINE-ROUTINE.                                           01890020
019000                                                                  01900020
019100     PERFORM B100-INITIALIZATION.                                 01910020
019200                                                                  01920020
019300     PERFORM B200-TPOINST-EXTRACT-PROCESS                         01930020
019400       UNTIL END-OF-EXTRACT.                                      01940020
019500                                                                  01950020
019600     PERFORM B300-EOJ-PROCESSING.                                 01960020
019700                                                                  01970020
019800     GOBACK.                                                      01980020
019900 EJECT                                                            01990020
020000 B100-INITIALIZATION.                                             02000020
020100                                                                  02010020
020200     EXEC SQL                                                     02020020
020300         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 02030020
020400     END-EXEC.                                                    02040020
020500                                                                  02050020
020600     PERFORM X300-GET-CHECKPOINT-CNTL.                            02060020
020700     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    02070020
020800                                                                  02080020
020900     OPEN INPUT TPOINST-EXTRACT-FILE.                             02090020
021000                                                                  02100020
021100     IF RESTART-RUN                                               02110020
021200         PERFORM X200-CHECKPOINT-RESTART                          02120020
021300     ELSE                                                         02130020
021400         PERFORM R100-READ-EXTRACT-FILE                           02140020
021500     END-IF.                                                      02150020
021600                                                                  02160020
021700     PERFORM X500-SET-CHECKPOINT-TIME.                            02170020
021800                                                                  02180020
021900                                                                  02190020
022000     EJECT                                                        02200020
022100 B200-TPOINST-EXTRACT-PROCESS.                                    02210020
022200                                                                  02220020
022300     MOVE POINST-PO-NBR             TO PV-DISP-PO-NBR.            02230020
022400     MOVE POINST-RECIP-CDE          TO PV-DISP-RECIP-CDE.         02240020
022500     MOVE POINST-INSTR-NBR          TO PV-DISP-INSTR-NBR.         02250020
022600     IF POINST-PO-NBR NOT = PV-SAVE-PO-NBR                        02260020
022700         MOVE POINST-PO-NBR TO PV-SAVE-PO-NBR                     02270020
022900     END-IF.                                                      02290020
023000                                                                  02300020
023200     PERFORM D100-DELETE-TPOINST                                  02320026
023400                                                                  02340020
023500     PERFORM X100-CHECKPOINT-CHECK.                               02350020
023600                                                                  02360020
023700     PERFORM R100-READ-EXTRACT-FILE.                              02370020
023800     EJECT                                                        02380020
023900                                                                  02390020
024000                                                                  02400020
024100 B300-EOJ-PROCESSING.                                             02410020
024200                                                                  02420020
024300     DISPLAY '** AHKUP045 SUMMARY **'.                            02430020
024400     DISPLAY '** TPOINST INPUT COUNT = ' PV-TPOINST-INPUT-COUNT.  02440020
024500     DISPLAY '** TPOINST DELETE COUNT = ' PV-TPOINST-DELETE-COUNT.02450020
024600     DISPLAY '** SQL DELETE COUNT = ' PV-SQL-DELETE-COUNT.        02460020
024700                                                                  02470020
024800     CLOSE  TPOINST-EXTRACT-FILE.                                 02480020
024900                                                                  02490020
025000     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02500020
025100     PERFORM X600-UPDATE-TCKRSTCNTL.                              02510020
025200                                                                  02520020
025300     EJECT                                                        02530020
032500*                                                                 03250021
032600*----------------------------------------------------------------*03260020
032700*    DELETES FROM THE TPOINST TABLE.  CASCADE DELETE WILL ALSO   *03270020
032800*    CAUSE ROWS TO BE DELETED FROM TMIITEM, TVNDINV AND TEXINVC  *03280020
032900*    TABLES.                                                     *03290020
033000*----------------------------------------------------------------*03300020
033100 D100-DELETE-TPOINST.                                             03310020
033200                                                                  03320020
033300     MOVE 'D100-DELETE-TPOINST' TO PV-CURRENT-PARAGRAPH.          03330020
033400                                                                  03340020
033500     PERFORM WITH TEST AFTER                                      03350020
033600        VARYING PC-RETRY-COUNT FROM 1 BY 1                        03360020
033700          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                     03370020
033800             OR SQLCODE = ZERO                                    03380020
033900                                                                  03390020
034000         EXEC SQL                                                 03400020
034100              DELETE                                              03410020
034200                FROM TPOINST                                      03420020
034300               WHERE PO_NBR      = :POINST-PO-NBR                 03430020
034400                 AND RECIP_CDE   = :POINST-RECIP-CDE              03440020
034500                 AND INSTR_NBR   = :POINST-INSTR-NBR              03450020
034600         END-EXEC                                                 03460020
034700                                                                  03470020
034800         EVALUATE TRUE                                            03480020
034900             WHEN SQLCODE = ZERO                                  03490020
035000                 ADD 1 TO PV-TPOINST-DELETE-COUNT                 03500020
035100                 MOVE SQLERRD(3) TO PV-SQLERRD3                   03510020
035200                 ADD PV-SQLERRD3 TO PV-SQL-DELETE-COUNT           03520020
035300                                                                  03530020
035400             WHEN SQLCODE = -904                                  03540020
035500             WHEN SQLCODE = -913                                  03550020
035600             WHEN SQLCODE = +100                                  03560020
035700                  CONTINUE                                        03570020
035800                                                                  03580020
035900             WHEN SQLWARN0 NOT = SPACES                           03590020
036000             WHEN SQLCODE  NOT = ZERO                             03600020
036100                 MOVE PV-CURRENT-PARAGRAPH                        03610020
036200                                     TO AA-PARAGRAPH-NAME         03620020
036300                 DISPLAY '******** PO NUMBER:'                    03630020
036400                          PV-DISP-PO-NBR                          03640020
036500                 DISPLAY '******** PO RECIP CDE:'                 03650020
036600                          PV-DISP-RECIP-CDE                       03660020
036700                 DISPLAY '******** PO INSTR NBR:'                 03670020
036800                          PV-DISP-INSTR-NBR                       03680020
036900                 MOVE SPACES TO AA-MESSAGE-1                      03690020
037000                                AA-MESSAGE-2                      03700020
037100                 MOVE 'UNSUCCESSFUL DELETE'                       03710020
037200                                     TO AA-DB2-OPERATION          03720020
037300                 MOVE 'TPOINST'      TO AA-DB2-TABLE              03730020
037400                 PERFORM Z999-DB2-ABEND                           03740020
037500         END-EVALUATE                                             03750020
037600     END-PERFORM.                                                 03760020
037700                                                                  03770020
037800     IF PC-RETRY-COUNT > PC-RETRY-MAX                             03780020
037900         MOVE PV-CURRENT-PARAGRAPH                                03790020
038000                             TO AA-PARAGRAPH-NAME                 03800020
038100         DISPLAY '******** PO NUMBER:'                            03810020
038200                          PV-DISP-PO-NBR                          03820020
038300         DISPLAY '******* PO RECIP CDE:'                          03830020
038400                          PV-DISP-RECIP-CDE                       03840020
038500         DISPLAY '******** PO INSTR NBR:'                         03850020
038600                          PV-DISP-INSTR-NBR                       03860020
038700         MOVE SPACES TO AA-MESSAGE-1                              03870020
038800                        AA-MESSAGE-2                              03880020
038900         MOVE 'MAX RETRIES EXCEEDED ON DELETE'                    03890020
039000                             TO AA-DB2-OPERATION                  03900020
039100         MOVE 'TPOINST'      TO AA-DB2-TABLE                      03910020
039200         PERFORM Z999-DB2-ABEND                                   03920020
039300     END-IF.                                                      03930020
039400                                                                  03940020
039500     EJECT                                                        03950020
039600 R100-READ-EXTRACT-FILE.                                          03960020
039700                                                                  03970020
039800     READ TPOINST-EXTRACT-FILE                                    03980020
039900          INTO DCLTPOINST                                         03990020
040000          AT END SET END-OF-EXTRACT TO TRUE.                      04000020
040100                                                                  04010020
040200     IF MORE-EXTRACT                                              04020020
040300         ADD 1 TO PV-TPOINST-INPUT-COUNT                          04030020
040400     END-IF.                                                      04040020
040500                                                                  04050020
040600                                                                  04060020
040700     EJECT                                                        04070020
040800*----------------------------------------------------------------*04080020
040900*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *04090020
041000*----------------------------------------------------------------*04100020
041100 X100-CHECKPOINT-CHECK.                                           04110020
041200                                                                  04120020
041300     MOVE 'X100-CHECKPOINT-CHECK' TO PV-CURRENT-PARAGRAPH.        04130020
041400                                                                  04140020
041500     EXEC SQL                                                     04150020
041600       SET :WS-TMST = CURRENT TIMESTAMP                           04160020
041700     END-EXEC.                                                    04170020
041800                                                                  04180020
041900     IF SQLCODE = +0                                              04190020
042000         CONTINUE                                                 04200020
042100     ELSE                                                         04210020
042200         MOVE PV-CURRENT-PARAGRAPH                                04220020
042300                             TO AA-PARAGRAPH-NAME                 04230020
042400         MOVE SPACES TO AA-MESSAGE-1                              04240020
042500                        AA-MESSAGE-2                              04250020
042600         MOVE 'BAD SET COMMAND'                                   04260020
042700                             TO AA-DB2-OPERATION                  04270020
042800         MOVE SPACES             TO AA-DB2-TABLE                  04280020
042900         PERFORM Z999-DB2-ABEND                                   04290020
043000     END-IF.                                                      04300020
043100                                                                  04310020
043200     IF WS-TMST > WS-HOLD-TMST                                    04320020
043300         IF NO-COMMITS-TAKEN                                      04330020
043400             MOVE PC-IN-PROCESS-CODE TO PV-CKPT-STAT-CODE         04340020
043500             PERFORM X600-UPDATE-TCKRSTCNTL                       04350020
043600             SET COMMITS-TAKEN TO TRUE                            04360020
043700         END-IF                                                   04370020
043800         PERFORM X700-UPDATE-TCKRSTINF                            04380020
043900         PERFORM Y100-COMMIT                                      04390020
044000         PERFORM X500-SET-CHECKPOINT-TIME                         04400020
044100     END-IF.                                                      04410020
044200                                                                  04420020
044300 EJECT                                                            04430020
044400*----------------------------------------------------------------*04440020
044500*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *04450020
044600*----------------------------------------------------------------*04460020
044700 X200-CHECKPOINT-RESTART.                                         04470020
044800                                                                  04480020
044900     MOVE 'X200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.      04490020
045000                                                                  04500020
045100     PERFORM X400-GET-CHECKPOINT-INFO.                            04510020
045200     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     04520020
045300                                                                  04530020
045400     DISPLAY '** AHKUP045 CHECKPOINT RESTART **'                  04540020
045500     DISPLAY '** EXTRACT RECS BYPASSED ON RESTART = '             04550020
045600              CR-EXTRACT-RECS-WORKED.                             04560020
045700     DISPLAY '***********************************************'    04570020
045800                                                                  04580020
045900     PERFORM R100-READ-EXTRACT-FILE                               04590020
046000         CR-EXTRACT-RECS-WORKED TIMES.                            04600020
046100     PERFORM R100-READ-EXTRACT-FILE.                              04610020
046200 EJECT                                                            04620020
046300*----------------------------------------------------------------*04630020
046400*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *04640020
046500*----------------------------------------------------------------*04650020
046600 X300-GET-CHECKPOINT-CNTL.                                        04660020
046700                                                                  04670020
046800     MOVE 'X300-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     04680020
046900                                                                  04690020
047000     PERFORM WITH TEST AFTER                                      04700020
047100             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04710020
047200             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04720020
047300                     SQLCODE = ZERO                               04730020
047400                                                                  04740020
047500             EXEC SQL                                             04750020
047600              SELECT CKPT_STAT_CODE                               04760020
047700               INTO :PV-CKPT-STAT-CODE                            04770020
047800               FROM TCKRSTCNTL                                    04780020
047900               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04790020
048000             END-EXEC                                             04800020
048100                                                                  04810020
048200             EVALUATE TRUE                                        04820020
048300                 WHEN SQLCODE = ZERO                              04830020
048400                 WHEN SQLCODE = -904                              04840020
048500                 WHEN SQLCODE = -913                              04850020
048600                      CONTINUE                                    04860020
048700                                                                  04870020
048800                 WHEN SQLWARN0 NOT = SPACES                       04880020
048900                 WHEN SQLCODE  NOT = ZERO                         04890020
049000                     MOVE PV-CURRENT-PARAGRAPH                    04900020
049100                                         TO AA-PARAGRAPH-NAME     04910020
049200                     DISPLAY '******** PLAN_NAME:'                04920020
049300                              PV-PROGRAM-NAME                     04930020
049400                     MOVE SPACES TO AA-MESSAGE-1                  04940020
049500                                    AA-MESSAGE-2                  04950020
049600                     MOVE 'UNSUCCESSFUL SELECT'                   04960020
049700                                         TO AA-DB2-OPERATION      04970020
049800                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          04980020
049900                     PERFORM Z999-DB2-ABEND                       04990020
050000             END-EVALUATE                                         05000020
050100     END-PERFORM.                                                 05010020
050200                                                                  05020020
050300     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05030020
050400         MOVE PV-CURRENT-PARAGRAPH                                05040020
050500                             TO AA-PARAGRAPH-NAME                 05050020
050600         DISPLAY '******** PLAN_NAME:'                            05060020
050700                  PV-PROGRAM-NAME                                 05070020
050800         MOVE SPACES TO AA-MESSAGE-1                              05080020
050900                        AA-MESSAGE-2                              05090020
051000         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05100020
051100                             TO AA-DB2-OPERATION                  05110020
051200         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05120020
051300         PERFORM Z999-DB2-ABEND                                   05130020
051400     END-IF.                                                      05140020
051500                                                                  05150020
051600 EJECT                                                            05160020
051700*----------------------------------------------------------------*05170020
051800*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *05180020
051900*----------------------------------------------------------------*05190020
052000 X400-GET-CHECKPOINT-INFO.                                        05200020
052100                                                                  05210020
052200     MOVE 'X400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     05220020
052300                                                                  05230020
052400     PERFORM WITH TEST AFTER                                      05240020
052500             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05250020
052600             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05260020
052700                     SQLCODE = ZERO                               05270020
052800                                                                  05280020
052900             EXEC SQL                                             05290020
053000              SELECT WORK_STRG_DESC                               05300020
053100               INTO :TCKRSTINF-WORK-STRG-DESC                     05310020
053200               FROM TCKRSTINF                                     05320020
053300               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05330020
053400             END-EXEC                                             05340020
053500                                                                  05350020
053600             EVALUATE TRUE                                        05360020
053700                 WHEN SQLCODE = ZERO                              05370020
053800                 WHEN SQLCODE = -904                              05380020
053900                 WHEN SQLCODE = -913                              05390020
054000                      CONTINUE                                    05400020
054100                                                                  05410020
054200                 WHEN SQLWARN0 NOT = SPACES                       05420020
054300                 WHEN SQLCODE  NOT = ZERO                         05430020
054400                     MOVE PV-CURRENT-PARAGRAPH                    05440020
054500                                         TO AA-PARAGRAPH-NAME     05450020
054600                     DISPLAY '******** PLAN_NAME:'                05460020
054700                              PV-PROGRAM-NAME                     05470020
054800                     MOVE SPACES TO AA-MESSAGE-1                  05480020
054900                                    AA-MESSAGE-2                  05490020
055000                     MOVE 'UNSUCCESSFUL SELECT'                   05500020
055100                                         TO AA-DB2-OPERATION      05510020
055200                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          05520020
055300                     PERFORM Z999-DB2-ABEND                       05530020
055400             END-EVALUATE                                         05540020
055500     END-PERFORM.                                                 05550020
055600                                                                  05560020
055700     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05570020
055800         MOVE PV-CURRENT-PARAGRAPH                                05580020
055900                             TO AA-PARAGRAPH-NAME                 05590020
056000         DISPLAY '******** PLAN_NAME:'                            05600020
056100                  PV-PROGRAM-NAME                                 05610020
056200         MOVE SPACES TO AA-MESSAGE-1                              05620020
056300                        AA-MESSAGE-2                              05630020
056400         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05640020
056500                             TO AA-DB2-OPERATION                  05650020
056600         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      05660020
056700         PERFORM Z999-DB2-ABEND                                   05670020
056800     END-IF.                                                      05680020
056900                                                                  05690020
057000 EJECT                                                            05700020
057100*----------------------------------------------------------------*05710020
057200*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *05720020
057300*----------------------------------------------------------------*05730020
057400 X500-SET-CHECKPOINT-TIME.                                        05740020
057500                                                                  05750020
057600     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-CURRENT-PARAGRAPH.     05760020
057700                                                                  05770020
057800     PERFORM WITH TEST AFTER                                      05780020
057900             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05790020
058000             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05800020
058100                     SQLCODE = ZERO                               05810020
058200                                                                  05820020
058300             EXEC SQL                                             05830020
058400              SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)05840020
058500               INTO :WS-HOLD-TMST                                 05850020
058600               FROM TCKRSTCNTL                                    05860020
058700               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05870020
058800             END-EXEC                                             05880020
058900                                                                  05890020
059000             EVALUATE TRUE                                        05900020
059100                 WHEN SQLCODE = ZERO                              05910020
059200                 WHEN SQLCODE = -904                              05920020
059300                 WHEN SQLCODE = -913                              05930020
059400                      CONTINUE                                    05940020
059500                                                                  05950020
059600                 WHEN SQLWARN0 NOT = SPACES                       05960020
059700                 WHEN SQLCODE  NOT = ZERO                         05970020
059800                     MOVE PV-CURRENT-PARAGRAPH                    05980020
059900                                         TO AA-PARAGRAPH-NAME     05990020
060000                     DISPLAY '******** PLAN_NAME:'                06000020
060100                              PV-PROGRAM-NAME                     06010020
060200                     MOVE SPACES TO AA-MESSAGE-1                  06020020
060300                                    AA-MESSAGE-2                  06030020
060400                     MOVE 'UNSUCCESSFUL SELECT'                   06040020
060500                                         TO AA-DB2-OPERATION      06050020
060600                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          06060020
060700                     PERFORM Z999-DB2-ABEND                       06070020
060800             END-EVALUATE                                         06080020
060900     END-PERFORM.                                                 06090020
061000                                                                  06100020
061100     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06110020
061200         MOVE PV-CURRENT-PARAGRAPH                                06120020
061300                             TO AA-PARAGRAPH-NAME                 06130020
061400         DISPLAY '******** PLAN_NAME:'                            06140020
061500                  PV-PROGRAM-NAME                                 06150020
061600         MOVE SPACES TO AA-MESSAGE-1                              06160020
061700                        AA-MESSAGE-2                              06170020
061800         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    06180020
061900                             TO AA-DB2-OPERATION                  06190020
062000         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06200020
062100         PERFORM Z999-DB2-ABEND                                   06210020
062200     END-IF.                                                      06220020
062300                                                                  06230020
062400 EJECT                                                            06240020
062500*----------------------------------------------------------------*06250020
062600*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *06260020
062700*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *06270020
062800*----------------------------------------------------------------*06280020
062900 X600-UPDATE-TCKRSTCNTL.                                          06290020
063000                                                                  06300020
063100     MOVE 'X600-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       06310020
063200                                                                  06320020
063300     PERFORM WITH TEST AFTER                                      06330020
063400             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06340020
063500             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06350020
063600                     SQLCODE = ZERO                               06360020
063700                                                                  06370020
063800             EXEC SQL                                             06380020
063900                 UPDATE TCKRSTCNTL                                06390020
064000                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          06400020
064100                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06410020
064200             END-EXEC                                             06420020
064300                                                                  06430020
064400             EVALUATE TRUE                                        06440020
064500                 WHEN SQLCODE = ZERO                              06450020
064600                 WHEN SQLCODE = -904                              06460020
064700                 WHEN SQLCODE = -913                              06470020
064800                      CONTINUE                                    06480020
064900                                                                  06490020
065000                 WHEN SQLWARN0 NOT = SPACES                       06500020
065100                 WHEN SQLCODE  NOT = ZERO                         06510020
065200                     MOVE PV-CURRENT-PARAGRAPH                    06520020
065300                                         TO AA-PARAGRAPH-NAME     06530020
065400                     DISPLAY '******** PLAN_NAME:'                06540020
065500                              PV-PROGRAM-NAME                     06550020
065600                     MOVE SPACES TO AA-MESSAGE-1                  06560020
065700                                    AA-MESSAGE-2                  06570020
065800                     MOVE 'UNSUCCESSFUL UPDATE'                   06580020
065900                                         TO AA-DB2-OPERATION      06590020
066000                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          06600020
066100                     PERFORM Z999-DB2-ABEND                       06610020
066200             END-EVALUATE                                         06620020
066300     END-PERFORM.                                                 06630020
066400                                                                  06640020
066500     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06650020
066600         MOVE PV-CURRENT-PARAGRAPH                                06660020
066700                             TO AA-PARAGRAPH-NAME                 06670020
066800         DISPLAY '******** PLAN_NAME:'                            06680020
066900                  PV-PROGRAM-NAME                                 06690020
067000         MOVE SPACES TO AA-MESSAGE-1                              06700020
067100                        AA-MESSAGE-2                              06710020
067200         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06720020
067300                             TO AA-DB2-OPERATION                  06730020
067400         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06740020
067500         PERFORM Z999-DB2-ABEND                                   06750020
067600     END-IF.                                                      06760020
067700                                                                  06770020
067800     EJECT                                                        06780020
067900*----------------------------------------------------------------*06790020
068000*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *06800020
068100*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *06810020
068200*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *06820020
068300*----------------------------------------------------------------*06830020
068400 X700-UPDATE-TCKRSTINF.                                           06840020
068500                                                                  06850020
068600     MOVE 'X700-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        06860020
068700                                                                  06870020
068800     MOVE PV-TPOINST-INPUT-COUNT TO CR-EXTRACT-RECS-WORKED.       06880020
068900     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   06890020
069000     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    06900020
069100                                                                  06910020
069200     PERFORM WITH TEST AFTER                                      06920020
069300             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06930020
069400             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06940020
069500                     SQLCODE = ZERO                               06950020
069600                                                                  06960020
069700             EXEC SQL                                             06970020
069800                 UPDATE TCKRSTINF                                 06980020
069900                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 06990020
070000                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          07000020
070100             END-EXEC                                             07010020
070200                                                                  07020020
070300             EVALUATE TRUE                                        07030020
070400                 WHEN SQLCODE = ZERO                              07040020
070500                 WHEN SQLCODE = -904                              07050020
070600                 WHEN SQLCODE = -913                              07060020
070700                      CONTINUE                                    07070020
070800                                                                  07080020
070900                 WHEN SQLWARN0 NOT = SPACES                       07090020
071000                 WHEN SQLCODE  NOT = ZERO                         07100020
071100                     MOVE PV-CURRENT-PARAGRAPH                    07110020
071200                                         TO AA-PARAGRAPH-NAME     07120020
071300                     DISPLAY '******** PLAN_NAME:'                07130020
071400                              PV-PROGRAM-NAME                     07140020
071500                     MOVE SPACES TO AA-MESSAGE-1                  07150020
071600                                    AA-MESSAGE-2                  07160020
071700                     MOVE 'UNSUCCESSFUL UPDATE'                   07170020
071800                                         TO AA-DB2-OPERATION      07180020
071900                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          07190020
072000                     PERFORM Z999-DB2-ABEND                       07200020
072100             END-EVALUATE                                         07210020
072200     END-PERFORM.                                                 07220020
072300                                                                  07230020
072400     IF PC-RETRY-COUNT > PC-RETRY-MAX                             07240020
072500         MOVE PV-CURRENT-PARAGRAPH                                07250020
072600                             TO AA-PARAGRAPH-NAME                 07260020
072700         DISPLAY '******** PLAN_NAME:'                            07270020
072800                  PV-PROGRAM-NAME                                 07280020
072900         MOVE SPACES TO AA-MESSAGE-1                              07290020
073000                        AA-MESSAGE-2                              07300020
073100         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    07310020
073200                             TO AA-DB2-OPERATION                  07320020
073300         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      07330020
073400         PERFORM Z999-DB2-ABEND                                   07340020
073500     END-IF.                                                      07350020
073600                                                                  07360020
073700 EJECT                                                            07370020
073800                                                                  07380020
073900*----------------------------------------------------------------*07390020
074000*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *07400020
074100*----------------------------------------------------------------*07410020
074200 Y100-COMMIT.                                                     07420020
074300                                                                  07430020
074400     MOVE 'Y100-COMMIT'    TO PV-CURRENT-PARAGRAPH.               07440020
074500                                                                  07450020
074600     EXEC SQL                                                     07460020
074700         COMMIT                                                   07470020
074800     END-EXEC.                                                    07480020
074900                                                                  07490020
075000     EVALUATE TRUE                                                07500020
075100         WHEN SQLCODE = ZEROS                                     07510020
075200             CONTINUE                                             07520020
075300         WHEN OTHER                                               07530020
075400             MOVE PV-CURRENT-PARAGRAPH                            07540020
075500                                 TO AA-PARAGRAPH-NAME             07550020
075600             MOVE SPACES TO AA-MESSAGE-1                          07560020
075700                            AA-MESSAGE-2                          07570020
075800             MOVE 'UNSUCCESSFUL COMMIT'                           07580020
075900                                 TO AA-DB2-OPERATION              07590020
076000             MOVE SPACES         TO AA-DB2-TABLE                  07600020
076100             PERFORM Z999-DB2-ABEND                               07610020
076200     END-EVALUATE.                                                07620020
076300 EJECT                                                            07630020
076400 Z999-DB2-ABEND.                                                  07640020
076500                                                                  07650020
076600     DISPLAY AA-ABEND-LIT.                                        07660020
076700     DISPLAY AA-DB2-ERROR-LIT.                                    07670020
076800     DISPLAY AA-PROGRAM-LIT.                                      07680020
076900     DISPLAY AA-PARAGRAPH-LIT.                                    07690020
077000     DISPLAY AA-DB2-OPERATION-LIT.                                07700020
077100     DISPLAY AA-DB2-TABLE.                                        07710020
077200     SET AC-DB2-ERROR TO TRUE.                                    07720020
077300                                                                  07730020
077400     COPY DPPD004.                                                07740020
077500                                                                  07750020
077600     CALL 'ILBOABN0' USING ABEND-CODE.                            07760020
