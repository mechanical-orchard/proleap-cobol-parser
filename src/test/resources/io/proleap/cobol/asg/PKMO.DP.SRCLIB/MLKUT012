       IDENTIFICATION DIVISION.                                                 
       PROGRAM-ID.              MLKUT012.                                       
       AUTHOR.                  PERM TEAM.                                      
       INSTALLATION.            KOHLS DEPARTMENT STORES.                        
       DATE-WRITTEN.            11/30/04.                                       
       DATE-COMPILED.                                                           
      ******************************************************************        
      *             ML PERM MARKDOWN PROCESS                           *        
      ******************************************************************        
RONNA * 12-01-2004 -- CREATE AN INTERNAL TABLE FOR OPEN STORES FROM    *        
RONNA *               STR-CSR CURSOR                                            
LEE   * 12-03-2004 -- RESTRUCTURE OF READ-SKU-LOC AND PROCESS-SKU-LOC  *        
LEE   *               PARAGRAPHS.  ADD MORE STATISTICS.                         
RONNA1* 03-01-2005 -- FIX STORE EXCEPTION HANDLING - FOR CONTINUED     *        
RONNA1*               CLEARANCE IT WAS EXPLODING OUT THE STORE ZERO             
RONNA1*               TUPCPLS ROW TO CREATE A PRICE CHANGE FOR ALL OF           
RONNA1*               THE STORES.  CREATED A SEPARATE PARAGRAPH                 
RONNA1*               JUST FOR THE STORE EXCEPTION REPORTING.                   
RONNA2* 03-02-2005 -- WHEN THE QTY IS A NEGATIVE NUMBER, WRITE A RECORD*        
RONNA2*               OUT TO A NEGATIVE QTY FILE.  THIS FILE WILL BE   *        
RONNA2*               USED IN A PROCESS TO IDENTIFY IF THERE ARE ANY   *        
RONNA2*               NEGATIVE ON HANDS FOR A PRICE CHANGE             *        
RONNA3* 03-08-2005 -- CORRECTION TO KEEP TRACK OF STORES WHERE THERE   *        
RONNA3*               IS A STORE SPECIFIC ACTIVE ROW ON TUPCPLS EXTRACT*        
RONNA3*               THIS IS USED WHEN A STORE 000 ROW HAS A PRICE CHG*        
RONNA3*               AND WE DO NOT WANT TO INCLUDE ANY STORES THAT HAVE        
RONNA3*               A STORE SPECIFIC ACTIVE ROW                      *        
L0315 * 03-15-2005 -- FIX ISSUE OF MISSING PRICE CHANGE BACK TO ACTIVE *        
L0315 *               BECAUSE LOCATION ZERO WOULD HAVE NO RETAIL CHANGE*        
L0316 * 03-15-2005 -- INCLUDE PROCESSING DATE WHEN SAVING DATA FOR     *        
L0316 *               CLEARANCE TO ACTIVE.                             *        
27813R* 03-22-2005 -- BATCH NUMBER NEEDS TO BE 888 FOR CONTINUED       *        
27813R*               CLEARANCE AND 999 FOR ALL OTHER.                 *        
R27813* 04-13-2005 -- CORRECT STR-CSR TO INCLUDE FINANCIAL CLOSED      *        
R27813*               DATES OF NULL                                    *        
R0512 * 05-12-2005 -- FIX ISSUE OF MISSING PRICE CHANGE BACK TO ACTIVE *        
R0512 * XXXXXXXX      BECAUSE LOCATION ZERO WOULD HAVE NO RETAIL CHANGE*        
R0512 * XXXXXXXXX     FOR A STATUS CHANGE FROM 25 TO 30                *        
R0512 * XXXXXXXXXX    THERE WAS A CHANGE MADE BEFORE SEE L0315         *        
R0512 * XXXXXXXXXXX   BUT I THINK THIS FIX WAS FOR STATUS 30 TO 20     *        
W29145* 09-23-2005 -- INPUT TUPCPLS FILE IS EXPANDED FOR NEW FIELDS ON *        
W29145*               EXTRACT THAT PERTAIN TO SAS OPTIMIZATION PRICING.*        
W29145*               EXPAND MLRD012 TO CARRY ORIG-CLR-DTE & MKDN-CDE. *        
W30273* 03-13-2006 -- CORRECT MULTIPLE DC ASSIGNMENTS                  *        
W35378* 06-03-2009 -- TAISA KONTAROVICH                                *        
W35378*               BCM TO IBM UNLOAD CONVERSION. THE RECORD LAYOUT  *        
W35378*  OF THE INPUT FILE (COPYBOOK IMRD056) IS CHANGED. IF DATABASE  *        
W35378*  FIELD HAS NULL VALUE, IBM UNLOAD REPLACE NULL WITH SPACES IN  *        
W35378*  THE OUTPUT FILE. ALSO NULL INDICATOR IS PLACED AT THE FRONT   *        
W35378*  OF THE OUTPUT FIELD.                                          *        
PE9928* 01-20-2012 -- COGNIZANT                                                 
PE9928*               CHANGED THE PROGRAM TO PREVENT ABENDING WHEN THERE        
PE9928*               ARE MORE THAN 1 INACTIVE ROW IN TUPCPLS EXTRACT  *        
PE9928*               FILE. SUCH SCENARIO OCCURS WHEN A COST CHANGE IS *        
PE9928*               ON THE DAY BEFORE PRICE CHANGE. THE PRICE CHANGE *        
PE9928*               IS SUCH THAT THE CHANGE WENT FROM STORE LEVEL TO *        
PE9928*               CORPORATE. SUCH RECORDS IN INPUT WILL BE SKIPPED *        
PE9928*               AND WRITTEN TO SYSOUT.                                    
253902* 11-13-2020 -- PERFORMANCE IMPROVEMENT REQUESTED BY DBA                  
253902*               BY REMOVING THE 'DATE' FUNCTION IN THE SQL                
253902*               WITH B.PRCHG_EFF_DTE COLUMN                               
257592* 06-05-2021 -- INTERNAL TABLE SIZE INCREASED FROM 9999 TO 99999          
      ******************************************************************        
                                                                                
       ENVIRONMENT DIVISION.                                                    
       CONFIGURATION SECTION.                                                   
       INPUT-OUTPUT SECTION.                                                    
       FILE-CONTROL.                                                            
                                                                                
           SELECT SKU-LOC-FILE                                                  
               ASSIGN TO INP01.                                                 
                                                                                
           SELECT CC-DATE-FILE                                                  
               ASSIGN TO INP02.                                                 
                                                                                
           SELECT EXCP-FILE                                                     
               ASSIGN TO INP03.                                                 
                                                                                
           SELECT AUTO-COUNT-OUTFILE                                            
               ASSIGN TO OUT01.                                                 
                                                                                
RONNA2     SELECT NEG-AUTO-COUNT-FILE                                           
RONNA2         ASSIGN TO OUT02.                                                 
                                                                                
       DATA DIVISION.                                                           
       FILE SECTION.                                                            
                                                                                
       FD  SKU-LOC-FILE                                                         
           RECORDING MODE IS F                                                  
           LABEL RECORDS ARE STANDARD                                           
W29145     RECORD CONTAINS 122 CHARACTERS                                       
           BLOCK CONTAINS 0 RECORDS.                                            
W29145 01  SKU-LOC-REC                     PIC  X(122).                         
                                                                                
       FD  CC-DATE-FILE                                                         
           RECORDING MODE IS F                                                  
           LABEL RECORDS ARE STANDARD                                           
           RECORD CONTAINS 80 CHARACTERS                                        
           BLOCK CONTAINS 0 RECORDS.                                            
       01  CC-DATE-REC                     PIC  X(80).                          
                                                                                
       FD  EXCP-FILE                                                            
           RECORDING MODE IS F                                                  
           LABEL RECORDS ARE STANDARD                                           
           RECORD CONTAINS 80 CHARACTERS                                        
           BLOCK CONTAINS 0 RECORDS.                                            
       01  EXCP-REC                        PIC  X(80).                          
                                                                                
       FD  AUTO-COUNT-OUTFILE                                                   
           RECORDING MODE IS F                                                  
           LABEL RECORDS ARE OMITTED                                            
           RECORD CONTAINS 150 CHARACTERS                                       
           DATA RECORD IS RCP-SUMMARY-REC.                                      
       01  AUTO-COUNT-OUT-REC              PIC X(150).                          
                                                                                
RONNA2 FD  NEG-AUTO-COUNT-FILE                                                  
RONNA2     RECORDING MODE IS F                                                  
RONNA2     LABEL RECORDS ARE OMITTED                                            
RONNA2     RECORD CONTAINS 150 CHARACTERS                                       
RONNA2     DATA RECORD IS RCP-SUMMARY-REC.                                      
RONNA2 01  NEG-AUTO-COUNT-REC              PIC X(150).                          
                                                                                
       EJECT                                                                    
       WORKING-STORAGE SECTION.                                                 
                                                                                
       01  PC-PROGRAM-CONSTANTS.                                                
LEE        05  PC-CLEARANCE-STATUS         PIC X(02)       VALUE '30'.          
L0315      05  PC-ACTIVE-STATUS            PIC X(02)       VALUE '20'.          
                                                                                
       01  PV-PROGRAM-VARIABLES.                                                
           05  PV-PROGRAM-NAME             PIC X(8)    VALUE 'MLKUT012'.        
           05  PV-PARAGRAPH-NAME           PIC X(25)       VALUE SPACES.        
           05  PV-OPER-ATTEMPTED           PIC X(30)       VALUE SPACES.        
           05  PV-STATUS-CODE              PIC X(02)       VALUE SPACES.        
LEE            88  PV-DELETED-STATUS                       VALUE '00'.          
LEE            88  PV-NEW-STATUS                           VALUE '10'.          
LEE            88  PV-ACTIVE-STATUS                        VALUE '20'.          
LEE            88  PV-REG-CLEARANCE-STATUS                 VALUE '25'.          
LEE            88  PV-CLEARANCE-STATUS                     VALUE '30'.          
LEE            88  PV-PROMO-STATUS                         VALUE '40'.          
LEE            88  PV-DISCONTINUED-STATUS                  VALUE '90'.          
LEE            88  PV-RENUMBERED-STATUS                    VALUE '98'.          
           05  PV-CHANGE-TYPE-CDE          PIC X(03)       VALUE SPACES.        
LEE            88  PV-NO-CHANGE-TYPE                       VALUE SPACES.        
LEE            88  PV-CONTINUOUS-CHANGE-TYPE               VALUE 'CON'.         
LEE            88  PV-CLEARANCE-CHANGE-TYPE                VALUE 'CLR'.         
LEE            88  PV-ACTIVE-CHANGE-TYPE                   VALUE 'ACT'.         
           05  PV-EXCPN-AUTO-CNT-IND       PIC X(01)       VALUE SPACES.        
LEE            88  PV-NO-EXCPN-AUTO-CNT                    VALUE 'N'.           
LEE            88  PV-EXCPN-AUTO-CNT                       VALUE 'Y'.           
RONNA1     05  PV-EXCPN-LOC-NBR            PIC 9(05)       VALUE ZEROES.        
LEE        05  PV-SKU-LOC-READ             PIC 9(11)       VALUE ZEROES         
LEE                            COMP-3.                                          
LEE        05  PV-EVENT-CTG-COUNT          PIC 9(11)       VALUE ZEROES         
LEE                            COMP-3.                                          
LEE        05  PV-GRP-LOOKUP               PIC 9(11)       VALUE ZEROES         
LEE                            COMP-3.                                          
LEE        05  PV-GRP-LOOKUP-FAIL          PIC 9(11)       VALUE ZEROES         
LEE                            COMP-3.                                          
LEE        05  PV-EXCPN-STR-SELECTED       PIC 9(11)       VALUE ZEROES         
LEE                            COMP-3.                                          
LEE        05  PV-STR-SPECIFIC-PC          PIC 9(11)       VALUE ZEROES         
LEE                            COMP-3.                                          
LEE        05  PV-NO-OH-FOUND              PIC 9(11)       VALUE ZEROES         
LEE                            COMP-3.                                          
LEE        05  PV-RECS-SELECTED            PIC 9(11)       VALUE ZEROES         
LEE                            COMP-3.                                          
LEE        05  PV-CON-PROCESSED            PIC 9(11)       VALUE ZEROES         
LEE                            COMP-3.                                          
LEE        05  PV-CLR-PROCESSED            PIC 9(11)       VALUE ZEROES         
LEE                            COMP-3.                                          
LEE        05  PV-ACT-PROCESSED            PIC 9(11)       VALUE ZEROES         
LEE                            COMP-3.                                          
LEE        05  PV-RECS-WRITTEN             PIC 9(11)       VALUE ZEROES         
LEE                            COMP-3.                                          
RONNA2     05  PV-NEG-RECS-WRITTEN         PIC 9(11)       VALUE ZEROES         
RONNA2                         COMP-3.                                          
PE9928     05  PV-DUP-STR-REC-CNT          PIC 9(11)       VALUE ZEROES         
PE9928                         COMP-3.                                          
PE9928     05  PV-HOLD-INTR-UPC-ID         PIC S9(09)      VALUE ZEROES         
PE9928                         COMP.                                            
PE9928     05  PV-DISP-INTR-UPC-ID         PIC 9(10)       VALUE ZEROES.        
           05  PV-LOC-NBR                  PIC S9(04)      VALUE ZEROES         
                               COMP.                                            
LEE        05  PV-OH-AUTO-CNT-IND-ACT      PIC X(01)       VALUE SPACE.         
LEE        05  PV-OH-AUTO-CNT-IND-CLR      PIC X(01)       VALUE SPACE.         
LEE        05  PV-OH-AUTO-CNT-IND-CON      PIC X(01)       VALUE SPACE.         
LEE        05  PV-NEW-UNT-RTL-AMT          PIC S9(7)V9(2)  VALUE ZEROES         
LEE                            COMP-3.                                          
           05  PV-EFF-BEG-TMST.                                                 
               10  PV-EFF-BEG-DTE          PIC X(10)       VALUE SPACES.        
LEE            10  FILLER                  PIC X(16)       VALUE SPACES.        
LY1217     05  PV-EFF-END-TMST.                                                 
LY1217         10  PV-EFF-END-DTE          PIC X(10)       VALUE SPACES.        
LY1217         10  FILLER                  PIC X(16)       VALUE SPACES.        
                                                                                
LEE        05  PV-PROCESS-EFF-DATE         PIC X(10)       VALUE SPACES.        
L0315      05  PV-PREV-PROCESS-DATE        PIC X(10)       VALUE SPACES.        
                                                                                
       01  PS-SWITCHES.                                                         
           05  PS-SKU-LOC-EOF-SW           PIC X           VALUE 'N'.           
               88  PS-SKU-LOC-EOF                          VALUE 'Y'.           
           05  PS-END-OF-AUTO-IND-CSR-SW   PIC X(01)       VALUE 'N'.           
               88  PS-END-OF-AUTO-IND-CSR                  VALUE 'Y'.           
               88  PS-NOT-END-OF-AUTO-IND-CSR              VALUE 'N'.           
           05  PS-END-OF-STR-CSR-SW        PIC X(01)       VALUE 'N'.           
               88  PS-END-OF-STR-CSR                       VALUE 'Y'.           
               88  PS-NOT-END-OF-STR-CSR                   VALUE 'N'.           
           05  PS-END-OF-CONTROL-FILE-SW   PIC X(01)       VALUE 'N'.           
               88  PS-END-OF-CONTROL-FILE                  VALUE 'Y'.           
               88  PS-NOT-END-OF-CONTROL-FILE              VALUE 'N'.           
           05  PS-END-OF-EXCP-FILE-SW      PIC X(01)       VALUE 'N'.           
               88  PS-END-OF-EXCP-FILE                     VALUE 'Y'.           
               88  PS-NOT-END-OF-EXCP-FILE                 VALUE 'N'.           
PE9928     05  PS-DUP-STR-REC-SW           PIC X(01)       VALUE 'N'.           
PE9928         88  PS-DUP-STR-REC                          VALUE 'Y'.           
PE9928         88  PS-NOT-DUP-STR-REC                      VALUE 'N'.           
                                                                                
      ******************************************************************        
      * AC ABEND CODES                                                 *        
      ******************************************************************        
                                                                                
       01  ABEND-CODE                      PIC S9(04)      VALUE ZEROES         
LEE                            COMP.                                            
           88  ABEND-4001-WRITE-ERROR                      VALUE +4001.         
           88  ABEND-4002-READ-ERROR                       VALUE +4002.         
           88  ABEND-4003-CTRL-CARD-ERROR                  VALUE +4003.         
           88  ABEND-4004-TABLE-ERROR                      VALUE +4004.         
           88  ABEND-4005-OPEN-ERROR                       VALUE +4005.         
           88  ABEND-4006-CLOSE-ERROR                      VALUE +4006.         
           88  ABEND-4007-SEQUENCE-ERROR                   VALUE +4007.         
           88  ABEND-4008-DATA-ERROR                       VALUE +4008.         
           88  ABEND-4009-KEY-DATA-ERROR                   VALUE +4009.         
           88  ABEND-4013-DB2-ERROR                        VALUE +4013.         
           88  ABEND-4019-DATE-ROUTINE-ERROR               VALUE +4019.         
           88  ABEND-4444-FORCED-ABEND                     VALUE +4444.         
                                                                                
      *****************************************************************         
      *     AUTO COUNT INDICATOR EXCEPTION TABLE                      *         
      *****************************************************************         
LEE    01  PT-EXCP-TABLE-AREA.                                                  
LEE        05  PT-EXCP-STR-INDX            PIC S9(04)      VALUE ZEROES         
LEE                            COMP.                                            
LEE        05  PT-EXCP-STR-MAX             PIC S9(04)      VALUE +1000          
LEE                            COMP.                                            
LEE        05  PT-EXCP-STR-COUNT           PIC S9(04)      VALUE ZEROES         
LEE                            COMP.                                            
LEE        05  PT-EXCP-TABLE OCCURS 1000 TIMES.                                 
LEE            10  PT-EXCP-LOC-NBR         PIC 9(05)       VALUE ZEROES.        
LEE            10  PT-EXCP-EVNT-CTG-CDE    PIC X(03)       VALUE SPACES.        
LEE            10  PT-EXCP-OH-AUTO-CNT-IND PIC X(01)       VALUE SPACE.         
LEE            10  PT-EXCP-EFF-DTE         PIC X(10)       VALUE SPACES.        
                                                                                
      *****************************************************************         
      *     PRICE CHANGE LOCATION ALREADY BUILT                       *         
      *****************************************************************         
LEE    01  PT-BUILT-STR-AREA.                                                   
LEE        05  PT-BUILT-STR-INDX           PIC S9(04)      VALUE ZEROES         
LEE                            COMP.                                            
257592     05  PT-BUILT-STR-MAX            PIC S9(05)      VALUE +99999         
LEE                            COMP.                                            
LEE        05  PT-BUILT-STR-COUNT          PIC S9(04)      VALUE ZEROES         
LEE                            COMP.                                            
257592     05  PT-BUILT-STR OCCURS 99999 TIMES.                                 
LEE            10  PT-BUILT-STR-NBR        PIC 9(05)       VALUE ZEROES.        
                                                                                
L0315 *****************************************************************         
L0315 *     PRICE CHANGE LOCATION ENDED ON PREVIOUS DAY               *         
L0315 *****************************************************************         
L0315  01  PT-ENDED-STR-AREA.                                                   
L0315      05  PT-ENDED-STR-INDX           PIC S9(04)      VALUE ZEROES         
L0315                          COMP.                                            
257592     05  PT-ENDED-STR-MAX            PIC S9(05)      VALUE +99999         
L0315                          COMP.                                            
L0315      05  PT-ENDED-STR-COUNT          PIC S9(04)      VALUE ZEROES         
L0315                          COMP.                                            
257592     05  PT-ENDED-STR OCCURS 99999 TIMES.                                 
L0315          10  PT-ENDED-STR-NBR        PIC 9(05)       VALUE ZEROES.        
                                                                                
RONNA *****************************************************************         
RONNA *     STORE NUMBER TABLE                                        *         
RONNA *                                                               *         
RONNA *     THIS TABLE IS USED TO STORE ALL OPEN STORES.  IT WILL BE  *         
RONNA *     USED TO DETERMINE PRICE CHANGE INFORMATION FOR STORES     *         
RONNA *     THAT ARE USING THE STORE 000 PRICE (CORPORATE LEVEL)      *         
RONNA *                                                               *         
RONNA *****************************************************************         
LEE    01  PT-OPEN-STR-TABLE-AREA.                                              
LEE        05  PT-OPEN-STR-INDX            PIC S9(05)      VALUE ZEROES         
LEE                            COMP.                                            
LEE        05  PT-OPEN-STR-MAX             PIC S9(05)      VALUE +99999         
LEE                            COMP.                                            
LEE        05  PT-OPEN-STR-COUNT           PIC S9(05)      VALUE ZEROES         
LEE                            COMP.                                            
LEE        05  PT-OPEN-STR-TABLE OCCURS 99999 TIMES.                            
LEE            10  PT-OPEN-STR-TABLE-NBR   PIC 9(05)       VALUE ZEROES.        
                                                                                
      ******************************************************************        
      *    VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004              
      ******************************************************************        
           COPY DPWS004.                                                        
                                                                                
      ******************************************************************        
      *    TABLE INCLUDES                                                       
      ******************************************************************        
           EXEC SQL INCLUDE XMT00001 END-EXEC.                                  
           EXEC SQL INCLUDE XMT00002 END-EXEC.                                  
           EXEC SQL INCLUDE XMT00009 END-EXEC.                                  
           EXEC SQL INCLUDE XMT00010 END-EXEC.                                  
           EXEC SQL INCLUDE TMITGPL  END-EXEC.                                  
           EXEC SQL INCLUDE TSKST    END-EXEC.                                  
           EXEC SQL INCLUDE TSKXREF  END-EXEC.                                  
                                                                                
      ******************************************************************        
      *    SQL COMMUNICATIONS AREA DCLGEN                                       
      ******************************************************************        
           EXEC SQL                                                             
               INCLUDE SQLCA                                                    
           END-EXEC.                                                            
                                                                                
      ******************************************************************        
      *    EXTENSION TO THE SQL COMMUNICATIONS AREA FOR EDITING        *        
      *    SQL CODES FOR DISPLAY                                       *        
      ******************************************************************        
           COPY SQLCA2.                                                         
                                                                                
      ******************************************************************        
      *    AUTO-IND-CSR                                                         
      ******************************************************************        
           EXEC SQL                                                             
                DECLARE AUTO-IND-CSR CURSOR                                     
                FOR SELECT DISTINCT                                             
                      A.EVNT_CTG_CDE                                            
                     ,B.PRCHG_EFF_DTE                                           
                     ,B.OH_AUTO_CNT_IND                                         
                 FROM XMT_PRCHG A                                               
                     ,XMT_STR_GP_PRCHG B                                        
                WHERE A.PRCHG_ID = B.PRCHG_ID                                   
                  AND A.PRCHG_ST_CDE = 'APR'                                    
RONNAM            AND B.PRCHG_EFF_DTE = DATE(:PV-PROCESS-EFF-DATE)              
LEE   *           AND DATE(B.PRCHG_EFF_DTE) = DATE(:PV-PROCESS-EFF-DATE)        
                WITH UR                                                         
           END-EXEC.                                                            
                                                                                
      ******************************************************************        
      *    STR-CSR                                                              
      ******************************************************************        
           EXEC SQL                                                             
                DECLARE STR-CSR CURSOR                                          
                FOR SELECT                                                      
                      DISTINCT L.LOC_NBR                                        
                 FROM XMT_LOC L                                                 
                     ,XMT_DC_LOC_ASGMT D                                        
                WHERE D.LOC_NBR = L.LOC_NBR                                     
RONNA *           AND L.CLO_DTE > DATE(:PV-PROCESS-EFF-DATE)                    
RONNA             AND (L.FINCL_CLO_DTE > DATE(:PV-PROCESS-EFF-DATE)             
R27813             OR  L.FINCL_CLO_DTE IS NULL)                                 
LEE               AND (L.OPN_DTE <= DATE(:PV-PROCESS-EFF-DATE)                  
LEE                    OR DATE(:PV-PROCESS-EFF-DATE) >=                         
                      (SELECT MAX(X.EFF_BEG_DTE)                                
                         FROM XMT_DC_LOC_ASGMT X                                
                        WHERE X.LOC_NBR = D.LOC_NBR                             
W30273                    AND X.EFF_BEG_DTE <= :PV-PROCESS-EFF-DATE))           
                ORDER BY L.LOC_NBR                                              
                WITH UR                                                         
           END-EXEC.                                                            
                                                                                
      ******************************************************************        
      * CC- CONTROL CARD                                                        
      ******************************************************************        
       01  CC-CONTROL-REC.                                                      
LEE        05  CC-COMMENT-IND              PIC X(01)       VALUE SPACES.        
LEE            88  CC-COMMENT-RECORD                       VALUE '*'.           
           05  CC-CONTROL-DATE.                                                 
LEE            10  CC-DATE-CC              PIC X(02)       VALUE SPACES.        
LEE            10  CC-DATE-YY              PIC X(02)       VALUE SPACES.        
LEE            10  CC-DATE-DASH-1          PIC X(01)       VALUE SPACES.        
LEE                88  CC-VALID-DATE-DASH-1                VALUE '-'.           
LEE            10  CC-DATE-MM              PIC X(02)       VALUE SPACES.        
LEE                88  CC-VALID-DATE-MM                    VALUES ARE           
LEE                    '01' THRU '12'.                                          
LEE            10  CC-DATE-DASH-2          PIC X(01)       VALUE SPACES.        
LEE                88  CC-VALID-DATE-DASH-2                VALUE '-'.           
LEE            10  CC-DATE-DD              PIC X(02)       VALUE SPACES.        
LEE                88  CC-VALID-DATE-DD                    VALUES ARE           
LEE                    '01' THRU '31'.                                          
           05  FILLER                      PIC X(69)       VALUE SPACES.        
                                                                                
      ******************************************************************        
      * AUTO COUNT INDICATOR EXCEPTIONS INPUT FILE                              
      ******************************************************************        
       01  AC-EXCP-REC.                                                         
           05 AC-EXCP-LOC-NBR              PIC 9(05).                           
           05 FILLER                       PIC X(01).                           
           05 AC-EXCP-EVNT-CTG-CDE         PIC X(03).                           
           05 FILLER                       PIC X(01).                           
           05 AC-EXCP-OH-AUTO-CNT-IND      PIC X(01).                           
           05 FILLER                       PIC X(01).                           
           05 AC-EXCP-EFF-DTE              PIC X(10).                           
           05 FILLER                       PIC X(58).                           
                                                                                
      ******************************************************************        
      *  COPY MEMBER FOR THE ITEM/LOC UNLOAD FILE                               
      ******************************************************************        
           COPY IMRD056.                                                        
                                                                                
      ******************************************************************        
      *  COPY MEMBER FOR THE AUTO COUNT OUTPUT FILE                             
      ******************************************************************        
           COPY MLRD012.                                                        
                                                                                
           EJECT                                                                
       LINKAGE SECTION.                                                         
           EJECT                                                                
                                                                                
       PROCEDURE DIVISION.                                                      
                                                                                
       0000-MAIN-MODULE.                                                        
      ******************************************************************        
      *  MAIN PROCESSING.                                                       
      ******************************************************************        
                                                                                
           PERFORM 1000-HOUSEKEEPING.                                           
                                                                                
LEE        DISPLAY ' '.                                                         
LEE        DISPLAY '    AUTO COUNT EXCEPTION'.                                  
LEE        DISPLAY ' LOCATION    EVENT COUNT  EFFECTIVE'.                       
LEE        DISPLAY '   NUMBER CATEGORY   IND BEGIN DATE'.                       
LEE        DISPLAY ' -------- -------- ----- ----------'.                       
LEE        PERFORM 2000-READ-LOAD-EXCP                                          
               UNTIL PS-END-OF-EXCP-FILE.                                       
LEE        MOVE PT-EXCP-STR-INDX   TO PT-EXCP-STR-COUNT.                        
LEE        DISPLAY ' '.                                                         
LEE        DISPLAY ' ' PT-EXCP-STR-COUNT ' EXCEPTION STORE LOADED.'.            
                                                                                
LEE        PERFORM 2200-SETUP-AUTO-CNT-INDS.                                    
                                                                                
LEE        PERFORM 2300-READ-SKU-LOC-FILE.                                      
                                                                                
           IF PS-SKU-LOC-EOF                                                    
               DISPLAY '*******************************************'            
               DISPLAY '*** NO SKUS FOUND ON INPUT RECORD       ***'            
               DISPLAY '*******************************************'            
           ELSE                                                                 
               PERFORM 2400-PROCESS-SKU-LOCS                                    
                       UNTIL PS-SKU-LOC-EOF                                     
           END-IF.                                                              
                                                                                
           PERFORM 1900-EOJ.                                                    
                                                                                
           STOP RUN.                                                            
      ******************************************************************        
      *    OPEN FILES & INIT                                                    
      ******************************************************************        
       1000-HOUSEKEEPING.                                                       
                                                                                
           DISPLAY '**********************************'.                        
           DISPLAY '* START OF MLKUT012               '.                        
           DISPLAY '**********************************'.                        
                                                                                
           OPEN INPUT  SKU-LOC-FILE                                             
                       CC-DATE-FILE                                             
                       EXCP-FILE                                                
                OUTPUT AUTO-COUNT-OUTFILE                                       
RONNA2                 NEG-AUTO-COUNT-FILE.                                     
                                                                                
           INITIALIZE IM056-ITEM-SKU-LOC-UNLD-REC.                              
                                                                                
LEE        PERFORM 2100-READ-CC-DATE-FILE.                                      
LEE        PERFORM                                                              
LEE            UNTIL PS-END-OF-CONTROL-FILE                                     
LEE                OR NOT CC-COMMENT-RECORD                                     
LEE            DISPLAY ' ' CC-CONTROL-REC                                       
LEE            PERFORM 2100-READ-CC-DATE-FILE                                   
LEE        END-PERFORM.                                                         
LEE        IF PS-END-OF-CONTROL-FILE                                            
LEE            DISPLAY ' '                                                      
LEE            DISPLAY '*** NO VALID CONTROL CARD TO PROCESS ***'               
LEE            DISPLAY ' '                                                      
LEE            SET ABEND-4003-CTRL-CARD-ERROR TO TRUE                           
LEE            PERFORM 9999-ABEND                                               
LEE        ELSE                                                                 
LEE            DISPLAY ' ' CC-CONTROL-REC                                       
LEE            IF CC-DATE-CC IS NUMERIC                                         
LEE                AND CC-DATE-YY IS NUMERIC                                    
LEE                AND CC-VALID-DATE-MM                                         
LEE                AND CC-VALID-DATE-DD                                         
LEE                AND CC-VALID-DATE-DASH-1                                     
LEE                AND CC-VALID-DATE-DASH-2                                     
LEE                MOVE CC-CONTROL-DATE TO PV-PROCESS-EFF-DATE                  
LEE                DISPLAY 'PV-CONTROL-DATE-F: ' PV-PROCESS-EFF-DATE            
L0315              EXEC SQL                                                     
L0315                  SELECT                                                   
L0315                         DATE(:PV-PROCESS-EFF-DATE) - 1 DAY                
L0315                    INTO                                                   
L0315                         :PV-PREV-PROCESS-DATE                             
L0315                    FROM                                                   
L0315                         SYSIBM.SYSDUMMY1                                  
L0315              END-EXEC                                                     
L0315              DISPLAY 'PREVIOUS DATE: ' PV-PREV-PROCESS-DATE               
LEE            ELSE                                                             
LEE                DISPLAY '   *** INVALID CONTROL CARD ***'                    
LEE                SET ABEND-4003-CTRL-CARD-ERROR TO TRUE                       
LEE                PERFORM 9999-ABEND                                           
LEE            END-IF                                                           
LEE        END-IF.                                                              
LEE                                                                             
LEE        PERFORM 7000-OPEN-STR-CSR.                                           
LEE        PERFORM 7100-FETCH-LOAD-STR-CSR                                      
LEE                UNTIL PS-END-OF-STR-CSR.                                     
LEE        MOVE PT-OPEN-STR-INDX TO PT-OPEN-STR-COUNT.                          
LEE        PERFORM 7400-CLOSE-STR-CSR.                                          
LEE        DISPLAY ' '.                                                         
LEE        DISPLAY ' ' PT-OPEN-STR-COUNT ' OPENED STORE LOADED.'.               
                                                                                
      ******************************************************************        
      *    CLOSE THE FILES.                                                     
      ******************************************************************        
       1900-EOJ.                                                                
                                                                                
           CLOSE SKU-LOC-FILE                                                   
                 CC-DATE-FILE                                                   
                 EXCP-FILE                                                      
                 AUTO-COUNT-OUTFILE                                             
RONNA2           NEG-AUTO-COUNT-FILE.                                           
                                                                                
LEE        DISPLAY ' '.                                                         
           DISPLAY '**********************************'.                        
           DISPLAY '* MLKUT012 PROGRAM STATISTICS:    '.                        
           DISPLAY '**********************************'.                        
LEE        DISPLAY '* TOTAL SKU-LOC READ:     ' PV-SKU-LOC-READ.                
LEE        DISPLAY '    SKU-LOC SELECTED:       ' PV-RECS-SELECTED.             
LEE        DISPLAY '      ACTIVE TYPE:            ' PV-ACT-PROCESSED.           
LEE        DISPLAY '      CLEARANCE TYPE:         ' PV-CLR-PROCESSED.           
LEE        DISPLAY '      CONTINUOUS TYPE:        ' PV-CON-PROCESSED.           
LEE        DISPLAY '    GROUP PRICE LOOKUP:     ' PV-GRP-LOOKUP.                
LEE        DISPLAY '      GRP LOOKUP FAIL:        ' PV-GRP-LOOKUP-FAIL.         
LEE        DISPLAY '    EXCEPTION STR SELECT:   ' PV-EXCPN-STR-SELECTED.        
LEE        DISPLAY '    STORE SPECIFIC PRICE:   ' PV-STR-SPECIFIC-PC.           
LEE        DISPLAY '    RECORDS W/O ON-HAND:    ' PV-NO-OH-FOUND.               
RONNA2     DISPLAY '* TOTAL OUT01 RECORDS:    ' PV-RECS-WRITTEN.                
RONNA2     DISPLAY '* TOTAL OUT02 RECORDS:    ' PV-NEG-RECS-WRITTEN.            
PE9928     DISPLAY 'BAD RECORDS WITH MORE THAN ONE INACTIVE ROW IN'             
PE9928-              ' TUPCPLS:   ' PV-DUP-STR-REC-CNT.                         
           DISPLAY '**********************************'.                        
           DISPLAY '* END OF MLKUT012                 '.                        
           DISPLAY '**********************************'.                        
                                                                                
      ******************************************************************        
      * READ AUTO COUNT INDICATOR EXCEPTIONS INTO AN INTERNAL TABLE             
      ******************************************************************        
LEE    2000-READ-LOAD-EXCP.                                                     
           READ EXCP-FILE                                                       
               INTO AC-EXCP-REC                                                 
               AT END SET PS-END-OF-EXCP-FILE TO TRUE.                          
                                                                                
           IF PS-NOT-END-OF-EXCP-FILE                                           
LEE            ADD +1 TO PT-EXCP-STR-INDX                                       
LEE            IF PT-EXCP-STR-INDX > PT-EXCP-STR-MAX                            
LEE                DISPLAY '*** EXCEPTION STORE TABLE OVERFLOW ***'             
LEE                DISPLAY '    INDEX: ' PT-EXCP-STR-INDX                       
LEE                        ', MAX ENTRIES: ' PT-EXCP-STR-MAX                    
LEE                SET ABEND-4004-TABLE-ERROR  TO TRUE                          
LEE                PERFORM 9999-ABEND                                           
               END-IF                                                           
LEE            MOVE AC-EXCP-LOC-NBR                                             
LEE                TO PT-EXCP-LOC-NBR(PT-EXCP-STR-INDX)                         
LEE            MOVE AC-EXCP-EVNT-CTG-CDE                                        
LEE                TO PT-EXCP-EVNT-CTG-CDE(PT-EXCP-STR-INDX)                    
LEE            MOVE AC-EXCP-OH-AUTO-CNT-IND                                     
LEE                TO PT-EXCP-OH-AUTO-CNT-IND(PT-EXCP-STR-INDX)                 
LEE            MOVE AC-EXCP-EFF-DTE                                             
LEE                TO PT-EXCP-EFF-DTE(PT-EXCP-STR-INDX)                         
LEE            DISPLAY '    ' PT-EXCP-LOC-NBR(PT-EXCP-STR-INDX)                 
LEE                    '      ' PT-EXCP-EVNT-CTG-CDE(PT-EXCP-STR-INDX)          
LEE                    '     ' PT-EXCP-OH-AUTO-CNT-IND(PT-EXCP-STR-INDX)        
LEE                    ' ' PT-EXCP-EFF-DTE(PT-EXCP-STR-INDX)                    
           END-IF.                                                              
                                                                                
      ******************************************************************        
      * READ THE DATE CONTROL CARD                                              
      ******************************************************************        
       2100-READ-CC-DATE-FILE.                                                  
           READ CC-DATE-FILE                                                    
               INTO CC-CONTROL-REC                                              
               AT END                                                           
                   SET PS-END-OF-CONTROL-FILE TO TRUE.                          
                                                                                
      ******************************************************************        
      * SETUP AUTO COUNT INDICATORS BASED ON EVENT CATEGORY CODES               
      ******************************************************************        
       2200-SETUP-AUTO-CNT-INDS.                                                
                                                                                
LEE        DISPLAY ' '.                                                         
           PERFORM 3000-OPEN-AUTO-IND-CSR.                                      
           IF NOT PS-END-OF-AUTO-IND-CSR                                        
              PERFORM 3100-FETCH-AUTO-IND-CSR                                   
                      UNTIL PS-END-OF-AUTO-IND-CSR                              
           END-IF.                                                              
LEE        DISPLAY ' EVENT CATEGORY COUNTS: ' PV-EVENT-CTG-COUNT.               
           PERFORM 3400-CLOSE-AUTO-IND-CSR.                                     
                                                                                
      ******************************************************************        
      * READ THE NEXT RECORD ON THE SKU-LOC-FILE.                               
      ******************************************************************        
       2300-READ-SKU-LOC-FILE.                                                  
                                                                                
           READ SKU-LOC-FILE                                                    
               INTO IM056-ITEM-SKU-LOC-UNLD-REC                                 
               AT END                                                           
                   SET PS-SKU-LOC-EOF         TO TRUE                           
               NOT AT END                                                       
LEE                ADD +1 TO PV-SKU-LOC-READ                                    
LEE        END-READ.                                                            
                                                                                
      ******************************************************************        
      * PROCESS RECORD FROM SKU-LOC-FILE IF EFF DATE AND UNT RETAIL             
      * CHANGE DATE ARE EQUAL TO THE RUNDATE.                                   
      ******************************************************************        
       2400-PROCESS-SKU-LOCS.                                                   
                                                                                
LEE        MOVE IM056-EFF-BEG-TMST    TO PV-EFF-BEG-TMST.                       
LEE        MOVE IM056-EFF-END-TMST    TO PV-EFF-END-TMST.                       
RONNA3     IF IM056-INTR-UPC-ID NOT EQUAL ML012-INTR-UPC-ID                     
RONNA3         MOVE IM056-INTR-UPC-ID TO ML012-INTR-UPC-ID                      
      * INITIALIZE STORE BUILT INTERNAL WORKING STORAGE TABLE                   
RONNA3         MOVE +1                TO PT-BUILT-STR-INDX                      
L0315          PERFORM                                                          
L0315              UNTIL PT-BUILT-STR-NBR(PT-BUILT-STR-INDX) = ZEROES           
L0315                  OR PT-BUILT-STR-INDX > PT-BUILT-STR-MAX                  
L0315              MOVE ZEROES TO PT-BUILT-STR-NBR(PT-BUILT-STR-INDX)           
L0315              ADD +1 TO PT-BUILT-STR-INDX                                  
L0315          END-PERFORM                                                      
RONNA3         MOVE ZEROES            TO PT-BUILT-STR-INDX                      
RONNA3                                   PT-BUILT-STR-COUNT                     
      * INITIALIZE STORE ROW ENDED PRIOR DAY WORKING STORAGE TABLE              
L0315          MOVE +1                TO PT-ENDED-STR-INDX                      
L0315          PERFORM                                                          
L0315              UNTIL PT-ENDED-STR-NBR(PT-ENDED-STR-INDX) = ZEROES           
L0315                  OR PT-ENDED-STR-INDX > PT-ENDED-STR-MAX                  
L0315              MOVE ZEROES TO PT-ENDED-STR-NBR(PT-ENDED-STR-INDX)           
L0315              ADD +1 TO PT-ENDED-STR-INDX                                  
L0315          END-PERFORM                                                      
L0315          MOVE ZEROES            TO PT-ENDED-STR-INDX                      
L0315                                    PT-ENDED-STR-COUNT                     
RONNA3     END-IF.                                                              
LEE                                                                             
LEE        IF (PV-EFF-BEG-DTE = PV-PROCESS-EFF-DATE AND                         
LEE            IM056-UNT-RTL-CHG-DTE = PV-PROCESS-EFF-DATE)                     
L0315             PERFORM 2600-PROCESS-SELECTED                                 
           ELSE                                                                 
RONNA3         IF (PV-EFF-BEG-DTE < PV-PROCESS-EFF-DATE                         
RONNA3                 AND (PV-PROCESS-EFF-DATE <= PV-EFF-END-DTE               
W35378                      OR PV-EFF-END-DTE = LOW-VALUES)                     
W35378*                     OR IM056-END-TMST-NULL-IND = '?')                   
RONNA3                 AND IM056-STR-NBR NOT = ZEROES                           
RONNA3            )                                                             
RONNA3*            THE STORE SPECIFIC RECORDS FROM TUPCPLS NEEDS TO             
RONNA3*            BE ADDED TO THE BUILT TABLE SO THAT IF A STORE               
RONNA3*            ZERO ROW IN TUPCPLS EXTRACT HAS A PRICE CHANGE,              
RONNA3*            THIS STORE SPECIFIC ROW WILL NOT HAVE A PRICE                
RONNA3*            CHANGE RECORD INCLUDED.                                      
RONNA3             ADD +1 TO PT-BUILT-STR-COUNT                                 
RONNA3             IF PT-BUILT-STR-COUNT > PT-BUILT-STR-MAX                     
RONNA3                 DISPLAY '*** BUILT STORE TABLE OVERFLOW ***'             
RONNA3                 DISPLAY '    INDEX: ' PT-BUILT-STR-COUNT                 
RONNA3                     ', MAX ENTRIES: ' PT-BUILT-STR-MAX                   
RONNA3                 SET ABEND-4004-TABLE-ERROR  TO TRUE                      
RONNA3                 PERFORM 9999-ABEND                                       
RONNA3             ELSE                                                         
RONNA3                 MOVE IM056-STR-NBR                                       
RONNA3                     TO PT-BUILT-STR-NBR(PT-BUILT-STR-COUNT)              
RONNA3             END-IF                                                       
L0315          ELSE                                                             
L0315              PERFORM 2500-CLEARANCE-TO-ACTIVE                             
RONNA3         END-IF                                                           
           END-IF.                                                              
                                                                                
           PERFORM 2300-READ-SKU-LOC-FILE.                                      
                                                                                
L0315 ******************************************************************        
L0315 * CHECK FOR CLEARANCE TO ACTIVE                                           
L0315 ******************************************************************        
L0315  2500-CLEARANCE-TO-ACTIVE.                                                
L0315                                                                           
L0315 * STATUS CHANGED FOR LOCATION ZERO ROW WITH SAVED ENDED STORES?           
L0315      IF IM056-SKU-STAT-CHG-DTE = PV-PROCESS-EFF-DATE                      
L0315          AND IM056-UNT-RTL-CHG-DTE < PV-PROCESS-EFF-DATE                  
L0315          AND PV-EFF-BEG-DTE = PV-PROCESS-EFF-DATE                         
L0315          AND IM056-STR-NBR = ZEROES                                       
L0315          AND PT-ENDED-STR-COUNT > ZEROES                                  
L0315          IF IM056-SKU-STAT-CDE = PC-ACTIVE-STATUS                         
L0315              PERFORM                                                      
L0315                  VARYING PT-ENDED-STR-INDX FROM 1 BY 1                    
L0315                  UNTIL PT-ENDED-STR-INDX > PT-ENDED-STR-COUNT             
L0315                  MOVE PV-PROCESS-EFF-DATE  TO PV-EFF-BEG-DTE              
L0315                  MOVE PT-ENDED-STR-NBR(PT-ENDED-STR-INDX)                 
L0315                      TO IM056-STR-NBR                                     
L0315                  PERFORM 2600-PROCESS-SELECTED                            
L0315              END-PERFORM                                                  
L0315          ELSE                                                             
L0315              DISPLAY ' *** STATUS CHANGED TO NON-ACTIVE,'                 
L0315                      ' STATUS CODE: ' IM056-SKU-STAT-CDE                  
L0315              SET ABEND-4008-DATA-ERROR TO TRUE                            
L0315              PERFORM 9999-ABEND                                           
L0315          END-IF                                                           
L0315      ELSE                                                                 
L0315 * SAVE ENDED STORE SPECIFIC ROW?                                          
L0315          IF (IM056-EFF-END-TMST(1:10) = PV-PREV-PROCESS-DATE              
L0316                 OR IM056-EFF-END-TMST(1:10) = PV-PROCESS-EFF-DATE)        
L0315              AND IM056-STR-NBR NOT = ZEROES                               
L0315              ADD +1 TO PT-ENDED-STR-COUNT                                 
L0315              IF PT-ENDED-STR-COUNT > PT-ENDED-STR-MAX                     
L0315                  DISPLAY '*** ENDED STORE TABLE OVERFLOW '                
L0315                  DISPLAY '    INDEX: ' PT-ENDED-STR-COUNT                 
L0315                      ', MAX ENTRIES: ' PT-ENDED-STR-MAX                   
L0315                  SET ABEND-4004-TABLE-ERROR  TO TRUE                      
L0315                  PERFORM 9999-ABEND                                       
L0315              ELSE                                                         
DELETE*                DISPLAY ' *** LOADING STORE '                            
DELETE*                        IM056-STR-NBR                                    
DELETE*                        ' UPC-ID '                                       
DELETE*                        IM056-INTR-UPC-ID                                
DELETE*                        ' BEG/END DATE '                                 
DELETE*                        IM056-EFF-BEG-TMST                               
DELETE*                        '/' IM056-EFF-END-TMST                           
L0315                  MOVE IM056-STR-NBR                                       
L0315                      TO PT-ENDED-STR-NBR(PT-ENDED-STR-COUNT)              
L0315              END-IF                                                       
L0315          END-IF                                                           
L0315      END-IF.                                                              
L0315                                                                           
L0315 ******************************************************************        
L0315 * PROCESS SELECTED RECORD                                                 
L0315 ******************************************************************        
L0315  2600-PROCESS-SELECTED.                                                   
L0315                                                                           
PE9928     MOVE 'N'  TO PS-DUP-STR-REC-SW.                                      
L0315      ADD +1    TO PV-RECS-SELECTED.                                       
L0315                                                                           
L0315      MOVE PV-EFF-BEG-DTE        TO ML012-EFF-BEG-DTE.                     
L0315      MOVE IM056-STR-NBR         TO PV-LOC-NBR                             
L0315                                    ML012-MD-EVENT-LOC.                    
L0315                                                                           
W35378     IF IM056-ORIG-CLR-DTE = LOW-VALUES                                   
W29145         MOVE SPACES                TO ML012-ORIG-CLR-DTE                 
W29145     ELSE                                                                 
W29145         MOVE IM056-ORIG-CLR-DTE    TO ML012-ORIG-CLR-DTE                 
W29145     END-IF.                                                              
W29145                                                                          
W35378     IF IM056-MKDN-CDE = LOW-VALUES                                       
W29145         MOVE SPACES                TO ML012-MKDN-CDE                     
W29145     ELSE                                                                 
W29145         MOVE IM056-MKDN-CDE        TO ML012-MKDN-CDE                     
W29145     END-IF.                                                              
L0315                                                                           
L0315      SET PV-NO-CHANGE-TYPE      TO TRUE.                                  
L0315      IF IM056-SKU-STAT-CDE EQUAL PC-CLEARANCE-STATUS                      
L0315          IF IM056-SKU-STAT-CHG-DTE < IM056-UNT-RTL-CHG-DTE                
L0315              SET PV-CONTINUOUS-CHANGE-TYPE   TO TRUE                      
L0315          ELSE                                                             
L0315              SET PV-CLEARANCE-CHANGE-TYPE    TO TRUE                      
L0315          END-IF                                                           
L0315      ELSE                                                                 
L0315          SET PV-ACTIVE-CHANGE-TYPE       TO TRUE                          
L0315      END-IF.                                                              
DELETE*    DISPLAY ' *** BUILDING'                                              
DELETE*            ' FOR STORE ' IM056-STR-NBR                                  
DELETE*            ' UPC-ID ' IM056-INTR-UPC-ID                                 
DELETE*            ' BEG/END '                                                  
DELETE*            IM056-EFF-BEG-TMST(1:10)                                     
DELETE*            '/' IM056-EFF-END-TMST(1:10)                                 
DELETE*            ' CHANGE ' PV-CHANGE-TYPE-CDE.                               
L0315                                                                           
L0315      EVALUATE TRUE                                                        
L0315          WHEN PV-ACTIVE-CHANGE-TYPE                                       
L0315              IF PV-OH-AUTO-CNT-IND-ACT = 'Y'                              
L0315                  PERFORM 4400-STORE-LOGIC                                 
L0315              ELSE                                                         
L0315                  PERFORM 4000-PROC-EXCP-INT-TABLE                         
L0315              END-IF                                                       
L0315          WHEN PV-CLEARANCE-CHANGE-TYPE                                    
L0315              IF PV-OH-AUTO-CNT-IND-CLR = 'Y'                              
L0315                  PERFORM 4400-STORE-LOGIC                                 
L0315              ELSE                                                         
L0315                  PERFORM 4000-PROC-EXCP-INT-TABLE                         
L0315              END-IF                                                       
L0315          WHEN PV-CONTINUOUS-CHANGE-TYPE                                   
L0315              IF PV-OH-AUTO-CNT-IND-CON = 'Y'                              
L0315                  PERFORM 4400-STORE-LOGIC                                 
L0315              ELSE                                                         
L0315                  PERFORM 4000-PROC-EXCP-INT-TABLE                         
L0315              END-IF                                                       
L0315      END-EVALUATE.                                                        
                                                                                
      ******************************************************************        
      * OPEN THE AUTO IND CURSOR                                                
      ******************************************************************        
       3000-OPEN-AUTO-IND-CSR.                                                  
                                                                                
           EXEC SQL                                                             
               OPEN AUTO-IND-CSR                                                
           END-EXEC.                                                            
                                                                                
           EVALUATE TRUE                                                        
               WHEN SQLCODE = +0                                                
                   CONTINUE                                                     
               WHEN OTHER                                                       
                   MOVE '3000-OPEN-AUTO-IND-CSR        '                        
                                     TO PV-PARAGRAPH-NAME                       
                   MOVE 'OPEN ERROR ON DEPT-CSR      '                          
                                     TO PV-OPER-ATTEMPTED                       
LEE                PERFORM 9990-SQL-ABEND                                       
           END-EVALUATE.                                                        
                                                                                
      ******************************************************************        
      * FETCH THE AUTO IND CURSOR                                               
      ******************************************************************        
       3100-FETCH-AUTO-IND-CSR.                                                 
                                                                                
           EXEC SQL                                                             
               FETCH AUTO-IND-CSR                                               
                INTO :XMT00009-EVNT-CTG-CDE                                     
                    ,:XMT00010-PRCHG-EFF-DTE                                    
                    ,:XMT00010-OH-AUTO-CNT-IND                                  
           END-EXEC.                                                            
                                                                                
           EVALUATE TRUE                                                        
               WHEN SQLCODE = +0                                                
LEE                ADD +1      TO PV-EVENT-CTG-COUNT                            
LEE                                                                             
LEE                DISPLAY ' EVENT CATEGORY "' XMT00009-EVNT-CTG-CDE            
LEE                        '" IS SET TO AUTO COUNT OF "'                        
LEE                        XMT00010-OH-AUTO-CNT-IND                             
LEE                        '"'                                                  
LEE                                                                             
                   EVALUATE TRUE                                                
                       WHEN XMT00009-EVNT-CTG-CDE = 'ACT'                       
                            MOVE XMT00010-OH-AUTO-CNT-IND TO                    
                                        PV-OH-AUTO-CNT-IND-ACT                  
                       WHEN XMT00009-EVNT-CTG-CDE = 'CLR'                       
                            MOVE XMT00010-OH-AUTO-CNT-IND TO                    
                                        PV-OH-AUTO-CNT-IND-CLR                  
                       WHEN XMT00009-EVNT-CTG-CDE = 'CON'                       
                            MOVE XMT00010-OH-AUTO-CNT-IND TO                    
                                        PV-OH-AUTO-CNT-IND-CON                  
                   END-EVALUATE                                                 
               WHEN SQLCODE = +100                                              
                   SET PS-END-OF-AUTO-IND-CSR TO TRUE                           
               WHEN OTHER                                                       
                   MOVE '3100-FETCH-AUTO-IND-CSR       '                        
                                     TO PV-PARAGRAPH-NAME                       
                   MOVE 'FETCH ERROR ON AUTO-IND-CSR '                          
                                     TO PV-OPER-ATTEMPTED                       
LEE                PERFORM 9990-SQL-ABEND                                       
           END-EVALUATE.                                                        
                                                                                
      ******************************************************************        
      * CLOSE THE AUTO IND CURSOR                                               
      ******************************************************************        
       3400-CLOSE-AUTO-IND-CSR.                                                 
                                                                                
           EXEC SQL                                                             
               CLOSE AUTO-IND-CSR                                               
           END-EXEC.                                                            
                                                                                
           EVALUATE TRUE                                                        
               WHEN SQLCODE = +0                                                
                   CONTINUE                                                     
               WHEN OTHER                                                       
                   MOVE '3400-CLOSE-AUTO-IND-CSR      '                         
                                     TO PV-PARAGRAPH-NAME                       
                   MOVE 'CLOSE ERROR ON AUTO IND CSR  '                         
                                     TO PV-OPER-ATTEMPTED                       
LEE                PERFORM 9990-SQL-ABEND                                       
           END-EVALUATE.                                                        
                                                                                
      ******************************************************************        
LEE   *    PROCESS EXCEPTION INTERNAL TABLE                                     
      ******************************************************************        
LEE    4000-PROC-EXCP-INT-TABLE.                                                
                                                                                
           PERFORM 4100-CHECK-EXCP-INT-TABLE.                                   
           IF PV-EXCPN-AUTO-CNT                                                 
               ADD +1   TO PV-EXCPN-STR-SELECTED                                
RONNA1                                                                          
RONNA1         EVALUATE TRUE                                                    
RONNA1             WHEN PV-ACTIVE-CHANGE-TYPE                                   
RONNA1                 ADD +1     TO PV-ACT-PROCESSED                           
27813R                 MOVE '999' TO ML012-BATCH-NBR                            
RONNA1             WHEN PV-CLEARANCE-CHANGE-TYPE                                
RONNA1                 ADD +1     TO PV-CLR-PROCESSED                           
27813R                 MOVE '999' TO ML012-BATCH-NBR                            
RONNA1             WHEN PV-CONTINUOUS-CHANGE-TYPE                               
RONNA1                 ADD +1     TO PV-CON-PROCESSED                           
27813R                 MOVE '888' TO ML012-BATCH-NBR                            
RONNA1         END-EVALUATE                                                     
RONNA1                                                                          
RONNA1         IF PV-LOC-NBR EQUAL ZERO                                         
RONNA1*            THIS IS THE CORPORATE LEVEL RECORD ON TUPCPLS.               
RONNA1*            DID THE STORE IN THE EXCEPTION CONTROL CARD                  
RONNA1*            HAVE A STORE SPECIFIC ROW ON TUPCPLS THAT                    
RONNA1*            WAS ALREADY PROCESSED - OR DOES THE EXCEPTION STORE          
RONNA1*            FALL UNDER THE CORP LEVEL RECORD?                            
RONNA1             PERFORM WITH TEST BEFORE                                     
RONNA1                 VARYING PT-BUILT-STR-INDX FROM +1 BY +1                  
RONNA1                 UNTIL PT-BUILT-STR-INDX > PT-BUILT-STR-COUNT             
RONNA1                     OR PV-EXCPN-LOC-NBR                                  
RONNA1                             = PT-BUILT-STR-NBR(PT-BUILT-STR-INDX)        
RONNA1             END-PERFORM                                                  
RONNA1                                                                          
RONNA1*IF NOT FOUND ON TABLE, HASN'T BEEN PROCESSED SPECIFICALLY SO             
RONNA1*CONTINUE                                                                 
RONNA1             IF PT-BUILT-STR-INDX > PT-BUILT-STR-COUNT                    
RONNA1                 MOVE PV-EXCPN-LOC-NBR                                    
RONNA1                   TO TSKST-LOC-NBR                                       
RONNA1                 PERFORM 4500-FINISH-UP                                   
RONNA1             END-IF                                                       
RONNA1                                                                          
RONNA1         ELSE                                                             
RONNA1*            THE STORE IN THE EXCEPTION CONTROL CARD HAS                  
RONNA1*            A STORE SPECIFIC ROW ON TUPCPLS.                             
RONNA1             ADD +1 TO PT-BUILT-STR-COUNT                                 
RONNA1                       PV-STR-SPECIFIC-PC                                 
RONNA1             IF PT-BUILT-STR-COUNT > PT-BUILT-STR-MAX                     
RONNA1                 DISPLAY '*** BUILT STORE TABLE OVERFLOW ***'             
RONNA1                 DISPLAY '    INDEX: ' PT-BUILT-STR-COUNT                 
RONNA1                     ', MAX ENTRIES: ' PT-BUILT-STR-MAX                   
RONNA1                 SET ABEND-4004-TABLE-ERROR  TO TRUE                      
RONNA1                 PERFORM 9999-ABEND                                       
RONNA1             ELSE                                                         
RONNA1                 MOVE PV-EXCPN-LOC-NBR                                    
RONNA1                     TO PT-BUILT-STR-NBR(PT-BUILT-STR-COUNT)              
RONNA1                 MOVE PV-EXCPN-LOC-NBR TO TSKST-LOC-NBR                   
RONNA1                 PERFORM 4500-FINISH-UP                                   
RONNA1             END-IF                                                       
RONNA1         END-IF                                                           
                                                                                
           END-IF.                                                              
                                                                                
LEE   ******************************************************************        
LEE   *    CHECK EXCEPTION INTERNAL TABLE                                       
LEE   ******************************************************************        
LEE    4100-CHECK-EXCP-INT-TABLE.                                               
LEE                                                                             
LEE        SET PV-NO-EXCPN-AUTO-CNT   TO TRUE.                                  
RONNA1     MOVE ZEROS                 TO PV-EXCPN-LOC-NBR.                      
LEE                                                                             
LEE        PERFORM WITH TEST BEFORE                                             
LEE            VARYING PT-EXCP-STR-INDX FROM +1 BY +1                           
LEE            UNTIL PT-EXCP-STR-INDX > PT-EXCP-STR-COUNT                       
LEE                OR (PV-CHANGE-TYPE-CDE                                       
LEE                        = PT-EXCP-EVNT-CTG-CDE(PT-EXCP-STR-INDX)             
LEE   *    EFFECTIVE DATE CHECK (EITHER ALL 9S OR MATCHING EXCP DATE            
LEE                    AND (PT-EXCP-EFF-DTE(PT-EXCP-STR-INDX)                   
LEE                                = '9999-09-09'                               
LEE                         OR PT-EXCP-EFF-DTE(PT-EXCP-STR-INDX)                
LEE                                = PV-PROCESS-EFF-DATE                        
LEE                        )                                                    
LEE   *    STORE NUMBER CHECK (EITHER ZEROES OR MATCHING EXCP LOCATION          
LEE                    AND (IM056-STR-NBR = ZEROES                              
LEE                         OR IM056-STR-NBR                                    
LEE                                = PT-EXCP-LOC-NBR(PT-EXCP-STR-INDX)          
LEE                        )                                                    
LEE                   )                                                         
LEE        END-PERFORM.                                                         
LEE                                                                             
LEE   *IF FOUND ON THE TABLE MOVE WHAT YOU FOUND                                
LEE        IF PT-EXCP-STR-INDX <= PT-EXCP-STR-COUNT                             
LEE            MOVE PT-EXCP-OH-AUTO-CNT-IND(PT-EXCP-STR-INDX)                   
LEE                TO PV-EXCPN-AUTO-CNT-IND                                     
RONNA1         MOVE PT-EXCP-LOC-NBR(PT-EXCP-STR-INDX)                           
RONNA1             TO PV-EXCPN-LOC-NBR                                          
           END-IF.                                                              
                                                                                
      ******************************************************************        
      *    BLOW TO ALL STORES IF STORE 000                                      
      ******************************************************************        
       4400-STORE-LOGIC.                                                        
                                                                                
LEE        EVALUATE TRUE                                                        
LEE            WHEN PV-ACTIVE-CHANGE-TYPE                                       
LEE                ADD +1          TO PV-ACT-PROCESSED                          
27813R             MOVE '999'      TO ML012-BATCH-NBR                           
LEE            WHEN PV-CLEARANCE-CHANGE-TYPE                                    
LEE                ADD +1          TO PV-CLR-PROCESSED                          
27813R             MOVE '999'      TO ML012-BATCH-NBR                           
LEE            WHEN PV-CONTINUOUS-CHANGE-TYPE                                   
LEE                ADD +1          TO PV-CON-PROCESSED                          
27813R             MOVE '888'      TO ML012-BATCH-NBR                           
LEE        END-EVALUATE.                                                        
                                                                                
LEE        IF PV-LOC-NBR EQUAL ZERO                                             
LEE            PERFORM 7300-PROCESS-OPEN-STR                                    
LEE                VARYING PT-OPEN-STR-INDX FROM 1 BY 1                         
LEE                UNTIL PT-OPEN-STR-INDX > PT-OPEN-STR-COUNT                   
LEE        ELSE                                                                 
LEE            ADD +1 TO PT-BUILT-STR-COUNT                                     
LEE                      PV-STR-SPECIFIC-PC                                     
LEE            IF PT-BUILT-STR-COUNT > PT-BUILT-STR-MAX                         
LEE                DISPLAY '*** BUILT STORE TABLE OVERFLOW ***'                 
LEE                DISPLAY '    INDEX: ' PT-BUILT-STR-COUNT                     
LEE                        ', MAX ENTRIES: ' PT-BUILT-STR-MAX                   
LEE                SET ABEND-4004-TABLE-ERROR  TO TRUE                          
LEE                PERFORM 9999-ABEND                                           
LEE            ELSE                                                             
L0315 * CHECK STORE BUILT TABLE?                                                
L0315              PERFORM                                                      
L0315                  VARYING PT-BUILT-STR-INDX FROM 1 BY 1                    
L0315                  UNTIL PT-BUILT-STR-INDX > PT-BUILT-STR-COUNT             
L0315                      OR PV-LOC-NBR                                        
L0315                              = PT-BUILT-STR-NBR(PT-BUILT-STR-INDX)        
L0315                  CONTINUE                                                 
L0315              END-PERFORM                                                  
L0315 * DUPLICATE, STORE ALREADY BUILT?                                         
L0315              IF PT-BUILT-STR-INDX < PT-BUILT-STR-COUNT                    
PE9928*                DISPLAY ' *** LOCATION ALREADY PROCESSED: '              
PE9928*                        PV-LOC-NBR                                       
PE9928                IF IM056-INTR-UPC-ID NOT EQUAL PV-HOLD-INTR-UPC-ID        
PE9928                 MOVE IM056-INTR-UPC-ID TO PV-DISP-INTR-UPC-ID            
PE9928                 DISPLAY 'MORE THAN ONE INACTIVE ROW FOR UPC '            
PE9928                         PV-DISP-INTR-UPC-ID                              
PE9928                END-IF                                                    
PE9928                 ADD +1 TO PV-DUP-STR-REC-CNT                             
PE9928                 SET PS-DUP-STR-REC TO TRUE                               
PE9928                MOVE IM056-INTR-UPC-ID TO PV-HOLD-INTR-UPC-ID             
PE9928*                SET ABEND-4008-DATA-ERROR TO TRUE                        
PE9928*                PERFORM 9999-ABEND                                       
L0315              END-IF                                                       
LEE                   MOVE PV-LOC-NBR                                           
LEE                        TO PT-BUILT-STR-NBR(PT-BUILT-STR-COUNT)              
PE9928             IF PS-DUP-STR-REC-SW = 'N'                                   
RONNA1                MOVE PV-LOC-NBR TO TSKST-LOC-NBR                          
                      PERFORM 4500-FINISH-UP                                    
PE9928             END-IF                                                       
               END-IF                                                           
           END-IF.                                                              
                                                                                
      ******************************************************************        
      *    FINISH UP                                                            
      ******************************************************************        
       4500-FINISH-UP.                                                          
                                                                                
           PERFORM 5000-LOOK-UP-OH.                                             
                                                                                
RONNA5*    IF ML012-ON-HAND-QTY > 0                                             
RONNA5     IF TSKST-ONHAND-QTY  > 0                                             
               PERFORM 5500-CALC-NEW-PRICE                                      
               PERFORM 6000-WRITE-OUTPUT-REC                                    
RONNA5*    ELSE IF ML012-ON-HAND-QTY < 0                                        
RONNA5     ELSE IF TSKST-ONHAND-QTY  < 0                                        
RONNA2         PERFORM 5500-CALC-NEW-PRICE                                      
RONNA2         PERFORM 6100-WRITE-OUT02-REC                                     
           END-IF.                                                              
                                                                                
      ******************************************************************        
      *    LOOK UP ONHAND QTY                                                   
      ******************************************************************        
       5000-LOOK-UP-OH.                                                         
                                                                                
DELETE*    DISPLAY ' *** CHECKING ON-HAND'                                      
DELETE*            ' FOR STORE ' IM056-STR-NBR                                  
DELETE*            ' UPC-ID ' IM056-INTR-UPC-ID.                                
           MOVE ZEROS                   TO TSKST-ONHAND-QTY.                    
                                                                                
           EXEC SQL                                                             
               SELECT B.ONHAND_QTY                                              
                 INTO :TSKST-ONHAND-QTY                                         
                 FROM TSKXREF A                                                 
                     ,TSKST B                                                   
                WHERE A.ITM_NBR     = B.ITEM_NMBR                               
                  AND A.INTR_UPC_ID = :IM056-INTR-UPC-ID                        
                  AND A.SKU_STAT_CDE NOT IN ('98', '00')                        
RONNA2            AND B.ONHAND_QTY  <> 0                                        
RONNA1            AND B.LOC_NBR     = :TSKST-LOC-NBR                            
                WITH UR                                                         
           END-EXEC.                                                            
                                                                                
           EVALUATE TRUE                                                        
               WHEN SQLCODE = 0                                                 
                   MOVE TSKST-ONHAND-QTY TO ML012-ON-HAND-QTY                   
RONNA1             MOVE TSKST-LOC-NBR    TO ML012-LOC-NBR                       
               WHEN SQLCODE = +100                                              
                   MOVE 0                TO ML012-ON-HAND-QTY                   
RONNA1             MOVE TSKST-LOC-NBR    TO ML012-LOC-NBR                       
LEE                ADD +1                TO PV-NO-OH-FOUND                      
               WHEN OTHER                                                       
                   MOVE '5000-LOOK-UP-OH'     TO PV-PARAGRAPH-NAME              
                   MOVE 'ERROR ON SELECT '    TO PV-OPER-ATTEMPTED              
LEE                PERFORM 9990-SQL-ABEND                                       
           END-EVALUATE.                                                        
                                                                                
      ******************************************************************        
      *    CALCULATE NEW PRICE                                                  
      ******************************************************************        
       5500-CALC-NEW-PRICE.                                                     
                                                                                
           IF IM056-MEITGP-NBR = 0                                              
               MOVE IM056-UNT-RTL-AMT TO ML012-NEW-UNT-RTL-AMT                  
           ELSE                                                                 
               PERFORM 5600-SELECT-QTY-AMT                                      
           END-IF.                                                              
                                                                                
      ******************************************************************        
      *    SELECT QTY AND AMT                                                   
      ******************************************************************        
       5600-SELECT-QTY-AMT.                                                     
LEE                                                                             
LEE        ADD +1    TO PV-GRP-LOOKUP.                                          
LEE                                                                             
           EXEC SQL                                                             
               SELECT MITGPL_QTY                                                
                     ,GP_AMT                                                    
                 INTO :MITGPL-MITGPL-QTY                                        
                     ,:MITGPL-GP-AMT                                            
                 FROM TMITGPL                                                   
                WHERE MEITGP_NBR = :IM056-MEITGP-NBR                            
                WITH UR                                                         
           END-EXEC.                                                            
                                                                                
           EVALUATE TRUE                                                        
               WHEN SQLCODE = 0                                                 
                   IF MITGPL-MITGPL-QTY NOT EQUAL 0                             
                       COMPUTE PV-NEW-UNT-RTL-AMT ROUNDED                       
                       = MITGPL-GP-AMT / MITGPL-MITGPL-QTY                      
                       MOVE PV-NEW-UNT-RTL-AMT                                  
                              TO ML012-NEW-UNT-RTL-AMT                          
                   ELSE                                                         
LEE                    ADD +1 TO PV-GRP-LOOKUP-FAIL                             
                       MOVE 0 TO ML012-NEW-UNT-RTL-AMT                          
                   END-IF                                                       
               WHEN SQLCODE = +100                                              
LEE                ADD +1 TO PV-GRP-LOOKUP-FAIL                                 
                   MOVE 0    TO ML012-NEW-UNT-RTL-AMT                           
               WHEN OTHER                                                       
                   MOVE '5600-SELECT-QTY-AMT' TO PV-PARAGRAPH-NAME              
                   MOVE 'ERROR ON SELECT '    TO PV-OPER-ATTEMPTED              
LEE                PERFORM 9990-SQL-ABEND                                       
           END-EVALUATE.                                                        
                                                                                
                                                                                
      ******************************************************************        
      *    WRITE OUTPUT RECORD                                                  
      ******************************************************************        
       6000-WRITE-OUTPUT-REC.                                                   
                                                                                
LEE        SET ML012-AUTO-COUNT    TO TRUE.                                     
                                                                                
           WRITE AUTO-COUNT-OUT-REC FROM ML012-AUTO-COUNT-RECORD.               
LEE        ADD +1 TO PV-RECS-WRITTEN.                                           
                                                                                
RONNA2******************************************************************        
RONNA2*    WRITE OUTPUT RECORD                                                  
RONNA2******************************************************************        
RONNA2 6100-WRITE-OUT02-REC.                                                    
RONNA2                                                                          
RONNA2     SET ML012-AUTO-COUNT    TO TRUE.                                     
RONNA2                                                                          
RONNA2     WRITE NEG-AUTO-COUNT-REC FROM ML012-AUTO-COUNT-RECORD.               
RONNA2     ADD +1 TO PV-NEG-RECS-WRITTEN.                                       
RONNA2                                                                          
      ******************************************************************        
      * OPEN THE STR CURSOR                                                     
      ******************************************************************        
       7000-OPEN-STR-CSR.                                                       
                                                                                
LEE        SET PS-NOT-END-OF-STR-CSR TO TRUE.                                   
LEE        MOVE ZEROES               TO PT-OPEN-STR-INDX.                       
                                                                                
           EXEC SQL                                                             
               OPEN STR-CSR                                                     
           END-EXEC.                                                            
                                                                                
           EVALUATE TRUE                                                        
               WHEN SQLCODE = +0                                                
LEE   *            DISPLAY ' LOCATION '                                         
                   CONTINUE                                                     
               WHEN OTHER                                                       
                   MOVE '7000-OPEN-STR-CSR        '                             
                                     TO PV-PARAGRAPH-NAME                       
                   MOVE 'OPEN ERROR ON STR-CSR      '                           
                                     TO PV-OPER-ATTEMPTED                       
LEE                PERFORM 9990-SQL-ABEND                                       
           END-EVALUATE.                                                        
                                                                                
      ******************************************************************        
      * FETCH THE STR CURSOR                                                    
      ******************************************************************        
LEE    7100-FETCH-LOAD-STR-CSR.                                                 
                                                                                
           EXEC SQL                                                             
               FETCH STR-CSR                                                    
                 INTO :XMT00001-LOC-NBR                                         
           END-EXEC.                                                            
                                                                                
           EVALUATE TRUE                                                        
               WHEN SQLCODE = +0                                                
                   ADD +1                TO PT-OPEN-STR-INDX                    
LEE                IF PT-OPEN-STR-INDX > PT-OPEN-STR-MAX                        
LEE                    DISPLAY '*** OPEN STORE TABLE OVERFLOW ***'              
LEE                    DISPLAY '    INDEX: ' PT-OPEN-STR-INDX                   
LEE                            ', MAX ENTRIES: ' PT-OPEN-STR-MAX                
LEE                    SET ABEND-4004-TABLE-ERROR  TO TRUE                      
LEE                    PERFORM 9999-ABEND                                       
LEE                END-IF                                                       
LEE                MOVE XMT00001-LOC-NBR                                        
LEE                    TO PT-OPEN-STR-TABLE-NBR(PT-OPEN-STR-INDX)               
LEE   *            DISPLAY '    '                                               
LEE   *                    PT-OPEN-STR-TABLE-NBR(PT-OPEN-STR-INDX)              
               WHEN SQLCODE = +100                                              
                   SET PS-END-OF-STR-CSR TO TRUE                                
               WHEN OTHER                                                       
LEE                MOVE '7100-FETCH-LOAD-STR-CSR       '                        
                                     TO PV-PARAGRAPH-NAME                       
                   MOVE 'FETCH ERROR ON AUTO-IND-CSR '                          
                                     TO PV-OPER-ATTEMPTED                       
LEE                PERFORM 9990-SQL-ABEND                                       
           END-EVALUATE.                                                        
                                                                                
      ******************************************************************        
      * LOOK THROUGH STORE TABLE TO SEE IF WE'VE ALREADY                        
      * PROCESSED THIS LOCATION FOR THE UPC WE'RE ON -                          
      * SINCE THE SORT BEFORE THIS PROGRAM SORTS IN DESCENDING                  
      * STORE ORDER, STORE 0 IS AT THE BOTTOM - ALL OF THE SPECIFIC             
      * STORES WILL BE ON THIS INTERNAL TABLE SO WE'LL KNOW IF                  
      * WE'VE DONE A STORE SPECIFICALLY OR NOT.                                 
      ******************************************************************        
LEE    7300-PROCESS-OPEN-STR.                                                   
                                                                                
           PERFORM WITH TEST BEFORE                                             
LEE            VARYING PT-BUILT-STR-INDX FROM +1 BY +1                          
LEE            UNTIL PT-BUILT-STR-INDX > PT-BUILT-STR-COUNT                     
LEE                OR PT-OPEN-STR-TABLE-NBR(PT-OPEN-STR-INDX)                   
LEE                        = PT-BUILT-STR-NBR(PT-BUILT-STR-INDX)                
           END-PERFORM.                                                         
                                                                                
      *IF NOT FOUND ON TABLE, HASN'T BEEN PROCESSED SPECIFICALLY SO             
      *CONTINUE                                                                 
LEE        IF PT-BUILT-STR-INDX > PT-BUILT-STR-COUNT                            
LEE            MOVE PT-OPEN-STR-TABLE-NBR(PT-OPEN-STR-INDX)                     
LEE                TO PV-LOC-NBR                                                
RONNA1                TSKST-LOC-NBR                                             
               PERFORM 4500-FINISH-UP                                           
           END-IF.                                                              
                                                                                
      ******************************************************************        
      * CLOSE THE STR CURSOR                                                    
      ******************************************************************        
       7400-CLOSE-STR-CSR.                                                      
                                                                                
           EXEC SQL                                                             
               CLOSE STR-CSR                                                    
           END-EXEC.                                                            
                                                                                
           EVALUATE TRUE                                                        
               WHEN SQLCODE = +0                                                
                   CONTINUE                                                     
               WHEN OTHER                                                       
                   MOVE '7400-CLOSE-STR-CSR      '                              
                                     TO PV-PARAGRAPH-NAME                       
                   MOVE 'CLOSE ERROR ON STR CSR  '                              
                                     TO PV-OPER-ATTEMPTED                       
LEE                PERFORM 9990-SQL-ABEND                                       
           END-EVALUATE.                                                        
                                                                                
      ******************************************************************        
LEE   * 9990-SQL-ABEND - PERFORMS UPON SQL RELATED ISSUES                       
      ******************************************************************        
LEE    9990-SQL-ABEND.                                                          
                                                                                
           DISPLAY '**********************************'.                        
           DISPLAY '**  ABEND     **'.                                          
           DISPLAY '**  PROGRAM   **  = ' PV-PROGRAM-NAME.                      
           DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.                    
           DISPLAY '**  OPERATION **  = ' PV-OPER-ATTEMPTED.                    
           DISPLAY '**********************************'.                        
                                                                                
           COPY DPPD004.                                                        
                                                                                
           SET ABEND-4013-DB2-ERROR TO TRUE.                                    
LEE        PERFORM 9999-ABEND.                                                  
                                                                                
      ******************************************************************        
LEE   * 9999-ABEND - PERFORMS A NON-SQL-ABEND                          *        
      ******************************************************************        
LEE    9999-ABEND.                                                              
                                                                                
           DISPLAY '** ABEND           **'.                                     
           DISPLAY '** PROGRAM         ** = ' PV-PROGRAM-NAME.                  
           DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.                
           DISPLAY '** OPERATION       ** = ' PV-OPER-ATTEMPTED.                
                                                                                
           CALL 'ILBOABN0' USING ABEND-CODE.                                    
