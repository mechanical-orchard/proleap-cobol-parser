000100*----------------------------------------------------------       00010003
000200 IDENTIFICATION DIVISION.                                         00020003
000300*----------------------------------------------------------       00030003
000400 PROGRAM-ID.    XSKUP028.                                         00040003
000500 AUTHOR.        ALEXIS KEIKER.                                    00050003
000600 DATE-WRITTEN.  OCTOBER 1, 2002.                                  00060003
000700                                                                  00070003
000800*----------------------------------------------------------       00080003
000900*            AD EVENT BUSINESS EVENT LOADER                       00090053
001000*----------------------------------------------------------       00100019
001010* THIS PROGRAM WILL PERFORM THE NECESSARY BUSINESS EVENT          00101019
001020* LOAD FOR THE ADEVENT BUSINESS EVENT.  THIS PROGRAM IS           00102019
001030* A MODULE AND WILL BE CALLED BY ANOTHER PROGRAM(XSKUT034).       00103063
001040* THERE ARE 5 PARAMETERS PASSED IN THIS PROGRAM.  ONE WILL        00104019
001050* BE THE ACTUAL ADEVENT BUSINESS RECORD, MAXIMUM FUTURE           00105019
001060* OFFSET DATE IN CCYYMMDD, A LOAD SQL RETURN CODE FIELD,          00106051
001070* A PROGRAM STATUS CODE, AND A LOAD SEVERITY LEVEL.  THIS         00107019
001080* PROGRAM WILL EITHER UPDATE OR INSERT A RECORD TO THE            00108019
001090* XST_AD_EVNT (ADEVENT TABLE).  THIS PROGRAM WILL ALWAYS SEND     00109051
001091* BACK A LOAD SQL RETURN CODE, A PROGRAM STATUS CODE AND A        00109151
001092* LOAD SEVERITY CODE.  IF THE PROGRAM DOES NOT UPDATE OR          00109251
001093* INSERT THE RECORD CORRECTLY IT WILL SELECT THE CORRECT          00109351
001094* ERROR CODES, FIND THE LOAD SEVERITY LEVEL, AND EXIT OUT OF      00109451
001095* THE PROGRAM.                                                    00109551
001100*                                                                 00110019
001101*          SQL CODES - LOAD SQL RETURN CODE                       00110152
001102*             - THIS IS THE LAST SQL RETURN CODE RECEIVED         00110219
001103*               FROM A DATABASE ACTION.                           00110319
001104*                                                                 00110419
001105*          PROGRAM CODES - PROGRAM STATUS CODE                    00110552
001106*           - 00 - ALL DATABASE ACTION WAS SUCCESSFUL AND         00110619
001107*                  WORKED ACCORDING TO THE MESSAGE TYPE.          00110719
001108*           - 01 - AN 'ADD' RECORD WAS TURNED INTO AN             00110819
001109*                  UPDATE AND THE BUSINESS EVENT WAS FOUND        00110919
001110*                  TO BE THE ONE NEEDED ON THE DATABASE.          00111019
001111*           - 02 - AN 'ADD' RECORD WAS TURNED INTO AN UPDATE      00111119
001112*                  AND THE BUSINESS EVENT WAS FOUND TO BE         00111219
001113*                  THE ONE NOT NEEDED ON THE DATABASE.            00111319
001114*           - 03 - AN 'UPDATE' RECORD WAS TURNED INTO AN ADD.     00111419
001115*           - 04 - AN 'UPDATE' RECORD WAS BYPASSED BECAUSE THE    00111561
001116*                  RECORD CURRENTLY ON THE DATABASE WAS THE       00111661
001117*                  MOST RECENT DATA.                              00111761
001118*           - 05 - THE DATABASE ACTION WAS NOT SUCCESSFUL DUE     00111861
001119*                  TO THE RETURNED SQL CODE.                      00111919
001120*           - 06 - UNEXPECTED ACTION CODE RECEIVED.               00112061
001121*                                                                 00112119
001122*          ERROR CODES - LOAD SEVERITY LEVEL                      00112219
001123*            THIS CODE IS FOUND BY TAKING THE MAXIMUM OFFSET      00112351
001124*            DATE AND COMPARING IT TO THE AD EVENT START          00112451
001125*            DATE.  IF THE MAXIMUM OFFSET DATE IS LESS THAN       00112551
001126*            THE AD EVENT START DATE THE LOAD IS NOT CRITICAL,    00112651
001127*            OTHERWISE IT IS CRITICAL TO THE SYSTEM.              00112751
001128*           - 00 - THE LOAD OF THE DATA WAS SUCCESSFUL AND        00112851
001129*                  THEREFORE THE SEVERITY OF THE LOAD DID         00112951
001130*                  NOT NEED TO BE DETERMINED.                     00113051
001131*           - 01 - THE LOAD IS CRITICAL TO A SYSTEM AND           00113119
001132*                  THEREFORE MUST BE RESOLVED ASAP.               00113219
001133*           - 02 - THE LOAD IS NOT CRITICAL AND THEREFORE CAN     00113319
001134*                  WAIT UNTIL A LATER TIME TO BE RESOLVED.        00113419
001135*                                                                 00113519
001136*----------------------------------------------------------       00113619
001137* HISTORY LOG:                                                    00113719
001138*                                                                 00113819
001139*----------------------------------------------------------       00113919
001140* DATE:                                                           00114019
001141* WR/IR#:                                                         00114119
001142* PROGRAMMER:                                                     00114219
001143* DESCRIPTION:                                                    00114319
001150*                                                                 00115019
001160*----------------------------------------------------------       00116019
001170 ENVIRONMENT DIVISION.                                            00117019
001180*----------------------------------------------------------       00118019
001190 CONFIGURATION SECTION.                                           00119019
001200 SOURCE-COMPUTER. IBM-3090.                                       00120019
001300 OBJECT-COMPUTER. IBM-3090.                                       00130019
001400                                                                  00140019
001500 INPUT-OUTPUT SECTION.                                            00150019
001600                                                                  00160019
001700 FILE-CONTROL.                                                    00170019
001800                                                                  00180019
001900*----------------------------------------------------------       00190019
002000 DATA DIVISION.                                                   00200019
002100*----------------------------------------------------------       00210019
002200 FILE SECTION.                                                    00220019
002300                                                                  00230019
002400                                                                  00240019
002500*---------------------------------------------------------        00250019
002600                                                                  00260019
002700 WORKING-STORAGE SECTION.                                         00270019
002800*---------------------------------------------------------        00280019
003500* PC- PROGRAM CONSTANTS                                           00350019
003600*----------------------------------------------------------       00360019
003700 01  PC-PROGRAM-CONSTANTS.                                        00370019
003800     05  PC-PROGRAM-NAME              PIC X(08) VALUE 'XSKUP028'. 00380019
003900     05  PC-MAX-RETRIES               PIC S9(04) VALUE +5 COMP.   00390019
004000                                                                  00400019
004100*----------------------------------------------------------       00410019
004200* PS- PROGRAM SWITCHES                                            00420019
004300*----------------------------------------------------------       00430019
004400 01  PS-PROGRAM-SWITCHES.                                         00440019
004500     05  PS-PROCESS-CONTINUE-SW       PIC X(01)  VALUE 'Y'.       00450024
004600         88  PS-PROCESS-CONTINUE                 VALUE 'Y'.       00460024
004700         88  PS-PROCESS-COMPLETE                 VALUE 'N'.       00470024
004800                                                                  00480019
004900*----------------------------------------------------------       00490019
005000* PV- PROGRAM VARIABLES                                           00500019
005100*----------------------------------------------------------       00510019
005200 01 PV-PROGRAM-VARIABLES.                                         00520019
005500    05  PV-SQL-SUB                    PIC S9(4)  VALUE +0 COMP.   00550019
005510    05  PV-SQL-CODE                   PIC S9(4)  VALUE +0.        00551070
005600    05  PV-MAX-OFFSET-DTE             PIC 9(08)  VALUE 0.         00560031
005700    05  PV-LAST-UPD-TMST              PIC X(26)  VALUE SPACES.    00570028
005800    05  PV-ACTION-CODE                PIC X(01).                  00580022
005810        88  PV-INSERT-DATA                       VALUE 'I'.       00581024
005820        88  PV-UPDATE-DATA                       VALUE 'U'.       00582024
006000    05  PV-LD-STATUS-CDE              PIC X(02).                  00600019
006100        88  PV-NO-ERROR                          VALUE '00'.      00610049
006200        88  PV-CRITICAL-ERROR                    VALUE '01'.      00620023
006300        88  PV-NOT-CRITICAL-ERROR                VALUE '02'.      00630023
006400    05  PV-PGM-STATUS-CDE             PIC X(02).                  00640019
006500        88  PV-SUCCESS-CDE                       VALUE '00'.      00650023
006600        88  PV-UPDATE-NEED                       VALUE '01'.      00660023
006700        88  PV-UPDATE-NOT-NEED                   VALUE '02'.      00670023
006800        88  PV-ADD-CDE                           VALUE '03'.      00680023
006810        88  PV-UPDATE-BYPASS                     VALUE '04'.      00681059
006900        88  PV-NO-SUCCESS-CDE                    VALUE '05'.      00690059
006910        88  PV-UNEXPECT-CDE                      VALUE '06'.      00691059
007000                                                                  00700019
007100    05  PV-AD-EVNT-STRT-DTE-NBR.                                  00710037
007200        10  PV-AD-EVNT-DTE-CCYY       PIC 9(04).                  00720028
007400        10  PV-AD-EVNT-DTE-MM         PIC 9(02).                  00740028
007600        10  PV-AD-EVNT-DTE-DD         PIC 9(02).                  00760028
007700                                                                  00770019
007800    05  PV-AD-EVNT-STRT-DTE-TM.                                   00780019
007810        10  PV-AD-EVNT-STRT-DTE.                                  00781038
007900            15  PV-AD-EVNT-DTE-TM-CCYY    PIC X(04).              00790035
008000            15  FILLER                    PIC X(01).              00800035
008100            15  PV-AD-EVNT-DTE-TM-MM      PIC X(02).              00810035
008200            15  FILLER                    PIC X(01).              00820035
008300            15  PV-AD-EVNT-DTE-TM-DD      PIC X(02).              00830035
008400        10  PV-AD-EVNT-STRT-TM            PIC X(16).              00840035
008500                                                                  00850019
008600    05  PV-AD-EVNT-END-DTE-TM.                                    00860065
008700        10  PV-AD-EVNT-END-DTE            PIC X(10).              00870065
009300        10  PV-AD-EVNT-END-TM             PIC X(16).              00930065
009400                                                                  00940065
010900*----------------------------------------------------------       01090019
011000* AD EVENT BUSINESS EVENT RECORD LAYOUT                           01100050
011100*----------------------------------------------------------       01110019
011200     COPY XSRD015.                                                01120019
011300                                                                  01130019
011900*----------------------------------------------------------       01190019
012000* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         01200019
012100*----------------------------------------------------------       01210019
012200     COPY DPWS004.                                                01220019
012300                                                                  01230019
030160*----------------------------------------------------------       03016067
030170*  DB2 COMMUNICATION AREA.                                        03017004
030180*----------------------------------------------------------       03018067
030190     EXEC SQL                                                     03019004
030191          INCLUDE SQLCA                                           03019104
030192     END-EXEC.                                                    03019204
030193                                                                  03019304
030194*---------------------------------------------                    03019404
030195*  DB2 TABLE XST00027(XST_AD_EVNT) - AD EVENT TABLE               03019532
030196*---------------------------------------------                    03019604
030197     EXEC SQL                                                     03019704
030198          INCLUDE XST00027                                        03019832
030199     END-EXEC.                                                    03019904
030200                                                                  03020004
030307 LINKAGE SECTION.                                                 03030703
030310                                                                  03031003
030400*----------------------------------------------------------       03040003
030500* FILE INFORMATION BEING PASSED TO AND FROM THIS MODULE.          03050003
030600*----------------------------------------------------------       03060003
030700 01 LV-LINKAGE-VARIABLES.                                         03070040
030900    05  LV-AD-EVNT-BUS-REC         PIC X(300).                    03090045
030910    05  LV-MAX-OFFSET-DTE          PIC X(08).                     03091040
031000    05  LV-LD-SQL-RETURN-CDE       PIC S9(4).                     03100040
031100    05  LV-PGM-STATUS-CDE          PIC X(02).                     03110040
031110    05  LV-LD-SEVERITY-LVL         PIC X(02).                     03111040
031200                                                                  03120003
031300                                                                  03130003
031400*----------------------------------------------------------       03140003
031500 PROCEDURE DIVISION USING LV-LINKAGE-VARIABLES.                   03150040
032100*----------------------------------------------------------       03210003
032200 0000-MAINLINE.                                                   03220003
032300                                                                  03230003
032400     PERFORM 1000-INITIALIZATION.                                 03240022
032500                                                                  03250003
032600     PERFORM 2000-PROCESS-MESSAGE                                 03260023
032700             UNTIL PS-PROCESS-COMPLETE.                           03270024
035000                                                                  03500003
035100     PERFORM 9999-WRAPUP.                                         03510022
035200                                                                  03520011
035500     EXIT PROGRAM.                                                03550074
035700                                                                  03570003
035701*0000-EXIT.                                                       03570124
035702 EJECT.                                                           03570224
035703                                                                  03570324
035800*----------------------------------------------------------       03580003
035900* 1000-INITIALIZATION.                                            03590022
036000*     INTIALIZES OR MOVES ANY VARIABLES BEFORE IT WILL            03600024
036100*     UPDATE OR INSERT A RECORD.                                  03610024
036200*----------------------------------------------------------       03620003
036300 1000-INITIALIZATION.                                             03630022
036400                                                                  03640003
036410     INITIALIZE DCLXST00027.                                      03641041
036420     INITIALIZE PV-SQL-CODE.                                      03642070
036500     MOVE LV-AD-EVNT-BUS-REC   TO XS015-ADEVENT-RECORD.           03650069
036501     MOVE XS015-ACTION-CDE     TO PV-ACTION-CODE.                 03650124
036502     MOVE XS015-STRT-DTE       TO PV-AD-EVNT-STRT-DTE-TM.         03650248
036503     MOVE XS015-END-DTE        TO PV-AD-EVNT-END-DTE-TM.          03650365
036505     SET PV-NO-ERROR           TO TRUE.                           03650548
036506     SET PV-SUCCESS-CDE        TO TRUE.                           03650648
036507     SET PS-PROCESS-CONTINUE   TO TRUE.                           03650748
036508                                                                  03650846
036509     IF LV-MAX-OFFSET-DTE = SPACES                                03650947
036510        INITIALIZE PV-MAX-OFFSET-DTE                              03651047
036511     ELSE                                                         03651147
036512        MOVE LV-MAX-OFFSET-DTE    TO PV-MAX-OFFSET-DTE            03651246
036513     END-IF.                                                      03651346
036516                                                                  03651628
036517     PERFORM 1100-POPULATE-DCLGEN.                                03651733
036522                                                                  03652233
036523*1000-EXIT.                                                       03652323
036524 EJECT.                                                           03652422
036525                                                                  03652524
036530*----------------------------------------------------------       03653033
036540* 1100-POPULATE-DCLGEN.                                           03654033
036550*     POPULATES THE AD EVENT TABLE VARIABLES.                     03655073
036570*----------------------------------------------------------       03657033
036580 1100-POPULATE-DCLGEN.                                            03658033
036590                                                                  03659033
036600     MOVE XS015-AD-EVNT-ID      TO XST00027-AD-EVNT-ID.           03660057
036610     MOVE XS015-CPLT-NM         TO XST00027-AD-EVNT-NM.           03661059
036700     MOVE XS015-AD-EVNT-NBR-TXT TO XST00027-AD-EVNT-NBR-TXT.      03670033
036800     MOVE XS015-STAT-CDE        TO XST00027-STAT-CDE.             03680059
036900     MOVE PV-AD-EVNT-STRT-DTE   TO XST00027-STRT-DTE.             03690065
037000     MOVE PV-AD-EVNT-END-DTE    TO XST00027-END-DTE.              03700065
037200     MOVE XS015-LAST-UPD-TMST   TO XST00027-SOR-LAST-UPD-TMST.    03720059
037210                                                                  03721033
037240*1100-EXIT.                                                       03724033
037250 EJECT.                                                           03725033
037251                                                                  03725133
037260*----------------------------------------------------------       03726003
037300* 2000-PROCESS-MESSAGE.                                           03730022
037400*     THIS CHECKS THE ACTION TO SEE WHETHER THE RECORD            03740023
037500*     SHOULD BE INSERTED INTO THE AD EVENT TABLE OR UPDATED.      03750023
037600*     IF SOMETHING IS WRONG WITH THE ACTION CODE IT WILL          03760023
037700*     PROCESS AN ERROR AND EXIT THE PROGRAM.                      03770023
037800*----------------------------------------------------------       03780003
037900 2000-PROCESS-MESSAGE.                                            03790022
038000                                                                  03800003
038010     EVALUATE TRUE                                                03801022
038011        WHEN PV-INSERT-DATA                                       03801122
038020             PERFORM 2100-INSERT-DATA                             03802022
038040        WHEN PV-UPDATE-DATA                                       03804022
038050             PERFORM 2200-UPDATE-DATA                             03805022
038060        WHEN OTHER                                                03806022
038061             SET PS-PROCESS-COMPLETE TO TRUE                      03806122
038062             SET PV-UNEXPECT-CDE     TO TRUE                      03806231
038063             PERFORM 9000-LOAD-SEVERITY-ERROR                     03806329
038090     END-EVALUATE.                                                03809022
038100                                                                  03810003
038110*2000-EXIT.                                                       03811023
038200 EJECT.                                                           03820022
038210                                                                  03821024
038300*------------------------------------------------------           03830022
038400* 2100-INSERT-DATA.                                               03840022
038500*     INSERT THE AD EVENT RECORD.                                 03850023
038600*------------------------------------------------------           03860022
038700 2100-INSERT-DATA.                                                03870022
038800                                                                  03880022
038900     PERFORM                                                      03890022
039000         WITH TEST AFTER                                          03900022
039100         VARYING PV-SQL-SUB                                       03910022
039200         FROM 1 BY 1                                              03920022
039300         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 03930022
039510                   OR  SQLCODE NOT = -904 AND -911 AND -913)      03951055
039600                                                                  03960022
039700         EXEC SQL                                                 03970022
039800             INSERT INTO XST_AD_EVNT  (AD_EVNT_ID                 03980023
039810                                      ,AD_EVNT_NM                 03981023
039820                                      ,AD_EVNT_NBR_TXT            03982023
039821                                      ,STAT_CDE                   03982133
039830                                      ,STRT_DTE                   03983023
039840                                      ,END_DTE                    03984023
039860                                      ,LAST_UPD_TMST              03986059
039870                                      ,SOR_LAST_UPD_TMST)         03987059
039900             VALUES                                               03990022
040000                (:XST00027-AD-EVNT-ID                             04000033
040100                ,:XST00027-AD-EVNT-NM                             04010033
040200                ,:XST00027-AD-EVNT-NBR-TXT                        04020033
040300                ,:XST00027-STAT-CDE                               04030033
040400                ,:XST00027-STRT-DTE                               04040033
040500                ,:XST00027-END-DTE                                04050033
040510                ,CURRENT TIMESTAMP                                04051059
040600                ,:XST00027-SOR-LAST-UPD-TMST)                     04060059
040800         END-EXEC                                                 04080022
040900                                                                  04090022
040910         MOVE SQLCODE TO PV-SQL-CODE                              04091070
040920                                                                  04092070
041000         EVALUATE TRUE                                            04100022
041100             WHEN SQLCODE = -904                                  04110022
041200             WHEN SQLCODE = -911                                  04120022
041300             WHEN SQLCODE = -913                                  04130022
041400                  CONTINUE                                        04140025
041500             WHEN SQLCODE = 0                                     04150022
041600                  SET PS-PROCESS-COMPLETE TO TRUE                 04160023
041700             WHEN SQLCODE = -803                                  04170022
041900                  PERFORM 2300-SELECT-DATA                        04190059
042000                  MOVE -803 TO SQLCODE                            04200070
042200             WHEN OTHER                                           04220025
042310                  SET PS-PROCESS-COMPLETE TO TRUE                 04231023
042311                  SET PV-NO-SUCCESS-CDE TO TRUE                   04231131
042320                  PERFORM 9000-LOAD-SEVERITY-ERROR                04232029
042600         END-EVALUATE                                             04260022
042700     END-PERFORM.                                                 04270022
042800                                                                  04280022
043100     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         04310023
043110        SET PS-PROCESS-COMPLETE TO TRUE                           04311023
043111        SET PV-NO-SUCCESS-CDE TO TRUE                             04311131
043120        PERFORM 9000-LOAD-SEVERITY-ERROR                          04312029
043400     END-IF.                                                      04340022
043500                                                                  04350022
043510*2100-EXIT.                                                       04351023
043600 EJECT.                                                           04360022
043610                                                                  04361024
052310*------------------------------------------------------           05231009
052320* 2200-UPDATE-DATA.                                               05232022
052330*     UPDATE THE AD EVENT RECORD.                                 05233023
052340*------------------------------------------------------           05234009
052350 2200-UPDATE-DATA.                                                05235022
052360                                                                  05236009
052370     PERFORM                                                      05237009
052380         WITH TEST AFTER                                          05238009
052390         VARYING PV-SQL-SUB                                       05239009
052391         FROM 1 BY 1                                              05239109
052392         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 05239209
052395                   OR  SQLCODE NOT = -904 AND -911 AND -913)      05239555
052398                                                                  05239809
052399         EXEC SQL                                                 05239909
052400             UPDATE XST_AD_EVNT                                   05240009
052401             SET  AD_EVNT_ID        = :XST00027-AD-EVNT-ID,       05240159
052402                  AD_EVNT_NM        = :XST00027-AD-EVNT-NM,       05240259
052403                  AD_EVNT_NBR_TXT   = :XST00027-AD-EVNT-NBR-TXT,  05240359
052404                  STAT_CDE          = :XST00027-STAT-CDE,         05240459
052405                  STRT_DTE          = :XST00027-STRT-DTE,         05240559
052406                  END_DTE           = :XST00027-END-DTE,          05240659
052408                  LAST_UPD_TMST     = CURRENT TIMESTAMP,          05240860
052409                  SOR_LAST_UPD_TMST = :XST00027-SOR-LAST-UPD-TMST 05240959
052410            WHERE AD_EVNT_ID        = :XST00027-AD-EVNT-ID        05241059
052411              AND SOR_LAST_UPD_TMST <= :XST00027-SOR-LAST-UPD-TMST05241166
052412         END-EXEC                                                 05241209
052413                                                                  05241309
052414         MOVE SQLCODE TO PV-SQL-CODE                              05241470
052415                                                                  05241570
052416         EVALUATE TRUE                                            05241609
052417             WHEN SQLCODE = -904                                  05241709
052418             WHEN SQLCODE = -911                                  05241809
052419             WHEN SQLCODE = -913                                  05241909
052420                  CONTINUE                                        05242026
052421             WHEN SQLCODE = 0                                     05242109
052422                  SET PS-PROCESS-COMPLETE TO TRUE                 05242223
052423             WHEN SQLCODE = +100                                  05242309
052424                  PERFORM 2300-SELECT-DATA                        05242459
052425                  MOVE +100 TO SQLCODE                            05242570
052426             WHEN OTHER                                           05242625
052427                  SET PS-PROCESS-COMPLETE TO TRUE                 05242723
052428                  SET PV-NO-SUCCESS-CDE TO TRUE                   05242831
052429                  PERFORM 9000-LOAD-SEVERITY-ERROR                05242929
052430         END-EVALUATE                                             05243009
052431     END-PERFORM.                                                 05243109
052432                                                                  05243209
052433     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         05243323
052434        SET PS-PROCESS-COMPLETE TO TRUE                           05243423
052435        SET PV-NO-SUCCESS-CDE TO TRUE                             05243531
052436        PERFORM 9000-LOAD-SEVERITY-ERROR                          05243629
052437     END-IF.                                                      05243709
052438                                                                  05243809
052439*2200-EXIT.                                                       05243923
052440 EJECT.                                                           05244022
052450                                                                  05245024
052460*------------------------------------------------------           05246059
052470* 2300-SELECT-DATA.                                               05247059
052480*     SELECT THE TIMESTAMP IN THE AD EVENT RECORD.                05248059
052490*------------------------------------------------------           05249059
052500 2300-SELECT-DATA.                                                05250059
052600                                                                  05260059
052700     PERFORM                                                      05270059
052800         WITH TEST AFTER                                          05280059
052900         VARYING PV-SQL-SUB                                       05290059
053000         FROM 1 BY 1                                              05300059
053100         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 05310059
053200                   OR  SQLCODE NOT = -904 AND -911 AND -913)      05320059
053300                                                                  05330059
053400         EXEC SQL                                                 05340059
053410             SELECT  SOR_LAST_UPD_TMST                            05341059
053420               INTO :PV-LAST-UPD-TMST                             05342059
053430               FROM  XST_AD_EVNT                                  05343059
053440              WHERE  AD_EVNT_ID      = :XST00027-AD-EVNT-ID       05344059
053450         END-EXEC                                                 05345059
053460                                                                  05346059
053461         MOVE SQLCODE TO PV-SQL-CODE                              05346170
053462                                                                  05346270
053470         EVALUATE TRUE                                            05347059
053480             WHEN SQLCODE = -904                                  05348059
053490             WHEN SQLCODE = -911                                  05349059
053491             WHEN SQLCODE = -913                                  05349159
053492                  CONTINUE                                        05349259
053493             WHEN SQLCODE = 0                                     05349359
053494                  IF PV-UPDATE-DATA                               05349459
053495                     SET PS-PROCESS-COMPLETE TO TRUE              05349559
053496                     SET PV-UPDATE-BYPASS TO TRUE                 05349659
053497                  ELSE                                            05349759
053498                     PERFORM 2350-TMST-COMPARE                    05349871
053499                  END-IF                                          05349959
053500             WHEN SQLCODE = +100                                  05350059
053501                  SET PV-INSERT-DATA TO TRUE                      05350159
053502                  SET PV-ADD-CDE TO TRUE                          05350259
053503             WHEN OTHER                                           05350359
053504                  SET PS-PROCESS-COMPLETE TO TRUE                 05350459
053505                  SET PV-NO-SUCCESS-CDE TO TRUE                   05350559
053506                  PERFORM 9000-LOAD-SEVERITY-ERROR                05350659
053507         END-EVALUATE                                             05350759
053508     END-PERFORM.                                                 05350859
053509                                                                  05350959
053510     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         05351059
053511        SET PS-PROCESS-COMPLETE TO TRUE                           05351159
053512        SET PV-NO-SUCCESS-CDE TO TRUE                             05351259
053513        PERFORM 9000-LOAD-SEVERITY-ERROR                          05351359
053514     END-IF.                                                      05351459
053515                                                                  05351559
053516*2300-EXIT.                                                       05351659
053517 EJECT.                                                           05351759
053518                                                                  05351859
053519*--------------------------------------------------------         05351959
053520* 2350-TMST-COMPARE.                                              05352071
053521*     COMPARE TIMESTAMP OF EXISTING ROW TO MESSAGE RECORD         05352171
053522*     AND UPDATE IF MESSAGE HAS A NEWER TIMESTAMP.                05352271
053523*--------------------------------------------------------         05352359
053524 2350-TMST-COMPARE.                                               05352471
053525                                                                  05352559
053526     IF XS015-LAST-UPD-TMST >= PV-LAST-UPD-TMST                   05352662
053527        SET PV-UPDATE-DATA      TO TRUE                           05352759
053528        SET PV-UPDATE-NEED      TO TRUE                           05352859
053529     ELSE                                                         05352959
053530        SET PS-PROCESS-COMPLETE TO TRUE                           05353059
053531        SET PV-UPDATE-NOT-NEED  TO TRUE                           05353159
053533     END-IF.                                                      05353359
053534                                                                  05353459
053535*2350-EXIT.                                                       05353559
053536 EJECT.                                                           05353659
053537                                                                  05353759
053540*----------------------------------------------------------       05354014
053600* 9000-LOAD-SEVERITY-ERROR.                                       05360022
053610*     THIS PROCEDURE IS CALLED IF THE RECORD WAS NOT UPDATED      05361023
053620*     OR INSERTED INTO THE AD EVENT TABLE.  COMPARES THE          05362031
053630*     MAXIMUM OFFSET DATE TO THE BUSINESS AD EVENT START          05363031
053640*     DATE.  IF THE MAXIMUM OFFSET DATE IS LESS THAN THE          05364031
053650*     AD EVENT START DATE THE ERROR IS UNCRITICAL, OTHERWISE      05365031
053660*     IT IS CRITICAL.                                             05366031
053700*----------------------------------------------------------       05370014
053800 9000-LOAD-SEVERITY-ERROR.                                        05380022
053900                                                                  05390014
053901     IF PV-AD-EVNT-STRT-DTE = SPACES                              05390146
053902        MOVE ZEROES TO PV-AD-EVNT-STRT-DTE-NBR                    05390246
053903     ELSE                                                         05390346
053910        PERFORM 9100-FORMAT-DATE-INFO                             05391046
053920     END-IF.                                                      05392046
054100                                                                  05410014
054200     IF (PV-MAX-OFFSET-DTE < PV-AD-EVNT-STRT-DTE-NBR) AND         05420044
054210       (PV-MAX-OFFSET-DTE NOT = ZEROES) AND                       05421046
054220       (PV-AD-EVNT-STRT-DTE-NBR NOT = ZEROES)                     05422046
054300        SET PV-NOT-CRITICAL-ERROR TO TRUE                         05430044
054400     ELSE                                                         05440014
054500        SET PV-CRITICAL-ERROR TO TRUE                             05450044
054600     END-IF.                                                      05460014
054700                                                                  05470014
054710     INITIALIZE PV-SQL-SUB.                                       05471056
054720                                                                  05472056
054800*9000-EXIT.                                                       05480023
055110 EJECT.                                                           05511022
055120                                                                  05512024
055200*----------------------------------------------------------       05520014
055300* 9100-FORMAT-DATE-INFO.                                          05530022
055310*     FORMATS THE DATE FOR COMPARING.                             05531023
055400*----------------------------------------------------------       05540014
055500 9100-FORMAT-DATE-INFO.                                           05550022
055600                                                                  05560014
055700     MOVE PV-AD-EVNT-DTE-TM-CCYY TO PV-AD-EVNT-DTE-CCYY.          05570014
055800     MOVE PV-AD-EVNT-DTE-TM-MM   TO PV-AD-EVNT-DTE-MM.            05580014
055900     MOVE PV-AD-EVNT-DTE-TM-DD   TO PV-AD-EVNT-DTE-DD.            05590014
056000                                                                  05600014
056001*9100-EXIT.                                                       05600123
056010 EJECT.                                                           05601022
056020                                                                  05602024
059800*----------------------------------------------------------       05980015
059900* 9999-WRAPUP.                                                    05990022
059910*     MOVES ALL ERROR CODES TO THE LINKAGE VARIABLES TO           05991023
059920*     BE PASSED BACK TO THE CALLING PROGRAM.  EXITS THE           05992023
059930*     PROGRAM.                                                    05993023
060000*----------------------------------------------------------       06000015
060100 9999-WRAPUP.                                                     06010022
060200                                                                  06020015
060210     MOVE PV-PGM-STATUS-CDE TO LV-PGM-STATUS-CDE.                 06021040
060300     MOVE PV-SQL-CODE       TO LV-LD-SQL-RETURN-CDE.              06030070
060400     MOVE PV-LD-STATUS-CDE  TO LV-LD-SEVERITY-LVL.                06040040
060500                                                                  06050015
060710*9999-EXIT.                                                       06071023
060800 EJECT.                                                           06080022
060900                                                                  06090024
