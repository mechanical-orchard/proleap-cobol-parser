       IDENTIFICATION DIVISION.                                         00010099
                                                                        00020099
       PROGRAM-ID.    MLKUP355.                                         00030099
       INSTALLATION.  KOHLS DEPARTMENT STORES.                          00040099
       DATE-WRITTEN.  11-26-2004.                                       00050099
       DATE-COMPILED.                                                   00060099
                                                                        00070099
      ******************************************************************00080099
      * MLKUP355 - M/L MONTHLY DETAIL LEDGER TABLE RECALC UPDATE        00090099
      ******************************************************************00100099
      *                                                                 00110099
      *  THIS PROGRAM WILL TAKE IN A COMMON RECALC EXTRACT AND UPDAT    00120099
      *    SHNK_RTL_AMT     - RETAIL SHRINK                             00130099
      *    END_INV_RTL_AMT  - ENDING INVENTORY RETAIL                   00140099
      *    END_INV_COST_AMT - ENDING INVENTORY COST                     00150099
W28582*    INV_COST_ADJ1_AMT - INVENTORY COST ADJUSTMENT 1              00151099
W28582*    INV_COST_ADJ2_AMT - INVENTORY COST ADJUSTMENT 2              00152099
W28582*    END_INV_COST1_AMT - ENDING INVENTORY COST 1                  00153099
W28582*    END_INV_COST2_AMT - ENDING INVENTORY COST 2                  00154099
W28582*    ADJ_GRO_MRGN_AMT  - ADJUSTED GROSS MARGIN AMOUNT             00155099
      *                                                                 00160099
      * THERE ARE TWO INPUT FILES TO THIS PROGRAM:                      00170099
      *    INP01 - CONTROL CARD FILE                                    00180099
      *            USE TO DETERMINE WHICH CHECKPOINT RESTART RECORD/ROW 00190099
      *            TO USE FOR RESTARTING THIS PROGRAM.                  00200099
      *    INP02 - COMMON RECALC EXTRACT FILE                           00210099
      *            THIS FILE CONTAIN THE RECALC RECORD(S) TO BE UPDATED.00220099
      *                                                                 00230099
      * THIS PROGRAM USES CHECKPOINT RESTART LOGIC TO DETERMINE IF AND  00240099
      * WHEN A CHECKPOINT IS TO BE TAKEN. A MINIMUM OF 10 SECONDS WILL  00250099
      * EXPIRE BEFORE A CHECKPOINT / COMMIT WILL BE PERFORMED.          00260099
      *                                                                 00270099
      * CONDITIONS:                                                     00280099
      * NORMAL START - START FROM THE BEGINNING OF THE INPUT FILE       00290099
      * RESTART - SELECT CHECKPOINT RESTART KEY FROM TCKRSTINF, USE     00300099
      *   DEPT/MAJ/SUB-CLASS/LOC/ENT-ID AS A STARTING POINT FOR         00310099
      *   RECALC TO CONTINUE; > THE LAST COMMITED KEY.                  00320099
      *                                                                 00330099
      *CHANGE HISTORY:                                                  00340099
      * WR/PROJ DATE       PGMR        DESCRIPTION OF CHANGES           00350099
      * ------- ---------- ----------- -------------------------------- 00360099
R21764* W21764 11-26-2004 ROD JANSSEN MERCH LEDGER DETAIL LEDGER TBL    00370099
W20445* W20445 01-11-2005 ROD JANSSEN MAX SEASON MONTH ISSUE. INCREASE  00380099
W20445*                               TO 7 TO CORRECT.                  00390099
      * W21764 01-13-2005 ERIN SEARL  MADE CHANGES TO MLPD500/MLWS500   00400099
R20445* W20445 01-14-2005 ROD JANSSEN SHRINK CALC/EIR CALC ISSUES.      00410099
727932*P727932 01-16-2005 ROD JANSSEN MLK185 S04C ABEND DURING RECALC   00420099
727932*                               CAUSED DURING THE VENDOR NUMBER   00430099
727932*                               COUNTING PROCESS.                 00440099
X20445* W20445 01-19-2005 ROD JANSSEN MORE SHRINK/EIR CALC ISSUES.      00450099
W23843* W23843 02-06-2005 V. LEE YANG REWRITE TO USE COMMON RECALC EXTR 00460099
W28582* W28582 12-15-2005 C. MCCAMMON CHANGED ENT-ID TO ML-LWST-ID OR   00461099
W28582*                               ML-LO-MDSE-LVL-ID.                00462099
W28582* W28582 10-11-2006 J. SELWITSCHKA                                00463099
W28582*                               EXPAND RECALC-EXTR-FILE (MLRD070) 00464099
W28582*                               TO 400 AND INSERT/UPDATE NEW      00465099
W28582*                               COLUMNS FOR BV SMOOTHING.         00466099
J28582* W28582 12-06-2006 J. SELWITSCHKA                                00467099
J28582*                               CHECK EIC2 INSTEAD OF EIC WHEN    00468099
J28582*                               DROPPING RECORDS.                 00469099
X28582* W28582 04-30-2007 R. JANSSEN  INCLUDE GROSS MARGIN IN CARRY     00469199
X28582*                               FORWARD TEST.                     00469299
      ******************************************************************00470099
                                                                        00480099
       ENVIRONMENT DIVISION.                                            00490099
       CONFIGURATION SECTION.                                           00500099
       SOURCE-COMPUTER.        IBM-3090.                                00510099
       OBJECT-COMPUTER.        IBM-3090.                                00520099
       INPUT-OUTPUT SECTION.                                            00530099
       FILE-CONTROL.                                                    00540099
                                                                        00550099
           SELECT CC-PGM-MODE-CNTL-FILE                                 00560099
               ASSIGN TO INP01.                                         00570099
                                                                        00580099
           SELECT RECALC-EXTR-FILE                                      00590099
               ASSIGN TO INP02.                                         00600099
                                                                        00610099
       DATA DIVISION.                                                   00620099
       FILE SECTION.                                                    00630099
                                                                        00640099
       FD  CC-PGM-MODE-CNTL-FILE                                        00650099
           RECORDING MODE IS F                                          00660099
           LABEL RECORDS ARE STANDARD                                   00670099
           BLOCK CONTAINS 0 RECORDS.                                    00680099
       01  CC-PGM-MODE-CNTL-REC            PIC X(80).                   00690099
                                                                        00700099
       FD  RECALC-EXTR-FILE                                             00710099
           RECORDING MODE IS F                                          00720099
           LABEL RECORDS ARE STANDARD                                   00730099
           BLOCK CONTAINS 0 RECORDS.                                    00740099
W28582 01  RECALC-EXTR-REC                 PIC X(400).                  00750099
                                                                        00760099
      ******************************************************************00770099
       WORKING-STORAGE SECTION.                                         00780099
      ******************************************************************00790099
                                                                        00800099
      ******************************************************************00810099
      *  COMMON RECALC EXTRACT                                          00820099
      ******************************************************************00830099
      *01  ML070-COMMON-RECALC-EXTRACT.                                 00840099
           COPY MLRD070.                                                00850099
                                                                        00860099
       01  CC-CONTROL-CARD-REC.                                         00870099
           05  CC-JOB-NAME                 PIC  X(08)      VALUE SPACES.00880099
           05  FILLER                      PIC  X(01)      VALUE SPACES.00890099
           05  CC-RECALC-MODE              PIC  X(01)      VALUE SPACE. 00900099
               88  CC-ADJUST-RECALC-MODE                   VALUE 'A'.   00910099
               88  CC-REPLACE-RECALC-MODE                  VALUE SPACE. 00920099
           05  FILLER                      PIC  X(70)      VALUE SPACES.00930099
                                                                        00940099
       01  ABEND-CODE                      PIC S9(04)      VALUE ZEROES 00950099
                               COMP SYNC.                               00960099
           88  MISSING-CONTROL-ABEND                       VALUE +4002. 00970099
           88  INVALID-CONTROL-ABEND                       VALUE +4003. 00980099
           88  SQL-ABEND                                   VALUE +4013. 00990099
                                                                        01000099
       01  PA-PROGRAM-ACCUMULATORS.                                     01010099
           05  PA-COMMIT-COUNT             PIC  9(09)      VALUE ZEROES.01020099
           05  PA-INSERT-COUNT             PIC  9(09)      VALUE ZEROES.01030099
           05  PA-UPDATE-COUNT             PIC  9(09)      VALUE ZEROES.01040099
           05  PA-EXTRACT-RECS-READ        PIC  9(09)      VALUE ZEROES.01050099
           05  PA-ZERO-REC-DROPPED         PIC  9(09)      VALUE ZEROES.01060099
           05  PA-DUPLICATE-REC            PIC  9(09)      VALUE ZEROES.01070099
                                                                        01080099
       01  PS-PROGRAM-SWITCHES.                                         01090099
           05  PS-FIRST-TIME-THRU-SW       PIC X           VALUE 'Y'.   01100099
               88  PS-NOT-FIRST-TIME-THRU                  VALUE 'N'.   01110099
               88  PS-FIRST-TIME-THRU                      VALUE 'Y'.   01120099
           05  PS-EOF-EXTR-FILE-SW         PIC X(01)       VALUE 'N'.   01130099
               88  PS-EOF-EXTR-FILE                        VALUE 'Y'.   01140099
           05  PS-FIRST-COMMIT-SW          PIC X           VALUE 'N'.   01150099
               88  PS-FIRST-COMMIT                         VALUE 'Y'.   01160099
           05  PS-RESTART-ROW-SW           PIC X           VALUE 'N'.   01170099
               88  PS-RESTART-KEY-ESTABLISHED              VALUE 'Y'.   01180099
           05  PS-COMMIT-TAKEN-SW          PIC X           VALUE 'N'.   01190099
               88  PS-COMMIT-TAKEN                         VALUE 'Y'.   01200099
                                                                        01210099
       01  PC-PROGRAM-CONSTANTS.                                        01220099
           05  PC-PROGRAM-NAME             PIC  X(08)      VALUE        01230099
               'MLKUP355'.                                              01240099
                                                                        01250099
       01  PE-PROGRAM-ERROR-MESSAGES.                                   01260099
           05  PE-MSG-01                       PIC X(30) VALUE          01270099
                'INSPECT WHERE CLAUSE VARIABLE'.                        01280099
           05  PE-MSG-02                       PIC X(30) VALUE          01290099
                'DB2 SELECT ATTEMPTED         '.                        01300099
           05  PE-MSG-03                       PIC X(30) VALUE          01310099
                'ATTEMPTING TO OPEN DB2 CURSOR'.                        01320099
           05  PE-MSG-04                       PIC X(30) VALUE          01330099
                'ATTEMPT TO FETCH CURSOR ROW  '.                        01340099
           05  PE-MSG-05                       PIC X(30) VALUE          01350099
                'ATTEMPT TO CLOSE DB2 CURSOR  '.                        01360099
           05  PE-MSG-06                       PIC X(30) VALUE          01370099
                'ERROR ON UPDATE OF MNLYSUM   '.                        01380099
           05  PE-MSG-07                       PIC X(30) VALUE          01390099
                'ERROR IN SELECT - TCKRSTCNTL '.                        01400099
           05  PE-MSG-08                       PIC X(30) VALUE          01410099
                'UPDATE WORK_STRG - TCKRSTINF '.                        01420099
           05  PE-MSG-09                       PIC X(30) VALUE          01430099
                'PGM ABEND DURING A COMMIT    '.                        01440099
           05  PE-MSG-10                       PIC X(30) VALUE          01450099
                'UPDATE OF TCKRSTCNTL FAILED  '.                        01460099
           05  PE-MSG-11                       PIC X(30) VALUE          01470099
                'ERROR IN SELECT - TCKRSTINF  '.                        01480099
           05  PE-MSG-12                       PIC X(30) VALUE          01490099
                'UNABLE TO OBTAIN TIMESTAMP   '.                        01500099
           05  PE-MSG-13                       PIC X(30) VALUE          01510099
                'SHRINK NOT FND FOR DEPT/DATE '.                        01520099
           05  PE-MSG-14                       PIC X(30) VALUE          01530099
                'ERROR ON ''INSERT'' TO MNLYSUM'.                       01540099
           05  PE-MSG-15                       PIC X(30) VALUE          01550099
                'CURRENT DATE LIMIT IS 27 WKS.'.                        01560099
           05  PE-MSG-16                       PIC X(30) VALUE          01570099
                'ERROR SELECTING COUNT OF ROWS.'.                       01580099
           05  PE-MSG-17                       PIC X(30) VALUE          01590099
                'ERROR IN PFW WK NBR - DTATTR.'.                        01600099
           05  PE-MSG-18                       PIC X(30) VALUE          01610099
                'ERR PREV SEA WK NBR - DTATTR.'.                        01620099
           05  PE-MSG-20                       PIC X(30) VALUE          01630099
                'ERR IN OPN SEA MTH - TDTATTR.'.                        01640099
           05  PE-MSG-21                       PIC X(30) VALUE          01650099
                'ERR IN FETCH SEA MTH - DTATTR'.                        01660099
           05  PE-MSG-22                       PIC X(30) VALUE          01670099
                'ERROR IN NBR OF SEAONS      .'.                        01680099
           05  PE-MSG-23                       PIC X(30) VALUE          01690099
                'ERROR IN CLOS SEA MTH - DTAT.'.                        01700099
           05  PE-MSG-24                       PIC X(30) VALUE          01710099
                'ERROR SELECTING PARTITION  '.                          01720099
                                                                        01730099
       01  PROGRAM-VARIABLES.                                           01740099
           05  PV-CURRENT-TIMESTAMP        PIC  X(26)      VALUE SPACES.01750099
           05  PV-COMMIT-TIMESTAMP         PIC  X(26)      VALUE SPACES.01760099
           05  PV-PARAGRAPH-NAME           PIC  X(30)      VALUE SPACES.01770099
           05  PV-ABEND-MESSAGE            PIC  X(75)      VALUE SPACES.01780099
           05  PV-OPERATION-ATTEMPTED      PIC  X(30)      VALUE SPACES.01790099
           05  PV-DEPT-NBR-HOLD            PIC  S9(04)     VALUE ZEROES 01800099
                               COMP-3.                                  01810099
                                                                        01820099
      ******************************************************************01830099
      *  ERROR MESSAGE AREA FOR DB2                                     01840099
      ******************************************************************01850099
           COPY DPWS004.                                                01860099
                                                                        01870099
      ****************************************************              01880099
      *  COMMUNICATION AREAS FOR DB2                     *              01890099
      ****************************************************              01900099
           EXEC SQL                                                     01910099
               INCLUDE SQLCA                                            01920099
           END-EXEC.                                                    01930099
                                                                        01940099
      ****************************************************              01950099
      * M/L MONTHLY DETAIL LEDGER (MLT_MNLY_SUM)         *              01960099
      ****************************************************              01970099
           EXEC SQL                                                     01980099
               INCLUDE MLT00004                                         01990099
           END-EXEC.                                                    02000099
                                                                        02010099
      ****************************************************              02020099
      * M/L DATE TABLE AND CURRENT OPEN FISCAL DATE INFO *              02030099
      ****************************************************              02040099
           EXEC SQL                                                     02050099
               INCLUDE TDTATTR                                          02060099
           END-EXEC.                                                    02070099
                                                                        02080099
           EXEC SQL                                                     02090099
               INCLUDE TMLCNTL                                          02100099
           END-EXEC.                                                    02110099
                                                                        02120099
      ****************************************************              02130099
      *CHECKPOINT RESTART CONTROL AND INFORMATION TABLES *              02140099
      ****************************************************              02150099
           EXEC SQL                                                     02160099
               INCLUDE TCKRSTCN                                         02170099
           END-EXEC.                                                    02180099
                                                                        02190099
           EXEC SQL                                                     02200099
               INCLUDE TCKRSTIN                                         02210099
           END-EXEC.                                                    02220099
                                                                        02230099
      ******************************************************************02240099
      * CHECKPOINT RESTART VARIABLES                                   *02250099
      ******************************************************************02260099
       01  CR-CHECKPOINT-RESTART-AREA.                                  02270099
           05  CR-AREA-LEN                 PIC S9(04)      VALUE +89    02280099
                               COMP.                                    02290099
           05  CR-CHECKPOINT-RESTART-VAR.                               02300099
               10  CR-PREV-DTL-KEY         PIC  X(28)      VALUE SPACES.02310099
               10  FILLER REDEFINES CR-PREV-DTL-KEY.                    02320099
                   15  CR-FISCAL-MN-END-DTE PIC  X(10).                 02330099
                   15  FILLER              PIC  X(01).                  02340099
                   15  CR-KEY.                                          02350099
                       20  CR-PARTN-NBR    PIC S9(4)V                   02360099
                               COMP.                                    02370099
                       20  CR-DEPT-NBR     PIC S9(4)V                   02380099
                               COMP-3.                                  02390099
                       20  CR-MAJ-CL-NBR   PIC S9(4)V                   02400099
                               COMP-3.                                  02410099
                       20  CR-SUB-CL-NBR   PIC S9(4)V                   02420099
                               COMP-3.                                  02430099
                       20  CR-LOC-NBR      PIC S9(4)                    02440099
                               COMP.                                    02450099
W28582                 20  CR-ML-LWST-ID   PIC S9(9)                    02460099
W28582***              20  CR-ENT-ID       PIC S9(9)                    02461099
                               COMP.                                    02470099
               10  FILLER                   PIC  X(01) VALUE SPACES.    02480099
               10  CR-MNLYSUM-UPDATE-COUNT  PIC  9(09) VALUE ZEROES.    02490099
               10  FILLER                   PIC  X(01) VALUE SPACES.    02500099
               10  CR-MNLYSUM-INSERT-COUNT  PIC  9(09) VALUE ZEROES.    02510099
               10  FILLER                   PIC  X(01) VALUE SPACES.    02520099
               10  CR-MNLYSUM-COMMIT-COUNT  PIC  9(09) VALUE ZEROES.    02530099
               10  FILLER                   PIC  X(01) VALUE SPACES.    02540099
               10  CR-MNLYSUM-INPUT-COUNT   PIC  9(09) VALUE ZEROES.    02550099
               10  FILLER                   PIC  X(01) VALUE SPACES.    02560099
               10  CR-ZERO-REC-DROPPED      PIC  9(09) VALUE ZEROES.    02570099
               10  FILLER                   PIC  X(01) VALUE SPACES.    02580099
               10  CR-DUPLICATE-REC         PIC  9(09) VALUE ZEROES.    02590099
               10  FILLER                   PIC  X(01) VALUE SPACES.    02600099
                                                                        02610099
      ******************************************************************02620099
      ******************************************************************02630099
       PROCEDURE DIVISION.                                              02640099
      ******************************************************************02650099
                                                                        02660099
       0000-MAIN-MLKUP355.                                              02670099
                                                                        02680099
           PERFORM 1000-INITIALIZATION.                                 02690099
                                                                        02700099
           PERFORM 2000-PROCESS-INPUT                                   02710099
                UNTIL PS-EOF-EXTR-FILE.                                 02720099
                                                                        02730099
           PERFORM 9000-EOJ-ROUTINE.                                    02740099
                                                                        02750099
       9999-EXIT-PROGRAM.                                               02760099
           STOP RUN.                                                    02770099
                                                                        02780099
      /*****************************************************************02790099
      * 1000-INITIALIZATION.                                            02800099
      * INITIALIZE VARIOUS VARIABLES AND CHECK TO SEE WHAT RESTART      02810099
      * CONDITION TO OPERATE UNDER.                                     02820099
      ******************************************************************02830099
       1000-INITIALIZATION.                                             02840099
                                                                        02850099
           OPEN INPUT CC-PGM-MODE-CNTL-FILE                             02860099
                      RECALC-EXTR-FILE.                                 02870099
                                                                        02880099
           PERFORM 7100-READ-PROCESS-JOB-NAME.                          02890099
                                                                        02900099
           DISPLAY ' '.                                                 02910099
           DISPLAY ' PROCESSING JOB NAME: ' CC-JOB-NAME.                02920099
           IF CC-ADJUST-RECALC-MODE                                     02930099
               DISPLAY '   MODE: ADJUST'                                02940099
           ELSE                                                         02950099
               DISPLAY '   MODE: REPLACE/NORMAL'                        02960099
           END-IF.                                                      02970099
                                                                        02980099
           IF CC-JOB-NAME = SPACES                                      02990099
               SET INVALID-CONTROL-ABEND  TO TRUE                       03000099
               PERFORM 9999-ABEND                                       03010099
           END-IF.                                                      03020099
                                                                        03030099
      *** TEST FOR A RESTART OF THIS PROGRAM....                        03040099
           PERFORM 7650-INIT-CHECKPOINT-SELECT.                         03050099
           IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           03060099
                PERFORM 7700-SELECT-RESTART-INFO                        03070099
                MOVE TCKRSTINF-WORK-STRG-DESC-TEXT                      03080099
                    TO CR-CHECKPOINT-RESTART-VAR                        03090099
                DISPLAY ' '                                             03100099
                DISPLAY '--------------------------------------------'  03110099
                DISPLAY 'RESTART-LAST DEPT/MCL/SCL/LOC COMMIT: ',       03120099
                         ' PARTN: ' CR-PARTN-NBR                        03130099
                         ' DEPT:  ' CR-DEPT-NBR                         03140099
                         ' MAJCL: ' CR-MAJ-CL-NBR                       03150099
                         ' SUBCL: ' CR-SUB-CL-NBR                       03160099
                         ' LOC:   ' CR-LOC-NBR                          03170099
W28582                   ' ML-LWST-ID: ' CR-ML-LWST-ID                  03180099
W28582***                ' ENT-ID ' CR-ENT-ID                           03181099
                DISPLAY '--------------------------------------------'  03190099
                DISPLAY ' '                                             03200099
                MOVE CR-MNLYSUM-INPUT-COUNT    TO PA-EXTRACT-RECS-READ  03210099
                MOVE CR-MNLYSUM-UPDATE-COUNT   TO PA-UPDATE-COUNT       03220099
                MOVE CR-MNLYSUM-INSERT-COUNT   TO PA-INSERT-COUNT       03230099
                MOVE CR-MNLYSUM-COMMIT-COUNT   TO PA-COMMIT-COUNT       03240099
                MOVE CR-ZERO-REC-DROPPED       TO PA-ZERO-REC-DROPPED   03250099
                MOVE CR-DUPLICATE-REC          TO PA-DUPLICATE-REC      03260099
           ELSE                                                         03270099
               SET PS-FIRST-COMMIT TO TRUE                              03280099
               INITIALIZE CR-CHECKPOINT-RESTART-VAR                     03290099
               DISPLAY 'COMMITS WILL BE TAKEN EVERY ',                  03300099
                                 TCKRSTCNTL-CKPT-FRQNCY-QTY, ' SECONDS.'03310099
               PERFORM 7600-GET-COMMIT-TIMESTAMP                        03320099
           END-IF.                                                      03330099
                                                                        03340099
      *** READ THE RECALC EXTRACT FILE...                               03350099
           SET PS-FIRST-TIME-THRU TO TRUE.                              03360099
           INITIALIZE PA-PROGRAM-ACCUMULATORS.                          03370099
                                                                        03380099
           IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           03390099
               PERFORM 7000-READ-EXTR-FILE                              03400099
                   UNTIL (ML070-PARTN-NBR  = CR-PARTN-NBR  AND          03410099
                          ML070-DEPT-NBR   = CR-DEPT-NBR   AND          03420099
                          ML070-MAJ-CL-NBR = CR-MAJ-CL-NBR AND          03430099
                          ML070-SUB-CL-NBR = CR-SUB-CL-NBR AND          03440099
                          ML070-LOC-NBR    = CR-LOC-NBR    AND          03450099
W28582                    ML070-ML-LWST-ID = CR-ML-LWST-ID)             03460099
W28582***                 ML070-ENT-ID     = CR-ENT-ID)                 03461099
                    OR (PS-EOF-EXTR-FILE)                               03470099
           END-IF.                                                      03480099
                                                                        03490099
      * GET THE NEXT RECORD                                             03500099
      * FOR RESTARTING, THIS WILL CONTINUE AFTER THE LAST COMMITED REC  03510099
      * THIS IS IMPORTANT WHEN RUNNING UNDER ADJUSTMENT MODE, SEE CNTL  03520099
           IF NOT PS-EOF-EXTR-FILE                                      03530099
               PERFORM 7000-READ-EXTR-FILE                              03540099
           END-IF.                                                      03550099
                                                                        03560099
      *** END OF FILE PROCESSING...                                     03570099
           IF PS-EOF-EXTR-FILE                                          03580099
               IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                       03590099
                   DISPLAY 'NO RECORDS TO PROCESSED AFTER RESTART'      03600099
               ELSE                                                     03610099
                   IF TCKRSTCNTL-CKPT-STAT-CODE = '0'                   03620099
                       DISPLAY 'NO ROWS SELECTED FOR RECALCULATION'     03630099
                       DISPLAY 'CHECK IF INPUT FILE IS EMPTY      '     03640099
                   END-IF                                               03650099
               END-IF                                                   03660099
           END-IF.                                                      03670099
                                                                        03680099
           DISPLAY ' '.                                                 03690099
                                                                        03700099
      /*****************************************************************03710099
      * 2000-PROCESS-INPUT.                                             03720099
      * MAIN PROCESSING PARAGRAPH-PERFORMED UNTIL END OF INPUT FILE     03730099
      ******************************************************************03740099
       2000-PROCESS-INPUT.                                              03750099
                                                                        03760099
           ADD 1 TO PA-EXTRACT-RECS-READ.                               03770099
                                                                        03780099
           IF ML070-DEPT-NBR NOT = PV-DEPT-NBR-HOLD                     03790099
               MOVE ML070-DEPT-NBR TO PV-DEPT-NBR-HOLD                  03800099
               DISPLAY 'PROCESSING DEPT: ' PV-DEPT-NBR-HOLD             03810099
           END-IF.                                                      03820099
                                                                        03830099
      *    IF ML070-PREV-FISCAL-EXIST                                   03840099
      *        AND NOT ML070-CURR-FISCAL-EXIST                          03850099
      *        IF ML070-PREV-END-INV-RTL-AMT       = ZEROES             03860099
      *            AND ML070-PREV-END-INV-COST-AMT = ZEROES             03870099
      *            AND ML070-CURR-END-INV-RTL-AMT  = ZEROES             03880099
      *            AND ML070-CURR-END-INV-COST-AMT = ZEROES             03890099
      *            ADD +1           TO PA-ZERO-REC-DROPPED              03900099
      *        ELSE                                                     03910099
      *            PERFORM 6100-INSERT-CARRY-FWD-ROW                    03920099
      *        END-IF                                                   03930099
      *    ELSE                                                         03940099
      *        IF NOT ML070-CURR-FISCAL-EXIST                           03950099
      *            ADD +1           TO PA-DUPLICATE-REC                 03960099
      *            DISPLAY ' RECORD DROPPED - '                         03970099
      *                  ' TYPE:  ' ML070-TYPE                          03980099
      *                  ' PARTN: ' ML070-PARTN-NBR,                    03990099
      *                  ' DEPT:  ' ML070-DEPT-NBR,                     04000099
      *                  ' MAJCL: ' ML070-MAJ-CL-NBR,                   04010099
      *                  ' SUBCL: ' ML070-SUB-CL-NBR,                   04020099
      *                  ' LOC:   ' ML070-LOC-NBR,                      04030099
W28582*                  ' ML-LWST-ID: ' ML070-ML-LWST-ID               04040099
W28582***                ' ENTID: ' ML070-ENT-ID                        04041099
      *        ELSE                                                     04050099
      *            PERFORM 4000-PROCESS-RECALC                          04060099
      *        END-IF                                                   04070099
      *    END-IF.                                                      04080099
                                                                        04090099
750167     IF ML070-CURR-FISCAL-EXIST                                   04100099
750167         PERFORM 4000-PROCESS-RECALC                              04110099
750167     ELSE                                                         04120099
               IF ML070-CURR-END-INV-RTL-AMT   = ZEROES                 04130099
                   AND ML070-END-INV-COST-AMT2 = ZEROES                 04140099
X28582             AND ML070-ADJ-GRO-MRGN-AMT  = ZEROES                 04141099
                   ADD +1           TO PA-ZERO-REC-DROPPED              04150099
               ELSE                                                     04160099
750167             PERFORM 6100-INSERT-CARRY-FWD-ROW                    04170099
               END-IF                                                   04180099
750167     END-IF.                                                      04190099
                                                                        04200099
           PERFORM 7800-COMMIT-PROCESSING.                              04210099
                                                                        04220099
           PERFORM 7000-READ-EXTR-FILE.                                 04230099
                                                                        04240099
      ******************************************************************04250099
      * 4000-PROCESS-RECALC.                                            04260099
      ******************************************************************04270099
       4000-PROCESS-RECALC.                                             04280099
                                                                        04290099
           IF CC-ADJUST-RECALC-MODE                                     04300099
               PERFORM 6200-GET-CURRENT-ROW                             04310099
               ADD MLT00004-SHNK-RTL-AMT                                04320099
                   TO ML070-CURR-SHNK-RTL-AMT                           04330099
               ADD MLT00004-END-INV-RTL-AMT                             04340099
                   TO ML070-CURR-END-INV-RTL-AMT                        04350099
               ADD MLT00004-END-INV-COST-AMT                            04360099
                   TO ML070-CURR-END-INV-COST-AMT                       04370099
W28582         ADD MLT00004-INV-COST-ADJ1-AMT                           04371099
W28582             TO ML070-INV-COST-ADJ1                               04372099
W28582         ADD MLT00004-INV-COST-ADJ2-AMT                           04373099
W28582             TO ML070-INV-COST-ADJ2                               04374099
W28582         ADD MLT00004-END-INV-COST1-AMT                           04375099
W28582             TO ML070-END-INV-COST-AMT1                           04376099
W28582         ADD MLT00004-END-INV-COST2-AMT                           04377099
W28582             TO ML070-END-INV-COST-AMT2                           04378099
W28582         ADD MLT00004-ADJ-GRO-MRGN-AMT                            04379099
W28582             TO ML070-ADJ-GRO-MRGN-AMT                            04379199
           END-IF.                                                      04380099
                                                                        04390099
           PERFORM 6300-UPDATE-PROCESSING.                              04400099
                                                                        04410099
      ******************************************************************04420099
      * 6100-INSERT-CARRY-FWD-ROW                                       04430099
      * PERFORMED IF NO ROW IS FOUND ON DB2 (FOR THIS PROCESSING WEEK)  04440099
      * BUT INVENTORY DOLLARS (COST AND/OR RETAIL) FOUND FOR LAST WEEK  04450099
      ******************************************************************04460099
       6100-INSERT-CARRY-FWD-ROW.                                       04470099
                                                                        04480099
           INITIALIZE DCLMLT00004.                                      04490099
           MOVE ML070-PARTN-NBR           TO MLT00004-PARTN-NBR.        04500099
           MOVE ML070-DEPT-NBR            TO MLT00004-DEPT-NBR.         04510099
           MOVE ML070-MAJ-CL-NBR          TO MLT00004-MAJ-CL-NBR.       04520099
           MOVE ML070-SUB-CL-NBR          TO MLT00004-SUB-CL-NBR.       04530099
           MOVE ML070-LOC-NBR             TO MLT00004-LOC-NBR.          04540099
W28582     MOVE ML070-ML-LWST-ID          TO MLT00004-ML-LO-MDSE-LVL-ID.04550099
W28582***  MOVE ML070-ENT-ID              TO MLT00004-ENT-ID.           04551099
           MOVE ML070-FSCL-END-DTE        TO MLT00004-FSCL-MN-END-DTE.  04560099
                                                                        04570099
           MOVE ML070-CURR-SHNK-RTL-AMT     TO MLT00004-SHNK-RTL-AMT.   04580099
           MOVE ML070-CURR-END-INV-RTL-AMT                              04590099
               TO MLT00004-END-INV-RTL-AMT.                             04600099
           MOVE ML070-CURR-END-INV-COST-AMT                             04620099
               TO MLT00004-END-INV-COST-AMT.                            04630099
W28582     MOVE ML070-INV-COST-ADJ1                                     04640099
W28582         TO MLT00004-INV-COST-ADJ1-AMT.                           04641099
W28582     MOVE ML070-INV-COST-ADJ2                                     04642099
W28582         TO MLT00004-INV-COST-ADJ2-AMT.                           04643099
W28582     MOVE ML070-END-INV-COST-AMT1                                 04644099
W28582         TO MLT00004-END-INV-COST1-AMT.                           04645099
W28582     MOVE ML070-END-INV-COST-AMT2                                 04646099
W28582         TO MLT00004-END-INV-COST2-AMT.                           04647099
W28582     MOVE ML070-ADJ-GRO-MRGN-AMT                                  04648099
W28582         TO MLT00004-ADJ-GRO-MRGN-AMT.                            04649099
                                                                        04650099
           EXEC SQL                                                     04660099
               INSERT INTO MLT_MNLY_SUM                                 04670099
                    (  PARTN_NBR                                        04680099
                     , DEPT_NBR                                         04690099
                     , MAJ_CL_NBR                                       04700099
                     , SUB_CL_NBR                                       04710099
                     , LOC_NBR                                          04720099
W28582               , ML_LO_MDSE_LVL_ID                                04721099
W28582***            , ENT_ID                                           04730099
                     , FSCL_MN_END_DTE                                  04740099
                     , SLS_REG_RTL_AMT                                  04750099
                     , SLS_PROMO_RTL_AMT                                04760099
                     , SLS_PROCLR_RTL_AMT                               04770099
                     , SLS_CLR_RTL_AMT                                  04780099
                     , SLS_OTH_RTL_AMT                                  04790099
                     , MKDN_PLU_RTL_AMT                                 04800099
                     , MKDN_PROMO_RTL_AMT                               04810099
                     , MKDN_RGST_RTL_AMT                                04820099
                     , MKDN_GLDST_RTL_AMT                               04830099
                     , MKDN_UMTCH_RTL_AMT                               04840099
                     , MKDN_BYR_RTL_AMT                                 04850099
                     , MKDN_STR_RTL_AMT                                 04860099
                     , MKDN_PRPT_RTL_AMT                                04870099
                     , MKDN_OTH_RTL_AMT                                 04880099
                     , MKDN_RTL_AMT                                     04890099
                     , MKUP_RTL_AMT                                     04900099
                     , XFER_IN_RTL_AMT                                  04910099
                     , XFER_OUT_RTL_AMT                                 04920099
                     , RCPT_RTL_AMT                                     04930099
                     , RCPT_NET_COST_AMT                                04940099
                     , RCPT_GRO_COST_AMT                                04950099
                     , PADJ_RTL_AMT                                     04960099
                     , PADJ_FRGT_COST_AMT                               04970099
                     , PADJ_DISC_COST_AMT                               04980099
                     , PADJ_RTV_COST_AMT                                04990099
                     , PADJ_RTV_RTL_AMT                                 05000099
                     , PADJ_DA_COST_AMT                                 05010099
                     , PADJ_DA_RTL_AMT                                  05020099
                     , PADJ_NET_COST_AMT                                05030099
                     , PADJ_OTH_COST_AMT                                05040099
                     , PADJ_OTH_RTL_AMT                                 05050099
                     , DR_ALW_RTL_AMT                                   05060099
                     , RTV_RTL_AMT                                      05070099
                     , MKUP_INIT_AMT                                    05080099
                     , MKUP_NET_AMT                                     05090099
                     , INV_ADJ_RTL_AMT                                  05100099
                     , ONORD_RTL_AMT                                    05110099
                     , ONORD_COST_AMT                                   05120099
                     , SHNK_RTL_AMT                                     05130099
                     , END_INV_RTL_AMT                                  05140099
                     , END_INV_COST_AMT                                 05150099
W28582               , INV_COST_ADJ1_AMT                                05151099
W28582               , INV_COST_ADJ2_AMT                                05152099
W28582               , END_INV_COST1_AMT                                05153099
W28582               , END_INV_COST2_AMT                                05154099
W28582               , ADJ_GRO_MRGN_AMT )                               05155099
               VALUES (:MLT00004-PARTN-NBR                              05160099
                      ,:MLT00004-DEPT-NBR                               05170099
                      ,:MLT00004-MAJ-CL-NBR                             05180099
                      ,:MLT00004-SUB-CL-NBR                             05190099
                      ,:MLT00004-LOC-NBR                                05200099
W28582                ,:MLT00004-ML-LO-MDSE-LVL-ID                      05210099
W28582***             ,:MLT00004-ENT-ID                                 05211099
                      ,:MLT00004-FSCL-MN-END-DTE                        05220099
                      ,:MLT00004-SLS-REG-RTL-AMT                        05230099
                      ,:MLT00004-SLS-PROMO-RTL-AMT                      05240099
                      ,:MLT00004-SLS-PROCLR-RTL-AMT                     05250099
                      ,:MLT00004-SLS-CLR-RTL-AMT                        05260099
                      ,:MLT00004-SLS-OTH-RTL-AMT                        05270099
                      ,:MLT00004-MKDN-PLU-RTL-AMT                       05280099
                      ,:MLT00004-MKDN-PROMO-RTL-AMT                     05290099
                      ,:MLT00004-MKDN-RGST-RTL-AMT                      05300099
                      ,:MLT00004-MKDN-GLDST-RTL-AMT                     05310099
                      ,:MLT00004-MKDN-UMTCH-RTL-AMT                     05320099
                      ,:MLT00004-MKDN-BYR-RTL-AMT                       05330099
                      ,:MLT00004-MKDN-STR-RTL-AMT                       05340099
                      ,:MLT00004-MKDN-PRPT-RTL-AMT                      05350099
                      ,:MLT00004-MKDN-OTH-RTL-AMT                       05360099
                      ,:MLT00004-MKDN-RTL-AMT                           05370099
                      ,:MLT00004-MKUP-RTL-AMT                           05380099
                      ,:MLT00004-XFER-IN-RTL-AMT                        05390099
                      ,:MLT00004-XFER-OUT-RTL-AMT                       05400099
                      ,:MLT00004-RCPT-RTL-AMT                           05410099
                      ,:MLT00004-RCPT-NET-COST-AMT                      05420099
                      ,:MLT00004-RCPT-GRO-COST-AMT                      05430099
                      ,:MLT00004-PADJ-RTL-AMT                           05440099
                      ,:MLT00004-PADJ-FRGT-COST-AMT                     05450099
                      ,:MLT00004-PADJ-DISC-COST-AMT                     05460099
                      ,:MLT00004-PADJ-RTV-COST-AMT                      05470099
                      ,:MLT00004-PADJ-RTV-RTL-AMT                       05480099
                      ,:MLT00004-PADJ-DA-COST-AMT                       05490099
                      ,:MLT00004-PADJ-DA-RTL-AMT                        05500099
                      ,:MLT00004-PADJ-NET-COST-AMT                      05510099
                      ,:MLT00004-PADJ-OTH-COST-AMT                      05520099
                      ,:MLT00004-PADJ-OTH-RTL-AMT                       05530099
                      ,:MLT00004-DR-ALW-RTL-AMT                         05540099
                      ,:MLT00004-RTV-RTL-AMT                            05550099
                      ,:MLT00004-MKUP-INIT-AMT                          05560099
                      ,:MLT00004-MKUP-NET-AMT                           05570099
                      ,:MLT00004-INV-ADJ-RTL-AMT                        05580099
                      ,:MLT00004-ONORD-RTL-AMT                          05590099
                      ,:MLT00004-ONORD-COST-AMT                         05600099
                      ,:MLT00004-SHNK-RTL-AMT                           05610099
                      ,:MLT00004-END-INV-RTL-AMT                        05620099
                      ,:MLT00004-END-INV-COST-AMT                       05630099
W28582                ,:MLT00004-INV-COST-ADJ1-AMT                      05631099
W28582                ,:MLT00004-INV-COST-ADJ2-AMT                      05632099
W28582                ,:MLT00004-END-INV-COST1-AMT                      05633099
W28582                ,:MLT00004-END-INV-COST2-AMT                      05634099
W28582                ,:MLT00004-ADJ-GRO-MRGN-AMT )                     05635099
           END-EXEC.                                                    05640099
                                                                        05650099
750167     EVALUATE TRUE                                                05660099
750167         WHEN SQLCODE = 0                                         05670099
                   ADD 1                      TO PA-INSERT-COUNT        05680099
750182         WHEN SQLCODE = -803                                      05690099
750182             ADD 1 TO PA-DUPLICATE-REC                            05700099
750167             PERFORM 6300-UPDATE-PROCESSING                       05710099
750167         WHEN OTHER                                               05720099
                   DISPLAY ' ' PA-EXTRACT-RECS-READ                     05730099
                        ' TYPE:  ' ML070-TYPE                           05740099
                        ' PARTN: ' MLT00004-PARTN-NBR,                  05750099
                        ' DEPT:  ' MLT00004-DEPT-NBR,                   05760099
                        ' MAJCL: ' MLT00004-MAJ-CL-NBR,                 05770099
                        ' SUBCL: ' MLT00004-SUB-CL-NBR,                 05780099
                        ' LOC:   ' MLT00004-LOC-NBR,                    05790099
W28582                  ' ML-LWST-ID: ' MLT00004-ML-LO-MDSE-LVL-ID      05800099
W28582***               ' ENTID: ' MLT00004-ENT-ID                      05801099
                   MOVE '6100-INSERT-CARRY-FWD-ROW' TO PV-PARAGRAPH-NAME05810099
                   MOVE PE-MSG-14             TO PV-OPERATION-ATTEMPTED 05820099
                   PERFORM 9950-SQL-ABEND                               05830099
750167     END-EVALUATE.                                                05840099
                                                                        05850099
      ******************************************************************05860099
      * 6200-GET-CURRENT-ROW.                                           05870099
      * GET THE CURRENT VALUE FOR A GIVEN ROWS                          05880099
      ******************************************************************05890099
       6200-GET-CURRENT-ROW.                                            05900099
                                                                        05910099
           MOVE ML070-PARTN-NBR           TO MLT00004-PARTN-NBR.        05920099
           MOVE ML070-DEPT-NBR            TO MLT00004-DEPT-NBR.         05930099
           MOVE ML070-MAJ-CL-NBR          TO MLT00004-MAJ-CL-NBR.       05940099
           MOVE ML070-SUB-CL-NBR          TO MLT00004-SUB-CL-NBR.       05950099
           MOVE ML070-LOC-NBR             TO MLT00004-LOC-NBR.          05960099
W28582     MOVE ML070-ML-LWST-ID          TO MLT00004-ML-LO-MDSE-LVL-ID.05970099
W28582***  MOVE ML070-ENT-ID              TO MLT00004-ENT-ID.           05971099
                                                                        05980099
           EXEC SQL                                                     05990099
               SELECT                                                   06000099
                       SHNK_RTL_AMT                                     06010099
                      ,END_INV_RTL_AMT                                  06020099
                      ,END_INV_COST_AMT                                 06030099
W28582                ,INV_COST_ADJ1_AMT                                06031099
W28582                ,INV_COST_ADJ2_AMT                                06032099
W28582                ,END_INV_COST1_AMT                                06033099
W28582                ,END_INV_COST2_AMT                                06034099
W28582                ,ADJ_GRO_MRGN_AMT                                 06035099
                 INTO                                                   06040099
                       :MLT00004-SHNK-RTL-AMT                           06050099
                      ,:MLT00004-END-INV-RTL-AMT                        06060099
                      ,:MLT00004-END-INV-COST-AMT                       06070099
W28582                ,:MLT00004-INV-COST-ADJ1-AMT                      06071099
W28582                ,:MLT00004-INV-COST-ADJ2-AMT                      06072099
W28582                ,:MLT00004-END-INV-COST1-AMT                      06073099
W28582                ,:MLT00004-END-INV-COST2-AMT                      06074099
W28582                ,:MLT00004-ADJ-GRO-MRGN-AMT                       06075099
                 FROM                                                   06080099
                       MLT_MNLY_SUM                                     06090099
                 WHERE PARTN_NBR       = :MLT00004-PARTN-NBR            06100099
                   AND DEPT_NBR        = :MLT00004-DEPT-NBR             06110099
                   AND MAJ_CL_NBR      = :MLT00004-MAJ-CL-NBR           06120099
                   AND SUB_CL_NBR      = :MLT00004-SUB-CL-NBR           06130099
                   AND LOC_NBR         = :MLT00004-LOC-NBR              06140099
W28582             AND ML_LO_MDSE_LVL_ID = :MLT00004-ML-LO-MDSE-LVL-ID  06150099
W28582***          AND ENT_ID          = :MLT00004-ENT-ID               06151099
           END-EXEC.                                                    06160099
                                                                        06170099
           EVALUATE SQLCODE                                             06180099
               WHEN 0                                                   06190099
                    CONTINUE                                            06200099
               WHEN OTHER                                               06210099
                    DISPLAY '*************************************'     06220099
                    DISPLAY 'ROW IN PROCESS : '                         06230099
                    DISPLAY ' ' PA-EXTRACT-RECS-READ                    06240099
                         ' TYPE:  ' ML070-TYPE                          06250099
                         ' PARTN: ' MLT00004-PARTN-NBR,                 06260099
                         ' DEPT:  ' MLT00004-DEPT-NBR,                  06270099
                         ' MAJCL: ' MLT00004-MAJ-CL-NBR,                06280099
                         ' SUBCL: ' MLT00004-SUB-CL-NBR,                06290099
                         ' LOC:   ' MLT00004-LOC-NBR,                   06300099
W28582                   ' ML-LWST-ID: ' MLT00004-ML-LO-MDSE-LVL-ID     06310099
W28582***                ' ENTID: ' MLT00004-ENT-ID                     06311099
                    DISPLAY '*************************************'     06320099
                    DISPLAY 'MONTH-END-DATE : ' ML070-FSCL-END-DTE      06330099
                    MOVE PE-MSG-06        TO PV-OPERATION-ATTEMPTED     06340099
                    MOVE '6200-GET-CURRENT-ROW'                         06350099
                                          TO PV-PARAGRAPH-NAME          06360099
                    PERFORM 9950-SQL-ABEND                              06370099
           END-EVALUATE.                                                06380099
                                                                        06390099
      ******************************************************************06400099
      * 6300-UPDATE-PROCESSING.                                         06410099
      * UPDATE COLUMNS WITH VALUES JUST CALCULATED FOR THIS DEPARTMENT  06420099
      ******************************************************************06430099
       6300-UPDATE-PROCESSING.                                          06440099
                                                                        06450099
           MOVE ML070-PARTN-NBR           TO MLT00004-PARTN-NBR.        06460099
           MOVE ML070-DEPT-NBR            TO MLT00004-DEPT-NBR.         06470099
           MOVE ML070-MAJ-CL-NBR          TO MLT00004-MAJ-CL-NBR.       06480099
           MOVE ML070-SUB-CL-NBR          TO MLT00004-SUB-CL-NBR.       06490099
           MOVE ML070-LOC-NBR             TO MLT00004-LOC-NBR.          06500099
W28582     MOVE ML070-ML-LWST-ID          TO MLT00004-ML-LO-MDSE-LVL-ID.06510099
W28582***  MOVE ML070-ENT-ID              TO MLT00004-ENT-ID.           06511099
                                                                        06520099
           EXEC SQL                                                     06530099
               UPDATE MLT_MNLY_SUM                                      06540099
                  SET                                                   06550099
                       SHNK_RTL_AMT     = :ML070-CURR-SHNK-RTL-AMT      06560099
                      ,END_INV_RTL_AMT  = :ML070-CURR-END-INV-RTL-AMT   06570099
                      ,END_INV_COST_AMT = :ML070-CURR-END-INV-COST-AMT  06580099
W28582                ,INV_COST_ADJ1_AMT = :ML070-INV-COST-ADJ1         06581099
W28582                ,INV_COST_ADJ2_AMT = :ML070-INV-COST-ADJ2         06582099
W28582                ,END_INV_COST1_AMT = :ML070-END-INV-COST-AMT1     06583099
W28582                ,END_INV_COST2_AMT = :ML070-END-INV-COST-AMT2     06584099
W28582                ,ADJ_GRO_MRGN_AMT  = :ML070-ADJ-GRO-MRGN-AMT      06585099
                 WHERE PARTN_NBR       = :MLT00004-PARTN-NBR            06590099
                   AND DEPT_NBR        = :MLT00004-DEPT-NBR             06600099
                   AND MAJ_CL_NBR      = :MLT00004-MAJ-CL-NBR           06610099
                   AND SUB_CL_NBR      = :MLT00004-SUB-CL-NBR           06620099
                   AND LOC_NBR         = :MLT00004-LOC-NBR              06630099
W28582             AND ML_LO_MDSE_LVL_ID = :MLT00004-ML-LO-MDSE-LVL-ID  06640099
W28582***          AND ENT_ID          = :MLT00004-ENT-ID               06641099
           END-EXEC.                                                    06650099
                                                                        06660099
           EVALUATE SQLCODE                                             06670099
               WHEN 0                                                   06680099
                    ADD 1                TO PA-UPDATE-COUNT             06690099
               WHEN OTHER                                               06700099
                    DISPLAY '*************************************'     06710099
                    DISPLAY 'ROW IN PROCESS : '                         06720099
                    DISPLAY ' ' PA-EXTRACT-RECS-READ                    06730099
                         ' TYPE:  ' ML070-TYPE                          06740099
                         ' PARTN: ' MLT00004-PARTN-NBR,                 06750099
                         ' DEPT:  ' MLT00004-DEPT-NBR,                  06760099
                         ' MAJCL: ' MLT00004-MAJ-CL-NBR,                06770099
                         ' SUBCL: ' MLT00004-SUB-CL-NBR,                06780099
                         ' LOC:   ' MLT00004-LOC-NBR,                   06790099
W28582                   ' ML-LWST-ID: ' MLT00004-ML-LO-MDSE-LVL-ID     06800099
W28582***                ' ENTID: ' MLT00004-ENT-ID                     06801099
                    DISPLAY '*************************************'     06810099
                    DISPLAY 'MONTH-END-DATE : ' ML070-FSCL-END-DTE      06820099
                    MOVE PE-MSG-06        TO PV-OPERATION-ATTEMPTED     06830099
                    MOVE '6300-UPDATE-PROCESSING'                       06840099
                                          TO PV-PARAGRAPH-NAME          06850099
                    PERFORM 9950-SQL-ABEND                              06860099
           END-EVALUATE.                                                06870099
                                                                        06880099
      ******************************************************************06890099
      * 7000-READ-EXTR-FILE.                                            06900099
      ******************************************************************06910099
       7000-READ-EXTR-FILE.                                             06920099
                                                                        06930099
           READ RECALC-EXTR-FILE INTO ML070-COMMON-RECALC-EXTRACT       06940099
               AT END                                                   06950099
                  SET PS-EOF-EXTR-FILE TO TRUE.                         06960099
                                                                        06970099
                                                                        06980099
      ******************************************************************06990099
      * READS THE PROCESSING JOB NAME CONTROL CARD FILE.                07000099
      ******************************************************************07010099
       7100-READ-PROCESS-JOB-NAME.                                      07020099
           READ CC-PGM-MODE-CNTL-FILE INTO CC-CONTROL-CARD-REC          07030099
               AT END                                                   07040099
               SET MISSING-CONTROL-ABEND  TO TRUE                       07050099
               PERFORM 9999-ABEND.                                      07060099
                                                                        07070099
      ******************************************************************07080099
      * 7600-GET-COMMIT-TIMESTAMP.                                     *07090099
      *   GET THE TIMESTAMP FROM THE CHECKPOINT TABLE FOR NEXT COMMIT  *07100099
      ******************************************************************07110099
       7600-GET-COMMIT-TIMESTAMP.                                       07120099
                                                                        07130099
           EXEC SQL                                                     07140099
             SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)       07150099
               INTO :PV-COMMIT-TIMESTAMP                                07160099
               FROM TCKRSTCNTL                                          07170099
              WHERE JOB_NAME  = :CC-JOB-NAME                            07180099
                AND PLAN_NAME = :PC-PROGRAM-NAME                        07190099
           END-EXEC.                                                    07200099
                                                                        07210099
           EVALUATE TRUE                                                07220099
               WHEN SQLCODE = 0                                         07230099
                   CONTINUE                                             07240099
               WHEN SQLCODE NOT EQUAL ZERO                              07250099
                   DISPLAY ' JOB: ' CC-JOB-NAME                         07260099
                           ' PROGRAM: ' PC-PROGRAM-NAME                 07270099
                   MOVE '7600-GET-COMMIT-TIMESTAMP' TO PV-PARAGRAPH-NAME07280099
                   MOVE PE-MSG-07             TO PV-OPERATION-ATTEMPTED 07290099
                   PERFORM 9950-SQL-ABEND                               07300099
           END-EVALUATE.                                                07310099
      *                                                                 07320099
      ******************************************************************07330099
      * 7650-INIT-CHECKPOINT-SELECT                                    *07340099
      * CHECK STATUS CODE TO SEE IF THIS IS A RESTART CONDITION        *07350099
      ******************************************************************07360099
       7650-INIT-CHECKPOINT-SELECT.                                     07370099
      *                                                                 07380099
           EXEC SQL                                                     07390099
             SELECT  CKPT_STAT_CODE                                     07400099
                    ,CKPT_FRQNCY_QTY                                    07410099
               INTO  :TCKRSTCNTL-CKPT-STAT-CODE                         07420099
                    ,:TCKRSTCNTL-CKPT-FRQNCY-QTY                        07430099
               FROM  TCKRSTCNTL                                         07440099
              WHERE  JOB_NAME  = :CC-JOB-NAME                           07450099
                AND  PLAN_NAME = :PC-PROGRAM-NAME                       07460099
           END-EXEC.                                                    07470099
      *                                                                 07480099
           IF SQLCODE = 0                                               07490099
               CONTINUE                                                 07500099
           ELSE                                                         07510099
               DISPLAY ' JOB: ' CC-JOB-NAME                             07520099
                       ' PROGRAM: ' PC-PROGRAM-NAME                     07530099
               MOVE '7650-INIT-CHECKPOINT-SELECT' TO PV-PARAGRAPH-NAME  07540099
               MOVE PE-MSG-07             TO PV-OPERATION-ATTEMPTED     07550099
               PERFORM 9950-SQL-ABEND                                   07560099
           END-IF.                                                      07570099
                                                                        07580099
      ******************************************************************07590099
      * 7700-SELECT-RESTART-INFO                                       *07600099
      * OBTAIN INFORMATION REGARDING WHERE TO RESTART TABLE PROCESSING *07610099
      ******************************************************************07620099
       7700-SELECT-RESTART-INFO.                                        07630099
      *                                                                 07640099
           EXEC SQL                                                     07650099
             SELECT  WORK_STRG_DESC                                     07660099
               INTO  :TCKRSTINF-WORK-STRG-DESC                          07670099
               FROM  TCKRSTINF                                          07680099
              WHERE  JOB_NAME  = :CC-JOB-NAME                           07690099
                AND  PLAN_NAME = :PC-PROGRAM-NAME                       07700099
           END-EXEC.                                                    07710099
      *                                                                 07720099
           IF SQLCODE = 0                                               07730099
               CONTINUE                                                 07740099
           ELSE                                                         07750099
               DISPLAY ' JOB: ' CC-JOB-NAME                             07760099
                       ' PROGRAM: ' PC-PROGRAM-NAME                     07770099
               MOVE '*7700-SELECT-RESTART-INFO*' TO PV-PARAGRAPH-NAME   07780099
               MOVE PE-MSG-11             TO PV-OPERATION-ATTEMPTED     07790099
               PERFORM 9950-SQL-ABEND                                   07800099
           END-IF.                                                      07810099
                                                                        07820099
      ******************************************************************07830099
      * 7750-SET-CURRENT-TIMESTAMP.                                    *07840099
      * CURRENT TIMESTAMP SET TO BE COMPARED TO COMMIT TIMESTAMP       *07850099
      ******************************************************************07860099
       7750-SET-CURRENT-TIMESTAMP.                                      07870099
                                                                        07880099
           EXEC SQL                                                     07890099
                SET :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP           07900099
           END-EXEC.                                                    07910099
                                                                        07920099
           IF SQLCODE = 0                                               07930099
               CONTINUE                                                 07940099
           ELSE                                                         07950099
               MOVE PE-MSG-12             TO PV-OPERATION-ATTEMPTED     07960099
               MOVE '*7750-SET-CURRENT-TIMESTAMP*' TO PV-PARAGRAPH-NAME 07970099
               PERFORM 9950-SQL-ABEND                                   07980099
           END-IF.                                                      07990099
                                                                        08000099
      ******************************************************************08010099
      * 7800-COMMIT-PROCESSING.                                        *08020099
      * COMPARE COMMIT TIMESTAMP TO CURRENT TO DETERMINE IF COMMIT REQD*08030099
      ******************************************************************08040099
       7800-COMMIT-PROCESSING.                                          08050099
           MOVE '*7800-COMMIT-PROCESSING*'    TO PV-PARAGRAPH-NAME.     08060099
                                                                        08070099
           PERFORM 7750-SET-CURRENT-TIMESTAMP.                          08080099
                                                                        08090099
           IF (PV-CURRENT-TIMESTAMP > PV-COMMIT-TIMESTAMP)  OR          08100099
              (PS-EOF-EXTR-FILE)                                        08110099
      * PREPARE COMMIT RECORD FOR UPDATE                                08120099
               ADD 1                          TO PA-COMMIT-COUNT        08130099
               MOVE ML070-FSCL-END-DTE        TO CR-FISCAL-MN-END-DTE   08140099
               MOVE ML070-PARTN-NBR           TO CR-PARTN-NBR           08150099
               MOVE ML070-DEPT-NBR            TO CR-DEPT-NBR            08160099
               MOVE ML070-MAJ-CL-NBR          TO CR-MAJ-CL-NBR          08170099
               MOVE ML070-SUB-CL-NBR          TO CR-SUB-CL-NBR          08180099
               MOVE ML070-LOC-NBR             TO CR-LOC-NBR             08190099
W28582         MOVE ML070-ML-LWST-ID          TO CR-ML-LWST-ID          08200099
W28582***      MOVE ML070-ENT-ID              TO CR-ENT-ID              08201099
               MOVE PA-EXTRACT-RECS-READ      TO CR-MNLYSUM-INPUT-COUNT 08210099
               MOVE PA-UPDATE-COUNT           TO CR-MNLYSUM-UPDATE-COUNT08220099
               MOVE PA-INSERT-COUNT           TO CR-MNLYSUM-INSERT-COUNT08230099
               MOVE PA-COMMIT-COUNT           TO CR-MNLYSUM-COMMIT-COUNT08240099
               MOVE PA-ZERO-REC-DROPPED       TO CR-ZERO-REC-DROPPED    08250099
               MOVE PA-DUPLICATE-REC          TO CR-DUPLICATE-REC       08260099
      * MOVE COMMIT INFO TO WORKING STORAGE ROW                         08270099
               MOVE CR-CHECKPOINT-RESTART-AREA TO                       08280099
                                                TCKRSTINF-WORK-STRG-DESC08290099
               MOVE 'Y' TO PS-COMMIT-TAKEN-SW                           08300099
               IF PS-FIRST-COMMIT                                       08310099
                   MOVE '9' TO TCKRSTCNTL-CKPT-STAT-CODE                08320099
                   PERFORM 7900-UPDATE-CHECKPOINT-STATUS                08330099
                   MOVE 'N' TO PS-FIRST-COMMIT-SW                       08340099
               END-IF                                                   08350099
                                                                        08360099
               PERFORM 7850-COMMIT-CHANGES                              08370099
                                                                        08380099
               PERFORM 7600-GET-COMMIT-TIMESTAMP                        08390099
                                                                        08400099
           END-IF.                                                      08410099
                                                                        08420099
      ******************************************************************08430099
      * 7850-COMMIT-CHANGES.                                            08440099
      * UPDATE CHECKPOINT INFORMATION TABLE. TAKE A COMMIT.             08450099
      ******************************************************************08460099
       7850-COMMIT-CHANGES.                                             08470099
                                                                        08480099
           EXEC SQL                                                     08490099
             UPDATE TCKRSTINF                                           08500099
                SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC          08510099
              WHERE JOB_NAME       = :CC-JOB-NAME                       08520099
                AND PLAN_NAME      = :PC-PROGRAM-NAME                   08530099
           END-EXEC.                                                    08540099
                                                                        08550099
           IF SQLCODE = 0                                               08560099
               CONTINUE                                                 08570099
           ELSE                                                         08580099
               DISPLAY ' JOB: ' CC-JOB-NAME                             08590099
                       ' PROGRAM: ' PC-PROGRAM-NAME                     08600099
               MOVE PE-MSG-08                  TO PV-OPERATION-ATTEMPTED08610099
               MOVE  '* 7850-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     08620099
               PERFORM 9950-SQL-ABEND                                   08630099
           END-IF.                                                      08640099
                                                                        08650099
           EXEC SQL                                                     08660099
               COMMIT                                                   08670099
           END-EXEC.                                                    08680099
                                                                        08690099
           IF SQLCODE = 0                                               08700099
               CONTINUE                                                 08710099
           ELSE                                                         08720099
               MOVE PE-MSG-09                  TO PV-OPERATION-ATTEMPTED08730099
               MOVE  '* 7850-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     08740099
               PERFORM 9950-SQL-ABEND                                   08750099
           END-IF.                                                      08760099
                                                                        08770099
      ******************************************************************08780099
      * UPDATE CHECKPOINT STATUS                                        08790099
      ******************************************************************08800099
       7900-UPDATE-CHECKPOINT-STATUS.                                   08810099
                                                                        08820099
           EXEC SQL                                                     08830099
             UPDATE  TCKRSTCNTL                                         08840099
                SET  CKPT_STAT_CODE = :TCKRSTCNTL-CKPT-STAT-CODE        08850099
              WHERE  JOB_NAME  = :CC-JOB-NAME                           08860099
                AND  PLAN_NAME = :PC-PROGRAM-NAME                       08870099
           END-EXEC.                                                    08880099
                                                                        08890099
           IF SQLCODE = 0                                               08900099
               CONTINUE                                                 08910099
           ELSE                                                         08920099
               DISPLAY ' JOB: ' CC-JOB-NAME                             08930099
                       ' PROGRAM: ' PC-PROGRAM-NAME                     08940099
               MOVE '7900-UPDATE-CHECKPOINT-STATUS' TO PV-PARAGRAPH-NAME08950099
               MOVE PE-MSG-10                  TO PV-OPERATION-ATTEMPTED08960099
               PERFORM 9950-SQL-ABEND                                   08970099
           END-IF.                                                      08980099
                                                                        08990099
      /*****************************************************************09000099
      * 9000-EOJ-ROUTINE.                                               09010099
      * RESET STATUS CODE, DISPLAY FINAL COUNTS , CLOSE INPUT FILE      09020099
      ******************************************************************09030099
       9000-EOJ-ROUTINE.                                                09040099
                                                                        09050099
           PERFORM 7800-COMMIT-PROCESSING                               09060099
                                                                        09070099
           MOVE '0' TO TCKRSTCNTL-CKPT-STAT-CODE.                       09080099
           PERFORM 7900-UPDATE-CHECKPOINT-STATUS.                       09090099
           CLOSE CC-PGM-MODE-CNTL-FILE                                  09100099
                 RECALC-EXTR-FILE.                                      09110099
      *                                                                 09120099
           DISPLAY '                                             '.     09130099
           DISPLAY '******* END OF JOB STATISTICS ********'.            09140099
           DISPLAY '                                             '.     09150099
           DISPLAY 'INPUT EXTRACT RECORDS READ ' PA-EXTRACT-RECS-READ.  09160099
           DISPLAY '  MNLYSUM ROWS UPDATED   ', PA-UPDATE-COUNT.        09170099
           DISPLAY '  MNLYSUM ROWS INSERTED  ', PA-INSERT-COUNT.        09180099
           DISPLAY '  ZERO CARRY FWD DROPPED ' PA-ZERO-REC-DROPPED.     09190099
           DISPLAY '  DUPLICATE REC          ' PA-DUPLICATE-REC.        09200099
           DISPLAY '                                             '.     09210099
           DISPLAY '  COMMITS TAKEN         ', PA-COMMIT-COUNT.         09220099
           DISPLAY '                                             '.     09230099
           DISPLAY 'EOJ EOJ EOJ EOJ EOJ EOJ EOJ EOJ EOJ EOJ EOJ EOJ '.  09240099
                                                                        09250099
      ******************************************************************09260099
      * 9950-SQL-ABEND.                                                 09270099
      *  STANDARD DB2 ERROR ABEND ROUTINE                               09280099
      *  THIS ROUTINE FORCES AN ABEND DUE TO A DB2 PROBLEM.             09290099
      ******************************************************************09300099
       9950-SQL-ABEND.                                                  09310099
                                                                        09320099
           SET SQL-ABEND              TO TRUE.                          09330099
           DISPLAY '**  ABEND     **'.                                  09340099
           DISPLAY '**  OPERATION **  = ' PV-OPERATION-ATTEMPTED.       09350099
                                                                        09360099
      *    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE         09370099
      *    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.        09380099
                                                                        09390099
           COPY DPPD004.                                                09400099
                                                                        09410099
           PERFORM 9999-ABEND.                                          09420099
                                                                        09430099
      ******************************************************************09440099
      * 9999-ABEND.                                                     09450099
      *  STANDARD ABEND ROUTINE                                         09460099
      ******************************************************************09470099
       9999-ABEND.                                                      09480099
           DISPLAY '**  PROGRAM   ** => ' PC-PROGRAM-NAME.              09490099
           DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            09500099
                                                                        09510099
           CALL 'ILBOABN0'  USING ABEND-CODE.                           09520099
                                                                        09530099
                                                                        09540099
