000200******************************************************************00010038
001000 IDENTIFICATION DIVISION.                                         00020038
001100******************************************************************00030038
001200*                                                                 00040038
001300*    WEEKLY FLASH SALES LOAD PROCESS - ML ADJUSTED NUMBERS        00050038
001400*                                                                 00060038
001500******************************************************************00070038
001600 PROGRAM-ID.             DFKUP004.                                00080052
001700 AUTHOR.                 DOUG JONES.                              00090038
001800 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00100038
001900 DATE-WRITTEN.           09-13-2004.                              00110038
002000 DATE-COMPILED.                                                   00120038
002100******************************************************************00130038
002200* THIS PROGRAM USE THE DATA AS SENT WEEK BY ML TO LOAD/UPDATE THE 00140038
002300* ML FINANCIAL FLASH SUMMARY TABLE WITH ADJUSTED FIGURES TO BE    00150038
002400* USED FOR FLASH REPORTING.                                       00160038
002400*                                                                 00161071
002400* 07/01/2020  JEAN KURK  FIX COMMIT LOGIC                         00162077
002400*                                                                 00162178
260107* CHG0260107 - 08/18/21  JIM HUNTER                               00163078
260107* ADDING COPYBOOK DPWS991 TO MAKE CALL TO DPKUT901 DYNAMIC.       00164078
002500******************************************************************00170038
002600 ENVIRONMENT DIVISION.                                            00180038
002700******************************************************************00190038
002800 CONFIGURATION SECTION.                                           00200038
002900 SOURCE-COMPUTER.        IBM-3090.                                00210038
003000 OBJECT-COMPUTER.        IBM-3090.                                00220038
003100 INPUT-OUTPUT SECTION.                                            00230038
003200 FILE-CONTROL.                                                    00240038
003300                                                                  00250038
003301*    INP01 IS USED BY DPKUT901                                    00251073
003400     SELECT DATE-CONTROL-FILE                                     00260038
003500         ASSIGN TO INP02.                                         00270072
005600     SELECT COMMIT-CARD-FILE                                      00280071
005700         ASSIGN TO INP03.                                         00290073
003800                                                                  00300038
003900******************************************************************00310038
004000 DATA DIVISION.                                                   00320038
004100******************************************************************00330038
004200 FILE SECTION.                                                    00340038
004300 FD  DATE-CONTROL-FILE                                            00350038
004400     RECORDING MODE F                                             00360038
004500     BLOCK CONTAINS 0 RECORDS                                     00370038
004600     LABEL RECORDS ARE OMITTED.                                   00380038
004700 01  DATE-CONTROL-RECORD              PIC  X(80).                 00390038
010000                                                                  00390171
009600 FD  COMMIT-CARD-FILE                                             00391071
009700     RECORDING MODE IS F                                          00392071
009800     BLOCK CONTAINS 0 RECORDS                                     00393071
009900     LABEL RECORDS ARE STANDARD.                                  00394071
010000                                                                  00395071
010200 01  COMMIT-CARD-RECORD              PIC X(80).                   00396071
004800                                                                  00400038
005500 WORKING-STORAGE SECTION.                                         00470038
005600 01  FILLER                           PIC X(41)                   00480038
005700     VALUE 'WORKING STORAGE STARTS HERE FOR DFKUP004'.            00490052
004800                                                                  00490154
004400***************************************************************** 00491054
004500*                         SWITCHES                                00492054
004600***************************************************************** 00493054
004700 01  PROGRAM-SWITCHES.                                            00494054
004800     05  PS-RESTART-REQUIRED-SW       PIC  X(01) VALUE 'N'.       00495054
004900         88  PS-RESTART-REQUIRED                 VALUE 'Y'.       00496054
005000         88  PS-RESTART-NOT-REQUIRED             VALUE 'N'.       00497054
005100                                                                  00498054
005200******************************************************************00499054
005300*                       ACCUMULATORS                              00499154
005400******************************************************************00499254
005500 01  PROGRAM-ACCUM.                                               00499354
005600     05  PA-READ                      PIC  9(11) VALUE ZEROS.     00499454
005700     05  PA-CKPT                      PIC  9(11) VALUE ZEROS.     00499554
           05  PA-INPUT-COUNT               PIC  9(9)  VALUE ZEROES.    00499662
005800                                                                  00499854
005900******************************************************************00499954
006000*                           CONSTANTS                             00500054
006100******************************************************************00500154
006200 01  PROGRAM-CONSTANTS.                                           00500254
006300     05  PC-MAX-RETRIES               PIC S9(04) VALUE +3         00500354
006400                                                 COMP SYNC.       00500454
006500     05  PC-MAX-DEADLOCKS             PIC S9(04) VALUE +3         00500554
006600                                                 COMP SYNC.       00500654
006700                                                                  00500754
006800     05  PC-CKPT-JOB-NAME             PIC  X(08) VALUE 'DFK105  '.00500858
006900     05  PC-CKPT-PLAN-NAME            PIC  X(08) VALUE 'DFKUP004'.00500955
007000     05  PC-PROGRAM-NAME              PIC  X(08) VALUE 'DFKUP004'.00501055
007100                                                                  00501154
007200     05  PC-TRAN-PRES-FUNC-CODES.                                 00501254
007300         10  PC-TRAN-PRES-FUNC-OPEN   PIC  X(05) VALUE 'OPEN '.   00501354
007400         10  PC-TRAN-PRES-FUNC-TRANS  PIC  X(05) VALUE 'TRANS'.   00501454
007500         10  PC-TRAN-PRES-FUNC-RSTRT  PIC  X(05) VALUE 'RSTRT'.   00501554
007600         10  PC-TRAN-PRES-FUNC-CLOSE  PIC  X(05) VALUE 'CLOSE'.   00501654
               10  PC-TRAN-PRES-FUNC-CKPT   PIC  X(05) VALUE 'CKPT '.   00501767
007700                                                                  00501854
007800     05  PC-MINUS-ONE                 PIC S9(01) VALUE -1.        00501954
007900     05  PC-SYSTEM                    PIC  X(08) VALUE 'SYSTEM  '.00502054
008000                                                                  00502154
008100******************************************************************00502254
008200*                          VARIABLES                              00502354
008300******************************************************************00502454
008400 01  PROGRAM-VARIABLES.                                           00502554
008500     05  PV-SQL-SUB                   PIC  9(03) VALUE ZERO.      00502654
008600     05  PV-DEADLOCK-COUNTER          PIC  9(03) VALUE ZERO.      00502754
008700     05  PV-PARAGRAPH-NAME            PIC  X(30) VALUE SPACE.     00502854
008800     05  PV-DB2-OPER-ATTEMPTED        PIC  X(30) VALUE SPACE.     00502954
008900     05  PV-OPERATION-MSG             PIC  X(35) VALUE SPACE.     00503054
009000     05  PV-RET-CODE                  PIC  9(04) VALUE ZEROS.     00503154
009100                                                                  00503254
009200******************************************************************00503354
009300*               SYSTEM TIME AND DATE VARIABLES                    00503454
009400******************************************************************00503554
009500 01  SYS-DATE-TIME.                                               00503654
009600     05  SYS-DATE                     PIC  X(08) VALUE SPACES.    00503754
009700     05  SYS-TIME                     PIC  X(08) VALUE SPACES.    00503854
009800                                                                  00503954
009900 01  ST-BEG-TIME.                                                 00504054
010000     05  ST-BEG-HR                    PIC  9(02) VALUE ZEROS.     00504154
010100     05  FILLER                       PIC  X(01) VALUE ':'.       00504254
010200     05  ST-BEG-MN                    PIC  9(02) VALUE ZEROS.     00504354
010300                                                                  00504454
010400 01  ST-END-TIME.                                                 00504554
010500     05  ST-END-HR                    PIC  9(02) VALUE ZEROS.     00504654
010600     05  FILLER                       PIC  X(01) VALUE ':'.       00504754
010700     05  ST-END-MN                    PIC  9(02) VALUE ZEROS.     00504854
010800                                                                  00504954
010900 01  SD-EDIT-DATE.                                                00505054
011000     05  SD-MONTH                     PIC  9(02) VALUE ZEROS.     00505154
011100     05  FILLER                       PIC  X(01) VALUE '-'.       00505254
011200     05  SD-DAY                       PIC  9(02) VALUE ZEROS.     00505354
011300     05  FILLER                       PIC  X(01) VALUE '-'.       00505454
011400     05  SD-CENT                      PIC  9(02) VALUE ZEROS.     00505554
011500     05  SD-YEAR                      PIC  9(02) VALUE ZEROS.     00505654
011600                                                                  00505754
011700******************************************************************00505854
011800*                        ERROR HANDLING                           00505954
011900******************************************************************00506054
012000 01  ABEND-CODE                       PIC S9(04) VALUE ZEROS      00506154
012100                                                 COMP SYNC.       00506254
012200     88  ABEND-4002-READ-ERROR                   VALUE +4002.     00506354
012300     88  ABEND-4013-DB2-ERROR                    VALUE +4013.     00506454
012400     88  ABEND-4019-CAL-SUB-ERROR                VALUE +4019.     00506554
012500                                                                  00506654
005800 01  AC-ABEND-CODE                 PIC S9(4) COMP SYNC VALUE ZERO.00507038
005900     88  AC-CONTROL-CARD-ERROR                   VALUE +4003.     00510038
006000     88  AC-INVALID-DATE-ERROR                   VALUE +4004.     00520038
006100     88  AC-DB2-ERROR                            VALUE +4013.     00530038
006200                                                                  00540038
006300 01 PC-CONSTANTS.                                                 00550038
006400     05  PC-PGM-NAME               PIC X(08)     VALUE 'DFKUP004'.00560052
006600     05  PC-ROW-NOT-FOUND          PIC S9(04)     VALUE +100      00570038
006700                                                  COMP SYNC.      00580038
006710     05  PC-ROW-FOUND              PIC S9(04)  VALUE +0           00590038
006720                                                 COMP SYNC.       00600038
012600*    05  PC-COMMIT-MAX             PIC 9(9)       VALUE 250.      00610071
006800 01  PV-PROGRAM-VARIABLES.                                        00620038
006900     05  PV-DEPT-NBR-NUMERIC       PIC  9(04)     VALUE ZEROES.   00640038
007004     05  PV-SAVE-STR               PIC S9(04)     COMP            00650038
007005                                                  VALUE ZEROES.   00660038
007006     05  PV-SAVE-DEPT              PIC  X(03)     VALUE SPACES.   00670038
007010     05  PV-DEPT-NBR-COMP          PIC S9(04)V    COMP-3          00680038
007100                                                  VALUE ZEROES.   00690038
007200     05  PV-DB2-OPERATION          PIC  X(30)     VALUE SPACES.   00700038
007210     05  PV-TEMP-TOT-SLS-AMT       PIC  S9(07)V99 COMP-3          00710038
007220                                                  VALUE ZEROES.   00720038
015400     05  PV-CNT-SINCE-COMMIT       PIC  9(9)      VALUE 0.        00721038
007300     05  PV-INCREMENTING-DATE      PIC  X(10)     VALUE SPACES.   00722038
007301     05  PV-ROLLING-DATE           PIC  X(10)     VALUE SPACES.   00723038
007303     05  PV-ROLLING-DATE-SAVED     PIC  X(10)     VALUE SPACES.   00724038
007310     05  PV-COMPARE-DATE           PIC  X(10)     VALUE SPACES.   00725038
007400     05  PV-CONTROL-DATE.                                         00726038
007500         10  PV-CNTL-CC            PIC X(02)      VALUE '20'.     00727038
007600         10  PV-CNTL-YY            PIC X(02).                     00728038
007700         10  PV-CNTL-MM            PIC X(02).                     00729038
007800         10  PV-CNTL-DD            PIC X(02).                     00730038
008100                                                                  00740038
008200     05  PV-CONTROL-DATE-FMT.                                     00750038
008300         10 PV-CNTL-DATE-CC        PIC 9(02)      VALUE 20.       00760038
008400         10 PV-CNTL-DATE-YY        PIC 9(02)      VALUE ZEROES.   00770038
008500         10 FILLER                 PIC X          VALUE '-'.      00780038
008600         10 PV-CNTL-DATE-MM        PIC 9(02)      VALUE ZEROES.   00790038
008700         10 FILLER                 PIC X          VALUE '-'.      00800038
008800         10 PV-CNTL-DATE-DD        PIC 9(02)      VALUE ZEROES.   00810038
008900                                                                  00820038
009000     05  PV-SAVED-INFO.                                           00830038
009100        10  PV-SAVED-DTE           PIC X(10)      VALUE SPACES.   00840038
009200        10  PV-SAVED-DEPT          PIC S9(4)V     COMP-3          00850038
009300                                                  VALUE ZEROS.    00860038
009400        10  PV-SAVED-STR           PIC S9(4)      COMP            00870038
009500                                                  VALUE ZEROS.    00880038
009600        10  PV-SAVED-DLYSLS        PIC S9(11)V9(2) COMP-3         00890038
009700                                                  VALUE ZEROS.    00900038
010800                                                                  00910038
010900     05  PV-CUR-DTE                PIC X(10)      VALUE SPACES.   00920038
011000     05  PV-CUR-WTD-BEG-DATE       PIC X(10)      VALUE SPACES.   00930038
011100     05  PV-CUR-WTD-END-DATE       PIC X(10)      VALUE SPACES.   00940038
011200     05  PV-CUR-MTD-BEG-DATE       PIC X(10)      VALUE SPACES.   00950038
011300     05  PV-CUR-MTD-END-DATE       PIC X(10)      VALUE SPACES.   00960038
011400     05  PV-CUR-QTD-BEG-DATE       PIC X(10)      VALUE SPACES.   00970038
011500     05  PV-CUR-QTD-END-DATE       PIC X(10)      VALUE SPACES.   00980038
011600     05  PV-CUR-STD-BEG-DATE       PIC X(10)      VALUE SPACES.   00990038
011700     05  PV-CUR-STD-END-DATE       PIC X(10)      VALUE SPACES.   01000038
011800     05  PV-CUR-YTD-BEG-DTE        PIC X(10)      VALUE SPACES.   01010038
011900     05  PV-CUR-YTD-END-DTE        PIC X(10)      VALUE SPACES.   01020038
012000                                                                  01030038
012200 01  PS-PROGRAM-SWITCHES.                                         01040038
012210     05  PS-END-OF-TABLE-SW            PIC X(01)  VALUE 'N'.      01050038
012220         88  PS-END-OF-TABLE                      VALUE 'Y'.      01060038
012500     05  PS-UPDATE-ML-SALES-SW         PIC X(01)  VALUE 'N'.      01090038
012600         88  PS-UPDATE-ML-SALES                   VALUE 'Y'.      01100038
012700         88  PS-NO-UPDATE-ML-SALES                VALUE 'N'.      01110038
012800     05  PS-ML-HISTORICAL-SALES-SW     PIC X(01)  VALUE 'N'.      01120038
012900         88  PS-ML-HIST-SLS-MISSING               VALUE 'Y'.      01130038
013000         88  PS-NO-MISSING-HIST-ML-SLS            VALUE 'N'.      01140038
013100     05  PS-ROLL-HISTORY-FWD-SW        PIC X(01)  VALUE 'N'.      01150038
013200         88  PS-ROLL-HISTORY-FORWARD              VALUE 'Y'.      01160038
013300         88  PS-DO-NOT-ROLL-HISTORY-FORWARD       VALUE 'N'.      01170038
013400     05  PS-HISTORY-TO-UPDATE-SW       PIC X(01)  VALUE 'N'.      01180038
013500         88  PS-HISTORY-TO-UPDATE                 VALUE 'Y'.      01190038
013600         88  PS-NO-HISTORY-TO-UPDATE              VALUE 'N'.      01200038
013700     05  PS-HISTORY-PRIOR-YR-SW        PIC X(01)  VALUE 'N'.      01210038
013800         88  PS-HISTORY-PRIOR-YR                  VALUE 'Y'.      01220038
013900         88  PS-HISTORY-NOT-PRIOR-YR              VALUE 'N'.      01230038
016900     05  PS-END-OF-CARD-FILE           PIC  X(01) VALUE 'N'.      01231071
017500         88  PS-END-OF-CARD-NO                    VALUE 'N'.      01232071
017500         88  PS-END-OF-CARD-YES                   VALUE 'Y'.      01233071
014000                                                                  01240038
014100 01 CD-CONTROL-DATE.                                              01250038
014200     05  FILLER                    PIC X(14).                     01260038
014300     05  CD-POS-DATE-MDY           PIC X(6).                      01270038
014400     05  FILLER                    REDEFINES CD-POS-DATE-MDY.     01280038
014500         10  CD-POS-MONTH          PIC X(2).                      01290038
014600         10  CD-POS-DAY            PIC X(2).                      01300038
014700         10  CD-POS-YEAR           PIC X(2).                      01310038
014800     05  FILLER                    PIC X(60).                     01320038
014900                                                                  01330038
015000*  DCLGEN FOR THE DAILY FLASH ML FINANCIAL SUMMARY TABLE.         01340038
015100*                                                                 01350038
015200     EXEC SQL                                                     01360038
015300        INCLUDE DFT00002                                          01370038
015400     END-EXEC.                                                    01380038
015500                                                                  01390038
015600*  DB2 COMMUNICATION AREA                                         01400038
015700     EXEC SQL                                                     01410038
015800        INCLUDE SQLCA                                             01420038
015900     END-EXEC.                                                    01430038
016000                                                                  01440038
016100*---------------------------------------------                    01450038
016110*   DFT TABLE CURSOR  DB2 SELECT  (MAIN CURSOR)                   01460038
016120*---------------------------------------------                    01470038
016130     EXEC SQL                                                     01480038
016140       DECLARE DFT-TABLE-CURSOR CURSOR WITH HOLD FOR              01490038
016150           SELECT SLS_DTE,                                        01500038
016151                  STR_NBR,                                        01510038
016152                  DEPT_NBR,                                       01520038
016153                  DLY_DOL_AMT,                                    01530038
016154                  WTD_DOL_AMT,                                    01540038
016155                  MTD_DOL_AMT,                                    01550038
016156                  QTD_DOL_AMT,                                    01560038
016157                  S_T_D_DOL_AMT,                                  01570038
016158                  YTD_DOL_AMT                                     01580038
016159        FROM DFT_ML_FINCL_SUM   DFT                               01590038
016160        WHERE DFT.SLS_DTE = :PV-ROLLING-DATE-SAVED                01600038
016161        WITH UR                                                   01610076
016162     END-EXEC.                                                    01611038
016163                                                                  01612038
016170******************************************************************01613038
016200*    ML SALES FILE LAYOUT                                        *01614038
016300******************************************************************01615038
016400     COPY DFRD005.                                                01616038
016500                                                                  01617038
012100******************************************************************01617171
012200* RECORD LAYOUT FOR INPUT CARD - COMMIT COUNT                     01617271
012300******************************************************************01617371
012400 01  CC-CONTROL-CARD.                                             01617471
012600     05  CC-COMMIT-CNT           PIC 9(06)    VALUE ZERO.         01617571
012900     05  FILLER                  PIC X(74)    VALUE SPACE.        01617671
010800                                                                  01617771
013200******************************************************************01617857
013300*  DB2 FORMATTED ERROR MESSAGE                                    01617957
013400******************************************************************01618057
013500     COPY DPWS004.                                                01618157
013600                                                                  01618257
016600******************************************************************01618338
016700*    DATE CALCULATION ROUTINE RECORD LAYOUT                      *01619038
016800******************************************************************01620038
016900     COPY DPWS500.                                                01630038
017000                                                                  01640038
013700******************************************************************01640157
013800*  SQL COMMUNICATIONS WORK AREA                                   01640257
013900******************************************************************01640357
014000     COPY SQLCA2.                                                 01640457
014100                                                                  01640557
015600******************************************************************01641054
015700*  TRANSACTION PREPARATION MODULE COMMUNICATIONS AREA             01642054
015800******************************************************************01643054
260107     COPY DPWS991.                                                01644078
015900                                                                  01644178
015900     COPY DPLS001.                                                01644278
016000     05  WORK-STORAGE-PASSED.                                     01645054
016100******************************************************************01646070
016200*PA - PROGRAM ACCUMULATORS                                        01647070
016300******************************************************************01648070
016400         10  PROGRAM-ACCUMULATORS.                                01649070
016500             15  PA-ROWS-INSERTED PIC S9(11)           VALUE ZERO 01649170
016600                                                       COMP-3.    01649270
016700             15  PV-BYPASS-COUNT  PIC S9(11)           VALUE ZERO 01649370
016800                                                       COMP-3.    01649470
016900                                                                  01649554
017000 01  FILLER                          PIC X(4096)  VALUE SPACE.    01649654
017100                                                                  01649754
017100******************************************************************01650038
017200 PROCEDURE DIVISION.                                              01660038
017300******************************************************************01670038
017400 0000-MAINLINE.                                                   01680038
017500                                                                  01690038
017600     PERFORM 1000-INITIALIZATION.                                 01700038
017700     PERFORM 2000-PROCESS-ML-ADJ-SALES                            01710054
018200       UNTIL DP001-PREP-TRANS-EOF.                                01711054
109604     PERFORM 9000-CLEANUP.                                        01711167
018400     PERFORM Z990-EOJ-ROUTINE.                                    01712067
017900     GOBACK.                                                      01740038
018000                                                                  01750038
018300******************************************************************01780067
018400* PROCESSES THE DATE CONTROL CARD AND OPEN FILES                  01790038
018500******************************************************************01800038
018600 1000-INITIALIZATION.                                             01810038
018700                                                                  01820038
018800     PERFORM 1100-OPEN-FILES.                                     01830038
018900     PERFORM 1200-PROCESS-CONTROL-DATE.                           01840038
019000     PERFORM 1300-VALIDATE-CONTROL-DATE.                          01850038
019010     PERFORM 1400-DECREMENT-DATE.                                 01860038
019200                                                                  01880038
019400     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 01881055
019500                                                                  01882055
019600     MOVE SYS-TIME (1:2) TO ST-BEG-HR.                            01883055
019700     MOVE SYS-TIME (3:2) TO ST-BEG-MN.                            01884055
019800                                                                  01885055
019900     MOVE SYS-DATE (1:2) TO SD-CENT.                              01886055
020000     MOVE SYS-DATE (3:2) TO SD-YEAR.                              01887055
020100     MOVE SYS-DATE (5:2) TO SD-MONTH.                             01888055
020200     MOVE SYS-DATE (7:2) TO SD-DAY.                               01889055
020300                                                                  01889155
020400     MOVE PC-TRAN-PRES-FUNC-OPEN TO DP001-FUNC-CODE.              01889255
020500                                                                  01889364
020600     PERFORM X100-BUILD-COMM-AREA-TRAN-PRES.                      01889464
020500                                                                  01889555
019300******************************************************************01890038
019400* OPEN ALL FILES                                                  01900038
019500******************************************************************01910038
019600 1100-OPEN-FILES.                                                 01920038
019700                                                                  01930038
019800     OPEN INPUT DATE-CONTROL-FILE                                 01940071
123214                COMMIT-CARD-FILE.                                 01950071
067900                                                                  01952071
068000     READ COMMIT-CARD-FILE INTO CC-CONTROL-CARD                   01953071
068100        AT END                                                    01954071
068200           SET PS-END-OF-CARD-YES TO TRUE.                        01955071
068300                                                                  01956071
068400     CLOSE COMMIT-CARD-FILE.                                      01957071
068300                                                                  01958071
068600     IF PS-END-OF-CARD-YES                                        01959071
020800        DISPLAY ' '                                               01959471
020900        DISPLAY '** ABEND     **'                                 01959571
021000        DISPLAY '** PROGRAM   **  = DFKUP004'                     01959671
021100        DISPLAY '** PARAGRAPH **'                                 01959771
021200                       ' = 1100-OPEN-FILES'                       01959871
021300        DISPLAY '** COMMIT CONTROL RECORD IS MISSING'             01959971
021400        SET AC-CONTROL-CARD-ERROR TO TRUE                         01960071
021500        CALL 'ILBOABN0' USING AC-ABEND-CODE                       01960171
069100     END-IF.                                                      01960271
069200                                                                  01960371
020000                                                                  01961038
020100******************************************************************01970038
020200*    OPEN THE DATE CONTROL FILE, AND SAVE OFF THE VALUE IN WORKING01980038
020210*    STORAGE.                                                     01990038
020300******************************************************************02000038
020400 1200-PROCESS-CONTROL-DATE.                                       02010038
020500                                                                  02020038
020600     READ DATE-CONTROL-FILE                                       02030038
020700       AT END                                                     02040038
020800         DISPLAY ' '                                              02050038
020900         DISPLAY '** ABEND     **'                                02060038
021000         DISPLAY '** PROGRAM   **  = DFKUP004'                    02070052
021100         DISPLAY '** PARAGRAPH **'                                02080038
021200          '= 1200-PROCESS-CONTROL-DATE'                           02090038
021300         DISPLAY '** DATE CONTROL RECORD IS MISSING'              02100038
021400         SET AC-CONTROL-CARD-ERROR TO TRUE                        02110038
021500         CALL 'ILBOABN0' USING AC-ABEND-CODE                      02120038
021600     END-READ.                                                    02130038
021700                                                                  02140038
021800     MOVE DATE-CONTROL-RECORD TO CD-CONTROL-DATE.                 02150038
021900                                                                  02160038
022000     DISPLAY 'CONTROL DATE= ' CD-POS-DATE-MDY.                    02170038
022100                                                                  02180038
022200     CLOSE DATE-CONTROL-FILE.                                     02190038
022300                                                                  02200038
022400     MOVE CD-POS-YEAR      TO PV-CNTL-YY                          02210038
022500                              PV-CNTL-DATE-YY.                    02220038
022600     MOVE CD-POS-MONTH     TO PV-CNTL-MM                          02230038
022700                              PV-CNTL-DATE-MM.                    02240038
022800     MOVE CD-POS-DAY       TO PV-CNTL-DD                          02250038
022900                              PV-CNTL-DATE-DD.                    02260038
023000                                                                  02270038
023100******************************************************************02280038
023200*    ENSURE THAT THE CONTROL DATE MARKS THE BEGINNING OF A FISCAL 02290038
023300*    PERIOD WEEK.                                                 02300038
023400******************************************************************02310038
023500 1300-VALIDATE-CONTROL-DATE.                                      02320038
023600                                                                  02330038
023700     INITIALIZE DPG51 DPG52 DPG53                                 02340038
023800                DPG54 DPG55 DPG56.                                02350038
023900                                                                  02360038
024000     SET DPG51-FISCAL-454-CALENDAR  TO TRUE.                      02370038
024100     DISPLAY 'CALENDAR ROUTINE INPUT= ' PV-CONTROL-DATE.          02380038
024200                                                                  02390038
024300     MOVE PV-CONTROL-DATE      TO DPG52-DB2-ISO-DATE.             02400038
024400     SET DPG52-LK-DTE-ISO      TO TRUE.                           02410038
024500                                                                  02420038
024600     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    02430038
024700                                             DPG54 DPG55 DPG56.   02440038
024800                                                                  02450038
024900     IF DPG54-SEVERE-ERROR OR DPG54-DATE-INVALID                  02460038
025000         DISPLAY '** ABEND **'                                    02470038
025100         DISPLAY '** PROGRAM = DFKUP004'                          02480052
025200         DISPLAY 'DATE = ' PV-CONTROL-DATE                        02490038
025300         DISPLAY DPG54-ERROR-MESSAGE                              02500038
025400         SET AC-CONTROL-CARD-ERROR TO TRUE                        02510038
025500         CALL 'ILBOABN0' USING AC-ABEND-CODE                      02520038
025600     END-IF.                                                      02530038
025700                                                                  02540038
025800     MOVE DPG55-DB2-ISO-DATE-FMT     TO PV-CUR-DTE                02550038
025900                                        PV-COMPARE-DATE.          02560038
026000     MOVE DPG55-1ST-WKDY-DB2ISO-FMT  TO PV-CUR-WTD-BEG-DATE       02570038
026100     MOVE DPG55-LAST-WKDY-DB2ISO-FMT TO PV-CUR-WTD-END-DATE.      02580038
026200     MOVE DPG56-FIRST-FP-DB2-ISO-FMT TO PV-CUR-MTD-BEG-DATE.      02590038
026300     MOVE DPG56-LAST-FP-DB2-ISO-FMT  TO PV-CUR-MTD-END-DATE.      02600038
026400     MOVE DPG56-FIRST-FQ-DB2-ISO-FMT TO PV-CUR-QTD-BEG-DATE       02610038
026500     MOVE DPG56-LAST-FQ-DB2-ISO-FMT  TO PV-CUR-QTD-END-DATE.      02620038
026600     MOVE DPG56-FIRST-FS-DB2-ISO-FMT TO PV-CUR-STD-BEG-DATE       02630038
026700     MOVE DPG56-LAST-FS-DB2-ISO-FMT  TO PV-CUR-STD-END-DATE.      02640038
026800     MOVE DPG56-FIRST-FD-DB2-ISO-FMT TO PV-CUR-YTD-BEG-DTE.       02650038
026900     MOVE DPG56-LAST-FD-DB2-ISO-FMT  TO PV-CUR-YTD-END-DTE.       02660038
027000                                                                  02670038
027100     DISPLAY 'CTL DAY= '         PV-CUR-DTE.                      02680038
027200     DISPLAY '            '.                                      02690038
027300     DISPLAY 'FIRST WEEK = '     PV-CUR-WTD-BEG-DATE.             02700038
027400     DISPLAY 'LAST WEEK = '      PV-CUR-WTD-END-DATE.             02710038
027500     DISPLAY '            '.                                      02720038
027600     DISPLAY 'FIRST MTH DATE = ' PV-CUR-MTD-BEG-DATE.             02730038
027700     DISPLAY 'LAST  MTH DATE = ' PV-CUR-MTD-END-DATE.             02740038
027800     DISPLAY '            '.                                      02750038
027900     DISPLAY 'FIRST QTR DATE = ' PV-CUR-QTD-BEG-DATE.             02760038
028000     DISPLAY 'LAST  QTR DATE = ' PV-CUR-QTD-END-DATE.             02770038
028100     DISPLAY '            '.                                      02780038
028200     DISPLAY 'FIRST SEASON = '   PV-CUR-STD-BEG-DATE.             02790038
028300     DISPLAY 'LAST SEASON = '    PV-CUR-STD-END-DATE.             02800038
028400     DISPLAY '            ' .                                     02810038
028500     DISPLAY 'FIRST YEAR = '     PV-CUR-YTD-BEG-DTE.              02820038
028600     DISPLAY 'LAST YEAR = '      PV-CUR-YTD-END-DTE.              02830038
028700     DISPLAY '            '.                                      02840038
028800                                                                  02850038
028820*    MOVE PV-CONTROL-DATE-FMT TO PV-ROLLING-DATE-SAVED.           02860038
028830                                                                  02870038
028900     IF  PV-CONTROL-DATE-FMT NOT = PV-CUR-WTD-BEG-DATE            02880038
029000         DISPLAY '** ABEND **'                                    02890038
029100         DISPLAY '** PROGRAM = DFKUP004'                          02900052
029200         DISPLAY 'DATE = ' PV-CONTROL-DATE-FMT                    02910038
029300         DISPLAY 'NOT A FISCAL WEEK BEGIN DATE!'                  02920038
029400         DISPLAY DPG54-ERROR-MESSAGE                              02930038
029500         SET AC-CONTROL-CARD-ERROR TO TRUE                        02940038
029600         CALL 'ILBOABN0' USING AC-ABEND-CODE                      02950038
029700     END-IF.                                                      02960038
029800                                                                  02970038
029840******************************************************************02971055
029820*    THIS PARAGRAPH DECREMENTS THE DATE BY ONE AND SELECTS ALL OF 02980038
029830*    THE FISCAL GROUPINGS ASSOCIATED WITH IT.                     02981038
029840******************************************************************02982038
029850 1400-DECREMENT-DATE.                                             02983038
029860                                                                  02984038
029870     INITIALIZE DPG51 DPG52 DPG53                                 02985038
029880                DPG54 DPG55 DPG56.                                02986038
029890                                                                  02987038
029891     SET DPG51-FISCAL-454-CALENDAR  TO TRUE.                      02988038
029892     SET DPG51-DECREMENT-DATE       TO TRUE.                      02989038
029893     MOVE 1                         TO DPG51-INCR-DECR-DAYS-9     02989138
029894     SET DPG52-LK-DTE-ISO-FMT       TO TRUE.                      02989238
029895                                                                  02989338
029896     DISPLAY 'DATE TO BE DECREMENTED = '                          02989438
029897                               PV-CUR-DTE.                        02989538
029898                                                                  02989638
029899     MOVE PV-CUR-DTE TO DPG52-DB2-ISO-DATE-FMT.                   02989738
029900                                                                  02989838
029901     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    02989938
029902                                             DPG54 DPG55 DPG56.   02990038
029903                                                                  02990138
029904     IF DPG54-SEVERE-ERROR OR DPG54-DATE-INVALID                  02990238
029905         DISPLAY '** ABEND **'                                    02990338
029906         DISPLAY '** PROGRAM = DFKUP004'                          02990455
029907         DISPLAY 'DATE = ' PV-SAVED-DTE                           02990538
029908         DISPLAY DPG54-ERROR-MESSAGE                              02990638
029909         SET AC-INVALID-DATE-ERROR TO TRUE                        02990738
029910         CALL 'ILBOABN0' USING AC-ABEND-CODE                      02990838
029911     END-IF.                                                      02990938
029912                                                                  02991038
029913     MOVE DPG55-DB2-ISO-DATE-FMT TO PV-ROLLING-DATE-SAVED.        02991138
029914     DISPLAY 'DECREMENT DATE     = ' PV-ROLLING-DATE-SAVED.       02991238
029915                                                                  02991338
029920******************************************************************02991538
030000* PROCESSES THE ML SALES FILE                                     02991638
030100******************************************************************02991738
030200 2000-PROCESS-ML-ADJ-SALES.                                       02991838
030300                                                                  02991938
021400     SET PS-RESTART-NOT-REQUIRED TO TRUE.                         02992055
021500                                                                  02992155
021800*----------------------------------------------------------------*02993855
021900*  IF A RESTART IS REQUIRED, ISSUE A RESTART CALL RATHER THAN A  *02993955
022000*  TRANS CALL.  THIS WILL ALLOW PROCESSING TO RESUME WITH THE    *02994055
022100*  FIRST TRANSACTION AFTER THE LAST COMMIT.                      *02994155
022200*----------------------------------------------------------------*02994255
022300     IF  PS-RESTART-REQUIRED                                      02994355
022400         MOVE PC-TRAN-PRES-FUNC-RSTRT TO DP001-FUNC-CODE          02994455
022500     ELSE                                                         02994555
022600         MOVE PC-TRAN-PRES-FUNC-TRANS TO DP001-FUNC-CODE          02994655
022700     END-IF.                                                      02994755
022800                                                                  02994855
023100     ADD 1 TO PA-READ.                                            02995155
023300                                                                  02995255
030400     IF DF005-KY-DTE NOT = PV-COMPARE-DATE                        02995338
030500        PERFORM 2100-GET-NEW-DATE-RANGES                          02995438
030600        MOVE DF005-KY-DTE TO PV-COMPARE-DATE                      02995538
030700     END-IF.                                                      02995638
030800                                                                  02996038
030900     IF DF005-KY-DTE >= PV-CONTROL-DATE-FMT                       02997038
031000*****  CURRENT WEEK PROCESSING                                    02998038
031100        PERFORM 3000-PROCESS-CURRENT-WEEK                         02999038
031200     ELSE                                                         03000038
031300*****  BACK POSTING LOGIC REQUIRED HERE                           03010038
031310*****   DISPLAY 'PERFORMING BACK POSTING!!!'                      03020038
031400        PERFORM 4000-PROCESS-PREVIOUS-WEEK                        03030038
031500     END-IF.                                                      03040038
031600                                                                  03050038
091300     IF PV-CNT-SINCE-COMMIT >= CC-COMMIT-CNT                      03051074
040016        PERFORM 9100-COMMIT-DB2                                   03052071
040017     END-IF.                                                      03054071
040017                                                                  03055071
022900     PERFORM X100-BUILD-COMM-AREA-TRAN-PRES.                      03060066
023000                                                                  03070066
031900******************************************************************03080038
032000*    ON A DATE CHANGE IN THE INPUT FILE, GET THE NEW FISCAL       03090038
032100*    PERIODS FOR THAT DAY (I.E. WEEK, MONTH, YEAR START/END DAYS) 03100038
032200******************************************************************03110038
032300 2100-GET-NEW-DATE-RANGES.                                        03120038
032400                                                                  03130038
032500     INITIALIZE DPG51 DPG52 DPG53                                 03140038
032600                DPG54 DPG55 DPG56.                                03150038
032700                                                                  03160038
032800     SET DPG51-FISCAL-454-CALENDAR  TO TRUE.                      03170038
033000                                                                  03180038
033100     MOVE DF005-KY-DTE         TO DPG52-DB2-ISO-DATE-FMT.         03190038
033200     SET DPG52-LK-DTE-ISO-FMT  TO TRUE.                           03200038
033300                                                                  03210038
033400     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    03220038
033500                                             DPG54 DPG55 DPG56.   03230038
033600                                                                  03240038
033700     IF DPG54-SEVERE-ERROR OR DPG54-DATE-INVALID                  03250038
033800         DISPLAY '** ABEND **'                                    03260038
033900         DISPLAY '** PROGRAM = DFKUP004'                          03270052
034000         DISPLAY 'DATE = ' DF005-KY-DTE                           03280038
034100         DISPLAY DPG54-ERROR-MESSAGE                              03290038
034200         SET AC-INVALID-DATE-ERROR TO TRUE                        03300038
034300         CALL 'ILBOABN0' USING AC-ABEND-CODE                      03310038
034400     END-IF.                                                      03320038
034500                                                                  03330038
034600     MOVE DPG55-DB2-ISO-DATE-FMT     TO PV-CUR-DTE.               03340038
034700     MOVE DPG55-1ST-WKDY-DB2ISO-FMT  TO PV-CUR-WTD-BEG-DATE       03350038
034800     MOVE DPG55-LAST-WKDY-DB2ISO-FMT TO PV-CUR-WTD-END-DATE.      03360038
034900     MOVE DPG56-FIRST-FP-DB2-ISO-FMT TO PV-CUR-MTD-BEG-DATE.      03370038
035000     MOVE DPG56-LAST-FP-DB2-ISO-FMT  TO PV-CUR-MTD-END-DATE.      03380038
035100     MOVE DPG56-FIRST-FQ-DB2-ISO-FMT TO PV-CUR-QTD-BEG-DATE       03390038
035200     MOVE DPG56-LAST-FQ-DB2-ISO-FMT  TO PV-CUR-QTD-END-DATE.      03400038
035300     MOVE DPG56-FIRST-FS-DB2-ISO-FMT TO PV-CUR-STD-BEG-DATE       03410038
035400     MOVE DPG56-LAST-FS-DB2-ISO-FMT  TO PV-CUR-STD-END-DATE.      03420038
035500     MOVE DPG56-FIRST-FD-DB2-ISO-FMT TO PV-CUR-YTD-BEG-DTE.       03430038
035600     MOVE DPG56-LAST-FD-DB2-ISO-FMT  TO PV-CUR-YTD-END-DTE.       03440038
037500                                                                  03450038
037600******************************************************************03460038
037700* PROCESSES THE CURRENT WEEKS RECORDS IN THE ML FILE.             03470038
037800* AN INSERT WILL BE ATTEMPTED FIRST, IF THAT FAILS AN UPDATE WILL 03480038
037900* BE PERFORMED.                                                   03490038
038000******************************************************************03500038
038100 3000-PROCESS-CURRENT-WEEK.                                       03510038
038200                                                                  03520038
038201     IF DF005-KY-DTE NOT = PV-ROLLING-DATE                        03530038
038203        PERFORM 5000-ROLL-TABLE-FORWARD UNTIL                     03540038
038204           DF005-KY-DTE = PV-ROLLING-DATE                         03550038
038223     END-IF.                                                      03560038
038230                                                                  03570038
038300     MOVE DF005-DEPT-NBR      TO PV-DEPT-NBR-NUMERIC.             03580038
038400     MOVE PV-DEPT-NBR-NUMERIC TO PV-DEPT-NBR-COMP.                03590038
038500                                                                  03600038
038600     PERFORM 3200-INSERT-DFT-ML-FINCL-SUM.                        03610038
038700                                                                  03620038
038800     IF PS-UPDATE-ML-SALES                                        03630038
038900        PERFORM 3800-UPDATE-DFT-ML-FINCL-SUM                      03640038
039000     END-IF.                                                      03650038
039100                                                                  03660038
039200******************************************************************03670038
039300* THIS LOGIC WILL INSERT ML SALES INFORMATION TO THE FLASH TABLE  03680038
039400* AFTER FIRST DETERMINING WHAT THE VALUE OF HISTORY/ACCUMULATED   03690038
039500* BUCKETS SHOULD BE SET TO.                                       03700038
039600******************************************************************03710038
039700 3200-INSERT-DFT-ML-FINCL-SUM.                                    03720038
039910                                                                  03730038
040000     IF PV-SAVE-STR NOT = DF005-STR-NBR OR                        03740038
040010        PV-SAVE-DEPT NOT = DF005-DEPT-NBR                         03750048
040102           MOVE DF005-STR-NBR  TO PV-SAVE-STR                     03840048
040103           MOVE DF005-DEPT-NBR TO PV-SAVE-DEPT                    03850048
040110     END-IF.                                                      03860038
040200                                                                  03870038
040600     PERFORM 3600-PREPR-INSRT-WTHOUT-HSTY.                        03880038
040800                                                                  03890038
040900     MOVE DF005-KY-DTE      TO  DFT00002-SLS-DTE.                 03900038
041000     MOVE DF005-STR-NBR     TO  DFT00002-STR-NBR.                 03910038
041100     MOVE PV-DEPT-NBR-COMP  TO  DFT00002-DEPT-NBR.                03920038
041200                                                                  03930038
041300     PERFORM 7700-INSRT-ML-SLS-SUMMARY.                           03940038
041400                                                                  03950038
049000******************************************************************03960038
049100* THIS SECTION WILL PREPARE A NEW ROW FOR INSERTION TO THE ML     03970038
049200* FLASH HISTORY TABLE, WHEN NO PRIOR HISTORY EXISTS FOR THE FISCAL03980038
049300* YEAR OF THE GIVEN STORE AND DEPARTMENT COMBINATION.             03990038
049400******************************************************************04000038
049500 3600-PREPR-INSRT-WTHOUT-HSTY.                                    04010038
049910                                                                  04020038
050000     COMPUTE PV-TEMP-TOT-SLS-AMT = DF005-SLS-AMT +                04030038
050010                                       DF005-SLS-CORR-AMT.        04040038
050020                                                                  04050038
050100     MOVE PV-TEMP-TOT-SLS-AMT TO   DFT00002-DLY-DOL-AMT           04060038
050200                                   DFT00002-WTD-DOL-AMT           04070038
050300                                   DFT00002-MTD-DOL-AMT           04080038
050400                                   DFT00002-QTD-DOL-AMT           04090038
050500                                   DFT00002-S-T-D-DOL-AMT         04100038
050600                                   DFT00002-YTD-DOL-AMT.          04110038
050700                                                                  04120038
054900******************************************************************04130038
055000* UPDATE THE DAILY ML FINANCIAL SUMMARY TABLE IF FOR SOME REASON  04140038
055100* THE INSERT FAILED.                                              04150038
055200******************************************************************04160038
055300 3800-UPDATE-DFT-ML-FINCL-SUM.                                    04170038
055400                                                                  04180038
055500     EXEC SQL                                                     04190038
055600                                                                  04200038
055700       UPDATE DFT_ML_FINCL_SUM                                    04210038
055800                                                                  04220038
055900          SET DLY_DOL_AMT    =  DLY_DOL_AMT + :DF005-SLS-AMT +    04230038
056000                                  :DF005-SLS-CORR-AMT,            04240038
056100                                                                  04250038
056200              WTD_DOL_AMT    =  WTD_DOL_AMT + :DF005-SLS-AMT +    04260038
056300                                  :DF005-SLS-CORR-AMT,            04270038
056400                                                                  04280038
056500              MTD_DOL_AMT    =  MTD_DOL_AMT + :DF005-SLS-AMT +    04290038
056600                                  :DF005-SLS-CORR-AMT,            04300038
056700                                                                  04310038
056800              QTD_DOL_AMT    =  QTD_DOL_AMT + :DF005-SLS-AMT +    04320038
056900                                  :DF005-SLS-CORR-AMT,            04330038
057000                                                                  04340038
057100              S_T_D_DOL_AMT  =  S_T_D_DOL_AMT + :DF005-SLS-AMT +  04350038
057200                                  :DF005-SLS-CORR-AMT,            04360038
057300                                                                  04370038
057400              YTD_DOL_AMT    =  YTD_DOL_AMT + :DF005-SLS-AMT +    04380038
057500                                  :DF005-SLS-CORR-AMT             04390038
057600                                                                  04400038
057700             WHERE                                                04410038
057800               SLS_DTE      = :DF005-KY-DTE   AND                 04420038
057900               STR_NBR      = :DF005-STR-NBR  AND                 04430038
058000               DEPT_NBR     = :PV-DEPT-NBR-COMP                   04440038
058100    END-EXEC.                                                     04450038
058200                                                                  04460038
058300      EVALUATE TRUE                                               04470038
058400         WHEN SQLCODE = 0                                         04480038
058410*           CONTINUE                                              04490071
081700            ADD +1 TO PV-CNT-SINCE-COMMIT                         04491071
058600         WHEN OTHER                                               04500038
058700           DISPLAY 'SLS DTE= '   DF005-KY-DTE                     04510038
058800           DISPLAY 'STR NBR= '   DF005-STR-NBR                    04520038
058900           DISPLAY 'DEPT_NBR= '  PV-DEPT-NBR-COMP                 04530038
059000           MOVE '3800-UPDATE-DFT-ML-FINCL-SUM' TO                 04540038
059100               PV-DB2-OPERATION                                   04550038
059200           PERFORM 9200-SQL-ABEND                                 04560038
059300      END-EVALUATE.                                               04570038
059400                                                                  04580038
059500******************************************************************04590038
059600* PROCESSES PREVIOUS WEEKS RECORDS IN THE ML FILE.  AN UPDATE     04600038
059700* WILL BE ATTEMPTED FIRST, IF THAT FAILS AN INSERT WILL           04610038
059800* BE PERFORMED.                                                   04620038
059900******************************************************************04630038
060000 4000-PROCESS-PREVIOUS-WEEK.                                      04640038
060100                                                                  04650038
060200     MOVE DF005-DEPT-NBR      TO PV-DEPT-NBR-NUMERIC.             04660038
060300     MOVE PV-DEPT-NBR-NUMERIC TO PV-DEPT-NBR-COMP.                04670038
060400                                                                  04680038
060500     PERFORM 4100-UPDT-DFT-ML-FINCL-SUM-HST.                      04690038
081700*    ADD +1 TO PV-CNT-SINCE-COMMIT.                               04700071
060600                                                                  04710038
060700     IF PS-DO-NOT-ROLL-HISTORY-FORWARD                            04720038
060800        PERFORM 4200-INST-DFT-ML-FINCL-SUM-HST                    04730038
060900        SET PS-ROLL-HISTORY-FORWARD TO TRUE                       04740038
060910     ELSE                                                         04750038
060920        PERFORM 4150-SET-ML-SALES-DCLGEN-RCD                      04760038
061000     END-IF.                                                      04770038
061100                                                                  04780038
091300*    IF PV-CNT-SINCE-COMMIT > PC-COMMIT-MAX                       04790071
040016*       PERFORM 9100-COMMIT-DB2                                   04850071
      *       MOVE ZEROS TO PV-CNT-SINCE-COMMIT                         04860071
040017*    END-IF.                                                      04870071
                                                                        04880038
061200     PERFORM 4800-SAVE-CURRNT-PROC-DATA.                          04890038
061300                                                                  04900038
061400     MOVE SPACES TO PV-CUR-DTE.                                   04910038
061500                                                                  04920038
061600     PERFORM 4900-INCREMENT-DATE.                                 04930038
061700     PERFORM 4400-ROLL-HISTORY-FORWARD UNTIL                      04940038
061800               PV-CUR-DTE = PV-CONTROL-DATE-FMT.                  04950038
061900                                                                  04960038
062000******************************************************************04970038
062100* UPDATE THE DAILY ML FINANCIAL SUMMARY TABLE FOR A DAY FROM      04980038
062200* A PREVIOUS WEEK.  ONCE COMPLETE ROLL THE ADDITIONAL DATA UP     04990038
062300* GOING FORWARD THROUGH THE DAYS.                                 05000038
062400******************************************************************05010038
062500 4100-UPDT-DFT-ML-FINCL-SUM-HST.                                  05020038
062600                                                                  05030038
062700     EXEC SQL                                                     05040038
062800                                                                  05050038
062900       UPDATE DFT_ML_FINCL_SUM                                    05060038
063000                                                                  05070038
063100          SET DLY_DOL_AMT    =  DLY_DOL_AMT + :DF005-SLS-AMT +    05080038
063200                                  :DF005-SLS-CORR-AMT,            05090038
063330                                                                  05100038
063400              WTD_DOL_AMT    =  WTD_DOL_AMT + :DF005-SLS-AMT +    05110038
063500                                  :DF005-SLS-CORR-AMT,            05120038
063600                                                                  05130038
063700              MTD_DOL_AMT    =  MTD_DOL_AMT + :DF005-SLS-AMT +    05140038
063800                                  :DF005-SLS-CORR-AMT,            05150038
063900                                                                  05160038
064000              QTD_DOL_AMT    =  QTD_DOL_AMT + :DF005-SLS-AMT +    05170038
064100                                  :DF005-SLS-CORR-AMT,            05180038
064200                                                                  05190038
064300              S_T_D_DOL_AMT  =  S_T_D_DOL_AMT + :DF005-SLS-AMT +  05200038
064400                                  :DF005-SLS-CORR-AMT,            05210038
064500                                                                  05220038
064600              YTD_DOL_AMT    =  YTD_DOL_AMT + :DF005-SLS-AMT +    05230038
064700                                  :DF005-SLS-CORR-AMT             05240038
064800                                                                  05250038
064900             WHERE                                                05260038
065000               SLS_DTE      = :DF005-KY-DTE   AND                 05270038
065100               STR_NBR      = :DF005-STR-NBR  AND                 05280038
065200               DEPT_NBR     = :PV-DEPT-NBR-COMP                   05290038
065300     END-EXEC.                                                    05300038
065400                                                                  05310038
065500      EVALUATE TRUE                                               05320038
065600         WHEN SQLCODE = 0                                         05330038
065700            SET PS-ROLL-HISTORY-FORWARD TO TRUE                   05340038
081700            ADD +1 TO PV-CNT-SINCE-COMMIT                         05341071
065800         WHEN SQLCODE = PC-ROW-NOT-FOUND                          05350038
065900            SET PS-DO-NOT-ROLL-HISTORY-FORWARD TO TRUE            05360038
066000         WHEN OTHER                                               05370038
066100           DISPLAY 'SLS DTE= '   DF005-KY-DTE                     05380038
066200           DISPLAY 'STR NBR= '   DF005-STR-NBR                    05390038
066300           DISPLAY 'DEPT_NBR= '  PV-DEPT-NBR-COMP                 05400038
066400           MOVE '4100-UPDT-DFT-ML-FINCL-SUM-HST' TO               05410038
066500               PV-DB2-OPERATION                                   05420038
066600           PERFORM 9200-SQL-ABEND                                 05430038
066700      END-EVALUATE.                                               05440038
066800                                                                  05450038
066810******************************************************************05460038
066820* AFTER INSERTING A ROW, THE DCLGEN VALUES NEED TO BE LOADED.     05470038
066850******************************************************************05480038
066860 4150-SET-ML-SALES-DCLGEN-RCD.                                    05490038
066870                                                                  05500038
066871     EXEC SQL                                                     05510038
066872           SELECT SLS_DTE,                                        05520038
066873                  STR_NBR,                                        05530038
066874                  DEPT_NBR,                                       05540038
066875                  DLY_DOL_AMT,                                    05550038
066876                  WTD_DOL_AMT,                                    05560038
066877                  MTD_DOL_AMT,                                    05570038
066878                  QTD_DOL_AMT,                                    05580038
066879                  S_T_D_DOL_AMT,                                  05590038
066880                  YTD_DOL_AMT                                     05600038
066881                                                                  05610038
066882          INTO   :DFT00002-SLS-DTE,                               05620038
066883                 :DFT00002-STR-NBR,                               05630038
066884                 :DFT00002-DEPT-NBR,                              05640038
066885                 :DFT00002-DLY-DOL-AMT,                           05650038
066886                 :DFT00002-WTD-DOL-AMT,                           05660038
066887                 :DFT00002-MTD-DOL-AMT,                           05670038
066888                 :DFT00002-QTD-DOL-AMT,                           05680038
066889                 :DFT00002-S-T-D-DOL-AMT,                         05690038
066890                 :DFT00002-YTD-DOL-AMT                            05700038
066891                                                                  05710038
066892              FROM DFT_ML_FINCL_SUM SUM                           05720038
066893                                                                  05730038
066894         WHERE                                                    05740038
066895               SLS_DTE      = :DF005-KY-DTE   AND                 05750038
066896               STR_NBR      = :DF005-STR-NBR  AND                 05760038
066897               DEPT_NBR     = :PV-DEPT-NBR-COMP                   05770038
066898                                                                  05780038
066899               WITH UR                                            05790038
066900     END-EXEC.                                                    05800038
066901                                                                  05810038
066902       EVALUATE TRUE                                              05820038
066903          WHEN SQLCODE = ZERO                                     05830038
066904             SET PS-HISTORY-TO-UPDATE    TO TRUE                  05840038
066905          WHEN SQLCODE = PC-ROW-NOT-FOUND                         05850038
066906             SET PS-NO-HISTORY-TO-UPDATE TO TRUE                  05860038
066907          WHEN OTHER                                              05870038
066908            DISPLAY 'SLS DTE= '   PV-CUR-DTE                      05880038
066909            DISPLAY 'STR NBR= '   PV-SAVED-STR                    05890038
066910            DISPLAY 'DEPT_NBR= '  PV-SAVED-DEPT                   05900038
066911            MOVE '4450-SELECT-RECENT-HISTORY' TO                  05910038
066912                PV-DB2-OPERATION                                  05920038
066913            PERFORM 9200-SQL-ABEND                                05930038
066914       END-EVALUATE.                                              05940038
066925                                                                  05950038
066930******************************************************************05960038
067000* PREPARE TO INSERT ROW FROM THE PAST, LOOKING BACK TO GET THE    05970038
067100* APPROPRIATE HISTORY.                                            05980038
067200******************************************************************05990038
067300 4200-INST-DFT-ML-FINCL-SUM-HST.                                  06000038
067400                                                                  06010038
067500     PERFORM 7000-SLCT-CUR-HST-STR-DEPT.                          06020038
067600                                                                  06030038
067700     IF PS-NO-MISSING-HIST-ML-SLS                                 06040038
067800        PERFORM 4500-PREPR-INSRT-WITH-HSTY                        06050038
067900     ELSE                                                         06060038
068000        PERFORM 4600-PREPR-INSRT-WTHOUT-HSTY                      06070038
068100     END-IF.                                                      06080038
068200                                                                  06090038
068300     MOVE DF005-KY-DTE      TO  DFT00002-SLS-DTE.                 06100038
068400     MOVE DF005-STR-NBR     TO  DFT00002-STR-NBR.                 06110038
068500     MOVE PV-DEPT-NBR-COMP  TO  DFT00002-DEPT-NBR.                06120038
068600                                                                  06130038
068700     PERFORM 7700-INSRT-ML-SLS-SUMMARY.                           06140038
068800                                                                  06150038
068810******************************************************************06160038
068820* THIS SECTION WILL WORK TO MOVE FORWARD PAST THE DATE UPDATED OR 06170038
068830* INSERTED FROM HISTORY, THROUGH ALL DAYS FOLLOWING FOR THE STORE 06180038
068840* DAY, AND DEPT TO THE CURRENT DAY AND UPDATED THE ACCUMULATED    06190038
068850* BUCKETS.  DAILY INFORMATION WOULD NOT CHANGE, BUT THE ACCUMULATE06200038
068860* BUCKETS WILL BE IMPACTED FROM AN UPDATE/INSERT TO A PREVIOUS DAY06210038
068870******************************************************************06220038
068880 4400-ROLL-HISTORY-FORWARD.                                       06230038
068890                                                                  06240038
068891     PERFORM 4450-SELECT-RECENT-HISTORY.                          06250038
068892                                                                  06260038
068893     IF PS-HISTORY-TO-UPDATE                                      06270038
068894        PERFORM 4650-PREPARE-TO-UPDATE-HISTORY                    06280038
068895        IF PS-HISTORY-NOT-PRIOR-YR                                06290038
068896          PERFORM 4700-UPDATE-HISTORY                             06300038
068897        END-IF                                                    06301045
DMBDMB     ELSE                                                         06310045
DMBDMB         MOVE PV-CUR-DTE  TO  DFT00002-SLS-DTE                    06311045
DMBDMB         MOVE +0          TO  DFT00002-DLY-DOL-AMT                06311146
DMBDMB         PERFORM 7700-INSRT-ML-SLS-SUMMARY                        06312045
068898     END-IF.                                                      06320038
068899                                                                  06330038
068900     PERFORM 4900-INCREMENT-DATE.                                 06340038
068901                                                                  06350038
068902******************************************************************06360038
068903* THIS SECTION WILL SELECT THE HISTORY SALES FOR USE IN UPDATING  06370038
068904* AS THE PROGRAM ROLLS BACKPOSTING CHANGES FORWARD.               06380038
068906******************************************************************06390038
068907 4450-SELECT-RECENT-HISTORY.                                      06400038
068908                                                                  06410038
068909     EXEC SQL                                                     06420038
068910           SELECT SLS_DTE,                                        06430038
068911                  STR_NBR,                                        06440038
068912                  DEPT_NBR,                                       06450038
068913                  DLY_DOL_AMT,                                    06460038
068914                  WTD_DOL_AMT,                                    06470038
068915                  MTD_DOL_AMT,                                    06480038
068916                  QTD_DOL_AMT,                                    06490038
068917                  S_T_D_DOL_AMT,                                  06500038
068918                  YTD_DOL_AMT                                     06510038
068919                                                                  06520038
068920          INTO   :DFT00002-SLS-DTE,                               06530038
068921                 :DFT00002-STR-NBR,                               06540038
068922                 :DFT00002-DEPT-NBR,                              06550038
068923                 :DFT00002-DLY-DOL-AMT,                           06560038
068924                 :DFT00002-WTD-DOL-AMT,                           06570038
068925                 :DFT00002-MTD-DOL-AMT,                           06580038
068926                 :DFT00002-QTD-DOL-AMT,                           06590038
068927                 :DFT00002-S-T-D-DOL-AMT,                         06600038
068928                 :DFT00002-YTD-DOL-AMT                            06610038
068929                                                                  06620038
068930              FROM DFT_ML_FINCL_SUM SUM                           06630038
068931                                                                  06640038
068932              WHERE SUM.SLS_DTE    = :PV-CUR-DTE       AND        06650038
068933                    SUM.STR_NBR    = :PV-SAVED-STR     AND        06660038
068934                    SUM.DEPT_NBR   = :PV-SAVED-DEPT               06670038
068935               WITH UR                                            06680038
068936     END-EXEC.                                                    06690038
068937                                                                  06700038
068938       EVALUATE TRUE                                              06710038
068939          WHEN SQLCODE = ZERO                                     06720038
068940             SET PS-HISTORY-TO-UPDATE    TO TRUE                  06730038
068941          WHEN SQLCODE = PC-ROW-NOT-FOUND                         06740038
068942             SET PS-NO-HISTORY-TO-UPDATE TO TRUE                  06750038
068943          WHEN OTHER                                              06760038
068944            DISPLAY 'SLS DTE= '   PV-CUR-DTE                      06770038
068945            DISPLAY 'STR NBR= '   PV-SAVED-STR                    06780038
068946            DISPLAY 'DEPT_NBR= '  PV-SAVED-DEPT                   06790038
068947            MOVE '4450-SELECT-RECENT-HISTORY' TO                  06800038
068948                PV-DB2-OPERATION                                  06810038
068949            PERFORM 9200-SQL-ABEND                                06820038
068950       END-EVALUATE.                                              06830038
068951                                                                  06840038
068960******************************************************************06850038
069000*   THIS SECTION USES THE MOST CURRENT HISTORY, IN ORDER TO       06860038
069100*   DETERMINE HOW TO SET ACCUMULATED VALUES WHEN BACK POSTING TO A06870038
069200*   PREVIOUS DATE(INSERTING)                                      06880038
069300******************************************************************06890038
069400 4500-PREPR-INSRT-WITH-HSTY.                                      06900038
069500                                                                  06910038
069510     COMPUTE PV-TEMP-TOT-SLS-AMT = DF005-SLS-AMT +                06920038
069520                                       DF005-SLS-CORR-AMT.        06930038
069530                                                                  06940038
DMBDMB** HISTORY IS LATER THAN THE DATE THE ADJUSTMENT IS FOR           06941040
DMBDMB     EVALUATE TRUE                                                06942038
DMBDMB        WHEN  DFT00002-SLS-DTE > DF005-KY-DTE                     06943038
DMBDMB                                                                  06944038
DMBDMB           MOVE PV-TEMP-TOT-SLS-AMT TO DFT00002-DLY-DOL-AMT       06945038
DMBDMB                                       DFT00002-WTD-DOL-AMT       06946038
DMBDMB                                       DFT00002-MTD-DOL-AMT       06947038
DMBDMB                                       DFT00002-QTD-DOL-AMT       06948038
DMBDMB                                       DFT00002-S-T-D-DOL-AMT     06949038
DMBDMB                                       DFT00002-YTD-DOL-AMT       06949138
                                                                        06949239
069600** HISTORY IN SAME FISCAL WEEK AS DATE IN PROCESS                 06950038
069800        WHEN  DFT00002-SLS-DTE >= PV-CUR-WTD-BEG-DATE             06970038
069900              AND <= PV-CUR-WTD-END-DATE                          06980038
070000                                                                  06990038
070100           MOVE PV-TEMP-TOT-SLS-AMT TO DFT00002-DLY-DOL-AMT       07000038
070200           ADD  PV-TEMP-TOT-SLS-AMT TO DFT00002-WTD-DOL-AMT       07010038
070300                                       DFT00002-MTD-DOL-AMT       07020038
070400                                       DFT00002-QTD-DOL-AMT       07030038
070500                                       DFT00002-S-T-D-DOL-AMT     07040038
070600                                       DFT00002-YTD-DOL-AMT       07050038
070700                                                                  07060038
070800** HISTORY IN SAME FISCAL MONTH AS DATE IN PROCESS                07070038
070900        WHEN  DFT00002-SLS-DTE >= PV-CUR-MTD-BEG-DATE             07080038
071000              AND <= PV-CUR-MTD-END-DATE                          07090038
071100                                                                  07100038
071200           MOVE PV-TEMP-TOT-SLS-AMT TO DFT00002-DLY-DOL-AMT       07110038
071300                                       DFT00002-WTD-DOL-AMT       07120038
071400                                                                  07130038
071500           ADD  PV-TEMP-TOT-SLS-AMT TO DFT00002-MTD-DOL-AMT       07140038
071600                                       DFT00002-QTD-DOL-AMT       07150038
071700                                       DFT00002-S-T-D-DOL-AMT     07160038
071800                                       DFT00002-YTD-DOL-AMT       07170038
071900                                                                  07180038
072000** HISTORY IN SAME FISCAL QUARTER AS DATE IN PROCESS              07190038
072100        WHEN  DFT00002-SLS-DTE >= PV-CUR-QTD-BEG-DATE             07200038
072200              AND <= PV-CUR-QTD-END-DATE                          07210038
072300                                                                  07220038
072400           MOVE PV-TEMP-TOT-SLS-AMT  TO DFT00002-DLY-DOL-AMT      07230038
072500                                        DFT00002-WTD-DOL-AMT      07240038
072600                                        DFT00002-MTD-DOL-AMT      07250038
072700           ADD  PV-TEMP-TOT-SLS-AMT  TO DFT00002-QTD-DOL-AMT      07260038
072800                                        DFT00002-S-T-D-DOL-AMT    07270038
072900                                        DFT00002-YTD-DOL-AMT      07280038
073000                                                                  07290038
073100** HISTORY IN SAME FISCAL SEASON AS DATE IN PROCESS               07300038
073200        WHEN  DFT00002-SLS-DTE >= PV-CUR-STD-BEG-DATE             07310038
073300              AND <= PV-CUR-STD-END-DATE                          07320038
073400                                                                  07330038
073500           MOVE PV-TEMP-TOT-SLS-AMT TO DFT00002-DLY-DOL-AMT       07340038
073600                                       DFT00002-WTD-DOL-AMT       07350038
073700                                       DFT00002-MTD-DOL-AMT       07360038
073800                                       DFT00002-QTD-DOL-AMT       07370038
073900           ADD  PV-TEMP-TOT-SLS-AMT TO DFT00002-S-T-D-DOL-AMT     07380038
074000                                       DFT00002-YTD-DOL-AMT       07390038
074100                                                                  07400038
074200** HISTORY IN SAME FISCAL YEAR AS DATE IN PROCESS                 07410038
074300        WHEN  DFT00002-SLS-DTE >= PV-CUR-YTD-BEG-DTE              07420038
074400              AND <= PV-CUR-YTD-END-DTE                           07430038
074500                                                                  07440038
074600           MOVE PV-TEMP-TOT-SLS-AMT TO DFT00002-DLY-DOL-AMT       07450038
074700                                       DFT00002-WTD-DOL-AMT       07460038
074800                                       DFT00002-MTD-DOL-AMT       07470038
074900                                       DFT00002-QTD-DOL-AMT       07480038
075000                                       DFT00002-S-T-D-DOL-AMT     07490038
075100           ADD  PV-TEMP-TOT-SLS-AMT TO DFT00002-YTD-DOL-AMT       07500038
075200                                                                  07510038
075300** HISTORY NOT IN SAME YEAR.... SET EVERYTHING TO DAILY VALUE!    07520038
075400        WHEN OTHER                                                07530038
075500                                                                  07540038
075600           MOVE PV-TEMP-TOT-SLS-AMT TO DFT00002-DLY-DOL-AMT       07550038
075700                                       DFT00002-WTD-DOL-AMT       07560038
075800                                       DFT00002-MTD-DOL-AMT       07570038
075900                                       DFT00002-QTD-DOL-AMT       07580038
076000                                       DFT00002-S-T-D-DOL-AMT     07590038
076100                                       DFT00002-YTD-DOL-AMT       07600038
076200     END-EVALUATE.                                                07610038
076300                                                                  07620038
076400******************************************************************07630038
076500* THIS SECTION WILL PREPARE A NEW ROW FOR INSERTION TO THE ML     07640038
076600* FLASH HISTORY TABLE WHEN NO PRIOR HISTORY EXISTS FOR THE FISCAL 07650038
076700* YEAR OF THE GIVEN STORE AND DEPARTMENT COMBINATION.             07660038
076800******************************************************************07670038
076900 4600-PREPR-INSRT-WTHOUT-HSTY.                                    07680038
077400                                                                  07690038
077410     COMPUTE PV-TEMP-TOT-SLS-AMT = DF005-SLS-AMT +                07700038
077420                                       DF005-SLS-CORR-AMT.        07710038
077430                                                                  07720038
077500     MOVE PV-TEMP-TOT-SLS-AMT TO DFT00002-DLY-DOL-AMT             07730038
077600                                 DFT00002-WTD-DOL-AMT             07740038
077700                                 DFT00002-MTD-DOL-AMT             07750038
077800                                 DFT00002-QTD-DOL-AMT             07760038
077900                                 DFT00002-S-T-D-DOL-AMT           07770038
078000                                 DFT00002-YTD-DOL-AMT.            07780038
078700                                                                  07790038
085700******************************************************************07800038
085800* PREPARES TO UPDATE HISTORY FOR BACK POSTING, AS THE IMPACT IS   07810038
085900* ROLLED FORWARD TO FUTURE DAYS.                                  07820038
086100******************************************************************07830038
086200 4650-PREPARE-TO-UPDATE-HISTORY.                                  07840038
086300                                                                  07850038
086400     SET PS-HISTORY-NOT-PRIOR-YR TO TRUE.                         07860038
086500                                                                  07870038
086600** HISTORY IN SAME FISCAL WEEK AS DATE IN PROCESS                 07880038
086700     EVALUATE TRUE                                                07890038
086800        WHEN  PV-CUR-DTE >= PV-CUR-WTD-BEG-DATE                   07900038
086900              AND <= PV-CUR-WTD-END-DATE                          07910038
087000                                                                  07920038
087100           ADD  PV-SAVED-DLYSLS TO  DFT00002-WTD-DOL-AMT          07930038
087200                                    DFT00002-MTD-DOL-AMT          07940038
087300                                    DFT00002-QTD-DOL-AMT          07950038
087400                                    DFT00002-S-T-D-DOL-AMT        07960038
087500                                    DFT00002-YTD-DOL-AMT          07970038
087600                                                                  07980038
087700** HISTORY IN SAME FISCAL MONTH AS DATE IN PROCESS                07990038
087800        WHEN  PV-CUR-DTE >= PV-CUR-MTD-BEG-DATE                   08000038
087900              AND <= PV-CUR-MTD-END-DATE                          08010038
088000                                                                  08020038
088100           ADD  PV-SAVED-DLYSLS TO DFT00002-MTD-DOL-AMT           08030038
088200                                 DFT00002-QTD-DOL-AMT             08040038
088300                                 DFT00002-S-T-D-DOL-AMT           08050038
088400                                 DFT00002-YTD-DOL-AMT             08060038
088500                                                                  08070038
088600** HISTORY IN SAME FISCAL QUARTER AS DATE IN PROCESS              08080038
088700        WHEN  PV-CUR-DTE >= PV-CUR-QTD-BEG-DATE                   08090038
088800              AND <= PV-CUR-QTD-END-DATE                          08100038
088900                                                                  08110038
089000           ADD  PV-SAVED-DLYSLS TO DFT00002-QTD-DOL-AMT           08120038
089100                                 DFT00002-S-T-D-DOL-AMT           08130038
089200                                 DFT00002-YTD-DOL-AMT             08140038
089300                                                                  08150038
089400** HISTORY IN SAME FISCAL SEASON AS DATE IN PROCESS               08160038
089500        WHEN  PV-CUR-DTE >= PV-CUR-STD-BEG-DATE                   08170038
089600              AND <= PV-CUR-STD-END-DATE                          08180038
089700                                                                  08190038
089800           ADD  PV-SAVED-DLYSLS TO DFT00002-S-T-D-DOL-AMT         08200038
089900                                 DFT00002-YTD-DOL-AMT             08210038
090000                                                                  08220038
090100** HISTORY IN SAME FISCAL YEAR AS DATE IN PROCESS                 08230038
090200        WHEN  PV-CUR-DTE >= PV-CUR-YTD-BEG-DTE                    08240038
090300              AND <= PV-CUR-YTD-END-DTE                           08250038
090400                                                                  08260038
090500           ADD  PV-SAVED-DLYSLS TO DFT00002-YTD-DOL-AMT           08270038
090600                                                                  08280038
090700** HISTORY FROM PRIOR PERIOD, THEN NOTHING TO UPDATE WHEN ROLLING 08290038
090800** FORWARD                                                        08300038
090900        WHEN OTHER                                                08310038
091000           SET PS-HISTORY-PRIOR-YR TO TRUE                        08320038
091100     END-EVALUATE.                                                08330038
091200                                                                  08340038
091300******************************************************************08350038
091400*   EXECUTRES THE SQL TO UPDATE HISTORY.                          08360038
091700******************************************************************08370038
091800 4700-UPDATE-HISTORY.                                             08380038
091900                                                                  08390038
092000     EXEC SQL                                                     08400038
092100                                                                  08410038
092200       UPDATE DFT_ML_FINCL_SUM                                    08420038
092300                                                                  08430038
092400          SET DLY_DOL_AMT    =  :DFT00002-DLY-DOL-AMT,            08440038
092500                                                                  08450038
092600              WTD_DOL_AMT    =  :DFT00002-WTD-DOL-AMT,            08460038
092700                                                                  08470038
092800              MTD_DOL_AMT    =  :DFT00002-MTD-DOL-AMT,            08480038
092900                                                                  08490038
093000              QTD_DOL_AMT    =  :DFT00002-QTD-DOL-AMT,            08500038
093100                                                                  08510038
093200              S_T_D_DOL_AMT  =  :DFT00002-S-T-D-DOL-AMT,          08520038
093300                                                                  08530038
093400              YTD_DOL_AMT    =  :DFT00002-YTD-DOL-AMT             08540038
093500                                                                  08550038
093600             WHERE                                                08560038
093700               SLS_DTE      = :PV-CUR-DTE AND                     08570038
093800               STR_NBR      = :PV-SAVED-STR AND                   08580038
093900               DEPT_NBR     = :PV-SAVED-DEPT                      08590038
094000    END-EXEC.                                                     08600038
094100                                                                  08610038
094200      EVALUATE TRUE                                               08620038
094300         WHEN SQLCODE = 0                                         08630038
094400*           CONTINUE                                              08640071
081700            ADD +1 TO PV-CNT-SINCE-COMMIT                         08641071
094500         WHEN OTHER                                               08650038
094600           DISPLAY 'SLS DTE= '   PV-CUR-DTE                       08660038
094700           DISPLAY 'STR NBR= '   PV-SAVED-STR                     08670038
094800           DISPLAY 'DEPT_NBR= '  PV-SAVED-DEPT                    08680038
094900           MOVE '4700-UPDATE-HISTORY' TO                          08690038
095000               PV-DB2-OPERATION                                   08700038
095100           PERFORM 9200-SQL-ABEND                                 08710038
095200      END-EVALUATE.                                               08720038
095300                                                                  08730038
095400******************************************************************08740038
095500* THIS SECTION SAVES OFF THE DATA CURRENTLY IN PROCESS TO COMPARE 08750038
095600* TO LATER IN ATTEMPT TO ENSURE SUMMARY BUCKETS (I.E. WTD, MTD)   08760038
095700* ARE ROLLED UP CORRECTLY.                                        08770038
095800******************************************************************08780038
095900 4800-SAVE-CURRNT-PROC-DATA.                                      08790038
096000                                                                  08800038
096100     MOVE  DFT00002-SLS-DTE        TO  PV-SAVED-DTE               08810038
096110                                       PV-INCREMENTING-DATE.      08820038
096200     MOVE  DFT00002-STR-NBR        TO  PV-SAVED-STR.              08830038
096300     MOVE  DFT00002-DEPT-NBR       TO  PV-SAVED-DEPT.             08840038
096500     COMPUTE PV-SAVED-DLYSLS = DF005-SLS-AMT + DF005-SLS-CORR-AMT.08850038
097000                                                                  08860038
097100******************************************************************08870038
097200*    THIS PARAGRAPH INCREMENTS THE DATE BY ONE AND SELECTS ALL OF 08880038
097300*    THE FISCAL GROUPINGS ASSOCIATED WITH IT.                     08890038
097400******************************************************************08900038
097500 4900-INCREMENT-DATE.                                             08910038
097600                                                                  08920038
097700     INITIALIZE DPG51 DPG52 DPG53                                 08930038
097800                DPG54 DPG55 DPG56.                                08940038
097900                                                                  08950038
098000     SET DPG51-FISCAL-454-CALENDAR  TO TRUE.                      08960038
098100     SET DPG51-INCREMENT-DATE       TO TRUE.                      08970038
098110     MOVE 1                         TO DPG51-INCR-DECR-DAYS-9     08980038
098200     SET DPG52-LK-DTE-ISO-FMT       TO TRUE.                      08990038
098300                                                                  09000038
098400*    DISPLAY 'DATE TO UPDATE = ' PV-INCREMENTING-DATE.            09010038
098500                                                                  09020038
098600     MOVE PV-INCREMENTING-DATE TO DPG52-DB2-ISO-DATE-FMT.         09030038
098700                                                                  09040038
098800     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    09050038
098900                                             DPG54 DPG55 DPG56.   09060038
099000                                                                  09070038
099100     IF DPG54-SEVERE-ERROR OR DPG54-DATE-INVALID                  09080038
099200         DISPLAY '** ABEND **'                                    09090038
099300         DISPLAY '** PROGRAM = DFKUP004'                          09100052
099400         DISPLAY 'DATE = ' PV-SAVED-DTE                           09110038
099500         DISPLAY DPG54-ERROR-MESSAGE                              09120038
099600         SET AC-INVALID-DATE-ERROR TO TRUE                        09130038
099700         CALL 'ILBOABN0' USING AC-ABEND-CODE                      09140038
099800     END-IF.                                                      09150038
099900                                                                  09160038
100000     MOVE DPG55-DB2-ISO-DATE-FMT     TO PV-CUR-DTE                09170038
100001                                        PV-INCREMENTING-DATE.     09180038
103000                                                                  09300038
103014******************************************************************09310038
103015* PROCESSES ROLLING DATA IN TABLE FROM ONE DAY TO THE NEXT        09320038
103016******************************************************************09330038
103017 5000-ROLL-TABLE-FORWARD.                                         09340038
103018                                                                  09350038
103019        PERFORM 5600-INCREMENT-DATE.                              09360038
103020        PERFORM 5100-OPEN-DFT-TABLE-CURSOR.                       09370038
103021        MOVE 'N' TO PS-END-OF-TABLE-SW.                           09380038
103022        PERFORM 5050-ROLL-ADAY UNTIL                              09390038
103023           PS-END-OF-TABLE.                                       09400038
103024        PERFORM 5300-CLOSE-DFT-TABLE-CURSOR.                      09410038
103025        MOVE PV-ROLLING-DATE TO PV-ROLLING-DATE-SAVED.            09420038
103026                                                                  09430038
103027                                                                  09440038
103028******************************************************************09450038
103029* PROCESSES THE DFT TABLE                                         09460038
103030******************************************************************09470038
103031 5050-ROLL-ADAY.                                                  09480038
103032                                                                  09490038
103033     PERFORM 5200-FETCH-DFT-TABLE-CURSOR.                         09500050
103034                                                                  09510038
103035     IF PS-END-OF-TABLE-SW = 'N'                                  09520053
103036        PERFORM 5400-PREPR-INSRT-TABLE                            09530053
103037        PERFORM 5500-INSRT-DFT-TABLE                              09540053
091300        IF PV-CNT-SINCE-COMMIT >= CC-COMMIT-CNT                   09541075
040016           PERFORM 9100-COMMIT-DB2                                09542075
040017        END-IF                                                    09543075
103038     END-IF.                                                      09550053
103039                                                                  09560038
103040                                                                  09570038
103041******************************************************************09580038
103042* 5100-OPEN-DFT-TABLE-CURSOR.                                     09590038
103043*     OPEN DFT_ML_FINCL_SUM CURSOR                                09600075
103044******************************************************************09610038
103050 5100-OPEN-DFT-TABLE-CURSOR.                                      09620038
103060                                                                  09630038
103070     EXEC SQL                                                     09640038
103080          OPEN DFT-TABLE-CURSOR                                   09650038
103090     END-EXEC.                                                    09660038
103091                                                                  09670038
103092     EVALUATE TRUE                                                09680038
103093         WHEN SQLCODE = PC-ROW-FOUND                              09690038
103094              CONTINUE                                            09700038
103095         WHEN SQLWARN0 NOT EQUAL SPACE                            09710038
103096         WHEN SQLCODE NOT EQUAL PC-ROW-FOUND                      09720038
103097             MOVE '5100-OPEN-DFT-TABLE-CURSOR'                    09730038
103098                                            TO PV-PARAGRAPH-NAME  09740038
103099             MOVE 'ERROR ON OPEN OF DFT-TABLE-CURSOR'             09750038
103100                                            TO PV-DB2-OPERATION   09760038
103101             PERFORM 9200-SQL-ABEND                               09770038
103102     END-EVALUATE.                                                09780038
103103                                                                  09790038
103104******************************************************************09800038
103105* 5200-FETCH-DFT-TABLE-CURSOR                                     09810038
103106*     FETCH THE DFT TABLE RECORD.                                 09820038
103107*                                                                 09830038
103108******************************************************************09840038
103109                                                                  09850038
103110 5200-FETCH-DFT-TABLE-CURSOR.                                     09860038
103111                                                                  09870038
103112     EXEC SQL                                                     09880038
103113         FETCH DFT-TABLE-CURSOR                                   09890038
103114          INTO   :DFT00002-SLS-DTE,                               09900038
103115                 :DFT00002-STR-NBR,                               09910038
103116                 :DFT00002-DEPT-NBR,                              09920038
103117                 :DFT00002-DLY-DOL-AMT,                           09930038
103118                 :DFT00002-WTD-DOL-AMT,                           09940038
103119                 :DFT00002-MTD-DOL-AMT,                           09950038
103120                 :DFT00002-QTD-DOL-AMT,                           09960038
103121                 :DFT00002-S-T-D-DOL-AMT,                         09970038
103122                 :DFT00002-YTD-DOL-AMT                            09980038
103123     END-EXEC.                                                    09990038
103124                                                                  10000038
103125     EVALUATE TRUE                                                10010038
103126         WHEN SQLCODE = PC-ROW-FOUND                              10020038
103127             MOVE 'N' TO PS-END-OF-TABLE-SW                       10030038
103128         WHEN SQLCODE = PC-ROW-NOT-FOUND                          10040038
103129             MOVE 'Y' TO PS-END-OF-TABLE-SW                       10050038
103130         WHEN SQLWARN0 NOT EQUAL SPACE                            10060038
103131         WHEN SQLCODE NOT EQUAL PC-ROW-FOUND                      10070038
103132             MOVE '5200-FETCH-PROMO-TABLE-CURSOR'                 10080038
103133                                            TO PV-PARAGRAPH-NAME  10090038
103134             MOVE 'ERROR ON FETCH OF PROMO-TABLE-CURSOR'          10100038
103135                                            TO PV-DB2-OPERATION   10110038
103136             PERFORM 9200-SQL-ABEND                               10120038
103137     END-EVALUATE.                                                10130038
103138                                                                  10140038
103139                                                                  10150038
103140******************************************************************10160038
103141* 5300-CLOSE-DFT-TABLE-CURSOR                                     10170038
103142******************************************************************10180038
103143 5300-CLOSE-DFT-TABLE-CURSOR.                                     10190038
103144                                                                  10200038
103145     EXEC SQL                                                     10210038
103146          CLOSE DFT-TABLE-CURSOR                                  10220038
103147     END-EXEC.                                                    10230038
103148                                                                  10240038
103149     EVALUATE TRUE                                                10250038
103150         WHEN SQLCODE = PC-ROW-FOUND                              10260038
103151              CONTINUE                                            10270038
103152         WHEN SQLWARN0 NOT EQUAL SPACE                            10280038
103153         WHEN SQLCODE NOT EQUAL PC-ROW-FOUND                      10290038
103154             MOVE '5300-CLOSE-DFT-TABLE-CURSOR'                   10300038
103155                                            TO PV-PARAGRAPH-NAME  10310038
103156             MOVE 'ERROR ON CLOSE OF DFT-TABLE-CURSOR'            10311038
103157                                            TO PV-DB2-OPERATION   10312038
103158             PERFORM 9200-SQL-ABEND                               10313038
103159     END-EVALUATE.                                                10314038
103160******************************************************************10315038
103161*   THIS SECTION SETS UP THE FIELDS TO BE UPDATED IN THE DFT      10316038
103162*   TABLE                                                         10316138
103163******************************************************************10316238
103164 5400-PREPR-INSRT-TABLE.                                          10316338
103165                                                                  10316438
103166     MOVE ZEROES TO DFT00002-DLY-DOL-AMT.                         10316538
103167     MOVE PV-ROLLING-DATE TO DFT00002-SLS-DTE.                    10316638
103168                                                                  10316738
103169** HISTORY NOT IN SAME FISCAL WEEK AS DATE IN PROCESS             10316838
103170        IF DFT00002-SLS-DTE <= PV-CUR-WTD-BEG-DATE                10316938
103171              OR > PV-CUR-WTD-END-DATE                            10317038
103172                                                                  10317138
103173           MOVE ZEROES              TO DFT00002-WTD-DOL-AMT       10317238
103174        END-IF                                                    10317338
103175                                                                  10317438
103176** HISTORY NOT IN SAME FISCAL MONTH AS DATE IN PROCESS            10317538
103177        IF DFT00002-SLS-DTE <= PV-CUR-MTD-BEG-DATE                10317638
103178              OR > PV-CUR-MTD-END-DATE                            10317738
103179                                                                  10317838
103180           MOVE ZEROES              TO DFT00002-MTD-DOL-AMT       10317938
103181        END-IF                                                    10318038
103182                                                                  10318138
103183** HISTORY NOT IN SAME FISCAL QUARTER AS DATE IN PROCESS          10318238
103184        IF DFT00002-SLS-DTE <= PV-CUR-QTD-BEG-DATE                10318338
103185              OR > PV-CUR-QTD-END-DATE                            10318438
103186                                                                  10318538
103187           MOVE ZEROES               TO DFT00002-QTD-DOL-AMT      10318638
103188        END-IF                                                    10318738
103189                                                                  10318838
103190** HISTORY NOT IN SAME FISCAL SEASON AS DATE IN PROCESS           10318938
103191        IF DFT00002-SLS-DTE <= PV-CUR-STD-BEG-DATE                10319038
103192              OR > PV-CUR-STD-END-DATE                            10319138
103193                                                                  10319238
103194           MOVE ZEROES              TO DFT00002-S-T-D-DOL-AMT     10319338
103195        END-IF                                                    10319438
103196                                                                  10319538
103197** HISTORY NOT IN SAME FISCAL YEAR AS DATE IN PROCESS             10319638
103198        IF DFT00002-SLS-DTE <= PV-CUR-YTD-BEG-DTE                 10319738
103199              OR > PV-CUR-YTD-END-DTE                             10319838
103200                                                                  10319938
103201           MOVE ZEROES              TO DFT00002-YTD-DOL-AMT       10320038
103202        END-IF.                                                   10320138
103203                                                                  10320238
103204******************************************************************10320338
103205* THIS SECTION WILL INSERT A ROW INTO THE DFT TABLE               10320438
103206******************************************************************10320538
103207 5500-INSRT-DFT-TABLE.                                            10320638
103208                                                                  10320738
103209     EXEC SQL                                                     10320838
103210       INSERT INTO DFT_ML_FINCL_SUM                               10320938
103211         VALUES                                                   10321038
103212           (:DFT00002-SLS-DTE                                     10321138
103213           ,:DFT00002-STR-NBR                                     10321238
103214           ,:DFT00002-DEPT-NBR                                    10321338
103215           ,:DFT00002-DLY-DOL-AMT                                 10321438
103216           ,:DFT00002-WTD-DOL-AMT                                 10321538
103217           ,:DFT00002-MTD-DOL-AMT                                 10321638
103218           ,:DFT00002-QTD-DOL-AMT                                 10321738
103219           ,:DFT00002-S-T-D-DOL-AMT                               10321838
103220           ,:DFT00002-YTD-DOL-AMT)                                10321938
103221     END-EXEC.                                                    10322038
103222                                                                  10322138
103223       EVALUATE TRUE                                              10322238
103224          WHEN SQLCODE = ZERO                                     10322338
103225*             CONTINUE                                            10322471
081700             ADD +1 TO PV-CNT-SINCE-COMMIT                        10322571
103226          WHEN OTHER                                              10322638
103227             DISPLAY 'SLS DATE= ' DFT00002-SLS-DTE                10322738
103228             DISPLAY 'STR NBR = ' DFT00002-STR-NBR                10322838
103229             DISPLAY 'DEPT NBR= ' DFT00002-DEPT-NBR               10322938
103230             DISPLAY 'DLY AMT=  ' DFT00002-DLY-DOL-AMT            10323038
103231             DISPLAY 'WTD AMT=  ' DFT00002-WTD-DOL-AMT            10323138
103232             DISPLAY 'MTD AMT=  ' DFT00002-MTD-DOL-AMT            10323238
103233             DISPLAY 'QTD AMT=  ' DFT00002-QTD-DOL-AMT            10323338
103234             DISPLAY 'STD AMT=  ' DFT00002-S-T-D-DOL-AMT          10323438
103235             DISPLAY 'YTD AMT= '  DFT00002-YTD-DOL-AMT            10323538
103236            MOVE '5500-INSRT-DFT-TABLE' TO                        10323665
103237                PV-DB2-OPERATION                                  10323738
103238            PERFORM 9200-SQL-ABEND                                10323838
103239       END-EVALUATE.                                              10323938
103240                                                                  10324038
103241*    THIS PARAGRAPH INCREMENTS THE DATE BY ONE AND SELECTS ALL OF 10324138
103242*    THE FISCAL GROUPINGS ASSOCIATED WITH IT.                     10324238
103243******************************************************************10324338
103244 5600-INCREMENT-DATE.                                             10324438
103245                                                                  10324538
103246     INITIALIZE DPG51 DPG52 DPG53                                 10324638
103247                DPG54 DPG55 DPG56.                                10324738
103248                                                                  10324838
103249     SET DPG51-FISCAL-454-CALENDAR  TO TRUE.                      10324938
103250     SET DPG51-INCREMENT-DATE       TO TRUE.                      10325038
103251     MOVE 1                         TO DPG51-INCR-DECR-DAYS-9     10325138
103252     SET DPG52-LK-DTE-ISO-FMT       TO TRUE.                      10325238
103253                                                                  10325338
103254     DISPLAY 'DATE TO BE ROLLED = '                               10325438
103255                               PV-ROLLING-DATE-SAVED.             10325538
103256                                                                  10325638
103257     MOVE PV-ROLLING-DATE-SAVED TO DPG52-DB2-ISO-DATE-FMT.        10325738
103258                                                                  10325838
103259     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    10325938
103260                                             DPG54 DPG55 DPG56.   10326038
103261                                                                  10326138
103262     IF DPG54-SEVERE-ERROR OR DPG54-DATE-INVALID                  10326238
103263         DISPLAY '** ABEND **'                                    10326338
103264         DISPLAY '** PROGRAM = DFKUP004'                          10326455
103265         DISPLAY 'DATE = ' PV-SAVED-DTE                           10326538
103266         DISPLAY DPG54-ERROR-MESSAGE                              10326638
103267         SET AC-INVALID-DATE-ERROR TO TRUE                        10326738
103268         CALL 'ILBOABN0' USING AC-ABEND-CODE                      10326838
103269     END-IF.                                                      10326938
103270                                                                  10327038
103271     MOVE DPG55-DB2-ISO-DATE-FMT TO PV-ROLLING-DATE.              10327138
103272     DISPLAY 'ROLLED DATE= ' PV-ROLLING-DATE.                     10327238
103273                                                                  10327338
103274                                                                  10327438
103308                                                                  10327538
103309******************************************************************10327638
103310* THIS SECTION WILL SELECT THE HISTORY SALES INFORMATION USING THE10327738
103400* MOST RECENT DATE FOR A STORE/DEPT COMBINATION.                  10327838
103500******************************************************************10327938
103600 7000-SLCT-CUR-HST-STR-DEPT.                                      10328038
103700                                                                  10328138
103710     INITIALIZE DCLDFT00002.                                      10329038
103720                                                                  10330038
103800     EXEC SQL                                                     10340038
103900           SELECT SLS_DTE,                                        10350038
104000                  STR_NBR,                                        10360038
104100                  DEPT_NBR,                                       10370038
104200                  DLY_DOL_AMT,                                    10380038
104300                  WTD_DOL_AMT,                                    10390038
104400                  MTD_DOL_AMT,                                    10400038
104500                  QTD_DOL_AMT,                                    10410038
104600                  S_T_D_DOL_AMT,                                  10420038
104700                  YTD_DOL_AMT                                     10430038
104800                                                                  10440038
104900          INTO   :DFT00002-SLS-DTE,                               10450038
105000                 :DFT00002-STR-NBR,                               10460038
105100                 :DFT00002-DEPT-NBR,                              10470038
105200                 :DFT00002-DLY-DOL-AMT,                           10480038
105300                 :DFT00002-WTD-DOL-AMT,                           10490038
105400                 :DFT00002-MTD-DOL-AMT,                           10500038
105500                 :DFT00002-QTD-DOL-AMT,                           10510038
105600                 :DFT00002-S-T-D-DOL-AMT,                         10520038
105700                 :DFT00002-YTD-DOL-AMT                            10530038
105800                                                                  10540038
105900              FROM DFT_ML_FINCL_SUM SUM                           10550038
106000                                                                  10560038
106300              WHERE SUM.SLS_DTE    =                              10570038
106400                    (                                             10580038
106500                     SELECT MAX(TMP.SLS_DTE)                      10590038
106600                       FROM DFT_ML_FINCL_SUM TMP                  10600038
106700                      WHERE TMP.STR_NBR   = :DF005-STR-NBR AND    10610038
106800                            TMP.DEPT_NBR  = :PV-DEPT-NBR-COMP AND 10620038
106810                            TMP.SLS_DTE BETWEEN                   10630038
106811                            :PV-CUR-YTD-BEG-DTE        AND        10640038
106820                            :PV-CUR-YTD-END-DTE                   10650038
106900                    )  AND                                        10660038
106901                    SUM.STR_NBR    = :DF005-STR-NBR    AND        10670038
106902                    SUM.DEPT_NBR   = :PV-DEPT-NBR-COMP            10680038
106910                                                                  10690038
106920            WITH UR                                               10691038
107000     END-EXEC.                                                    10692038
107100                                                                  10693038
107200       EVALUATE TRUE                                              10694038
107300          WHEN SQLCODE = ZERO                                     10695038
107400             SET PS-NO-MISSING-HIST-ML-SLS TO TRUE                10696038
107500          WHEN SQLCODE = PC-ROW-NOT-FOUND                         10697038
107600             SET PS-ML-HIST-SLS-MISSING TO TRUE                   10698038
107700          WHEN OTHER                                              10699038
107800            DISPLAY 'SLS DTE= '   DF005-KY-DTE                    10700038
107900            DISPLAY 'STR NBR= '   DF005-STR-NBR                   10710038
108000            DISPLAY 'DEPT_NBR= '  PV-DEPT-NBR-COMP                10720038
108100            MOVE '7000-SLCT-CUR-HST-STR-DEPT' TO                  10730038
108200                PV-DB2-OPERATION                                  10740038
108300            PERFORM 9200-SQL-ABEND                                10750038
108400       END-EVALUATE.                                              10760038
108500                                                                  10770038
108510******************************************************************10780038
108520* THIS SECTION WILL INSERT A ROW THAT HAS NO HISTORY OF SALES     10790038
108530* WITHIN THE FISCAL YEAR TO THE ML FLASH SUMMARY TABLE.           10800038
108550******************************************************************10810038
108560 7700-INSRT-ML-SLS-SUMMARY.                                       10820038
108570                                                                  10830038
108580     EXEC SQL                                                     10840038
108590       INSERT INTO DFT_ML_FINCL_SUM                               10850038
108591         VALUES                                                   10851038
108592           (:DFT00002-SLS-DTE                                     10852038
108593           ,:DFT00002-STR-NBR                                     10853038
108594           ,:DFT00002-DEPT-NBR                                    10854038
108595           ,:DFT00002-DLY-DOL-AMT                                 10855038
108596           ,:DFT00002-WTD-DOL-AMT                                 10856038
108597           ,:DFT00002-MTD-DOL-AMT                                 10857038
108598           ,:DFT00002-QTD-DOL-AMT                                 10858038
108599           ,:DFT00002-S-T-D-DOL-AMT                               10859038
108600           ,:DFT00002-YTD-DOL-AMT)                                10860038
108601     END-EXEC.                                                    10860138
108602                                                                  10860238
108603       EVALUATE TRUE                                              10860338
108604          WHEN SQLCODE = ZERO                                     10860438
108605             SET PS-NO-UPDATE-ML-SALES TO TRUE                    10860538
081700             ADD +1 TO PV-CNT-SINCE-COMMIT                        10860671
091300             IF PV-CNT-SINCE-COMMIT >= CC-COMMIT-CNT              10860775
040016                  PERFORM 9100-COMMIT-DB2                         10860875
040017             END-IF                                               10860975
108609          WHEN SQLCODE = -803                                     10861138
108610             SET PS-UPDATE-ML-SALES TO TRUE                       10861238
108611          WHEN OTHER                                              10861338
108612             DISPLAY 'SLS DATE= ' DFT00002-SLS-DTE                10861438
108613             DISPLAY 'STR NBR = ' DFT00002-STR-NBR                10861538
108614             DISPLAY 'DEPT NBR= ' DFT00002-DEPT-NBR               10861638
108615             DISPLAY 'DLY AMT=  ' DFT00002-DLY-DOL-AMT            10861738
108616             DISPLAY 'WTD AMT=  ' DFT00002-WTD-DOL-AMT            10861838
108617             DISPLAY 'MTD AMT=  ' DFT00002-MTD-DOL-AMT            10861938
108618             DISPLAY 'QTD AMT=  ' DFT00002-QTD-DOL-AMT            10862038
108619             DISPLAY 'STD AMT=  ' DFT00002-S-T-D-DOL-AMT          10862138
108620             DISPLAY 'YTD AMT= '  DFT00002-YTD-DOL-AMT            10862238
108621            MOVE '7700-INSRT-ML-SLS-SUMMARY' TO                   10862338
108622                PV-DB2-OPERATION                                  10862438
108623            PERFORM 9200-SQL-ABEND                                10862538
108624       END-EVALUATE.                                              10862638
108625                                                                  10862738
109601***************************************************************** 10867038
109602* CLOSES ANY OPEN FILES.                                          10868038
109603***************************************************************** 10869038
109604 9000-CLEANUP.                                                    10870038
109605                                                                  10880038
109603***************************************************************** 10890038
109603**  IF HOLIDAY FALLS AT LAST DAY OF WEEK AND STORE IS CLOSED      10900038
109603**  WE WILL NEED TO ROLL DATA FORWARD FROM PREVISOU DATE.         10910038
109603***************************************************************** 10920038
030900     IF (DF005-KY-DTE >= PV-CONTROL-DATE-FMT) AND                 10930038
038201        (PV-ROLLING-DATE < PV-CUR-WTD-END-DATE)                   10940038
038203           PERFORM 5000-ROLL-TABLE-FORWARD UNTIL                  10950038
038204             PV-ROLLING-DATE = PV-CUR-WTD-END-DATE                10960038
038223     END-IF.                                                      10961038
109606     PERFORM 9100-COMMIT-DB2.                                     10961138
109614                                                                  10961338
109615******************************************************************10961438
109620 9100-COMMIT-DB2.                                                 10961538
109630******************************************************************10961638
109631                                                                  10961738
109640     EXEC SQL                                                     10961838
109650        COMMIT                                                    10961938
109660     END-EXEC.                                                    10962038
109670                                                                  10963038
109680     EVALUATE TRUE                                                10964038
109690        WHEN SQLCODE = 0                                          10965038
                 CONTINUE                                               10966038
109692        WHEN OTHER                                                10967038
109696           MOVE '9100-COMMIT-DB2' TO                              10968038
109697               PV-DB2-OPERATION                                   10969038
109698           PERFORM 9200-SQL-ABEND                                 10969138
109700            CALL 'ILBOABN0' USING AC-ABEND-CODE                   10969238
109701     END-EVALUATE.                                                10969338
040016                                                                  10969471
040016     MOVE ZEROS TO PV-CNT-SINCE-COMMIT.                           10969571
109702                                                                  10969671
109710***************************************************************** 10969771
109800* 9200-SQL-ABEND                                                  10969871
109900*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.10969971
110000***************************************************************** 10970071
110100 9200-SQL-ABEND.                                                  10970171
110110                                                                  10971038
110200     DISPLAY '** ABEND     **'.                                   10980038
110300     DISPLAY '** PROGRAM   ** = ' PC-PGM-NAME.                    10990038
110400     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               11000038
110500     DISPLAY '** SQLCODE= ' SQLCODE.                              11010038
110600     SET AC-DB2-ERROR TO TRUE.                                    11020038
110700     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         11030038
036000******************************************************************11040055
036100* BUILD THE COMMUNICATION AREA FOR A CALL TO THE TRANSACTION      11050055
036200* PRESENTATION MODULE                                             11060055
036300******************************************************************11070055
036400 X100-BUILD-COMM-AREA-TRAN-PRES.                                  11080055
036500                                                                  11090055
036600     MOVE LENGTH OF                                               11100055
036700          WORK-STORAGE-PASSED TO DP001-WORK-STRG-LENGTH.          11110055
036800     MOVE PC-CKPT-JOB-NAME    TO DP001-JOB-NAME.                  11120055
036900     MOVE PC-CKPT-PLAN-NAME   TO DP001-PLAN-NAME.                 11130055
037000                                                                  11140055
037100     PERFORM X200-CALL-TRANS-PRES-MODULE.                         11150055
037200                                                                  11160055
037300     MOVE DP001-TRANS-RECORD  TO DF005-RECORD.                    11170056
037400                                                                  11180055
037500     IF  DP001-CKPT-TAKEN                                         11190055
037600         ADD 1 TO PA-CKPT                                         11200055
037800         INITIALIZE PV-DEADLOCK-COUNTER                           11220055
037900     END-IF.                                                      11230055
038000                                                                  11240055
038100                                                                  11250055
038200******************************************************************11260055
038300* VERIFY THE RETURN CODE ON THE CALLED MODULE                     11270055
038400******************************************************************11280055
038500 X200-CALL-TRANS-PRES-MODULE.                                     11290055
038600                                                                  11300055
038700     PERFORM Z900-CALL-TRANS-PRES-MODULE.                         11310055
038800                                                                  11320055
038900     IF  DP001-GOOD-RET-CODE                                      11330055
039000     OR  DP001-CKPT-TAKEN                                         11340055
039100     OR  DP001-RESTART                                            11350055
039200         CONTINUE                                                 11360055
039400     ELSE                                                         11380055
039500         MOVE 'X200-CALL-TRANS-PRES-MODULE' TO PV-PARAGRAPH-NAME  11390055
039600         MOVE '** BAD CALL TO TRANS PREP MODULE **'               11400055
039700                                            TO PV-OPERATION-MSG   11410055
039800         MOVE DP001-RET-CODE                TO PV-RET-CODE        11420055
040000         SET ABEND-4019-CAL-SUB-ERROR TO TRUE                     11440055
040200         PERFORM Z100-ABEND                                       11460055
040300     END-IF.                                                      11470055
040400                                                                  11480055
040500                                                                  11490055
040600******************************************************************11500055
040700* NON-DB2 ABEND                                                   11510055
040800******************************************************************11520055
040900 Z100-ABEND.                                                      11530055
041000                                                                  11540055
041100     PERFORM Z999-CONTROLS.                                       11550055
041200                                                                  11560055
041300     DISPLAY '                     '.                             11570055
041400     DISPLAY '** ABEND           **'.                             11580055
041500     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          11590055
041600     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        11600055
041700     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG.         11610055
041800     DISPLAY '** RETURN CODE     ** = ' PV-RET-CODE.              11620055
041900                                                                  11630055
042000     CALL 'ILBOABN0' USING ABEND-CODE.                            11640055
042100                                                                  11650055
042300******************************************************************11670055
042400* ABEND THE PROGRAM IN THE EVENT THAT A SQL ERROR OR WARNING      11680055
042500* CODE OCCURS.                                                    11690055
042600******************************************************************11700055
042700 Z200-SQL-ABEND.                                                  11710055
042800                                                                  11720055
042900     PERFORM Z999-CONTROLS.                                       11730055
043000                                                                  11740055
043100     DISPLAY '** ABEND     **'.                                   11750055
043200     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                11760055
043300     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              11770055
043400     DISPLAY '** OPERATION ** = ' PV-DB2-OPER-ATTEMPTED.          11780055
043500                                                                  11790055
043600******************************************************************11800055
043700* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    11810055
043800* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         11820055
043900* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     11830055
044000* FORMAT.                                                         11840055
044100******************************************************************11850055
044200     COPY DPPD004.                                                11860055
044300                                                                  11870055
044400     SET ABEND-4013-DB2-ERROR TO TRUE.                            11880055
044500                                                                  11890055
044600     CALL 'ILBOABN0' USING ABEND-CODE.                            11900055
044700                                                                  11910055
044900******************************************************************11930055
045000* PREFORMS TASK TERMINATION PROCESSING                            11940055
045100******************************************************************11950055
045200 Z990-EOJ-ROUTINE.                                                11960055
045300                                                                  11970055
045400     MOVE PC-TRAN-PRES-FUNC-CLOSE TO DP001-FUNC-CODE.             11980055
045500                                                                  11990055
045600     PERFORM X100-BUILD-COMM-AREA-TRAN-PRES.                      12000055
045700                                                                  12010055
045800     PERFORM Z999-CONTROLS.                                       12020055
045900                                                                  12030055
046100******************************************************************12050055
046200* DISPLAY CONTROLS FROM THE PROGRAM                               12060055
046300******************************************************************12070055
046400 Z999-CONTROLS.                                                   12080055
046500                                                                  12090055
046600     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 12100055
046700                                                                  12110055
046800     MOVE SYS-TIME (1:2) TO ST-END-HR.                            12120055
046900     MOVE SYS-TIME (3:2) TO ST-END-MN.                            12130055
047000                                                                  12140055
047100     DISPLAY '                    '.                              12150055
047200     DISPLAY '**********************'.                            12160055
047300     DISPLAY '   DFKUP004 CONTROLS  '.                            12170055
047400     DISPLAY '**********************'.                            12180055
047500     DISPLAY 'RUN DATE  = ' SD-EDIT-DATE.                         12190055
047600     DISPLAY 'BEG TIME  = ' ST-BEG-TIME.                          12200055
047700     DISPLAY 'END TIME  = ' ST-END-TIME.                          12210055
047800     DISPLAY '======================'.                            12220055
047900     DISPLAY 'RECORDS READ   = ' PA-READ.                         12230055
048000     DISPLAY 'CHECKPOINTS    = ' PA-CKPT.                         12240055
048500                                                                  12290055
048700******************************************************************12310055
048800* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    12320055
048900* MENTS THAT ARE REQUIRED TO INVOKE THE TRANSACTION PRESENTATION  12330055
049000* MODULE (DPKUT901) OF THE DB2 CHECKPOINT RESTART SYSTEM.         12340055
049100******************************************************************12350055
049200     COPY DPPD001.                                                12360055
049300                                                                  12370055
