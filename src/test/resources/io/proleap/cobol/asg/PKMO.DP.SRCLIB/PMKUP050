       IDENTIFICATION DIVISION.                                         00010000
                                                                        00020000
       PROGRAM-ID.    PMKUP050.                                         00030000
       AUTHOR.        JOHN SELWITSCHKA.                                 00040000
       INSTALLATION.  KOHLS DEPARTMENT STORES.                          00050000
       DATE-WRITTEN.  08/29/2012.                                       00060000
       DATE-COMPILED.                                                   00070000
                                                                        00080000
      ******************************************************************00090000
      *           PMKUP050 - XST PROMO TABLES ACTUAL START AND END     *00100000
      *                      TIMESTAMPS UPDATE.                        *00110033
      *                                                                *00110133
      *           THIS PROGRAM READS A CONTROL CARD FILE (PMSI050)     *00111033
      *           CONTAINING PROMOTION ID'S AND/OR REBATE ID'S AND     *00112033
      *           SETS THE ACTUAL START AND END TIMESTAMPS TO MATCH    *00113035
      *           THE DEFAULT START AND END TIMESTAMPS ON THE          *00114033
      *           FOLLOWING TABLES:                                    *00115035
      *                             XST_PROMO                          *00116033
      *                             XST_PROMO_STR_GP                   *00117033
      *                             XST_PROMO_ADHC_RLT                 *00118033
      *                                                                *00118133
      *           THE FORMAT OF THE CONTROL CARD IS:                   *00119033
      *                                                                *00119133
      *           * PROMO ID'S MUST BE NUMERIC AND IN COLUMNS 2 THRU 11*00119237
      *           -----+---1-                                          *00119333
      *            0000000001                                          *00119436
      *            0000000002                                          *00119536
      *                                                                *00119633
      ******************************************************************00130000
      * WR/IR #           DATE     DESCRIPTION                         *00140000
      * --------        --------  ---------------------------------    *00150000
      * CRQ000000032594 08/29/12  INITIAL CREATION                     *00160033
      ******************************************************************00170000
                                                                        00180000
       ENVIRONMENT DIVISION.                                            00190000
                                                                        00200000
       CONFIGURATION SECTION.                                           00210000
       SOURCE-COMPUTER.        IBM-3090.                                00220000
       OBJECT-COMPUTER.        IBM-3090.                                00230000
       INPUT-OUTPUT SECTION.                                            00240000
       FILE-CONTROL.                                                    00250000
                                                                        00260000
           SELECT CNTL-PROMO-ID-FILE                                    00290000
               ASSIGN TO INP01.                                         00300000
                                                                        00310000
       DATA DIVISION.                                                   00320000
       FILE SECTION.                                                    00330000
                                                                        00340000
       FD  CNTL-PROMO-ID-FILE                                           00410000
           LABEL RECORDS ARE STANDARD                                   00420000
           RECORDING MODE IS F                                          00430000
           BLOCK CONTAINS 0 RECORDS.                                    00440000
       01  CNTL-PROMO-ID-RECORD        PIC X(80).                       00450000
                                                                        00460006
                                                                        00470000
       WORKING-STORAGE SECTION.                                         00480000
                                                                        00490000
       01  FILLER                      PIC X(28)   VALUE                00500000
                'BEGINNING OF WORKING STORAGE'.                         00510000
                                                                        00520000
       01  ABEND-CODE                  PIC S9(04)  VALUE ZERO COMP SYNC.00530000
                                                                        00540000
       01  PC-PROGRAM-CONSTANTS.                                        00550000
           05  PC-JOB-NAME             PIC  X(06)    VALUE 'PMK053'.    00560047
           05  PC-PROGRAM-NAME         PIC  X(08)    VALUE 'PMKUP050'.  00570000
           05  PC-MAX-RETRIES          PIC S9(04)    VALUE +3           00580003
                                                     COMP SYNC.         00581003
                                                                        00590000
       01  PE-PROGRAM-ERROR-MESSAGES.                                   00600000
           05  PE-MSG-00                       PIC X(50) VALUE          00611040
                'ATTEMPT TO SELECT XST_PROMO TABLE FAILED          '.   00620040
           05  PE-MSG-01                       PIC X(50) VALUE          00621040
                'ATTEMPT TO UPDATE XST_PROMO TABLE FAILED          '.   00622040
           05  PE-MSG-02                       PIC X(50) VALUE          00630007
                'ATTEMPT TO OPEN CURSOR XST_MDSE_LNE_SELN FAILED   '.   00640007
           05  PE-MSG-03                       PIC X(50) VALUE          00640107
                'ATTEMPT TO FETCH CURSOR XST_MDSE_LNE_SELN FAILED  '.   00640207
           05  PE-MSG-04                       PIC X(50) VALUE          00641007
                'ATTEMPT TO UPDATE XST_PROMO_STR_GP TABLE FAILED   '.   00642007
           05  PE-MSG-05                       PIC X(50) VALUE          00650005
                'ATTEMPT TO UPDATE XST_PROMO_ADHC_RLT TABLE FAILED '.   00660007
           05  PE-MSG-06                       PIC X(50) VALUE          00661007
                'ATTEMPT TO CLOSE CURSOR XST_MDSE_LNE_SELN FAILED  '.   00662007
           05  PE-MSG-07                       PIC X(50) VALUE          00670003
                'ERROR IN SELECT FROM TCKRSTCNTL                   '.   00680007
           05  PE-MSG-08                       PIC X(50) VALUE          00690003
                'UPDATE TO TCKRSTINF FAILED                        '.   00700007
           05  PE-MSG-09                       PIC X(50) VALUE          00710003
                'ERROR IN SELECT FROM TCKRSTINF                    '.   00720007
           05  PE-MSG-10                       PIC X(50) VALUE          00721007
                'PROGRAM ABENDED WHILE TRYING TO PERFORM A COMMIT  '.   00722007
           05  PE-MSG-11                       PIC X(50) VALUE          00730007
                'UPDATE TO TCKRSTINF FAILED                        '.   00740007
           05  PE-MSG-12                       PIC X(50) VALUE          00750007
                'MAXIMUM RETRIES HAS BEEN EXCEEDED                 '.   00760007
                                                                        00770006
       01  PS-PROGRAM-SWITCHES.                                         00780000
           05  PS-PROMO-ID-FOUND-SW         PIC X(01)     VALUE 'N'.    00810044
               88  PS-PROMO-ID-FOUND                      VALUE 'Y'.    00820044
               88  PS-PROMO-ID-NOT-FOUND                  VALUE 'N'.    00820144
           05  PS-EOF-PROMO-ID-FILE-SW      PIC X(01)     VALUE 'N'.    00820244
               88  PS-EOF-PROMO-ID-FILE                   VALUE 'Y'.    00820344
           05  PS-XST00028-NOT-FOUND-SW     PIC X(01)     VALUE 'N'.    00821009
               88  PS-XST00028-NOT-FOUND                  VALUE 'Y'.    00822009
           05  PS-FIRST-COMMIT-SW           PIC X(01)     VALUE 'N'.    00830000
               88  PS-FIRST-COMMIT                        VALUE 'Y'.    00840000
           05  PS-DEADLOCK-RESTART-SW       PIC X(01)     VALUE 'N'.    00850000
               88  PS-PROGRAM-DEADLOCKED                  VALUE 'Y'.    00860000
                                                                        00890006
       01  CC-CONTROL-CARD.                                             00900000
           05  CC-COMMENT-IND            PIC  X(01) VALUE '*'.          00901027
               88  CC-NOT-COMMENT                   VALUE SPACES.       00902025
               88  CC-COMMENT                       VALUE '*', '-'.     00903034
           05  CC-PROMO-ID               PIC  9(10) VALUE ZEROES.       00910022
           05  FILLER                    PIC  X(69) VALUE SPACES.       00920024
                                                                        00930006
       01  PROGRAM-VARIABLES.                                           00940000
           05  PV-RETRY-COUNT            PIC S9(04) VALUE +0.           00950000
           05  PV-DEADLOCK-COUNT         PIC S9(04) VALUE +0.           00960000
           05  PV-PARAGRAPH-NAME         PIC  X(30) VALUE SPACES.       00970000
           05  PV-ABEND-MESSAGE          PIC  X(75) VALUE SPACES.       00980000
           05  PV-OPERATION-ATTEMPTED    PIC  X(50) VALUE SPACES.       00990000
           05  PV-CURRENT-TIMESTAMP      PIC  X(26) VALUE SPACES.       01000000
           05  PV-COMMIT-TIMESTAMP       PIC  X(26) VALUE SPACES.       01010000
           05  PV-DISPLAY-FIELD          PIC ZZZZZZZZ9  VALUE ZERO.     01020000
           05  PV-DB2-DATE-EXISTS        PIC  X(01) VALUE SPACES.       01030000
                                                                        01040006
       01  PA-PROGRAM-ACCUMULATORS.                                     01050000
           05  PA-RECORD-COUNTS.                                        01060000
               10  PA-INPUT-COUNT        PIC  9(09)  VALUE ZEROES.      01070000
               10  PA-INPUT-PROMO-COUNT  PIC  9(09)  VALUE ZEROES.      01071028
               10  PA-INVALID-PROMO-ID-COUNT                            01072040
                                         PIC  9(09)  VALUE ZEROES.      01073040
               10  PA-XST00026-UPDATES-PERFORMED                        01080007
                                         PIC  9(09)  VALUE ZEROES.      01081007
               10  PA-XST00029-UPDATES-PERFORMED                        01082007
                                         PIC  9(09)  VALUE ZEROES.      01083007
               10  PA-XST00031-UPDATES-PERFORMED                        01084007
                                         PIC  9(09)  VALUE ZEROES.      01085007
               10  PA-XST00026-UPDATE-COUNT                             01086007
                                         PIC  9(09)  VALUE ZEROES.      01087007
               10  PA-XST00028-FETCH-COUNT                              01087107
                                         PIC  9(09)  VALUE ZEROES.      01087207
               10  PA-XST00029-UPDATE-COUNT                             01088007
                                         PIC  9(09)  VALUE ZEROES.      01089007
               10  PA-XST00031-UPDATE-COUNT                             01090007
                                         PIC  9(09)  VALUE ZEROES.      01091007
               10  PA-COMMIT-COUNT       PIC  9(13)  VALUE ZEROES.      01100040
                                                                        01110006
       01  PD-PROGRAM-DISPLAYS.                                         01120000
           05  PD-DEADLOCK-COUNT         PIC  9(04) VALUE 0.            01130000
                                                                        01130106
      ******************************************************************01131006
      * CHECKPOINT RESTART VARIABLES AND PREV COMMIT VARIABLES.        *01132006
      ******************************************************************01133006
       01  CR-CHECKPOINT-RESTART-AREA.                                  01134006
           05  CR-AREA-LEN                  PIC S9(04) VALUE +32 COMP.  01135045
           05  CR-CHECKPOINT-RESTART-VAR.                               01136006
               10  CR-PROMO-ID              PIC 9(10) VALUE ZEROES.     01137006
               10  CR-INPUT-READ-COUNT      PIC 9(09) VALUE ZEROES.     01138006
               10  CR-COMMIT-COUNT          PIC 9(13) VALUE ZEROES.     01138140
                                                                        01139006
       01  CK-CHECKPOINT-SAVE-AREA.                                     01139106
           05  CK-SAVE-PREV-KEY.                                        01139206
               10  CK-PROMO-ID            PIC 9(10)  VALUE ZEROES.      01139306
               10  CK-INPUT-READ-COUNT    PIC 9(09)  VALUE ZEROES.      01139406
                                                                        01139506
                                                                        01140006
      ******************************************************************01200000
      *  DB2 ERROR MESSAGES FORMAT AREA.                                01210000
      ******************************************************************01220000
           COPY DPWS004.                                                01230000
                                                                        01240006
      ******************************************************************01250000
      *  USED FOR DB2 ERRORS                                            01260000
      ******************************************************************01270000
           EXEC SQL                                                     01280000
               INCLUDE SQLCA                                            01290000
           END-EXEC.                                                    01300000
                                                                        01310006
      ******************************************************************01390000
      *  XST PROMOTION TABLE (XST_PROMO)                                01400000
      ******************************************************************01410000
           EXEC SQL                                                     01420000
               INCLUDE XST00026                                         01430000
           END-EXEC.                                                    01440000
                                                                        01450006
      ******************************************************************01450100
      *  XST MERCHANDISE LINE TABLE (XST_MDSE_LNE_SELN)                 01450200
      ******************************************************************01450300
           EXEC SQL                                                     01450400
               INCLUDE XST00028                                         01450500
           END-EXEC.                                                    01450600
                                                                        01450706
      ******************************************************************01451000
      *  XST PROMOTION STORE GROUP TABLE (XST_PROMO_STR_GP)             01452000
      ******************************************************************01453000
           EXEC SQL                                                     01454000
               INCLUDE XST00029                                         01455000
           END-EXEC.                                                    01456000
                                                                        01457006
      ******************************************************************01458000
      *  XST PROMOTION ADHOC RELATION TABLE (XST_PROMO_ADHC_RLT)        01459000
      ******************************************************************01459100
           EXEC SQL                                                     01459200
               INCLUDE XST00031                                         01459300
           END-EXEC.                                                    01459400
                                                                        01459506
      ***************************************************************** 01461000
      * DB2 CHECKPOINT RESTART CONTROL TABLE AND RESTART INFO TABLE     01470000
      ***************************************************************** 01480000
           EXEC SQL                                                     01490000
               INCLUDE TCKRSTCN                                         01500000
           END-EXEC.                                                    01510000
                                                                        01520006
           EXEC SQL                                                     01530000
               INCLUDE TCKRSTIN                                         01540000
           END-EXEC.                                                    01550000
                                                                        01560006
      ******************************************************************01561007
      *  CURSOR ON XST_MDSE_LNE_SELN TABLE                              01562007
      ******************************************************************01563007
                                                                        01564007
           EXEC SQL                                                     01565007
              DECLARE XST00028_CSR CURSOR WITH HOLD FOR                 01566007
                  SELECT                                                01567007
                      PROMO_INTFC_ID                                    01568007
                     ,MDSE_LNE_ID                                       01569007
                  FROM                                                  01569407
                      XST_MDSE_LNE_SELN                                 01569507
                  WHERE PROMO_ID = :XST00028-PROMO-ID                   01569607
                   WITH UR                                              01569716
           END-EXEC.                                                    01569807
                                                                        01570007
      *----------------------------------------------------------------*01930004
       PROCEDURE DIVISION.                                              01940000
      *----------------------------------------------------------------*01950004
                                                                        01960000
       0000-PMKUP050.                                                   01970001
                                                                        01971004
           PERFORM 1000-INITIALIZATION.                                 01980000
                                                                        01990004
           PERFORM 2000-PROCESS-INPUT                                   02000000
                UNTIL PS-EOF-PROMO-ID-FILE.                             02010001
                                                                        02020004
           PERFORM 8000-EOJ-ROUTINE.                                    02030000
                                                                        02040000
           STOP RUN.                                                    02050000
                                                                        02060000
      ******************************************************************02070000
      * OPEN INPUT FILE , INITIALIZE COUNTERS , READ FIRST INPUT RECORD 02080000
      * PREPARE CHECKPOINT RESTART TABLES FOR PROCESSING / RESTART      02090000
      ******************************************************************02100000
                                                                        02110007
       1000-INITIALIZATION.                                             02120000
                                                                        02130007
           OPEN INPUT CNTL-PROMO-ID-FILE.                               02140001
                                                                        02160000
           PERFORM 7400-INIT-CHECKPOINT-SELECT.                         02170000
      * CKPT-STAT-CODE = '9' INDICATES A RESTART CONDITION              02180000
           IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           02190000
               PERFORM 7500-SELECT-RESTART-INFO                         02200000
               MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO                    02210000
                                           CR-CHECKPOINT-RESTART-VAR    02220002
               DISPLAY 'PROMO ID       : ' CR-PROMO-ID                  02221002
               DISPLAY 'INPUT RECS READ: ' CR-INPUT-READ-COUNT          02450002
           ELSE                                                         02460000
               SET PS-FIRST-COMMIT TO TRUE                              02470000
               INITIALIZE CR-CHECKPOINT-RESTART-VAR                     02480000
           END-IF.                                                      02490000
                                                                        02500007
           PERFORM 4000-READ-PROMO-ID-FILE UNTIL                        02520001
               CC-NOT-COMMENT                                           02531026
            OR PS-EOF-PROMO-ID-FILE.                                    02540001
                                                                        02550007
           PERFORM 4000-READ-PROMO-ID-FILE UNTIL                        02551026
               PA-INPUT-COUNT > CR-INPUT-READ-COUNT                     02552026
            OR PS-EOF-PROMO-ID-FILE.                                    02554026
                                                                        02555026
           IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           02560000
               DISPLAY 'INPUT FILE RESTARTED ON RECORD '                02570000
                        PA-INPUT-COUNT                                  02580000
               DISPLAY 'PROMO ID       : ' CC-PROMO-ID                  02590002
           END-IF.                                                      02790000
                                                                        02800000
           IF PS-EOF-PROMO-ID-FILE                                      02810001
               IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                       02820000
                   CONTINUE                                             02830000
               ELSE                                                     02840000
                   DISPLAY '** NO PROMO ID''S IN CONTROL CARD **'       02850013
               END-IF                                                   02860000
           ELSE                                                         02870000
               PERFORM 7300-GET-COMMIT-TIMESTAMP                        02880000
               DISPLAY 'COMMITS WILL BE TAKEN EVERY ',                  02890000
                    TCKRSTCNTL-CKPT-FRQNCY-QTY, ' SECONDS.'             02900000
           END-IF.                                                      02910000
                                                                        02920000
      ******************************************************************02930000
      * PROCESS THE PROMOTION ID'S FROM THE CONTROL CARD                02940002
      ******************************************************************02950000
       2000-PROCESS-INPUT.                                              02960000
                                                                        02970007
           PERFORM 5000-SELECT-XST00026                                 02981040
                                                                        02990040
           IF PS-PROMO-ID-FOUND                                         03000044
                                                                        03010040
               PERFORM 5100-UPDATE-XST00026                             03060040
                                                                        03070040
               PERFORM 6000-OPEN-XST00028-CSR                           03110040
               PERFORM 6100-FETCH-XST00028-CSR                          03120040
               PERFORM 6200-UPDATE-XST00029-XST00031                    03121040
                 UNTIL PS-XST00028-NOT-FOUND                            03122040
               PERFORM 6300-CLOSE-XST00028-CSR                          03123040
                                                                        03124040
           END-IF.                                                      03125040
                                                                        03140004
           PERFORM 4000-READ-PROMO-ID-FILE.                             03145004
                                                                        03146029
      ******************************************************************03150000
      * READS THE PROMOTION ID CONTROL CARD                             03160004
      ******************************************************************03170000
       4000-READ-PROMO-ID-FILE.                                         03180001
           READ CNTL-PROMO-ID-FILE INTO CC-CONTROL-CARD                 03190001
              AT END                                                    03200000
                MOVE 'Y' TO PS-EOF-PROMO-ID-FILE-SW.                    03210001
                                                                        03220007
           IF PS-EOF-PROMO-ID-FILE                                      03230001
               IF PA-INPUT-COUNT = 0                                    03240000
                    INITIALIZE CC-CONTROL-CARD                          03250001
               END-IF                                                   03260000
               MOVE CC-PROMO-ID               TO CR-PROMO-ID            03270001
               MOVE PA-INPUT-COUNT            TO CR-INPUT-READ-COUNT    03390000
               MOVE PA-COMMIT-COUNT           TO CR-COMMIT-COUNT        03391040
      *        MOVE COMMIT INFO TO WORKING STORAGE ROW                  03400000
               MOVE CR-CHECKPOINT-RESTART-AREA TO                       03410000
                                             TCKRSTINF-WORK-STRG-DESC   03420000
               EXEC SQL                                                 03430000
                 UPDATE TCKRSTINF                                       03440000
                    SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC      03450000
                  WHERE JOB_NAME   = :PC-JOB-NAME                       03460000
                    AND PLAN_NAME  = :PC-PROGRAM-NAME                   03470000
               END-EXEC                                                 03480000
               IF SQLCODE = 0                                           03490000
                   CONTINUE                                             03500000
               ELSE                                                     03510000
                   MOVE PE-MSG-08          TO PV-OPERATION-ATTEMPTED    03520004
                   MOVE '* 4000-READ-PROMO-ID  *' TO PV-PARAGRAPH-NAME  03530001
                   PERFORM 9999-SQL-ABEND                               03540000
               END-IF                                                   03550000
            ELSE                                                        03560000
               ADD 1                        TO PA-INPUT-COUNT           03570028
               IF CC-NOT-COMMENT                                        03571028
                  ADD 1                     TO PA-INPUT-PROMO-COUNT     03571128
               END-IF                                                   03572028
            END-IF.                                                     03580000
                                                                        03590007
      ***************************************************************** 03600005
      * VALIDATE PROMOTION ID. SELECT FROM XST_PROMO TABLE. IF          03610040
      * PROMOTION NOT FOUND, THE PROMO ID IS INVALID.                   03611040
      ***************************************************************** 03620005
       5000-SELECT-XST00026.                                            03630040
                                                                        03640005
           MOVE CC-PROMO-ID TO XST00026-PROMO-ID.                       03641007
                                                                        03642007
           PERFORM WITH TEST AFTER                                      03650005
               VARYING  PV-RETRY-COUNT FROM 1 BY 1                      03660005
                 UNTIL (PV-RETRY-COUNT > PC-MAX-RETRIES                 03670005
                           OR SQLCODE = 0                               03680019
                           OR SQLCODE = +100)                           03681019
              EXEC SQL                                                  03690005
                  SELECT PROMO_ID                                       03700040
                   INTO :XST00026-PROMO-ID                              03701042
                   FROM XST_PROMO                                       03710042
                  WHERE PROMO_ID            = :XST00026-PROMO-ID        03750042
              END-EXEC                                                  03790005
                                                                        03800005
              EVALUATE SQLCODE                                          03810005
                  WHEN 0                                                03820005
                      SET PS-PROMO-ID-FOUND     TO TRUE                 03820144
                      DISPLAY 'PROCESSING PROMO ID: ', CC-PROMO-ID      03821041
                  WHEN +100                                             03832019
                      SET PS-PROMO-ID-NOT-FOUND TO TRUE                 03832144
                      DISPLAY 'INVALID PROMO ID   : ', CC-PROMO-ID      03833041
                      ADD 1                 TO PA-INVALID-PROMO-ID-COUNT03834040
                  WHEN -904                                             03840005
                  WHEN -911                                             03850005
                  WHEN -913                                             03860005
                      DISPLAY SQLCODE, ' *** OCCURRED ON SELECT ***'    03870040
                      DISPLAY ' *** TABLE XST_PROMO    ***'             03871007
                  WHEN OTHER                                            03880005
                      MOVE '5000-SELECT-XST00026' TO PV-PARAGRAPH-NAME  03890040
                      MOVE PE-MSG-00           TO PV-OPERATION-ATTEMPTED03900040
                      PERFORM 9999-SQL-ABEND                            03910005
              END-EVALUATE                                              03920005
                                                                        03930005
           END-PERFORM.                                                 03940005
                                                                        03950005
           IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          03960005
               MOVE '5000-SELECT-XST00026' TO PV-PARAGRAPH-NAME         03970040
               MOVE PE-MSG-12 TO PV-OPERATION-ATTEMPTED                 03971009
               PERFORM 9999-SQL-ABEND                                   03972005
           END-IF.                                                      03973005
                                                                        03974007
      ***************************************************************** 03978040
      * UPDATE THE ACTUAL START AND END DATES ON XST_PROMO.             03979040
      ***************************************************************** 03979140
       5100-UPDATE-XST00026.                                            03979240
                                                                        03979340
           MOVE CC-PROMO-ID TO XST00026-PROMO-ID.                       03979440
                                                                        03979540
           PERFORM WITH TEST AFTER                                      03979640
               VARYING  PV-RETRY-COUNT FROM 1 BY 1                      03979740
                 UNTIL (PV-RETRY-COUNT > PC-MAX-RETRIES                 03979840
                           OR SQLCODE = 0                               03979940
                           OR SQLCODE = +100)                           03980040
              EXEC SQL                                                  03980140
                  UPDATE XST_PROMO                                      03980240
                      SET ACTL_STRT_TMST     = DFLT_STRT_TMST           03980340
                         ,ACTL_END_TMST      = DFLT_END_TMST            03980440
                         ,LAST_UPD_TMST      = CURRENT TIMESTAMP        03980540
                 WHERE   PROMO_ID            = :XST00026-PROMO-ID       03980640
                   AND (ACTL_STRT_TMST <> DFLT_STRT_TMST OR             03980740
                        ACTL_END_TMST  <> DFLT_END_TMST)                03980840
              END-EXEC                                                  03980940
                                                                        03981040
              EVALUATE SQLCODE                                          03981140
                  WHEN 0                                                03981240
                      ADD 1          TO PA-XST00026-UPDATES-PERFORMED   03981340
                      ADD SQLERRD(3) TO PA-XST00026-UPDATE-COUNT        03981440
                  WHEN +100                                             03981540
                      CONTINUE                                          03981640
                  WHEN -904                                             03981740
                  WHEN -911                                             03981840
                  WHEN -913                                             03981940
                      DISPLAY SQLCODE, ' *** OCCURRED ON UPDATE ***'    03982040
                      DISPLAY ' *** TABLE XST_PROMO    ***'             03982140
                  WHEN OTHER                                            03982240
                      MOVE '5100-UPDATE-XST00026' TO PV-PARAGRAPH-NAME  03982340
                      MOVE PE-MSG-01           TO PV-OPERATION-ATTEMPTED03982440
                      PERFORM 9999-SQL-ABEND                            03982540
              END-EVALUATE                                              03982640
                                                                        03982740
           END-PERFORM.                                                 03982840
                                                                        03982940
           IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          03983040
               MOVE '5100-UPDATE-XST00026' TO PV-PARAGRAPH-NAME         03983140
               MOVE PE-MSG-12 TO PV-OPERATION-ATTEMPTED                 03983240
               PERFORM 9999-SQL-ABEND                                   03983340
           END-IF.                                                      03983440
                                                                        03983540
           IF SQLCODE = 0                                               03983640
               PERFORM 7700-COMMIT-PROCESSING                           03983740
           END-IF.                                                      03983840
                                                                        03983940
      ***************************************************************** 03984040
      * OPEN XST00028 CURSOR TO OBTAIN PROMOTION INTERFACE ID'S AND     03990006
      * MERCHANDISE LINE ID'S FOR PROMOTIONS.                           04000006
      ***************************************************************** 04010000
       6000-OPEN-XST00028-CSR.                                          04020002
                                                                        04030007
           MOVE CC-PROMO-ID TO XST00028-PROMO-ID.                       04030107
                                                                        04030207
           PERFORM WITH TEST AFTER                                      04031003
               VARYING  PV-RETRY-COUNT FROM 1 BY 1                      04032003
                 UNTIL (PV-RETRY-COUNT > PC-MAX-RETRIES                 04032103
                           OR SQLCODE = 0)                              04032203
                                                                        04033003
              EXEC SQL                                                  04040003
                  OPEN XST00028_CSR                                     04040103
              END-EXEC                                                  04041003
                                                                        04230003
              EVALUATE SQLCODE                                          04240003
                  WHEN 0                                                04250003
                      CONTINUE                                          04260007
                  WHEN -904                                             04270003
                  WHEN -911                                             04271003
                  WHEN -913                                             04272003
                      DISPLAY SQLCODE, ' *** OCCURRED ON OPEN ***'      04290007
                      DISPLAY ' *** TABLE XST_MDSE_LNE_SELN *** '       04300007
                  WHEN OTHER                                            04370003
                      MOVE '6000-OPEN-XST00028-CSR' TO PV-PARAGRAPH-NAME04380003
                      MOVE PE-MSG-02           TO PV-OPERATION-ATTEMPTED04390009
                      PERFORM 9999-SQL-ABEND                            04400003
              END-EVALUATE                                              04410003
                                                                        04410103
           END-PERFORM.                                                 04411003
                                                                        04411104
           IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          04412004
               MOVE '6000-OPEN-XST00028-CSR' TO PV-PARAGRAPH-NAME       04412104
               MOVE PE-MSG-12 TO PV-OPERATION-ATTEMPTED                 04413009
               PERFORM 9999-SQL-ABEND                                   04414004
           END-IF.                                                      04417004
                                                                        04420007
           MOVE 'N' TO PS-XST00028-NOT-FOUND-SW.                        04420118
                                                                        04420218
      ***************************************************************** 04420307
      * FETCH XST00028 CURSOR TO OBTAIN PROMOTION INTERFACE ID'S AND    04420407
      * MERCHANDISE LINE ID'S FOR PROMOTIONS.                           04420507
      ***************************************************************** 04420607
       6100-FETCH-XST00028-CSR.                                         04420707
                                                                        04420807
           PERFORM WITH TEST AFTER                                      04420907
               VARYING  PV-RETRY-COUNT FROM 1 BY 1                      04421007
                 UNTIL (PV-RETRY-COUNT > PC-MAX-RETRIES                 04421107
                           OR SQLCODE = 0                               04421217
                           OR SQLCODE = +100)                           04421317
                                                                        04421417
              EXEC SQL                                                  04421517
                  FETCH  XST00028_CSR                                   04421617
                   INTO :XST00028-PROMO-INTFC-ID                        04421717
                       ,:XST00028-MDSE-LNE-ID                           04421817
              END-EXEC                                                  04421917
                                                                        04422017
              EVALUATE SQLCODE                                          04422117
                  WHEN 0                                                04422217
                      ADD 1 TO PA-XST00028-FETCH-COUNT                  04422317
                  WHEN +100                                             04422419
                      SET PS-XST00028-NOT-FOUND TO TRUE                 04422519
                  WHEN -904                                             04422607
                  WHEN -911                                             04422707
                  WHEN -913                                             04422807
                      DISPLAY SQLCODE, ' *** OCCURRED ON FETCH ***'     04422907
                      DISPLAY ' *** TABLE XST_MDSE_LNE_SELN *** '       04423007
                  WHEN OTHER                                            04423207
                      MOVE '6100-FETCH-XST00028-CSR'                    04423307
                                                    TO PV-PARAGRAPH-NAME04423407
                      MOVE PE-MSG-03           TO PV-OPERATION-ATTEMPTED04423509
                      PERFORM 9999-SQL-ABEND                            04423607
              END-EVALUATE                                              04423707
                                                                        04423807
           END-PERFORM.                                                 04423907
                                                                        04424007
           IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          04424107
               MOVE '6100-FETCH-XST00028-CSR' TO PV-PARAGRAPH-NAME      04424207
               MOVE PE-MSG-12 TO PV-OPERATION-ATTEMPTED                 04424309
               PERFORM 9999-SQL-ABEND                                   04424407
           END-IF.                                                      04424507
                                                                        04424607
      ***************************************************************** 04424707
      * UPDATE THE ACTUAL START AND END DATES ON XST_PROMO_STR_GP AND   04424807
      * XST_PROMO_ADHC_RLT TABLES.                                      04424907
      ***************************************************************** 04425007
       6200-UPDATE-XST00029-XST00031.                                   04425104
                                                                        04426007
           PERFORM 6210-UPDATE-XST00029.                                04426104
                                                                        04426440
           PERFORM 6220-UPDATE-XST00031.                                04426704
                                                                        04426839
           PERFORM 6100-FETCH-XST00028-CSR.                             04427114
                                                                        04428014
      ***************************************************************** 04439005
      * UPDATE THE ACTUAL START AND END DATES ON XST_PROMO_STR_GP.      04439105
      ***************************************************************** 04439205
       6210-UPDATE-XST00029.                                            04439305
                                                                        04439405
           MOVE XST00028-PROMO-INTFC-ID TO XST00029-PROMO-INTFC-ID.     04439507
           MOVE XST00028-MDSE-LNE-ID    TO XST00029-MDSE-LNE-ID.        04439607
                                                                        04439707
           PERFORM WITH TEST AFTER                                      04439805
               VARYING  PV-RETRY-COUNT FROM 1 BY 1                      04439905
                 UNTIL (PV-RETRY-COUNT > PC-MAX-RETRIES                 04440005
                           OR SQLCODE = 0                               04440119
                           OR SQLCODE = +100)                           04440219
              EXEC SQL                                                  04440319
                  UPDATE XST_PROMO_STR_GP                               04440419
                      SET ACTL_STRT_TMST     = PROMO_STRT_TMST          04440519
                         ,ACTL_END_TMST      = PROMO_END_TMST           04440619
                         ,LAST_UPD_TMST      = CURRENT TIMESTAMP        04440719
                         ,LAST_ACTN_CDE      = 'U'                      04440819
                 WHERE   PROMO_INTFC_ID      = :XST00029-PROMO-INTFC-ID 04440919
                   AND   MDSE_LNE_ID         = :XST00029-MDSE-LNE-ID    04441019
                   AND (ACTL_STRT_TMST <> PROMO_STRT_TMST OR            04441119
                        ACTL_END_TMST  <> PROMO_END_TMST)               04441219
              END-EXEC                                                  04441319
                                                                        04441419
              EVALUATE SQLCODE                                          04441519
                  WHEN 0                                                04441619
                      ADD 1          TO PA-XST00029-UPDATES-PERFORMED   04441709
                      ADD SQLERRD(3) TO PA-XST00029-UPDATE-COUNT        04441807
                  WHEN +100                                             04441919
                      CONTINUE                                          04442019
                  WHEN -904                                             04442119
                  WHEN -911                                             04442219
                  WHEN -913                                             04442319
                      DISPLAY SQLCODE, ' *** OCCURRED ON UPDATE ***'    04442419
                      DISPLAY ' *** TABLE XST_PROMO_STR_GP *** '        04442519
                  WHEN OTHER                                            04442619
                      MOVE '6210-UPDATE-XST00029' TO PV-PARAGRAPH-NAME  04442719
                      MOVE PE-MSG-04           TO PV-OPERATION-ATTEMPTED04442819
                      PERFORM 9999-SQL-ABEND                            04442919
              END-EVALUATE                                              04443019
                                                                        04443119
           END-PERFORM.                                                 04443219
                                                                        04443319
           IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          04443419
               MOVE '6210-UPDATE-XST00029' TO PV-PARAGRAPH-NAME         04443519
               MOVE PE-MSG-12 TO PV-OPERATION-ATTEMPTED                 04443619
               PERFORM 9999-SQL-ABEND                                   04443719
           END-IF.                                                      04443819
                                                                        04443919
           IF SQLCODE = 0                                               04444040
               PERFORM 7700-COMMIT-PROCESSING                           04444140
           END-IF.                                                      04444240
                                                                        04444340
      ***************************************************************** 04444419
      * UPDATE THE ACTUAL START AND END DATES ON XST_PROMO_ADHC_RLT.    04444519
      ***************************************************************** 04444619
       6220-UPDATE-XST00031.                                            04444719
                                                                        04444819
           MOVE XST00028-PROMO-INTFC-ID TO XST00031-PROMO-INTFC-ID.     04444919
           MOVE XST00028-MDSE-LNE-ID    TO XST00031-MDSE-LNE-ID.        04445019
                                                                        04445119
           PERFORM WITH TEST AFTER                                      04445219
               VARYING  PV-RETRY-COUNT FROM 1 BY 1                      04445319
                 UNTIL (PV-RETRY-COUNT > PC-MAX-RETRIES                 04445419
                           OR SQLCODE = 0                               04445519
                           OR SQLCODE = +100)                           04445619
              EXEC SQL                                                  04445719
                  UPDATE XST_PROMO_ADHC_RLT                             04445819
                      SET ACTL_STRT_TMST     = PROMO_STRT_TMST          04445919
                         ,ACTL_END_TMST      = PROMO_END_TMST           04446019
                         ,LAST_UPD_TMST      = CURRENT TIMESTAMP        04446119
                         ,LAST_ACTN_CDE      = 'U'                      04446219
                 WHERE   PROMO_INTFC_ID      = :XST00031-PROMO-INTFC-ID 04446319
                   AND   MDSE_LNE_ID         = :XST00031-MDSE-LNE-ID    04446419
                   AND (ACTL_STRT_TMST <> PROMO_STRT_TMST OR            04446519
                        ACTL_END_TMST  <> PROMO_END_TMST)               04446619
              END-EXEC                                                  04446719
                                                                        04446819
              EVALUATE SQLCODE                                          04446919
                  WHEN 0                                                04447019
                      ADD 1          TO PA-XST00031-UPDATES-PERFORMED   04447119
                      ADD SQLERRD(3) TO PA-XST00031-UPDATE-COUNT        04447219
                  WHEN +100                                             04447319
                      CONTINUE                                          04447419
                  WHEN -904                                             04447519
                  WHEN -911                                             04447619
                  WHEN -913                                             04447719
                      DISPLAY SQLCODE, ' *** OCCURRED ON UPDATE ***'    04447819
                      DISPLAY ' *** TABLE XST_PROMO_ADHC_RLT *** '      04447919
                  WHEN OTHER                                            04448019
                      MOVE '6220-UPDATE-XST00031' TO PV-PARAGRAPH-NAME  04448119
                      MOVE PE-MSG-05           TO PV-OPERATION-ATTEMPTED04448219
                      PERFORM 9999-SQL-ABEND                            04448319
              END-EVALUATE                                              04448419
                                                                        04448519
           END-PERFORM.                                                 04448619
                                                                        04448719
           IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          04448819
               MOVE '6220-UPDATE-XST00031' TO PV-PARAGRAPH-NAME         04448919
               MOVE PE-MSG-12 TO PV-OPERATION-ATTEMPTED                 04449019
               PERFORM 9999-SQL-ABEND                                   04449119
           END-IF.                                                      04449219
                                                                        04449319
           IF SQLCODE = 0                                               04449440
               PERFORM 7700-COMMIT-PROCESSING                           04449540
           END-IF.                                                      04449640
                                                                        04449740
      ***************************************************************** 04449819
      * CLOSE XST00028 CURSOR TO OBTAIN PROMOTION INTERFACE ID'S AND    04449919
      * MERCHANDISE LINE ID'S FOR PROMOTIONS.                           04450019
      ***************************************************************** 04450119
       6300-CLOSE-XST00028-CSR.                                         04450219
                                                                        04450319
           PERFORM WITH TEST AFTER                                      04450419
               VARYING  PV-RETRY-COUNT FROM 1 BY 1                      04450519
                 UNTIL (PV-RETRY-COUNT > PC-MAX-RETRIES                 04451007
                           OR SQLCODE = 0)                              04460007
                                                                        04470007
              EXEC SQL                                                  04480007
                  CLOSE XST00028_CSR                                    04490007
              END-EXEC                                                  04500007
                                                                        04510007
              EVALUATE SQLCODE                                          04520007
                  WHEN 0                                                04530007
                      CONTINUE                                          04540007
                  WHEN -904                                             04550007
                  WHEN -911                                             04560007
                  WHEN -913                                             04570007
                      DISPLAY SQLCODE, ' *** OCCURRED ON CLOSE ***'     04580007
                      DISPLAY ' *** TABLE XST_MDSE_LNE_SELN *** '       04581007
                  WHEN OTHER                                            04590007
                      MOVE '6300-CLOSE-XST00028-CSR'                    04600007
                                                    TO PV-PARAGRAPH-NAME04601007
                      MOVE PE-MSG-06           TO PV-OPERATION-ATTEMPTED04610009
                      PERFORM 9999-SQL-ABEND                            04620007
              END-EVALUATE                                              04630007
                                                                        04640007
           END-PERFORM.                                                 04650007
                                                                        04660007
           IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          04670007
               MOVE '6300-CLOSE-XST00028-CSR' TO PV-PARAGRAPH-NAME      04680007
               MOVE PE-MSG-12 TO PV-OPERATION-ATTEMPTED                 04690010
               PERFORM 9999-SQL-ABEND                                   04700007
           END-IF.                                                      04710007
                                                                        04720007
      ******************************************************************05030000
      * 7300-GET-COMMIT-TIMESTAMP.                                     *05040000
      * PROCESSES: GET THE COMMIT TIMESTAMP FROM THE CHECKPOINT        *05050000
      *            CONTROL TABLE                                       *05060000
      ******************************************************************05070000
       7300-GET-COMMIT-TIMESTAMP.                                       05080000
                                                                        05090000
           EXEC SQL                                                     05100000
      * CHECKPOINT TAKEN BASED ON CHEKPOINT RESTART CICSP1 PANEL        05110000
             SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)       05120000
               INTO :PV-COMMIT-TIMESTAMP                                05130000
               FROM TCKRSTCNTL                                          05140000
              WHERE JOB_NAME  = :PC-JOB-NAME                            05150000
                AND PLAN_NAME = :PC-PROGRAM-NAME                        05160000
           END-EXEC.                                                    05170000
                                                                        05180000
           EVALUATE TRUE                                                05190000
               WHEN SQLCODE = 0                                         05200000
      **     DISPLAY 'NEXT COMMIT AT TIMESTAMP: ', PV-COMMIT-TIMESTAMP  05210000
                   CONTINUE                                             05220000
               WHEN SQLCODE NOT EQUAL ZERO                              05230000
                   MOVE '7300-GET-COMMIT-TIMESTAMP' TO PV-PARAGRAPH-NAME05240000
               MOVE PE-MSG-07             TO PV-OPERATION-ATTEMPTED     05241007
                   PERFORM 9999-SQL-ABEND                               05250000
           END-EVALUATE.                                                05260000
                                                                        05280007
      ******************************************************************05290000
      * 7400-INIT-CHECKPOINT-SELECT                                    *05300000
      * PROCESSES: SELECTS FROM THE CHECKPOINT RESTART CONTROL TABLE   *05310000
      *            IF WE ARE IN A RESTART CONDITION.                   *05320000
      ******************************************************************05330000
       7400-INIT-CHECKPOINT-SELECT.                                     05340000
           EXEC SQL                                                     05350000
             SELECT  CKPT_STAT_CODE                                     05360000
                    ,CKPT_FRQNCY_QTY                                    05370000
               INTO  :TCKRSTCNTL-CKPT-STAT-CODE                         05380000
                    ,:TCKRSTCNTL-CKPT-FRQNCY-QTY                        05390000
               FROM  TCKRSTCNTL                                         05400000
              WHERE  JOB_NAME  = :PC-JOB-NAME                           05410000
                AND  PLAN_NAME = :PC-PROGRAM-NAME                       05420000
           END-EXEC.                                                    05430000
                                                                        05440000
           IF SQLCODE = 0                                               05450000
               CONTINUE                                                 05460000
           ELSE                                                         05470000
               MOVE '7400-INIT-CHECKPOINT-SELECT' TO PV-PARAGRAPH-NAME  05480000
               MOVE PE-MSG-07             TO PV-OPERATION-ATTEMPTED     05490007
               PERFORM 9999-SQL-ABEND                                   05500000
           END-IF.                                                      05510000
                                                                        05520007
      ******************************************************************05540000
      * 7500-SELECT-RESTART-INFO                                       *05550000
      * PROCESSES: SELECTS FROM THE CHECKPOINT RESTART INFORMATION     *05560000
      *            TABLE TO OBTAIN THE PROGRAMS SAVED VARIABLES.       *05570000
      ******************************************************************05580000
       7500-SELECT-RESTART-INFO.                                        05590000
           EXEC SQL                                                     05600000
             SELECT  WORK_STRG_DESC                                     05610000
               INTO  :TCKRSTINF-WORK-STRG-DESC                          05620000
               FROM  TCKRSTINF                                          05630000
              WHERE  JOB_NAME  = :PC-JOB-NAME                           05640000
                AND  PLAN_NAME = :PC-PROGRAM-NAME                       05650000
           END-EXEC.                                                    05660000
                                                                        05670000
           IF SQLCODE = 0                                               05680000
               CONTINUE                                                 05690000
           ELSE                                                         05700000
               MOVE '*7500-SELECT-RESTART-INFO*' TO PV-PARAGRAPH-NAME   05710000
               MOVE PE-MSG-09             TO PV-OPERATION-ATTEMPTED     05711007
               PERFORM 9999-SQL-ABEND                                   05720000
           END-IF.                                                      05730000
                                                                        05740000
      ******************************************************************05750000
      * 7600-SET-CURRENT-TIMESTAMP.                                    *05760000
      * PROCESSES: GET THE CURRENT TIMESTAMP FROM DB2.                 *05770000
      ******************************************************************05780000
       7600-SET-CURRENT-TIMESTAMP.                                      05790000
                                                                        05800000
           EXEC SQL                                                     05810000
                SET :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP           05820000
           END-EXEC.                                                    05830000
                                                                        05840000
           IF SQLCODE = 0                                               05850000
               CONTINUE                                                 05860000
           ELSE                                                         05870000
               MOVE '*7600-SET-CURRENT-TIMESTAMP*' TO PV-PARAGRAPH-NAME 05880000
               PERFORM 9999-SQL-ABEND                                   05890000
           END-IF.                                                      05900000
                                                                        05910007
      ******************************************************************05930000
      * 7700-COMMIT-PROCESSING.                                        *05940000
      * PROCESSES: CHECK IF WE NEED TO TAKE A COMMIT.                  *05950000
      *          PREPARE CHECKPOINT RECORD FOR UPDATE OF WORK_STRG_DESC*05960000
      ******************************************************************05970000
       7700-COMMIT-PROCESSING.                                          05980000
           MOVE '*7700-COMMIT-PROCESSING*'    TO PV-PARAGRAPH-NAME.     05990000
                                                                        06000000
           PERFORM 7600-SET-CURRENT-TIMESTAMP.                          06010000
                                                                        06020000
      * PREPARE COMMIT RECORD FOR UPDATE                                06030000
           IF PV-CURRENT-TIMESTAMP > PV-COMMIT-TIMESTAMP                06040032
               MOVE CC-PROMO-ID               TO CR-PROMO-ID            06050003
               MOVE PA-INPUT-COUNT            TO CR-INPUT-READ-COUNT    06170000
               MOVE PA-COMMIT-COUNT           TO CR-COMMIT-COUNT        06171046
      *        MOVE COMMIT INFO TO WORKING STORAGE ROW                  06180000
               MOVE CR-CHECKPOINT-RESTART-AREA TO                       06190000
                                             TCKRSTINF-WORK-STRG-DESC   06200000
               IF PS-FIRST-COMMIT                                       06210000
                   MOVE '9' TO TCKRSTCNTL-CKPT-STAT-CODE                06220000
                   PERFORM 7900-UPDATE-CHECKPOINT-STATUS                06230000
                   MOVE 'N' TO PS-FIRST-COMMIT-SW                       06240000
               END-IF                                                   06250000
               PERFORM 7800-COMMIT-CHANGES                              06260000
               PERFORM 7300-GET-COMMIT-TIMESTAMP                        06270000
           END-IF.                                                      06280032
                                                                        06300007
      ******************************************************************06310000
      * 7800-COMMIT-CHANGES.                                            06320000
      * PROCESSES: PERFORM UPDATE OF CHECKPOINT INFORMATION TABLE.      06330000
      *            TAKE A COMMIT.                                       06340000
      *  ==> PERFORMED FROM: 7700-COMMIT-PROCESSING.                    06350000
      ******************************************************************06360000
       7800-COMMIT-CHANGES.                                             06370000
                                                                        06380000
           EXEC SQL                                                     06390000
             UPDATE TCKRSTINF                                           06400000
                SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC          06410000
              WHERE JOB_NAME       = :PC-JOB-NAME                       06420000
                AND PLAN_NAME      = :PC-PROGRAM-NAME                   06430000
           END-EXEC.                                                    06440000
                                                                        06450000
           IF SQLCODE = 0                                               06460000
               CONTINUE                                                 06470040
           ELSE                                                         06480000
               MOVE PE-MSG-08                  TO PV-OPERATION-ATTEMPTED06490007
               MOVE  '* 7800-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     06500000
               PERFORM 9999-SQL-ABEND                                   06510000
           END-IF.                                                      06520000
                                                                        06530000
           EXEC SQL                                                     06540000
               COMMIT                                                   06550000
           END-EXEC.                                                    06560000
                                                                        06570000
           IF SQLCODE = 0                                               06580000
               ADD 1 TO PA-COMMIT-COUNT                                 06590000
           ELSE                                                         06600000
               MOVE PE-MSG-10                  TO PV-OPERATION-ATTEMPTED06610007
               MOVE  '* 7800-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     06620000
               PERFORM 9999-SQL-ABEND                                   06630000
           END-IF.                                                      06640000
                                                                        06650007
      ******************************************************************06660000
      * 7900-UPDATE-CHECKPOINT-STATUS                                   06670000
      * PROCESSES: UPDATES THE STATUS ON THE CHECKPOINT CONTROL TABLE   06680000
      ******************************************************************06690000
       7900-UPDATE-CHECKPOINT-STATUS.                                   06700000
                                                                        06710000
           EXEC SQL                                                     06720000
             UPDATE  TCKRSTCNTL                                         06730000
                SET  CKPT_STAT_CODE = :TCKRSTCNTL-CKPT-STAT-CODE        06740000
              WHERE  JOB_NAME  = :PC-JOB-NAME                           06750000
                AND  PLAN_NAME = :PC-PROGRAM-NAME                       06760000
           END-EXEC.                                                    06770000
                                                                        06780000
           IF SQLCODE = 0                                               06790000
               CONTINUE                                                 06800000
           ELSE                                                         06810000
               MOVE '7900-UPDATE-CHECKPOINT-STATUS' TO PV-PARAGRAPH-NAME06820000
               MOVE PE-MSG-11             TO PV-OPERATION-ATTEMPTED     06821007
               PERFORM 9999-SQL-ABEND                                   06830000
           END-IF.                                                      06840000
                                                                        06850000
           EJECT                                                        06860000
                                                                        06870007
      ******************************************************************07710000
      *  RESET STATUS CODE, DISPLAY FINAL COUNTS , CLOSE INPUT FILE    *07720000
      ******************************************************************07730000
       8000-EOJ-ROUTINE.                                                07740000
                                                                        07750007
           MOVE '0' TO TCKRSTCNTL-CKPT-STAT-CODE.                       07760000
           PERFORM 7900-UPDATE-CHECKPOINT-STATUS.                       07770000
                                                                        07780000
           DISPLAY SPACES.                                              07800000
           DISPLAY 'INPUT RECORDS PROCESSED    ', PA-INPUT-COUNT.       07810007
           DISPLAY 'PROMO RECORDS PROCESSED    ', PA-INPUT-PROMO-COUNT. 07811028
           DISPLAY 'INVALID PROMO ID''S         ',                      07812044
                                          PA-INVALID-PROMO-ID-COUNT.    07813041
           DISPLAY 'XST00026 UPDATES PERFORMED ',                       07820007
                                          PA-XST00026-UPDATES-PERFORMED.07820107
           DISPLAY 'XST00026 ROWS UPDATED      ',                       07820207
                                          PA-XST00026-UPDATE-COUNT.     07820307
           DISPLAY 'XST00028 ROWS FETCHED      ',                       07820407
                                          PA-XST00028-FETCH-COUNT.      07820507
           DISPLAY 'XST00029 UPDATES PERFORMED ',                       07820607
                                          PA-XST00029-UPDATES-PERFORMED.07820707
           DISPLAY 'XST00029 ROWS UPDATED      ',                       07820807
                                          PA-XST00029-UPDATE-COUNT.     07820907
           DISPLAY 'XST00031 UPDATES PERFORMED ',                       07821007
                                          PA-XST00031-UPDATES-PERFORMED.07821107
           DISPLAY 'XST00031 ROWS UPDATED      ',                       07821207
                                          PA-XST00031-UPDATE-COUNT.     07821307
           DISPLAY SPACES.                                              07840000
                                                                        07850007
           CLOSE CNTL-PROMO-ID-FILE.                                    07860007
                                                                        07870007
      ******************************************************************07980000
      *  STANDARD DB2 ERROR ABEND ROUTINE                               07990000
      *  THIS ROUTINE FORCES AN ABEND DUE TO A DB2 PROBLEM.             08000000
      ******************************************************************08010000
       9999-SQL-ABEND.                                                  08020000
                                                                        08030000
           MOVE +4013                 TO ABEND-CODE.                    08040000
           DISPLAY '**  ABEND     **'.                                  08050000
           DISPLAY '**  PROGRAM   ** => ' PC-PROGRAM-NAME.              08060000
           DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            08070000
           DISPLAY '**  OPERATION **  = ' PV-OPERATION-ATTEMPTED.       08080000
                                                                        08090000
      *    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE         08100000
      *    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.        08110000
                                                                        08120000
           COPY DPPD004.                                                08130000
           CALL 'ILBOABN0'  USING ABEND-CODE.                           08140000
