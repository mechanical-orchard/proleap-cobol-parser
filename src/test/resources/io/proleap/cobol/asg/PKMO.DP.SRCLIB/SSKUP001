000100 IDENTIFICATION DIVISION.                                         00010001
000200                                                                  00020001
000300 PROGRAM-ID.    SSKUP001.                                         00030016
000400 AUTHOR.        COGNIZANT.                                        00040001
000500 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00050001
000600 DATE-WRITTEN.  12-07-09.                                         00060001
000700 DATE-COMPILED.                                                   00070001
000800                                                                  00080001
000900******************************************************************00090001
001000*     SSKUP001 - UPDATE TABLE EPT_TRN_CTG_SUM                    *00100016
001100******************************************************************00110001
001200*     THIS PROGRAM WILL UPDATE TABLE EPT_TRN_CTG_SUM             *00120004
001300* DB2 TABLE USING THE DB2 KEY INFO FROM EACH INPUT FILE RECORD.  *00130001
001400* THESE RECORDS ARE CREATED IN THE FIRST STEP OF THE JOB IN AN   *00140001
001500* BY A SQL UNLOAD UTILITY.                                       *00150001
001600* COMMITS ARE TAKEN EVERY TEN SECONDS, AND CHECKPOINT RESTART    *00160001
001700* LOGIC IS INCORPORATED.                                         *00170001
001800*                                                                *00180001
001900*    WR/PITS#     DATE        DESCRIPTION                        *00190001
002000*    --------   --------     ---------------------------------   *00200001
002300******************************************************************00210001
C27938* DATE: 05/18/2012                                                00220030
C27938* WHO: KAREN GIVENS (REFER TO 'C27938' FOR ALL CHANGES)           00230030
C27938* WHY: ADD NEW TRN_DTE TO EPT_TRN_CTG_SUM                         00240030
C27938******************************************************************00250030
260107* DATE: 08/16/2021                                                00251031
260107* WHO: JIM HUNTER   (REFER TO '260107' FOR ALL CHANGES)           00252031
260107* WHY: ADDED COPYBOOK DPWS991 TO MAKE CALL TO DPKUT901 DYNAMIC    00253031
260107******************************************************************00254031
002400                                                                  00260001
002500                                                                  00270001
002600 ENVIRONMENT DIVISION.                                            00280001
002700                                                                  00290001
002800 CONFIGURATION SECTION.                                           00300001
002900 SOURCE-COMPUTER.        IBM-3090.                                00310001
003000 OBJECT-COMPUTER.        IBM-3090.                                00320001
003100 INPUT-OUTPUT SECTION.                                            00330001
003200                                                                  00340001
003300 DATA DIVISION.                                                   00350001
003400 FILE SECTION.                                                    00360001
003500                                                                  00370001
003600 WORKING-STORAGE SECTION.                                         00380001
003700                                                                  00390001
003800 01  ABEND-CODE                  PIC S9(04)  VALUE ZERO COMP SYNC.00400001
003900                                                                  00410001
004000 01  PC-PROGRAM-CONSTANTS.                                        00420001
004200     05  PC-CKPT-JOB-NAME        PIC  X(06)  VALUE 'SSK001'.      00430011
004300     05  PC-PROGRAM-NAME         PIC  X(08)  VALUE 'SSKUP001'.    00440016
004400     05  PC-CKPT-PLAN-NAME       PIC  X(08)  VALUE 'SSKUP001'.    00450016
004500     05  PC-CURRENT-PROGRAM-NAME PIC  X(08)  VALUE 'SSKUP001'.    00460016
004600     05  PC-MAX-RETRIES          PIC S9(03)  VALUE +3 COMP-3.     00470001
004700     05  PC-MAX-DEADLOCKS        PIC S9(03)  VALUE +3 COMP-3.     00480001
004800     05  PC-TRAN-PRES-FUNC-CODES.                                 00490001
004900         10  PC-TRAN-PRES-FUNC-OPEN   PIC  X(05)  VALUE 'OPEN '.  00500001
005000         10  PC-TRAN-PRES-FUNC-CKPT   PIC  X(05)  VALUE 'CKPT '.  00510001
005100         10  PC-TRAN-PRES-FUNC-TRANS  PIC  X(05)  VALUE 'TRANS'.  00520001
005200         10  PC-TRAN-PRES-FUNC-RSTRT  PIC  X(05)  VALUE 'RSTRT'.  00530001
005300         10  PC-TRAN-PRES-FUNC-CLOSE  PIC  X(05)  VALUE 'CLOSE'.  00540001
005400                                                                  00550001
005500                                                                  00560001
005600 01  PC-PROGRAM-COUNTER.                                          00570001
005700     05  PC-UPDATE-CNT           PIC  9(09)  VALUE ZERO.          00580002
005800                                                                  00590001
005900 01  PE-PROGRAM-ERROR-MESSAGES.                                   00600001
006000     05  PE-MSG-01                       PIC X(60) VALUE          00610008
006100          'ATTEMPT TO UPDATE ROW ON TABLE EPT_TRN_CTG_SUM FAIL'.  00620004
006200     05  PE-MSG-04                       PIC X(50) VALUE          00630001
006300          'PROGRAM ABENDED WHILE TRYING TO PERFORM A COMMIT '.    00640001
006400     05  PE-MSG-05                       PIC X(50) VALUE          00650001
006500          'PROGRAM MAXIMUM DEADLOCK COUNT HAS BEEN EXCEEDED'.     00660001
006600     05  PE-MSG-07                       PIC X(50) VALUE          00670001
006700          'ATTEMPT TO SELECT TIMESTAMP + CKPT_FRQNCY_QTY   '.     00680001
006800     05  PE-MSG-11                       PIC X(50) VALUE          00690001
006900          'ATTEMPT TO SELECT ROW ON TABLE XST_SKU_LOC FAILED'.    00700001
007000*                                                                 00710001
007100 01  PS-PROGRAM-SWITCHES.                                         00720001
008000     05  PS-RESTART-REQUIRED-SW  PIC X(01)          VALUE 'N'.    00730001
008100         88  PS-RESTART-REQUIRED                    VALUE 'Y'.    00740001
008200         88  PS-RESTART-NOT-REQUIRED                VALUE 'N'.    00750001
008300                                                                  00760001
008400*                                                                 00770001
008500*                                                                 00780001
008600 01  PROGRAM-VARIABLES.                                           00790001
008700     05  PV-DEADLOCK-COUNTER             PIC S9(04) VALUE +0.     00800001
008900     05  PV-PARAGRAPH-NAME               PIC  X(30) VALUE SPACES. 00810001
009000     05  PV-ABEND-MESSAGE                PIC  X(75) VALUE SPACES. 00820001
009100     05  PV-DB2-OPER-ATTEMPTED           PIC  X(50) VALUE SPACES. 00830001
009400     05  PV-SQLCODE-DISPLAY              PIC  ++++9 VALUE ZERO.   00840001
010300     05  PV-SQL-SUB                   PIC  9(03)   VALUE ZERO.    00850001
      ***************************************************************   00860006
      * RECORD LAYOUT FOR FILE TRN-CTG-SUM-FILE                         00870006
      ***************************************************************   00880006
           COPY SSRD020.                                                00890022
012300*                                                                 00900001
012400******************************************************************00910001
012500*  DB2 ERROR MESSAGES FORMAT AREA.                                00920001
012600******************************************************************00930001
012700     COPY DPWS004.                                                00940001
012800*                                                                 00950001
012900******************************************************************00960001
013000*  USED FOR DB2 ERRORS                                            00970001
013100******************************************************************00980001
013200     EXEC SQL                                                     00990001
013300         INCLUDE SQLCA                                            01000001
013400     END-EXEC.                                                    01010001
013500******************************************************************01020001
013600*  SQL COMMUNICATIONS WORK AREA                                  *01030001
013700******************************************************************01040001
013800     COPY SQLCA2.                                                 01050001
013900                                                                  01060001
015400***************************************************************** 01070004
015500*  DB2 TABLE EPT_TRN_CTG_SUM - TRANSACTION SUMMARY TOTALS         01080004
015600*  BY CATEGORY TABLE (SALES BY HOUR)                              01090004
015700***************************************************************** 01100004
015800                                                                  01110004
015900     EXEC SQL                                                     01120004
016000         INCLUDE EPT00004                                         01130004
016100     END-EXEC.                                                    01140004
016200                                                                  01150004
014700******************************************************************01160001
014800*  TRANSACTION PREPARATION MODULE COMMUNICATIONS AREA            *01170001
014900******************************************************************01180001
260107     COPY DPWS991.                                                01190031
015000                                                                  01190131
015000     COPY DPLS001.                                                01191031
           05  WORK-STORAGE-PASSED.                                     01200021
015200******************************************************************01210026
015300*PA - PROGRAM ACCUMULATORS                                        01220026
015400******************************************************************01230026
015500         10  PROGRAM-ACCUMULATORS.                                01240026
015600             15  PA-INCENTIVE-ROWS-UPDATED PIC S9(11)  VALUE ZERO 01250026
015700                                                       COMP-3.    01260026
015800*                                                                 01270001
015900*-------------------*                                             01280001
016000 PROCEDURE DIVISION.                                              01290001
016100*-------------------*                                             01300001
016200                                                                  01310001
016300 0000-MAIN-MODULE.                                                01320001
016400                                                                  01330001
016500     PERFORM 1000-INITIALIZATION.                                 01340001
016600*                                                                 01350001
016700     PERFORM 2000-PROCESS-INPUT                                   01360001
016800          UNTIL DP001-PREP-TRANS-EOF.                             01370001
016900*                                                                 01380001
017000     PERFORM 8000-EOJ-ROUTINE.                                    01390001
017100                                                                  01400001
017200     STOP RUN.                                                    01410001
017300*                                                                 01420001
017400******************************************************************01430001
017500* INITIALIZE COUNTERS , READ FIRST INPUT RECORD                   01440001
017600* PREPARE CHECKPOINT RESTART TABLES FOR PROCESSING / RESTART      01450001
017700******************************************************************01460001
017800*                                                                 01470001
017900 1000-INITIALIZATION.                                             01480001
018000*                                                                 01490001
018100     MOVE PC-TRAN-PRES-FUNC-OPEN TO DP001-FUNC-CODE.              01500001
018200     PERFORM Z100-BUILD-COMM-AREA-TRAN-PRES.                      01510001
018300     EVALUATE TRUE                                                01520001
018400        WHEN DP001-GOOD-RET-CODE                                  01530001
018500            DISPLAY 'PROCESSING STARTS FROM BEGINNING OF FILE'    01540001
018600        WHEN DP001-RESTART                                        01550001
018700            DISPLAY 'PROCESSING STARTS FROM LAST CHECKPOINT'      01560001
018800        WHEN OTHER                                                01570001
018900            DISPLAY '1000-INITIALIZATION'                         01580001
019000            DISPLAY 'ERROR CALLING CHECKPOINT ROUTINE ON OPEN'    01590001
019100            DISPLAY 'DP001-RET-CODE IS ' DP001-RET-CODE           01600001
019200            PERFORM 9999-SQL-ABEND                                01610027
019300     END-EVALUATE.                                                01620001
019400                                                                  01630001
019500*                                                                 01640001
019600******************************************************************01650001
019700* PROCESS TRN-CTG-SUM-FILE - UPDATE EACH ROW                      01660011
019800******************************************************************01670001
019900 2000-PROCESS-INPUT.                                              01680001
020000*                                                                 01690001
020100     MOVE SS020-TRN-CTG-ITM-QTY  TO EPT00004-CTG-ITM-QTY.         01700024
020200     MOVE SS020-TRN-PARTN-NBR    TO EPT00004-PARTN-NBR.           01710024
020300     MOVE SS020-TRN-SUM-TYP-CDE  TO EPT00004-SUM-TYP-CDE.         01720024
020400     MOVE SS020-TRN-SUM-CTG-CDE  TO EPT00004-SUM-CTG-CDE.         01730024
020400     MOVE SS020-TRN-STR-NBR      TO EPT00004-STR-NBR.             01740024
020500     MOVE SS020-TRN-SUM-STRT-TM  TO EPT00004-SUM-STRT-TM.         01750024
C27938     MOVE SS020-TRN-DTE          TO EPT00004-TRN-DTE.             01760030
020600     SET PS-RESTART-NOT-REQUIRED TO TRUE.                         01770001
020700     PERFORM 6000-UPDATE-CTG-ITM-QTY.                             01780004
022100***************************************************************   01790001
022200                                                                  01800001
022300*----------------------------------------------------------------*01810001
022400*  IF A RESTART IS REQUIRED, ISSUE A RESTART CALL RATHER THAN A  *01820001
022500*  TRANS CALL.  THIS WILL ALLOW PROCESSING TO RESUME WITH THE    *01830001
022600*  FIRST TRANSACTION AFTER THE LAST COMMIT.                      *01840001
022700*----------------------------------------------------------------*01850001
022800     IF PS-RESTART-REQUIRED                                       01860001
022900         MOVE PC-TRAN-PRES-FUNC-RSTRT TO DP001-FUNC-CODE          01870001
023000     ELSE                                                         01880001
023100         MOVE PC-TRAN-PRES-FUNC-TRANS TO DP001-FUNC-CODE          01890001
023200     END-IF.                                                      01900001
023300                                                                  01910001
023400     PERFORM Z100-BUILD-COMM-AREA-TRAN-PRES.                      01920001
023500     EVALUATE TRUE                                                01930001
023600        WHEN DP001-GOOD-RET-CODE                                  01940001
023700        WHEN DP001-CKPT-TAKEN                                     01950001
023800            MOVE DP001-TRANS-RECORD    TO                         01960001
023900                 SS020-TRN-CTG-SUM-RECORD                         01970023
024000        WHEN OTHER                                                01980001
024100            DISPLAY '2000-PROCESS-INPUT  '                        01990001
024200            DISPLAY 'ERROR CALLING CHECKPOINT ROUTINE ON TRANS'   02000001
024300            DISPLAY 'DP001-RET-CODE IS ' DP001-RET-CODE           02010001
024400            PERFORM 9999-SQL-ABEND                                02020027
024500     END-EVALUATE.                                                02030001
024600                                                                  02040001
024700*                                                                 02050001
024800******************************************************************02060001
024900* UPDATE TABLE EPT_TRN_CTG_SUM THAT MATCHES THE INPUT KEY         02070011
025000******************************************************************02080001
025100 6000-UPDATE-CTG-ITM-QTY.                                         02090004
025200                                                                  02100001
025300     PERFORM WITH TEST AFTER                                      02110001
025400         VARYING PV-SQL-SUB                                       02120001
025500         FROM 1 BY 1                                              02130001
025600         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       02140001
025700                OR SQLCODE = -911                                 02150001
025800                OR SQLCODE = +100                                 02160001
025900                OR SQLCODE = 0)                                   02170001
026000                                                                  02180001
026100       EXEC SQL                                                   02190001
153713        UPDATE EPT_TRN_CTG_SUM                                    02200003
153714           SET CTG_ITM_QTY = CTG_ITM_QTY                          02210003
153715                           + :EPT00004-CTG-ITM-QTY                02220003
153716         WHERE PARTN_NBR   = :EPT00004-PARTN-NBR                  02230003
153717           AND SUM_TYP_CDE = :EPT00004-SUM-TYP-CDE                02240003
153718           AND SUM_CTG_CDE = :EPT00004-SUM-CTG-CDE                02250003
153719           AND SUM_STRT_TM = :EPT00004-SUM-STRT-TM                02260003
      *** COMMENTED OUT LINE TO PREVENT ABEND.  END TIME CURRENTLY      02270003
      *** NOT BEING PASSED BY SALES CORRECTION SCREEN.  REMOVE COMMENT  02280003
      *** ONCE SCREEN IS CHANGED TO PASS VALUE OR LOADER IS CHANGED TO  02290003
      *** CALCULATE VALUE BASED ON START TIME AS IT DOES FOR TRAN END TM02300003
153720***        AND SUM_END_TM  = :EPT00004-SUM-END-TM                 02310003
153721           AND STR_NBR     = :EPT00004-STR-NBR                    02320003
C27938           AND TRN_DTE     = :EPT00004-TRN-DTE                    02330030
026700       END-EXEC                                                   02340001
026800                                                                  02350001
026900       EVALUATE SQLCODE                                           02360001
027000           WHEN 0                                                 02370001
027100               ADD +1             TO PC-UPDATE-CNT                02380002
027200               MOVE ZERO          TO PV-DEADLOCK-COUNTER          02390001
027300           WHEN +100                                              02400001
027400               MOVE ZERO          TO PV-DEADLOCK-COUNTER          02410001
027500           WHEN -911                                              02420001
027600               ADD +1             TO PV-DEADLOCK-COUNTER          02430001
027700               DISPLAY 'DEADLOCK -911 IN 6000-UPDATE-CTG-ITM-QTY' 02440004
027800               IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS          02450001
027900                   MOVE '6000-UPDATE-CTG-ITM-QTY'                 02460004
028000                                  TO PV-PARAGRAPH-NAME            02470001
028100                   PERFORM 9000-DEADLOCK-ERROR                    02480001
028200               ELSE                                               02490001
028300                 SET PS-RESTART-REQUIRED TO TRUE                  02500001
028400               END-IF                                             02510001
028500           WHEN OTHER                                             02520001
028600               MOVE '6000-UPDATE-CTG-ITM-QTY'                     02530004
028700                                  TO PV-PARAGRAPH-NAME            02540001
028800               MOVE PE-MSG-01     TO PV-DB2-OPER-ATTEMPTED        02550001
028900               DISPLAY 'KEY -' EPT00004-PARTN-NBR   ' - '         02560008
029000                               EPT00004-SUM-TYP-CDE ' - '         02570008
029100                               EPT00004-SUM-CTG-CDE ' - '         02580008
029200                               EPT00004-SUM-STRT-TM ' - '         02590008
029300                               EPT00004-STR-NBR     ' - '         02600029
C27938                               EPT00004-TRN-DTE                   02610030
029300               PERFORM 9999-SQL-ABEND                             02620001
029400       END-EVALUATE                                               02630001
029500     END-PERFORM.                                                 02640001
029600                                                                  02650001
029700     IF PV-SQL-SUB > PC-MAX-RETRIES                               02660001
029800         MOVE '6000-UPDATE-CTG-ITM-QTY' TO PV-PARAGRAPH-NAME      02670004
029900         MOVE 'VERIFY RETRIES EXCEEDED' TO PV-DB2-OPER-ATTEMPTED  02680001
030000         PERFORM 9999-SQL-ABEND                                   02690027
030100     END-IF.                                                      02700001
030200*                                                                 02710001
030300******************************************************************02720001
030400*  RESET STATUS CODE, DISPLAY FINAL COUNTS , CLOSE INPUT FILE    *02730001
030500******************************************************************02740001
030600 8000-EOJ-ROUTINE.                                                02750001
030700*                                                                 02760001
030800     MOVE PC-TRAN-PRES-FUNC-CLOSE TO DP001-FUNC-CODE.             02770001
030900     PERFORM Z100-BUILD-COMM-AREA-TRAN-PRES.                      02780001
031000     DISPLAY 'NUMBER OF RECORDS UPDATED: ' PC-UPDATE-CNT.         02790002
031100*                                                                 02800001
031200******************************************************************02810001
031300*     Z100-BUILD-COMM-AREA-TRAN-PRES                             *02820001
031400*     - BUILD THE COMMUNICATION AREA FOR A CALL TO THE           *02830001
031500*       TRANSACTION PRESENTATION MODULE.                         *02840001
031600******************************************************************02850001
031700 Z100-BUILD-COMM-AREA-TRAN-PRES.                                  02860001
031800                                                                  02870001
031900     MOVE LENGTH OF WORK-STORAGE-PASSED                           02880001
032000                                       TO DP001-WORK-STRG-LENGTH. 02890001
032100     MOVE PC-CKPT-JOB-NAME             TO DP001-JOB-NAME.         02900001
032200     MOVE PC-CKPT-PLAN-NAME            TO DP001-PLAN-NAME.        02910001
032300     PERFORM Z900-CALL-TRANS-PRES-MODULE.                         02920001
032400     IF DP001-GOOD-RET-CODE                                       02930001
032500             OR DP001-CKPT-TAKEN                                  02940001
032600             OR DP001-RESTART                                     02950001
032700         MOVE DP001-TRANS-RECORD       TO                         02960001
032800           SS020-TRN-CTG-SUM-RECORD                               02970023
032900     ELSE                                                         02980001
033000         DISPLAY 'Z100-BUILD-COMM-AREA-TRAN-PRES '                02990001
033100         DISPLAY 'ERROR CALLING CHECKPOINT ROUTINE ON '           03000001
033200             DP001-FUNC-CODE                                      03010001
033300         DISPLAY 'DP001-RET-CODE IS ' DP001-RET-CODE              03020001
033400         PERFORM 9999-SQL-ABEND                                   03030027
033500     END-IF.                                                      03040001
033600                                                                  03050001
033700******************************************************************03060001
033800*  PERFORMED BY 6100-UPDATE AND 7200-INSERT                       03070001
033900*  THIS ROUTINE FORCES AN ABEND DUE TO A SQLCODE -911 (3 TIMES)   03080001
034000******************************************************************03090001
034100 9000-DEADLOCK-ERROR.                                             03100001
034200*                                                                 03110001
034300         MOVE PE-MSG-05             TO PV-DB2-OPER-ATTEMPTED      03120001
034400         PERFORM 9999-SQL-ABEND.                                  03130001
034500*                                                                 03140001
034600******************************************************************03150001
034700*  STANDARD DB2 ERROR ABEND ROUTINE                               03160001
034800*  THIS ROUTINE FORCES AN ABEND DUE TO A DB2 PROBLEM.             03170001
034900******************************************************************03180001
035000 9999-SQL-ABEND.                                                  03190001
035100                                                                  03200001
035200     MOVE +4013                 TO ABEND-CODE.                    03210001
035300     MOVE SQLCODE               TO PV-SQLCODE-DISPLAY.            03220001
035400     DISPLAY '**  ABEND     **'.                                  03230001
035500     DISPLAY '**  PROGRAM   ** => ' PC-PROGRAM-NAME.              03240001
035600     DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            03250001
035700     DISPLAY '**  OPERATION **  = ' PV-DB2-OPER-ATTEMPTED.        03260001
035800     DISPLAY '**  SQLCODE   **  = ' PV-SQLCODE-DISPLAY.           03270001
035900                                                                  03280001
036000                                                                  03290001
036100*    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE         03300001
036200*    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.        03310001
036300                                                                  03320001
036400     COPY DPPD004.                                                03330001
036500     CALL 'ILBOABN0'  USING ABEND-CODE.                           03340001
038700******************************************************************03350001
038800*  THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-  *03360001
038900*  MENTS THAT ARE REQUIRED TO INVOKE THE TRANSACTION PRESENTATION*03370001
039000*  MODULE (DPKUT901) OF THE DB2 CHECKPOINT RESTART SYSTEM.       *03380001
039100******************************************************************03390001
039200     COPY DPPD001.                                                03400001
