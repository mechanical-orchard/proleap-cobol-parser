000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.     APKUT287.                                        00020000
000300 AUTHOR.         NANCY EILBES.                                    00030000
000400 DATE-WRITTEN.   JUNE 2006.                                       00040000
000500*----------------------------------------------------------------*00050000
000600*    COBOL 2 WITH DB2 SQL                                        *00060000
000700*                                                                *00070000
000800*    EXTRACT MISSED PROFIT ASSIST/AD COOP DEDUCTIONS             *00080000
000900*                                                                *00090000
001000*   PROGRAM OVERVIEW:                                            *00100000
001100*                                                                *00110000
001200*  THIS PROGRAM READS THE FILE OF RECEIPTS MATCHED FOR THE       *00120000
001300*  CURRENT DATE AND IDENTIFIES THOSE WHERE A NEW VENDOR          *00130000
001400*  AGREEMENT FOR PROFIT ASSISTANCE WAS ADDED DURING THE          *00140000
001500*  CURRENT FISCAL MONTH AND THE INVOICES MATCHED AGAINST         *00150000
001600*  RECEIPTS FOR THAT SAME MONTH WERE DATED BEFORE THE START      *00160000
001700*  OF THE MONTH AND THE ALLOWANCE WAS NOT TAKEN.                 *00170000
001800*                                                                *00180000
001900*  FOR THE PO NUMBERS MEETING THE ABOVE RULES, ALL RECEIPTS      *00190000
002000*  WILL BE CAPTURED, ALONG WITH THEIR TOTAL COST AND VERIFIED    *00200000
002100*  DATES, AND ALL INVOICES WILL BE CAPTURED, ALONG WITH THEIR    *00210000
002200*  GROSS COSTS AND INDIVIDUAL ALLOWANCES.  ALL OF THIS DATA WILL *00220000
002300*  BE FORMATTED ON A REPORT IN APKRP266.                         *00230000
002400*                                                                *00240000
002500*   DB2 TABLES:                                                  *00250000
002600*  1. AP CONTROL TABLE                          (TAPCNTL)        *00260000
002700*  2. DATE ATTRIBUTE TABLE                      (TDTATTR)        *00270000
002800*  3. PURCHASE ORDER HEADER TABLE               (TPURCHS)        *00280000
002900*  4. INVOICE HEADER TABLE                      (TINVOIC)        *00290000
003000*  5. MERCHANDISE INVOICE TABLE                 (TMDINVC)        *00300000
003100*  6. INVOICE ALLOWANCE/CHARGE TABLE            (TALCHRG)        *00310000
003200*  7. VENDOR AGREEMENT TABLE                    (TVNDAGR)        *00320000
003300*  8. EXTERNAL ENTERPRISE TABLE                 (TEXTENT)        *00330000
003400*  9. EXTERNAL ENTERPRISE NAME TABLE            (TENTNME)        *00340000
003500*                                                                *00350000
003600*   INPUT:                                                       *00360000
003700*  1. MATCHED RECEIPTS EXTRACT                  (APRD105)        *00370000
003800*                                                                *00380000
003900*   OUTPUT:                                                      *00390000
004000*  1. MISSED PROFIT ASSIST REPORT FILE          (APRD057)        *00400000
004100*                                                                *00410000
004200*----------------------------------------------------------------*00420000
004300* CHANGE LOG:                                                    *00430000
004400* DATE  06/06/2006                                               *00440000
004500*      CHANGE MADE: INITIAL VERSION                              *00450000
004600*      MADE BY: NANCY EILBES            WR/IR #: WR30028         *00460000
004700*                                                                *00470000
004800* DATE  10/01/2007                                               *00480011
004900*      CHANGE MADE: INCREASED THE SIZE OF THE RECEIVER-TABLE FROM*00490011
005000*      500 TO 900 TO CORRECT A PRODUCTION ABEND. RCVR-INDEX-LIMIT*00500011
005100*      WAS ALSO INCREASED FROM 500 TO 900.                       *00510011
005200*      MADE BY: MIKE BESKE              WR/IR #: INC000000088183 *00520011
005300*                                                                *00530011
005310* DATE  11/23/2007                                               *00531014
005320*      CHANGE MADE: INCREASED THE SIZE OF THE RECEIVER-TABLE FROM*00532012
005330*      900 TO 1200TO CORRECT A PRODUCTION ABEND. RCVR-INDEX-LIMIT*00533013
005340*      WAS ALSO INCREASED FROM 900 TO 1200.                      *00534013
005350*      MADE BY: GREG WISIALOWSKI        WR/IR #: INC000000166139 *00535013
005360*                                                                *00536012
005370*                                                                *00537014
005380* DATE  02/26/2016                                               *00538014
005390*      CHANGE MADE: INCREASED THE SIZE OF THE RECEIVER-TABLE FROM*00539014
005391*      1200 TO 2500 TO CORRECT PRODUCTION ABEND. RCVR-INDEX-LIMIT*00539115
005392*      WAS ALSO INCREASED FROM 1200 TO 2500                      *00539214
005393*      MADE BY: COGNIZANT              WR/IR #: CHG0135445        00539316
005394*                                                                *00539414
005400*----------------------------------------------------------------*00540011
005500/                                                                 00550011
005600 ENVIRONMENT DIVISION.                                            00560011
005700 CONFIGURATION SECTION.                                           00570011
005800 INPUT-OUTPUT SECTION.                                            00580011
005900 FILE-CONTROL.                                                    00590011
006000                                                                  00600011
006100     SELECT MATCHED-RECEIPTS-FILE ASSIGN TO UT-S-INP01.           00610011
006200     SELECT MISSED-REPORT-FILE   ASSIGN TO UT-S-OUT01.            00620011
006300                                                                  00630011
006400 DATA DIVISION.                                                   00640011
006500 FILE SECTION.                                                    00650011
006600 FD  MATCHED-RECEIPTS-FILE                                        00660011
006700     RECORDING MODE IS F                                          00670011
006800     LABEL RECORDS ARE STANDARD                                   00680011
006900     BLOCK CONTAINS 0 RECORDS                                     00690011
007000     DATA RECORD IS MATCHED-RECEIPTS-RECORD.                      00700011
007100 01  MATCHED-RECEIPTS-RECORD     PIC X(200).                      00710011
007200                                                                  00720011
007300 FD  MISSED-REPORT-FILE                                           00730011
007400     RECORDING MODE IS F                                          00740011
007500     LABEL RECORDS ARE STANDARD                                   00750011
007600     BLOCK CONTAINS 0 RECORDS                                     00760011
007700     DATA RECORD IS MISSED-REPORT-RECORD.                         00770011
007800 01  MISSED-REPORT-RECORD        PIC X(120).                      00780011
007900                                                                  00790011
008000 WORKING-STORAGE SECTION.                                         00800011
008100                                                                  00810011
008200 01  PROGRAM-WORKAREA.                                            00820011
008300     05  FILLER                       PIC X(30) VALUE             00830011
008400         '** BEGINING OF APKUT287 W/S **'.                        00840011
008500                                                                  00850011
008600     05  PV-CURRENT-PARAGRAPH         PIC X(30) VALUE SPACE.      00860011
008700     05  PV-PROGRAM-NAME              PIC X(08) VALUE 'APKUT287'. 00870011
008800     05  INPUT-COUNT                  PIC 9(09) VALUE  0.         00880011
008900     05  OUTPUT-COUNT                 PIC 9(09) VALUE  0.         00890011
009000     05  PV-AGRMT-RECORDS-WRITTEN     PIC 9(09) VALUE  0.         00900011
009100     05  PV-RECVR-RECORDS-WRITTEN     PIC 9(09) VALUE  0.         00910011
009200     05  PV-INVC-RECORDS-WRITTEN      PIC 9(09) VALUE  0.         00920011
009300     05  PV-ALLW-RECORDS-WRITTEN      PIC 9(09) VALUE  0.         00930011
009400     05  PV-ONE                       PIC X(1)  VALUE SPACES.     00940011
009500     05  DISPLAY-PO-NBR               PIC 9(9)  VALUE ZEROS.      00950011
009600     05  DISPLAY-RCVR-SEQ-NBR         PIC 9(9)  VALUE ZEROS.      00960011
009700     05  PV-PO-NBR-9                  PIC S9(9) VALUE ZEROS.      00970011
009800     05  SAVE-PO-NBR                  PIC S9(9) VALUE ZEROS COMP. 00980011
009900     05  PV-PO-TYP-CDE                PIC X(2).                   00990011
010000         88  IMPORT-PO                     VALUE 'IM', 'IE', 'IF'.01000011
010100     05  PV-VERFYD-TMST               PIC X(26).                  01010011
010200     05  FILLER REDEFINES PV-VERFYD-TMST.                         01020011
010300         10  PV-VERFYD-DTE            PIC X(10).                  01030011
010400         10  FILLER                   PIC X(16).                  01040011
010500                                                                  01050011
010600 01  RCVR-INDEX-LIMIT                 PIC S9(9) VALUE 2500        01060014
010700                                                COMP SYNC.        01070011
010800 01  RECEIVER-TABLE.                                              01080011
010900     05  RCVR-INDEX-MAX               PIC S9(9) VALUE 0           01090011
011000                                                COMP SYNC.        01100011
011100     05  RCVR-TABLE OCCURS 2500 TIMES INDEXED BY RCVR-INDEX.      01110014
011200         10  RCVR-SEQ-NBR             PIC 9(09).                  01120011
011300         10  RCVR-QTY                 PIC 9(07).                  01130011
011400         10  RCVR-AMT                 PIC 9(09)V99  COMP-3.       01140011
011500         10  RCVR-VERFYD-DTE          PIC X(10).                  01150011
011600                                                                  01160011
011700 01  INVC-INDEX-LIMIT                 PIC S9(9) VALUE 5000        01170011
011800                                                COMP SYNC.        01180011
011900 01  INVOICE-TABLE.                                               01190011
012000     05  INVC-INDEX-MAX               PIC S9(9) VALUE 0           01200011
012100                                                COMP SYNC.        01210011
012200     05  INVC-TABLE OCCURS 5000 TIMES INDEXED BY INVC-INDEX.      01220011
012300         10  INVC-NBR                  PIC X(22).                 01230011
012400         10  INVC-DTE                  PIC X(10).                 01240011
012500         10  INVC-QTY                  PIC 9(07).                 01250011
012600         10  INVC-GRO-COST-AMT         PIC 9(09)V99  COMP-3.      01260011
012700                                                                  01270011
012800 01  PROGRAM-SWITCHES-SUBS.                                       01280011
012900     05  PV-EOF-SW                     PIC X    VALUE 'N'.        01290011
013000         88  END-OF-RECEIPTS                    VALUE 'Y'.        01300011
013100     05  PS-OUT-OF-INVOICES-SW         PIC X    VALUE 'N'.        01310011
013200         88  OUT-OF-INVOICES                    VALUE 'Y'.        01320011
013300         88  MORE-INVOICES                      VALUE 'N'.        01330011
013400     05  PS-OUT-OF-ALLOWANCES-SW       PIC X    VALUE 'N'.        01340011
013500         88  OUT-OF-ALLOWANCES                  VALUE 'Y'.        01350011
013600         88  MORE-ALLOWANCES                    VALUE 'N'.        01360011
013700     05  RECEIVER-SW                   PIC X    VALUE 'N'.        01370011
013800         88  QUALIFYING-RECEIVER-FOUND          VALUE 'Y'.        01380011
013900         88  NO-QUALIFYING-RECEIVER-FOUND       VALUE 'N'.        01390011
014000     05  AGREEMENT-SW                  PIC X    VALUE 'N'.        01400011
014100         88  EFFECTIVE-AGREEMENT-FOUND          VALUE 'Y'.        01410011
014200         88  NO-EFFECTIVE-AGREEMENT-FOUND       VALUE 'N'.        01420011
014300     05  INVOICE-SW                    PIC X    VALUE 'N'.        01430011
014400         88  QUALIFYING-INVOICE-FOUND           VALUE 'Y'.        01440011
014500         88  NO-QUALIFYING-INVOICE-FOUND        VALUE 'N'.        01450011
014600     05  ALLOWANCE-SW                  PIC X    VALUE 'N'.        01460011
014700         88  ALW-ALLOWANCE-FOUND                VALUE 'Y'.        01470011
014800         88  NO-ALW-ALLOWANCE-FOUND             VALUE 'N'.        01480011
014900                                                                  01490011
015000 01  CONTROL-CARD.                                                01500011
015100     05  CC-RQST-BATCH-DTE               PIC X(10).               01510011
015200         88  CC-TODAYS-BATCH           VALUE 'TODAY     '.        01520011
015300                                                                  01530011
015400*----------------------------------------------------------------*01540011
015500*  INPUT RECORD AREA                                              01550011
015600*----------------------------------------------------------------*01560011
015700     COPY APRD105.                                                01570011
015800                                                                  01580011
015900*----------------------------------------------------------------*01590011
016000*  OUTPUT RECORD AREA                                             01600011
016100*----------------------------------------------------------------*01610011
016200     COPY APRD090.                                                01620011
016300                                                                  01630011
016400*----------------------------------------------------------------*01640011
016500*  AP CONTROL TABLE                                              *01650011
016600*----------------------------------------------------------------*01660011
016700     EXEC SQL                                                     01670011
016800          INCLUDE TAPCNTL                                         01680011
016900     END-EXEC.                                                    01690011
017000                                                                  01700011
017100*----------------------------------------------------------------*01710011
017200*  DATE ATTRIBUTE TABLE                                          *01720011
017300*----------------------------------------------------------------*01730011
017400     EXEC SQL                                                     01740011
017500          INCLUDE TDTATTR                                         01750011
017600     END-EXEC.                                                    01760011
017700                                                                  01770011
017800*----------------------------------------------------------------*01780011
017900*  PURCHASE ORDER HEADER TABLE                                   *01790011
018000*----------------------------------------------------------------*01800011
018100     EXEC SQL                                                     01810011
018200          INCLUDE TPURCHS                                         01820011
018300     END-EXEC.                                                    01830011
018400                                                                  01840011
018500*----------------------------------------------------------------*01850011
018600*  INVOICE HEADER TABLE                                          *01860011
018700*----------------------------------------------------------------*01870011
018800     EXEC SQL                                                     01880011
018900          INCLUDE TINVOIC                                         01890011
019000     END-EXEC.                                                    01900011
019100                                                                  01910011
019200*----------------------------------------------------------------*01920011
019300*  MERCHANDISE INVOICE TABLE                                     *01930011
019400*----------------------------------------------------------------*01940011
019500     EXEC SQL                                                     01950011
019600          INCLUDE TMDINVC                                         01960011
019700     END-EXEC.                                                    01970011
019800                                                                  01980011
019900*----------------------------------------------------------------*01990011
020000*  INVOICE ALLOWANCE TABLE                                       *02000011
020100*----------------------------------------------------------------*02010011
020200     EXEC SQL                                                     02020011
020300          INCLUDE TALCHRG                                         02030011
020400     END-EXEC.                                                    02040011
020500                                                                  02050011
020600*----------------------------------------------------------------*02060011
020700*  VENDOR AGREEMENT TABLE                                        *02070011
020800*----------------------------------------------------------------*02080011
020900     EXEC SQL                                                     02090011
021000          INCLUDE TVNDAGR                                         02100011
021100     END-EXEC.                                                    02110011
021200                                                                  02120011
021300*----------------------------------------------------------------*02130011
021400*  EXTERNAL ENTERPRISE TABLE                                     *02140011
021500*----------------------------------------------------------------*02150011
021600     EXEC SQL                                                     02160011
021700          INCLUDE TEXTENT                                         02170011
021800     END-EXEC.                                                    02180011
021900                                                                  02190011
022000*----------------------------------------------------------------*02200011
022100*  EXTERNAL ENTERPRISE NAME TABLE                                *02210011
022200*----------------------------------------------------------------*02220011
022300     EXEC SQL                                                     02230011
022400          INCLUDE TENTNME                                         02240011
022500     END-EXEC.                                                    02250011
022600                                                                  02260011
022700*----------------------------------------------------------------*02270011
022800*    DB2 AREA FOR SYSDUMMY1                                      *02280011
022900*----------------------------------------------------------------*02290011
023000     EXEC SQL                                                     02300011
023100          INCLUDE SYSDUMMY                                        02310011
023200     END-EXEC.                                                    02320011
023300                                                                  02330011
023400*                                                                 02340011
023500*    SQL COMMUNICATIONS AREA DCLGEN                               02350011
023600*                                                                 02360011
023700     EXEC SQL                                                     02370011
023800         INCLUDE SQLCA                                            02380011
023900     END-EXEC.                                                    02390011
024000                                                                  02400011
024100*----------------------------------------------------------------*02410011
024200* INVOICE_CSR WILL FETCH ALL MI'S FOR THE PO BEING PROCESSED     *02420011
024300* THAT HAVE AN AP_PRC_DTE EQUAL TO THE APCNTL_BTCH_PRC_DTE.      *02430011
024400* THE INVOICES WILL BE SORTED BY INVOICE DATE SO THE PROGRAM CAN *02440011
024500* QUICKLY IDENTIFY WHETHER OR NOT THERE ARE ELIGIBLE INVOICES.   *02450011
024600*----------------------------------------------------------------*02460011
024700     EXEC SQL                                                     02470011
024800       DECLARE INVOICE_CSR CURSOR FOR                             02480011
024900         SELECT A.INVC_ID                                         02490011
025000              , A.INVC_DTE                                        02500011
025100              , A.GRO_COST_AMT                                    02510011
025200              , B.TOT_INVC_PC_QTY                                 02520011
025300          FROM TINVOIC A                                          02530011
025400             , TMDINVC B                                          02540011
025500         WHERE A.PO_NBR             = :SAVE-PO-NBR                02550011
025600           AND A.PO_NBR             = B.PO_NBR                    02560011
025700           AND A.INVC_ID            = B.INVC_ID                   02570011
025800           AND INVC_TYP_CDE         = 'MI'                        02580011
025900           AND AP_PRC_DTE           = :APCNTL-BTCH-PRC-DTE        02590011
026000      ORDER BY A.INVC_DTE                                         02600011
026100     END-EXEC.                                                    02610011
026200                                                                  02620011
026300*---------------------------------------------------------------- 02630011
026400* ALLOWANCE_CSR GETS ALL ALLOWANCES FOR THE PO/INVOICE            02640011
026500*---------------------------------------------------------------- 02650011
026600     EXEC SQL                                                     02660011
026700       DECLARE ALLOWANCE_CSR CURSOR FOR                           02670011
026800         SELECT ALW_CHRG_CDE                                      02680011
026900              , ALW_CHRG_PCT                                      02690011
027000              , ALW_CHRG_AMT                                      02700011
027100           FROM TALCHRG                                           02710011
027200          WHERE PO_NBR           = :SAVE-PO-NBR                   02720011
027300            AND INVC_ID          = :ALCHRG-INVC-ID                02730011
027400            AND ALW_CHRG_TYP_CDE = 'A'                            02740011
027500     END-EXEC.                                                    02750011
027600*----------------------------------------------------------------*02760011
027700*  ABEND DATA AREAS                                              *02770011
027800*----------------------------------------------------------------*02780011
027900 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          02790011
028000                                             COMP SYNC.           02800011
028100     88  AC-BAD-DATA                         VALUE +4003.         02810011
028200     88  AC-TABLE-OVERFLOW                   VALUE +4004.         02820011
028300     88  AC-DB2-ERROR                        VALUE +4013.         02830011
028400     88  AC-DATE-ERROR                       VALUE +4019.         02840011
028500                                                                  02850011
028600                                                                  02860011
028700 01  ABEND-AREAS.                                                 02870011
028800     05  AA-ABEND-LIT            PIC  X(40)  VALUE                02880011
028900             '*****       ABEND'.                                 02890011
029000     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                02900011
029100             '*****   PROGRAM: APKUT287'.                         02910011
029200     05  AA-PARAGRAPH-LIT.                                        02920011
029300         10  FILLER              PIC  X(17)  VALUE                02930011
029400             '***** PARAGRAPH: '.                                 02940011
029500         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        02950011
029600     05  AA-MESSAGE-LINE.                                         02960011
029700         10  FILLER              PIC  X(06)  VALUE '*****'.       02970011
029800         10  AA-MESSAGE          PIC  X(127) VALUE SPACES.        02980011
029900     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                02990011
030000             '*****    DB2 ERROR'.                                03000011
030100     05  AA-DB2-OPERATION-LIT.                                    03010011
030200         10  FILLER              PIC  X(17)  VALUE                03020011
030300             '***** OPERATION: '.                                 03030011
030400         10  AA-DB2-OPERATION.                                    03040011
030500             15  AA-DB2-OP-1     PIC  X(50)  VALUE SPACES.        03050011
030600             15  AA-DB2-OP-2     PIC  X(25)  VALUE SPACES.        03060011
030700     05  AA-DB2-TABLE-1          PIC  X(08)  VALUE SPACES.        03070011
030800     05  AA-DB2-TABLE-2          PIC  X(08)  VALUE SPACES.        03080011
030900     05  AA-DB2-TABLE-3          PIC  X(08)  VALUE SPACES.        03090011
031000                                                                  03100011
031100     COPY DPWS004.                                                03110011
031200                                                                  03120011
031300 01  FILLER                      PIC  X(25)  VALUE                03130011
031400     '** END OF APKUT287 W/S **'.                                 03140011
031500                                                                  03150011
031600 PROCEDURE DIVISION.                                              03160011
031700                                                                  03170011
031800***************************************************************** 03180011
031900*  MAIN DRIVER PARAGRAPH                                          03190011
032000***************************************************************** 03200011
032100 A100-MAIN.                                                       03210011
032200                                                                  03220011
032300     PERFORM B100-INTIALIZE.                                      03230011
032400                                                                  03240011
032500     PERFORM B200-PROCESS-DATA                                    03250011
032600       UNTIL END-OF-RECEIPTS.                                     03260011
032700                                                                  03270011
032800     PERFORM B300-END-PROGRAM.                                    03280011
032900                                                                  03290011
033000     GOBACK.                                                      03300011
033100                                                                  03310011
033200***************************************************************** 03320011
033300*  PROGRAM INITIALIZATION                                         03330011
033400***************************************************************** 03340011
033500 B100-INTIALIZE.                                                  03350011
033600                                                                  03360011
033700     MOVE 'B100-INTIALIZE'       TO   PV-CURRENT-PARAGRAPH.       03370011
033800                                                                  03380011
033900     DISPLAY '**********************************************'.    03390011
034000     DISPLAY '**        PROGRAM APKUT287 BEGINNING        **'.    03400011
034100     DISPLAY '**********************************************'.    03410011
034200                                                                  03420011
034300     OPEN INPUT  MATCHED-RECEIPTS-FILE                            03430011
034400          OUTPUT MISSED-REPORT-FILE.                              03440011
034500                                                                  03450011
034600     INITIALIZE DCLTAPCNTL                                        03460011
034700                DCLTDTATTR                                        03470011
034800                DCLTPURCHS                                        03480011
034900                DCLTINVOIC                                        03490011
035000                DCLTALCHRG                                        03500011
035100                DCLTVNDAGR                                        03510011
035200                DCLTEXTENT                                        03520011
035300                DCLTENTNME                                        03530011
035400                AP090-RECORD.                                     03540011
035500                                                                  03550011
035600     ACCEPT CONTROL-CARD.                                         03560011
035700     DISPLAY '*** CONTROL CARD FOR THIS RUN ***'                  03570011
035800     DISPLAY CONTROL-CARD.                                        03580011
035900     DISPLAY '*** END OF CONTROL CARD ***'                        03590011
036000                                                                  03600011
036100     PERFORM S100-SELECT-PROCESS-DATES.                           03610011
036200                                                                  03620011
036300     PERFORM R100-READ-MATCHED-RECEIPTS.                          03630011
036400                                                                  03640011
036500******************************************************************03650011
036600* PROCESS THE PO FROM THE INPUT FILE TO DETERMINE IF IT QUALIFIES*03660011
036700* FOR THE MISSED ALLOWANCE REPORT.                               *03670011
036800******************************************************************03680011
036900 B200-PROCESS-DATA.                                               03690011
037000                                                                  03700011
037100     MOVE AP105-PO-NBR TO PV-PO-NBR-9.                            03710011
037200     MOVE PV-PO-NBR-9  TO SAVE-PO-NBR.                            03720011
037300     SET RCVR-INDEX TO 1.                                         03730011
037400     SET RCVR-INDEX DOWN BY 1.                                    03740011
037500                                                                  03750011
037600     PERFORM C100-LOAD-RECEIPTS                                   03760011
037700       UNTIL AP105-PO-NBR > SAVE-PO-NBR                           03770011
037800          OR END-OF-RECEIPTS.                                     03780011
037900     SET RCVR-INDEX-MAX TO RCVR-INDEX.                            03790011
038000                                                                  03800011
038100     IF  QUALIFYING-RECEIVER-FOUND                                03810011
038200     MOVE SAVE-PO-NBR TO DISPLAY-PO-NBR                           03820011
038300**** DISPLAY 'QUALIFYING RECEIVER FOR PO ' DISPLAY-PO-NBR         03830011
038400         PERFORM S200-SELECT-PO-INFO                              03840011
038500         IF  IMPORT-PO                                            03850011
038600             CONTINUE                                             03860011
038700         ELSE                                                     03870011
038800             PERFORM S300-SELECT-ALW-AGREEMENT                    03880011
038900             IF  EFFECTIVE-AGREEMENT-FOUND                        03890011
039000     MOVE SAVE-PO-NBR TO DISPLAY-PO-NBR                           03900011
039100     DISPLAY 'EFFECTIVE AGREEMENT FOR PO ' DISPLAY-PO-NBR         03910011
039200                 PERFORM C200-LOAD-MATCHING-INVOICES              03920011
039300                 IF  QUALIFYING-INVOICE-FOUND                     03930011
039400     MOVE SAVE-PO-NBR TO DISPLAY-PO-NBR                           03940011
039500     DISPLAY 'QUALIFYING INVOICE FOR PO ' DISPLAY-PO-NBR          03950011
039600                     PERFORM C300-PROCESS-REPORT-RECORDS          03960011
039700                 END-IF                                           03970011
039800             END-IF                                               03980011
039900         END-IF                                                   03990011
040000     END-IF.                                                      04000011
040100                                                                  04010011
040200     SET NO-QUALIFYING-RECEIVER-FOUND TO TRUE.                    04020011
040300     SET NO-EFFECTIVE-AGREEMENT-FOUND TO TRUE.                    04030011
040400     SET NO-QUALIFYING-INVOICE-FOUND  TO TRUE.                    04040011
040500                                                                  04050011
040600     PERFORM VARYING RCVR-INDEX FROM 1 BY 1                       04060011
040700       UNTIL RCVR-INDEX > RCVR-INDEX-MAX                          04070011
040800         INITIALIZE RCVR-TABLE(RCVR-INDEX)                        04080011
040900     END-PERFORM.                                                 04090011
041000     MOVE 1 TO RCVR-INDEX-MAX.                                    04100011
041100                                                                  04110011
041200     PERFORM VARYING INVC-INDEX FROM 1 BY 1                       04120011
041300       UNTIL INVC-INDEX > INVC-INDEX-MAX                          04130011
041400         INITIALIZE INVC-TABLE(INVC-INDEX)                        04140011
041500     END-PERFORM.                                                 04150011
041600     MOVE 1 TO INVC-INDEX-MAX.                                    04160011
041700                                                                  04170011
041800***************************************************************** 04180011
041900*  END OF PROCESSING.  CLOSE FILES.  DISPLAY COUNTS.              04190011
042000***************************************************************** 04200011
042100 B300-END-PROGRAM.                                                04210011
042200                                                                  04220011
042300     MOVE 'B300-END-PROGRAM'     TO   PV-CURRENT-PARAGRAPH.       04230011
042400                                                                  04240011
042500     CLOSE  MATCHED-RECEIPTS-FILE                                 04250011
042600            MISSED-REPORT-FILE.                                   04260011
042700                                                                  04270011
042800     DISPLAY '***** APKUT287 COUNTS *****'.                       04280011
042900     DISPLAY 'RECORDS READ    = ' INPUT-COUNT.                    04290011
043000     DISPLAY 'AGREEMENT COUNT = ' PV-AGRMT-RECORDS-WRITTEN.       04300011
043100     DISPLAY 'RECEIVER COUNT  = ' PV-RECVR-RECORDS-WRITTEN.       04310011
043200     DISPLAY 'INVOICE COUNT   = ' PV-INVC-RECORDS-WRITTEN.        04320011
043300     DISPLAY 'ALLOWANCE COUNT = ' PV-ALLW-RECORDS-WRITTEN.        04330011
043400     DISPLAY 'TOTAL WRITTEN   = ' OUTPUT-COUNT.                   04340011
043500     DISPLAY '***************************'.                       04350011
043600                                                                  04360011
043700***************************************************************** 04370011
043800*  LOAD ALL RECEIVERS FOR THE PO BEING PROCESSED INTO THE RECEIPT 04380011
043900*  ARRAY.  KEEP TRACK OF WHETHER ANY VERIFIED DATES FALL INSIDE   04390011
044000*  THE CURRENT FISCAL MONTH.                                      04400011
044100***************************************************************** 04410011
044200 C100-LOAD-RECEIPTS.                                              04420011
044300                                                                  04430011
044400     SET RCVR-INDEX UP BY 1.                                      04440011
044500     IF  RCVR-INDEX > RCVR-INDEX-LIMIT                            04450011
044600         SET AC-TABLE-OVERFLOW           TO TRUE                  04460011
044700         MOVE SAVE-PO-NBR TO DISPLAY-PO-NBR                       04470011
044800         MOVE AP105-RECEIVER-SEQ-NUMBER TO DISPLAY-RCVR-SEQ-NBR   04480011
044900         DISPLAY 'PO = ' DISPLAY-PO-NBR                           04490011
045000         DISPLAY ' RECEIVER =  ' DISPLAY-RCVR-SEQ-NBR             04500011
045100         MOVE 'C100-LOAD-RECEIPTS'  TO AA-PARAGRAPH-NAME          04510011
045200         MOVE 'RECEIVING ARRAY EXCEEDS LIMIT' TO AA-MESSAGE       04520011
045300         PERFORM Z999-ABEND                                       04530011
045400     END-IF.                                                      04540011
045500                                                                  04550011
045600     MOVE AP105-RECEIVER-SEQ-NUMBER TO RCVR-SEQ-NBR(RCVR-INDEX).  04560011
045700     MOVE AP105-NR-NON-INVC-UNT-QTY TO RCVR-QTY(RCVR-INDEX).      04570011
045800     MOVE AP105-TOTAL-COST          TO RCVR-AMT(RCVR-INDEX).      04580011
045900     MOVE AP105-RV-VERFYD-TMST      TO PV-VERFYD-TMST.            04590011
046000     MOVE PV-VERFYD-DTE            TO RCVR-VERFYD-DTE(RCVR-INDEX).04600011
046100                                                                  04610011
046200     IF  PV-VERFYD-DTE >= DTATTR-FSCL-MN-BEG-DTE                  04620011
046300     AND PV-VERFYD-DTE <= DTATTR-FSCL-MN-END-DTE                  04630011
046400         SET QUALIFYING-RECEIVER-FOUND TO TRUE                    04640011
046500     END-IF.                                                      04650011
046600                                                                  04660011
046700     PERFORM R100-READ-MATCHED-RECEIPTS.                          04670011
046800                                                                  04680011
046900*----------------------------------------------------------------*04690011
047000*  OPEN THE INVOICE CURSOR AND PROCESS THE FIRST FETCH.  IF THE   04700011
047100*  INVOICE DATE ON THE FIRST FETCH IS OLDER THAN THE FISCAL MONTH 04710011
047200*  BEGIN DATE, THEN THERE ARE QUALIFYING INVOICES AND ALL OF THE  04720011
047300*  MATCHING INVOICES WILL BE LOADED INTO THE INVOICE ARRAY.       04730011
047400*  SINCE THE CURSOR IS ORDERED BY INVOICE DATE, IF THE FIRST ROW  04740011
047500*  DOESN'T QUALIFY, THE REST WILL NOT QUALIFY EITHER, SO THE      04750011
047600*  CURSOR WILL BE CLOSED AND NO FURTHER PROCESSING WILL BE DONE   04760011
047700*  FOR THIS PO.                                                   04770011
047800*----------------------------------------------------------------*04780011
047900 C200-LOAD-MATCHING-INVOICES.                                     04790011
048000                                                                  04800011
048100     SET MORE-INVOICES TO TRUE.                                   04810011
048200     PERFORM Y100-OPEN-INVOICE-CSR.                               04820011
048300     PERFORM R200-FETCH-INVOICES.                                 04830011
048400                                                                  04840011
048500     IF  OUT-OF-INVOICES                                          04850011
048600         CONTINUE                                                 04860011
048700     ELSE                                                         04870011
048800         IF  INVOIC-INVC-DTE < DTATTR-FSCL-MN-BEG-DTE             04880011
048900             PERFORM S500-SELECT-ALW-ALLOWANCE                    04890011
049000             IF  NO-ALW-ALLOWANCE-FOUND                           04900011
049100                 SET QUALIFYING-INVOICE-FOUND TO TRUE             04910011
049200                 SET INVC-INDEX TO 1                              04920011
049300                 SET INVC-INDEX DOWN BY 1                         04930011
049400                 PERFORM D100-LOAD-INVOICE-ARRAY                  04940011
049500                   UNTIL OUT-OF-INVOICES                          04950011
049600                 SET INVC-INDEX-MAX TO INVC-INDEX                 04960011
049700             END-IF                                               04970011
049800         END-IF                                                   04980011
049900     END-IF.                                                      04990011
050000                                                                  05000011
050100     PERFORM Y200-CLOSE-INVOICE-CSR.                              05010011
050200                                                                  05020011
050300*----------------------------------------------------------------*05030011
050400*  FORMAT ALL REPORT OUTPUT RECORDS.                              05040011
050500*  NOTE THAT THE CREATION OF THE RECEIVER RECORDS WAS COMMENTED   05050011
050600*  OUT BECAUSE THE RECEIPTS WILL BE CAPTURED IN APKUT288.         05060011
050700*----------------------------------------------------------------*05070011
050800 C300-PROCESS-REPORT-RECORDS.                                     05080011
050900                                                                  05090011
051000     INITIALIZE AP090-RECORD.                                     05100011
051100                                                                  05110011
051200     PERFORM S400-SELECT-VENDOR-NAME.                             05120011
051300                                                                  05130011
051400     MOVE EXTENT-DUN-NBR         TO AP090-VENDOR-NBR.             05140011
051500     MOVE ENTNME-ENT-NAME-DESC   TO AP090-VENDOR-NAME.            05150011
051600     MOVE PURCHS-DEPT-NBR        TO AP090-DEPT-NBR.               05160011
051700     MOVE SAVE-PO-NBR            TO AP090-PO-NBR.                 05170011
051800     SET AP090-CURRENT-PERIOD    TO TRUE.                         05180011
051900                                                                  05190011
052000     SET AP090-VNDAGR-DATA       TO TRUE.                         05200011
052100     MOVE VNDAGR-EFFECTIVE-DATE  TO AP090-EFFECTIVE-DATE.         05210011
052200     MOVE 'ALW'                  TO AP090-ALLOW-TYP-CDE.          05220011
052300     MOVE VNDAGR-DISCOUNT-PCT    TO AP090-ALLOW-PERCENT.          05230011
052400                                                                  05240011
052500     PERFORM W100-WRITE-REPORT-RECORD.                            05250011
052600     ADD +1 TO PV-AGRMT-RECORDS-WRITTEN.                          05260011
052700                                                                  05270011
052800     MOVE SPACES TO AP090-AGRMNT-RECORD.                          05280011
052900                                                                  05290011
053000*    SET AP090-RECEIVER-DATA     TO TRUE.                         05300011
053100*                                                                 05310011
053200*    PERFORM VARYING RCVR-INDEX FROM 1 BY 1                       05320011
053300*      UNTIL RCVR-INDEX > RCVR-INDEX-MAX                          05330011
053400*         MOVE RCVR-SEQ-NBR(RCVR-INDEX)    TO AP090-RECVR-SEQ-NBR 05340011
053500*         MOVE RCVR-QTY(RCVR-INDEX)        TO AP090-RECVR-QTY     05350011
053600*         MOVE RCVR-AMT(RCVR-INDEX)        TO AP090-RECVR-AMT     05360011
053700*         MOVE RCVR-VERFYD-DTE(RCVR-INDEX)                        05370011
053800*                                        TO AP090-RECVR-VERFYD-DTE05380011
053900*         PERFORM W100-WRITE-REPORT-RECORD                        05390011
054000*         ADD +1 TO PV-RECVR-RECORDS-WRITTEN                      05400011
054100*    END-PERFORM.                                                 05410011
054200                                                                  05420011
054300     PERFORM VARYING INVC-INDEX FROM 1 BY 1                       05430011
054400       UNTIL INVC-INDEX > INVC-INDEX-MAX                          05440011
054500          MOVE INVC-NBR(INVC-INDEX) TO ALCHRG-INVC-ID             05450011
054600          MOVE SPACES TO AP090-AGRMNT-RECORD                      05460011
054700          SET MORE-ALLOWANCES TO TRUE                             05470011
054800          PERFORM Y300-OPEN-ALLOWANCE-CSR                         05480011
054900          PERFORM R300-FETCH-ALLOWANCES                           05490011
055000          IF  OUT-OF-ALLOWANCES                                   05500011
055100              SET AP090-NO-ALLOWANCES-EXIST TO TRUE               05510011
055200          ELSE                                                    05520011
055300              SET AP090-INVOICE-DATA                              05530011
055400                  AP090-ALLOWANCE-DATA TO TRUE                    05540011
055500              PERFORM D200-CREATE-ALLOWANCE-RECORDS               05550011
055600                UNTIL OUT-OF-ALLOWANCES                           05560011
055700              MOVE SPACES TO AP090-AGRMNT-RECORD                  05570011
055800              SET AP090-ALLOWANCES-EXIST TO TRUE                  05580011
055900          END-IF                                                  05590011
056000          PERFORM Y400-CLOSE-ALLOWANCE-CSR                        05600011
056100          SET AP090-INVOICE-DATA                                  05610011
056200              AP090-INVOICE-HEADER      TO TRUE                   05620011
056300          MOVE INVC-NBR(INVC-INDEX)     TO AP090-INVC-NBR         05630011
056400          MOVE INVC-DTE(INVC-INDEX)     TO AP090-INVC-DATE        05640011
056500          MOVE INVC-QTY(INVC-INDEX)     TO AP090-INVC-QTY         05650011
056600          MOVE INVC-GRO-COST-AMT(INVC-INDEX)                      05660011
056700                                        TO AP090-INVC-GRO-COST-AMT05670011
056800          PERFORM W100-WRITE-REPORT-RECORD                        05680011
056900          ADD +1 TO PV-INVC-RECORDS-WRITTEN                       05690011
057000     END-PERFORM.                                                 05700011
057100                                                                  05710011
057200*----------------------------------------------------------------*05720011
057300*  LOAD ALL INVOICES FOR THE PO BEING PROCESSED INTO THE INVOICE  05730011
057400*  ARRAY.                                                         05740011
057500*----------------------------------------------------------------*05750011
057600 D100-LOAD-INVOICE-ARRAY.                                         05760011
057700                                                                  05770011
057800     SET INVC-INDEX UP BY 1.                                      05780011
057900     IF  INVC-INDEX > INVC-INDEX-LIMIT                            05790011
058000         SET AC-TABLE-OVERFLOW           TO TRUE                  05800011
058100         MOVE SAVE-PO-NBR TO DISPLAY-PO-NBR                       05810011
058200         DISPLAY 'PO = ' DISPLAY-PO-NBR                           05820011
058300         DISPLAY ' INVOICE =  ' INVOIC-INVC-ID                    05830011
058400         MOVE 'D100-LOAD-INVOICE-ARRAY'     TO AA-PARAGRAPH-NAME  05840011
058500         MOVE 'INVOICE ARRAY EXCEEDS LIMIT' TO AA-MESSAGE         05850011
058600         PERFORM Z999-ABEND                                       05860011
058700     END-IF.                                                      05870011
058800                                                                  05880011
058900     MOVE INVOIC-INVC-ID         TO INVC-NBR(INVC-INDEX).         05890011
059000     MOVE INVOIC-INVC-DTE        TO INVC-DTE(INVC-INDEX).         05900011
059100     MOVE MDINVC-TOT-INVC-PC-QTY TO INVC-QTY(INVC-INDEX).         05910011
059200     MOVE INVOIC-GRO-COST-AMT    TO INVC-GRO-COST-AMT(INVC-INDEX).05920011
059300                                                                  05930011
059400     PERFORM R200-FETCH-INVOICES.                                 05940011
059500                                                                  05950011
059600*----------------------------------------------------------------*05960011
059700*  MOVE THE ALLOWANCE DATA TO THE OUTPUT RECORD AND WRITE IT.     05970011
059800*----------------------------------------------------------------*05980011
059900 D200-CREATE-ALLOWANCE-RECORDS.                                   05990011
060000                                                                  06000011
060100     MOVE ALCHRG-INVC-ID      TO AP090-ALW-INVC-NBR.              06010011
060200     MOVE ALCHRG-ALW-CHRG-CDE TO AP090-ALW-CDE.                   06020011
060300     MOVE ALCHRG-ALW-CHRG-PCT TO AP090-ALW-PCNT.                  06030011
060400     MOVE ALCHRG-ALW-CHRG-AMT TO AP090-ALW-AMT.                   06040011
060500                                                                  06050011
060600     PERFORM W100-WRITE-REPORT-RECORD.                            06060011
060700     ADD +1 TO PV-ALLW-RECORDS-WRITTEN.                           06070011
060800                                                                  06080011
060900     PERFORM R300-FETCH-ALLOWANCES.                               06090011
061000*----------------------------------------------------------------*06100011
061100*  READ THE INPUT FILE.                                           06110011
061200*----------------------------------------------------------------*06120011
061300 R100-READ-MATCHED-RECEIPTS.                                      06130011
061400                                                                  06140011
061500     MOVE 'R100-READ-MATCHED-RECEIPTS'                            06150011
061600                                 TO   PV-CURRENT-PARAGRAPH.       06160011
061700                                                                  06170011
061800     READ MATCHED-RECEIPTS-FILE INTO AP105-RECORD                 06180011
061900         AT END                                                   06190011
062000             SET END-OF-RECEIPTS TO TRUE.                         06200011
062100                                                                  06210011
062200     IF NOT END-OF-RECEIPTS                                       06220011
062300        ADD +1 TO INPUT-COUNT                                     06230011
062400     END-IF.                                                      06240011
062500                                                                  06250011
062600*----------------------------------------------------------------*06260011
062700*  RETRIEVES THE INVOICE DATA FOR THE PO BEING PROCESSED.         06270011
062800*----------------------------------------------------------------*06280011
062900 R200-FETCH-INVOICES.                                             06290011
063000                                                                  06300011
063100     EXEC SQL                                                     06310011
063200         FETCH INVOICE_CSR                                        06320011
063300         INTO :INVOIC-INVC-ID                                     06330011
063400             ,:INVOIC-INVC-DTE                                    06340011
063500             ,:INVOIC-GRO-COST-AMT                                06350011
063600             ,:MDINVC-TOT-INVC-PC-QTY                             06360011
063700     END-EXEC.                                                    06370011
063800                                                                  06380011
063900     EVALUATE TRUE                                                06390011
064000         WHEN SQLCODE = ZERO                                      06400011
064100              CONTINUE                                            06410011
064200                                                                  06420011
064300         WHEN SQLCODE = +100                                      06430011
064400              SET OUT-OF-INVOICES TO TRUE                         06440011
064500                                                                  06450011
064600         WHEN SQLWARN0 NOT = SPACES                               06460011
064700         WHEN SQLCODE  NOT = ZERO                                 06470011
064800             MOVE 'R200-FETCH-INVOICES'    TO AA-PARAGRAPH-NAME   06480011
064900             MOVE 'UNSUCCESSFUL FETCH WITH INVOICES_CSR'          06490011
065000                                           TO AA-DB2-OPERATION    06500011
065100             MOVE 'TINVOIC'                TO AA-DB2-TABLE-1      06510011
065200             MOVE 'TMDINVC'                TO AA-DB2-TABLE-2      06520011
065300             MOVE SPACES                   TO AA-DB2-TABLE-3      06530011
065400             PERFORM Z998-DB2-ABEND                               06540011
065500     END-EVALUATE.                                                06550011
065600                                                                  06560011
065700*----------------------------------------------------------------*06570011
065800*  RETRIEVES THE ALLOWANCE DATA FOR THE PO/INVOIC BEING PROCESSED.06580011
065900*----------------------------------------------------------------*06590011
066000 R300-FETCH-ALLOWANCES.                                           06600011
066100                                                                  06610011
066200     EXEC SQL                                                     06620011
066300         FETCH ALLOWANCE_CSR                                      06630011
066400         INTO :ALCHRG-ALW-CHRG-CDE                                06640011
066500             ,:ALCHRG-ALW-CHRG-PCT                                06650011
066600             ,:ALCHRG-ALW-CHRG-AMT                                06660011
066700     END-EXEC.                                                    06670011
066800                                                                  06680011
066900     EVALUATE TRUE                                                06690011
067000         WHEN SQLCODE = ZERO                                      06700011
067100              CONTINUE                                            06710011
067200                                                                  06720011
067300         WHEN SQLCODE = +100                                      06730011
067400              SET OUT-OF-ALLOWANCES TO TRUE                       06740011
067500                                                                  06750011
067600         WHEN SQLWARN0 NOT = SPACES                               06760011
067700         WHEN SQLCODE  NOT = ZERO                                 06770011
067800             MOVE 'R300-FETCH-ALLOWANCES'  TO AA-PARAGRAPH-NAME   06780011
067900             MOVE 'UNSUCCESSFUL FETCH WITH ALLOWANCES_CSR'        06790011
068000                                           TO AA-DB2-OPERATION    06800011
068100             MOVE 'TALCHRG'                TO AA-DB2-TABLE-1      06810011
068200             PERFORM Z998-DB2-ABEND                               06820011
068300     END-EVALUATE.                                                06830011
068400                                                                  06840011
068500*----------------------------------------------------------------*06850011
068600*  SELECT THE BEGIN AND END DATES FOR THE CURRENT FISCAL MONTH.   06860011
068700*----------------------------------------------------------------*06870011
068800 S100-SELECT-PROCESS-DATES.                                       06880011
068900                                                                  06890011
069000     IF  CC-TODAYS-BATCH                                          06900011
069100         EXEC SQL                                                 06910011
069200             SELECT A.BTCH_PRC_DTE                                06920011
069300                  , B.FSCL_MN_BEG_DTE                             06930011
069400                  , B.FSCL_MN_END_DTE                             06940011
069500               INTO :APCNTL-BTCH-PRC-DTE                          06950011
069600                  , :DTATTR-FSCL-MN-BEG-DTE                       06960011
069700                  , :DTATTR-FSCL-MN-END-DTE                       06970011
069800               FROM TAPCNTL  A                                    06980011
069900                  , TDTATTR  B                                    06990011
070000              WHERE A.BTCH_PRC_DTE  =  B.KY_DTE                   07000011
070100         END-EXEC                                                 07010011
070200                                                                  07020011
070300     ELSE                                                         07030011
070400         MOVE CC-RQST-BATCH-DTE TO APCNTL-BTCH-PRC-DTE            07040011
070500                                                                  07050011
070600         EXEC SQL                                                 07060011
070700             SELECT B.FSCL_MN_BEG_DTE                             07070011
070800                  , B.FSCL_MN_END_DTE                             07080011
070900               INTO                                               07090011
071000                    :DTATTR-FSCL-MN-BEG-DTE                       07100011
071100                  , :DTATTR-FSCL-MN-END-DTE                       07110011
071200               FROM                                               07120011
071300                    TDTATTR  B                                    07130011
071400              WHERE B.KY_DTE = :APCNTL-BTCH-PRC-DTE               07140011
071500         END-EXEC                                                 07150011
071600     END-IF.                                                      07160011
071700                                                                  07170011
071800     EVALUATE TRUE                                                07180011
071900         WHEN SQLCODE = ZERO                                      07190011
072000            DISPLAY 'BATCH DATE BEING USED = ' APCNTL-BTCH-PRC-DTE07200011
072100                                                                  07210011
072200         WHEN SQLWARN0 NOT = SPACES                               07220011
072300         WHEN SQLCODE NOT  = ZERO                                 07230011
072400            MOVE 'S100-SELECT-PROCESS-DATES'                      07240011
072500                                TO AA-PARAGRAPH-NAME              07250011
072600            MOVE 'UNSUCCESSFUL SELECT OF DATES'                   07260011
072700                                TO AA-DB2-OPERATION               07270011
072800            MOVE 'TAPCNTL'      TO AA-DB2-TABLE-1                 07280011
072900            MOVE 'TDTATRR'      TO AA-DB2-TABLE-2                 07290011
073000            PERFORM Z998-DB2-ABEND                                07300011
073100     END-EVALUATE.                                                07310011
073200                                                                  07320011
073300*----------------------------------------------------------------*07330011
073400*  SELECT THE ENT ID AND DEPT NUMBER FROM TPURCHS.                07340011
073500*----------------------------------------------------------------*07350011
073600 S200-SELECT-PO-INFO.                                             07360011
073700                                                                  07370011
073800     EXEC SQL                                                     07380011
073900         SELECT ENT_ID                                            07390011
074000              , DEPT_NBR                                          07400011
074100              , PO_TYP_CDE                                        07410011
074200           INTO :PURCHS-ENT-ID                                    07420011
074300              , :PURCHS-DEPT-NBR                                  07430011
074400              , :PURCHS-PO-TYP-CDE                                07440011
074500           FROM TPURCHS                                           07450011
074600          WHERE PO_NBR = :SAVE-PO-NBR                             07460011
074700            AND VER_STATUS_CDE = 'A'                              07470011
074800     END-EXEC.                                                    07480011
074900                                                                  07490011
075000     EVALUATE TRUE                                                07500011
075100         WHEN SQLCODE = ZERO                                      07510011
075200            MOVE PURCHS-PO-TYP-CDE TO PV-PO-TYP-CDE               07520011
075300                                                                  07530011
075400         WHEN SQLWARN0 = SPACES                                   07540011
075500         WHEN SQLCODE NOT = ZERO                                  07550011
075600            MOVE 'S200-SELECT-PO-INFO        '                    07560011
075700                                TO AA-PARAGRAPH-NAME              07570011
075800            MOVE 'UNSUCCESSFUL SELECT FOR PO DATA   '             07580011
075900                                TO AA-DB2-OPERATION               07590011
076000            MOVE 'TPURCHS'      TO AA-DB2-TABLE-1                 07600011
076100            PERFORM Z998-DB2-ABEND                                07610011
076200                                                                  07620011
076300     END-EVALUATE.                                                07630011
076400                                                                  07640011
076500*----------------------------------------------------------------*07650011
076600*  SELECT THE ALW AGREEMENT INFO FROM TVNDAGR.                    07660011
076700*----------------------------------------------------------------*07670011
076800 S300-SELECT-ALW-AGREEMENT.                                       07680011
076900                                                                  07690011
077000     EXEC SQL                                                     07700011
077100         SELECT EFFECTIVE_DATE                                    07710011
077200              , DISCOUNT_PCT                                      07720011
077300           INTO :VNDAGR-EFFECTIVE-DATE                            07730011
077400              , :VNDAGR-DISCOUNT-PCT                              07740011
077500           FROM TVNDAGR                                           07750011
077600          WHERE ENT_ID = :PURCHS-ENT-ID                           07760011
077700            AND DEPT_NBR = :PURCHS-DEPT-NBR                       07770011
077800            AND AGRMT_TYP_ID = '5'                                07780011
077900            AND TYP_CDE      = 11                                 07790011
078000            AND EFFECTIVE_DATE BETWEEN :DTATTR-FSCL-MN-BEG-DTE    07800011
078100                                   AND :DTATTR-FSCL-MN-END-DTE    07810011
078200            AND EXPIRATION_DATE = '9999-12-31'                    07820011
078300     END-EXEC.                                                    07830011
078400                                                                  07840011
078500     EVALUATE TRUE                                                07850011
078600         WHEN SQLCODE = ZERO                                      07860011
078700            SET EFFECTIVE-AGREEMENT-FOUND TO TRUE                 07870011
078800                                                                  07880011
078900         WHEN SQLCODE = +100                                      07890011
079000            SET NO-EFFECTIVE-AGREEMENT-FOUND TO TRUE              07900011
079100                                                                  07910011
079200         WHEN SQLWARN0 = SPACES                                   07920011
079300         WHEN SQLCODE NOT = ZERO                                  07930011
079400            MOVE 'S300-SELECT-ALW-AGREEMENT  '                    07940011
079500                                TO AA-PARAGRAPH-NAME              07950011
079600            MOVE 'UNSUCCESSFUL SELECT FOR VENDOR AGREEMENT'       07960011
079700                                TO AA-DB2-OPERATION               07970011
079800            MOVE 'TVNDAGR'      TO AA-DB2-TABLE-1                 07980011
079900            PERFORM Z998-DB2-ABEND                                07990011
080000                                                                  08000011
080100     END-EVALUATE.                                                08010011
080200                                                                  08020011
080300                                                                  08030011
080400*----------------------------------------------------------------*08040011
080500*  SELECT THE VENDOR NAME FOR THE PO BEING PROCESSED.             08050011
080600*----------------------------------------------------------------*08060011
080700 S400-SELECT-VENDOR-NAME.                                         08070011
080800                                                                  08080011
080900     EXEC SQL                                                     08090011
081000         SELECT A.ENT_NAME_DESC                                   08100011
081100              , B.DUN_NBR                                         08110011
081200           INTO :ENTNME-ENT-NAME-DESC                             08120011
081300              , :EXTENT-DUN-NBR                                   08130011
081400           FROM TENTNME A                                         08140011
081500              , TEXTENT B                                         08150011
081600          WHERE A.ENT_ID   = :PURCHS-ENT-ID                       08160011
081700            AND A.ENT_ID   = B.ENT_ID                             08170011
081800            AND A.TYPE_CDE = '01'                                 08180011
081900     END-EXEC.                                                    08190011
082000                                                                  08200011
082100     EVALUATE TRUE                                                08210011
082200         WHEN SQLCODE = ZERO                                      08220011
082300            CONTINUE                                              08230011
082400                                                                  08240011
082500         WHEN SQLWARN0 = SPACES                                   08250011
082600         WHEN SQLCODE NOT = ZERO                                  08260011
082700            MOVE 'S400-SELECT-VENDOR-NAME    '                    08270011
082800                                TO AA-PARAGRAPH-NAME              08280011
082900            MOVE 'UNSUCCESSFUL SELECT FOR VENDOR NAME   '         08290011
083000                                TO AA-DB2-OPERATION               08300011
083100            MOVE 'TENTNME'      TO AA-DB2-TABLE-1                 08310011
083200            MOVE 'TEXTENT'      TO AA-DB2-TABLE-2                 08320011
083300            PERFORM Z998-DB2-ABEND                                08330011
083400                                                                  08340011
083500     END-EVALUATE.                                                08350011
083600                                                                  08360011
083700*----------------------------------------------------------------*08370011
083800*  SELECT THE ALW ALLOWANCE FOR THE INVOICE BEING PROCESSED.      08380011
083900*----------------------------------------------------------------*08390011
084000 S500-SELECT-ALW-ALLOWANCE.                                       08400011
084100                                                                  08410011
084200     EXEC SQL                                                     08420011
084300        SELECT '1'                                                08430011
084400          INTO  :PV-ONE                                           08440011
084500          FROM SYSIBM.SYSDUMMY1 X                                 08450011
084600         WHERE EXISTS                                             08460011
084700              (SELECT 1                                           08470011
084800                 FROM TALCHRG A                                   08480011
084900                WHERE A.PO_NBR     = :SAVE-PO-NBR                 08490011
085000                  AND A.INVC_ID    = :INVOIC-INVC-ID              08500011
085100                  AND A.ALW_CHRG_CDE = 'ALW'                      08510011
085200                  AND X.IBMREQD = X.IBMREQD)                      08520011
085300     END-EXEC.                                                    08530011
085400                                                                  08540011
085500     EVALUATE TRUE                                                08550011
085600         WHEN SQLCODE = ZERO                                      08560011
085700            SET ALW-ALLOWANCE-FOUND TO TRUE                       08570011
085800         WHEN SQLCODE = +100                                      08580011
085900            SET NO-ALW-ALLOWANCE-FOUND TO TRUE                    08590011
086000                                                                  08600011
086100         WHEN SQLWARN0 = SPACES                                   08610011
086200         WHEN SQLCODE NOT = ZERO                                  08620011
086300            MOVE 'S500-SELECT-ALW-ALLOWANCE  '                    08630011
086400                                TO AA-PARAGRAPH-NAME              08640011
086500            MOVE 'UNSUCCESSFUL EXISTENCE CHECK FOR ALW  '         08650011
086600                                TO AA-DB2-OPERATION               08660011
086700            MOVE 'TALCHRG'      TO AA-DB2-TABLE-1                 08670011
086800            PERFORM Z998-DB2-ABEND                                08680011
086900                                                                  08690011
087000     END-EVALUATE.                                                08700011
087100                                                                  08710011
087200*----------------------------------------------------------------*08720011
087300*  OPENS THE INVOICE CURSOR.                                      08730011
087400*----------------------------------------------------------------*08740011
087500 Y100-OPEN-INVOICE-CSR.                                           08750011
087600                                                                  08760011
087700     EXEC SQL                                                     08770011
087800         OPEN INVOICE_CSR                                         08780011
087900     END-EXEC.                                                    08790011
088000                                                                  08800011
088100     EVALUATE TRUE                                                08810011
088200         WHEN SQLCODE = ZERO                                      08820011
088300              CONTINUE                                            08830011
088400                                                                  08840011
088500         WHEN SQLWARN0 NOT = SPACES                               08850011
088600         WHEN SQLCODE  NOT = ZERO                                 08860011
088700             MOVE 'Y100-OPEN-INVOICE-CSR' TO AA-PARAGRAPH-NAME    08870011
088800             MOVE 'UNSUCCESSFUL OPEN ON INVOICE_CSR'              08880011
088900                                           TO AA-DB2-OPERATION    08890011
089000             MOVE 'TINVOIC'      TO AA-DB2-TABLE-1                08900011
089100             PERFORM Z998-DB2-ABEND                               08910011
089200     END-EVALUATE.                                                08920011
089300                                                                  08930011
089400*----------------------------------------------------------------*08940011
089500*  CLOSES THE INVOICE CURSOR.                                     08950011
089600*----------------------------------------------------------------*08960011
089700 Y200-CLOSE-INVOICE-CSR.                                          08970011
089800                                                                  08980011
089900       EXEC SQL                                                   08990011
090000           CLOSE INVOICE_CSR                                      09000011
090100       END-EXEC.                                                  09010011
090200                                                                  09020011
090300       EVALUATE TRUE                                              09030011
090400           WHEN SQLCODE = ZERO                                    09040011
090500                CONTINUE                                          09050011
090600                                                                  09060011
090700           WHEN SQLWARN0 NOT = SPACES                             09070011
090800           WHEN SQLCODE  NOT = ZERO                               09080011
090900               MOVE 'Y200-CLOSE-INVOICE-CSR'                      09090011
091000                                         TO AA-PARAGRAPH-NAME     09100011
091100               MOVE 'UNSUCCESSFUL CLOSE ON INVOICE_CSR'           09110011
091200                                         TO AA-DB2-OPERATION      09120011
091300               MOVE 'TINVOIC'      TO AA-DB2-TABLE-1              09130011
091400               PERFORM Z998-DB2-ABEND                             09140011
091500       END-EVALUATE.                                              09150011
091600                                                                  09160011
091700*----------------------------------------------------------------*09170011
091800*  OPENS THE ALLOWANCE CURSOR.                                    09180011
091900*----------------------------------------------------------------*09190011
092000 Y300-OPEN-ALLOWANCE-CSR.                                         09200011
092100                                                                  09210011
092200     EXEC SQL                                                     09220011
092300         OPEN ALLOWANCE_CSR                                       09230011
092400     END-EXEC.                                                    09240011
092500                                                                  09250011
092600     EVALUATE TRUE                                                09260011
092700         WHEN SQLCODE = ZERO                                      09270011
092800              CONTINUE                                            09280011
092900                                                                  09290011
093000         WHEN SQLWARN0 NOT = SPACES                               09300011
093100         WHEN SQLCODE  NOT = ZERO                                 09310011
093200             MOVE 'Y300-OPEN-ALLOWANCE-CSR' TO AA-PARAGRAPH-NAME  09320011
093300             MOVE 'UNSUCCESSFUL OPEN ON ALLOWANCE_CSR'            09330011
093400                                           TO AA-DB2-OPERATION    09340011
093500             MOVE 'TALCHRG'      TO AA-DB2-TABLE-1                09350011
093600             PERFORM Z998-DB2-ABEND                               09360011
093700     END-EVALUATE.                                                09370011
093800                                                                  09380011
093900*----------------------------------------------------------------*09390011
094000*  CLOSES THE ALLOWANCE CURSOR.                                   09400011
094100*----------------------------------------------------------------*09410011
094200 Y400-CLOSE-ALLOWANCE-CSR.                                        09420011
094300                                                                  09430011
094400       EXEC SQL                                                   09440011
094500           CLOSE ALLOWANCE_CSR                                    09450011
094600       END-EXEC.                                                  09460011
094700                                                                  09470011
094800       EVALUATE TRUE                                              09480011
094900           WHEN SQLCODE = ZERO                                    09490011
095000                CONTINUE                                          09500011
095100                                                                  09510011
095200           WHEN SQLWARN0 NOT = SPACES                             09520011
095300           WHEN SQLCODE  NOT = ZERO                               09530011
095400               MOVE 'Y400-CLOSE-ALLOWANCE-CSR'                    09540011
095500                                         TO AA-PARAGRAPH-NAME     09550011
095600               MOVE 'UNSUCCESSFUL CLOSE ON ALLOWANCE_CSR'         09560011
095700                                         TO AA-DB2-OPERATION      09570011
095800               MOVE 'TALCHRG'      TO AA-DB2-TABLE-1              09580011
095900               PERFORM Z998-DB2-ABEND                             09590011
096000       END-EVALUATE.                                              09600011
096100                                                                  09610011
096200*----------------------------------------------------------------*09620011
096300*  WRITE RECORDS TO REPORT FILE.                                  09630011
096400*----------------------------------------------------------------*09640011
096500 W100-WRITE-REPORT-RECORD.                                        09650011
096600                                                                  09660011
096700     WRITE MISSED-REPORT-RECORD FROM AP090-RECORD.                09670011
096800     ADD +1 TO OUTPUT-COUNT.                                      09680011
096900                                                                  09690011
097000*----------------------------------------------------------------*09700011
097100*  ABEND ROUTINE FOR DB2 ERRORS                                   09710011
097200*----------------------------------------------------------------*09720011
097300 Z998-DB2-ABEND.                                                  09730011
097400                                                                  09740011
097500     CLOSE  MATCHED-RECEIPTS-FILE                                 09750011
097600            MISSED-REPORT-FILE.                                   09760011
097700                                                                  09770011
097800     MOVE SAVE-PO-NBR    TO DISPLAY-PO-NBR.                       09780011
097900     DISPLAY 'PO NBR = ' DISPLAY-PO-NBR.                          09790011
098000     DISPLAY AA-ABEND-LIT.                                        09800011
098100     DISPLAY AA-DB2-ERROR-LIT.                                    09810011
098200     DISPLAY AA-PROGRAM-LIT.                                      09820011
098300     DISPLAY AA-PARAGRAPH-LIT.                                    09830011
098400     DISPLAY AA-DB2-OPERATION-LIT.                                09840011
098500     DISPLAY AA-DB2-TABLE-1.                                      09850011
098600     DISPLAY AA-DB2-TABLE-2.                                      09860011
098700     DISPLAY AA-DB2-TABLE-3.                                      09870011
098800     SET AC-DB2-ERROR TO TRUE.                                    09880011
098900                                                                  09890011
099000     COPY DPPD004.                                                09900011
099100                                                                  09910011
099200     CALL 'ILBOABN0' USING ABEND-CODE.                            09920011
099300*---------------------------------------------------------------  09930011
099400*    ABEND ROUTINE                                                09940011
099500*---------------------------------------------------------------  09950011
099600 Z999-ABEND.                                                      09960011
099700                                                                  09970011
099800     CLOSE  MATCHED-RECEIPTS-FILE                                 09980011
099900            MISSED-REPORT-FILE.                                   09990011
100000                                                                  10000011
100100     DISPLAY AA-ABEND-LIT.                                        10010011
100200     DISPLAY AA-PROGRAM-LIT.                                      10020011
100300     DISPLAY AA-PARAGRAPH-LIT.                                    10030011
100400     DISPLAY AA-MESSAGE-LINE.                                     10040011
100500     CALL 'ILBOABN0' USING ABEND-CODE.                            10050011
