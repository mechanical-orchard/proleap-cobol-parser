000200 IDENTIFICATION DIVISION.                                         00020000
000300 PROGRAM-ID.         XSKUT132.                                    00030001
000400 AUTHOR.             MEDHA CHOUDHURY.                             00040000
000500 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00050000
000600 DATE-WRITTEN.       FEB, 2010.                                   00060000
000700 DATE-COMPILED.                                                   00070000
000800******************************************************************00080000
000900* THIS PROGRAM PREPARES THE PRICE CHANGE LOAD FILE TO BE        * 00090000
001000* PROCESSED BY XSKUP132 UNDER THE DB2 CHECKPOINT RESTART SYSTEM. *00100003
001100*                                                                *00110000
001200* THE PROGRAM READS THE INPUT LOAD RECORDS, REFORMATS THE       * 00120000
001300* RECORDS AND SETS A CHECKPOINT INDICATOR ON THE RECORD BASED    *00130000
001400* ON HOW CHECKPOINTS WILL BE TAKEN BY THE MAINTENANCE PROGRAM.   *00140000
001500* AFTER A RECORD HAS BEEN REFORMATTED IT IS PASSED TO THE        *00150000
001600* TRANSACTION PREPARATION MODULE (DPKUT900) WHICH DOES SOME MORE *00160000
001700* PROCESSING ON THE RECORDS AND WRITES THE REFORMATTED RECORDS   *00170000
001800* OUT TO A SEQUENTIAL FILE.                                      *00180000
001900*                                                                *00190000
002000* THE PROGRAM COMMUNICATES WITH THE TRANSACTION PREPARATION      *00200000
002100* MODULE USING FUNCTION CODES (OPEN, WRITE, & CLOSE) AND CHECKS  *00210000
002200* THE RETURN CODE AFTER EACH REQUEST.  IF AN INVALID RETURN CODE *00220000
002300* IS RECEIVED, ANY INFORMATION THAT MAY BE HELPFUL IN RESOLVING  *00230000
002400* THE BAD RETURN CODE IS DISPLAYED AND THE PROGRAM ABENDS.       *00240000
002500******************************************************************00250000
260107*    JIM HUNTER 08-19-21     ADD COPYBOOK DPWS990 TO MAKE        *00251011
260107*    CHG0260107              DPKUT900 CALL DYNAMIC.              *00252011
002500******************************************************************00253011
002600 ENVIRONMENT DIVISION.                                            00260000
002700 CONFIGURATION SECTION.                                           00270000
002800 SOURCE-COMPUTER.    IBM-3090.                                    00280000
002900 OBJECT-COMPUTER.    IBM-3090.                                    00290000
003000                                                                  00300000
003100 INPUT-OUTPUT SECTION.                                            00310000
003200 FILE-CONTROL.                                                    00320000
003300     SELECT HISTORY-LOAD-EXTRACT ASSIGN TO INP01.                 00330003
003400******************************************************************00340000
003500 DATA DIVISION.                                                   00350000
003600 FILE SECTION.                                                    00360000
003700                                                                  00370000
003800 FD  HISTORY-LOAD-EXTRACT                                         00380003
003900     RECORDING MODE IS F                                          00390000
004000     BLOCK CONTAINS 0 RECORDS                                     00400000
004100     LABEL RECORDS ARE OMITTED.                                   00410000
004200                                                                  00420000
004300 01  LOAD-EXTRACT-RECORD   PIC  X(169).                           00430010
004400******************************************************************00440000
004500 WORKING-STORAGE SECTION.                                         00450000
004600 01  ABEND-CODE                       PIC S9(04) VALUE +0  COMP.  00460000
004700                                                                  00470000
004800 01  PROGRAM-CONSTANTS.                                           00480000
004900     05  PC-PROGRAM-NAME              PIC X(08)  VALUE 'XSKUT132'.00490003
005000     05  PC-TRAN-PREP-FUNC-CODES.                                 00500000
005100         10  PC-TRAN-PREP-FUNC-OPEN   PIC X(05)  VALUE 'OPEN '.   00510000
005200         10  PC-TRAN-PREP-FUNC-WRITE  PIC X(05)  VALUE 'WRITE'.   00520000
005300         10  PC-TRAN-PREP-FUNC-CLOSE  PIC X(05)  VALUE 'CLOSE'.   00530000
005400     05  PC-JOB-NAME                  PIC X(08)  VALUE 'XSK125  '.00540003
005500     05  PC-PLAN-NAME                 PIC X(08)  VALUE 'XSKUP132'.00550002
005600     05  PC-TRANS-RECORD-LENGTH       PIC S9(04) VALUE +169 COMP. 00560009
005700                                                                  00570000
005800******************************************************************00580000
005810* FOR THIS PROGRAM IT WILL ALWAYS BE T (TIME INTERVAL)         ***00581003
005820******************************************************************00582003
005900 01  PROGRAM-VARIABLES.                                           00590000
006000     05  PV-CHECKPOINT-TYPE           PIC X(01)  VALUE SPACE.     00600000
006100         88  CONTROL-BREAK                       VALUE 'C'.       00610000
006200         88  LOGICAL-TRANSACTION                 VALUE 'L'.       00620000
006300         88  TIME-INTERVAL                       VALUE 'T'.       00630000
006400         88  REQUESTED-BY-PROGRAM                VALUE 'R'.       00640000
006500     05  PV-HOLD-PRCHG-ID             PIC 9(10)  VALUE ZERO.      00650004
006510     05  PV-HOLD-STR-GP-TYP-CD        PIC 9(04)  VALUE ZERO.      00651004
006520     05  PV-HOLD-STR-GP-ID            PIC 9(04)  VALUE ZERO.      00652004
006600                                                                  00660000
006700******************************************************************00670000
006800 01  PROGRAM-ACCUMULATORS.                                        00680000
006900     05  PA-INPUT-RECORDS-READ        PIC S9(11) VALUE 0  COMP-3. 00690000
007000                                                                  00700000
007100     05  PA-OUTPUT-RECS-WRITTEN       PIC S9(11) VALUE 0  COMP-3. 00710000
007200                                                                  00720000
007300******************************************************************00730000
007400 01  PROGRAM-SWITCHES.                                            00740000
007500     05  PS-INPUT-UPDATE-EOF-SW       PIC X(01)  VALUE 'N'.       00750000
007600         88  PS-INPUT-UPDATE-EOF                 VALUE 'Y'.       00760000
007700     05  PS-FIRST-TRANS-READ-SW       PIC X(01)  VALUE 'Y'.       00770000
007800         88  FIRST-TRANS-READ                    VALUE 'Y'.       00780000
007900                                                                  00790000
008000******************************************************************00800000
008100*  INPUT FILE LAYOUT                                              00810000
008200******************************************************************00820000
008300     COPY XSRD147.                                                00830003
008400                                                                  00840000
008500******************************************************************00850000
008600*  TRANSACTION PREPARATION MODULE LINKAGE SECTION                *00860000
008700******************************************************************00870000
260107     COPY DPWS990.                                                00880011
008800                                                                  00881011
008800     COPY DPLS000.                                                00882011
008900                                                                  00890000
009000******************************************************************00900000
009100*  SQL COMMUNICATIONS WORK AREA                                  *00910000
009200******************************************************************00920000
009300     COPY SQLCA2.                                                 00930000
009400                                                                  00940000
009500******************************************************************00950000
009600 PROCEDURE DIVISION.                                              00960000
009700******************************************************************00970000
009800* A100-MAINLINE-PROCESSING                                        00980000
009900*    CONTROLS FLOW OF THE PROGRAM                                *00990000
010000******************************************************************01000000
010100 A100-MAINLINE-PROCESSING.                                        01010000
010200                                                                  01020000
010300     PERFORM 1000-INITIALIZE.                                     01030000
010400                                                                  01040000
010500     PERFORM 2000-PROCESS-UPDATE-INPUT-FILE                       01050000
010600         UNTIL PS-INPUT-UPDATE-EOF.                               01060000
010700                                                                  01070000
010800     PERFORM 3000-END-OF-JOB-ROUTINE.                             01080000
010900                                                                  01090000
011000     GOBACK.                                                      01100000
011100******************************************************************01110000
011200*  INITIALIZE                                                     01120000
011300******************************************************************01130000
011400 1000-INITIALIZE.                                                 01140000
011500                                                                  01150000
011510     DISPLAY '********************************************'.      01151007
011520     DISPLAY '*   START OF PROGRAM XSKUT132              *'.      01152008
011530     DISPLAY '********************************************'.      01153007
011540                                                                  01154007
011600     PERFORM C100-ISSUE-OPEN-REQUEST.                             01160000
011700                                                                  01170000
011800     OPEN INPUT HISTORY-LOAD-EXTRACT.                             01180005
011900                                                                  01190000
012000     PERFORM C200-READ-UPDATE-INPUT-FILE.                         01200000
012100     IF PS-INPUT-UPDATE-EOF                                       01210000
012200         DISPLAY ' '                                              01220000
012300         DISPLAY 'MESSAGES FOR PROGRAM ' PC-PROGRAM-NAME          01230000
012400         DISPLAY 'UPDATE INPUT FILE IS EMPTY'                     01240000
012500         DISPLAY ' '                                              01250000
012600     END-IF.                                                      01260000
012700                                                                  01270000
012800******************************************************************01280000
012900* 2000-PROCESS-UPDATE-INPUT-FILE.                                *01290000
013000*     READ AN UPDATE INPUT RECORD.                               *01300000
013100*     IF END-OF-FILE, STOP PROCESSING.                           *01310000
013200*     IF A RECORD IS READ, GATHER WHATEVER OTHER DATA            *01320000
013300*     IS NECESSARY TO TAKE CHECKPOINTS BASED ON THE TYPE OF      *01330000
013400*     CHECKPOINTS BEING TAKEN BY XSKUP132 AND ISSUE A WRITE      *01340002
013500*     REQUEST TO THE TRANSACTION PREPARATION PROGRAM.            *01350000
013510*     PLEASE NOTE: XSKUP132 WILL BE TAKING TIME INTERVAL AS      *01351002
013520*     THE CHECKPOINT TYPE  (WILL ALWAYS EXECUTE PARA C500-)      *01352002
013600******************************************************************01360000
013700 2000-PROCESS-UPDATE-INPUT-FILE.                                  01370000
013800                                                                  01380000
013900     IF FIRST-TRANS-READ                                          01390000
014000         MOVE 'N'                 TO PS-FIRST-TRANS-READ-SW       01400000
014100     END-IF.                                                      01410000
014200                                                                  01420000
014300     IF CONTROL-BREAK                                             01430000
014400         PERFORM C300-CKPT-BY-CNTL-BREAK                          01440000
014500     ELSE                                                         01450000
014600         IF LOGICAL-TRANSACTION                                   01460000
014700             PERFORM C400-CKPT-BY-LOGICAL-TRANS                   01470000
014800         ELSE                                                     01480000
014900             PERFORM C500-CKPT-BY-TIME-OR-REQUEST                 01490000
015000         END-IF                                                   01500000
015100     END-IF.                                                      01510000
015200                                                                  01520000
015300     PERFORM C200-READ-UPDATE-INPUT-FILE.                         01530000
015400                                                                  01540000
015500******************************************************************01550000
015600* 3000-END-OF-JOB-ROUTINE                                        *01560000
015700******************************************************************01570000
015800 3000-END-OF-JOB-ROUTINE.                                         01580000
015900                                                                  01590000
016000     CLOSE HISTORY-LOAD-EXTRACT.                                  01600006
016100                                                                  01610000
016200     DISPLAY ' '.                                                 01620000
016300     DISPLAY 'MESSAGES FOR PROGRAM ' PC-PROGRAM-NAME.             01630000
016400     DISPLAY 'NUMBER OF INPUT RECORDS READ:          '            01640000
016500             PA-INPUT-RECORDS-READ.                               01650000
016600     DISPLAY 'NUMBER OF TRANS/PREP RECORDS WRITTEN:  '            01660000
016700             PA-OUTPUT-RECS-WRITTEN.                              01670000
016800     DISPLAY ' '.                                                 01680000
016900                                                                  01690000
017000     PERFORM C600-ISSUE-CLOSE-REQUEST.                            01700000
017100                                                                  01710000
017200******************************************************************01720000
017300* C100-ISSUE-OPEN-REQUEST                                        *01730000
017400*     ISSUE AN 'OPEN' REQUEST TO THE TRANSACTION PREPARATION     *01740000
017500*     MODULE.                                                    *01750000
017600******************************************************************01760000
017700 C100-ISSUE-OPEN-REQUEST.                                         01770000
017800                                                                  01780000
017900     MOVE PC-TRAN-PREP-FUNC-OPEN TO DP000-FUNC-CODE.              01790000
018000     MOVE PC-JOB-NAME            TO DP000-JOB-NAME.               01800000
018100     MOVE PC-PLAN-NAME           TO DP000-PLAN-NAME.              01810000
018200                                                                  01820000
018300     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         01830000
018400                                                                  01840000
018500     MOVE DP000-CKPT-TYPE-CODE   TO PV-CHECKPOINT-TYPE.           01850000
018600                                                                  01860000
018700******************************************************************01870000
018800* C200-READ-UPDATE-INPUT-FILE                                    *01880000
018900******************************************************************01890000
019000 C200-READ-UPDATE-INPUT-FILE.                                     01900000
019100                                                                  01910000
019200     READ HISTORY-LOAD-EXTRACT                                    01920003
019300          INTO XS147-PERM-EXTRACT                                 01930003
019400         AT END                                                   01940000
019500             SET PS-INPUT-UPDATE-EOF TO TRUE.                     01950000
019600                                                                  01960000
019700     IF PS-INPUT-UPDATE-EOF                                       01970000
019800         CONTINUE                                                 01980000
019900     ELSE                                                         01990000
020000         ADD +1 TO PA-INPUT-RECORDS-READ                          02000000
020100     END-IF.                                                      02010000
020200                                                                  02020000
020300******************************************************************02030000
020400* C300-CKPT-BY-CNTL-BREAK                                        *02040000
020500*     THIS ROUTINE SETS THE CHECKPOINT INDICATOR ON THE TRANSAC- *02050000
020600*     TION RECORD "ON" IF THERE IS A CHANGE IN THE STORE         *02060000
020700*     NUMBER.  AFTER THE TRANSACTION RECORD HAS BEEN FORMATTED,  *02070000
020800*     A WRITE REQUEST IS ISSUED TO THE TRANSACTION PREPARATION   *02080000
020900*     MODULE.                                                    *02090000
021000* NOTE: AT THIS TIME CONTROL/LOGIC BREAK PROCESSING IS IDENTICAL.*02100000
021100******************************************************************02110000
021200 C300-CKPT-BY-CNTL-BREAK.                                         02120000
021300                                                                  02130000
021400     IF XS147-PRCHG-ID-KEY = PV-HOLD-PRCHG-ID                     02140004
021500         MOVE 'N' TO DP000-CHECKPOINT-IND                         02150000
021600     ELSE                                                         02160000
021700         MOVE 'Y' TO DP000-CHECKPOINT-IND                         02170000
021800         MOVE XS147-PRCHG-ID-KEY TO PV-HOLD-PRCHG-ID              02180005
021900     END-IF.                                                      02190000
022000                                                                  02200000
022100     MOVE PC-TRANS-RECORD-LENGTH   TO DP000-TRANS-REC-LENGTH.     02210000
022200     MOVE XS147-PERM-EXTRACT       TO DP000-TRANS-REC.            02220004
022300     MOVE PC-TRAN-PREP-FUNC-WRITE  TO DP000-FUNC-CODE.            02230000
022400     MOVE PC-JOB-NAME              TO DP000-JOB-NAME.             02240000
022500     MOVE PC-PLAN-NAME             TO DP000-PLAN-NAME.            02250000
022600                                                                  02260000
022700     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02270000
022800     ADD +1 TO PA-OUTPUT-RECS-WRITTEN.                            02280000
022900                                                                  02290000
023000******************************************************************02300000
023100* C400-CKPT-BY-LOGICAL-TRANS.                                    *02310000
023200*     THIS ROUTINE SETS THE CHECKPOINT INDICATOR ON THE TRANSAC- *02320000
023300*     TION RECORD "ON".  THE UPDATE PROGRAM WILL CHECK THE       *02330000
023400*     CHECKPOINT FREQUENCY TO KNOW WHETHER A CHECKPOINT SHOULD BE*02340000
023500*     TAKEN.   AFTER THE TRANSACTION RECORD HAS BEEN FORMATTED,  *02350000
023600*     A WRITE REQUEST IS ISSUED TO THE TRANSACTION PREPARATION   *02360000
023700*     MODULE.                                                    *02370000
023800******************************************************************02380000
023900 C400-CKPT-BY-LOGICAL-TRANS.                                      02390000
024000                                                                  02400000
024100     MOVE 'Y'                      TO DP000-CHECKPOINT-IND.       02410000
024200     MOVE PC-TRANS-RECORD-LENGTH   TO DP000-TRANS-REC-LENGTH.     02420000
024300     MOVE XS147-PERM-EXTRACT       TO DP000-TRANS-REC.            02430004
024400     MOVE PC-TRAN-PREP-FUNC-WRITE  TO DP000-FUNC-CODE.            02440000
024500     MOVE PC-JOB-NAME              TO DP000-JOB-NAME.             02450000
024600     MOVE PC-PLAN-NAME             TO DP000-PLAN-NAME.            02460000
024700                                                                  02470000
024800     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02480000
024900     ADD +1 TO PA-OUTPUT-RECS-WRITTEN.                            02490000
025000                                                                  02500000
025100******************************************************************02510000
025200* C500-CKPT-BY-TIME-OR-REQUEST.                                  *02520000
025300*     THIS ROUTINE BUILDS THE TRANSACTION RECORD AND ISSUES A    *02530000
025400*     WRITE REQUEST TO THE TRANSACTION PREPARATION MODULE IF     *02540000
025500*     CHECKPOINTS ARE TAKEN BY TIME INTERVAL (SECONDS) OR        *02550000
025600*     REQUESTED BY THE MAINTENANCE PROGRAM.                      *02560000
025700******************************************************************02570000
025800 C500-CKPT-BY-TIME-OR-REQUEST.                                    02580000
025900                                                                  02590000
026000     MOVE 'N'                        TO DP000-CHECKPOINT-IND.     02600000
026100     MOVE PC-TRANS-RECORD-LENGTH     TO DP000-TRANS-REC-LENGTH.   02610000
026200     MOVE XS147-PERM-EXTRACT         TO DP000-TRANS-REC.          02620004
026300     MOVE PC-TRAN-PREP-FUNC-WRITE    TO DP000-FUNC-CODE.          02630000
026400     MOVE PC-JOB-NAME                TO DP000-JOB-NAME.           02640000
026500     MOVE PC-PLAN-NAME               TO DP000-PLAN-NAME.          02650000
026600                                                                  02660000
026700     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02670000
026800     ADD +1 TO PA-OUTPUT-RECS-WRITTEN.                            02680000
026900                                                                  02690000
027000******************************************************************02700000
027100* C600-ISSUE-CLOSE-REQUEST                                       *02710000
027200*     ISSUE A 'CLOSE' REQUEST TO THE TRANSACTION PREPARATION     *02720000
027300*     MODULE.                                                    *02730000
027400******************************************************************02740000
027500 C600-ISSUE-CLOSE-REQUEST.                                        02750000
027600                                                                  02760000
027700     MOVE PC-TRAN-PREP-FUNC-CLOSE TO DP000-FUNC-CODE.             02770000
027800     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              02780000
027900     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             02790000
028000                                                                  02800000
028100     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02810000
028200                                                                  02820000
028300******************************************************************02830000
028400*  TRANSACTION PREPARATION MODULE CALL AND ERROR ROUTINES        *02840000
028500******************************************************************02850000
028600     COPY DPPD000.                                                02860000
