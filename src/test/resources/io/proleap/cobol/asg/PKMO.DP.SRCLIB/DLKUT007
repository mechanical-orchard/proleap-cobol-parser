000100 TITLE 'EXTRACT BUSINESS EVENT DATA'.                             00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300 PROGRAM-ID.    DLKUT007.                                         00030001
000400 AUTHOR.        BUDDY BARNES.                                     00040003
000500 DATE-WRITTEN.  JUNE 2004.                                        00050003
000600******************************************************************00060000
000700***************************************************************** 00070000
000800* THIS PROGRAM WILL EXTRACT RECORDS FROM SUT_BUS_EVNT_EXPRT     * 00080005
000900* TABLES AND WRITE THOSE RECORDS TO AN OUTPUT FILE.             * 00090001
001000***************************************************************** 00100000
001100 ENVIRONMENT DIVISION.                                            00110000
001200 INPUT-OUTPUT SECTION.                                            00120000
001300                                                                  00130000
001400 FILE-CONTROL.                                                    00140000
001500     SELECT BUSEV-EXTRACT-FILE     ASSIGN TO OUT01.               00150001
001600                                                                  00160000
001700 DATA DIVISION.                                                   00170000
001800 FILE SECTION.                                                    00180000
001900                                                                  00190000
002000 FD  BUSEV-EXTRACT-FILE                                           00200001
002100     RECORDING MODE IS F                                          00210000
002200     LABEL RECORDS ARE STANDARD                                   00220000
002300     BLOCK CONTAINS 0 RECORDS.                                    00230000
002400                                                                  00240000
002500 01  BUSEV-EXTRACT-RECORD             PIC X(50).                  00250001
002600                                                                  00260000
002700 WORKING-STORAGE SECTION.                                         00270000
002800                                                                  00280000
002900 01  PV-ABEND-CODE                    PIC S9(04)   VALUE ZERO     00290000
003000                                                   COMP SYNC.     00300000
003100                                                                  00310000
003200 01  PS-PROGRAM-SWITCHES.                                         00320000
003300     05  PS-END-CSR-SW                PIC X(1)   VALUE 'N'.       00330000
003400         88  PS-END-CSR                          VALUE 'Y'.       00340000
003500     05  PS-BUSEV-DETAIL-SW           PIC X(1)   VALUE 'N'.       00350001
003600         88  PS-BUSEV-DETAIL-FOUND               VALUE 'Y'.       00360001
003700         88  PS-BUSEV-DETAIL-NOT-FOUND           VALUE 'N'.       00370001
003800                                                                  00380000
004500 01  PA-PROGRAM-ACCUMULATORS.                                     00450000
004600     05  PA-BUSEV-RECS-FETCHED        PIC S9(9)   COMP-3          00460001
004700                                                  VALUE ZEROS.    00470000
004800     05  PA-OUTPUT-RECS-WRITTEN       PIC S9(9)   COMP-3          00480000
004900                                                  VALUE ZEROS.    00490000
005000                                                                  00500000
005100 01  PV-PROGRAM-VARIABLES.                                        00510000
005110     05  PV-EVNT-EXPRT-ID-HOLD        PIC S9(18)  COMP.           00511006
005200     05  PV-RETRY-COUNT               PIC S9(04)  VALUE ZERO      00520000
005300                                                  COMP SYNC.      00530000
005400     05  PV-CNTL-TMST                 PIC X(26)   VALUE SPACES.   00540000
005401     05  PV-CNTL-TMST2                PIC X(26)   VALUE SPACES.   00540107
005410     05  PV-FUNC-QTY2                 PIC S9(9) COMP.             00541007
005500     05  PV-PARAGRAPH-NAME            PIC X(30)   VALUE SPACES.   00550000
005600     05  PV-ERROR-MESSAGE-1           PIC X(60)   VALUE SPACES.   00560000
005700     05  PV-ERROR-MESSAGE-2           PIC X(60)   VALUE SPACES.   00570000
005800     05  PV-SQLCODE                   PIC 9(9)    VALUE ZERO.     00580000
005900     05  PV-DISPLAY-NUMBER            PIC 9999999999.             00590000
006000     05  PV-DISPLAY-COUNT             PIC ZZZ,ZZZ,ZZ9.            00600000
006100                                                                  00610000
006200 01  PC-PROGRAM-CONSTANTS.                                        00620000
006300     05  PC-PROGRAM-NAME              PIC X(08)  VALUE 'DLKUT007'.00630001
006400     05  PC-MAX-RETRIES               PIC S9(04) VALUE +3         00640000
006500                                                 COMP SYNC.       00650000
006600 01  PV-ABEND-FIELDS.                                             00660000
006700     05  PV-ABEND-PROGRAM             PIC X(8)   VALUE 'DLKUT007'.00670001
006800     05  PV-ABEND-PARAGRAPH           PIC X(50)  VALUE SPACES.    00680000
006900     05  PV-ABEND-OPERATION           PIC X(50)  VALUE SPACES.    00690000
007000     05  PV-ABEND-STRUCTURE-1         PIC X(15)  VALUE SPACES.    00700000
007100     05  PV-ABEND-STRUCTURE-2         PIC X(15)  VALUE SPACES.    00710000
007200     05  PV-ABEND-STRUCTURE-3         PIC X(15)  VALUE SPACES.    00720000
007300     05  PV-ABEND-STATUS              PIC XX     VALUE SPACES.    00730000
007400     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    00740000
007500     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    00750000
007600     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    00760000
007700     05  PV-DB2-OPERATION-MESSAGE-4   PIC  X(79) VALUE SPACES.    00770000
007800                                                                  00780000
007900*    DCLGEN FOR PARAMETERS                                        00790000
008000     EXEC SQL                                                     00800000
008100         INCLUDE TKRPRPM                                          00810000
008200     END-EXEC                                                     00820000
008300                                                                  00830000
008400*    DCLGEN FOR SUT_BUS_EVNT_EXPRT                                00840002
008500     EXEC SQL                                                     00850000
008600         INCLUDE SUT00037                                         00860002
008700     END-EXEC                                                     00870000
008800                                                                  00880000
009000     EXEC SQL                                                     00900000
009100         DECLARE BUSEV-CSR CURSOR FOR                             00910002
009200             SELECT EVNT_EXPRT_ID                                 00920002
009500             FROM   SUT_BUS_EVNT_EXPRT                            00950002
009600             WHERE (EXPRT_STAT_CDE = 'P'  AND                     00960008
009700                    CRE_TMST < :PV-CNTL-TMST)                     00970008
009710                OR (CRE_TMST < :PV-CNTL-TMST2)                    00971008
009800         ORDER BY 1 ASC                                           00980000
010000     END-EXEC                                                     01000000
010100/                                                                 01010000
010200*  USED FOR DB2 ERROR MESSAGE BUILDING                            01020000
010300     COPY DPWS004.                                                01030000
010400                                                                  01040000
010410*  USED FOR BUILDING OUTPUT FILE OF BUSEV KEY DATA.               01041001
010420     COPY DLRD007.                                                01042001
010430                                                                  01043000
010500*   DB2 SQL COMMUNICATION AREA                                    01050000
010600     EXEC SQL                                                     01060000
010700          INCLUDE SQLCA                                           01070000
010800     END-EXEC.                                                    01080000
010900*                                                                 01090005
011000 PROCEDURE DIVISION.                                              01100000
011100                                                                  01110000
011200     PERFORM 1000-INIT.                                           01120000
011400     PERFORM 2000-PROCESS UNTIL PS-END-CSR.                       01140000
011600     PERFORM 9000-TERMINATE.                                      01160000
011700                                                                  01170000
011800     STOP RUN.                                                    01180000
011900                                                                  01190000
012000 1000-INIT.                                                       01200000
012200     OPEN OUTPUT BUSEV-EXTRACT-FILE.                              01220001
012210     MOVE ZEROS TO PV-EVNT-EXPRT-ID-HOLD.                         01221006
012300                                                                  01230000
012400     PERFORM 3000-CALC-PURGE-TMST.                                01240000
012410     PERFORM 3010-CALC-PURGE-TMST2.                               01241007
012500     PERFORM 7000-OPEN-BUSEV-CSR.                                 01250001
012600     PERFORM 7010-FETCH-BUSEV-CSR.                                01260001
012700                                                                  01270000
012800 2000-PROCESS.                                                    01280000
013000     PERFORM 8000-WRITE-EXTRACT-REC.                              01300000
013100                                                                  01310000
013200     PERFORM 7010-FETCH-BUSEV-CSR.                                01320001
013300                                                                  01330000
013400 3000-CALC-PURGE-TMST.                                            01340000
013500                                                                  01350000
013600     EXEC SQL                                                     01360000
013700         SELECT FUNC_QTY                                          01370000
013800               ,CHAR((CURRENT TIMESTAMP) - FUNC_QTY DAYS)         01380000
013900           INTO :KRPRPM-FUNC-QTY                                  01390000
014000               ,:PV-CNTL-TMST                                     01400000
014100           FROM TKRPRPM                                           01410000
014200               ,SYSIBM.SYSDUMMY1                                  01420000
014300          WHERE LOC_ID            = 90                            01430000
014400            AND INTFC_SYS_CDE     = 'DLX'                         01440000
014500            AND SYS_PRC_FUNC_CDE  = 'DLBEPG'                      01450002
014600            AND FUNC_PRC_STAT_CDE = 'AC'                          01460000
014700     END-EXEC.                                                    01470000
014800                                                                  01480000
014900     EVALUATE TRUE                                                01490000
015000         WHEN SQLCODE = ZERO                                      01500000
015100             CONTINUE                                             01510000
015200         WHEN SQLCODE = +100                                      01520000
015300         WHEN SQLWARN0 NOT = SPACE                                01530000
015400         WHEN SQLCODE  NOT = ZERO                                 01540000
015500             MOVE '3000-CALC-PURGE-TMST' TO PV-ABEND-PARAGRAPH    01550000
015600             MOVE 'SELECT'               TO PV-ABEND-OPERATION    01560000
015700             MOVE 'CALC PURGE TMST    '  TO PV-ABEND-STRUCTURE-1  01570000
015800             MOVE 'DB2 - TKRPRPM     '   TO PV-ABEND-STRUCTURE-2  01580000
015900             PERFORM 9900-DB2-ABEND                               01590000
016000     END-EVALUATE.                                                01600000
016100                                                                  01610000
016110 3010-CALC-PURGE-TMST2.                                           01611007
016120                                                                  01612007
016130     EXEC SQL                                                     01613007
016140         SELECT FUNC_QTY                                          01614007
016150               ,CHAR((CURRENT TIMESTAMP) - FUNC_QTY DAYS)         01615007
016160           INTO :PV-FUNC-QTY2                                     01616007
016170               ,:PV-CNTL-TMST2                                    01617007
016180           FROM TKRPRPM                                           01618007
016191          WHERE LOC_ID            = 90                            01619107
016192            AND INTFC_SYS_CDE     = 'DLX'                         01619207
016193            AND SYS_PRC_FUNC_CDE  = 'DLBEP2'                      01619307
016194            AND FUNC_PRC_STAT_CDE = 'AC'                          01619407
016195     END-EXEC.                                                    01619507
016196                                                                  01619607
016197     EVALUATE TRUE                                                01619707
016198         WHEN SQLCODE = ZERO                                      01619807
016199             CONTINUE                                             01619907
016200         WHEN SQLCODE = +100                                      01620007
016201         WHEN SQLWARN0 NOT = SPACE                                01620107
016202         WHEN SQLCODE  NOT = ZERO                                 01620207
016203             MOVE '3010-CALC-PURGE-TMST2' TO PV-ABEND-PARAGRAPH   01620307
016204             MOVE 'SELECT'               TO PV-ABEND-OPERATION    01620407
016205             MOVE 'CALC PURGE TMST2   '  TO PV-ABEND-STRUCTURE-1  01620507
016206             MOVE 'DB2 - TKRPRPM     '   TO PV-ABEND-STRUCTURE-2  01620607
016207             PERFORM 9900-DB2-ABEND                               01620707
016208     END-EVALUATE.                                                01620807
016209                                                                  01620907
016210                                                                  01621007
016220 7000-OPEN-BUSEV-CSR.                                             01622007
016300     EXEC SQL                                                     01630000
016400         OPEN BUSEV-CSR                                           01640001
016500     END-EXEC.                                                    01650000
016600                                                                  01660000
016700     EVALUATE TRUE                                                01670000
016800         WHEN SQLCODE = ZERO                                      01680000
016900             CONTINUE                                             01690000
017000         WHEN SQLWARN0 NOT = SPACE                                01700000
017100         WHEN SQLCODE  NOT = ZERO                                 01710000
017200             MOVE '7000-OPEN-BUSEV-CSR'  TO PV-ABEND-PARAGRAPH    01720001
017300             MOVE 'OPEN CURSOR'          TO PV-ABEND-OPERATION    01730000
017400             MOVE 'BUSEV PURGE PROCESS'  TO PV-ABEND-STRUCTURE-1  01740001
017500             MOVE 'DB2 - SUT_BUS_EVNT'   TO PV-ABEND-STRUCTURE-2  01750002
017600             PERFORM 9900-DB2-ABEND                               01760000
017700     END-EVALUATE.                                                01770000
017800                                                                  01780000
017900 7010-FETCH-BUSEV-CSR.                                            01790001
018000     EXEC SQL                                                     01800000
018100         FETCH BUSEV-CSR                                          01810001
018200         INTO                                                     01820000
018300             :SUT00037-EVNT-EXPRT-ID                              01830002
018600     END-EXEC.                                                    01860000
018700                                                                  01870000
018800     EVALUATE TRUE                                                01880000
018900         WHEN SQLCODE = ZERO                                      01890000
019000             ADD 1                    TO PA-BUSEV-RECS-FETCHED    01900001
019600                                                                  01960000
019700         WHEN SQLCODE = +100                                      01970000
019800             SET PS-END-CSR           TO TRUE                     01980000
019900         WHEN SQLWARN0 NOT = SPACE                                01990000
020000         WHEN SQLCODE  NOT = ZERO                                 02000000
020100             MOVE '7010-FETCH-BUSEV-CSR' TO PV-ABEND-PARAGRAPH    02010001
020200             MOVE 'FETCH CURSOR'         TO PV-ABEND-OPERATION    02020000
020300             MOVE 'BUSEV PURGE PROCESS'  TO PV-ABEND-STRUCTURE-1  02030001
020400             MOVE 'DB2 - SUT_BUS_EVNT'   TO PV-ABEND-STRUCTURE-2  02040002
020500             PERFORM 9900-DB2-ABEND                               02050000
020600     END-EVALUATE.                                                02060000
020700                                                                  02070000
020800 7020-CLOSE-BUSEV-CSR.                                            02080001
020900     EXEC SQL                                                     02090000
021000         CLOSE BUSEV-CSR                                          02100001
021100     END-EXEC.                                                    02110000
021200                                                                  02120000
021300     EVALUATE TRUE                                                02130000
021400         WHEN SQLCODE = ZERO                                      02140000
021500             CONTINUE                                             02150000
021600         WHEN SQLWARN0 NOT = SPACE                                02160000
021700         WHEN SQLCODE  NOT = ZERO                                 02170000
021800             MOVE '7020-CLOSE-BUSEV-CSR' TO PV-ABEND-PARAGRAPH    02180001
021900             MOVE 'CLOSE CURSOR'         TO PV-ABEND-OPERATION    02190000
022000             MOVE 'BUSEV PURGE PROCESS'  TO PV-ABEND-STRUCTURE-1  02200001
022100             MOVE 'DB2 - SUT_BUS_EVNT'   TO PV-ABEND-STRUCTURE-2  02210002
022200             PERFORM 9900-DB2-ABEND                               02220000
022300     END-EVALUATE.                                                02230000
022500                                                                  02250000
022600 8000-WRITE-EXTRACT-REC.                                          02260000
022700                                                                  02270000
022800     INITIALIZE DL007-BUSEV-PURGE-LAYOUT.                         02280001
022900                                                                  02290000
023000     MOVE SUT00037-EVNT-EXPRT-ID     TO PV-EVNT-EXPRT-ID-HOLD.    02300006
023100     MOVE PV-EVNT-EXPRT-ID-HOLD      TO DL007-EVNT-EXPRT-ID.      02310006
023300                                                                  02330000
023400     ADD 1 TO PA-OUTPUT-RECS-WRITTEN.                             02340000
023500     WRITE BUSEV-EXTRACT-RECORD FROM DL007-BUSEV-PURGE-LAYOUT.    02350001
023600                                                                  02360000
023700 9000-TERMINATE.                                                  02370000
023800                                                                  02380000
023900     PERFORM 7020-CLOSE-BUSEV-CSR.                                02390001
024000                                                                  02400000
024100     CLOSE BUSEV-EXTRACT-FILE.                                    02410001
024200                                                                  02420000
024300     DISPLAY 'TMST :'  PV-CNTL-TMST.                              02430000
024400     DISPLAY 'TMST2:'  PV-CNTL-TMST2.                             02440008
024500                                                                  02450000
024600     DISPLAY '************************'.                          02460000
024700     DISPLAY '******* DLKUT007 *******'.                          02470001
024800     DISPLAY '************************'.                          02480000
024900     DISPLAY SPACES                                               02490000
025000                                                                  02500000
025100     MOVE PA-BUSEV-RECS-FETCHED       TO PV-DISPLAY-COUNT.        02510001
025200     DISPLAY 'TOTAL BUSEV RECS FETCHED      = ' PV-DISPLAY-COUNT. 02520001
025300                                                                  02530000
025400     MOVE PA-OUTPUT-RECS-WRITTEN      TO PV-DISPLAY-COUNT.        02540000
025500     DISPLAY 'TOTAL OUTPUT RECS WRITTEN     = ' PV-DISPLAY-COUNT. 02550000
025600                                                                  02560000
025700     DISPLAY SPACES                                               02570000
025800     DISPLAY '************************'.                          02580000
026000                                                                  02600000
026100 9900-DB2-ABEND.                                                  02610000
026200                                                                  02620000
026300     MOVE SQLCODE TO PV-SQLCODE.                                  02630000
026400     DISPLAY '*** DB2 ERROR '.                                    02640000
026500     DISPLAY '*** SQLCODE   = ' PV-SQLCODE.                       02650000
026600     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 02660000
026700     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               02670000
026800     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               02680000
026900     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       02690000
027000     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.       02700000
027100     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-3.       02710000
027200     DISPLAY '*** PROCESS   = ' PV-ABEND-STRUCTURE-1.             02720000
027300     DISPLAY '*** TABLE     = ' PV-ABEND-STRUCTURE-2.             02730000
027500                                                                  02750000
027600     COPY DPPD004.                                                02760000
027700                                                                  02770000
027800     MOVE +4013                  TO PV-ABEND-CODE.                02780000
027900     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         02790000
028000                                                                  02800000
