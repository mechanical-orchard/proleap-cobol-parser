      ******************************************************************00010007
      * COPYBOOK POPD055                                               *00020007
      ******************************************************************00030007
                                                                        00040007
      ******************************************************************00050007
      * THIS COPYBOOK MUST BE USED WITH POWS055 IN WORKING STORAGE.    *00060007
      ******************************************************************00070003
                                                                        00080007
       POPD055-CALC-WEEKLY-OTB.                                         00090006
                                                                        00100003
           MOVE SPACES TO POWS055-ERROR-TYPE.                           00110007
                                                                        00120007
           PERFORM POPD055-SELECT-TPOLDTM.                              00130007
                                                                        00140007
           IF POWS055-NO-ERROR                                          00150007
               PERFORM POPD055-CALC-NEW-DATE                            00160007
           END-IF.                                                      00170007
                                                                        00180007
           IF POWS055-NO-ERROR                                          00190007
               PERFORM POPD055-SELECT-TDTATTR                           00200007
           END-IF.                                                      00210007
                                                                        00220003
      *----------------------------------------------------------------*00230007
      * POPD055-SELECT-TPOLDTM.                                        *00240007
      *     THIS PARAGRAPH SELECTS THE OTB SHIP DAYS QTY FROM TPOLDTM  *00250007
      *     FOR USE IN CALCULATING THE OTB DATE FIELDS.                *00260007
      *----------------------------------------------------------------*00270007
       POPD055-SELECT-TPOLDTM.                                          00280007
                                                                        00290007
           PERFORM                                                      00300007
               WITH TEST AFTER                                          00310012
               VARYING POWS055-RETRY-COUNTER                            00320007
               FROM 1 BY 1                                              00330007
               UNTIL ((POWS055-RETRY-COUNTER > POWS055-MAX-RETRIES)     00340007
                         OR (SQLCODE = ZERO))                           00350007
               EXEC SQL                                                 00360007
                   SELECT SHIPT_WND_DAY_QTY                             00370007
                     INTO :POLDTM-SHIPT-WND-DAY-QTY                     00380007
                     FROM TPOLDTM                                       00390007
               END-EXEC                                                 00400007
                                                                        00410007
               EVALUATE TRUE                                            00420007
                   WHEN SQLCODE = ZERO                                  00430007
                       SET POWS055-NO-ERROR TO TRUE                     00440007
                       MOVE ZEROES          TO POWS055-SQLCODE          00450007
                   WHEN SQLWARN0 NOT = SPACES                           00460007
                   WHEN SQLCODE < ZERO                                  00470007
                   WHEN SQLCODE > ZERO                                  00480007
                       SET POWS055-BAD-SELECT-TO-TPOLDTM                00490007
                                            TO TRUE                     00500007
                       MOVE SQLCODE         TO POWS055-SQLCODE          00510007
               END-EVALUATE                                             00520007
           END-PERFORM.                                                 00530007
      *                                                                 00540007
           IF  POWS055-RETRY-COUNTER > POWS055-MAX-RETRIES              00550007
               SET POWS055-BAD-SELECT-TO-TPOLDTM                        00560007
                                            TO TRUE                     00570009
               MOVE SQLCODE TO POWS055-SQLCODE                          00580007
           END-IF.                                                      00590007
                                                                        00600007
      *----------------------------------------------------------------*00610007
      * POPD055-CALC-NEW-DATE.                                         *00620007
      *     THIS PARAGRAPH CALCS THE OTB DATE WITH AN SQL CALL.        *00630007
      *----------------------------------------------------------------*00640007
       POPD055-CALC-NEW-DATE.                                           00650007
                                                                        00660007
           EXEC SQL                                                     00670007
               SET :POWS055-CALCED-OTB-DATE =  DATE(:POWS055-INPUT-DATE)00680007
                                            + :POLDTM-SHIPT-WND-DAY-QTY 00690007
                                               DAYS                     00700010
           END-EXEC.                                                    00710008
                                                                        00720007
           EVALUATE TRUE                                                00730007
               WHEN SQLCODE = ZERO                                      00740007
                   SET POWS055-NO-ERROR     TO TRUE                     00750007
                   MOVE ZEROES              TO POWS055-SQLCODE          00760007
               WHEN SQLWARN0 NOT = SPACES                               00770007
               WHEN SQLCODE < ZERO                                      00780007
               WHEN SQLCODE > ZERO                                      00790007
                   SET POWS055-INVALID-INPUT-DATE                       00800007
                                            TO TRUE                     00810007
                   MOVE SQLCODE             TO POWS055-SQLCODE          00820007
           END-EVALUATE.                                                00830007
                                                                        00840007
      *----------------------------------------------------------------*00850007
      * GET THE FOLLOWING DATE FROM THE TDTATTR TABLE:                 *00860007
      *    - OTB YEAR (CCYY)                                           *00870007
      *    - OTB MONTH                                                 *00880007
      *    - OTB WEEK NUMBER                                           *00890007
      *    - OTB FISCAL BEGIN WEEK DATE                                *00900007
      *----------------------------------------------------------------*00910007
                                                                        00920004
       POPD055-SELECT-TDTATTR.                                          00930007
                                                                        00940007
           PERFORM                                                      00950003
               WITH TEST AFTER                                          00960012
               VARYING POWS055-RETRY-COUNTER                            00970007
               FROM 1 BY 1                                              00980003
               UNTIL ((POWS055-RETRY-COUNTER > POWS055-MAX-RETRIES)     00990007
                         OR (SQLCODE = ZERO))                           01000003
               EXEC SQL                                                 01010003
                  SELECT                                                01020003
                      FSCL_YR_NBR                                       01030004
                     ,FSCL_MN_NBR                                       01040015
                     ,CAL_MN_NBR                                        01050015
                     ,WK_IN_MN_NBR                                      01060004
                     ,FSCL_WK_BEG_DTE                                   01070007
                  INTO                                                  01080003
                      :DTATTR-FSCL-YR-NBR                               01090015
                     ,:DTATTR-FSCL-MN-NBR                               01100016
                     ,:POWS055-OTB-MONTH                                01110015
                     ,:POWS055-OTB-FSCL-WEEK-NBR                        01120008
                     ,:POWS055-OTB-FSCL-WK-BEG-DTE                      01130007
                  FROM                                                  01140003
                      TDTATTR                                           01150003
                  WHERE                                                 01160003
                      KY_DTE = :POWS055-CALCED-OTB-DATE                 01170007
               END-EXEC                                                 01180003
                                                                        01190003
               EVALUATE TRUE                                            01200003
                   WHEN SQLCODE = ZERO                                  01210003
                       MOVE DTATTR-FSCL-YR-NBR TO POWS055-OTB-YEAR      01220018
                       IF DTATTR-FSCL-MN-NBR = '12' AND                 01230015
                          POWS055-OTB-MONTH = '01'                      01240021
                           COMPUTE POWS055-OTB-YEAR-NBR =               01250020
                                   POWS055-OTB-YEAR-NBR + 1             01260020
                       END-IF                                           01270015
                       SET POWS055-NO-ERROR TO TRUE                     01280007
                       MOVE ZEROES          TO POWS055-SQLCODE          01290007
                   WHEN SQLWARN0 NOT = SPACES                           01300003
                   WHEN SQLCODE < ZERO                                  01310003
                   WHEN SQLCODE > ZERO                                  01320003
                       SET POWS055-BAD-SELECT-TO-TDTATTR                01330007
                                            TO TRUE                     01340007
                       MOVE SQLCODE         TO POWS055-SQLCODE          01350007
               END-EVALUATE                                             01360003
           END-PERFORM.                                                 01370003
                                                                        01380003
           IF  POWS055-RETRY-COUNTER > POWS055-MAX-RETRIES              01390011
               SET POWS055-BAD-SELECT-TO-TDTATTR                        01400007
                                            TO TRUE                     01410009
               MOVE SQLCODE TO POWS055-SQLCODE                          01420007
           END-IF.                                                      01430003
                                                                        01440003
