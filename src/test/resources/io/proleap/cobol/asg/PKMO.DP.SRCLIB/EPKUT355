000100 IDENTIFICATION DIVISION.                                         00010035
000200 PROGRAM-ID.      EPKUT355.                                       00020035
000300 AUTHOR.          COGNIZANT.                                      00030035
000400 DATE-WRITTEN.    SEPTEMBER,2013.                                 00040035
000500                                                                  00050035
000600*-----------------------------------------------------------      00060035
000700*            PROMOTIONS CORRECTION IDENTIFIER                     00070035
000800*-----------------------------------------------------------      00080035
000900*-----------------------------------------------------------      00090035
001000* HISTORY LOG:                                                    00100035
001100*-----------------------------------------------------------      00110035
001200* DATE: 09/30/2013                                                00120035
001300* WR/IR#:                                                         00130035
001400* PROGRAMMER: COGNIZANT                                           00140035
001500* THIS PROGRAM IS A MODIFIED VERSION OF EPKUT126.                 00150035
001600* DESCRIPTION: REMOVED THE EMERGENCY FILE EXTRACT PROCESS IN THE  00160035
001700*   NIGHTLY CYCLE. THIS IS DONE TO AVOID SORTING ISSUE FOR PROMO  00170035
001701*   SEND TO STORES.                                               00180035
001702* DATE:                                                           00190013
001703* WR/IR#:                                                         00200013
001704* PROGRAMMER:                                                     00210013
001705* DESCRIPTION:                                                    00220013
001706*                                                                 00230013
001707*----------------------------------------------------------       00240013
001708 ENVIRONMENT DIVISION.                                            00250035
001709*----------------------------------------------------------       00260035
001710 CONFIGURATION SECTION.                                           00270035
001720 SOURCE-COMPUTER.        IBM-3090.                                00280035
001730 OBJECT-COMPUTER.        IBM-3090.                                00290035
001740                                                                  00300035
001750 INPUT-OUTPUT SECTION.                                            00310035
001760                                                                  00320035
001770 FILE-CONTROL.                                                    00330035
001780                                                                  00340035
001790     SELECT CONTROL-CARD-PGM-LAST-RUN-TMST                        00350035
001800       ASSIGN TO INP01.                                           00360035
001900     SELECT CONTROL-CARD-PGM-CURR-TMST                            00370035
002000       ASSIGN TO INP02.                                           00380035
002100     SELECT CONTROL-CARD-CURR-PRICG-DTE                           00390035
002200       ASSIGN TO INP03.                                           00400035
002210     SELECT CONTROL-CARD-FUTRE-CORR-DTE                           00410035
002220       ASSIGN TO INP04.                                           00420035
002230     SELECT CONTROL-CARD-CRIT-EFF-DTE                             00430035
002240       ASSIGN TO INP05.                                           00440035
002250     SELECT PROMO-NIGHT-FILE                                      00450035
002260       ASSIGN TO OUT01.                                           00460035
002261                                                                  00470035
002262 DATA DIVISION.                                                   00480035
002263 FILE SECTION.                                                    00490035
002264                                                                  00500035
002265 FD  CONTROL-CARD-PGM-LAST-RUN-TMST                               00510035
002266     RECORDING MODE F                                             00520035
002267     BLOCK CONTAINS 0 RECORDS                                     00530035
002268     LABEL RECORDS ARE OMITTED                                    00540035
002269     DATA RECORD IS CNTRL-CARD-PGM-LAST-RUN-REC.                  00550035
002270 01  CNTRL-CARD-PGM-LAST-RUN-REC                   PIC  X(080).   00560035
002271                                                                  00570035
002272 FD  CONTROL-CARD-PGM-CURR-TMST                                   00580013
002273     RECORDING MODE F                                             00590013
002274     BLOCK CONTAINS 0 RECORDS                                     00600013
002275     LABEL RECORDS ARE OMITTED                                    00610013
002276     DATA RECORD IS CNTRL-CARD-PGM-CURR-RUN-REC.                  00620013
002277 01  CNTRL-CARD-PGM-CURR-RUN-REC                   PIC  X(080).   00630013
002278                                                                  00640035
002279 FD  CONTROL-CARD-CURR-PRICG-DTE                                  00650013
002280     RECORDING MODE F                                             00660013
002281     BLOCK CONTAINS 0 RECORDS                                     00670013
002282     LABEL RECORDS ARE OMITTED                                    00680013
002283     DATA RECORD IS CNTRL-CARD-CURR-PRICG-DTE-REC.                00690013
002284 01  CNTRL-CARD-CURR-PRICG-DTE-REC                 PIC  X(080).   00700013
002285                                                                  00710013
002286 FD  CONTROL-CARD-FUTRE-CORR-DTE                                  00720035
002287     RECORDING MODE F                                             00730035
002288     BLOCK CONTAINS 0 RECORDS                                     00740035
002289     LABEL RECORDS ARE OMITTED                                    00750035
002290     DATA RECORD IS CNTRL-CARD-FUTRE-CORR-DTE-REC.                00760035
002300 01  CNTRL-CARD-FUTRE-CORR-DTE-REC                 PIC  X(080).   00770035
002400                                                                  00780035
002500 FD  CONTROL-CARD-CRIT-EFF-DTE                                    00790035
002600     RECORDING MODE F                                             00800035
002700     BLOCK CONTAINS 0 RECORDS                                     00810035
002800     LABEL RECORDS ARE OMITTED                                    00820035
002900     DATA RECORD IS CNTRL-CARD-CRIT-EFF-DTE-REC.                  00830035
003000 01  CNTRL-CARD-CRIT-EFF-DTE-REC                   PIC  X(080).   00840035
003010                                                                  00850035
003020 FD  PROMO-NIGHT-FILE                                             00860035
003030     RECORDING MODE F                                             00870035
003040     BLOCK CONTAINS 0 RECORDS                                     00880035
003050     LABEL RECORDS ARE OMITTED                                    00890035
003060     DATA RECORD IS PROMO-NIGHT-ID-RECORD.                        00900035
003070 01  PROMO-NIGHT-RECORD                            PIC  X(200).   00910035
003080                                                                  00920035
003090                                                                  00930035
003100 WORKING-STORAGE SECTION.                                         00940035
003110*-----------------------------------------------------------      00950035
003120* PS - PROGRAM SWITCHES                                           00960035
003130*-----------------------------------------------------------      00970035
003140 01  PS-PROGRAM-SWITCHES.                                         00980035
003150     05  PS-RMS-PROMO-CSR-EOF-SW                   PIC  X(001).   00990035
003160       88  PS-RMS-PROMO-CSR-EOF                      VALUE 'Y'.   01000035
003170       88  PS-RMS-PROMO-CSR-NOT-EOF                  VALUE 'N'.   01010035
003180     05  PS-ADHOC-PROMO-CSR-EOF-SW                 PIC  X(001).   01020035
003190       88  PS-ADHOC-PROMO-CSR-EOF                    VALUE 'Y'.   01030035
003200       88  PS-ADHOC-PROMO-CSR-NOT-EOF                VALUE 'N'.   01040035
003300     05  PS-REC-FOUND-SW                           PIC  X(001).   01050035
003400       88  PS-REC-FOUND                              VALUE 'Y'.   01060035
003500       88  PS-NO-REC-FOUND                           VALUE 'N'.   01070035
003600     05  PS-WRITE-PROMO-SW                         PIC  X(001).   01080035
003700       88  PS-WRITE-PROMO                            VALUE 'Y'.   01090035
003800       88  PS-DONT-WRITE-PROMO                       VALUE 'N'.   01100035
003900     05  PS-FILE-STATUS                            PIC  X(002).   01110035
004000       88  PS-SUCCESSFUL-COMPLETION                  VALUE '00'.  01120035
004100       88  PS-END-OF-FILE                            VALUE '10'.  01130035
004200       88  PS-SUCCESSFUL-OPEN                        VALUE '97'.  01140035
004300     05  PS-END-OF-CNTL-CRD-SW                     PIC  X(001).   01150035
004400       88  PS-END-OF-CNTL-CRD-FILE                   VALUE 'Y'.   01160035
004500       88  PS-NOT-END-OF-CNTL-CRD-FILE               VALUE 'N'.   01170035
004600                                                                  01180035
004700*-----------------------------------------------------------      01190035
004800* PROGRAM CONSTANTS                                               01200035
004900*-----------------------------------------------------------      01210035
005000 01  PC-PROGRAM-CONSTANTS.                                        01220035
005100     05  PC-CURRENT-PROGRAM-NAME                   PIC  X(008)    01230035
005200       VALUE 'EPKUT355'.                                          01240035
005300     05  PC-PROMO-BUS-EVENT                        PIC  X(003)    01250035
005400       VALUE '020'.                                               01260035
005500     05  PC-RMS-PRC-SETUP-IND                      PIC  X(001)    01270035
005600       VALUE 'R'.                                                 01280035
005700     05  PC-ADHOC-PRC-SETUP-IND                    PIC  X(001)    01290035
005800       VALUE 'A'.                                                 01300035
005900     05  PC-ADHOC-STR-GRP-TYP-CDE                  PIC  X(005)    01310035
006000       VALUE '99999'.                                             01320035
006010     05  PC-ADHOC-STR-SPEC-CDE                     PIC  X(004)    01330035
006020       VALUE '5000'.                                              01340035
006030     05  PC-FILE-ACT-TYPE                          PIC  X(003)    01350035
006040       VALUE 'CHG'.                                               01360035
006050     05  PC-APPLY-NIGHTLY                          PIC  X(001)    01370035
006060       VALUE 'N'.                                                 01380035
006070     05  PC-PROMO-STAT-CDE                         PIC  X(001).   01390035
006080       88  PC-SCHEDULED-STATUS                       VALUE 'S'.   01400035
006090       88  PC-DELETE-STATUS                          VALUE 'D'.   01410035
006100       88  PC-CANCEL-STATUS                          VALUE 'C'.   01420035
006101     05  PC-ADD-STAT-CDE                           PIC  X(001)    01430035
006102       VALUE 'A'.                                                 01440035
006103     05  PC-DELETE-STAT-CDE                        PIC  X(001)    01450035
006104       VALUE 'D'.                                                 01460035
006105     05  PC-MDSE-INCL-IND                          PIC  X(001)    01470035
006106       VALUE 'I'.                                                 01480035
006107                                                                  01490035
006108*-----------------------------------------------------------      01500035
006109* PV- PROGRAM VARIABLES                                           01510035
006110*-----------------------------------------------------------      01520035
006120 01  PV-PROGRAM-VARAIBLES.                                        01530035
006130     05  PV-SQL-SUB                                PIC S9(004)    01540035
006140                                                     VALUE +0     01550035
006150                                                     COMP.        01560035
006160     05  PV-ACTL-STRT-TMST.                                       01570035
006170       10  PV-ACTL-STRT-TMST-DATE                  PIC  X(010)    01580035
006180                                                     VALUE SPACES.01590035
006190       10  FILLER                                  PIC  X(016)    01600035
006200                                                     VALUE SPACES.01610035
006300     05  PV-SOR-LAST-UPD-TMST                      PIC  X(026)    01620035
006400                                                     VALUE SPACES.01630035
006500     05  PV-EFF-STRT-TMST                          PIC  X(026)    01640035
006600                                                     VALUE SPACES.01650035
006700     05  PV-EFF-END-TMST                           PIC  X(026)    01660035
006800                                                     VALUE SPACES.01670035
006900     05  PV-EFF-END-NULL                           PIC S9(004)    01680035
007000                                                     VALUE ZEROS  01690035
007100                                                     COMP.        01700035
007200     05  PV-ABEND-CODE                             PIC  9999      01710035
007300                                                     VALUE ZEROS  01720035
007400                                                     COMP.        01730035
007500     05  PV-FUL-FILE-STR                           PIC  9(005)    01740035
007600                                                     VALUE ZEROS. 01750035
007700     05  EP111-CC-DATE-PLUS1                       PIC  X(010)    01760035
007800                                                     VALUE SPACES.01770035
007900     05  EP113-CC-CRNT-DTE-MINUS1                  PIC  X(010)    01780035
008000                                                     VALUE SPACES.01790035
008100                                                                  01800035
008200*----------------------------------------------------------       01810035
008300* FULL FILE EXTRACT OUTPUT FILE.                                  01820035
008400*----------------------------------------------------------       01830035
008500     COPY EPRD072.                                                01840035
008600                                                                  01850035
008700*----------------------------------------------------------       01860035
008800* EPCC111 CONTROL CARD LAYOUT                                     01870035
008900*----------------------------------------------------------       01880035
009000     COPY EPRD111.                                                01890035
009100                                                                  01900035
009200*----------------------------------------------------------       01910035
009300* EPCC113 CONTROL CARD LAYOUT                                     01920035
009400*----------------------------------------------------------       01930035
009500     COPY EPRD113.                                                01940035
009600                                                                  01950035
009700*----------------------------------------------------------       01960035
009800* EPCC400 CONTROL CARD LAYOUT                                     01970035
009900*----------------------------------------------------------       01980035
010000     COPY EPRD400.                                                01990035
010001                                                                  02000035
010002*----------------------------------------------------------       02010013
010003* EPCC401 CONTROL CARD LAYOUT                                     02020035
010004*----------------------------------------------------------       02030035
010005     COPY EPRD401.                                                02040035
010006                                                                  02050035
010007*----------------------------------------------------------       02060035
010008* EPCC128 CONTROL CARD LAYOUT                                     02070035
010009*----------------------------------------------------------       02080035
010010     COPY EPRD128.                                                02090035
010020                                                                  02100035
010030*----------------------------------------------------------       02110035
010040* DATE ROUTINE COPY MEMBERS                                       02120035
010050*----------------------------------------------------------       02130035
010060     COPY DPWS500.                                                02140035
010070                                                                  02150035
010080*-----------------------------------------------------------      02160035
010090* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         02170035
010100*-----------------------------------------------------------      02180035
010200     COPY DPWS004.                                                02190035
010300                                                                  02200035
010400*-----------------------------------------------------------      02210035
010500* DB2 ABEND COPYBOOK                                              02220035
010600*-----------------------------------------------------------      02230035
010700     COPY DPWS900.                                                02240035
010800                                                                  02250035
010900*-----------------------------------------------------------      02260035
011000* DB2 MESSAGE AREA                                                02270035
011100*-----------------------------------------------------------      02280035
011200     COPY SQLCA2.                                                 02290035
011300                                                                  02300035
011400*-----------------------------------------------------------      02310035
011500* PROGRAM COUNTERS                                                02320035
011600*-----------------------------------------------------------      02330035
011700 01  PC-PROGRAM-COUNTERS.                                         02340035
011800     05  PC-CNT-READ-RECS                          PIC  9(009)    02350035
011900                                                     VALUE 0.     02360035
012000     05  PC-CNT-NIGHT-RECS                         PIC  9(009)    02370035
012100                                                     VALUE 0.     02380035
012200     05  PC-CNT-PROMO-RECS                         PIC  9(009)    02390035
012300                                                     VALUE 0.     02400035
012400     05  PC-CNT-RMS-RECS                           PIC  9(009)    02410035
012500                                                     VALUE 0.     02420035
012600     05  PC-CNT-ADHOC-RECS                         PIC  9(009)    02430035
012700                                                     VALUE 0.     02440035
012800     05  PC-CNT-DEVT-RECS                          PIC  9(009)    02450035
012900                                                     VALUE 0.     02460035
013000     05  PC-CNT-PMAP-RECS                          PIC  9(009)    02470035
013100                                                     VALUE 0.     02480035
013200     05  PC-CNT-ERROR-RECS                         PIC  9(009)    02490035
013210                                                     VALUE 0.     02500035
013220     05  PC-CNT-ALL-RECS                           PIC  9(009)    02510035
013230                                                     VALUE 0.     02520035
013240     05  PC-CNT-SPACES                             PIC  9(009)    02530035
013250                                                     VALUE 0.     02540035
013260     05  PC-CNT-POS                                PIC  9(009)    02550035
013270                                                     VALUE 0.     02560035
013280     05  PC-MAX-RETRIES                            PIC S9(004)    02570035
013290                                                     VALUE +5     02580035
013300                                                     COMP.        02590035
013301                                                                  02600035
013302*-----------------------------------------------------------      02610035
013303* ERROR HANDLING                                                  02620035
013304*-----------------------------------------------------------      02630035
013305 01  PV-MISC-ABEND-FIELDS.                                        02640035
013306     05  PV-PARAGRAPH-NAME                         PIC  X(030)    02650035
013307                                                     VALUE SPACE. 02660035
013308     05  PV-OPERATION-MSG-1                        PIC  X(040)    02670035
013309                                                     VALUE SPACE. 02680035
013310     05  PV-OPERATION-MSG-2                        PIC  X(040)    02690035
013320                                                     VALUE SPACE. 02700035
013330     05  PV-DB2-OPERATION                          PIC  X(030)    02710035
013340                                                     VALUE SPACE. 02720035
013350 01  ABEND-CODE                                    PIC S9(004)    02730035
013360                                                     VALUE ZEROS  02740035
013370                                                     COMP         02750035
013380                                                     SYNC.        02760035
013390   88  ABEND-4003-CTRL-CARD-ERROR                    VALUE +4003. 02770035
013400   88  ABEND-4013-DB2-ERROR                          VALUE +4013. 02780035
013500   88  ABEND-4019-CAL-SUB-ERROR                      VALUE +4019. 02790035
013600   88  ABEND-4020-MQ-ERROR                           VALUE +4020. 02800035
013700   88  ABEND-4444-FORCED-ABEND                       VALUE +4444. 02810035
013800   88  ABEND-4008                                    VALUE +4008. 02820035
013900                                                                  02830035
014000                                                                  02840035
014100*-----------------------------------------------------------      02850035
014200* DB2 COMMUNICATIONS AREA                                         02860035
014300*-----------------------------------------------------------      02870035
014400     EXEC SQL                                                     02880035
014500       INCLUDE SQLCA                                              02890035
014600     END-EXEC.                                                    02900035
014700                                                                  02910035
014800*-----------------------------------------------------------      02920035
014900* DB2 TABLE XST00026(XST_PROMO) - PROMOTIONS TABLE                02930035
015000*-----------------------------------------------------------      02940035
015100     EXEC SQL                                                     02950035
015200       INCLUDE XST00026                                           02960035
015300     END-EXEC.                                                    02970035
015400                                                                  02980035
015500*-----------------------------------------------------------      02990035
015600* DB2 TABLE XST00028(XST_MDSE_LNE_SELN) - MERCHANDISE TABLE       03000035
015700*-----------------------------------------------------------      03010035
015800     EXEC SQL                                                     03020035
015900       INCLUDE XST00028                                           03030035
016000     END-EXEC.                                                    03040035
016100                                                                  03050035
016200*-----------------------------------------------------------      03060035
016300* DB2 TABLE XST00029(XST_PROMO_STR_GP) - STORE ZONE PRICING       03070035
016400*                                               TABLE             03080035
016500*-----------------------------------------------------------      03090035
016600     EXEC SQL                                                     03100035
016700       INCLUDE XST00029                                           03110035
016800     END-EXEC.                                                    03120035
016900                                                                  03130035
017000*-----------------------------------------------------------      03140035
017100* DB2 TABLE XST00031(XST_PROMO_ADHC_RLT) ADHOC RELATION           03150035
017200*-----------------------------------------------------------      03160035
017300     EXEC SQL                                                     03170035
017400       INCLUDE XST00031                                           03180035
017500     END-EXEC.                                                    03190035
017600                                                                  03200035
017700*-----------------------------------------------------------      03210035
017800* PROMOTIONS CHANGE INTERFACE INCLUDE CURSOR. (RMS)               03220035
017900*-----------------------------------------------------------      03230035
018000     EXEC SQL                                                     03240035
018100       DECLARE PROMO-RMS CURSOR FOR                               03250035
018200         SELECT PROMO.STAT_CDE                                    03260035
018300               ,PROMO.LAST_UPD_TMST                               03270035
018400               ,PROMO.SOR_LAST_UPD_TMST                           03280035
018500               ,STRGP.PROMO_INTFC_ID                              03290035
018600               ,STRGP.MDSE_LNE_ID                                 03300035
018700               ,STRGP.STR_GP_TYP_CDE                              03310035
018800               ,STRGP.STR_GP_ID                                   03320035
018900               ,STRGP.STR_SELN_HIER_CDE                           03330035
019000               ,STRGP.ACTL_STRT_TMST                              03340035
019100               ,STRGP.ACTL_END_TMST                               03350035
019200               ,MDSSEL.PRICG_TYP_CDE                              03360035
019300         FROM XST_PROMO          PROMO                            03370035
019400             ,XST_PROMO_STR_GP   STRGP                            03380035
019500             ,XST_MDSE_LNE_SELN  MDSSEL                           03390035
019600         WHERE PROMO.PROMO_ID = MDSSEL.PROMO_ID                   03400035
019700           AND MDSSEL.PROMO_INTFC_ID = STRGP.PROMO_INTFC_ID       03410035
019800           AND MDSSEL.MDSE_LNE_ID    = STRGP.MDSE_LNE_ID          03420035
019900           AND PROMO.STAT_CDE IN ('S')                            03430035
020000           AND STRGP.STAT_CDE  IN ('S')                           03440035
020100           AND (PROMO.LAST_UPD_TMST                               03450035
020200               BETWEEN :EP400-CC-PREV-RUN-CUTOFF-TMST             03460035
020300                   AND :EP401-CC-CURR-RUN-CUTOFF-TMST)            03470035
020400           AND ((:EP111-CC-CRNT-DTE                               03480035
020500               BETWEEN DATE(STRGP.ACTL_STRT_TMST)                 03490035
020600                   AND DATE(STRGP.ACTL_END_TMST))                 03500035
020700           OR  (DATE(STRGP.ACTL_STRT_TMST)                        03510035
020800               BETWEEN :EP111-CC-DATE-PLUS1                       03520035
020900                   AND :EP113-CC-CRNT-DTE-MINUS1))                03530035
021000         FOR FETCH ONLY                                           03540035
021100         WITH UR                                                  03550035
021200     END-EXEC.                                                    03560035
021300                                                                  03570035
021400*-----------------------------------------------------------      03580035
021500* PROMOTIONS CHANGE ID ADHOC CURSOR.                              03590035
021600*-----------------------------------------------------------      03600035
021700     EXEC SQL                                                     03610035
021710       DECLARE PROMO-ADHOC CURSOR FOR                             03620035
021720         SELECT PROMO.STAT_CDE                                    03630035
021730               ,PROMO.LAST_UPD_TMST                               03640035
021740               ,PROMO.SOR_LAST_UPD_TMST                           03650035
021750               ,ADHOC.PROMO_INTFC_ID                              03660035
021760               ,ADHOC.MDSE_LNE_ID                                 03670035
021770               ,ADHOC.ADHC_STR_GP_ID                              03680035
021780               ,ADHOC.STR_SELN_HIER_CDE                           03690035
021790               ,ADHOC.ACTL_STRT_TMST                              03700035
021800               ,ADHOC.ACTL_END_TMST                               03710035
021801               ,MDSSEL.PRICG_TYP_CDE                              03720035
021802        FROM XST_PROMO          PROMO                             03730035
021803            ,XST_PROMO_ADHC_RLT ADHOC                             03740035
021804            ,XST_MDSE_LNE_SELN  MDSSEL                            03750035
021805        WHERE PROMO.PROMO_ID = MDSSEL.PROMO_ID                    03760035
021806          AND ADHOC.PROMO_INTFC_ID  = MDSSEL.PROMO_INTFC_ID       03770035
021807          AND ADHOC.MDSE_LNE_ID     = MDSSEL.MDSE_LNE_ID          03780035
021808          AND ADHOC.STAT_CDE  IN ('S')                            03790035
021809          AND PROMO.STAT_CDE IN ('S')                             03800035
021810          AND (PROMO.LAST_UPD_TMST                                03810035
021820              BETWEEN :EP400-CC-PREV-RUN-CUTOFF-TMST              03820035
021830                  AND :EP401-CC-CURR-RUN-CUTOFF-TMST)             03830035
021840          AND ((:EP111-CC-CRNT-DTE                                03840035
021850              BETWEEN DATE(ADHOC.ACTL_STRT_TMST)                  03850035
021860                  AND DATE(ADHOC.ACTL_END_TMST))                  03860035
021870          OR  (DATE(ADHOC.ACTL_STRT_TMST)                         03870035
021880              BETWEEN :EP111-CC-DATE-PLUS1                        03880035
021890                  AND :EP113-CC-CRNT-DTE-MINUS1))                 03890035
021900        FOR FETCH ONLY                                            03900035
021910        WITH UR                                                   03910035
021911     END-EXEC.                                                    03920035
021912                                                                  03930035
021913 LINKAGE SECTION.                                                 03940035
021914                                                                  03950035
021915*----------------------------------------------------------       03960035
021916 PROCEDURE DIVISION.                                              03970035
021917*----------------------------------------------------------       03980035
021918 0000-MAINLINE.                                                   03990035
021919                                                                  04000035
021920     PERFORM 1000-INITIALIZATION.                                 04010035
021930                                                                  04020035
021940     PERFORM 2000-PROCESS-PROMOTIONS.                             04030035
021950                                                                  04040035
021960     PERFORM 9999-WRAPUP.                                         04050035
021970                                                                  04060035
021980     GOBACK.                                                      04070035
021981                                                                  04080035
021982*0000-EXIT.                                                       04090035
021983 EJECT.                                                           04100035
021984                                                                  04110035
021985*----------------------------------------------------------       04120035
021986* 1000-INITIALIZATION.                                            04130035
021987*     INITIALIZATION AREA - INITIALIZES ALL VARIABLES, OPENS      04140035
021988*     FILES, READS INPUT FILES, AND PROCESSES ANY INPUT FILE      04150035
021989*     PARAMETERS IT MAY NEED TO USE TO READ THE PROMO             04160035
021990*     INTERFACE ID FILE.                                          04170035
021991*----------------------------------------------------------       04180035
021992 1000-INITIALIZATION.                                             04190035
021993                                                                  04200035
021994     OPEN INPUT  CONTROL-CARD-CURR-PRICG-DTE                      04210035
021995                 CONTROL-CARD-FUTRE-CORR-DTE                      04220035
021996                 CONTROL-CARD-PGM-CURR-TMST                       04230035
021997                 CONTROL-CARD-PGM-LAST-RUN-TMST                   04240013
021998                 CONTROL-CARD-CRIT-EFF-DTE.                       04250013
021999     OPEN OUTPUT PROMO-NIGHT-FILE.                                04260013
022000                                                                  04270035
022100     INITIALIZE EP072-PROMO-INTFC-RECORD.                         04280035
022200                                                                  04290035
022300     PERFORM 1010-READ-PGM-CURR-RUN-CARD.                         04300035
022400     PERFORM 1020-READ-PGM-LAST-RUN-CARD.                         04310035
022500     PERFORM 1030-READ-CURR-PRICG-DTE-CARD.                       04320035
022600     PERFORM 1040-READ-FUTRE-CORR-DTE-CARD.                       04330035
022700     PERFORM 1050-READ-CRIT-EFF-DTE-CARD.                         04340035
022800     PERFORM 6100-DATE-ROUTINE.                                   04350035
022900                                                                  04360035
023000*1000-EXIT.                                                       04370035
023100 EJECT.                                                           04380035
023200                                                                  04390035
023300*----------------------------------------------------------       04400035
023400* 1010-READ-PGM-CURR-RUN-CARD.                                    04410035
023500*     READ CONTROL CARD EPCC401. THIS CONTROL CARD CONTAINS       04420035
023600*     THE CURRENT TIMESTAMP                                       04430035
023700*----------------------------------------------------------       04440035
023800 1010-READ-PGM-CURR-RUN-CARD.                                     04450035
023900                                                                  04460035
024000     READ CONTROL-CARD-PGM-CURR-TMST                              04470035
024100                                    INTO EP401-CC-CONTROL-CARD    04480035
024200       AT END                                                     04490035
024300          SET PS-END-OF-CNTL-CRD-FILE TO TRUE.                    04500035
024400                                                                  04510035
024500     IF PS-END-OF-CNTL-CRD-FILE                                   04520035
024600       DISPLAY ' '                                                04530035
024700       DISPLAY '** ABEND     **'                                  04540035
024800       DISPLAY '** PROGRAM   **  = ' PC-CURRENT-PROGRAM-NAME      04550035
024900       DISPLAY '** PARAGRAPH **  = 1010-READ-PGM-CURR-RUN-CARD'   04560035
025000       DISPLAY '** CONTROL FILE IS EMPTY  '                       04570035
025100       DISPLAY ' '                                                04580035
025200       MOVE +4002 TO ABEND-CODE                                   04590035
025300       CALL 'ILBOABN0' USING ABEND-CODE                           04600035
025400     ELSE                                                         04610035
025500       DISPLAY '** PROGRAM LAST RUN CONTROL CARD  **'             04620035
025600       DISPLAY '** EPCC401    **  =' EP401-CC-CURR-RUN-CUTOFF-TMST04630035
025700       DISPLAY ' '                                                04640035
025800     END-IF.                                                      04650035
025900                                                                  04660035
026000*1010-EXIT.                                                       04670035
026100 EJECT.                                                           04680035
026101                                                                  04690035
026102*----------------------------------------------------------       04700013
026103* 1020-READ-PGM-LAST-RUN-CARD.                                    04710013
026104*     READ CONTROL CARD EPCC400. THIS CONTROL CARD CONTAINS       04720013
026105*     THE TIMESTAMP FROM THE LAST RUN OF EPKUT355                 04730013
026106*----------------------------------------------------------       04740013
026107 1020-READ-PGM-LAST-RUN-CARD.                                     04750013
026108                                                                  04760035
026109     READ CONTROL-CARD-PGM-LAST-RUN-TMST                          04770035
026110                                    INTO EP400-CC-CONTROL-CARD    04780035
026120       AT END                                                     04790035
026130          SET PS-END-OF-CNTL-CRD-FILE TO TRUE.                    04800035
026140                                                                  04810035
026150     IF PS-END-OF-CNTL-CRD-FILE                                   04820035
026160       DISPLAY ' '                                                04830035
026170       DISPLAY '** ABEND     **'                                  04840035
026180       DISPLAY '** PROGRAM   **  = ' PC-CURRENT-PROGRAM-NAME      04850035
026190       DISPLAY '** PARAGRAPH **  = 1020-READ-PGM-LAST-RUN-CARD'   04860035
026200       DISPLAY '** CONTROL FILE IS EMPTY  '                       04870035
026300       DISPLAY ' '                                                04880035
026400       MOVE +4002 TO ABEND-CODE                                   04890035
026500       CALL 'ILBOABN0' USING ABEND-CODE                           04900035
026600     ELSE                                                         04910035
026700       DISPLAY '** PROGRAM LAST RUN CONTROL CARD  **'             04920035
026800       DISPLAY '** EPCC400    **  =' EP400-CC-PREV-RUN-CUTOFF-TMST04930035
026900       DISPLAY ' '                                                04940035
027000     END-IF.                                                      04950035
027100                                                                  04960035
027200*1020-EXIT.                                                       04970035
027300 EJECT.                                                           04980035
027400                                                                  04990035
027500*----------------------------------------------------------       05000035
027600* 1030-READ-CURR-PRICG-DTE-CARD.                                  05010035
027700*     READ CONTROL CARD EPCC111. THIS CONTROL CARD CONTAINS       05020035
027800*     THE CURRENT PRICING DATE.                                   05030035
027900*----------------------------------------------------------       05040035
028000 1030-READ-CURR-PRICG-DTE-CARD.                                   05050035
028100                                                                  05060035
028200     READ CONTROL-CARD-CURR-PRICG-DTE                             05070035
028300                               INTO EP111-CC-CONTROL-CARD         05080035
028310       AT END                                                     05090035
028320          SET PS-END-OF-CNTL-CRD-FILE TO TRUE.                    05100035
028330                                                                  05110035
028340     IF PS-END-OF-CNTL-CRD-FILE                                   05120035
028350       DISPLAY ' '                                                05130035
028360       DISPLAY '** ABEND     **'                                  05140035
028361       DISPLAY '** PROGRAM   **  = ' PC-CURRENT-PROGRAM-NAME      05150035
028362       DISPLAY '** PARAGRAPH **  = 1030-READ-CURR-PRICG-DTE-CARD' 05160035
028363       DISPLAY '** CONTROL FILE IS EMPTY  '                       05170035
028364       DISPLAY ' '                                                05180035
028365       MOVE +4002 TO ABEND-CODE                                   05190035
028366       CALL 'ILBOABN0' USING ABEND-CODE                           05200035
028367     ELSE                                                         05210035
028368       DISPLAY '** CURRENT PRICING DATE CONTROL CARD  **'         05220035
028369       DISPLAY '** EPCC111       **  = ' EP111-CC-CRNT-DTE        05230035
028370       DISPLAY ' '                                                05240035
028371     END-IF.                                                      05250035
028372                                                                  05260035
028373*1030-EXIT.                                                       05270035
028374 EJECT.                                                           05280035
028375                                                                  05290035
028376*----------------------------------------------------------       05300035
028377* 1040-READ-FUTRE-CORR-DTE-CARD.                                  05310035
028378*     READ CONTROL CARD EPCC113. THIS CONTROL CARD CONTAINS       05320035
028379*     THE NEXT FUTURE CORRECTIONS DATE                            05330035
028380*----------------------------------------------------------       05340035
028381 1040-READ-FUTRE-CORR-DTE-CARD.                                   05350035
028382                                                                  05360035
028383     READ CONTROL-CARD-FUTRE-CORR-DTE                             05370035
028384                               INTO EP113-CC-CONTROL-CARD         05380035
028385       AT END                                                     05390035
028386          SET PS-END-OF-CNTL-CRD-FILE TO TRUE.                    05400035
028387                                                                  05410035
028388     IF PS-END-OF-CNTL-CRD-FILE                                   05420035
028389       DISPLAY ' '                                                05430035
028390       DISPLAY '** ABEND     **'                                  05440035
028391       DISPLAY '** PROGRAM   **  = ' PC-CURRENT-PROGRAM-NAME      05450035
028392       DISPLAY '** PARAGRAPH **  = 1040-READ-FUTRE-CORR-DTE-CARD' 05460035
028393       DISPLAY '** CONTROL FILE IS EMPTY  '                       05470035
028394       DISPLAY ' '                                                05480035
028395       MOVE +4002 TO ABEND-CODE                                   05490035
028396       CALL 'ILBOABN0' USING ABEND-CODE                           05500035
028397     ELSE                                                         05510035
028398       DISPLAY '** FUTURE CORRECTION DATE CONTROL CARD  **'       05520035
028399       DISPLAY '** EPCC113       **  = ' EP113-CC-CRNT-DTE        05530035
028400       DISPLAY ' '                                                05540035
028401     END-IF.                                                      05550035
028402                                                                  05560035
028403*1040-EXIT.                                                       05570035
028404 EJECT.                                                           05580035
028405                                                                  05590035
028406*----------------------------------------------------------       05600035
028407* 1050-READ-CRIT-EFF-DTE-CARD.                                    05610035
028408*     READ CONTROL CARD EPCC128  THIS CONTROL CARD CONTAINS       05620035
028409*     THE CRITICAL EFFECTIVE DATE, WHICH DETERMINES IF CHANGES    05630035
028410*     ARE EMERGENCY OR NIGHTLY.                                   05640035
028411*----------------------------------------------------------       05650035
028412 1050-READ-CRIT-EFF-DTE-CARD.                                     05660035
028413                                                                  05670035
028414     READ CONTROL-CARD-CRIT-EFF-DTE                               05680035
028415                               INTO EP128-CC-CONTROL-CARD         05690035
028416       AT END                                                     05700035
028417          SET PS-END-OF-CNTL-CRD-FILE TO TRUE.                    05710035
028418                                                                  05720035
028419     IF PS-END-OF-CNTL-CRD-FILE                                   05730035
028420       DISPLAY ' '                                                05740035
028421       DISPLAY '** ABEND     **'                                  05750035
028422       DISPLAY '** PROGRAM   **  = ' PC-CURRENT-PROGRAM-NAME      05760035
028423       DISPLAY '** PARAGRAPH **  = 1050-READ-CRIT-EFF-DTE-CARD'   05770035
028424       DISPLAY '** CONTROL FILE IS EMPTY  '                       05780035
028425       DISPLAY ' '                                                05790035
028426       MOVE +4002 TO ABEND-CODE                                   05800035
028427       CALL 'ILBOABN0' USING ABEND-CODE                           05810035
028428     ELSE                                                         05820035
028429       DISPLAY '** CRITICAL EFFECTIVE DATE CONTROL CARD  **'      05830035
028430       DISPLAY '** EPCC128       **  = ' EP128-CC-CRITICAL-DTE    05840035
028431       DISPLAY ' '                                                05850035
028432     END-IF.                                                      05860035
028433                                                                  05870035
028434*1050-EXIT.                                                       05880035
028435 EJECT.                                                           05890035
028436                                                                  05900035
028437*----------------------------------------------------------       05910035
028438* 2000-PROCESS-PROMOTIONS.                                        05920035
028439*     MAIN PROCESSING AREA - EXECUTES RMS AND ADHOC QUERY         05930035
028440*     TO IDENTIFY PROMOTION CHANGES AND CREATES OUTPUT            05940035
028441*     FILES TO IDENTIFY WHICH STORE GROUP/PROMO INTERFACE I.D     05950035
028442*     COMBO'S NEED RECORDS CREATED FOR THE STORE SERVER.          05960035
028443*----------------------------------------------------------       05970035
028444 2000-PROCESS-PROMOTIONS.                                         05980035
028445                                                                  05990035
028446     PERFORM 2100-PROCESS-RMS-CURSOR.                             06000035
028447                                                                  06010035
028448     PERFORM 2200-PROCESS-ADHOC-CURSOR.                           06020035
028449                                                                  06030035
028450*2000-EXIT.                                                       06040035
028451 EJECT.                                                           06050035
028452                                                                  06060035
028453*----------------------------------------------------------       06070035
028454* 2100-PROCESS-RMS-CURSOR.                                        06080035
028455*     READ THE RECORD FROM THE PROMOTIONS TABLE AND               06090035
028456*     CREATE PROMO AND PMAP RECORDS BASED ON THE RECORD READ.     06100035
028457*----------------------------------------------------------       06110035
028458 2100-PROCESS-RMS-CURSOR.                                         06120035
028459                                                                  06130035
028460     PERFORM 2110-OPEN-RMS-PROMO-CSR.                             06140035
028461     PERFORM 2120-FETCH-RMS-PROMO-CSR                             06150035
028462       UNTIL PS-RMS-PROMO-CSR-EOF.                                06160035
028463     PERFORM 2130-CLOSE-RMS-PROMO-CSR.                            06170035
028464                                                                  06180035
028465*2100-EXIT.                                                       06190035
028466 EJECT.                                                           06200035
028467                                                                  06210035
028468*----------------------------------------------------------       06220035
028469* 2110-OPEN-RMS-PROMO-CSR.                                        06230035
028470*     OPEN THE PROMOTIONS CURSOR (RMS).                           06240035
028480*----------------------------------------------------------       06250035
028490 2110-OPEN-RMS-PROMO-CSR.                                         06260035
028500                                                                  06270035
028600     PERFORM                                                      06280035
028700         WITH TEST AFTER                                          06290035
028800         VARYING PV-SQL-SUB                                       06300035
028900         FROM 1 BY 1                                              06310035
029000         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 06320035
029100                   OR  SQLCODE = 0)                               06330035
029200                                                                  06340035
029300         EXEC SQL                                                 06350035
029400           OPEN PROMO-RMS                                         06360035
029500         END-EXEC                                                 06370035
029600                                                                  06380035
029700         EVALUATE TRUE                                            06390035
029800           WHEN SQLCODE = -904                                    06400035
029900           WHEN SQLCODE = -911                                    06410035
030000           WHEN SQLCODE = -913                                    06420035
030100             CONTINUE                                             06430035
030200           WHEN SQLCODE = 0                                       06440035
030300             SET PS-RMS-PROMO-CSR-NOT-EOF TO TRUE                 06450035
030400           WHEN SQLWARN0 NOT EQUAL SPACE                          06460035
030500           WHEN SQLCODE NOT EQUAL ZERO                            06470035
030600             MOVE '2110-OPEN-RMS-PROMO-CSR'                       06480035
030700                                   TO PV-PARAGRAPH-NAME           06490035
030800             MOVE 'ERROR ON OPEN OF PROMO RMS CURSOR'             06500035
030900                                   TO PV-DB2-OPERATION            06510035
031000             PERFORM 9900-SQL-ABEND-ROUTINE                       06520035
031100         END-EVALUATE                                             06530035
031200     END-PERFORM.                                                 06540035
031300                                                                  06550035
031400     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         06560035
031500       MOVE '2110-OPEN-RMS-PROMO-CSR'                             06570035
031600                             TO  PV-PARAGRAPH-NAME                06580035
031700       MOVE 'OPEN RETRIES EXCEEDED'                               06590035
031800                              TO  PV-DB2-OPERATION                06600035
031900       PERFORM 9900-SQL-ABEND-ROUTINE                             06610035
032000     END-IF.                                                      06620035
032100                                                                  06630035
032200*2110-EXIT.                                                       06640035
032300 EJECT.                                                           06650035
032400                                                                  06660035
032500*----------------------------------------------------------       06670035
032600* 2120-FETCH-RMS-PROMO-CSR.                                       06680035
032700*     FETCH THE PROMOTIONS ID CURSOR. (RMS)                       06690035
032800*----------------------------------------------------------       06700035
032900 2120-FETCH-RMS-PROMO-CSR.                                        06710035
033000                                                                  06720035
033100     PERFORM                                                      06730035
033200         WITH TEST AFTER                                          06740035
033300         VARYING PV-SQL-SUB                                       06750035
033400         FROM 1 BY 1                                              06760035
033500         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 06770035
033600                   OR  SQLCODE = 0                                06780035
033700                   OR  SQLCODE = +100)                            06790035
033800                                                                  06800035
033900         EXEC SQL                                                 06810035
034000           FETCH PROMO-RMS                                        06820035
034100           INTO  :XST00026-STAT-CDE                               06830035
034200                ,:XST00026-LAST-UPD-TMST                          06840035
034300                ,:XST00026-SOR-LAST-UPD-TMST                      06850035
034400                ,:XST00029-PROMO-INTFC-ID                         06860035
034500                ,:XST00029-MDSE-LNE-ID                            06870035
034600                ,:XST00029-STR-GP-TYP-CDE                         06880035
034700                ,:XST00029-STR-GP-ID                              06890035
034800                ,:XST00029-STR-SELN-HIER-CDE                      06900035
034900                ,:XST00029-ACTL-STRT-TMST                         06910035
035000                ,:XST00029-ACTL-END-TMST                          06920035
035100                ,:XST00028-PRICG-TYP-CDE                          06930035
035200         END-EXEC                                                 06940035
035300                                                                  06950035
035400         EVALUATE TRUE                                            06960035
035500           WHEN SQLCODE = -904                                    06970035
035600           WHEN SQLCODE = -911                                    06980035
035700           WHEN SQLCODE = -913                                    06990035
035800             CONTINUE                                             07000035
035900           WHEN SQLCODE = ZERO                                    07010035
036000             PERFORM 3000-FORMAT-RMS-OUTPUT                       07020035
036100             ADD 1 TO PC-CNT-RMS-RECS                             07030035
036200           WHEN SQLCODE = +100                                    07040035
036300             SET PS-RMS-PROMO-CSR-EOF TO TRUE                     07050035
036400           WHEN SQLWARN0 NOT EQUAL SPACE                          07060035
036500           WHEN SQLCODE NOT EQUAL ZERO                            07070035
036600             MOVE '2120-FETCH-RMS-PROMO-CSR'                      07080035
036700                                    TO PV-PARAGRAPH-NAME          07090035
036800             MOVE 'ERROR ON FETCHING PROMO RMS CURSOR'            07100035
036900                                    TO PV-DB2-OPERATION           07110035
037000             PERFORM 9900-SQL-ABEND-ROUTINE                       07120035
037100         END-EVALUATE                                             07130035
037200     END-PERFORM.                                                 07140035
037300                                                                  07150035
037400     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         07160035
037500       MOVE '2120-FETCH-RMS-PROMO-CSR'                            07170035
037600                               TO  PV-PARAGRAPH-NAME              07180035
037700       MOVE 'FETCH RETRIES EXCEEDED'                              07190035
037800                               TO  PV-DB2-OPERATION               07200035
037900       PERFORM 9900-SQL-ABEND-ROUTINE                             07210035
038000     END-IF.                                                      07220035
038100                                                                  07230035
038200*2120-EXIT.                                                       07240035
038300 EJECT.                                                           07250035
038400                                                                  07260035
038500*-----------------------------------------------------------      07270035
038600* 2130-CLOSE-RMS-PROMO-CSR.                                       07280035
038700*-----------------------------------------------------------      07290035
038800 2130-CLOSE-RMS-PROMO-CSR.                                        07300035
038900                                                                  07310035
039000     PERFORM                                                      07320035
039100         WITH TEST AFTER                                          07330035
039200         VARYING PV-SQL-SUB                                       07340035
039300         FROM 1 BY 1                                              07350035
039400         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 07360035
039500                   OR  SQLCODE = 0)                               07370035
039600                                                                  07380035
039700         EXEC SQL                                                 07390035
039800           CLOSE PROMO-RMS                                        07400035
039900         END-EXEC                                                 07410035
040000                                                                  07420035
040100         EVALUATE TRUE                                            07430035
040200           WHEN SQLCODE = -904                                    07440035
040300           WHEN SQLCODE = -911                                    07450035
040400           WHEN SQLCODE = -913                                    07460035
040500           WHEN SQLCODE = 0                                       07470035
040600             CONTINUE                                             07480035
040700           WHEN SQLWARN0 NOT EQUAL SPACE                          07490035
040800           WHEN SQLCODE NOT EQUAL ZERO                            07500035
040900             MOVE '2130-CLOSE-RMS-PROMO-CSR'                      07510035
041000                                       TO PV-PARAGRAPH-NAME       07520035
041100             MOVE 'ERROR ON CLOSE OF PROMO RMS CURSOR'            07530035
041200                                       TO PV-DB2-OPERATION        07540035
041300             PERFORM 9900-SQL-ABEND-ROUTINE                       07550035
041400         END-EVALUATE                                             07560035
041500     END-PERFORM.                                                 07570035
041600                                                                  07580035
041700     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         07590035
041800       MOVE '2130-CLOSE-RMS-PROMO-CSR'                            07600035
041900                               TO  PV-PARAGRAPH-NAME              07610035
042000       MOVE 'CLOSE RETRIES EXCEEDED'                              07620035
042100                               TO  PV-DB2-OPERATION               07630035
042200       PERFORM 9900-SQL-ABEND-ROUTINE                             07640035
042300     END-IF.                                                      07650035
042400                                                                  07660035
042500*2130-EXIT.                                                       07670035
042600 EJECT.                                                           07680035
042700                                                                  07690035
042800*----------------------------------------------------------       07700035
042900* 2200-PROCESS-ADHOC-CURSOR.                                      07710035
043000*     READ THE RECORD FROM THE PROMOTIONS TABLE AND               07720035
043100*     CREATE PROMO RECORDS BASED ON THE RECORD READ.              07730035
043200*----------------------------------------------------------       07740035
043300 2200-PROCESS-ADHOC-CURSOR.                                       07750035
043400                                                                  07760035
043500     PERFORM 2210-OPEN-ADHOC-PROMO-CSR.                           07770035
043600     PERFORM 2220-FETCH-ADHOC-PROMO-CSR                           07780035
043700       UNTIL PS-ADHOC-PROMO-CSR-EOF.                              07790035
043800     PERFORM 2230-CLOSE-ADHOC-PROMO-CSR.                          07800035
043900                                                                  07810035
044000*2200-EXIT.                                                       07820035
044100 EJECT.                                                           07830035
044200                                                                  07840035
044300*----------------------------------------------------------       07850035
044400* 2210-OPEN-ADHOC-PROMO-CSR.                                      07860035
044500*     OPEN THE PROMOTIONS ADHOC CURSOR.                           07870035
044600*----------------------------------------------------------       07880035
044700 2210-OPEN-ADHOC-PROMO-CSR.                                       07890035
044800                                                                  07900035
044900     PERFORM                                                      07910035
045000         WITH TEST AFTER                                          07920035
045100         VARYING PV-SQL-SUB                                       07930035
045200         FROM 1 BY 1                                              07940035
045300         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 07950035
045400                   OR  SQLCODE = 0)                               07960035
045500                                                                  07970035
045600         EXEC SQL                                                 07980035
045700           OPEN PROMO-ADHOC                                       07990035
045800         END-EXEC                                                 08000035
045900                                                                  08010035
046000         EVALUATE TRUE                                            08020035
046100           WHEN SQLCODE = -904                                    08030035
046200           WHEN SQLCODE = -911                                    08040035
046300           WHEN SQLCODE = -913                                    08050035
046400             CONTINUE                                             08060035
046500           WHEN SQLCODE = 0                                       08070035
046600             SET PS-ADHOC-PROMO-CSR-NOT-EOF TO TRUE               08080035
046700           WHEN SQLWARN0 NOT EQUAL SPACE                          08090035
046800           WHEN SQLCODE NOT EQUAL ZERO                            08100035
046900             MOVE '2210-OPEN-ADHOC-PROMO-CSR'                     08110035
047000                                     TO PV-PARAGRAPH-NAME         08120035
047100             MOVE 'ERROR ON OPEN OF PROMO ADHOC CURSOR'           08130035
047200                                     TO PV-DB2-OPERATION          08140035
047300             PERFORM 9900-SQL-ABEND-ROUTINE                       08150035
047400         END-EVALUATE                                             08160035
047500     END-PERFORM.                                                 08170035
047600                                                                  08180035
047700     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         08190035
047800       MOVE '2210-OPEN-ADHOC-PROMO-CSR'                           08200035
047900                             TO  PV-PARAGRAPH-NAME                08210035
048000       MOVE 'OPEN RETRIES EXCEEDED'                               08220035
048100                              TO  PV-DB2-OPERATION                08230035
048200       PERFORM 9900-SQL-ABEND-ROUTINE                             08240035
048300     END-IF.                                                      08250035
048400                                                                  08260035
048500*2210-EXIT.                                                       08270035
048600 EJECT.                                                           08280035
048700                                                                  08290035
048800*----------------------------------------------------------       08300035
048900* 2220-FETCH-ADHOC-PROMO-CSR.                                     08310035
049000*     FETCH THE PROMOTIONS ADHOC CURSOR.                          08320035
049100*----------------------------------------------------------       08330035
049200 2220-FETCH-ADHOC-PROMO-CSR.                                      08340035
049300                                                                  08350035
049400     PERFORM                                                      08360035
049500         WITH TEST AFTER                                          08370035
049600         VARYING PV-SQL-SUB                                       08380035
049700         FROM 1 BY 1                                              08390035
049800         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 08400035
049900                   OR  SQLCODE = 0                                08410035
050000                   OR  SQLCODE = +100)                            08420035
050100                                                                  08430035
050200         EXEC SQL                                                 08440035
050300           FETCH PROMO-ADHOC                                      08450035
050400            INTO  :XST00026-STAT-CDE                              08460035
050500                 ,:XST00026-LAST-UPD-TMST                         08470035
050600                 ,:XST00026-SOR-LAST-UPD-TMST                     08480035
050700                 ,:XST00031-PROMO-INTFC-ID                        08490035
050800                 ,:XST00031-MDSE-LNE-ID                           08500035
050900                 ,:XST00031-ADHC-STR-GP-ID                        08510035
051000                 ,:XST00031-STR-SELN-HIER-CDE                     08520035
051100                 ,:XST00031-ACTL-STRT-TMST                        08530035
051110                 ,:XST00031-ACTL-END-TMST                         08540035
051120                 ,:XST00028-PRICG-TYP-CDE                         08550035
051130         END-EXEC                                                 08560035
051140                                                                  08570035
051150         EVALUATE TRUE                                            08580035
051160           WHEN SQLCODE = -904                                    08590035
051170           WHEN SQLCODE = -911                                    08600035
051180           WHEN SQLCODE = -913                                    08610035
051190             CONTINUE                                             08620035
051200           WHEN SQLCODE = ZERO                                    08630035
051300             PERFORM 3100-FORMAT-ADHOC-OUTPUT                     08640035
051400             ADD 1 TO PC-CNT-ADHOC-RECS                           08650035
051500           WHEN SQLCODE = +100                                    08660035
051600             SET PS-ADHOC-PROMO-CSR-EOF TO TRUE                   08670035
051700           WHEN SQLWARN0 NOT EQUAL SPACE                          08680035
051800           WHEN SQLCODE NOT EQUAL ZERO                            08690035
051810             MOVE '2220-FETCH-ADHOC-PROMO-CSR'                    08700035
051820                                    TO PV-PARAGRAPH-NAME          08710035
051830             MOVE 'ERROR ON FETCHING PROMO ADHOC CURSOR'          08720035
051840                                    TO PV-DB2-OPERATION           08730035
051850             DISPLAY 'SQLCODE= ' SQLCODE                          08740035
051860             PERFORM 9900-SQL-ABEND-ROUTINE                       08750035
051870         END-EVALUATE                                             08760035
051880     END-PERFORM.                                                 08770035
051881                                                                  08780035
051882     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         08790035
051883       MOVE '2220-FETCH-ADHOC-PROMO-CSR'                          08800035
051884                              TO  PV-PARAGRAPH-NAME               08810035
051885       MOVE 'FETCH RETRIES EXCEEDED'                              08820035
051886                              TO  PV-DB2-OPERATION                08830035
051887       PERFORM 9900-SQL-ABEND-ROUTINE                             08840035
051888     END-IF.                                                      08850035
051889                                                                  08860035
051890*2220-EXIT.                                                       08870035
051891 EJECT.                                                           08880035
051892                                                                  08890035
051893*-----------------------------------------------------------      08900035
051894* 2230-CLOSE-ADHOC-PROMO-CSR.                                     08910035
051895*     CLOSE THE PROMOTIONS ADHOC CURSOR.                          08920035
051896*-----------------------------------------------------------      08930035
051897 2230-CLOSE-ADHOC-PROMO-CSR.                                      08940035
051898                                                                  08950035
051899     PERFORM                                                      08960035
051900         WITH TEST AFTER                                          08970035
051901         VARYING PV-SQL-SUB                                       08980035
051902         FROM 1 BY 1                                              08990035
051903         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 09000035
051904                   OR  SQLCODE = 0)                               09010035
051905                                                                  09020035
051906         EXEC SQL                                                 09030035
051907           CLOSE PROMO-ADHOC                                      09040035
051908         END-EXEC                                                 09050035
051909                                                                  09060035
051910         EVALUATE TRUE                                            09070035
051911           WHEN SQLCODE = -904                                    09080035
051912           WHEN SQLCODE = -911                                    09090035
051913           WHEN SQLCODE = -913                                    09100035
051914           WHEN SQLCODE = 0                                       09110035
051915             CONTINUE                                             09120035
051916           WHEN SQLWARN0 NOT EQUAL SPACE                          09130035
051917           WHEN SQLCODE NOT EQUAL ZERO                            09140035
051918             MOVE '2230-CLOSE-ADHOC-PROMO-CSR'                    09150035
051919                                     TO PV-PARAGRAPH-NAME         09160035
051920             MOVE 'ERROR ON CLOSE OF PROMOTION ADHOC CURSOR'      09170035
051921                                     TO PV-DB2-OPERATION          09180035
051922             PERFORM 9900-SQL-ABEND-ROUTINE                       09190035
051923         END-EVALUATE                                             09200035
051924     END-PERFORM.                                                 09210035
051925                                                                  09220035
051926     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         09230035
051927       MOVE '2230-CLOSE-ADHOC-PROMO-CSR'                          09240035
051928                               TO  PV-PARAGRAPH-NAME              09250035
051929       MOVE 'CLOSE RETRIES EXCEEDED'                              09260035
051930                               TO  PV-DB2-OPERATION               09270035
051931       PERFORM 9900-SQL-ABEND-ROUTINE                             09280035
051932     END-IF.                                                      09290035
051933                                                                  09300035
051934*2230-EXIT.                                                       09310035
051935 EJECT.                                                           09320035
051936                                                                  09330035
051937*-----------------------------------------------------------      09340035
051938* 3000-FORMAT-RMS-OUTPUT.                                         09350035
051939*     POPULATE COPYBOOK EPRD072.                                  09360035
051940*-----------------------------------------------------------      09370035
051950 3000-FORMAT-RMS-OUTPUT.                                          09380035
051960                                                                  09390035
051970     INITIALIZE EP072-PROMO-INTFC-RECORD.                         09400035
051980     MOVE PC-PROMO-BUS-EVENT                                      09410035
051990                             TO EP072-BUSINESS-EVENT-ID.          09420035
052000     MOVE PC-RMS-PRC-SETUP-IND                                    09430035
052100                             TO EP072-PRC-SETUP-IND.              09440035
052110     MOVE XST00029-STR-GP-TYP-CDE                                 09450035
052111                             TO EP072-SETUP-STR-GRP-TYP-CDE.      09460035
052112     MOVE XST00029-STR-GP-ID                                      09470035
052113                             TO EP072-SETUP-STR-GRP-ID.           09480035
052114     MOVE XST00029-STR-SELN-HIER-CDE                              09490035
052115                             TO EP072-STR-SELN-HIER-CDE.          09500035
052116     MOVE XST00029-STR-GP-TYP-CDE                                 09510035
052117                             TO EP072-DIST-STR-GRP-TYP-CDE.       09520035
052118     MOVE XST00029-STR-GP-ID                                      09530035
052119                             TO EP072-DIST-STR-GRP-ID.            09540035
052120     MOVE PC-FILE-ACT-TYPE   TO EP072-FILE-ACT-TYP.               09550035
052121                                                                  09560035
052122     MOVE XST00029-ACTL-STRT-TMST                                 09570035
052123                             TO PV-ACTL-STRT-TMST.                09580035
052124                                                                  09590035
052125     IF PV-ACTL-STRT-TMST-DATE > EP128-CC-CRITICAL-DTE            09600035
052126       AND PV-ACTL-STRT-TMST-DATE < EP113-CC-CRNT-DTE             09610035
052127         MOVE PC-APPLY-NIGHTLY   TO EP072-APPLY-IND               09620035
052128     END-IF.                                                      09630035
052129                                                                  09640035
052130     MOVE XST00026-STAT-CDE  TO PC-PROMO-STAT-CDE                 09650035
052131                                                                  09660035
052132     IF PC-SCHEDULED-STATUS                                       09670035
052133       MOVE PC-ADD-STAT-CDE                                       09680035
052134                             TO EP072-RECORD-ACTION               09690035
052135     ELSE                                                         09700035
052136       IF PC-DELETE-STATUS OR PC-CANCEL-STATUS                    09710035
052137         MOVE PC-DELETE-STAT-CDE                                  09720035
052138                             TO EP072-RECORD-ACTION               09730035
052139       END-IF                                                     09740035
052140     END-IF.                                                      09750035
052141                                                                  09760035
052142     MOVE XST00029-PROMO-INTFC-ID                                 09770035
052143                             TO EP072-PROMO-INTFC-ID.             09780035
052144     MOVE XST00029-MDSE-LNE-ID                                    09790035
052145                             TO EP072-MERCH-LNE-ID.               09800035
052146     MOVE XST00028-PRICG-TYP-CDE                                  09810035
052147                             TO EP072-PRICG-TYP-CDE.              09820035
052148     MOVE PC-MDSE-INCL-IND                                        09830035
052149                             TO EP072-MDSE-INC-EXC-IND.           09840035
052150     MOVE XST00029-ACTL-STRT-TMST                                 09850035
052151                             TO EP072-STR-GRP-PROMO-STRT-TMST.    09860035
052152     MOVE XST00029-ACTL-END-TMST                                  09870035
052153                             TO EP072-STR-GRP-PROMO-END-TMST.     09880035
052154     MOVE XST00026-SOR-LAST-UPD-TMST                              09890035
052155                             TO EP072-SOR-LAST-UPD-TMST.          09900035
052156                                                                  09910035
052157     IF EP072-APPLY-NIGHTLY                                       09920035
052158       PERFORM 4000-WRITE-NIGHT-APPLY-RECORD                      09930035
052159     ELSE                                                         09940035
052160       MOVE PC-APPLY-NIGHTLY   TO EP072-APPLY-IND                 09950035
052170       PERFORM 4000-WRITE-NIGHT-APPLY-RECORD                      09960035
052171     END-IF.                                                      09970035
052172                                                                  09980035
052173*3000-EXIT.                                                       09990035
052174 EJECT.                                                           10000035
052175*-----------------------------------------------------------      10010035
052176* 3100-FORMAT-ADHOC-OUTPUT.                                       10020035
052177*     POPULATE COPYBOOK EPRD072.                                  10030035
052178*-----------------------------------------------------------      10040035
052179 3100-FORMAT-ADHOC-OUTPUT.                                        10050035
052180                                                                  10060035
052181     INITIALIZE EP072-PROMO-INTFC-RECORD.                         10070035
052182     MOVE PC-PROMO-BUS-EVENT                                      10080035
052183                             TO EP072-BUSINESS-EVENT-ID.          10090035
052184     MOVE PC-ADHOC-PRC-SETUP-IND                                  10100035
052185                             TO EP072-PRC-SETUP-IND.              10110035
052186     MOVE PC-ADHOC-STR-GRP-TYP-CDE                                10120035
052187                             TO EP072-SETUP-STR-GRP-TYP-CDE.      10130035
052188     MOVE XST00031-ADHC-STR-GP-ID                                 10140035
052189                             TO EP072-SETUP-STR-GRP-ID.           10150035
052190     MOVE XST00031-STR-SELN-HIER-CDE                              10160035
052200                             TO EP072-STR-SELN-HIER-CDE.          10170035
052210     MOVE PC-ADHOC-STR-GRP-TYP-CDE                                10180035
052220                             TO EP072-DIST-STR-GRP-TYP-CDE.       10190035
052230     MOVE XST00031-ADHC-STR-GP-ID                                 10200035
052240                             TO EP072-DIST-STR-GRP-ID.            10210035
052250     MOVE PC-FILE-ACT-TYPE   TO EP072-FILE-ACT-TYP.               10220035
052260                                                                  10230035
052270     MOVE XST00031-ACTL-STRT-TMST                                 10240035
052280                             TO PV-ACTL-STRT-TMST.                10250035
052281                                                                  10260035
052282     IF PV-ACTL-STRT-TMST-DATE > EP128-CC-CRITICAL-DTE            10270035
052283       AND PV-ACTL-STRT-TMST-DATE < EP113-CC-CRNT-DTE             10280035
052284         MOVE PC-APPLY-NIGHTLY   TO EP072-APPLY-IND               10290035
052285     END-IF.                                                      10300035
052286                                                                  10310035
052287     MOVE XST00026-STAT-CDE  TO PC-PROMO-STAT-CDE                 10320035
052288                                                                  10330035
052289     IF PC-SCHEDULED-STATUS                                       10340035
052290       MOVE PC-ADD-STAT-CDE                                       10350035
052300                             TO EP072-RECORD-ACTION               10360035
052301     ELSE                                                         10370035
052302       IF PC-DELETE-STATUS OR PC-CANCEL-STATUS                    10380035
052303         MOVE PC-DELETE-STAT-CDE                                  10390035
052304                             TO EP072-RECORD-ACTION               10400035
052305       END-IF                                                     10410035
052306     END-IF.                                                      10420035
052307                                                                  10430035
052308     MOVE XST00031-PROMO-INTFC-ID                                 10440035
052309                             TO EP072-PROMO-INTFC-ID.             10450035
052310     MOVE XST00031-MDSE-LNE-ID                                    10460035
052311                             TO EP072-MERCH-LNE-ID.               10470035
052312     MOVE XST00028-PRICG-TYP-CDE                                  10480035
052313                             TO EP072-PRICG-TYP-CDE.              10490035
052314     MOVE PC-MDSE-INCL-IND                                        10500035
052315                             TO EP072-MDSE-INC-EXC-IND.           10510035
052316     MOVE XST00031-ACTL-STRT-TMST                                 10520035
052317                             TO EP072-STR-GRP-PROMO-STRT-TMST.    10530035
052318     MOVE XST00031-ACTL-END-TMST                                  10540035
052319                             TO EP072-STR-GRP-PROMO-END-TMST.     10550035
052320     MOVE XST00026-SOR-LAST-UPD-TMST                              10560035
052321                             TO EP072-SOR-LAST-UPD-TMST.          10570035
052322                                                                  10580035
052323     IF EP072-APPLY-NIGHTLY                                       10590035
052324       PERFORM 4000-WRITE-NIGHT-APPLY-RECORD                      10600035
052325     ELSE                                                         10610035
052326       MOVE PC-APPLY-NIGHTLY   TO EP072-APPLY-IND                 10620035
052327       PERFORM 4000-WRITE-NIGHT-APPLY-RECORD                      10630035
052328     END-IF.                                                      10640035
052329                                                                  10650035
052330*3100-EXIT.                                                       10660035
052331 EJECT.                                                           10670035
052332                                                                  10680035
052333*----------------------------------------------------------       10690035
052334* 4000-WRITE-NIGHT-APPLY-RECORD.                                  10700035
052335*     WRITES THE PROMO FULL FILE RECORD TO THE FULL FILE          10710035
052336*----------------------------------------------------------       10720035
052337 4000-WRITE-NIGHT-APPLY-RECORD.                                   10730035
052338                                                                  10740035
052339     WRITE PROMO-NIGHT-RECORD FROM EP072-PROMO-INTFC-RECORD.      10750035
052340                                                                  10760035
052350     ADD 1           TO PC-CNT-NIGHT-RECS                         10770035
052360                        PC-CNT-ALL-RECS.                          10780035
052370                                                                  10790035
052380*4000-EXIT.                                                       10800035
052390 EJECT.                                                           10810035
052400                                                                  10820035
052500*----------------------------------------------------------       10830035
052600* DATE ROUTINE TO SET UP THE PROCESS DATE IN                      10840035
052700* CCYYMMDD FORMAT.                                                10850035
052800*----------------------------------------------------------       10860035
052810 6100-DATE-ROUTINE.                                               10870035
052820                                                                  10880035
052830     INITIALIZE DPG51 DPG52 DPG53                                 10890035
052840                DPG54 DPG55 DPG56.                                10900035
052850                                                                  10910035
052860     SET DPG51-FISCAL-454-CALENDAR  TO TRUE.                      10920035
052870     SET DPG51-INCREMENT-DATE       TO TRUE.                      10930035
052880     SET DPG52-LK-DTE-ISO-FMT       TO TRUE.                      10940035
052890     MOVE 1                         TO DPG51-INCR-DECR-DAYS-9.    10950035
052900     MOVE EP111-CC-CRNT-DTE         TO DPG52-DB2-ISO-DATE-FMT.    10960035
053000                                                                  10970035
053100     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    10980035
053200                                             DPG54 DPG55 DPG56.   10990035
053210                                                                  11000035
053220     IF DPG54-SEVERE-ERROR OR DPG54-DATE-INVALID                  11010035
053230       DISPLAY '** ABEND **'                                      11020035
053240       DISPLAY '** PROGRAM = EPKUT355'                            11030035
053241       DISPLAY 'DATE = ' EP111-CC-CRNT-DTE                        11040035
053242       DISPLAY DPG54-ERROR-MESSAGE                                11050035
053243       MOVE 4019 TO PV-ABEND-CODE                                 11060035
053244       CALL 'ILBOABN0' USING PV-ABEND-CODE                        11070035
053245     END-IF.                                                      11080035
053246                                                                  11090035
053247     MOVE DPG55-DB2-ISO-DATE-FMT     TO EP111-CC-DATE-PLUS1.      11100035
053248                                                                  11110035
053249     INITIALIZE DPG51 DPG52 DPG53                                 11120035
053250                DPG54 DPG55 DPG56.                                11130035
053251                                                                  11140035
053252     SET DPG51-FISCAL-454-CALENDAR  TO TRUE.                      11150035
053253     SET DPG51-DECREMENT-DATE       TO TRUE.                      11160035
053254     SET DPG52-LK-DTE-ISO-FMT       TO TRUE.                      11170035
053255     MOVE 1                         TO DPG51-INCR-DECR-DAYS-9.    11180035
053256     MOVE EP113-CC-CRNT-DTE         TO DPG52-DB2-ISO-DATE-FMT.    11190035
053257                                                                  11200035
053258     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    11210035
053259                                             DPG54 DPG55 DPG56.   11220035
053260                                                                  11230035
053261     IF DPG54-SEVERE-ERROR OR DPG54-DATE-INVALID                  11240035
053262       DISPLAY '** ABEND **'                                      11250035
053263       DISPLAY '** PROGRAM = EPKUT355'                            11260035
053264       DISPLAY 'DATE = ' EP111-CC-CRNT-DTE                        11270035
053265       DISPLAY DPG54-ERROR-MESSAGE                                11280035
053266       MOVE 4019 TO PV-ABEND-CODE                                 11290035
053267       CALL 'ILBOABN0' USING PV-ABEND-CODE                        11300035
053268     END-IF.                                                      11310035
053269                                                                  11320035
053270     MOVE DPG55-DB2-ISO-DATE-FMT    TO EP113-CC-CRNT-DTE-MINUS1.  11330035
053271                                                                  11340035
053272*6100-EXIT.                                                       11350035
053273 EJECT.                                                           11360035
053274                                                                  11370035
053275*----------------------------------------------------------       11380035
053276* 9900-SQL-ABEND-ROUTINE.                                         11390035
053277*     SQL ABEND ROUTINE.                                          11400035
053278*----------------------------------------------------------       11410035
053279 9900-SQL-ABEND-ROUTINE.                                          11420035
053280                                                                  11430035
053290     DISPLAY '** ABEND     **'.                                   11440035
053300     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        11450035
053400     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              11460035
053500     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               11470035
053600                                                                  11480035
053700     COPY DPPD004.                                                11490035
053800     SET ABEND-4013-DB2-ERROR TO TRUE.                            11500035
053900     CALL 'ILBOABN0' USING ABEND-CODE.                            11510035
054000                                                                  11520035
054100*9900-EXIT.                                                       11530035
054200 EJECT.                                                           11540035
054300                                                                  11550035
054400*----------------------------------------------------------       11560035
054500* 9999-WRAPUP.                                                    11570035
054600*     END OF PROGRAM ROUTINE.  CLOSES ALL FILES AND DISPLAYS      11580035
054700*     ANY DATA FROM THE PROGRAM.                                  11590035
054800*----------------------------------------------------------       11600035
054900 9999-WRAPUP.                                                     11610035
055000                                                                  11620035
055100                                                                  11630035
055200     CLOSE CONTROL-CARD-CURR-PRICG-DTE                            11640035
055300           CONTROL-CARD-FUTRE-CORR-DTE                            11650035
055400           CONTROL-CARD-PGM-CURR-TMST                             11660035
055500           CONTROL-CARD-PGM-LAST-RUN-TMST                         11670035
055600           CONTROL-CARD-CRIT-EFF-DTE                              11680035
055700           PROMO-NIGHT-FILE.                                      11690035
055800                                                                  11700035
055900     DISPLAY ' '.                                                 11710035
056000     DISPLAY '*********************************************'.     11720035
056100     DISPLAY 'PROGRAM NAME: ' PC-CURRENT-PROGRAM-NAME.            11730035
056200     DISPLAY '*********************************************'.     11740035
056300     DISPLAY 'NUMBER OF NIGHT RECS WRITTEN: ' PC-CNT-NIGHT-RECS.  11750035
056400     DISPLAY 'NUMBER OF RECS FROM RMS QUERY:' PC-CNT-RMS-RECS.    11760035
056500     DISPLAY 'NUMBER OF RECS FROM ADHC QUERY: ' PC-CNT-ADHOC-RECS.11770035
056600     DISPLAY 'ALL RECS WRITTEN: ' PC-CNT-ALL-RECS.                11780035
056700     DISPLAY '*********************************************'.     11790035
056800                                                                  11800035
056900*9999-EXIT.                                                       11810035
057000 EJECT.                                                           11820035
057100                                                                  11830035
