000100*----------------------------------------------------------       00010031
000200 IDENTIFICATION DIVISION.                                         00020031
000300*----------------------------------------------------------       00030031
000400 PROGRAM-ID.    EPKUP105.                                         00040031
000500 AUTHOR.        SANDY POTTER.                                     00050031
000600 DATE-WRITTEN.  DECEMBER 9, 2003.                                 00060031
000700                                                                  00070031
000800*----------------------------------------------------------       00080031
000900*      EXTRACT PLU & XREF SKU DELETES AND REMOVE FROM TEMP TABLE  00090031
001000*----------------------------------------------------------       00100031
001100* THIS PROGRAM FIRST PROCESS A FILE OF NEWLY EXCLUDED SKUS AND    00110031
001200* CREATES A PLU DELETE RECORD.  FOR EACH RELATED UPC, IT ALSO     00120031
001300* CREATES AN XREF DELETE RECORD.                                  00130031
001400* FOR THE NEW SQL SERVER DATABASE AT THE STORES, THE PROGRAM      00140031
001500* ALSO CREATES A SKU DELETE RECORD FOR EACH NEWLY EXCLUDED SKU,   00150031
001600* AS WELL AS CREATING XREF DELETE RECORDS FOR EACH RELATED UPC.   00160031
001700*                                                                 00170031
001800* THEN THIS PROGRAM USES A CURSOR TO FETCH ALL SKU/UPCS THAT      00180031
001900* HAVE BEEN DELETED SINCE THE LAST RUN.  THESE SKU/UPC VALUES WERE00190031
002000* SAVED IN A TEMPORARY TABLE (STRUCTURE IS PERMANENT, BUT DATA IS 00200031
002100* TEMPORARY) WHEN THE SKUS WERE PHYSICALLY DELETED DUE TO MESSAG- 00210031
002200* ING FROM THE SOR.  FOR EACH UNIQUE SKU, A PLU DELETE RECORD IS  00220031
002300* CREATED.  FOR EACH UPC, AN XREF DELETE RECORD IS CREATED.  ALL  00230031
002400* FETCHED ROWS ARE THEN DELETED AND THE UPDATES ARE COMMITTED.    00240031
002500* FOR THE NEW SQL SERVER DATABASE AT THE STORES, THE PROGRAM      00250031
002600* ALSO CREATES A SKU DELETE RECORD FOR EACH UNIQUE SKU,           00260031
002700* AS WELL AS CREATING AN XREF DELETE RECORD FOR EACH UPC.         00270031
002800*                                                                 00280031
002900* THE RETURN CODE IS SET TO 4 IF ANY RECORDS WERE READ FROM THE   00290031
003000* EXCLUDED SKUS FILE.  THIS IS A GOOD RETURN CODE.                00300031
003100*----------------------------------------------------------       00310031
003200* HISTORY LOG:                                                    00320031
003300*                                                                 00330031
003400* DATE: MM/DD/YY                                                  00340031
003500* WR/IR#:                                                         00350031
003600* PROGRAMMER:                                                     00360031
003700* DESCRIPTION:                                                    00370031
003800*----------------------------------------------------------       00380031
003900 ENVIRONMENT DIVISION.                                            00390031
004000*----------------------------------------------------------       00400031
004100 CONFIGURATION SECTION.                                           00410031
004200 SOURCE-COMPUTER. IBM-3090.                                       00420031
004300 OBJECT-COMPUTER. IBM-3090.                                       00430031
004400                                                                  00440031
004500 INPUT-OUTPUT SECTION.                                            00450031
004600                                                                  00460031
004700 FILE-CONTROL.                                                    00470031
004800                                                                  00480031
004900     SELECT CONTROL-CARD-TOMORROW                                 00490031
005000            ASSIGN TO INP01.                                      00500031
005100                                                                  00510031
005200     SELECT EXCLUDED-SKUS                                         00520031
005300            ASSIGN TO INP02.                                      00530031
005400                                                                  00540031
005500     SELECT SKU-CHG-GLOBAL-FILE                                   00550031
005600            ASSIGN TO OUT01.                                      00560031
005700                                                                  00570031
005800     SELECT XREF-SQLS-GLOBAL-FILE                                 00580031
005900            ASSIGN TO OUT02.                                      00590031
006000                                                                  00600031
006100*----------------------------------------------------------       00610031
006200 DATA DIVISION.                                                   00620031
006300*----------------------------------------------------------       00630031
006400 FILE SECTION.                                                    00640031
006500                                                                  00650031
006600 FD  CONTROL-CARD-TOMORROW                                        00660031
006700     RECORDING MODE F                                             00670031
006800     BLOCK CONTAINS 0 RECORDS                                     00680031
006900     LABEL RECORDS ARE OMITTED                                    00690031
007000     DATA RECORD IS CONTROL-TOMORROW-RECORD.                      00700031
007100 01  CONTROL-TOMORROW-RECORD      PIC  X(080).                    00710031
007200                                                                  00720031
007300 FD  EXCLUDED-SKUS                                                00730031
007400     RECORDING MODE F                                             00740031
007500     BLOCK CONTAINS 0 RECORDS                                     00750031
007600     LABEL RECORDS ARE OMITTED                                    00760031
007700     DATA RECORD IS EXCLUDED-SKU-RECORD.                          00770031
007800 01  EXCLUDED-SKU-RECORD       PIC  X(050).                       00780031
007900                                                                  00790031
008000 FD  SKU-CHG-GLOBAL-FILE                                          00800031
008100     RECORDING MODE F                                             00810031
008200     BLOCK CONTAINS 0 RECORDS                                     00820031
008300     LABEL RECORDS ARE OMITTED                                    00830031
008400     DATA RECORD IS SKU-CHG-GLOBAL-RECORD.                        00840031
008500 01  SKU-CHG-GLOBAL-RECORD           PIC X(170).                  00850031
008600                                                                  00860031
008700 FD  XREF-SQLS-GLOBAL-FILE                                        00870031
008800     RECORDING MODE IS F                                          00880031
008900     BLOCK CONTAINS 0 RECORDS                                     00890031
009000     LABEL RECORDS ARE STANDARD                                   00900031
009100     DATA RECORD IS XREF-SQLS-GLOBAL-RECORD.                      00910031
009200 01  XREF-SQLS-GLOBAL-RECORD                PIC  X(80).           00920031
009300                                                                  00930031
009400 WORKING-STORAGE SECTION.                                         00940031
009500*----------------------------------------------------             00950031
009600 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      00960031
009700                                                  COMP SYNC.      00970031
009800     88  AC-DB2-ERROR                             VALUE +4013.    00980031
009900     88  AC-CTRL-CARD-ERROR                       VALUE +4003.    00990031
010000                                                                  01000031
010100*---------------------------------------------                    01010031
010200* PC- PROGRAM CONSTANTS                                           01020031
010300*---------------------------------------------                    01030031
010400 01  PC-PROGRAM-CONSTANTS.                                        01040031
010500     05  PC-PROGRAM-NAME              PIC X(08)  VALUE 'EPKUP105'.01050031
010600     05  PC-MAX-RETRIES               PIC S9(04) VALUE +5 COMP.   01060031
010700     05  PC-STR-GRP-TYP-CDE-CORP      PIC 9(05)  VALUE 1000.      01070031
010800     05  PC-STR-GRP-ID-CORP           PIC 9(10)  VALUE 0000000001.01080031
010900                                                                  01090031
011000*---------------------------------------------                    01100031
011100* PS- PROGRAM SWITCHES                                            01110031
011200*---------------------------------------------                    01120031
011300 01  PS-PROGRAM-SWITCHES.                                         01130031
011400     05  PS-END-OF-DEL-SKU-CURSOR-SW   PIC X(01)  VALUE 'Y'.      01140031
011500         88  PS-END-OF-DEL-SKU-CSR                VALUE 'N'.      01150031
011600         88  PS-MORE-DEL-SKU-CSR                  VALUE 'Y'.      01160031
011700     05  PS-END-OF-CNTL-CARD1-SW       PIC X(01)  VALUE 'Y'.      01170031
011800         88  PS-END-OF-CNTL-CARD1                 VALUE 'N'.      01180031
011900         88  PS-MORE-CNTL-CARD1                   VALUE 'Y'.      01190031
012000     05  PS-END-OF-EXCL-SKUS-SW        PIC X(01)  VALUE 'Y'.      01200031
012100         88  PS-END-OF-EXCL-SKUS                  VALUE 'N'.      01210031
012200         88  PS-MORE-EXCL-SKUS                    VALUE 'Y'.      01220031
012300     05  PS-END-OF-EXCL-UPCS-SW        PIC X(01)  VALUE 'Y'.      01230031
012400         88  PS-END-OF-EXCL-UPCS                  VALUE 'N'.      01240031
012500         88  PS-MORE-EXCL-UPCS                    VALUE 'Y'.      01250031
012600                                                                  01260031
012700*---------------------------------------------                    01270031
012800* PV- PROGRAM WORKING VARIABLES                                   01280031
012900*---------------------------------------------                    01290031
013000 01  PV-PROGRAM-VARIABLES.                                        01300031
013100     05  PV-PARAGRAPH-NAME             PIC X(30)  VALUE SPACE.    01311033
013200     05  PV-DB2-OPERATION              PIC X(30)  VALUE SPACE.    01320031
013300     05  PV-OPERATION-MSG-1            PIC X(40)  VALUE SPACE.    01330031
013400     05  PV-OPERATION-MSG-2            PIC X(40)  VALUE SPACE.    01340031
013500     05  PV-SQL-SUB                    PIC S9(4) COMP  VALUE +0.  01350031
013600     05  PV-INTR-UPC-ID-NUM            PIC S9(11) COMP  VALUE 0.  01360031
013700     05  PV-SAVE-INTR-UPC-ID           PIC S9(9) COMP  VALUE 0.   01370031
011200     05  PV-TMST                  PIC X(26)     VALUE SPACES.     01371034
011100     05  PV-HOLD-TMST             PIC X(26)     VALUE SPACES.     01372034
013800                                                                  01380031
013900*-----------------------------------------------------------      01390031
014000* PV- PROGRAM COUNTERS                                            01400031
014100*-----------------------------------------------------------      01410031
014200 01  PV-PROGRAM-COUNTERS.                                         01420031
014300     05  PV-CNT-EXCL-SKU-RECS          PIC 9(9)   VALUE 0.        01430031
014400     05  PV-CNT-EXCL-UPC-FETCH         PIC 9(9)   VALUE 0.        01440031
014500     05  PV-CNT-DEL-SKU-FETCH          PIC 9(9)   VALUE 0.        01450031
014600     05  PV-CNT-DEL-SKU-DELETE         PIC 9(9)   VALUE 0.        01460031
014700     05  PV-CNT-XREF-GLOBAL            PIC 9(9)   VALUE 0.        01470031
014800     05  PV-CNT-PLU-DEL-RECS           PIC 9(9)   VALUE 0.        01480031
014900     05  PV-CNT-XREF-EXCL-RECS         PIC 9(9)   VALUE 0.        01490031
015000     05  PV-CNT-XREF-DEL-RECS          PIC 9(9)   VALUE 0.        01500031
015100     05  PV-CNT-SKU-GLOBAL             PIC 9(9)   VALUE 0.        01510031
015200     05  PV-CNT-SKU-EXCL-RECS          PIC 9(9)   VALUE 0.        01520031
015300     05  PV-CNT-SKU-DELTD-RECS         PIC 9(9)   VALUE 0.        01530031
015400     05  PV-CNT-SQLS-XREF-GLOBAL       PIC 9(9)   VALUE 0.        01540031
015500     05  PV-CNT-SQLS-XREF-EXCL-RECS    PIC 9(9)   VALUE 0.        01550031
015600     05  PV-CNT-SQLS-XREF-DEL-RECS     PIC 9(9)   VALUE 0.        01560031
015600     05  PV-CNT-COMMITS                PIC 9(9)   VALUE 0.        01561035
015700                                                                  01570031
015800*---------------------------------------------                    01580031
015900* INPUT FILE LAYOUT - EXCLUDED SKUS                               01590031
016000*---------------------------------------------                    01600031
016100     COPY EPRD132.                                                01610031
016200                                                                  01620031
016300*--------------------------------------------------------------*  01630031
016400* SQL SERVER UPC/SKU XREF FILE LAYOUT.                            01640031
016500*--------------------------------------------------------------*  01650031
016600     COPY EPRD218.                                                01660031
016700                                                                  01670031
016800*--------------------------------------------------------------*  01680031
016900* EPRD219 SKU DATA RECORD LAYOUT                                  01690031
017000*--------------------------------------------------------------*  01700031
017100     COPY EPRD219.                                                01710031
017200                                                                  01720031
017300*----------------------------------------------------------       01730031
017400* CONTROL CARD LAYOUT FOR TOMORROW'S DATE                         01740031
017500*----------------------------------------------------------       01750031
017600     COPY EPWS112.                                                01760031
017700                                                                  01770031
017800*---------------------------------------------                    01780031
017900*  DB2 TABLE XST00012 - UPC TABLE(XST_UPC)                        01790031
018000*---------------------------------------------                    01800031
018100     EXEC SQL                                                     01810031
018200          INCLUDE XST00012                                        01820031
018300     END-EXEC.                                                    01830031
018400                                                                  01840031
018500*---------------------------------------------                    01850031
018600*  TEMP DB2 TABLE EPT00016 - DELETED SKUS TABLE(EPTW_DLTD_SKU)    01860031
018700*---------------------------------------------                    01870031
018800     EXEC SQL                                                     01880031
018900          INCLUDE EPT00016                                        01890031
019000     END-EXEC.                                                    01900031
019100                                                                  01910031
016000*----------------------------------------------------------------*01911033
016100*      TCKRSTCNTL TABLE LAYOUT                                    01912033
016200*----------------------------------------------------------------*01913033
016300     EXEC SQL                                                     01914033
016400         INCLUDE TCKRSTCN                                         01915033
016500     END-EXEC.                                                    01916033
016600                                                                  01917033
016700*----------------------------------------------------------------*01918033
016800*      TCKRSTINF TABLE LAYOUT                                     01919033
016900*----------------------------------------------------------------*01919133
017000     EXEC SQL                                                     01919233
017100         INCLUDE TCKRSTIN                                         01919333
017200     END-EXEC.                                                    01919433
016000                                                                  01919533
019200*---------------------------------------------                    01920031
019300*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            01930031
019400*---------------------------------------------                    01940031
019500     COPY DPWS004.                                                01950031
019600                                                                  01960031
019700*---------------------------------------------                    01970031
019800*  DB2 COMMUNICATION AREA.                                        01980031
019900*---------------------------------------------                    01990031
020000     EXEC SQL                                                     02000031
020100          INCLUDE SQLCA                                           02010031
020200     END-EXEC.                                                    02020031
020300                                                                  02030031
020400*---------------------------------------------                    02040031
020500*  EXCLUDED UPC SKU CURSOR WILL FETCH ALL UPCS FOR A NEWLY        02050031
020600*  EXCLUDED SKU (UPCS MARKED AS DELETED ARE NOT FETCHED BECAUSE   02060031
020700*  THEY MIGHT HAVE BEEN REUSED, AND DELETING THEM WOULD CAUSE     02070031
020800*  PROBLEMS).                                                     02080031
020900*---------------------------------------------                    02090031
021000     EXEC SQL                                                     02100031
021100       DECLARE EXCL-UPC-CSR CURSOR FOR                            02110031
021200            SELECT U.UPC_NBR                                      02120031
021300            FROM   XST_UPC      U                                 02130031
021400            WHERE  U.INTR_UPC_ID    = :XST00012-INTR-UPC-ID       02140031
021500              AND  U.LAST_ACTN_CDE <> 'D'                         02150031
021600              WITH UR                                             02160031
021700     END-EXEC.                                                    02170031
021800                                                                  02180031
021900*---------------------------------------------                    02190031
022000*  DELETED UPC / SKU CURSOR WILL FETCH ALL DELETED SKU / UPC      02200031
022100*  VALUES.                                                        02210031
022200*---------------------------------------------                    02220031
022300     EXEC SQL                                                     02230031
022400       DECLARE DELETED-SKU-CSR CURSOR WITH HOLD FOR               02240037
022500            SELECT INTR_UPC_ID                                    02250031
022600                  ,UPC_NBR                                        02260031
022700                  ,SKU_NBR                                        02270031
022800            FROM   EPTW_DLTD_SKU                                  02280031
022900            WHERE  'A' = 'A'                                      02290031
023000            ORDER BY INTR_UPC_ID                                  02300031
023100              WITH UR                                             02310031
023200     END-EXEC.                                                    02320031
023300                                                                  02330031
023400*----------------------------------------------------------       02340031
023500 PROCEDURE DIVISION.                                              02350031
023600*----------------------------------------------------------       02360031
023700 0000-MAINLINE.                                                   02370031
023800                                                                  02380031
023900     PERFORM 1000-INITIALIZATION.                                 02390031
024000                                                                  02400031
024100*    * PROCESS EXCLUDED SKUS FROM FILE *                          02410031
024200*    PERFORM 8000-READ-EXCLUDED-SKUS.                             02420033
024300                                                                  02430031
024400     PERFORM 2000-PROCESS-EXCLUDES                                02440031
024500         UNTIL PS-END-OF-EXCL-SKUS.                               02450031
024600                                                                  02460031
024700*    * PROCESS DELETED SKUS FROM TEMPORARY TABLE *                02470031
024800     PERFORM 6300-OPEN-DELETED-SKU-CSR.                           02480031
024900     PERFORM 6400-FETCH-DELETED-SKU-CSR.                          02490031
021700     PERFORM X500-SET-CHECKPOINT-TIME.                            02501033
021800                                                                  02502033
025100     PERFORM 3000-PROCESS-CURSOR                                  02510031
025200         UNTIL PS-END-OF-DEL-SKU-CSR.                             02520031
025300                                                                  02530031
025400     PERFORM 6500-CLOSE-DELETED-SKU-CSR.                          02540031
025500                                                                  02550031
025600*    * COMMIT TO ALL DELETES AGAINST THE TEMPORARY TABLE *        02560031
025700     PERFORM 9000-DB2-COMMIT.                                     02570031
025800                                                                  02580031
025900*    * CLOSE FILES, DISPLAY COUNTS, AND POSSIBLY SET RETURN CODE *02590031
026000     PERFORM 9100-END-OF-JOB-ROUTINE.                             02600031
026100                                                                  02610031
026200     GOBACK.                                                      02620031
026300                                                                  02630031
026400*0000-EXIT.                                                       02640031
026500                                                                  02650031
026600*----------------------------------------------------------       02660031
026700* 1000-INITIALIZATION.                                            02670031
026800*      OPENS UP THE CONTROL CARD INPUT FILE AND READS IT, THEN    02680031
026900*      CLOSES IT.  OPENS THE EXCLUDED SKUS FILE AND BOTH OUTPUT   02690031
027000*      FILES.                                                     02700031
027100*----------------------------------------------------------       02710031
027200 1000-INITIALIZATION.                                             02720031
027300                                                                  02730031
027500                                                                  02750031
027600     DISPLAY ' '.                                                 02760031
027700     DISPLAY '*********************************************'.     02770031
027800     DISPLAY '       PROGRAM NAME: ' PC-PROGRAM-NAME.             02780031
027900     DISPLAY '*********************************************'.     02790031
028000     DISPLAY ' '.                                                 02800031
028100                                                                  02810031
027400     OPEN INPUT  CONTROL-CARD-TOMORROW.                           02811033
028200     PERFORM 1100-READ-TOMORROW-RECORD.                           02820031
028400     CLOSE CONTROL-CARD-TOMORROW.                                 02840031
028500                                                                  02850031
028600     OPEN INPUT  EXCLUDED-SKUS.                                   02860031
028700     OPEN OUTPUT                                                  02870031
028800                 SKU-CHG-GLOBAL-FILE                              02880031
028900                 XREF-SQLS-GLOBAL-FILE.                           02890031
021600                                                                  02899433
029000                                                                  02900031
029100*1000-EXIT.                                                       02910031
029200                                                                  02920031
029300*--------------------------------------------------------------*  02930031
029400* 1100-READ-TOMORROW-RECORD.                                      02940031
029500*      READ CONTROL CARD EPCC112. THIS CONTROL CARD CONTAINS      02950031
029600*      TOMORROW'S DATE BASED ON THE JOB RUN DATE.                 02960031
029700*--------------------------------------------------------------*  02970031
029800 1100-READ-TOMORROW-RECORD.                                       02980031
029900                                                                  02990031
030000     READ CONTROL-CARD-TOMORROW                                   03000031
030100          INTO CC-EPCC112-CONTROL-CARD                            03010031
030200       AT END                                                     03020031
030300          SET PS-END-OF-CNTL-CARD1 TO TRUE.                       03030031
030400                                                                  03040031
030500     IF PS-END-OF-CNTL-CARD1                                      03050031
030600         MOVE '1100-READ-TOMORROW-RECORD' TO PV-PARAGRAPH-NAME    03060031
030700         MOVE '** CONTROL FILE IS EMPTY'  TO PV-OPERATION-MSG-1   03070031
030800         SET AC-CTRL-CARD-ERROR           TO TRUE                 03080031
030900         PERFORM 9800-ABEND                                       03090031
031000     ELSE                                                         03100031
031100         DISPLAY '** TOMORROW DATE CONTROL CARD    **'            03110031
031200         DISPLAY '** EPCC112     **  = ' CC-EPCC112-TOMORROW-DATE 03120031
031300         DISPLAY ' '                                              03130031
031400     END-IF.                                                      03140031
031500                                                                  03150031
031600*1100-EXIT.                                                       03160031
031700                                                                  03170031
031800*----------------------------------------------------------       03180031
031900* 2000-PROCESS-EXCLUDES.                                          03190031
032000*      WRITES A PLU RECORD, OPENS AND PROCESSES THE CURSOR TO GET 03200031
032100*      ALL UPCS FOR THE SKU, WRITING AN XREF RECORD FOR EACH.  IT 03210031
032200*      THEN READS THE NEXT EXCLUDED SKUS RECORD.                  03220031
032300*----------------------------------------------------------       03230031
032400 2000-PROCESS-EXCLUDES.                                           03240031
032500                                                                  03250031
032600*    * POPULATE FIELDS - WRITE SKU DELETE RECORD FOR SQL SERVER*  03260031
032700     PERFORM 5000-BUILD-WRITE-EXCL-SKU.                           03270031
032800                                                                  03280031
032900*    * FETCH THROUGH UPCS, WRITING XREF DELETE RECORDS *          03290031
033000                                                                  03300031
033100     SET PS-MORE-EXCL-UPCS   TO TRUE.                             03310031
033200     MOVE EP132-INTR-UPC-ID  TO PV-INTR-UPC-ID-NUM.               03320031
033300     MOVE PV-INTR-UPC-ID-NUM TO XST00012-INTR-UPC-ID.             03330031
033400     PERFORM 6000-OPEN-EXCL-UPC.                                  03340031
033500     PERFORM 6100-FETCH-EXCL-UPC.                                 03350031
033600                                                                  03360031
033700     PERFORM 2100-PROCESS-EXCL-UPC                                03370031
033800         UNTIL PS-END-OF-EXCL-UPCS.                               03380031
033900                                                                  03390031
034000     PERFORM 6200-CLOSE-EXCL-UPC.                                 03400031
034100                                                                  03410031
034200     PERFORM 8000-READ-EXCLUDED-SKUS.                             03420031
034300                                                                  03430031
034400*2000-EXIT.                                                       03440031
034500                                                                  03450031
034600*----------------------------------------------------------       03460031
034700* 2100-PROCESS-EXCL-UPC.                                          03470031
034800*      PROCESS THE UPC FOR AN EXCLUDED SKU, WRITING AN XREF RECORD03480031
034900*      AND FETCHING THE NEXT ROW.                                 03490031
035000*----------------------------------------------------------       03500031
035100 2100-PROCESS-EXCL-UPC.                                           03510031
035200                                                                  03520031
035300     ADD +1 TO PV-CNT-XREF-EXCL-RECS.                             03530031
035400                                                                  03540031
035500     PERFORM 5200-BLD-WRITE-SQLS-XREF-EXCL.                       03550031
035600                                                                  03560031
035700     PERFORM 6100-FETCH-EXCL-UPC.                                 03570031
035800                                                                  03580031
035900*2100-EXIT.                                                       03590031
036000                                                                  03600031
036100*----------------------------------------------------------       03610031
036200* 3000-PROCESS-CURSOR.                                            03620031
036300*      PROCESSES EACH DELETED SKU/UPC FROM THE TEMPORARY DELETED  03630031
036400*      SKUS TABLE.  CREATES PLU DELETE RECORD FOR EACH UNIQUE SKU 03640031
036500*      AND AN XREF DELETE RECORD FOR EACH UPC NUMBER.             03650031
036600*----------------------------------------------------------       03660031
036700 3000-PROCESS-CURSOR.                                             03670031
036800                                                                  03680031
036900     IF EPT00016-INTR-UPC-ID = PV-SAVE-INTR-UPC-ID                03690031
037000         CONTINUE                                                 03700031
037100     ELSE                                                         03710031
037200*        * POPULATE AND WRITE PLU DELETE RECORD *                 03720031
037300                                                                  03730031
037400         MOVE EPT00016-INTR-UPC-ID TO PV-SAVE-INTR-UPC-ID         03740031
037500         MOVE EPT00016-INTR-UPC-ID TO PV-INTR-UPC-ID-NUM          03750031
037600         ADD +1 TO PV-CNT-PLU-DEL-RECS                            03760031
037700                                                                  03770031
037800         PERFORM 5100-BUILD-WRITE-DELETED-SKU                     03780031
037900     END-IF.                                                      03790031
038000                                                                  03800031
038100*    * POPULATE AND WRITE XREF DELETE RECORD *                    03810031
038200                                                                  03820031
038300     ADD +1 TO PV-CNT-XREF-DEL-RECS.                              03830031
038400                                                                  03840031
038500     PERFORM 5300-BUILD-WRITE-SQLS-XREF-DLT.                      03850031
038600                                                                  03860031
038700*    * DELETE TEMPORARY ROW FROM TABLE *                          03870031
038800     PERFORM 3100-DELETE-TEMP.                                    03880031
023000     PERFORM X100-CHECKPOINT-CHECK.                               03881033
038900                                                                  03890031
039000*    * FETCH NEXT DELETED SKU ROW FROM TEMP TABLE *               03900031
039100     PERFORM 6400-FETCH-DELETED-SKU-CSR.                          03910031
039200                                                                  03920031
039300*3000-EXIT.                                                       03930031
039400                                                                  03940031
039500*------------------------------------------------------           03950031
039600* 3100-DELETE-TEMP.                                               03960031
039700*      DELETES THE ROW JUST PROCESSED FROM THE TEMPORARY DELETED  03970031
039800*      SKUS TABLE.  BECAUSE IT IS A TEMPORARY TABLE, INTENDED     03980031
039900*      SIMPLY TO PASS INFORMATION ABOUT DELETES BETWEEN THE XS    03990031
040000*      PROCESS AND THE EP PROCESS, IT CAN BE DELETED ONCE IT HAS  04000031
040100*      BEEN PROCESSED.                                            04010031
040200*------------------------------------------------------           04020031
040300 3100-DELETE-TEMP.                                                04030031
040400                                                                  04040031
040500     PERFORM                                                      04050031
040600         WITH TEST AFTER                                          04060031
040700         VARYING PV-SQL-SUB                                       04070031
040800         FROM 1 BY 1                                              04080031
040900         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 04090031
041000                   OR  SQLCODE = 0)                               04100031
041100                                                                  04110031
041200         EXEC SQL                                                 04120031
041300             DELETE FROM EPTW_DLTD_SKU                            04130031
041400             WHERE INTR_UPC_ID = :EPT00016-INTR-UPC-ID            04140031
041500               AND UPC_NBR     = :EPT00016-UPC-NBR                04150031
041600         END-EXEC                                                 04160031
041700                                                                  04170031
041800         EVALUATE TRUE                                            04180031
041900             WHEN SQLCODE = -904                                  04190031
042000             WHEN SQLCODE = -911                                  04200031
042100             WHEN SQLCODE = -913                                  04210031
042200                 CONTINUE                                         04220031
042300             WHEN SQLCODE = 0                                     04230031
042400                 ADD +1 TO PV-CNT-DEL-SKU-DELETE                  04240031
042500             WHEN SQLWARN NOT EQUAL SPACES                        04250031
042600             WHEN SQLCODE NOT EQUAL ZERO                          04260031
042700                 MOVE '3100-DELETE-TEMP' TO PV-PARAGRAPH-NAME     04270031
042800                 MOVE 'DELETE FROM TEMP TABLE' TO PV-DB2-OPERATION04280031
042900                 PERFORM 9200-SQL-ABEND                           04290031
043000         END-EVALUATE                                             04300031
043100     END-PERFORM.                                                 04310031
043200                                                                  04320031
043300     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        04330031
043400         MOVE '3100-DELETE-TEMP'        TO PV-PARAGRAPH-NAME      04340031
043500         MOVE 'DELETE RETRIES EXCEEDED' TO PV-DB2-OPERATION       04350031
043600         PERFORM 9200-SQL-ABEND                                   04360031
043700     END-IF.                                                      04370031
043800                                                                  04380031
043900*3100-EXIT.                                                       04390031
044000                                                                  04400031
044100*----------------------------------------------------------       04410031
044200* 5000-BUILD-WRITE-EXCL-SKU.                                      04420031
044300*      BUILDS OUTPUT RECORD FOR SKU DELETE, AND WRITES OUTPUT     04430031
044400*      RECORD FOR SQL SERVER, FOR EXCLUDED SKUS.                  04440031
044500*----------------------------------------------------------       04450031
044600 5000-BUILD-WRITE-EXCL-SKU.                                       04460031
044700                                                                  04470031
044800     PERFORM 7200-POPULATE-COMMON-SKU.                            04480031
044900                                                                  04490031
045000     MOVE EP132-INTR-UPC-ID TO EP219-INTR-UPC-ID.                 04500031
045100     MOVE EP132-SKU-NBR     TO EP219-SKU-NBR.                     04510031
045200                                                                  04520031
045300     PERFORM 8300-WRITE-SKU-GLOBAL-REC.                           04530031
045400     ADD +1 TO PV-CNT-SKU-EXCL-RECS.                              04540031
045500                                                                  04550031
045600*5000-EXIT.                                                       04560031
045700*----------------------------------------------------------       04570031
045800* 5100-BUILD-WRITE-DELETED-SKU.                                   04580031
045900*      BUILDS OUTPUT RECORD FOR SKU DELETE, AND WRITES OUTPUT     04590031
046000*      RECORD FOR SQL SERVER, FOR EXCLUDED SKUS.                  04600031
046100*----------------------------------------------------------       04610031
046200 5100-BUILD-WRITE-DELETED-SKU.                                    04620031
046300                                                                  04630031
046400     PERFORM 7200-POPULATE-COMMON-SKU.                            04640031
046500                                                                  04650031
046600     MOVE EPT00016-SKU-NBR         TO EP219-SKU-NBR.              04660031
046700     MOVE PV-INTR-UPC-ID-NUM       TO EP219-INTR-UPC-ID.          04670031
046800                                                                  04680031
046900     PERFORM 8300-WRITE-SKU-GLOBAL-REC.                           04690031
047000     ADD +1 TO PV-CNT-SKU-DELTD-RECS.                             04700031
047100                                                                  04710031
047200*5100-EXIT.                                                       04720031
047300*----------------------------------------------------------       04730031
047400* 5200-BLD-WRITE-SQLS-XREF-EXCL.                                  04740031
047500*      BUILDS OUTPUT RECORD FOR XREF FOR EXCLUDED SKU,            04750031
047600*      AND WRITES OUTPUT RECORD FOR SQL SERVER.                   04760031
047700*----------------------------------------------------------       04770031
047800 5200-BLD-WRITE-SQLS-XREF-EXCL.                                   04780031
047900                                                                  04790031
048000     PERFORM 7300-POPULATE-COMMON-SQLS-XREF.                      04800031
048100                                                                  04810031
048200     MOVE XST00012-UPC-NBR  TO EP218-UPC-NBR.                     04820031
048300     MOVE EP132-SKU-NBR     TO EP218-SKU-NBR.                     04830031
048400                                                                  04840031
048500     PERFORM 8400-WRITE-SQLS-XREF-GLBL-REC.                       04850031
048600     ADD +1 TO PV-CNT-SQLS-XREF-EXCL-RECS.                        04860031
048700                                                                  04870031
048800*5200-EXIT.                                                       04880031
048900*----------------------------------------------------------       04890031
049000* 5300-BUILD-WRITE-SQLS-XREF-DLT.                                 04900031
049100*      BUILDS OUTPUT RECORD FOR XREF FOR DELETED SKU / UPC,       04910031
049200*      AND WRITES OUTPUT RECORD FOR SQL SERVER.                   04920031
049300*----------------------------------------------------------       04930031
049400 5300-BUILD-WRITE-SQLS-XREF-DLT.                                  04940031
049500                                                                  04950031
049600     PERFORM 7300-POPULATE-COMMON-SQLS-XREF.                      04960031
049700                                                                  04970031
049800     MOVE EPT00016-UPC-NBR     TO EP218-UPC-NBR.                  04980031
049900     MOVE EPT00016-SKU-NBR     TO EP218-SKU-NBR.                  04990031
050000                                                                  05000031
050100     PERFORM 8400-WRITE-SQLS-XREF-GLBL-REC.                       05010031
050200     ADD +1 TO PV-CNT-SQLS-XREF-DEL-RECS.                         05020031
050300                                                                  05030031
050400*5300-EXIT.                                                       05040031
050500*----------------------------------------------------------       05050031
050600* 6000-OPEN-EXCL-UPC.                                             05060031
050700*      OPEN THE CURSOR OF UPCS FOR AN EXCLUDED SKU.               05070031
050800*----------------------------------------------------------       05080031
050900 6000-OPEN-EXCL-UPC.                                              05090031
051000                                                                  05100031
051100     PERFORM                                                      05110031
051200         WITH TEST AFTER                                          05120031
051300         VARYING PV-SQL-SUB                                       05130031
051400         FROM 1 BY 1                                              05140031
051500         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 05150031
051600                   OR  SQLCODE = 0)                               05160031
051700                                                                  05170031
051800           EXEC SQL                                               05180031
051900              OPEN EXCL-UPC-CSR                                   05190031
052000           END-EXEC                                               05200031
052100                                                                  05210031
052200         EVALUATE TRUE                                            05220031
052300             WHEN SQLCODE = -904                                  05230031
052400             WHEN SQLCODE = -911                                  05240031
052500             WHEN SQLCODE = -913                                  05250031
052600             WHEN SQLCODE = 0                                     05260031
052700                 CONTINUE                                         05270031
052800             WHEN SQLWARN0 NOT EQUAL SPACE                        05280031
052900             WHEN SQLCODE NOT EQUAL ZERO                          05290031
053000                 MOVE '6000-OPEN-EXCL-UPC' TO PV-PARAGRAPH-NAME   05300031
053100                 MOVE 'ERROR ON OPEN OF EXCL UPC CURSOR'          05310031
053200                                           TO PV-DB2-OPERATION    05320031
053300                 PERFORM 9200-SQL-ABEND                           05330031
053400         END-EVALUATE                                             05340031
053500     END-PERFORM.                                                 05350031
053600                                                                  05360031
053700     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        05370031
053800         MOVE '6000-OPEN-EXCL-UPC'    TO PV-PARAGRAPH-NAME        05380031
053900         MOVE 'OPEN RETRIES EXCEEDED' TO PV-DB2-OPERATION         05390031
054000         PERFORM 9200-SQL-ABEND                                   05400031
054100     END-IF.                                                      05410031
054200                                                                  05420031
054300*6000-EXIT.                                                       05430031
054400                                                                  05440031
054500*----------------------------------------------------------       05450031
054600* 6100-FETCH-EXCL-UPC.                                            05460031
054700*      FETCH THE EXCLUDED UPCS CURSOR.                            05470031
054800*----------------------------------------------------------       05480031
054900 6100-FETCH-EXCL-UPC.                                             05490031
055000                                                                  05500031
055100     PERFORM                                                      05510031
055200         WITH TEST AFTER                                          05520031
055300         VARYING PV-SQL-SUB                                       05530031
055400         FROM 1 BY 1                                              05540031
055500         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 05550031
055600                   OR  SQLCODE = 0                                05560031
055700                   OR  SQLCODE = +100)                            05570031
055800                                                                  05580031
055900           EXEC SQL                                               05590031
056000              FETCH EXCL-UPC-CSR                                  05600031
056100              INTO  :XST00012-UPC-NBR                             05610031
056200           END-EXEC                                               05620031
056300                                                                  05630031
056400          EVALUATE TRUE                                           05640031
056500              WHEN SQLCODE = -904                                 05650031
056600              WHEN SQLCODE = -911                                 05660031
056700              WHEN SQLCODE = -913                                 05670031
056800                  CONTINUE                                        05680031
056900              WHEN SQLCODE = ZERO                                 05690031
057000                  ADD +1 TO PV-CNT-EXCL-UPC-FETCH                 05700031
057100              WHEN SQLCODE = +100                                 05710031
057200                  SET PS-END-OF-EXCL-UPCS    TO TRUE              05720031
057300              WHEN SQLWARN0 NOT EQUAL SPACE                       05730031
057400              WHEN SQLCODE NOT EQUAL ZERO                         05740031
057500                  MOVE '6100-FETCH-EXCL-UPC' TO PV-PARAGRAPH-NAME 05750031
057600                  MOVE 'ERROR ON FETCHING EXCL UPC CURSOR'        05760031
057700                                             TO PV-DB2-OPERATION  05770031
057800                  PERFORM 9200-SQL-ABEND                          05780031
057900          END-EVALUATE                                            05790031
058000     END-PERFORM.                                                 05800031
058100                                                                  05810031
058200     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        05820031
058300         MOVE '6100-FETCH-EXCL-UPC'    TO PV-PARAGRAPH-NAME       05830031
058400         MOVE 'FETCH RETRIES EXCEEDED' TO PV-DB2-OPERATION        05840031
058500         PERFORM 9200-SQL-ABEND                                   05850031
058600     END-IF.                                                      05860031
058700                                                                  05870031
058800*6100-EXIT.                                                       05880031
058900                                                                  05890031
059000*-------------------------------------------------------------    05900031
059100* 6200-CLOSE-EXCL-UPC.                                            05910031
059200*      CLOSE THE EXCLUDED UPCS CURSOR.                            05920031
059300*-------------------------------------------------------------    05930031
059400 6200-CLOSE-EXCL-UPC.                                             05940031
059500                                                                  05950031
059600     PERFORM                                                      05960031
059700         WITH TEST AFTER                                          05970031
059800         VARYING PV-SQL-SUB                                       05980031
059900         FROM 1 BY 1                                              05990031
060000         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 06000031
060100                   OR  SQLCODE = 0)                               06010031
060200                                                                  06020031
060300           EXEC SQL                                               06030031
060400              CLOSE EXCL-UPC-CSR                                  06040031
060500           END-EXEC                                               06050031
060600                                                                  06060031
060700          EVALUATE TRUE                                           06070031
060800             WHEN SQLCODE = -904                                  06080031
060900             WHEN SQLCODE = -911                                  06090031
061000             WHEN SQLCODE = -913                                  06100031
061100             WHEN SQLCODE = 0                                     06110031
061200                  CONTINUE                                        06120031
061300             WHEN SQLWARN0 NOT EQUAL SPACE                        06130031
061400             WHEN SQLCODE NOT EQUAL ZERO                          06140031
061500                 MOVE '6200-CLOSE-EXCL-UPC' TO PV-PARAGRAPH-NAME  06150031
061600                 MOVE 'ERROR ON CLOSE OF EXCL UPC CURSOR'         06160031
061700                                            TO PV-DB2-OPERATION   06170031
061800                 PERFORM 9200-SQL-ABEND                           06180031
061900          END-EVALUATE                                            06190031
062000     END-PERFORM.                                                 06200031
062100                                                                  06210031
062200     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        06220031
062300         MOVE '6200-CLOSE-EXCL-UPC'    TO PV-PARAGRAPH-NAME       06230031
062400         MOVE 'CLOSE RETRIES EXCEEDED' TO PV-DB2-OPERATION        06240031
062500         PERFORM 9200-SQL-ABEND                                   06250031
062600     END-IF.                                                      06260031
062700                                                                  06270031
062800*6200-EXIT.                                                       06280031
062900                                                                  06290031
063000*----------------------------------------------------------       06300031
063100* 6300-OPEN-DELETED-SKU-CSR.                                      06310031
063200*      OPEN THE CURSOR OF DELETED SKUS (AND UPCS).                06320031
063300*----------------------------------------------------------       06330031
063400 6300-OPEN-DELETED-SKU-CSR.                                       06340031
063500                                                                  06350031
063600     PERFORM                                                      06360031
063700         WITH TEST AFTER                                          06370031
063800         VARYING PV-SQL-SUB                                       06380031
063900         FROM 1 BY 1                                              06390031
064000         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 06400031
064100                   OR  SQLCODE = 0)                               06410031
064200                                                                  06420031
064300           EXEC SQL                                               06430031
064400              OPEN DELETED-SKU-CSR                                06440031
064500           END-EXEC                                               06450031
064600                                                                  06460031
064700         EVALUATE TRUE                                            06470031
064800             WHEN SQLCODE = -904                                  06480031
064900             WHEN SQLCODE = -911                                  06490031
065000             WHEN SQLCODE = -913                                  06500031
065100             WHEN SQLCODE = 0                                     06510031
065200                 CONTINUE                                         06520031
065300             WHEN SQLWARN0 NOT EQUAL SPACE                        06530031
065400             WHEN SQLCODE NOT EQUAL ZERO                          06540031
065500                 MOVE '6300-OPEN-DELETED-SKU-CSR'                 06550031
065600                                          TO PV-PARAGRAPH-NAME    06560031
065700                 MOVE 'ERROR ON OPEN OF DELETED SKUS CURSOR'      06570031
065800                                          TO PV-DB2-OPERATION     06580031
065900                 PERFORM 9200-SQL-ABEND                           06590031
066000         END-EVALUATE                                             06600031
066100     END-PERFORM.                                                 06610031
066200                                                                  06620031
066300     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        06630031
066400         MOVE '6300-OPEN-DELETED-SKU-CSR'  TO PV-PARAGRAPH-NAME   06640031
066500         MOVE 'OPEN RETRIES EXCEEDED'      TO PV-DB2-OPERATION    06650031
066600         PERFORM 9200-SQL-ABEND                                   06660031
066700     END-IF.                                                      06670031
066800                                                                  06680031
066900*6300-EXIT.                                                       06690031
067000                                                                  06700031
067100*----------------------------------------------------------       06710031
067200* 6400-FETCH-DELETED-SKU-CSR.                                     06720031
067300*      FETCH THE DELETED SKU CURSOR.                              06730031
067400*----------------------------------------------------------       06740031
067500 6400-FETCH-DELETED-SKU-CSR.                                      06750031
067600                                                                  06760031
067700     PERFORM                                                      06770031
067800         WITH TEST AFTER                                          06780031
067900         VARYING PV-SQL-SUB                                       06790031
068000         FROM 1 BY 1                                              06800031
068100         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 06810031
068200                   OR  SQLCODE = 0                                06820031
068300                   OR  SQLCODE = +100)                            06830031
068400                                                                  06840031
068500           EXEC SQL                                               06850031
068600              FETCH DELETED-SKU-CSR                               06860031
068700              INTO  :EPT00016-INTR-UPC-ID                         06870031
068800                   ,:EPT00016-UPC-NBR                             06880031
068900                   ,:EPT00016-SKU-NBR                             06890031
069000           END-EXEC                                               06900031
069100                                                                  06910031
069200          EVALUATE TRUE                                           06920031
069300              WHEN SQLCODE = -904                                 06930031
069400              WHEN SQLCODE = -911                                 06940031
069500              WHEN SQLCODE = -913                                 06950031
069600                  CONTINUE                                        06960031
069700              WHEN SQLCODE = ZERO                                 06970031
069800                  ADD +1 TO PV-CNT-DEL-SKU-FETCH                  06980031
069900              WHEN SQLCODE = +100                                 06990031
070000                  SET PS-END-OF-DEL-SKU-CSR  TO TRUE              07000031
070100              WHEN SQLWARN0 NOT EQUAL SPACE                       07010031
070200              WHEN SQLCODE NOT EQUAL ZERO                         07020031
070300                 MOVE '6400-FETCH-DELETED-SKU-CSR'                07030031
070400                                           TO PV-PARAGRAPH-NAME   07040031
070500                 MOVE 'ERROR ON FETCHING DELETED SKU CURSOR'      07050031
070600                                           TO PV-DB2-OPERATION    07060031
070700                 DISPLAY 'SQLCODE= ' SQLCODE                      07070031
070800                 PERFORM 9200-SQL-ABEND                           07080031
070900          END-EVALUATE                                            07090031
071000     END-PERFORM.                                                 07100031
071100                                                                  07110031
071200     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        07120031
071300         MOVE '6400-FETCH-DELETED-SKU-CSR'  TO PV-PARAGRAPH-NAME  07130031
071400         MOVE 'FETCH RETRIES EXCEEDED'      TO PV-DB2-OPERATION   07140031
071500         PERFORM 9200-SQL-ABEND                                   07150031
071600     END-IF.                                                      07160031
071700                                                                  07170031
071800*6400-EXIT.                                                       07180031
071900                                                                  07190031
072000*-------------------------------------------------------------    07200031
072100* 6500-CLOSE-DELETED-SKU-CSR.                                     07210031
072200*      CLOSE THE DELETED SKUS CURSOR.                             07220031
072300*-------------------------------------------------------------    07230031
072400 6500-CLOSE-DELETED-SKU-CSR.                                      07240031
072500                                                                  07250031
072600     PERFORM                                                      07260031
072700         WITH TEST AFTER                                          07270031
072800         VARYING PV-SQL-SUB                                       07280031
072900         FROM 1 BY 1                                              07290031
073000         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 07300031
073100                   OR  SQLCODE = 0)                               07310031
073200                                                                  07320031
073300           EXEC SQL                                               07330031
073400              CLOSE DELETED-SKU-CSR                               07340031
073500           END-EXEC                                               07350031
073600                                                                  07360031
073700          EVALUATE TRUE                                           07370031
073800              WHEN SQLCODE = -904                                 07380031
073900              WHEN SQLCODE = -911                                 07390031
074000              WHEN SQLCODE = -913                                 07400031
074100              WHEN SQLCODE = 0                                    07410031
074200                  CONTINUE                                        07420031
074300              WHEN SQLWARN0 NOT EQUAL SPACE                       07430031
074400              WHEN SQLCODE NOT EQUAL ZERO                         07440031
074500                  MOVE '6500-CLOSE-DELETED-SKU-CSR'               07450031
074600                                           TO PV-PARAGRAPH-NAME   07460031
074700                  MOVE 'ERROR ON CLOSE OF DELETED SKUS CURSOR'    07470031
074800                                           TO PV-DB2-OPERATION    07480031
074900                  PERFORM 9200-SQL-ABEND                          07490031
075000          END-EVALUATE                                            07500031
075100     END-PERFORM.                                                 07510031
075200                                                                  07520031
075300     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        07530031
075400         MOVE '6500-CLOSE-DELETED-SKU-CSR'  TO PV-PARAGRAPH-NAME  07540031
075500         MOVE 'CLOSE RETRIES EXCEEDED'      TO PV-DB2-OPERATION   07550031
075600         PERFORM 9200-SQL-ABEND                                   07560031
075700     END-IF.                                                      07570031
075800                                                                  07580031
075900*6500-EXIT.                                                       07590031
076000                                                                  07600031
076100*----------------------------------------------------------       07610031
076200* 7200-POPULATE-COMMON-SKU.                                       07620031
076300*      POPULATES COMMON FIELDS OF THE SKU EXTRACT OUTPUT          07630031
076400*      RECORD FOR SQL SERVER.                                     07640031
076500*----------------------------------------------------------       07650031
076600 7200-POPULATE-COMMON-SKU.                                        07660031
076700                                                                  07670031
076800     INITIALIZE EP219-XST-SKU-RECORD.                             07680031
076900     MOVE PC-STR-GRP-TYP-CDE-CORP  TO EP219-STR-GRP-TYP-CDE.      07690031
077000     MOVE PC-STR-GRP-ID-CORP       TO EP219-STR-GRP-ID.           07700031
077100     MOVE CC-EPCC112-TOMORROW-DATE TO EP219-PRICG-EFFECT-DTE.     07710031
077200     SET EP219-FILE-CHANGE         TO TRUE.                       07720031
077300     SET EP219-APPLY-NIGHTLY       TO TRUE.                       07730031
077400     SET EP219-RECORD-DELETE       TO TRUE.                       07740031
077500                                                                  07750031
077600     SET EP219-SKU-NBR-YES         TO TRUE.                       07760031
077700     SET EP219-INTR-UPC-ID-YES     TO TRUE.                       07770031
077800                                                                  07780031
077900     SET EP219-SKU-DESC-NO         TO TRUE.                       07790031
078000     SET EP219-E-BUS-ITM-IND-NO    TO TRUE.                       07800031
078100     SET EP219-E-BUS-PRD-GP-NBR-NO TO TRUE.                       07810031
078200     SET EP219-NRF-CLOR-DESC-NO    TO TRUE.                       07820031
078300     SET EP219-SIZE-DESC-NO        TO TRUE.                       07830031
078400     SET EP219-TAX-PRD-CDE-NO      TO TRUE.                       07840031
078500     SET EP219-MDSE-TX-CDE-NO      TO TRUE.                       07850031
078600     SET EP219-MKDN-SGN-CDE-NO     TO TRUE.                       07860031
078700     SET EP219-STYL-ID-NO          TO TRUE.                       07870031
078800     SET EP219-DMY-SKU-IND-NO      TO TRUE.                       07880031
078900                                                                  07890031
079000*7200-EXIT.                                                       07900031
079100*----------------------------------------------------------       07910031
079200* 7300-POPULATE-COMMON-SQLS-XREF.                                 07920031
079300*      POPULATES COMMON FIELDS OF THE XREF EXTRACT OUTPUT         07930031
079400*      RECORD FOR SQL SERVER.                                     07940031
079500*----------------------------------------------------------       07950031
079600 7300-POPULATE-COMMON-SQLS-XREF.                                  07960031
079700                                                                  07970031
079800     INITIALIZE EP218-UPC-SKU-XREF-RECORD.                        07980031
079900     MOVE CC-EPCC112-TOMORROW-DATE TO EP218-XREF-EFFECT-DTE.      07990031
080000     MOVE PC-STR-GRP-TYP-CDE-CORP  TO EP218-STR-GRP-TYP-CDE.      08000031
080100     MOVE PC-STR-GRP-ID-CORP       TO EP218-STR-GRP-ID.           08010031
080200     SET EP218-FILE-CHANGE         TO TRUE.                       08020031
080300     SET EP218-APPLY-NIGHTLY       TO TRUE.                       08030031
080400     SET EP218-RECORD-DELETE       TO TRUE.                       08040031
080500                                                                  08050031
080600*7300-EXIT.                                                       08060031
080700*--------------------------------------------------------------*  08070031
080800* 8000-READ-EXCLUDED-SKUS.                                     *  08080031
080900*      READ A RECORD FROM THE EXCLUDED SKUS FILE               *  08090031
081000*--------------------------------------------------------------*  08100031
081100 8000-READ-EXCLUDED-SKUS.                                         08110031
081200                                                                  08120031
081300     MOVE '8000-READ-EXCLUDED-SKUS' TO PV-PARAGRAPH-NAME.         08130031
081400                                                                  08140031
081500     READ EXCLUDED-SKUS INTO EP132-PLU-EXCL-REC                   08150031
081600         AT END                                                   08160031
081700          SET PS-END-OF-EXCL-SKUS TO TRUE.                        08170031
081800                                                                  08180031
081900     IF PS-MORE-EXCL-SKUS                                         08190031
082000         ADD 1 TO PV-CNT-EXCL-SKU-RECS                            08200031
082100     END-IF.                                                      08210031
082200                                                                  08220031
082300*8000-EXIT.                                                       08230031
082400                                                                  08240031
082500*----------------------------------------------------------       08250031
082600* 8300-WRITE-SKU-GLOBAL-REC.                                      08260031
082700*      WRITES A PLU GLOBAL EXTRACT RECORD TO THE FILE.            08270031
082800*----------------------------------------------------------       08280031
082900 8300-WRITE-SKU-GLOBAL-REC.                                       08290031
083000                                                                  08300031
083100     WRITE SKU-CHG-GLOBAL-RECORD                                  08310031
083200         FROM EP219-XST-SKU-RECORD.                               08320031
083300                                                                  08330031
083400     ADD 1 TO PV-CNT-SKU-GLOBAL.                                  08340031
083500                                                                  08350031
083600*8300-EXIT.                                                       08360031
083700                                                                  08370031
083800*----------------------------------------------------------       08380031
083900* 8400-WRITE-SQLS-XREF-GLBL-REC.                                  08390031
084000*      WRITES A XREF GLOBAL EXTRACT RECORD TO THE FILE.           08400031
084100*----------------------------------------------------------       08410031
084200 8400-WRITE-SQLS-XREF-GLBL-REC.                                   08420031
084300                                                                  08430031
084400     WRITE XREF-SQLS-GLOBAL-RECORD                                08440031
084500         FROM EP218-UPC-SKU-XREF-RECORD.                          08450031
084600                                                                  08460031
084700     ADD 1 TO PV-CNT-SQLS-XREF-GLOBAL.                            08470031
084800                                                                  08480031
084900*8400-EXIT.                                                       08490031
084800                                                                  08490133
084800                                                                  08490233
033800*----------------------------------------------------------------*08491033
033900*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *08492033
034000*----------------------------------------------------------------*08493033
034100 X100-CHECKPOINT-CHECK.                                           08494033
034200                                                                  08495033
034300     MOVE 'X100-CHECKPOINT-CHECK' TO PV-PARAGRAPH-NAME.           08496034
034400                                                                  08497033
034500     EXEC SQL                                                     08498033
034600       SET :PV-TMST = CURRENT TIMESTAMP                           08499034
034700     END-EXEC.                                                    08499133
034800                                                                  08499233
034900     IF SQLCODE = +0                                              08499333
035000         CONTINUE                                                 08499433
035100     ELSE                                                         08499533
035600         MOVE 'BAD SET COMMAND'                                   08500033
035700                             TO PV-DB2-OPERATION                  08500134
035900         PERFORM 9200-SQL-ABEND                                   08500334
036000     END-IF.                                                      08500433
036100                                                                  08500533
036200     IF PV-TMST > PV-HOLD-TMST                                    08500634
036900         PERFORM 9000-DB2-COMMIT                                  08501334
037000         PERFORM X500-SET-CHECKPOINT-TIME                         08501433
037100     END-IF.                                                      08501533
037200                                                                  08501633
037200                                                                  08501733
050100*----------------------------------------------------------------*08514533
050200*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *08514633
050300*----------------------------------------------------------------*08514733
050400 X500-SET-CHECKPOINT-TIME.                                        08514833
050500                                                                  08514933
050600     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-PARAGRAPH-NAME.        08515034
050700                                                                  08515133
051300     EXEC SQL                                                     08515733
051400         SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)     08515833
051500           INTO :PV-HOLD-TMST                                     08515934
051600           FROM TCKRSTCNTL                                        08516033
051700          WHERE PLAN_NAME = :PC-PROGRAM-NAME                      08516133
051800     END-EXEC.                                                    08516233
051900                                                                  08516333
052000     EVALUATE TRUE                                                08516433
052100         WHEN SQLCODE = ZERO                                      08516533
052200         WHEN SQLCODE = -904                                      08516633
052300         WHEN SQLCODE = -913                                      08516733
052400              CONTINUE                                            08516833
052500                                                                  08516933
052600         WHEN SQLWARN0 NOT = SPACES                               08517033
052700         WHEN SQLCODE  NOT = ZERO                                 08517133
053400             MOVE 'UNSUCCESSFUL SELECT'                           08517833
053500                                         TO PV-DB2-OPERATION      08517934
053700             PERFORM 9200-SQL-ABEND                               08518134
053800     END-EVALUATE.                                                08518233
055300                                                                  08519733
055400                                                                  08519833
085000*---------------------------------------------------------        08531131
085100* 9000-DB2-COMMIT.                                                08531231
085200*      THIS ROUTINE EXECUTES THE COMMIT FOR THE TEMP TABLE        08531331
085300*      DELETES.                                                   08532031
085400*---------------------------------------------------------        08540031
085500 9000-DB2-COMMIT.                                                 08550031
085600                                                                  08560031
085700     PERFORM                                                      08570031
085800         WITH TEST AFTER                                          08580031
085900         VARYING PV-SQL-SUB                                       08590031
086000         FROM 1 BY 1                                              08600031
086100         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 08610031
086200                   OR  SQLCODE = 0)                               08620031
086300         EXEC SQL                                                 08630031
086400             COMMIT                                               08640031
086500         END-EXEC                                                 08650031
086600                                                                  08660031
086700         EVALUATE TRUE                                            08670031
086800             WHEN SQLCODE = -904                                  08680031
086900             WHEN SQLCODE = -911                                  08690031
087000             WHEN SQLCODE = -913                                  08700031
087100             WHEN SQLCODE = 0                                     08710031
087200                 ADD 1 TO PV-CNT-COMMITS                          08720035
087200                 CONTINUE                                         08721035
087300             WHEN SQLWARN NOT EQUAL SPACES                        08730031
087400             WHEN SQLCODE NOT EQUAL ZERO                          08740031
087500                 MOVE '9000-DB2-COMMIT'    TO PV-PARAGRAPH-NAME   08750031
087600                 MOVE 'COMMIT DB2 DELETES' TO PV-DB2-OPERATION    08760031
087700                 PERFORM 9200-SQL-ABEND                           08770031
087800         END-EVALUATE                                             08780031
087900     END-PERFORM.                                                 08790031
088000                                                                  08800031
088100     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        08810031
088200         MOVE '9000-DB2-COMMIT'         TO PV-PARAGRAPH-NAME      08820031
088300         MOVE 'COMMIT RETRIES EXCEEDED' TO PV-DB2-OPERATION       08830031
088400         PERFORM 9200-SQL-ABEND                                   08840031
088500     END-IF.                                                      08850031
088600                                                                  08860031
088700*9000-EXIT.                                                       08870031
088800*----------------------------------------------------------       08880031
088900* 9100-END-OF-JOB-ROUTINE.                                        08890031
089000*      TAKES CARE OF CLEAN UP AT THE END OF THE PROGRAM.          08900031
089100*      FILES ARE CLOSED AND COUNTS ARE DISPLAYED.  IF THERE       08910031
089200*      WERE RECORDS IN THE EXCLUDED SKUS FILE, THEN THE RETURN    08920031
089300*      CODE IS SET TO 4.  THIS IS A GOOD RETURN CODE, BUT LETS    08930031
089400*      THE JOB KNOW AN EXTRA STEP IS NEEDED.                      08940031
089500*----------------------------------------------------------       08950031
089600 9100-END-OF-JOB-ROUTINE.                                         08960031
089700                                                                  08970031
089800     CLOSE  EXCLUDED-SKUS                                         08980031
089900            SKU-CHG-GLOBAL-FILE                                   08990031
090000            XREF-SQLS-GLOBAL-FILE.                                09000031
090100                                                                  09010031
090200     DISPLAY '***********************************************'.   09020031
090300     DISPLAY '*******      COUNTS AT END OF EPKUP105  *******'.   09030031
090400     DISPLAY ' '.                                                 09040031
090500     DISPLAY '# EXCLUDED SKU RECS READ: ' PV-CNT-EXCL-SKU-RECS.   09050031
090600     DISPLAY ' # EXCLUDED UPCS FETCHED: ' PV-CNT-EXCL-UPC-FETCH.  09060031
090700     DISPLAY ' '.                                                 09070031
090800     DISPLAY '# SKU/UPC DELETE FETCHED: ' PV-CNT-DEL-SKU-FETCH.   09080031
090900     DISPLAY '# SKU/UPC DELETE DELETED: ' PV-CNT-DEL-SKU-DELETE.  09090031
091000     DISPLAY '        # FROM DELETED SKUS:  '                     09100031
091100             PV-CNT-PLU-DEL-RECS.                                 09110031
091200     DISPLAY '  '.                                                09120031
091300     DISPLAY '# SQLS SKU RECORDS WRITTEN: ' PV-CNT-SKU-GLOBAL.    09130031
091400     DISPLAY '       # FROM EXCLUDED SKUS:  '                     09140031
091500             PV-CNT-SKU-EXCL-RECS.                                09150031
091600     DISPLAY '        # FROM DELETED SKUS:  '                     09160031
091700             PV-CNT-SKU-DELTD-RECS.                               09170031
091800     DISPLAY ' '.                                                 09180031
091900     DISPLAY '       # FROM EXCLUDED SKUS:  '                     09190031
092000             PV-CNT-XREF-EXCL-RECS.                               09200031
092100     DISPLAY '        # FROM DELETED SKUS:  '                     09210031
092200             PV-CNT-XREF-DEL-RECS.                                09220031
092300     DISPLAY '  '.                                                09230031
092400     DISPLAY '# SQLS XREF RECORDS WRITTEN: '                      09240031
092500             PV-CNT-SQLS-XREF-GLOBAL.                             09250031
092600     DISPLAY '       # FROM EXCLUDED SKUS:  '                     09260031
092700             PV-CNT-SQLS-XREF-EXCL-RECS.                          09270031
092800     DISPLAY '        # FROM DELETED SKUS:  '                     09280031
092900             PV-CNT-SQLS-XREF-DEL-RECS.                           09290031
092800     DISPLAY '# COMMITS DONE:               '                     09291036
092900             PV-CNT-COMMITS.                                      09292035
093000     DISPLAY '*******                                 *******'.   09300031
093100     DISPLAY '***********************************************'.   09310031
093200                                                                  09320031
093300     IF PV-CNT-EXCL-SKU-RECS  > 0                                 09330031
093400        MOVE 04               TO RETURN-CODE                      09340031
093500     END-IF.                                                      09350031
093600                                                                  09350133
093600                                                                  09360031
093700*9100-EXIT.                                                       09370031
093800                                                                  09380031
093900*---------------------------------------------------------        09390031
094000* 9200-SQL-ABEND.                                                 09400031
094100*      ABEND PROGRAM WHEN AN SQL ERROR CODE OCCURS.               09410031
094200*---------------------------------------------------------        09420031
094300 9200-SQL-ABEND.                                                  09430031
094400     DISPLAY '** ABEND     **'.                                   09440031
094500     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                09450031
094600     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              09460031
094700     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               09470031
094800                                                                  09480031
094900     COPY DPPD004.                                                09490031
095000     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         09500031
095100                                                                  09510031
095200*9200-EXIT.                                                       09520031
095300                                                                  09530031
095400*----------------------------------------------------------       09540031
095500* 9800-ABEND.                                                     09550031
095600*      ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                 09560031
095700*----------------------------------------------------------       09570031
095800 9800-ABEND.                                                      09580031
095900                                                                  09590031
096000     DISPLAY '** ABEND           **'.                             09600031
096100     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          09610031
096200     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        09620031
096300     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       09630031
096400     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       09640031
096500     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         09650031
096600                                                                  09660031
096700*9800-EXIT.                                                       09670031
096800                                                                  09680031
