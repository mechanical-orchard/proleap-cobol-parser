000100*-----------------------*                                         00010002
000200 IDENTIFICATION DIVISION.                                         00020002
000300*-----------------------*                                         00030002
000400 PROGRAM-ID.    RDKCS036.                                         00040002
000500 AUTHOR.        GREGORY SHEFF.                                    00050002
000600 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00060002
000700 DATE-WRITTEN.  06-11-03.                                         00070002
000800 DATE-COMPILED.                                                   00080002
000900*----------------------------------------------------------------*00090002
001000*                                                                *00100002
001100* THIS PROGRAM IS USED TO UPDATE INFO FOR SETTLEMENT OF A MAIL    00110002
001200* CHECK REQUEST.                                                 *00120002
001300*                                                                 00130002
001400* THIS PROGRAM IS REACHED FROM THE RDLRFND OR RDIRFND FUNCTION.  *00140002
001500*                                                                 00150002
001600* USING THE CUSTOMER ID, READ RDT_CUST AND FILL IN THE CUSTOMER   00160002
001700* INFORMATION.  THEN, USING THE CUSTOMER ID AND MAIL CHECK REFUND 00170002
001800* ID, READ THE RDT_MAL_CK_RFND TABLE AND FILL IN THE REQUEST      00180002
001900* INFORMATION.                                                    00190002
002000*                                                                 00200002
002100* USING THE STORE NUMBER, READ XST_LOC TO GET THE STORE NAME FOR  00210002
002200* THE SCREEN.                                                     00220002
002300*                                                                 00230002
002400* IF ANY CUSTOMER DATA IS CHANGED, THE RDT_CUST TABLE SHOULD BE   00240002
002500* UPDATED WITH THOSE CHANGES.                                     00250002
002600*                                                                 00260002
002700* THE REFUND AMOUNT CAN BE CHANGED.  IF IT IS CHANGED, THE        00270002
002800* ADJUSTED REFUND AMOUNT SHOULD BE UPDATED IN RDT_MAL_CK_RFND.    00280002
002900*                                                                 00290002
003000* THE FIELDS THAT SHOW WHETHER OTHER SYSTEMS HAVE BEEN CHECKED CAN00300002
003100* HAVE VALUES OF OK OR SR (SEE RESEARCH).THE APPROVAL CODE CAN NOT00310002
003200* BE CHANGED UNLESS ALL THREE OF THOSE FIELDS HAVE EITHER OK OR SR00320002
003300* IN THEM.  THEY DO NOT HAVE TO BE THE SAME VALUE IN ALL FIELDS.  00330002
003400*                                                                 00340002
003500* IF APPROVED FOR KMRC, THE KMRC NUMBER SHOULD BE ENTERED.        00350002
003600*                                                                 00360002
003700* IF APPROVAL CODE IS CHANGED TO V (VOID), CREATE A NEW ROW IN THE00370002
003800* RDT_MAL_CK_RFND TABLE WITH THE SAME DATA EXCEPT THAT THE        00380002
003900* RFND_SEQ_NBR WILL BE CHANGED TO THE NEXT SEQUENTIAL NUMBER AND  00390002
004000* THE RFND_CK_NBR AND RFND_CK_DTE WILL BE NULL.                   00400002
004100*                                                                 00410002
004200* FROM THIS PROGRAM, THE USER CAN UPDATE, GO TO THE COMMENT SCREEN00420002
004300* OR ISSUE A KMRC. WHEN THE USER HITS THE PF19 TO ISSUE A KMRC,   00430002
004400* CONTROL IS PASSED TO RDUCRD.                                    00440002
004500*                                                                *00450002
004600*----------------------------------------------------------------*00460002
004610*========================== CHANGE LOG ===========================00461002
004611*  02/27/08   INC000000276250   CHERI PARMLEY                     00461102
004612*   BACKED OUT NON-NUMERIC EDIT FROM WR#33375                     00461202
004613*----------------------------------------------------------------*00461304
004650*                                                                 00465002
004660* 10/11/2021 GERMAN BANDA                    WR/IR #: CHG0262418* 00466004
004670*            - CHANGE CALL OF DPKUT100 TO                       * 00467004
004680*              CALL DP010I-NUMERIC-EDIT-ROUTINE                 * 00468004
004690*              MAKING THE CALL DYNAMIC VS STATIC                * 00469004
004691*                                                               * 00469104
004692*---------------------------------------------------------------* 00469204
CICS  * CHANGED 10/27/2022    BY JIM HUNTER      WR: CHG0277293         00469305
CICS  * ADD COPYBOOK DPWS930 AND MAKE THE CICS ARCHITECTURE CALL        00469405
CICS  * DYNAMIC INSTEAD OF STATIC BY CALLING DP930-CICS-ARCH-API.       00469505
CICS  ******************************************************************00469605
004693* CHANGED 06/05/2023    BY JEAN KURK       WR: CHG0288970         00469706
004693* REPLACE CRPD500 AND CRWS500 WITH RDPD500 AND RDWS500            00469806
004693******************************************************************00470006
004700 ENVIRONMENT DIVISION.                                            00471002
004800 DATA DIVISION.                                                   00480002
004900 WORKING-STORAGE SECTION.                                         00490002
005000*                                                                 00500002
005100 01  IV-INDICATOR-VARIABLES.                                      00510002
005200     15  IV-PHN-NBR                     PIC S9(04)  COMP          00520002
005300                                                    VALUE 0.      00530002
005400     15  IV-STAT-CHNG-DTE               PIC S9(04)  COMP          00540002
005500                                                    VALUE 0.      00550002
005600     15  IV-RFND-CK-DTE                 PIC S9(04)  COMP          00560002
005700                                                    VALUE 0.      00570002
005800     15  IV-RFND-CK-NBR                 PIC S9(04)  COMP          00580002
005900                                                    VALUE 0.      00590002
006000     15  IV-CORP-EJRNL-CKD-CDE          PIC S9(04)  COMP          00600002
006100                                                    VALUE 0.      00610002
006200     15  IV-CK-SYS-CKD-CDE              PIC S9(04)  COMP          00620002
006300                                                    VALUE 0.      00630002
006400     15  IV-GR-CKD-CDE                  PIC S9(04)  COMP          00640002
006500                                                    VALUE 0.      00650002
006600     15  IV-KMRC-CRD-NBR                PIC S9(04)  COMP          00660002
006700                                                    VALUE 0.      00670002
006800     15  IV-RFND-AMT-ADJ                PIC S9(04)  COMP          00680002
006900                                                    VALUE 0.      00690002
007000 01  PC-PROGRAM-CONSTANTS.                                        00700002
007100     05  PC-CURRENT-PROGRAM-NAME  PIC  X(08)  VALUE  'RDKCS036'.  00710002
007200     05  PC-CURRENT-MAP-NAME      PIC  X(08)  VALUE  'RD036A  '.  00720002
007300     05  PC-CURRENT-MAPSET-NAME   PIC  X(08)  VALUE  'RDKM036 '.  00730002
007400     05  PC-APPL-MAP              PIC S9(04)  VALUE  +1           00740002
007500                                              COMP.               00750002
007600     05  PC-MAX-RETRIES           PIC S9(04)  VALUE  +3           00760002
007700                                              COMP.               00770002
007800     05  PC-INTER-APPL-CODES.                                     00780002
007900         10  PC-INTER-APPL-CRIT-SPEC                              00790002
008000                                  PIC  X(01)  VALUE ' '.          00800002
008100     05  PC-KMRC                  PIC  X(01)  VALUE 'M'.          00810002
008200     05  PC-V                     PIC  X(01)  VALUE 'V'.          00820002
008300                                                                  00830002
008400     05  PC-TSYMSG-NUMBERS.                                       00840002
008500         10  PC-TSYMSG-00005      PIC  9(05)  VALUE  00005.       00850002
008600         10  PC-TSYMSG-00007      PIC  9(05)  VALUE  00007.       00860002
008700         10  PC-TSYMSG-00008      PIC  9(05)  VALUE  00008.       00870002
008800         10  PC-TSYMSG-00010      PIC  9(05)  VALUE  00010.       00880002
008900         10  PC-TSYMSG-03096      PIC  9(05)  VALUE  03096.       00890002
009000         10  PC-TSYMSG-00059      PIC  9(05)  VALUE  00059.       00900002
009100         10  PC-TSYMSG-00117      PIC  9(05)  VALUE  00117.       00910002
009200         10  PC-TSYMSG-00148      PIC  9(05)  VALUE  00148.       00920002
009300         10  PC-TSYMSG-00158      PIC  9(05)  VALUE  00158.       00930002
009400         10  PC-TSYMSG-00482      PIC  9(05)  VALUE  00482.       00940002
009500         10  PC-TSYMSG-01236      PIC  9(05)  VALUE  01236.       00950002
009600*                                                                 00960002
009700     05  PC-STATUS-CODES          PIC  X(01)  VALUE  SPACES.      00970002
009800         88  PC-VALID-STATUS-CODE                                 00980002
009900                                  VALUE  'E', 'D', 'O', 'S', 'V', 00990002
010000                                         'A', 'K', 'M', 'B', 'C'. 01000002
010100         88  PC-VOID              VALUE  'V'.                     01010002
010200*                                                                 01020002
010300 01  PS-PROGRAM-SWITCHES.                                         01030002
010400     05  PS-VALID-KMRC-SW         PIC  X(01)  VALUE  'N'.         01040002
010500         88  PS-VALID-KMRC                    VALUE  'Y'.         01050002
010600         88  PS-INVALID-KMRC                  VALUE  'N'.         01060002
010700*                                                                 01070002
010800 01  PV-PROGRAM-VARIABLES.                                        01080002
010900     05  PV-CICS-RESPONSE         PIC S9(04)      VALUE +0        01090002
011000                                                  COMP SYNC.      01100002
011100     05  PV-RETRY-COUNTER         PIC S9(04)      VALUE +0        01110002
011200                                                  COMP SYNC.      01120002
011300     05  PV-RFND-SEQ-NBR          PIC S9(4) COMP.                 01130002
011400     05  PV-CORP-SYS-GIFT-CODE    PIC  X(02)     VALUE  SPACES.   01140002
011500         88  PV-VALID-CORP-SYS-GIFT-CODE                          01150002
011600                                                 VALUE 'SR', 'OK'.01160002
011700     05  PV-CURRENT-TIMESTAMP       PIC  X(26)  VALUE SPACES.     01170002
011800     05  PV-CURRENT-TIMESTAMPX      REDEFINES                     01180002
011900         PV-CURRENT-TIMESTAMP.                                    01190002
012000         10  PV-CURRENT-DATE        PIC  X(10).                   01200002
012100         10  PV-CURRENT-TIME        PIC  X(16).                   01210002
012200                                                                  01220002
012300     EJECT                                                        01230002
012400*----------------------------------------------------------------*01240002
012500*    MAP LAYOUT                                                  *01250002
012600*----------------------------------------------------------------*01260002
012700     COPY RDKM036.                                                01270002
012800                                                                  01280002
012900*----------------------------------------------------------------*01290002
013000*    ATTRIBUTE SETTINGS COPYBOOK.                                *01300002
013100*----------------------------------------------------------------*01310002
013200                                                                  01320002
013300     COPY DPWS015.                                                01330002
013400                                                                  01340002
013500*--------------------------------------------------------------   01350002
013600*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             01360002
013700*--------------------------------------------------------------   01370002
013800     COPY DPWS500.                                                01380002
013900                                                                  01390002
014000*----------------------------------------------------------------*01400002
014100* STORED VALUE CONVERT CARD NUMBER WORKING STORAGE               *01410002
014200*----------------------------------------------------------------*01420002
014300                                                                  01430002
014400     COPY SVWS007.                                                01440002
014500*----------------------------------------------------------------*01450002
014600                                                                  01460002
014700* STORED VALUE CONSTANTS                                         *01470002
014800*----------------------------------------------------------------*01480002
014900                                                                  01490002
015000     COPY SVWS004.                                                01500002
015100*----------------------------------------------------------------*01510002
015200                                                                  01520002
015300*    FUNCTION KEYS COPYBOOK                                      *01530002
015400*----------------------------------------------------------------*01540002
015500                                                                  01550002
015600     COPY DPWS016.                                                01560002
015700                                                                  01570002
015800**--------------------------------------------------------------**01580002
015900** THE CALLING PARAMETER LIST (DPWS010) FOR THE NUMERIC EDIT    **01590002
016000** SUB-ROUTINE (DPKUT100).                                      **01600002
016100**--------------------------------------------------------------**01610002
016200     COPY DPWS010I.                                               01620002
016300 EJECT                                                            01630002
016400**--------------------------------------------------------------**01640002
016500** THE CALLING PARAMETER LIST (DPWS030) FOR THE CICS ARCHITECTURE*01650002
016600** APPLICATION PROGRAMMING INTERFACE MODULE.                    **01660005
016700**--------------------------------------------------------------**01670002
016800     COPY DPWS030.                                                01680002
CICS       COPY DPWS930.                                                01681005
016900 EJECT                                                            01690002
017000**--------------------------------------------------------------**01700002
017100*    STANDARD COMMAREA.                                           01710002
017200**--------------------------------------------------------------**01720002
017300                                                                  01730002
017400     COPY DPWS020.                                                01740002
017500     05  FILLER REDEFINES DP020-VARIABLE-COMMAREA.                01750002
017600                                                                  01760002
017700***************************************************************** 01770002
017800*    INTER-APPLICATION COMMAREA.                                  01780002
017900***************************************************************** 01790002
018000                                                                  01800002
018100         10  INTER-APPL-COMM-AREA PIC X(200).                     01810002
018200     COPY RDWS034.                                                01820002
018300***************************************************************** 01830002
018400*    SPECIFIC COMMMAREA FOR RDKCS036.                             01840002
018500***************************************************************** 01850002
018600         10  ASC-SPECIFIC-COMMAREA.                               01860002
018700             15  ASC-INT-APPL-FORMAT-IND     PIC  X(01).          01870002
018800             15  ASC-LIST-KEYS.                                   01880002
018900                 20  ASC-KEY-CUST-ID         PIC S9(10)  COMP-3.  01890002
019000                 20  ASC-KEY-TERMINAL        PIC S9(04)  COMP.    01900002
019100                 20  ASC-KEY-TRANSACTION     PIC S9(04)  COMP.    01910002
019200                 20  ASC-KEY-SEQ-NBR         PIC S9(04)  COMP.    01920002
019300             15  ASC-NON-KEYS.                                    01930002
019400                 20  ASC-DRIVERS-LIC         PIC X(25).           01940002
019500                 20  ASC-LAST-NAME           PIC X(30).           01950002
019600                 20  ASC-FIRST-NAME          PIC X(30).           01960002
019700                 20  ASC-ADDRESS1            PIC X(40).           01970002
019800                 20  ASC-ADDRESS2            PIC X(40).           01980002
019900                 20  ASC-CITY                PIC X(20).           01990002
020000                 20  ASC-STATE               PIC X(02).           02000002
020100                 20  ASC-ZIP                 PIC X(11).           02010002
020200                 20  ASC-PHONE               PIC X(26).           02020002
020300                 20  ASC-STORE-NBR           PIC S9(04) COMP.     02030002
020400                 20  ASC-STORE-NAME          PIC X(30).           02040002
020500                 20  ASC-RECEIPT-DTE         PIC X(10).           02050002
020600                 20  ASC-TERMINAL            PIC S9(04) COMP.     02060002
020700                 20  ASC-TRANSACTION         PIC S9(04) COMP.     02070002
020800                 20  ASC-SEQ-NBR             PIC S9(04) COMP.     02080002
020900                 20  ASC-RFND-AMT-ORIG       PIC 9(05)V99.        02090002
021000                 20  ASC-RFND-AMT-ADJX       PIC X(08).           02100002
021100                 20  ASC-RFND-AMT-ADJ        PIC 9(05)V99.        02110002
021200                 20  ASC-CORP-EJ             PIC X(02).           02120002
021300                 20  ASC-CK-SYS-CK           PIC X(02).           02130002
021400                 20  ASC-GIFT-CK             PIC X(02).           02140002
021500                 20  ASC-STATUS-CDE          PIC X(01).           02150002
021600                 20  ASC-STATUS-DESC         PIC X(10).           02160002
021700                 20  ASC-STATUS-DATE         PIC X(10).           02170002
021800                 20  ASC-CHECK-DATE          PIC X(10).           02180002
021900                 20  ASC-CHECK-NBR           PIC 9(07).           02190002
022000                 20  ASC-KMRC-NBRX           PIC X(30).           02200002
022100                 20  ASC-KMRC-NBR REDEFINES ASC-KMRC-NBRX         02210002
022200                                             PIC 9(30).           02220002
022300                 20  ASC-KMRC-CNVT           PIC 9(12) COMP-3.    02230002
022400                 20  ASC-STATUS-ORIG         PIC X(01).           02240002
022500                 20  ASC-ERROR-SW            PIC X(01).           02250002
022600                     88  ASC-ERROR                     VALUE  'Y'.02260002
022700                     88  ASC-NO-ERROR                  VALUE  'N'.02270002
022800                 20  ASC-STATUS-CHNG-SW      PIC X(01).           02280002
022900                     88  ASC-STATUS-CHNG               VALUE  'Y'.02290002
023000                     88  ASC-STATUS-NO-CHNG            VALUE  ' '.02300002
023100             15  ASC-USE-SELECTION-QUEUE-IND                      02310002
023200                                           PIC  X(01).            02320002
023300                 88  ASC-USE-SELECTION-QUEUE           VALUE 'Y'. 02330002
023400             15  ASC-SEL-QUEUE-NAME        PIC  X(08).            02340002
023500             15  ASC-NUMBER-OF-TS-ITEMS    PIC S9(05)  COMP-3.    02350002
023600             15  ASC-NUMBER-OF-SELECTED-ITEMS                     02360002
023700                                           PIC S9(09)  COMP-3.    02370002
023800             15  ASC-SEL-SUB               PIC S9(04)  COMP.      02380002
023900             15  ASC-SEL-ITEM              PIC S9(04)  COMP.      02390002
024000         10  FILLER                        PIC  X(2467).          02400002
024100     EJECT                                                        02410002
024200*----------------------------------------------------------------*02420002
024300*    ABEND PROCESSING COPYBOOK.                                  *02430002
024400*----------------------------------------------------------------*02440002
024500                                                                  02450002
024600     COPY DPWS013.                                                02460002
024700                                                                  02470002
024800 EJECT                                                            02480002
024900                                                                  02490002
025000*-----------------------------------------------------------------02500002
025100*    DB2 AREA FOR CUSTOMERS (RDT_CUST)                            02510002
025200*-----------------------------------------------------------------02520002
025300*                                                                 02530002
025400     EXEC SQL                                                     02540002
025500          INCLUDE RDT00000                                        02550002
025600     END-EXEC.                                                    02560002
025700                                                                  02570002
025800*-----------------------------------------------------------------02580002
025900*    DB2 AREA FOR MAILED REFUND CHECKS (RDT_MAL_CK_RFND)          02590002
026000*-----------------------------------------------------------------02600002
026100     EXEC SQL                                                     02610002
026200          INCLUDE RDT00001                                        02620002
026300     END-EXEC.                                                    02630002
026400                                                                  02640002
026500*-----------------------------------------------------------------02650002
026600*    DB2 AREA FOR STORED VALUE CARD TABLE (SVT_KOHLS_CRD_ACCT)    02660002
026700*-----------------------------------------------------------------02670002
026800     EXEC SQL                                                     02680002
026900          INCLUDE SVT00001                                        02690002
027000     END-EXEC.                                                    02700002
027100                                                                  02710002
027200*-----------------------------------------------------------------02720002
027300*    DB2 AREA FOR STORED VALUE COMMENTS (SVT_CRD_ACCT_CMMT)       02730002
027400*-----------------------------------------------------------------02740002
027500     EXEC SQL                                                     02750002
027600          INCLUDE SVT00003                                        02760002
027700     END-EXEC.                                                    02770002
027800                                                                  02780002
027900*-----------------------------------------------------------------02790002
028000*    DB2 AREA FOR LOCATION TABLE (XST_LOC)                        02800002
028100*-----------------------------------------------------------------02810002
028200     EXEC SQL                                                     02820002
028300          INCLUDE XST00001                                        02830002
028400     END-EXEC.                                                    02840002
028500                                                                  02850002
028600*---------------------------------------------------------------* 02860002
028700*    DB2 AREA FOR COMMUNICATIONS                                  02870002
028800*---------------------------------------------------------------* 02880002
028900     EXEC SQL                                                     02890002
029000          INCLUDE SQLCA                                           02900002
029100     END-EXEC.                                                    02910002
029200                                                                  02920002
029300******************************************************            02930002
029400*  DRIVER LICENSE CONVERSION COPYBOOK                             02940002
029500******************************************************            02950002
029600     COPY RDWS500.                                                02960006
029600*    COPY CRWS500.                                                02961006
029700                                                                  02970002
029800*---------------------------------------------------------------* 02980002
029900 LINKAGE SECTION.                                                 02990002
030000                                                                  03000002
030100 01  DFHCOMMAREA.                                                 03010002
030200     05  FILLER                         OCCURS  1 TO 4072 TIMES   03020002
030300                                        DEPENDING ON EIBCALEN.    03030002
030400         10  FILLER                     PIC X.                    03040002
030500                                                                  03050002
030600*---------------------------------------------------------------* 03060002
030700 PROCEDURE DIVISION.                                              03070002
030800***************************************************************** 03080002
030900** THIS MODULE CONTROLS THE OVERALL PROCESSING IN THE PROGRAM. ** 03090002
031000** THE SETUP AND PERFORM OF PARAGRAPH 0001-CALL-CICS-ARCH-API  ** 03100002
031100** MUST BE THE FIRST CODE EXECUTED IN THIS PROGRAM.            ** 03110002
031200**                                                             ** 03120002
031300** THE SECOND OR 'EXIT' PERFORM OF THIS PARAGRAPH MUST BE THE  ** 03130002
031400** LAST CODE EXECUTED ON EACH ITERATION OF THIS PROGRAM.       ** 03140002
031500***************************************************************** 03150002
031600 0000-MAIN-MODULE.                                                03160002
031700     INITIALIZE DP030-CICS-API-FIELDS.                            03170002
031800     MOVE +1                       TO DP030-NUMBER-OF-MAPS.       03180002
031900     MOVE PC-CURRENT-MAPSET-NAME   TO DP030-MAPSET-NAME.          03190002
032000     MOVE PC-CURRENT-MAP-NAME      TO DP030-MAP-NAME (1).         03200002
032100     SET DP030-RECEIVE-APPL-MAP    TO TRUE.                       03210002
032200     MOVE LENGTH OF RD036AI        TO DP030-MAP-LENGTH (1).       03220002
032300     MOVE 'PROGRAM ENTRY CALL'     TO DP013-MESSAGE-TEXT (1).     03230002
032400     PERFORM 0001-CALL-CICS-ARCH-API.                             03240002
032500*                                                                 03250002
032600     PERFORM 1000-CONTROL-PROCESSING                              03260002
032700*                                                                 03270002
032800     MOVE 'PROGRAM EXIT CALL'      TO DP013-MESSAGE-TEXT (1).     03280002
032900     PERFORM 0001-CALL-CICS-ARCH-API.                             03290002
033000                                                                  03300002
033100 0001-CALL-CICS-ARCH-API.                                         03310002
CICS       CALL DP930-CICS-ARCH-API USING DFHEIBLK                      03320005
033300                                    DFHCOMMAREA                   03330005
033400                                    DP030-CICS-API-FIELDS         03340005
033500                                    DP020-STANDARD-COMMAREA       03350005
033600                                    RD036AI.                      03360005
033700*                                                                 03370002
033800     IF  DP030-RC-CALL-SUCCESSFUL                                 03380002
033900         CONTINUE                                                 03390002
034000     ELSE                                                         03400002
034100         SET DP013-NO-ROLLBACK                                    03410002
034200             DP013-XCTL-DISPLAY-RESTART                           03420002
034300             DP013-CICS-ABEND      TO TRUE                        03430002
034400         MOVE '0000-MAIN-MODULE'                                  03440002
034500                                   TO DP013-PARAGRAPH             03450002
CICS           MOVE 'CALL TO CICS ARCH API NOT SUCCESSFUL, RETURN-CODE O03451005
CICS  -             'N NEXT LINE'        TO DP013-MESSAGE-TEXT (2)      03452005
034800         MOVE DP030-RETURN-CODE    TO DP013-MESSAGE-TEXT (3)      03480002
034900         PERFORM DP013-0000-PROCESS-ABEND                         03490002
035000     END-IF.                                                      03500002
035100 EJECT                                                            03510002
035200*----------------------------------------------------------------*03520002
035300*    PROCESS THE APPROPRIATE PARAGRAPHS BASED ON WHAT THE NEXT   *03530002
035400*    COURSE OF ACTION IS FOR THIS TRANSACTION.                   *03540002
035500*----------------------------------------------------------------*03550002
035600                                                                  03560002
035700 1000-CONTROL-PROCESSING.                                         03570002
035800                                                                  03580002
035900     EVALUATE TRUE                                                03590002
036000         WHEN DP020-NEXT-ACT-INITIAL                              03600002
036100              PERFORM 1100-FIND-OBJECT-KEYS                       03610002
036200              PERFORM 4000-BUILD-INITIAL-PANEL                    03620002
036300              IF  SQLCODE = +100                                  03630002
036400                  SET DP020-NEXT-ACT-APPL-ERROR TO TRUE           03640002
036500*                 -- DATA DOES NOT EXIST --                       03650002
036600                  MOVE PC-TSYMSG-00148                            03660002
036700                                   TO DP020-MSG-NUMBER            03670002
036800                  SET DP020-MSG-INFORMATIONAL TO TRUE             03680002
036900              END-IF                                              03690002
037000                                                                  03700002
037100         WHEN DP020-NEXT-ACT-READ-MAP                             03710002
037200             PERFORM 2000-PROCESS-PANEL                           03720002
037300                                                                  03730002
037400         WHEN DP020-NEXT-ACT-RETURN                               03740002
037500             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 03750002
037600             PERFORM 3000-EDIT-DATA-IN-COMMAREA                   03760002
037700                                                                  03770002
037800         WHEN OTHER                                               03780002
037900             SET DP013-LOGIC-ABEND TO TRUE                        03790002
038000             SET DP013-NO-ROLLBACK TO TRUE                        03800002
038100             MOVE '1000-CONTROL-PROCESSING'                       03810002
038200                                   TO DP013-PARAGRAPH             03820002
038300             MOVE 'INVALID NEXT ACTIVITY RETURNED TO APPL PGM:'   03830002
038400                                   TO DP013-MESSAGE-TEXT(1)       03840002
038500             MOVE DP020-NEXT-APPL-ACTIVITY                        03850002
038600                                   TO DP013-MESSAGE-TEXT(2)       03860002
038700             PERFORM DP013-0000-PROCESS-ABEND                     03870002
038800     END-EVALUATE.                                                03880002
038900******************************************************************03890002
039000** DETERMINE THE KEY OF THE OBJECT TO BE UPDATED BASED ON THE   **03900002
039100** INTER-APPLICATION FORMAT CODE.                               **03910002
039200******************************************************************03920002
039300 1100-FIND-OBJECT-KEYS.                                           03930002
039400     INITIALIZE ASC-SPECIFIC-COMMAREA.                            03940002
039500     MOVE DP020-INT-APPL-FORMAT-IND                               03950002
039600                                   TO ASC-INT-APPL-FORMAT-IND.    03960002
039700     EVALUATE DP020-INT-APPL-FORMAT-IND                           03970002
039800         WHEN PC-INTER-APPL-CRIT-SPEC                             03980002
039900                 MOVE RD034-CUST-ID                               03990002
040000                               TO ASC-KEY-CUST-ID                 04000002
040100                 MOVE RD034-TERMINAL                              04010002
040200                               TO ASC-KEY-TERMINAL                04020002
040300                 MOVE RD034-TRANSACTION                           04030002
040400                               TO ASC-KEY-TRANSACTION             04040002
040500                 MOVE RD034-SEQ-NBR                               04050002
040600                               TO ASC-KEY-SEQ-NBR                 04060002
040700         WHEN OTHER                                               04070002
040800*             -- DATA DOES NOT EXIST --                           04080002
040900              MOVE PC-TSYMSG-00148                                04090002
041000                               TO DP020-MSG-NUMBER                04100002
041100              SET DP020-MSG-FATAL TO TRUE                         04110002
041200              SET DP020-NEXT-ACT-APPL-ERROR TO TRUE               04120002
041300     END-EVALUATE.                                                04130002
041400                                                                  04140002
041500*----------------------------------------------------------------*04150002
041600* DO ANY PROCESSING FOR KEYS FOR WHICH NO EDITTING OF THE DATA   *04160002
041700* ON THE SCREEN NEEDS TO BE DONE.  IF ONE OF THOSE KEYS IS NOT   *04170002
041800* USED, EDIT THE DATA ON THE SCREEN AND GO ON TO CHECK THE REST  *04180002
041900* OF THE FUNCTION KEYS.  NOTE THAT WITH THE API, NO INVALID      *04190002
042000* FUNCTION KEYS CAN GET THIS FAR.                                *04200002
042100*----------------------------------------------------------------*04210002
042200 2000-PROCESS-PANEL.                                              04220002
042300                                                                  04230002
042400     EVALUATE TRUE                                                04240002
042500                                                                  04250002
042600         WHEN DP020-SRC-AID = DP016-CLEAR                         04260002
042700             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 04270002
042800             PERFORM 3000-EDIT-DATA-IN-COMMAREA                   04280002
042900                                                                  04290002
043000         WHEN DP020-FK-REFRESH(DP020-SRC-AID)                     04300002
043100             SET DP030-DONT-ERASE                                 04310002
043200                 DP030-SEND-DATAONLY (PC-APPL-MAP)                04320002
043300                                   TO TRUE                        04330002
043400                 MOVE RD034-CUST-ID                               04340002
043500                               TO ASC-KEY-CUST-ID                 04350002
043600                 MOVE RD034-TERMINAL                              04360002
043700                               TO ASC-KEY-TERMINAL                04370002
043800                 MOVE RD034-TRANSACTION                           04380002
043900                               TO ASC-KEY-TRANSACTION             04390002
044000                 MOVE RD034-SEQ-NBR                               04400002
044100                               TO ASC-KEY-SEQ-NBR                 04410002
044200             PERFORM 4000-BUILD-INITIAL-PANEL                     04420002
044300             PERFORM 3200-RESET-ATTRIBUTES                        04430002
044400                                                                  04440002
044500         WHEN OTHER                                               04450002
044600             PERFORM 2200-MOVE-SCREEN-TO-COMMAREA                 04460002
044700             PERFORM 3000-EDIT-DATA-IN-COMMAREA                   04470002
044800             IF  ASC-NO-ERROR                                     04480002
044900                 SET DP030-CONTINUE-GO                            04490002
045000                                   TO TRUE                        04500002
045100                 PERFORM 2100-CHECK-FUNCTION-KEY                  04510002
045200             ELSE                                                 04520002
045300                 SET DP030-OVERRIDE-GO                            04530002
045400                                   TO TRUE                        04540002
045500             END-IF                                               04550002
045600                                                                  04560002
045700     END-EVALUATE.                                                04570002
045800*----------------------------------------------------------------*04580002
045900* ACT ON ANY FUNCTION KEYS THAT REQUIRE EDITS TO BE PASSED       *04590002
046000* FIRST.  NOTE THAT INVALID FUNCTION KEYS WILL NOT BE RETURNED   *04600002
046100* FROM THE CICS ARCHITECTURE API.                                *04610002
046200*----------------------------------------------------------------*04620002
046300                                                                  04630002
046400 2100-CHECK-FUNCTION-KEY.                                         04640002
046500                                                                  04650002
046600     EVALUATE TRUE                                                04660002
046700         WHEN DP020-SRC-AID = DP016-ENTER                         04670002
046800             CONTINUE                                             04680002
046900                                                                  04690002
047000*            ----- GO TO COMMENTS -----                           04700002
047100         WHEN DP020-FK-LOCAL-FUNC-02 (DP020-SRC-AID)              04710002
047200*            ----- GO TO KMRC -----                               04720002
047300         WHEN DP020-FK-LOCAL-FUNC-03 (DP020-SRC-AID)              04730002
047400             CONTINUE                                             04740002
047500                                                                  04750002
047600*            ----- UPDATE DATA BASES -----                        04760002
047700         WHEN DP020-FK-LOCAL-FUNC-01 (DP020-SRC-AID)              04770002
047800              SET DP030-CONTINUE-GO TO TRUE                       04780002
047900              PERFORM 5000-UPDATE-CUST                            04790002
048000              PERFORM 5100-UPDATE-CUSTOMER                        04800002
048100              PERFORM 5050-UPDATE-RFND                            04810002
048200              PERFORM 5150-UPDATE-CK-RFND                         04820002
048300              IF  ASC-STATUS-NO-CHNG                              04830002
048400                 CONTINUE                                         04840002
048500              ELSE                                                04850002
048600                 IF ASC-STATUS-CDE = PC-KMRC                      04860002
048700                    PERFORM 6200-INSERT-SV-COMMENT                04870002
048800                 END-IF                                           04880002
048900              END-IF                                              04890002
049000                                                                  04900002
049100              IF ASC-STATUS-CDE = PC-V                            04910002
049200                 PERFORM 6100-SETUP-INSERT                        04920002
049300                 PERFORM 6125-SELECT-MAX-REQ-NBR                  04930002
049400                 PERFORM 6175-INSERT-RFND                         04940002
049500                 MOVE PC-V TO ASC-STATUS-ORIG                     04950002
049600              END-IF                                              04960002
049700                                                                  04970002
049800              IF  ASC-NO-ERROR                                    04980002
049900*                 --- UPDATES SUCCESSFUL ---                      04990002
050000                  MOVE PC-TSYMSG-00059  TO DP020-MSG-NUMBER       05000002
050100                  SET DP020-MSG-INFORMATIONAL                     05010002
050200                                   TO TRUE                        05020002
050300              END-IF                                              05030002
050400                                                                  05040002
050500                                                                  05050002
050600         WHEN OTHER                                               05060002
050700             SET DP013-NO-ROLLBACK                                05070002
050800                 DP013-XCTL-DISPLAY-RESTART                       05080002
050900                 DP013-CICS-ABEND  TO TRUE                        05090002
051000             MOVE '2100-CHECK-FUNCTION-KEY'                       05100002
051100                                   TO DP013-PARAGRAPH             05110002
051200             MOVE 'INVALID FUNCTION KEY NOT CAPTURED BY API'      05120002
051300                                   TO DP013-MESSAGE-TEXT (1)      05130002
051400             PERFORM DP013-0000-PROCESS-ABEND                     05140002
051500     END-EVALUATE.                                                05150002
051600                                                                  05160002
051700*----------------------------------------------------------------*05170002
051800* MOVE DATA ENTERED ON THE SCREEN INTO THEIR RESPECTIVE FIELDS   *05180002
051900* IN THE APPLICATION-SPECIFIC COMMAREA.  ALL EDITS ARE DONE IN   *05190002
052000* THE APPLICATION-SPECIFIC COMMAERA, NOT ON THE SCREEN.          *05200002
052100*----------------------------------------------------------------*05210002
052200 2200-MOVE-SCREEN-TO-COMMAREA.                                    05220002
052300                                                                  05230002
052400     IF  ALASTNML > ZERO                                          05240002
052500         MOVE ALASTNMI              TO ASC-LAST-NAME              05250002
052600     ELSE                                                         05260002
052700         IF  ALASTNMF = DP015-ERASE-EOF                           05270002
052800             MOVE SPACE            TO ASC-LAST-NAME               05280002
052900         END-IF                                                   05290002
053000     END-IF.                                                      05300002
053100                                                                  05310002
053200     IF  AFRSTNML > ZERO                                          05320002
053300         MOVE AFRSTNMI              TO ASC-FIRST-NAME             05330002
053400     ELSE                                                         05340002
053500         IF  AFRSTNMF = DP015-ERASE-EOF                           05350002
053600             MOVE SPACE            TO ASC-FIRST-NAME              05360002
053700         END-IF                                                   05370002
053800     END-IF.                                                      05380002
053900                                                                  05390002
054000     IF  ADRVLICL > ZERO                                          05400002
054100         MOVE ADRVLICI              TO ASC-DRIVERS-LIC            05410002
054200     ELSE                                                         05420002
054300         IF  ADRVLICF = DP015-ERASE-EOF                           05430002
054400             MOVE SPACE            TO ASC-DRIVERS-LIC             05440002
054500         END-IF                                                   05450002
054600     END-IF.                                                      05460002
054700                                                                  05470002
054800     IF  AADDLN1L > ZERO                                          05480002
054900         MOVE AADDLN1I              TO ASC-ADDRESS1               05490002
055000     ELSE                                                         05500002
055100         IF  AADDLN1F = DP015-ERASE-EOF                           05510002
055200             MOVE SPACE            TO ASC-ADDRESS1                05520002
055300         END-IF                                                   05530002
055400     END-IF.                                                      05540002
055500                                                                  05550002
055600     IF  AADDLN2L > ZERO                                          05560002
055700         MOVE AADDLN2I              TO ASC-ADDRESS2               05570002
055800     ELSE                                                         05580002
055900         IF  AADDLN2F = DP015-ERASE-EOF                           05590002
056000             MOVE SPACE            TO ASC-ADDRESS2                05600002
056100         END-IF                                                   05610002
056200     END-IF.                                                      05620002
056300                                                                  05630002
056400     IF  ACITYNML > ZERO                                          05640002
056500         MOVE ACITYNMI              TO ASC-CITY                   05650002
056600     ELSE                                                         05660002
056700         IF  ACITYNMF = DP015-ERASE-EOF                           05670002
056800             MOVE SPACE            TO ASC-CITY                    05680002
056900         END-IF                                                   05690002
057000     END-IF.                                                      05700002
057100                                                                  05710002
057200     IF  ASTCODEL > ZERO                                          05720002
057300         MOVE ASTCODEI              TO ASC-STATE                  05730002
057400     ELSE                                                         05740002
057500         IF  ASTCODEF = DP015-ERASE-EOF                           05750002
057600             MOVE SPACE            TO ASC-STATE                   05760002
057700         END-IF                                                   05770002
057800     END-IF.                                                      05780002
057900                                                                  05790002
058000     IF  APSTLCDL > ZERO                                          05800002
058100         MOVE APSTLCDI              TO ASC-ZIP                    05810002
058200     ELSE                                                         05820002
058300         IF  APSTLCDF = DP015-ERASE-EOF                           05830002
058400             MOVE SPACE            TO ASC-ZIP                     05840002
058500         END-IF                                                   05850002
058600     END-IF.                                                      05860002
058700                                                                  05870002
058800     IF  APHNNBRL > ZERO                                          05880002
058900         MOVE APHNNBRI              TO ASC-PHONE                  05890002
059000     ELSE                                                         05900002
059100         IF  APHNNBRF = DP015-ERASE-EOF                           05910002
059200             MOVE SPACE            TO ASC-PHONE                   05920002
059300         END-IF                                                   05930002
059400     END-IF.                                                      05940002
059500                                                                  05950002
059600     IF  AADJAMTL > ZERO                                          05960002
059700         MOVE AADJAMTI              TO ASC-RFND-AMT-ADJX          05970002
059800     ELSE                                                         05980002
059900         IF  AADJAMTF = DP015-ERASE-EOF                           05990002
060000             MOVE ZEROES           TO ASC-RFND-AMT-ADJX           06000002
060100         END-IF                                                   06010002
060200     END-IF.                                                      06020002
060300                                                                  06030002
060400     IF  ACORPEJL > ZERO                                          06040002
060500         MOVE ACORPEJI              TO ASC-CORP-EJ                06050002
060600     ELSE                                                         06060002
060700         IF  ACORPEJF = DP015-ERASE-EOF                           06070002
060800             MOVE SPACE            TO ASC-CORP-EJ                 06080002
060900         END-IF                                                   06090002
061000     END-IF.                                                      06100002
061100                                                                  06110002
061200     IF  ACHKSYSL > ZERO                                          06120002
061300         MOVE ACHKSYSI              TO ASC-CK-SYS-CK              06130002
061400     ELSE                                                         06140002
061500         IF  ACHKSYSF = DP015-ERASE-EOF                           06150002
061600             MOVE SPACE            TO ASC-CK-SYS-CK               06160002
061700         END-IF                                                   06170002
061800     END-IF.                                                      06180002
061900                                                                  06190002
062000     IF  AGIFTCKL > ZERO                                          06200002
062100         MOVE AGIFTCKI              TO ASC-GIFT-CK                06210002
062200     ELSE                                                         06220002
062300         IF  AGIFTCKF = DP015-ERASE-EOF                           06230002
062400             MOVE SPACE            TO ASC-GIFT-CK                 06240002
062500         END-IF                                                   06250002
062600     END-IF.                                                      06260002
062700                                                                  06270002
062800     IF  ASTATCDL > ZERO                                          06280002
062900         MOVE ASTATCDI              TO ASC-STATUS-CDE             06290002
063000         SET ASC-STATUS-CHNG        TO TRUE                       06300002
063100     ELSE                                                         06310002
063200         IF  ASTATCDF = DP015-ERASE-EOF                           06320002
063300             MOVE SPACE             TO ASC-STATUS-CDE             06330002
063400         END-IF                                                   06340002
063500     END-IF.                                                      06350002
063600                                                                  06360002
063700     IF  AKMRCNOL > ZERO                                          06370002
063800         MOVE AKMRCNOI              TO ASC-KMRC-NBRX              06380002
063900     ELSE                                                         06390002
064000         IF  AKMRCNOF = DP015-ERASE-EOF                           06400002
064100             MOVE SPACES           TO ASC-KMRC-NBRX               06410002
064200         END-IF                                                   06420002
064300     END-IF.                                                      06430002
064400                                                                  06440002
064500     IF  ASC-NO-ERROR                                             06450002
064600         MOVE -1                   TO ALASTNML                    06460002
064700         SET DP030-SET-CURSOR-APPL-1                              06470002
064800                                   TO TRUE                        06480002
064900     END-IF.                                                      06490002
065000*                                                                 06500002
065100*----------------------------------------------------------------*06510002
065200* PERFORM EDITS ON EACH FIELD ENTERED BY THE USER.  IF AN ERROR  *06520002
065300* IS FOUND, THE CURSOR IS POSITIONED AT THAT FIELD AND AN        *06530002
065400* APPROPRIATE ERROR MESSAGE IS DISPLAYED.                        *06540002
065500*----------------------------------------------------------------*06550002
065600*                                                                 06560002
065700 3000-EDIT-DATA-IN-COMMAREA.                                      06570002
065800     PERFORM 3200-RESET-ATTRIBUTES.                               06580002
065900     PERFORM 4500-GET-STATUS-DESC.                                06590002
066000     MOVE ASC-STATUS-DESC          TO ACDEDESO.                   06600002
066100                                                                  06610002
066200     SET ASC-NO-ERROR TO TRUE.                                    06620002
066300                                                                  06630002
066400     IF  ASC-RFND-AMT-ADJX > SPACE                                06640002
066500         MOVE ASC-RFND-AMT-ADJX   TO DP010I-UNEDITED-FIELD        06650002
066600         MOVE LENGTH OF ASC-RFND-AMT-ADJX                         06660002
066700                                   TO DP010I-MAXIMUM-DIGITS       06670002
066800         MOVE 2                    TO DP010I-MAXIMUM-DECIMALS     06680002
066900         SET DP010I-NEGATIVE-NOT-ALLOWED TO TRUE                  06690002
067010         CALL DP010I-NUMERIC-EDIT-ROUTINE                         06701003
067020                         USING DP010I-NUMERIC-EDIT-AREA           06702003
067100         IF  DP010I-ERROR-DETECTED                                06710002
067200             SET ASC-ERROR                                        06720002
067300                 DP020-MSG-FATAL   TO TRUE                        06730002
067400*            --- MUST BE NUMERIC ---                              06740002
067500             MOVE PC-TSYMSG-00008  TO DP020-MSG-NUMBER            06750002
067600             MOVE DP015-UNP-NUM-BRT-OFF                           06760002
067700                                   TO AADJAMTA                    06770002
067800             MOVE DP015-RED        TO AADJAMTC                    06780002
067900             MOVE DP015-REVERSE    TO AADJAMTH                    06790002
068000             MOVE -1               TO AADJAMTL                    06800002
068100             SET DP030-SET-CURSOR-APPL-1 TO TRUE                  06810002
068200         ELSE                                                     06820002
068300             MOVE DP010I-NUMERIC-FIELD                            06830002
068400                                   TO ASC-RFND-AMT-ADJ            06840002
068500                                      AADJAMTO                    06850002
068600             IF DP010I-NUMERIC-FIELD = ZEROS                      06860002
068700                 SET ASC-ERROR                                    06870002
068800                     DP020-MSG-FATAL                              06880002
068900                                   TO TRUE                        06890002
069000*                --- CANNOT BE ZERO ---                           06900002
069100                 MOVE PC-TSYMSG-00010                             06910002
069200                                   TO DP020-MSG-NUMBER            06920002
069300                 MOVE DP015-UNP-NUM-BRT-OFF                       06930002
069400                                   TO AADJAMTA                    06940002
069500                 MOVE DP015-RED    TO AADJAMTC                    06950002
069600                 MOVE DP015-REVERSE                               06960002
069700                                   TO AADJAMTH                    06970002
069800                 MOVE -1           TO AADJAMTL                    06980002
069900                 SET DP030-SET-CURSOR-APPL-1 TO TRUE              06990002
070000             END-IF                                               07000002
070100         END-IF                                                   07010002
070200     END-IF.                                                      07020002
070300*                                                                 07030002
070400     IF  ASC-STATUS-NO-CHNG                                       07040002
070500         CONTINUE                                                 07050002
070600     ELSE                                                         07060002
070700         MOVE ASC-STATUS-CDE       TO PC-STATUS-CODES             07070002
070800         IF NOT PC-VALID-STATUS-CODE                              07080002
070900             SET ASC-ERROR                                        07090002
071000                 DP020-MSG-FATAL   TO TRUE                        07100002
071100*    ------- 00005-E-INVALID VALUE                                07110002
071200             MOVE PC-TSYMSG-00005  TO DP020-MSG-NUMBER            07120002
071300             MOVE DP015-UNP-ALP-BRT-OFF                           07130002
071400                                   TO ASTATCDA                    07140002
071500             MOVE DP015-RED        TO ASTATCDC                    07150002
071600             MOVE DP015-REVERSE    TO ASTATCDH                    07160002
071700             MOVE -1               TO ASTATCDL                    07170002
071800             SET DP030-SET-CURSOR-APPL-1 TO TRUE                  07180002
071900     END-IF.                                                      07190002
072000*                                                                 07200002
072100     IF  ASC-STATUS-NO-CHNG                                       07210002
072200         CONTINUE                                                 07220002
072300     ELSE                                                         07230002
072400       IF ASC-CORP-EJ    > SPACE AND                              07240002
072500          ASC-GIFT-CK    > SPACE AND                              07250002
072600          ASC-CK-SYS-CK  > SPACE                                  07260002
072700         CONTINUE                                                 07270002
072800       ELSE                                                       07280002
072900         IF ASC-CORP-EJ = SPACE                                   07290002
073000            SET ASC-ERROR                                         07300002
073100                DP020-MSG-FATAL   TO TRUE                         07310002
073200*   ------- 00007-E-REQUIRED-ENTRY                                07320002
073300            MOVE PC-TSYMSG-00007  TO DP020-MSG-NUMBER             07330002
073400            MOVE DP015-UNP-ALP-BRT-OFF                            07340002
073500                                  TO ACORPEJA                     07350002
073600            MOVE DP015-RED        TO ACORPEJC                     07360002
073700            MOVE DP015-REVERSE    TO ACORPEJH                     07370002
073800            MOVE -1               TO ACORPEJL                     07380002
073900            SET DP030-SET-CURSOR-APPL-1 TO TRUE                   07390002
074000         END-IF                                                   07400002
074100         IF ASC-CK-SYS-CK = SPACE                                 07410002
074200            SET ASC-ERROR                                         07420002
074300                DP020-MSG-FATAL   TO TRUE                         07430002
074400*   ------- 00007-E-REQUIRED-ENTRY                                07440002
074500            MOVE PC-TSYMSG-00007  TO DP020-MSG-NUMBER             07450002
074600            MOVE DP015-UNP-ALP-BRT-OFF                            07460002
074700                                  TO ACHKSYSA                     07470002
074800            MOVE DP015-RED        TO ACHKSYSC                     07480002
074900            MOVE DP015-REVERSE    TO ACHKSYSH                     07490002
075000            MOVE -1               TO ACHKSYSL                     07500002
075100            SET DP030-SET-CURSOR-APPL-1 TO TRUE                   07510002
075200         END-IF                                                   07520002
075300         IF ASC-GIFT-CK = SPACE                                   07530002
075400            SET ASC-ERROR                                         07540002
075500                DP020-MSG-FATAL   TO TRUE                         07550002
075600*   ------- 00007-E-REQUIRED-ENTRY                                07560002
075700            MOVE PC-TSYMSG-00007  TO DP020-MSG-NUMBER             07570002
075800            MOVE DP015-UNP-ALP-BRT-OFF                            07580002
075900                                  TO AGIFTCKA                     07590002
076000            MOVE DP015-RED        TO AGIFTCKC                     07600002
076100            MOVE DP015-REVERSE    TO AGIFTCKH                     07610002
076200            MOVE -1               TO AGIFTCKL                     07620002
076300            SET DP030-SET-CURSOR-APPL-1 TO TRUE                   07630002
076400         END-IF                                                   07640002
076500       END-IF                                                     07650002
076600     END-IF.                                                      07660002
076700*                                                                 07670002
076800                                                                  07680002
076900     IF  ASC-CORP-EJ > SPACE                                      07690002
077000         MOVE ASC-CORP-EJ          TO PV-CORP-SYS-GIFT-CODE       07700002
077100         IF NOT PV-VALID-CORP-SYS-GIFT-CODE                       07710002
077200             SET ASC-ERROR                                        07720002
077300                 DP020-MSG-FATAL   TO TRUE                        07730002
077400*    ------- 00005-E-INVALID VALUE                                07740002
077500             MOVE PC-TSYMSG-00005  TO DP020-MSG-NUMBER            07750002
077600             MOVE DP015-UNP-ALP-BRT-OFF                           07760002
077700                                   TO ACORPEJA                    07770002
077800             MOVE DP015-RED        TO ACORPEJC                    07780002
077900             MOVE DP015-REVERSE    TO ACORPEJH                    07790002
078000             MOVE -1               TO ACORPEJL                    07800002
078100             SET DP030-SET-CURSOR-APPL-1 TO TRUE                  07810002
078200         END-IF                                                   07820002
078300     END-IF.                                                      07830002
078400                                                                  07840002
078500     IF  ASC-CK-SYS-CK > SPACE                                    07850002
078600         MOVE ASC-CK-SYS-CK        TO PV-CORP-SYS-GIFT-CODE       07860002
078700         IF NOT PV-VALID-CORP-SYS-GIFT-CODE                       07870002
078800             SET ASC-ERROR                                        07880002
078900                 DP020-MSG-FATAL   TO TRUE                        07890002
079000*    ------- 00005-E-INVALID VALUE                                07900002
079100             MOVE PC-TSYMSG-00005  TO DP020-MSG-NUMBER            07910002
079200             MOVE DP015-UNP-ALP-BRT-OFF                           07920002
079300                                   TO ACHKSYSA                    07930002
079400             MOVE DP015-RED        TO ACHKSYSC                    07940002
079500             MOVE DP015-REVERSE    TO ACHKSYSH                    07950002
079600             MOVE -1               TO ACHKSYSL                    07960002
079700             SET DP030-SET-CURSOR-APPL-1 TO TRUE                  07970002
079800         END-IF                                                   07980002
079900     END-IF.                                                      07990002
080000                                                                  08000002
080100     IF  ASC-GIFT-CK   > SPACE                                    08010002
080200         MOVE ASC-GIFT-CK          TO PV-CORP-SYS-GIFT-CODE       08020002
080300         IF NOT PV-VALID-CORP-SYS-GIFT-CODE                       08030002
080400             SET ASC-ERROR                                        08040002
080500                 DP020-MSG-FATAL   TO TRUE                        08050002
080600*    ------- 00005-E-INVALID VALUE                                08060002
080700             MOVE PC-TSYMSG-00005  TO DP020-MSG-NUMBER            08070002
080800             MOVE DP015-UNP-ALP-BRT-OFF                           08080002
080900                                   TO AGIFTCKA                    08090002
081000             MOVE DP015-RED        TO AGIFTCKC                    08100002
081100             MOVE DP015-REVERSE    TO AGIFTCKH                    08110002
081200             MOVE -1               TO AGIFTCKL                    08120002
081300             SET DP030-SET-CURSOR-APPL-1 TO TRUE                  08130002
081400         END-IF                                                   08140002
081500     END-IF.                                                      08150002
081600                                                                  08160002
081700     IF  ASC-DRIVERS-LIC > SPACE                                  08170002
081800        MOVE SPACES TO RDWS500-INPUT-DL                           08180006
081900                       RDWS500-OUTPUT-DL                          08190006
082000        MOVE FUNCTION UPPER-CASE(ASC-DRIVERS-LIC)                 08200002
082100                    TO RDWS500-INPUT-DL                           08210006
082200        PERFORM PD500-SHIFT-CONV-ALPHA-DL                         08220002
082300           THRU PD500-EXIT                                        08230002
082400        MOVE RDWS500-OUTPUT-DL TO ASC-DRIVERS-LIC                 08240006
081800*       MOVE SPACES TO CRWS500-INPUT-DL                           08241006
081900*                      CRWS500-OUTPUT-DL                          08242006
082000*       MOVE FUNCTION UPPER-CASE(ASC-DRIVERS-LIC)                 08243006
082100*                   TO CRWS500-INPUT-DL                           08244006
082200*       PERFORM PD500-SHIFT-CONV-ALPHA-DL                         08245006
082300*          THRU PD500-EXIT                                        08246006
082400*       MOVE CRWS500-OUTPUT-DL TO ASC-DRIVERS-LIC                 08247006
082500     END-IF.                                                      08250002
082600                                                                  08260002
082700     IF ASC-STATUS-CDE = PC-V                                     08270002
082800           AND ASC-STATUS-ORIG = PC-V                             08280002
082900             SET ASC-ERROR                                        08290002
083000                 DP020-MSG-FATAL   TO TRUE                        08300002
083100*    ------- 01236-E-INVALID VALUE                                08310002
083200             MOVE PC-TSYMSG-01236  TO DP020-MSG-NUMBER            08320002
083300             MOVE DP015-UNP-ALP-BRT-OFF                           08330002
083400                                   TO ASTATCDA                    08340002
083500             MOVE DP015-RED        TO ASTATCDC                    08350002
083600             MOVE DP015-REVERSE    TO ASTATCDH                    08360002
083700             MOVE -1               TO ASTATCDL                    08370002
083800             SET DP030-SET-CURSOR-APPL-1 TO TRUE                  08380002
083900     ELSE                                                         08390002
084000        IF ASC-STATUS-CDE = PC-V                                  08400002
084100           AND ASC-CHECK-NBR NOT > 0                              08410002
084200             SET ASC-ERROR                                        08420002
084300                 DP020-MSG-FATAL   TO TRUE                        08430002
084400*    ------- 03096-E-TRANSACTION HAS NO CHECK TO VOID             08440002
084500             MOVE PC-TSYMSG-03096  TO DP020-MSG-NUMBER            08450002
084600             MOVE DP015-UNP-ALP-BRT-OFF                           08460002
084700                                   TO ASTATCDA                    08470002
084800             MOVE DP015-RED        TO ASTATCDC                    08480002
084900             MOVE DP015-REVERSE    TO ASTATCDH                    08490002
085000             MOVE -1               TO ASTATCDL                    08500002
085100             SET DP030-SET-CURSOR-APPL-1 TO TRUE                  08510002
085200        END-IF                                                    08520002
085300     END-IF.                                                      08530002
085400                                                                  08540002
085500     IF ASC-STATUS-CDE = PC-KMRC                                  08550002
085600         IF ASC-KMRC-NBRX = SPACES                                08560002
085700             SET ASC-ERROR                                        08570002
085800                 DP020-MSG-FATAL   TO TRUE                        08580002
085900*    ------- 00005-E-INVALID VALUE                                08590002
086000             MOVE PC-TSYMSG-00005  TO DP020-MSG-NUMBER            08600002
086100             MOVE DP015-UNP-ALP-BRT-OFF                           08610002
086200                                   TO AKMRCNOA                    08620002
086300             MOVE DP015-RED        TO AKMRCNOC                    08630002
086400             MOVE DP015-REVERSE    TO AKMRCNOH                    08640002
086500             MOVE -1               TO AKMRCNOL                    08650002
086600             SET DP030-SET-CURSOR-APPL-1 TO TRUE                  08660002
090500         END-IF                                                   09050002
090600     ELSE                                                         09060002
090700         IF ASC-KMRC-NBRX = ZEROES                                09070002
090800          OR ASC-KMRC-NBRX = SPACES                               09080002
090900             CONTINUE                                             09090002
091000         ELSE                                                     09100002
091100             SET ASC-ERROR                                        09110002
091200                 DP020-MSG-FATAL   TO TRUE                        09120002
091300*    ------- 00005-E-INVALID VALUE                                09130002
091400             MOVE PC-TSYMSG-00005  TO DP020-MSG-NUMBER            09140002
091500             MOVE DP015-UNP-ALP-BRT-OFF                           09150002
091600                                   TO AKMRCNOA                    09160002
091700             MOVE DP015-RED        TO AKMRCNOC                    09170002
091800             MOVE DP015-REVERSE    TO AKMRCNOH                    09180002
091900             MOVE -1               TO AKMRCNOL                    09190002
092000             SET DP030-SET-CURSOR-APPL-1 TO TRUE                  09200002
092100         END-IF                                                   09210002
092200     END-IF.                                                      09220002
092300*                                                                 09230002
092400     IF ASC-KMRC-NBRX > SPACES                                    09240002
092500         MOVE ASC-KMRC-NBRX    TO SV007-CARD-NUMBER-IN            09250002
092600         MOVE 0                TO SV007-CARD-NUMBER-LENGTH        09260002
092700         SET SV007-FORMAT-BOTH TO TRUE                            09270002
092800         MOVE 30               TO SV007-CARD-NUMBER-DIS-LENGTH    09280002
092900         PERFORM SV007-FORMAT-CARD                                09290002
093000         MOVE SV007-CARD-NUMBER-DISPLAY TO AKMRCNOO               09300002
093100         MOVE SV007-CARD-NBR   TO ASC-KMRC-CNVT                   09310002
093200                                  SVT00001-CRD-NBR                09320002
093201                                                                  09320102
093202         SET PS-INVALID-KMRC TO TRUE                              09320202
093203         PERFORM 3100-VALIDATE-KMRC                               09320302
093204         IF PS-VALID-KMRC                                         09320402
093300             CONTINUE                                             09330002
093400         ELSE                                                     09340002
093500             SET ASC-ERROR                                        09350002
093600                 DP020-MSG-FATAL         TO TRUE                  09360002
093700*    ------- 00005-E-INVALID VALUE                                09370002
093800             MOVE PC-TSYMSG-00005        TO DP020-MSG-NUMBER      09380002
093900             MOVE DP015-UNP-ALP-BRT-OFF  TO AKMRCNOA              09390002
094000             MOVE DP015-RED              TO AKMRCNOC              09400002
094100             MOVE DP015-REVERSE          TO AKMRCNOH              09410002
094200             MOVE -1                     TO AKMRCNOL              09420002
094300             SET DP030-SET-CURSOR-APPL-1 TO TRUE                  09430002
094400         END-IF                                                   09440002
094500     END-IF.                                                      09450002
094600                                                                  09460002
094700     IF  ASC-NO-ERROR                                             09470002
094800         MOVE -1                   TO ALASTNML                    09480002
094900         SET DP030-SET-CURSOR-APPL-1                              09490002
095000                                   TO TRUE                        09500002
095100     END-IF.                                                      09510002
095200*                                                                 09520002
095300*----------------------------------------------------------------*09530002
095400* VALIDATE THE KMRC NUMBER ENTERED                               *09540002
095500*----------------------------------------------------------------*09550002
095600 3100-VALIDATE-KMRC.                                              09560002
095700                                                                  09570002
095800     PERFORM WITH TEST AFTER                                      09580002
095900         VARYING PV-RETRY-COUNTER                                 09590002
096000         FROM 1 BY 1                                              09600002
096100         UNTIL (PV-RETRY-COUNTER > PC-MAX-RETRIES                 09610002
096200                OR SQLCODE = +100                                 09620002
096300                OR SQLCODE = 0)                                   09630002
096400                                                                  09640002
096500         EXEC SQL                                                 09650002
096600             SELECT 'Y'                                           09660002
096700               INTO :PS-VALID-KMRC-SW                             09670002
096800               FROM SVT_KOHLS_CRD_ACCT                            09680002
096900              WHERE CRD_NBR = :SVT00001-CRD-NBR                   09690002
097000                AND CRD_STAT_CDE = 'AV'                           09700002
097010              WITH UR                                             09701002
097100         END-EXEC                                                 09710002
097200                                                                  09720002
097300         EVALUATE TRUE                                            09730002
097400             WHEN SQLCODE = 0                                     09740002
097500             WHEN SQLCODE = +100                                  09750002
097600             WHEN SQLCODE = -911                                  09760002
097700                 CONTINUE                                         09770002
097800             WHEN OTHER                                           09780002
097900                 MOVE '3100-VALIDATE-KMRC         '               09790002
098000                                      TO DP013-PARAGRAPH          09800002
098100                 MOVE 'FIND KMRC NUMBER             '             09810002
098200                                      TO DP013-MESSAGE-TEXT (1)   09820002
098300                 MOVE SQLCA           TO DP013-SQLCA              09830002
098400                 MOVE 'SVT_KOHLS_CRD_ACCT'                        09840002
098500                                      TO DP013-DB2-TABLE-NAME(1)  09850002
098600                 SET DP013-DB2-ABEND                              09860002
098700                     DP013-XCTL-DISPLAY-RESTART TO TRUE           09870002
098800                 PERFORM DP013-0000-PROCESS-ABEND                 09880002
098900         END-EVALUATE                                             09890002
099000     END-PERFORM.                                                 09900002
099100                                                                  09910002
099200     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         09920002
099300         MOVE '3100-VALIDATE-KMRC         '                       09930002
099400                                      TO DP013-PARAGRAPH          09940002
099500         MOVE 'SELECT RETRIES EXCEEDED       '                    09950002
099600                                      TO DP013-MESSAGE-TEXT (1)   09960002
099700         MOVE SQLCA                   TO DP013-SQLCA              09970002
099800         MOVE 'SVT_KOHLS_CRD_ACCT'    TO DP013-DB2-TABLE-NAME(1)  09980002
099900         SET DP013-DB2-ABEND                                      09990002
100000             DP013-XCTL-DISPLAY-RESTART TO TRUE                   10000002
100100         PERFORM DP013-0000-PROCESS-ABEND                         10010002
100200     END-IF.                                                      10020002
100300                                                                  10030002
100400*----------------------------------------------------------------*10040002
100500* MOVE THE DEFAULT ATTRIBUTE VALUES TO THE ENTERABLE FIELDS ON   *10050002
100600* MAP.                                                           *10060002
100700*----------------------------------------------------------------*10070002
100800 3200-RESET-ATTRIBUTES.                                           10080002
100900     MOVE DP015-UNP-ALP-NOR-OFF    TO                             10090002
101000                  ALASTNMA                                        10100002
101100                  AFRSTNMA                                        10110002
101200                  ADRVLICA                                        10120002
101300                  AADDLN1A                                        10130002
101400                  AADDLN2A                                        10140002
101500                  ACITYNMA                                        10150002
101600                  ASTCODEA                                        10160002
101700                  APSTLCDA                                        10170002
101800                  APHNNBRA                                        10180002
101900                  AADJAMTA                                        10190002
102000                  ACORPEJA                                        10200002
102100                  ACHKSYSA                                        10210002
102200                  AGIFTCKA                                        10220002
102300                  ASTATCDA                                        10230002
102400                  AKMRCNOA.                                       10240002
102500                                                                  10250002
102600     MOVE DP015-GREEN              TO                             10260002
102700                  ALASTNMC                                        10270002
102800                  AFRSTNMC                                        10280002
102900                  ADRVLICC                                        10290002
103000                  AADDLN1C                                        10300002
103100                  AADDLN2C                                        10310002
103200                  ACITYNMC                                        10320002
103300                  ASTCODEC                                        10330002
103400                  APSTLCDC                                        10340002
103500                  APHNNBRC                                        10350002
103600                  AADJAMTC                                        10360002
103700                  ACORPEJC                                        10370002
103800                  ACHKSYSC                                        10380002
103900                  AGIFTCKC                                        10390002
104000                  ASTATCDC                                        10400002
104100                  AKMRCNOC.                                       10410002
104200                                                                  10420002
104300     MOVE DP015-UNDERLINE          TO                             10430002
104400                  ALASTNMH                                        10440002
104500                  AFRSTNMH                                        10450002
104600                  ADRVLICH                                        10460002
104700                  AADDLN1H                                        10470002
104800                  AADDLN2H                                        10480002
104900                  ACITYNMH                                        10490002
105000                  ASTCODEH                                        10500002
105100                  APSTLCDH                                        10510002
105200                  APHNNBRH                                        10520002
105300                  AADJAMTH                                        10530002
105400                  ACORPEJH                                        10540002
105500                  ACHKSYSH                                        10550002
105600                  AGIFTCKH                                        10560002
105700                  ASTATCDH                                        10570002
105800                  AKMRCNOH.                                       10580002
105900*                                                                 10590002
106000*----------------------------------------------------------------*10600002
106100*    VALIDATE THE QUEUE WAS PASSED AND DISPLAY FOR THE FIRST     *10610002
106200*    ENTRY.                                                      *10620002
106300*----------------------------------------------------------------*10630002
106400                                                                  10640002
106500 4000-BUILD-INITIAL-PANEL.                                        10650002
106600     SET DP030-SET-CURSOR-APPL-1   TO TRUE                        10660002
106700     MOVE -1                       TO ALASTNML.                   10670002
106800                                                                  10680002
106900     PERFORM 4320-SELECT-RDT-MAL-CK-RFND.                         10690002
107000                                                                  10700002
107100     MOVE RDT00000-LAST-NM         TO ASC-LAST-NAME.              10710002
107200     MOVE RDT00000-FRST-NM         TO ASC-FIRST-NAME.             10720002
107300     MOVE RDT00000-M2A-LNE-1-ADDR  TO ASC-ADDRESS1.               10730002
107400     MOVE RDT00000-M2A-LNE-2-ADDR  TO ASC-ADDRESS2.               10740002
107500     MOVE RDT00000-M2A-CTY-NM      TO ASC-CITY.                   10750002
107600     MOVE RDT00000-M2A-ST-CDE      TO ASC-STATE.                  10760002
107700     MOVE RDT00000-M2A-PSTL-CDE    TO ASC-ZIP.                    10770002
107800     MOVE RDT00000-DRV-LIC-NBR     TO ASC-DRIVERS-LIC.            10780002
107900                                                                  10790002
108000     IF IV-PHN-NBR = 0                                            10800002
108100        MOVE RDT00000-PHN-NBR      TO ASC-PHONE                   10810002
108200     ELSE                                                         10820002
108300        MOVE SPACES                TO ASC-PHONE                   10830002
108400     END-IF.                                                      10840002
108500                                                                  10850002
108600     MOVE RDT00001-STR-NBR            TO ASC-STORE-NBR.           10860002
108700     MOVE RDT00001-RFND-REQ-DTE       TO ASC-RECEIPT-DTE.         10870002
108800     MOVE RDT00001-STR-RGST-ID        TO ASC-TERMINAL.            10880002
108900     MOVE RDT00001-RGST-TRN-NBR       TO ASC-TRANSACTION.         10890002
109000     MOVE RDT00001-RFND-SEQ-NBR       TO ASC-SEQ-NBR.             10900002
109100     MOVE RDT00001-RFND-AMT           TO ASC-RFND-AMT-ORIG.       10910002
109200                                                                  10920002
109300     IF IV-RFND-AMT-ADJ = 0                                       10930002
109400        MOVE RDT00001-ADJ-RFND-AMT       TO ASC-RFND-AMT-ADJ      10940002
109500     ELSE                                                         10950002
109600        MOVE ZEROES                      TO ASC-RFND-AMT-ADJ      10960002
109700     END-IF.                                                      10970002
109800                                                                  10980002
109900     IF IV-CORP-EJRNL-CKD-CDE = 0                                 10990002
110000        MOVE RDT00001-CORP-EJRNL-CKD-CDE TO ASC-CORP-EJ           11000002
110100     ELSE                                                         11010002
110200        MOVE SPACES                      TO ASC-CORP-EJ           11020002
110300     END-IF.                                                      11030002
110400                                                                  11040002
110500     IF IV-CK-SYS-CKD-CDE = 0                                     11050002
110600        MOVE RDT00001-CK-SYS-CKD-CDE  TO ASC-CK-SYS-CK            11060002
110700     ELSE                                                         11070002
110800        MOVE SPACES                   TO ASC-CK-SYS-CK            11080002
110900     END-IF.                                                      11090002
111000                                                                  11100002
111100     IF IV-GR-CKD-CDE = 0                                         11110002
111200        MOVE RDT00001-GR-CKD-CDE      TO ASC-GIFT-CK              11120002
111300     ELSE                                                         11130002
111400        MOVE SPACES                   TO ASC-GIFT-CK              11140002
111500     END-IF.                                                      11150002
111600                                                                  11160002
111700     MOVE RDT00001-RFND-STAT-CDE      TO ASC-STATUS-CDE.          11170002
111800     MOVE RDT00001-RFND-STAT-CDE      TO ASC-STATUS-ORIG.         11180002
111900                                                                  11190002
112000     IF IV-STAT-CHNG-DTE = 0                                      11200002
112100        MOVE RDT00001-STAT-CHNG-DTE   TO ASC-STATUS-DATE          11210002
112200     ELSE                                                         11220002
112300        MOVE SPACES                   TO ASC-STATUS-DATE          11230002
112400     END-IF.                                                      11240002
112500                                                                  11250002
112600     IF IV-RFND-CK-DTE = 0                                        11260002
112700        MOVE RDT00001-RFND-CK-DTE     TO ASC-CHECK-DATE           11270002
112800     ELSE                                                         11280002
112900        MOVE SPACES                   TO ASC-CHECK-DATE           11290002
113000     END-IF.                                                      11300002
113100                                                                  11310002
113200     IF IV-RFND-CK-NBR = 0                                        11320002
113300        MOVE RDT00001-RFND-CK-NBR     TO ASC-CHECK-NBR            11330002
113400     ELSE                                                         11340002
113500        MOVE ZEROES                   TO ASC-CHECK-NBR            11350002
113600     END-IF.                                                      11360002
113700                                                                  11370002
113800     IF IV-KMRC-CRD-NBR = 0                                       11380002
113900        MOVE RDT00001-KMRC-CRD-NBR    TO ASC-KMRC-NBR             11390002
114000     END-IF.                                                      11400002
114100                                                                  11410002
114200     IF  SQLCODE = ZERO                                           11420002
114300         PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                     11430002
114400     ELSE                                                         11440002
114500         IF  SQLCODE = +100                                       11450002
114600             SET ASC-ERROR                                        11460002
114700                 DP020-MSG-FATAL   TO TRUE                        11470002
114800*    ------- CANNOT CHANGE - RECORD DOES NOT EXIST                11480002
114900             MOVE PC-TSYMSG-00158  TO DP020-MSG-NUMBER            11490002
115000             MOVE DP015-UNP-ALP-BRT-OFF                           11500002
115100                                   TO ALASTNMA                    11510002
115200             MOVE DP015-RED        TO ALASTNMC                    11520002
115300             MOVE DP015-REVERSE    TO ALASTNMH                    11530002
115400             MOVE -1               TO ALASTNML                    11540002
115500             SET DP030-SET-CURSOR-APPL-1 TO TRUE                  11550002
115600     END-IF.                                                      11560002
115700                                                                  11570002
115800     MOVE ASC-STORE-NBR               TO XST00001-LOC-NBR         11580002
115900     PERFORM 4340-SELECT-XST-LOC.                                 11590002
116000*----------------------------------------------------------------*11600002
116100* SELECT A ROW FROM THE DB2 RDT-MAL-CK-RFND TABLE.               *11610002
116200*----------------------------------------------------------------*11620002
116300 4320-SELECT-RDT-MAL-CK-RFND.                                     11630002
116400     PERFORM                                                      11640002
116500         WITH TEST AFTER                                          11650002
116600         VARYING PV-RETRY-COUNTER                                 11660002
116700         FROM 1 BY 1                                              11670002
116800         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               11680002
116900                   OR (SQLCODE = ZERO)                            11690002
117000                   OR (SQLCODE = +100))                           11700002
117100*                                                                 11710002
117200         EXEC SQL                                                 11720002
117300             SELECT                                               11730002
117400                   C.LAST_NM                                      11740002
117500                 , C.FRST_NM                                      11750002
117600                 , C.M2A_LNE_1_ADDR                               11760002
117700                 , C.M2A_LNE_2_ADDR                               11770002
117800                 , C.M2A_CTY_NM                                   11780002
117900                 , C.M2A_ST_CDE                                   11790002
118000                 , C.M2A_PSTL_CDE                                 11800002
118100                 , C.DRV_LIC_NBR                                  11810002
118200                 , C.PHN_NBR                                      11820002
118300                 , M.STR_NBR                                      11830002
118400                 , M.RFND_REQ_DTE                                 11840002
118500                 , M.STR_RGST_ID                                  11850002
118600                 , M.RGST_TRN_NBR                                 11860002
118700                 , M.RFND_SEQ_NBR                                 11870002
118800                 , M.RFND_AMT                                     11880002
118900                 , M.ADJ_RFND_AMT                                 11890002
119000                 , M.CORP_EJRNL_CKD_CDE                           11900002
119100                 , M.CK_SYS_CKD_CDE                               11910002
119200                 , M.GR_CKD_CDE                                   11920002
119300                 , M.RFND_STAT_CDE                                11930002
119400                 , M.STAT_CHNG_DTE                                11940002
119500                 , M.RFND_CK_DTE                                  11950002
119600                 , M.RFND_CK_NBR                                  11960002
119700                 , M.KMRC_CRD_NBR                                 11970002
119800             INTO                                                 11980002
119900                :RDT00000-LAST-NM                                 11990002
120000              , :RDT00000-FRST-NM                                 12000002
120100              , :RDT00000-M2A-LNE-1-ADDR                          12010002
120200              , :RDT00000-M2A-LNE-2-ADDR                          12020002
120300              , :RDT00000-M2A-CTY-NM                              12030002
120400              , :RDT00000-M2A-ST-CDE                              12040002
120500              , :RDT00000-M2A-PSTL-CDE                            12050002
120600              , :RDT00000-DRV-LIC-NBR                             12060002
120700              , :RDT00000-PHN-NBR:IV-PHN-NBR                      12070002
120800              , :RDT00001-STR-NBR                                 12080002
120900              , :RDT00001-RFND-REQ-DTE                            12090002
121000              , :RDT00001-STR-RGST-ID                             12100002
121100              , :RDT00001-RGST-TRN-NBR                            12110002
121200              , :RDT00001-RFND-SEQ-NBR                            12120002
121300              , :RDT00001-RFND-AMT                                12130002
121400              , :RDT00001-ADJ-RFND-AMT:IV-RFND-AMT-ADJ            12140002
121500              , :RDT00001-CORP-EJRNL-CKD-CDE:IV-CORP-EJRNL-CKD-CDE12150002
121600              , :RDT00001-CK-SYS-CKD-CDE:IV-CK-SYS-CKD-CDE        12160002
121700              , :RDT00001-GR-CKD-CDE:IV-GR-CKD-CDE                12170002
121800              , :RDT00001-RFND-STAT-CDE                           12180002
121900              , :RDT00001-STAT-CHNG-DTE:IV-STAT-CHNG-DTE          12190002
122000              , :RDT00001-RFND-CK-DTE:IV-RFND-CK-DTE              12200002
122100              , :RDT00001-RFND-CK-NBR:IV-RFND-CK-NBR              12210002
122200              , :RDT00001-KMRC-CRD-NBR:IV-KMRC-CRD-NBR            12220002
122300             FROM                                                 12230002
122400                    RDT_CUST        C                             12240002
122500                 ,  RDT_MAL_CK_RFND M                             12250002
122600             WHERE                                                12260002
122700                   M.STR_RGST_ID  = :ASC-KEY-TERMINAL             12270002
122800               AND M.RGST_TRN_NBR = :ASC-KEY-TRANSACTION          12280002
122900               AND M.RFND_SEQ_NBR = :ASC-KEY-SEQ-NBR              12290002
123000               AND C.CUST_ID      = :ASC-KEY-CUST-ID              12300002
123100               AND C.CUST_ID      = M.CUST_ID                     12310002
123110             WITH UR                                              12311002
123200         END-EXEC                                                 12320002
123300                                                                  12330002
123400         EVALUATE TRUE                                            12340002
123500             WHEN SQLCODE = ZERO                                  12350002
123600             WHEN SQLCODE = -904                                  12360002
123700             WHEN SQLCODE = -913                                  12370002
123800                 CONTINUE                                         12380002
123900             WHEN SQLWARN0 NOT = SPACES                           12390002
124000             WHEN SQLCODE < ZERO                                  12400002
124100             WHEN SQLCODE > ZERO                                  12410002
124200                 MOVE '4320-SELECT-RDT-MAL-CK-RFND'               12420002
124300                                   TO DP013-PARAGRAPH             12430002
124400                 MOVE RDT00001-CUST-ID                            12440002
124500                                   TO DP013-MESSAGE-TEXT (1)      12450002
124600                 MOVE RDT00001-STR-RGST-ID                        12460002
124700                                   TO DP013-MESSAGE-TEXT (2)      12470002
124800                 MOVE RDT00001-RGST-TRN-NBR                       12480002
124900                                   TO DP013-MESSAGE-TEXT (3)      12490002
125000                 MOVE RDT00001-RFND-SEQ-NBR                       12500002
125100                                   TO DP013-MESSAGE-TEXT (4)      12510002
125200                 MOVE SQLCA        TO DP013-SQLCA                 12520002
125300                 MOVE 'RDT_CUST'   TO DP013-DB2-TABLE-NAME (1)    12530002
125400                 MOVE 'RDT_MAL_CK_RFND'                           12540002
125500                                   TO DP013-DB2-TABLE-NAME (2)    12550002
125600                 SET DP013-DB2-ABEND                              12560002
125700                     DP013-XCTL-DISPLAY-RESTART TO TRUE           12570002
125800                 PERFORM DP013-0000-PROCESS-ABEND                 12580002
125900         END-EVALUATE                                             12590002
126000     END-PERFORM.                                                 12600002
126100*                                                                 12610002
126200     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        12620002
126300         MOVE '4320-SELECT-RDT-MAL-CK-RFND'                       12630002
126400                                   TO DP013-PARAGRAPH             12640002
126500         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO SELECT'     12650002
126600                                   TO DP013-MESSAGE-TEXT (1)      12660002
126700         MOVE 'CUSTOMER ID: '                                     12670002
126800                                   TO DP013-MESSAGE-TEXT (2)      12680002
126900         MOVE RDT00001-CUST-ID     TO DP013-MESSAGE-TEXT (3)      12690002
127000         MOVE SQLCA                TO DP013-SQLCA                 12700002
127100         MOVE 'RDT_CUST'           TO DP013-DB2-TABLE-NAME (1)    12710002
127200         MOVE 'RDT_MAL_CK_RFND'    TO DP013-DB2-TABLE-NAME (2)    12720002
127300         SET DP013-DB2-ABEND                                      12730002
127400             DP013-XCTL-DISPLAY-RESTART                           12740002
127500                                   TO TRUE                        12750002
127600         PERFORM DP013-0000-PROCESS-ABEND                         12760002
127700     END-IF.                                                      12770002
127800 EJECT                                                            12780002
127900                                                                  12790002
128000*----------------------------------------------------------------*12800002
128100* SELECT A ROW FROM THE DB2 XST-LOC TABLE.                       *12810002
128200*----------------------------------------------------------------*12820002
128300 4340-SELECT-XST-LOC.                                             12830002
128400     PERFORM                                                      12840002
128500         WITH TEST AFTER                                          12850002
128600         VARYING PV-RETRY-COUNTER                                 12860002
128700         FROM 1 BY 1                                              12870002
128800         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               12880002
128900                   OR (SQLCODE = ZERO)                            12890002
129000                   OR (SQLCODE = +100))                           12900002
129100*                                                                 12910002
129200         EXEC SQL                                                 12920002
129300             SELECT                                               12930002
129400                     LOC_NM                                       12940002
129500             INTO                                                 12950002
129600                    :XST00001-LOC-NM                              12960002
129700             FROM    XST_LOC                                      12970002
129800             WHERE   LOC_NBR  = :XST00001-LOC-NBR                 12980002
129810             WITH UR                                              12981002
129900         END-EXEC                                                 12990002
130000                                                                  13000002
130100         EVALUATE TRUE                                            13010002
130200             WHEN SQLCODE = ZERO                                  13020002
130300                 MOVE XST00001-LOC-NM TO ALOCNAMO                 13030002
130400             WHEN SQLCODE = +100                                  13040002
130500             WHEN SQLCODE = -904                                  13050002
130600             WHEN SQLCODE = -913                                  13060002
130700                 CONTINUE                                         13070002
130800             WHEN SQLWARN0 NOT = SPACES                           13080002
130900             WHEN SQLCODE < ZERO                                  13090002
131000             WHEN SQLCODE > ZERO                                  13100002
131100                 MOVE '4340-SELECT-XST-LOC '                      13110002
131200                                   TO DP013-PARAGRAPH             13120002
131300                 MOVE 'SELECT STORE DESC      '                   13130002
131400                                   TO DP013-MESSAGE-TEXT (1)      13140002
131500                 MOVE XST00001-LOC-NBR                            13150002
131600                                   TO DP013-MESSAGE-TEXT (2)      13160002
131700                 MOVE SQLCA        TO DP013-SQLCA                 13170002
131800                 MOVE 'XST_LOC '   TO DP013-DB2-TABLE-NAME (1)    13180002
131900                 SET DP013-DB2-ABEND                              13190002
132000                     DP013-XCTL-DISPLAY-RESTART TO TRUE           13200002
132100                 PERFORM DP013-0000-PROCESS-ABEND                 13210002
132200         END-EVALUATE                                             13220002
132300     END-PERFORM.                                                 13230002
132400*                                                                 13240002
132500     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        13250002
132600         MOVE '4340-SELECT-XST-LOC '                              13260002
132700                                   TO DP013-PARAGRAPH             13270002
132800         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO SELECT'     13280002
132900                                   TO DP013-MESSAGE-TEXT (1)      13290002
133000         MOVE 'STORE DESC   '                                     13300002
133100                                   TO DP013-MESSAGE-TEXT (2)      13310002
133200         MOVE XST00001-LOC-NBR     TO DP013-MESSAGE-TEXT (3)      13320002
133300         MOVE SQLCA                TO DP013-SQLCA                 13330002
133400         MOVE 'XST_LOC '           TO DP013-DB2-TABLE-NAME (1)    13340002
133500         SET DP013-DB2-ABEND                                      13350002
133600             DP013-XCTL-DISPLAY-RESTART                           13360002
133700                                   TO TRUE                        13370002
133800         PERFORM DP013-0000-PROCESS-ABEND                         13380002
133900     END-IF.                                                      13390002
134000 EJECT                                                            13400002
134100*                                                                 13410002
134200*----------------------------------------------------------------*13420002
134300*    RESTORE THE CUSTOMER DATA ON THE SCREEN FROM THE COMM AREA.  13430002
134400*----------------------------------------------------------------*13440002
134500                                                                  13450002
134600 4400-MOVE-COMMAREA-TO-SCREEN.                                    13460002
134700     MOVE ASC-LAST-NAME            TO ALASTNMO.                   13470002
134800     MOVE ASC-FIRST-NAME           TO AFRSTNMO.                   13480002
134900     MOVE ASC-DRIVERS-LIC          TO ADRVLICO.                   13490002
135000     MOVE ASC-ADDRESS1             TO AADDLN1O.                   13500002
135100     MOVE ASC-ADDRESS2             TO AADDLN2O.                   13510002
135200     MOVE ASC-CITY                 TO ACITYNMO.                   13520002
135300     MOVE ASC-STATE                TO ASTCODEO.                   13530002
135400     MOVE ASC-ZIP                  TO APSTLCDO.                   13540002
135500     MOVE ASC-PHONE                TO APHNNBRO.                   13550002
135600                                                                  13560002
135700     MOVE ASC-STORE-NBR            TO ALOCNBRO.                   13570002
135800     MOVE ASC-STORE-NAME           TO ALOCNAMO.                   13580002
135900     MOVE ASC-RECEIPT-DTE          TO AREQDTEO.                   13590002
136000     MOVE ASC-TERMINAL             TO ASTRRGTO.                   13600002
136100     MOVE ASC-TRANSACTION          TO ATRANNOO.                   13610002
136200     MOVE ASC-SEQ-NBR              TO ASEQNBRO.                   13620002
136300     MOVE ASC-RFND-AMT-ORIG        TO ARFDAMTO.                   13630002
136400     MOVE ASC-RFND-AMT-ADJ         TO AADJAMTO.                   13640002
136500     MOVE ASC-CORP-EJ              TO ACORPEJO.                   13650002
136600     MOVE ASC-CK-SYS-CK            TO ACHKSYSO.                   13660002
136700     MOVE ASC-GIFT-CK              TO AGIFTCKO.                   13670002
136800     MOVE ASC-STATUS-CDE           TO ASTATCDO.                   13680002
136900*                                                                 13690002
137000     PERFORM 4500-GET-STATUS-DESC                                 13700002
137100*                                                                 13710002
137200     MOVE ASC-STATUS-DESC          TO ACDEDESO.                   13720002
137300     MOVE ASC-STATUS-DATE          TO ACNGDTEO.                   13730002
137400     MOVE ASC-CHECK-DATE           TO ACKDATEO.                   13740002
137500     MOVE ASC-CHECK-NBR            TO ACHKNBRO.                   13750002
137600     MOVE ASC-KMRC-NBRX            TO SV007-CARD-NUMBER-IN        13760002
137700     MOVE 0                        TO SV007-CARD-NUMBER-LENGTH    13770002
137800     SET SV007-FORMAT-BOTH         TO TRUE                        13780002
137900     MOVE 30                       TO SV007-CARD-NUMBER-DIS-LENGTH13790002
138000     PERFORM SV007-FORMAT-CARD                                    13800002
138001     MOVE SV007-CARD-NUMBER-DISPLAY TO AKMRCNOO.                  13800102
138002                                                                  13800202
138003 EJECT                                                            13800302
138004*----------------------------------------------------------------*13800402
138005* GET APPROVAL CODE DESCRIPTION                                   13800502
138100*----------------------------------------------------------------*13810002
138200 4500-GET-STATUS-DESC.                                            13820002
138300     EVALUATE ASC-STATUS-CDE                                      13830002
138400             WHEN 'A' MOVE 'APPROVED  ' TO ASC-STATUS-DESC        13840002
138500             WHEN 'D' MOVE 'DENIED    ' TO ASC-STATUS-DESC        13850002
138600             WHEN 'M' MOVE 'KMRC      ' TO ASC-STATUS-DESC        13860002
138700             WHEN 'V' MOVE 'VOID      ' TO ASC-STATUS-DESC        13870002
138800             WHEN 'S' MOVE 'STORE HNDL' TO ASC-STATUS-DESC        13880002
138900             WHEN 'C' MOVE 'CASH PAID ' TO ASC-STATUS-DESC        13890002
139000             WHEN 'K' MOVE 'KOHLS CHRG' TO ASC-STATUS-DESC        13900002
139100             WHEN 'B' MOVE 'BANKCARD  ' TO ASC-STATUS-DESC        13910002
139200             WHEN 'E' MOVE 'MDSE XCHNG' TO ASC-STATUS-DESC        13920002
139300             WHEN 'O' MOVE 'ORIG MDSE ' TO ASC-STATUS-DESC        13930002
139400             WHEN 'P' MOVE 'PENDING   ' TO ASC-STATUS-DESC        13940002
139500             WHEN OTHER MOVE 'UNKNOWN ' TO ASC-STATUS-DESC        13950002
139600     END-EVALUATE.                                                13960002
139700*----------------------------------------------------------------*13970002
139800* APPLY THE CHANGES TO THE CUSTOMER DB2 TABLE.                    13980002
139900*----------------------------------------------------------------*13990002
140000 5000-UPDATE-CUST.                                                14000002
140100                                                                  14010002
140200     MOVE ASC-KEY-CUST-ID TO RDT00001-CUST-ID.                    14020002
140300     MOVE ASC-DRIVERS-LIC TO RDT00000-DRV-LIC-NBR.                14030002
140400     MOVE ASC-LAST-NAME   TO RDT00000-LAST-NM.                    14040002
140500     MOVE ASC-FIRST-NAME  TO RDT00000-FRST-NM.                    14050002
140600     MOVE ASC-ADDRESS1    TO RDT00000-M2A-LNE-1-ADDR.             14060002
140700     MOVE ASC-ADDRESS2    TO RDT00000-M2A-LNE-2-ADDR.             14070002
140800     MOVE ASC-CITY        TO RDT00000-M2A-CTY-NM.                 14080002
140900     MOVE ASC-STATE       TO RDT00000-M2A-ST-CDE.                 14090002
141000     MOVE ASC-ZIP         TO RDT00000-M2A-PSTL-CDE.               14100002
141100     IF ASC-PHONE = SPACES                                        14110002
141200         MOVE -1 TO IV-PHN-NBR                                    14120002
141300     ELSE                                                         14130002
141400         MOVE ASC-PHONE   TO RDT00000-PHN-NBR                     14140002
141500     END-IF.                                                      14150002
141600                                                                  14160002
141700*----------------------------------------------------------------*14170002
141800* APPLY THE CHANGES TO THE CHECK REFUND DB2 TABLE.                14180002
141900*----------------------------------------------------------------*14190002
142000 5050-UPDATE-RFND.                                                14200002
142100                                                                  14210002
142200     MOVE ASC-KEY-CUST-ID      TO RDT00001-CUST-ID.               14220002
142300     MOVE ASC-KEY-TERMINAL     TO RDT00001-STR-RGST-ID.           14230002
142400     MOVE ASC-KEY-TRANSACTION  TO RDT00001-RGST-TRN-NBR.          14240002
142500     MOVE ASC-KEY-SEQ-NBR      TO RDT00001-RFND-SEQ-NBR.          14250002
142600                                                                  14260002
142700     IF ASC-RFND-AMT-ADJ = ZEROES                                 14270002
142800         MOVE -1 TO IV-RFND-AMT-ADJ                               14280002
142900     ELSE                                                         14290002
143000         MOVE ASC-RFND-AMT-ADJ TO RDT00001-ADJ-RFND-AMT           14300002
143100     END-IF.                                                      14310002
143200                                                                  14320002
143300     IF ASC-KMRC-NBRX = ZEROES                                    14330002
143400     OR ASC-KMRC-NBRX = SPACES                                    14340002
143500         MOVE -1 TO IV-KMRC-CRD-NBR                               14350002
143600     ELSE                                                         14360002
143700         MOVE ASC-KMRC-CNVT TO RDT00001-KMRC-CRD-NBR              14370002
143800     END-IF.                                                      14380002
143900                                                                  14390002
144000     MOVE ASC-STATUS-CDE       TO RDT00001-RFND-STAT-CDE.         14400002
144100*                                                                 14410002
144200     IF ASC-CORP-EJ = SPACES                                      14420002
144300        MOVE -1 TO IV-CORP-EJRNL-CKD-CDE                          14430002
144400     ELSE                                                         14440002
144500        MOVE ASC-CORP-EJ       TO RDT00001-CORP-EJRNL-CKD-CDE     14450002
144600     END-IF.                                                      14460002
144700                                                                  14470002
144800     IF ASC-CK-SYS-CK = SPACES                                    14480002
144900        MOVE -1 TO IV-CK-SYS-CKD-CDE                              14490002
145000     ELSE                                                         14500002
145100        MOVE ASC-CK-SYS-CK     TO RDT00001-CK-SYS-CKD-CDE         14510002
145200     END-IF.                                                      14520002
145300                                                                  14530002
145400     IF ASC-GIFT-CK = SPACES                                      14540002
145500        MOVE -1 TO IV-GR-CKD-CDE                                  14550002
145600     ELSE                                                         14560002
145700        MOVE ASC-GIFT-CK       TO RDT00001-GR-CKD-CDE             14570002
145800     END-IF.                                                      14580002
145900*                                                                 14590002
146000     IF ASC-STATUS-CHNG                                           14600002
146100            EXEC SQL                                              14610002
146200                    SELECT CURRENT DATE INTO                      14620002
146300                                   :RDT00001-STAT-CHNG-DTE        14630002
146400                    FROM RDT_CUST                                 14640002
146410                    WITH UR                                       14641002
146500             END-EXEC                                             14650002
146600     ELSE                                                         14660002
146700        IF ASC-STATUS-DATE = SPACES                               14670002
146800           MOVE -1 TO IV-STAT-CHNG-DTE                            14680002
146900        ELSE                                                      14690002
147000           MOVE ASC-STATUS-DATE TO RDT00001-STAT-CHNG-DTE         14700002
147100        END-IF                                                    14710002
147200     END-IF.                                                      14720002
147300*                                                                 14730002
147400******************************************************************14740002
147500** UPDATE THE ROW ON THE DB2 TABLE.                             **14750002
147600******************************************************************14760002
147700 5100-UPDATE-CUSTOMER.                                            14770002
147800     PERFORM                                                      14780002
147900         WITH TEST AFTER                                          14790002
148000         VARYING PV-RETRY-COUNTER                                 14800002
148100         FROM 1 BY 1                                              14810002
148200         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               14820002
148300                   OR (SQLCODE = ZERO))                           14830002
148400         EXEC SQL                                                 14840002
148500             UPDATE RDT_CUST                                      14850002
148600               SET DRV_LIC_NBR      = :RDT00000-DRV-LIC-NBR       14860002
148700                 , LAST_NM          = :RDT00000-LAST-NM           14870002
148800                 , FRST_NM          = :RDT00000-FRST-NM           14880002
148900                 , M2A_LNE_1_ADDR   = :RDT00000-M2A-LNE-1-ADDR    14890002
149000                 , M2A_LNE_2_ADDR   = :RDT00000-M2A-LNE-2-ADDR    14900002
149100                 , M2A_CTY_NM       = :RDT00000-M2A-CTY-NM        14910002
149200                 , M2A_ST_CDE       = :RDT00000-M2A-ST-CDE        14920002
149300                 , M2A_PSTL_CDE     = :RDT00000-M2A-PSTL-CDE      14930002
149400                 , PHN_NBR          = :RDT00000-PHN-NBR:IV-PHN-NBR14940002
149500                 , LAST_UPD_DTE     = CURRENT DATE                14950002
149600             WHERE CUST_ID   = :RDT00001-CUST-ID                  14960002
149700         END-EXEC                                                 14970002
149800                                                                  14980002
149900         EVALUATE TRUE                                            14990002
150000             WHEN SQLCODE = ZERO                                  15000002
150100             WHEN SQLCODE = -904                                  15010002
150200             WHEN SQLCODE = -913                                  15020002
150300                 CONTINUE                                         15030002
150400             WHEN SQLWARN0 NOT = SPACES                           15040002
150500             WHEN SQLCODE < ZERO                                  15050002
150600             WHEN SQLCODE > ZERO                                  15060002
150700                 MOVE '5100-UPDATE-CUSTOMER'                      15070002
150800                                   TO DP013-PARAGRAPH             15080002
150900                 MOVE 'UPDATE A ROW ON THE CUSTOMER TABLE'        15090002
151000                                   TO DP013-MESSAGE-TEXT(1)       15100002
151100                 MOVE SQLCA        TO DP013-SQLCA                 15110002
151200                 MOVE 'RDT_CUST'   TO DP013-DB2-TABLE-NAME (1)    15120002
151300                 SET DP013-DB2-ABEND                              15130002
151400                     DP013-XCTL-DISPLAY-RESTART TO TRUE           15140002
151500                 PERFORM DP013-0000-PROCESS-ABEND                 15150002
151600         END-EVALUATE                                             15160002
151700     END-PERFORM.                                                 15170002
151800*                                                                 15180002
151900     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        15190002
152000         MOVE '5100-UPDATE-CUSTOMER'                              15200002
152100                                   TO DP013-PARAGRAPH             15210002
152200         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO UPDATE A CUS15220002
152300-             'TOMER ROW  '        TO DP013-MESSAGE-TEXT (1)      15230002
152400         MOVE SQLCA                TO DP013-SQLCA                 15240002
152500         MOVE 'RDT_CUST'           TO DP013-DB2-TABLE-NAME (1)    15250002
152600         SET DP013-DB2-ABEND                                      15260002
152700             DP013-XCTL-DISPLAY-RESTART                           15270002
152800                                   TO TRUE                        15280002
152900         PERFORM DP013-0000-PROCESS-ABEND                         15290002
153000     END-IF.                                                      15300002
153100 EJECT                                                            15310002
153200******************************************************************15320002
153300** UPDATE THE ROW ON THE CHECK REFUND DB2 TABLE.                  15330002
153400******************************************************************15340002
153500 5150-UPDATE-CK-RFND.                                             15350002
153600     PERFORM                                                      15360002
153700         WITH TEST AFTER                                          15370002
153800         VARYING PV-RETRY-COUNTER                                 15380002
153900         FROM 1 BY 1                                              15390002
154000         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               15400002
154100                   OR (SQLCODE = ZERO))                           15410002
154200                                                                  15420002
154300         EXEC SQL                                                 15430002
154400             UPDATE RDT_MAL_CK_RFND                               15440002
154500                 SET ADJ_RFND_AMT   =                             15450002
154600               :RDT00001-ADJ-RFND-AMT:IV-RFND-AMT-ADJ             15460002
154700                   , KMRC_CRD_NBR   =                             15470002
154800               :RDT00001-KMRC-CRD-NBR:IV-KMRC-CRD-NBR             15480002
154900                   , CORP_EJRNL_CKD_CDE =                         15490002
155000               :RDT00001-CORP-EJRNL-CKD-CDE:IV-CORP-EJRNL-CKD-CDE 15500002
155100                   , CK_SYS_CKD_CDE =                             15510002
155200               :RDT00001-CK-SYS-CKD-CDE:IV-CK-SYS-CKD-CDE         15520002
155300                   , GR_CKD_CDE     =                             15530002
155400               :RDT00001-GR-CKD-CDE:IV-GR-CKD-CDE                 15540002
155500                   , RFND_STAT_CDE  = :RDT00001-RFND-STAT-CDE     15550002
155600                   , STAT_CHNG_DTE  =                             15560002
155700               :RDT00001-STAT-CHNG-DTE:IV-STAT-CHNG-DTE           15570002
155800                   , LST_UPD_TMST   = CURRENT TIMESTAMP           15580002
155900             WHERE CUST_ID      = :RDT00001-CUST-ID               15590002
156000               AND STR_RGST_ID  = :RDT00001-STR-RGST-ID           15600002
156100               AND RGST_TRN_NBR = :RDT00001-RGST-TRN-NBR          15610002
156200               AND RFND_SEQ_NBR = :RDT00001-RFND-SEQ-NBR          15620002
156300         END-EXEC                                                 15630002
156400                                                                  15640002
156500         EVALUATE TRUE                                            15650002
156600             WHEN SQLCODE = ZERO                                  15660002
156700             WHEN SQLCODE = -904                                  15670002
156800             WHEN SQLCODE = -913                                  15680002
156900                 CONTINUE                                         15690002
157000             WHEN SQLWARN0 NOT = SPACES                           15700002
157100             WHEN SQLCODE < ZERO                                  15710002
157200             WHEN SQLCODE > ZERO                                  15720002
157300                 MOVE '5150-UPDATE-CK-RFND '                      15730002
157400                                   TO DP013-PARAGRAPH             15740002
157500                 MOVE 'UPDATE A ROW ON THE CHECK REFUND TABLE'    15750002
157600                                   TO DP013-MESSAGE-TEXT(1)       15760002
157700                 MOVE SQLCA        TO DP013-SQLCA                 15770002
157800                 MOVE 'RDT_MAL_CK_RFND'                           15780002
157900                                   TO DP013-DB2-TABLE-NAME (1)    15790002
158000                 SET DP013-DB2-ABEND                              15800002
158100                     DP013-XCTL-DISPLAY-RESTART TO TRUE           15810002
158200                 PERFORM DP013-0000-PROCESS-ABEND                 15820002
158300         END-EVALUATE                                             15830002
158400     END-PERFORM.                                                 15840002
158500*                                                                 15850002
158600     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        15860002
158700         MOVE '5150-UPDATE-CK-RFND '                              15870002
158800                                   TO DP013-PARAGRAPH             15880002
158900         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO UPDATE CHECK15890002
159000-             ' REFUND    '        TO DP013-MESSAGE-TEXT (1)      15900002
159100         MOVE SQLCA                TO DP013-SQLCA                 15910002
159200         MOVE 'RDT_MAL_CK_RFND'    TO DP013-DB2-TABLE-NAME (1)    15920002
159300         SET DP013-DB2-ABEND                                      15930002
159400             DP013-XCTL-DISPLAY-RESTART                           15940002
159500                                   TO TRUE                        15950002
159600         PERFORM DP013-0000-PROCESS-ABEND                         15960002
159700     END-IF.                                                      15970002
159800 EJECT                                                            15980002
159900                                                                  15990002
160000******************************************************************16000002
160100* APPLY THE CHANGES TO THE MESSAGE TO THE DB2 TABLE.             *16010002
160200******************************************************************16020002
160300 6100-SETUP-INSERT.                                               16030002
160400                                                                  16040002
160500     MOVE ASC-KEY-CUST-ID   TO RDT00001-CUST-ID.                  16050002
160600     MOVE ASC-TERMINAL      TO RDT00001-STR-RGST-ID.              16060002
160700     MOVE ASC-TRANSACTION   TO RDT00001-RGST-TRN-NBR.             16070002
160800     IF ASC-RFND-AMT-ADJ > 0                                      16080002
160900        MOVE ASC-RFND-AMT-ADJ  TO RDT00001-RFND-AMT               16090002
161000     ELSE                                                         16100002
161100        MOVE ASC-RFND-AMT-ORIG TO RDT00001-RFND-AMT               16110002
161200     END-IF.                                                      16120002
161300     MOVE ASC-STORE-NBR     TO RDT00001-STR-NBR.                  16130002
161400     MOVE 'P'               TO RDT00001-RFND-STAT-CDE.            16140002
161500     MOVE ASC-RECEIPT-DTE   TO RDT00001-RFND-REQ-DTE.             16150002
161600                                                                  16160002
161700******************************************************************16170002
161800*                                                                *16180002
161900*       FIND NEXT AVAILABLE SEQUENCE NUMBER                      *16190002
162000*                                                                *16200002
162100******************************************************************16210002
162200 6125-SELECT-MAX-REQ-NBR.                                         16220002
162300     PERFORM                                                      16230002
162400         WITH TEST AFTER                                          16240002
162500         VARYING PV-RETRY-COUNTER                                 16250002
162600         FROM 1 BY 1                                              16260002
162700         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  16270002
162800                   OR SQLCODE = ZERO                              16280002
162900*                                                                 16290002
163000     EXEC SQL                                                     16300002
163100         SELECT  MAX(RFND_SEQ_NBR) + 1                            16310002
163200           INTO  :PV-RFND-SEQ-NBR                                 16320002
163300           FROM  RDT_MAL_CK_RFND                                  16330002
163400             WHERE CUST_ID      = :RDT00001-CUST-ID               16340002
163500               AND STR_RGST_ID  = :RDT00001-STR-RGST-ID           16350002
163600               AND RGST_TRN_NBR = :RDT00001-RGST-TRN-NBR          16360002
163610             WITH UR                                              16361002
163700     END-EXEC                                                     16370002
163800                                                                  16380002
163900     EVALUATE TRUE                                                16390002
164000         WHEN SQLCODE = ZERO                                      16400002
164100             MOVE PV-RFND-SEQ-NBR TO RDT00001-RFND-SEQ-NBR        16410002
164200         WHEN SQLCODE = -304                                      16420002
164300             SET DP013-NO-ROLLBACK                                16430002
164400                 DP013-XCTL-DISPLAY-RESTART                       16440002
164500                 DP013-CICS-ABEND  TO TRUE                        16450002
164600             MOVE '6125-SELECT-MAX-REQ-NBR'                       16460002
164700                                   TO DP013-PARAGRAPH             16470002
164800             MOVE 'MAXIMUM SEQUENCE NUMBER EXCEEDED'              16480002
164900                                   TO DP013-MESSAGE-TEXT (1)      16490002
165000             PERFORM DP013-0000-PROCESS-ABEND                     16500002
165100         WHEN SQLCODE = -913                                      16510002
165200             CONTINUE                                             16520002
165300         WHEN OTHER                                               16530002
165400             MOVE '6125-SELECT-MAX-REQ-NBR   '                    16540002
165500                                 TO DP013-PARAGRAPH               16550002
165600             MOVE 'SELECT MAX REQUEST NBR'                        16560002
165700                                 TO DP013-MESSAGE-TEXT (1)        16570002
165800             MOVE SQLCA          TO DP013-SQLCA                   16580002
165900             MOVE 'RDT_MAL_CK_RFND' TO DP013-DB2-TABLE-NAME (1)   16590002
166000             SET DP013-DB2-ABEND                                  16600002
166100                 DP013-XCTL-DISPLAY-RESTART                       16610002
166200                                   TO TRUE                        16620002
166300             PERFORM DP013-0000-PROCESS-ABEND                     16630002
166400       END-EVALUATE                                               16640002
166500     END-PERFORM                                                  16650002
166600*                                                                 16660002
166700     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        16670002
166800         MOVE '6125-SELECT-MAX-REQ-NBR'                           16680002
166900                                   TO DP013-PARAGRAPH             16690002
167000         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO SELECT'     16700002
167100                                   TO DP013-MESSAGE-TEXT (1)      16710002
167200         MOVE 'CUSTOMER ID: '                                     16720002
167300                                   TO DP013-MESSAGE-TEXT (2)      16730002
167400         MOVE RDT00001-CUST-ID     TO DP013-MESSAGE-TEXT (3)      16740002
167500         MOVE SQLCA                TO DP013-SQLCA                 16750002
167600         MOVE 'RDT_MAL_CK_RFND'    TO DP013-DB2-TABLE-NAME (1)    16760002
167700         SET DP013-DB2-ABEND                                      16770002
167800             DP013-XCTL-DISPLAY-RESTART                           16780002
167900                                   TO TRUE                        16790002
168000         PERFORM DP013-0000-PROCESS-ABEND                         16800002
168100     END-IF.                                                      16810002
168200                                                                  16820002
168300******************************************************************16830002
168400*                                                                 16840002
168500* INSERT A CHECK REFUND RECORD BECAUSE OF A VOID                  16850002
168600*                                                                 16860002
168700******************************************************************16870002
168800                                                                  16880002
168900 6175-INSERT-RFND.                                                16890002
169000     PERFORM                                                      16900002
169100         WITH TEST AFTER                                          16910002
169200         VARYING PV-RETRY-COUNTER                                 16920002
169300         FROM 1 BY 1                                              16930002
169400         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               16940002
169500                   OR (SQLCODE = ZERO))                           16950002
169600                                                                  16960002
169700       EXEC SQL                                                   16970002
169800          INSERT INTO RDT_MAL_CK_RFND                             16980002
169900                   ( CUST_ID                                      16990002
170000                    ,STR_RGST_ID                                  17000002
170100                    ,RGST_TRN_NBR                                 17010002
170200                    ,RFND_SEQ_NBR                                 17020002
170300                    ,STR_NBR                                      17030002
170400                    ,RFND_AMT                                     17040002
170500                    ,RFND_STAT_CDE                                17050002
170600                    ,RFND_REQ_DTE                                 17060002
170700                    ,LST_UPD_TMST)                                17070002
170800                 VALUES                                           17080002
170900                  (:RDT00001-CUST-ID,                             17090002
171000                   :RDT00001-STR-RGST-ID,                         17100002
171100                   :RDT00001-RGST-TRN-NBR,                        17110002
171200                   :RDT00001-RFND-SEQ-NBR,                        17120002
171300                   :RDT00001-STR-NBR,                             17130002
171400                   :RDT00001-RFND-AMT,                            17140002
171500                   :RDT00001-RFND-STAT-CDE,                       17150002
171600                   :RDT00001-RFND-REQ-DTE,                        17160002
171700                   CURRENT TIMESTAMP)                             17170002
171800       END-EXEC                                                   17180002
171900                                                                  17190002
172000       EVALUATE TRUE                                              17200002
172100         WHEN SQLCODE = -803                                      17210002
172200*                 ------ RECORD ALREADY EXISTS ------             17220002
172300              ADD +1 TO RDT00001-RFND-SEQ-NBR                     17230002
172400                                                                  17240002
172500         WHEN SQLCODE = ZERO                                      17250002
172600         WHEN SQLCODE = -904                                      17260002
172700         WHEN SQLCODE = -913                                      17270002
172800                 CONTINUE                                         17280002
172900         WHEN SQLWARN0 NOT = SPACES                               17290002
173000         WHEN SQLCODE < ZERO                                      17300002
173100         WHEN SQLCODE > ZERO                                      17310002
173200                 MOVE '6175-INSERT-RFND'                          17320002
173300                                   TO DP013-PARAGRAPH             17330002
173400                 MOVE 'INSERT A ROW ON THE CHECK REFUND TABLE  '  17340002
173500                                   TO DP013-MESSAGE-TEXT(1)       17350002
173600                 MOVE SQLCA        TO DP013-SQLCA                 17360002
173700                 MOVE 'RDT_MAL_CK_RFND'                           17370002
173800                                   TO DP013-DB2-TABLE-NAME (1)    17380002
173900                 SET DP013-DB2-ABEND                              17390002
174000                     DP013-XCTL-DISPLAY-RESTART TO TRUE           17400002
174100                 PERFORM DP013-0000-PROCESS-ABEND                 17410002
174200       END-EVALUATE                                               17420002
174300     END-PERFORM.                                                 17430002
174400*                                                                 17440002
174500     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        17450002
174600         MOVE '6175-INSERT-RFND    '                              17460002
174700                                   TO DP013-PARAGRAPH             17470002
174800         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO SELECT'     17480002
174900                                   TO DP013-MESSAGE-TEXT (1)      17490002
175000         MOVE 'CUSTOMER ID: '                                     17500002
175100                                   TO DP013-MESSAGE-TEXT (2)      17510002
175200         MOVE RDT00001-CUST-ID     TO DP013-MESSAGE-TEXT (3)      17520002
175300         MOVE SQLCA                TO DP013-SQLCA                 17530002
175400         MOVE 'RDT_MAL_CK_RFND'    TO DP013-DB2-TABLE-NAME (1)    17540002
175500         SET DP013-DB2-ABEND                                      17550002
175600             DP013-XCTL-DISPLAY-RESTART                           17560002
175700                                   TO TRUE                        17570002
175800         PERFORM DP013-0000-PROCESS-ABEND                         17580002
175900     END-IF.                                                      17590002
176000                                                                  17600002
176100******************************************************************17610002
176200** INSERT THE ROW ON THE SVT_CRD_ACCT_CMNT TABLE                **17620002
176300******************************************************************17630002
176400 6200-INSERT-SV-COMMENT.                                          17640002
176500                                                                  17650002
176600     MOVE ASC-KMRC-CNVT TO SVT00003-CRD-NBR.                      17660002
176700     MOVE 1             TO SVT00003-CMNT-SEQ-NBR.                 17670002
176800     STRING 'CORP REFUND CONVERSION: ' DELIMITED BY SIZE          17680002
176900            ASC-FIRST-NAME DELIMITED BY SPACE                     17690002
177000            ' ' DELIMITED BY SIZE                                 17700002
177100            ASC-LAST-NAME DELIMITED BY SPACE                      17710002
177200            ' ' DELIMITED BY SIZE                                 17720002
177300            ASC-DRIVERS-LIC DELIMITED BY SPACE                    17730002
177400                      INTO SVT00003-CMNT-TXT.                     17740002
177500     MOVE DP020-USERID  TO SVT00003-CRE-BY-USR-ID.                17750002
177600                                                                  17760002
177700     PERFORM                                                      17770002
177800         WITH TEST AFTER                                          17780002
177900         VARYING PV-RETRY-COUNTER                                 17790002
178000         FROM 1 BY 1                                              17800002
178100         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               17810002
178200                   OR (SQLCODE = ZERO))                           17820002
178300                                                                  17830002
178400         EXEC SQL                                                 17840002
178500              INSERT INTO SVT_CRD_ACCT_CMMT                       17850002
178600                       ( CRD_NBR                                  17860002
178700                        ,CRE_TMST                                 17870002
178800                        ,CMNT_SEQ_NBR                             17880002
178900                        ,CMNT_TXT                                 17890002
179000                        ,CRE_BY_USR_ID)                           17900002
179100                     VALUES                                       17910002
179200                      (:SVT00003-CRD-NBR                          17920002
179300                      ,CURRENT TIMESTAMP                          17930002
179400                      ,:SVT00003-CMNT-SEQ-NBR                     17940002
179500                      ,:SVT00003-CMNT-TXT                         17950002
179600                      ,:SVT00003-CRE-BY-USR-ID)                   17960002
179700         END-EXEC                                                 17970002
179800                                                                  17980002
179900         EVALUATE TRUE                                            17990002
180000             WHEN SQLCODE = ZERO                                  18000002
180100             WHEN SQLCODE = -904                                  18010002
180200             WHEN SQLCODE = -913                                  18020002
180300                 CONTINUE                                         18030002
180400             WHEN SQLWARN0 NOT = SPACES                           18040002
180500             WHEN SQLCODE < ZERO                                  18050002
180600             WHEN SQLCODE > ZERO                                  18060002
180700                 MOVE '6200-INSERT-SV-COMMENT'                    18070002
180800                                   TO DP013-PARAGRAPH             18080002
180900                 MOVE 'INSERT A ROW ON THE SVT_CRD_ACCT_CMMT TBL' 18090002
181000                                   TO DP013-MESSAGE-TEXT(1)       18100002
181100                 MOVE SQLCA        TO DP013-SQLCA                 18110002
181200                 MOVE 'SVT_CRD_ACCT_CMMT'                         18120002
181300                                   TO DP013-DB2-TABLE-NAME (1)    18130002
181400                 SET DP013-DB2-ABEND                              18140002
181500                     DP013-XCTL-DISPLAY-RESTART TO TRUE           18150002
181600                 PERFORM DP013-0000-PROCESS-ABEND                 18160002
181700         END-EVALUATE                                             18170002
181800     END-PERFORM.                                                 18180002
181900                                                                  18190002
182000     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        18200002
182100         MOVE '6200-INSERT-SV-COMMENT'                            18210002
182200                                   TO DP013-PARAGRAPH             18220002
182300         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO INSERT A SV 18230002
182400-             'COMMENT    '        TO DP013-MESSAGE-TEXT (1)      18240002
182500         MOVE SQLCA                TO DP013-SQLCA                 18250002
182600         MOVE 'SVT_CRD_ACCT_CMMT'  TO DP013-DB2-TABLE-NAME (1)    18260002
182700         SET DP013-DB2-ABEND                                      18270002
182800             DP013-XCTL-DISPLAY-RESTART                           18280002
182900                                   TO TRUE                        18290002
183000         PERFORM DP013-0000-PROCESS-ABEND                         18300002
183100     END-IF.                                                      18310002
183200                                                                  18320002
183300                                                                  18330002
183400**********************************************************        18340002
183500*  DRIVERS LICENSE ROUTINE RDPD500                                18350006
183600**********************************************************        18360002
183700     COPY RDPD500.                                                18370006
183700*    COPY CRPD500.                                                18371006
183800*----------------------------------------------------------------*18380002
183900*    CONVERSION OF CARD NUMBER                                   *18390002
184000*----------------------------------------------------------------*18400002
184100     COPY SVPD007.                                                18410002
184200*----------------------------------------------------------------*18420002
184300*----------------------------------------------------------------*18430002
184400*    ABEND PROCESSOR MODULE                                      *18440002
184500*----------------------------------------------------------------*18450002
184600                                                                  18460002
184700     COPY DPPD013.                                                18470002
184800                                                                  18480002
