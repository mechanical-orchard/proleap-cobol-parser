000100***************************************************************** 00010001
000200 IDENTIFICATION DIVISION.                                         00020001
000300***************************************************************** 00030001
000400                                                                  00040001
000500 PROGRAM-ID.             XSKUP041.                                00050001
000600 AUTHOR.                 LIHUA LIANG.                             00060036
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070001
000800 DATE-WRITTEN            NOVEMBER 2002.                           00080001
000900 DATE-COMPILED.                                                   00090001
001000                                                                  00100001
001100***************************************************************** 00110001
001200*                                                                 00120001
001300*  THIS PROGRAM WILL IDENTIFY ANY CHANGED RECORDS IN THE VENDOR   00130001
001400*  DEPARTMENT EXTRACT FILE AND PERFORM ANY NECESSARY MAINTENANCE  00140001
001400*  TO THE XS DOMAIN'S VENDOR DEPARTMENT (XST_VND_DEPT) TABLE.     00150037
001500*                                                                 00160001
001600*   INPUT: UPD01 - CONTAINS THE LAST SUCCESSFUL COMPLETION DATE   00170037
001600*                  OF THIS PROGRAM.                               00180001
001700*          INP01 - CONTAINS ABEND THRESHOLD NUMBER.               00190037
001700*          INP02 - CONTAINS THE DATE FROM SCHEDULER.              00200037
001700*          INP03 - CONTAINS VENDOR DEPT INFORMATION.              00210037
001700*   OUTPUT:OUT01 - CONTAINS ERROR RECORD.                         00220037
001900*                                                                 00230001
      * 03/18/2003 CHANGED BY:SANDY POTTER  ADDED COUNTS AND COUNT DIS- 00231054
      *            PLAYS. ADDED SETTING RETURN CODE TO 04 IF ANY ERRORS.00233054
      *            CORRECTED ERROR OUTPUT LENGTH.                       00234054
007100***************************************************************** 00240001
007200 ENVIRONMENT DIVISION.                                            00250001
007300***************************************************************** 00260001
007400                                                                  00270001
007500 CONFIGURATION SECTION.                                           00280001
007600                                                                  00290001
007700 SOURCE-COMPUTER.        IBM-3090.                                00300001
007800 OBJECT-COMPUTER.        IBM-3090.                                00310001
007900                                                                  00320001
008000 INPUT-OUTPUT SECTION.                                            00330001
008100                                                                  00340001
008200 FILE-CONTROL.                                                    00350001
008300                                                                  00360001
008400     SELECT LAST-SUCCESSFUL-DATE-FILE                             00370003
008500         ASSIGN TO UPD01.                                         00380001
008600                                                                  00390001
008400     SELECT ABEND-THRESHOLD-NBR-FILE                              00400003
008500         ASSIGN TO INP01.                                         00410003
008600                                                                  00420001
008700     SELECT SCHEDULE-DATE-FILE                                    00430014
008800         ASSIGN TO INP02.                                         00440014
008900                                                                  00450014
008700     SELECT VENDOR-DEPT-EXTRACT-FILE                              00460003
008800         ASSIGN TO INP03.                                         00470015
009000                                                                  00490001
008700     SELECT ERROR-FILE                                            00500015
008800         ASSIGN TO OUT01.                                         00510015
009000                                                                  00530015
009100******************************************************************00540001
009200 DATA DIVISION.                                                   00550001
009300******************************************************************00560001
009400                                                                  00570001
009500 FILE SECTION.                                                    00580001
009600                                                                  00590001
009700 FD  LAST-SUCCESSFUL-DATE-FILE                                    00600003
009800     RECORDING MODE IS F                                          00610001
009900     BLOCK CONTAINS 0 RECORDS                                     00620001
010000     LABEL RECORDS ARE STANDARD.                                  00630001
010100                                                                  00640001
010200 01  LAST-SUCCESSFUL-DATE-RECORD      PIC X(80).                  00650003
010300                                                                  00660001
009700 FD  ABEND-THRESHOLD-NBR-FILE                                     00670003
009800     RECORDING MODE IS F                                          00680001
009900     BLOCK CONTAINS 0 RECORDS                                     00690001
010000     LABEL RECORDS ARE STANDARD.                                  00700001
010100                                                                  00710001
010200 01  ABEND-THRESHOLD-NBR-RECORD       PIC X(80).                  00720003
010300                                                                  00730001
009700 FD  SCHEDULE-DATE-FILE                                           00740014
009800     RECORDING MODE IS F                                          00750014
009900     BLOCK CONTAINS 0 RECORDS                                     00760014
010000     LABEL RECORDS ARE STANDARD.                                  00770014
010100                                                                  00780014
010200 01  SCHEDULE-DATE-RECORD             PIC X(80).                  00790014
010300                                                                  00800014
010400 FD  VENDOR-DEPT-EXTRACT-FILE                                     00810003
010500     RECORDING MODE IS F                                          00820001
010600     BLOCK CONTAINS 0  RECORDS.                                   00830001
010700                                                                  00840001
010800 01  VENDOR-DEPT-EXTRACT-RECORD       PIC  X(100).                00850022
010900                                                                  00860001
010400 FD  ERROR-FILE                                                   00870015
010500     RECORDING MODE IS F                                          00880015
010600     BLOCK CONTAINS 0  RECORDS.                                   00890015
010700                                                                  00900015
010800 01  ERROR-RECORD                     PIC  X(100).                00910054
010900                                                                  00920015
011100******************************************************************00930001
011200 WORKING-STORAGE SECTION.                                         00940001
011300******************************************************************00950001
011600                                                                  00960001
011400 01  FILLER                           PIC X(50)  VALUE            00970001
011500     ' *** WORKING STORAGE STARTS HERE FOR XSKUP041 *** '.        00980001
011600                                                                  00990001
009100******************************************************************01000001
009200* INPUT CONTROL CARD 1. CONTAINS THE LAST SUCCESSFUL RUN DATE.    01010038
009300******************************************************************01020001
009000                                                                  01030001
009400 01  CC-CONTROL-CARD-1.                                           01040001
009500     05  CC-LAST-SUCCESS-RUN-DATE     PIC  X(10) VALUE SPACE.     01050038
010500     05  FILLER                       PIC  X(70) VALUE SPACE.     01060003
009000                                                                  01070001
009100******************************************************************01080001
009200* INPUT CONTROL CARD 2. CONTAINS THE ABEND THRESHOLD NUMBER.      01090014
009300******************************************************************01100001
009000                                                                  01110001
009400 01  CC-CONTROL-CARD-2.                                           01120001
009500     05  CC-ABEND-THRESHOLD-NBR       PIC  9(04) VALUE ZERO.      01130003
010500     05  FILLER                       PIC  X(76) VALUE SPACE.     01140003
011000                                                                  01150001
009100******************************************************************01160014
009200* INPUT CONTROL CARD 3. CONTAINS THE SCHEDULED RUN DATE.          01170014
009300******************************************************************01180014
009000                                                                  01190014
009400 01  CC-CONTROL-CARD-3.                                           01200014
009500     05  CC-SCHEDULE-DATE             PIC  X(10) VALUE SPACE.     01210014
010500     05  FILLER                       PIC  X(76) VALUE SPACE.     01220014
011000                                                                  01230014
013200******************************************************************01240001
013300*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             01250001
013400******************************************************************01260001
013500     COPY DPWS500.                                                01270005
013600                                                                  01280001
013700 01  AC-ABEND-CODE                    PIC S9(04) VALUE ZERO       01290001
013800                                                 COMP SYNC.       01300001
013900     88  AC-CONTROL-CARD-ERROR                   VALUE +4003.     01310001
014000     88  AC-DB2-ERROR                            VALUE +4013.     01320001
014100     88  AC-CALENDAR-ROUTINE-ERROR               VALUE +4019.     01330001
014300                                                                  01340001
014500 01  PS-PROGRAM-SWITCHES.                                         01350001
014600     05  PS-END-OF-EXTRACT-FILE-SW    PIC  X(01) VALUE 'N'.       01360003
014700         88  PS-END-OF-EXTRACT-FILE-YES          VALUE 'Y'.       01370010
014800     05  PS-END-OF-FILE-1-SW          PIC  X(01) VALUE 'N'.       01380003
014900         88  PS-END-OF-FILE-1-YES                VALUE 'Y'.       01390003
015100     05  PS-END-OF-FILE-2-SW          PIC  X(01) VALUE 'N'.       01400003
015200         88  PS-END-OF-FILE-2-YES                VALUE 'Y'.       01410003
015100     05  PS-END-OF-FILE-3-SW          PIC  X(01) VALUE 'N'.       01420017
015200         88  PS-END-OF-FILE-3-YES                VALUE 'Y'.       01430017
015100     05  PS-MOVE-ON-SW                PIC  X(01) VALUE 'N'.       01440048
015200         88  PS-MOVE-ON-YES                      VALUE 'Y'.       01450048
015200         88  PS-MOVE-ON-NO                       VALUE 'N'.       01460048
016200                                                                  01470001
016300 01  PC-CONSTANTS.                                                01480001
016700     05  PC-ROW-NOT-FOUND             PIC S9(04) VALUE +100.      01490003
016700     05  PC-INSERT                    PIC  X(01) VALUE 'I'.       01500009
016700     05  PC-UPDATE                    PIC  X(01) VALUE 'U'.       01510009
016700     05  PC-MAX-DB2-ERROR-5           PIC  9(01) VALUE 5.         01520026
016900     05  PC-CURRENT-PROGRAM-NAME      PIC  X(08) VALUE            01530001
017000                                                 'XSKUP041'.      01540001
016900     05  PC-ORIGINAL-DATE             PIC  X(10) VALUE            01540152
                                                       '0001-01-01'.    01541053
020100                                                                  01550008
020400 01  PV-DB2-KEY-FIELDS.                                           01560001
020500     05  PV-HOLD-ENT-ID               PIC S9(09) COMP.            01570029
020700     05  PV-HOLD-DEPT-NBR             PIC  X(03) VALUE SPACE.     01580029
021200                                                                  01590003
022400 01  PV-MISC-FIELDS.                                              01600001
024200     05  PV-PARAGRAPH-NAME            PIC  X(30) VALUE SPACE.     01610001
024300     05  PV-DB2-ERROR-COUNT           PIC  9(01) VALUE ZERO.      01620013
024300     05  PV-ERROR-RECORD-COUNT        PIC  9(04) VALUE ZERO.      01630013
024400     05  PV-OPERATION-MSG-1           PIC  X(40) VALUE SPACE.     01640010
024400     05  PV-OPERATION-MSG-2           PIC  X(40) VALUE SPACE.     01650010
024500     05  PV-DB2-OPERATION             PIC  X(40) VALUE SPACE.     01660001
024500     05  PV-HOLD-EFF-DTE              PIC  X(10) VALUE SPACE.     01670010
024500     05  PV-DC-RET-CDE                PIC  X(02) VALUE SPACE.     01680010
024500     05  PV-DATE                      PIC  X(10) VALUE SPACE.     01690023
024300     05  PV-EXTRACT-READ-CNT          PIC  9(07) VALUE ZERO.      01691050
024300     05  PV-UNIQUE-KEY-CNT            PIC  9(07) VALUE ZERO.      01691150
024300     05  PV-CHECK-VNDDEPT-CNT         PIC  9(07) VALUE ZERO.      01692050
024300     05  PV-INSERT-VNDDEPT-CNT        PIC  9(07) VALUE ZERO.      01693050
024300     05  PV-UPDATE-VNDDEPT-CNT        PIC  9(07) VALUE ZERO.      01694050
024900                                                                  01700001
022400     COPY VNRD101.                                                01710055
024900                                                                  01720013
022400 01  OUT-ERROR-FILE.                                              01730009
000200     05  OUT-ENT-ID                   PIC S9(09) COMP.            01740009
000300     05  OUT-DEPT-NBR                 PIC  X(03).                 01750009
000500     05  OUT-VEND-TYP-IND             PIC  X(01).                 01760009
000700     05  OUT-VND-DEPT-STAT-CD         PIC  X(01).                 01770009
007300     05  OUT-RTV-RA-REQD-IND          PIC  X(01).                 01780009
007400     05  OUT-RTV-NO-RA-REQD-IND       PIC  X(01).                 01790009
007500     05  OUT-DEBIT-DESTROY-IND        PIC  X(01).                 01800009
007600     05  OUT-MARKOUT-IND              PIC  X(01).                 01810009
007700     05  OUT-PRCHS-AGMNT-EFF-DTE      PIC  X(10).                 01820009
007800     05  OUT-PRCHS-AGMNT-EXP-DTE      PIC  X(10).                 01830009
000300     05  FILLER                       PIC  X(61).                 01831054
000300     05  OUT-INSRT-UPD-IND            PIC  X(01).                 01840009
000300     05  OUT-SQLCODE                  PIC S9(05).                 01850009
024900                                                                  01870009
046900******************************************************************01880001
047000*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            01890001
047100******************************************************************01900001
047300                                                                  01910001
047200     COPY DPWS004.                                                01920003
047300                                                                  01930001
047400******************************************************************01940001
047500*  DB2 COMMUNICATION AREA.                                        01950001
047600******************************************************************01960001
047300                                                                  01970001
047700     EXEC SQL                                                     01980001
047800          INCLUDE SQLCA                                           01990001
047900     END-EXEC.                                                    02000001
047300                                                                  02010001
048000******************************************************************02020001
048100*  DB2 TABLE DB2PDBA.XST_VND_DPT - VENDOR DEPARTMENT TABLE.       02030003
048200******************************************************************02040001
047300                                                                  02050001
048300     EXEC SQL                                                     02060001
048400          INCLUDE XST00017                                        02070010
048500     END-EXEC.                                                    02080001
047300                                                                  02090001
074100***************************************************************** 02100001
074400 PROCEDURE DIVISION.                                              02110001
074300***************************************************************** 02120001
074500                                                                  02130001
074600******************************************************************02140001
075000 0000-MAINLINE-PARAGRAPH.                                         02150001
074900******************************************************************02160001
075100                                                                  02170001
075200     PERFORM 1000-HOUSE-KEEPING.                                  02180014
075100                                                                  02190001
075300     PERFORM 2000-PROCESS-EXTRACT-FILE                            02200003
075400       UNTIL PS-END-OF-EXTRACT-FILE-YES.                          02210003
075100                                                                  02220001
075500     PERFORM 3000-CLOSE-FILES.                                    02230001
075100                                                                  02240001
075500     PERFORM 7500-UPDATE-CONTROL-CARD.                            02250015
075100                                                                  02260001
075500     PERFORM 9000-END-OF-PGM.                                     02261050
075100                                                                  02262050
075600     STOP RUN.                                                    02270001
075700                                                                  02280001
075900******************************************************************02290001
076500 1000-HOUSE-KEEPING.                                              02300014
076100*     OPEN INPUT FILES AND PROCESS CONTROL CARDS.                 02310005
076400******************************************************************02320001
076600                                                                  02330001
079763     OPEN INPUT LAST-SUCCESSFUL-DATE-FILE                         02340003
079763                ABEND-THRESHOLD-NBR-FILE                          02350003
079763                SCHEDULE-DATE-FILE                                02360016
076800                VENDOR-DEPT-EXTRACT-FILE                          02370020
076800         OUTPUT ERROR-FILE.                                       02380020
079765                                                                  02390001
079794     READ LAST-SUCCESSFUL-DATE-FILE INTO CC-CONTROL-CARD-1        02400003
079795        AT END                                                    02410001
079796           SET PS-END-OF-FILE-1-YES    TO TRUE.                   02420001
079797                                                                  02430001
079794     READ ABEND-THRESHOLD-NBR-FILE INTO CC-CONTROL-CARD-2         02440003
079795        AT END                                                    02450001
079796           SET PS-END-OF-FILE-2-YES    TO TRUE.                   02460001
079797                                                                  02470001
079794     READ SCHEDULE-DATE-FILE       INTO CC-CONTROL-CARD-3         02480014
079795        AT END                                                    02490014
079796           SET PS-END-OF-FILE-3-YES    TO TRUE.                   02500014
079797                                                                  02510014
079779     CLOSE LAST-SUCCESSFUL-DATE-FILE                              02520003
079779           ABEND-THRESHOLD-NBR-FILE.                              02530003
079797                                                                  02540001
079779     IF PS-END-OF-FILE-1-YES OR                                   02550001
079779        PS-END-OF-FILE-2-YES OR                                   02560014
079779        PS-END-OF-FILE-3-YES                                      02570014
079780        MOVE '1000-HOUSE-KEEPING'     TO PV-PARAGRAPH-NAME        02580001
079781        MOVE 'CONTROL CARD IS EMPTY'  TO PV-OPERATION-MSG-1       02590001
079782        SET AC-CONTROL-CARD-ERROR     TO TRUE                     02600001
079783        PERFORM 9999-ABEND                                        02610001
079784     END-IF.                                                      02620001
079797                                                                  02630001
079785     DISPLAY 'PROGRAM NAME:       ' PC-CURRENT-PROGRAM-NAME.      02640001
079785     DISPLAY 'CONTROL CARD 1:     ' CC-CONTROL-CARD-1.            02650001
      *    * DATE ROUTINE THINKS '0001-01-01 IS AN INVALID DATE.  *     02651052
      *    * THIS DATE IS IN THE CONTROL CARD ON AN INITIAL LOAD. *     02651152
           IF CC-LAST-SUCCESS-RUN-DATE = PC-ORIGINAL-DATE               02651352
              CONTINUE                                                  02651452
           ELSE                                                         02651552
079810        MOVE CC-LAST-SUCCESS-RUN-DATE TO PV-DATE                  02652051
079787        PERFORM 1115-VALIDATE-DATE                                02653051
           END-IF.                                                      02653151
                                                                        02654051
079785     DISPLAY 'CONTROL CARD 2:     ' CC-CONTROL-CARD-2.            02660001
079787     IF CC-ABEND-THRESHOLD-NBR IS NUMERIC                         02690014
079787        CONTINUE                                                  02700001
079787     ELSE                                                         02710001
079780        MOVE '1000-HOUSE-KEEPING'     TO PV-PARAGRAPH-NAME        02720001
079781        MOVE 'INVALID THRESHOLD NBR'  TO PV-OPERATION-MSG-1       02730003
079781        MOVE CC-ABEND-THRESHOLD-NBR   TO PV-OPERATION-MSG-2       02740003
079782        SET AC-CONTROL-CARD-ERROR     TO TRUE                     02750001
079783        PERFORM 9999-ABEND                                        02760001
079787     END-IF.                                                      02770001
                                                                        02771051
079785     DISPLAY 'CONTROL CARD 3:     ' CC-CONTROL-CARD-3.            02780051
079810     MOVE CC-SCHEDULE-DATE            TO PV-DATE.                 02820032
079787     PERFORM 1115-VALIDATE-DATE.                                  02830014
075100                                                                  02840014
080100******************************************************************02850001
080700 1115-VALIDATE-DATE.                                              02860001
080300*     CALL KOHLS CALENDAR ROUTINE:                                02870001
080600******************************************************************02880001
080800                                                                  02890001
079805     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              02900001
079806                                                                  02910001
079807     SET  DPG51-ACTUAL-CALENDAR-ONLY  TO TRUE.                    02920001
079808     SET  DPG51-DO-NOT-INCR-DECR-DATE TO TRUE.                    02930001
079809     SET  DPG52-LK-DTE-ISO-FMT        TO TRUE.                    02940001
079810     MOVE PV-DATE                     TO DPG52-LK-DATE-INPUT.     02950023
079811                                                                  02960001
079812     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    02970001
079813                                             DPG54 DPG55 DPG56.   02980001
079814     EVALUATE TRUE                                                02990001
079815        WHEN DPG54-SEVERE-ERROR                                   03000001
079816        WHEN DPG54-DATE-INVALID                                   03010001
079817           MOVE '1115-VALIDATE-DATE'     TO PV-PARAGRAPH-NAME     03020001
079819           MOVE 'INVALID INPUT DATE'     TO PV-OPERATION-MSG-1    03030001
079821           SET AC-CALENDAR-ROUTINE-ERROR TO TRUE                  03040001
079822           MOVE DPG54-ERROR-MESSAGE      TO PV-OPERATION-MSG-2    03050001
079823           PERFORM 9999-ABEND                                     03060001
079824     END-EVALUATE.                                                03070001
079827                                                                  03080001
090200******************************************************************03090001
090600 2000-PROCESS-EXTRACT-FILE.                                       03100003
090400*     PROCESS EXTRACT FILE. THE FILE SHOULD CONTAIN ONLY RECORDS  03110003
090400*     WITH 'M' AS IT'S VENDOR TYPE INDICATOR.                     03120003
090500******************************************************************03130001
090700                                                                  03140001
079794     READ VENDOR-DEPT-EXTRACT-FILE  INTO VN101-VENDOR-DEPT-EXTR   03150013
079795        AT END                                                    03160003
079796           SET PS-END-OF-EXTRACT-FILE-YES TO TRUE.                03170014
079797                                                                  03180003
079797     IF NOT PS-END-OF-EXTRACT-FILE-YES                            03190013
              ADD +1 TO PV-EXTRACT-READ-CNT                             03191050
                                                                        03192050
079797        IF VN101-ENT-ID        NOT EQUAL PV-HOLD-ENT-ID OR        03200013
079797           VN101-DEPT-NBR      NOT EQUAL PV-HOLD-DEPT-NBR         03210013
                 ADD +1                     TO PV-UNIQUE-KEY-CNT        03211050
079797           MOVE VN101-ENT-ID          TO PV-HOLD-ENT-ID           03220013
079797           MOVE VN101-DEPT-NBR        TO PV-HOLD-DEPT-NBR         03230013
079797                                                                  03240035
079797           IF VN101-PRCHS-AGMNT-EFF-DTE EQUAL                     03250049
079797              CC-LAST-SUCCESS-RUN-DATE OR                         03260049
079797              VN101-PRCHS-AGMNT-EFF-DTE GREATER THAN              03270049
079797              CC-LAST-SUCCESS-RUN-DATE                            03280049
                                                                        03280150
                    ADD +1                  TO PV-CHECK-VNDDEPT-CNT     03281050
079797              PERFORM 4000-SELECT-VENDOR-DEPT                     03290003
079797              PERFORM 5500-EVALUATE-DC-RETURN-CODE                03300035
079797                                                                  03310035
079797              IF SQLCODE = PC-ROW-NOT-FOUND                       03320035
134300                 MOVE PV-DC-RET-CDE   TO XST00017-DC-RET-CDE      03330035
079797                 PERFORM 5000-INSERT-VENDOR-DEPT                  03340003
079797                    UNTIL PS-MOVE-ON-YES                          03350048
132200                 SET PS-MOVE-ON-NO    TO TRUE                     03360048
079797              ELSE                                                03370033
079797                 IF SQLCODE = ZERO                                03380033
079797                    IF XST00017-DC-RET-CDE = PV-DC-RET-CDE        03390033
079797                       CONTINUE                                   03400033
079797                    ELSE                                          03410033
134300                       MOVE PV-DC-RET-CDE                         03420035
134300                                      TO XST00017-DC-RET-CDE      03430035
079797                       PERFORM 6000-UPDATE-VENDOR-DEPT            03440033
079797                          UNTIL PS-MOVE-ON-YES                    03450048
132200                       SET PS-MOVE-ON-NO TO TRUE                  03460048
079797                    END-IF                                        03470033
079797                 END-IF                                           03480033
079797              END-IF                                              03490047
079797           END-IF                                                 03500028
079797        END-IF                                                    03510013
079797     END-IF.                                                      03520003
091300                                                                  03530001
091400******************************************************************03540001
091900 3000-CLOSE-FILES.                                                03550001
091600*     CLOSE EXTRACT FILE.                                         03560005
091800******************************************************************03570001
092000                                                                  03580001
092300     CLOSE VENDOR-DEPT-EXTRACT-FILE.                              03590003
092400                                                                  03600001
129600******************************************************************03610001
129900 4000-SELECT-VENDOR-DEPT.                                         03620007
129800******************************************************************03630001
129500                                                                  03640001
130000     MOVE VN101-ENT-ID                TO XST00017-ENT-ID.         03650013
130000     MOVE VN101-DEPT-NBR              TO XST00017-DEPT-NBR.       03660013
129500                                                                  03670007
130000     EXEC SQL                                                     03680007
130100        SELECT  DC_RET_CDE                                        03690007
130200          INTO :XST00017-DC-RET-CDE                               03700007
131400          FROM  XST_VND_DEPT                                      03710007
131500         WHERE  ENT_ID      = :XST00017-ENT-ID                    03720012
131500           AND  DEPT_NBR    = :XST00017-DEPT-NBR                  03730012
131500                WITH UR                                           03740007
131800     END-EXEC.                                                    03750001
131900                                                                  03760001
132000     EVALUATE SQLCODE                                             03770007
132100        WHEN ZERO                                                 03780007
132300        WHEN PC-ROW-NOT-FOUND                                     03790019
132200           CONTINUE                                               03800008
132500        WHEN OTHER                                                03810007
132700           MOVE '4000-SELECT-VENDOR-DEPT'                         03820007
132800                                      TO PV-PARAGRAPH-NAME        03830001
133100           PERFORM 9100-SQL-ABEND                                 03840001
133200     END-EVALUATE.                                                03850001
133300                                                                  03860001
133400******************************************************************03870001
133700 5000-INSERT-VENDOR-DEPT.                                         03880007
133600******************************************************************03890001
133800                                                                  03900001
133900     EXEC SQL                                                     03910001
134000        INSERT INTO XST_VND_DEPT                                  03920007
134000        VALUES                                                    03930007
134000           (                                                      03940007
134000             :XST00017-ENT-ID                                     03950007
134000            ,:XST00017-DEPT-NBR                                   03960007
134000            ,:XST00017-DC-RET-CDE                                 03970007
134000            ,CURRENT TIMESTAMP                                    03980024
134000           )                                                      03990007
134100     END-EXEC.                                                    04000001
134200                                                                  04010036
132000     EVALUATE SQLCODE                                             04020041
132100        WHEN ZERO                                                 04030041
132200           SET PS-MOVE-ON-YES         TO TRUE                     04040048
                 ADD +1                     TO PV-INSERT-VNDDEPT-CNT    04041050
132500        WHEN -904                                                 04050041
132500        WHEN -911                                                 04060041
132500        WHEN -913                                                 04070041
132200           ADD 1                      TO PV-DB2-ERROR-COUNT       04080041
129900           IF PV-DB2-ERROR-COUNT       > PC-MAX-DB2-ERROR-5       04090041
000200              MOVE VN101-ENT-ID       TO OUT-ENT-ID               04100041
000300              MOVE VN101-DEPT-NBR     TO OUT-DEPT-NBR             04110041
000500              MOVE VN101-VEND-TYP-IND TO OUT-VEND-TYP-IND         04120041
000700              MOVE VN101-VND-DEPT-STAT-CD                         04130041
000700                                      TO OUT-VND-DEPT-STAT-CD     04140041
007300              MOVE VN101-RTV-RA-REQD-IND                          04150048
007300                                      TO OUT-RTV-RA-REQD-IND      04160048
007400              MOVE VN101-RTV-NO-RA-REQD-IND                       04170041
007400                                      TO OUT-RTV-NO-RA-REQD-IND   04180041
007500              MOVE VN101-DEBIT-DESTROY-IND                        04190041
007500                                      TO OUT-DEBIT-DESTROY-IND    04200041
007600              MOVE VN101-MARKOUT-IND  TO OUT-MARKOUT-IND          04210041
007700              MOVE VN101-PRCHS-AGMNT-EFF-DTE                      04220041
007700                                      TO OUT-PRCHS-AGMNT-EFF-DTE  04230041
007800              MOVE VN101-PRCHS-AGMNT-EXP-DTE                      04240041
007800                                      TO OUT-PRCHS-AGMNT-EXP-DTE  04250041
129900              MOVE SQLCODE            TO OUT-SQLCODE              04260041
129900              PERFORM 7000-WRITE-ERROR-RECORD                     04270041
129900              ADD 1                   TO PV-ERROR-RECORD-COUNT    04280041
132200              SET PS-MOVE-ON-YES      TO TRUE                     04290048
132200              MOVE ZERO               TO PV-DB2-ERROR-COUNT       04300048
129900              IF PV-ERROR-RECORD-COUNT > CC-ABEND-THRESHOLD-NBR   04310041
134800                 MOVE '5000-INSERT-VENDOR-DEPT'                   04320041
134800                                      TO PV-PARAGRAPH-NAME        04330041
134800                 MOVE PC-INSERT       TO OUT-INSRT-UPD-IND        04340041
129900                 PERFORM 9100-SQL-ABEND                           04350041
129900              END-IF                                              04360041
129900           END-IF                                                 04370041
132500        WHEN OTHER                                                04380041
000200           MOVE VN101-ENT-ID          TO OUT-ENT-ID               04390041
000300           MOVE VN101-DEPT-NBR        TO OUT-DEPT-NBR             04400041
000500           MOVE VN101-VEND-TYP-IND    TO OUT-VEND-TYP-IND         04410041
000700           MOVE VN101-VND-DEPT-STAT-CD                            04420041
000700                                      TO OUT-VND-DEPT-STAT-CD     04430041
007300           MOVE VN101-RTV-RA-REQD-IND TO OUT-RTV-RA-REQD-IND      04440041
007400           MOVE VN101-RTV-NO-RA-REQD-IND                          04450041
007400                                      TO OUT-RTV-NO-RA-REQD-IND   04460041
007500           MOVE VN101-DEBIT-DESTROY-IND                           04470041
007500                                      TO OUT-DEBIT-DESTROY-IND    04480041
007600           MOVE VN101-MARKOUT-IND     TO OUT-MARKOUT-IND          04490041
007700           MOVE VN101-PRCHS-AGMNT-EFF-DTE                         04500041
007700                                      TO OUT-PRCHS-AGMNT-EFF-DTE  04510041
007800           MOVE VN101-PRCHS-AGMNT-EXP-DTE                         04520041
007800                                      TO OUT-PRCHS-AGMNT-EXP-DTE  04530041
129900           MOVE SQLCODE               TO OUT-SQLCODE              04540041
129900           PERFORM 7000-WRITE-ERROR-RECORD                        04550041
129900           ADD 1                      TO PV-ERROR-RECORD-COUNT    04560041
129900           SET PS-MOVE-ON-YES         TO TRUE                     04570048
129900           IF PV-ERROR-RECORD-COUNT > CC-ABEND-THRESHOLD-NBR      04580041
134800              MOVE '5000-INSERT-VENDOR-DEPT'                      04590041
134800                                      TO PV-PARAGRAPH-NAME        04600041
134800              MOVE PC-INSERT          TO OUT-INSRT-UPD-IND        04610041
129900              PERFORM 9100-SQL-ABEND                              04620041
129900           END-IF                                                 04630041
133200     END-EVALUATE.                                                04640041
133300                                                                  04650041
135500******************************************************************04660001
135800 5500-EVALUATE-DC-RETURN-CODE.                                    04670007
135700******************************************************************04680001
135900                                                                  04690007
135900     EVALUATE TRUE                                                04700007
136000        WHEN VN101-RTV-RA-REQD-IND     = 'Y'                      04710025
136000           MOVE 'RA'                  TO PV-DC-RET-CDE            04720025
135900        WHEN VN101-RTV-NO-RA-REQD-IND  = 'Y'                      04730025
136000           MOVE 'RV'                  TO PV-DC-RET-CDE            04740025
135900        WHEN VN101-DEBIT-DESTROY-IND   = 'Y'                      04750025
136000           MOVE 'DD'                  TO PV-DC-RET-CDE            04760007
136000        WHEN VN101-MARKOUT-IND         = 'Y'                      04770025
136000           MOVE 'MO'                  TO PV-DC-RET-CDE            04780025
136000        WHEN OTHER                                                04790025
136000           MOVE 'NA'                  TO PV-DC-RET-CDE            04800025
136100     END-EVALUATE.                                                04810007
137400                                                                  04820001
133400******************************************************************04830007
133700 6000-UPDATE-VENDOR-DEPT.                                         04840007
133600******************************************************************04850007
133800                                                                  04860007
133900     EXEC SQL                                                     04870007
134000        UPDATE XST_VND_DEPT                                       04880007
134000           SET DC_RET_CDE    = :XST00017-DC-RET-CDE               04890007
134000              ,LAST_UPD_TMST = CURRENT TIMESTAMP                  04900024
134000         WHERE ENT_ID        = :XST00017-ENT-ID                   04910007
134000           AND DEPT_NBR      = :XST00017-DEPT-NBR                 04920007
134100     END-EXEC.                                                    04930007
134200                                                                  04940036
132000     EVALUATE SQLCODE                                             04950044
132100        WHEN ZERO                                                 04960044
132200           SET PS-MOVE-ON-YES         TO TRUE                     04970048
                 ADD +1                     TO PV-UPDATE-VNDDEPT-CNT    04971050
132500        WHEN -904                                                 04980044
132500        WHEN -911                                                 04990044
132500        WHEN -913                                                 05000044
132200           ADD 1                      TO PV-DB2-ERROR-COUNT       05010044
129900           IF PV-DB2-ERROR-COUNT       > PC-MAX-DB2-ERROR-5       05020044
000200              MOVE VN101-ENT-ID       TO OUT-ENT-ID               05030044
000300              MOVE VN101-DEPT-NBR     TO OUT-DEPT-NBR             05040044
000500              MOVE VN101-VEND-TYP-IND TO OUT-VEND-TYP-IND         05050044
000700              MOVE VN101-VND-DEPT-STAT-CD                         05060044
000700                                      TO OUT-VND-DEPT-STAT-CD     05070044
007300              MOVE VN101-RTV-RA-REQD-IND TO OUT-RTV-RA-REQD-IND   05080044
007400              MOVE VN101-RTV-NO-RA-REQD-IND                       05090044
007400                                      TO OUT-RTV-NO-RA-REQD-IND   05100044
007500              MOVE VN101-DEBIT-DESTROY-IND                        05110044
007500                                      TO OUT-DEBIT-DESTROY-IND    05120044
007600              MOVE VN101-MARKOUT-IND  TO OUT-MARKOUT-IND          05130044
007700              MOVE VN101-PRCHS-AGMNT-EFF-DTE                      05140044
007700                                      TO OUT-PRCHS-AGMNT-EFF-DTE  05150044
007800              MOVE VN101-PRCHS-AGMNT-EXP-DTE                      05160044
007800                                      TO OUT-PRCHS-AGMNT-EXP-DTE  05170044
129900              MOVE SQLCODE            TO OUT-SQLCODE              05180044
129900              PERFORM 7000-WRITE-ERROR-RECORD                     05190044
129900              ADD 1                   TO PV-ERROR-RECORD-COUNT    05200044
132200              SET PS-MOVE-ON-YES      TO TRUE                     05210048
132200              MOVE ZERO               TO PV-DB2-ERROR-COUNT       05220048
129900              IF PV-ERROR-RECORD-COUNT > CC-ABEND-THRESHOLD-NBR   05230044
134800                 MOVE '6000-UPDATE-VENDOR-DEPT'                   05240044
134800                                      TO PV-PARAGRAPH-NAME        05250044
134800                 MOVE PC-UPDATE       TO OUT-INSRT-UPD-IND        05260044
129900                 PERFORM 9100-SQL-ABEND                           05270044
129900              END-IF                                              05280044
129900           END-IF                                                 05290044
132500        WHEN OTHER                                                05300044
000200           MOVE VN101-ENT-ID          TO OUT-ENT-ID               05310044
000300           MOVE VN101-DEPT-NBR        TO OUT-DEPT-NBR             05320044
000500           MOVE VN101-VEND-TYP-IND    TO OUT-VEND-TYP-IND         05330044
000700           MOVE VN101-VND-DEPT-STAT-CD                            05340044
000700                                      TO OUT-VND-DEPT-STAT-CD     05350044
007300           MOVE VN101-RTV-RA-REQD-IND TO OUT-RTV-RA-REQD-IND      05360044
007400           MOVE VN101-RTV-NO-RA-REQD-IND                          05370044
007400                                      TO OUT-RTV-NO-RA-REQD-IND   05380044
007500           MOVE VN101-DEBIT-DESTROY-IND                           05390044
007500                                      TO OUT-DEBIT-DESTROY-IND    05400044
007600           MOVE VN101-MARKOUT-IND     TO OUT-MARKOUT-IND          05410044
007700           MOVE VN101-PRCHS-AGMNT-EFF-DTE                         05420044
007700                                      TO OUT-PRCHS-AGMNT-EFF-DTE  05430044
007800           MOVE VN101-PRCHS-AGMNT-EXP-DTE                         05440044
007800                                      TO OUT-PRCHS-AGMNT-EXP-DTE  05450044
129900           MOVE SQLCODE               TO OUT-SQLCODE              05460044
129900           PERFORM 7000-WRITE-ERROR-RECORD                        05470044
129900           ADD 1                      TO PV-ERROR-RECORD-COUNT    05480044
129900           SET PS-MOVE-ON-YES         TO TRUE                     05490048
129900           IF PV-ERROR-RECORD-COUNT > CC-ABEND-THRESHOLD-NBR      05500044
134800              MOVE '6000-UPDATE-VENDOR-DEPT'                      05510044
134800                                      TO PV-PARAGRAPH-NAME        05520044
134800              MOVE PC-UPDATE          TO OUT-INSRT-UPD-IND        05530044
129900              PERFORM 9100-SQL-ABEND                              05540044
129900           END-IF                                                 05550044
133200     END-EVALUATE.                                                05560044
133300                                                                  05570044
116867******************************************************************05580001
116868 7000-WRITE-ERROR-RECORD.                                         05590019
116869*     WRITE ERROR RECORD OUT TO THE FILE.                         05600015
116870******************************************************************05610001
116871                                                                  05620001
116873     WRITE ERROR-RECORD                                           05630015
116873        FROM OUT-ERROR-FILE.                                      05640015
118126                                                                  05650001
117500     INITIALIZE OUT-ERROR-FILE.                                   05660015
117000                                                                  05670001
116867******************************************************************05680015
116868 7500-UPDATE-CONTROL-CARD.                                        05690015
116869*     UPDATE CONTROL CARDS. CLOSE FILES.                          05700021
116870******************************************************************05710015
116871                                                                  05720015
116872     OPEN OUTPUT LAST-SUCCESSFUL-DATE-FILE.                       05730015
118126                                                                  05740015
116872     MOVE CC-SCHEDULE-DATE       TO CC-LAST-SUCCESS-RUN-DATE.     05750038
116873     WRITE LAST-SUCCESSFUL-DATE-RECORD                            05760015
116874        FROM CC-CONTROL-CARD-1.                                   05770015
118126                                                                  05780015
117500     CLOSE LAST-SUCCESSFUL-DATE-FILE                              05790021
117500           ERROR-FILE.                                            05800021
059500                                                                  05801050
059600****************************************************************  05802050
059620* 9000-END-OF-PGM.                                                05803050
059630*     DISPLAYS PROGRAM TOTALS.                                    05804050
059631*     SETS THE RETURN CODE TO 04 IF ANY ERROR RECORDS WRITTEN.    05805050
059640***************************************************************** 05806050
059900 9000-END-OF-PGM.                                                 05807050
060000                                                                  05808050
060500     DISPLAY '******** COUNTS **************************'.        05809050
060600     DISPLAY '      EXTRACT REC READ CNT= ' PV-EXTRACT-READ-CNT.  05809150
060600     DISPLAY '    EXTRACT UNIQUE KEY CNT= ' PV-UNIQUE-KEY-CNT.    05809250
060600     DISPLAY ' VND DEPT ROWS CHECKED CNT= ' PV-CHECK-VNDDEPT-CNT. 05809350
060600     DISPLAY 'VND DEPT ROWS INSERTED CNT= ' PV-INSERT-VNDDEPT-CNT.05809450
060600     DISPLAY ' VND DEPT ROWS UPDATED CNT= ' PV-UPDATE-VNDDEPT-CNT.05809550
060800     DISPLAY '        ERROR RECS WRITTEN= ' PV-ERROR-RECORD-COUNT.05809650
061000     DISPLAY '                              '.                    05809750
061400     DISPLAY '******************************************'.        05809850
061500                                                                  05809950
061600     IF  PV-ERROR-RECORD-COUNT > 0                                05810050
061700         MOVE 04               TO RETURN-CODE                     05810150
061800     END-IF.                                                      05810250
117000                                                                  05811015
180900******************************************************************05820001
181000* 9100-SQL-ABEND                                                  05830001
181100*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.05840001
181200******************************************************************05850001
181300 9100-SQL-ABEND.                                                  05860001
181400     DISPLAY '** ABEND     **'.                                   05870001
181500     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        05880001
181600     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              05890001
181700     DISPLAY '** VENDOR    ** = ' VN101-ENT-ID.                   05900013
181700     DISPLAY '** DEPT      ** = ' VN101-DEPT-NBR.                 05910013
181700     DISPLAY '** EFF DATE  ** = ' VN101-PRCHS-AGMNT-EFF-DTE.      05920013
181700     DISPLAY '** EXP DATE  ** = ' VN101-PRCHS-AGMNT-EXP-DTE.      05930013
181800                                                                  05940001
181900******************************************************************05950001
182000* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     05960001
182100* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      05970001
182200******************************************************************05980001
182300     COPY DPPD004.                                                05990055
182400                                                                  06000001
182500     SET AC-DB2-ERROR TO TRUE.                                    06010001
182600     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         06020001
182700                                                                  06030001
182800******************************************************************06040001
182900* 9999-ABEND                                                      06050001
183000*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  06060001
183100******************************************************************06070001
183200 9999-ABEND.                                                      06080001
183300     DISPLAY '** ABEND           **'.                             06090001
183400     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  06100001
183500     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        06110001
183600     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       06120001
183700     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       06130001
183800     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         06140001
