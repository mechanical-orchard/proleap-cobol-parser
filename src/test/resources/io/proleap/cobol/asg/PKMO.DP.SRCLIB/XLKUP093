000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400                                                                  00040000
000500 PROGRAM-ID.   XLKUP093.                                          00050000
000600 AUTHOR.       AYAN (COGNIZANT).                                  00060000
000700 INSTALLATION. KOHLS DEPARTMENT STORES.                           00070000
000800 DATE-WRITTEN. APR, 2015.                                         00080000
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100******************************************************************00110000
001200*PROGRAM TO CORRECT PACK UPC NUMBER DIFFERENCES BETWEEN          *00120000
001300*XLT_PK_UPC AND TPOPRPK TABLE FOR THE PACKS THAT ARE POINTING AT *00130000
001310*A UPC OF TPOPRPK THAT IS NO LONGER ASSOCIATED WITH THE PACK ON  *00131000
001320*XLT_PK_UPC TABLE.                                               *00132000
001400******************************************************************00133000
001500 ENVIRONMENT DIVISION.                                            00134000
001600******************************************************************00135000
001700                                                                  00136000
001800 CONFIGURATION SECTION.                                           00137000
001900                                                                  00138000
002000 SOURCE-COMPUTER.        IBM-3090.                                00139000
002100 OBJECT-COMPUTER.        IBM-3090.                                00140000
002200                                                                  00150000
002300******************************************************************00160000
002400 DATA DIVISION.                                                   00170000
002500******************************************************************00180000
002600                                                                  00190000
002700******************************************************************00200000
002800 WORKING-STORAGE SECTION.                                         00210000
002900******************************************************************00220000
003000******************************************************************00230000
003100*  COMMUNICATIONS AREA FOR DB2                                   *00240000
003200******************************************************************00250000
003300     EXEC SQL                                                     00260000
003400          INCLUDE SQLCA                                           00270000
003500     END-EXEC.                                                    00280000
003600                                                                  00290000
003700******************************************************************00300000
003800*  DB2 TABLE DECLARATION - TPOPRPK                               *00310000
003900******************************************************************00320000
004000     EXEC SQL                                                     00330000
004100          INCLUDE TPOPRPK                                         00340000
004200     END-EXEC.                                                    00350000
004300                                                                  00360000
004400******************************************************************00370000
004500*  DB2 TABLE DECLARATION - XLT_PK_UPC                            *00380000
004600******************************************************************00390000
004700     EXEC SQL                                                     00400000
004800          INCLUDE XLT00009                                        00410000
004900     END-EXEC.                                                    00420000
005000                                                                  00430000
005100******************************************************************00440000
005200*    CURSOR TO SELECT SKU'S WHICH HAS DIFFERENCES IN PACK-UPC    *00450000
005300*    VALUE FOR A PACK-SKU IN XLT_PK_UPC AND TPOPRPK TABLE        *00460000
005400******************************************************************00470000
005500     EXEC SQL                                                     00480000
005600        DECLARE PK_UPC_CSR CURSOR WITH HOLD FOR                   00490000
005700            SELECT                                                00500000
005900                   A.PO_NBR                                       00510000
006000                  ,A.PK_SKU_NBR                                   00520000
006010                  ,A.PREPK_UPC_NBR                                00530000
006020                  ,C.UPC_NBR                                      00540000
006100            FROM                                                  00550000
006200                   TPOPRPK    A                                   00560000
006300                  ,XLT_PK_UPC C                                   00570000
006400            WHERE                                                 00580000
006500                   A.PK_DTL_CHG_TMST >                            00590000
006510                              '2014-01-01-00.00.00.000000'        00600000
006520               AND A.PK_SKU_NBR      > 0                          00610000
006530               AND NOT EXISTS (SELECT *                           00620000
006540                                 FROM XLT_PK_UPC B                00630000
006550                                WHERE B.PK_SKU_NBR = A.PK_SKU_NBR 00640000
006560                                  AND B.UPC_NBR = A.PREPK_UPC_NBR 00650000
006570                              )                                   00651000
006600               AND C.PK_SKU_NBR      = A.PK_SKU_NBR               00652000
006700               AND C.EDI_ORD_IND     = 'Y'                        00653000
006800            ORDER BY                                              00654000
006810                    A.PO_NBR                                      00655000
006820                   ,A.PK_SKU_NBR                                  00656000
006900     END-EXEC.                                                    00657000
007000                                                                  00658000
007100******************************************************************00659000
007200*  WORK AREA FOR SQL ERROR ROUTINE 'DSNTIAR'                     *00660000
007300******************************************************************00670000
007400     COPY DPWS004.                                                00680000
007500                                                                  00690000
007600 01  ABEND-CODE                    PIC S9(04)  VALUE +0           00700000
007700                                                   COMP SYNC.     00710000
007800 01  PS-PROGRAM-SWITCHES.                                         00720000
007900     05  PS-END-OF-SKU_DESC-CSR-SW PIC X(01)   VALUE 'N'.         00730000
008000         88  PS-END-OF-PK-UPC-CSR              VALUE 'Y'.         00740000
008100         88  PS-END-OF-PK-UPC-CSR-NO           VALUE 'N'.         00750000
008200                                                                  00760000
008300 01  PC-PROGRAM-CONSTANTS.                                        00770000
008400     05  PC-PGM-NAME               PIC X(08)   VALUE 'XLKUP093'.  00780000
008500     05  PC-COMMIT-HOLD            PIC 9(03)   VALUE 100.         00790000
008510     05  PC-PK-DTL-CHG-TMST        PIC X(26)   VALUE              00800000
008520                                  '2014-01-01-00.00.00.000000'.   00810000
008600                                                                  00820000
008700 01 PV-PROGRAM-VARIABLES.                                         00830000
008800     05  PV-ABEND-PARAGRAPH        PIC X(35)   VALUE SPACES.      00840000
008900     05  PV-DB2-OPN-ATTEMPTED      PIC X(35)   VALUE SPACES.      00850000
009000     05  PV-FETCH-CNT              PIC 9(13)   VALUE ZEROES.      00860000
009100     05  PV-UPDATE-CNT             PIC 9(13)   VALUE ZEROES.      00870000
009200     05  PV-UPD-COUNT-TOT          PIC 9(13)   VALUE ZEROES.      00880000
009300     05  PV-COMMIT-CNT             PIC 9(13)   VALUE ZEROES.      00890000
009400     05  PV-DISPLAY-COUNT          PIC Z(12)9.                    00900000
009500                                                                  00910000
009600 LINKAGE SECTION.                                                 00920000
009700 PROCEDURE DIVISION.                                              00930000
009800******************************************************************00940000
009900*  0000-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE PROGRAM.  *00950000
010000******************************************************************00960000
010100 0000-PROGRAM-MAINLINE.                                           00970000
010200                                                                  00980000
010300     PERFORM 1000-INITIALIZE.                                     00990000
010400     PERFORM 2000-PROCESS-PK-UPC-DIFF.                            01000000
010500     PERFORM 8000-EOJ-ROUTINE.                                    01010000
010600                                                                  01020000
010700     STOP RUN.                                                    01030000
010800                                                                  01040000
010900******************************************************************01050000
011000*  PERFORMS INITIALIZATION.                                      *01060000
011100******************************************************************01070000
011200 1000-INITIALIZE.                                                 01080000
011300                                                                  01090000
011400     DISPLAY 'START OF PROGRAM : ' PC-PGM-NAME.                   01100000
011500                                                                  01110000
011600     INITIALIZE DCLTPOPRPK                                        01120000
011700                DCLXLT00009                                       01130000
011800                PV-PROGRAM-VARIABLES.                             01140000
011900                                                                  01150000
012000     SET PS-END-OF-PK-UPC-CSR-NO  TO TRUE.                        01160000
012100                                                                  01170000
012200*                                                                 01180000
012300******************************************************************01190000
012400* PERFORMS MAIN PROCESSING                                       *01200000
012500******************************************************************01210000
012600 2000-PROCESS-PK-UPC-DIFF.                                        01220000
012700                                                                  01230000
012800     PERFORM 2100-OPEN-PK-UPC-CSR.                                01240000
012900                                                                  01250000
013000     PERFORM 2200-FETCH-PK-UPC-CSR                                01260000
013100       UNTIL PS-END-OF-PK-UPC-CSR.                                01270000
013200                                                                  01280000
013300     PERFORM 2300-CLOSE-PK-UPC-CSR.                               01290000
013400                                                                  01300000
013500*                                                                 01310000
013600******************************************************************01320000
013700* OPENS PACK DESCRIPTION DIFERENCE CURSOR                        *01330000
013800******************************************************************01340000
013900 2100-OPEN-PK-UPC-CSR.                                            01350000
014000                                                                  01360000
014100     EXEC SQL                                                     01370000
014200          OPEN PK_UPC_CSR                                         01380000
014300     END-EXEC.                                                    01390000
014400                                                                  01400000
014500     EVALUATE TRUE                                                01410000
014600         WHEN SQLCODE = 0                                         01420000
014700             CONTINUE                                             01430000
014800         WHEN OTHER                                               01440000
014900             MOVE '2100-OPEN-PK-UPC-CSR'                          01450000
015000                                     TO PV-ABEND-PARAGRAPH        01460000
015100             MOVE 'OPEN PK_UPC_CSR'  TO PV-DB2-OPN-ATTEMPTED      01470000
015300             PERFORM 9100-SQL-ABEND                               01480000
015400     END-EVALUATE.                                                01490000
015500                                                                  01500000
015600*                                                                 01510000
015700******************************************************************01520000
015800* FETCHES PACK DESCRIPTION DIFFERENCE CURSOR                     *01530000
015900******************************************************************01540000
016000 2200-FETCH-PK-UPC-CSR.                                           01550000
016100                                                                  01560000
016200     INITIALIZE DCLTPOPRPK                                        01570000
016300                DCLXLT00009.                                      01580000
016400                                                                  01590000
016500     EXEC SQL                                                     01600000
016600          FETCH PK_UPC_CSR                                        01610000
016700           INTO :POPRPK-PO-NBR                                    01620000
016800               ,:POPRPK-PK-SKU-NBR                                01630000
016900               ,:POPRPK-PREPK-UPC-NBR                             01640000
016910               ,:XLT00009-UPC-NBR                                 01650000
017000     END-EXEC.                                                    01660000
017100                                                                  01670000
017200     EVALUATE TRUE                                                01680000
017300         WHEN SQLCODE = ZEROS                                     01690000
017400             ADD 1                 TO PV-FETCH-CNT                01700000
017410             DISPLAY '** BEFORE UPDATE **'                        01710000
017420             DISPLAY 'PO NUMBER       :' POPRPK-PO-NBR            01720000
017430             DISPLAY 'PACK SKU NUMBER :' POPRPK-PK-SKU-NBR        01730000
017440             DISPLAY 'PACK UPC NUMBER :' POPRPK-PREPK-UPC-NBR     01740000
017500             PERFORM 3000-UPDATE-TPOPRPK-PK-UPC                   01750000
017600         WHEN SQLCODE = +100                                      01760000
017700             SET PS-END-OF-PK-UPC-CSR                             01770000
017800                                   TO TRUE                        01780000
017900         WHEN OTHER                                               01790000
018000             MOVE '2200-FETCH-PK-UPC-CSR'                         01800000
018100                                   TO PV-ABEND-PARAGRAPH          01810000
018200             MOVE 'FETCH PK_UPC_CSR'                              01820000
018300                                   TO PV-DB2-OPN-ATTEMPTED        01830000
018400           PERFORM 9100-SQL-ABEND                                 01840000
018500     END-EVALUATE.                                                01850000
018600                                                                  01860000
018700*                                                                 01870000
018800******************************************************************01880000
018900* CLOSES PACK DESCRIPTION DIFFERENCE CURSOR                      *01890000
019000******************************************************************01900000
019100 2300-CLOSE-PK-UPC-CSR.                                           01910000
019200                                                                  01920000
019300     EXEC SQL                                                     01930000
019400          CLOSE PK_UPC_CSR                                        01940000
019500     END-EXEC.                                                    01950000
019600                                                                  01960000
019700     EVALUATE TRUE                                                01970000
019800         WHEN SQLCODE = 0                                         01980000
019900             IF PV-UPDATE-CNT > 0                                 01990000
020000               PERFORM 4000-COMMIT                                02000000
020100             END-IF                                               02010000
020200         WHEN OTHER                                               02020000
020300             MOVE '2300-CLOSE-PK-UPC-CSR'                         02030000
020400                                   TO PV-ABEND-PARAGRAPH          02040000
020500             MOVE 'CLOSE PK_UPC_CSR'                              02050000
020600                                   TO PV-DB2-OPN-ATTEMPTED        02060000
020700             PERFORM 9100-SQL-ABEND                               02070000
020800     END-EVALUATE.                                                02080000
020900                                                                  02090000
021020*                                                                 02100000
021100******************************************************************02110000
021200* UPDATES UPC-NBR IN TPOPRPK WITH THAT OF XLT_PK_UPC             *02120000
021300******************************************************************02130000
021400 3000-UPDATE-TPOPRPK-PK-UPC.                                      02140000
021500                                                                  02150000
021510     MOVE XLT00009-UPC-NBR         TO POPRPK-PREPK-UPC-NBR        02151000
021520                                                                  02152000
021600     EXEC SQL                                                     02153000
021700         UPDATE TPOPRPK                                           02154000
021800           SET  PREPK_UPC_NBR = :POPRPK-PREPK-UPC-NBR             02155000
021900         WHERE                                                    02156000
022000                PO_NBR       = :POPRPK-PO-NBR                     02157000
022100           AND  PK_SKU_NBR   = :POPRPK-PK-SKU-NBR                 02158000
022200     END-EXEC.                                                    02159000
022300                                                                  02160000
022400     EVALUATE TRUE                                                02170000
022500         WHEN SQLCODE = ZEROS                                     02180000
022600             ADD  1                TO  PV-UPDATE-CNT              02190000
022700                                       PV-UPD-COUNT-TOT           02200000
022800             DISPLAY '** AFTER UPDATE **'                         02210000
022810             DISPLAY 'PO NUMBER       :' POPRPK-PO-NBR            02220000
022900             DISPLAY 'PACK SKU NUMBER :' POPRPK-PK-SKU-NBR        02230000
022910             DISPLAY 'PACK UPC NUMBER :' POPRPK-PREPK-UPC-NBR     02240000
023000             IF PV-UPDATE-CNT = PC-COMMIT-HOLD                    02250000
023100                PERFORM 4000-COMMIT                               02260000
023200             END-IF                                               02270000
023210         WHEN SQLCODE = +100                                      02280000
023300             CONTINUE                                             02290000
023400         WHEN OTHER                                               02300000
023500             MOVE '3000-UPDATE-TPOPRPK-PK-UPC'                    02310000
023600                                   TO PV-ABEND-PARAGRAPH          02320000
023700             MOVE 'UDPATE TPOPRPK' TO PV-DB2-OPN-ATTEMPTED        02330000
023900           PERFORM 9100-SQL-ABEND                                 02340000
024000     END-EVALUATE.                                                02350000
024100                                                                  02360000
024200 EJECT                                                            02370000
024300*                                                                 02380000
024400******************************************************************02390000
024500* TAKES COMMIT                                                   *02400000
024600******************************************************************02410000
024700 4000-COMMIT.                                                     02420000
024800                                                                  02430000
024900     EXEC SQL                                                     02440000
025000         COMMIT                                                   02450000
025100     END-EXEC.                                                    02460000
025200                                                                  02470000
025300     EVALUATE TRUE                                                02480000
025400         WHEN SQLCODE = ZEROS                                     02490000
025500             MOVE 0                TO PV-UPDATE-CNT               02500000
025600             ADD +1                TO PV-COMMIT-CNT               02510000
025700         WHEN OTHER                                               02520000
025800             MOVE '4000-COMMIT'    TO PV-ABEND-PARAGRAPH          02530000
025900             MOVE 'COMMIT'         TO PV-DB2-OPN-ATTEMPTED        02540000
026000           PERFORM 9100-SQL-ABEND                                 02550000
026100     END-EVALUATE.                                                02560000
026200                                                                  02570000
026300*                                                                 02580000
026400******************************************************************02590000
026500* DISPLAYS PROGRAM STATISTICS                                    *02600000
026600******************************************************************02610000
026700 8000-EOJ-ROUTINE.                                                02620000
026800                                                                  02630000
026900     DISPLAY '*************************************************'. 02640000
027000     DISPLAY '**             XLKUP093 SUMMARY                **'. 02650000
027100     DISPLAY '*************************************************'. 02660000
027200     MOVE  PV-FETCH-CNT              TO PV-DISPLAY-COUNT.         02670000
027300     DISPLAY 'TOTAL RECORDS FETCHED  = ' PV-DISPLAY-COUNT.        02680000
027400     MOVE  PV-UPD-COUNT-TOT          TO PV-DISPLAY-COUNT.         02690000
027500     DISPLAY 'TOTAL RECORDS UPDATED  = ' PV-DISPLAY-COUNT.        02700000
027600     MOVE  PV-COMMIT-CNT             TO PV-DISPLAY-COUNT.         02710000
027700     DISPLAY 'TOTAL COMMITS TAKEN    = ' PV-DISPLAY-COUNT.        02720000
027800     DISPLAY '*************************************************'. 02730000
027900     DISPLAY 'END OF PROGRAM   : ' PC-PGM-NAME.                   02740000
028000                                                                  02750000
028100 EJECT                                                            02760000
028200*                                                                 02770000
028300******************************************************************02780000
028400* PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    *02790000
028500* ERROR OR WARNING CODE OCCURS.                                  *02800000
028600******************************************************************02810000
028700 9100-SQL-ABEND.                                                  02820000
028800                                                                  02830000
028900     DISPLAY '9100-SQL-ABEND'.                                    02840000
029000     DISPLAY '** ABEND     **'.                                   02850000
029100     DISPLAY '** PROGRAM   ** = ' PC-PGM-NAME.                    02860000
029200     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.             02870000
029300     DISPLAY '** OPERATION ** = ' PV-DB2-OPN-ATTEMPTED.           02880000
029400     COPY DPPD004.                                                02890000
029500     MOVE +4013                      TO ABEND-CODE.               02900000
029600     CALL 'ILBOABN0' USING ABEND-CODE.                            02910000
029700                                                                  02920000
