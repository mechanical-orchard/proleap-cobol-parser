000100****************************************************************  00010002
000200 IDENTIFICATION DIVISION.                                         00020002
000300****************************************************************  00030002
000400                                                                  00040002
000500 PROGRAM-ID.         SAKUT004.                                    00050002
000600                                                                  00060002
000700 AUTHOR.             CRAIG VOSKUIL - STRATAGEM.                   00070002
000800                                                                  00080002
000900 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00090002
001000                                                                  00100002
001100 DATE-WRITTEN.       JUNE 1999.                                   00110002
001200                                                                  00120002
001300 DATE-COMPILED.                                                   00130002
001400                                                                  00140002
001500******************************************************************00150002
001600*                                                                *00160002
001700*     THIS PROGRAM CREATES A CASH AND CHECK DEPOSIT DOWNLOAD     *00170002
001800*     FILE TO BE FTP'D TO FINANCE.                               *00180002
001900*                                                                 00190002
002000*     SELECT TSAADDP ROWS AND EXTRACT STORE NUMBER, DATE,        *00200002
002100*     CASH ABD CHECK DEPOSITS.                                   *00210002
002200*                                                                *00220002
002300*     THIS NEW FILE WILL BE DOWNLOADED TO THE LAN.               *00230002
002400*                                                                *00240002
002500*----------------------------------------------------------       00250002
002600* HISTORY LOG:                                                    00260002
002700*----------------------------------------------------------       00270002
002800* DATE: 09/23/03                                                  00280002
002900* WR/IR#: WR25693                                                 00290002
003000* PROGRAMMER: GAYLE HAUPT                                         00300002
003100* DESCRIPTION: PER FINANCE (SALES AUDIT) REQUEST, ADD THE         00310002
003200*   ENDING CASH ON HAND (EB) BALANCE TO THE MONTHLY CASH          00320002
003300*   AND CHECKS DEPOSITED COMMA DELIMITED FILE.                    00330002
003400*----------------------------------------------------------       00340002
003500* DATE: 09/29/04                                                  00350002
003600* WR/IR#: WR27107                                                 00360002
003700* PROGRAMMER: THOMAS HANSON                                       00370002
003800* DESCRIPTION: ALTER THE CASH/CHECK EXTRACT FILE TO INCLUDE       00380002
003900*   A 4 DIGIT STORE NUMBER VALUE. INCREASES FILE SIZE BY 1.       00390002
004000*----------------------------------------------------------       00400002
004100******************************************************************00410002
004200     EJECT                                                        00420002
004300                                                                  00430002
004400****************************************************************  00440002
004500 ENVIRONMENT DIVISION.                                            00450002
004600****************************************************************  00460002
004700                                                                  00470002
004800 CONFIGURATION SECTION.                                           00480002
004900                                                                  00490002
005000 SOURCE-COMPUTER.    IBM-3090.                                    00500002
005100                                                                  00510002
005200 OBJECT-COMPUTER.    IBM-3090.                                    00520002
005300                                                                  00530002
005400 INPUT-OUTPUT SECTION.                                            00540002
005500                                                                  00550002
005600 FILE-CONTROL.                                                    00560002
005700                                                                  00570002
005800     SELECT FISCAL-MONTH-INPUT-FILE                               00580002
005900         ASSIGN TO INP01.                                         00590002
006000                                                                  00600002
006100     SELECT CASH-SALES-EXTRACT-FILE                               00610002
006200         ASSIGN TO OUT01.                                         00620002
006300                                                                  00630002
006400     EJECT                                                        00640002
006500****************************************************************  00650002
006600 DATA DIVISION.                                                   00660002
006700****************************************************************  00670002
006800                                                                  00680002
006900 FILE SECTION.                                                    00690002
007000                                                                  00700002
007100 FD  FISCAL-MONTH-INPUT-FILE                                      00710002
007200     RECORDING MODE IS F                                          00720002
007300     RECORD CONTAINS 80 CHARACTERS                                00730002
007400     LABEL RECORDS ARE STANDARD                                   00740002
007500     BLOCK CONTAINS 0 RECORDS.                                    00750002
007600                                                                  00760002
007700 01  FISCAL-MONTH-INPUT-RECORD  PIC X(80).                        00770002
007800                                                                  00780002
007900 FD  CASH-SALES-EXTRACT-FILE                                      00790002
008000     RECORDING MODE IS F                                          00800002
008100     RECORD CONTAINS 41 CHARACTERS                                00810002
008200     LABEL RECORDS ARE STANDARD                                   00820002
008300     BLOCK CONTAINS 0  RECORDS.                                   00830002
008400                                                                  00840002
008500 01  CASH-SALES-EXTRACT-RECORD   PIC X(41).                       00850002
008600                                                                  00860002
008700     EJECT                                                        00870002
008800****************************************************************  00880002
008900 WORKING-STORAGE SECTION.                                         00890002
009000****************************************************************  00900002
009100                                                                  00910002
009200 01  AC-ABEND-CODE               PIC S9(04) VALUE +0              00920002
009300                                                    COMP          00930002
009400                                                    SYNC.         00940002
009500                                                                  00950002
009600     88  AC-CURSOR-OPEN                             VALUE +4001.  00960002
009700     88  AC-CURSOR-CLOSE                            VALUE +4002.  00970002
009800     88  AC-CURSOR-FETCH                            VALUE +4003.  00980002
009900     88  AC-INVALID-CONTROL-CARD                    VALUE +4004.  00990002
010000     88  AC-CALENDAR-ROUTINE-ERROR                  VALUE +4005.  01000002
010100     88  AC-FILE-SEQUENCE-ERROR                     VALUE +4007.  01010002
010200     88  AC-DB2-ERROR                               VALUE +4013.  01020002
010300                                                                  01030002
010400     EJECT                                                        01040002
010500****************************************************************  01050002
010600*   CASH SALES EXTRACT RECORD LAYOUT - OUTPUT                     01060002
010700****************************************************************  01070002
010800                                                                  01080002
010900 01  CSE-CASH-SALES-EXTRACT.                                      01090002
011000     05  CSE-STORE               PIC  9(4)     VALUE ZEROES.      01100002
011100     05  FILLER                  PIC  X(1)     VALUE ','.         01110002
011200     05  CSE-DATE                PIC  9(6)     VALUE ZEROES.      01120002
011300     05  FILLER                  PIC  X(1)     VALUE ','.         01130002
011400     05  CSE-CASH-DEPOSIT        PIC  9(7)V99  VALUE ZEROES.      01140002
011500     05  FILLER                  PIC  X(1)     VALUE ','.         01150002
011600     05  CSE-CHECK-DEPOSIT       PIC  9(7)V99  VALUE ZEROES.      01160002
011700     05  FILLER                  PIC  X(1)     VALUE ','.         01170002
011800     05  CSE-ENDING-BALANCE      PIC  9(7)V99  VALUE ZEROES.      01180002
011900                                                                  01190002
012000****************************************************************  01200002
012100*  LAYOUT FOR THE INPUT FILE THAT INDICATES WHETHER OR NOT IT  *  01210002
012200*  IS FISCAL MONTH END                                         *  01220002
012300****************************************************************  01230002
012400                                                                  01240002
012500 01  FISCAL-MONTH-CONTROL-AREA.                                   01250002
012600     05  FM-CONTROL-DATE         PIC X(10)    VALUE SPACES.       01260002
012700     05  FM-CURRENT-DATE         PIC X(10)    VALUE SPACES.       01270002
012800     05  FM-LAST-WEEK-IND        PIC X(01)    VALUE SPACES.       01280002
012900         88  FM-LAST-FISCAL-WEEK              VALUE 'Y'.          01290002
013000         88  FM-NOT-LAST-FISCAL-WEEK          VALUE 'N'.          01300002
013100     05  FILLER                  PIC X(59)    VALUE SPACES.       01310002
013200                                                                  01320002
013300 01  PV-PROGRAM-VARIABLES.                                        01330002
013400     05  PV-RECORDS-WRITTEN      PIC S9(7)  VALUE +0 COMP-3.      01340002
013500     05  PV-DEPOSIT-CURSOR-COUNT PIC S9(7)  VALUE +0 COMP-3.      01350002
013600     05  PV-START-DATE           PIC X(10).                       01360002
013700     05  PV-END-DATE             PIC X(10).                       01370002
013800     05  PV-TNDR-TYP-CDE         PIC XX     VALUE SPACES.         01380002
013900     05  PV-PARAGRAPH-NAME       PIC X(30)  VALUE SPACES.         01390002
014000     05  PV-OPERATION-MSG-1      PIC X(40)  VALUE SPACES.         01400002
014100     05  PV-OPERATION-MSG-2      PIC X(40)  VALUE SPACES.         01410002
014200     05  PV-DB2-OPERATION        PIC X(30)  VALUE SPACES.         01420002
014300     05  PV-DB2-SLS-DTE          PIC X(10)  VALUE SPACES.         01430002
014400     05  PV-DB2-STR-NBR          PIC 9(04)  VALUE ZERO.           01440002
014500     05  PV-DB2-CTG-CDE          PIC X(04)  VALUE SPACES.         01450002
014600     05  PV-EDIT-MASK            PIC Z,ZZZ,ZZ9.                   01460002
014700     05  PV-DB2-ISO-DATE.                                         01470002
014800         10  PV-DB2-ISO-CC       PIC 99.                          01480002
014900         10  PV-DB2-ISO-YY       PIC 99.                          01490002
015000         10  FILLER              PIC X.                           01500002
015100         10  PV-DB2-ISO-MM       PIC 99.                          01510002
015200         10  FILLER              PIC X.                           01520002
015300         10  PV-DB2-ISO-DD       PIC 99.                          01530002
015400     05  PV-MDY-DATE             PIC 9(6).                        01540002
015500     05  FILLER REDEFINES PV-MDY-DATE.                            01550002
015600         10  PV-MDY-MM           PIC 99.                          01560002
015700         10  PV-MDY-DD           PIC 99.                          01570002
015800         10  PV-MDY-YY           PIC 99.                          01580002
015900                                                                  01590002
016000 01  PC-PROGRAM-CONSTANTS.                                        01600002
016100     05  PC-CURRENT-PROGRAM-NAME PIC X(8)   VALUE 'SAKUT004'.     01610002
016200     05  PC-ROW-NOT-FOUND        PIC S9(04) VALUE +100            01620002
016300                                            COMP SYNC.            01630002
016400                                                                  01640002
016500 01  PS-PROGRAM-SWITCHES.                                         01650002
016600     05  PS-END-OF-DEPOSIT-CURSOR-SW     PIC X      VALUE 'N'.    01660002
016700         88 PS-END-OF-DEPOSIT-CURSOR                VALUE 'Y'.    01670002
016800     05  PS-END-OF-FISCAL-FILE-SW        PIC X      VALUE 'N'.    01680002
016900         88 PS-END-OF-FISCAL-FILE                   VALUE 'Y'.    01690002
017000     05  PS-HAVE-CASH-SW                 PIC X      VALUE 'N'.    01700002
017100         88  PS-HAVE-CASH-Y                         VALUE 'Y'.    01710002
017200         88  PS-HAVE-CASH-N                         VALUE 'N'.    01720002
017300     05  PS-HAVE-CHECKS-SW               PIC X      VALUE 'N'.    01730002
017400         88  PS-HAVE-CHECKS-Y                       VALUE 'Y'.    01740002
017500         88  PS-HAVE-CHECKS-N                       VALUE 'N'.    01750002
017600     EJECT                                                        01760002
017700******************************************************************01770002
017800*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500) *           01780002
017900******************************************************************01790002
018000     COPY DPWS500.                                                01800002
018100     EJECT                                                        01810002
018200                                                                  01820002
018300******************************************************************01830002
018400*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            01840002
018500******************************************************************01850002
018600     COPY DPWS004.                                                01860002
018700                                                                  01870002
018800******************************************************************01880002
018900*  DB2 COMMUNICATION AREA. *                                      01890002
019000******************************************************************01900002
019100     EXEC SQL                                                     01910002
019200          INCLUDE SQLCA                                           01920002
019300     END-EXEC.                                                    01930002
019400 EJECT                                                            01940002
019500******************************************************************01950002
019600*  DB2 TABLE TSAADDP - ADJUSTED DEPOSITS TABLE *                  01960002
019700******************************************************************01970002
019800     EXEC SQL                                                     01980002
019900          INCLUDE TSAADDP                                         01990002
020000     END-EXEC.                                                    02000002
020100 EJECT                                                            02010002
020200******************************************************************02020002
020300*  DB2 TABLE TSAADSU - ADJUSTED SUMMARY TABLE *                   02030002
020400******************************************************************02040002
020500     EXEC SQL                                                     02050002
020600          INCLUDE TSAADSU                                         02060002
020700     END-EXEC.                                                    02070002
020800 EJECT                                                            02080002
020900******************************************************************02090002
021000*  CURSOR FOR FETCHING TSAADDP *                                 *02100002
021100*  ONLY GET DATA FOR THOSE STORES THAT HAVE STM <> 0.            *02110002
021200*  IF THEY DO NOT HAVE SALES ON A GIVEN DAY, THEY SHOULD NOT     *02120002
021300*  HAVE A DEPOSIT.   THIS WOULD REPRESENT A HOLIDAY.             *02130002
021400*  THE ADJUSTED AMT (ADJ_AMT) IS USED BECAUSE THIS IS THE AUDITED*02140002
021500*  AMOUNT.                                                        02150002
021600******************************************************************02160002
021700     EXEC SQL                                                     02170002
021800         DECLARE DEPOSIT-CURSOR CURSOR                            02180002
021900         FOR SELECT D.SLS_DTE                                     02190002
022000                   ,D.STR_NBR                                     02200002
022100                   ,D.TNDR_TYP_CDE                                02210002
022200                   ,D.STRT_TMST                                   02220002
022300                   ,D.TNDR_AMT                                    02230002
022400         FROM TSAADDP D                                           02240002
022500         WHERE D.SLS_DTE BETWEEN :PV-START-DATE AND :PV-END-DATE  02250002
022600                AND EXISTS                                        02260002
022700             (SELECT 1                                            02270002
022800                FROM TSAADSU T                                    02280002
022900               WHERE T.SLS_DTE     = D.SLS_DTE                    02290002
023000                 AND T.STR_NBR     = D.STR_NBR                    02300002
023100                 AND T.SUM_CTG_CDE = 'STM'                        02310002
023200                 AND T.ADJ_AMT    ^= 0)                           02320002
023300         ORDER BY D.SLS_DTE, D.STR_NBR, D.STRT_TMST               02330002
023400         WITH UR                                                  02340002
023500     END-EXEC.                                                    02350002
023600 EJECT                                                            02360002
023700******************************************************************02370002
023800 PROCEDURE DIVISION.                                              02380002
023900******************************************************************02390002
024000                                                                  02400002
024100     PERFORM 1000-INITIALIZATION.                                 02410002
024200                                                                  02420002
024300     IF FM-LAST-FISCAL-WEEK                                       02430002
024400         PERFORM 2000-PROCESS-TRANFILE                            02440002
024500             UNTIL PS-END-OF-DEPOSIT-CURSOR                       02450002
024600         PERFORM 8000-END-OF-JOB                                  02460002
024700     ELSE                                                         02470002
024800         DISPLAY 'WEEK ENDING DATE '                              02480002
024900                 FM-CONTROL-DATE                                  02490002
025000                 ' IS NOT THE LAST WEEK OF THE FISCAL MONTH'      02500002
025100         CLOSE FISCAL-MONTH-INPUT-FILE                            02510002
025200         CLOSE CASH-SALES-EXTRACT-FILE                            02520002
025300         MOVE 4090                 TO RETURN-CODE                 02530002
025400     END-IF.                                                      02540002
025500                                                                  02550002
025600     STOP RUN.                                                    02560002
025700     EJECT                                                        02570002
025800******************************************************************02580002
025900*                                                                *02590002
026000*    INITIALIZATION ROUTINE, OPEN THE EXTRACT, ACCEPT THE        *02600002
026100*    CARD FROM SYSIN, PERFORM THE ROUTINE TO FIND THE FISCAL     *02610002
026200*    PERIOD AND PERFORM THE ROUTIN TO OPEN THE CURSOR.           *02620002
026300*                                                                *02630002
026400******************************************************************02640002
026500                                                                  02650002
026600 1000-INITIALIZATION.                                             02660002
026700                                                                  02670002
026800     OPEN  INPUT  FISCAL-MONTH-INPUT-FILE.                        02680002
026900     OPEN  OUTPUT CASH-SALES-EXTRACT-FILE.                        02690002
027000                                                                  02700002
027100     READ FISCAL-MONTH-INPUT-FILE                                 02710002
027200         INTO FISCAL-MONTH-CONTROL-AREA                           02720002
027300         AT END SET PS-END-OF-FISCAL-FILE                         02730002
027400                                   TO TRUE.                       02740002
027500                                                                  02750002
027600     IF PS-END-OF-FISCAL-FILE                                     02760002
027700         MOVE '1000-INITIALIZATION'                               02770002
027800                                 TO PV-PARAGRAPH-NAME             02780002
027900         MOVE 'FISCAL MONTH CONTROL CARD IS EMPTY'                02790002
028000                                 TO PV-OPERATION-MSG-1            02800002
028100         SET AC-FILE-SEQUENCE-ERROR                               02810002
028200                                   TO TRUE                        02820002
028300         PERFORM 9999-ABEND                                       02830002
028400     END-IF.                                                      02840002
028500                                                                  02850002
028600     IF FM-LAST-FISCAL-WEEK                                       02860002
028700         SET PS-HAVE-CASH-N                                       02870002
028800             PS-HAVE-CHECKS-N      TO TRUE                        02880002
028900         PERFORM 1100-DATE-ROUTINE                                02890002
029000         PERFORM 1200-OPEN-DEPOSIT-CURSOR                         02900002
029100         PERFORM 2100-FETCH-DEPOSIT-CURSOR                        02910002
029200         MOVE SAADDP-SLS-DTE       TO PV-DB2-ISO-DATE             02920002
029300         MOVE PV-DB2-ISO-YY        TO PV-MDY-YY                   02930002
029400         MOVE PV-DB2-ISO-MM        TO PV-MDY-MM                   02940002
029500         MOVE PV-DB2-ISO-DD        TO PV-MDY-DD                   02950002
029600         MOVE PV-MDY-DATE          TO CSE-DATE                    02960002
029700         MOVE SAADDP-STR-NBR       TO CSE-STORE                   02970002
029800     END-IF.                                                      02980002
029900                                                                  02990002
030000     EJECT                                                        03000002
030100******************************************************************03010002
030200*                                                                *03020002
030300*    INITIALIZE THE CALL PARAMETERS, SET THE DATE INDICATORS,    *03030002
030400*    MOVE THE YEAR AND PERIOD TO THE INPUT AREA AND CALL THE     *03040002
030500*    ROUTINE AND CHECK FOR ERRORS.                               *03050002
030600*                                                                *03060002
030700******************************************************************03070002
030800 1100-DATE-ROUTINE.                                               03080002
030900                                                                  03090002
031000     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              03100002
031100                                                                  03110002
031200     SET  DPG51-FISCAL-454-CALENDAR    TO TRUE.                   03120002
031300     SET  DPG51-DO-NOT-INCR-DECR-DATE  TO TRUE.                   03130002
031400     SET  DPG52-LK-DTE-ISO-FMT         TO TRUE.                   03140002
031500     MOVE FM-CONTROL-DATE              TO DPG52-LK-DATE-INPUT.    03150002
031600                                                                  03160002
031700     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    03170002
031800                                             DPG54 DPG55 DPG56.   03180002
031900                                                                  03190002
032000     EVALUATE TRUE                                                03200002
032100         WHEN DPG54-SEVERE-ERROR                                  03210002
032200         WHEN DPG54-DATE-INVALID                                  03220002
032300             MOVE '1100-DATE-ROUTINE'                             03230002
032400                                           TO PV-PARAGRAPH-NAME   03240002
032500             MOVE 'ERROR CONVERTING INPUT CARD DATE'              03250002
032600                                           TO PV-OPERATION-MSG-1  03260002
032700             SET AC-CALENDAR-ROUTINE-ERROR TO TRUE                03270002
032800             MOVE DPG54-ERROR-MESSAGE      TO PV-OPERATION-MSG-2  03280002
032900             PERFORM 9999-ABEND                                   03290002
033000     END-EVALUATE.                                                03300002
033100                                                                  03310002
033200     MOVE DPG56-FIRST-FP-DB2-ISO-FMT   TO PV-START-DATE           03320002
033300     MOVE DPG56-LAST-FP-DB2-ISO-FMT    TO PV-END-DATE.            03330002
033400                                                                  03340002
033500     DISPLAY 'PV-START-DATE - ' PV-START-DATE                     03350002
033600     DISPLAY 'PV-END-DATE --- ' PV-END-DATE.                      03360002
033700                                                                  03370002
033800     EJECT                                                        03380002
033900******************************************************************03390002
034000*                                                                *03400002
034100*    OPEN THE DEPOSIT CURSOR AND CHECK FOR ERRORS.               *03410002
034200*                                                                *03420002
034300******************************************************************03430002
034400                                                                  03440002
034500 1200-OPEN-DEPOSIT-CURSOR.                                        03450002
034600                                                                  03460002
034700     EXEC SQL                                                     03470002
034800          OPEN DEPOSIT-CURSOR                                     03480002
034900     END-EXEC.                                                    03490002
035000                                                                  03500002
035100     EVALUATE TRUE                                                03510002
035200         WHEN SQLCODE = ZERO                                      03520002
035300              CONTINUE                                            03530002
035400         WHEN SQLWARN0 NOT EQUAL SPACE                            03540002
035500         WHEN SQLCODE NOT EQUAL ZERO                              03550002
035600             MOVE '1200-OPEN-DEPOSIT-CURSOR'                      03560002
035700                                 TO PV-PARAGRAPH-NAME             03570002
035800             MOVE 'ERROR ON OPEN OF DEPOSIT-CURSOR'               03580002
035900                                 TO PV-DB2-OPERATION              03590002
036000             SET AC-CURSOR-OPEN  TO TRUE                          03600002
036100             PERFORM 9800-SQL-ABEND                               03610002
036200     END-EVALUATE.                                                03620002
036300                                                                  03630002
036400     EJECT                                                        03640002
036500******************************************************************03650002
036600*                                                                *03660002
036700*    CHECK SEQUENCE, IF NON-MATCHING, WRITE THE EXTRACT          *03670002
036800*    RECORD AND INITIALIZE THE RECORD. MOVE THE AMOUNT TO        *03680002
036900*    EITHER THE CASH OR CHECK FIELD DEPENDING ON THE TYPE,       *03690002
037000*    PERFORM THE FET TO GET ANOTHER ROW FROM THE CURSOR.         *03700002
037100*                                                                *03710002
037200******************************************************************03720002
037300                                                                  03730002
037400 2000-PROCESS-TRANFILE.                                           03740002
037500                                                                  03750002
037600     MOVE SAADDP-SLS-DTE         TO PV-DB2-ISO-DATE.              03760002
037700     MOVE PV-DB2-ISO-YY          TO PV-MDY-YY                     03770002
037800     MOVE PV-DB2-ISO-MM          TO PV-MDY-MM                     03780002
037900     MOVE PV-DB2-ISO-DD          TO PV-MDY-DD                     03790002
038000                                                                  03800002
038100     IF ((CSE-DATE EQUAL PV-MDY-DATE)                             03810002
038200         AND (CSE-STORE EQUAL SAADDP-STR-NBR))                    03820002
038300         IF ((SAADDP-TNDR-TYP-CDE EQUAL PV-TNDR-TYP-CDE)          03830002
038400             OR ((CSE-CASH-DEPOSIT NOT EQUAL ZERO)                03840002
038500                 AND (CSE-CHECK-DEPOSIT NOT EQUAL ZERO)))         03850002
038600             PERFORM 9000-WRITE-EXTRACT-RECORDS                   03860002
038700             MOVE SAADDP-STR-NBR TO CSE-STORE                     03870002
038800             MOVE PV-MDY-DATE    TO CSE-DATE                      03880002
038900             MOVE SAADDP-TNDR-TYP-CDE                             03890002
039000                                 TO PV-TNDR-TYP-CDE               03900002
039100             MOVE ZERO           TO CSE-CASH-DEPOSIT              03910002
039200             MOVE ZERO           TO CSE-CHECK-DEPOSIT             03920002
039300             MOVE ZERO           TO CSE-ENDING-BALANCE            03930002
039400         ELSE                                                     03940002
039500             MOVE SAADDP-TNDR-TYP-CDE                             03950002
039600                                 TO PV-TNDR-TYP-CDE               03960002
039700         END-IF                                                   03970002
039800     ELSE                                                         03980002
039900         PERFORM 9000-WRITE-EXTRACT-RECORDS                       03990002
040000         MOVE SAADDP-STR-NBR     TO CSE-STORE                     04000002
040100         MOVE PV-MDY-DATE        TO CSE-DATE                      04010002
040200         MOVE SAADDP-TNDR-TYP-CDE                                 04020002
040300                                 TO PV-TNDR-TYP-CDE               04030002
040400         MOVE ZERO               TO CSE-CASH-DEPOSIT              04040002
040500         MOVE ZERO               TO CSE-CHECK-DEPOSIT             04050002
040600         MOVE ZERO               TO CSE-ENDING-BALANCE            04060002
040700     END-IF.                                                      04070002
040800                                                                  04080002
040900     IF SAADDP-TNDR-TYP-CDE EQUAL ZERO                            04090002
041000         MOVE SAADDP-TNDR-AMT    TO CSE-CASH-DEPOSIT              04100002
041100         SET PS-HAVE-CASH-Y      TO TRUE                          04110002
041200     ELSE                                                         04120002
041300         MOVE SAADDP-TNDR-AMT    TO CSE-CHECK-DEPOSIT             04130002
041400         SET PS-HAVE-CHECKS-Y    TO TRUE                          04140002
041500     END-IF.                                                      04150002
041600                                                                  04160002
041700     IF PS-HAVE-CASH-Y          AND                               04170002
041800        PS-HAVE-CHECKS-Y                                          04180002
041900        PERFORM 3000-SELECT-ENDING-BALANCE                        04190002
042000        IF SQLCODE                = ZERO                          04200002
042100            MOVE SAADSU-ADJ-AMT  TO CSE-ENDING-BALANCE            04210002
042200        ELSE                                                      04220002
042300            IF SQLCODE            = +100                          04230002
042400                MOVE ZERO        TO CSE-ENDING-BALANCE            04240002
042500            END-IF                                                04250002
042600        END-IF                                                    04260002
042700        SET PS-HAVE-CASH-N                                        04270002
042800            PS-HAVE-CHECKS-N     TO TRUE                          04280002
042900     END-IF.                                                      04290002
043000                                                                  04300002
043100     PERFORM 2100-FETCH-DEPOSIT-CURSOR.                           04310002
043200     EJECT                                                        04320002
043300******************************************************************04330002
043400*                                                                *04340002
043500*    FETCH THE DEPOSIT CURSOR AND CHECK FOR ERRORS.              *04350002
043600*                                                                *04360002
043700******************************************************************04370002
043800                                                                  04380002
043900 2100-FETCH-DEPOSIT-CURSOR.                                       04390002
044000                                                                  04400002
044100     EXEC SQL                                                     04410002
044200          FETCH DEPOSIT-CURSOR                                    04420002
044300           INTO :SAADDP-SLS-DTE                                   04430002
044400               ,:SAADDP-STR-NBR                                   04440002
044500               ,:SAADDP-TNDR-TYP-CDE                              04450002
044600               ,:SAADDP-STRT-TMST                                 04460002
044700               ,:SAADDP-TNDR-AMT                                  04470002
044800     END-EXEC.                                                    04480002
044900                                                                  04490002
045000     EVALUATE TRUE                                                04500002
045100         WHEN SQLCODE = ZERO                                      04510002
045200             ADD 1                    TO PV-DEPOSIT-CURSOR-COUNT  04520002
045300         WHEN SQLCODE = PC-ROW-NOT-FOUND                          04530002
045400             SET PS-END-OF-DEPOSIT-CURSOR TO TRUE                 04540002
045500         WHEN SQLWARN0 NOT EQUAL SPACE                            04550002
045600         WHEN SQLCODE NOT EQUAL ZERO                              04560002
045700             MOVE '2100-FETCH-DEPOSIT-CURSOR'                     04570002
045800                                      TO PV-PARAGRAPH-NAME        04580002
045900             MOVE SQLCODE             TO PV-DB2-OPERATION         04590002
046000             MOVE SAADDP-SLS-DTE      TO PV-DB2-SLS-DTE           04600002
046100             MOVE SAADDP-STR-NBR      TO PV-DB2-STR-NBR           04610002
046200             MOVE SAADDP-TNDR-TYP-CDE TO PV-DB2-CTG-CDE           04620002
046300             SET AC-CURSOR-FETCH      TO TRUE                     04630002
046400             PERFORM 9800-SQL-ABEND                               04640002
046500     END-EVALUATE.                                                04650002
046600 EJECT                                                            04660002
046700                                                                  04670002
046800******************************************************************04680002
046900* 3000-SELECT-ENDING-BALANCE                                     *04690002
047000*  SELECT THE ENDING BALANCE AMOUNT FROM TSAADSU AFTER BOTH THE  *04700002
047100*  CHECK AND CASH DEPOSIT HAVE BEEN OBTAINED.                    *04710002
047200******************************************************************04720002
047300                                                                  04730002
047400 3000-SELECT-ENDING-BALANCE.                                      04740002
047500                                                                  04750002
047600     EXEC SQL                                                     04760002
047700         SELECT  DSU.ADJ_AMT                                      04770002
047800           INTO :SAADSU-ADJ-AMT                                   04780002
047900           FROM  TSAADSU DSU                                      04790002
048000          WHERE  DSU.SLS_DTE        = :SAADDP-SLS-DTE             04800002
048100           AND   DSU.STR_NBR        = :SAADDP-STR-NBR             04810002
048200           AND   DSU.SUM_CTG_CDE    = 'EB'                        04820002
048300     END-EXEC.                                                    04830002
048400                                                                  04840002
048500     EVALUATE TRUE                                                04850002
048600         WHEN SQLCODE = ZERO                                      04860002
048700         WHEN SQLCODE = +100                                      04870002
048800             CONTINUE                                             04880002
048900         WHEN SQLWARN0 NOT EQUAL SPACE                            04890002
049000         WHEN SQLCODE NOT EQUAL ZERO                              04900002
049100             MOVE '3000-SELECT-ENDING-BALANCE'                    04910002
049200                                     TO PV-PARAGRAPH-NAME         04920002
049300             MOVE SQLCODE            TO PV-DB2-OPERATION          04930002
049400             MOVE SAADSU-SLS-DTE     TO PV-DB2-SLS-DTE            04940002
049500             MOVE SAADSU-STR-NBR     TO PV-DB2-STR-NBR            04950002
049600             MOVE SAADSU-SUM-CTG-CDE TO PV-DB2-CTG-CDE            04960002
049700             PERFORM 9800-SQL-ABEND                               04970002
049800     END-EVALUATE.                                                04980002
049900                                                                  04990002
050000                                                                  05000002
050100*3000-EXIT.                                                       05010002
050200******************************************************************05020002
050300 8000-END-OF-JOB.                                                 05030002
050400                                                                  05040002
050500     IF PV-DEPOSIT-CURSOR-COUNT GREATER THAN ZERO                 05050002
050600         PERFORM 9000-WRITE-EXTRACT-RECORDS                       05060002
050700     END-IF                                                       05070002
050800                                                                  05080002
050900     CLOSE FISCAL-MONTH-INPUT-FILE.                               05090002
051000     CLOSE CASH-SALES-EXTRACT-FILE.                               05100002
051100                                                                  05110002
051200     PERFORM 8100-CLOSE-DEPOSIT-CURSOR.                           05120002
051300                                                                  05130002
051400     DISPLAY '****************************************'           05140002
051500     DISPLAY '*************** SAKUT004 ***************'           05150002
051600     DISPLAY '****************************************'           05160002
051700     MOVE PV-DEPOSIT-CURSOR-COUNT                                 05170002
051800                                 TO PV-EDIT-MASK                  05180002
051900     INSPECT PV-EDIT-MASK REPLACING LEADING SPACE BY '.'          05190002
052000     DISPLAY 'DEPOSIT ROWS FETCHED...........'                    05200002
052100         PV-EDIT-MASK                                             05210002
052200     MOVE PV-RECORDS-WRITTEN     TO PV-EDIT-MASK                  05220002
052300     INSPECT PV-EDIT-MASK REPLACING LEADING SPACE BY '.'          05230002
052400     DISPLAY 'EXTRACT RECORDS WRITTEN........'                    05240002
052500         PV-EDIT-MASK                                             05250002
052600     DISPLAY '****************************************'           05260002
052700     DISPLAY '****************************************'           05270002
052800     DISPLAY '****************************************'.          05280002
052900                                                                  05290002
053000     MOVE ZERO                     TO RETURN-CODE.                05300002
053100     EJECT                                                        05310002
053200******************************************************************05320002
053300*                                                                *05330002
053400*    CLOSE THE DEPOSIT CURSOR AND CHECK FOR ERRORS.              *05340002
053500*                                                                *05350002
053600******************************************************************05360002
053700                                                                  05370002
053800 8100-CLOSE-DEPOSIT-CURSOR.                                       05380002
053900                                                                  05390002
054000     EXEC SQL                                                     05400002
054100          CLOSE DEPOSIT-CURSOR                                    05410002
054200     END-EXEC.                                                    05420002
054300                                                                  05430002
054400     EVALUATE TRUE                                                05440002
054500         WHEN SQLCODE = ZERO                                      05450002
054600              CONTINUE                                            05460002
054700         WHEN SQLWARN0 NOT EQUAL SPACE                            05470002
054800         WHEN SQLCODE NOT EQUAL ZERO                              05480002
054900             MOVE '8100-CLOSE-DEPOSIT-CURSOR'                     05490002
055000                                 TO PV-PARAGRAPH-NAME             05500002
055100             MOVE 'ERROR ON CLOSE OF DEPOSIT-CURSOR'              05510002
055200                                 TO PV-DB2-OPERATION              05520002
055300             SET AC-CURSOR-CLOSE TO TRUE                          05530002
055400             PERFORM 9800-SQL-ABEND                               05540002
055500     END-EVALUATE.                                                05550002
055600 EJECT                                                            05560002
055700***************************************************************** 05570002
055800* THIS MODULE WRITES THE OUTPUT FILE RECORD.                      05580002
055900***************************************************************** 05590002
056000                                                                  05600002
056100 9000-WRITE-EXTRACT-RECORDS.                                      05610002
056200                                                                  05620002
056300     WRITE CASH-SALES-EXTRACT-RECORD                              05630002
056400         FROM CSE-CASH-SALES-EXTRACT.                             05640002
056500                                                                  05650002
056600     ADD 1                       TO PV-RECORDS-WRITTEN.           05660002
056700                                                                  05670002
056800     EJECT                                                        05680002
056900******************************************************************05690002
057000* 9800-SQL-ABEND.                                                 05700002
057100*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.05710002
057200******************************************************************05720002
057300 9800-SQL-ABEND.                                                  05730002
057400     DISPLAY '** ABEND     **'.                                   05740002
057500     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        05750002
057600     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              05760002
057700     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               05770002
057800     DISPLAY '** SALES DTE ** = ' PV-DB2-SLS-DTE.                 05780002
057900     DISPLAY '** STORE     ** = ' PV-DB2-STR-NBR.                 05790002
058000     DISPLAY '** CTG CDE   ** = ' PV-DB2-CTG-CDE.                 05800002
058100                                                                  05810002
058200     COPY DPPD004.                                                05820002
058300     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         05830002
058400                                                                  05840002
058500*9800-EXIT.                                                       05850002
058600                                                                  05860002
058700******************************************************************05870002
058800* 9999-ABEND                                                      05880002
058900*     ABEND PROGRAM WHEN AN ERROR OCCURS.                         05890002
059000******************************************************************05900002
059100 9999-ABEND.                                                      05910002
059200     DISPLAY '** ABEND           **'.                             05920002
059300     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  05930002
059400     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        05940002
059500     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       05950002
059600     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       05960002
059700     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         05970002
