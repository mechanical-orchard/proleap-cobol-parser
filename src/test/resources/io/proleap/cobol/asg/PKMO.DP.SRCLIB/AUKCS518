000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400                                                                  00040000
000500 PROGRAM-ID.                AUKCS518.                             00050000
000600 AUTHOR.                    BARB SCHULTZ.                         00060000
000700 INSTALLATION.              KOHLS DEPARTMENT STORES.              00070000
000800 DATE-WRITTEN.              JANUARY 2008.                         00080000
000900 DATE-COMPILED.                                                   00090000
000901                                                                  00100000
000902******************************************************************00110000
000920*  CHANGE LOG                                                     00120000
000921******************************************************************00130000
000940* DATE     INITIALS  DESCRIPTION                                  00140000
000941* 01/09/09  TDH      CHANGE LENGTH OF PV-REF-RGST-ID TO X(02) AND 00150000
000942*                    ADD PV-REF-LINE-NBR TO MAKE REFERENCE NUMBER 00160000
000944*                    UNIQUE WHEN MULTIPLE CARDS ARE PURCHASED IN  00170000
000945*                    ONE POS TRANSACTION.  CHANGES MARKED TDH001. 00180000
000946* 07/09/10  TDH      CHANGED IP ADDRESS OF AUTHORIZATION SERVERS. 00190000
000949*                    CHANGES MARKED TDH002.                       00200000
000950* 08/22/11  SAK      CHANGED IP ADDRESS OF BACKUP AJB SERVER TO   00210000
000951*                    KSTRNT225 IN GERMANTOWN.                     00220000
000952* 11/25/13  SJK      CHANGED IP ADDRESS OF BOTH AJB SERVERs FOR   00230000
000953*                    THE AJB UPGRADE PROJECT.                     00240000
000954*                    CHANGE THE SIZING OF THE OUTGOING MESSAGE    00250000
000955*                      THIS WILL FIX THE SAF MATCHING ERROR       00260000
LOAD  * 10/28/19  BJS      CHANGED IP ADDRESS OF BOTH AJB SERVERs FOR   00261000
LOAD  *                    THE LOAD BALANCING PROJECT. REMOVED THE      00262000
LOAD  *                    BACKUP IP ADDRESS SINCE IT IS NOT USED.      00262100
LOAD  *                    WE ONLY HAVE 2 SERVERS, PRIMARY AND SECONDARY00262200
LOAD  *                                                                 00262300
001100******************************************************************00262400
001200* AUTH TO AJB VIA TCP/IP SOCKET CALL                              00262500
001300******************************************************************00262600
001400                                                                  00262700
001500 ENVIRONMENT DIVISION.                                            00262800
001600 DATA DIVISION.                                                   00262900
001700 WORKING-STORAGE SECTION.                                         00263000
001800*                                                                 00264000
001900*  SOCKET COMMANDS CODES NEED FOR THE TCP/IP SOCKET CALLS         00265000
002000     COPY DPWS081.                                                00266000
002100*                                                                 00267000
002200*  LAYOUT FOR THE ABEND MODULE COMMUNICATIONS AREA.               00268000
002300     COPY DPWS013.                                                00269000
002400                                                                  00270000
002500*  LAYOUT FOR THE ABEND MODULE COMMUNICATIONS AREA.               00280000
002600     COPY DPWS020.                                                00290000
002700                                                                  00300000
002800     COPY EPWS000.                                                00310000
002900*                                                                 00320000
003000*    MQ Series API control blocks                                 00330000
003100*                                                                 00340000
003200 01  MQM-OBJECT-DESCRIPTOR.                                       00350000
003300     COPY CMQODV.                                                 00360000
003400                                                                  00370000
003500 01  MQM-MESSAGE-DESCRIPTOR.                                      00380000
003600     COPY CMQMDV.                                                 00390000
003700                                                                  00400000
003800 01  MQM-GET-MESSAGE-OPTIONS.                                     00410000
003900     COPY CMQGMOV.                                                00420000
004000                                                                  00430000
004100 01  MQM-PUT-MESSAGE-OPTIONS.                                     00440000
004200     COPY CMQPMOV.                                                00450000
004300*                                                                 00460000
004400*    MQV contains constants (for filling in the control blocks)   00470000
004500*    and return codes (for testing the result of a call)          00480000
004600*                                                                 00490000
004700 01  MQM-CONSTANTS.                                               00500000
004800     COPY CMQV.                                                   00510000
004900                                                                  00520000
005300*  LAYOUT FOR QUEUE                                               00530000
005400     COPY SAWS051.                                                00540000
005500                                                                  00550000
005600*  LAYOUT FOR THE 100 REQUEST MESSAGE.                            00560000
005700     COPY AURD014.                                                00570000
005800                                                                  00580000
005900*  LAYOUT FOR THE 101 RESPONSE MESSAGE.                           00590000
006000     COPY AURD015.                                                00600000
006100                                                                  00610000
006200* NETCOOL MESSAGE COPYBOOK.                                       00620000
006300     COPY ISWS003.                                                00630000
006400                                                                  00640000
006500*-----------------------------------------------------------------00650000
006600                                                                  00660000
006700 01  TCP-BUF.                                                     00670000
006800     05 TCP-LEN                 PIC 9(04)  VALUE ZEROES.          00680000
006900     05 TCP-MSG                 PIC X(200) VALUE SPACES.          00690000
007000 01  TCP-LEN-BYTES              PIC 9(04)  VALUE ZEROES.          00700000
007100                                                                  00710000
007200 01  TCP-MSG-HOLD               PIC X(200) VALUE SPACES.          00720000
007300                                                                  00730000
008100 01  PC-PROGRAM-CONSTANTS.                                        00740000
008200     05  PC-NULL-INDICATOR       PIC S9(4)    VALUE -1            00750000
008300                                 COMP SYNC.                       00760000
008400     05  PC-COMMUNICATIONS-IN-LENGTH                              00770000
008500                                 PIC S9(4)    VALUE +400          00780000
008600                                 COMP SYNC.                       00790000
008700     05  PC-CURRENT-PROGRAM-NAME PIC  X(08) VALUE                 00800000
008800         'AUKCS518'.                                              00810000
008900*    05  PC-PORT-NBR-DEC        PIC 9(5) COMP VALUE 27000.        00820000
009000     05  PC-PORT-NBR-DEC        PIC 9(5) COMP VALUE 29000.        00830000
009100     05  PC-PORT-NBR-HEX        PIC X(2)    VALUE X'7148'.        00840000
009200*    05  PC-PORT-NBR-HEX        PIC X(2)    VALUE X'6978'.        00850000
009300     05  PC-PORT-NBR REDEFINES PC-PORT-NBR-HEX                    00860000
009400                                PIC 9(4) COMP.                    00870000
009500     05  PC-AUTH-INQ-MESSAGE-LENGTH PIC X(100) VALUE SPACES.      00880000
009600     05  PC-ONE                 PIC S9(1)  VALUE  +1.             00890000
009700*                   MQ SERIES CONSTANTS                           00900000
009800     05  PC-MQCMIT               PIC X(8)    VALUE 'CSQCCOMM'.    00910000
009810     05  PC-MQCONN               PIC X(8)    VALUE 'CSQCCONN'.    00920000
009900     05  PC-MQOPEN               PIC X(8)    VALUE 'CSQCOPEN'.    00930000
010000     05  PC-MQGET                PIC X(8)    VALUE 'CSQCGET'.     00940000
010100     05  PC-MQPUT                PIC X(8)    VALUE 'CSQCPUT'.     00950000
010110     05  PC-MQPUT1               PIC X(8)    VALUE 'CSQCPUT1'.    00960000
010200     05  PC-MQCLOSE              PIC X(8)    VALUE 'CSQCCLOS'.    00970000
010300     05  PC-MQDISC               PIC X(8)    VALUE 'CSQCDISC'.    00980000
010400     05  PC-QM-NAME              PIC X(4)    VALUE SPACES.        00990000
010500         88  PC-PROD-QMGR-NAME               VALUE 'QKSP'.        01000000
010600         88  PC-TEST-QMGR-NAME               VALUE 'QKST'.        01010000
010700         88  PC-QA-QMGR-NAME                 VALUE 'QKSQ'.        01020000
010800                                                                  01030000
010900*-----------TEST IP ADDRESS KSTRNT18----------------------------- 01040000
011000*TDH002 - START                                                   01050000
011001*    05  PC-IP-ADDR-18          PIC X(15) VALUE '010.001.199.136'.01060000
011010*    05  PC-IP-ADDR-18          PIC X(15) VALUE '010.001.080.001'.01070000
011100*-----------PRODUCTION IP ADDRESS KSTRNT19----------------------- 01080000
011200*    05  PC-IP-ADDR-19          PIC X(15) VALUE '010.001.011.146'.01090000
011210*    05  PC-IP-ADDR-19          PIC X(15) VALUE '010.001.224.001'.01100000
011300*-----------PRODUCTION IP ADDRESS KSTRNT20----------------------- 01110000
011400*    05  PC-IP-ADDR-20          PIC X(15) VALUE '010.001.011.147'.01120000
011410*    05  PC-IP-ADDR-20          PIC X(15) VALUE '010.001.224.002'.01130000
011420*TDH002 - END                                                     01140000
011430*-----------PRODUCTION IP ADDRESS KSTRNT225---------------------- 01150000
011440*    05  PC-IP-ADDR-225         PIC X(15) VALUE '010.007.226.001'.01160000
011500*---------------------------------------------------------------- 01170000
LOAD                                                                    01180000
LOAD  *****OLD IP ADDRESSES AS OF 10/29/19*****                         01190000
LOAD                                                                    01200000
LOAD  *----TEST MF IP ADDRESS TSST0101 -OLD---------------------------- 01210000
LOAD  *    05  PC-IP-ADDR-TEST        PIC X(15) VALUE '010.001.080.009'.01220000
LOAD  *----PRIMARY PROD MF IP ADDRESS KSST0100 -OLD-------------------- 01230000
LOAD  *    05  PC-IP-ADDR-PROD-PM     PIC X(15) VALUE '010.001.224.015'.01240000
LOAD  *----SECONDARY PROD MF IP ADDRESS KSST0101 -OLD-------------------01250000
LOAD  *    05  PC-IP-ADDR-PROD-SC     PIC X(15) VALUE '010.001.224.010'.01260000
LOAD  *----BACKUP PROD GT IP ADDRESS K2ST0100 --OLD-------------------- 01270000
LOAD  *    05  PC-IP-ADDR-PROD-BK     PIC X(15) VALUE '010.007.226.008'.01280000
LOAD                                                                    01290000
LOAD  *****NEW IP ADDRESSES AS OF 10/29/19*****                         01300000
LOAD                                                                    01310000
LOAD  *----TEST MF PRIMARY IP ADDRESS bhm-gc-mf-tst-kohls.com --------- 01320000
LOAD       05  PC-IP-ADDR-TEST        PIC X(15) VALUE '010.001.070.194'.01330000
LOAD  *----TEST MF SECONDARY IP ADDRESS bhm-gc-gt-tst-kohls.com ------- 01340000
LOAD       05  PC-IP-ADDR-TEST-SC     PIC X(15) VALUE '010.008.029.059'.01350000
LOAD  *----PRIMARY PROD MF IP ADDRESS BHM-GC-MF ------------------------01360000
LOAD       05 PC-IP-ADDR-PROD-PM      PIC X(15) VALUE '010.001.027.069'.01370000
LOAD  *----SECONDARY PROD MF IP ADDRESS BHM-GC-GT ----------------------01380000
LOAD       05 PC-IP-ADDR-PROD-SC      PIC X(15) VALUE '010.007.027.069'.01381000
011500                                                                  01382000
011700 01  PS-PROGRAM-SWITCHES.                                         01383000
011800     05  PS-SOCKET-ERROR-SW     PIC X(01)  VALUE 'N'.             01384000
011900         88  PS-SOCKET-ERROR-NO            VALUE 'N'.             01385000
012000         88  PS-SOCKET-ERROR               VALUE 'Y'.             01386000
012100     05  PS-CONNECT-SW          PIC  X(01) VALUE 'N'.             01387000
012200         88  PS-CONNECT                    VALUE 'Y'.             01388000
012300         88  PS-NO-CONNECT                 VALUE 'N'.             01389000
012400     05  PS-PROCESS-SW          PIC  X(01) VALUE SPACE.           01390000
012500         88  PS-END-PROCESS                VALUE 'Y'.             01400000
012600         88  PS-CONTINUE-PROCESS           VALUE 'N'.             01410000
012700     05  PS-SEND-AUTH-SW        PIC  X(01) VALUE SPACE.           01420000
012800         88  PS-SEND-AUTH                  VALUE 'Y'.             01430000
012900         88  PS-DO-NOT-SEND-AUTH           VALUE 'N'.             01440000
013000     05  PS-RSPN-SW             PIC  X(01) VALUE 'Y'.             01450000
013100         88  PS-VALID-RSPN                 VALUE 'Y'.             01460000
013200         88  PS-INVALID-RSPN               VALUE 'N'.             01470000
013300     05  PS-CONTINUE-SW         PIC  X(01) VALUE SPACE.           01480000
013400         88  PS-CONTINUE                   VALUE 'Y'.             01490000
013500         88  PS-DO-NOT-CONTINUE            VALUE 'N'.             01500000
013600     05  PS-BACKUP-SERVER-SW    PIC  X(01) VALUE 'N'.             01510000
013700         88  PS-BACKUP                     VALUE 'Y'.             01520000
013800         88  PS-PRIMARY                    VALUE 'N'.             01530000
014300                                                                  01540000
014400 01  PV-PROGRAM-VARIABLES.                                        01550000
014500     05  PV-AMT                         PIC 9(7)V99  VALUE ZEROES.01560000
014600     05  PV-AMT-X REDEFINES PV-AMT      PIC X(9).                 01570000
014700     05  PV-SEPARATE-CARD.                                        01580000
014800         10  PV-UPC-NBR       PIC X(11)       VALUE SPACES.       01590000
014900         10  PV-CRD-NBR       PIC X(19)       VALUE SPACES.       01600000
015000     05  PV-IP-ADDRESS.                                           01610000
015100         10  PV-IP-ADDR-NUM1    PIC 9(03).                        01620000
015200             88  PV-IP-ADDR-NUM1-VALID     VALUE 1 THRU 255.      01630000
015300         10  PV-IP-ADDR-DOT1    PIC X(01).                        01640000
015400             88  PV-IP-ADDR-DOT1-VALID     VALUE '.'.             01650000
015500         10  PV-IP-ADDR-NUM2    PIC 9(03).                        01660000
015600             88  PV-IP-ADDR-NUM2-VALID     VALUE 1 THRU 255.      01670000
015700         10  PV-IP-ADDR-DOT2             PIC X(01).               01680000
015800             88  PV-IP-ADDR-DOT2-VALID     VALUE '.'.             01690000
015900         10  PV-IP-ADDR-NUM3             PIC 9(03).               01700000
016000             88  PV-IP-ADDR-NUM3-VALID     VALUE 1 THRU 255.      01710000
016100         10  PV-IP-ADDR-DOT3             PIC X(01).               01720000
016200             88  PV-IP-ADDR-DOT3-VALID     VALUE '.'.             01730000
016300         10  PV-IP-ADDR-NUM4             PIC 9(03).               01740000
016400             88  PV-IP-ADDR-NUM4-VALID     VALUE 1 THRU 255.      01750000
016500                                                                  01760000
016600     05  PV-HEX-FIELD.                                            01770000
016700         10  PV-HEX-FIELD-1              PIC X(01).               01780000
016800         10  PV-HEX-FIELD-2              PIC X(01).               01790000
016900         10  PV-HEX-FIELD-3              PIC X(01).               01800000
017000         10  PV-HEX-FIELD-4              PIC X(01).               01810000
017100     05  PV-HEX-FIELD-NUMBER REDEFINES PV-HEX-FIELD               01820000
017200                                         PIC 9(08)  COMP.         01830000
017300     05  PV-HEX-NUMERIC                  PIC 9(04) BINARY.        01840000
017400     05  PV-HEX-CHAR REDEFINES PV-HEX-NUMERIC.                    01850000
017500         10  PV-HEX-CHAR-1               PIC X(01).               01860000
017600         10  PV-HEX-CHAR-2               PIC X(01).               01870000
017700     05  PV-ERROR-MESSAGE-1      PIC X(77)    VALUE SPACES.       01880000
017800     05  PV-ERROR-MESSAGE-2      PIC X(77)    VALUE SPACES.       01890000
017900     05  PV-ERROR-MESSAGE-3      PIC X(77)    VALUE SPACES.       01900000
018000     05  PV-ERROR-MESSAGE-4      PIC X(77)    VALUE SPACES.       01910000
018100     05  PV-CICS-MSG-AREA               PIC X(100) VALUE SPACES.  01920000
018200                                                                  01930000
018300     05  PV-CICS-RESPONSE-DISP   PIC ZZZZZ9999-.                  01940000
018400     05  PV-CICS-RESPONSE        PIC S9(09) VALUE ZEROS           01950000
018500                                              COMP SYNC.          01960000
018600*                     MQ SERIES VARIABLES.                        01970000
018700     05  PV-GET-MESSAGE-BUFFER      PIC X(82)        VALUE SPACES.01980000
018710     05  PV-MSGBUFFER               PIC X(100000)    VALUE SPACES.01990000
018800     05  PV-QMGR-NAME           PIC X(48)    VALUE                02000000
018810              'EP.THIRDPARTYCARD.AUTH.Q                        '. 02010000
018900     05  PV-GET-DATA-LENGTH         PIC S9(9) BINARY VALUE 0.     02020000
019000     05  PV-PUT-MESSAGE-BUFFER      PIC X(82) VALUE SPACES.       02030000
019100     05  PV-PUT-MSG-BUFFER-LENGTH   PIC S9(9) BINARY VALUE 82.    02040000
019200     05  PV-CONNECT-HANDLE          PIC S9(9) BINARY VALUE 0.     02050000
019300     05  PV-PQ-HANDLE               PIC S9(9) BINARY VALUE 0.     02060000
019400     05  PV-OPEN-OPTIONS            PIC S9(9) BINARY VALUE 0.     02070000
019500     05  PV-COMPLETION-CODE         PIC S9(9) BINARY VALUE 0.     02080000
019600     05  PV-REASON                  PIC S9(9) BINARY VALUE 0.     02090000
019700     05  PV-CONNECT-REASON          PIC S9(9) BINARY VALUE 0.     02100000
019800     05  PV-DISPLAY-REASON          PIC S9(9)        VALUE 0.     02110000
019900     05  PV-DISPLAY-COMP-CODE       PIC S9(9)        VALUE 0.     02120000
020000     05  PV-REF-NBR.                                              02130000
020100         10  PV-REF-STR-NBR      PIC X(04)    VALUE SPACES.       02140000
020200*TDH001  10  PV-REF-RGST-ID      PIC X(04)    VALUE SPACES.       02150000
020210         10  PV-REF-RGST-ID      PIC X(02)    VALUE SPACES.       02160000
020300         10  PV-REF-TRN-NBR      PIC X(04)    VALUE SPACES.       02170000
020301*TDH001                                                           02180000
020310         10  PV-REF-LINE-NBR     PIC X(02)    VALUE SPACES.       02190000
020400                                                                  02200000
020500     05  PV-LOG-MSG-AREA                PIC X(80)  VALUE SPACES.  02210000
020600     05  PV-RECEIVE-BUF                 PIC X(500) VALUE SPACES.  02220000
020700     05  PV-TCK-STR-NBR                 PIC X(04)  VALUE SPACES.  02230000
020800     05  PV-CRE-TMST                    PIC X(26)  VALUE SPACES.  02240000
020900     05  PV-CUST-CHRGD-AMT              PIC 9(07)  VALUE ZEROES.  02250000
021000     05  PV-AUTH-INQ-MESSAGE-AREA.                                02260000
021100         10  PV-AI-MQ-MESSAGE-DESCRIPTOR                          02270000
021200                                    PIC X(324)       VALUE SPACES.02280000
021300         10  PV-AI-AUTH-REQUEST-MESSAGE                           02290000
021400                                    PIC X(74)        VALUE SPACES.02300000
021500     05  PV-MESSAGE-AREA.                                         02310000
021600         10  PV-HD-SLS-DTE           PIC  X(10)      VALUE SPACES.02320000
021700         10  PV-HD-STR-NBR           PIC  9(04)      VALUE ZEROES.02330000
021800         10  PV-HD-RGST-ID           PIC  9(04)      VALUE ZEROES.02340000
021900         10  PV-HD-TRN-NBR           PIC  9(04)      VALUE ZEROES.02350000
022000         10  PV-HD-STRT-TM           PIC  X(08)      VALUE SPACES.02360000
022100         10  PV-HD-LNE-ITM-SEQ-NBR   PIC  9(04)      VALUE ZEROES.02370000
022200         10  PV-HD-CARD-NBR          PIC  X(30)      VALUE SPACES.02380000
022300         10  PV-HD-CUST-CHRGD-AMT    PIC  9(07)V99   VALUE ZEROES.02390000
022400         10  PV-HD-SAF-CDE           PIC  X(01)      VALUE SPACES.02400000
022500******************************************************************02410000
022600* RECORD FOR PUT TO BLACK HAWK                                    02420000
022700******************************************************************02430000
022800 01  PV-BLKHAWK-FEED               PIC  X(1200000).               02440000
022900                                                                  02450000
023000 01  PV-BLKHAWK-INFO          REDEFINES PV-BLKHAWK-FEED.          02460000
023100     05  PV-BLKHAWK-DATA           PIC X(82).                     02470000
023200     05  FILLER                    PIC X(1199918).                02480000
023300                                                                  02490000
023400 01  PV-BLKHAWK-RECORD REDEFINES PV-BLKHAWK-FEED.                 02500000
023500     05  PV-BLKHAWK-TBL OCCURS 1200000 TIMES.                     02510000
023600         10  PV-BLKHAWK-REC PIC X(01).                            02520000
023700                                                                  02530000
023800 01  SUBSCRIPTS.                                                  02540000
023900     05  BLKHAWK-SUB               PIC S9(09)  COMP.              02550000
025500     05  PV-LEN-COUNT                   PIC 9(4)  VALUE ZEROES.   02560000
025600     05  PV-LENGTH                      PIC 9(4)  VALUE ZEROES.   02570000
025700     05  PV-ABSTIME                     PIC S9(18) VALUE ZERO     02580000
025800                                                     COMP SYNC.   02590000
025900                                                                  02600000
026000     05  PV-CURRENT-DATE                PIC 9(6)  VALUE ZERO.     02610000
026100     05  FILLER REDEFINES PV-CURRENT-DATE.                        02620000
026200         10  PV-CURRENT-YEAR            PIC 9(2).                 02630000
026300         10  PV-CURRENT-MONTH           PIC 9(2).                 02640000
026400         10  PV-CURRENT-DAY             PIC 9(2).                 02650000
026500     05  PV-CURRENT-TIME                PIC 9(6)  VALUE ZERO.     02660000
026600                                                                  02670000
026700     05  PV-VENDOR-COUNT         PIC S9(4) COMP VALUE ZERO.       02680000
027200     05  PV-RESP-OPTIONS.                                         02690000
027300         10  PV-RESP-FILLER      PIC X(17).                       02700000
027400         10  PV-RESP-VENDOR      PIC X(04).                       02710000
027500     05  PV-SEP-DATE.                                             02720000
027600         10  PV-CC-SEP           PIC X(02).                       02730000
027700         10  PV-YY-SEP           PIC X(02).                       02740000
027800         10  FILLER              PIC X(01).                       02750000
027900         10  PV-MM-SEP           PIC X(02).                       02760000
028000         10  FILLER              PIC X(01).                       02770000
028100         10  PV-DD-SEP           PIC X(02).                       02780000
028200     05  PV-SEP-DTE.                                              02790000
028300         10  PV-SEP-MM           PIC X(02).                       02800000
028400         10  PV-SEP-DD           PIC X(02).                       02810000
028500     05  PV-SEP-TIME.                                             02820000
028600         10  PV-HH-TM            PIC X(02).                       02830000
028700         10  FILLER              PIC X(01).                       02840000
028800         10  PV-MM-TM            PIC X(02).                       02850000
028900         10  FILLER              PIC X(01).                       02860000
029000         10  PV-SS-TM            PIC X(02).                       02870000
029100     05  PV-SEP-TM.                                               02880000
029200         10  PV-SEP-HH           PIC X(02).                       02890000
029300         10  PV-SEP-MIN          PIC X(02).                       02900000
029400         10  PV-SEP-SS           PIC X(02).                       02910000
029500                                                                  02920000
029600 01  PV-SYSTEM-ID.                                                02930000
029700     05  PV-CICS-REGION          PIC  X(05)   VALUE SPACE.        02940000
029800     05  FILLER                  PIC  X(03)   VALUE SPACE.        02950000
030400                                                                  02960000
030500 01  SELECT-PARMS.                                                02970000
030600     05  SELECT-NUMFDS          PIC 9(8) COMP VALUE 2.            02980000
030700     05  SELECT-TIMEOUT.                                          02990000
030800         10  SELECT-SECS        PIC 9(8) COMP VALUE 05.           03000000
030900         10  SELECT-MILLSECS    PIC 9(8) COMP VALUE 0.            03010000
031000     05  SELECT-RD-MASK         PIC X(16).                        03020000
031100     05  SELECT-WR-MASK         PIC X(16).                        03030000
031200     05  SELECT-EX-MASK         PIC X(16).                        03040000
031300     05  SELECT-RR-MASK         PIC X(16).                        03050000
031400     05  SELECT-RW-MASK         PIC X(16).                        03060000
031500     05  SELECT-RE-MASK         PIC X(16).                        03070000
031600                                                                  03080000
031700 01  CHAR-MASK.                                                   03090000
031800     05 CHAR-STRING             PIC  X(100).                      03100000
031900                                                                  03110000
032000 01  CHAR-ARRAY REDEFINES CHAR-MASK.                              03120000
032100     05  CHAR-ENTRY-TABLE OCCURS 100 TIMES.                       03130000
032200       10  CHAR-ENTRY         PIC  X.                             03140000
032300                                                                  03150000
032400 01  BIT-MASK.                                                    03160000
032500     05  BIT-ARRAY            PIC  X(16).                         03170000
032600                                                                  03180000
032700 01  BIT-FUNCTION-CODES.                                          03190000
032800     05  CTOB                 PIC  X(4) VALUE 'CTOB'.             03200000
032900     05  BTOC                 PIC  X(4) VALUE 'BTOC'.             03210000
033000                                                                  03220000
033100 01  BIT-MASK-LENGTH          PIC  9(8) COMP VALUE 100.           03230000
033200                                                                  03240000
033300 01  BITMASK-TOKEN            PIC X(16) VALUE 'TCPIPBITMASKCOBL'. 03250000
033400 01  SOCKETS                  PIC  9(8) COMP VALUE 100.           03260000
033500 01  SOCKNO                   PIC S9(8) BINARY.                   03270000
033600 01  EZRETC                   PIC S9(8) COMP.                     03280000
033700 01  PE-PROGRAM-ERROR-MESSAGES.                                   03290000
033800*                    MQ CALL ERROR MESSAGES                       03300000
033900     05  PE-MQ-ERROR-NUMBER           PIC X(02) VALUE '01'.       03310000
034000     05  PE-MQ-ERROR-MESSAGE.                                     03320000
034100         10  FILLER                   PIC X(19) VALUE             03330000
034200                                'MQ ERROR FOR CALL: '.            03340000
034300         10  PE-MQ-CALL-TYPE          PIC X(7)  VALUE SPACES.     03350000
034400             88  PE-MQ-CONNECT                  VALUE 'MQCONN '.  03360000
034500             88  PE-MQ-OPEN                     VALUE 'MQOPEN '.  03370000
034600             88  PE-MQ-GET                      VALUE 'MQGET  '.  03380000
034700             88  PE-MQ-PUT                      VALUE 'MQPUT  '.  03390000
034800             88  PE-MQ-CLOSE                    VALUE 'MQCLOSE'.  03400000
034900             88  PE-MQ-DISCONNECT               VALUE 'MQDISCN'.  03410000
035000         10  FILLER                   PIC X(02) VALUE SPACES.     03420000
035100         10  FILLER                   PIC X(11) VALUE             03430000
035200                                        'COMP CODE: '.            03440000
035300         10  PE-MQ-COMPLETION-CODE    PIC 9(04) VALUE ZEROS.      03450000
035400         10  FILLER                   PIC X(02) VALUE SPACES.     03460000
035500         10  FILLER                   PIC X(13) VALUE             03470000
035600                                      'REASON CODE: '.            03480000
035700         10  PE-MQ-REASON-CODE        PIC 9(04) VALUE ZEROS.      03490000
035800                                                                  03500000
035900*-----------------------------------------------------------------03510000
036000*   ERROR MESSAGE AREAS                                           03520000
036100*-----------------------------------------------------------------03530000
036200 01  DE-DB2-ERROR-MESSAGE.                                        03540000
036300     05  FILLER                  PIC X(11)    VALUE               03550000
036400         'SQLCODE = ('.                                           03560000
036500     05  DE-SQLCODE              PIC Z(8)9-   VALUE ZERO.         03570000
036600     05  FILLER                  PIC X(21)    VALUE               03580000
036700         ')  ROWS PROCESSED = ('.                                 03590000
036800     05  DE-ROWS-PROCESSED       PIC Z(8)9-   VALUE ZERO.         03600000
036900     05  FILLER                  PIC X(25)    VALUE ')'.          03610000
037000                                                                  03620000
037100 01  DW-DB2-WARNING-MESSAGE.                                      03630000
037200     05  FILLER                  PIC X(11)    VALUE               03640000
037300         'SQLCODE = ('.                                           03650000
037400     05  DW-SQLCODE              PIC Z(8)9-   VALUE ZERO.         03660000
037500     05  FILLER                  PIC X(21)    VALUE               03670000
037600         ')  ROWS PROCESSED = ('.                                 03680000
037700     05  DW-ROWS-PROCESSED       PIC Z(8)9-   VALUE ZERO.         03690000
037800     05  FILLER                  PIC X(14)    VALUE               03700000
037900         ')  SQLWARN = ('.                                        03710000
038000     05  DW-SQLWARN              PIC X(8)     VALUE ZERO.         03720000
038100     05  FILLER                  PIC X(3)     VALUE ')'.          03730000
038200                                                                  03740000
038300 01  DS-DB2-SQLERRMC-MESSAGE.                                     03750000
038400     05  FILLER                  PIC X(11)    VALUE               03760000
038500         'SQLERRMC = '.                                           03770000
038600     05  DS-SQLERRMC             PIC X(66)    VALUE SPACES.       03780000
038700                                                                  03790000
038800 01  AA-ATTEMPTED-ACTION-MESSAGE.                                 03800000
038900     05  FILLER                  PIC X(14)    VALUE               03810000
039000         'ATTEMPTING TO '.                                        03820000
039100     05  AA-ATTEMPTED-ACTION     PIC X(90)    VALUE SPACES.       03830000
039200                                                                  03840000
039300 01  AC-ATTEMPTED-ACTION-MESSAGE.                                 03850000
039400     05  FILLER                  PIC X(14)    VALUE               03860000
039500         'ATTEMPTING TO '.                                        03870000
039600     05  AC-ATTEMPTED-ACTION     PIC X(90)    VALUE SPACES.       03880000
039700                                                                  03890000
039800*-----------------------------------------------------------------03900000
039900*  INCLUDE FOR GCT_VND_AUTH     TABLE                             03910000
040000*-----------------------------------------------------------------03920000
040100     EXEC SQL                                                     03930000
040200        INCLUDE GCT00004                                          03940000
040300     END-EXEC.                                                    03950000
040400                                                                  03960000
040500*-----------------------------------------------------------------03970000
040600*  INCLUDE FOR SQLCA                                              03980000
040700*-----------------------------------------------------------------03990000
040800     EXEC SQL                                                     04000000
040900       INCLUDE SQLCA                                              04010000
041000     END-EXEC.                                                    04020000
041100                                                                  04030000
041200******************************************************************04040000
041300 LINKAGE SECTION.                                                 04050000
041400******************************************************************04060000
041500*01  DFHCOMMAREA                      PIC X(200).                 04070000
041600                                                                  04080000
041700******************************************************************04090000
041800 PROCEDURE DIVISION.                                              04100000
041900******************************************************************04110000
042000 0000-PROGRAM-MAINLINE.                                           04120000
042100                                                                  04130000
042200     PERFORM 1000-INITIALIZE.                                     04140000
042300                                                                  04150000
042400     PERFORM 2000-PROCESS                                         04160000
042500        UNTIL PS-END-PROCESS OR PS-SOCKET-ERROR.                  04170000
042600                                                                  04180000
042900     EXEC CICS                                                    04190000
043000        RETURN                                                    04200000
043100     END-EXEC.                                                    04210000
043200                                                                  04220000
043300     GOBACK.                                                      04230000
043400                                                                  04240000
043500*---------------------------------------------------------------- 04250000
043600*  INITIALIZE                                                     04260000
043700*---------------------------------------------------------------- 04270000
043800 1000-INITIALIZE.                                                 04280000
043900                                                                  04290000
044200     PERFORM EP000-0000-INITIALIZE.                               04300000
044300                                                                  04310000
044400     IF EP000-PV-KOHLS-PROD-SYSTEM                                04320000
044500         SET PC-PROD-QMGR-NAME  TO  TRUE                          04330000
044600     ELSE                                                         04340000
044700        IF EP000-PV-KOHLS-QA-SYSTEM                               04350000
044800            SET PC-QA-QMGR-NAME  TO  TRUE                         04360000
044900        ELSE                                                      04370000
045000            SET PC-TEST-QMGR-NAME  TO  TRUE                       04380000
045100        END-IF                                                    04390000
045200     END-IF.                                                      04400000
045300                                                                  04410000
045400     PERFORM 7000-RETRIEVE-AUTH-REQUEST.                          04420000
045500                                                                  04430000
045600     SET PS-SOCKET-ERROR-NO TO TRUE.                              04440000
045700                                                                  04450000
045800     EXEC CICS                                                    04460000
045900         ASSIGN APPLID (PV-SYSTEM-ID)                             04470000
046000     END-EXEC.                                                    04480000
046100                                                                  04490000
046200     EXEC CICS ASKTIME                                            04500000
046300               ABSTIME(PV-ABSTIME)                                04510000
046400     END-EXEC.                                                    04520000
046500                                                                  04530000
046600     EXEC CICS FORMATTIME                                         04540000
046700               ABSTIME(PV-ABSTIME)                                04550000
046800               YYMMDD (PV-CURRENT-DATE)                           04560000
046900               TIME   (PV-CURRENT-TIME)                           04570000
047000     END-EXEC.                                                    04580000
047100                                                                  04590000
047200     SET PS-SEND-AUTH  TO TRUE.                                   04600000
047300                                                                  04610000
047400     PERFORM 1100-FORMAT-IP-ADDR.                                 04620000
047500                                                                  04630000
047600                                                                  04640000
047700*---------------------------------------------------------------- 04650000
047800*  FORMAT IP ADDRESS TO GET TO AJB                                04660000
047900*---------------------------------------------------------------- 04670000
048000 1100-FORMAT-IP-ADDR.                                             04680000
048100                                                                  04690000
048200*      old comment below                                          04700000
048300*      IN ORDER TO TEST THE FAILOVER, SEND TO NT63 BECAUSE NO ONE 04710000
048400*      REALLY TESTS THERE AND YOU CAN BRING IT DOWN WITHOUT       04720000
048500*      AFFECTING ANYONE.  ECOM USES NT18 SO CAN'T BRING IT DOWN TO04730000
048600*      TEST.                                                      04740000
048700                                                                  04750000
048800     EVALUATE TRUE                                                04760000
048900         WHEN  PV-CICS-REGION = 'CICST'                           04770000
049000            MOVE PC-IP-ADDR-TEST TO PV-IP-ADDRESS                 04780000
049100         WHEN  PV-CICS-REGION = 'CICSP'                           04790000
049200            MOVE PC-IP-ADDR-PROD-PM TO PV-IP-ADDRESS              04800000
049300         WHEN OTHER                                               04810000
049400            MOVE PC-IP-ADDR-PROD-SC TO PV-IP-ADDRESS              04820000
LOAD  *** CHANGE THIS TO TEST SECONDARY IP ADDRESS WHEN TESTING         04830000
LOAD  ***         MOVE PC-IP-ADDR-TEST-SC TO PV-IP-ADDRESS              04840000
049500     END-EVALUATE.                                                04850000
049600                                                                  04860000
049700     MOVE PV-IP-ADDR-NUM1 TO PV-HEX-NUMERIC.                      04870000
049800     MOVE PV-HEX-CHAR-2 TO PV-HEX-FIELD-1.                        04880000
049900                                                                  04890000
050000     MOVE PV-IP-ADDR-NUM2 TO PV-HEX-NUMERIC.                      04900000
050100     MOVE PV-HEX-CHAR-2 TO PV-HEX-FIELD-2.                        04910000
050200                                                                  04920000
050300     MOVE PV-IP-ADDR-NUM3 TO PV-HEX-NUMERIC.                      04930000
050400     MOVE PV-HEX-CHAR-2 TO PV-HEX-FIELD-3.                        04940000
050500                                                                  04950000
050600     MOVE PV-IP-ADDR-NUM4 TO PV-HEX-NUMERIC.                      04960000
050700     MOVE PV-HEX-CHAR-2 TO PV-HEX-FIELD-4.                        04970000
050800                                                                  04980000
050900     MOVE PV-HEX-FIELD-NUMBER TO DP081-NAME-IP-ADDR.              04990000
051000                                                                  05000000
051100*---------------------------------------------------------------- 05010000
051200*  FORMAT BACKUP IP ADDRESS IF CONNECTION WAS NOT MADE INITIALLY  05020000
051300*---------------------------------------------------------------- 05030000
051400 1200-SECONDARY-IP-ADDR.                                          05040000
051500                                                                  05050000
051600     INITIALIZE DP081-NAME-IP-ADDR.                               05060000
051700                                                                  05070000
051800     EVALUATE TRUE                                                05080000
051900         WHEN  PV-CICS-REGION = 'CICST'                           05090000
052000            MOVE PC-IP-ADDR-TEST TO PV-IP-ADDRESS                 05100000
052200            SET PS-BACKUP      TO TRUE                            05110000
052300         WHEN  PV-CICS-REGION = 'CICSP'                           05120000
LOAD              MOVE PC-IP-ADDR-PROD-SC TO PV-IP-ADDRESS              05130000
052600            SET PS-BACKUP      TO TRUE                            05140000
052700         WHEN OTHER                                               05150000
052800            MOVE PC-IP-ADDR-PROD-PM TO PV-IP-ADDRESS              05160000
053000            SET PS-BACKUP      TO TRUE                            05170000
LOAD  * THIS WAS USED FOR TESTING PURPOSES BELOW                        05171000
LOAD  *           MOVE PC-IP-ADDR-TEST-SC TO PV-IP-ADDRESS              05172000
053100     END-EVALUATE.                                                05173000
053200                                                                  05174000
053300     MOVE PV-IP-ADDR-NUM1 TO PV-HEX-NUMERIC.                      05175000
053400     MOVE PV-HEX-CHAR-2 TO PV-HEX-FIELD-1.                        05176000
053500                                                                  05177000
053600     MOVE PV-IP-ADDR-NUM2 TO PV-HEX-NUMERIC.                      05178000
053700     MOVE PV-HEX-CHAR-2 TO PV-HEX-FIELD-2.                        05179000
053800                                                                  05180000
053900     MOVE PV-IP-ADDR-NUM3 TO PV-HEX-NUMERIC.                      05190000
054000     MOVE PV-HEX-CHAR-2 TO PV-HEX-FIELD-3.                        05200000
054100                                                                  05210000
054200     MOVE PV-IP-ADDR-NUM4 TO PV-HEX-NUMERIC.                      05220000
054300     MOVE PV-HEX-CHAR-2 TO PV-HEX-FIELD-4.                        05230000
054400                                                                  05240000
054500     MOVE PV-HEX-FIELD-NUMBER TO DP081-NAME-IP-ADDR.              05250000
054600                                                                  05260000
054700*---------------------------------------------------------------- 05270000
054800*  BEGIN MAIN AUTHORIZATION PROCESSING                            05280000
054900*---------------------------------------------------------------- 05290000
055000 2000-PROCESS.                                                    05300000
055100                                                                  05310000
055200     MOVE SPACE TO PS-CONTINUE-SW.                                05320000
055300                                                                  05330000
055400     PERFORM 8000-FORMAT-AUTH.                                    05340000
055500                                                                  05350000
055600*JMP                                                              05360000
055700* 'SOCKET' COMMAND ASSIGNS A SOCKET ON THE MAINFRAME.             05370000
055800* 'CONNECT' TRIES TO CONNECT TO THE REMOTE SERVER.                05380000
055900* IF YOU CAN'T CONNECT TO THE PRIMARY SERVER, TRY SECONDARY.      05390000
056000                                                                  05400000
056100     IF PS-SEND-AUTH                                              05410000
056200        PERFORM 5100-CALL-SOCKET                                  05420000
056300        IF PS-SOCKET-ERROR-NO                                     05430000
056400            PERFORM 5200-CONNECT-SOCKET                           05440000
056500            IF PS-SOCKET-ERROR                                    05450000
056600                PERFORM 5600-CLOSE-SOCKET                         05460000
056700                PERFORM 1200-SECONDARY-IP-ADDR                    05470000
056800                PERFORM 5100-CALL-SOCKET                          05480000
056900                IF PS-SOCKET-ERROR-NO                             05490000
057000                    PERFORM 5200-CONNECT-SOCKET                   05500000
057100                END-IF                                            05510000
057200            END-IF                                                05520000
057300        ELSE                                                      05530000
057400            PERFORM 1200-SECONDARY-IP-ADDR                        05540000
057500            PERFORM 5100-CALL-SOCKET                              05550000
057600            IF PS-SOCKET-ERROR-NO                                 05560000
057700                PERFORM 5200-CONNECT-SOCKET                       05570000
057800            END-IF                                                05580000
057900        END-IF                                                    05590000
058000     END-IF.                                                      05600000
058100                                                                  05610000
058200     IF PS-SOCKET-ERROR-NO                                        05620000
058300**     100 message      ****                                      05630000
058400         PERFORM 5300-SEND-AUTH                                   05640000
058500         IF PS-SOCKET-ERROR                                       05650000
058600             PERFORM 5600-CLOSE-SOCKET                            05660000
058700             PERFORM 1200-SECONDARY-IP-ADDR                       05670000
058800             PERFORM 5100-CALL-SOCKET                             05680000
058900             IF PS-SOCKET-ERROR-NO                                05690000
059000                 PERFORM 5200-CONNECT-SOCKET                      05700000
059100                 PERFORM 5300-SEND-AUTH                           05710000
059200             END-IF                                               05720000
059300         END-IF                                                   05730000
059400     ELSE                                                         05740000
059500         SET PS-DO-NOT-CONTINUE TO TRUE                           05750000
059600     END-IF.                                                      05760000
059700                                                                  05770000
059800     IF PS-CONTINUE                                               05780000
059900**     101 message       **                                       05790000
060000        PERFORM 5350-CHECK-SOCKET-CONNECTION                      05800000
060100        IF PS-SOCKET-ERROR-NO                                     05810000
060200            PERFORM 5500-RECEIVE-TCP                              05820000
060300            IF PS-SOCKET-ERROR                                    05830000
060400                PERFORM 5600-CLOSE-SOCKET                         05840000
060500                PERFORM 1200-SECONDARY-IP-ADDR                    05850000
060600                PERFORM 5100-CALL-SOCKET                          05860000
060700                IF PS-SOCKET-ERROR-NO                             05870000
060800                    PERFORM 5200-CONNECT-SOCKET                   05880000
060900                    IF PS-SOCKET-ERROR-NO                         05890000
061000                        PERFORM 5300-SEND-AUTH                    05900000
061100                        IF PS-CONTINUE                            05910000
061200                            PERFORM 5350-CHECK-SOCKET-CONNECTION  05920000
061300                            IF PS-SOCKET-ERROR-NO                 05930000
061400                                PERFORM 5500-RECEIVE-TCP          05940000
061500                            END-IF                                05950000
061600                        END-IF                                    05960000
061700                    END-IF                                        05970000
061800                END-IF                                            05980000
061900            END-IF                                                05990000
062000        END-IF                                                    06000000
064300                                                                  06010000
064400        IF PS-VALID-RSPN                                          06020000
064500           PERFORM 5600-CLOSE-SOCKET                              06030000
064600           PERFORM 8500-UNSTRING-RESP                             06040000
064700           PERFORM 8550-SELECT-AUTH                               06050000
064800           PERFORM 8600-UPDATE-AUTH-TABLE                         06060000
064900           PERFORM 8700-COMMIT-CHANGES                            06070000
065100        ELSE                                                      06080000
065200           PERFORM 5600-CLOSE-SOCKET                              06090000
065300           PERFORM 8550-SELECT-AUTH                               06100000
065400           PERFORM 8650-UPDATE-AUTH-TABLE                         06110000
065500           PERFORM 8700-COMMIT-CHANGES                            06120000
065600        END-IF                                                    06130000
065700     END-IF.                                                      06140000
065710                                                                  06150000
065920     IF GCT00004-VND-AUTH-RSPN-CDE = '15' OR                      06160000
066000        GCT00004-VND-AUTH-RSPN-CDE = '74' OR                      06170000
066010        GCT00004-VND-AUTH-RSPN-CDE = '21' OR                      06180000
066020        GCT00004-VND-AUTH-RSPN-CDE = '00' OR                      06190000
066100        GCT00004-VND-AUTH-RSPN-CDE = 'F99'                        06200000
066101           CONTINUE                                               06210000
066601     ELSE                                                         06220000
066607*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  06230000
066608        STRING                                                    06240000
066609         ' AUKCS518:'            DELIMITED BY SIZE                06250000
066610         ' HARD DECLINE - CARD ' DELIMITED BY SIZE                06260000
066611           PV-CRD-NBR            DELIMITED BY SIZE                06270000
066612         ' CALL PAYMENT AND TAX - AJB SUPPORT'                    06280000
066613                                 DELIMITED BY SIZE                06290000
066614           INTO IS003-SUMMARY                                     06300000
066615        PERFORM 9900-POST-NETCOOL-ALERT                           06310000
066616*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  06320000
066620     END-IF.                                                      06330000
066700                                                                  06340000
066710*** DISPLAY A MESSAGE TO THE EPCL LOG ***                         06350000
066730     SET EP000-SL-INFORMATION TO TRUE.                            06360000
066740     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   06370000
066750* Display Message *                                               06380000
066760     STRING '3RD PRTY GC RSP: '                                   06390000
066770             PV-HD-STR-NBR '/'                                    06400000
066780             PV-HD-RGST-ID '/'                                    06410000
066790             PV-HD-TRN-NBR '/'                                    06420000
066792             PV-UPC-NBR '/'                                       06430000
066793             'CARD:' PV-CRD-NBR                                   06440000
066794             ' AMT:' PV-CUST-CHRGD-AMT                            06450000
066795             ' SAF:' PV-HD-SAF-CDE                                06460000
066796             ' RESP:' GCT00004-VND-AUTH-RSPN-CDE                  06470000
066797             DELIMITED BY SIZE                                    06480000
066798     INTO EP000-MD-SYSTEM-LOG-MESSAGE                             06490000
066799          (EP000-MESSAGE-LINE-COUNTER)                            06500000
066800     END-STRING.                                                  06510000
066801                                                                  06520000
066802     PERFORM EP000-1000-POST-MESSAGE.                             06530000
066803                                                                  06540000
066810     SET PS-INVALID-RSPN TO TRUE.                                 06550000
066900     SET PS-END-PROCESS  TO TRUE.                                 06560000
067000                                                                  06570000
067100*---------------------------------------------------------------- 06580000
067200*  CALL SOCKET                                                    06590000
067300* 'SOCKET' COMMAND ASSIGNS A SOCKET ON THE MAINFRAME.             06600000
067400*---------------------------------------------------------------- 06610000
067500 5100-CALL-SOCKET.                                                06620000
067600                                                                  06630000
067700     INITIALIZE DP081-RETCODE                                     06640000
067800                DP081-ERRNO.                                      06650000
067900     SET PS-SOCKET-ERROR-NO TO TRUE.                              06660000
068000                                                                  06670000
068100     CALL 'EZASOKET'                                              06680000
068200         USING DP081-SOCKET-CMD                                   06690000
068300               DP081-AF-INET                                      06700000
068400               DP081-SOCK-TYPE                                    06710000
068500               DP081-PROTOCOL                                     06720000
068600               DP081-ERRNO                                        06730000
068700               DP081-RETCODE.                                     06740000
068800                                                                  06750000
068900     MOVE DP081-RETCODE TO DP081-SOCK-ID.                         06760000
069000                                                                  06770000
069100     IF DP081-RETCODE < ZERO                                      06780000
069200        INITIALIZE PV-CICS-MSG-AREA                               06790000
069300        SET PS-SOCKET-ERROR          TO TRUE                      06800000
069400        MOVE PC-CURRENT-PROGRAM-NAME TO DP081-TCP-IP-PGM-NAME     06810000
069500        SET  DP081-TCP-IP-SOCKET-ERR TO TRUE                      06820000
069600        MOVE DP081-ERRNO             TO DP081-TCP-IP-ERR-NBR      06830000
069700        MOVE DP081-TCP-IP-LOGGING-MSG TO PV-CICS-MSG-AREA         06840000
069800        PERFORM 9990-WRITE-CICS                                   06850000
069900*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  06860000
070000        STRING                                                    06870000
070100         ' AUKCS518:'            DELIMITED BY SIZE                06880000
070200         ' SOCKET CALL FAILED. ' DELIMITED BY SIZE                06890000
070210         'CALL PAYMENT AND TAX MAINFRAME TEAM'                    06900000
070220                                 DELIMITED BY SIZE                06910000
070300           INTO IS003-SUMMARY                                     06920000
070400        PERFORM 9900-POST-NETCOOL-ALERT                           06930000
070500*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  06940000
070600     ELSE                                                         06950000
070700        SET PS-CONNECT TO TRUE                                    06960000
070800     END-IF.                                                      06970000
070900/                                                                 06980000
071000*----------------------------------------------------------------*06990000
071100*  CONNECT SOCKET                                                 07000000
071200* 'CONNECT' TRIES TO CONNECT TO THE REMOTE SERVER.                07010000
071300*----------------------------------------------------------------*07020000
071400 5200-CONNECT-SOCKET.                                             07030000
071500                                                                  07040000
071600     INITIALIZE DP081-RETCODE                                     07050000
071700                DP081-ERRNO.                                      07060000
071800     SET PS-SOCKET-ERROR-NO TO TRUE.                              07070000
071900                                                                  07080000
072000     MOVE DP081-AF-INET  TO  DP081-NAME-FAMILY.                   07090000
072100     MOVE PC-PORT-NBR    TO  DP081-NAME-PORT.                     07100000
072200                                                                  07110000
072300     CALL 'EZASOKET'                                              07120000
072400         USING DP081-CONNECT-CMD                                  07130000
072500               DP081-SOCK-ID                                      07140000
072600               DP081-SOCK-NAME                                    07150000
072700               DP081-ERRNO                                        07160000
072800               DP081-RETCODE.                                     07170000
072900                                                                  07180000
073000     IF DP081-RETCODE < ZERO                                      07190000
073100        SET  DP081-TCP-IP-CONNECT-ERR TO TRUE                     07200000
073200        SET  PS-SOCKET-ERROR          TO TRUE                     07210000
073300        MOVE DP081-ERRNO              TO DP081-TCP-IP-ERR-NBR     07220000
073400        MOVE DP081-TCP-IP-LOGGING-MSG TO PV-LOG-MSG-AREA          07230000
073500        PERFORM 9990-WRITE-CICS                                   07240000
073600        SET PS-NO-CONNECT TO TRUE                                 07250000
073700*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  07260000
073800        STRING                                                    07270000
073900         ' AUKCS518:'               DELIMITED BY SIZE             07280000
074000         ' CONNECT SOCKET FAILED  ' DELIMITED BY SIZE             07290000
074100         ' IP ADDR = '              DELIMITED BY SIZE             07300000
074200           PV-IP-ADDRESS            DELIMITED BY SIZE             07310000
074201         'CALL PAYMENT AND TAX MAINFRAME TEAM'                    07320000
074202                                 DELIMITED BY SIZE                07330000
074300           INTO IS003-SUMMARY                                     07340000
074400        PERFORM 9900-POST-NETCOOL-ALERT                           07350000
074500*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  07360000
074600     ELSE                                                         07370000
074700        SET PS-CONNECT TO TRUE                                    07380000
074800     END-IF.                                                      07390000
074900/                                                                 07400000
075000*----------------------------------------------------------------*07410000
075100*    WRITE OUT THE AUTH                                          *07420000
075200*----------------------------------------------------------------*07430000
075300 5300-SEND-AUTH.                                                  07440000
075400                                                                  07450000
075500     MOVE PV-LENGTH    TO TCP-LEN.                                07460000
075600     MOVE TCP-MSG-HOLD TO TCP-MSG.                                07470000
075700     SET PS-SOCKET-ERROR-NO TO TRUE.                              07480000
075800     MOVE TCP-LEN             TO DP081-TCPLENG                    07490000
075900     COMPUTE TCP-LEN-BYTES = TCP-LEN + 4.                         07500000
076000     MOVE TCP-LEN-BYTES       TO DP081-NBR-BYTES                  07510000
076600                                                                  07520000
076700* TRANSLATE EBCDIC TO ASCII                                       07530000
076800     CALL 'EZACIC04'                                              07540000
076900         USING  DP081-TOASCII-TOKEN                               07550000
077000                TCP-BUF                                           07560000
077100                DP081-NBR-BYTES.                                  07570000
077200                                                                  07580000
077300* WRITE DATA ON A CONNECTED SOCKET                                07590000
077400     CALL 'EZASOKET'                                              07600000
077500         USING                                                    07610000
077600                DP081-WRITE-CMD                                   07620000
077700                DP081-SOCK-ID                                     07630000
077800                DP081-NBR-BYTES                                   07640000
077900                TCP-BUF                                           07650000
078000                DP081-ERRNO                                       07660000
078100                DP081-RETCODE.                                    07670000
078200                                                                  07680000
078300     EVALUATE TRUE                                                07690000
078400       WHEN DP081-RETCODE = ZERO                                  07700000
078500       WHEN DP081-RETCODE > ZERO                                  07710000
078600           SET PS-CONTINUE TO TRUE                                07720000
078700       WHEN DP081-RETCODE < ZERO                                  07730000
078800           SET PS-SOCKET-ERROR TO TRUE                            07740000
078900           PERFORM 5600-CLOSE-SOCKET                              07750000
079000                                                                  07760000
079100           SET PS-DO-NOT-CONTINUE                                 07770000
079200               PS-INVALID-RSPN    TO TRUE                         07780000
079300                                                                  07790000
079400           INITIALIZE PV-CICS-MSG-AREA                            07800000
079500                                                                  07810000
079600           STRING ' AUKCS518 - '                                  07820000
079700                  '5300- SEND AUTH   '                            07830000
079800                       TCP-BUF                                    07840000
079900           DELIMITED BY SIZE INTO PV-CICS-MSG-AREA                07850000
080000                                                                  07860000
080100           PERFORM 9990-WRITE-CICS                                07870000
080200           MOVE PC-CURRENT-PROGRAM-NAME TO DP081-TCP-IP-PGM-NAME  07880000
080300           SET DP081-TCP-IP-SEND-TO-ERR TO TRUE                   07890000
080400           MOVE DP081-ERRNO       TO DP081-TCP-IP-ERR-NBR         07900000
080500           SET DP013-OTHER-ABEND  TO TRUE                         07910000
080600           SET DP013-NO-ROLLBACK  TO TRUE                         07920000
080700           MOVE '5300-SEND-AUTH'                                  07930000
080800               TO DP013-PARAGRAPH                                 07940000
080900           MOVE DP081-TCP-IP-LOGGING-MSG                          07950000
081000                                  TO DP013-MESSAGE-TEXT(1)        07960000
081100                                  PV-CICS-MSG-AREA                07970000
081200           PERFORM 9990-WRITE-CICS                                07980000
081300*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  07990000
081400           STRING                                                 08000000
081500             ' AUKCS518:'            DELIMITED BY SIZE            08010000
081600             ' FAILED MESSAGE SEND ' DELIMITED BY SIZE            08020000
081620             'CALL PAYMENT AND TAX MAINFRAME TEAM'                08030000
081630                                     DELIMITED BY SIZE            08040000
081700              INTO IS003-SUMMARY                                  08050000
081800           PERFORM 9900-POST-NETCOOL-ALERT                        08060000
081900*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  08070000
082000       END-EVALUATE.                                              08080000
082100                                                                  08090000
082200*---------------------------------------------------------------* 08100000
082300*  ADDED SELECT SOCKET COMMAND TO CHECK IF SOCKET CONNECTION    * 08110000
082400*  IS STILL ACTIVE.  IF RETURN CODE > 0 THEN SOCKET IS ACTIVE   * 08120000
082500*  IF RETURN CODE = 0 SOCKET IS NO LONGER ACTIVE.               * 08130000
082600*---------------------------------------------------------------* 08140000
082700 5350-CHECK-SOCKET-CONNECTION.                                    08150000
082800                                                                  08160000
082900* ZERO OUT ALL OUTPUT BIT MASKS FOR SELECT                        08170000
083000     PERFORM VARYING SOCKNO FROM 1 BY 1 UNTIL SOCKNO > SOCKETS    08180000
083100        MOVE '0' TO CHAR-ENTRY(SOCKNO)                            08190000
083200     END-PERFORM.                                                 08200000
083300     PERFORM 5360-CHAR-TO-BIT.                                    08210000
083400     MOVE BIT-MASK TO SELECT-RR-MASK.                             08220000
083500     MOVE BIT-MASK TO SELECT-RW-MASK.                             08230000
083600     MOVE BIT-MASK TO SELECT-RE-MASK.                             08240000
083700     MOVE BIT-MASK TO SELECT-EX-MASK.                             08250000
083800     MOVE BIT-MASK TO SELECT-WR-MASK.                             08260000
083900                                                                  08270000
084000* set all input bit masks for select to 1                         08280000
084100     PERFORM VARYING SOCKNO FROM 1 BY 1 UNTIL SOCKNO > SOCKETS    08290000
084200        MOVE '1' TO CHAR-ENTRY(SOCKNO)                            08300000
084300     END-PERFORM.                                                 08310000
084400     PERFORM 5360-CHAR-TO-BIT.                                    08320000
084500     MOVE BIT-MASK TO SELECT-RD-MASK.                             08330000
084600*                                                                 08340000
084700* ISSUE THE SELECT COMMAND ----------------------------           08350000
084800* SELECT WILL FLIP A BIT IN THE READ MASK TO '1' FOR ANY          08360000
084900* SOCKET THAT HAS DATA TO BE PROCESSED.                           08370000
085000*                                                                 08380000
085100                                                                  08390000
085200     MOVE 0 TO DP081-ERRNO.                                       08400000
085300     MOVE 0 TO DP081-RETCODE.                                     08410000
085400     CALL 'EZASOKET' USING DP081-SELECT-CMD                       08420000
085500         SELECT-NUMFDS SELECT-TIMEOUT                             08430000
085600         SELECT-RD-MASK SELECT-WR-MASK SELECT-EX-MASK             08440000
085700         SELECT-RR-MASK SELECT-RW-MASK SELECT-RE-MASK             08450000
085800         DP081-ERRNO DP081-RETCODE.                               08460000
085900                                                                  08470000
086000     EVALUATE TRUE                                                08480000
086100       WHEN DP081-RETCODE = ZERO                                  08490000
086200           CONTINUE                                               08500000
086300       WHEN DP081-RETCODE < ZERO                                  08510000
086400           SET PS-SOCKET-ERROR TO TRUE                            08520000
086500           SET PS-NO-CONNECT   TO TRUE                            08530000
086600           SET PS-INVALID-RSPN TO TRUE                            08540000
086700           MOVE 98             TO AU015-IX-RESP-CDE               08550000
086800                                                                  08560000
086900           PERFORM 5600-CLOSE-SOCKET                              08570000
087000                                                                  08580000
087100           SET PS-DO-NOT-CONTINUE                                 08590000
087200               PS-INVALID-RSPN    TO TRUE                         08600000
087300                                                                  08610000
087400           INITIALIZE PV-CICS-MSG-AREA                            08620000
087500                                                                  08630000
087600           STRING ' AUKCS518 - '                                  08640000
087700                  '5350- CHECK CONNECT'                           08650000
087800                       TCP-BUF                                    08660000
087900           DELIMITED BY SIZE INTO PV-CICS-MSG-AREA                08670000
088000                                                                  08680000
088100           PERFORM 9990-WRITE-CICS                                08690000
088200           MOVE PC-CURRENT-PROGRAM-NAME TO DP081-TCP-IP-PGM-NAME  08700000
088300           SET DP081-TCP-IP-CONNECT-ERR TO TRUE                   08710000
088400           MOVE DP081-ERRNO       TO DP081-TCP-IP-ERR-NBR         08720000
088500           SET DP013-OTHER-ABEND  TO TRUE                         08730000
088600           SET DP013-NO-ROLLBACK  TO TRUE                         08740000
088700           MOVE '5350-CHECK CONNECT'                              08750000
088800               TO DP013-PARAGRAPH                                 08760000
088900           MOVE DP081-TCP-IP-LOGGING-MSG                          08770000
089000                                  TO DP013-MESSAGE-TEXT(1)        08780000
089100                                  PV-CICS-MSG-AREA                08790000
089200           PERFORM 9990-WRITE-CICS                                08800000
089300*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  08810000
089400           STRING                                                 08820000
089500             ' AUKCS518:'            DELIMITED BY SIZE            08830000
089600             ' CONNECT NOT ACTIVE '  DELIMITED BY SIZE            08840000
089620             'CALL PAYMENT AND TAX MAINFRAME TEAM'                08850000
089630                                     DELIMITED BY SIZE            08860000
089700              INTO IS003-SUMMARY                                  08870000
089800           PERFORM 9900-POST-NETCOOL-ALERT                        08880000
089900*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  08890000
090000     END-EVALUATE.                                                08900000
090100                                                                  08910000
090200***************************************************************   08920000
090300* CHAR-TO-BIT                                                 *   08930000
090400* CONVERT THE CHARACTER ARRAY TO A SELECT BIT MASK SO THAT THE*   08940000
090500* COBOL PROGRAM CAN WRITE IT.                                 *   08950000
090600***************************************************************   08960000
090700 5360-CHAR-TO-BIT.                                                08970000
090800*                                                                 08980000
090900* CHAR-TO-BIT                                                     08990000
091000* CONVERT THE CHARACTER ARRAY TO A SELECT BIT MASK SO THAT THE    09000000
091100* COBOL PROGRAM CAN WRITE IT.                                     09010000
091200*                                                                 09020000
091300     CALL 'EZACIC06' USING BITMASK-TOKEN CTOB                     09030000
091400          BIT-MASK CHAR-MASK BIT-MASK-LENGTH EZRETC               09040000
091500     IF  EZRETC < 0 THEN                                          09050000
091600         MOVE '!EZCIC06 - AUKCS518 '       TO PV-CICS-MSG-AREA    09060000
091700         SET  PS-SOCKET-ERROR              TO TRUE                09070000
091800         PERFORM 9990-WRITE-CICS                                  09080000
091900         SET  DP081-TCP-IP-CONNECT-ERR     TO TRUE                09090000
092000         MOVE DP081-ERRNO                  TO DP081-TCP-IP-ERR-NBR09100000
092100         MOVE 'AUKCS518 SOCKET-SELECT-ERR' TO PV-CICS-MSG-AREA    09110000
092200         PERFORM 9990-WRITE-CICS                                  09120000
092300     END-IF.                                                      09130000
092400                                                                  09140000
092500*----------------------------------------------------------------*09150000
092600*    THIS PARAGRAPH WILL CONTROL THE RECEIVES TO CAPTURE ALL     *09160000
092700*    OF THE DATA BEING PASSED TO THE MAINFRAME FROM AJB          *09170000
092800*----------------------------------------------------------------*09180000
092900 5500-RECEIVE-TCP.                                                09190000
093000                                                                  09200000
093100     SET PS-VALID-RSPN TO TRUE.                                   09210000
093200     MOVE +500 TO DP081-NBR-BYTES.                                09220000
093300                                                                  09230000
093400     CALL 'EZASOKET'                                              09240000
093500         USING                                                    09250000
093600                DP081-RECV-CMD                                    09260000
093700                DP081-SOCK-ID                                     09270000
093800                DP081-FLAG                                        09280000
093900                DP081-NBR-BYTES                                   09290000
094000                PV-RECEIVE-BUF                                    09300000
094100                DP081-ERRNO                                       09310000
094200                DP081-RETCODE.                                    09320000
094300     IF  DP081-RETCODE < ZERO                                     09330000
094400         SET PS-INVALID-RSPN TO TRUE                              09340000
094500         SET PS-SOCKET-ERROR TO TRUE                              09350000
094600                                                                  09360000
094700         MOVE PC-CURRENT-PROGRAM-NAME TO DP081-TCP-IP-PGM-NAME    09370000
094800         SET  DP081-TCP-IP-READ-ERR TO TRUE                       09380000
094900         MOVE DP081-ERRNO         TO DP081-TCP-IP-ERR-NBR         09390000
095000         SET  DP013-OTHER-ABEND   TO TRUE                         09400000
095100         SET  DP013-NO-ROLLBACK   TO TRUE                         09410000
095200         MOVE '5500-RECEIVE-TCP'                                  09420000
095300             TO DP013-PARAGRAPH                                   09430000
095400         MOVE DP081-TCP-IP-LOGGING-MSG TO DP013-MESSAGE-TEXT (1)  09440000
095500                                                                  09450000
095600         PERFORM 9990-WRITE-CICS                                  09460000
095700*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  09470000
095800         STRING                                                   09480000
095900           ' AUKCS518:'                    DELIMITED BY SIZE      09490000
096000           ' RECEIVE FROM SOCKET FAILED. ' DELIMITED BY SIZE      09500000
096001           'CALL PAYMENT AND TAX MAINFRAME TEAM'                  09510000
096002                                           DELIMITED BY SIZE      09520000
096100              INTO IS003-SUMMARY                                  09530000
096200          PERFORM 9900-POST-NETCOOL-ALERT                         09540000
096300*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  09550000
096400                                                                  09560000
096500     END-IF.                                                      09570000
096600                                                                  09580000
096700*----------------------------------------------------------------*09590000
096800*  CLOSE THE SOCKET                                              *09600000
096900*----------------------------------------------------------------*09610000
097000 5600-CLOSE-SOCKET.                                               09620000
097100* CLOSE THE CONNECTED SOCKET                                      09630000
097200                                                                  09640000
097300     CALL 'EZASOKET'                                              09650000
097400         USING                                                    09660000
097500                DP081-CLOSE-CMD                                   09670000
097600                DP081-SOCK-ID                                     09680000
097700                DP081-ERRNO                                       09690000
097800                DP081-RETCODE.                                    09700000
097900     IF DP081-RETCODE < ZERO                                      09710000
098000         MOVE PC-CURRENT-PROGRAM-NAME TO DP081-TCP-IP-PGM-NAME    09720000
098100         SET  DP081-TCP-IP-CLOSE-ERR TO TRUE                      09730000
098200         MOVE DP081-ERRNO         TO DP081-TCP-IP-ERR-NBR         09740000
098300         SET  DP013-OTHER-ABEND   TO TRUE                         09750000
098400         SET  DP013-NO-ROLLBACK   TO TRUE                         09760000
098500         MOVE '5600-CLOSE-SOCKET'                                 09770000
098600             TO DP013-PARAGRAPH                                   09780000
098700         MOVE DP081-TCP-IP-LOGGING-MSG TO DP013-MESSAGE-TEXT (1)  09790000
098800         PERFORM 9990-WRITE-CICS                                  09800000
098900*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  09810000
099000         STRING                                                   09820000
099100           ' AUKCS518:'             DELIMITED BY SIZE             09830000
099200           ' CLOSE SOCKET FAILED '  DELIMITED BY SIZE             09840000
099220           'CALL PAYMENT AND TAX MAINFRAME TEAM'                  09850000
099230                                    DELIMITED BY SIZE             09860000
099300              INTO IS003-SUMMARY                                  09870000
099400          PERFORM 9900-POST-NETCOOL-ALERT                         09880000
099500*---------- CONSTRUCT NETCOOL MESSAGE -------------------------*  09890000
099600     END-IF.                                                      09900000
099700******************************************************************09910000
099800*   RETRIEVE THE AUTH REQUEST                                     09920000
099900******************************************************************09930000
100000 7000-RETRIEVE-AUTH-REQUEST.                                      09940000
100100                                                                  09950000
100200     EXEC CICS                                                    09960000
100300         RETRIEVE                                                 09970000
100400             INTO    (PV-AUTH-INQ-MESSAGE-AREA)                   09980000
100500             LENGTH  (PC-COMMUNICATIONS-IN-LENGTH)                09990000
100600             RESP    (PV-CICS-RESPONSE)                           10000000
100700     END-EXEC.                                                    10010000
100800                                                                  10020000
100900     EVALUATE TRUE                                                10030000
101000         WHEN ((PV-CICS-RESPONSE NOT = DFHRESP(NORMAL))           10040000
101100                      AND (PV-CICS-RESPONSE NOT = DFHRESP(EOC)))  10050000
101200             SET EP000-SL-ERROR TO TRUE                           10060000
101300             MOVE PV-CICS-RESPONSE TO PV-CICS-RESPONSE-DISP       10070000
101400             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            10080000
101500             STRING 'ERROR RETRIEVING RESPONSE MESSAGE '          10090000
101600                                         DELIMITED BY SIZE        10100000
101700                ' - CICS RESPONSE = '    DELIMITED BY SIZE        10110000
101800                PV-CICS-RESPONSE-DISP    DELIMITED BY SIZE        10120000
101900                 INTO  EP000-MD-SYSTEM-LOG-MESSAGE                10130000
102000                           (EP000-MESSAGE-LINE-COUNTER)           10140000
102100             PERFORM EP000-1000-POST-MESSAGE                      10150000
102200             PERFORM 9999-RETURN-TO-NATIVE-CICS                   10160000
102300         WHEN PV-CICS-RESPONSE  = DFHRESP(NORMAL)                 10170000
102400             MOVE PV-AI-AUTH-REQUEST-MESSAGE TO PV-MESSAGE-AREA   10180000
103900     END-EVALUATE.                                                10190000
104000                                                                  10200000
104100                                                                  10210000
104200*-----------------------------------------------------------------10220000
104300*  MOVE FIELDS TO 100 REQUEST MESSAGE FIELDS.                     10230000
104400*-----------------------------------------------------------------10240000
104500 8000-FORMAT-AUTH.                                                10250000
104600                                                                  10260000
104800     MOVE PV-HD-STR-NBR         TO AU014-IX-STR-NBR               10270000
104900                                   PV-REF-STR-NBR.                10280000
104910*TDH001                                                           10290000
105000     MOVE PV-HD-RGST-ID         TO AU014-IX-RGST-ID.              10300000
105010     MOVE PV-HD-RGST-ID(3:2)    TO PV-REF-RGST-ID.                10310000
105020*                                                                 10320000
105030                                                                  10330000
105400     MOVE PV-HD-TRN-NBR         TO AU014-IX-TRN-NBR               10340000
105500                                   PV-REF-TRN-NBR.                10350000
105510*TDH001                                                           10360000
105511     MOVE PV-HD-LNE-ITM-SEQ-NBR(3:2)                              10370000
105512                                TO PV-REF-LINE-NBR.               10380000
105514*                                                                 10390000
105500                                                                  10400000
105600     MOVE PV-REF-NBR            TO AU014-IX-REF-NBR.              10410000
105700                                                                  10420000
105900     MOVE PV-HD-SLS-DTE         TO PV-SEP-DATE.                   10430000
106000     MOVE PV-MM-SEP             TO PV-SEP-MM.                     10440000
106100     MOVE PV-DD-SEP             TO PV-SEP-DD.                     10450000
106200     MOVE PV-SEP-DTE            TO AU014-IX-DATE.                 10460000
106300                                                                  10470000
106400     MOVE PV-HD-STRT-TM         TO PV-SEP-TIME.                   10480000
106600     MOVE PV-HH-TM              TO PV-SEP-HH.                     10490000
106700     MOVE PV-MM-TM              TO PV-SEP-MIN.                    10500000
106800     MOVE PV-SS-TM              TO PV-SEP-SS.                     10510000
106900     MOVE PV-SEP-TM             TO AU014-IX-TIME.                 10520000
107000                                                                  10530000
107200     MOVE PV-HD-CARD-NBR        TO PV-SEPARATE-CARD.              10540000
107300     MOVE PV-CRD-NBR            TO AU014-IX-CARD.                 10550000
107400     MOVE PV-UPC-NBR            TO AU014-IX-UPC-NBR.              10560000
107500                                                                  10570000
107700     MOVE PV-HD-CUST-CHRGD-AMT  TO PV-AMT                         10580000
107800                                   PV-CUST-CHRGD-AMT.             10590000
107900                                                                  10600000
108000     EVALUATE TRUE                                                10610000
108100        WHEN PV-AMT(1:8) = 00000000                               10620000
108200           MOVE PV-AMT-X(9:1) TO AU014-IX-AMT                     10630000
108300        WHEN PV-AMT(1:7) = 0000000                                10640000
108400           MOVE PV-AMT-X(8:2) TO AU014-IX-AMT                     10650000
108500        WHEN PV-AMT(1:6) = 000000                                 10660000
108600           MOVE PV-AMT-X(7:3) TO AU014-IX-AMT                     10670000
108700        WHEN PV-AMT(1:5) = 00000                                  10680000
108800           MOVE PV-AMT-X(6:4) TO AU014-IX-AMT                     10690000
108900        WHEN PV-AMT(1:4) = 0000                                   10700000
109000           MOVE PV-AMT-X(5:5) TO AU014-IX-AMT                     10710000
109100        WHEN PV-AMT(1:3) = 000                                    10720000
109200           MOVE PV-AMT-X(4:6) TO AU014-IX-AMT                     10730000
109300        WHEN PV-AMT(1:2) = 00                                     10740000
109400           MOVE PV-AMT-X(3:7) TO AU014-IX-AMT                     10750000
109500        WHEN PV-AMT(1:1) = 0                                      10760000
109600           MOVE PV-AMT-X(2:8) TO AU014-IX-AMT                     10770000
109700        WHEN OTHER                                                10780000
109800           MOVE PV-AMT-X TO AU014-IX-AMT                          10790000
109900     END-EVALUATE.                                                10800000
110000                                                                  10810000
110200     IF PV-HD-SAF-CDE = 'S'                                       10820000
110300        MOVE '**AJBMOD_SAF_TRAN** *barcodescan'                   10830000
110400                                 TO AU014-IX-SAF-OR-BAR           10840000
110500     ELSE                                                         10850000
110600        MOVE '*BarcodeScan'      TO AU014-IX-SAF-OR-BAR           10860000
110700     END-IF.                                                      10870000
110800                                                                  10880000
110900     MOVE '4912'     TO AU014-IX-EXP-DTE.                         10890000
111000                                                                  10900000
111100     STRING AU014-TRANS-TYPE      DELIMITED BY SIZE               10910000
111200            ','                   DELIMITED BY SIZE               10920000
111300            ','                   DELIMITED BY SIZE               10930000
111400            ','                   DELIMITED BY SIZE               10940000
111500            ','                   DELIMITED BY SIZE               10950000
111600            ','                   DELIMITED BY SIZE               10960000
111700            AU014-IX-GIFT-CARD    DELIMITED BY SIZE               10970000
111800            ','                   DELIMITED BY SIZE               10980000
111900            ','                   DELIMITED BY SIZE               10990000
112000            AU014-IX-STR-NBR      DELIMITED BY SIZE               11000000
112100            ','                   DELIMITED BY SIZE               11010000
112200            AU014-IX-RGST-ID      DELIMITED BY SIZE               11020000
112300            ','                   DELIMITED BY SIZE               11030000
112400            AU014-IX-TRAN-TYP-REQ DELIMITED BY SIZE               11040000
112500            ','                   DELIMITED BY SIZE               11050000
112600            ','                   DELIMITED BY SIZE               11060000
112700            ','                   DELIMITED BY SIZE               11070000
112800            AU014-IX-CARD         DELIMITED BY SIZE               11080000
112900            ','                   DELIMITED BY SIZE               11090000
113000            AU014-IX-EXP-DTE      DELIMITED BY SIZE               11100000
113100            ','                   DELIMITED BY SIZE               11110000
113200            ','                   DELIMITED BY SIZE               11120000
113300            AU014-IX-AMT          DELIMITED BY SPACE              11130000
113400            ','                   DELIMITED BY SIZE               11140000
113500            AU014-IX-TRN-NBR      DELIMITED BY SIZE               11150000
113600            ','                   DELIMITED BY SIZE               11160000
113700            ',,,'                 DELIMITED BY SIZE               11170000
113800            AU014-IX-SAF-OR-BAR   DELIMITED BY SIZE               11180000
113900            ','                   DELIMITED BY SIZE               11190000
114000            AU014-IX-UPC-NBR      DELIMITED BY SIZE               11200000
114100            ','                   DELIMITED BY SIZE               11210000
114200            ',,,,,,'              DELIMITED BY SIZE               11220000
114300            ',,,,,,'              DELIMITED BY SIZE               11230000
114400            ',,,,,,'              DELIMITED BY SIZE               11240000
114500            ',,,,'                DELIMITED BY SIZE               11250000
114600            AU014-IX-REF-NBR      DELIMITED BY SIZE               11260000
114700            ',,,,,'               DELIMITED BY SIZE               11270000
114800            AU014-IX-DATE         DELIMITED BY SIZE               11280000
114900            ','                   DELIMITED BY SIZE               11290000
115000            AU014-IX-TIME         DELIMITED BY SIZE               11300000
115100            ','                   DELIMITED BY SIZE               11310000
115200            ','                   DELIMITED BY SIZE               11320000
115300            ','                   DELIMITED BY SIZE               11330000
115400            ','                   DELIMITED BY SIZE               11340000
115500     INTO  TCP-MSG.                                               11350000
115600                                                                  11360000
115700     INITIALIZE  PV-LENGTH.                                       11370000
115700     PERFORM VARYING PV-LENGTH FROM 200 BY -1                     11380000
115700         UNTIL PV-LENGTH = 0 OR                                   11390000
115700         TCP-MSG (PV-LENGTH:1) = ','                              11400000
115800     END-PERFORM.                                                 11410000
115900                                                                  11420000
116000*    INSPECT TCP-MSG                                              11430000
116100*       TALLYING PV-LEN-COUNT FOR ALL SPACES.                     11440000
116200                                                                  11450000
116400     MOVE PV-LENGTH TO TCP-LEN.                                   11460000
116500                                                                  11470000
116600     MOVE TCP-MSG   TO TCP-MSG-HOLD.                              11480000
116700                                                                  11490000
116800*-----------------------------------------------------------------11500000
116900*  UNSTRING 101 RESPONSE MESSAGE.                                 11510000
117000*-----------------------------------------------------------------11520000
117100 8500-UNSTRING-RESP.                                              11530000
117200                                                                  11540000
117300***   BEGIN OF TRANSLATE ASCII TO EBCDIC                          11550000
117400     CALL 'EZACIC05'                                              11560000
117500        USING  DP081-TOEBCDIC-TOKEN                               11570000
117600               PV-RECEIVE-BUF                                     11580000
117700               DP081-NBR-BYTES                                    11590000
117800                                                                  11600000
117900***   END OF TRANSLATE ASCII TO EBCDIC                            11610000
118000                                                                  11620000
118100     UNSTRING PV-RECEIVE-BUF                                      11630000
118200         DELIMITED BY ','                                         11640000
118300            INTO  AU015-TRANS-TYPE                                11650000
118400                  AU015-FIELD-2                                   11660000
118500                  AU015-FIELD-3                                   11670000
118600                  AU015-IX-ACTION-CODE                            11680000
118700                  AU015-FIELD-5                                   11690000
118800                  AU015-IX-GIFT-CARD                              11700000
118900                  AU015-FIELD-7                                   11710000
119000                  AU015-IX-STR-NBR                                11720000
119100                  AU015-IX-RGST-ID                                11730000
119200                  AU015-IX-TRAN-TYP-REQ                           11740000
119300                  AU015-FIELD-11                                  11750000
119400                  AU015-FIELD-12                                  11760000
119500                  AU015-IX-CARD                                   11770000
119600                  AU015-IX-EXP-DTE                                11780000
119700                  AU015-FIELD-15                                  11790000
119800                  AU015-IX-AMT                                    11800000
119900                  AU015-IX-TRN-NBR                                11810000
120000                  AU015-FIELD-18                                  11820000
120100                  AU015-FIELD-19                                  11830000
120200                  AU015-FIELD-20                                  11840000
120300                  AU015-IX-BARCODE                                11850000
120400                  AU015-IX-UPC-NBR                                11860000
120500                  AU015-FIELD-23                                  11870000
120600                  AU015-FIELD-24                                  11880000
120700                  AU015-FIELD-25                                  11890000
120800                  AU015-FIELD-26                                  11900000
120900                  AU015-FIELD-27                                  11910000
121000                  AU015-FIELD-28                                  11920000
121100                  AU015-FIELD-29                                  11930000
121200                  AU015-FIELD-30                                  11940000
121300                  AU015-FIELD-31                                  11950000
121400                  AU015-FIELD-32                                  11960000
121500                  AU015-FIELD-33                                  11970000
121600                  AU015-FIELD-34                                  11980000
121700                  AU015-FIELD-35                                  11990000
121800                  AU015-FIELD-36                                  12000000
121900                  AU015-IX-AUTH-CODE                              12010000
122000                  AU015-FIELD-38                                  12020000
122100                  AU015-FIELD-39                                  12030000
122200                  AU015-FIELD-40                                  12040000
122300                  AU015-FIELD-41                                  12050000
122400                  AU015-FIELD-42                                  12060000
122500                  AU015-FIELD-43                                  12070000
122600                  AU015-FIELD-44                                  12080000
122700                  AU015-FIELD-45                                  12090000
122800                  AU015-IX-REF-NBR                                12100000
122900                  AU015-FIELD-47                                  12110000
123000                  AU015-FIELD-48                                  12120000
123100                  AU015-FIELD-49                                  12130000
123200                  AU015-IX-DATE                                   12140000
123300                  AU015-IX-TIME                                   12150000
123400                  AU015-FIELD-52                                  12160000
123500                  AU015-IX-RESP-CDE                               12170000
123600                  AU015-FIELD-54                                  12180000
123700                  AU015-FIELD-55                                  12190000
123800                  AU015-FIELD-56                                  12200000
123900                  AU015-FIELD-57                                  12210000
124000                  AU015-FIELD-58                                  12220000
124100                  AU015-FIELD-59                                  12230000
124200                  AU015-FIELD-60                                  12240000
124300                  AU015-FIELD-61                                  12250000
124400                  AU015-FIELD-62                                  12260000
124500                  AU015-FIELD-63                                  12270000
124600                  AU015-FIELD-64                                  12280000
124700                  AU015-FIELD-65                                  12290000
124800                  AU015-FIELD-66                                  12300000
124900                  AU015-FIELD-67                                  12310000
125000                  AU015-FIELD-68                                  12320000
125100                  AU015-FIELD-69                                  12330000
125200                  AU015-FIELD-70                                  12340000
125300                  AU015-FIELD-71                                  12350000
125400                  AU015-FIELD-72                                  12360000
125500                  AU015-FIELD-73                                  12370000
125600                  AU015-FIELD-74                                  12380000
125700                  AU015-FIELD-75                                  12390000
125800                  AU015-FIELD-76                                  12400000
125900                  AU015-FIELD-77                                  12410000
126000                  AU015-FIELD-78                                  12420000
126100                  AU015-FIELD-79                                  12430000
126200                  AU015-FIELD-80                                  12440000
126300                  AU015-FIELD-81                                  12450000
126400                  AU015-IX-RECEIPT-DISP                           12460000
126500                  AU015-FIELD-83                                  12470000
126600                  AU015-FIELD-84                                  12480000
126700                  AU015-FIELD-85                                  12490000
126800                  AU015-FIELD-86                                  12500000
126900                  AU015-FIELD-87                                  12510000
127000                  AU015-FIELD-88                                  12520000
127100                  AU015-FIELD-89                                  12530000
127200                  AU015-FIELD-90                                  12540000
127300                  AU015-FIELD-91                                  12550000
127400                  AU015-FIELD-92                                  12560000
127500                  AU015-FIELD-93                                  12570000
127600                  AU015-FIELD-94                                  12580000
127700                  AU015-FIELD-95                                  12590000
127800                  AU015-FIELD-96                                  12600000
127900                  AU015-FIELD-97                                  12610000
128000                  AU015-FIELD-98                                  12620000
128100                  AU015-FIELD-99                                  12630000
128200                  AU015-FIELD-100                                 12640000
128300                  AU015-FIELD-101                                 12650000
128400                  AU015-FIELD-102                                 12660000
128500                  AU015-FIELD-103                                 12670000
128600                  AU015-FIELD-104                                 12680000
128700                  AU015-FIELD-105                                 12690000
128800                  AU015-FIELD-106                                 12700000
128900                  AU015-FIELD-107                                 12710000
129000                  AU015-FIELD-108                                 12720000
129100                  AU015-FIELD-109.                                12730000
129200                                                                  12740000
129300*-----------------------------------------------------------------12750000
129400*  SELECT THE LAST AUTH FIRST THAT WAS CREATED FOR THE CARD      *12760000
129500*-----------------------------------------------------------------12770000
129600 8550-SELECT-AUTH.                                                12780000
129700                                                                  12790000
129800     EXEC SQL                                                     12800000
129900         SELECT MAX(CRE_TMST)                                     12810000
130000         INTO  :PV-CRE-TMST                                       12820000
130100         FROM  GCT_VND_AUTH                                       12830000
130200         WHERE CRD_ACCT_NBR = :PV-CRD-NBR                         12840000
130300     END-EXEC.                                                    12850000
130400                                                                  12860000
130500     EVALUATE TRUE                                                12870000
130600         WHEN SQLCODE = -305                                      12880000
130700             MOVE SPACES TO PV-CRE-TMST                           12890000
130800         WHEN SQLCODE = -803                                      12900000
130900             CONTINUE                                             12910000
131000         WHEN SQLCODE = -805                                      12920000
131100             CONTINUE                                             12930000
131200         WHEN SQLCODE = -811                                      12940000
131300             CONTINUE                                             12950000
131400         WHEN SQLCODE = -911                                      12960000
131500         WHEN SQLCODE = -913                                      12970000
131600         WHEN SQLCODE < ZERO                                      12980000
131700             MOVE 'SELECT THE AUTH RESPONSE CODE'                 12990000
131800                             TO AA-ATTEMPTED-ACTION               13000000
131900             MOVE PV-CRD-NBR TO AC-ATTEMPTED-ACTION               13010000
132000             PERFORM 9100-DB2-ERROR                               13020000
132100             PERFORM 9999-RETURN-TO-NATIVE-CICS                   13030000
132200         WHEN SQLCODE > ZERO                                      13040000
132300         WHEN SQLWARN0 NOT = SPACES                               13050000
132400             MOVE 'SELECT THE AUTH RESPONSE CODE'                 13060000
132500                             TO AA-ATTEMPTED-ACTION               13070000
132600             MOVE PV-CRD-NBR TO AC-ATTEMPTED-ACTION               13080000
132700             PERFORM 9200-DB2-WARNING                             13090000
132800             PERFORM 9999-RETURN-TO-NATIVE-CICS                   13100000
132900         WHEN OTHER                                               13110000
133000             CONTINUE                                             13120000
133100     END-EVALUATE.                                                13130000
133200                                                                  13140000
134000*-----------------------------------------------------------------13150000
134100*  UPDATE INTO GCT_VND_AUTH TABLE WITH THE RESPONSE              *13160000
134200*-----------------------------------------------------------------13170000
134300 8600-UPDATE-AUTH-TABLE.                                          13180000
134400                                                                  13190000
134500     MOVE AU015-IX-AUTH-CODE     TO GCT00004-VND-AUTH-NBR.        13200000
134600                                                                  13210000
134700     IF AU015-IX-RESP-CDE = 'OFFLINE' OR                          13220000
134800        AU015-IX-RESP-CDE = 'OF' OR                               13230000
134900        AU015-IX-RESP-CDE = '  '                                  13240000
135000         MOVE '74' TO GCT00004-VND-AUTH-RSPN-CDE                  13250000
135100     ELSE                                                         13260000
135200         MOVE AU015-IX-RESP-CDE TO GCT00004-VND-AUTH-RSPN-CDE     13270000
135300     END-IF.                                                      13280000
135400                                                                  13290000
135500     IF AU015-IX-AUTH-CODE = 'CALL  '                             13300000
135600         MOVE SPACES TO GCT00004-VND-AUTH-NBR                     13310000
135700     END-IF.                                                      13320000
135800                                                                  13330000
135900     EXEC SQL                                                     13340000
136000         UPDATE GCT_VND_AUTH                                      13350000
136100            SET LAST_UPD_TMST     =  CURRENT TIMESTAMP            13360000
136200              , VND_AUTH_NBR      = :GCT00004-VND-AUTH-NBR        13370000
136300              , VND_AUTH_RSPN_CDE = :GCT00004-VND-AUTH-RSPN-CDE   13380000
136400            WHERE CRD_ACCT_NBR    = :PV-CRD-NBR                   13390000
136500            AND   CRE_TMST        = :PV-CRE-TMST                  13400000
136600     END-EXEC.                                                    13410000
136700                                                                  13420000
136800     EVALUATE TRUE                                                13430000
136900         WHEN SQLCODE = -911                                      13440000
137000         WHEN SQLCODE = -913                                      13450000
137100         WHEN SQLCODE < ZERO                                      13460000
137200             MOVE 'UPDATE THE AUTH RESPONSE CODE'                 13470000
137300                             TO AA-ATTEMPTED-ACTION               13480000
137400             PERFORM 9100-DB2-ERROR                               13490000
137500             PERFORM 9999-RETURN-TO-NATIVE-CICS                   13500000
137600         WHEN SQLCODE > ZERO                                      13510000
137700         WHEN SQLWARN0 NOT = SPACES                               13520000
137800             MOVE 'UPDATE THE AUTH RESPONSE CODE'                 13530000
137900                             TO AA-ATTEMPTED-ACTION               13540000
138000             PERFORM 9200-DB2-WARNING                             13550000
138100             PERFORM 9999-RETURN-TO-NATIVE-CICS                   13560000
138200         WHEN OTHER                                               13570000
138300             CONTINUE                                             13580000
138400     END-EVALUATE.                                                13590000
138500                                                                  13600000
138600*-----------------------------------------------------------------13610000
138700*  UPDATE INTO GCT_VND_AUTH TABLE WITH THE OFFLINE RESPONSE      *13620000
138800*-----------------------------------------------------------------13630000
138900 8650-UPDATE-AUTH-TABLE.                                          13640000
139000                                                                  13650000
139100     MOVE SPACES  TO GCT00004-VND-AUTH-NBR.                       13660000
139200     MOVE 'F99'   TO GCT00004-VND-AUTH-RSPN-CDE.                  13670000
139300                                                                  13680000
139400     EXEC SQL                                                     13690000
139500         UPDATE GCT_VND_AUTH                                      13700000
139600            SET LAST_UPD_TMST     =  CURRENT TIMESTAMP            13710000
139700              , VND_AUTH_NBR      = :GCT00004-VND-AUTH-NBR        13720000
139800              , VND_AUTH_RSPN_CDE = :GCT00004-VND-AUTH-RSPN-CDE   13730000
139900            WHERE CRD_ACCT_NBR    = :PV-CRD-NBR                   13740000
140000            AND   CRE_TMST        = :PV-CRE-TMST                  13750000
140100     END-EXEC.                                                    13760000
140200                                                                  13770000
140300     EVALUATE TRUE                                                13780000
140400         WHEN SQLCODE = -911                                      13790000
140500         WHEN SQLCODE = -913                                      13800000
140600         WHEN SQLCODE < ZERO                                      13810000
140700             MOVE 'UPDATE THE AUTH RESPONSE CODE-F99'             13820000
140800                             TO AA-ATTEMPTED-ACTION               13830000
140900             PERFORM 9100-DB2-ERROR                               13840000
141000             PERFORM 9999-RETURN-TO-NATIVE-CICS                   13850000
141100         WHEN SQLCODE > ZERO                                      13860000
141200         WHEN SQLWARN0 NOT = SPACES                               13870000
141300             MOVE 'UPDATE THE AUTH RESPONSE CODE-F99'             13880000
141400                             TO AA-ATTEMPTED-ACTION               13890000
141500             PERFORM 9200-DB2-WARNING                             13900000
141600             PERFORM 9999-RETURN-TO-NATIVE-CICS                   13910000
141700         WHEN OTHER                                               13920000
141800             CONTINUE                                             13930000
141900     END-EVALUATE.                                                13940000
142000                                                                  13950000
142100*-----------------------------------------------------------------13960000
142200*  COMMIT FOR GFT_VND_AUTH_TBL                                   *13970000
142300*-----------------------------------------------------------------13980000
142400 8700-COMMIT-CHANGES.                                             13990000
142500     EXEC CICS                                                    14000000
142600         SYNCPOINT                                                14010000
142700     END-EXEC.                                                    14020000
142800                                                                  14030000
142900     EVALUATE TRUE                                                14040000
143000         WHEN SQLCODE = ZERO                                      14050000
143100             CONTINUE                                             14060000
143200         WHEN SQLCODE > ZERO                                      14070000
143300         WHEN SQLCODE < ZERO                                      14080000
143400             MOVE '8700-COMMIT-CHANGES' TO AA-ATTEMPTED-ACTION    14090000
143500             PERFORM 9100-DB2-ERROR                               14100000
143600     END-EVALUATE.                                                14110000
143610                                                                  14120000
161200*-----------------------------------------------------------------14130000
161300*  DB2 ABEND PROCESSING                                           14140000
161400*-----------------------------------------------------------------14150000
161500 9100-DB2-ERROR.                                                  14160000
161600                                                                  14170000
161700     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   14180000
161800     STRING 'DB2 ERROR '                 DELIMITED BY SIZE        14190000
161900                 INTO  EP000-MD-SYSTEM-LOG-MESSAGE                14200000
162000                           (EP000-MESSAGE-LINE-COUNTER).          14210000
162100     PERFORM EP000-1000-POST-MESSAGE.                             14220000
162200     MOVE SQLCODE TO DE-SQLCODE.                                  14230000
162300     MOVE SQLERRD(3) TO DE-ROWS-PROCESSED.                        14240000
162400     MOVE DE-DB2-ERROR-MESSAGE TO PV-ERROR-MESSAGE-1.             14250000
162500     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   14260000
162600     STRING  PV-ERROR-MESSAGE-1          DELIMITED BY SIZE        14270000
162700                 INTO  EP000-MD-SYSTEM-LOG-MESSAGE                14280000
162800                           (EP000-MESSAGE-LINE-COUNTER).          14290000
162900     PERFORM EP000-1000-POST-MESSAGE.                             14300000
163000                                                                  14310000
163100     MOVE SQLERRMC TO DS-SQLERRMC.                                14320000
163200     MOVE DS-DB2-SQLERRMC-MESSAGE TO                              14330000
163300         PV-ERROR-MESSAGE-2.                                      14340000
163400     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   14350000
163500     STRING  PV-ERROR-MESSAGE-2          DELIMITED BY SIZE        14360000
163600                 INTO  EP000-MD-SYSTEM-LOG-MESSAGE                14370000
163700                           (EP000-MESSAGE-LINE-COUNTER).          14380000
163800     PERFORM EP000-1000-POST-MESSAGE.                             14390000
163900                                                                  14400000
164000     MOVE AA-ATTEMPTED-ACTION-MESSAGE TO                          14410000
164100         PV-ERROR-MESSAGE-3.                                      14420000
164200     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   14430000
164300     STRING  PV-ERROR-MESSAGE-3          DELIMITED BY SIZE        14440000
164400                 INTO  EP000-MD-SYSTEM-LOG-MESSAGE                14450000
164500                           (EP000-MESSAGE-LINE-COUNTER).          14460000
164600     PERFORM EP000-1000-POST-MESSAGE.                             14470000
164700                                                                  14480000
164800     MOVE AC-ATTEMPTED-ACTION-MESSAGE TO                          14490000
164900         PV-ERROR-MESSAGE-4.                                      14500000
165000     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   14510000
165100     STRING  PV-ERROR-MESSAGE-4          DELIMITED BY SIZE        14520000
165200                 INTO  EP000-MD-SYSTEM-LOG-MESSAGE                14530000
165300                           (EP000-MESSAGE-LINE-COUNTER).          14540000
165400     PERFORM EP000-1000-POST-MESSAGE.                             14550000
165500                                                                  14560000
165600     EXEC CICS                                                    14570000
165700         SYNCPOINT                                                14580000
165800             ROLLBACK                                             14590000
165900     END-EXEC.                                                    14600000
166000                                                                  14610000
166100*-----------------------------------------------------------------14620000
166200*  FORMAT AND POST INFORMATION RELATIVE TO A DB2 WARNING.  ROLL  *14630000
166300*  BACK ALL RESOURCES.                                           *14640000
166400*-----------------------------------------------------------------14650000
166500 9200-DB2-WARNING.                                                14660000
166600                                                                  14670000
166700     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   14680000
166800     STRING 'DB2 ERROR '                 DELIMITED BY SIZE        14690000
166900                 INTO  EP000-MD-SYSTEM-LOG-MESSAGE                14700000
167000                           (EP000-MESSAGE-LINE-COUNTER).          14710000
167100     PERFORM EP000-1000-POST-MESSAGE.                             14720000
167200                                                                  14730000
167300     MOVE SQLCODE TO DW-SQLCODE.                                  14740000
167400     MOVE SQLERRD(3) TO DW-ROWS-PROCESSED.                        14750000
167500     MOVE SQLWARN TO DW-SQLWARN.                                  14760000
167600     MOVE DW-DB2-WARNING-MESSAGE TO PV-ERROR-MESSAGE-1.           14770000
167700     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   14780000
167800     STRING  PV-ERROR-MESSAGE-1          DELIMITED BY SIZE        14790000
167900                 INTO  EP000-MD-SYSTEM-LOG-MESSAGE                14800000
168000                           (EP000-MESSAGE-LINE-COUNTER).          14810000
168100     PERFORM EP000-1000-POST-MESSAGE.                             14820000
168200                                                                  14830000
168300     MOVE SQLERRMC TO DS-SQLERRMC.                                14840000
168400     MOVE DS-DB2-SQLERRMC-MESSAGE TO                              14850000
168500         PV-ERROR-MESSAGE-2.                                      14860000
168600     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   14870000
168700     STRING  PV-ERROR-MESSAGE-2          DELIMITED BY SIZE        14880000
168800                 INTO  EP000-MD-SYSTEM-LOG-MESSAGE                14890000
168900                           (EP000-MESSAGE-LINE-COUNTER).          14900000
169000     PERFORM EP000-1000-POST-MESSAGE.                             14910000
169100                                                                  14920000
169200     MOVE AA-ATTEMPTED-ACTION-MESSAGE TO                          14930000
169300         PV-ERROR-MESSAGE-3.                                      14940000
169400     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   14950000
169500     STRING  PV-ERROR-MESSAGE-3          DELIMITED BY SIZE        14960000
169600                 INTO  EP000-MD-SYSTEM-LOG-MESSAGE                14970000
169700                           (EP000-MESSAGE-LINE-COUNTER).          14980000
169800     PERFORM EP000-1000-POST-MESSAGE.                             14990000
169900     MOVE AC-ATTEMPTED-ACTION-MESSAGE TO                          15000000
170000         PV-ERROR-MESSAGE-4.                                      15010000
170100     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   15020000
170200     STRING  PV-ERROR-MESSAGE-4          DELIMITED BY SIZE        15030000
170300                 INTO  EP000-MD-SYSTEM-LOG-MESSAGE                15040000
170400                           (EP000-MESSAGE-LINE-COUNTER).          15050000
170500     PERFORM EP000-1000-POST-MESSAGE.                             15060000
170600                                                                  15070000
170700     EXEC CICS                                                    15080000
170800         SYNCPOINT                                                15090000
170900             ROLLBACK                                             15100000
171000     END-EXEC.                                                    15110000
171010                                                                  15120000
171100* -------------------------------------------------------------- *15130000
171200*    CONNECT TO THE QUEUE MANAGER                                 15140000
171300* -------------------------------------------------------------- *15150000
171400 9250-CONNECT-TO-Q-MNGR.                                          15160000
171500                                                                  15170000
171600     CALL PC-MQCONN USING PC-QM-NAME                              15180000
171700                          PV-CONNECT-HANDLE                       15190000
171800                          PV-COMPLETION-CODE                      15200000
171900                          PV-REASON.                              15210000
172000*                                                                 15220000
172100*    If connection fails display error message and exit.          15230000
172200*                                                                 15240000
172300     MOVE PV-REASON TO PV-CONNECT-REASON.                         15250000
172400     IF (PV-COMPLETION-CODE NOT = MQCC-OK) THEN                   15260000
172500         SET PE-MQ-CONNECT TO TRUE                                15270000
172600         MOVE PV-COMPLETION-CODE TO PV-DISPLAY-COMP-CODE          15280000
172700         MOVE PV-DISPLAY-COMP-CODE TO PE-MQ-COMPLETION-CODE       15290000
172800         MOVE PV-REASON TO PV-DISPLAY-REASON                      15300000
172900         MOVE PE-MQ-ERROR-NUMBER TO EP000-SL-PI-MESSAGE-NUMBER    15310000
173000         SET EP000-SL-ERROR  TO  TRUE                             15320000
173100         MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                15330000
173200         MOVE PE-MQ-ERROR-MESSAGE TO                              15340000
173300                    EP000-MD-SYSTEM-LOG-MESSAGE                   15350000
173400                    (EP000-MESSAGE-LINE-COUNTER)                  15360000
173600         PERFORM EP000-1000-POST-MESSAGE                          15370000
173700         PERFORM 9999-RETURN-TO-NATIVE-CICS                       15380000
173800     END-IF.                                                      15390000
173900                                                                  15400000
174000* -------------------------------------------------------------- *15410000
174100*    Open the queue for input                                     15420000
174200* -------------------------------------------------------------- *15430000
174300 9300-OPEN-THIRDPTY-AUTH-Q.                                       15440000
174400                                                                  15450000
174500     COMPUTE PV-OPEN-OPTIONS = MQOO-OUTPUT +                      15460000
174600                               MQOO-FAIL-IF-QUIESCING.            15470000
174700     MOVE PV-QMGR-NAME        TO MQOD-OBJECTNAME.                 15480000
174800     MOVE PC-QM-NAME          TO MQOD-OBJECTQMGRNAME.             15490000
174900*                                                                 15500000
175000     CALL PC-MQOPEN USING PV-CONNECT-HANDLE                       15510000
175100                          MQM-OBJECT-DESCRIPTOR                   15520000
175200                          PV-OPEN-OPTIONS                         15530000
175300                          PV-PQ-HANDLE                            15540000
175400                          PV-COMPLETION-CODE                      15550000
175500                          PV-REASON.                              15560000
175600*                                                                 15570000
175700*    If open fails log error message and exit.                    15580000
175800*                                                                 15590000
175900     IF (PV-COMPLETION-CODE NOT = MQCC-OK) THEN                   15600000
176000         SET PE-MQ-OPEN TO TRUE                                   15610000
176100         MOVE PV-COMPLETION-CODE TO PV-DISPLAY-COMP-CODE          15620000
176200         MOVE PV-DISPLAY-COMP-CODE TO PE-MQ-COMPLETION-CODE       15630000
176300         MOVE PV-REASON TO PV-DISPLAY-REASON                      15640000
176400         MOVE PV-DISPLAY-REASON TO PE-MQ-REASON-CODE              15650000
176600         MOVE PE-MQ-ERROR-NUMBER TO EP000-SL-PI-MESSAGE-NUMBER    15660000
176700         SET EP000-SL-ERROR  TO  TRUE                             15670000
176800         MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                15680000
176900         MOVE PE-MQ-ERROR-MESSAGE TO                              15690000
177000                    EP000-MD-SYSTEM-LOG-MESSAGE                   15700000
177100                    (EP000-MESSAGE-LINE-COUNTER)                  15710000
177300         PERFORM EP000-1000-POST-MESSAGE                          15720000
177400         PERFORM 9600-DISCONNECT-FROM-Q-MNGR                      15730000
177500         PERFORM 9999-RETURN-TO-NATIVE-CICS                       15740000
177600     END-IF.                                                      15750000
177700                                                                  15760000
177800* ------------------------------------------------------------- * 15770000
177900* MOVE THE FIELDS TO THE QUEUE                                    15780000
178000* ------------------------------------------------------------- * 15790000
178100 9350-MOVE-FIELDS-TO-QUEUE.                                       15800000
178200                                                                  15810000
178300      MOVE ZEROES                   TO SA051-PARTN-NBR.           15820000
178400      MOVE PV-HD-SLS-DTE            TO SA051-SLS-DTE.             15830000
178500      MOVE PV-HD-CARD-NBR           TO SA051-CARD-NBR.            15840000
178600      MOVE PV-HD-STR-NBR            TO SA051-STR-NBR.             15850000
178700      MOVE PV-HD-RGST-ID            TO SA051-RGST-ID.             15860000
178800      MOVE PV-HD-TRN-NBR            TO SA051-TRN-NBR.             15870000
178900      MOVE PV-HD-STRT-TM            TO SA051-STRT-TM.             15880000
179000      MOVE ZEROES                   TO SA051-SLS-CORR-SEQ-NBR.    15890000
179100      MOVE PV-HD-LNE-ITM-SEQ-NBR    TO SA051-LNE-ITM-SEQ-NBR.     15900000
179200      MOVE PV-HD-CUST-CHRGD-AMT     TO SA051-CUST-CHRGD-AMT.      15910000
179300      MOVE 'S'                      TO SA051-SAF-CDE.             15920000
179400                                                                  15930000
179500      MOVE SA051-CARD-INFO    TO PV-PUT-MESSAGE-BUFFER.           15940000
179501                                                                  15950000
179700* ------------------------------------------------------------- * 15960000
179800* PUT MESSAGE ON LOCAL QUEUE                                      15970000
179900* ------------------------------------------------------------- * 15980000
180000 9400-MQPUT-MSG.                                                  15990000
180100                                                                  16000000
180200     MOVE SA051-BLKHAWK-FIELDS TO PV-BLKHAWK-DATA.                16010000
180300     MOVE SA051-CARD-LENGTH    TO PV-PUT-MSG-BUFFER-LENGTH.       16020000
180400                                                                  16030000
180500     COMPUTE MQPMO-OPTIONS = MQPMO-SYNCPOINT.                     16040000
180600                                                                  16050000
180700     MOVE PC-QM-NAME          TO MQOD-OBJECTQMGRNAME.             16060000
180800     MOVE PV-QMGR-NAME        TO MQOD-OBJECTNAME.                 16070000
180900     MOVE PV-BLKHAWK-FEED     TO PV-MSGBUFFER.                    16080000
181000     MOVE MQPER-PERSISTENT    TO MQMD-PERSISTENCE.                16090000
181100                                                                  16100000
181200     CALL PC-MQPUT USING PV-CONNECT-HANDLE                        16110000
181300                         PV-PQ-HANDLE                             16120000
181400                         MQM-MESSAGE-DESCRIPTOR                   16130000
181500                         MQM-PUT-MESSAGE-OPTIONS                  16140000
181600                         PV-PUT-MSG-BUFFER-LENGTH                 16150000
181700                         PV-MSGBUFFER                             16160000
181800                         PV-COMPLETION-CODE                       16170000
181900                         PV-REASON.                               16180000
182000                                                                  16190000
182100     IF (PV-COMPLETION-CODE = MQCC-FAILED)                        16200000
182200         IF (PV-REASON NOT = MQRC-NO-MSG-AVAILABLE)               16210000
182300             SET PE-MQ-PUT TO TRUE                                16220000
182400             MOVE PV-COMPLETION-CODE TO PV-DISPLAY-COMP-CODE      16230000
182500             MOVE PV-DISPLAY-COMP-CODE TO PE-MQ-COMPLETION-CODE   16240000
182600             MOVE PV-REASON TO PV-DISPLAY-REASON                  16250000
182700             MOVE PV-DISPLAY-REASON TO PE-MQ-REASON-CODE          16260000
182800             MOVE PE-MQ-ERROR-NUMBER TO                           16270000
182900                                     EP000-SL-PI-MESSAGE-NUMBER   16280000
183000             SET EP000-SL-ERROR  TO  TRUE                         16290000
183100             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            16300000
183200             MOVE PE-MQ-ERROR-MESSAGE TO                          16310000
183300                        EP000-MD-SYSTEM-LOG-MESSAGE               16320000
183400                        (EP000-MESSAGE-LINE-COUNTER)              16330000
183410             PERFORM EP000-1000-POST-MESSAGE                      16340000
183420         END-IF                                                   16350000
183430         PERFORM 9500-CLOSE-THIRDPTY-AUTH-Q                       16360000
183440         PERFORM 9600-DISCONNECT-FROM-Q-MNGR                      16370000
183450         PERFORM 9999-RETURN-TO-NATIVE-CICS                       16380000
183475     END-IF.                                                      16390000
183476                                                                  16400000
183480     INITIALIZE PV-BLKHAWK-FEED.                                  16410000
183490     INITIALIZE SA051-BLKHAWK-FIELDS.                             16420000
183491                                                                  16430000
183600* -------------------------------------------------------------- *16440000
183700*    CLOSE THE THIRDPTY AUTH QUEUE                                16450000
183800* -------------------------------------------------------------- *16460000
183900 9500-CLOSE-THIRDPTY-AUTH-Q.                                      16470000
184000                                                                  16480000
184100     CALL PC-MQCLOSE USING PV-CONNECT-HANDLE                      16490000
184200                           PV-PQ-HANDLE                           16500000
184300                           MQCO-NONE                              16510000
184400                           PV-COMPLETION-CODE                     16520000
184500                           PV-REASON.                             16530000
184600     IF (PV-COMPLETION-CODE NOT = MQCC-OK) THEN                   16540000
184700         SET PE-MQ-CLOSE TO TRUE                                  16550000
184800         MOVE PV-COMPLETION-CODE TO PV-DISPLAY-COMP-CODE          16560000
184900         MOVE PV-DISPLAY-COMP-CODE TO PE-MQ-COMPLETION-CODE       16570000
185000         MOVE PV-REASON TO PV-DISPLAY-REASON                      16580000
185100         MOVE PV-DISPLAY-REASON TO PE-MQ-REASON-CODE              16590000
185300         MOVE PE-MQ-ERROR-NUMBER TO  EP000-SL-PI-MESSAGE-NUMBER   16600000
185400         SET EP000-SL-ERROR  TO  TRUE                             16610000
185500         MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                16620000
185600         MOVE PE-MQ-ERROR-MESSAGE TO                              16630000
185700                    EP000-MD-SYSTEM-LOG-MESSAGE                   16640000
185800                    (EP000-MESSAGE-LINE-COUNTER)                  16650000
185900                                                                  16660000
186000         PERFORM EP000-1000-POST-MESSAGE                          16670000
186100         PERFORM 9600-DISCONNECT-FROM-Q-MNGR                      16680000
186200         PERFORM 9999-RETURN-TO-NATIVE-CICS                       16690000
186300     END-IF.                                                      16700000
186400                                                                  16710000
186500*----------------------------------------------------------------*16720000
186600*  DISCONNECT FROM THE MQ MANAGER                                *16730000
186700*----------------------------------------------------------------*16740000
186800 9600-DISCONNECT-FROM-Q-MNGR.                                     16750000
186900                                                                  16760000
187000*    Disconnect from the queue manager                            16770000
187100                                                                  16780000
187200     IF PV-CONNECT-REASON IS NOT EQUAL TO MQRC-ALREADY-CONNECTED  16790000
187300         CALL PC-MQDISC USING PV-CONNECT-HANDLE                   16800000
187400                              PV-COMPLETION-CODE                  16810000
187500                              PV-REASON                           16820000
187600         IF (PV-COMPLETION-CODE NOT = MQCC-OK) THEN               16830000
187700             SET PE-MQ-DISCONNECT TO TRUE                         16840000
187800             MOVE PV-COMPLETION-CODE TO PV-DISPLAY-COMP-CODE      16850000
187900             MOVE PV-DISPLAY-COMP-CODE TO PE-MQ-COMPLETION-CODE   16860000
188000             MOVE PV-REASON      TO PV-DISPLAY-REASON             16870000
188100             MOVE PV-DISPLAY-REASON TO PE-MQ-REASON-CODE          16880000
188300             MOVE PE-MQ-ERROR-NUMBER TO                           16890000
188400                                     EP000-SL-PI-MESSAGE-NUMBER   16900000
188500             SET EP000-SL-ERROR  TO  TRUE                         16910000
188600             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            16920000
188700             MOVE PE-MQ-ERROR-MESSAGE TO                          16930000
188800                        EP000-MD-SYSTEM-LOG-MESSAGE               16940000
188900                        (EP000-MESSAGE-LINE-COUNTER)              16950000
189000             PERFORM EP000-1000-POST-MESSAGE                      16960000
189100             PERFORM 9999-RETURN-TO-NATIVE-CICS                   16970000
189200         END-IF                                                   16980000
189300     END-IF.                                                      16990000
189400                                                                  17000000
189410******************************************************************17010000
189420* COMMIT MQ                                                       17020000
189430******************************************************************17030000
189440 9700-COMMIT-MQ.                                                  17040000
189450                                                                  17050000
189460     CALL PC-MQCMIT USING PV-CONNECT-HANDLE                       17060000
189470                          PV-COMPLETION-CODE                      17070000
189480                          PV-REASON.                              17080000
189490                                                                  17090000
189491     IF (PV-COMPLETION-CODE NOT = MQCC-OK) THEN                   17100000
189492         SET PE-MQ-DISCONNECT TO TRUE                             17110000
189493         MOVE PV-COMPLETION-CODE TO PV-DISPLAY-COMP-CODE          17120000
189494         MOVE PV-DISPLAY-COMP-CODE TO PE-MQ-COMPLETION-CODE       17130000
189495         MOVE PV-REASON      TO PV-DISPLAY-REASON                 17140000
189496         MOVE PV-DISPLAY-REASON TO PE-MQ-REASON-CODE              17150000
189498         MOVE PE-MQ-ERROR-NUMBER TO EP000-SL-PI-MESSAGE-NUMBER    17160000
189500         SET EP000-SL-ERROR  TO  TRUE                             17170000
189501         MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                17180000
189502         MOVE PE-MQ-ERROR-MESSAGE TO                              17190000
189503                        EP000-MD-SYSTEM-LOG-MESSAGE               17200000
189504                        (EP000-MESSAGE-LINE-COUNTER)              17210000
189505         PERFORM EP000-1000-POST-MESSAGE                          17220000
189506         PERFORM 9999-RETURN-TO-NATIVE-CICS                       17230000
189507     END-IF.                                                      17240000
189514                                                                  17250000
189520*-----------------------------------------------------------------17260000
189600*  SEND A MESSAGE TO NETCOOL                                      17270000
189700*-----------------------------------------------------------------17280000
189800 9900-POST-NETCOOL-ALERT.                                         17290000
189900     SET IS003-CICS                                               17300000
190000         IS003-VERSION-1                                          17310000
190100         IS003-PROBLEM-ALERT                                      17320000
190200         IS003-CRITICAL        TO TRUE.                           17330000
190300                                                                  17340000
190400     MOVE 'AU'                 TO IS003-SYSTEM-ID.                17350000
190500                                                                  17360000
190610     IF PV-CICS-REGION = 'CICSP'                                  17370000
190700         MOVE 'AUTO LAB'       TO IS003-AUTOMATION-LABEL          17380000
190800     ELSE                                                         17390000
190900         MOVE 'CICS TST'       TO IS003-AUTOMATION-LABEL          17400000
191000     END-IF.                                                      17410000
191100                                                                  17420000
191210     IF PV-CICS-REGION = 'CICSP'                                  17430000
191300        CALL IS003-ALERT-PROGRAM                                  17440000
191400           USING DFHEIBLK                                         17450000
191500              IS003-CICS-COMMAREA                                 17460000
191600              IS003-NETCOOL-ALERT                                 17470000
191700        IF NOT IS003-OK                                           17480000
191800           STRING '!ERROR WRITING NETCOOL ALERT. '                17490000
191900                  'NETCOOL RETURN CODE='                          17500000
192000              IS003-RETURN-CODE DELIMITED BY SIZE                 17510000
192100              INTO PV-CICS-MSG-AREA                               17520000
192200           END-STRING                                             17530000
192300                                                                  17540000
192400           PERFORM 9990-WRITE-CICS                                17550000
192500                                                                  17560000
192600        END-IF                                                    17570000
192700     END-IF.                                                      17580000
192800                                                                  17590000
192900*-- WRITE ALL NETCOOL MESSAGES TO THE CICS LOG                    17600000
193000*-- IF NOT IN PRODUCTION, ONLY WRITE NETCOOL MESSAGES             17610000
193100*-- TO THE CICS LOG, NOT TO NETCOOL                               17620000
193200                                                                  17630000
193300     MOVE IS003-SUMMARY       TO PV-CICS-MSG-AREA.                17640000
193400     PERFORM 9990-WRITE-CICS.                                     17650000
193500                                                                  17660000
193600     EXEC CICS                                                    17670000
193700         SYNCPOINT                                                17680000
193800     END-EXEC.                                                    17690000
193900                                                                  17700000
194000*-----------------------------------------------------------------17710000
194100*  WRITE TO CSSL                                                  17720000
194200*-----------------------------------------------------------------17730000
194300 9990-WRITE-CICS.                                                 17740000
194400                                                                  17750000
194500     EXEC CICS                                                    17760000
194600         WRITEQ TD                                                17770000
194700         QUEUE('CSSL')                                            17780000
194800         FROM(PV-CICS-MSG-AREA)                                   17790000
194900         RESP(PV-CICS-RESPONSE)                                   17800000
195000     END-EXEC.                                                    17810000
195100                                                                  17820000
195200     MOVE SPACES TO PV-CICS-MSG-AREA.                             17830000
195300                                                                  17840000
195400*----------------------------------------------------------------*17850000
195500*    ABEND PROCESSOR MODULE                                      *17860000
195600*----------------------------------------------------------------*17870000
195700                                                                  17880000
195800     COPY DPPD013.                                                17890000
195900                                                                  17900000
196000******************************************************************17910000
196100*  TERMINATE THE TRANSACTION.                                    *17920000
196200******************************************************************17930000
196300 9999-RETURN-TO-NATIVE-CICS.                                      17940000
196400                                                                  17950000
196500     EXEC CICS                                                    17960000
196600         RETURN                                                   17970000
196700     END-EXEC.                                                    17980000
196800                                                                  17990000
196900*----------------------------------------------------------------*18000000
197000*  LOG ALERT/ERROR ROUTINE.                                       18010000
197100*----------------------------------------------------------------*18020000
197200     COPY EPPD000.                                                18030000
197300                                                                  18040000
