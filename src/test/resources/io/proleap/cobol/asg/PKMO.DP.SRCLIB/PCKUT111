000100 IDENTIFICATION DIVISION.                                         00010000
000200 TITLE 'EXTRACT CLOSED STORES FOR STORE EXPECTED DELETIONS'       00020000
000300                                                                  00030000
000400 PROGRAM-ID.             PCKUT111.                                00040000
000500 AUTHOR.                 DENISE HAHN.                             00050000
000600 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00060000
000700 DATE-WRITTEN            NOVEMBER 2014.                           00070000
000800 DATE-COMPILED.                                                   00080000
000900                                                                  00090000
001000 ENVIRONMENT DIVISION.                                            00100000
001100 CONFIGURATION SECTION.                                           00110000
001200                                                                  00120000
001300 SOURCE-COMPUTER.        IBM-3090.                                00130000
001400 OBJECT-COMPUTER.        IBM-3090.                                00140000
001500                                                                  00150000
001600 INPUT-OUTPUT SECTION.                                            00160000
001700                                                                  00170000
001800 FILE-CONTROL.                                                    00180000
001900                                                                  00190000
002300     SELECT CLOSED-STORE-FILE                                     00230000
002400         ASSIGN TO OUT01.                                         00240000
002500                                                                  00250000
002900 DATA DIVISION.                                                   00290000
003000 FILE SECTION.                                                    00300000
003001                                                                  00300101
003010 FD  CLOSED-STORE-FILE                                            00301001
003020     RECORDING MODE IS F                                          00302001
003030     LABEL RECORDS ARE STANDARD                                   00303001
003040     BLOCK CONTAINS 0 RECORDS.                                    00304001
003050                                                                  00305000
003060 01  CLOSED-STORE-REC                 PIC X(080).                 00306001
003070                                                                  00307000
003100                                                                  00310000
005300 WORKING-STORAGE SECTION.                                         00530000
005400                                                                  00540000
005500 01  FILLER.                                                      00550000
005600     05  FILLER                      PIC  X(36)    VALUE          00560000
005700         ' ***** WORKING STORAGE PGM=PCKUT111 '.                  00570000
005800                                                                  00580000
005900 01  PS-SWITCHES.                                                 00590000
006000                                                                  00600000
006100     05  PS-END-CSR-SW                PIC X(01) VALUE 'N'.        00610000
006200         88  PS-END-CSR-YES                     VALUE 'Y'.        00620000
006300         88  PS-END-CSR-NO                      VALUE 'N'.        00630000
006400     05  PS-ALL-STORES-SW             PIC X(01) VALUE 'N'.        00640000
006500         88  PS-ALL-STORES-YES                  VALUE 'Y'.        00650000
006600         88  PS-ALL-STORES-NO                   VALUE 'N'.        00660000
006700                                                                  00670000
006800 01  DK-DB2-KEYS.                                                 00680000
006900     05  DK-STORE-LOW                 PIC S9(04) COMP VALUE ZERO. 00690000
007000     05  DK-STORE-HIGH                PIC S9(04) COMP VALUE ZERO. 00700000
007100     05  DK-DTE-OFFSET                PIC S9(04) COMP VALUE ZERO. 00710000
007200     05  DK-LOW-DTE                   PIC X(10) VALUE SPACES.     00720000
007300     05  DK-HIGH-DTE                  PIC X(10) VALUE SPACES.     00730000
007400 01  PC-CONSTANTS.                                                00740000
007500     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00750000
007600                                                   'PCKUT111'.    00760000
007700     05  PC-ILBOABN0                 PIC  X(08)    VALUE          00770000
007800                                                   'ILBOABN0'.    00780000
007900                                                                  00790000
008000 01  PV-MISC-STUFF.                                               00800000
008100     05  PV-DATE                      PIC X(10) VALUE SPACES.     00810000
008200     05  PV-BOOK-DTE-ADJ              PIC X(10) VALUE SPACES.     00820000
008300     05  PV-ABEND-PARAGRAPH           PIC X(30) VALUE SPACES.     00830000
008400     05  PV-DB2-OPERATION-ATTEMPTED   PIC X(60) VALUE SPACE.      00840000
008500     05  PV-SQL-CODE                  PIC 9(04) VALUE ZERO.       00850000
008600     05  PV-ABEND-CODE                PIC S9(04) VALUE ZERO       00860000
008700                                                   COMP SYNC.     00870000
008800     05  PV-WRITE-1-COUNTER           PIC S9(09) COMP-3           00880000
008900                                              VALUE ZERO.         00890000
009000     05  PV-WRITE-2-COUNTER           PIC S9(09) COMP-3           00900000
009100                                              VALUE ZERO.         00910000
009200     05  PV-ABEND-OPERATION           PIC X(20) VALUE SPACES.     00920000
009300     05  PV-ABEND-STRUCTURE-1         PIC X(20) VALUE SPACES.     00930000
009310     05  PV-DISPLAY-SQLCODE           PIC -999  VALUE ZEROES.     00931000
009320     05  PV-PURGE-DAYS                PIC Z(09) VALUE ZEROES.     00932000
009330     05  PV-PURGE-DATE                PIC X(10).                  00933000
009400                                                                  00940000
009500 01  ABEND-CODE                       PIC S9(04)     VALUE +0     00950000
009600                                                     COMP SYNC.   00960000
009700     88  ABEND-4013-DB2-ERROR                        VALUE +4013. 00970000
009800                                                                  00980000
009900*    CLOSED STORE FILE.                                           00990000
010000     COPY PCRD077.                                                01000000
010100                                                                  01010000
010500*    PARM TABLE                                                   01050000
010600     EXEC SQL                                                     01060000
010700         INCLUDE TKRPRPM                                          01070000
010800     END-EXEC.                                                    01080000
010900                                                                  01090000
011500*    XLT_LOC                                                      01150000
011600     EXEC SQL                                                     01160000
011700         INCLUDE XLT00010                                         01170000
011800     END-EXEC.                                                    01180000
011900                                                                  01190000
012000     EXEC SQL                                                     01200000
012100         DECLARE CLO-STR-CSR CURSOR FOR                           01210000
012200         SELECT A.LOC_NBR                                         01220000
012300              , A.CLO_DTE                                         01230000
012400              , B.FUNC_QTY                                        01240000
012500              , (CURRENT DATE - B.FUNC_QTY DAYS)                  01250000
012600           FROM XLT_LOC A                                         01260003
012700              , TKRPRPM B                                         01270003
012800         WHERE A.CLO_DTE <= (CURRENT DATE - B.FUNC_QTY DAYS)      01280000
012900           AND B.LOC_ID             = 90                          01290000
013100           AND B.INTFC_SYS_CDE      = 'KHL'                       01310000
013200           AND B.SYS_PRC_FUNC_CDE   = 'PURG02'                    01320000
013300           AND B.FUNC_PRC_STAT_CDE  = 'AC'                        01330000
013400           AND B.FUNC_BEG_TMST     <= CURRENT TIMESTAMP           01340000
013500           AND B.FUNC_END_TMST     >= CURRENT TIMESTAMP           01350000
013600          WITH UR                                                 01360000
014100                                                                  01410000
015900     END-EXEC.                                                    01590000
016000/                                                                 01600000
016100     EXEC SQL                                                     01610000
016200         INCLUDE SQLCA                                            01620000
016300     END-EXEC.                                                    01630000
016400                                                                  01640000
016500     COPY SQLCA2.                                                 01650000
016600                                                                  01660000
016700     COPY DPWS004.                                                01670000
016800/                                                                 01680000
016900 PROCEDURE DIVISION.                                              01690000
017000                                                                  01700000
017100     PERFORM 1000-INITIALIZATION.                                 01710000
017300     PERFORM 2000-PROCESS                                         01730004
017500     PERFORM 9000-QUIT.                                           01750000
017600     GOBACK.                                                      01760000
017700                                                                  01770000
017800 1000-INITIALIZATION.                                             01780000
017900     MOVE '1000-INITIALIZATION         '  TO PV-ABEND-PARAGRAPH.  01790000
018000                                                                  01800000
018100     DISPLAY SPACES.                                              01810000
018200     DISPLAY SPACES.                                              01820000
018300     DISPLAY 'START PCKUT111'.                                    01830000
018400     DISPLAY SPACES.                                              01840000
018500                                                                  01850000
018800         OPEN OUTPUT                                              01880000
018900              CLOSED-STORE-FILE.                                  01890000
019100                                                                  01910000
020900      DISPLAY 'LOC      CLO'.                                     02090002
021100                                                                  02110000
021300                                                                  02130000
021500 2000-PROCESS.                                                    02150000
021600     PERFORM 7000-OPEN-CSR                                        02160000
021700     PERFORM 7010-FETCH-CSR                                       02170000
021800     PERFORM UNTIL PS-END-CSR-YES                                 02180000
021900        MOVE '2000-PROCESS'              TO PV-ABEND-PARAGRAPH    02190000
022000                                                                  02200000
022100        MOVE XLT00010-LOC-NBR            TO PC077-LOC-NBR         02210000
022200        MOVE XLT00010-CLO-DTE            TO PC077-CLO-DTE         02220000
022300        MOVE PV-PURGE-DATE               TO PC077-PURGE-DATE      02230005
022900                                                                  02290000
023000        PERFORM 8100-WRITE-STORE-REC                              02300000
023100        PERFORM 7010-FETCH-CSR                                    02310000
023200     END-PERFORM                                                  02320000
023300     PERFORM 7020-CLOSE-CSR.                                      02330000
023400/                                                                 02340000
023500 7000-OPEN-CSR.                                                   02350000
023600                                                                  02360000
023700     MOVE '7000-OPEN-CSR'             TO PV-ABEND-PARAGRAPH.      02370000
023800                                                                  02380000
023900     EXEC SQL                                                     02390000
024000         OPEN CLO-STR-CSR                                         02400000
024100     END-EXEC                                                     02410000
024200                                                                  02420000
024300     EVALUATE TRUE                                                02430000
024400         WHEN SQLCODE = ZERO                                      02440000
024500                 CONTINUE                                         02450000
024600         WHEN SQLCODE = -904                                      02460000
024700         WHEN SQLCODE = -911                                      02470000
024800         WHEN SQLCODE = -913                                      02480000
024810             MOVE SQLCODE  TO   PV-DISPLAY-SQLCODE                02481000
024820             DISPLAY '**************************************'     02482000
024840             DISPLAY 'OPEN CURSOR                           '     02484000
024850             DISPLAY '7000-OPEN-CSR                         '     02485000
024860             DISPLAY 'SQLCODE:   PV-DISPLAY-SQLCODE         '     02486000
024870             DISPLAY '**************************************'     02487000
024900             PERFORM 9900-SQL-ERROR                               02490000
025000                                                                  02500000
025100         WHEN (SQLCODE > ZERO OR SQLWARN0 = 'W')                  02510000
025200             MOVE SQLCODE  TO   PV-DISPLAY-SQLCODE                02520000
025210             DISPLAY '**************************************'     02521000
025300             DISPLAY 'WARNING ISSUED '                            02530000
025400             DISPLAY 'OPEN CURSOR                           '     02540000
025410             DISPLAY '7000-OPEN-CSR                         '     02541000
025420             DISPLAY 'SQLCODE:   PV-DISPLAY-SQLCODE         '     02542000
025500             DISPLAY '**************************************'     02550000
025600             PERFORM 9800-SQL-WARNING                             02560000
025700                                                                  02570000
025800         WHEN SQLCODE < ZERO                                      02580000
025810             MOVE SQLCODE  TO   PV-DISPLAY-SQLCODE                02581000
025900             DISPLAY '**************************************'     02590000
026000             DISPLAY 'ERROR ISSUED ON                       '     02600000
026100             DISPLAY 'OPEN CURSOR                           '     02610000
026110             DISPLAY '7000-OPEN-CSR                         '     02611000
026120             DISPLAY 'SQLCODE:   PV-DISPLAY-SQLCODE         '     02612000
026200             DISPLAY '**************************************'     02620000
026300             PERFORM 9900-SQL-ERROR                               02630000
026400                                                                  02640000
026500     END-EVALUATE.                                                02650000
026600                                                                  02660000
026700 7010-FETCH-CSR.                                                  02670000
026800                                                                  02680000
026900     MOVE '7010-FETCH-CSR'          TO PV-ABEND-PARAGRAPH.        02690000
027000                                                                  02700000
027100     EXEC SQL                                                     02710000
027200         FETCH CLO-STR-CSR                                        02720000
027300         INTO                                                     02730000
027400             :XLT00010-LOC-NBR                                    02740000
027500         ,   :XLT00010-CLO-DTE                                    02750000
027600         ,   :KRPRPM-FUNC-QTY                                     02760001
027700         ,   :PV-PURGE-DATE                                       02770000
028000     END-EXEC                                                     02800000
028100                                                                  02810000
028200     EVALUATE TRUE                                                02820000
028300         WHEN SQLCODE = ZERO                                      02830000
028310             MOVE  KRPRPM-FUNC-QTY  TO  PV-PURGE-DAYS             02831001
028400             DISPLAY XLT00010-LOC-NBR '  '                        02840000
028500                     XLT00010-CLO-DTE '  '                        02850000
028510                     'PURGE DAYS:'    '  '                        02851000
028600                     PV-PURGE-DAYS    '  '                        02860000
028700                     'PURGE DATE:'    '  '                        02870000
028800                     PV-PURGE-DATE                                02880000
029000                                                                  02900000
029100         WHEN SQLCODE = +100                                      02910000
029200             SET PS-END-CSR-YES       TO TRUE                     02920000
029300         WHEN SQLCODE = -904                                      02930000
029400         WHEN SQLCODE = -911                                      02940000
029500         WHEN SQLCODE = -913                                      02950000
029510             MOVE SQLCODE  TO   PV-DISPLAY-SQLCODE                02951000
029520             DISPLAY '**************************************'     02952000
029530             DISPLAY 'FETCH CURSOR                          '     02953000
029540             DISPLAY '7010-FETCH-CSR                        '     02954000
029550             DISPLAY 'SQLCODE:   PV-DISPLAY-SQLCODE         '     02955000
029560             DISPLAY '**************************************'     02956000
029600             PERFORM 9900-SQL-ERROR                               02960000
029700                                                                  02970000
029800         WHEN (SQLCODE > ZERO OR SQLWARN0 = 'W')                  02980000
029810             MOVE SQLCODE  TO   PV-DISPLAY-SQLCODE                02981000
029900             DISPLAY '**************************************'     02990000
030000             DISPLAY 'WARNING ISSUED '                            03000000
030100             DISPLAY 'FETCH CURSOR                          '     03010000
030110             DISPLAY '7010-FETCH-CSR                        '     03011000
030200             DISPLAY 'XLT_LOC - TKRPRPM                     '     03020000
030210             DISPLAY 'SQLCODE:   PV-DISPLAY-SQLCODE         '     03021000
030300             DISPLAY '**************************************'     03030000
030400             PERFORM 9800-SQL-WARNING                             03040000
030500                                                                  03050000
030600         WHEN SQLCODE < ZERO                                      03060000
030610             MOVE SQLCODE  TO   PV-DISPLAY-SQLCODE                03061000
030700             DISPLAY '**************************************'     03070000
030800             DISPLAY 'ERROR ISSUED ON                       '     03080000
030900             DISPLAY 'FETCH CURSOR                          '     03090000
030901             DISPLAY '7010-FETCH-CSR                        '     03090100
030910             DISPLAY 'XLT_LOC - TKRPRPM                     '     03091000
030920             DISPLAY 'SQLCODE:   PV-DISPLAY-SQLCODE         '     03092000
031100             DISPLAY '**************************************'     03110000
031200             PERFORM 9900-SQL-ERROR                               03120000
031300                                                                  03130000
031400     END-EVALUATE.                                                03140000
031500                                                                  03150000
031600 7020-CLOSE-CSR.                                                  03160000
031700                                                                  03170000
031800     MOVE '7020-CLOSE-CSR'          TO PV-ABEND-PARAGRAPH.        03180000
031900                                                                  03190000
032000     EXEC SQL                                                     03200000
032100         CLOSE CLO-STR-CSR                                        03210000
032200     END-EXEC                                                     03220000
032300                                                                  03230000
032400     EVALUATE TRUE                                                03240000
032500         WHEN SQLCODE = ZERO                                      03250000
032600                 CONTINUE                                         03260000
032700         WHEN SQLCODE = -904                                      03270000
032800         WHEN SQLCODE = -911                                      03280000
032900         WHEN SQLCODE = -913                                      03290000
032910             MOVE SQLCODE  TO   PV-DISPLAY-SQLCODE                03291000
032920             DISPLAY '**************************************'     03292000
032930             DISPLAY 'CLOSE CURSOR                          '     03293000
032940             DISPLAY '7020-CLOSE-CSR                        '     03294000
032950             DISPLAY 'SQLCODE:   PV-DISPLAY-SQLCODE         '     03295000
032960             DISPLAY '**************************************'     03296000
033000             PERFORM 9900-SQL-ERROR                               03300000
033100                                                                  03310000
033200         WHEN (SQLCODE > ZERO OR SQLWARN0 = 'W')                  03320000
033210             MOVE SQLCODE  TO   PV-DISPLAY-SQLCODE                03321000
033300             DISPLAY '**************************************'     03330000
033400             DISPLAY 'WARNING ISSUED '                            03340000
033500             DISPLAY 'CLOSE CURSOR                          '     03350000
033501             DISPLAY '7020-CLOSE-CSR                        '     03350100
033510             DISPLAY 'SQLCODE:   PV-DISPLAY-SQLCODE         '     03351000
033600             DISPLAY '**************************************'     03360000
033700             PERFORM 9800-SQL-WARNING                             03370000
033800                                                                  03380000
033900         WHEN SQLCODE < ZERO                                      03390000
033910             MOVE SQLCODE  TO   PV-DISPLAY-SQLCODE                03391000
034000             DISPLAY '**************************************'     03400000
034100             DISPLAY 'ERROR ISSUED ON                       '     03410000
034200             DISPLAY 'CLOSE CURSOR                          '     03420000
034201             DISPLAY '7020-CLOSE-CSR                        '     03420100
034210             DISPLAY 'SQLCODE:   PV-DISPLAY-SQLCODE         '     03421000
034300             DISPLAY '**************************************'     03430000
034400             PERFORM 9900-SQL-ERROR                               03440000
034500                                                                  03450000
034600     END-EVALUATE.                                                03460000
034700                                                                  03470000
039600 8100-WRITE-STORE-REC.                                            03960000
039700                                                                  03970000
039800     MOVE '8100-WRITE-STORE-REC'  TO PV-ABEND-PARAGRAPH.          03980000
039900     WRITE                                                        03990000
040000         CLOSED-STORE-REC                                         04000000
040100         FROM PC077-CLO-STORE-REC                                 04010000
040200     END-WRITE.                                                   04020000
040300     ADD 1                            TO PV-WRITE-1-COUNTER.      04030000
040400                                                                  04040000
041400 9000-QUIT.                                                       04140000
041500                                                                  04150000
041600         CLOSE                                                    04160000
041800             CLOSED-STORE-FILE.                                   04180000
042000                                                                  04200000
042100                                                                  04210000
042200     DISPLAY SPACES                                               04220000
042300     DISPLAY 'TOTAL STORES ELIGIBLE FOR PURGING = : '             04230000
042400                                         PV-WRITE-1-COUNTER       04240000
042500     IF PV-WRITE-1-COUNTER = ZERO                                 04250000
042600         MOVE 1                       TO RETURN-CODE              04260000
042700     END-IF                                                       04270000
042800                                                                  04280000
043300     DISPLAY SPACES.                                              04330000
043400                                                                  04340000
043500/                                                                 04350000
043600******************************************************************04360000
043700*  THIS MODULE PERFORMS THE SQL WARNING.                         *04370000
043800******************************************************************04380000
043900                                                                  04390000
044000 9800-SQL-WARNING.                                                04400000
044100                                                                  04410000
044200     MOVE SQLCODE               TO SQLCODE2.                      04420000
044300     MOVE SQLERRD(3)            TO SQLERRD3.                      04430000
044400     DISPLAY '** ABEND **       ** = SQLWARNING'.                 04440000
044500     DISPLAY '** PROGRAM        ** = PCKUT111'.                   04450000
044600     DISPLAY '** PARAGRAPH      ** = ' PV-ABEND-PARAGRAPH.        04460000
044700     DISPLAY '** SQLCODE        ** = ' SQLCODE2.                  04470000
044800     DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                  04480000
044900                                                                  04490000
045000     COPY DPPD004.                                                04500000
045100     SET ABEND-4013-DB2-ERROR   TO TRUE                           04510000
045200     CALL 'ILBOABN0' USING ABEND-CODE.                            04520000
045300/                                                                 04530000
045400******************************************************************04540000
045500* THIS MODULE PERFORMS THE SQL ERROR.                            *04550000
045600******************************************************************04560000
045700                                                                  04570000
045800 9900-SQL-ERROR.                                                  04580000
045900                                                                  04590000
046000     MOVE SQLCODE               TO SQLCODE2.                      04600000
046100     MOVE SQLERRD(3)            TO SQLERRD3.                      04610000
046200     DISPLAY '** ABEND **       ** = SQLERROR'.                   04620000
046300     DISPLAY '** PROGRAM        ** = PCKUT111'.                   04630000
046400     DISPLAY '** PARAGRAPH      ** = ' PV-ABEND-PARAGRAPH.        04640000
046500     DISPLAY '** OPERATION      ** = ' PV-ABEND-OPERATION         04650000
046600     DISPLAY '** TABLE          ** = ' PV-ABEND-STRUCTURE-1       04660000
046700     DISPLAY SPACES                                               04670000
046800                                                                  04680000
046900     COPY DPPD004.                                                04690000
047000     SET ABEND-4013-DB2-ERROR   TO TRUE                           04700000
047100     CALL 'ILBOABN0' USING ABEND-CODE.                            04710000
