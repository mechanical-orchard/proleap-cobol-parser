000200 IDENTIFICATION DIVISION.                                                 
000300 PROGRAM-ID.    WSKUT065.                                                 
000400 AUTHOR.        GERMAN BANDA.                                             
000500 DATE-WRITTEN.  JUNE 2018.                                                
000600 ENVIRONMENT DIVISION.                                                    
000700 INPUT-OUTPUT SECTION.                                                    
000800                                                                          
000900 FILE-CONTROL.                                                            
001000     SELECT SWC-LOC-EXTRACT-FILE      ASSIGN TO INP01.                    
001120     SELECT SWC-LOC-QUERY-FILE        ASSIGN TO OUT01.                    
001200                                                                          
001300 DATA DIVISION.                                                           
001400 FILE SECTION.                                                            
001500                                                                          
001600                                                                          
001700 FD  SWC-LOC-EXTRACT-FILE                                                 
001800     RECORDING MODE IS F                                                  
001900     LABEL RECORDS ARE STANDARD                                           
002000     RECORD CONTAINS 37                                                   
002100     BLOCK CONTAINS 0 RECORDS                                             
002200     DATA RECORD IS SWC-CNT-LOC-RECORD.                                   
002300 01  SWC-CNT-LOC-RECORD               PIC X(37).                          
002400                                                                          
002500 FD  SWC-LOC-QUERY-FILE                                                   
002600     RECORDING MODE IS F                                                  
002700     LABEL RECORDS ARE STANDARD                                           
002800     RECORD CONTAINS 80                                                   
002900     BLOCK CONTAINS 0 RECORDS                                             
003000     DATA RECORD IS SWC-LOC-QUERY-RECORD.                                 
003100 01  SWC-LOC-QUERY-RECORD        PIC X(80).                               
003200                                                                          
003300 WORKING-STORAGE SECTION.                                                 
003400                                                                          
003500 01  PV-ABEND-CODE                    PIC S9(04)   VALUE ZERO             
003600                                                   COMP SYNC.             
003700                                                                          
003800 01  PS-PROGRAM-SWITCHES.                                                 
003900     05  PS-END-EXTRACT-SW            PIC X(1)   VALUE 'N'.               
004000         88  PS-END-EXTRACT                      VALUE 'Y'.               
004100     05  PS-ORDER-TYPE-SW             PIC X(1)   VALUE 'N'.               
004200         88  PS-ORDER-TYPE-YES                   VALUE 'Y'.               
004210         88  PS-ORDER-TYPE-NO                    VALUE 'N'.               
004300                                                                          
004400                                                                          
004500 01  PV-PROGRAM-VARIABLES.                                                
004600     05  PV-RETRY-COUNT               PIC S9(04)  VALUE ZERO              
004700                                                  COMP SYNC.              
004800     05  PV-PARAGRAPH-NAME            PIC X(30)   VALUE SPACES.           
004900     05  PV-ERROR-MESSAGE-1           PIC X(60)   VALUE SPACES.           
005000     05  PV-ERROR-MESSAGE-2           PIC X(60)   VALUE SPACES.           
005010     05  PV-TMST                      PIC X(26)   VALUE SPACES.           
005100     05  PV-SQLCODE                   PIC 9(9)    VALUE ZERO.             
005700     05  PV-DISP-NBR                  PIC Z(8)9.                          
005710*                                                                         
005800     05  PV-POSITION                 PIC 9(05) VALUE 0.                   
005900     05  PV-FIELD-LGTH               PIC 9(05) VALUE 0.                   
006000     05  PV-PUB-RT1-LGTH             PIC 9(03) VALUE 0.                   
006100     05  PV-PUB-RF3-LGTH             PIC 9(03) VALUE 0.                   
006110     05  PV-PUB-REF3-LGTH            PIC 9(03) VALUE 0.                   
006200     05  PV-WORK-FIELD               PIC X(300) VALUE SPACES.             
006210     05  PV-WORK-KEY                  PIC 9(06) VALUE 0.                  
006220     05  PV-ADDR-TRIMMED              PIC X(40) VALUE SPACE.              
006300                                                                          
006400 01  PV-COUNTERS COMP-3.                                                  
006500     05  PV-READ-COUNT                PIC S9(9)    VALUE ZERO.            
006600     05  PV-WRITE-COUNT               PIC S9(9)    VALUE ZERO.            
006700     05  PV-SKIP-COUNT                PIC S9(9)    VALUE ZERO.            
006710     05  PV-COMMIT-COUNT              PIC S9(9)    VALUE ZERO.            
006800                                                                          
006900 01  PC-PROGRAM-CONSTANTS.                                                
007000     05  PC-PROGRAM-NAME              PIC X(08)  VALUE 'WSKUT065'.        
007100     05  PC-MAX-RETRIES               PIC S9(04) VALUE +3                 
007200                                                 COMP SYNC.               
007300     05  PC-COMMIT                    PIC S9(04) VALUE 999.               
007400     05  PC-SEMI-COLON                PIC X(01)  VALUE ';'.               
007500     05  PC-COMMA                     PIC X(01)  VALUE ','.               
007600     05  PC-QUOTE                     PIC X(01)  VALUE "'".               
007700     05  PC-CLOSE                     PIC X(01)  VALUE ")".               
008510 01  PV-IN-RECORD.                                                        
008520     05  PV-LOCN-IN                   PIC X(03).                          
008521     05  PV-ORDER-ID                  PIC X(10).                          
008522     05  PV-RATE-TYPE-1               PIC X(15).                          
008523     05  PV-RATE-TYPE-2               PIC X(01).                          
008524     05  PV-REF-FIELD-3               PIC X(03).                          
008525     05  PV-ORDER-TYPE                PIC X(02).                          
008526     05  PV-CHUTE-ASSGN               PIC X(03).                          
008540 01  PV-OUT-RECORD.                                                       
008550     05  PV-SQL-REC-1.                                                    
008551         10  PV-SQL-STMT-1               PIC X(30)  VALUE                 
008552             'update wmos_efc.orders        '.                            
008553         10  PV-FILLER-1                 PIC X(50)  VALUE SPACE.          
008554*                                                                         
008555     05  PV-SQL-REC-2                    PIC X(80)  VALUE SPACE.          
008561     05  PV-SQL-REC-3                    PIC X(80)  VALUE SPACE.          
008571*                                                                         
008572     05  PV-SQL-REC-4                    PIC X(80)  VALUE SPACE.          
008577*                                                                         
008579     05  PV-SQL-REC-5.                                                    
008580         10  PV-SQL-STMT-5               PIC X(22)  VALUE                 
008581             'last_updated_source = '.                                    
008582         10 PV-SQL-LAST-UPD-SRC          PIC X(08)  VALUE                 
008583                                                   "'WSTEAM'".            
008584         10 FILLER                       PIC X(01)  VALUE ','.            
008585*                                                                         
008586     05  PV-SQL-REC-6.                                                    
008587         10  PV-SQL-STMT-6               PIC X(22)  VALUE                 
008588             'last_updated_dttm = '.                                      
008589         10 PV-SQL-LAST-UPD-DTTM        PIC X(07)  VALUE                  
008590                                                   'sysdate'.             
008591*                                                                         
008592     05  PV-SQL-REC-7                    PIC X(80)  VALUE SPACE.          
008598                                                                          
008599     05  PV-SQL-REC-8                    PIC X(80)  VALUE SPACE.          
008600                                                                          
008604     05  PV-SQL-REC-9.                                                    
008605         10  PV-SQL-STMT-9               PIC X(32)  VALUE                 
008606        'update WMOS_EFC.order_Line_item '.                               
008610*Chute                                                                    
008611     05  PV-SQL-REC-10                   PIC X(80)  VALUE SPACE.          
008612*                                                                         
008613     05  PV-SQL-REC-11.                                                   
008614         10  PV-SQL-STMT-11              PIC X(55)  VALUE                 
008615        'where order_id in (select order_id from WMOS_EFC.orders'.        
008616     05  PV-SQL-REC-12                   PIC X(80)  VALUE SPACE.          
008617*                                                                         
008618 01  PV-COMMIT-RECORD.                                                    
008619     05  PV-COMMIT-STMT-1                PIC X(03)  VALUE                 
008620                                         'com'.                           
008621     05  PV-COMMIT-STMT-2                PIC X(04)  VALUE                 
008622                                         'mit;'.                          
008623     05  PV-FILLER-5                     PIC X(73)  VALUE SPACE.          
008630/                                                                         
011100 PROCEDURE DIVISION.                                                      
011200                                                                          
011300     PERFORM 1000-INIT.                                                   
011400                                                                          
011500     PERFORM 2000-PROCESS UNTIL PS-END-EXTRACT.                           
011600     IF PV-WRITE-COUNT > 0                                                
011700        PERFORM 8500-WRITE-COMMIT-REC                                     
011701     END-IF.                                                              
011702                                                                          
011710     PERFORM 9000-TERMINATE.                                              
011800                                                                          
011900     GOBACK.                                                              
012000                                                                          
012100 1000-INIT.                                                               
012200                                                                          
012300     OPEN INPUT  SWC-LOC-EXTRACT-FILE                                     
012400          OUTPUT SWC-LOC-QUERY-FILE                                       
012500                                                                          
012700                                                                          
012800     PERFORM 8000-READ-SWC-LOC-REC.                                       
012900                                                                          
013000 2000-PROCESS.                                                            
013010                                                                          
013020     SET PS-ORDER-TYPE-NO TO TRUE                                         
013200                                                                          
013400     PERFORM 2100-FIND-REF3-LENGTH                                        
013401     PERFORM 2200-FIND-RT1-LENGTH                                         
013402     PERFORM 2300-STRING-RFMT-RATE-TYP-2                                  
013403     PERFORM 2400-STRING-TC-ORDER-ID                                      
013404                                                                          
013405     IF PV-ORDER-TYPE > SPACE                                             
013406        IF PV-ORDER-TYPE = 'NA'                                           
013408           SET PS-ORDER-TYPE-NO TO TRUE                                   
013409        ELSE                                                              
013410           PERFORM 2500-STRING-ORDER-TYPE                                 
013411           SET PS-ORDER-TYPE-YES TO TRUE                                  
013412        END-IF                                                            
013413     ELSE                                                                 
013414           SET PS-ORDER-TYPE-NO TO TRUE                                   
013415     END-IF                                                               
013428                                                                          
013429     PERFORM 8100-WRITE-EXTRACT-REC                                       
013430     IF PV-CHUTE-ASSGN > SPACE                                            
013431        IF PV-CHUTE-ASSGN = 'NA'                                          
013432           CONTINUE                                                       
013433        ELSE                                                              
013434           PERFORM 2600-STRING-CHUTE-TYPE                                 
013435           PERFORM 8200-WRITE-EXTRCT-ORD-ID                               
013436        END-IF                                                            
013437     END-IF                                                               
013438                                                                          
013500                                                                          
013600     PERFORM 8000-READ-SWC-LOC-REC.                                       
013700/                                                                         
016600 2100-FIND-REF3-LENGTH.                                                   
016610                                                                          
016700     MOVE LENGTH OF PV-REF-FIELD-3 TO PV-FIELD-LGTH.                      
016800     MOVE PV-REF-FIELD-3           TO PV-WORK-FIELD.                      
016900     PERFORM VARYING PV-POSITION                                          
017000                FROM PV-FIELD-LGTH                                        
017100                  BY -1                                                   
017200               UNTIL PV-WORK-FIELD (PV-POSITION : 1) NOT = SPACE          
017300                  OR PV-POSITION = 1                                      
017400                                                                          
017500     END-PERFORM.                                                         
017600     MOVE PV-POSITION                      TO PV-PUB-REF3-LGTH.           
017700     PERFORM 2150-STRING-REF3.                                            
017800/                                                                         
017900 2150-STRING-REF3.                                                        
018000      String 'set ref_field_3 = '                                         
018010             PC-QUOTE                                                     
018100             PV-REF-FIELD-3 (1:PV-PUB-REF3-LGTH)                          
018110             PC-QUOTE                                                     
018200             PC-COMMA                                                     
018400             DELIMITED BY SIZE                                            
018500             INTO PV-SQL-REC-2.                                           
018600/                                                                         
018700 2200-FIND-RT1-LENGTH.                                                    
018800     MOVE LENGTH OF PV-RATE-TYPE-1 TO PV-FIELD-LGTH.                      
018900     MOVE PV-RATE-TYPE-1           TO PV-WORK-FIELD.                      
019000     PERFORM VARYING PV-POSITION                                          
019100                FROM PV-FIELD-LGTH                                        
019200                  BY -1                                                   
019300               UNTIL PV-WORK-FIELD (PV-POSITION : 1) NOT = SPACE          
019400                  OR PV-POSITION = 1                                      
019500                                                                          
019600     END-PERFORM.                                                         
019700     MOVE PV-POSITION                      TO PV-PUB-RT1-LGTH.            
019800     PERFORM 2250-STRING-RFMT-RATE-TYP-1.                                 
019900/                                                                         
020000 2250-STRING-RFMT-RATE-TYP-1.                                             
020100      String 'rte_type_1 = '                                              
020110             PC-QUOTE                                                     
020200             PV-RATE-TYPE-1 (1:PV-PUB-RT1-LGTH)                           
020210             PC-QUOTE                                                     
020300             PC-COMMA                                                     
020400             DELIMITED BY SIZE                                            
020500             INTO PV-SQL-REC-3.                                           
020501**                                                                        
020510 2300-STRING-RFMT-RATE-TYP-2.                                             
020520      String 'rte_type_2 = '                                              
020521             PC-QUOTE                                                     
020530             PV-RATE-TYPE-2                                               
020532             PC-QUOTE                                                     
020533             PC-COMMA                                                     
020550             DELIMITED BY SIZE                                            
020560             INTO PV-SQL-REC-4.                                           
020600/                                                                         
020700**                                                                        
020800 2400-STRING-TC-ORDER-ID.                                                 
020900      String 'where tc_order_id = '                                       
020910             PC-QUOTE                                                     
021000             PV-ORDER-ID                                                  
021010             PC-QUOTE                                                     
021100             PC-SEMI-COLON                                                
021200             DELIMITED BY SIZE                                            
021300             INTO PV-SQL-REC-7.                                           
021400*                                                                         
021500 2500-STRING-ORDER-TYPE.                                                  
021600      String 'order_type = '                                              
021610             PC-QUOTE                                                     
021700             PV-ORDER-TYPE                                                
021710             PC-QUOTE                                                     
021720             PC-COMMA                                                     
021900             DELIMITED BY SIZE                                            
022000             INTO PV-SQL-REC-8.                                           
022001*                                                                         
022010 2600-STRING-CHUTE-TYPE.                                                  
022020      String 'set CHUTE_ASSIGN_TYPE = '                                   
022021             PC-QUOTE                                                     
022030             PV-CHUTE-ASSGN                                               
022031             PC-QUOTE                                                     
022032             PC-COMMA                                                     
022050             DELIMITED BY SIZE                                            
022060             INTO PV-SQL-REC-10.                                          
022061                                                                          
022062                                                                          
022063                                                                          
022070      String '                   '                                        
022071             'where tc_order_id = '                                       
022080             PC-QUOTE                                                     
022090             PV-ORDER-ID                                                  
022091             PC-QUOTE                                                     
022092             PC-CLOSE                                                     
022093             PC-SEMI-COLON                                                
022094             DELIMITED BY SIZE                                            
022095             INTO PV-SQL-REC-12.                                          
022100/                                                                         
026100 8000-READ-SWC-LOC-REC.                                                   
026200                                                                          
026300     READ SWC-LOC-EXTRACT-FILE INTO PV-IN-RECORD                          
026500     AT END                                                               
026600         SET PS-END-EXTRACT           TO TRUE                             
026700     NOT AT END                                                           
026800         ADD 1                        TO PV-READ-COUNT                    
026900     END-READ.                                                            
027000                                                                          
027100 8100-WRITE-EXTRACT-REC.                                                  
027200                                                                          
027300     ADD 1                         TO PV-WRITE-COUNT                      
027400                                      PV-COMMIT-COUNT.                    
027500     WRITE SWC-LOC-QUERY-RECORD FROM PV-SQL-REC-1.                        
027510     WRITE SWC-LOC-QUERY-RECORD FROM PV-SQL-REC-2.                        
027520     WRITE SWC-LOC-QUERY-RECORD FROM PV-SQL-REC-3.                        
027530     WRITE SWC-LOC-QUERY-RECORD FROM PV-SQL-REC-4.                        
027531     WRITE SWC-LOC-QUERY-RECORD FROM PV-SQL-REC-5.                        
027532     WRITE SWC-LOC-QUERY-RECORD FROM PV-SQL-REC-6.                        
027533                                                                          
027534     IF PS-ORDER-TYPE-YES                                                 
027535        WRITE SWC-LOC-QUERY-RECORD FROM PV-SQL-REC-8                      
027540     END-IF                                                               
027542     WRITE SWC-LOC-QUERY-RECORD FROM PV-SQL-REC-7.                        
027543                                                                          
027550     IF PV-COMMIT-COUNT > PC-COMMIT                                       
027560        PERFORM 8500-WRITE-COMMIT-REC                                     
027561        MOVE +0 TO   PV-COMMIT-COUNT                                      
027570     END-IF.                                                              
027600/                                                                         
027601 8200-WRITE-EXTRCT-ORD-ID.                                                
027602                                                                          
027603     WRITE SWC-LOC-QUERY-RECORD FROM PV-SQL-REC-9.                        
027604     WRITE SWC-LOC-QUERY-RECORD FROM PV-SQL-REC-10.                       
027605     WRITE SWC-LOC-QUERY-RECORD FROM PV-SQL-REC-5.                        
027606     WRITE SWC-LOC-QUERY-RECORD FROM PV-SQL-REC-6.                        
027607     WRITE SWC-LOC-QUERY-RECORD FROM PV-SQL-REC-11.                       
027608     WRITE SWC-LOC-QUERY-RECORD FROM PV-SQL-REC-12.                       
027612                                                                          
027613     IF PV-COMMIT-COUNT > PC-COMMIT                                       
027614        PERFORM 8500-WRITE-COMMIT-REC                                     
027615        MOVE +0 TO   PV-COMMIT-COUNT                                      
027616     END-IF.                                                              
027617/                                                                         
027618 8500-WRITE-COMMIT-REC.                                                   
027620                                                                          
027640                                                                          
027650     WRITE SWC-LOC-QUERY-RECORD FROM PV-COMMIT-RECORD.                    
027690/                                                                         
027700 9000-TERMINATE.                                                          
027800                                                                          
027900     CLOSE SWC-LOC-EXTRACT-FILE                                           
028000           SWC-LOC-QUERY-FILE                                             
028100                                                                          
028200     DISPLAY '************************'.                                  
028300     DISPLAY '******* WSKUT065 *******'.                                  
028400     DISPLAY '************************'.                                  
028500     DISPLAY SPACES                                                       
028600                                                                          
028700     MOVE PV-READ-COUNT               TO PV-DISP-NBR                      
028800     DISPLAY 'EXTRACTS RECORDS READ        = ' PV-DISP-NBR                
028900                                                                          
029000     MOVE PV-WRITE-COUNT              TO PV-DISP-NBR                      
029100     DISPLAY 'SELECTED EXTRACTS WRITTEN    = ' PV-DISP-NBR                
029200                                                                          
029300     DISPLAY SPACES                                                       
029400     DISPLAY '************************'.                                  
029500                                                                          
