000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400 PROGRAM-ID.   CEKUP900.                                          00040000
000500 AUTHOR.       RON KRIER.                                         00050000
000600 INSTALLATION. KOHLS DEPARTMENT STORES.                           00060000
000700 DATE-WRITTEN. MAY 2010.                                          00070000
000800 DATE-COMPILED.                                                   00080000
000900******************************************************************00090000
001000*              CENTRAL STOCK DATA FIX                             00100000
001100*                                                                 00110000
001200* THIS PROGRAM WILL TAKE A FILE THAT WAS CREATED BY QMF AND BRING 00120000
001300* THAT FILE INTO THIS PROGRAM TO DELETE TCEPLMF TABLE ENTRIES THAT00130000
001400* HAVE NOT YET BEEN EXTRACTED AND SENT TO FASHION/LEDGER BECAUSE  00140000
001500* THE DATA IN THE FILE WAS POSTED A SECOND TIME FROM WMOS TO THE  00150000
001510* CENTRAL STOCK PULL DATABASES.  SOMETHING HAPPENS WHERE THE DATA 00151000
001520* IS NOT GETTING POSTED THE FIRST TIME AND THEN SOMEONE FROM THE  00152000
001530* EFC TEAM IS RESETING DATA AND PUSHING THROUGH AGAIN BUT LANDS   00153000
001540* UP SENDING ALL DATA FOR THE PULL THROUGH WHICH MEANS UNITS ARE  00154000
001550* POSTING TO CENTRAL STOCK A SECOND TIME.                         00155000
001560*                                                                 00156000
001570* THIS PROGRAM WILL DELETE DATA FROM TCEPLMF AND UPDATE THE       00157000
001580* DISTRIBUTED QUANTITY ON TCEPLDS TO REFLECT THE DELETED TCEPLMF  00158000
001590* ENTRIES.                                                        00159000
001600******************************************************************00160000
001700* 7/12/07 - MAJOR RE-WRITE TO SPLIT PICKTICKETS AFTER 90 SKUS.    00170001
001800******************************************************************00180000
001900 ENVIRONMENT DIVISION.                                            00190000
002000******************************************************************00200000
002100 CONFIGURATION SECTION.                                           00210000
002200 SOURCE-COMPUTER.        IBM-3090.                                00220000
002300 OBJECT-COMPUTER.        IBM-3090.                                00230000
002400                                                                  00240000
002500 INPUT-OUTPUT SECTION.                                            00250000
002600 FILE-CONTROL.                                                    00260000
002700     SELECT CE-PULL-DATA-FILE                                     00270000
002800         ASSIGN TO INP01.                                         00280000
003540                                                                  00354000
003550******************************************************************00355000
003560 DATA DIVISION.                                                   00356000
003570******************************************************************00357000
003580 FILE SECTION.                                                    00358000
003590                                                                  00359000
003600 FD  CE-PULL-DATA-FILE                                            00360000
003700     RECORDING MODE IS F                                          00370000
003800     LABEL RECORDS ARE STANDARD                                   00380000
003900     RECORD CONTAINS 90 CHARACTERS                                00390000
004000     BLOCK CONTAINS 0 RECORDS                                     00400000
004001     DATA RECORD IS CE-PULL-DATA-FILE-REC.                        00400100
004100 01  CE-PULL-DATA-FILE-REC.                                       00410000
004110     05  CE-FILLER-1                   PIC X(09).                 00411001
004120     05  CE-PULL-NBR                   PIC 9(05).                 00412000
004130     05  CE-FILLER-2                   PIC X(02).                 00413001
004140     05  CE-LINE-NBR                   PIC 9(04).                 00414000
004150     05  CE-FILLER-3                   PIC X(02).                 00415001
004160     05  CE-STOR-NBR                   PIC 9(04).                 00416000
004170     05  CE-FILLER-4                   PIC X(02).                 00417001
004180     05  CE-TMST                       PIC X(26).                 00418000
004190     05  CE-FILLER-5                   PIC X(02).                 00419001
004191     05  CE-ADJ-QTY                    PIC 9(05).                 00419100
004192     05  CE-FILLER-6                   PIC X(29).                 00419201
006800                                                                  00680000
006900******************************************************************00690000
007000 WORKING-STORAGE SECTION.                                         00700000
007100******************************************************************00710000
007200 01  PC-PROGRAM-CONSTANTS.                                        00720000
007300     05  PC-CURRENT-PROGRAM-NAME       PIC X(08) VALUE 'CEKUP900'.00730000
007600                                                                  00760000
007700 01  PS-PROGRAM-SWITCHES.                                         00770000
007800     05  PS-END-OF-FILE-SW             PIC X(01) VALUE 'N'.       00780000
007900         88  PS-END-OF-FILE-YES                  VALUE 'Y'.       00790000
008000         88  PS-END-OF-FILE-NO                   VALUE 'N'.       00800000
008400     05  PS-ERROR-MESSAGE-SW           PIC X(01) VALUE 'N'.       00840000
008500         88  PS-ERROR-MESSAGE-YES                VALUE 'Y'.       00850000
008600         88  PS-ERROR-MESSAGE-NO                 VALUE 'N'.       00860000
012540                                                                  01254000
012550 01  DK-DATABASE-KEYS.                                            01255000
012560     05  DK-TIMESTAMP                  PIC X(26).                 01256000
012570     05  DK-CE-PULL-NBR                PIC S9(9) COMP.            01257000
012580     05  DK-CE-LINE-NBR                PIC S9(4) COMP.            01258000
012581     05  DK-CE-STOR-NBR                PIC S9(4) COMP.            01258100
013000                                                                  01300000
013100 01  PV-ABEND-FIELDS.                                             01310000
013110     05  PV-SQLCODE                    PIC  9999-.                01311001
013200     05  PV-ABEND-CODE                 PIC S9(4) VALUE +0         01320000
013300                                                        COMP SYNC.01330000
013400     05  PV-ABEND-PROGRAM              PIC X(08) VALUE 'CEKUP900'.01340000
013500     05  PV-ABEND-PARAGRAPH            PIC X(25) VALUE SPACES.    01350000
013600     05  PV-ABEND-OPERATION            PIC X(20) VALUE SPACES.    01360000
013700     05  PV-ABEND-STRUCTURE-1          PIC X(08) VALUE SPACES.    01370000
013800     05  PV-ABEND-STRUCTURE-2          PIC X(08) VALUE SPACES.    01380000
013900     05  PV-ABEND-STATUS               PIC XX    VALUE SPACES.    01390000
014000     05  PV-DB2-OPERATION-MESSAGE-1    PIC X(79) VALUE SPACES.    01400000
014100     05  PV-DB2-OPERATION-MESSAGE-2    PIC X(79) VALUE SPACES.    01410000
014200     05  PV-DB2-TABLE-NAME             PIC X(08) VALUE SPACES.    01420001
015212                                                                  01521200
015213 01  PV-NULL-INDICATORS.                                          01521300
015214     05  PV-NULL-IND-1                 PIC S9(4) VALUE +0 COMP.   01521400
015215     05  PV-NULL-IND-2                 PIC S9(4) VALUE +0 COMP.   01521500
015216     05  PV-NULL-IND-3                 PIC S9(4) VALUE +0 COMP.   01521600
015217                                                                  01521700
015218 01  PV-PROGRAM-VARIABLES.                                        01521800
015219     05  FILLER                        PIC X(26) VALUE            01521900
015220                                   '***PV-PROGRAM-VARIABLES***'.  01522000
015290     05  PV-DISPLAY-REC-3              PIC ZZZ,ZZZ,999-.          01529000
015300     05  PV-DISPLAY-REC-4              PIC Z,ZZZ,999-.            01530000
015400     05  PV-DISPLAY-AMT                PIC 999.99.                01540000
018000     05  PV-ITM-NBR                    PIC S9(15)V COMP-3.        01800000
018100     05  PV-ADJ-QTY                    PIC S9(09)  COMP.          01810000
030300                                                                  03030000
030400 01  PA-PROGRAM-ACCUMULATORS.                                     03040000
030500     05  PA-RECS-IN                    PIC S9(9) VALUE ZEROES.    03050000
030510     05  PA-TCEPLMF-DELETED            PIC S9(9) VALUE ZEROES.    03051000
030520     05  PA-TCEPLDS-UPDATED            PIC S9(9) VALUE ZEROES.    03052000
030600     05  PA-PROCESS-QTY                PIC S9(9) VALUE ZEROES.    03060000
034500                                                                  03450000
047200                                                                  04720000
047300***********************************************************       04730000
047400*  USED FOR DB2 ERROR MESSAGE BUILDING                    *       04740000
047500***********************************************************       04750000
047600     COPY DPWS004.                                                04760000
047700                                                                  04770000
047800***********************************************************       04780000
047900*  DB2 SQL COMMUNICATION AREA                             *       04790000
048000***********************************************************       04800000
048100     EXEC SQL                                                     04810000
048200         INCLUDE SQLCA                                            04820000
048300     END-EXEC.                                                    04830000
048400                                                                  04840000
050600***********************************************************       05060000
050700*  CENTRAL STOCK - STORE (DISTRIBUTION) TABLE             *       05070000
050800***********************************************************       05080000
050900     EXEC SQL                                                     05090000
051000         INCLUDE TCEPLDS                                          05100000
051100     END-EXEC.                                                    05110000
051200                                                                  05120000
051300***********************************************************       05130000
051400*  CENTRAL STOCK - MANIFEST TABLE                         *       05140000
051500***********************************************************       05150000
051600     EXEC SQL                                                     05160000
051700         INCLUDE TCEPLMF                                          05170000
051800     END-EXEC.                                                    05180000
051900                                                                  05190000
053700***********************************************************       05370000
053800***********************************************************       05380000
053900 PROCEDURE DIVISION.                                              05390000
054000     DISPLAY '*** START OF CEKUP900 ***'.                         05400000
054100     DISPLAY ' '.                                                 05410000
054200                                                                  05420000
054300*INITIALIZATION.                                                  05430000
054400     PERFORM 0100-INITIALIZATION.                                 05440000
054500                                                                  05450000
054600*PROCESS INPUT FILE.                                              05460000
054700     IF PS-END-OF-FILE-YES                                        05470001
054800         DISPLAY '**** NO INPUT FILE FOUND FOR CEKUP900 ****'     05480000
054900     ELSE                                                         05490000
055000         PERFORM 1000-PROCESS-INPUT                               05500000
055100           UNTIL PS-END-OF-FILE-YES                               05510000
055200     END-IF.                                                      05520000
055300                                                                  05530000
055400*DISPLAY RECORD COUNTS.                                           05540000
055500     DISPLAY ' '.                                                 05550000
055600     DISPLAY '****************************************'.          05560000
055700     MOVE PA-RECS-IN             TO PV-DISPLAY-REC-3.             05570000
055800     DISPLAY '*** RECORDS READ     ==> ' PV-DISPLAY-REC-3.        05580000
055900     MOVE PA-PROCESS-QTY         TO PV-DISPLAY-REC-3.             05590000
056000     DISPLAY '*** UNITS PROCESSED  ==> ' PV-DISPLAY-REC-3.        05600000
056100     MOVE PA-TCEPLMF-DELETED     TO PV-DISPLAY-REC-3.             05610001
056200     DISPLAY '*** TCEPLMF DELETED  ==> ' PV-DISPLAY-REC-3.        05620001
056210     MOVE PA-TCEPLDS-UPDATED     TO PV-DISPLAY-REC-3.             05621001
056220     DISPLAY '*** TCEPLDS UPDATED  ==> ' PV-DISPLAY-REC-3.        05622001
056300     DISPLAY '****************************************'.          05630000
056400     DISPLAY ' '.                                                 05640000
056500                                                                  05650000
056600*CLOSE FILES.                                                     05660000
056700     CLOSE CE-PULL-DATA-FILE.                                     05670000
056900                                                                  05690000
057300     DISPLAY '***  END OF CEKUP900  ***'.                         05730000
057400     GOBACK.                                                      05740000
057500                                                                  05750000
057600******************************************************************05760000
057700 0100-INITIALIZATION.                                             05770000
057800******************************************************************05780000
057900     MOVE '0100-INITIALIZATION        ' TO PV-ABEND-PARAGRAPH.    05790000
058000                                                                  05800000
058100     OPEN INPUT  CE-PULL-DATA-FILE.                               05810000
058300                                                                  05830000
059500     READ CE-PULL-DATA-FILE                                       05950000
059600         AT END                                                   05960000
059700            SET PS-END-OF-FILE-YES TO TRUE.                       05970000
059800                                                                  05980000
059900     IF PS-END-OF-FILE-NO                                         05990000
060000        ADD +1 TO PA-RECS-IN                                      06000000
060100        ADD CE-ADJ-QTY TO PA-PROCESS-QTY                          06010000
060200     END-IF.                                                      06020000
060300                                                                  06030000
060400******************************************************************06040000
060500 1000-PROCESS-INPUT.                                              06050000
060600******************************************************************06060000
060700     MOVE '1000-PROCESS-INPUT         ' TO PV-ABEND-PARAGRAPH.    06070000
060800                                                                  06080000
060900     DISPLAY 'PULL NUMBER: ' CE-PULL-NBR.                         06090002
061000     DISPLAY 'LINE NUMBER: ' CE-LINE-NBR.                         06100002
061100     DISPLAY 'STOR NUMBER: ' CE-STOR-NBR.                         06110002
061110     DISPLAY 'QTY ADJ:     ' CE-ADJ-QTY.                          06111002
061120     DISPLAY ' '.                                                 06112002
061200                                                                  06120002
068020     PERFORM 3000-DELETE-TCEPLMF.                                 06802000
068030     PERFORM 3100-UPDATE-TCEPLDS.                                 06803000
068100     PERFORM 4230-COMMIT.                                         06810000
068200                                                                  06820000
068300     READ CE-PULL-DATA-FILE                                       06830000
068400         AT END                                                   06840000
068500            SET PS-END-OF-FILE-YES TO TRUE.                       06850000
068600                                                                  06860000
068700     IF PS-END-OF-FILE-NO                                         06870000
068800        ADD +1 TO PA-RECS-IN                                      06880000
068900        ADD CE-ADJ-QTY TO PA-PROCESS-QTY                          06890000
069000     END-IF.                                                      06900000
097200                                                                  09720000
097300******************************************************************09730000
097400 3000-DELETE-TCEPLMF.                                             09740000
097500******************************************************************09750000
097600     MOVE '3000-DELETE-TCEPLMF        ' TO PV-ABEND-PARAGRAPH.    09760000
097700                                                                  09770000
097800     INITIALIZE DCLTCEPLMF.                                       09780000
097900                                                                  09790000
098000     MOVE CE-PULL-NBR            TO DK-CE-PULL-NBR.               09800000
098100     MOVE CE-LINE-NBR            TO DK-CE-LINE-NBR.               09810000
098200     MOVE CE-STOR-NBR            TO DK-CE-STOR-NBR.               09820000
098210     MOVE CE-TMST                TO DK-TIMESTAMP.                 09821000
098300                                                                  09830000
100600     EXEC SQL                                                     10060000
100700         DELETE                                                   10070000
100800         FROM  TCEPLMF                                            10080000
100900        WHERE  CNSTK_REQ_PL_NBR = :DK-CE-PULL-NBR                 10090000
101000          AND  PL_LNE_NBR = :DK-CE-LINE-NBR                       10100000
101100          AND  STR_NBR = :DK-CE-STOR-NBR                          10110000
101200          AND  MFST_TMST = :DK-TIMESTAMP                          10120000
102400     END-EXEC.                                                    10240000
102500                                                                  10250000
102600     EVALUATE TRUE                                                10260000
102700         WHEN SQLCODE = ZERO                                      10270000
102800             ADD +1 TO PA-TCEPLMF-DELETED                         10280000
103000         WHEN OTHER                                               10300000
103100           MOVE 'TCEPLMF' TO PV-DB2-TABLE-NAME                    10310000
103200           MOVE 'DELETE MANIFEST RECORD'                          10320000
103300                          TO PV-DB2-OPERATION-MESSAGE-1           10330000
103400           STRING 'PULL# / LINE / STORE = '                       10340000
103500                  CE-PULL-NBR    ' / '                            10350000
103600                  CE-LINE-NBR    ' / '                            10360000
103700                  CE-STOR-NBR                                     10370000
103800             DELIMITED BY SIZE                                    10380000
103900             INTO PV-DB2-OPERATION-MESSAGE-2                      10390000
104000           PERFORM 9900-DB2-ABEND                                 10400000
104100     END-EVALUATE.                                                10410000
104200                                                                  10420000
104300******************************************************************10430000
104400 3100-UPDATE-TCEPLDS.                                             10440000
104500******************************************************************10450000
104600     MOVE '3100-UPDATE-TCEPLDS        ' TO PV-ABEND-PARAGRAPH.    10460000
104700                                                                  10470000
104710     MOVE CE-ADJ-QTY TO PV-ADJ-QTY.                               10471000
105300     EXEC SQL                                                     10530000
105400         UPDATE TCEPLDS                                           10540000
105500            SET  ACTL_DISTRB_QTY  =                               10550000
105510                 ACTL_DISTRB_QTY - :PV-ADJ-QTY                    10551000
105520          WHERE  CNSTK_REQ_PL_NBR = :DK-CE-PULL-NBR               10552000
105530            AND  PL_LNE_NBR = :DK-CE-LINE-NBR                     10553000
105540            AND  STR_NBR = :DK-CE-STOR-NBR                        10554000
105900     END-EXEC.                                                    10590000
106000                                                                  10600000
106100     EVALUATE TRUE                                                10610000
106200       WHEN SQLCODE = ZERO                                        10620000
106210           ADD +1 TO PA-TCEPLDS-UPDATED                           10621000
106500       WHEN OTHER                                                 10650000
106600           MOVE 'TCEPLDS' TO PV-DB2-TABLE-NAME                    10660000
106700           MOVE 'UPDATE DISTRIBUTION RECORD'                      10670000
106800                          TO PV-DB2-OPERATION-MESSAGE-1           10680000
106810           STRING 'PULL# / LINE / STORE = '                       10681000
106811                  CE-PULL-NBR    ' / '                            10681100
106812                  CE-LINE-NBR    ' / '                            10681200
106813                  CE-STOR-NBR                                     10681300
107300             DELIMITED BY SIZE                                    10730000
107400             INTO PV-DB2-OPERATION-MESSAGE-2                      10740000
107500           PERFORM 9900-DB2-ABEND                                 10750000
107600     END-EVALUATE.                                                10760000
107700                                                                  10770000
120500                                                                  12050000
135100******************************************************************13510000
135200 4230-COMMIT.                                                     13520000
135300******************************************************************13530000
135400     MOVE '4230-COMMIT                ' TO PV-ABEND-PARAGRAPH.    13540000
135500                                                                  13550000
135600     EXEC SQL                                                     13560000
135700         COMMIT                                                   13570000
135800     END-EXEC.                                                    13580000
135900                                                                  13590000
142900******************************************************************14290000
143000 9900-DB2-ABEND.                                                  14300000
143100******************************************************************14310000
143200     MOVE '9900-DB2-ABEND             ' TO PV-ABEND-PARAGRAPH.    14320000
143300                                                                  14330000
143400     MOVE SQLCODE TO PV-SQLCODE.                                  14340000
143500     DISPLAY '*** DB2 ERROR '.                                    14350000
143600     DISPLAY '*** SQLCODE   = ' PV-SQLCODE.                       14360000
143700     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 14370000
143800     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               14380000
143900     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               14390000
144000     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       14400000
144100     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.       14410000
144200     DISPLAY '*** TABLE 1   = ' PV-DB2-TABLE-NAME.                14420000
144300                                                                  14430000
144400     COPY DPPD004.                                                14440000
144500                                                                  14450000
144600     MOVE +4013 TO PV-ABEND-CODE.                                 14460000
144700     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         14470000
144800                                                                  14480000
144900******************************************************************14490000
145000******************************************************************14500000
