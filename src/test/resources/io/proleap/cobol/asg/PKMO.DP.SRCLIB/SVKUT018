000100 IDENTIFICATION DIVISION.                                         00010001
000200 PROGRAM-ID.         SVKUT018.                                    00020001
000300 AUTHOR.             GREGORY SHEFF.                               00030001
000400 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00040001
000500 DATE-WRITTEN.       MAY 2001.                                    00050001
000600 DATE-COMPILED.                                                   00060001
000700                                                                  00070001
000800***************************************************************** 00080001
000900* THIS PROGRAM DETERMINES WHAT SVT-ACCT, SVT-TXN, TKMCCOM DATA  * 00090001
001000* SHOULD BE ARCHIVED TO THE HISTORY TABLES.                     * 00100001
001100***************************************************************** 00110001
C12521*----------------------------------------------------------------*00120001
C12521* 05/20/2015  CHG0112521 - COGNIZANT                              00130002
C12521* MODIFIED THE PROGRAM TO ARCHIVE DATA WITH ZERO BALANCES FOR     00140001
C12521* ATLEAST 13 MONTHS                                               00150001
C12521* FIND THE TAG C12521 FOR CHANGES                                *00160001
C12521*----------------------------------------------------------------*00170001
001200                                                                  00180001
001300 ENVIRONMENT DIVISION.                                            00190001
001400 CONFIGURATION SECTION.                                           00200001
001500                                                                  00210001
001600 SOURCE-COMPUTER.    IBM-3090.                                    00220001
001700 OBJECT-COMPUTER.    IBM-3090.                                    00230001
001800                                                                  00240001
001900 INPUT-OUTPUT SECTION.                                            00250001
002000 FILE-CONTROL.                                                    00260001
002100                                                                  00270001
002200     SELECT SVT-ACCT              ASSIGN TO INP01.                00280001
002300     SELECT SVT-TXN               ASSIGN TO INP02.                00290001
002400     SELECT SVT-CNT               ASSIGN TO INP03.                00300001
002500     SELECT SVT-HIST              ASSIGN TO OUT01.                00310001
002600                                                                  00320001
002700 DATA DIVISION.                                                   00330001
002800 FILE SECTION.                                                    00340001
002900                                                                  00350001
003000 FD  SVT-ACCT                                                     00360001
003100     RECORDING MODE IS F                                          00370001
003200     BLOCK CONTAINS 0 RECORDS                                     00380001
003300     LABEL RECORDS ARE OMITTED.                                   00390001
003400 01  TBL-FILE                         PIC X(42).                  00400001
003500                                                                  00410001
003600 FD  SVT-TXN                                                      00420001
003700     RECORDING MODE IS F                                          00430001
003800     BLOCK CONTAINS 0 RECORDS                                     00440001
003900     LABEL RECORDS ARE OMITTED.                                   00450001
004000 01  ACT-FILE                         PIC X(38).                  00460001
004100                                                                  00470001
004200 FD  SVT-CNT                                                      00480001
004300     RECORDING MODE IS F                                          00490001
004400     BLOCK CONTAINS 0 RECORDS                                     00500001
004500     LABEL RECORDS ARE OMITTED.                                   00510001
004600 01  CNT-FILE.                                                    00520001
004610     05 CNT-CC-NBR-ACCTS              PIC 9(9).                   00530001
004620     05 FILLER                        PIC X(71).                  00540001
004700                                                                  00550001
004800 FD  SVT-HIST                                                     00560001
004900     RECORDING MODE IS F                                          00570001
005000     BLOCK CONTAINS 0 RECORDS                                     00580001
005100     LABEL RECORDS ARE OMITTED.                                   00590001
005200 01  HTB-FILE                         PIC X(26).                  00600001
005300                                                                  00610001
005400 WORKING-STORAGE SECTION.                                         00620001
005500                                                                  00630001
005600******************************************************************00640001
005700*    PC-PROGRAM CONSTANTS                                        *00650001
005800******************************************************************00660001
005900 01  PC-PROGRAM-CONSTANTS.                                        00670001
006000     05  PC-PROGRAM-NAME              PIC  X(08)     VALUE        00680001
006100                                           'SVKUT018'.            00690001
006200                                                                  00700001
006300******************************************************************00710001
006400* COBOL DECLARATION FOR TABLE SVT_KOHLS_CRD_ACCT                  00720001
006500******************************************************************00730001
006600 01  KMCTBL-RCD.                                                  00740001
006700     10 KMCTBL-CRD-NBR                PIC  S9(12)V COMP-3.        00750001
006900     10 KMCTBL-CRD-PROD-YR            PIC  S9(4) COMP.            00760001
007000     10 KMCTBL-SHIPT-REQ-NBR          PIC  S9(4) COMP.            00770001
007100     10 KMCTBL-CRD-TYP-CDE            PIC  S9(1)V COMP-3.         00780001
007200     10 KMCTBL-CRD-STAT-CDE           PIC   X(2).                 00790001
007300     10 KMCTBL-CRD-STAT-CHG-DTE       PIC   X(10).                00800001
007300     10 KMCTBL-CRD-STAT-CHG-TM        PIC   X(08).                00810001
006800     10 KMCTBL-CRD-CLO-DTE            PIC   X(10).                00820001
007400                                                                  00830001
007500******************************************************************00840001
007600* COBOL DECLARATION FOR TABLE SVT_KOHLS_CRD_TXN                   00850001
007700******************************************************************00860001
007800 01  KMCACT-RCD.                                                  00870001
007900     10 KMCACT-CRD-NBR                PIC  S9(12)V COMP-3.        00880001
008000     10 KMCACT-AUTH-TMST              PIC   X(26).                00890001
           10 KMCACT-DATE-TIME        REDEFINES KMCACT-AUTH-TMST.       00900001
              15 KMCACT-AUTH-DTE            PIC  X(10).                 00910001
              15 FILLER                     PIC  X.                     00920001
              15 KMCACT-AUTH-TM             PIC  X(8).                  00930001
              15 FILLER                     PIC  X(7).                  00940001
008100     10 KMCACT-APP-AUTH-AMT           PIC  S9(7)V9(2) COMP-3.     00950001
008200                                                                  00960001
008300******************************************************************00970001
008400* COBOL DECLARATION FOR FILE  SVT_HIST                            00980001
008500******************************************************************00990001
008600 01  HBT-RCD.                                                     01000001
008700     10 HBT-CRD-NBR                PIC  S9(12)V COMP-3.           01010001
008800     10 HBT-CRD-CLO-DTE            PIC   X(10).                   01020001
008800     10 HBT-CRD-CLO-TM             PIC   X(08).                   01030001
008900     10 HBT-CLO-FLG                PIC   X.                       01040001
009000                                                                  01050001
009100******************************************************************01060001
009200*    PROGRAM VARIABLES                                           *01070001
009300******************************************************************01080001
009400 01  PV-PROGRAM-VARIABLES.                                        01090001
009500     05  PV-CURRENT-DATE-TIME.                                    01100001
009600        10  PV-CURRENT-DATE.                                      01110001
009700            15  PV-CURRENT-YEAR          PIC  9(04).              01120001
009800            15  PV-CURRENT-MONTH         PIC  9(02).              01130001
009900            15  PV-CURRENT-DAY           PIC  9(02).              01140001
010000        10  PV-CURRENT-TIME.                                      01150001
010100            15  PV-CURRENT-HRS       PIC  9(02).                  01160001
010200            15  PV-CURRENT-MINS      PIC  9(02).                  01170001
010300            15  PV-CURRENT-SECS      PIC  9(02).                  01180001
010400        10                           PIC  X(07).                  01190001
C12521     05  PV-390-DAYS-AGO             PIC  X(10) VALUE SPACES.     01200001
010600     05  PV-APP-AUTH-AMT     PIC  S9(7)V9(2) COMP-3 VALUE ZEROES. 01210001
010610     05  PV-LAST-AUTH-DTE             PIC  X(10).                 01220001
010610     05  PV-LAST-AUTH-TM              PIC  X(08).                 01230001
010700     05  PV-PARAGRAPH                 PIC  X(30).                 01240001
010710     05  PV-DB2-OPERATION             PIC  X(30).                 01250001
011300     05  PV-RPL-IDX                   PIC S9(4) COMP.             01260001
011300     05  PV-RPL-MAX                   PIC S9(4) COMP VALUE 50.    01270001
011400     05  PV-REPLENISH-TBL OCCURS 50 TIMES.                        01280001
011500         10  PV-CRD-TYP-CDE           PIC 9.                      01290001
011600         10  PV-CRD-PROD-YR           PIC 9(4).                   01300001
011700         10  PV-SHIPT-REQ-NBR         PIC 9(4).                   01310001
011800                                                                  01320001
011900 01  ABEND-CODE                       PIC S9(04)    VALUE +0 COMP.01330001
012000                                                                  01340001
012100******************************************************************01350001
012200*    PS-PROGRAM SWITCHES                                         *01360001
012300******************************************************************01370001
012400 01  PS-PROGRAM-SWITCHES.                                         01380001
012500     05  PS-END-OF-REPL-SW            PIC  X(01)     VALUE 'N'.   01390001
012600         88  PS-END-OF-REPL-CSR                      VALUE 'Y'.   01400001
012700         88  NOT-END-OF-REPL-CSR                     VALUE 'N'.   01410001
012800     05  PS-END-OF-SVT-ACCT-SW        PIC  X(01)     VALUE 'N'.   01420001
012900         88  END-OF-SVT-ACCT                         VALUE 'Y'.   01430001
013000         88  NOT-END-OF-SVT-ACCT                     VALUE 'N'.   01440001
013100     05  PS-END-OF-SVT-TXN-SW         PIC  X(01)     VALUE 'N'.   01450001
013200         88  END-OF-SVT-TXN                          VALUE 'Y'.   01460001
013300         88  NOT-END-OF-SVT-TXN                      VALUE 'N'.   01470001
013400     05  PS-CHANGE-SVT-ACCT-SW        PIC  X(01)     VALUE 'N'.   01480001
013500         88  CHANGE-SVT-ACCT                         VALUE 'Y'.   01490001
013600         88  NO-CHANGE-SVT-ACCT                      VALUE 'N'.   01500001
           05  PS-REPLENISH-CARD            PIC  X(01)     VALUE 'N'.   01510001
               88  REPLENISH-CARD                          VALUE 'Y'.   01520001
               88  NOT-REPLENISH-CARD                      VALUE 'N'.   01530001
013700                                                                  01540001
013800******************************************************************01550001
013900*    PA-PROGRAM ACCUMULATORS                                     *01560001
014000******************************************************************01570001
014100 01  PA-PROGRAM-ACCUMULATORS.                                     01580001
014200     05  PA-READ-ACT                  PIC  9(09)    VALUE ZEROES. 01590001
014300     05  PA-READ-TBL                  PIC  9(09)    VALUE ZEROES. 01600001
014400     05  PA-WRITE-TBL                 PIC  9(09)    VALUE ZEROES. 01610001
014500                                                                  01620001
015000******************************************************************01630001
015100*    DATE ROUTINE COPY MEMBERS                                   *01640001
015200******************************************************************01650001
015300     COPY DPWS500.                                                01660001
015400******************************************************************01670001
015500*    STORED VALUE CARD CONSTANTS                                 *01680001
015600******************************************************************01690001
015700     COPY SVWS004.                                                01700001
                                                                        01710001
      ******************************************************************01720001
      * STANDARD DB2 ERROR HANDLING AREA                                01730001
      ******************************************************************01740001
           COPY DPWS004.                                                01750001
                                                                        01760001
      ******************************************************************01770001
      *    STANDARD LAYOUT FOR THE SQL COMMUNICATIONS AREA             *01780001
      ******************************************************************01790001
           EXEC SQL                                                     01800001
                INCLUDE SQLCA                                           01810001
           END-EXEC.                                                    01820001
                                                                        01830001
           COPY SQLCA2.                                                 01840001
015800                                                                  01850001
015810******************************************************************01860001
015820*  KOHL'S STORED VALUE TABLE SVT_CRD_PROD                        *01870001
015830******************************************************************01880001
015840                                                                  01890001
015850     EXEC SQL                                                     01900001
015860         INCLUDE SVT00000                                         01910001
015870     END-EXEC.                                                    01920001
016500                                                                  01930001
016600***************************************************************** 01940001
016700*  DB2 TABLE SVT_CRD_STK_DNMNTN STORED VALUE TABLE                01950001
016800***************************************************************** 01960001
016900     EXEC SQL                                                     01970001
017000          INCLUDE SVT00008                                        01980001
017100     END-EXEC.                                                    01990001
017200                                                                  02000001
017300***************************************************************** 02010001
017400*  REPLENISH CURSOR                                               02020001
017500***************************************************************** 02030001
017600     EXEC SQL                                                     02040001
017700        DECLARE REPLENISH-CSR CURSOR FOR                          02050001
017800          SELECT CRD_PROD_YR                                      02060001
017900               , SHIPT_REQ_NBR                                    02070001
018000               , A.CRD_TYP_CDE                                    02080001
018100          FROM SVT_CRD_PROD A,                                    02090001
018200               SVT_CRD_STK_DNMNTN B                               02100001
018300          WHERE B.CRD_RPLNT_IND  = 'Y'                            02110001
018400            AND A.CRD_TYP_CDE    = B.CRD_TYP_CDE                  02120001
018500            AND A.CRD_STK_TYP_ID = B.CRD_STK_TYP_ID               02130001
018600          WITH UR                                                 02140001
018700     END-EXEC.                                                    02150001
018800                                                                  02160001
018900******************************************************************02170001
019000 PROCEDURE DIVISION.                                              02180001
019100                                                                  02190001
019200 A100-MAINLINE.                                                   02200001
019300                                                                  02210001
019400     DISPLAY '************ START ************'                    02220001
019500     PERFORM A100-INITIALIZE.                                     02230001
019600                                                                  02240001
019700     PERFORM A200-PROCESS-SVT-ACCT                                02250001
019800                  UNTIL END-OF-SVT-ACCT.                          02260001
019900                                                                  02270001
020000     PERFORM A300-CLEANUP.                                        02280001
020100                                                                  02290001
020200     DISPLAY '************* EOJ *************'                    02300001
020300     GOBACK.                                                      02310001
020400                                                                  02320001
020500******************************************************************02330001
020600 A100-INITIALIZE.                                                 02340001
020700     MOVE FUNCTION CURRENT-DATE    TO PV-CURRENT-DATE-TIME.       02350001
020800     DISPLAY 'START: ' PV-CURRENT-TIME.                           02360001
020900                                                                  02370001
021000     PERFORM A110-GET-DATES.                                      02380001
021100                                                                  02390001
021200     OPEN INPUT  SVT-ACCT                                         02400001
021300                 SVT-TXN                                          02410001
021310                 SVT-CNT                                          02420001
021400          OUTPUT SVT-HIST.                                        02430001
021401                                                                  02440001
021410       READ SVT-CNT                                               02450001
021420            AT END                                                02460001
021421               DISPLAY '** ABEND **'                              02470001
021422               DISPLAY '** PROGRAM = SVKUT018 **'                 02480001
021423               DISPLAY '** PARAGRAPH = 100-INITIALIZE **'         02490001
021424               DISPLAY '** MISSING CONTROL CARD **'               02500001
021428               MOVE +4003 TO ABEND-CODE                           02510001
021429               CALL 'ILBOABN0' USING ABEND-CODE                   02520001
021460       END-READ.                                                  02530001
021500                                                                  02540001
021600     PERFORM A120-LOAD-REPLENISH-TBL.                             02550001
021700                                                                  02560001
021800     PERFORM X100-READ-SVT-ACCT.                                  02570001
021900     PERFORM X200-READ-SVT-TXN.                                   02580001
022100******************************************************************02590001
C12521*    GET CURRENT DATE AND DATE 390 DAYS AGO                      *02600001
022300******************************************************************02610001
022400 A110-GET-DATES.                                                  02620001
022900                                                                  02630001
023000     INITIALIZE DPG51 DPG52 DPG53                                 02640001
023100                DPG54 DPG55 DPG56.                                02650001
023200                                                                  02660001
023300     SET DPG51-ACTUAL-CALENDAR-ONLY                               02670001
023400                                 TO TRUE.                         02680001
023500     SET DPG51-DECREMENT-DATE                                     02690001
023600                                 TO TRUE.                         02700001
025000                                                                  02710001
025200                                                                  02720001
C12521     MOVE 390 TO DPG51-INCR-DECR-DAYS-9.                          02730001
023800     MOVE PV-CURRENT-DATE        TO DPG52-LK-DATE-INPUT.          02740001
023900     SET DPG52-LK-DTE-ISO        TO TRUE.                         02750001
024000                                                                  02760001
024100     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    02770001
024200                                             DPG54 DPG55 DPG56.   02780001
024300                                                                  02790001
024400     EVALUATE TRUE                                                02800001
024500       WHEN DPG54-SEVERE-ERROR                                    02810001
024600       WHEN DPG54-WARNING-ERROR                                   02820001
024700            MOVE 'A100-GET-DATES-2' TO PV-PARAGRAPH               02830001
024800            PERFORM Z900-DATE-ABEND                               02840001
024900     END-EVALUATE.                                                02850001
025000                                                                  02860001
C12521     MOVE DPG55-DB2-ISO-DATE-FMT TO PV-390-DAYS-AGO.              02870001
025200                                                                  02880001
025300     DISPLAY 'RUN DATE  : '  PV-CURRENT-DATE.                     02890001
C12521     DISPLAY 'ARCHIVE DATA OLDER THAN(13 MONTHS)'                 02900001
                                PV-390-DAYS-AGO.                        02910001
025500                                                                  02920001
025600******************************************************************02930001
025700*    LOAD CRD PRODUCTS/SHIP TO REQUEST NBR INTO WORK TABLE       *02940001
025800******************************************************************02950001
025900 A120-LOAD-REPLENISH-TBL.                                         02960001
026000                                                                  02970001
       4010-OPEN-CURSOR.                                                02980001
                                                                        02990001
           EXEC SQL                                                     03000001
                OPEN REPLENISH-CSR                                      03010001
           END-EXEC.                                                    03020001
                                                                        03030001
           EVALUATE TRUE                                                03040001
               WHEN SQLCODE = ZERO                                      03050001
                    CONTINUE                                            03060001
               WHEN SQLWARN0 NOT EQUAL SPACE                            03070001
               WHEN SQLCODE NOT EQUAL ZERO                              03080001
                    MOVE 'A120-LOAD-REPLENISH-TBL' TO PV-PARAGRAPH      03090001
                    MOVE 'ERROR ON OPEN OF REPLENISH-CSR'               03100001
                                               TO PV-DB2-OPERATION      03110001
                    PERFORM Z910-SQL-ABEND                              03120001
           END-EVALUATE.                                                03130001
                                                                        03140001
026100     PERFORM VARYING PV-RPL-IDX FROM 1 BY 1                       03150001
026200        UNTIL PS-END-OF-REPL-CSR                                  03160001
026300           OR PV-RPL-IDX > PV-RPL-MAX                             03170001
026400        EXEC SQL                                                  03180001
026500           FETCH REPLENISH-CSR                                    03190001
026600              INTO :SVT00000-CRD-PROD-YR                          03200001
026700                 , :SVT00000-SHIPT-REQ-NBR                        03210001
026800                 , :SVT00000-CRD-TYP-CDE                          03220001
026900        END-EXEC                                                  03230001
027000        EVALUATE TRUE                                             03240001
027100           WHEN SQLCODE = ZERO                                    03250001
027200              MOVE SVT00000-CRD-PROD-YR                           03260001
027300                                 TO PV-CRD-PROD-YR (PV-RPL-IDX)   03270001
027400              MOVE SVT00000-SHIPT-REQ-NBR                         03280001
027500                                 TO PV-SHIPT-REQ-NBR (PV-RPL-IDX) 03290001
027600              MOVE SVT00000-CRD-TYP-CDE                           03300001
027700                                 TO PV-CRD-TYP-CDE (PV-RPL-IDX)   03310001
027800           WHEN SQLCODE = +100                                    03320001
027900              SET PS-END-OF-REPL-CSR TO TRUE                      03330001
028000           WHEN SQLWARN0 NOT EQUAL SPACE                          03340001
028100           WHEN SQLCODE NOT EQUAL ZERO                            03350001
028200              MOVE 'A120-LOAD-REPLENISH-TBL' TO PV-PARAGRAPH      03360001
028300              MOVE 'ERROR ON FETCH OF REPLENISH-CSR'              03370001
028400                                           TO PV-DB2-OPERATION    03380001
028500              PERFORM Z910-SQL-ABEND                              03390001
028600        END-EVALUATE                                              03400001
028700     END-PERFORM.                                                 03410001
028800     COMPUTE PV-RPL-MAX =  PV-RPL-IDX - 1.                        03420001
028900                                                                  03430001
           EXEC SQL                                                     03440001
               CLOSE REPLENISH-CSR                                      03450001
           END-EXEC.                                                    03460001
                                                                        03470001
           EVALUATE TRUE                                                03480001
               WHEN SQLCODE = ZERO                                      03490001
                    CONTINUE                                            03500001
               WHEN SQLWARN0 NOT EQUAL SPACE                            03510001
               WHEN SQLCODE NOT EQUAL ZERO                              03520001
                    MOVE 'A120-LOAD-REPLENISH-TBL' TO PV-PARAGRAPH      03530001
                    MOVE 'ERROR ON CLOSE OF REPLENISH-CSR'              03540001
                                               TO PV-DB2-OPERATION      03550001
                    PERFORM Z910-SQL-ABEND                              03560001
           END-EVALUATE.                                                03570001
                                                                        03580001
029000******************************************************************03590001
029100*    PROCESS FILES                                               *03600001
029200******************************************************************03610001
029300 A200-PROCESS-SVT-ACCT.                                           03620001
029400                                                                  03630001
029500     IF  KMCTBL-CRD-STAT-CDE      = SV004-CRD-STAT-TYP-CORP       03640001
C12521     AND (KMCTBL-CRD-CLO-DTE      < PV-390-DAYS-AGO               03650001
C12521     OR   KMCTBL-CRD-STAT-CHG-DTE < PV-390-DAYS-AGO)              03660001
030110         MOVE KMCTBL-CRD-NBR       TO HBT-CRD-NBR                 03670001
030120         MOVE KMCTBL-CRD-CLO-DTE   TO HBT-CRD-CLO-DTE             03680001
030120         MOVE SPACES               TO HBT-CRD-CLO-TM              03690001
030130         MOVE 'N'                  TO HBT-CLO-FLG                 03700001
030200         PERFORM X300-WRITE-SVT-HIST                              03710001
030600     END-IF.                                                      03720001
030610                                                                  03730001
030700*    IF KMCTBL-CRD-STAT-CDE = SV004-CRD-STAT-TYP-CANCELLED        03740001
030800*       IF KMCTBL-CRD-CLO-DTE < PV-60-DAYS-AGO                    03750001
030801*          MOVE KMCTBL-CRD-NBR     TO HBT-CRD-NBR                 03760001
030802*          MOVE KMCTBL-CRD-CLO-DTE TO HBT-CRD-CLO-DTE             03770001
030802*          MOVE SPACES             TO HBT-CRD-CLO-TM              03780001
030803*          MOVE 'N'                TO HBT-CLO-FLG                 03790001
030804*          PERFORM X300-WRITE-SVT-HIST                            03800001
030805*       ELSE                                                      03810001
030810*          IF  KMCTBL-CRD-CLO-DTE = SV004-DEFAULT-DATE            03820001
030820*          AND KMCTBL-CRD-STAT-CHG-DTE < PV-60-DAYS-AGO           03830001
030830*             MOVE KMCTBL-CRD-NBR          TO HBT-CRD-NBR         03840001
030840*             MOVE KMCTBL-CRD-STAT-CHG-DTE TO HBT-CRD-CLO-DTE     03850001
030840*             MOVE KMCTBL-CRD-STAT-CHG-TM  TO HBT-CRD-CLO-TM      03860001
030850*             MOVE 'Y'                     TO HBT-CLO-FLG         03870001
030900*             PERFORM X300-WRITE-SVT-HIST                         03880001
031000*          END-IF                                                 03890001
031100*       END-IF                                                    03900001
031110*    END-IF.                                                      03910001
031111                                                                  03920001
031120     IF  KMCTBL-CRD-STAT-CDE = SV004-CRD-STAT-TYP-EXPIRED         03930001
C12521     AND KMCTBL-CRD-STAT-CHG-DTE < PV-390-DAYS-AGO                03940001
031192        MOVE KMCTBL-CRD-NBR          TO HBT-CRD-NBR               03950001
031193        MOVE KMCTBL-CRD-STAT-CHG-DTE TO HBT-CRD-CLO-DTE           03960001
031193        MOVE KMCTBL-CRD-STAT-CHG-TM  TO HBT-CRD-CLO-TM            03970001
031194        MOVE 'Y'                     TO HBT-CLO-FLG               03980001
031195        PERFORM X300-WRITE-SVT-HIST                               03990001
031198     END-IF.                                                      04000001
031199                                                                  04010001
031200     IF  KMCTBL-CRD-STAT-CDE = SV004-CRD-STAT-TYP-AVAILABLE       04020001
C12521        IF KMCTBL-CRD-CLO-DTE < PV-390-DAYS-AGO                   04030001
031202           MOVE KMCTBL-CRD-NBR     TO HBT-CRD-NBR                 04040001
031203           MOVE KMCTBL-CRD-CLO-DTE TO HBT-CRD-CLO-DTE             04050001
031203           MOVE SPACES             TO HBT-CRD-CLO-TM              04060001
031204           MOVE 'N'                TO HBT-CLO-FLG                 04070001
031205           PERFORM X300-WRITE-SVT-HIST                            04080001
031206        ELSE                                                      04090001
                 SET NOT-REPLENISH-CARD TO TRUE                         04100001
                 PERFORM VARYING PV-RPL-IDX FROM 1 BY 1                 04110001
                 UNTIL PV-RPL-IDX > PV-RPL-MAX                          04120001
                    IF  KMCTBL-CRD-PROD-YR   =                          04130001
                                         PV-CRD-PROD-YR (PV-RPL-IDX)    04140001
                    AND KMCTBL-SHIPT-REQ-NBR =                          04150001
                                         PV-SHIPT-REQ-NBR (PV-RPL-IDX)  04160001
                    AND KMCTBL-CRD-TYP-CDE =                            04170001
                                         PV-CRD-TYP-CDE (PV-RPL-IDX)    04180001
                       SET REPLENISH-CARD TO TRUE                       04190001
                       MOVE PV-RPL-MAX    TO PV-RPL-IDX                 04200001
                    END-IF                                              04210001
                 END-PERFORM                                            04220001
                 IF NOT-REPLENISH-CARD                                  04230001
031208              SET NO-CHANGE-SVT-ACCT TO TRUE                      04240001
031209              MOVE SV004-DEFAULT-DATE TO PV-LAST-AUTH-DTE         04250001
031209              MOVE SV004-DEFAULT-TIME TO PV-LAST-AUTH-TM          04260001
031210              PERFORM B200-ACCUM-SVT-TXN                          04270001
031211                   UNTIL CHANGE-SVT-ACCT                          04280001
031212                   OR    END-OF-SVT-TXN                           04290001
031213              IF PV-APP-AUTH-AMT = ZERO                           04300001
C12521              AND PV-LAST-AUTH-DTE < PV-390-DAYS-AGO              04310001
031215                 MOVE KMCTBL-CRD-NBR     TO HBT-CRD-NBR           04320001
031216                 MOVE PV-LAST-AUTH-DTE   TO HBT-CRD-CLO-DTE       04330001
031216                 MOVE PV-LAST-AUTH-TM    TO HBT-CRD-CLO-TM        04340001
031217                 MOVE 'Y'                TO HBT-CLO-FLG           04350001
031218                 PERFORM X300-WRITE-SVT-HIST                      04360001
031220              END-IF                                              04370001
031221              MOVE ZEROS TO PV-APP-AUTH-AMT                       04380001
031220           END-IF                                                 04390001
031223     END-IF.                                                      04400001
031230                                                                  04410001
031300     PERFORM X100-READ-SVT-ACCT.                                  04420001
031400                                                                  04430001
031500******************************************************************04440001
031600 A300-CLEANUP.                                                    04450001
031700     CLOSE SVT-ACCT                                               04460001
031800           SVT-TXN                                                04470001
031810           SVT-CNT                                                04480001
031900           SVT-HIST.                                              04490001
032000                                                                  04500001
032100     PERFORM X800-DISPLAY-CNT.                                    04510001
032200                                                                  04520001
032300******************************************************************04530001
032400 B200-ACCUM-SVT-TXN.                                              04540001
032500     IF KMCTBL-CRD-NBR = KMCACT-CRD-NBR                           04550001
032600        ADD KMCACT-APP-AUTH-AMT TO PV-APP-AUTH-AMT                04560001
032610        IF PV-LAST-AUTH-DTE = SV004-DEFAULT-DATE                  04570001
032620        OR PV-LAST-AUTH-DTE < KMCACT-AUTH-TMST                    04580001
032630           MOVE KMCACT-AUTH-DTE  TO PV-LAST-AUTH-DTE              04590001
032630           MOVE KMCACT-AUTH-TM   TO PV-LAST-AUTH-TM               04600001
032640        END-IF                                                    04610001
032700        PERFORM X200-READ-SVT-TXN                                 04620001
032800     ELSE                                                         04630001
032900        IF KMCTBL-CRD-NBR > KMCACT-CRD-NBR                        04640001
033000           PERFORM X200-READ-SVT-TXN                              04650001
033100        ELSE                                                      04660001
033200           SET CHANGE-SVT-ACCT TO TRUE                            04670001
033300        END-IF                                                    04680001
033400     END-IF.                                                      04690001
033500                                                                  04700001
033600******************************************************************04710001
033700 X100-READ-SVT-ACCT.                                              04720001
033800     READ SVT-ACCT INTO KMCTBL-RCD                                04730001
033900          AT END                                                  04740001
034000             SET END-OF-SVT-ACCT TO TRUE                          04750001
034100          NOT AT END                                              04760001
034200             ADD 1 TO PA-READ-TBL                                 04770001
034300     END-READ.                                                    04780001
034400                                                                  04790001
034500******************************************************************04800001
034600 X200-READ-SVT-TXN.                                               04810001
034700     READ SVT-TXN INTO KMCACT-RCD                                 04820001
034800          AT END                                                  04830001
034900             SET END-OF-SVT-TXN TO TRUE                           04840001
035000             MOVE 999999999999  TO KMCACT-CRD-NBR                 04850001
035100          NOT AT END                                              04860001
035200             ADD 1 TO PA-READ-ACT                                 04870001
035300     END-READ.                                                    04880001
035400                                                                  04890001
035500******************************************************************04900001
035600 X300-WRITE-SVT-HIST.                                             04910001
035700                                                                  04920001
035800     WRITE HTB-FILE FROM HBT-RCD.                                 04930001
035900     ADD 1 TO  PA-WRITE-TBL.                                      04940001
035910     IF PA-WRITE-TBL >= CNT-CC-NBR-ACCTS                          04950001
036000        SET END-OF-SVT-ACCT TO TRUE                               04960001
036001     END-IF.                                                      04970001
036010                                                                  04980001
036100******************************************************************04990001
036200 X800-DISPLAY-CNT.                                                05000001
036300                                                                  05010001
036400     DISPLAY 'MESSAGES FOR PROGRAM ' PC-PROGRAM-NAME              05020001
036500     DISPLAY 'SVT_KOHLS_CRD_TXN READ          : ' PA-READ-ACT.    05030001
036600     DISPLAY 'SVT_KOHLS_CRD_ACCT READ         : ' PA-READ-TBL.    05040001
036700     DISPLAY 'SVT_CRD_ACCT_HIST  WRITTEN      : ' PA-WRITE-TBL.   05050001
036800     MOVE FUNCTION CURRENT-DATE    TO PV-CURRENT-DATE-TIME.       05060001
036900     DISPLAY 'END  : ' PV-CURRENT-TIME.                           05070001
037000                                                                  05080001
037100***************************************************************** 05090001
037200*    ABEND PROCESSING FOR ERRORS.                                 05100001
037300***************************************************************** 05110001
037400 Z900-DATE-ABEND.                                                 05120001
037500     DISPLAY ' '.                                                 05130001
037600     DISPLAY '** ABEND     **'.                                   05140001
037700     DISPLAY '** PROGRAM   **  = ' PC-PROGRAM-NAME.               05150001
037800     DISPLAY '** PARAGRAPH **  = ' PV-PARAGRAPH.                  05160001
037900     DISPLAY '** BAD CALL TO CALENDAR MODULE '.                   05170001
038000     DISPLAY DPG54-ERROR-MESSAGE.                                 05180001
      ******************************************************************05190001
      * COPYBOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED      05200001
      * TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS       05210001
      ******************************************************************05220001
                                                                        05230001
           COPY DPPD004.                                                05240001
                                                                        05250001
           MOVE +4019 TO ABEND-CODE.                                    05260001
           CALL 'ILBOABN0' USING ABEND-CODE.                            05270001
038100                                                                  05280001
038200******************************************************************05290001
038300* Z910-SQL-ABEND - PERFORMS THE ABEND FOR THE PROGRAM IN THE      05300001
038400* EVENT THAT AN SQL ERROR OR WARNING CODE OCCURS.                 05310001
038500******************************************************************05320001
038600 Z910-SQL-ABEND.                                                  05330001
038700     DISPLAY '** ABEND     **'.                                   05340001
038800     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                05350001
038900     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH.                   05360001
039000     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               05370001
                                                                        05380001
      ******************************************************************05390001
      * THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    05400001
      * MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         05410001
      * 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     05420001
      * FORMAT.                                                         05430001
      ******************************************************************05440001
           COPY DPPD004.                                                05450001
                                                                        05460001
           MOVE +4008 TO ABEND-CODE.                                    05470001
           CALL 'ILBOABN0' USING ABEND-CODE.                            05480001
