000100DYNAM,LIB,OBJECT,RENT,RES,APOST                                   00010000
000200* ------------------------------------------------------------- * 00020000
000300 IDENTIFICATION DIVISION.                                         00030000
000400* ------------------------------------------------------------- * 00040000
000500 PROGRAM-ID. DPKUT200.                                            00050000
000600*                                                                 00060000
000700* ------------------------------------------------------------- * 00070000
000800 ENVIRONMENT DIVISION.                                            00080000
000900* ------------------------------------------------------------- * 00090000
001000 INPUT-OUTPUT SECTION.                                            00100000
001100 FILE-CONTROL.                                                    00110000
001200     SELECT SYSPRINT ASSIGN TO UT-S-SYSPRINT.                     00120000
001300     SELECT INTRDR   ASSIGN TO UT-S-INTRDR.                       00130000
001400* ------------------------------------------------------------- * 00140000
001500 DATA DIVISION.                                                   00150000
001600* ------------------------------------------------------------- * 00160000
001700 FILE SECTION.                                                    00170000
001800 FD  SYSPRINT                                                     00180000
001900     BLOCK CONTAINS 0 RECORDS                                     00190000
002000     RECORDING MODE IS F.                                         00200000
002100 01  PR-PRINT-REC.                                                00210000
002200     05  PR-CARRIAGE-CONTROL     PIC X.                           00220000
002300     05  PR-PRINT-DATA           PIC X(132).                      00230000
002400 FD  INTRDR                                                       00240000
002500     BLOCK CONTAINS  0 RECORDS                                    00250000
002600     RECORDING MODE IS F.                                         00260000
002700 01  ID-INTRDR-DATA              PIC X(80).                       00270000
002800* ------------------------------------------------------------- * 00280000
002900 WORKING-STORAGE SECTION.                                         00290000
003000* ------------------------------------------------------------- * 00300000
003100*                                                                 00310000
003200*    GENERAL WORK FIELDS                                          00320000
003300*                                                                 00330000
003400 01  ID-INPUT-DATE.                                               00340000
003500     05  ID-YEAR                 PIC 99.                          00350000
003600     05  ID-MONTH                PIC 99.                          00360000
003700     05  ID-DAY                  PIC 99.                          00370000
003800 01  IT-INPUT-TIME.                                               00380000
003900     05  IT-HOURS                PIC 99.                          00390000
004000     05  IT-MINUTES              PIC 99.                          00400000
004100     05  IT-SECONDS              PIC 99.                          00410000
004200     05  IT-HUNDRETHS            PIC 99.                          00420000
004400 01  RC-RETURN-CODE              PIC S9(04) BINARY  VALUE ZERO.   00440000
004401 01  WS-WORKING-STORAGE.                                          00440100
004402     05  WS-MQCONN               PIC X(8)  VALUE 'CSQBCONN'.      00440200
004403     05  WS-MQOPEN               PIC X(8)  VALUE 'CSQBOPEN'.      00440300
004404     05  WS-MQINQ                PIC X(8)  VALUE 'CSQBINQ'.       00440400
004405     05  WS-MQGET                PIC X(8)  VALUE 'CSQBGET'.       00440500
004406     05  WS-MQPUT1               PIC X(8)  VALUE 'CSQBPUT1'.      00440600
004407     05  WS-MQCMIT               PIC X(8)  VALUE 'CSQBCOMM'.      00440700
004408     05  WS-MQBACK               PIC X(8)  VALUE 'CSQBBACK'.      00440800
004410     05  WS-MQCLOSE              PIC X(8)  VALUE 'CSQBCLOS'.      00441000
004500     05  WS-MQDISC               PIC X(8)  VALUE 'CSQBDISC'.      00450000
004600*                                                                 00460000
004700*    LINES OF THE PRINT REPORT                                    00470000
004800*                                                                 00480000
004900 01  H1-HEADER-1.                                                 00490000
005000     05  FILLER                  PIC X(10) VALUE SPACES.          00500000
005100     05  H1-MM                   PIC 99.                          00510000
005200     05  FILLER                  PIC X     VALUE '/'.             00520000
005300     05  H1-DD                   PIC 99.                          00530000
005400     05  FILLER                  PIC X     VALUE '/'.             00540000
005500     05  H1-YY                   PIC 99.                          00550000
005600     05  FILLER                  PIC X(8)  VALUE SPACES.          00560000
005700     05  FILLER                  PIC X(21) VALUE                  00570000
005800                                          'Batch Trigger Monitor'.00580000
005900     05  FILLER                  PIC X(85) VALUE SPACES.          00590000
006000 01  H2-HEADER-2.                                                 00600000
006100     05  FILLER                  PIC X(5)  VALUE SPACES.          00610000
006200     05  FILLER                  PIC X(29) VALUE                  00620000
006300                                 '        Queue Manager Name : '. 00630000
006400     05  H2-MQM-NAME             PIC X(48) VALUE SPACES.          00640000
006500     05  FILLER                  PIC X(50) VALUE SPACES.          00650000
006600 01  H3-HEADER-3.                                                 00660000
006700     05  FILLER                  PIC X(17) VALUE SPACES.          00670000
006800     05  FILLER                  PIC X(17) VALUE                  00680000
006900                                              ' Trigger Queue : '.00690000
007000     05  H3-QUEUE-NAME           PIC X(48) VALUE SPACES.          00700000
007100     05  FILLER                  PIC X(50) VALUE SPACES.          00710000
007200 01  H4-HEADER-4.                                                 00720000
007300     05  H4-HOURS                PIC X(2).                        00730000
007400     05  FILLER                  PIC X VALUE ':'.                 00740000
007500     05  H4-MINUTES              PIC X(2).                        00750000
007600     05  FILLER                  PIC X VALUE ':'.                 00760000
007700     05  H4-SECONDS              PIC X(2).                        00770000
007800     05  FILLER                  PIC X(3)  VALUE SPACES.          00780000
007900     05  H4-HEADER-4-DATA        PIC X(80) VALUE SPACES.          00790000
008000 01  H5-HEADER-5.                                                 00800000
008100     05  FILLER                  PIC X(11) VALUE SPACES.          00810000
008200     05  H5-HEADER-5-DATA        PIC X(69) VALUE SPACES.          00820000
008300*                                                                 00830000
008400*    DATA FIELDS DERIVED FROM THE PARM FIELD                      00840000
008500*                                                                 00850000
008600 01  IP-INPUT-PARMS.                                              00860000
008610     05  IP-MQM                      PIC X(48) VALUE SPACES.      00861000
008700     05  IP-OBJECT                   PIC X(48) VALUE SPACES.      00870000
008800*                                                                 00880000
008900*    MQM API FIELDS                                               00890000
009000*                                                                 00900000
009100 01  AF-API-FIELDS.                                               00910013
009110     05  AF-BUFFER-LENGTH            PIC S9(9) BINARY  VALUE 800. 00911013
009200     05  AF-HCONN                    PIC S9(9) BINARY.            00920013
009300     05  AF-OPTIONS                  PIC S9(9) BINARY.            00930013
009400     05  AF-HOBJ                     PIC S9(9) BINARY.            00940013
009500     05  AF-DATA-LENGTH              PIC S9(9) BINARY.            00950013
009600     05  AF-COMPCODE                 PIC S9(9) BINARY.            00960013
009700     05  AF-REASON                   PIC S9(9) BINARY.            00970013
009800     05  AF-MESSAGE-DATA.                                         00980013
009908         10 MQTM-STRUCTURE.                                       00990813
009910             15 AF-STRUCID       PIC X(4) VALUE 'TM  '.           00991014
009912             15 AF-VERSION       PIC S9(9) BINARY VALUE 1.        00991214
009914             15 AF-QNAME         PIC X(48) VALUE SPACES.          00991414
009916             15 AF-PROCESSNAME PIC X(48) VALUE SPACES.            00991614
009918             15 AF-TRIGGERDATA PIC X(64) VALUE SPACES.            00991814
009920             15 AF-APPLTYPE      PIC S9(9) BINARY VALUE 0.        00992014
009922             15 AF-APPLID        PIC X(256) VALUE SPACES.         00992214
009924             15 AF-ENVDATA       PIC X(128) VALUE SPACES.         00992414
009926             15 AF-USERDATA      PIC X(128) VALUE SPACES.         00992614
010000 01 AA-APPLID-ARRAY.                                              01000000
010100     05 AA-APPLID-ARRAY-1.                                        01010000
010110        10 AA-1-SLASH                  PIC XX.                    01011000
010120        10 FILLER                      PIC X(62).                 01012000
010200     05 AA-APPLID-ARRAY-2.                                        01020000
010210        10 AA-2-SLASH                  PIC XX.                    01021000
010220        10 FILLER                      PIC X(62).                 01022000
010300     05 AA-APPLID-ARRAY-3.                                        01030000
010310        10 AA-3-SLASH                  PIC XX.                    01031000
010320        10 FILLER                      PIC X(62).                 01032000
010400     05 AA-APPLID-ARRAY-4.                                        01040000
010410        10 AA-4-SLASH                  PIC XX.                    01041000
010420        10 FILLER                      PIC X(62).                 01042000
010500 01 EA-ENVDATA-ARRAY.                                             01050000
010600     05 EA-ENVDATA-ARRAY-1.                                       01060000
010610        10 EA-1-SLASH                 PIC XX.                     01061000
010620        10 FILLER                      PIC X(62).                 01062000
010700     05 EA-ENVDATA-ARRAY-2.                                       01070000
010710        10 EA-2-SLASH                  PIC XX.                    01071000
010720        10 FILLER                      PIC X(62).                 01072000
010800 01 UA-USERDATA-ARRAY.                                            01080000
010900     05 UA-USERDATA-ARRAY-1.                                      01090000
010910        10 UA-1-SLASH                  PIC XX.                    01091000
010920        10 FILLER                      PIC X(62).                 01092000
011000     05 UA-USERDATA-ARRAY-2.                                      01100000
011010        10 UA-2-SLASH                  PIC XX.                    01101000
011020        10 FILLER                      PIC X(62).                 01102000
011100*                                                                 01110000
011200*    ERROR AND INFORMATION MESSAGES                               01120000
011300*                                                                 01130000
011400 01  MESSAGES.                                                    01140000
011401     05  M-MESSAGE-0.                                             01140100
011402         10  FILLER              PIC X(53) VALUE                  01140200
011403                ' ********** TERMINATION MESSAGE RECEIVED FROM: '.01140300
011404         10  M-USERID            PIC X(8) VALUE SPACES.           01140400
011405         10  FILLER              PIC X(71) VALUE SPACES.          01140500
011406     05  M-MESSAGE-1.                                             01140600
011407         10  FILLER              PIC X(10)  VALUE SPACES.         01140700
011408         10  FILLER              PIC X(122) VALUE                 01140800
011409        '********** NO DATA PASSED TO PROGRAM. PROGRAM REQUIRES A 01140900
011410-       'QUEUE MANAGER NAME AND A QUEUE NAME. **********'.        01141000
011411     05  M-MESSAGE-2.                                             01141100
011412         10  FILLER              PIC X(25)  VALUE SPACES.         01141200
011413         10  FILLER              PIC X(107) VALUE                 01141300
011414        '********** NO QUEUE MANAGER NAME PASSED TO PROGRAM - DEFA01141400
011415-       'ULT USED *****'.                                         01141500
011416     05  M-MESSAGE-3.                                             01141600
011417         10  FILLER              PIC X(38) VALUE SPACES.          01141700
011418         10  FILLER              PIC X(94) VALUE                  01141800
011419        '********** NO QUEUE NAME PASSED TO PROGRAM. **********'. 01141900
011420     05  M-MESSAGE-4.                                             01142000
011421         10  FILLER              PIC X(13) VALUE SPACES.          01142100
011422         10  FILLER              PIC X(32) VALUE                  01142200
011423             '********** AN ERROR OCCURRED IN '.                  01142300
011424         10  M-MSG4-TYPE         PIC X(10).                       01142400
011425         10  FILLER              PIC X(20) VALUE                  01142500
011426             '. COMPLETION CODE = '.                              01142600
011427         10  M-MSG4-COMPCODE     PIC Z(8)9.                       01142700
011428         10  FILLER              PIC X(15) VALUE ' REASON CODE ='.01142800
011430         10  M-MSG4-REASON       PIC Z(8)9.                       01143000
011500         10  FILLER              PIC X(24) VALUE ' **********'.   01150000
014400*                                                                 01440000
014500*    The following copy files define API control blocks.          01450000
014600*                                                                 01460000
014700 01  MQM-OBJECT-DESCRIPTOR.                                       01470000
014800     COPY CMQODV.                                                 01480000
014900 01  MQM-MESSAGE-DESCRIPTOR.                                      01490000
015000     COPY CMQMDV.                                                 01500000
015100 01  MQM-GET-MESSAGE-OPTIONS.                                     01510000
015200     COPY CMQGMOV.                                                01520000
015300*                                                                 01530000
015400*    Copy file of constants (for filling in the control blocks)   01540000
015500*    and return codes (for testing the result of a call)          01550000
015600*                                                                 01560000
015700 01  MQM-CONSTANTS.                                               01570000
015800     COPY CMQV.                                                   01580000
015900*                                                                 01590000
016000*    RETURN VALUES                                                01600000
016100*                                                                 01610000
016200 01  RV-RETURN-VALUES.                                            01620000
016210     05  RV-CSQ4-OK              PIC S9(4) VALUE 0.               01621000
016300     05  RV-CSQ4-WARNING         PIC S9(4) VALUE 4.               01630000
016400     05  RV-CSQ4-ERROR           PIC S9(4) VALUE 8.               01640000
016500*                                                                 01650000
016600*    END OF JOB INDICATOR                                         01660000
016700*                                                                 01670000
016800 01  E-ENDJOB.                                                    01680000
016810     05  E-END-JOB               PIC 9 VALUE IS 0.                01681000
016900         88 E-END-OF-JOB         VALUE IS 1.                      01690000
017000     05  EO-TRUE                 PIC 9 VALUE 1.                   01700000
017100* ------------------------------------------------------------- * 01710000
017200*    ADDITIONAL JOB CARDS TO WRITE OUT                            01720000
017300* ------------------------------------------------------------- * 01730000
017400 01  AC-ADDITIONAL-CARDS.                                         01740000
017410     05  AC-SUBMITED-BY-CARD.                                     01741000
017500         10 FILLER               PIC X(4)  VALUE '//* '.          01750000
017600         10 FILLER               PIC X(76) VALUE                  01760000
017700                          'JOB SUBMITTED BY DPKUT200'.            01770000
017800     05  AC-EOF-CARD             PIC X(80) VALUE                  01780000
017900         '/*EOF'.                                                 01790000
018200* ------------------------------------------------------------- * 01820000
018300 LINKAGE SECTION.                                                 01830000
018400* ------------------------------------------------------------- * 01840000
018500 01  P-PARMDATA.                                                  01850000
018600     05  P-PARM-LEN              PIC S9(03) BINARY.               01860000
018700     05  P-PARM-STRING           PIC X(100).                      01870000
018800*                                                                 01880000
018900     EJECT                                                        01890000
019000* ------------------------------------------------------------- * 01900000
019100 PROCEDURE DIVISION USING P-PARMDATA.                             01910000
019200* ------------------------------------------------------------- * 01920000
019300* ------------------------------------------------------------- * 01930000
019400 A-MAIN SECTION.                                                  01940000
019500* ------------------------------------------------------------- * 01950000
019600*                                                               * 01960000
019700* This section receives the names of the queue manager and the  * 01970000
019800* queue from the PARM statement in the JCL. It opens the queue, * 01980000
019900* reads all the messages, and prints them                       * 01990000
020000*                                                               * 02000000
020100* ------------------------------------------------------------- * 02010000
020200*                                                                 02020000
020300*    Open the print file, initialize the fields for the           02030000
020400*    header date and the page number, and print the first         02040000
020500*    line of the header                                           02050000
020600*                                                                 02060000
020700     OPEN OUTPUT SYSPRINT.                                        02070000
020800*                                                                 02080000
020900     ACCEPT ID-INPUT-DATE FROM DATE.                              02090000
021000     MOVE ID-MONTH TO H1-MM.                                      02100000
021100     MOVE ID-DAY TO H1-DD.                                        02110000
021200     MOVE ID-YEAR TO H1-YY.                                       02120000
021300*                                                                 02130000
021400     MOVE H1-HEADER-1 TO PR-PRINT-DATA.                           02140000
021500     WRITE PR-PRINT-REC AFTER ADVANCING PAGE.                     02150000
021600*                                                                 02160000
021700*    If no data was passed, create a message, print it, and       02170000
021800*    exit                                                         02180000
021900*                                                                 02190000
022000     IF P-PARM-LEN = 0 THEN                                       02200000
022100        MOVE M-MESSAGE-1 TO PR-PRINT-DATA                         02210000
022200        WRITE PR-PRINT-REC                                        02220000
022300        MOVE RV-CSQ4-WARNING TO RC-RETURN-CODE                    02230000
022400        GO TO A-MAIN-END                                          02240000
022500     END-IF.                                                      02250000
022600*                                                                 02260000
022700*    Separate into the relevant fields any data passed in the     02270000
022800*    PARM statement                                               02280000
022900*                                                                 02290000
023000     UNSTRING P-PARM-STRING DELIMITED BY ALL ','                  02300000
023100                             INTO IP-MQM                          02310000
023200                                  IP-OBJECT.                      02320000
023300*                                                                 02330000
023400*    Move the data (spaces if nothing is entered) into the        02340000
023500*    relevant print fields                                        02350000
023600*                                                                 02360000
023700     MOVE IP-MQM     TO H2-MQM-NAME.                              02370000
023800     MOVE IP-OBJECT TO H3-QUEUE-NAME.                             02380000
023900*                                                                 02390000
024000*    Print a message if the queue manager name is missing, the    02400000
024100*    default queue manager will be used                           02410000
024200*                                                                 02420000
024300     IF IP-MQM = SPACES OR IP-MQM = LOW-VALUES THEN               02430000
024400        MOVE M-MESSAGE-2 TO PR-PRINT-DATA                         02440000
024500        WRITE PR-PRINT-REC                                        02450000
024600     END-IF.                                                      02460000
024700*                                                                 02470000
024800*    Print a message if the queue name is missing and exit from   02480000
024900*    program                                                      02490000
025000*                                                                 02500000
025100     IF IP-OBJECT = SPACES OR IP-OBJECT = LOW-VALUES THEN         02510000
025200        MOVE M-MESSAGE-3 TO PR-PRINT-DATA                         02520000
025300        WRITE PR-PRINT-REC                                        02530000
025400        MOVE RV-CSQ4-WARNING TO RC-RETURN-CODE                    02540000
025500        GO TO A-MAIN-END                                          02550000
025600     END-IF.                                                      02560000
025700*                                                                 02570000
025800*    Print the remaining header lines                             02580000
025900*                                                                 02590000
026000     MOVE H2-HEADER-2 TO PR-PRINT-DATA.                           02600000
026100     WRITE PR-PRINT-REC AFTER ADVANCING 2.                        02610000
026200*                                                                 02620000
026300     MOVE H3-HEADER-3 TO PR-PRINT-DATA.                           02630000
026400     WRITE PR-PRINT-REC AFTER ADVANCING 1.                        02640000
026500*                                                                 02650000
026600*    Connect to the specified queue manager.                      02660000
026700*                                                                 02670000
026800     CALL WS-MQCONN USING IP-MQM                                  02680000
026900                         AF-HCONN                                 02690013
027000                         AF-COMPCODE                              02700013
027100                         AF-REASON.                               02710013
027200*                                                                 02720000
027300*    Test the output of the connect call.  If the call failed,    02730000
027400*    print an error message showing the completion code and       02740000
027500*    reason code                                                  02750000
027600*                                                                 02760000
027700     IF (AF-COMPCODE NOT = MQCC-OK) THEN                          02770013
027800        MOVE 'CONNECT'     TO M-MSG4-TYPE                         02780000
027900        MOVE AF-COMPCODE   TO M-MSG4-COMPCODE                     02790013
028000        MOVE AF-REASON     TO M-MSG4-REASON                       02800013
028100        MOVE M-MESSAGE-4 TO PR-PRINT-DATA                         02810000
028200        WRITE PR-PRINT-REC                                        02820000
028300        MOVE RV-CSQ4-ERROR TO RC-RETURN-CODE                      02830000
028400        GO TO A-MAIN-END                                          02840000
028500     END-IF.                                                      02850000
028600*                                                                 02860000
028700*    Initialize the object descriptor (MQOD) control block.       02870000
028800*    (The copy file initializes all the other fields)             02880000
028900*                                                                 02890000
029000      MOVE IP-OBJECT         TO MQOD-OBJECTNAME.                  02900000
029100*                                                                 02910000
029200*    Initialize the working storage fields required to open       02920000
029300*    the queue                                                    02930000
029400*                                                                 02940000
029500*      AF-OPTIONS IS SET TO OPEN THE QUEUE FOR INPUT              02950013
029600*      AF-HOBJ     is set by the MQOPEN call and is used by the   02960013
029700*                  MQGET and MQCLOSE calls                        02970000
029800*                                                                 02980000
029900     MOVE MQOO-INPUT-AS-Q-DEF TO AF-OPTIONS.                      02990013
030000*                                                                 03000000
030100*    Open the queue.                                              03010000
030200*                                                                 03020000
030300     CALL WS-MQOPEN USING AF-HCONN                                03030013
030400                         MQOD                                     03040000
030500                         AF-OPTIONS                               03050013
030600                         AF-HOBJ                                  03060013
030700                         AF-COMPCODE                              03070013
030800                         AF-REASON.                               03080013
030900*                                                                 03090000
031000*    Test the output of the open call.  If the call failed, print 03100000
031100*    an error message showing the completion code and reason code 03110000
031200*                                                                 03120000
031300     IF (AF-COMPCODE NOT = MQCC-OK) THEN                          03130013
031400        MOVE 'OPEN'        TO M-MSG4-TYPE                         03140000
031500        MOVE AF-COMPCODE   TO M-MSG4-COMPCODE                     03150013
031600        MOVE AF-REASON     TO M-MSG4-REASON                       03160013
031700        MOVE M-MESSAGE-4 TO PR-PRINT-DATA                         03170000
031800        WRITE PR-PRINT-REC                                        03180000
031900        MOVE RV-CSQ4-ERROR TO RC-RETURN-CODE                      03190000
032000        GO TO A-MAIN-DISCONNECT                                   03200000
032100     END-IF.                                                      03210000
032200*                                                                 03220000
032300*    SET THE MQMD ATTRIBUTES                                      03230000
032400*                                                                 03240000
032500     MOVE MQGMO-WAIT TO MQGMO-OPTIONS.                            03250000
032600     ADD MQGMO-NO-SYNCPOINT TO MQGMO-OPTIONS.                     03260000
032700     MOVE MQWI-UNLIMITED TO MQGMO-WAITINTERVAL.                   03270000
032800*                                                                 03280000
032900     PERFORM WITH TEST AFTER                                      03290000
033000             UNTIL AF-COMPCODE NOT = MQCC-OK                      03300013
033100                   OR E-END-OF-JOB                                03310000
033200*                                                                 03320000
033300* SET ATTRIBUTES THAT MUST BE RESET EACH TIME                     03330000
033400*                                                                 03340000
033500        MOVE MQMI-NONE TO MQMD-MSGID                              03350000
033600        MOVE MQCI-NONE TO MQMD-CORRELID                           03360000
033700*                                                                 03370000
033800*       PRINT A LINE SAYING WE'RE WAITING FOR WORK                03380000
033900*                                                                 03390000
034000        ACCEPT IT-INPUT-TIME FROM TIME                            03400000
034100        MOVE IT-HOURS TO H4-HOURS                                 03410000
034200        MOVE IT-MINUTES TO H4-MINUTES                             03420000
034300        MOVE IT-SECONDS TO H4-SECONDS                             03430000
034400        MOVE 'Waiting for Triggering Message' TO                  03440000
034500             H4-HEADER-4-DATA                                     03450000
034600        MOVE H4-HEADER-4 TO PR-PRINT-DATA                         03460000
034700        WRITE PR-PRINT-REC AFTER ADVANCING 2                      03470000
034800*                                                                 03480000
034900*       Get the next message                                      03490000
035000*                                                                 03500000
035100        CALL WS-MQGET USING AF-HCONN                              03510013
035200                           AF-HOBJ                                03520013
035300                           MQMD                                   03530000
035400                           MQGMO                                  03540000
035500                           AF-BUFFER-LENGTH                       03550013
035600                           AF-MESSAGE-DATA                        03560013
035700                           AF-DATA-LENGTH                         03570013
035800                           AF-COMPCODE                            03580013
035900                           AF-REASON                              03590013
036000                                                                  03600000
036100        IF (AF-COMPCODE = MQCC-OK) THEN                           03610013
036200           IF MQMD-MSGTYPE = MQMT-REPORT AND                      03620000
036300              MQMD-FEEDBACK = MQFB-QUIT                           03630000
036400              THEN                                                03640000
036500                 MOVE MQMD-USERIDENTIFIER TO M-USERID             03650000
036600                 MOVE M-MESSAGE-0 TO PR-PRINT-DATA                03660000
036700                 MOVE EO-TRUE TO E-END-JOB                        03670000
036800              ELSE                                                03680000
036900                 PERFORM PROCESS-MESSAGE                          03690000
037000           END-IF                                                 03700000
037100        END-IF                                                    03710000
037200*                                                                 03720000
037300     END-PERFORM.                                                 03730000
037400*                                                                 03740000
037500     IF NOT AF-COMPCODE = MQCC-OK                                 03750013
037600     THEN                                                         03760000
037700        MOVE 'GET'         TO M-MSG4-TYPE                         03770000
037800        MOVE AF-COMPCODE   TO M-MSG4-COMPCODE                     03780013
037900        MOVE AF-REASON     TO M-MSG4-REASON                       03790013
038000        MOVE M-MESSAGE-4 TO PR-PRINT-DATA                         03800000
038100     END-IF.                                                      03810000
038200*                                                                 03820000
038300     WRITE PR-PRINT-REC                                           03830000
038400*                                                                 03840000
038500* Close the queue                                                 03850000
038600*                                                                 03860000
038700     MOVE MQCO-NONE TO AF-OPTIONS.                                03870013
038800*                                                                 03880000
038900     CALL WS-MQCLOSE USING AF-HCONN                               03890013
039000                          AF-HOBJ                                 03900013
039100                          AF-OPTIONS                              03910013
039200                          AF-COMPCODE                             03920013
039300                          AF-REASON.                              03930013
039400*                                                                 03940000
039500*    Test the output of the MQCLOSE call.  If the call failed,    03950000
039600*    print an error message showing the completion code and reason03960000
039700*    code                                                         03970000
039800*                                                                 03980000
039900     IF (AF-COMPCODE NOT = MQCC-OK) THEN                          03990013
040000        MOVE 'CLOSE'       TO M-MSG4-TYPE                         04000000
040100        MOVE AF-COMPCODE   TO M-MSG4-COMPCODE                     04010013
040200        MOVE AF-REASON     TO M-MSG4-REASON                       04020013
040300        MOVE M-MESSAGE-4 TO PR-PRINT-DATA                         04030000
040400        WRITE PR-PRINT-REC                                        04040000
040500        MOVE RV-CSQ4-ERROR TO RC-RETURN-CODE                      04050000
040600     END-IF.                                                      04060000
040700*                                                                 04070000
040800 A-MAIN-DISCONNECT.                                               04080000
040900*                                                                 04090000
041000* Disconnect from the queue manager                               04100000
041100*                                                                 04110000
041200     CALL WS-MQDISC USING AF-HCONN                                04120013
041300                         AF-COMPCODE                              04130013
041400                         AF-REASON.                               04140013
041500*                                                                 04150000
041600*    Test the output of the disconnect call.  If the call failed, 04160000
041700*    print an error message showing the completion code and       04170000
041800*    reason code                                                  04180000
041900*                                                                 04190000
042000     IF (AF-COMPCODE NOT = MQCC-OK) THEN                          04200013
042100        MOVE 'DISCONNECT'  TO M-MSG4-TYPE                         04210000
042200        MOVE AF-COMPCODE   TO M-MSG4-COMPCODE                     04220013
042300        MOVE AF-REASON     TO M-MSG4-REASON                       04230013
042400        MOVE M-MESSAGE-4 TO PR-PRINT-DATA                         04240000
042500        MOVE RV-CSQ4-ERROR TO RC-RETURN-CODE                      04250000
042600        WRITE PR-PRINT-REC                                        04260000
042700     END-IF.                                                      04270000
042800*                                                                 04280000
042900 A-MAIN-END.                                                      04290000
043000*                                                                 04300000
043100*    Set the return code                                          04310000
043200*                                                                 04320000
043300     MOVE RC-RETURN-CODE TO RETURN-CODE.                          04330000
043400*                                                                 04340000
043500*    Close the print file and stop                                04350000
043600*                                                                 04360000
043700     CLOSE SYSPRINT.                                              04370000
043800     STOP RUN.                                                    04380000
043900*                                                                 04390000
044000                                                                  04400000
044100 PROCESS-MESSAGE SECTION.                                         04410000
044200*  ------------------------------------------------------------   04420000
044300*   THIS SECTION IS CALLED WHEN A TRIGGER MEESAGE HAS BEEN READ.  04430000
044400*   IT WILL READ THE TRIGGER MESSAGE TO CREATE THE JCL TO SEND    04440000
044500*   TO THE INTERNAL READER.                                       04450000
044600*  ------------------------------------------------------------   04460000
044700*                                                                 04470000
044800*       PRINT A LINE SAYING WE'VE GOT WORK                        04480000
044900*                                                                 04490000
045000     ACCEPT IT-INPUT-TIME FROM TIME                               04500000
045100     MOVE IT-HOURS TO H4-HOURS                                    04510000
045200     MOVE IT-MINUTES TO H4-MINUTES                                04520000
045300     MOVE IT-SECONDS TO H4-SECONDS                                04530000
045400     MOVE 'Received Trigger Message; Generated JCL follows.' TO   04540000
045500             H4-HEADER-4-DATA                                     04550000
045600        MOVE H4-HEADER-4 TO PR-PRINT-DATA                         04560000
045700        WRITE PR-PRINT-REC AFTER ADVANCING 1                      04570000
045800*                                                                 04580000
045900     OPEN OUTPUT INTRDR.                                          04590000
046000*                                                                 04600000
046100*  Now, Grab the fields of the trigger message to construct JCL   04610000
046200*                                                                 04620000
046300* MOVE JOB CARDS TO INTERNAL READER AND OUTPUT IT                 04630000
046301     MOVE AF-APPLID TO AA-APPLID-ARRAY.                           04630113
046310     IF AA-1-SLASH = '//'                                         04631000
046500          MOVE AA-APPLID-ARRAY-1 TO ID-INTRDR-DATA                04650000
046600          WRITE ID-INTRDR-DATA                                    04660011
046610          MOVE AA-APPLID-ARRAY-1 TO H5-HEADER-5-DATA              04661000
046620          MOVE H5-HEADER-5 TO PR-PRINT-DATA                       04662000
046630          WRITE PR-PRINT-REC.                                     04663000
046640     IF AA-2-SLASH = '//'                                         04664000
046700          MOVE AA-APPLID-ARRAY-2 TO ID-INTRDR-DATA                04670000
046800          WRITE ID-INTRDR-DATA                                    04680011
046810          MOVE AA-APPLID-ARRAY-2 TO H5-HEADER-5-DATA              04681000
046820          MOVE H5-HEADER-5 TO PR-PRINT-DATA                       04682000
046830          WRITE PR-PRINT-REC.                                     04683000
046840     IF AA-3-SLASH = '//'                                         04684000
046900          MOVE AA-APPLID-ARRAY-3 TO ID-INTRDR-DATA                04690000
047000          WRITE ID-INTRDR-DATA                                    04700011
047010          MOVE AA-APPLID-ARRAY-3 TO H5-HEADER-5-DATA              04701000
047020          MOVE H5-HEADER-5 TO PR-PRINT-DATA                       04702000
047030          WRITE PR-PRINT-REC.                                     04703000
047040     IF AA-4-SLASH = '//'                                         04704000
047100          MOVE AA-APPLID-ARRAY-4 TO ID-INTRDR-DATA                04710000
047200          WRITE ID-INTRDR-DATA                                    04720011
048200          MOVE AA-APPLID-ARRAY-4 TO H5-HEADER-5-DATA              04820000
048300          MOVE H5-HEADER-5 TO PR-PRINT-DATA                       04830000
048400          WRITE PR-PRINT-REC.                                     04840000
048500******************************************************************04850000
048501     MOVE AF-ENVDATA TO EA-ENVDATA-ARRAY.                         04850113
048510     IF EA-1-SLASH = '//'                                         04851000
048700          MOVE EA-ENVDATA-ARRAY-1 TO ID-INTRDR-DATA               04870000
048800          WRITE ID-INTRDR-DATA                                    04880011
048810          MOVE EA-ENVDATA-ARRAY-1 TO H5-HEADER-5-DATA             04881000
048820          MOVE H5-HEADER-5 TO PR-PRINT-DATA                       04882000
048830          WRITE PR-PRINT-REC.                                     04883000
048840     IF EA-2-SLASH = '//'                                         04884000
048900          MOVE AF-ENVDATA TO EA-ENVDATA-ARRAY                     04890013
049000          MOVE EA-ENVDATA-ARRAY-2 TO ID-INTRDR-DATA               04900000
049100          WRITE ID-INTRDR-DATA                                    04910011
049500          MOVE EA-ENVDATA-ARRAY-2 TO H5-HEADER-5-DATA             04950000
049600          MOVE H5-HEADER-5 TO PR-PRINT-DATA                       04960000
049700          WRITE PR-PRINT-REC.                                     04970000
049800***************************************************************   04980000
049801     MOVE AF-USERDATA TO UA-USERDATA-ARRAY.                       04980113
049810     IF UA-1-SLASH = '//'                                         04981000
050000          MOVE UA-USERDATA-ARRAY-1 TO ID-INTRDR-DATA              05000000
050100          WRITE ID-INTRDR-DATA                                    05010011
050110          MOVE UA-USERDATA-ARRAY-1 TO H5-HEADER-5-DATA            05011000
050120          MOVE H5-HEADER-5 TO PR-PRINT-DATA                       05012000
050130          WRITE PR-PRINT-REC.                                     05013000
050140     IF UA-2-SLASH = '//'                                         05014000
050200          MOVE UA-USERDATA-ARRAY-2 TO ID-INTRDR-DATA              05020000
050300          WRITE ID-INTRDR-DATA                                    05030011
050700          MOVE UA-USERDATA-ARRAY-2 TO H5-HEADER-5-DATA            05070000
050800          MOVE H5-HEADER-5 TO PR-PRINT-DATA                       05080000
050900          WRITE PR-PRINT-REC.                                     05090000
051000*                                                                 05100000
051100*                                                                 05110000
051200*  PUT THE SUBMITTED BY DPKUT200 CARD                             05120000
051300*                                                                 05130000
051400     MOVE AC-SUBMITED-BY-CARD TO ID-INTRDR-DATA.                  05140000
051500     WRITE ID-INTRDR-DATA.                                        05150011
051600     MOVE AC-SUBMITED-BY-CARD TO H5-HEADER-5-DATA                 05160000
051700     MOVE H5-HEADER-5 TO PR-PRINT-DATA                            05170000
051800     WRITE PR-PRINT-REC.                                          05180000
051810*                                                                 05181000
051820*  Put the JES termination card.                                  05182000
051830*                                                                 05183000
051840     MOVE AC-EOF-CARD TO ID-INTRDR-DATA.                          05184000
051850     WRITE ID-INTRDR-DATA.                                        05185011
051860     MOVE AC-EOF-CARD TO H5-HEADER-5-DATA                         05186000
051870     MOVE H5-HEADER-5 TO PR-PRINT-DATA                            05187000
051880     WRITE PR-PRINT-REC.                                          05188000
051900*                                                                 05190000
052000*  Close the output INTRDR file.                                  05200000
052100*                                                                 05210000
052200     CLOSE INTRDR.                                                05220000
052300*                                                                 05230000
052400 PROCESS-MESSAGE-END.                                             05240000
052500     EXIT.                                                        05250000
052600* --------------------------------------------------------------- 05260000
052700*                  End of program                                 05270000
052800* --------------------------------------------------------------- 05280000
