000100 IDENTIFICATION DIVISION.                                         00010000
000200                                                                  00020000
000300 PROGRAM-ID.             DBKUT035.                                00030000
000400 AUTHOR.                 LARRY SCHLEICHER.                        00040000
000500 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00050000
000600 DATE-WRITTEN.           MAY 2013.                                00060000
000700 DATE-COMPILED.                                                   00070000
000800                                                                  00080000
000900***************************************************************** 00090014
001000***  RUNSTATS DETERMINATION PROGRAM                           *** 00100015
001100***  ------------------------------                           *** 00110015
001200***  THIS PROGRAM WILL GENERATE IBM DB2 RUNSTAT CONTROL CARDS *** 00120001
001300***  FOR NON-PARTITIONED INDEXES WHEN PARTITIONS ON A TABLE   *** 00130017
001300***  ARE REORGED AND THE NON-PARTITIONED INDEXES WERE NOT     *** 00131017
001400***  RUNSTATTED.                                              *** 00140017
001500***************************************************************** 00150000
001600*                                                                 00160000
001700***************************************************************** 00170000
001800***-----------------------------------------------------------*** 00180000
001900***  IMPORTANT!!!                                             *** 00190000
002000***-----------------------------------------------------------*** 00200000
002100***  WHENEVER THIS PROGRAM IS TURNED OVER TO PRODUCTION, A    *** 00210000
002200***  BIND TO DB6P IS REQUIRED.  BIND JCL CAN BE FOUND IN THE  *** 00220017
002300***  FOLLOWING MEMBER:                                        *** 00230000
002400***     TKMD.DB2.CNTL(BINDRS6P)                               *** 00240017
002500***************************************************************** 00250000
002600*                                                                 00260000
002700***************************************************************** 00270000
002800*                                                                 00280000
002900 ENVIRONMENT DIVISION.                                            00290000
003000                                                                  00300000
003100 CONFIGURATION SECTION.                                           00310000
003200                                                                  00320000
003300 SOURCE-COMPUTER.    IBM.                                         00330000
003400 OBJECT-COMPUTER.    IBM.                                         00340000
003500                                                                  00350000
003600 INPUT-OUTPUT SECTION.                                            00360000
003700                                                                  00370000
003800 FILE-CONTROL.                                                    00380000
003900                                                                  00390000
004000     SELECT TS-REORG-FILE                                         00400017
004100         ASSIGN TO IN01.                                          00410000
004200                                                                  00420000
004300     SELECT IX-RUNSTAT-FILE                                       00430017
004400         ASSIGN TO OUT01.                                         00440000
004500                                                                  00450000
004600 DATA DIVISION.                                                   00460000
004700                                                                  00470000
004800 FILE SECTION.                                                    00480000
004900                                                                  00490000
005000 FD  TS-REORG-FILE                                                00500017
005100     RECORDING MODE IS F                                          00510000
005200     BLOCK CONTAINS 0 RECORDS.                                    00520000
005300                                                                  00530000
005400 01  TS-REORG-RECORD            PIC X(080).                       00540017
005500                                                                  00550000
005600 FD  IX-RUNSTAT-FILE                                              00560017
005700     RECORDING MODE IS F                                          00570000
005800     BLOCK CONTAINS 0 RECORDS.                                    00580000
005900                                                                  00590000
006000 01  IX-RUNSTAT-RECORD          PIC X(080).                       00600017
006100                                                                  00610000
006200                                                                  00620000
006300 WORKING-STORAGE SECTION.                                         00630000
006400                                                                  00640000
006500 01  WS-ABEND-CODE                 PIC S9(04) VALUE +0 COMP SYNC. 00650000
006600 01  WS-NO-MORE-INDEXES            PIC X(01)  VALUE 'N'.          00660005
006800 01  WS-IX-STATS-COUNT             PIC S9(04) VALUE +0  COMP.     00680002
006900                                                                  00690002
007000 01  WS-TS-REORG-EOF               PIC X(01)  VALUE 'N'.          00700017
007200                                                                  00720000
008500 01 DP004-DB2-ERROR-FIELDS.                                       00850002
008600     05  DP004-ASTERISK-LINE       PIC  X(80)  VALUE ALL '*'.     00860002
008700     05  DP004-MAX-MESSAGE-LINES   PIC S9(04)  VALUE +12          00870002
008800                                               COMP SYNC.         00880002
008900     05  DP004-ERROR-LINE-LENGTH   PIC S9(09)  VALUE +75          00890002
009000                                               COMP SYNC.         00900002
009100     05  DP004-FORMATTED-MESSAGE.                                 00910002
009200         10  FILLER                PIC S9(04)  VALUE +900         00920002
009300                                               COMP SYNC.         00930002
009400         10  DP004-MESSAGE-LINE    OCCURS 12 TIMES                00940002
009500                                   INDEXED BY DP004-MSG-IDX       00950002
009600                                   PIC  X(75).                    00960002
009700                                                                  00970002
009800 01  WS-REORG-RECORD.                                             00980000
009900     05  FILLER                    PIC X(21).                     00990000
010000     05  WS-DATABASE               PIC X(08).                     01000000
010100     05  FILLER                    PIC X(01).                     01010000
010200     05  WS-TABLESPACE             PIC X(08).                     01020000
010300     05  FILLER                    PIC X(42).                     01030017
010400                                                                  01040017
011000***************************************************************** 01100000
011100*** RUNSTAT INDEX STATEMENTS                                  *** 01110001
011200***************************************************************** 01120000
011300                                                                  01130000
012900 01  WS-OPTIONS-LINE.                                             01131020
013000     05  FILLER                    PIC X(29)   VALUE              01132020
013100     'OPTIONS EVENT(ITEMERROR,SKIP)'.                             01133020
013200                                                                  01134020
011400 01  WS-LISTDEF-LINE.                                             01140020
011500     05  FILLER                    PIC X(14)   VALUE              01150000
011600     'LISTDEF IXLIST'.                                            01160000
011700                                                                  01170000
011800 01  WS-INCLUDE-LINE.                                             01180020
011900     05  FILLER                    PIC X(15)   VALUE              01190000
012000     ' INCLUDE INDEX '.                                           01200000
012100                                                                  01210000
007300 01  WS-IX-CREATOR-NAME            PIC X(80)   VALUE SPACES.      01211020
007400                                                                  01212020
012200 01  WS-RUNSTATS-LINE              PIC X(26)   VALUE              01220020
012300     'RUNSTATS INDEX LIST IXLIST'.                                01230012
012400                                                                  01240000
012500 01  WS-SHRLEVEL-LINE.                                            01250020
012600     05  FILLER                    PIC X(18)   VALUE              01260017
012700     '  SHRLEVEL CHANGE '.                                        01270017
012800                                                                  01280000
013400                                                                  01340000
014000*  SYSIBM.SYSINDEXES                                              01350000
014100     EXEC SQL                                                     01360000
014200         INCLUDE SYSINDEX                                         01370000
014300     END-EXEC.                                                    01380000
014400                                                                  01390000
014500*  SYSIBM.SYSTABLES                                               01400000
014600     EXEC SQL                                                     01410000
014700         INCLUDE SYSTABLE                                         01420000
014800     END-EXEC.                                                    01430000
014900                                                                  01440000
015000*  SYSIBM.SYSINDEXSPACESTATS                                      01450000
015100     EXEC SQL                                                     01460000
015200         INCLUDE SYSRTSIX                                         01470000
015300     END-EXEC.                                                    01480000
015400                                                                  01490000
015500     EXEC SQL                                                     01500002
015600         INCLUDE SQLCA                                            01510002
015700     END-EXEC.                                                    01520002
015800                                                                  01530002
015900                                                                  01540000
016000     EXEC SQL                                                     01550005
016100         DECLARE INDEX-CURSOR CURSOR FOR                          01560005
016200           SELECT DISTINCT(I.NAME), I.CREATOR                     01570012
016300                FROM SYSIBM.SYSTABLES  T                          01580005
016400                ,    SYSIBM.SYSINDEXES I                          01590005
016500                ,    SYSIBM.SYSINDEXSPACESTATS S                  01600005
016600             WHERE T.DBNAME      = :WS-DATABASE                   01610005
016700             AND   T.TSNAME      = :WS-TABLESPACE                 01620005
016800             AND   T.NAME        = I.TBNAME                       01630005
016900             AND   I.NAME        = S.NAME                         01640005
016900             AND   T.CREATOR     = I.CREATOR                      01641019
017000             AND   S.PARTITION   = 0                              01650005
017100             AND   S.REORGLASTTIME <> S.STATSLASTTIME             01660005
017200             WITH UR                                              01670005
017300     END-EXEC.                                                    01680005
017400                                                                  01690000
017600 PROCEDURE DIVISION.                                              01710000
017700                                                                  01720000
018300 0000-PROGRAM-MAINLINE SECTION.                                   01780000
018400                                                                  01790000
018500     OPEN INPUT  TS-REORG-FILE.                                   01800017
018600                                                                  01810000
018700     OPEN OUTPUT IX-RUNSTAT-FILE.                                 01820017
018800                                                                  01830000
020400     PERFORM 1000-READ-TS-REORG-FILE THRU 1000-EXIT               01990017
020500         UNTIL WS-TS-REORG-EOF = 'Y'.                             02000017
020700                                                                  02020000
020800     PERFORM 5000-WRITE-SUMMARY-LINES THRU 5000-EXIT.             02030022
020900                                                                  02040000
021000     CLOSE TS-REORG-FILE                                          02050017
021100           IX-RUNSTAT-FILE.                                       02060017
021200                                                                  02070000
021300     GOBACK.                                                      02080000
021500                                                                  02100000
021600 1000-READ-TS-REORG-FILE.                                         02110017
021700*    DISPLAY '1000-READ-TS-REORG-FILE'.                           02120023
024900                                                                  02440000
025000     READ TS-REORG-FILE INTO WS-REORG-RECORD                      02450017
025100         AT END                                                   02460000
025200             MOVE 'Y'  TO  WS-TS-REORG-EOF                        02470023
025300     END-READ.                                                    02490023
025400                                                                  02491023
025400     IF WS-TS-REORG-EOF = 'N'                                     02500023
026200         PERFORM 2000-GET-IX-DETAILS THRU 2000-EXIT               02570023
026300     END-IF.                                                      02590023
026400                                                                  02591023
026500 1000-EXIT.                                                       02600000
026600      EXIT.                                                       02610000
027000                                                                  02650000
029100 2000-GET-IX-DETAILS.                                             02860022
029200*    DISPLAY '2000-GET-IX-DETAILS'.                               02870023
029300                                                                  02880000
029400***************************************************************** 02890000
029500*** INDEX NAME IS FETCHED FOR THE FOLLOWING REASONS:          *** 02900005
029600*** - INDEX IS A NPI (PARTITION = 0)                          *** 02910025
029700*** - RUNSTATS WERE NOT UPDATED WITH A REORG                  *** 02920025
029800***     (REORGLASTTIME <> STATSLASTTIME)                      *** 02930025
030000***************************************************************** 02950000
030100                                                                  02960000
030200     EXEC SQL                                                     02970005
030300        OPEN INDEX-CURSOR                                         02980005
030400     END-EXEC.                                                    02990005
030500                                                                  03000005
030600     IF  SQLCODE NOT = ZERO                                       03010005
030700         DISPLAY '******************************************'     03020005
030800         DISPLAY '*** PROGRAM ERROR - DBKUT035           ***'     03030005
030900         DISPLAY '***                                    ***'     03040005
031000         DISPLAY '*** PARAGRAPH 2000-GET-IX-DETAILS      ***'     03050022
031100         DISPLAY '*** BAD OPEN ON INDEX-CURSOR           ***'     03060005
031200         DISPLAY '******************************************'     03070005
031300         PERFORM 9999-DB2-ABEND                                   03080023
031300     END-IF.                                                      03081023
031400                                                                  03090005
031500     MOVE 'N' TO WS-NO-MORE-INDEXES.                              03100005
031600                                                                  03110005
031700     PERFORM 3000-FETCH-IX-DETAILS THRU 3000-EXIT                 03120026
031800         UNTIL WS-NO-MORE-INDEXES = 'Y'.                          03130005
031900                                                                  03140005
032000     EXEC SQL                                                     03150005
032100        CLOSE INDEX-CURSOR                                        03160005
032200     END-EXEC.                                                    03170005
032300                                                                  03180005
032400     IF  SQLCODE NOT = ZERO                                       03190005
032500         DISPLAY '******************************************'     03200005
032600         DISPLAY '*** PROGRAM ERROR - DBKUT035           ***'     03210005
032700         DISPLAY '***                                    ***'     03220005
032800         DISPLAY '*** PARAGRAPH 2000-GET-IX-DETAILS      ***'     03230022
032900         DISPLAY '*** BAD CLOSE ON INDEX-CURSOR          ***'     03240005
033000         DISPLAY '******************************************'     03250005
033100         PERFORM 9999-DB2-ABEND                                   03260023
033100     END-IF.                                                      03270023
033300                                                                  03280005
033400 2000-EXIT.                                                       03290022
033500     EXIT.                                                        03300005
033700                                                                  03320000
033800 3000-FETCH-IX-DETAILS.                                           03330026
033900*    DISPLAY '3000-FETCH-IX-DETAILS'.                             03340026
034100                                                                  03360005
034200     MOVE SPACES TO SYSINDEX-NAME-TEXT.                           03370012
034300     MOVE SPACES TO SYSINDEX-CREATOR-TEXT.                        03380012
034400                                                                  03390005
034500     EXEC SQL                                                     03400005
034600         FETCH INDEX-CURSOR                                       03410005
034700             INTO :SYSINDEX-NAME,                                 03420012
034800                  :SYSINDEX-CREATOR                               03430012
034900     END-EXEC.                                                    03440005
035000                                                                  03450005
035100     IF SQLCODE = +0                                              03460005
035200         PERFORM 4000-WRITE-DETAIL-LINE THRU 4000-EXIT            03470025
035300     ELSE                                                         03480005
035400         IF SQLCODE = +100                                        03490005
035500             MOVE 'Y' TO WS-NO-MORE-INDEXES                       03500005
035700         ELSE                                                     03520005
035800             DISPLAY '*****************************************'  03530005
035900             DISPLAY '*** PROGRAM ERROR - DBKUT035          ***'  03540005
036000             DISPLAY '***                                   ***'  03550005
036100             DISPLAY '*** PARAGRAPH 3000-FETCH-IX-DETAILS   ***'  03560026
036200             DISPLAY '*** BAD FETCH ON INDEX-CURSOR         ***'  03570005
036300             DISPLAY '*****************************************'  03580005
036400             PERFORM 9999-DB2-ABEND                               03590023
036400         END-IF                                                   03591023
036400     END-IF.                                                      03592023
036500                                                                  03600005
036600 3000-EXIT.                                                       03610022
036700     EXIT.                                                        03620000
036900                                                                  03640000
037000 4000-WRITE-DETAIL-LINE.                                          03650025
037100*    DISPLAY '4000-WRITE-DETAIL-LINE'.                            03660025
037200                                                                  03670000
037700     ADD +1 TO WS-IX-STATS-COUNT.                                 03720002
037800                                                                  03730000
037900     IF WS-IX-STATS-COUNT = 1                                     03740002
038000         WRITE IX-RUNSTAT-RECORD FROM WS-OPTIONS-LINE             03750017
038100         MOVE SPACES TO IX-RUNSTAT-RECORD                         03760017
038200         WRITE IX-RUNSTAT-RECORD                                  03770017
038300         WRITE IX-RUNSTAT-RECORD FROM WS-LISTDEF-LINE             03780020
038400     END-IF.                                                      03790000
038500                                                                  03800000
038600     WRITE IX-RUNSTAT-RECORD FROM WS-INCLUDE-LINE.                03810020
038700                                                                  03820000
038800     MOVE SPACES TO WS-IX-CREATOR-NAME.                           03830000
038900                                                                  03840000
039000     STRING SYSINDEX-CREATOR-TEXT DELIMITED BY ' '                03850012
039100            '.'                   DELIMITED BY SIZE               03860012
039200            SYSINDEX-NAME-TEXT    DELIMITED BY SIZE               03870012
039300     INTO WS-IX-CREATOR-NAME.                                     03880000
039400                                                                  03890000
040100     WRITE IX-RUNSTAT-RECORD FROM WS-IX-CREATOR-NAME.             03891020
042600                                                                  04210000
042700 4000-EXIT.                                                       04220022
042800     EXIT.                                                        04230000
043000                                                                  04250000
027100 5000-WRITE-SUMMARY-LINES.                                        04251022
021700*    DISPLAY '5000-WRITE-SUMMARY-LINES'.                          04252023
027200                                                                  04253022
027700      MOVE SPACES TO IX-RUNSTAT-RECORD.                           04254022
027800      WRITE IX-RUNSTAT-RECORD.                                    04255022
027900                                                                  04256022
028000      IF WS-IX-STATS-COUNT > 0                                    04257023
028400          WRITE IX-RUNSTAT-RECORD FROM WS-RUNSTATS-LINE           04259224
028500          WRITE IX-RUNSTAT-RECORD FROM WS-SHRLEVEL-LINE           04259324
028200      END-IF.                                                     04259423
028600                                                                  04259522
028700 5000-EXIT.                                                       04259622
028800      EXIT.                                                       04259722
029000                                                                  04259822
043100 9999-DB2-ABEND.                                                  04260000
043200                                                                  04270000
043300     CALL 'DSNTIAR' USING SQLCA                                   04280000
043400                          DP004-FORMATTED-MESSAGE                 04290000
043500                          DP004-ERROR-LINE-LENGTH.                04300000
043600                                                                  04310000
043700     DISPLAY DP004-ASTERISK-LINE.                                 04320000
043800                                                                  04330000
043900     PERFORM                                                      04340000
044000         VARYING DP004-MSG-IDX                                    04350000
044100         FROM 1 BY 1                                              04360000
044200         UNTIL DP004-MSG-IDX > DP004-MAX-MESSAGE-LINES            04370000
044300             DISPLAY '**'                                         04380000
044400                     DP004-MESSAGE-LINE (DP004-MSG-IDX)           04390000
044500                     ' **'                                        04400000
044600     END-PERFORM.                                                 04410000
044700                                                                  04420000
044800     DISPLAY DP004-ASTERISK-LINE.                                 04430000
044900                                                                  04440000
045000     MOVE +4013      TO WS-ABEND-CODE                             04450000
045100     CALL 'ILBOABN0' USING WS-ABEND-CODE.                         04460000
