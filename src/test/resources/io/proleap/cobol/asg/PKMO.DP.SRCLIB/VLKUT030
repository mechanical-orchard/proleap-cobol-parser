000010 IDENTIFICATION DIVISION.                                         00001015
000020                                                                  00002015
000030 PROGRAM-ID.             VLKUT030.                                00003015
000040 AUTHOR.                 DAN HINTZ.                               00004015
000050 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00005015
000060 DATE-WRITTEN.           FEBRUARY 2005.                           00006015
000070 DATE-COMPILED.                                                   00007015
000080                                                                  00008015
000090*                                                                 00009015
000091*  PROGRAM NARRATIVE:                                             00009115
000092*  THIS PROGRAM WILL CREATE A FILE CONTAINING SITE/LOCATION       00009215
000093*  INFORMATION FOR COMPLIANCE NETWORK                             00009315
000094*                                                                 00009415
000095*                                                                 00009515
000096 ENVIRONMENT DIVISION.                                            00009615
000097                                                                  00009715
000098 CONFIGURATION SECTION.                                           00009815
000099                                                                  00009915
000100 SOURCE-COMPUTER.                        IBM-3090.                00010015
000110 OBJECT-COMPUTER.                        IBM-3090.                00011015
000120                                                                  00012015
000130 INPUT-OUTPUT SECTION.                                            00013015
000140                                                                  00014015
000150 FILE-CONTROL.                                                    00015015
000160                                                                  00016015
000170     SELECT  VL-LOCATION-FILE                                     00017015
000180         ASSIGN TO OUT01.                                         00018015
000190                                                                  00019015
000170     SELECT  VL-MARKER-FILE                                       00017015
000180         ASSIGN TO OUT02.                                         00018015
000190                                                                  00019015
000191******************************************************************00019115
000192 DATA DIVISION.                                                   00019215
000193******************************************************************00019315
000194                                                                  00019415
000195 FILE SECTION.                                                    00019515
000196*                                                                 00019615
000197 FD  VL-LOCATION-FILE                                             00019715
000198     RECORDING MODE IS F                                          00019815
000199     LABEL RECORDS ARE STANDARD                                   00019915
000200     BLOCK CONTAINS 0 RECORDS.                                    00020015
000210 01  VL-LOCATION-RECORD               PIC  X(311).                00021015
000220*                                                                 00022015
000197 FD  VL-MARKER-FILE                                               00019715
000198     RECORDING MODE IS F                                          00019815
000199     LABEL RECORDS ARE STANDARD                                   00019915
000200     BLOCK CONTAINS 0 RECORDS.                                    00020015
000210 01  VL-MARKER-RECORD                 PIC  X(78).                 00021015
000220*                                                                 00022015
000230*                                                                 00023015
000240 WORKING-STORAGE SECTION.                                         00024015
000250***************************************************************** 00025015
000260*    INPUT CONTROL CARD                                           00026015
000270***************************************************************** 00027015
000054 01  CC-CONTROL-CARD.                                                     
000055     05  CC-SCHEDULE-DATE.                                                
000056         10  CC-CCYY                 PIC X(04).                           
000057         10  CC-MM                   PIC X(02).                           
000058         10  CC-DD                   PIC X(02).                           
000059                                                                          
000250***************************************************************** 00025015
000260*    PROGRAM CONSTANTS                                            00026015
000270***************************************************************** 00027015
000280 01  PC-CONSTANTS.                                                00028015
000290     05  PC-CURRENT-PGM-VLKUT030      PIC  X(08) VALUE 'VLKUT030'.00029015
000291     05  PC-MAX-RETRIES               PIC S9(04) VALUE +3         00029115
000292                                                 COMP SYNC.       00029215
000293                                                                  00029315
000294***************************************************************** 00029415
000295*    PROGRAM SWITCHES                                             00029515
000296***************************************************************** 00029615
000297 01  PS-SWITCHES.                                                 00029715
000298     05  PS-END-CURSOR-SWITCH         PIC  X(01) VALUE 'N'.       00029815
000299         88  PS-END-CSR                          VALUE 'Y'.       00029915
000300         88  PS-NOT-END-CSR                      VALUE 'N'.       00030015
000310                                                                  00031015
000320***************************************************************** 00032015
000330*    PROGRAM VARIABLES                                            00033015
000340***************************************************************** 00034015
000350 01  PV-VARIABLES.                                                00035015
000360     05  PV-RETRY-COUNT               PIC S9(04) VALUE +0         00036015
000370                                                 COMP SYNC.       00037015
000380     05  PV-ABEND-CODE                PIC S9(04) VALUE ZERO       00038015
000390                                                 COMP SYNC.       00039015
000391     05  PV-PARAGRAPH                 PIC  X(30) VALUE SPACES.    00039115
000392     05  PV-DB2-FUNCTION              PIC  X(30) VALUE SPACES.    00039215
000393     05  PV-ABEND-TABLE-1             PIC  X(20) VALUE SPACES.    00039315
000394     05  PV-ABEND-TABLE-2             PIC  X(20) VALUE SPACES.    00039415
000395     05  PV-ERROR-MSG                 PIC  X(60) VALUE SPACES.    00039515
000396     05  PV-RECS-WRITTEN              PIC  9(09) VALUE ZERO.      00039615
000397     05  PV-DIST-NBR-X.                                           00039715
000398         10  PV-DIST-NBR              PIC  9(03) VALUE ZERO.      00039815
000399     05  PV-REGN-NBR-X.                                           00039915
000400         10  PV-REGN-NBR              PIC  9(03) VALUE ZERO.      00040015
000401     05  PV-INPUT-DATE.                                           00040115
000402         10  PV-INPUT-DATE-CCYY       PIC  9(04) VALUE ZERO.      00040215
000403         10  FILLER                   PIC  X(01) VALUE SPACES.    00040315
000404         10  PV-INPUT-DATE-MM         PIC  9(02) VALUE ZERO.      00040415
000405         10  FILLER                   PIC  X(01) VALUE SPACES.    00040515
000406         10  PV-INPUT-DATE-DD         PIC  9(02) VALUE ZERO.      00040615
000407     05  PV-OUTPUT-DATE.                                          00040715
000408         10  PV-OUTPUT-DATE-CCYY      PIC  9(04) VALUE ZERO.      00040815
000409         10  PV-OUTPUT-DATE-MM        PIC  9(02) VALUE ZERO.      00040915
000410         10  PV-OUTPUT-DATE-DD        PIC  9(02) VALUE ZERO.      00041015
009000     05  PV-RUN-DATE-CN               PIC  X(08) VALUE SPACES.            
010100     05  PV-RUN-TIME-CN               PIC  X(06) VALUE SPACES.            
010500***** FILE NAME CONSISTS OF RUN-DATE-CN_SITE.DAT                          
010600*****     EXAMPLE: 20050317_SITE.DAT                                      
010700     05  PV-FILE-NAME.                                                    
010800         10  PV-CREATE-DATE           PIC  X(08) VALUE SPACES.            
010900         10  PV-UNDERSCORE            PIC  X(01) VALUE '_'.               
011000         10  PV-SITE-DAT              PIC  X(08) VALUE SPACES.            
000411                                                                  00041115
000412***  MARKER FILE LAYOUT                                           00041215
000413     COPY VLRD029.                                                00041315
000414                                                                  00041415
000412***  LOCATION FILE LAYOUT                                         00041215
000413     COPY VLRD030.                                                00041315
000414                                                                  00041415
000415***  LOCATION FILE LAYOUT                                         00041515
000416     COPY XLWS071.                                                00041615
000417                                                                  00041715
000418***  DATE ROUTINE COPYBOOK                                        00041815
000419     COPY DPWS500.                                                00041915
000420                                                                  00042015
000418***  DB2 ABEND COPYBOOK                                           00041815
000419     COPY DPWS004.                                                00041915
000420                                                                  00042015
000430     EXEC SQL                                                     00043015
000440         INCLUDE SQLCA                                            00044015
000450     END-EXEC.                                                    00045015
000460                                                                  00046015
000470     COPY SQLCA2.                                                 00047015
000480                                                                  00048015
000490***  XLT_LOC                                                      00049015
000491     EXEC SQL                                                     00049115
000492         INCLUDE XLT00010                                         00049215
000493     END-EXEC.                                                    00049315
000494                                                                  00049415
000495***  XLT_DIST                                                     00049515
000496     EXEC SQL                                                     00049615
000497         INCLUDE XLT00013                                         00049715
000498     END-EXEC.                                                    00049815
000499                                                                  00049915
000495***  XLT_DC_LOC_ASGMT                                             00049515
000496     EXEC SQL                                                     00049615
000497         INCLUDE XLT00014                                         00049715
000498     END-EXEC.                                                    00049815
000499                                                                  00049915
000500***  EXTRACT CURSOR                                               00050015
000510     EXEC SQL                                                     00051015
000520         DECLARE EXTRACT-CSR CURSOR FOR                           00052015
000530         SELECT                                                   00053015
000540                A.LOC_NBR                                         00054015
000550              , COALESCE(DIST_NBR , 0)                            00055015
000560           FROM                                                   00056015
000570                XLT_LOC A                                         00057015
000580           WHERE                                                  00058015
000590                LOC_TYP_CDE             IN ('DC', 'DS', 'HQ')     00059015
000600             AND                                                  00060015
000610              ((CHAR(CURRENT_DATE, ISO)                           00061015
000620                    BETWEEN                                       00062015
000630                 CHAR(OPN_DTE,ISO)                                00063015
000631                    AND                                           00063115
000632                 CHAR(CLO_DTE,ISO))                               00063215
000600                        OR                                        00060015
000610              ((CHAR(CURRENT_DATE, ISO) < OPN_DTE                 00061015
000620                 AND                                              00062015
000630                 CHAR(CLO_DTE,ISO) = '9999-09-09')))              00063015
000631             AND EXISTS                                           00063115
000632                 (SELECT *                                        00063215
000632                    FROM XLT_DC_LOC_ASGMT B                       00063215
000632                   WHERE B.LOC_NBR = A.LOC_NBR                    00063215
000632                     AND DC_NBR    <> 899)                        00063215
000633        ORDER BY                                                  00063315
000634                LOC_NBR                                           00063415
000634        WITH UR                                                   00063415
000635     END-EXEC.                                                    00063515
000636                                                                  00063615
000637 LINKAGE SECTION.                                                 00063715
000638                                                                  00063815
000639 PROCEDURE DIVISION.                                              00063915
000640***************************************************************** 00064015
000650*  MAINLINE LOGIC FOR PROGRAM                                     00065015
000660***************************************************************** 00066015
000670 0000-MAINLINE.                                                   00067015
000680     PERFORM 1000-INITIALIZE.                                     00068015
000690                                                                  00069015
000691     PERFORM 2000-PROCESS                                         00069115
000692         UNTIL PS-END-CSR.                                        00069215
000693                                                                  00069315
000694     PERFORM 9000-EOJ.                                            00069415
000695                                                                  00069515
000696     STOP RUN.                                                    00069615
000697                                                                  00069715
000698***************************************************************** 00069815
000699*  INITIALIZATION PARAGRAPH                                       00069915
000700***************************************************************** 00070015
000710 1000-INITIALIZE.                                                 00071015
000720     OPEN OUTPUT VL-LOCATION-FILE                                 00072015
000720                 VL-MARKER-FILE.                                  00072015
000730                                                                  00073015
000126     ACCEPT CC-CONTROL-CARD FROM SYSIN.                                   
000127                                                                          
000128     DISPLAY 'CONTROL CARD ====>  ' CC-CONTROL-CARD.                      
000129                                                                          
000130     PERFORM 1100-VALIDATE-CONTROL-CARD.                                  
000131                                                                          
000132******* TIME IS CONTAINED CURRENT-DATE IN POSITION 9 FOR 8                
000133     MOVE FUNCTION CURRENT-DATE(9:8) TO PV-RUN-TIME-CN.                   
000135                                                                          
000136     DISPLAY '******  RUN TIME  => '  PV-RUN-TIME-CN.                     
000137                                                                          
000740     PERFORM 7000-OPEN-EXTRACT-CURSOR.                            00074015
000750     PERFORM 7200-FETCH-EXTRACT-CURSOR.                           00075015
000760                                                                  00076015
000142******************************************************************        
000143**  VALIDATE THE DATE FROM THE SCHEDULE                                   
000144******************************************************************        
000145 1100-VALIDATE-CONTROL-CARD.                                              
000146     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.                      
000147     SET DPG51-FISCAL-454-CALENDAR                                        
000148         DPG51-DO-NOT-INCR-DECR-DATE                                      
000149         DPG52-LK-DTE-ISO           TO TRUE.                              
000150                                                                          
000151     MOVE CC-SCHEDULE-DATE     TO DPG52-LK-DATE-INPUT.                    
000152                                                                          
000153     CALL DP500-KOHLS-CALENDAR-ROUTINE USING                              
000154             DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.                         
000155                                                                          
000156     IF DPG54-NO-ERROR                                                    
000157         MOVE CC-SCHEDULE-DATE     TO PV-RUN-DATE-CN                      
000158     ELSE                                                                 
000159         DISPLAY '** ABEND **'                                            
000160         DISPLAY '** PROGRAM = VLKUT030 -- CALLED MODULE '                
000161                  'DPKUT500 **'                                           
000162         DISPLAY '** PARAGRAPH = 1100-VALIDATE-CONTROL-CARD **'           
000163         DISPLAY '** INVALID SCHEDULE DATE: ' CC-SCHEDULE-DATE            
000164         DISPLAY '** ERROR MESSAGE FROM CALLED MODULE:   '                
000165         DISPLAY DPG54-ERROR-MESSAGE                                      
000166         MOVE +4003 TO PV-ABEND-CODE                                      
000167         CALL 'ILBOABN0' USING PV-ABEND-CODE                              
000168     END-IF.                                                              
000169                                                                          
000169                                                                          
000770***************************************************************** 00077015
000780* PROCESS DATA FROM CURSOR AND WRITE OUTPUT RECORD                00078015
000790***************************************************************** 00079015
000791 2000-PROCESS.                                                    00079115
000792     PERFORM 2100-GET-LOC-INFO.                                   00079215
000793                                                                  00079315
000794     MOVE 'A'                     TO VL030-ACD-INDICATOR.         00079415
000795     MOVE XLT00010-LOC-NBR        TO VL030-LOCATION-NBR.          00079515
000796     MOVE XL071-LOC-NM            TO VL030-LOCATION-NAME.         00079615
000797     MOVE XL071-LNE-1-ADDR        TO VL030-ADDRESS-LINE-1.        00079715
000798     MOVE XL071-LNE-2-ADDR        TO VL030-ADDRESS-LINE-2.        00079815
000799     MOVE SPACES                  TO VL030-ADDRESS-LINE-3.        00079915
000800     MOVE XL071-CTY-NM            TO VL030-CITY.                  00080015
000801     MOVE XL071-ST-CDE            TO VL030-STATE.                 00080115
000802     MOVE XL071-ZIP-10-CDE        TO VL030-ZIP-CODE.              00080215
000803     MOVE XL071-PHN-NBR           TO VL030-PHONE-NBR.             00080315
000804     MOVE SPACES                  TO VL030-FAX-NBR.               00080415
000805                                                                  00080515
000806     IF  XL071-DIST-NBR > 0                                       00080615
000806         PERFORM 2200-GET-DIST-REGN-INFO                          00080615
000806     END-IF.                                                      00080615
000807                                                                  00080715
000806     IF  XL071-DIST-NBR > 0                                       00080615
000808         MOVE XL071-DIST-NBR      TO PV-DIST-NBR                  00080815
000809         MOVE PV-DIST-NBR-X       TO VL030-DISTRICT-NBR           00080915
000810         MOVE XLT00013-REGN-NBR   TO PV-REGN-NBR                  00081015
000811         MOVE PV-REGN-NBR-X       TO VL030-REGION-NBR             00081115
000806     ELSE                                                         00080615
000809         MOVE '000'               TO VL030-DISTRICT-NBR           00080915
000811                                     VL030-REGION-NBR             00081115
000806     END-IF.                                                      00080615
000807                                                                  00080715
000812     MOVE 'KOHLS'                 TO VL030-COMPANY-NAME.          00081215
000813     MOVE XL071-OPN-DTE           TO PV-INPUT-DATE.               00081315
000814     MOVE PV-INPUT-DATE-CCYY      TO PV-OUTPUT-DATE-CCYY.         00081415
000815     MOVE PV-INPUT-DATE-MM        TO PV-OUTPUT-DATE-MM.           00081515
000816     MOVE PV-INPUT-DATE-DD        TO PV-OUTPUT-DATE-DD.           00081615
000817     MOVE PV-OUTPUT-DATE          TO VL030-SITE-OPEN-DATE.        00081715
000818     MOVE XL071-CLO-DTE           TO PV-INPUT-DATE.               00081815
000819     MOVE PV-INPUT-DATE-CCYY      TO PV-OUTPUT-DATE-CCYY.         00081915
000820     MOVE PV-INPUT-DATE-MM        TO PV-OUTPUT-DATE-MM.           00082015
000821     MOVE PV-INPUT-DATE-DD        TO PV-OUTPUT-DATE-DD.           00082115
000822     MOVE PV-OUTPUT-DATE          TO VL030-SITE-CLOSE-DATE.       00082215
000823     MOVE XL071-ASGMT-PO-STRT-DTE TO PV-INPUT-DATE.               00082315
000824     MOVE PV-INPUT-DATE-CCYY      TO PV-OUTPUT-DATE-CCYY.         00082415
000825     MOVE PV-INPUT-DATE-MM        TO PV-OUTPUT-DATE-MM.           00082515
000826     MOVE PV-INPUT-DATE-DD        TO PV-OUTPUT-DATE-DD.           00082615
000827     MOVE PV-OUTPUT-DATE          TO VL030-SITE-SHIP-START-DATE.  00082715
000828     MOVE XL071-ASGMT-PO-STP-DTE  TO PV-INPUT-DATE.               00082815
000829     MOVE PV-INPUT-DATE-CCYY      TO PV-OUTPUT-DATE-CCYY.         00082915
000830     MOVE PV-INPUT-DATE-MM        TO PV-OUTPUT-DATE-MM.           00083015
000831     MOVE PV-INPUT-DATE-DD        TO PV-OUTPUT-DATE-DD.           00083115
000832     MOVE PV-OUTPUT-DATE          TO VL030-SITE-SHIP-STOP-DATE.   00083215
000833     MOVE 'KSS'                   TO VL030-BUSINESS-UNIT.         00083315
000834     MOVE XL071-ASGMT-DC-NBR      TO VL030-DROP-LOCATION.         00083415
000835     MOVE 'X'                     TO VL030-ANCHOR-CONSTANT.       00083515
000836                                                                  00083615
000837     PERFORM 8000-WRITE-OUTPUT.                                   00083715
000838                                                                  00083815
000839     PERFORM 7200-FETCH-EXTRACT-CURSOR.                           00083915
000840                                                                  00084015
000850                                                                  00085015
000860***************************************************************** 00086015
000870* USE THE XLKUT071 ROUTINE TO FETCH THE INFORMATION FOR A         00087015
000871* SPECIFIED LOCATION NUMBER.                                      00087115
000872***************************************************************** 00087215
000873 2100-GET-LOC-INFO.                                               00087315
000874     INITIALIZE XL071-COMMAREA-REC.                               00087415
000875     MOVE XLT00010-LOC-NBR TO XL071-LOCATION-NUMBER               00087515
000876                                                                  00087615
000877     CALL XL071-LOCATION-MODULE USING XL071-COMMAREA-REC.         00087715
000878                                                                  00087815
000879     EVALUATE TRUE                                                00087915
000880         WHEN XL071-NO-ERRORS                                     00088015
000881         WHEN XL071-LOC-NOT-FOUND                                 00088115
000882         WHEN XL071-SQLCODE-N = -305                              00088215
000883         WHEN XL071-SQLCODE-N = -904                              00088315
000884         WHEN XL071-SQLCODE-N = -911                              00088415
000885         WHEN XL071-SQLCODE-N = -913                              00088515
000886             CONTINUE                                             00088615
000887         WHEN XL071-BAD-DB2-RETURN                                00088715
000888             MOVE '2100-GET-LOC-INFO' TO PV-PARAGRAPH             00088815
000889             MOVE 'SELECT ON LOCATION'                            00088915
000890                                      TO PV-DB2-FUNCTION          00089015
000891             MOVE 'GET LOCATION INFO' TO PV-ERROR-MSG             00089115
000892             MOVE 'XLT_LOC'           TO PV-ABEND-TABLE-1         00089215
000893             MOVE 'XLT_DC_LOC_ASGMT'  TO PV-ABEND-TABLE-2         00089315
000894             MOVE XL071-SQLCODE-N     TO SQLCODE                  00089415
000895             PERFORM 9200-SQL-ERROR                               00089515
000896     END-EVALUATE.                                                00089615
000897/                                                                 00089715
000898******************************************************************00089815
000899* FETCH THE DISTRICT AND REGION NUMBER INFORMATION.               00089915
000900******************************************************************00090015
000901 2200-GET-DIST-REGN-INFO.                                         00090115
000902     INITIALIZE DCLXLT00013.                                      00090215
000903                                                                  00090315
000904     PERFORM                                                      00097115
000905         WITH TEST AFTER                                          00097215
000906         VARYING PV-RETRY-COUNT                                   00097315
000907         FROM 1 BY 1                                              00097415
000908         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 00097515
000909                   OR (SQLCODE = ZERO) OR (SQLCODE = +100))       00097615
000910                                                                  00090315
000911         EXEC SQL                                                 00090415
000912             SELECT                                               00090515
000913                    REGN_NBR                                      00090615
000914               INTO                                               00090715
000915                    :XLT00013-REGN-NBR                            00090815
000916               FROM                                               00090915
000917                    XLT_DIST                                      00091015
000918               WHERE                                              00091115
000919                    DIST_NBR = :XLT00010-DIST-NBR                 00091215
000920         END-EXEC                                                 00091315
000921                                                                  00091415
000922         EVALUATE TRUE                                            00091515
000923             WHEN SQLCODE = +0                                    00091615
000924             WHEN SQLCODE = -904                                  00098315
000925             WHEN SQLCODE = -911                                  00098415
000926             WHEN SQLCODE = -913                                  00098515
000927                 CONTINUE                                         00091715
000928             WHEN SQLCODE = +100                                  00091815
000929                 MOVE ZERO                TO XLT00013-REGN-NBR    00091915
000934                 DISPLAY 'MISSING DIST_NBR = ' XLT00010-DIST-NBR          
000934                         '  LOCATION NBR   = ' XLT00010-LOC-NBR           
000930             WHEN SQLWARN0 NOT EQUAL SPACE                        00092015
000931             WHEN SQLCODE NOT EQUAL ZERO                          00092115
000932                 DISPLAY '** ABEND **'                            00092215
000933                 DISPLAY '** PROGRAM = VLKUT030 **'               00092315
000934                 DISPLAY '** PARAGRAPH = '                                
000935                         '2200-GET-DIST-REGN-INFO **'                     
000934                 DISPLAY 'DIST_NBR     = ' XLT00010-DIST-NBR              
000936                 MOVE 'FETCH REGION NBR'  TO PV-ERROR-MSG         00092515
000937                 MOVE 'XLT_DIST'          TO PV-ABEND-TABLE-1     00092615
000938                 PERFORM 9200-SQL-ERROR                           00092715
000939         END-EVALUATE                                             00092815
000940     END-PERFORM.                                                 00099715
000941                                                                  00099815
000942     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          00104615
000943         DISPLAY '** ABEND **'                                    00092215
000944         DISPLAY '** PROGRAM = VLKUT030 **'                       00092315
000945         DISPLAY '** PARAGRAPH = 2200-GET-DIST-REGN-INFO **'      00092415
000946         MOVE 'FETCH REGION NBR MAX RETRIES'                              
000947                                          TO PV-ERROR-MSG                 
000948         MOVE 'XLT_DIST'                  TO PV-ABEND-TABLE-1     00114015
000949         PERFORM 9200-SQL-ERROR                                   00092715
000950     END-IF.                                                      00107215
000951                                                                  00092915
000952******************************************************************00093015
000953* OPEN CURSOR                                                     00094015
000954******************************************************************00095015
000960 7000-OPEN-EXTRACT-CURSOR.                                        00096015
000970                                                                  00097015
000971     PERFORM                                                      00097115
000972         WITH TEST AFTER                                          00097215
000973         VARYING PV-RETRY-COUNT                                   00097315
000974         FROM 1 BY 1                                              00097415
000975         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 00097515
000976                   OR (SQLCODE = ZERO))                           00097615
000977         EXEC SQL                                                 00097715
000978             OPEN EXTRACT-CSR                                     00097815
000979         END-EXEC                                                 00097915
000980                                                                  00098015
000981         EVALUATE TRUE                                            00098115
000982             WHEN SQLCODE = +0                                    00098215
000983             WHEN SQLCODE = -904                                  00098315
000984             WHEN SQLCODE = -911                                  00098415
000985             WHEN SQLCODE = -913                                  00098515
000986                 CONTINUE                                         00098615
000987             WHEN SQLWARN0 NOT EQUAL SPACE                        00098715
000988             WHEN SQLCODE NOT EQUAL ZERO                          00098815
000989                 DISPLAY '** ABEND **'                            00098915
000990                 DISPLAY '** PROGRAM = VLKUT030 **'               00099015
000991                 DISPLAY '** PARAGRAPH = '                        00099115
000992                         '7000-OPEN-EXTRACT-CURSOR **'            00099215
000993                 MOVE 'OPEN CURSOR'   TO PV-ERROR-MSG             00099315
000994                 MOVE 'XLT_LOC'       TO PV-ABEND-TABLE-1         00099415
000995                 PERFORM 9200-SQL-ERROR                           00099515
000996         END-EVALUATE                                             00099615
000997     END-PERFORM.                                                 00099715
000998                                                                  00099815
000999     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          00099915
001000         DISPLAY '** ABEND **'                                    00100015
001010         DISPLAY '** PROGRAM = VLKUT030 **'                       00101015
001011         DISPLAY '** PARAGRAPH =  7000-OPEN-EXTRACT-CURSOR **'    00101115
001012         MOVE 'OPEN CURSOR MAX RETRIES'                           00101215
001013                                      TO PV-ERROR-MSG             00101315
001014         MOVE 'XLT_LOC'               TO PV-ABEND-TABLE-1         00101415
001015         PERFORM 9200-SQL-ERROR                                   00101515
001016     END-IF.                                                      00101615
001017                                                                  00101715
001018                                                                  00101815
001019******************************************************************00101915
001020* CLOSE CURSOR                                                    00102015
001021******************************************************************00102115
001022 7100-CLOSE-EXTRACT-CURSOR.                                       00102215
001023                                                                  00102315
001024     PERFORM                                                      00102415
001025         WITH TEST AFTER                                          00102515
001026         VARYING PV-RETRY-COUNT                                   00102615
001027         FROM 1 BY 1                                              00102715
001028         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 00102815
001029                   OR (SQLCODE = ZERO))                           00102915
001030         EXEC SQL                                                 00103015
001031             CLOSE EXTRACT-CSR                                    00103115
001032         END-EXEC                                                 00103215
001033                                                                  00103315
001034         EVALUATE TRUE                                            00103415
001035             WHEN SQLCODE = +0                                    00103515
001036             WHEN SQLCODE = -904                                  00098315
001037             WHEN SQLCODE = -911                                  00098415
001038             WHEN SQLCODE = -913                                  00098515
001039                 CONTINUE                                         00103615
001040             WHEN SQLWARN0 NOT EQUAL SPACE                        00103715
001041             WHEN SQLCODE NOT EQUAL ZERO                          00103815
001042                 DISPLAY '** ABEND **'                            00103915
001043                 DISPLAY '** PROGRAM = VLKUT030 **'               00104015
001044                 DISPLAY '** PARAGRAPH = '                                
001045                         '7100-CLOSE-EXTRACT-CURSOR**'                    
001046                 MOVE 'CLOSE CURSOR'  TO PV-ERROR-MSG             00104215
001047                 MOVE 'XLT_LOC'       TO PV-ABEND-TABLE-1         00104315
001048                 PERFORM 9200-SQL-ERROR                           00104415
001049         END-EVALUATE                                             00104515
001050     END-PERFORM.                                                 00099715
001051                                                                  00099815
001052     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          00104615
001053         DISPLAY '** ABEND **'                                    00104715
001054         DISPLAY '** PROGRAM = VLKUT030 **'                       00104815
001055         DISPLAY '** PARAGRAPH = 7100-CLOSE-EXTRACT-CURSOR**'     00104915
001056         MOVE 'CLOSE CURSOR MAX RETRIES'                          00105015
001060                                      TO PV-ERROR-MSG             00106015
001070         MOVE 'XLT_LOC'               TO PV-ABEND-TABLE-1         00107015
001071         PERFORM 9200-SQL-ERROR                                   00107115
001072     END-IF.                                                      00107215
001073                                                                  00107315
001074******************************************************************00107415
001075*  FETCH CURSOR                                                   00107515
001076******************************************************************00107615
001077 7200-FETCH-EXTRACT-CURSOR.                                       00107715
001078     PERFORM                                                      00102415
001079         WITH TEST AFTER                                          00102515
001080         VARYING PV-RETRY-COUNT                                   00102615
001081         FROM 1 BY 1                                              00102715
001082         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 00102815
001083                   OR (SQLCODE = ZERO) OR (SQLCODE = +100))       00102915
001084         EXEC SQL                                                 00107815
001085              FETCH EXTRACT-CSR                                   00107915
001086              INTO  :XLT00010-LOC-NBR                             00108015
001090                  , :XLT00010-DIST-NBR                            00109015
001091         END-EXEC                                                 00109115
001092                                                                  00109215
001093         EVALUATE TRUE                                            00109315
001094             WHEN SQLCODE = ZERO                                  00109415
001095             WHEN SQLCODE = -904                                  00098315
001096             WHEN SQLCODE = -911                                  00098415
001097             WHEN SQLCODE = -913                                  00098515
001098                 CONTINUE                                         00109515
001099             WHEN SQLCODE = +100                                  00109615
001100                 SET PS-END-CSR       TO TRUE                     00109715
001101             WHEN SQLWARN0 NOT EQUAL SPACE                        00109815
001102             WHEN SQLCODE NOT EQUAL ZERO                          00109915
001103                 DISPLAY '** ABEND **'                            00110015
001110                 DISPLAY '** PROGRAM = VLKUT030 **'               00111015
001120                 DISPLAY '** PARAGRAPH = '                                
001121                         '7200-FETCH-EXTRACT-CURSOR**'                    
001130                 MOVE 'FETCH CURSOR'  TO PV-ERROR-MSG             00113015
001140                 MOVE 'XLT_LOC'       TO PV-ABEND-TABLE-1         00114015
001150                 PERFORM 9200-SQL-ERROR                           00115015
001160         END-EVALUATE                                             00116015
001161     END-PERFORM.                                                 00099715
001163                                                                  00117015
001164     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          00104615
001169         DISPLAY '** ABEND **'                                    00110015
001170         DISPLAY '** PROGRAM = VLKUT030 **'                       00111015
001171         DISPLAY '** PARAGRAPH = 7200-FETCH-EXTRACT-CURSOR**'     00112015
001172         MOVE 'FETCH CURSOR MAX RETRIES'                                  
001173                                      TO PV-ERROR-MSG                     
001174         MOVE 'XLT_LOC'               TO PV-ABEND-TABLE-1         00114015
001175         PERFORM 9200-SQL-ERROR                                   00115015
001176     END-IF.                                                      00107215
001177                                                                  00117015
001180***************************************************************** 00118015
001190*  WRITE OUTPUT FILE                                              00119015
001200***************************************************************** 00120015
001201 8000-WRITE-OUTPUT.                                               00120115
001202     WRITE VL-LOCATION-RECORD FROM VL030-SITE-RECORD.             00120215
001203                                                                  00120315
001204     ADD 1                TO PV-RECS-WRITTEN.                     00120415
001205                                                                  00120515
035800*****************************************************************         
035900*  CREATE MARKER FILE                                                     
036000*****************************************************************         
036100 8500-CREATE-MARKER.                                                      
036200     MOVE PV-RUN-DATE-CN  TO PV-CREATE-DATE.                              
036300     MOVE 'SITE.DAT'      TO PV-SITE-DAT.                                 
036400     MOVE PV-FILE-NAME    TO VL029-FILE-NAME.                             
036500     MOVE PV-RECS-WRITTEN TO VL029-RECORD-COUNT.                          
036600     MOVE PV-RUN-DATE-CN  TO VL029-BUILD-DATE.                            
036700     MOVE PV-RUN-TIME-CN  TO VL029-BUILD-TIME.                            
036800     MOVE 'X'             TO VL029-ANCHOR-CONSTANT.                       
036900                                                                          
037000     WRITE VL-MARKER-RECORD FROM VL029-MARKER-RECORD.                     
001205                                                                  00120515
001206***************************************************************** 00120615
001207*  END OF JOB PROCESSING                                          00120715
001208***************************************************************** 00120815
001209 9000-EOJ.                                                        00120915
001210     PERFORM 7100-CLOSE-EXTRACT-CURSOR.                           00121015
001220                                                                  00122015
001230     DISPLAY 'RECORDS WRITTEN ===>  ' PV-RECS-WRITTEN.            00123015
001240                                                                  00124015
001240     PERFORM 8500-CREATE-MARKER.                                  00124015
001240                                                                  00124015
001250     CLOSE VL-LOCATION-FILE                                       00125015
001250           VL-MARKER-FILE.                                        00125015
001260                                                                  00126015
001270                                                                  00127015
001280***************************************************************** 00128015
001290*  PARAGRAPH EXECUTED WHEN SERIOUS DB2 ERROR OCCURRED             00129015
001291***************************************************************** 00129115
001292 9200-SQL-ERROR.                                                  00129215
001293     CLOSE VL-LOCATION-FILE                                       00129315
001293           VL-MARKER-FILE.                                        00129315
001294                                                                  00129415
001295     MOVE SQLCODE                     TO SQLCODE2.                00129515
001296     MOVE SQLERRD(3)                  TO SQLERRD3.                00129615
001297                                                                  00129715
001298     DISPLAY '** ABEND **         ** = SQLERROR'.                 00129815
001299     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PGM-VLKUT030.        00129915
001300     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH.                   00130015
001310     DISPLAY '** OPERATION ** = ' PV-DB2-FUNCTION.                00131015
001320     DISPLAY '**           ** = ' PV-ABEND-TABLE-1.               00132015
001330     DISPLAY '**           ** = ' PV-ABEND-TABLE-2.               00133015
001340     DISPLAY '**           ** = ' PV-ERROR-MSG                    00134015
001350                                                                  00135015
001360     DISPLAY '** SQLCODE          ** = ' SQLCODE2.                00136015
001370     DISPLAY '** ROWS PROCESSED   ** = ' SQLERRD3.                00137015
001380     DISPLAY '** SQLERRM          ** = ' SQLERRM.                 00138015
001390     DISPLAY '** SQLERRMC         ** = ' SQLERRMC.                00139015
001400                                                                  00140015
001401     COPY DPPD004.                                                00140115
001402                                                                  00140215
001403     MOVE +4013                       TO PV-ABEND-CODE.           00140315
001404     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         00140415
001405                                                                  00140515
001406*************  END OF VLKUT030  ********************************  00140615
