000100 TITLE 'MAINTAIN LEGACY TPOPRPK TABLE FROM RMS PO SYSTEM'.        00010001
000200 IDENTIFICATION DIVISION.                                         00020001
000300 PROGRAM-ID.    XLKUP011.                                         00030001
000400 AUTHOR.        DEANNA BRANTNER.                                  00040001
000500 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00050001
000600 DATE-WRITTEN.  MARCH 2003.                                       00060001
000700 DATE-COMPILED.                                                   00070001
000800******************************************************************00080001
000900* THIS PGM IS PART OF THE INTERFACING BETWEEN RMS PO & LEGACY PO. 00090001
001000******************************************************************00100001
001100* THIS DB2 PROGRAM IS CALLED TO PROCESS CERTAIN TYPES OF PO DATA  00110001
001200* PASSED FROM RMS.  THE PROGRAM INSERTS, UPDATES OR DELETES ROWS  00120001
001300* ON THE LEGACY TPOPRPK TABLE.                                    00130001
001400******************************************************************00140001
001500 ENVIRONMENT DIVISION.                                            00150001
001600 CONFIGURATION SECTION.                                           00160001
001700 SOURCE-COMPUTER.  IBM-3090.                                      00170001
001800 OBJECT-COMPUTER.  IBM-3090.                                      00180001
001900 DATA DIVISION.                                                   00190001
002000                                                                  00200001
002100 WORKING-STORAGE SECTION.                                         00210001
002200                                                                  00220001
002300 01  WS-SYSWAIT                       PIC X(08) VALUE 'SYSWAIT'.  00230012
002400                                                                  00240012
002500 01  PV-VARIABLES.                                                00250001
002600     05  PV-UNT-QTY-TOT               PIC S9(9) COMP.             00260001
002700     05  PV-RETRY-COUNTER             PIC S9(04)  VALUE ZEROS     00270001
002800                                                  COMP SYNC.      00280001
002900     05  PV-DELAY-INTERVAL.                                       00290014
003000         10  FILLER                   PIC X(02)   VALUE SPACES.   00300012
003100         10  PV-DELAY-TIME            PIC 9(08)   VALUE 1500.     00310012
003200     05  PV-DISP-SQLCODE              PIC -ZZ9.                           
003300                                                                  00320012
003400 01  PC-CONSTANTS.                                                00330001
003500*    THIS IS SET TO ZERO TO MAXIMIZE THE THROUGHPUT.                      
003600*    IF THE NEED ARISES, WE CAN EASILY INCREASE THIS.                     
003700     05  PC-MAX-RETRIES               PIC S9(03)  VALUE +01       00340001
003800                                                  COMP-3.         00350001
003900                                                                  00360001
004000 01  PS-PROGRAM-STUFF.                                            00370001
004100     05  PS-EXISTENCE-PO              PIC S9 COMP-3 VALUE ZERO.   00380001
004200         88  PS-PO-EXISTS-YES                       VALUE 1.      00390001
004300         88  PS-PO-EXISTS-NO                        VALUE ZERO.   00400001
004400     05  PS-ERROR-SW                    PIC  X(01)  VALUE 'Y'.    00410001
004500         88  PS-NO-ERROR                            VALUE 'Y'.    00420001
004600         88  PS-ERROR                               VALUE 'N'.    00430001
004700     05  PS-CHECK-SW                    PIC  X(01)  VALUE 'Y'.    00440001
004800         88  PS-NO-CHECK                            VALUE 'N'.    00450001
004900         88  PS-CHECK                               VALUE 'Y'.    00460001
005000                                                                  00470012
005100     05  PS-TRY-WAIT-TIME-SW            PIC X(01)   VALUE 'N'.    00480016
005200         88  PS-TRY-WAIT-TIME-YES                   VALUE 'Y'.    00490016
005300         88  PS-TRY-WAIT-TIME-NO                    VALUE 'N'.    00500016
005400                                                                  00510012
005500     05  PS-NULL-IND                    PIC S9(04)  VALUE +0 COMP.00520001
005600     05  PS-NULL-IND2                   PIC S9(04)  VALUE +0 COMP.00520001
005700                                                                  00530001
005800**** PO AGREEMENTS                                                00540001
005900     EXEC SQL                                                     00550001
006000         INCLUDE TPOPRPK                                          00560001
006100     END-EXEC.                                                    00570001
006200                                                                  00580001
006300**** PURCHASING                                                   00590001
006400     EXEC SQL                                                     00600001
006500         INCLUDE TPURCHS                                          00610001
006600     END-EXEC.                                                    00620001
006700                                                                  00630001
006800**** PURCHASING ITEMS                                             00640001
006900     EXEC SQL                                                     00650001
007000         INCLUDE TPURITM                                          00660001
007100     END-EXEC.                                                    00670001
007200                                                                  00680001
007300**** XLT_PK TABLE                                                 00690001
007400     EXEC SQL                                                     00700001
007500         INCLUDE XLT00007                                         00710001
007600     END-EXEC.                                                    00720001
007700                                                                  00730001
007800**** XLT_PK_UPC TABLE                                             00740001
007900     EXEC SQL                                                     00750001
008000         INCLUDE XLT00009                                         00760001
008100     END-EXEC.                                                    00770001
008200                                                                  00780001
008300     EXEC SQL                                                     00790001
008400          INCLUDE SQLCA                                           00800001
008500     END-EXEC.                                                    00810001
008600                                                                  00820001
008700     COPY SQLCA2.                                                 00830001
008800                                                                  00840001
008900 LINKAGE SECTION.                                                 00850001
009000 01  XLRD011-RECORD.                                              00860001
009100     COPY XLRD011.                                                00870001
009200                                                                  00880001
009300******************************************************************00890001
009400 PROCEDURE DIVISION USING XLRD011-RECORD.                         00900001
009500                                                                  00910001
009600     IF XL011-DEBUG-YES                                           00920001
009700         DISPLAY 'XLKUP011'                                       00930001
009800         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
009900                             XL011-RETURN-CODE                            
010000     END-IF                                                       00940001
010100                                                                  00950001
010200     PERFORM 1000-INITIALIZATION.                                 00960001
010300                                                                  00970001
010400     IF PS-NO-ERROR                                               00980001
010500         IF XL011-PACK-CALC-YES                                   00990001
010600             IF PS-PO-EXISTS-YES                                  01000001
010700                 PERFORM 3000-UPDTE-TPOPRPK                       01010001
010800             END-IF                                               01020001
010900         ELSE                                                     01030001
011000             PERFORM 4000-PROCESS-MESSAGE                         01040001
011100         END-IF                                                   01050001
011200     END-IF.                                                      01060001
011300                                                                  01070001
011400     MOVE 'Y'                        TO PS-ERROR-SW.              01080001
011500     MOVE  0                         TO PS-EXISTENCE-PO           01090001
011600                                        PS-NULL-IND               01100001
011700                                        PS-NULL-IND2              01100001
011800                                        PV-UNT-QTY-TOT.           01110001
011900     MOVE 'Y' TO PS-CHECK-SW.                                     01120001
012000     SET XL011-PACK-CALC-NO          TO TRUE                      01130001
012100                                                                  01140001
012200     PERFORM 9999-WRAPUP.                                         01150001
012300                                                                  01160001
012400     GOBACK.                                                      01170001
012500                                                                  01180001
012600******************************************************************01190001
012700 1000-INITIALIZATION.                                             01200001
012800                                                                  01210001
012900     IF XL011-DEBUG-YES                                           01220001
013000         DISPLAY 'XLKUP011 - 1000-INITIALIZATION'                 01230001
013100         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
013200                             XL011-RETURN-CODE                            
013300     END-IF                                                       01240001
013400                                                                  01250001
013500     MOVE 0                           TO PV-UNT-QTY-TOT.          01260001
013600                                                                  01270001
013700     INITIALIZE XL011-RETURN-AREA                                 01280001
013800     MOVE 'XLKUP011'                  TO XL011-ERROR-PROGRAM.     01290001
013900     PERFORM 2000-CHECK-TPURCHS.                                  01300001
014000     IF PS-NO-ERROR                                               01310001
014100         PERFORM 2100-CHECK-TPOPRPK                               01320001
014200     END-IF.                                                      01330001
014300                                                                  01340001
014400******************************************************************01350001
014500 2000-CHECK-TPURCHS.                                              01360001
014600                                                                  01370001
014700     IF XL011-DEBUG-YES                                           01380001
014800         DISPLAY 'XLKUP011 - 2000-CHECK-TPURCHS'                  01390001
014900         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
015000                             XL011-RETURN-CODE                            
015100     END-IF                                                       01400001
015200                                                                  01410001
015300     MOVE '2000-CHECK-TPURCHS '     TO XL011-ERROR-PARAGRAPH.     01420001
015400     MOVE XL011-ORDER-NBR           TO PURCHS-PO-NBR.             01430001
015500                                                                  01440001
015600     PERFORM                                                      03022030
015700         WITH TEST AFTER                                          03023030
015800         VARYING PV-RETRY-COUNTER                                 03024030
015900         FROM 1 BY 1                                              03025030
016000         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  03026030
016100            OR (SQLCODE = ZERO)                                   03027030
016200            OR (SQLCODE = +100)                                   03027030
016300            OR PS-ERROR                                                   
016400                                                                  03028030
016500     EXEC SQL                                                     01450001
016600         SELECT PKGNG_CDE                                         01460001
016700         INTO  :PURCHS-PKGNG-CDE                                  01470001
016800         FROM  TPURCHS                                            01480001
016900         WHERE PO_NBR                 = :PURCHS-PO-NBR            01490001
017000         AND VER_STATUS_CDE           = 'A'                       01500001
017100     END-EXEC                                                     01510001
017200                                                                  01520001
017300     MOVE SQLCODE          TO XL011-SQLCODE                       06320001
017400                              PV-DISP-SQLCODE                             
017500     IF XL011-DEBUG-YES                                           04930001
017600         DISPLAY 'XLKUP011 - SQLCODE = ' PV-DISP-SQLCODE          04940001
017700             ' RETRY = ' PV-RETRY-COUNTER                                 
017800         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
017900                             XL011-RETURN-CODE                            
018000     END-IF                                                       04950001
018100     EVALUATE TRUE                                                01540001
018200         WHEN SQLCODE = ZERO                                      01550001
018300             CONTINUE                                             01560001
018400         WHEN SQLCODE = +100                                      01570001
018500             STRING 'NO TPURCHS FOR PO = ' XL011-ORDER-NBR        01580001
018600                     DELIMITED BY SIZE                            01590001
018700                                      INTO XL011-ERROR-TEXT       01600001
018800             SET XL011-SYSTEM-ERROR                               01610001
018900                 PS-ERROR             TO TRUE                     01620001
019000             MOVE 'TPURCHS'           TO XL011-DB2-TABLE-NAME(1)  01630001
019100                                                                          
019200         WHEN SQLCODE = -911                                      03261030
019300         WHEN SQLCODE = -913                                      03262030
019400         WHEN SQLCODE = -904                                      03263030
019500             CONTINUE                                             03264030
019600         WHEN OTHER                                               01640001
019700             SET XL011-SQL-ERROR                                  01650001
019800                 PS-ERROR             TO TRUE                     01660001
019900             MOVE 'TPURCHS'           TO XL011-DB2-TABLE-NAME(1)  01670001
020000     END-EVALUATE                                                 01680001
020100                                                                          
020200     END-PERFORM                                                          
020300                                                                  01690001
020400     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        03322030
020500         SET XL011-SQL-ERROR      TO TRUE                         03324030
020600         MOVE 'TPURCHS'           TO XL011-DB2-TABLE-NAME(1)      03300001
020700     END-IF.                                                      03325030
020800                                                                  03326030
020900******************************************************************01700001
021000 2100-CHECK-TPOPRPK.                                              01710001
021100                                                                  01720001
021200     IF XL011-DEBUG-YES                                           01730001
021300         DISPLAY 'XLKUP011 - 2100-CHECK-TPOPRPK'                  01740001
021400         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
021500                             XL011-RETURN-CODE                            
021600     END-IF                                                       01750001
021700                                                                  01760001
021800     MOVE '2100-CHECK-TPOPRPK '     TO XL011-ERROR-PARAGRAPH.     01770001
021900     MOVE ZERO                      TO PS-EXISTENCE-PO.           01780001
022000     MOVE XL011-ORDER-NBR           TO POPRPK-PO-NBR.             01790001
022100                                                                  01800005
022200*LMM 8/5                                                          01810009
022300     IF XL011-PACK-CALC-YES                                       01820001
022400           IF XL011-SA-PACK-SKU-IND = 'Y'                         01830005
022500              MOVE XL011-PACK-SKU-NBR    TO POPRPK-PK-SKU-NBR     01840006
022600           ELSE                                                   01850005
022700              MOVE XL011-SA-COMP-SKU-NBR TO POPRPK-PK-SKU-NBR     01860006
022800           END-IF                                                 01870005
022900     ELSE                                                         01880001
023000         EVALUATE XL011-MSG-ID                                    01890001
023100             WHEN 'ORD_SKU_ADD'                                   01900001
023200                 MOVE XL011-SA-COMP-SKU-NBR TO POPRPK-PK-SKU-NBR  01910001
023300             WHEN 'ORD_PACK_HDR_CHANGE'                           01920001
023400                 MOVE XL011-PHC-PK-SKU    TO POPRPK-PK-SKU-NBR    01930001
023500             WHEN 'ORD_SKU_DELETE'                                01940001
023600                 MOVE XL011-SD-COMP-SKU-NBR TO POPRPK-PK-SKU-NBR  01950001
023700             WHEN 'HDR_DELETE'                                    01960001
023800                 SET PS-NO-CHECK          TO TRUE                 01970001
023900        END-EVALUATE                                              01980001
024000     END-IF.                                                      01990001
024100                                                                  02000001
024200     IF PS-CHECK                                                  02010001
024300                                                                          
024400     IF XL011-DEBUG-YES                                           04930001
024500         DISPLAY 'XLKUP011 - POPRPK-PO-NBR ' POPRPK-PO-NBR        04940001
024600                  ' POPRPK-PK-SKU-NBR '  POPRPK-PK-SKU-NBR                
024700         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
024800                             XL011-RETURN-CODE                            
024900     END-IF                                                       04950001
025000     PERFORM                                                      03022030
025100         WITH TEST AFTER                                          03023030
025200         VARYING PV-RETRY-COUNTER                                 03024030
025300         FROM 1 BY 1                                              03025030
025400         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  03026030
025500            OR (SQLCODE = ZERO)                                   03027030
025600            OR (SQLCODE = +100)                                   03027030
025700                                                                  03028030
025800         EXEC SQL                                                 02020001
025900             SELECT 1                                             02030001
026000             INTO :PS-EXISTENCE-PO                                02040001
026100             FROM  TPOPRPK                                        02050001
026200             WHERE PO_NBR               = :POPRPK-PO-NBR          02060001
026300               AND PK_SKU_NBR           = :POPRPK-PK-SKU-NBR      02070001
026400*LMM           AND PREPK_STAT_CDE       = 'A'                     02080002
026500             FETCH FIRST 1 ROWS ONLY                              02090001
026600           END-EXEC                                               02100001
026700                                                                  02110001
026800     MOVE SQLCODE          TO XL011-SQLCODE                       06320001
026900                              PV-DISP-SQLCODE                             
027000     IF XL011-DEBUG-YES                                           04930001
027100         DISPLAY 'XLKUP011 - SQLCODE = ' PV-DISP-SQLCODE          04940001
027200             ' RETRY = ' PV-RETRY-COUNTER                                 
027300         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
027400                             XL011-RETURN-CODE                            
027500     END-IF                                                       04950001
027600         EVALUATE TRUE                                            02130001
027700             WHEN SQLCODE = ZERO                                  02140001
027800             WHEN SQLCODE = +100                                  02150001
027900                 CONTINUE                                         02160001
028000             WHEN SQLCODE = -911                                  03261030
028100             WHEN SQLCODE = -913                                  03262030
028200             WHEN SQLCODE = -904                                  03263030
028300                 CONTINUE                                         03264030
028400             WHEN OTHER                                           02170001
028500                 SET XL011-SQL-ERROR                              02180001
028600                     PS-ERROR             TO TRUE                 02190001
028700                 MOVE 'TPOPRPK'     TO XL011-DB2-TABLE-NAME(1)    02200001
028800         END-EVALUATE                                             02210001
028900     END-PERFORM                                                          
029000                                                                  03321030
029100         IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                    03322030
029200             SET XL011-SQL-ERROR      TO TRUE                     03324030
029300             MOVE 'TPOPRPK'           TO XL011-DB2-TABLE-NAME(1)  03300001
029400         END-IF                                                   03325030
029500                                                                          
029600      ELSE                                                        02220001
029700                                                                          
029800         MOVE 'Y' TO PS-CHECK-SW                                  02230001
029900                                                                          
030000      END-IF.                                                     02240001
030100                                                                  02250001
030200******************************************************************02260001
030300 3000-UPDTE-TPOPRPK.                                              02270001
030400                                                                  02280001
030500     IF XL011-DEBUG-YES                                           02290001
030600         DISPLAY 'XLKUP011 - 3000-UPDTE-TPOPRPK'                  02300001
030700         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
030800                             XL011-RETURN-CODE                            
030900     END-IF                                                       02310001
031000                                                                  02320001
031100     MOVE XL011-ORDER-NBR              TO POPRPK-PO-NBR           02330001
031200     MOVE '3000-UPDTE-TPOPRPK'         TO XL011-ERROR-PARAGRAPH.  02340001
031300     PERFORM 3100-SUM-TPURITM.                                    02350001
031400                                                                  02360001
031500     IF PS-NO-ERROR                                               02370001
031600       PERFORM 3200-GET-XLT-PK                                    02380001
031700       IF PS-NO-ERROR                                             02390001
031800         MOVE PURITM-PREPK-RATO-QTY    TO POPRPK-INPK-UNT-QTY     02400001
031900         IF XLT00007-DC-ORD-MULT-QTY = 1                          02401028
032000             MOVE 'M'                  TO POPRPK-PREPK-TYP-CDE    02402028
032100         ELSE                                                     02403028
032200             MOVE 'I'                  TO POPRPK-PREPK-TYP-CDE    02404028
032300         END-IF                                                   02405028
032400*        IF PURCHS-PKGNG-CDE = 'M'                                02410028
032500         IF POPRPK-PREPK-TYP-CDE = 'M'                            02411028
032600             MOVE 0                    TO POPRPK-OTPK-UNT-QTY     02420001
032700         ELSE                                                     02430001
032800             COMPUTE POPRPK-OTPK-UNT-QTY =                        02440001
032900                                    PURITM-PREPK-RATO-QTY *       02450001
033000                                    XLT00007-DC-ORD-MULT-QTY      02460001
033100              ON SIZE ERROR                                       02470001
033200                   MOVE ZERO TO POPRPK-OTPK-UNT-QTY               02480001
033300              END-COMPUTE                                         02490001
033400         END-IF                                                   02500001
033500                                                                  02510001
033600         COMPUTE POPRPK-OTPK-ORD-QTY =                            02520001
033700                   (PV-UNT-QTY-TOT / POPRPK-INPK-UNT-QTY) /       02530001
033800                                    XLT00007-DC-ORD-MULT-QTY      02540001
033900                                                                  02550001
034000         ON SIZE ERROR                                            02560001
034100            MOVE ZERO TO POPRPK-OTPK-ORD-QTY                      02570001
034200         END-COMPUTE                                              02580001
034300        END-IF                                                    02590001
034400     END-IF.                                                      02600001
034500                                                                  02610001
034600     IF PS-NO-ERROR                                               02620001
034700                                                                          
034800     IF XL011-DEBUG-YES                                           04930001
034900         DISPLAY 'XLKUP011 - POPRPK-PO-NBR ' POPRPK-PO-NBR        04940001
035000                  ' POPRPK-PK-SKU-NBR '  POPRPK-PK-SKU-NBR                
035100         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
035200                             XL011-RETURN-CODE                            
035300     END-IF                                                       04950001
035400     PERFORM                                                      03022030
035500         WITH TEST AFTER                                          03023030
035600         VARYING PV-RETRY-COUNTER                                 03024030
035700         FROM 1 BY 1                                              03025030
035800         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  03026030
035900            OR (SQLCODE = ZERO)                                   03027030
036000            OR (SQLCODE = +100)                                   03027030
036100            OR PS-ERROR                                                   
036200                                                                  03028030
036300         EXEC SQL                                                 02630001
036400             UPDATE TPOPRPK                                       02640001
036500               SET                                                02650001
036600                  PREPK_TYP_CDE  =   :POPRPK-PREPK-TYP-CDE        02651028
036700                 ,OTPK_ORD_QTY   =   :POPRPK-OTPK-ORD-QTY         02660023
036800                 ,INPK_UNT_QTY   =   :POPRPK-INPK-UNT-QTY         02670001
036900                 ,OTPK_UNT_QTY   =   :POPRPK-OTPK-UNT-QTY         02680001
037000             WHERE PO_NBR               = :POPRPK-PO-NBR          02690001
037100               AND PK_SKU_NBR           = :POPRPK-PK-SKU-NBR      02700001
037200*LMM           AND PREPK_STAT_CDE       = 'A'                     02710002
037300        END-EXEC                                                  02720001
037400                                                                  02730001
037500     MOVE SQLCODE          TO XL011-SQLCODE                       06320001
037600                              PV-DISP-SQLCODE                             
037700     IF XL011-DEBUG-YES                                           04930001
037800         DISPLAY 'XLKUP011 - SQLCODE = ' PV-DISP-SQLCODE          04940001
037900             ' RETRY = ' PV-RETRY-COUNTER                                 
038000         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
038100                             XL011-RETURN-CODE                            
038200     END-IF                                                       04950001
038300         EVALUATE TRUE                                            02750001
038400             WHEN SQLCODE = ZERO                                  02760001
038500                 MOVE 'N' TO XL011-PACK-CALC                      02780001
038600             WHEN SQLCODE = -911                                  03261030
038700             WHEN SQLCODE = -913                                  03262030
038800             WHEN SQLCODE = -904                                  03263030
038900                 CONTINUE                                         03264030
039000             WHEN OTHER                                           02790001
039100                 SET XL011-SQL-ERROR                              02800001
039200                     PS-ERROR             TO TRUE                 02810001
039300                 MOVE 'TPOPRPK'         TO XL011-DB2-TABLE-NAME(1)02820001
039400         END-EVALUATE                                             02830001
039500     END-PERFORM                                                          
039600                                                                          
039700                                                                  03321030
039800         IF PV-RETRY-COUNTER > PC-MAX-RETRIES                     03322030
039900             SET XL011-SQL-ERROR  TO TRUE                         03324030
040000             MOVE 'TPOPRPK'       TO XL011-DB2-TABLE-NAME(1)      03300001
040100         END-IF                                                   03325030
040200                                                                  03326030
040300     END-IF.                                                      02840001
040400                                                                  02850001
040500******************************************************************02860001
040600 3100-SUM-TPURITM.                                                02870001
040700                                                                  02880001
040800     IF XL011-DEBUG-YES                                           02890001
040900         DISPLAY 'XLKUP011 - 3100-SUM-TPURITM'                    02900001
041000         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
041100                             XL011-RETURN-CODE                            
041200     END-IF                                                       02910001
041300                                                                  02920001
041400     MOVE '3100-SUM-TPURITM '     TO XL011-ERROR-PARAGRAPH.       02930001
041500     MOVE XL011-ORDER-NBR         TO PURITM-PO-NBR                02940001
041600                                                                  02950007
041700*LMM 8/5                                                          02960009
041800     IF XL011-SA-PACK-SKU-IND = 'Y'                               02970007
041900        MOVE XL011-PACK-SKU-NBR    TO POPRPK-PK-SKU-NBR           02980007
042000     ELSE                                                         02990007
042100        MOVE XL011-SA-COMP-SKU-NBR TO POPRPK-PK-SKU-NBR           03000007
042200     END-IF                                                       03010007
042300                                                                  03020001
042400     IF XL011-DEBUG-YES                                           04930001
042500         DISPLAY 'XLKUP011 - POPRPK-PO-NBR ' POPRPK-PO-NBR        04940001
042600                  ' POPRPK-PK-SKU-NBR '  POPRPK-PK-SKU-NBR                
042700         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
042800                             XL011-RETURN-CODE                            
042900     END-IF                                                       04950001
043000                                                                  03021030
043100     PERFORM                                                      03022030
043200         WITH TEST AFTER                                          03023030
043300         VARYING PV-RETRY-COUNTER                                 03024030
043400         FROM 1 BY 1                                              03025030
043500         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  03026030
043600            OR (SQLCODE = ZERO)                                   03027030
043700            OR (SQLCODE = +100)                                   03027030
043800            OR PS-ERROR                                                   
043900                                                                  03028030
044000     EXEC SQL                                                     03030001
044100         SELECT SUM(PREPK_RATO_QTY)                               03040001
044200               ,SUM(UNT_QTY)                                      03050001
044300         INTO  :PURITM-PREPK-RATO-QTY :PS-NULL-IND                03060001
044400              ,:PV-UNT-QTY-TOT :PS-NULL-IND2                      03070001
044500         FROM  TPURITM A                                          03080001
044600              ,TPOPRPK B                                          03090001
044700         WHERE A.PO_NBR                 = :PURITM-PO-NBR          03100001
044800           AND A.PO_NBR                 = B.PO_NBR                03110001
044900           AND A.PO_PREPK_ID            = B.PO_PREPK_ID           03120001
045000           AND A.VER_STATUS_CDE         = 'A'                     03130001
045100           AND B.PK_SKU_NBR             = :POPRPK-PK-SKU-NBR      03140001
045200     END-EXEC                                                     03150030
045300                                                                  03160001
045400     MOVE SQLCODE          TO XL011-SQLCODE                       06320001
045500                              PV-DISP-SQLCODE                             
045600     IF XL011-DEBUG-YES                                           04930001
045700         DISPLAY 'XLKUP011 - SQLCODE = ' PV-DISP-SQLCODE          04940001
045800             ' RETRY = ' PV-RETRY-COUNTER                                 
045900         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
046000                             XL011-RETURN-CODE                            
046100     END-IF                                                       04950001
046200     EVALUATE TRUE                                                03180001
046300         WHEN SQLCODE = ZERO                                      03190001
046400             CONTINUE                                             03200001
046500         WHEN SQLCODE = +100                                      03210001
046600             STRING 'NO TPURITM FOR PO = ' XL011-ORDER-NBR        03220001
046700                     DELIMITED BY SIZE  INTO XL011-ERROR-TEXT     03230001
046800             SET XL011-SYSTEM-ERROR                               03240001
046900                 PS-ERROR             TO TRUE                     03250001
047000             MOVE 'TPURITM'           TO XL011-DB2-TABLE-NAME(1)  03260001
047100             MOVE 'TPOPRPK'           TO XL011-DB2-TABLE-NAME(2)  03260001
047200                                                                          
047300         WHEN SQLCODE = -911                                      03261030
047400         WHEN SQLCODE = -913                                      03262030
047500         WHEN SQLCODE = -904                                      03263030
047600             CONTINUE                                             03264030
047700         WHEN OTHER                                               03270001
047800             SET XL011-SQL-ERROR                                  03280001
047900                 PS-ERROR             TO TRUE                     03290001
048000             MOVE 'TPURITM'           TO XL011-DB2-TABLE-NAME(1)  03300001
048100             MOVE 'TPOPRPK'           TO XL011-DB2-TABLE-NAME(2)  03260001
048200     END-EVALUATE                                                 03310030
048300                                                                  03311030
048400     END-PERFORM.                                                 03312030
048500                                                                  03321030
048600     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        03322030
048700         SET XL011-SQL-ERROR      TO TRUE                         03324030
048800         MOVE 'TPURITM'           TO XL011-DB2-TABLE-NAME(1)      03300001
048900         MOVE 'TPOPRPK'           TO XL011-DB2-TABLE-NAME(2)      03260001
049000     END-IF.                                                      03325030
049100                                                                  03326030
049200******************************************************************03330001
049300 3200-GET-XLT-PK.                                                 03340001
049400                                                                  03350001
049500     IF XL011-DEBUG-YES                                           03360001
049600         DISPLAY 'XLKUP011 - 3200-GET-XLT-PK'                     03370001
049700         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
049800                             XL011-RETURN-CODE                            
049900     END-IF                                                       03380001
050000                                                                  03390001
050100     MOVE '3200-GET-XLT-PK  '     TO XL011-ERROR-PARAGRAPH.       03400001
050200*LMM 8/5                                                          03410009
050300     IF XL011-SA-PACK-SKU-IND = 'Y'                               03420008
050400        MOVE XL011-PACK-SKU-NBR    TO XLT00007-PK-SKU-NBR         03430008
050500     ELSE                                                         03440008
050600        MOVE XL011-SA-COMP-SKU-NBR TO XLT00007-PK-SKU-NBR         03450008
050700     END-IF                                                       03460008
050800                                                                  03470001
050900*    PERFORM                                                      03480022
051000*        WITH TEST AFTER                                          03490022
051100*        VARYING PV-RETRY-COUNTER                                 03500022
051200*        FROM 1 BY 1                                              03510022
051300*        UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  03520022
051400*           OR SQLCODE = +0                                       03530022
051500*                                                                 03540022
051600*        EXEC SQL                                                 03550022
051700*            SELECT DC_ORD_MULT_QTY                               03560022
051800*            INTO  :XLT00007-DC-ORD-MULT-QTY :PS-NULL-IND         03570022
051900*            FROM  XLT_PK                                         03580022
052000*            WHERE PK_SKU_NBR         = :XLT00007-PK-SKU-NBR      03590022
052100*        END-EXEC                                                 03600022
052200*                                                                 03610022
052300*    END-PERFORM.                                                 03620022
052400*                                                                 03630022
052500*    MOVE SQLCODE                     TO XL011-SQLCODE.           03640022
052600*    EVALUATE TRUE                                                03650022
052700*        WHEN SQLCODE = ZERO                                      03660022
052800*            CONTINUE                                             03670022
052900*        WHEN SQLCODE = +100                                      03680022
053000*            STRING 'NO XLT_PK FOR PO = ' XL011-ORDER-NBR         03690022
053100*                    ' SKU = ' XL011-PACK-SKU-NBR                 03700022
053200*                    DELIMITED BY SIZE  INTO XL011-ERROR-TEXT     03710022
053300*            SET XL011-SYSTEM-ERROR                               03720022
053400*                PS-ERROR             TO TRUE                     03730022
053500*            MOVE 'XLT_PK '           TO XL011-DB2-TABLE-NAME(1)  03740022
053600*        WHEN OTHER                                               03750022
053700*            SET XL011-SQL-ERROR                                  03760022
053800*                PS-ERROR             TO TRUE                     03770022
053900*            MOVE 'XLT_PK '           TO XL011-DB2-TABLE-NAME(1)  03780022
054000*    END-EVALUATE.                                                03790022
054100                                                                  03800020
054200     IF XL011-DEBUG-YES                                           04930001
054300         DISPLAY 'XLKUP011 - XLT00007-PK-SKU-NBR = '              04940001
054400                  XLT00007-PK-SKU-NBR                                     
054500         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
054600                             XL011-RETURN-CODE                            
054700     END-IF                                                       04950001
054800                                                                  03021030
054900                                                                  03810020
055000     PERFORM                                                      03820021
055100         WITH TEST AFTER                                          03830021
055200         VARYING PV-RETRY-COUNTER                                 03840021
055300         FROM 1 BY 1                                              03850021
055400         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  03860021
055500            OR SQLCODE = +0                                       03870021
055600                                                                  03880021
055700         EXEC SQL                                                 03890021
055800             SELECT DC_ORD_MULT_QTY                               03900021
055900             INTO  :XLT00007-DC-ORD-MULT-QTY :PS-NULL-IND         03910021
056000             FROM  XLT_PK                                         03920021
056100             WHERE PK_SKU_NBR         = :XLT00007-PK-SKU-NBR      03930021
056200         END-EXEC                                                 03940021
056300                                                                  03950020
056400     MOVE SQLCODE          TO XL011-SQLCODE                       06320001
056500                              PV-DISP-SQLCODE                             
056600     IF XL011-DEBUG-YES                                           04930001
056700         DISPLAY 'XLKUP011 - SQLCODE = ' PV-DISP-SQLCODE          04940001
056800             ' RETRY = ' PV-RETRY-COUNTER                                 
056900         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
057000                             XL011-RETURN-CODE                            
057100     END-IF                                                       04950001
057200         IF PV-RETRY-COUNTER > PC-MAX-RETRIES                     03960021
057300             AND SQLCODE NOT = +0                                 03970021
057400             AND PS-TRY-WAIT-TIME-NO                              03980021
057500                                                                  03990021
057600**               WAIT FOR 5 SECONDS AND TRY AGAIN                 04000017
057700**               THEN SET SWITCH SO IT ONLY WAITS ONCE            04010017
057800                                                                  04020021
057900                 CALL WS-SYSWAIT USING PV-DELAY-INTERVAL          04030021
058000                 SET PS-TRY-WAIT-TIME-YES TO TRUE                 04040021
058100                 MOVE ZERO TO PV-RETRY-COUNTER                    04050021
058200         ELSE                                                     04060021
058300             CONTINUE                                             04070021
058400         END-IF                                                   04080021
058500                                                                  04090021
058600     END-PERFORM.                                                 04100021
058700                                                                  04110021
058800                                                                  04120021
058900     MOVE SQLCODE    TO XL011-SQLCODE.                            04130021
059000     MOVE 'N'        TO PS-TRY-WAIT-TIME-SW.                      04140021
059100                                                                  04150021
059200     EVALUATE TRUE                                                04160021
059300         WHEN SQLCODE = ZERO                                      04170021
059400             CONTINUE                                             04180021
059500         WHEN SQLCODE = +100                                      04190021
059600             STRING 'NO XLT_PK FOR PO = ' XL011-ORDER-NBR         04200021
059700                     ' SKU = ' XL011-PACK-SKU-NBR                 04210021
059800                     DELIMITED BY SIZE  INTO XL011-ERROR-TEXT     04220021
059900             SET XL011-SYSTEM-ERROR                               04230021
060000                 PS-ERROR             TO TRUE                     04240021
060100             MOVE 'XLT_PK '           TO XL011-DB2-TABLE-NAME(1)  04250021
060200         WHEN OTHER                                               04260021
060300             SET XL011-SQL-ERROR                                  04270021
060400                 PS-ERROR             TO TRUE                     04280021
060500             MOVE 'XLT_PK '           TO XL011-DB2-TABLE-NAME(1)  04290021
060600     END-EVALUATE.                                                04300021
060700                                                                  04310001
060800******************************************************************04320001
060900 4000-PROCESS-MESSAGE.                                            04330022
061000                                                                  04340001
061100     IF XL011-DEBUG-YES                                           04350022
061200         DISPLAY 'XLKUP011 - 4000-PROCESS-MESSAGE'                04360022
061300         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
061400                             XL011-RETURN-CODE                            
061500     END-IF                                                       04370022
061600                                                                  04380022
061700     MOVE '4000-PROCESS-MESSAGE '     TO XL011-ERROR-PARAGRAPH.   04390022
061800                                                                  04400022
061900     EVALUATE XL011-MSG-ID                                        04410022
062000       WHEN 'ORD_SKU_ADD'                                         04420022
062100           IF XL011-SA-PACK-SKU-IND = 'Y'                         04430022
062200               IF PS-PO-EXISTS-NO                                 04440022
062300                   PERFORM 4005-CHECK-4-TPOPRPK                   04450022
062400                   PERFORM 4100-INSERT-ORD-SKU                    04460022
062500               END-IF                                             04470022
062600           END-IF                                                 04480022
062700       WHEN 'ORD_PACK_HDR_CHANGE'                                 04490022
062800           PERFORM 4200-CHANGE-ORD-HDR                            04500022
062900       WHEN 'HDR_DELETE'                                          04510022
063000           PERFORM 4300-DELETE-HDR                                04520022
063100       WHEN 'ORD_SKU_DELETE'                                      04530022
063200           IF XL011-SD-PK-SKU-IND  = 'Y'                          04540022
063300               PERFORM 4400-DELETE-ORD-SKU                        04550022
063400           END-IF                                                 04560022
063500     END-EVALUATE.                                                04570022
063600                                                                  04580001
063700*************************************************************     04590001
063800 4005-CHECK-4-TPOPRPK.                                            04600001
063900                                                                  04610001
064000     IF XL011-DEBUG-YES                                           04620001
064100         DISPLAY 'XLKUP011 - 4005-CHECK-4-TPOPRPK'                04630001
064200         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
064300                             XL011-RETURN-CODE                            
064400     END-IF                                                       04640001
064500                                                                  04650001
064600     MOVE '4005-CHECK-4-TPOPRPK '     TO XL011-ERROR-PARAGRAPH.   04660001
064700                                                                  04670001
064800     IF XL011-DEBUG-YES                                           04930001
064900         DISPLAY 'XLKUP011 - POPRPK-PO-NBR ' POPRPK-PO-NBR        04940001
065000         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
065100                             XL011-RETURN-CODE                            
065200     END-IF                                                       04950001
065300                                                                  03021030
065400     PERFORM                                                      03022030
065500         WITH TEST AFTER                                          03023030
065600         VARYING PV-RETRY-COUNTER                                 03024030
065700         FROM 1 BY 1                                              03025030
065800         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  03026030
065900            OR (SQLCODE = ZERO)                                   03027030
066000            OR PS-ERROR                                                   
066100                                                                  03028030
066200     EXEC SQL                                                     04680001
066300         SELECT MAX(PO_PREPK_ID)                                  04690001
066400         INTO :POPRPK-PO-PREPK-ID :PS-NULL-IND                    04700001
066500         FROM  TPOPRPK                                            04710001
066600         WHERE PO_NBR               = :POPRPK-PO-NBR              04720001
066700       END-EXEC                                                   04730001
066800                                                                  04740001
066900     MOVE SQLCODE          TO XL011-SQLCODE                       06320001
067000                              PV-DISP-SQLCODE                             
067100     IF XL011-DEBUG-YES                                           04930001
067200         DISPLAY 'XLKUP011 - SQLCODE = ' PV-DISP-SQLCODE          04940001
067300             ' RETRY = ' PV-RETRY-COUNTER                                 
067400         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
067500                             XL011-RETURN-CODE                            
067600     END-IF                                                       04950001
067700                                                                  04960001
067800                                                                          
067900       EVALUATE TRUE                                              04760001
068000           WHEN SQLCODE = ZERO                                    04770001
068100               IF PS-NULL-IND = ZERO                              04780001
068200                   ADD +1 TO POPRPK-PO-PREPK-ID                   04790001
068300                   IF POPRPK-PO-PREPK-ID = 99                     04800001
068400                      ADD +1 TO POPRPK-PO-PREPK-ID                04810001
068500                   END-IF                                         04820001
068600               ELSE                                               04830001
068700                   MOVE +1 TO POPRPK-PO-PREPK-ID                  04840001
068800               END-IF                                             04850001
068900                                                                          
069000         WHEN SQLCODE = -911                                      03261030
069100         WHEN SQLCODE = -913                                      03262030
069200         WHEN SQLCODE = -904                                      03263030
069300             CONTINUE                                             03264030
069400                                                                          
069500           WHEN OTHER                                             04860001
069600             SET XL011-SQL-ERROR                                  05550001
069700                 PS-ERROR             TO TRUE                     05560001
069800             MOVE 'TPOPRPK'           TO XL011-DB2-TABLE-NAME(1)  05570001
069900       END-EVALUATE                                               04880001
070000                                                                          
070100     END-PERFORM                                                          
070200                                                                  03321030
070300     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        03322030
070400         SET XL011-SQL-ERROR      TO TRUE                         03324030
070500         MOVE 'TPOPRPK'           TO XL011-DB2-TABLE-NAME(1)      03300001
070600     END-IF.                                                      03325030
070700                                                                  03326030
070800                                                                  04890001
070900******************************************************************04900001
071000 4100-INSERT-ORD-SKU.                                             04910029
071100                                                                  04920001
071200     IF XL011-DEBUG-YES                                           04930001
071300         DISPLAY 'XLKUP011 - 4100-INSERT-ORD-SKU'                 04940001
071400         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
071500                             XL011-RETURN-CODE                            
071600     END-IF                                                       04950001
071700                                                                  04960001
071800     MOVE '4100-INSERT-ORD-SKU'       TO XL011-ERROR-PARAGRAPH.   04970001
071900                                                                  04980001
072000     MOVE XL011-ORDER-NBR         TO POPRPK-PO-NBR.               04990001
072100     MOVE 1                       TO POPRPK-VER-NBR.              05000001
072200*    MOVE PURCHS-PKGNG-CDE        TO POPRPK-PREPK-TYP-CDE.        05010027
072300     MOVE XL011-SA-PK-SKU-DESC    TO POPRPK-PREPK-DESC.           05020001
072400     MOVE 'A'                     TO POPRPK-PREPK-STAT-CDE.       05030001
072500     PERFORM 4105-GET-UPC.                                        05040001
072600     MOVE XLT00009-UPC-NBR        TO POPRPK-PREPK-UPC-NBR.        05050001
072700     MOVE 0                       TO POPRPK-INPK-UNT-QTY.         05060001
072800     MOVE 'N'                     TO POPRPK-INPK-CNVYB-IND.       05070001
072900     MOVE 0                       TO POPRPK-OTPK-ORD-QTY          05080001
073000                                     POPRPK-OTPK-UNT-QTY.         05090001
073100     IF XL011-SA-DC-ORD-MULT-QTY = 1                              05091027
073200         MOVE 'M'                 TO POPRPK-PREPK-TYP-CDE         05092027
073300     ELSE                                                         05093027
073400         MOVE 'I'                 TO POPRPK-PREPK-TYP-CDE         05094027
073500     END-IF                                                       05095027
073600                                                                  05100001
073700     EXEC SQL                                                     05110001
073800         SET :POPRPK-PK-DTL-CHG-TMST  = CURRENT TIMESTAMP         05120001
073900     END-EXEC                                                     05130001
074000                                                                          
074100     IF XL011-DEBUG-YES                                           04930001
074200         DISPLAY 'XLKUP011 - POPRPK-PK-DTL-CHG-TMST '             04940001
074300                          POPRPK-PK-DTL-CHG-TMST                          
074400         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
074500                             XL011-RETURN-CODE                            
074600     END-IF                                                       04950001
074700                                                                  04960001
074800                                                                  04670001
074900     IF XL011-DEBUG-YES                                           04930001
075000         DISPLAY 'XLKUP011 - POPRPK-PO-NBR ' POPRPK-PO-NBR        04940001
075100                  ' POPRPK-PREPK-ID '  POPRPK-PO-PREPK-ID                 
075200                  ' POPRPK-PK-SKU-NBR '  POPRPK-PK-SKU-NBR                
075300         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
075400                             XL011-RETURN-CODE                            
075500     END-IF                                                       04950001
075600                                                                  03810020
075700     PERFORM                                                      03820021
075800         WITH TEST AFTER                                          03830021
075900         VARYING PV-RETRY-COUNTER                                 03840021
076000         FROM 1 BY 1                                              03850021
076100         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  03860021
076200            OR SQLCODE = +0                                       03870021
076300            OR PS-ERROR                                                   
076400                                                                  03880021
076500     EXEC SQL                                                     05140001
076600         INSERT INTO TPOPRPK                                      05150001
076700             (                                                    05160001
076800              PO_NBR                                              05170001
076900             ,VER_NBR                                             05180001
077000             ,PO_PREPK_ID                                         05190001
077100             ,PREPK_TYP_CDE                                       05200001
077200             ,PREPK_DESC                                          05210001
077300             ,PREPK_STAT_CDE                                      05220001
077400             ,PREPK_UPC_NBR                                       05230001
077500             ,INPK_UNT_QTY                                        05240001
077600             ,INPK_CNVYB_IND                                      05250001
077700             ,OTPK_UNT_QTY                                        05260001
077800             ,OTPK_ORD_QTY                                        05270001
077900             ,PK_DTL_CHG_TMST                                     05280001
078000             ,PK_SKU_NBR                                          05290001
078100             )                                                    05300001
078200         VALUES                                                   05310001
078300             (                                                    05320001
078400             :POPRPK-PO-NBR                                       05330001
078500            ,:POPRPK-VER-NBR                                      05340001
078600            ,:POPRPK-PO-PREPK-ID                                  05350001
078700            ,:POPRPK-PREPK-TYP-CDE                                05360001
078800            ,:POPRPK-PREPK-DESC                                   05370001
078900            ,:POPRPK-PREPK-STAT-CDE                               05380001
079000            ,:POPRPK-PREPK-UPC-NBR                                05390001
079100            ,:POPRPK-INPK-UNT-QTY                                 05400001
079200            ,:POPRPK-INPK-CNVYB-IND                               05410001
079300            ,:POPRPK-OTPK-UNT-QTY                                 05420001
079400            ,:POPRPK-OTPK-ORD-QTY                                 05430001
079500            ,:POPRPK-PK-DTL-CHG-TMST                              05440001
079600            ,:POPRPK-PK-SKU-NBR                                   05450001
079700             )                                                    05460001
079800        END-EXEC                                                  05470001
079900                                                                  05480001
080000     MOVE SQLCODE                     TO XL011-SQLCODE                  15
080100                                         PV-DISP-SQLCODE                  
080200                                                                          
080300     IF XL011-DEBUG-YES                                           04930001
080400         DISPLAY 'XLKUP011 - SQLCODE = ' PV-DISP-SQLCODE          04940001
080500             ' RETRY = ' PV-RETRY-COUNTER                                 
080600         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
080700                             XL011-RETURN-CODE                            
080800     END-IF                                                       04950001
080900                                                                  04960001
081000     EVALUATE TRUE                                                05500001
081100         WHEN SQLCODE = ZERO                                      05510001
081200             CONTINUE                                             05530001
081300         WHEN SQLCODE = -911                                      03261030
081400         WHEN SQLCODE = -913                                      03262030
081500         WHEN SQLCODE = -904                                      03263030
081600             CONTINUE                                             03264030
081700         WHEN OTHER                                               05540001
081800             SET XL011-SQL-ERROR                                  05550001
081900                 PS-ERROR             TO TRUE                     05560001
082000             MOVE 'TPOPRPK'           TO XL011-DB2-TABLE-NAME(1)  05570001
082100     END-EVALUATE                                                 05580001
082200                                                                          
082300     END-PERFORM.                                                         
082400                                                                          
082500     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        03322030
082600         SET XL011-SQL-ERROR      TO TRUE                         03324030
082700         MOVE 'TPOPRPK'           TO XL011-DB2-TABLE-NAME(1)      00    01
082800     END-IF.                                                      03325030
082900                                                                  05590001
083000******************************************************************05600001
083100 4105-GET-UPC.                                                    05610001
083200                                                                  05620001
083300     IF XL011-DEBUG-YES                                           05630001
083400         DISPLAY 'XLKUP011 - 4105-GET-UPC'                        05640001
083500         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
083600                             XL011-RETURN-CODE                            
083700     END-IF                                                       05650001
083800                                                                  05660001
083900     MOVE '4105-GET-UPC '      TO XL011-ERROR-PARAGRAPH.          05670001
084000     MOVE XL011-PACK-SKU-NBR   TO XLT00009-PK-SKU-NBR.            05680001
084100                                                                  05690001
084200     PERFORM                                                      03022030
084300         WITH TEST AFTER                                          03023030
084400         VARYING PV-RETRY-COUNTER                                 03024030
084500         FROM 1 BY 1                                              03025030
084600         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  03026030
084700            OR (SQLCODE = ZERO)                                   03027030
084800            OR (SQLCODE = +100)                                   03027030
084900            OR PS-ERROR                                                   
085000                                                                  03028030
085100     EXEC SQL                                                     05700001
085200         SELECT UPC_NBR                                           05710001
085300         INTO  :XLT00009-UPC-NBR :PS-NULL-IND                     05720001
085400         FROM  XLT_PK_UPC                                         05730001
085500         WHERE PK_SKU_NBR             = :XLT00009-PK-SKU-NBR      05740001
085600           AND EDI_ORD_IND            = 'Y'                       05750001
085700     END-EXEC                                                     05760001
085800                                                                  05770001
085900     MOVE SQLCODE                     TO XL011-SQLCODE            05780001
086000                                         PV-DISP-SQLCODE                  
086100                                                                          
086200     IF XL011-DEBUG-YES                                           04930001
086300         DISPLAY 'XLKUP011 - SQLCODE = ' PV-DISP-SQLCODE          04940001
086400             ' RETRY = ' PV-RETRY-COUNTER                                 
086500         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
086600                             XL011-RETURN-CODE                            
086700     END-IF                                                       04950001
086800                                                                  04960001
086900     EVALUATE TRUE                                                05790001
087000         WHEN SQLCODE = ZERO                                      05800001
087100             CONTINUE                                             05810001
087200         WHEN SQLCODE = +100                                      05820001
087300             MOVE ZEROES              TO  XLT00009-UPC-NBR        05830001
087400         WHEN SQLCODE = -911                                      03261030
087500         WHEN SQLCODE = -913                                      03262030
087600         WHEN SQLCODE = -904                                      03263030
087700             CONTINUE                                             03264030
087800         WHEN OTHER                                               05840001
087900             SET XL011-SQL-ERROR                                  05850001
088000                 PS-ERROR             TO TRUE                     05860001
088100             MOVE 'XLPKUPC'           TO XL011-DB2-TABLE-NAME(1)  05870001
088200     END-EVALUATE                                                 05880001
088300     END-PERFORM                                                          
088400                                                                          
088500                                                                  03321030
088600     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        03322030
088700         SET XL011-SQL-ERROR      TO TRUE                         03324030
088800         MOVE 'XLPKUPC'           TO XL011-DB2-TABLE-NAME(1)      03300001
088900     END-IF.                                                      03325030
089000                                                                  03326030
089100                                                                  05890001
089200******************************************************************05900001
089300 4200-CHANGE-ORD-HDR.                                             05910001
089400                                                                  05920001
089500     IF XL011-DEBUG-YES                                           05930001
089600         DISPLAY 'XLKUP011 - 4200-CHANGE-ORD-HDR'                 05940001
089700         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
089800                             XL011-RETURN-CODE                            
089900     END-IF                                                       05950001
090000                                                                  05960001
090100     MOVE '4200-CHANGE-ORD-HDR'   TO XL011-ERROR-PARAGRAPH.       05970001
090200     MOVE XL011-PHC-PK-SKU        TO POPRPK-PK-SKU-NBR.           05980001
090300                                                                  05990001
090400     PERFORM 3100-SUM-TPURITM.                                    06000011
090500                                                                  06010011
090600     PERFORM 4205-GET-INPK-UNT-QTY.                               06020001
090700                                                                  06021024
090800     IF XL011-PHC-DC-ORD-MULT-QTY = 1                             06022126
090900         MOVE 'M'                     TO POPRPK-PREPK-TYP-CDE     06023024
091000     ELSE                                                         06024024
091100         MOVE 'I'                     TO POPRPK-PREPK-TYP-CDE     06025024
091200     END-IF                                                       06026024
091300                                                                  06027024
091400*    IF PURCHS-PKGNG-CDE = 'M'                                    06030025
091500     IF POPRPK-PREPK-TYP-CDE = 'M'                                06031025
091600         MOVE 0                       TO POPRPK-OTPK-UNT-QTY      06040001
091700     ELSE                                                         06050001
091800         COMPUTE POPRPK-OTPK-UNT-QTY =                            06060010
091900                                    PURITM-PREPK-RATO-QTY *       06070010
092000                                    XL011-PHC-DC-ORD-MULT-QTY     06080001
092100                                                                  06090001
092200         ON SIZE ERROR                                            06100001
092300             MOVE ZERO TO POPRPK-OTPK-UNT-QTY                     06110010
092400         END-COMPUTE                                              06120001
092500     END-IF                                                       06130010
092600                                                                  06140010
092700     COMPUTE POPRPK-OTPK-ORD-QTY =                                06150010
092800                  (PV-UNT-QTY-TOT / POPRPK-INPK-UNT-QTY) /        06160010
092900                                  XL011-PHC-DC-ORD-MULT-QTY       06170010
093000     ON SIZE ERROR                                                06180010
093100        MOVE ZERO TO POPRPK-OTPK-ORD-QTY                          06190010
093200     END-COMPUTE                                                  06200010
093300                                                                  06210010
093400     IF XL011-DEBUG-YES                                           04930001
093500         DISPLAY 'XLKUP011 - POPRPK-PO-NBR ' POPRPK-PO-NBR        04940001
093600                  ' POPRPK-PK-SKU-NBR '  POPRPK-PK-SKU-NBR                
093700         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
093800                             XL011-RETURN-CODE                            
093900     END-IF                                                       04950001
094000                                                                  03810020
094100     PERFORM                                                      03022030
094200         WITH TEST AFTER                                          03023030
094300         VARYING PV-RETRY-COUNTER                                 03024030
094400         FROM 1 BY 1                                              03025030
094500         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  03026030
094600            OR (SQLCODE = ZERO)                                   03027030
094700            OR PS-ERROR                                                   
094800                                                                  03028030
094900     EXEC SQL                                                     06220001
095000         UPDATE TPOPRPK                                           06230001
095100           SET                                                    06240001
095200              PREPK_TYP_CDE  =   :POPRPK-PREPK-TYP-CDE            06241024
095300             ,OTPK_ORD_QTY   =   :POPRPK-OTPK-ORD-QTY             06250023
095400             ,PREPK_DESC     =   :XL011-PHC-PK-SKU-DESC           06260001
095500             ,OTPK_UNT_QTY   =   :POPRPK-OTPK-UNT-QTY             06270001
095600         WHERE PO_NBR      = :POPRPK-PO-NBR                       06280001
095700           AND PK_SKU_NBR  = :POPRPK-PK-SKU-NBR                   06290001
095800     END-EXEC                                                     06300001
095900                                                                  06310001
096000     MOVE SQLCODE          TO XL011-SQLCODE                       06320001
096100                              PV-DISP-SQLCODE                             
096200                                                                          
096300     IF XL011-DEBUG-YES                                           04930001
096400         DISPLAY 'XLKUP011 - SQLCODE = ' PV-DISP-SQLCODE          04940001
096500             ' RETRY = ' PV-RETRY-COUNTER                                 
096600         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
096700                             XL011-RETURN-CODE                            
096800     END-IF                                                       04950001
096900                                                                  04960001
097000     EVALUATE TRUE                                                06330001
097100         WHEN SQLCODE = ZERO                                      06340001
097200         WHEN SQLCODE = -803                                      06350001
097300             CONTINUE                                             06360001
097400         WHEN SQLCODE = -911                                      03261030
097500         WHEN SQLCODE = -913                                      03262030
097600         WHEN SQLCODE = -904                                      03263030
097700             CONTINUE                                             03264030
097800         WHEN OTHER                                               06370001
097900             SET XL011-SQL-ERROR                                  06380001
098000                 PS-ERROR             TO TRUE                     06390001
098100             MOVE 'TPOPRPK'           TO XL011-DB2-TABLE-NAME(1)  06400001
098200     END-EVALUATE                                                 06410001
098300     END-PERFORM                                                  06410001
098400                                                                  06420001
098500                                                                  03321030
098600     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        03322030
098700         SET XL011-SQL-ERROR      TO TRUE                         03324030
098800         MOVE 'TPOPRPK'           TO XL011-DB2-TABLE-NAME(1)      03300001
098900     END-IF.                                                      03325030
099000                                                                  03326030
099100******************************************************************06430001
099200 4205-GET-INPK-UNT-QTY.                                           06440001
099300                                                                  06450001
099400     IF XL011-DEBUG-YES                                           06460001
099500         DISPLAY 'XLKUP011 - 4205-GET-INPK-UNT-QTY'               06470001
099600         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
099700                             XL011-RETURN-CODE                            
099800     END-IF                                                       06480001
099900                                                                  06490001
100000     MOVE '4205-GET-INPK-UNT-QTY'   TO XL011-ERROR-PARAGRAPH.     06500001
100100     MOVE XL011-PHC-PK-SKU            TO POPRPK-PK-SKU-NBR.       06510001
100200     MOVE XL011-ORDER-NBR             TO POPRPK-PO-NBR.           06520001
100300                                                                  06530001
100400     IF XL011-DEBUG-YES                                           04930001
100500         DISPLAY 'XLKUP011 - POPRPK-PO-NBR ' POPRPK-PO-NBR        04940001
100600                  ' POPRPK-PK-SKU-NBR '  POPRPK-PK-SKU-NBR                
100700         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
100800                             XL011-RETURN-CODE                            
100900     END-IF                                                       04950001
101000                                                                  03810020
101100     PERFORM                                                      03022030
101200         WITH TEST AFTER                                          03023030
101300         VARYING PV-RETRY-COUNTER                                 03024030
101400         FROM 1 BY 1                                              03025030
101500         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  03026030
101600            OR (SQLCODE = ZERO)                                   03027030
101700            OR PS-ERROR                                                   
101800                                                                  03028030
101900     EXEC SQL                                                     06540001
102000         SELECT INPK_UNT_QTY                                      06550001
102100         INTO  :POPRPK-INPK-UNT-QTY :PS-NULL-IND                  06560001
102200         FROM  TPOPRPK                                            06570001
102300         WHERE PO_NBR             = :POPRPK-PO-NBR                06580001
102400           AND PK_SKU_NBR         = :POPRPK-PK-SKU-NBR            06590001
102500     END-EXEC                                                     06600001
102600                                                                  06610001
102700     MOVE SQLCODE          TO XL011-SQLCODE                       06320001
102800                              PV-DISP-SQLCODE                             
102900                                                                          
103000     IF XL011-DEBUG-YES                                           04930001
103100         DISPLAY 'XLKUP011 - SQLCODE = ' PV-DISP-SQLCODE          04940001
103200             ' RETRY = ' PV-RETRY-COUNTER                                 
103300         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
103400                             XL011-RETURN-CODE                            
103500     END-IF                                                       04950001
103600                                                                  04960001
103700                                                                          
103800     EVALUATE TRUE                                                06630001
103900         WHEN SQLCODE = ZERO                                      06640001
104000             CONTINUE                                             06650001
104100         WHEN SQLCODE = -911                                      03261030
104200         WHEN SQLCODE = -913                                      03262030
104300         WHEN SQLCODE = -904                                      03263030
104400             CONTINUE                                             03264030
104500         WHEN OTHER                                               06660001
104600             MOVE ZEROES           TO  POPRPK-INPK-UNT-QTY        06670001
104700             SET PS-ERROR          TO TRUE                                
104800     END-EVALUATE                                                 06680001
104900     END-PERFORM                                                          
105000                                                                  03321030
105100     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        03322030
105200         SET XL011-SQL-ERROR      TO TRUE                         03324030
105300         MOVE 'TPOPRPK'           TO XL011-DB2-TABLE-NAME(1)      03300001
105400     END-IF.                                                      03325030
105500                                                                  03326030
105600                                                                  06690001
105700******************************************************************06700001
105800 4300-DELETE-HDR.                                                 06710001
105900                                                                  06720001
106000     IF XL011-DEBUG-YES                                           06730001
106100         DISPLAY 'XLKUP011 - 4300-DELETE-HDR'                     06740001
106200         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
106300                             XL011-RETURN-CODE                            
106400     END-IF                                                       06750001
106500                                                                  06760001
106600     MOVE '4300-DELETE-HDR'   TO XL011-ERROR-PARAGRAPH.           06770001
106700     MOVE XL011-ORDER-NBR     TO POPRPK-PO-NBR.                   06780001
106800                                                                  06790001
106900     IF XL011-DEBUG-YES                                           04930001
107000         DISPLAY 'XLKUP011 - POPRPK-PO-NBR ' POPRPK-PO-NBR        04940001
107100         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
107200                             XL011-RETURN-CODE                            
107300     END-IF                                                       04950001
107400                                                                  03810020
107500     PERFORM                                                      03022030
107600         WITH TEST AFTER                                          03023030
107700         VARYING PV-RETRY-COUNTER                                 03024030
107800         FROM 1 BY 1                                              03025030
107900         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  03026030
108000            OR (SQLCODE = ZERO)                                   03027030
108100            OR (SQLCODE = +100)                                   03027030
108200            OR PS-ERROR                                                   
108300                                                                  03028030
108400     EXEC SQL                                                     06800001
108500         DELETE                                                   06810001
108600         FROM  TPOPRPK                                            06820001
108700         WHERE PO_NBR           = :POPRPK-PO-NBR                  06830001
108800     END-EXEC                                                     06840001
108900                                                                  06850001
109000     MOVE SQLCODE          TO XL011-SQLCODE                       06320001
109100                              PV-DISP-SQLCODE                             
109200                                                                          
109300     IF XL011-DEBUG-YES                                           04930001
109400         DISPLAY 'XLKUP011 - SQLCODE = ' PV-DISP-SQLCODE          04940001
109500             ' RETRY = ' PV-RETRY-COUNTER                                 
109600         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
109700                             XL011-RETURN-CODE                            
109800     END-IF                                                       04950001
109900                                                                  04960001
110000     EVALUATE TRUE                                                06870001
110100         WHEN SQLCODE = ZERO                                      06880001
110200         WHEN SQLCODE = +100                                      06890001
110300             CONTINUE                                             06900001
110400         WHEN SQLCODE = -911                                      03261030
110500         WHEN SQLCODE = -913                                      03262030
110600         WHEN SQLCODE = -904                                      03263030
110700             CONTINUE                                             03264030
110800         WHEN OTHER                                               06910001
110900             SET XL011-SQL-ERROR                                  06920001
111000                 PS-ERROR             TO TRUE                     06930001
111100             MOVE 'TPOPRPK'           TO XL011-DB2-TABLE-NAME(1)  06940001
111200     END-EVALUATE                                                 06950001
111300                                                                  06960001
111400     END-PERFORM                                                  06960001
111500                                                                  06960001
111600                                                                  03321030
111700     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        03322030
111800         SET XL011-SQL-ERROR      TO TRUE                         03324030
111900         MOVE 'TPOPRPK'           TO XL011-DB2-TABLE-NAME(1)      03300001
112000     END-IF.                                                      03325030
112100                                                                  03326030
112200******************************************************************06970001
112300 4400-DELETE-ORD-SKU.                                             06980001
112400                                                                  06990001
112500     IF XL011-DEBUG-YES                                           07000001
112600         DISPLAY 'XLKUP011 - 4400-DELETE-ORD-SKU'                 07010001
112700         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
112800                             XL011-RETURN-CODE                            
112900     END-IF                                                       07020001
113000                                                                  07030001
113100     MOVE '4400-DELETE-ORD-SKU'   TO XL011-ERROR-PARAGRAPH.       07040001
113200     MOVE XL011-ORDER-NBR         TO POPRPK-PO-NBR.               07050001
113300     MOVE XL011-SD-COMP-SKU-NBR   TO POPRPK-PK-SKU-NBR.           07060001
113400                                                                  07070001
113500     IF XL011-DEBUG-YES                                           04930001
113600         DISPLAY 'XLKUP011 - POPRPK-PO-NBR ' POPRPK-PO-NBR        04940001
113700                  ' POPRPK-PK-SKU-NBR '  POPRPK-PK-SKU-NBR                
113800         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
113900                             XL011-RETURN-CODE                            
114000     END-IF                                                       04950001
114100                                                                  03810020
114200     PERFORM                                                      03022030
114300         WITH TEST AFTER                                          03023030
114400         VARYING PV-RETRY-COUNTER                                 03024030
114500         FROM 1 BY 1                                              03025030
114600         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  03026030
114700            OR (SQLCODE = ZERO)                                   03027030
114800            OR (SQLCODE = +100)                                   03027030
114900            OR PS-ERROR                                                   
115000                                                                  03028030
115100     EXEC SQL                                                     07080001
115200         DELETE                                                   07090001
115300         FROM  TPOPRPK                                            07100001
115400         WHERE PO_NBR           = :POPRPK-PO-NBR                  07110001
115500           AND PK_SKU_NBR       = :POPRPK-PK-SKU-NBR              07120001
115600     END-EXEC                                                     07130001
115700                                                                  07140001
115800     MOVE SQLCODE          TO XL011-SQLCODE                       06320001
115900                              PV-DISP-SQLCODE                             
116000                                                                          
116100     IF XL011-DEBUG-YES                                           04930001
116200         DISPLAY 'XLKUP011 - SQLCODE = ' PV-DISP-SQLCODE          04940001
116300             ' RETRY = ' PV-RETRY-COUNTER                                 
116400         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
116500                             XL011-RETURN-CODE                            
116600     END-IF                                                       04950001
116700                                                                  04960001
116800     EVALUATE TRUE                                                07160001
116900         WHEN SQLCODE = ZERO                                      07170001
117000         WHEN SQLCODE = +100                                      07180001
117100             CONTINUE                                             07190001
117200         WHEN SQLCODE = -911                                      03261030
117300         WHEN SQLCODE = -913                                      03262030
117400         WHEN SQLCODE = -904                                      03263030
117500             CONTINUE                                             03264030
117600         WHEN OTHER                                               07200001
117700             SET XL011-SQL-ERROR                                  07210001
117800                 PS-ERROR             TO TRUE                     07220001
117900             MOVE 'TPOPRPK'           TO XL011-DB2-TABLE-NAME(1)  07230001
118000     END-EVALUATE                                                 07240001
118100                                                                          
118200     END-PERFORM                                                          
118300                                                                          
118400     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        03322030
118500         SET XL011-SQL-ERROR      TO TRUE                         03324030
118600         MOVE 'TPOPRPK'           TO XL011-DB2-TABLE-NAME(1)      03300001
118700     END-IF.                                                      03325030
118800                                                                  03326030
118900                                                                  07250001
119000******************************************************************07260001
119100 9999-WRAPUP.                                                     07270001
119200                                                                  07280001
119300     IF XL011-DEBUG-YES                                           07290001
119400         DISPLAY 'XLKUP011 - 9999-WRAPUP'                         07300001
119500         DISPLAY 'XLKUP011 - XL011-RETURN-CODE='                  00930001
119600                             XL011-RETURN-CODE                            
119700     END-IF                                                       07310001
119800                                                                  07320001
119900     MOVE SQLCA                       TO XL011-SQLCA.             07330001
120000                                                                  07340001
