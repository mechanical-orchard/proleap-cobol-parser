       IDENTIFICATION DIVISION.                                         00010000
       PROGRAM-ID. MAKUT205.                                            00020000
                                                                        00021039
      *  THE INPUT RECORDS TO THIS PROGRAM ARE EXTRACTED FROM TSKULOG.  00030039
      *  IN THE VSM SYSTEM, WHEN A RECORD IS CREATED ON TSKULOG IT      00031039
      *  IS ALSO CREATED/UPDATED ON TUPC AND TSKXREF.  THIS MEANS       00032039
      *  THAT THE SKU ADD/CHANGE/DELETE RECORD AND ITS CORRESPONDING    00033040
      *  TUPC/TSKXREF RECORD(S) ARE COMMITTED AS 1 UNIT OF WORK IN VSM. 00033140
P41269*----------------------------------------------------------       00035056
P41269* HISTORY LOG:                                                    00036056
P41269*----------------------------------------------------------       00037056
P41269* DATE:         04/26/2013                                        00038056
P41269* WR/IR#:       PRB0041267                                        00039056
P41269* PROGRAMMER:   COGNIZANT                                         00039156
P41269* DESCRIPTION:  INCLUDED RETRY LOGIC IN SELECT PARA               00039256
P41269*               B1300-SELECT-TUPC AND B1200-SELECT-TSKXREF        00039356
P41269*               'WITH UR' INCLUDED IN SELECT SQL TO HANDLE        00039456
P41269*               DEAD LOCK ISSUE.                                  00039556
P41269******************************************************************00039656
       ENVIRONMENT DIVISION.                                            00040000
       CONFIGURATION SECTION.                                           00050000
       SOURCE-COMPUTER. IBM-3090.                                       00060000
       OBJECT-COMPUTER. IBM-3090.                                       00070000
       INPUT-OUTPUT SECTION.                                            00080000
       FILE-CONTROL.                                                    00090000
                                                                        00100000
           SELECT DAILY-CHANGES-FILE                                    00110000
               ASSIGN                       TO INP01.                   00120000
           SELECT UPDATED-DAILY-CHANGES-FILE                            00130000
               ASSIGN                       TO OUT01.                   00140000
           SELECT INTR-UPC-ID-ERR-FILE                                  00150000
               ASSIGN                       TO OUT02.                   00160000
                                                                        00170000
       DATA DIVISION.                                                   00180000
       FILE SECTION.                                                    00190000
                                                                        00200000
       FD  DAILY-CHANGES-FILE                                           00210000
           RECORDING MODE F                                             00220000
           BLOCK CONTAINS 0 RECORDS                                     00230000
           RECORD CONTAINS 182 CHARACTERS                               00240021
           LABEL RECORDS ARE OMITTED                                    00250000
           DATA RECORD IS DAILY-CHANGES-RECORD.                         00260000
       01  DAILY-CHANGES-RECORD           PIC X(182).                   00270021
                                                                        00280000
       FD  UPDATED-DAILY-CHANGES-FILE                                   00290000
           RECORDING MODE F                                             00300000
           BLOCK CONTAINS 0 RECORDS                                     00310000
           RECORD CONTAINS 182 CHARACTERS                               00320021
           LABEL RECORDS ARE OMITTED                                    00330000
           DATA RECORD IS UPDATED-DAILY-CHANGES-RECORD.                 00340000
       01  UPDATED-DAILY-CHANGES-RECORD   PIC X(182).                   00350021
                                                                        00360000
       FD  INTR-UPC-ID-ERR-FILE                                         00370000
           RECORDING MODE F                                             00380000
           BLOCK CONTAINS 0 RECORDS                                     00390000
           RECORD CONTAINS 218 CHARACTERS                               00400021
           LABEL RECORDS ARE OMITTED                                    00410000
           DATA RECORD IS INTR-UPC-ID-ERR-REC.                          00420000
       01  INTR-UPC-ID-ERR-REC            PIC X(218).                   00430021
                                                                        00440000
       WORKING-STORAGE SECTION.                                         00450000
       01  PV-ABEND-CODE                  PIC S9(04)     VALUE +4001    00460003
                                                         COMP SYNC.     00470000
       01  PV-PROGRAM-VARIABLES.                                        00480000
                                                                        00490000
           05  PV-DAILY-CHANGES-READ-CT   PIC S9(9)      COMP-3         00500000
                                                         VALUE 0.       00510000
           05  PV-MISSING-INTR-UPC-ID-CT  PIC S9(9)      COMP-3         00520000
                                                         VALUE 0.       00530000
           05  PV-UPDATED-RCDS-WRITTEN-CT PIC S9(9)      COMP-3         00540000
                                                         VALUE 0.       00550000
           05  PV-UPC-NBR-REDEFINES-1     PIC 9(15).                    00580000
           05  PV-UPC-NBR-REDEFINES-2.                                  00590000
               10  PV-UPC-NBR-1-6         PIC 9(6).                     00600000
               10  PV-UPC-NBR-7-14        PIC 9(8).                     00610000
               10  PV-UPC-NBR-15          PIC 9(1).                     00620000
                                                                        00630000
P41269     05  PV-RETRY-COUNT          PIC S9(4)  COMP SYNC VALUE ZERO. 00631056
P41269     05  PC-MAX-RETRIES          PIC S9(3)  VALUE 3  COMP-3.      00632056
                                                                        00633045
       01  WS-INTR-UPC-ID-ERR-REC.                                      00640000
           05  WS-INTR-UPC-ID-ERR-RCD                                   00650000
                                          PIC X(182).                   00660021
           05  WS-INTR-UPC-ID-ERR-MSG     PIC X(36).                    00670000
                                                                        00680000
       01  PS-SWITCHES.                                                 00690000
           05 PS-INTR-UPC-ID-SWITCH       PIC X      VALUE 'Y'.         00700000
              88 PS-INTR-UPC-ID-FOUND                VALUE 'Y'.         00710000
              88 PS-INTR-UPC-ID-NOT-FOUND            VALUE 'N'.         00720000
           05 PS-DAILY-CHANGES-SWITCH     PIC X      VALUE 'N'.         00730000
              88 PS-DAILY-CHANGES-EOF                VALUE 'Y'.         00740000
              88 PS-DAILY-CHANGES-NOT-EOF            VALUE 'N'.         00750000
                                                                        00760000
           COPY DPWS004.                                                00770001
                                                                        00780001
           COPY FSRD500I.                                               00790001
                                                                        00800000
           EXEC SQL                                                     00810000
             INCLUDE TUPC                                               00820000
           END-EXEC.                                                    00830000
                                                                        00840000
           EXEC SQL                                                     00850000
             INCLUDE TSKXREF                                            00860000
           END-EXEC.                                                    00870000
                                                                        00880000
           EXEC SQL                                                     00890000
               INCLUDE SQLCA                                            00900000
           END-EXEC.                                                    00910000
                                                                        00920000
           COPY SQLCA2.                                                 00930018
                                                                        00940018
       PROCEDURE DIVISION.                                              00950000
       M0000-MAINLINE.                                                  00960000
                                                                        00970000
           PERFORM A1000-INITIALIZE                                     00980000
              THRU A1000-EXIT.                                          00990000
                                                                        01000000
           PERFORM B1000-PROCESS-DAILY-CHANGES                          01010001
              THRU B1000-EXIT                                           01020024
             UNTIL PS-DAILY-CHANGES-EOF.                                01030024
                                                                        01040000
           PERFORM C1000-EOJ-PROCESSING                                 01050000
              THRU C1000-EXIT.                                          01060000
                                                                        01070000
           GOBACK.                                                      01080006
                                                                        01090006
                                                                        01100006
       A1000-INITIALIZE.                                                01110001
                                                                        01120000
           OPEN INPUT DAILY-CHANGES-FILE                                01130000
               OUTPUT UPDATED-DAILY-CHANGES-FILE                        01140000
                      INTR-UPC-ID-ERR-FILE.                             01150000
                                                                        01160000
       A1000-EXIT.                                                      01170000
           EXIT.                                                        01180000
                                                                        01190000
                                                                        01200000
       B1000-PROCESS-DAILY-CHANGES.                                     01210001
                                                                        01220000
           PERFORM B1100-READ-DAILY-CHANGES-FILE                        01230000
              THRU B1100-EXIT.                                          01240000
           IF PS-DAILY-CHANGES-EOF                                      01250024
               GO TO B1000-EXIT                                         01260026
           END-IF.                                                      01270026
                                                                        01271036
      *  WHEN A SKU DELETION IS PROCESSED IN THE VSM SYSTEM, THE        01280036
      *  SKU IS ALSO DELETED ON TSKXREF.  SO RECORDS WITH A             01281036
      *  FUNCTION CODE = 'D' CANNOT BE LOOKED UP ON TSKXREF.            01282036
      *                                                                 01282139
      *  IF A USER DOES A SKU ADD AND A SKU DELETE; AND BOTH RCDS       01282239
      *  ARE SELECTED FROM TSKULOG WITHIN THE SAME BATCH RUN,           01282339
      *  THE SKU ADD RECORD WILL HAVE A "NOT FOUND" ON ITS TSKXREF      01282439
      *  LOOKUP AND IT WILL BE WRITTEN TO THE ERROR FILE.  THIS         01282539
      *  IS OK.  THE DELETE RECORDS WILL PASS THROUGH MAKUT102          01282639
      *  W/O A PROBLEM.  THE ADD RECORDS WRITTEN TO THE ERROR           01282739
      *  FILE DO NOT NEED TO BE PROCESSED ANY FURTHER.                  01282839
                                                                        01283036
           IF FS500I-FUNCTION-CODE = 'A'                                01290024
             OR FS500I-FUNCTION-CODE = 'C'                              01300024
               SET PS-INTR-UPC-ID-NOT-FOUND TO TRUE                     01310028
               INITIALIZE DCLTSKXREF                                    01320027
               MOVE FS500I-INTR-UPC-ID2     TO SKXREF-INTR-UPC-ID       01330028
               PERFORM B1200-SELECT-TSKXREF                             01340024
                  THRU B1200-EXIT                                       01350024
               IF PS-INTR-UPC-ID-FOUND                                  01360024
                   MOVE SKXREF-DEPT     TO FS500I-TSKXREF-DEPT          01370041
                   MOVE SKXREF-CLASS    TO FS500I-TSKXREF-CLASS         01380041
                   MOVE SKXREF-SUBCLASS TO FS500I-TSKXREF-SUBCLASS      01390041
                   MOVE SKXREF-ITM-NBR  TO FS500I-TSKXREF-ITM-NBR       01391042
               ELSE                                                     01400024
                   MOVE SPACES TO WS-INTR-UPC-ID-ERR-MSG                01410024
                   MOVE 'INTR-UPC-ID NOT FOUND ON TSKXREF'              01420024
                               TO WS-INTR-UPC-ID-ERR-MSG                01430024
                   MOVE FS500I-MAINTENANCE-LOG-RECORD                   01440024
                               TO WS-INTR-UPC-ID-ERR-RCD                01450024
                   PERFORM B1400-WRITE-ERROR-RCD                        01460024
                      THRU B1400-EXIT                                   01470024
                   GO TO B1000-EXIT                                     01480024
               END-IF                                                   01490024
           END-IF.                                                      01500024
                                                                        01510027
      *  THE TUPC LOOKUP IS DONE TO RETRIEVE THE NI SKU. THE OUTPUT     01511041
      *  RECORDS FROM THIS PROGRAM WILL BE SORTED BY NI SKU PRIOR       01512041
      *  TO MAKUT102.                                                   01513041
                                                                        01514036
           SET PS-INTR-UPC-ID-NOT-FOUND TO TRUE.                        01520028
           INITIALIZE DCLTUPC.                                          01530027
           MOVE FS500I-INTR-UPC-ID2     TO UPC-INTR-UPC-ID.             01540024
           PERFORM B1300-SELECT-TUPC                                    01550024
              THRU B1300-EXIT.                                          01560024
                                                                        01570024
           IF PS-INTR-UPC-ID-FOUND                                      01580024
               MOVE UPC-UPC-NBR TO PV-UPC-NBR-REDEFINES-1               01590024
               MOVE PV-UPC-NBR-REDEFINES-1                              01600024
                                TO PV-UPC-NBR-REDEFINES-2               01610024
               MOVE PV-UPC-NBR-7-14 TO FS500I-NI-SKU                    01620024
           ELSE                                                         01630024
               MOVE SPACES TO WS-INTR-UPC-ID-ERR-MSG                    01640024
               MOVE 'INTR-UPC-ID NOT FOUND ON TUPC'                     01650024
                           TO WS-INTR-UPC-ID-ERR-MSG                    01660024
               MOVE FS500I-MAINTENANCE-LOG-RECORD                       01670024
                           TO WS-INTR-UPC-ID-ERR-RCD                    01680024
               PERFORM B1400-WRITE-ERROR-RCD                            01690024
                  THRU B1400-EXIT                                       01700024
               GO TO B1000-EXIT                                         01710024
           END-IF.                                                      01720024
                                                                        01730000
           PERFORM B1500-WRITE-DAILY-CHANGES-RCD                        01740024
              THRU B1500-EXIT.                                          01750024
                                                                        01760000
       B1000-EXIT.                                                      01770000
           EXIT.                                                        01780000
                                                                        01790000
                                                                        01800000
       B1100-READ-DAILY-CHANGES-FILE.                                   01810000
                                                                        01820000
           READ DAILY-CHANGES-FILE                                      01830000
               INTO FS500I-MAINTENANCE-LOG-RECORD                       01840000
                   AT END                                               01850000
                       SET PS-DAILY-CHANGES-EOF TO TRUE                 01860005
                       GO TO B1100-EXIT.                                01870005
                                                                        01880000
           ADD 1 TO PV-DAILY-CHANGES-READ-CT.                           01890000
                                                                        01900000
       B1100-EXIT.                                                      01910000
           EXIT.                                                        01920000
                                                                        01930000
                                                                        01940039
       B1200-SELECT-TSKXREF.                                            01950000
                                                                        01950150
P41269     INITIALIZE PV-RETRY-COUNT.                                   01951056
P41269     PERFORM  WITH TEST AFTER                                     01952056
P41269       UNTIL SQLCODE = ZERO                                       01953056
P41269          OR SQLCODE = +100                                       01954056
P41269          OR PV-RETRY-COUNT > PC-MAX-RETRIES                      01955056
                                                                        01960000
           EXEC SQL                                                     01970000
               SELECT ITM_NBR,                                          01980044
                      DEPT,                                             01981044
                      CLASS,                                            01990043
                      SUBCLASS                                          02000044
                 INTO :SKXREF-ITM-NBR,                                  02010044
                      :SKXREF-DEPT,                                     02011044
                      :SKXREF-CLASS,                                    02020043
                      :SKXREF-SUBCLASS                                  02030043
                 FROM TSKXREF                                           02040000
                WHERE INTR_UPC_ID = :SKXREF-INTR-UPC-ID                 02050021
                  AND SKU_STAT_CDE NOT IN ('00','98')                   02060038
P41269        WITH UR                                                   02070056
P41269     END-EXEC                                                     02080056
                                                                        02081050
           EVALUATE TRUE                                                02090000
               WHEN SQLCODE = ZEROS                                     02100000
                   SET PS-INTR-UPC-ID-FOUND TO TRUE                     02110014
               WHEN SQLCODE = +100                                      02120000
                   CONTINUE                                             02130014
P41269         WHEN SQLCODE = -911                                      02131056
P41269             ADD +1  TO PV-RETRY-COUNT                            02132056
               WHEN OTHER                                               02140000
                   DISPLAY 'B1200-SELECT-TSKXREF'                       02150000
                   DISPLAY 'FS500I-INTR-UPC-ID = ' FS500I-INTR-UPC-ID1  02160023
                   PERFORM U9999-SQL-ERROR                              02170000
P41269     END-EVALUATE                                                 02180056
P41269     END-PERFORM.                                                 02181056
                                                                        02182050
P41269     IF PV-RETRY-COUNT > PC-MAX-RETRIES                           02183056
P41269         DISPLAY 'B1200-SELECT-TSKXREF'                           02184056
P41269         DISPLAY 'MAX RETRIES EXCEEDED ON TSKXREF SELECT'         02185056
P41269         PERFORM U9999-SQL-ERROR                                  02186056
P41269     END-IF.                                                      02187056
                                                                        02188050
                                                                        02190000
       B1200-EXIT.                                                      02200000
           EXIT.                                                        02210000
                                                                        02220000
                                                                        02230000
       B1300-SELECT-TUPC.                                               02240000
                                                                        02241036
      *  WHEN SKUS ARE DELETED, THE TUPC RECORD'S EFF END DTE           02251036
      *  IS UPDATED WITH THE CURRENT PROCESS DATE.  FOR SKU             02251136
      *  ADDS AND CHANGES, THE TUPC EFF END DTE WILL BE NULL.           02251236
      *  SO TO RETRIEVE THE MOST RECENT RECORD, SELECT THE              02251336
      *  RECORD WITH THE LATEST DATE.                                   02251436
                                                                        02252036
P41269     INITIALIZE PV-RETRY-COUNT.                                   02253056
P41269     PERFORM  WITH TEST AFTER                                     02254056
P41269       UNTIL SQLCODE = ZERO                                       02255056
P41269          OR SQLCODE = +100                                       02256056
P41269          OR PV-RETRY-COUNT > PC-MAX-RETRIES                      02257056
                                                                        02258045
           EXEC SQL                                                     02260000
             SELECT MAX(EFF_BEG_DTE),                                   02270030
                    UPC_NBR                                             02280030
               INTO :UPC-EFF-BEG-DTE,                                   02290031
                    :UPC-UPC-NBR                                        02300030
               FROM TUPC                                                02310000
              WHERE INTR_UPC_ID = :UPC-INTR-UPC-ID                      02320021
                AND UPC_TYP_CDE = 'I'                                   02330000
           GROUP BY EFF_BEG_DTE,                                        02340033
                    UPC_NBR                                             02350033
P41269        WITH UR                                                   02351056
P41269     END-EXEC                                                     02360056
                                                                        02370000
           EVALUATE TRUE                                                02380000
               WHEN SQLCODE = ZEROS                                     02390000
                   SET PS-INTR-UPC-ID-FOUND TO TRUE                     02400014
               WHEN SQLCODE = +100                                      02410034
                   CONTINUE                                             02420014
P41269         WHEN SQLCODE = -911                                      02421056
P41269             ADD +1  TO PV-RETRY-COUNT                            02422056
               WHEN OTHER                                               02430000
P41269             DISPLAY 'B1300-SELECT-TUPC'                          02440056
                   DISPLAY 'FS500I-INTR-UPC-ID = ' FS500I-INTR-UPC-ID1  02450023
                   PERFORM U9999-SQL-ERROR                              02460000
P41269     END-EVALUATE                                                 02470056
P41269     END-PERFORM.                                                 02480056
                                                                        02480145
P41269     IF PV-RETRY-COUNT > PC-MAX-RETRIES                           02481056
P41269         DISPLAY 'B1300-SELECT-TUPC'                              02481156
P41269         DISPLAY 'MAX RETRIES EXCEEDED ON TUPC SELECT'            02482056
P41269         PERFORM U9999-SQL-ERROR                                  02484056
P41269     END-IF.                                                      02485056
                                                                        02486045
       B1300-EXIT.                                                      02490000
           EXIT.                                                        02500000
                                                                        02510000
                                                                        02520000
       B1400-WRITE-ERROR-RCD.                                           02530000
                                                                        02540000
           WRITE INTR-UPC-ID-ERR-REC FROM WS-INTR-UPC-ID-ERR-REC.       02550000
           ADD 1 TO PV-MISSING-INTR-UPC-ID-CT.                          02560000
                                                                        02570000
       B1400-EXIT.                                                      02580000
           EXIT.                                                        02590000
                                                                        02600000
                                                                        02610000
       B1500-WRITE-DAILY-CHANGES-RCD.                                   02620000
                                                                        02630000
           WRITE UPDATED-DAILY-CHANGES-RECORD                           02640000
                       FROM FS500I-MAINTENANCE-LOG-RECORD.              02650000
           ADD 1 TO PV-UPDATED-RCDS-WRITTEN-CT.                         02660000
                                                                        02670000
       B1500-EXIT.                                                      02680000
           EXIT.                                                        02690000
                                                                        02700000
                                                                        02710000
       C1000-EOJ-PROCESSING.                                            02720000
                                                                        02730000
           CLOSE DAILY-CHANGES-FILE                                     02740000
                 UPDATED-DAILY-CHANGES-FILE                             02750000
                 INTR-UPC-ID-ERR-FILE.                                  02760000
                                                                        02770000
           DISPLAY '*******************************************'.       02780000
           DISPLAY '   MAKUT205 - TSKXREF/TUPC LOOKUP          '.       02781039
           DISPLAY 'RCDS READ:          ' PV-DAILY-CHANGES-READ-CT.     02790000
           DISPLAY 'RCDS WRITTEN:       ' PV-UPDATED-RCDS-WRITTEN-CT.   02800001
           DISPLAY 'ERROR RCDS WRITTEN: ' PV-MISSING-INTR-UPC-ID-CT.    02810015
           DISPLAY '*******************************************'.       02820000
                                                                        02830000
           IF PV-MISSING-INTR-UPC-ID-CT > 0                             02840000
               MOVE 4095 TO RETURN-CODE                                 02850000
           ELSE                                                         02860000
               MOVE 0    TO RETURN-CODE                                 02870000
           END-IF.                                                      02880000
                                                                        02890000
       C1000-EXIT.                                                      02900000
           EXIT.                                                        02910000
                                                                        02920000
                                                                        02930000
       U9999-SQL-ERROR.                                                 02940000
           COPY DPPD004.                                                02950000
                                                                        02960000
           CALL 'DSNTIAR' USING SQLCA                                   02970003
                               DP004-FORMATTED-MESSAGE                  02980000
                               DP004-ERROR-LINE-LENGTH.                 02990000
                                                                        03000000
           DISPLAY '*******************************************'.       03010000
           PERFORM VARYING DP004-MSG-IDX                                03020000
              FROM 1 BY 1                                               03030000
             UNTIL DP004-MSG-IDX > DP004-MAX-MESSAGE-LINES              03040000
                 DISPLAY '**'                                           03050000
                         DP004-MESSAGE-LINE (DP004-MSG-IDX)             03060000
                 DISPLAY '**'                                           03070000
           END-PERFORM.                                                 03080000
           DISPLAY '*******************************************'.       03090000
                                                                        03100000
           CALL 'ILBOABN0' USING PV-ABEND-CODE.                         03110004
