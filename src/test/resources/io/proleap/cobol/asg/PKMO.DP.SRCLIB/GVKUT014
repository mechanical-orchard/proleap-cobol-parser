000100 IDENTIFICATION DIVISION.                                         00010049
000200 PROGRAM-ID.         GVKUT014.                                    00020099
000300 AUTHOR.             JIM ARENDT.                                  00030099
000400 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00040049
000500 DATE-WRITTEN.       MARCH 2018.                                  00050099
000600                                                                  00060049
003300******************************************************************00070099
000800* I M P O R T A N T --- WHEN COMPILING THIS PROGRAM THE MQ SERIES 00080049
000900* SWITCH ON THE 2ND COMPILE SCREEN NEEDS TO BE SET TO 'Y'.        00090049
001000* THIS PROGRAM USES MQSERIES.                                     00100049
003300******************************************************************00110099
001300*                                                                 00120050
001400* THIS PROGRAM WILL GET MESSAGES FROM GV UPLOAD QUEUE             00130099
001500* (GV.OB.FS.ADJ.BOSS.Q) FORMAT THE DATA INTO A SEQUENTIAL FILE    00140099
      * MATCHING THE GVRD002 COPYBOOK FOR FURTHER PROCESSING.           00150099
001700*                                                                 00160050
003300******************************************************************00170099
001900 ENVIRONMENT DIVISION.                                            00180050
003300******************************************************************00190099
002100 CONFIGURATION SECTION.                                           00200050
002200 SOURCE-COMPUTER.        IBM-3090.                                00210050
002300 OBJECT-COMPUTER.        IBM-3090.                                00220050
002400 INPUT-OUTPUT SECTION.                                            00230050
002500                                                                  00240050
002600 FILE-CONTROL.                                                    00250050
                                                                        00260099
           SELECT OUTPUT-FILE                                           00270099
                  ASSIGN TO OUT01.                                      00280099
002700                                                                  00290099
003300******************************************************************00300099
002800 DATA DIVISION.                                                   00310050
003300******************************************************************00320099
003000 FILE SECTION.                                                    00330050
                                                                        00340099
       FD  OUTPUT-FILE                                                  00350099
           RECORDING MODE IS F                                          00360099
           LABEL RECORDS ARE STANDARD                                   00370099
           BLOCK CONTAINS 0 RECORDS.                                    00380099
       01  OUTPUT-RECORD                 PIC  X(130).                   00390099
003100                                                                  00400050
003200 WORKING-STORAGE SECTION.                                         00410050
003300******************************************************************00420050
003700*    PROGRAM CONSTANTS                                            00430050
003800******************************************************************00440050
003900 01  PC-PROGRAM-CONSTANTS.                                        00450050
004000     05  PC-CURRENT-PROGRAM-NAME   PIC  X(08) VALUE 'GVKUT014'.   00460099
004600                                                                  00470099
004700******************************************************************00480049
004800*    PROGRAM VARIABLES                                            00490049
004900******************************************************************00500049
005000 01  PV-PROGRAM-VARIABLES.                                        00510049
005300     05  PV-CURRENT-ELEMENT        PIC  X(30)  VALUE SPACES.      00520099
005400     05  PV-CURRENT-ATTRIBUTE      PIC  X(30)  VALUE SPACES.      00530099
005500     05  PV-PARAGRAPH              PIC  X(30)  VALUE SPACE.       00540099
005600     05  PV-SQLCODE                PIC  -999.                     00550099
005700     05  PV-ERR-CDE                PIC  X(03).                    00560099
005800     05  PV-DISP-OPER              PIC  X(04).                    00570099
005900     05  PV-DISP-SQLCODE           PIC  -999.                     00580099
006000     05  PV-DISPLAY-NBR            PIC  ZZZ,ZZZ,ZZ9.              00590099
006100     05  PV-DISPLAY-NBR2           PIC  Z,ZZ9.                    00600099
006300     05  PV-QUEUE-MANAGER          PIC  X(20).                    00610099
006400     05  PV-SERVER-NAME            PIC  X(20).                    00620099
           05  PV-HOLD-COMPLETION-CODE   PIC S9(09)  BINARY.            00630099
           05  PV-HOLD-REASON            PIC S9(09)  BINARY.            00640099
           05  PV-STR-NBR                PIC  X(05)  JUST RIGHT.        00650099
010000     05  PV-STR-NBR-REDEF REDEFINES PV-STR-NBR.                   00660099
010020         10  PV-STR-NBR-9          PIC  9(05).                    00670099
006500     05  PV-CRA-RET-MSG            PIC  X(25).                    00680099
006600     05  PV-CRA-RET-CDE            PIC  X(02)  VALUE '00'.        00690099
006700         88 PV-SUCCESSFUL                      VALUE '00'.        00700099
006800         88 PV-ERROR                           VALUE '01'.        00710099
006900         88 PV-SQL-ERROR                       VALUE '02'.        00720099
007000         88 PV-INVALID-DATA                    VALUE '03'.        00730099
007010         88 PV-UNKNOWN-USER                    VALUE '04'.        00740099
007020                                                                  00750096
007139     05  PV-QTY                    PIC  X(05) JUST RIGHT.         00760099
007200     05  PV-QTY-NUM    REDEFINES   PV-QTY PIC 9(05).              00770099
007600                                                                  00780049
007740******************************************************************00790049
007800*    PROGRAM ACCUMULATORS                                         00800049
007900******************************************************************00810049
008000 01  PA-PROGRAM-ACCUMULATORS.                                     00820049
008312     05  PA-CAPTURE-COUNT          PIC  9(09)  VALUE ZERO.        00830099
008600     05  PA-TOTAL-OUTPUT-RECS      PIC  9(09)  VALUE ZERO.        00840099
008100     05  PA-MQ-MSGS-READ           PIC S9(09)  VALUE +0 COMP-3.   00850099
008100     05  PA-MQ-MSGS-WRITTEN        PIC S9(09)  VALUE +0 COMP-3.   00851099
008100     05  PA-MQ-MSGS-ERROR          PIC S9(09)  VALUE +0 COMP-3.   00852099
008400     05  PA-MQ-COMMITS             PIC S9(09)  VALUE +0 COMP-3.   00860099
008500     05  PA-XML-PARSED             PIC S9(09)  VALUE +0 COMP-3.   00870099
008600     05  PA-END-RUN-MSG-CNT        pIC S9(09)  VALUE +0 COMP-3.   00880099
004600                                                                  00890099
       01  PS-PROGRAM-SWITCHES.                                         00890199
           05  PS-WRITE-2ND-QUEUE         PIC X(01) VALUE 'N'.          00891099
               88  PS-WRITE-2ND-QUE-YES             VALUE 'Y'.          00892099
               88  PS-WRITE-2ND-QUE-NO              VALUE 'N'.          00893099
004600                                                                  00894099
008700******************************************************************00900049
008800*    PROGRAM VARIABLES FOR QUEUE MANAGER AND QUEUE NAMES.         00910049
008900******************************************************************00920049
009000 01  PV-Q-MANAGER-VARIABLES.                                      00930049
009100     05  PV-QMGR-NAME              PIC  X(48).                    00940099
009100     05  PV-QMGR2-LCL-NAME         PIC  X(48).                    00941099
009100     05  PV-QMGR2-RMT-NAME         PIC  X(48).                    00942099
009200     05  PV-QUE-NAME               PIC  X(48).                    00950099
009200     05  PV-QUE2-NAME              PIC  X(48).                    00951099
009300     05  PV-HANDLE                 PIC S9(09)  BINARY VALUE 0.    00960099
009300     05  PV-PUT-HANDLE             PIC S9(09)  BINARY VALUE 0.    00961099
009400     05  PV-QMGR-NAME-ERROR        PIC  X(48).                    00970099
009500     05  PV-QUE-NAME-ERROR         PIC  X(48).                    00980099
009600*    05  PV-HANDLE-ERROR           PIC S9(09)  BINARY VALUE 0.    00990099
009700     05  PV-HCONN                  PIC S9(09)  BINARY VALUE 0.    01000099
009800     05  PV-OPEN-OPTIONS           PIC S9(09)  BINARY.            01010099
009900     05  PV-COMPLETION-CODE        PIC S9(09)  BINARY.            01020099
010000     05  PV-REASON                 PIC S9(09)  BINARY.            01030099
010100     05  PV-ERROR-MESSAGE          PIC  X(48)  VALUE SPACES.      01040099
010200     05  PV-CON-REASON             PIC S9(09)  BINARY.            01050099
010300     05  PV-MSGBUFFER              PIC  X(250000) VALUE SPACES.   01060099
010400     05  PV-ERRMSGBUFFER           PIC  X(630) VALUE SPACES.      01070099
010500     05  PV-MSG-LENGTH             PIC S9(09)  BINARY VALUE 32400.01080099
010600     05  PV-DATA-LENGTH            PIC S9(09)  BINARY.            01090099
010700     05  PV-ACTION                 PIC  X(60)  VALUE SPACES.      01100099
010800     05  PV-MQCHECK                PIC  X(08)  VALUE 'MQR2C'.     01110099
010900     05  PV-MQ-REASON-TEXT         PIC  X(30)  VALUE SPACES.      01120099
011000     05  PV-DISPLAY-CDE            PIC  -Z(8)9.                   01130099
011100     05  PV-REASON-CDE             PIC  -Z(8)9.                   01140099
011200                                                                  01150049
011300*PV-MSG IS THE INPUT MESSAGE                                      01160049
011400 01  PV-MSG                        PIC  X(250000) VALUE SPACES.   01170099
011500 01  XML-LENGTH                    PIC  9(07)    VALUE ZEROS.     01180099
011600                                                                  01190049
011700 01  PC-MQCONN                     PIC  X(08)  VALUE 'CSQBCONN'.  01200099
011800 01  PC-MQOPEN                     PIC  X(08)  VALUE 'CSQBOPEN'.  01210099
011900 01  PC-MQINQ                      PIC  X(08)  VALUE 'CSQBINQ'.   01220099
012000 01  PC-MQGET                      PIC  X(08)  VALUE 'CSQBGET'.   01230099
012100 01  PC-MQPUT                      PIC  X(08)  VALUE 'CSQBPUT'.   01240099
012200 01  PC-MQCMIT                     PIC  X(08)  VALUE 'CSQBCOMM'.  01250099
012300 01  PC-MQCLOSE                    PIC  X(08)  VALUE 'CSQBCLOS'.  01260099
012400 01  PC-MQDISC                     PIC  X(08)  VALUE 'CSQBDISC'.  01270099
012500 01  PC-MQBACK                     PIC  X(08)  VALUE 'CSQBBACK'.  01280099
012600                                                                  01290049
012700* API CONTROL BLOCKS                                              01300049
012800 01  MQM-OBJECT-DESCRIPTOR.                                       01310049
012900     COPY CMQODV.                                                 01320049
013000 01  MQM-MESSAGE-DESCRIPTOR.                                      01330049
013100     COPY CMQMDV.                                                 01340049
013200 01  MQM-PUT-MESSAGE-OPTIONS.                                     01350049
013300     COPY CMQPMOV.                                                01360049
013400 01  MQM-GET-MESSAGE-OPTIONS.                                     01370049
013500     COPY CMQGMOV.                                                01380049
013600                                                                  01390049
013700* MQV CONTAINS CONSTANTS (FOR FILLING IN THE CONTROL BLOCKS)      01400049
013800* AND RETURN CODES (FOR TESTING THE RESULT OF A CALL)             01410049
013900 01  MQM-CONSTANTS.                                               01420049
014000     COPY CMQV.                                                   01430049
014100                                                                  01440049
       01  PV-ABEND-VARIABLES.                                          01450099
           05  PV-ABEND-CODE             PIC S9(04)  VALUE +0 COMP SYNC.01460099
           88  ABEND-4001-WRITE-ERROR                VALUE +4001.       01470099
           88  ABEND-4002-READ-ERROR                 VALUE +4002.       01480099
           88  ABEND-4003-CTRL-CARD-ERROR            VALUE +4003.       01490099
           88  ABEND-4004-TABLE-ERROR                VALUE +4004.       01500099
           88  ABEND-4005-OPEN-ERROR                 VALUE +4005.       01510099
           88  ABEND-4006-CLOSE-ERROR                VALUE +4006.       01520099
           88  ABEND-4007-SEQUENCE-ERROR             VALUE +4007.       01530099
           88  ABEND-4008-DATA-ERROR                 VALUE +4008.       01540099
           88  ABEND-4009-KEY-DATA-ERROR             VALUE +4009.       01550099
           88  ABEND-4013-DB2-ERROR                  VALUE +4013.       01560099
           88  ABEND-4019-CAL-SUB-ERROR              VALUE +4019.       01570099
           88  ABEND-4020-MQ-ERROR                   VALUE +4020.       01580099
           88  ABEND-4444-FORCED-ABEND               VALUE +4444.       01590099
                                                                        01600099
       01  PE-MQ-ABEND-VARIABLES.                                       01610099
           10  PE-MQ-QMANAGER            PIC  X(05)  VALUE SPACES.      01620099
           10  PE-MQ-QNAME               PIC  X(30)  VALUE SPACES.      01630099
           10  PE-MQ-COMPLETION-CODE     PIC  9(04)  VALUE ZEROS.       01640099
           10  PE-MQ-REASON-CODE         PIC  9(04)  VALUE ZEROS.       01650099
                                                                        01660099
003300******************************************************************01670099
015700* MQ SERIES COMPLETION CODES.                                     01680049
003300******************************************************************01690099
015900     COPY ISWS002.                                                01700049
016000                                                                  01710049
003300******************************************************************01720099
UC5700* OUTPUT RECORD LAYOUT                                            01730099
003300******************************************************************01740099
015900     COPY GVRD002.                                                01750099
016000                                                                  01760099
003300******************************************************************01770099
016200* XML CODE DESCRIPTIONS, AND DISPLAYING FORMATTED XML MESSAGES    01780049
003300******************************************************************01790099
016400     COPY ISWS007.                                                01800049
016500     COPY ISWS008.                                                01810049
016600     COPY ISWS009.                                                01820049
016700                                                                  01830049
018400******************************************************************01840049
018500* COMMUNICATIONS AREA FOR DB2                                     01850049
018600******************************************************************01860049
018700     EXEC SQL                                                     01870049
018800          INCLUDE SQLCA                                           01880049
018900     END-EXEC.                                                    01890049
019000                                                                  01900049
019100******************************************************************01910049
019200*  DB2 VIEW DECLARATION - CONSUMER QUEUE VIEW (GET/READ)          01920049
019300*        (WSV_CNSMR_QUE) WSV00006                                 01930049
019400******************************************************************01940049
019500     EXEC SQL                                                     01950049
019600         INCLUDE WSV00006                                         01960049
019700     END-EXEC.                                                    01970049
019800                                                                  01980049
019100******************************************************************01980199
019200*  DB2 VIEW DECLARATION - PROVIDER QUEUE VIEW (PUT)               01980299
019300*        (WSV_PRVDR_QUE) WSV00005                                 01980399
019400******************************************************************01980499
019500     EXEC SQL                                                     01980599
019600         INCLUDE WSV00005                                         01980699
019700     END-EXEC.                                                    01980799
019800                                                                  01980899
019100******************************************************************01981099
019300*        PARAMETER TABLE                                          01983099
019400******************************************************************01984099
019500     EXEC SQL                                                     01985099
019600         INCLUDE TKRPRPM                                          01986099
019700     END-EXEC.                                                    01987099
019800                                                                  01988099
003300******************************************************************01990099
022900 PROCEDURE DIVISION.                                              02000099
003300******************************************************************02010099
023100*                                                                 02020049
023200******************************************************************02030049
023300*    MAIN PROCESSING.                                             02040049
023400******************************************************************02050049
023500 0000-MAIN-MODULE.                                                02060049
023600                                                                  02070049
023700     INITIALIZE  PV-PROGRAM-VARIABLES.                            02080099
023900                                                                  02090074
024000     MOVE '0000-MAIN-MODULE'           TO PV-PARAGRAPH.           02100049
024600                                                                  02110049
024700     PERFORM 1000-INITIALIZATION.                                 02120049
024800     PERFORM 1200-MQSERIES-CONNECT.                               02130049
024900     PERFORM 1300-MQSERIES-OPEN.                                  02140099
           IF PS-WRITE-2ND-QUE-YES                                      02141099
               PERFORM 1350-MQSERIES-OPEN-2                             02142099
           END-IF.                                                      02143099
025010                                                                  02150099
025000     PERFORM 1400-GET-MQ-MESSAGE.                                 02160049
025010                                                                  02170084
025100     PERFORM 2000-PROCESS-XML                                     02180049
025300        UNTIL PV-REASON = MQRC-NO-MSG-AVAILABLE.                  02190099
025700                                                                  02200099
025500     PERFORM 9300-EOJ.                                            02210049
025700                                                                  02220099
025600     GOBACK.                                                      02230049
025700                                                                  02240049
003300******************************************************************02250099
025900* INITIALIZATION                                                  02260049
026000*     GETS MQ QUEUE & QUEUE MANAGER INFORMATION                   02270049
003300******************************************************************02280099
026200 1000-INITIALIZATION.                                             02290049
026300                                                                  02300049
026400     MOVE '1000-INITIALIZATION'        TO PV-PARAGRAPH.           02310049
026500                                                                  02320049
024300     DISPLAY ' '.                                                 02330099
024300     DISPLAY '**********************************'.                02340099
024400     DISPLAY '* START OF GVKUT014               '.                02350099
024500     DISPLAY '**********************************'.                02360099
026700                                                                  02370049
010500     INITIALIZE PV-MSG-LENGTH.                                    02380099
026800     PERFORM 1100-GET-MQ-INFO.                                    02390049
           PERFORM 1050-CHECK-FOR-2ND-QUEUE.                            02391099
           IF PS-WRITE-2ND-QUE-YES                                      02393099
               PERFORM 1150-GET-MQ2-INFO                                02394099
           END-IF.                                                      02395099
026900                                                                  02400049
026900     OPEN OUTPUT OUTPUT-FILE.                                     02410099
026900                                                                  02420099
      ****************************************************************  02421099
      * CHECK TO SEE IF 2ND QUEUE SHOULD BE RECEIVING MSGS              02422099
      ****************************************************************  02423099
       1050-CHECK-FOR-2ND-QUEUE.                                        02424099
                                                                        02425099
           EXEC SQL                                                     02426099
               SELECT FUNC_TXT                                          02427099
                 INTO :KRPRPM-FUNC-TXT                                  02428099
                 FROM TKRPRPM                                           02429099
                WHERE LOC_ID               =   810                      02429199
                  AND INTFC_SYS_CDE        =  'KHL'                     02429299
                  AND SYS_PRC_FUNC_CDE     =  'GV47MQ'                  02429399
                  AND FUNC_PRC_STAT_CDE    =  'AC'                      02429499
                  AND FUNC_BEG_TMST       <=   CURRENT TIMESTAMP        02429599
                  AND FUNC_END_TMST       >=   CURRENT TIMESTAMP        02429699
            WITH UR                                                     02429799
           END-EXEC.                                                    02429899
                                                                        02429999
           EVALUATE TRUE                                                02430099
               WHEN SQLCODE = 0                                         02430199
                   MOVE KRPRPM-FUNC-TXT       TO  PS-WRITE-2ND-QUEUE    02430299
               WHEN OTHER                                               02430499
031000             MOVE 'NO PARAMTER FOUND FOR 2ND QUEUE'               02430699
031000                                        TO PV-ERROR-MESSAGE       02430799
032900             SET ABEND-4013-DB2-ERROR   TO TRUE                   02430899
033000             PERFORM 9400-DB2-ABEND                               02430999
           END-EVALUATE.                                                02431499
                                                                        02431599
           DISPLAY 'WRITING TO 2ND QUEUE? ' PS-WRITE-2ND-QUEUE.         02431699
                                                                        02431799
027000******************************************************************02432049
027100* GETS MQ INFO FROM WSV_CNSMR_QUE (GET/READ)                      02440099
027200******************************************************************02450049
027300 1100-GET-MQ-INFO.                                                02460049
027400                                                                  02470049
027500     MOVE '1100-GET-MQ-INFO'           TO PV-PARAGRAPH.           02480049
029600     INITIALIZE PV-QUE-NAME                                       02490099
029400                PV-QMGR-NAME.                                     02500099
027600                                                                  02510049
027900     EXEC SQL                                                     02520049
028000        SELECT QUE_MGR                                            02530099
028100              ,QUE_NM                                             02540099
028200          INTO :WSV00006-QUE-MGR                                  02550099
028300              ,:WSV00006-QUE-NM                                   02560099
028400          FROM WSV_CNSMR_QUE                                      02570099
028500         WHERE APPL_FUNC_DESC  = 'QUEUE'                          02580099
028500           AND INTGRTN_TYP_CDE = 'GIVBOSS'                        02590099
028700     END-EXEC.                                                    02600049
028800                                                                  02610049
029200     EVALUATE TRUE                                                02620049
029300         WHEN SQLCODE = 0                                         02630049
029500             MOVE WSV00006-QUE-MGR-TEXT TO PV-QMGR-NAME           02640049
029700             MOVE WSV00006-QUE-NM-TEXT  TO PV-QUE-NAME            02650099
029700             DISPLAY 'QMGR-NAME       : '  PV-QMGR-NAME           02660099
029700             DISPLAY 'QUEUE-NAME      : ' PV-QUE-NAME             02670099
029700                                                                  02680099
031100         WHEN OTHER                                               02690049
031000             MOVE 'NO QUEUE/GIVBOSS ROW IN WSV_CNSMR_QUE'         02700099
031000                                        TO PV-ERROR-MESSAGE       02710099
032900             SET ABEND-4013-DB2-ERROR   TO TRUE                   02720099
033000             PERFORM 9400-DB2-ABEND                               02730099
033100     END-EVALUATE.                                                02740049
033200                                                                  02750049
027000******************************************************************02751099
027100* GETS MQ INFO FROM WSV_PRVDR_QUE (PUT)                           02752099
027200******************************************************************02753099
027300 1150-GET-MQ2-INFO.                                               02754099
027400                                                                  02755099
027500     MOVE '1150-GET-MQ2-INFO'           TO PV-PARAGRAPH.          02756099
027600                                                                  02759099
027900     EXEC SQL                                                     02759199
              SELECT A.INTGRTN_TYP_DESC                                 02759299
                   , A.LCL_QUE_MGR                                      02759399
                   , A.RMT_QUE_MGR                                      02759499
                   , A.QUE_NM                                           02759599
                INTO :WSV00005-INTGRTN-TYP-DESC                         02759799
                   , :WSV00005-LCL-QUE-MGR                              02759899
                   , :WSV00005-RMT-QUE-MGR                              02759999
                   , :WSV00005-QUE-NM                                   02760099
                FROM WSV_PRVDR_QUE A                                    02760299
028500         WHERE APPL_FUNC_DESC  = 'QUEUE'                          02760899
028500           AND INTGRTN_TYP_CDE = 'GIVMOBOSS'                      02760999
028700     END-EXEC.                                                    02761099
028800                                                                  02761199
029200     EVALUATE TRUE                                                02761299
029300         WHEN SQLCODE = 0                                         02761399
029500             MOVE WSV00005-RMT-QUE-MGR-TEXT  TO PV-QMGR2-RMT-NAME 02761499
029500             MOVE WSV00005-LCL-QUE-MGR-TEXT  TO PV-QMGR2-LCL-NAME 02761599
029700             MOVE WSV00005-QUE-NM-TEXT  TO PV-QUE2-NAME           02761699
029700             DISPLAY 'QUEUE2 NAME     : ' PV-QUE2-NAME            02761899
029700                                                                  02761999
031100         WHEN OTHER                                               02762099
031000             MOVE 'NO QUEUE/GIVBOSS ROW IN WSV_CNSMR_QUE'         02762199
031000                                        TO PV-ERROR-MESSAGE       02762299
032900             SET ABEND-4013-DB2-ERROR   TO TRUE                   02762399
033000             PERFORM 9400-DB2-ABEND                               02762499
033100     END-EVALUATE.                                                02762599
033200                                                                  02762699
033300******************************************************************02763049
033400* CONNECT TO QUEUE MANAGER.                                       02770049
033500******************************************************************02780049
033600 1200-MQSERIES-CONNECT.                                           02790049
034000     DISPLAY '1200-MQSERIES-CONNECT ' PV-QMGR-NAME.               02800099
033700                                                                  02810049
033800     MOVE '1200-MQSERIES-CONNECT'      TO PV-PARAGRAPH.           02820049
033900                                                                  02830049
034100                                                                  02840049
034200     CALL PC-MQCONN USING PV-QMGR-NAME                            02850049
034300                          PV-HCONN                                02860049
034400                          PV-COMPLETION-CODE                      02870049
034500                          PV-REASON.                              02880049
034600                                                                  02890099
034700     MOVE PV-REASON TO PV-CON-REASON.                             02900049
034800     IF PV-COMPLETION-CODE = MQCC-OK THEN                         02910099
036300         CONTINUE                                                 02920064
033700                                                                  02930099
036400     ELSE                                                         02940049
036800         DISPLAY ' GVKUT014 - 1200-MQ-CONNECT '                   02950099
               CALL PV-MQCHECK USING PV-REASON                          02960099
                                     PV-MQ-REASON-TEXT                  02970099
               MOVE PV-QMGR-NAME         TO PE-MQ-QMANAGER              02980099
               MOVE PV-COMPLETION-CODE   TO PE-MQ-COMPLETION-CODE       02990099
               MOVE PV-REASON            TO PE-MQ-REASON-CODE           03000099
               MOVE 'CONNECT TO QMGR'    TO PV-ERROR-MESSAGE            03010099
               SET ABEND-4020-MQ-ERROR   TO TRUE                        03020099
               PERFORM 9800-MQ-ABEND                                    03030099
038400     END-IF.                                                      03040099
038500                                                                  03050049
003300******************************************************************03062099
038700*   OPEN THE QUEUE FOR GETS                                       03070049
003300******************************************************************03080099
038900 1300-MQSERIES-OPEN.                                              03090049
039100                                                                  03100049
039200     MOVE '1300-MQSERIES-OPEN'         TO PV-PARAGRAPH.           03110049
039300                                                                  03120049
039400*    NON-DESTRUCTIVE READ (FOR TESTING ONLY)                      03130049
039500*    COMPUTE PV-OPEN-OPTIONS        = MQOO-BROWSE                 03140099
039600*                                   + MQOO-FAIL-IF-QUIESCING.     03150099
039700                                                                  03160049
040500     MOVE PV-QUE-NAME              TO MQOD-OBJECTNAME.            03171099
040400     MOVE PV-QMGR-NAME             TO MQOD-OBJECTQMGRNAME.        03180099
039700                                                                  03190099
039800     COMPUTE PV-OPEN-OPTIONS        = MQOO-INPUT-SHARED           03200099
039900                                    + MQOO-OUTPUT                 03210099
040000                                    + MQOO-SET-IDENTITY-CONTEXT   03220099
040100                                    + MQOO-FAIL-IF-QUIESCING.     03230099
040200                                                                  03240099
040300     MOVE MQOT-Q                   TO MQOD-OBJECTTYPE.            03250099
034000     DISPLAY '1300-MQSERIES-OPEN ' PV-QUE-NAME '  '               03251099
034000                                   PV-QMGR-NAME.                  03252099
040600                                                                  03260099
040700     CALL PC-MQOPEN USING PV-HCONN                                03270049
040800                          MQM-OBJECT-DESCRIPTOR                   03280049
040900                          PV-OPEN-OPTIONS                         03290049
041000                          PV-HANDLE                               03300049
041100                          PV-COMPLETION-CODE                      03310049
041200                          PV-REASON.                              03320049
041300                                                                  03330049
041400     IF PV-COMPLETION-CODE = MQCC-OK THEN                         03340099
042900         CONTINUE                                                 03350063
043000     ELSE                                                         03360049
043400         DISPLAY ' GVKUT014 - 1300-MQ-OPEN'                       03370099
043500                 ' COMPLETION CODE:'  PV-COMPLETION-CODE          03380099
043600                 ' REASON CODE:'      PV-REASON-CDE               03390099
               CALL PV-MQCHECK USING PV-REASON                          03400099
                                     PV-MQ-REASON-TEXT                  03410099
               MOVE PV-QMGR-NAME            TO PE-MQ-QMANAGER           03420099
               MOVE PV-QUE-NAME             TO PE-MQ-QNAME              03430099
               MOVE PV-COMPLETION-CODE      TO PE-MQ-COMPLETION-CODE    03440099
               MOVE PV-REASON               TO PE-MQ-REASON-CODE        03450099
               MOVE 'OPEN ITEM QUEUE'       TO PV-ERROR-MESSAGE         03460099
               SET ABEND-4020-MQ-ERROR   TO TRUE                        03470099
               PERFORM 9800-MQ-ABEND                                    03480099
045000     END-IF.                                                      03490049
045100                                                                  03500049
003300******************************************************************03501099
038700*   OPEN THE QUEUE FOR PUTS                                       03502099
003300******************************************************************03503099
038900 1350-MQSERIES-OPEN-2.                                            03504099
039100                                                                  03505099
039200     MOVE '1350-MQSERIES-OPEN-2'       TO PV-PARAGRAPH.           03506099
039300                                                                  03507099
040500     MOVE PV-QUE2-NAME             TO MQOD-OBJECTNAME.            03509399
040400     MOVE PV-QMGR-NAME             TO MQOD-OBJECTQMGRNAME.        03509499
040300     MOVE MQOT-Q                   TO MQOD-OBJECTTYPE.            03509699
039700                                                                  03509799
039800     COMPUTE PV-OPEN-OPTIONS        = MQOO-OUTPUT                 03509899
040000                                    + MQOO-SET-IDENTITY-CONTEXT   03509999
040100                                    + MQOO-FAIL-IF-QUIESCING.     03510099
034000     DISPLAY '1350-MQSERIES-OPEN-2 ' PV-QUE2-NAME '  '            03510199
034000                                     PV-QMGR2-LCL-NAME.           03510299
040200                                                                  03510399
040700     CALL PC-MQOPEN USING PV-HCONN                                03510499
040800                          MQM-OBJECT-DESCRIPTOR                   03510599
040900                          PV-OPEN-OPTIONS                         03510699
041000                          PV-PUT-HANDLE                           03510799
041100                          PV-COMPLETION-CODE                      03510899
041200                          PV-REASON.                              03510999
041300                                                                  03511099
041400     IF PV-COMPLETION-CODE = MQCC-OK THEN                         03511199
042900         CONTINUE                                                 03511299
043000     ELSE                                                         03511399
043400         DISPLAY ' GVKUT014 - 1350-MQ-OPEN-2'                     03511499
043500                 ' COMPLETION CODE:'  PV-COMPLETION-CODE          03511599
043600                 ' REASON CODE:'      PV-REASON-CDE               03511699
               DISPLAY 'TURNING OFF WRITE TO 2ND QUEUE'                 03511799
               SET PS-WRITE-2ND-QUE-NO      TO TRUE                     03511899
045000     END-IF.                                                      03512899
045100                                                                  03512999
003300******************************************************************03513099
045300** GET THE MESSAGES FROM THE QUEUE.                               03520049
003300******************************************************************03530099
045500 1400-GET-MQ-MESSAGE.                                             03540049
045600                                                                  03550049
045700     MOVE '1400-GET-MQ-MESSAGE'        TO PV-PARAGRAPH.           03560049
046000                                                                  03570049
046100     INITIALIZE PV-MSGBUFFER                                      03580049
046200                PV-MSG.                                           03590049
046700                                                                  03600099
046700*MSG ID IS NOT POPULATED IN THIS PGM.                             03610099
046800     MOVE MQMI-NONE              TO MQMD-MSGID.                   03620099
046700                                                                  03630099
046800*MSGS ARE UNQUALIFIED IN THIS PGM.                                03640099
046900     MOVE MQCI-NONE              TO MQMD-CORRELID.                03650099
047000                                                                  03660099
047000*FORMAT TRANSLATES THE DATA ACROSS PLATFORMS, 4K IS THE           03670099
047000*MAX LENGTH FOR MSGS IN THE PGM.                                  03680099
047100     MOVE MQFMT-STRING           TO MQMD-FORMAT.                  03690099
047200     MOVE +250000                TO PV-MSG-LENGTH.                03700099
047000                                                                  03710099
046500     MOVE '000'                  TO PV-ERR-CDE.                   03720099
047300                                                                  03730049
047400*** THE UNLIMITED WAIT INTERVAL MEANS THAT PROCESSING WILL        03740049
047500*** CONTINUE UNTIL A END-OF-RUN MESSAGE APPEARS ON THE Q.         03750049
047600**   MOVE MQWI-UNLIMITED         TO MQGMO-WAITINTERVAL.           03760099
047700                                                                  03770049
047800*    30 SECONDS FOR TESTING PURPOSES                              03780099
047900*    MOVE 30000                  TO MQGMO-WAITINTERVAL.           03790099
048100                                                                  03800099
048200*  QUEUE RECORDS ARE NOT DESTROYED (TEST ONLY)                    03810099
048300*    COMPUTE MQGMO-OPTIONS =   MQGMO-NO-SYNCPOINT                 03820099
048400*                            + MQGMO-CONVERT                      03830099
048500*                            + MQGMO-BROWSE-NEXT                  03840099
048600*                            + MQGMO-ACCEPT-TRUNCATED-MSG         03850099
048700*                            + MQGMO-FAIL-IF-QUIESCING            03860099
048800*                            + MQGMO-WAIT.                        03870099
048900                                                                  03880049
049000     COMPUTE MQGMO-OPTIONS  =  MQGMO-SYNCPOINT +                  03890099
049100                               MQGMO-CONVERT   +                  03900099
049200                               MQGMO-ACCEPT-TRUNCATED-MSG +       03910099
049300                               MQGMO-WAIT.                        03920099
049400                                                                  03930049
049500     CALL PC-MQGET USING PV-HCONN                                 03940049
049600                         PV-HANDLE                                03950049
049700                         MQM-MESSAGE-DESCRIPTOR                   03960049
049800                         MQM-GET-MESSAGE-OPTIONS                  03970049
049900                         PV-MSG-LENGTH                            03980049
050000                         PV-MSGBUFFER(1:PV-MSG-LENGTH)            03990099
050100                         PV-DATA-LENGTH                           04000049
050200                         PV-COMPLETION-CODE                       04010049
050300                         PV-REASON.                               04020049
050400                                                                  04030049
      *IF GET FAILED THEN DISPLAY ERROR MESSAGE                         04040099
      *AND BREAK OUT OF LOOP                                            04050099
           IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        04060099
               IF ((PV-REASON NOT = MQRC-NO-MSG-AVAILABLE)              04070099
               AND (PV-REASON NOT = MQRC-TRUNCATED-MSG-ACCEPTED))       04080099
                   CALL PV-MQCHECK USING PV-REASON                      04090099
                                         PV-MQ-REASON-TEXT              04100099
                 MOVE 'MQGET ERROR'          TO PV-ERROR-MESSAGE        04110099
                 MOVE '1400-GET-MQ-MSG'      TO PV-PARAGRAPH            04120099
                 MOVE PV-COMPLETION-CODE     TO PV-HOLD-COMPLETION-CODE 04130099
                 MOVE PV-REASON              TO PV-HOLD-REASON          04140099
                 PERFORM 3700-BACK-OUT-MQ                               04150099
                 MOVE PV-HOLD-COMPLETION-CODE TO PV-COMPLETION-CODE     04160099
                                                 PE-MQ-COMPLETION-CODE  04170099
                 MOVE PV-HOLD-REASON         TO PV-REASON               04180099
                                                PE-MQ-REASON-CODE       04190099
                 SET ABEND-4020-MQ-ERROR     TO TRUE                    04200099
                 PERFORM 9800-MQ-ABEND                                  04210099
               END-IF                                                   04220099
      * THIS MEANS A MSG WAS TRUNCATED - COMMIT TO CLEAR IT FROM QUEUE  04230099
      * BEFORE ABENDING SO THAT IT WON'T BE READ BACK IN ON A RESTART   04240099
               IF PV-COMPLETION-CODE = +1                               04250099
               AND PV-REASON = +2079                                    04260099
                  ADD +1                     TO PA-MQ-MSGS-READ         04270099
                  MOVE 'MQGET TRUNCATION ERROR' TO PV-ERROR-MESSAGE     04280099
                  MOVE '3300-MQ-GET-MSG'     TO PV-PARAGRAPH            04290099
                  MOVE PV-COMPLETION-CODE    TO PE-MQ-COMPLETION-CODE   04300099
                  MOVE PV-REASON             TO PE-MQ-REASON-CODE       04310099
                  MOVE SPACES                TO PV-MQ-REASON-TEXT       04320099
                  DISPLAY 'PV-MSGBUFF:' PV-MSGBUFFER (1:PV-DATA-LENGTH) 04330099
                  DISPLAY 'PV-MSGLNGT:' PV-MSG-LENGTH                   04340099
                  DISPLAY 'PV-DATLNGT:' PV-DATA-LENGTH                  04350099
                  PERFORM 8500-MQ-COMMIT                                04360099
                  IF PS-WRITE-2ND-QUE-YES                               04361099
                      PERFORM 8550-MQ2-COMMIT                           04362099
                  END-IF                                                04363099
                  SET ABEND-4020-MQ-ERROR  TO TRUE                      04370099
                  PERFORM 9800-MQ-ABEND                                 04380099
               END-IF                                                   04390099
               IF (PV-REASON = MQRC-NO-MSG-AVAILABLE)                   04400099
                   CONTINUE                                             04410099
               END-IF                                                   04420099
           ELSE                                                         04430099
               ADD +1                           TO PA-MQ-MSGS-READ      04440099
                                                                        04450099
      *PV-MSG IS AN ELEMENT THAT JUST HOLDS THE ENTIRE MESSAGE          04460099
               MOVE PV-MSGBUFFER                TO PV-MSG               04470099
               IF PS-WRITE-2ND-QUE-YES                                  04470199
                   PERFORM 1450-MQ-PUT-MSG                              04471099
               END-IF                                                   04472099
                                                                        04480099
056000**       DISPLAY 'PV-MSGBUFF:' PV-MSGBUFFER(1:PV-DATA-LENGTH)     04490099
056100**       DISPLAY 'PV-MSGLNGT:' PV-MSG-LENGTH                      04500099
056200**       DISPLAY 'PV-DATLNGT:' PV-DATA-LENGTH                     04510099
056300**       DISPLAY 'PV-COMPLCD:' PV-COMPLETION-CODE                 04520099
056400**       DISPLAY 'PV-REASON :' PV-REASON                          04530099
056500**       DISPLAY 'full MESSAGE:' PV-MSG(1:PV-DATA-LENGTH)         04540099
056600     END-IF.                                                      04550049
056700                                                                  04560049
      ****************************************************************  04561099
      ** PUT THE MESSAGE TO THE OUTPUT QUEUE                            04562099
      ****************************************************************  04563099
       1450-MQ-PUT-MSG.                                                 04564099
                                                                        04565099
           MOVE MQMI-NONE            TO MQMD-MSGID.                     04566099
           MOVE MQCI-NONE            TO MQMD-CORRELID.                  04567099
           MOVE MQFMT-STRING         TO MQMD-FORMAT.                    04568099
           MOVE MQPER-PERSISTENT     TO MQMD-PERSISTENCE.               04569099
           COMPUTE MQPMO-OPTIONS = MQPMO-SYNCPOINT                      04569299
                                 + MQPMO-SET-IDENTITY-CONTEXT.          04569399
                                                                        04569499
           CALL PC-MQPUT USING PV-HCONN                                 04569599
                               PV-PUT-HANDLE                            04569699
                               MQM-MESSAGE-DESCRIPTOR                   04569799
                               MQM-PUT-MESSAGE-OPTIONS                  04569899
                               PV-DATA-LENGTH                           04569999
                               PV-MSG                                   04570099
                               PV-COMPLETION-CODE                       04570199
                               PV-REASON.                               04570299
                                                                        04570399
      *IF PUT FAILED THEN INCREMENT COUNTER, BUT DO NOT ABEND PROGRAM   04570499
           IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        04570699
               ADD +1                         TO PA-MQ-MSGS-ERROR       04572399
           ELSE                                                         04573099
               ADD +1                         TO PA-MQ-MSGS-WRITTEN     04573199
           END-IF.                                                      04573299
                                                                        04573399
056800******************************************************************04574049
056900* PROCESS/PARSE THE XML DATA                                      04580049
057000******************************************************************04590049
057100 2000-PROCESS-XML.                                                04600049
057500*    DISPLAY '2000-PROCESS-XML'.                                  04610099
057200                                                                  04620049
057300     MOVE '2000-PROCESS-XML'           TO PV-PARAGRAPH.           04630049
057600                                                                  04640049
059900     XML PARSE PV-MSG (1:PV-DATA-LENGTH)                          04650099
060000         PROCESSING PROCEDURE                                     04660099
060100             2100-HANDLE-XML                                      04670099
060200                 ON EXCEPTION                                     04680099
060300                      PERFORM 3000-XML-ERROR                      04690099
060400                 NOT ON EXCEPTION                                 04700099
060500                      PERFORM 3100-XML-SUCCESS                    04710099
060600     END-XML.                                                     04720099
060700                                                                  04730049
060900     PERFORM 8500-MQ-COMMIT.                                      04740099
           IF PS-WRITE-2ND-QUE-YES                                      04741099
               PERFORM 8550-MQ2-COMMIT                                  04742099
           END-IF.                                                      04743099
060901                                                                  04750075
060940     INITIALIZE PV-PROGRAM-VARIABLES.                             04760099
061200                                                                  04770099
061000     PERFORM 1400-GET-MQ-MESSAGE.                                 04780099
061200                                                                  04790049
069200******************************************************************04800049
069300* PREP THE OUTPUT FIELDS WITH THE XML DATA                        04810099
069400******************************************************************04820049
069500 2100-HANDLE-XML.                                                 04830099
069600                                                                  04840049
069700     COMPUTE XML-LENGTH = FUNCTION LENGTH(XML-TEXT).              04850049
069800                                                                  04860049
069900     EVALUATE XML-EVENT                                           04870049
079300                                                                  04880049
079400       WHEN 'END-OF-ELEMENT'                                      04890099
094700         EVALUATE XML-TEXT(1:XML-LENGTH)                          04900099
094800           WHEN 'Inventory'                                       04910099
094800               PERFORM 2700-WRITE-RECORD                          04920099
079300                                                                  04930099
094800           WHEN OTHER                                             04940099
094800               CONTINUE                                           04950099
079300                                                                  04960099
094700         END-EVALUATE                                             04970099
079300                                                                  04980099
074800       WHEN 'START-OF-ELEMENT'                                    04990099
074900         MOVE XML-TEXT(1:XML-LENGTH) TO PV-CURRENT-ELEMENT        05000099
079300                                                                  05010099
079400       WHEN 'ATTRIBUTE-NAME'                                      05020099
079500         MOVE XML-TEXT(1:XML-LENGTH) TO PV-CURRENT-ATTRIBUTE      05030099
079610*          display 'ATTRIB-NAME=' XML-EVENT '-'                   05040099
079620*                  PV-CURRENT-ATTRIBUTE '-'                       05050099
079630*                  XML-TEXT(1:XML-LENGTH)                         05060099
079640*                 ' - ' xml-length                                05070099
079650                                                                  05080099
079800       WHEN 'ATTRIBUTE-CHARACTERS'                                05090049
079900       WHEN 'ATTRIBUTE-CHARACTER'                                 05100049
080000       WHEN 'CONTENT-CHARACTERS'                                  05110049
080100       WHEN 'CONTENT-CHARACTER'                                   05120049
080110                                                                  05130099
080300        EVALUATE PV-CURRENT-ATTRIBUTE                             05140099
081400         WHEN 'ItemID'                                            05150099
081500           MOVE XML-TEXT(1:XML-LENGTH) TO GV002-INV-ITEM-ID       05160099
081500                                                                  05170099
081610         WHEN 'ShipNode'                                          05180099
086400           MOVE XML-TEXT(1:XML-LENGTH) TO PV-STR-NBR              05190099
086500                INSPECT PV-STR-NBR-REDEF                          05200099
086600                   REPLACING ALL ' ' BY '0'                       05210099
086700                MOVE PV-STR-NBR-9      TO GV002-INV-SHIP-NODE     05220099
081500                                                                  05230099
081700         WHEN 'ReceivingNode'                                     05240099
086400           MOVE XML-TEXT(1:XML-LENGTH) TO PV-STR-NBR              05250099
086500                INSPECT PV-STR-NBR-REDEF                          05260099
086600                   REPLACING ALL ' ' BY '0'                       05270099
086700                MOVE PV-STR-NBR-9      TO GV002-INV-RECEIVING-NODE05280099
081500                                                                  05290099
082400         WHEN 'Type'                                              05300099
082500           MOVE XML-TEXT(1:XML-LENGTH) TO GV002-INV-TYPE          05310099
081500                                                                  05320099
083010         WHEN 'Quantity'                                          05330099
083020           MOVE XML-TEXT(1:XML-LENGTH) TO GV002-INV-QUANTITY      05340099
081500                                                                  05350099
083100         WHEN 'OrderNo'                                           05360099
083020           MOVE XML-TEXT(1:XML-LENGTH) TO GV002-INV-ORDER-NBR     05370099
081500                                                                  05380099
083100         WHEN 'PrimeLineNo'                                       05390099
083020           MOVE XML-TEXT(1:XML-LENGTH) TO GV002-INV-PRIME-LINE-NBR05400099
081500                                                                  05410099
083100         WHEN 'ReasonCode'                                        05420099
083020           MOVE XML-TEXT(1:XML-LENGTH) TO GV002-INV-REASON-CODE   05430099
081500                                                                  05440099
088000         WHEN OTHER                                               05450049
088200             CONTINUE                                             05460049
088001                                                                  05470099
088300        END-EVALUATE                                              05480049
088400                                                                  05490049
088500       WHEN 'EXCEPTION'                                           05500049
088800            DISPLAY 'GVKUT014-2100 - UNKNOWN XML EVENT - '        05510099
088900                   XML-EVENT                                      05520099
114900            DISPLAY 'Exception Caught at ' XML-TEXT(1:XML-LENGTH) 05530099
114900            SET ABEND-4020-MQ-ERROR   TO TRUE                     05540099
102200            PERFORM 3000-XML-ERROR                                05550099
089300     END-EVALUATE.                                                05560049
089400                                                                  05570049
      ******************************************************************05580099
      * WRITE MESSAGES TO A OUTPUT FILE                                 05590099
      ******************************************************************05600099
       2700-WRITE-RECORD.                                               05610099
                                                                        05620099
           WRITE OUTPUT-RECORD                                          05630099
             FROM GV002-INVENTORY-RECORD.                               05640099
                                                                        05650099
           ADD +1                            TO PA-TOTAL-OUTPUT-RECS.   05660099
                                                                        05670099
101900******************************************************************05680049
102000* XML ERROR                                                       05690049
102100******************************************************************05700049
102200 3000-XML-ERROR.                                                  05710049
102300                                                                  05720049
102400     MOVE '3000-XML-ERROR'             TO PV-PARAGRAPH.           05730049
102500                                                                  05740049
102600     DISPLAY 'GVKUT014 - 3000-XML-ERROR.               '.         05750099
102700                                                                  05760049
102800     PERFORM 9000-EXPLAIN-XML-RESPONSE                            05770049
102900     PERFORM VARYING XML-LINE-IDX FROM 1 BY 1                     05780099
103000       UNTIL XML-LINE-IDX > XML-RESPONSE-LINES                    05790099
103100          DISPLAY XML-MSG(XML-LINE-IDX)                           05800099
103200     END-PERFORM.                                                 05810049
103300                                                                  05820049
103700     MOVE +4018              TO PV-ABEND-CODE.                    05830049
103800     PERFORM 9500-ABEND.                                          05840049
103900                                                                  05850049
104000******************************************************************05860049
104100* SUCCESSFUL XML PARSE                                            05870049
104200******************************************************************05880049
104300 3100-XML-SUCCESS.                                                05890049
104400                                                                  05900049
104500     MOVE '3100-XML-SUCCESS'           TO PV-PARAGRAPH.           05910049
104600                                                                  05920049
104700*    DISPLAY 'GVKUT014 - 3100-XML-SUCCESS.             '.         05930099
104800                                                                  05940049
104900     ADD +1                            TO PA-XML-PARSED.          05950099
105000                                                                  05960049
      ******************************************************************05970099
      * BACK OUT MQ PROCESSING SINCE THE POINT OF THE LAST COMMIT       05980099
      ******************************************************************05990099
       3700-BACK-OUT-MQ.                                                06000099
                                                                        06010099
           CALL PC-MQBACK USING PV-HCONN                                06020099
                                PV-COMPLETION-CODE                      06030099
                                PV-REASON.                              06040099
                                                                        06050099
           IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        06060099
               CALL PV-MQCHECK USING PV-REASON                          06070099
                                     PV-MQ-REASON-TEXT                  06080099
              MOVE '3700-BACK-OUT-MQ'  TO PV-PARAGRAPH                  06090099
              MOVE 'MQBACK ERROR'      TO PV-ERROR-MESSAGE              06100099
              SET ABEND-4020-MQ-ERROR  TO TRUE                          06110099
              PERFORM 9800-MQ-ABEND                                     06120099
           END-IF.                                                      06130099
                                                                        06140099
003300******************************************************************06150099
105200* MQ SERIES CLOSE QUEUE                                           06160049
003300******************************************************************06170099
105400 4100-MQ-CLOSE-QUEUE.                                             06180049
105600*    DISPLAY '4100-MQ-CLOSE-QUEUE'.                               06190099
105700                                                                  06200049
105800     MOVE '4100-MQ-CLOSE-QUEUE' TO PV-PARAGRAPH.                  06210049
105900                                                                  06220049
106000     MOVE PV-QUE-NAME               TO MQOD-OBJECTNAME.           06230049
106100     MOVE PV-QMGR-NAME              TO MQOD-OBJECTQMGRNAME.       06240049
106200                                                                  06250049
106300     CALL PC-MQCLOSE USING PV-HCONN                               06260099
106400                           PV-HANDLE                              06270049
106500                           MQCO-NONE                              06280049
106600                           PV-COMPLETION-CODE                     06290049
106700                           PV-REASON.                             06300049
106800                                                                  06310049
106900     IF PV-COMPLETION-CODE = MQCC-OK                              06320099
108400         CONTINUE                                                 06330063
106800                                                                  06340099
108500     ELSE                                                         06350049
108600         MOVE '109'              TO PV-ERR-CDE                    06360049
108700         MOVE PV-COMPLETION-CODE TO PV-DISPLAY-CDE                06370049
108800         MOVE PV-REASON          TO PV-REASON-CDE                 06380049
109600         MOVE +4018              TO PV-ABEND-CODE                 06390049
109700         PERFORM 9500-ABEND                                       06400049
109800     END-IF.                                                      06410049
109900                                                                  06420049
003300******************************************************************06421099
105200* MQ SERIES CLOSE OUTPUT QUEUE                                    06422099
003300******************************************************************06423099
105400 4150-MQ-CLOSE-QUEUE-2.                                           06424099
105600*    DISPLAY '4150-MQ-CLOSE-QUEUE-2'.                             06425099
105700                                                                  06426099
105800     MOVE '4150-MQ-CLOSE-QUEUE2'    TO PV-PARAGRAPH.              06427099
105900                                                                  06428099
106000     MOVE PV-QUE2-NAME              TO MQOD-OBJECTNAME.           06429099
106100     MOVE PV-QMGR2-RMT-NAME         TO MQOD-OBJECTQMGRNAME.       06429199
106200                                                                  06429299
106300     CALL PC-MQCLOSE USING PV-HCONN                               06429399
106400                           PV-PUT-HANDLE                          06429499
106500                           MQCO-NONE                              06429599
106600                           PV-COMPLETION-CODE                     06429699
106700                           PV-REASON.                             06429799
106800                                                                  06429899
106900     IF PV-COMPLETION-CODE = MQCC-OK                              06429999
108400         CONTINUE                                                 06430099
106800                                                                  06430199
108500     ELSE                                                         06430299
108600         MOVE '109'              TO PV-ERR-CDE                    06430399
108700         MOVE PV-COMPLETION-CODE TO PV-DISPLAY-CDE                06430499
108800         MOVE PV-REASON          TO PV-REASON-CDE                 06430599
109600         MOVE +4018              TO PV-ABEND-CODE                 06430699
109700         PERFORM 9500-ABEND                                       06430799
109800     END-IF.                                                      06430899
109900                                                                  06430999
003300******************************************************************06431099
110100* DISCONNECT FROM QUEUE MANAGER.                                  06440049
003300******************************************************************06450099
110300 4500-MQ-DISCONNECT.                                              06460049
110500*    DISPLAY '4500-MQ-DISCONNECT'.                                06470099
110600                                                                  06480049
110700     MOVE '4500-MQ-DISCONNECT'    TO PV-PARAGRAPH.                06490049
110800                                                                  06500049
110900     IF PV-CON-REASON NOT = MQRC-ALREADY-CONNECTED                06510049
111000         CALL PC-MQDISC USING PV-HCONN                            06520049
111100                              PV-COMPLETION-CODE                  06530049
111200                              PV-REASON                           06540049
111300                                                                  06550049
111400     IF PV-COMPLETION-CODE = MQCC-OK                              06560099
112900         CONTINUE                                                 06570049
111300                                                                  06580099
113000     ELSE                                                         06590049
113200         MOVE '110'              TO PV-ERR-CDE                    06600049
113300         MOVE PV-COMPLETION-CODE TO PV-DISPLAY-CDE                06610049
113400         MOVE PV-REASON          TO PV-REASON-CDE                 06620049
114200         MOVE +4018              TO PV-ABEND-CODE                 06630049
114300         PERFORM 9500-ABEND                                       06640049
114400     END-IF.                                                      06650049
126900                                                                  06660049
127000******************************************************************06671049
127100*  COMMIT MQ PROCESSING                                           06680049
127200******************************************************************06690049
127300 8500-MQ-COMMIT.                                                  06700049
127700*    DISPLAY '8500-MQ-COMMIT'.                                    06710099
127400                                                                  06720049
127500     MOVE '8500-MQ-COMMIT'        TO PV-PARAGRAPH.                06730049
127600                                                                  06740049
127900     CALL PC-MQCMIT USING PV-HCONN                                06750099
128000                          PV-COMPLETION-CODE                      06760099
128100                          PV-REASON.                              06770099
131100                                                                  06780049
           IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        06790099
              CALL PV-MQCHECK USING PV-REASON                           06800099
                                    PV-MQ-REASON-TEXT                   06810099
              MOVE '8500-MQ-COMMIT'    TO PV-PARAGRAPH                  06820099
              MOVE 'MQCMIT ERROR'      TO PV-ERROR-MESSAGE              06830099
              MOVE PV-COMPLETION-CODE  TO PE-MQ-COMPLETION-CODE         06840099
              MOVE PV-REASON           TO PE-MQ-REASON-CODE             06850099
              PERFORM 3700-BACK-OUT-MQ                                  06860099
              MOVE PV-HOLD-REASON      TO PE-MQ-REASON-CODE             06870099
              SET ABEND-4020-MQ-ERROR  TO TRUE                          06880099
              PERFORM 9800-MQ-ABEND                                     06890099
                                                                        06900099
           ELSE                                                         06910099
              ADD +1                   TO PA-MQ-COMMITS                 06920099
           END-IF.                                                      06930099
                                                                        06940099
127000******************************************************************06941099
127100*  COMMIT MQ2 PROCESSING                                          06942099
127200******************************************************************06943099
127300 8550-MQ2-COMMIT.                                                 06944099
127700*    DISPLAY '8550-MQ2-COMMIT'.                                   06945099
127400                                                                  06946099
127500     MOVE '8550-MQ2-COMMIT'        TO PV-PARAGRAPH.               06947099
127600                                                                  06948099
127900     CALL PC-MQCMIT USING PV-HCONN                                06949099
128000                          PV-COMPLETION-CODE                      06949199
128100                          PV-REASON.                              06949299
131100                                                                  06949399
           IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        06949499
              CALL PV-MQCHECK USING PV-REASON                           06949599
                                    PV-MQ-REASON-TEXT                   06949699
              MOVE '8550-MQ2-COMMIT'   TO PV-PARAGRAPH                  06949799
              MOVE 'MQCMIT ERROR'      TO PV-ERROR-MESSAGE              06949899
              MOVE PV-COMPLETION-CODE  TO PE-MQ-COMPLETION-CODE         06949999
              MOVE PV-REASON           TO PE-MQ-REASON-CODE             06950099
              PERFORM 3700-BACK-OUT-MQ                                  06950199
              MOVE PV-HOLD-REASON      TO PE-MQ-REASON-CODE             06950599
              SET ABEND-4020-MQ-ERROR  TO TRUE                          06950699
              PERFORM 9800-MQ-ABEND                                     06950799
                                                                        06950899
           ELSE                                                         06950999
              ADD +1                   TO PA-MQ-COMMITS                 06951099
           END-IF.                                                      06951199
                                                                        06951299
123500******************************************************************06952099
131300* EOJ AND DISPLAY SUMMARY TOTALS.                                 06960099
123500******************************************************************06970099
131500 9300-EOJ.                                                        06980099
131600                                                                  06990099
131700     MOVE '9300-EOJ'              TO PV-PARAGRAPH.                07000099
131800                                                                  07010099
132000     CLOSE OUTPUT-FILE.                                           07020099
132000                                                                  07030099
132100     PERFORM 4100-MQ-CLOSE-QUEUE.                                 07040099
           IF PS-WRITE-2ND-QUE-YES                                      07041099
               PERFORM 4150-MQ-CLOSE-QUEUE-2                            07042099
           END-IF.                                                      07043099
132200     PERFORM 4500-MQ-DISCONNECT.                                  07050099
132300                                                                  07060099
132400     DISPLAY SPACES.                                              07070099
132600     DISPLAY '******************************'.                    07080099
132500     DISPLAY ' GVKUT014 SUMMARY STATISTICS '.                     07090099
132600     DISPLAY '******************************'.                    07100099
132700     DISPLAY SPACES.                                              07110099
132700                                                                  07120099
132800     MOVE PA-MQ-MSGS-READ              TO PV-DISPLAY-NBR.         07130099
132900     DISPLAY ' MQ MESSAGES READ     = '   PV-DISPLAY-NBR.         07140099
133000                                                                  07150099
132800     MOVE PA-MQ-MSGS-WRITTEN           TO PV-DISPLAY-NBR.         07151099
132900     DISPLAY ' MQ MESSAGES WRITTEN  = '   PV-DISPLAY-NBR.         07152099
133000                                                                  07153099
132800     MOVE PA-MQ-MSGS-ERROR             TO PV-DISPLAY-NBR.         07154099
132900     DISPLAY ' MQ MSGS WRITE ERRORS = '   PV-DISPLAY-NBR.         07155099
133000                                                                  07156099
133100     MOVE PA-XML-PARSED                TO PV-DISPLAY-NBR.         07160099
133200     DISPLAY ' MQ MESSAGES PARSED   = '   PV-DISPLAY-NBR.         07170099
132700     DISPLAY SPACES.                                              07180099
133300                                                                  07190099
133710     MOVE PA-TOTAL-OUTPUT-RECS         TO PV-DISPLAY-NBR.         07200099
133800     DISPLAY ' OUTPUT RECORDS WROTE = '   PV-DISPLAY-NBR.         07210099
133900                                                                  07220099
134000     MOVE PA-MQ-COMMITS                TO PV-DISPLAY-NBR.         07230099
134100     DISPLAY ' MQ COMMITS           = '   PV-DISPLAY-NBR.         07240099
132700     DISPLAY SPACES.                                              07250099
134500                                                                  07260099
123500******************************************************************07270099
      ** PERFORM DB2 ABEND PROCESSING                                   07280099
123500******************************************************************07290099
       9400-DB2-ABEND.                                                  07300099
                                                                        07310099
           DISPLAY '**** ABEND *************************************'.  07320099
           DISPLAY '** DB2 ERROR **'.                                   07330099
           DISPLAY '** PROGRAM:    ', PC-CURRENT-PROGRAM-NAME.          07340099
           MOVE SQLCODE TO PV-SQLCODE.                                  07350099
           DISPLAY '** SQLCODE:    ', PV-SQLCODE.                       07360099
           DISPLAY '** ABEND CODE: ', PV-ABEND-CODE.                    07370099
           DISPLAY '** PARAGRAPH:  ', PV-PARAGRAPH.                     07380099
           DISPLAY '** MESSAGE:    ', PV-ERROR-MESSAGE.                 07390099
           DISPLAY '************************************************'.  07400099
           CALL 'ILBOABN0' USING PV-ABEND-CODE.                         07410099
                                                                        07420099
123500******************************************************************07430099
135100* ABEND PROGRAM - CALL ABEND MODULE                               07440099
123500******************************************************************07450099
135300 9500-ABEND.                                                      07460099
135400                                                                  07470099
135700     MOVE SQLCODE               TO PV-SQLCODE.                    07480099
           DISPLAY '** PROGRAM:      = ' PC-CURRENT-PROGRAM-NAME.       07490099
136200     DISPLAY '** PARAGRAPH     = ' PV-PARAGRAPH.                  07500099
136400     DISPLAY '** SQLCODE       = ' PV-SQLCODE.                    07510099
136500     DISPLAY '** MQ CMPLTN CDE = ' PV-DISPLAY-CDE.                07520099
136600     DISPLAY '** MQ REASON CDE = ' PV-REASON-CDE.                 07530099
           CALL 'ILBOABN0' USING PV-ABEND-CODE.                         07540099
                                                                        07550099
123500******************************************************************07560099
      ** PERFORM MQ-SERIES ABEND PROCESSING                             07570099
123500******************************************************************07580099
       9800-MQ-ABEND.                                                   07590099
                                                                        07600099
           DISPLAY '**** ABEND *************************************'.  07610099
           DISPLAY '** MQSERIES ERROR **'.                              07620099
           DISPLAY '** PROGRAM:    ', PC-CURRENT-PROGRAM-NAME.          07630099
           DISPLAY '** ABEND CODE: ', PV-ABEND-CODE.                    07640099
           DISPLAY '** PARAGRAPH:  ', PV-PARAGRAPH.                     07650099
           DISPLAY '** MESSAGE:    ', PV-ERROR-MESSAGE.                 07660099
           DISPLAY '** COMP CODE:  ', PE-MQ-COMPLETION-CODE.            07670099
           DISPLAY '** RSN CODE:   ', PE-MQ-REASON-CODE.                07680099
           DISPLAY '** RSN TEXT:   ', PV-MQ-REASON-TEXT.                07690099
           DISPLAY '************************************************'.  07700099
           CALL 'ILBOABN0' USING PV-ABEND-CODE.                         07710099
                                                                        07720099
137100     COPY ISPD002.                                                07730099
137200     COPY ISPD007.                                                07740099
137300     COPY ISPD008.                                                07750099
137400     COPY ISPD009.                                                07760099
