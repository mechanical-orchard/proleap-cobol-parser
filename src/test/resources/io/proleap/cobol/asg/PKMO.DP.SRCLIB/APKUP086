       IDENTIFICATION DIVISION.                                         00010000
       PROGRAM-ID.     APKUP086.                                        00020000
       AUTHOR.         COGNIZANT.                                       00030000
       DATE-WRITTEN.   MARCH 2019.                                      00040005
      ****************************************************************  00050000
      *    COBOL 2 WITH DB2 SQL.                                     *  00060000
      *                                                              *  00070000
      * THIS PROGRAM READS THE MEMO UPDATE FILE SO THAT IT CAN       *  00080000
      * UPDATE THE TIMESTAMP ON THE APT_AP_MEMO FOR EACH RECORD IN   *  00090000
      * THE FILE.                                                    *  00100000
      *                                                              *  00110000
      ****************************************************************  00120000
      *                                                              *  00130000
      * INPUT:                                                       *  00140000
      *  1. MEMO UPDATE FILE                 (APRD186)               *  00150000
      *                                                              *  00160000
      * DB2 TABLE:                                                   *  00170000
      *  1. AP MEMO TABLE - APT_AP_MEMO      (APT00001)              *  00180000
      *                                                              *  00190000
      ****************************************************************  00200000
      * CHANGE LOG:                                                  *  00210000
      * 03/12/19  NEW PROGRAM AS PART OF PEOPLESOFT ERP MIGRATION.   *  00220008
      *           CHANGED BY : COGNIZANT         WR#: CHG0220043     *  00230008
      ****************************************************************  00600000
                                                                        00610000
       ENVIRONMENT DIVISION.                                            00620000
       INPUT-OUTPUT SECTION.                                            00640000
       FILE-CONTROL.                                                    00660000
           SELECT MEMO-UPDATE-FILE     ASSIGN TO INP01.                 00670000
      *                                                                 00690000
       DATA DIVISION.                                                   00710000
       FILE SECTION.                                                    00730000
      *                                                                 00740000
       FD  MEMO-UPDATE-FILE                                             00760000
           RECORDING MODE IS F                                          00770000
           LABEL RECORDS ARE STANDARD                                   00780000
           BLOCK CONTAINS 0 RECORDS                                     00790000
           RECORD CONTAINS 26 CHARACTERS                                00800000
           DATA RECORD IS MEMO-UPDATE-REC.                              00810000
                                                                        00820000
       01  MEMO-UPDATE-REC                    PIC X(26).                00830000
                                                                        00840000
       EJECT                                                            00920000
                                                                        00930000
      /                                                                 00940000
       WORKING-STORAGE SECTION.                                         00950000
       01  FILLER                        PIC X(25)  VALUE               00970000
                                   'WS FOR APKUP086 BEGINS==>'.         00980000
                                                                        00990000
       01  WS-SWITCH-AREA.                                              01030000
           05  WS-INPUT-EOF-SW           PIC X(03)  VALUE 'NO '.        01040000
               88  INPUT-EOF                        VALUE 'YES'.        01050000
           05  WS-NO-INPUT-DATA-SW       PIC X(03)  VALUE 'NO '.        01060000
               88  NO-INPUT-DATA                    VALUE 'YES'.        01070000
                                                                        01090000
       01  WS-PROGRAM-COUNTERS.                                         01100000
           05  WS-IN-COUNT               PIC  9(09) VALUE ZEROS.        01110000
           05  WS-UPDATE-COUNT           PIC  9(09) VALUE ZEROS.        01120000
           05  WS-NOT-UPD-CNT            PIC  9(09) VALUE ZEROS.        01121006
                                                                        01130004
      ******************************************************************01140004
      * CONTAINS THE FIELDS TO CALL THE SQLCA MESSAGE MODULE            01150004
      ******************************************************************01160004
                                                                        01170004
           COPY DPWS004.                                                01202002
                                                                        01203002
      ******************************************************************01203104
      * WORKING STORAGE FOR ABEND PROCESSING                            01203204
      ******************************************************************01203304
                                                                        01203404
       01  ABEND-CODE                PIC S9(04)  VALUE ZEROS COMP SYNC. 01203504
           88  AC-DB2-ERROR                        VALUE +4013.         01203604
                                                                        01203704
       01  ABEND-AREAS.                                                 01204004
           05  AA-ABEND-LIT          PIC  X(40)  VALUE                  01205004
                   '*****       ABEND'.                                 01206004
           05  AA-PROGRAM-LIT        PIC  X(40)  VALUE                  01207004
                   '*****   PROGRAM: APKUP086'.                         01208004
           05  AA-PARAGRAPH-LIT.                                        01209004
               10  FILLER            PIC  X(17)  VALUE                  01209104
                   '***** PARAGRAPH: '.                                 01209204
               10  AA-PARAGRAPH-NAME PIC  X(35)  VALUE SPACES.          01209304
           05  AA-MESSAGE-LINE.                                         01209404
               10  FILLER            PIC  X(06)  VALUE '*****'.         01209504
               10  AA-MESSAGE        PIC  X(127) VALUE SPACES.          01209604
               10  FILLER REDEFINES AA-MESSAGE.                         01209704
                   15 AA-MESSAGE-1   PIC  X(45).                        01209804
                   15 AA-MESSAGE-2   PIC  X(45).                        01209904
                   15 AA-MESSAGE-3   PIC  X(37).                        01210004
           05  AA-DB2-ERROR-LIT      PIC  X(40)  VALUE                  01210104
                   '*****    DB2 ERROR'.                                01210204
           05  AA-DB2-OPERATION-LIT.                                    01210304
               10  FILLER            PIC  X(17)  VALUE                  01210404
                   '***** OPERATION: '.                                 01210504
               10  AA-DB2-OPERATION.                                    01210604
                   15  AA-DB2-OP-1   PIC  X(25)  VALUE SPACES.          01210704
                   15  AA-DB2-OP-2   PIC  X(25)  VALUE SPACES.          01210804
           05  AA-DB2-TABLE-1        PIC  X(18)  VALUE SPACES.          01210904
           05  AA-DB2-TABLE-2        PIC  X(18)  VALUE SPACES.          01211004
           05  AA-DB2-TABLE-3        PIC  X(18)  VALUE SPACES.          01211104
       EJECT                                                            01211204
      ******************************************************************01212004
      *  COPYBOOK FOR THE MEMO UPDATE FILE.                             01220004
      ******************************************************************01230004
                                                                        01231002
           COPY APRD188.                                                01240000
                                                                        01250000
      ******************************************************************01261002
      *  COMMUNICATIONS AREA2 FOR DB2                                   01262002
      ******************************************************************01263002
                                                                        01264002
           COPY SQLCA2.                                                 01265002
                                                                        01266002
           EXEC SQL                                                     01267002
                INCLUDE SQLCA                                           01268002
           END-EXEC.                                                    01269002
                                                                        01269102
      *--------------------------------------------------------------*  01271000
      *   APT_AP_MEMO                                                *  01272000
      *--------------------------------------------------------------*  01273000
                                                                        01273102
           EXEC SQL                                                     01274000
                INCLUDE APT00001                                        01275000
           END-EXEC.                                                    01276000
                                                                        01277002
       01  FILLER                        PIC X(25) VALUE                01760000
                '<====WS FOR APKUP086 ENDS'.                            01770001
                                                                        01780000
       PROCEDURE DIVISION.                                              01820000
      *                                                                 01840000
      ***************************************************************** 01850000
      *  MAIN DRIVER FOR THE PROGRAM.                                   01860000
      ***************************************************************** 01870000
      *                                                                 01880000
       A100-MAINLINE.                                                   01890000
                                                                        01900000
           PERFORM B100-HOUSEKEEPING.                                   01910000
                                                                        01920000
           IF NO-INPUT-DATA                                             01930000
              PERFORM N100-NO-DATA                                      01940000
           ELSE                                                         01950000
              PERFORM B200-PROCESS-DATA UNTIL INPUT-EOF                 01960000
           END-IF.                                                      01970000
                                                                        01980000
           PERFORM B300-END.                                            01990000
           GOBACK.                                                      02000000
                                                                        02010000
       EJECT                                                            02020000
      *                                                                 02030000
      ***************************************************************** 02040000
      *  INITIALIZATION AND THE READ OF THE INUT FILE.                  02050000
      ***************************************************************** 02060000
      *                                                                 02070000
       B100-HOUSEKEEPING.                                               02080000
                                                                        02090000
           OPEN INPUT MEMO-UPDATE-FILE                                  02100000
                                                                        02130000
           PERFORM R100-READ-INPUT-FILE.                                02140000
                                                                        02150000
           IF INPUT-EOF THEN                                            02160000
              SET NO-INPUT-DATA TO TRUE                                 02170000
              DISPLAY '***  APKUP086  ***'                              02180000
              DISPLAY 'EMPTY INPUT FILE     '                           02190000
              DISPLAY 'NO INPUT RECORDS TO PROCESS '                    02200000
              DISPLAY ' '                                               02210000
           END-IF.                                                      02240000
                                                                        02250000
       EJECT                                                            02260000
      *                                                                 02800000
      ***************************************************************** 02810000
      *  MAIN PROCESSING OF THE INPUT FILE DATA.                        02820000
      ***************************************************************** 02830000
      *                                                                 02840000
       B200-PROCESS-DATA.                                               02850000
                                                                        02860000
           PERFORM M100-MOVE-DATA.                                      02870000
           PERFORM S100-UPDATE-TIMESTAMP.                               02880001
           PERFORM R100-READ-INPUT-FILE.                                02890000
                                                                        02900000
       EJECT                                                            02910000
      *                                                                 02920000
      ***************************************************************** 02930000
      *  END OF PROGRAM PROCESSING.                                     02940000
      ***************************************************************** 02950000
      *                                                                 02960000
       B300-END.                                                        02970000
                                                                        02980002
           CLOSE MEMO-UPDATE-FILE                                       03030000
                                                                        03050000
           DISPLAY 'RECS READ    = ' WS-IN-COUNT.                       03060000
           DISPLAY 'RECS UPDATED = ' WS-UPDATE-COUNT.                   03070000
           DISPLAY 'RECS READ BUT NOT FOUND IN TABLE = '                03071006
                                              WS-NOT-UPD-CNT.           03080006
       EJECT                                                            03090000
      *                                                                 03100000
      ***************************************************************** 03110000
      *  MOVE THE INPUT DATA TO THE DCLGEN FIELDS TO PREPARE FOR UPDATE 03120000
      ***************************************************************** 03130000
      *                                                                 03140000
       M100-MOVE-DATA.                                                  03150000
                                                                        03160000
           MOVE MEMO-VENDOR-ID         TO APT00001-VENDOR-ID.           03170004
           MOVE MEMO-INVOICE-ID        TO APT00001-INVOICE-ID.          03180004
                                                                        03190000
       EJECT                                                            03200000
      *                                                                 03210000
      ***************************************************************** 03220000
      *  DISPLAY MESSAGE IF THERE IS NO DATA IN THE INPUT FILE.         03230000
      ***************************************************************** 03240000
      *                                                                 03250000
       N100-NO-DATA.                                                    03260000
                                                                        03270000
           DISPLAY 'NO DATA TO UPDATE'.                                 03280000
                                                                        03290000
       EJECT                                                            03300000
      *                                                                 03310000
      ***************************************************************** 03320000
      *  READ THE INPUT FILE.                                           03330000
      ***************************************************************** 03340000
      *                                                                 03350000
       R100-READ-INPUT-FILE.                                            03360000
                                                                        03370000
           READ MEMO-UPDATE-FILE                                        03380000
               AT END SET INPUT-EOF TO TRUE.                            03390000
                                                                        03400000
           MOVE MEMO-UPDATE-REC TO MEMO-RECORD.                         03410000
                                                                        03420000
           IF NOT INPUT-EOF                                             03430000
              ADD +1  TO WS-IN-COUNT.                                   03440000
                                                                        03450000
       EJECT                                                            03460000
      *                                                                 03470000
      ***************************************************************** 03480000
      *  THIS UPDATES THE TIMESTAMP ON THE PS_A12_AP_MEMO TABLE FOR  *  03490000
      *  THE VENDOR/INVOICE ID THAT WAS PROCESSED.                   *  03500000
      ***************************************************************** 03510000
      *                                                                 03520000
       S100-UPDATE-TIMESTAMP.                                           03530001
           EXEC SQL                                                     03540000
               UPDATE APT_AP_MEMO                                       03550000
               SET KC_AP_MEMO_TMST  = CURRENT_TIMESTAMP                 03560000
               WHERE VENDOR_ID      = :APT00001-VENDOR-ID               03570003
                 AND INVOICE_ID     = :APT00001-INVOICE-ID              03580003
           END-EXEC.                                                    03590000
                                                                        03600000
           EVALUATE TRUE                                                03610000
               WHEN SQLCODE = ZERO                                      03620000
                    ADD +1 TO WS-UPDATE-COUNT                           03630001
               WHEN SQLCODE = +100                                      03640006
                    ADD +1 TO WS-NOT-UPD-CNT                            03640106
                    DISPLAY 'APT_AP_MEMO NOT UPDATED FOR:'              03640207
                    DISPLAY 'VENDOR ID  ' APT00001-VENDOR-ID            03640307
                    DISPLAY 'INVOICE ID ' APT00001-INVOICE-ID           03640407
               WHEN SQLCODE NOT = ZERO                                  03641001
                    DISPLAY 'VENDOR ID  ' APT00001-VENDOR-ID            03642004
                    DISPLAY 'INVOICE ID ' APT00001-INVOICE-ID           03642104
                    MOVE 'S100-UPDATE-TIMESTAMP'   TO AA-PARAGRAPH-NAME 03646001
                    MOVE 'UNSUCCESSFUL UPDATE'     TO AA-DB2-OPERATION  03647001
                    MOVE 'APT_AP_MEMO'             TO AA-DB2-TABLE-1    03648001
                    MOVE SPACES                    TO AA-DB2-TABLE-2    03649001
                    MOVE SPACES                    TO AA-DB2-TABLE-3    03649101
                    PERFORM Z999-DB2-ABEND                              03649201
           END-EVALUATE.                                                03770000
                                                                        03780000
      ***************************************************************** 03790001
      *     DB2 ABEND ROUTINE                                           03800001
      ***************************************************************** 03810001
       Z999-DB2-ABEND.                                                  03820001
                                                                        03830001
           DISPLAY AA-ABEND-LIT.                                        03840001
           DISPLAY AA-DB2-ERROR-LIT.                                    03850001
           DISPLAY AA-PROGRAM-LIT.                                      03860001
           DISPLAY AA-PARAGRAPH-LIT.                                    03870001
           DISPLAY AA-DB2-OPERATION-LIT.                                03880001
           DISPLAY AA-DB2-TABLE-1.                                      03890001
           DISPLAY AA-DB2-TABLE-2.                                      03900001
           DISPLAY AA-DB2-TABLE-3.                                      03910001
           SET AC-DB2-ERROR TO TRUE.                                    03920001
                                                                        03930001
           COPY DPPD004.                                                03940001
                                                                        03950001
           CALL 'ILBOABN0' USING ABEND-CODE.                            03960001
       EJECT                                                            03970001
