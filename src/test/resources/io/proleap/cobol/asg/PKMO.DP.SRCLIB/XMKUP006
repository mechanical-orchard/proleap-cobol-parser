       IDENTIFICATION DIVISION.                                         00010000
       PROGRAM-ID.      XMKUP006.                                       00020000
       AUTHOR.          LYNN FUHRMAN                                    00030000
       INSTALLATION.    KOHLS DEPARTMENT STORES.                        00040000
       DATE-WRITTEN.    10/16/2004.                                     00050000
       DATE-COMPILED.                                                   00060000
      ******************************************************************00070000
      **  XM DOMAIN PERM PRICING TABLES PURGE FOR:                      00080000
      **  XMT_PRCHG,  XMT_STR_GP_PRCHG,  XMT_PRCHG_MDSE, XMT_PRICG_GRID,00090000
      **     XMT_PRICG_GRID_DTL                                         00100000
      **                                                                00110000
      **  USE A CONTROL CARD FOR THE PURGE DATA DATE.                   00120000
      **  PURGE FROM XMT_STR_GP_PRCHG WHEN THE EFFECTIVE DATE IS        00130000
      **  EQUAL TO OR LESS THAN THE PURGE DATA DATE.  DELETE            00140000
      **  ALL ROWS OF THE CHILDREN ON XMT_PRCHG_MDSE, ALSO.             00150000
      **  IF, AFTER THE PURGE OF A STR GP ROW, THERE ARE NO STR GP      00160000
      **  ROWS FOR THE PARENT PRCHG ID, PURGE THE PARENT ON THE         00170000
      **  XMT_PRCHG TABLE. IF THE PRICE CHANGE IS CONTINUED CLEARANCE,  00180000
      **  OPEN A CURSOR AGAINST XMT_PRICG_GRID FOR THIS PRCHG_ID,       00180100
      **  DELETE ALL XMT_PRICG_GRID_DTL RECORDS FOR THE PRICG_GRID_ID,  00180200
      **  THEN DELETE THE CORRESPONDING XMT_PRICG_GRID ROWS.            00180300
      *  TABLES ACCESSED ARE:                                           00180400
      *      XMT_PRCHG          - PRICE CHANGE TABLE                    00180500
      *      XMT_STR_GP_PRCHG   - STORE GROUP PRICE CHANGE TABLE        00180600
      *      XMT_PRCHG_MDSE     - PRICE CHANGE MERCHANDISE TABLE        00180700
      *      TCKRSTCNTL - DB2 CHECKPOINT RESTART CONTROL                00180800
      *  TABLES DELETED FROM ARE:                                       00180900
      *      XMT_PRCHG          - PRICE CHANGE TABLE                    00181000
      *      XMT_STR_GP_PRCHG   - STORE GROUP PRICE CHANGE TABLE        00182000
      *      XMT_PRCHG_MDSE     - PRICE CHANGE MERCHANDISE TABLE        00183000
      *      XMT_PRICG_GRID     - PRICE CHANGE GRID TABLE               00184000
      *      XMT_PRICG_GRID_DTL - PRICE CHANGE GRID DETAIL TABLE        00185000
      *      TCKRSTCNTL - DB2 CHECKPOINT RESTART CONTROL                00186000
      ******************************************************************00187000
      **  CHANGE LOG                                                    00188000
      **  WHEN        WHO            WHAT                               00189000
      **  2004/10/16  LYNN FUHRMAN   NEW PROGRAM                        00190000
      **  2004/12/02  D.THEEL        ADDED LOGIC TO ALSO PURGE FROM     00200000
      **                             THE GRID TABLES IF CONTINUED       00210000
      **                             CLEARANCE PRICE CHANGE.            00220000
      **  2010/02/04  COGNIZANT      ADDED LOGIC TO ALSO PURGE FROM     00230000
      **              COGN           MK2 AND FNL MARK TYPES IF IT       00231000
      **                             IS GREATER THAN 1 MONTH OLD        00232000
      **  2016/03/02  COGNIZANT      MODIFIED PROGRAM TO USE SINGLE     00233000
      **              057934         CURSOR INSTEAD OF TWO CURSORS AND  00233100
      **                             HANDLE CONDITIONS IN PROGRAM       00233200
      ******************************************************************00233300
       ENVIRONMENT DIVISION.                                            00233400
       CONFIGURATION SECTION.                                           00233500
       SOURCE-COMPUTER.        IBM-3090.                                00233600
       OBJECT-COMPUTER.        IBM-3090.                                00233700
       INPUT-OUTPUT SECTION.                                            00233800
       FILE-CONTROL.                                                    00233900
                                                                        00234000
           SELECT CONTROL-CARD-PURGE-DATE                               00235000
                  ASSIGN TO INP01.                                      00236000
                                                                        00237000
COGN       SELECT CONTROL-CARD-PURGE-DATE1                              00238000
COGN              ASSIGN TO INP02.                                      00239000
                                                                        00240000
       DATA DIVISION.                                                   00250000
       FILE SECTION.                                                    00260000
                                                                        00270000
       FD  CONTROL-CARD-PURGE-DATE                                      00280000
           RECORDING MODE F                                             00290000
           BLOCK CONTAINS 0 RECORDS                                     00300000
           LABEL RECORDS ARE OMITTED                                    00310000
           DATA RECORD IS CONTROL-CARD-PURGE-REC.                       00320000
       01  CONTROL-CARD-PURGE-REC          PIC X(080).                  00330000
                                                                        00340000
COGN   FD  CONTROL-CARD-PURGE-DATE1                                     00350000
COGN       RECORDING MODE F                                             00360000
COGN       BLOCK CONTAINS 0 RECORDS                                     00370000
COGN       LABEL RECORDS ARE OMITTED                                    00380000
COGN       DATA RECORD IS CONTROL-CARD-PURGE-REC1.                      00390000
COGN   01  CONTROL-CARD-PURGE-REC1         PIC X(080).                  00400000
                                                                        00410000
       WORKING-STORAGE SECTION.                                         00420000
      ******************************************************************00430000
      **SWITCHES                                                        00440000
      ******************************************************************00450000
       01  PS-PROGRAM-SWITCHES.                                         00460000
           05  PS-EOF-CC-PURGE-SW           PIC X(01)   VALUE 'N'.      00470000
               88  PS-EOF-CC-PURGE                      VALUE 'Y'.      00480000
               88  PS-NOT-EOF-CC-PURGE                  VALUE 'N'.      00490000
           05  PS-EOF-CC-PURGE-SW1          PIC X(01)   VALUE 'N'.      00500000
               88  PS-EOF-CC-PURGE1                     VALUE 'Y'.      00510000
               88  PS-NOT-EOF-CC-PURGE1                 VALUE 'N'.      00520000
           05  PS-EOF-STR-GP-CSR-SW         PIC X(01)   VALUE 'N'.      00530000
               88  PS-EOF-STR-GP-CSR                    VALUE 'Y'.      00540000
               88  PS-NOT-EOF-STR-GP-CSR                VALUE 'N'.      00550000
057934*    05  PS-EOF-STR-GP-MK2FNL-CSR-SW  PIC X(01)   VALUE 'N'.      00551000
057934*        88  PS-EOF-STR-GP-MK2FNL-CSR             VALUE 'Y'.      00552000
057934*        88  PS-NOT-EOF-STR-GP-MK2FNL-CSR         VALUE 'N'.      00553000
           05  PS-STR-GP-EXISTS-SW          PIC X(01)   VALUE 'N'.      00554000
               88  PS-STR-GP-EXISTS                     VALUE 'Y'.      00555000
               88  PS-STR-GP-DOESNT-EXIST               VALUE 'N'.      00556000
           05  PS-EOF-GRID-CSR-SW           PIC X(01)   VALUE 'N'.      00557000
               88  PS-EOF-GRID-CSR                      VALUE 'Y'.      00558000
               88  PS-NOT-EOF-GRID-CSR                  VALUE 'N'.      00559000
                                                                        00560000
      ******************************************************************00570000
      **PROGRAM CONSTANTS                                               00580000
      ******************************************************************00590000
       01  PC-PROGRAM-CONSTANTS.                                        00600000
           05  PC-PGM-NAME                PIC X(08)   VALUE 'XMKUP006'. 00610000
           05  PC-JOB-NAME                PIC X(08)   VALUE 'XMK125'.   00620000
           05  PC-MAX-RETRIES             PIC S9(04)  COMP SYNC         00630000
                                                      VALUE +3.         00640000
           05  PC-CONTROL-CARDS.                                        00650000
               10  PC-CC-PURGE-DATE       PIC X(10).                    00660000
               10  FILLER REDEFINES PC-CC-PURGE-DATE.                   00670000
                   15  PC-CC-CCYY         PIC X(04).                    00680000
                   15  FILLER             PIC X(01).                    00690000
                   15  PC-CC-MM           PIC X(02).                    00700000
                   15  FILLER             PIC X(01).                    00710000
                   15  PC-CC-DD           PIC X(02).                    00720000
                                                                        00730000
COGN       05  PC-CONTROL-CARDS1.                                       00740000
COGN           10  PC-CC-PURGE-DATE1      PIC X(10).                    00750000
COGN           10  FILLER REDEFINES PC-CC-PURGE-DATE1.                  00760000
COGN               15  PC-CC-CCYY1        PIC X(04).                    00770000
COGN               15  FILLER             PIC X(01).                    00780000
COGN               15  PC-CC-MM1          PIC X(02).                    00790000
COGN               15  FILLER             PIC X(01).                    00791000
COGN               15  PC-CC-DD1          PIC X(02).                    00792000
                                                                        00793000
      ******************************************************************00794000
      **PROGRAM VARIABLES                                               00795000
      ******************************************************************00796000
       01  PV-PROGRAM-COUNTERS.                                         00797000
057934     05  PV-TOTAL-FETCH-COUNT       PIC 9(09)   VALUE ZEROS.      00798000
           05  PV-FETCH-STR-GP-CNT        PIC 9(09)   VALUE ZEROS.      00799000
           05  PV-FETCH-GRID-CNT          PIC 9(09)   VALUE ZEROS.      00800000
           05  PV-DEL-PRCHG-CNT           PIC 9(09)   VALUE ZEROS.      00810000
           05  PV-DEL-STR-GP-CNT          PIC 9(09)   VALUE ZEROS.      00820000
           05  PV-DEL-MDSE-CNT            PIC 9(09)   VALUE ZEROS.      00830000
           05  PV-DEL-PRICG-GRID-DTL      PIC 9(09)   VALUE ZEROS.      00840000
           05  PV-DEL-PRICG-GRID          PIC 9(09)   VALUE ZEROS.      00850000
           05  PV-COMMIT-CNT              PIC 9(09)   VALUE ZEROS.      00860000
           05  PV-RETRY-CNT               PIC S9(04)  VALUE ZEROS.      00870000
       01  PV-ABEND-FIELDS.                                             00880000
           05  PV-ABEND-CODE              PIC S9(4) VALUE ZERO.         00890000
           05  PV-PARAGRAPH-NAME          PIC X(30) VALUE SPACE.        00900000
           05  PV-OPERATION-MSG-1         PIC X(40) VALUE SPACE.        00910000
           05  PV-OPERATION-MSG-2         PIC X(40) VALUE SPACE.        00920000
       01  PV-MISC-FIELDS.                                              00930000
           05  PV-COMMIT-TIMESTAMP        PIC  X(26)   VALUE SPACES.    00940000
           05  PV-CURRENT-TIMESTAMP       PIC  X(26)   VALUE SPACES.    00950000
                                                                        00960000
      ******************************************************************00970000
      **COPYBOOKS                                                       00980000
      ******************************************************************00990000
      ***VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004        01000000
           COPY DPWS004.                                                01010000
                                                                        01020000
      ***DB2 ABEND COPYBOOK                                             01030000
           COPY DPWS900.                                                01040000
                                                                        01050000
      ***DB2 MESSAGE AREA                                               01060000
           COPY SQLCA2.                                                 01070000
                                                                        01080000
      ***DB2 COMMUNICATIONS AREA                                        01090000
           EXEC SQL                                                     01100000
                INCLUDE SQLCA                                           01110000
           END-EXEC.                                                    01120000
                                                                        01130000
      ******************************************************************01140000
      **TABLES                                                          01150000
      ******************************************************************01160000
      ***TABLE XMT_PRCHG                                                01170000
           EXEC SQL                                                     01180000
                INCLUDE XMT00009                                        01190000
           END-EXEC.                                                    01200000
                                                                        01210000
      ***TABLE XMT_STR_GP_PRCHG                                         01220000
           EXEC SQL                                                     01230000
                INCLUDE XMT00010                                        01240000
           END-EXEC.                                                    01250000
                                                                        01260000
      ***TABLE XMT_PRCHG_MDSE                                           01270000
           EXEC SQL                                                     01280000
                INCLUDE XMT00011                                        01290000
           END-EXEC.                                                    01300000
                                                                        01310000
      ***TABLE XMT_PRICG_GRID                                           01320000
           EXEC SQL                                                     01330000
                INCLUDE XMT00012                                        01340000
           END-EXEC.                                                    01350000
                                                                        01360000
      ***TABLE XMT_PRICG_GRID_DTL                                       01370000
           EXEC SQL                                                     01380000
                INCLUDE XMT00013                                        01390000
           END-EXEC.                                                    01400000
                                                                        01410000
      *** COBOL DECLARATIONS FOR THE CHECKPOINT RESTART CONTROL TABLE   01420000
           EXEC SQL                                                     01430000
               INCLUDE TCKRSTCN                                         01440000
           END-EXEC.                                                    01450000
                                                                        01460000
                                                                        01470000
      ******************************************************************01471000
      **CURSORS                                                         01472000
      ******************************************************************01473000
      ***XMT_STR_GP_CSR                                                 01474000
           EXEC SQL                                                     01475000
               DECLARE XMT_STR_GP_CSR CURSOR WITH HOLD FOR              01475100
057934            SELECT DISTINCT S.PRCHG_ID                            01475200
057934                  ,S.STR_GP_TYP_CDE                               01475300
057934                  ,P.EVNT_CTG_CDE                                 01475400
057934                  ,P.PRCHG_TYP_CDE                                01475500
057934                  ,S.PRCHG_EFF_DTE                                01475600
057934*                 ,P.EVNT_CTG_CDE                                 01475700
                   FROM  XMT_PRCHG P                                    01475800
                        ,XMT_STR_GP_PRCHG S                             01475900
                   WHERE S.PRCHG_EFF_DTE <= :PC-CC-PURGE-DATE1          01476000
                     AND P.PRCHG_ID       = S.PRCHG_ID                  01476100
                   ORDER BY S.PRCHG_ID                                  01476200
                           ,S.STR_GP_TYP_CDE                            01476300
057934*                    ,S.STR_GP_ID                                 01476400
                   FOR FETCH ONLY                                       01476500
           END-EXEC.                                                    01476600
                                                                        01476700
                                                                        01476800
COGN  ***XMT_STR_GP_CSR1 FOR MK2 AND FNL                                01476900
057934*    EXEC SQL                                                     01477000
057934*        DECLARE XMT_STR_GP_MK2FNL_CSR CURSOR WITH HOLD FOR       01478000
057934*           SELECT S.PRCHG_ID                                     01479000
057934*                 ,S.STR_GP_TYP_CDE                               01480000
057934*                 ,S.STR_GP_ID                                    01480100
057934*                 ,P.EVNT_CTG_CDE                                 01480200
057934*            FROM  XMT_PRCHG P                                    01480300
057934*                 ,XMT_STR_GP_PRCHG S                             01480400
057934*            WHERE S.PRCHG_EFF_DTE <= :PC-CC-PURGE-DATE1          01480500
057934*              AND P.PRCHG_ID       = S.PRCHG_ID                  01480600
057934*              AND P.PRCHG_TYP_CDE  IN ('MK2', 'FNL')             01480700
057934*            ORDER BY S.PRCHG_ID                                  01480800
057934*                    ,S.STR_GP_TYP_CDE                            01480900
057934*                    ,S.STR_GP_ID                                 01481000
057934*            FOR FETCH ONLY                                       01481100
057934*    END-EXEC.                                                    01481200
                                                                        01481300
      ***XMT_PRICG_GRID_CSR                                             01481400
           EXEC SQL                                                     01481500
               DECLARE XMT_PRICG_GRID_CSR CURSOR FOR                    01481600
                  SELECT PRICG_GRID_ID                                  01481700
                   FROM  XMT_PRICG_GRID                                 01481800
                   WHERE PRCHG_ID = :XMT00009-PRCHG-ID                  01481900
                  ORDER BY PRICG_GRID_ID                                01482000
                  FOR FETCH ONLY                                        01483000
                  WITH UR                                               01484000
           END-EXEC.                                                    01485000
      ***CAN HAVE DIRTY READ BECAUSE WE ARE DELETING HISTORY            01486000
      ***************************************************************** 01487000
       PROCEDURE DIVISION.                                              01488000
      ***************************************************************** 01489000
                                                                        01490000
           DISPLAY 'BEGIN MESSAGES FOR XMKUP006'.                       01500000
           PERFORM 8000-INITIALIZE.                                     01510000
                                                                        01520000
           PERFORM 8100-OPEN-CURSOR.                                    01530000
                                                                        01540000
           PERFORM 1000-FETCH-STR-GP-CSR                                01550000
             UNTIL PS-EOF-STR-GP-CSR.                                   01560000
                                                                        01570000
           PERFORM 8200-CLOSE-CURSOR.                                   01580000
                                                                        01590000
           PERFORM 7200-COMMIT-DATA.                                    01600000
                                                                        01610000
           PERFORM 9200-DISPLAY-STATISTICS.                             01620000
                                                                        01630000
057934*    MOVE ZERO TO PV-FETCH-GRID-CNT.                              01640000
057934*    MOVE ZERO TO PV-DEL-PRCHG-CNT.                               01650000
057934*    MOVE ZERO TO PV-DEL-STR-GP-CNT.                              01660000
057934*    MOVE ZERO TO PV-DEL-MDSE-CNT.                                01670000
057934*    MOVE ZERO TO PV-DEL-PRICG-GRID-DTL.                          01670100
057934*    MOVE ZERO TO PV-DEL-PRICG-GRID.                              01670200
057934*    MOVE ZERO TO PV-COMMIT-CNT.                                  01670300
057934*                                                                 01670400
057934*    PERFORM 8300-OPEN-CURSOR.                                    01670500
057934*                                                                 01670600
057934*    PERFORM 1100-FETCH-STR-GP-MK2FNL-CSR                         01670700
057934*      UNTIL PS-EOF-STR-GP-MK2FNL-CSR.                            01670800
057934*                                                                 01670900
057934*    PERFORM 8400-CLOSE-CURSOR.                                   01671000
057934*                                                                 01672000
057934*    PERFORM 7200-COMMIT-DATA.                                    01673000
057934*                                                                 01674000
057934*    DISPLAY 'DISPLAY STATISTICS FOR MK2FNL'.                     01675000
057934*                                                                 01676000
057934*    PERFORM 9200-DISPLAY-STATISTICS.                             01677000
057934*                                                                 01678000
           DISPLAY 'END   MESSAGES FOR XMKUP006'.                       01679000
                                                                        01679100
           GOBACK.                                                      01679200
                                                                        01679300
                                                                        01679400
      ******************************************************************01679500
      **PROCESSES STR GP PRCHG CURSOR                                   01679600
      ******************************************************************01679700
       1000-FETCH-STR-GP-CSR.                                           01679800
           MOVE '1000-FETCH-STR-GP-CSR ' TO PV-PARAGRAPH-NAME.          01679900
                                                                        01680000
           INITIALIZE PV-RETRY-CNT.                                     01690000
           PERFORM WITH TEST AFTER                                      01700000
             UNTIL SQLCODE = ZERO                                       01710000
                OR SQLCODE = +100                                       01720000
                OR PV-RETRY-CNT > PC-MAX-RETRIES                        01730000
                   EXEC SQL                                             01740000
                       FETCH XMT_STR_GP_CSR                             01750000
057934                 INTO  :XMT00010-PRCHG-ID                         01760000
057934                     , :XMT00010-STR-GP-TYP-CDE                   01770000
057934                     , :XMT00009-EVNT-CTG-CDE                     01780000
057934                     , :XMT00009-PRCHG-TYP-CDE                    01790000
057934                     , :XMT00010-PRCHG-EFF-DTE                    01800000
                   END-EXEC                                             01810000
                                                                        01820000
                   EVALUATE TRUE                                        01830000
                       WHEN SQLCODE = ZERO                              01840000
057934                      ADD 1 TO PV-TOTAL-FETCH-COUNT               01850000
057934                      IF XMT00009-PRCHG-TYP-CDE = 'MK2' OR 'FNL'  01860000
057934                      ADD 1 TO PV-FETCH-STR-GP-CNT                01870000
057934                      PERFORM 2000-DELETE-MDSE-ROWS               01880000
057934                      PERFORM 2100-DELETE-STR-GP-ROW              01890000
057934                      PERFORM 2200-CHECK-PRCHG-TBL                01900000
057934                      IF PS-STR-GP-DOESNT-EXIST                   01910000
057934                         PERFORM 2300-DELETE-PRCHG-ROW            01911000
057934                         IF XMT00009-EVNT-CTG-CDE = 'CON' AND     01912000
057934                            XMT00010-PRCHG-EFF-DTE <=             01913000
057934                               PC-CC-PURGE-DATE                   01914000
057934                              PERFORM 3000-PROCESS-CON            01915000
057934                         END-IF                                   01916000
057934                       END-IF                                     01917000
057934                      ELSE                                        01918000
057934                        IF XMT00010-PRCHG-EFF-DTE <=              01919000
057934                               PC-CC-PURGE-DATE                   01920000
057934                      ADD 1 TO PV-FETCH-STR-GP-CNT                01920100
057934                      PERFORM 2000-DELETE-MDSE-ROWS               01920200
057934                      PERFORM 2100-DELETE-STR-GP-ROW              01920300
057934                      PERFORM 2200-CHECK-PRCHG-TBL                01920400
057934                      IF PS-STR-GP-DOESNT-EXIST                   01920500
057934                         PERFORM 2300-DELETE-PRCHG-ROW            01920600
057934                         IF XMT00009-EVNT-CTG-CDE = 'CON'         01920700
057934                              PERFORM 3000-PROCESS-CON            01920800
057934                         END-IF                                   01920900
057934                        END-IF                                    01921000
057934                      END-IF                                      01921100
057934                      END-IF                                      01921200
057934*                     ADD 1 TO PV-FETCH-STR-GP-CNT                01921300
057934*                     PERFORM 2000-DELETE-MDSE-ROWS               01921400
057934*                     PERFORM 2100-DELETE-STR-GP-ROW              01921500
057934*                     PERFORM 2200-CHECK-PRCHG-TBL                01921600
057934*                     IF PS-STR-GP-DOESNT-EXIST                   01921700
057934*                        PERFORM 2300-DELETE-PRCHG-ROW            01921800
057934*                        IF XMT00009-EVNT-CTG-CDE = 'CON'         01921900
057934*                             PERFORM 3000-PROCESS-CON            01922000
057934*                        END-IF                                   01923000
057934*                     END-IF                                      01924000
                       WHEN SQLCODE = +100                              01925000
                            SET PS-EOF-STR-GP-CSR TO TRUE               01926000
                       WHEN SQLCODE = -904                              01927000
                       WHEN SQLCODE = -911                              01928000
                       WHEN SQLCODE = -913                              01929000
COGN                    ADD +1 TO PV-RETRY-CNT                          01930000
                       WHEN SQLWARN NOT = SPACES                        01940000
                       WHEN SQLCODE NOT = ZERO                          01950000
                            MOVE 'FETCH STORE GROUP CURSOR PROBLEM'     01960000
                                              TO  PV-OPERATION-MSG-1    01970000
                            PERFORM 9200-DISPLAY-STATISTICS             01980000
                            PERFORM 9900-SQL-ABEND-ROUTINE              01990000
                   END-EVALUATE                                         02000000
           END-PERFORM.                                                 02010000
                                                                        02020000
           IF PV-RETRY-CNT > PC-MAX-RETRIES                             02030000
               MOVE 'FETCH RETRIES EXCEEDED      '                      02040000
                                      TO  PV-OPERATION-MSG-1            02050000
               PERFORM 9200-DISPLAY-STATISTICS                          02060000
               PERFORM 9900-SQL-ABEND-ROUTINE                           02070000
           END-IF.                                                      02080000
                                                                        02090000
                                                                        02100000
057934******************************************************************02110000
057934**PROCESSES STR GP PRCHG MK2FNL CURSOR                            02120000
057934******************************************************************02130000
057934*1100-FETCH-STR-GP-MK2FNL-CSR.                                    02131000
057934*    MOVE '1100-FETCH-STR-GP-MK2FNL-CSR ' TO PV-PARAGRAPH-NAME.   02132000
057934*                                                                 02133000
057934*    INITIALIZE PV-RETRY-CNT.                                     02134000
057934*    PERFORM WITH TEST AFTER                                      02135000
057934*      UNTIL SQLCODE = ZERO                                       02136000
057934*         OR SQLCODE = +100                                       02137000
057934*         OR PV-RETRY-CNT > PC-MAX-RETRIES                        02138000
057934*            EXEC SQL                                             02139000
057934*                FETCH XMT_STR_GP_MK2FNL_CSR                      02139100
057934*                INTO  :XMT00010-PRCHG-ID                         02139200
057934*                    , :XMT00010-STR-GP-TYP-CDE                   02139300
057934*                    , :XMT00010-STR-GP-ID                        02139400
057934*                    , :XMT00009-EVNT-CTG-CDE                     02139500
057934*            END-EXEC                                             02139600
057934*                                                                 02139700
057934*            EVALUATE TRUE                                        02139800
057934*                WHEN SQLCODE = ZERO                              02139900
057934*                     ADD 1 TO PV-FETCH-STR-GP-CNT                02140000
057934*                     PERFORM 2000-DELETE-MDSE-ROWS               02140100
057934*                     PERFORM 2100-DELETE-STR-GP-ROW              02140200
057934*                     PERFORM 2200-CHECK-PRCHG-TBL                02140300
057934*                     IF PS-STR-GP-DOESNT-EXIST                   02140400
057934*                        PERFORM 2300-DELETE-PRCHG-ROW            02140500
057934*                        IF XMT00009-EVNT-CTG-CDE = 'CON'         02140600
057934*                             PERFORM 3000-PROCESS-CON            02140700
057934*                        END-IF                                   02140800
057934*                     END-IF                                      02140900
057934*                WHEN SQLCODE = +100                              02141000
057934*                     SET PS-EOF-STR-GP-MK2FNL-CSR TO TRUE        02141100
057934*                WHEN SQLCODE = -904                              02141200
057934*                WHEN SQLCODE = -911                              02141300
057934*                WHEN SQLCODE = -913                              02141400
057934*                 ADD +1 TO PV-RETRY-CNT                          02141500
057934*                WHEN SQLWARN NOT = SPACES                        02141600
057934*                WHEN SQLCODE NOT = ZERO                          02141700
057934*                     MOVE 'FETCH STORE GROUP MK2 CURSOR PROBLEM' 02141800
057934*                                       TO  PV-OPERATION-MSG-1    02141900
057934*                     PERFORM 9200-DISPLAY-STATISTICS             02142000
057934*                     PERFORM 9900-SQL-ABEND-ROUTINE              02142100
057934*            END-EVALUATE                                         02142200
057934*    END-PERFORM.                                                 02142300
057934*                                                                 02142400
057934*    IF PV-RETRY-CNT > PC-MAX-RETRIES                             02142500
057934*        MOVE 'FETCH MK2FNL RETRIES EXCEEDED      '               02142600
057934*                               TO  PV-OPERATION-MSG-1            02142700
057934*        PERFORM 9200-DISPLAY-STATISTICS                          02142800
057934*        PERFORM 9900-SQL-ABEND-ROUTINE                           02142900
057934*    END-IF.                                                      02143000
                                                                        02143100
      ***************************************************************** 02143200
      **DELETE ROW(S) FROM TABLE XMT_PRCHG_MDSE                         02143300
      ***************************************************************** 02143400
       2000-DELETE-MDSE-ROWS.                                           02143500
           MOVE '2000-DELETE-MDSE-ROWS        ' TO PV-PARAGRAPH-NAME.   02143600
                                                                        02143700
           PERFORM 7000-DB2-COMMIT-CHECK.                               02143800
                                                                        02143900
           MOVE XMT00010-PRCHG-ID        TO  XMT00011-PRCHG-ID.         02144000
           MOVE XMT00010-STR-GP-TYP-CDE  TO  XMT00011-STR-GP-TYP-CDE.   02145000
057934*    MOVE XMT00010-STR-GP-ID       TO  XMT00011-STR-GP-ID.        02146000
                                                                        02147000
           INITIALIZE PV-RETRY-CNT.                                     02148000
           PERFORM WITH TEST AFTER                                      02149000
             UNTIL SQLCODE = ZERO                                       02150000
                OR SQLCODE = +100                                       02160000
                OR PV-RETRY-CNT > PC-MAX-RETRIES                        02170000
                   EXEC SQL                                             02180000
                      DELETE FROM XMT_PRCHG_MDSE                        02190000
                      WHERE  PRCHG_ID        = :XMT00011-PRCHG-ID       02200000
                        AND  STR_GP_TYP_CDE  = :XMT00011-STR-GP-TYP-CDE 02210000
057934*                 AND  STR_GP_ID       = :XMT00011-STR-GP-ID      02220000
                   END-EXEC                                             02230000
                                                                        02240000
                   EVALUATE TRUE                                        02250000
                      WHEN SQLCODE = ZERO                               02260000
                         ADD SQLERRD(3) TO PV-DEL-MDSE-CNT              02270000
                      WHEN SQLCODE = +100                               02280000
COGN                     CONTINUE                                       02290000
                      WHEN SQLCODE = -904                               02300000
                      WHEN SQLCODE = -911                               02310000
                      WHEN SQLCODE = -913                               02320000
COGN                    ADD +1 TO PV-RETRY-CNT                          02330000
                      WHEN OTHER                                        02340000
                         DISPLAY 'CANT DELETE FROM XMT_PRCHG_MDSE '     02350000
                         DISPLAY 'PRCHG-ID  : ' XMT00011-PRCHG-ID       02360000
                         DISPLAY 'STR-GP-TYP: ' XMT00011-STR-GP-TYP-CDE 02370000
                         DISPLAY 'STR-GP-ID : ' XMT00011-STR-GP-ID      02380000
                         PERFORM 9200-DISPLAY-STATISTICS                02390000
                         PERFORM 9900-SQL-ABEND-ROUTINE                 02400000
                   END-EVALUATE                                         02410000
           END-PERFORM.                                                 02420000
                                                                        02430000
           IF PV-RETRY-CNT > PC-MAX-RETRIES                             02440000
               MOVE 'DEL TO XMT_PRCHG_MDSE TBL RETRY EXCEEDED'          02450000
                                      TO  PV-OPERATION-MSG-1            02460000
               PERFORM 9200-DISPLAY-STATISTICS                          02470000
               PERFORM 9900-SQL-ABEND-ROUTINE                           02471000
           END-IF.                                                      02472000
                                                                        02473000
                                                                        02474000
      ***************************************************************** 02475000
      **DELETE ROW FROM TABLE XMT_STR_GP_PRCHG                          02476000
      ***************************************************************** 02477000
       2100-DELETE-STR-GP-ROW.                                          02478000
           MOVE '2100-DELETE-STR-GP-ROW       ' TO PV-PARAGRAPH-NAME.   02479000
                                                                        02480000
           PERFORM 7000-DB2-COMMIT-CHECK.                               02490000
                                                                        02500000
           INITIALIZE PV-RETRY-CNT.                                     02510000
           PERFORM WITH TEST AFTER                                      02520000
             UNTIL SQLCODE = ZERO                                       02530000
                OR SQLCODE = +100                                       02540000
                OR PV-RETRY-CNT > PC-MAX-RETRIES                        02550000
                   EXEC SQL                                             02560000
                      DELETE FROM XMT_STR_GP_PRCHG                      02570000
                       WHERE PRCHG_ID        = :XMT00010-PRCHG-ID       02580000
                         AND STR_GP_TYP_CDE  = :XMT00010-STR-GP-TYP-CDE 02590000
057934*                  AND STR_GP_ID       = :XMT00010-STR-GP-ID      02600000
                   END-EXEC                                             02610000
                                                                        02620000
                   EVALUATE TRUE                                        02630000
                      WHEN SQLCODE = ZERO                               02640000
                         ADD SQLERRD(3) TO PV-DEL-STR-GP-CNT            02650000
                      WHEN SQLCODE = +100                               02660000
COGN                     CONTINUE                                       02670000
                      WHEN SQLCODE = -904                               02680000
                      WHEN SQLCODE = -911                               02690000
                      WHEN SQLCODE = -913                               02700000
COGN                    ADD +1 TO PV-RETRY-CNT                          02710000
                      WHEN OTHER                                        02720000
                         DISPLAY 'CANT DELETE FROM XMT_STR_GP_PRCHG'    02730000
                         DISPLAY 'PRCHG-ID     : ' XMT00010-PRCHG-ID    02740000
                         DISPLAY 'STR-GP-TYP-CD: '                      02750000
                                                 XMT00010-STR-GP-TYP-CDE02751000
                         DISPLAY 'STR-GP-ID    : ' XMT00010-STR-GP-ID   02752000
                         PERFORM 9200-DISPLAY-STATISTICS                02753000
                         PERFORM 9900-SQL-ABEND-ROUTINE                 02754000
                   END-EVALUATE                                         02755000
           END-PERFORM.                                                 02756000
                                                                        02757000
           IF PV-RETRY-CNT > PC-MAX-RETRIES                             02758000
              MOVE 'DEL TO XMT_STR_GP TBL RETRIES EXCEEDED  '           02759000
                                     TO  PV-OPERATION-MSG-1             02760000
              PERFORM 9200-DISPLAY-STATISTICS                           02770000
              PERFORM 9900-SQL-ABEND-ROUTINE                            02780000
           END-IF.                                                      02790000
                                                                        02800000
                                                                        02810000
      ***************************************************************** 02820000
      * CHECK XMT_PRCHG TABLE PARENT FOR EXISTANCE OF ANY CHILDREN      02830000
      ***************************************************************** 02840000
       2200-CHECK-PRCHG-TBL.                                            02850000
           MOVE '2200-CHECK-PRCHG-TBL         ' TO PV-PARAGRAPH-NAME.   02860000
           SET   PS-STR-GP-DOESNT-EXIST TO TRUE.                        02870000
                                                                        02880000
           INITIALIZE PV-RETRY-CNT.                                     02890000
           PERFORM WITH TEST AFTER                                      02900000
             UNTIL SQLCODE = ZERO                                       02910000
                OR SQLCODE = +100                                       02920000
                OR PV-RETRY-CNT > PC-MAX-RETRIES                        02921000
                   EXEC SQL                                             02922000
                        SELECT 'Y'                                      02923000
                          INTO :PS-STR-GP-EXISTS-SW                     02924000
                          FROM  XMT_STR_GP_PRCHG                        02925000
                        WHERE   PRCHG_ID        =  :XMT00010-PRCHG-ID   02926000
                        FETCH   FIRST 1 ROWS ONLY                       02927000
                   END-EXEC                                             02928000
                                                                        02929000
                   EVALUATE TRUE                                        02930000
                      WHEN SQLCODE = ZERO                               02940000
                      WHEN SQLCODE = +100                               02950000
COGN                     CONTINUE                                       02960000
                      WHEN SQLCODE = -904                               02970000
                      WHEN SQLCODE = -911                               02980000
                      WHEN SQLCODE = -913                               02990000
COGN                    ADD +1 TO PV-RETRY-CNT                          03000000
                      WHEN OTHER                                        03010000
                         DISPLAY 'PRCHG_ID NOT FOUND ON XMT_PRCHG  '    03020000
                         DISPLAY 'PRCHG-ID: ' XMT00010-PRCHG-ID         03030000
                         PERFORM 9200-DISPLAY-STATISTICS                03040000
                         PERFORM 9900-SQL-ABEND-ROUTINE                 03050000
                   END-EVALUATE                                         03060000
           END-PERFORM.                                                 03070000
                                                                        03080000
           IF PV-RETRY-CNT > PC-MAX-RETRIES                             03090000
              MOVE 'COUNT FROM XMT_PRCHG RETRIES EXCEEDED   '           03100000
                                     TO  PV-OPERATION-MSG-1             03110000
              PERFORM 9200-DISPLAY-STATISTICS                           03120000
              PERFORM 9900-SQL-ABEND-ROUTINE                            03130000
           END-IF.                                                      03140000
                                                                        03150000
                                                                        03160000
      ****************************************************************  03170000
      *DELETE FROM XMT_PRCHG TABLE ROWS WITH NO CHILDREN                03180000
      ****************************************************************  03190000
       2300-DELETE-PRCHG-ROW.                                           03200000
           MOVE '2300-DELETE-PRCHG-ROW       ' TO PV-PARAGRAPH-NAME.    03210000
                                                                        03220000
           PERFORM 7000-DB2-COMMIT-CHECK.                               03230000
                                                                        03240000
           MOVE XMT00010-PRCHG-ID        TO  XMT00009-PRCHG-ID.         03250000
           INITIALIZE PV-RETRY-CNT.                                     03260000
           PERFORM WITH TEST AFTER                                      03261000
             UNTIL SQLCODE = ZERO                                       03262000
                OR SQLCODE = +100                                       03263000
                OR PV-RETRY-CNT > PC-MAX-RETRIES                        03264000
                   EXEC SQL                                             03265000
                        DELETE  FROM XMT_PRCHG                          03266000
                        WHERE   PRCHG_ID        =  :XMT00009-PRCHG-ID   03267000
                   END-EXEC                                             03268000
                                                                        03269000
                   EVALUATE TRUE                                        03270000
                      WHEN SQLCODE = ZERO                               03280000
                         ADD 1 TO PV-DEL-PRCHG-CNT                      03290000
                      WHEN SQLCODE = +100                               03300000
COGN                     CONTINUE                                       03310000
                      WHEN SQLCODE = -904                               03320000
                      WHEN SQLCODE = -911                               03330000
                      WHEN SQLCODE = -913                               03340000
COGN                    ADD +1 TO PV-RETRY-CNT                          03350000
                      WHEN OTHER                                        03360000
                         DISPLAY 'CANT DELETE FROM XMT_PRCHG   '        03370000
                         DISPLAY 'PRCHG-ID: ' XMT00009-PRCHG-ID         03380000
                         PERFORM 9200-DISPLAY-STATISTICS                03390000
                         PERFORM 9900-SQL-ABEND-ROUTINE                 03400000
                   END-EVALUATE                                         03410000
           END-PERFORM.                                                 03420000
                                                                        03421000
           IF PV-RETRY-CNT > PC-MAX-RETRIES                             03422000
              MOVE 'DELETE FROM XMT_PRCHG RETRIES EXCEEDED  '           03423000
                                     TO  PV-OPERATION-MSG-1             03424000
              PERFORM 9200-DISPLAY-STATISTICS                           03425000
              PERFORM 9900-SQL-ABEND-ROUTINE                            03426000
           END-IF.                                                      03427000
                                                                        03428000
                                                                        03429000
      ****************************************************************  03430000
      * IF CONTINUED CLEARANCE AND WE HAVE DELETED THE XMT_PRCHG ROW,   03440000
      * NOW WE NEED TO DELETE ALL ASSOCIATED ROWS FROM THE GRID AND     03450000
      * GRID DETAIL TABLES.  WE WILL USE THE PRCHG ID TO GET THE        03450100
      * ASSOCIATED GRID IDS, THEN USE THE GRID ID TO PURGE THE          03450200
      * CORRESPONDING GRID DETAIL RECORDS, THEN PURGE THE GRID          03450300
      * ID FOR THIS PRCHG ID FROM THE GRID TABLE.                       03450400
      ****************************************************************  03450500
       3000-PROCESS-CON.                                                03450600
           PERFORM 3100-OPEN-GRID-CSR.                                  03450700
           PERFORM 3200-PROCESS-GRID-CSR                                03450800
              UNTIL PS-EOF-GRID-CSR.                                    03450900
           PERFORM 3600-CLOSE-GRID-CSR.                                 03451000
           PERFORM 7000-DB2-COMMIT-CHECK.                               03452000
                                                                        03453000
                                                                        03454000
      ****************************************************************  03455000
      *OPEN PRICE CHANGE GRID CURSOR                                    03456000
      ****************************************************************  03457000
       3100-OPEN-GRID-CSR.                                              03457100
           MOVE '3100-OPEN-GRID-CSR    '  TO PV-PARAGRAPH-NAME.         03457200
                                                                        03457300
           INITIALIZE PV-RETRY-CNT.                                     03457400
           PERFORM WITH TEST AFTER                                      03457500
               UNTIL SQLCODE = ZERO                                     03457600
                  OR SQLCODE = +100                                     03457700
                  OR PV-RETRY-CNT > PC-MAX-RETRIES                      03457800
                     EXEC SQL                                           03457900
                         OPEN XMT_PRICG_GRID_CSR                        03458000
                     END-EXEC                                           03458100
                                                                        03458200
               EVALUATE TRUE                                            03458300
                   WHEN SQLCODE = ZERO                                  03458400
                   WHEN SQLCODE = +100                                  03458500
COGN                    CONTINUE                                        03458600
                   WHEN SQLCODE = -904                                  03458700
                   WHEN SQLCODE = -911                                  03458800
                   WHEN SQLCODE = -913                                  03458900
COGN                    ADD +1 TO PV-RETRY-CNT                          03459000
                   WHEN SQLWARN NOT = SPACES                            03459100
                   WHEN SQLCODE NOT = ZERO                              03459200
                        MOVE 'OPEN CURSOR OPERATION'                    03459300
                                   TO PV-OPERATION-MSG-1                03459400
                        PERFORM 9200-DISPLAY-STATISTICS                 03459500
                        PERFORM 9900-SQL-ABEND-ROUTINE                  03459600
               END-EVALUATE                                             03459700
           END-PERFORM.                                                 03459800
                                                                        03459900
           IF PV-RETRY-CNT > PC-MAX-RETRIES                             03460000
               MOVE 'OPEN CURSOR RETRIES EXCEEDED'                      03460100
                                      TO  PV-OPERATION-MSG-1            03460200
               PERFORM 9200-DISPLAY-STATISTICS                          03460300
               PERFORM 9900-SQL-ABEND-ROUTINE                           03460400
           END-IF.                                                      03460500
                                                                        03460600
                                                                        03460700
      ****************************************************************  03460800
      *PROCESS GRID CURSOR                                              03460900
      ****************************************************************  03461000
       3200-PROCESS-GRID-CSR.                                           03461100
           MOVE '3200-PROCESS-GRID-CSR      ' TO PV-PARAGRAPH-NAME.     03461200
           PERFORM 3300-FETCH-GRID-CSR.                                 03461300
           IF PS-NOT-EOF-GRID-CSR                                       03461400
               PERFORM 3400-DELETE-GRID-DTL                             03461500
               PERFORM 3500-DELETE-GRID                                 03461600
           END-IF.                                                      03461700
                                                                        03461800
                                                                        03461900
       3300-FETCH-GRID-CSR.                                             03462000
           MOVE '3300-FETCH-GRID-CSR ' TO PV-PARAGRAPH-NAME.            03462100
                                                                        03462200
           INITIALIZE PV-RETRY-CNT.                                     03462300
           PERFORM WITH TEST AFTER                                      03462400
             UNTIL SQLCODE = ZERO                                       03462500
                OR SQLCODE = +100                                       03462600
                OR PV-RETRY-CNT > PC-MAX-RETRIES                        03462700
                   EXEC SQL                                             03462800
                       FETCH XMT_PRICG_GRID_CSR                         03462900
                       INTO  :XMT00012-PRICG-GRID-ID                    03463000
                   END-EXEC                                             03463100
                                                                        03463200
                   EVALUATE TRUE                                        03463300
                       WHEN SQLCODE = ZERO                              03463400
                            ADD 1 TO PV-FETCH-GRID-CNT                  03463500
                       WHEN SQLCODE = +100                              03463600
                            SET PS-EOF-GRID-CSR TO TRUE                 03463700
                       WHEN SQLCODE = -904                              03463800
                       WHEN SQLCODE = -911                              03463900
                       WHEN SQLCODE = -913                              03464000
COGN                    ADD +1 TO PV-RETRY-CNT                          03465000
                       WHEN SQLWARN NOT = SPACES                        03465100
                       WHEN SQLCODE NOT = ZERO                          03465200
                            MOVE 'FETCH PRICING GRID CSR PROBLEM'       03465300
                                              TO  PV-OPERATION-MSG-1    03465400
                            PERFORM 9200-DISPLAY-STATISTICS             03465500
                            PERFORM 9900-SQL-ABEND-ROUTINE              03465600
                   END-EVALUATE                                         03465700
           END-PERFORM.                                                 03465800
                                                                        03465900
           IF PV-RETRY-CNT > PC-MAX-RETRIES                             03466000
               MOVE 'FETCH RETRIES EXCEEDED ON PRICING GRID'            03466100
                                      TO  PV-OPERATION-MSG-1            03466200
               PERFORM 9200-DISPLAY-STATISTICS                          03466300
               PERFORM 9900-SQL-ABEND-ROUTINE                           03466400
           END-IF.                                                      03466500
                                                                        03466600
                                                                        03466700
      ****************************************************************  03466800
      *DELETE ALL ROWS FROM THE PRICING GRID DETAIL FOR THIS GRID ID    03466900
      ****************************************************************  03467000
       3400-DELETE-GRID-DTL.                                            03468000
           MOVE '3400-DELETE-GRID-DTL        ' TO PV-PARAGRAPH-NAME.    03469000
                                                                        03470000
           MOVE XMT00012-PRICG-GRID-ID     TO XMT00013-PRICG-GRID-ID.   03480000
           INITIALIZE PV-RETRY-CNT.                                     03480100
           PERFORM WITH TEST AFTER                                      03480200
             UNTIL SQLCODE = ZERO                                       03480300
                OR SQLCODE = +100                                       03480400
                OR PV-RETRY-CNT > PC-MAX-RETRIES                        03480500
                   EXEC SQL                                             03480600
                        DELETE  FROM XMT_PRICG_GRID_DTL                 03480700
                        WHERE PRICG_GRID_ID = :XMT00013-PRICG-GRID-ID   03480800
                   END-EXEC                                             03480900
                                                                        03481000
                   EVALUATE TRUE                                        03481100
                      WHEN SQLCODE = ZERO                               03481200
                         ADD SQLERRD(3) TO PV-DEL-PRICG-GRID-DTL        03481300
                      WHEN SQLCODE = +100                               03481400
COGN                     CONTINUE                                       03481500
                      WHEN SQLCODE = -904                               03481600
                      WHEN SQLCODE = -911                               03481700
                      WHEN SQLCODE = -913                               03481800
COGN                    ADD +1 TO PV-RETRY-CNT                          03481900
                      WHEN OTHER                                        03482000
                        DISPLAY 'CANT DELETE FROM XMT_PRICG_GRID_DTL'   03483000
                        DISPLAY 'PRICG-GRID-ID: ' XMT00013-PRICG-GRID-ID03483100
                        DISPLAY 'PRCHG-ID:      ' XMT00009-PRCHG-ID     03483300
                        PERFORM 9200-DISPLAY-STATISTICS                 03483400
                        PERFORM 9900-SQL-ABEND-ROUTINE                  03483500
                   END-EVALUATE                                         03483600
           END-PERFORM.                                                 03483700
                                                                        03483800
           IF PV-RETRY-CNT > PC-MAX-RETRIES                             03483900
              MOVE 'XMT_PRICG_GRID_DTL RETRIES EXCEEDED'                03484000
                                     TO  PV-OPERATION-MSG-1             03484100
              PERFORM 9200-DISPLAY-STATISTICS                           03484200
              PERFORM 9900-SQL-ABEND-ROUTINE                            03484300
           END-IF.                                                      03484400
                                                                        03484500
                                                                        03484600
      ****************************************************************  03484700
      *DELETE ALL ROWS FROM THE PRICING GRID FOR THIS GRID ID           03484800
      ****************************************************************  03484900
       3500-DELETE-GRID.                                                03485000
           MOVE '3500-DELETE-GRID            ' TO PV-PARAGRAPH-NAME.    03485100
                                                                        03485200
           INITIALIZE PV-RETRY-CNT.                                     03485300
           PERFORM WITH TEST AFTER                                      03485400
             UNTIL SQLCODE = ZERO                                       03485500
                OR SQLCODE = +100                                       03485600
                OR PV-RETRY-CNT > PC-MAX-RETRIES                        03485700
                   EXEC SQL                                             03485800
                        DELETE  FROM XMT_PRICG_GRID                     03485900
                        WHERE PRICG_GRID_ID = :XMT00012-PRICG-GRID-ID   03486000
                   END-EXEC                                             03486100
                                                                        03486200
                   EVALUATE TRUE                                        03486300
                      WHEN SQLCODE = ZERO                               03486400
                         ADD SQLERRD(3) TO PV-DEL-PRICG-GRID            03486500
                      WHEN SQLCODE = +100                               03486600
COGN                     CONTINUE                                       03486700
                      WHEN SQLCODE = -904                               03486800
                      WHEN SQLCODE = -911                               03486900
                      WHEN SQLCODE = -913                               03487000
COGN                    ADD +1 TO PV-RETRY-CNT                          03487100
                      WHEN OTHER                                        03487200
      *ABEND IF +100 BECAUSE YOU ARE DELETING THE ROW FETCHED IN        03487300
      *GRID CURSOR AND IT HAS TO STILL BE THERE                         03487400
                        DISPLAY 'CANT DELETE FROM XMT_PRICG_GRID'       03487500
                        DISPLAY 'PRICG-GRID-ID: ' XMT00012-PRICG-GRID-ID03487600
                        DISPLAY 'PRCHG-ID:      ' XMT00009-PRCHG-ID     03487800
                        PERFORM 9200-DISPLAY-STATISTICS                 03487900
                        PERFORM 9900-SQL-ABEND-ROUTINE                  03488000
                   END-EVALUATE                                         03488100
           END-PERFORM.                                                 03488200
                                                                        03488300
           IF PV-RETRY-CNT > PC-MAX-RETRIES                             03488400
              MOVE 'XMT_PRICG_GRID RETRIES EXCEEDED'                    03488500
                                     TO  PV-OPERATION-MSG-1             03488600
              PERFORM 9200-DISPLAY-STATISTICS                           03488700
              PERFORM 9900-SQL-ABEND-ROUTINE                            03488800
           END-IF.                                                      03488900
                                                                        03489000
                                                                        03489100
       3600-CLOSE-GRID-CSR.                                             03489200
           MOVE '3600-CLOSE-GRID-CSR   '  TO PV-PARAGRAPH-NAME.         03489300
                                                                        03489400
           INITIALIZE PV-RETRY-CNT.                                     03489500
           PERFORM WITH TEST AFTER                                      03489600
               UNTIL SQLCODE = ZERO                                     03489700
                  OR SQLCODE = +100                                     03489800
                  OR PV-RETRY-CNT > PC-MAX-RETRIES                      03489900
                     EXEC SQL                                           03490000
                          CLOSE XMT_PRICG_GRID_CSR                      03490100
                     END-EXEC                                           03490200
                                                                        03490300
               EVALUATE TRUE                                            03490400
                   WHEN SQLCODE = 0                                     03490500
                   WHEN SQLCODE = +100                                  03490600
COGN                    CONTINUE                                        03490700
                   WHEN SQLCODE = -904                                  03490800
                   WHEN SQLCODE = -911                                  03490900
                   WHEN SQLCODE = -913                                  03491000
COGN                    ADD +1 TO PV-RETRY-CNT                          03491100
                   WHEN SQLWARN NOT = SPACES                            03491200
                   WHEN SQLCODE NOT = ZERO                              03491300
                        MOVE 'CLOSE GRID CURSOR OPERATION'              03491400
                                   TO PV-OPERATION-MSG-1                03491500
                        PERFORM 9200-DISPLAY-STATISTICS                 03491600
                        PERFORM 9900-SQL-ABEND-ROUTINE                  03491700
               END-EVALUATE                                             03491800
           END-PERFORM.                                                 03491900
                                                                        03492000
           IF PV-RETRY-CNT > PC-MAX-RETRIES                             03492100
               MOVE 'CLOSE GRID CURSOR RETRIES EXCEEDED'                03492200
                                      TO  PV-OPERATION-MSG-1            03492300
               PERFORM 9200-DISPLAY-STATISTICS                          03492400
               PERFORM 9900-SQL-ABEND-ROUTINE                           03492500
           END-IF.                                                      03492600
                                                                        03492700
                                                                        03492800
      ****************************************************************  03492900
      *IS IT TIME FOR A COMMIT?                                         03493000
      ****************************************************************  03493100
       7000-DB2-COMMIT-CHECK.                                           03493200
           MOVE '7000-DB2-COMMIT-CHECK      ' TO PV-PARAGRAPH-NAME.     03493300
           PERFORM 7100-SET-CURRENT-TIMESTAMP.                          03493400
                                                                        03493500
           IF PV-CURRENT-TIMESTAMP  >  PV-COMMIT-TIMESTAMP              03493600
              PERFORM 7200-COMMIT-DATA                                  03493700
              PERFORM 7300-GET-COMMIT-INFO                              03493800
           END-IF.                                                      03493900
                                                                        03494000
                                                                        03495000
       7100-SET-CURRENT-TIMESTAMP.                                      03496000
           MOVE '7100-SET-CURRENT-TIMESTAMP ' TO PV-PARAGRAPH-NAME.     03497000
           EXEC SQL                                                     03498000
                SET :PV-CURRENT-TIMESTAMP  =  CURRENT_TIMESTAMP         03499000
           END-EXEC.                                                    03500000
           IF SQLCODE   =  ZERO                                         03510000
              CONTINUE                                                  03520000
           ELSE                                                         03530000
              MOVE 'UNABLE TO SET CURRENT TIMESTAMP'                    03540000
                                              TO PV-OPERATION-MSG-1     03550000
              PERFORM 9200-DISPLAY-STATISTICS                           03560000
              PERFORM 9900-SQL-ABEND-ROUTINE                            03570000
           END-IF.                                                      03580000
                                                                        03590000
                                                                        03600000
       7200-COMMIT-DATA.                                                03610000
           MOVE '7200-COMMIT-DATA           ' TO PV-PARAGRAPH-NAME.     03620000
           EXEC SQL                                                     03630000
                COMMIT                                                  03640000
           END-EXEC.                                                    03650000
                                                                        03660000
           EVALUATE TRUE                                                03670000
              WHEN SQLCODE = ZERO                                       03680000
                   ADD 1 TO PV-COMMIT-CNT                               03681000
              WHEN SQLCODE = -904                                       03682000
              WHEN SQLCODE = -911                                       03683000
              WHEN SQLCODE = -913                                       03684000
                   CONTINUE                                             03685000
              WHEN OTHER                                                03686000
                   MOVE 'UNABLE TO DO A COMMIT' TO PV-OPERATION-MSG-1   03687000
                   PERFORM 9200-DISPLAY-STATISTICS                      03688000
                   PERFORM 9900-SQL-ABEND-ROUTINE                       03689000
           END-EVALUATE.                                                03690000
                                                                        03700000
                                                                        03710000
       7300-GET-COMMIT-INFO.                                            03720000
           MOVE '7300-GET-COMMIT-INFO       ' TO PV-PARAGRAPH-NAME.     03730000
           EXEC SQL                                                     03740000
                SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)    03750000
                 INTO  :PV-COMMIT-TIMESTAMP                             03760000
                 FROM   TCKRSTCNTL                                      03770000
                WHERE   JOB_NAME   =  :PC-JOB-NAME                      03780000
                  AND   PLAN_NAME  =  :PC-PGM-NAME                      03790000
           END-EXEC.                                                    03800000
                                                                        03801000
           EVALUATE TRUE                                                03802000
              WHEN SQLCODE = ZERO                                       03803000
                   CONTINUE                                             03804000
              WHEN OTHER                                                03805000
                   MOVE 'UNABLE TO GET COMMIT INFO'                     03806000
                                              TO PV-OPERATION-MSG-1     03807000
                   PERFORM 9200-DISPLAY-STATISTICS                      03808000
                   PERFORM 9900-SQL-ABEND-ROUTINE                       03809000
           END-EVALUATE.                                                03810000
                                                                        03820000
                                                                        03830000
      ******************************************************************03840000
      **INITIALIZATION PROCESSING                                       03850000
      ******************************************************************03860000
       8000-INITIALIZE.                                                 03870000
           MOVE '8000-INITIALIZE               ' TO PV-PARAGRAPH-NAME.  03880000
                                                                        03890000
           OPEN INPUT CONTROL-CARD-PURGE-DATE.                          03900000
COGN       OPEN INPUT CONTROL-CARD-PURGE-DATE1.                         03901000
                                                                        03902000
           READ CONTROL-CARD-PURGE-DATE INTO PC-CC-PURGE-DATE           03903000
                AT END                                                  03904000
                   SET PS-EOF-CC-PURGE TO TRUE                          03905000
           END-READ.                                                    03906000
COGN       READ CONTROL-CARD-PURGE-DATE1 INTO PC-CC-PURGE-DATE1         03907000
COGN            AT END                                                  03908000
COGN               SET PS-EOF-CC-PURGE1 TO TRUE                         03909000
COGN       END-READ.                                                    03910000
                                                                        03920000
           CLOSE CONTROL-CARD-PURGE-DATE.                               03930000
COGN       CLOSE CONTROL-CARD-PURGE-DATE1.                              03940000
                                                                        03950000
           DISPLAY 'CONTROL CARD PURGE DATE: ' PC-CC-PURGE-DATE.        03960000
COGN       DISPLAY 'CONTROL CARD PURGE DATE1: ' PC-CC-PURGE-DATE1.      03970000
                                                                        03980000
           IF (PS-NOT-EOF-CC-PURGE)  AND                                03990000
              (PC-CC-CCYY  NUMERIC)  AND                                03991000
              (PC-CC-MM    NUMERIC)  AND                                03992000
              (PC-CC-DD    NUMERIC)  AND                                03993000
              (PC-CC-PURGE-DATE > ZERO)                                 03994000
              CONTINUE                                                  03995000
           ELSE                                                         03996000
              MOVE 'NO PURGE DATE CONTROL CARD,' TO PV-OPERATION-MSG-1  03997000
              MOVE 'OR PURGE DATE IS INVALID   ' TO PV-OPERATION-MSG-2  03998000
              PERFORM 9800-ABEND-ROUTINE                                03999000
           END-IF.                                                      04000000
                                                                        04010000
COGN       IF (PS-NOT-EOF-CC-PURGE1)  AND                               04020000
COGN          (PC-CC-CCYY1  NUMERIC)  AND                               04030000
COGN          (PC-CC-MM1    NUMERIC)  AND                               04040000
COGN          (PC-CC-DD1    NUMERIC)  AND                               04050000
COGN          (PC-CC-PURGE-DATE1 > ZERO)                                04060000
COGN          CONTINUE                                                  04070000
COGN       ELSE                                                         04080000
COGN          MOVE 'NO PURGE DATE CONTROL CARD1,' TO PV-OPERATION-MSG-1 04090000
COGN          MOVE 'OR PURGE DATE IS INVALID-1  ' TO PV-OPERATION-MSG-2 04100000
COGN          PERFORM 9800-ABEND-ROUTINE                                04110000
COGN       END-IF.                                                      04120000
                                                                        04130000
      ******************************************************************04140000
      **OPEN CURSOR XMT_STR_GP_CSR                                      04150000
      ******************************************************************04160000
       8100-OPEN-CURSOR.                                                04170000
           MOVE '8100-OPEN-CURSOR      '  TO PV-PARAGRAPH-NAME.         04180000
                                                                        04190000
           INITIALIZE PV-RETRY-CNT.                                     04200000
           PERFORM WITH TEST AFTER                                      04210000
               UNTIL SQLCODE = ZERO                                     04220000
                  OR SQLCODE = +100                                     04230000
                  OR PV-RETRY-CNT > PC-MAX-RETRIES                      04240000
                     EXEC SQL                                           04250000
                         OPEN XMT_STR_GP_CSR                            04260000
                     END-EXEC                                           04270000
                                                                        04280000
               EVALUATE TRUE                                            04290000
                   WHEN SQLCODE = ZERO                                  04300000
COGN                     CONTINUE                                       04310000
                   WHEN SQLCODE = -904                                  04320000
                   WHEN SQLCODE = -911                                  04330000
                   WHEN SQLCODE = -913                                  04340000
COGN                    ADD +1 TO PV-RETRY-CNT                          04350000
                   WHEN SQLWARN NOT = SPACES                            04360000
                   WHEN SQLCODE NOT = ZERO                              04370000
                        MOVE 'OPEN CURSOR OPERATION'                    04380000
                                   TO PV-OPERATION-MSG-1                04390000
                        PERFORM 9200-DISPLAY-STATISTICS                 04400000
                        PERFORM 9900-SQL-ABEND-ROUTINE                  04410000
               END-EVALUATE                                             04420000
           END-PERFORM.                                                 04430000
                                                                        04440000
           IF PV-RETRY-CNT > PC-MAX-RETRIES                             04450000
               MOVE 'OPEN CURSOR RETRIES EXCEEDED'                      04460000
                                      TO  PV-OPERATION-MSG-1            04470000
               PERFORM 9200-DISPLAY-STATISTICS                          04480000
               PERFORM 9900-SQL-ABEND-ROUTINE                           04490000
           END-IF.                                                      04500000
                                                                        04510000
                                                                        04520000
      ******************************************************************04530000
      **CLOSE CURSOR XMT_STR_GP_CSR                                     04540000
      ******************************************************************04550000
       8200-CLOSE-CURSOR.                                               04560000
           MOVE '8200-CLOSE-CURSOR     '  TO PV-PARAGRAPH-NAME.         04570000
                                                                        04580000
           INITIALIZE PV-RETRY-CNT.                                     04590000
           PERFORM WITH TEST AFTER                                      04600000
               UNTIL SQLCODE = ZERO                                     04610000
                  OR SQLCODE = +100                                     04620000
                  OR PV-RETRY-CNT > PC-MAX-RETRIES                      04630000
                     EXEC SQL                                           04640000
                          CLOSE XMT_STR_GP_CSR                          04650000
                     END-EXEC                                           04660000
                                                                        04670000
               EVALUATE TRUE                                            04680000
                   WHEN SQLCODE = 0                                     04690000
COGN               WHEN SQLCODE = +100                                  04700000
COGN                    CONTINUE                                        04710000
                   WHEN SQLCODE = -904                                  04720000
                   WHEN SQLCODE = -911                                  04730000
                   WHEN SQLCODE = -913                                  04740000
                        ADD +1 TO PV-RETRY-CNT                          04750000
                   WHEN SQLWARN NOT = SPACES                            04760000
                   WHEN SQLCODE NOT = ZERO                              04770000
                        MOVE 'CLOSE CURSOR OPERATION'                   04780000
                                   TO PV-OPERATION-MSG-1                04790000
                        PERFORM 9200-DISPLAY-STATISTICS                 04800000
                        PERFORM 9900-SQL-ABEND-ROUTINE                  04810000
               END-EVALUATE                                             04820000
           END-PERFORM.                                                 04830000
                                                                        04840000
           IF PV-RETRY-CNT > PC-MAX-RETRIES                             04850000
               MOVE 'CLOSE CURSOR RETRIES EXCEEDED'                     04860000
                                      TO  PV-OPERATION-MSG-1            04870000
               PERFORM 9200-DISPLAY-STATISTICS                          04880000
               PERFORM 9900-SQL-ABEND-ROUTINE                           04890000
           END-IF.                                                      04900000
                                                                        04910000
                                                                        04920000
057934******************************************************************04930000
057934**OPEN CURSOR XMT_STR_GP_MK2FNL_CSR                               04940000
057934******************************************************************04950000
057934*8300-OPEN-CURSOR.                                                04960000
057934*    MOVE '8300-OPEN-CURSOR      '  TO PV-PARAGRAPH-NAME.         04970000
057934*                                                                 04980000
057934*    INITIALIZE PV-RETRY-CNT.                                     04990000
057934*    PERFORM WITH TEST AFTER                                      05000000
057934*        UNTIL SQLCODE = ZERO                                     05010000
057934*           OR SQLCODE = +100                                     05020000
057934*           OR PV-RETRY-CNT > PC-MAX-RETRIES                      05030000
057934*              EXEC SQL                                           05040000
057934*                  OPEN XMT_STR_GP_MK2FNL_CSR                     05041000
057934*              END-EXEC                                           05042000
057934*                                                                 05043000
057934*        EVALUATE TRUE                                            05044000
057934*            WHEN SQLCODE = ZERO                                  05045000
057934*            WHEN SQLCODE = +100                                  05046000
057934*                  CONTINUE                                       05047000
057934*            WHEN SQLCODE = -904                                  05048000
057934*            WHEN SQLCODE = -911                                  05049000
057934*            WHEN SQLCODE = -913                                  05050000
057934*                 ADD +1 TO PV-RETRY-CNT                          05050100
057934*            WHEN SQLWARN NOT = SPACES                            05050200
057934*            WHEN SQLCODE NOT = ZERO                              05050300
057934*                 MOVE 'OPEN MK2 CURSOR OPERATION'                05050400
057934*                            TO PV-OPERATION-MSG-1                05050500
057934*                 PERFORM 9200-DISPLAY-STATISTICS                 05050600
057934*                 PERFORM 9900-SQL-ABEND-ROUTINE                  05050700
057934*        END-EVALUATE                                             05050800
057934*    END-PERFORM.                                                 05050900
057934*                                                                 05051000
057934*    IF PV-RETRY-CNT > PC-MAX-RETRIES                             05051100
057934*        MOVE 'OPEN MK2 CURSOR RETRIES EXCEEDED'                  05051200
057934*                               TO  PV-OPERATION-MSG-1            05051300
057934*        PERFORM 9200-DISPLAY-STATISTICS                          05051400
057934*        PERFORM 9900-SQL-ABEND-ROUTINE                           05051500
057934*    END-IF.                                                      05051600
057934*                                                                 05051700
057934*                                                                 05051800
057934******************************************************************05051900
057934**CLOSE CURSOR XMT_STR_GP_MK2FNL_CSR                              05052000
057934******************************************************************05052100
057934*8400-CLOSE-CURSOR.                                               05052200
057934*    MOVE '8400-CLOSE-CURSOR     '  TO PV-PARAGRAPH-NAME.         05052300
057934*                                                                 05052400
057934*    INITIALIZE PV-RETRY-CNT.                                     05052500
057934*    PERFORM WITH TEST AFTER                                      05052600
057934*        UNTIL SQLCODE = ZERO                                     05052700
057934*           OR SQLCODE = +100                                     05052800
057934*           OR PV-RETRY-CNT > PC-MAX-RETRIES                      05052900
057934*              EXEC SQL                                           05053000
057934*                   CLOSE XMT_STR_GP_MK2FNL_CSR                   05053100
057934*              END-EXEC                                           05053200
057934*                                                                 05053300
057934*        EVALUATE TRUE                                            05053400
057934*            WHEN SQLCODE = 0                                     05053500
057934*            WHEN SQLCODE = +100                                  05053600
057934*                 CONTINUE                                        05053700
057934*            WHEN SQLCODE = -904                                  05053800
057934*            WHEN SQLCODE = -911                                  05053900
057934*            WHEN SQLCODE = -913                                  05054000
057934*                 ADD +1 TO PV-RETRY-CNT                          05054100
057934*            WHEN SQLWARN NOT = SPACES                            05054200
057934*            WHEN SQLCODE NOT = ZERO                              05054300
057934*                 MOVE 'CLOSE MK2 CURSOR OPERATION'               05054400
057934*                            TO PV-OPERATION-MSG-1                05054500
057934*                 PERFORM 9200-DISPLAY-STATISTICS                 05054600
057934*                 PERFORM 9900-SQL-ABEND-ROUTINE                  05054700
057934*        END-EVALUATE                                             05054800
057934*    END-PERFORM.                                                 05054900
057934*                                                                 05055000
057934*    IF PV-RETRY-CNT > PC-MAX-RETRIES                             05055100
057934*        MOVE 'CLOSE MK2 CURSOR RETRIES EXCEEDED'                 05055200
057934*                               TO  PV-OPERATION-MSG-1            05055300
057934*        PERFORM 9200-DISPLAY-STATISTICS                          05055400
057934*        PERFORM 9900-SQL-ABEND-ROUTINE                           05055500
057934*    END-IF.                                                      05055600
                                                                        05055700
                                                                        05055800
       9200-DISPLAY-STATISTICS.                                         05055900
           DISPLAY '*************************************************'. 05056000
           DISPLAY '* PROGRAM STATISTICS'.                              05057000
           DISPLAY '* PROGRAM.................: ' PC-PGM-NAME.          05058000
           DISPLAY '* TOTAL CURSOR FETCH      : ' PV-TOTAL-FETCH-COUNT. 05059000
           DISPLAY '* RETURNS FROM STR-GP CSR.: ' PV-FETCH-STR-GP-CNT.  05060000
           DISPLAY '* GRID CURSOR FETCH COUNT.: ' PV-FETCH-GRID-CNT.    05070000
           DISPLAY '* PRCHG TABLE DELETES.....: ' PV-DEL-PRCHG-CNT.     05080000
           DISPLAY '* STR GP PRCHG TBL DELETES: ' PV-DEL-STR-GP-CNT.    05090000
           DISPLAY '* PRCHG MDSE TABLE DELETES: ' PV-DEL-MDSE-CNT.      05100000
           DISPLAY '* PRICG GRID DTL DELETES..: ' PV-DEL-PRICG-GRID-DTL.05110000
           DISPLAY '* PRICG GRID TABLE DELETES: ' PV-DEL-PRICG-GRID.    05111000
           DISPLAY '* COMMIT COUNT............: ' PV-COMMIT-CNT.        05112000
           DISPLAY '*************************************************'. 05113000
                                                                        05114000
                                                                        05115000
      *----------------------------------------------------------       05116000
      * 9800-ABEND-ROUTINE.                                             05117000
      *     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  05118000
      *----------------------------------------------------------       05119000
       9800-ABEND-ROUTINE.                                              05120000
           DISPLAY '** ABEND           **'.                             05130000
           DISPLAY '** PROGRAM         ** = ' PC-PGM-NAME.              05140000
           DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        05150000
           DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       05160000
           DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       05170000
           MOVE +4000 TO PV-ABEND-CODE                                  05180000
           CALL 'ILBOABN0' USING PV-ABEND-CODE.                         05190000
                                                                        05200000
                                                                        05210000
      ******************************************************************05220000
      **SQL ABEND ROUTINE                                               05230000
      ******************************************************************05240000
       9900-SQL-ABEND-ROUTINE.                                          05250000
           DISPLAY '** ABEND     **'.                                   05260000
           DISPLAY '** PROGRAM   ** = ' PC-PGM-NAME.                    05270000
           DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              05280000
           DISPLAY '** OPERATION ** = ' PV-OPERATION-MSG-1.             05290000
      *    STMTS FOR USING SQLCA MSG DISPLAY MODULE "DSNTIAR"           05300000
           COPY DPPD004.                                                05310000
           MOVE 4013          TO PV-ABEND-CODE.                         05320000
           CALL 'ILBOABN0' USING PV-ABEND-CODE.                         05330000
