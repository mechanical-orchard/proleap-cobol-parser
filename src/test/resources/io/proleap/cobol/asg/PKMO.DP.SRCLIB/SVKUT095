000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.         SVKUT095.                                    00020000
000300 AUTHOR.             BARB SCHULTZ.                                00030000
000400 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00040000
000500 DATE-WRITTEN.       NOV 2011.                                    00050000
000600 DATE-COMPILED.                                                   00060000
000700                                                                  00070000
000800******************************************************************00080000
000900* SVKUT095 - TRANSACTION MATCHING PROGRAM FOR ECOMM.             *00090000
001000*  COPIED SVKUT029.                                              *00100000
001100*                                                                *00110000
001200* THIS PROGRAM DOES A FILE COMPARISON BETWEEN THE KMC ACTIVITY   *00120000
001300* TABLE EXTRACT AND THE KMC ACTIVITY EXTRACT FROM THE DAILY POS  *00130000
001400* FILE.                                                          *00140000
001500*                                                                *00150000
001600* INPUT FILES:   DAILY-SVT00002-ACTIVITY     DDNAME = INP01      *00160000
001700*                DAILY-POS-ACTIVITY          DDNAME = INP02      *00170000
001800*                CONTROL DATE FILE           DDNAME = INP03      *00180000
001900*                                                                *00190000
002000* OUTPUT FILES:  KMC-POSTING-FILE            DDNAME = OUT01      *00200000
002100*                AUDIT-REPORT-FILE           DDNAME = OUT02      *00210000
002200*---------------------------------------------------------------* 00220000
002270*  06/04/2014  RECOMPILED TO ADD OMNI-CHNL-FFLMT-TYP-CDE ON     * 00221000
002270*  SVRD021 AND SVRD019. ALSO INCREASED THE LENGTH OF SVRD021.   * 00221100
002200*---------------------------------------------------------------* 00221200
P10237*  17/06/2015  COSA DATA SECURITY PROJECT.                      * 00221800
P10237*     CHANGES MADE TO CONVERT THE DL# FROM SVT_KOHLS_CRD_TXN    * 00221900
P10237*  TABLE TO ASCII FORMAT, THEN ENCRYPT THIS ASCII VALUE USING   * 00222000
P10237*  PROTEGRITY MODULE AND THEN CONVERT THE ENCRYPTED DL# FROM    * 00222100
P10237*  BINARY TO BASE-64 FORMAT AND CHANGES TO ACCOMMODATE THE      * 00222200
P10237*  ENCRYPTED DL# AND TO REMOVE THE CARD# DISPLAY.               * 00222315
P10237*  MADE BY: COGNIZANT                   WR#: CHG0104429         * 00222514
P10237*---------------------------------------------------------------* 00222614
P12431*  08/27/2018  MODIFIED THE PROGRAM TO HANDLE NEWLY ADDED       * 00222732
P12431*              ORD_NBR FIELD IN THE SVT TABLES.                 * 00222832
P12431*  MADE BY: COGNIZANT                   WR#: CHG0208643         * 00222932
P12431*---------------------------------------------------------------* 00223032
002240 ENVIRONMENT DIVISION.                                            00223132
002250******************************************************************00223232
002260 CONFIGURATION SECTION.                                           00223332
002270                                                                  00223432
002280 SOURCE-COMPUTER.    IBM-3090.                                    00223532
002290 OBJECT-COMPUTER.    IBM-3090.                                    00223632
002300                                                                  00223732
002400 INPUT-OUTPUT SECTION.                                            00223832
002500                                                                  00223932
002600 FILE-CONTROL.                                                    00224000
002700                                                                  00225000
002800     SELECT DAILY-SVT00002-ACTIVITY   ASSIGN TO INP01.            00226000
002900     SELECT DAILY-POS-ACTIVITY        ASSIGN TO INP02.            00227000
003000     SELECT CONTROL-DATE-FILE         ASSIGN TO INP03.            00228000
003000     SELECT CUTOFF-SHIP-DAYS          ASSIGN TO INP04.            00228120
003100     SELECT KMC-POSTING-FILE          ASSIGN TO OUT01.            00229000
003200     SELECT AUDIT-REPORT-FILE         ASSIGN TO OUT02.            00230000
003300     SELECT TOTAL-FILE                ASSIGN TO OUT03.            00240000
003400     SELECT TOTAL-DETAIL-FILE         ASSIGN TO OUT04.            00250000
003500                                                                  00260000
003600******************************************************************00270000
003700 DATA DIVISION.                                                   00280000
003800******************************************************************00290000
003900                                                                  00300000
004000 FILE SECTION.                                                    00310000
004100                                                                  00320000
004200 FD  DAILY-SVT00002-ACTIVITY                                      00330000
004300     RECORDING MODE IS F                                          00340000
004400     BLOCK CONTAINS 0 RECORDS                                     00350000
004500     LABEL RECORDS ARE OMITTED.                                   00360000
004600                                                                  00370000
P12431 01  DAILY-SVT00002-RECORD       PIC  X(198).                     00381033
004800                                                                  00390000
004900 FD  DAILY-POS-ACTIVITY                                           00400000
005000     RECORDING MODE IS F                                          00410000
005100     BLOCK CONTAINS 0 RECORDS                                     00420000
005200     LABEL RECORDS ARE OMITTED.                                   00430000
005300                                                                  00440000
P12431 01  DAILY-POS-ACTIVITY-RECORD PIC X(179).                        00451031
005500                                                                  00460000
005600 FD  CONTROL-DATE-FILE                                            00470000
005700     RECORDING MODE IS F                                          00480000
005800     BLOCK CONTAINS 0 RECORDS                                     00490000
005900     LABEL RECORDS ARE OMITTED.                                   00500000
006000                                                                  00510000
006100 01  CONTROL-DATE-RECORD         PIC X(80).                       00520000
                                                                        00520121
005600 FD  CUTOFF-SHIP-DAYS                                             00521021
005700     RECORDING MODE IS F                                          00522021
005800     BLOCK CONTAINS 0 RECORDS                                     00523021
005900     LABEL RECORDS ARE OMITTED.                                   00524021
006000                                                                  00525021
006100 01  CUTOFF-SHIP-DAYS-RECORD     PIC X(80).                       00526021
006200                                                                  00530000
006300 FD  KMC-POSTING-FILE                                             00540000
006400     RECORDING MODE IS F                                          00550000
006500     BLOCK CONTAINS 0 RECORDS                                     00560000
006600     LABEL RECORDS ARE OMITTED.                                   00570000
006700                                                                  00580000
P12431 01  KMC-POSTING-RECORD          PIC  X(198).                     00591033
006900                                                                  00600000
007000 FD  AUDIT-REPORT-FILE                                            00610000
007100     RECORDING MODE IS F                                          00620000
007200     BLOCK CONTAINS 0 RECORDS                                     00630000
007300     LABEL RECORDS ARE OMITTED.                                   00640000
007400                                                                  00650000
P12431 01  AUDIT-REPORT-RECORD         PIC  X(198).                     00661033
007600                                                                  00670000
007700 FD  TOTAL-FILE                                                   00680000
007800     RECORDING MODE IS F                                          00690000
007900     BLOCK CONTAINS 0 RECORDS                                     00700000
008000     LABEL RECORDS ARE OMITTED.                                   00710000
008100                                                                  00720000
008200 01  TOTAL-RECORD                PIC  X(312).                     00730000
008300                                                                  00740000
008400 FD  TOTAL-DETAIL-FILE                                            00750000
008500     RECORDING MODE IS F                                          00760000
008600     BLOCK CONTAINS 0 RECORDS                                     00770000
008700     LABEL RECORDS ARE OMITTED.                                   00780000
008800                                                                  00790000
P12431 01  TOTAL-DETAIL-RECORD         PIC  X(437).                     00801033
009000                                                                  00810000
009100 WORKING-STORAGE SECTION.                                         00820000
009200                                                                  00830000
009300 01  ABEND-CODE                  PIC S9(04)     VALUE +0  COMP.   00840000
009400 01  WS-ABEND-ROUTINE            PIC X(08)      VALUE 'ILBOABN0'. 00850027
009500                                                                  00860000
009600 01  CR-CONTROL-RECORD.                                           00870000
009700     05  CR-CONTROL-DATE              PIC  X(10)    VALUE SPACES. 00880000
009800     05  FILLER                       PIC  X(70)    VALUE SPACES. 00890000
009900                                                                  00900000
010000******************************************************************00910000
010100*    PC-PROGRAM CONSTANTS                                        *00920000
010200******************************************************************00930000
010300 01  PC-PROGRAM-CONSTANTS.                                        00940000
010400     05  PC-PROGRAM-NAME          PIC  X(08)    VALUE 'SVKUT095'. 00950000
P10237     05  PC-DPKUT052              PIC  X(08)    VALUE 'DPKUT052'. 00951014
010500     05  PC-JOB-NAME              PIC  X(08)    VALUE 'SVK065  '. 00960000
010600     05  PC-UPDATE-RECORD         PIC  X(01)    VALUE 'U'.        00970000
010700     05  PC-INSERT-RECORD         PIC  X(01)    VALUE 'I'.        00980000
010800     05  PC-NUMBER-DAYS-TO-CHECK  PIC  9(01)    VALUE 7.          00990000
010900     05  PC-ONE                   PIC  9(01)    VALUE 1.          01000000
011000     05  PC-PEPLSOFT              PIC  X(08)    VALUE 'PSFTFIRB'. 01010000
011100                                                                  01020000
011200******************************************************************01030000
011300*    PV-PROGRAM VARIABLES                                        *01040000
011400******************************************************************01050000
011500 01  PV-PROGRAM-VARIABLES.                                        01060000
011600     05  PV-PARAGRAPH-NAME       PIC  X(30)     VALUE SPACES.     01070000
011700     05  PV-DB2-OPERATION-ATTEMPTED PIC X(30)   VALUE SPACES.     01080000
011800     05  PV-SELECT               PIC  X(01)     VALUE SPACE.      01090000
011900     05  PV-TENDER-ACT-TYP       PIC S9(01)     VALUE ZERO        01100000
012000                                                COMP-3.           01110000
012100     05  PV-POS-CUTOFF-DATE      PIC  X(10)     VALUE SPACES.     01120000
012200     05  PV-POS-DATE             PIC  X(10)     VALUE SPACES.     01130000
012200     05  PV-EXPECTED-SHIP-DATE   PIC  X(10)     VALUE SPACES.     01131025
012200     05  PV-SHIP-DATE-CUTOFF     PIC  X(10)     VALUE SPACES.     01132026
012300     05  PV-DATE-COUNTER         PIC  9(01)     VALUE ZERO.       01140000
P12431     05  PV-ORD-NBR-NULL-IND     PIC S9(4) COMP VALUE ZERO.       01141033
P12431     05  PV-HOLD-SV022-RECORD    PIC  X(198)    VALUE SPACES.     01151033
012500     05  PV-SAVE-SV022-RECORD.                                    01160000
012600         10 PV-SAVE-SV022-CRD-TYP PIC S9(01)V   COMP-3.           01170000
012700         10 PV-SAVE-SV022-CRD-NBR PIC S9(12)V   COMP-3.           01180000
012800         10 PV-SAVE-SV022-POS-DTE PIC X(10).                      01190000
012900         10 PV-SAVE-SV022-STR-NBR PIC S9(04)    COMP.             01200000
013000         10 PV-SAVE-SV022-TRMNLNO PIC S9(04)    COMP.             01210000
013100         10 PV-SAVE-SV022-TRN-NBR PIC S9(04)    COMP.             01220000
013200         10 PV-SAVE-SV022-APP-AMT PIC S9(07)V99 COMP-3.           01230000
013300         10 PV-SAVE-SV022-ORG-AMT PIC S9(07)V99 COMP-3.           01240000
013400         10 PV-SAVE-SV022-TRNVOID PIC X(01).                      01250000
013500         10 PV-SAVE-SV022-TRNRCDE PIC S9(01)V  COMP-3.            01260000
P10237         10 FILLER                PIC X(21).                      01270000
013700         10 PV-SAVE-SV022-ACT-STA PIC S9(01)V  COMP-3.            01280000
013800         10 PV-SAVE-SV022-ACT-TYP PIC S9(01)V  COMP-3.            01290000
013900         10 PV-SAVE-SV022-POS-OPR PIC S9(11)V  COMP-3.            01300000
014000         10 PV-SAVE-SV022-APP-USR PIC X(08).                      01310000
014100         10 PV-SAVE-SV022-OVRTNDR PIC X(01).                      01320000
014200         10 PV-SAVE-SV022-TRN-AUTH-TMST PIC X(26).                01330000
014200         10 PV-SAVE-ST-CDE        PIC X(02).                      01331000
014200         10 PV-SAVE-TRN-STAT-CDE  PIC X(02).                      01332000
014200         10 PV-SAVE-CRD-SPCTY-TYP-CDE PIC X(01).                  01333000
P10237         10 PV-SAVE-SV022-DRV-LIC PIC X(48).                      01334000
P12431         10 PV-SAVE-SV022-ORD-NBR PIC X(40).                      01335033
014300         10 FILLER                PIC X(05).                      01340000
014400     05  PV-SV022-APP-AUTH-AMT   PIC S9(07)V99 COMP-3.            01350000
014500     05  PV-CURRENT-TIMESTAMP    PIC  X(26)     VALUE SPACES.     01360000
014600     05  PV-HOLD-OVERTENDER-CRD-NBR                               01370000
014700                                 PIC S9(12)     VALUE ZEROES      01380000
014800                                                COMP-3.           01390000
014900     05  PV-CARD-BALANCE         PIC S9(07)V9(02)                 01400000
015000                                                VALUE ZEROES      01410000
015100                                                COMP-3.           01420000
015200     05  PV-SUB                  PIC 9(02)      VALUE ZERO.       01430017
015300     05  PV-MAX-STORE            PIC 9(02)      VALUE ZERO.       01440017
015400     05  PV-STORE-NBR            PIC S9(4) COMP VALUE ZERO.       01450000
015500     05  PV-ECOMM-STORES OCCURS 99 TIMES.                         01460000
015600         10  PV-ECOMM-STR   PIC S9(4) COMP      VALUE ZERO.       01470000
P10237     05  PV-ASCII                PIC  X(21).                      01471000
P10237     05  PV-DL-LENGTH            PIC  9(09)     VALUE ZEROES.     01472014
P10237     05  PV-INPUT-TEXT           PIC  X(34).                      01473000
P10237     05  PV-OUTPUT-TEXT          PIC  X(48)     VALUE SPACES.     01474000
015700     05  PV-CUTOFF-SHIP-RECORD.                                   01480021
015700         10 PV-CUTOFF-SHIP-DAYS PIC   9(01)     VALUE ZERO.       01481021
015700         10 FILLER              PIC   X(79)     VALUE SPACES.     01482022
015800******************************************************************01490000
015900*    PS-PROGRAM SWITCHES                                         *01500000
016000******************************************************************01510000
016100 01  PS-PROGRAM-SWITCHES.                                         01520000
016200     05  PS-FOUND-PTNDR-TRANS-SW        PIC X(01)   VALUE 'N'.    01530000
016300         88  PS-NOT-FOUND-PTNDR-TRANS               VALUE 'N'.    01540000
016400         88  PS-FOUND-PTNDR-TRANS                   VALUE 'Y'.    01550000
016500     05  PS-END-OF-PTNDR-CSR-SW         PIC  X(01)  VALUE 'N'.    01560000
016600         88  PS-NOT-END-OF-PTNDR-CSR                VALUE 'N'.    01570000
016700         88  PS-END-OF-PTNDR-CSR                    VALUE 'Y'.    01580000
016800                                                                  01590000
016900     05  PS-FOUND-GISSU-TRANS-SW        PIC X(01)   VALUE 'N'.    01600000
017000         88  PS-NOT-FOUND-GISSU-TRANS               VALUE 'N'.    01610000
017100         88  PS-FOUND-GISSU-TRANS                   VALUE 'Y'.    01620000
017200     05  PS-END-OF-GISSU-CSR-SW         PIC  X(01)  VALUE 'N'.    01630000
017300         88  PS-NOT-END-OF-GISSU-CSR                VALUE 'N'.    01640000
017400         88  PS-END-OF-GISSU-CSR                    VALUE 'Y'.    01650000
017500                                                                  01660000
017600     05  PS-FOUND-GVOID-TRANS-SW        PIC X(01)   VALUE 'N'.    01670000
017700         88  PS-NOT-FOUND-GVOID-TRANS               VALUE 'N'.    01680000
017800         88  PS-FOUND-GVOID-TRANS                   VALUE 'Y'.    01690000
017900     05  PS-END-OF-GVOID-CSR-SW         PIC  X(01)  VALUE 'N'.    01700000
018000         88  PS-NOT-END-OF-GVOID-CSR                VALUE 'N'.    01710000
018100         88  PS-END-OF-GVOID-CSR                    VALUE 'Y'.    01720000
018200                                                                  01730000
018300     05  PS-FOUND-VISSU-TRANS-SW        PIC X(01)   VALUE 'N'.    01740000
018400         88  PS-NOT-FOUND-VISSU-TRANS               VALUE 'N'.    01750000
018500         88  PS-FOUND-VISSU-TRANS                   VALUE 'Y'.    01760000
018600     05  PS-END-OF-VISSU-CSR-SW         PIC  X(01)  VALUE 'N'.    01770000
018700         88  PS-NOT-END-OF-VISSU-CSR                VALUE 'N'.    01780000
018800         88  PS-END-OF-VISSU-CSR                    VALUE 'Y'.    01790000
018900     05  PS-END-OF-XSTR-CSR-SW          PIC  X(01)  VALUE 'N'.    01800000
019000         88  PS-NOT-END-OF-XSTR-CSR                 VALUE 'N'.    01810000
019100         88  PS-END-OF-XSTR-CSR                     VALUE 'Y'.    01820000
019200     05  PS-END-OF-SVT00002-FILE-SW  PIC  X(01) VALUE 'N'.        01830000
019300         88  PS-END-OF-SVT00002-FILE            VALUE 'Y'.        01840000
019400     05  PS-END-OF-DAILY-POS-SW      PIC  X(01) VALUE 'N'.        01850000
019500         88  PS-END-OF-DAILY-POS-FILE           VALUE 'Y'.        01860000
019600     05  PS-END-OF-CONTROL-FILE-SW      PIC  X(01)   VALUE 'N'.   01870000
019700         88  PS-END-OF-CONTROL-FILE                  VALUE 'Y'.   01880000
019800     05  PS-MISSING-SVT00002-SW      PIC  X(01) VALUE 'N'.        01890000
019900         88  PS-MISSING-SVT00002-TRAN-FOUND     VALUE 'Y'.        01900000
020000         88  PS-MISS-SVT00002-TRAN-NOT-FND      VALUE 'N'.        01910000
020100     05  PS-WROTE-OVERTENDER-MSG-SW  PIC  X(01) VALUE 'N'.        01920000
020200         88  PS-WROTE-OVERTENDER-MSG            VALUE 'Y'.        01930000
020300         88  PS-OVERTENDER-MSG-NOT-WRITTEN      VALUE 'N'.        01940000
020400     05  PS-KMC-REC-SAVED-SW         PIC  X(01) VALUE 'N'.        01950000
020500         88  PS-KMC-REC-SAVED-YES               VALUE 'Y'.        01960000
020600         88  PS-KMC-REC-SAVED-NO                VALUE 'N'.        01970000
020700     05  PS-KMC-REC-SAVED-MATCH-SW   PIC  X(01) VALUE 'N'.        01980000
020800         88  PS-KMC-REC-SAVED-MATCH             VALUE 'Y'.        01990000
020900         88  PS-KMC-REC-SAVED-NO-MATCH          VALUE 'N'.        02000000
021000     05  PS-ECOMM-STR-SW             PIC  X(01) VALUE 'N'.        02010000
021100         88  PS-ECOMM-STR                       VALUE 'Y'.        02020000
021200         88  PS-NOT-ECOMM-STR                   VALUE 'N'.        02030000
021300                                                                  02040000
021400******************************************************************02050000
021500*    PA-PROGRAM ACCUMULATORS                                     *02060000
021600******************************************************************02070000
021700 01  PA-PROGRAM-ACCUMULATORS.                                     02080000
021800     05  PA-SALES-ACTIVITY-RECS-READ    PIC S9(11)   COMP-3       02090000
021900                                                     VALUE ZEROES.02100000
022000     05  PA-SVT00002-ACTIVITY-RECS-READ PIC S9(11)   COMP-3       02110000
022100                                                     VALUE ZEROES.02120000
022200     05  PA-UPDATE-RECORDS-WRITTEN      PIC S9(11)   COMP-3       02130000
022300                                                     VALUE ZEROES.02140000
022400     05  PA-AUDIT-RECORDS-WRITTEN       PIC S9(11)   COMP-3       02150000
022500                                                     VALUE ZEROES.02160000
022600                                                                  02170000
P10237******************************************************************02180000
P10237*    LK52- EBCDIC/ASCII DATA FORMAT CONVERSION AREA.             *02180100
P10237******************************************************************02180200
P10237 01  LK52-DPKUT052-SUBRTN-WORK-AREA.                              02180300
P10237   05  LK52-CONVERSION-TYPE      PIC  X(01).                      02180400
P10237       88  EBCDIC-TO-ASCII                   VALUE '1'.           02180513
P10237       88  ASCII-TO-EBCDIC                   VALUE '2'.           02180613
P10237   05  LK52-LENGTH               PIC S9(03)  COMP-3.              02180700
P10237   05  LK52-FROM-AREA            PIC  X(50)  VALUE SPACES.        02180800
P10237   05  LK52-TO-AREA              PIC  X(50)  VALUE SPACES.        02180900
P10237   05  LK52-RETURN-CODE          PIC  X(02)  VALUE '00'.          02181000
P10237       88  GOOD-LK52-RET-CODE                VALUE '00'.          02181113
P10237                                                                  02181200
022700******************************************************************02182000
022800*    DATE ROUTINE COPY MEMBERS                                   *02190000
022900******************************************************************02200000
023000     COPY DPWS500.                                                02210000
023100                                                                  02220000
023200******************************************************************02230000
023300*  KMC UPDATE POSTING RECORD LAYOUT                              *02240000
023400******************************************************************02250000
023500     COPY SVRD018.                                                02260000
023600                                                                  02270000
023700******************************************************************02280000
023800*  KMC DAILY EXTRACT RECORD LAYOUT FROM POS                      *02290000
023900******************************************************************02300000
024000     COPY SVRD021.                                                02310000
024100                                                                  02320000
024200******************************************************************02330000
024300*  KMC DAILY EXTRACT RECORD LAYOUT FROM SVT_KOHLS_CRD_TXN        *02340000
024400******************************************************************02350000
024500     COPY SVRD022.                                                02360000
024600                                                                  02370000
024700******************************************************************02380000
024800*  KMC AUDIT REPORT RECORD LAYOUT                                *02390000
024900******************************************************************02400000
025000     COPY SVRD019.                                                02410000
025100                                                                  02420000
025200******************************************************************02430000
025300*  TOTAL RECORD LAYOUT                                           *02440000
025400******************************************************************02450000
025500     COPY SVRD043.                                                02460000
025600                                                                  02470000
025700******************************************************************02480000
025800*  DETAILS OF THE TOTAL RECORD LAYOUT                            *02490000
025900******************************************************************02500000
026000     COPY SVRD044.                                                02510000
026100                                                                  02520000
026200******************************************************************02530000
026300** WORKING STORAGE FOR CONVERSION TO CARD NUMBER                 *02540000
026400******************************************************************02550000
026500     COPY SVWS007.                                                02560000
026600******************************************************************02570000
026700*  KOHLS STORED VALUE CARD CONSTANTS                             *02580000
026800******************************************************************02590000
026900     COPY SVWS004.                                                02600000
027000                                                                  02610000
027100******************************************************************02620000
027200*    VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004     *02630000
027300******************************************************************02640000
027400     COPY DPWS004.                                                02650000
027500                                                                  02660000
P10237******************************************************************02660100
P10237*  VARIABLES TO CONVERT FROM BASE64 TO BINARY & VICE VERSA       *02660200
P10237******************************************************************02660300
P10237     COPY DPWS022.                                                02660400
P10237                                                                  02660500
P10237******************************************************************02661000
P10237* LAYOUT THAT DEFINES THE PARAMETERS NEEDED TO INVOKE PROTEGRITY *02662000
P10237* MODULE                                                         *02663000
P10237******************************************************************02664000
P10237     COPY PTYCCSIP.                                               02665000
P10237                                                                  02666000
P10237******************************************************************02667000
P10237* LAYOUT THAT DEFINES THE WORKING VARIABLES TO INVOKE PROTEGRITY *02668000
P10237* MODULE                                                         *02669000
P10237******************************************************************02669100
P10237     COPY DPWS031.                                                02669214
P10237                                                                  02669300
027600******************************************************************02670000
027700*    SV-KOHL'S STORED VALUE CARD TABLE                           *02680000
027800******************************************************************02690000
027900     EXEC SQL                                                     02700000
028000         INCLUDE SVT00001                                         02710000
028100     END-EXEC.                                                    02720000
028200                                                                  02730000
028300******************************************************************02740000
028400*    SV-KOHL'S STORED VALUE CARD ACTIVITY TABLE                  *02750000
028500******************************************************************02760000
028600     EXEC SQL                                                     02770000
028700         INCLUDE SVT00002                                         02780000
028800     END-EXEC.                                                    02790000
028900                                                                  02800000
029000******************************************************************02810000
029100*       KOHL'S COSA-PARTITIONING TABLE                           *02820000
029200******************************************************************02830000
029300     EXEC SQL                                                     02840000
029400         INCLUDE TEPPART                                          02850000
029500     END-EXEC.                                                    02860000
029600                                                                  02870000
029700******************************************************************02880000
029800*       KOHL'S COSA ORDER ECOMMERCE TABLE                        *02890000
029900******************************************************************02900000
030000*    EXEC SQL                                                     02910000
030100*        INCLUDE TEPORD                                           02920000
030200*    END-EXEC.                                                    02930000
030300*                                                                 02940000
029700******************************************************************02950000
029800*       KOHL'S COSA-TRANSACTION TABLE                            *02960000
029900******************************************************************02970000
030000     EXEC SQL                                                     02980000
030100         INCLUDE TEPTRN                                           02990000
030200     END-EXEC.                                                    03000000
030300                                                                  03010000
030400******************************************************************03020000
030500*       KOHL'S COSA-TENDER TABLE                                 *03030000
030600******************************************************************03031000
030700     EXEC SQL                                                     03032000
030800         INCLUDE TEPTND                                           03033000
030900     END-EXEC.                                                    03034000
031000                                                                  03035000
031100******************************************************************03036000
031200*       KOHL'S COSA-ITEM TABLE                                   *03037000
031300******************************************************************03038000
031400     EXEC SQL                                                     03039000
031500         INCLUDE TEPITM                                           03040000
031600     END-EXEC.                                                    03050000
031700                                                                  03060000
031800******************************************************************03070000
031900*       KOHL'S DOMAIN LOCATION TABLE                             *03080000
032000******************************************************************03090000
032100     EXEC SQL                                                     03100000
032200         INCLUDE XST00001                                         03110000
032300     END-EXEC.                                                    03120000
032400                                                                  03130000
032500******************************************************************03140000
032600*    STANDARD LAYOUT FOR THE SQL COMMUNCATIONS AREA              *03150000
032700******************************************************************03160000
032800     EXEC SQL                                                     03170000
032900         INCLUDE SQLCA                                            03180000
033000     END-EXEC.                                                    03190000
033100                                                                  03200000
033200     COPY SQLCA2.                                                 03210000
033300                                                                  03220000
033400*---------------------------------------------------------------* 03230000
033500*    CURSOR TO EXTRACT TNDR_ID FROM COSA TENDER TABLE           * 03240000
033600*---------------------------------------------------------------* 03250000
033700                                                                  03260000
033800     EXEC SQL                                                     03270000
033900         DECLARE PTNDR-CSR CURSOR                                 03280000
034000          FOR SELECT                                              03290000
034100                TNDR_ID                                           03300000
034200               ,TNDR_ID_LEN_NBR                                   03310000
034300          FROM                                                    03320000
034400                TEPPART P                                         03330000
034500              , TEPTND  N                                         03340000
034600          WHERE                                                   03350000
034700                P.SLS_DTE     =  :SV022-POS-DTE                   03360000
034900            AND P.PARTN_NBR   =  N.PARTN_NBR                      03370000
035000            AND N.STR_NBR     =  :SV022-STR-NBR                   03380000
035100            AND N.RGST_ID     =  :SV022-TRMNL-NBR                 03390000
034800            AND N.TRN_NBR     =  :SV022-TRN-NBR                   03400000
035200            AND N.TNDR_TYP_CDE  IN ('02','13')                    03410000
035300            AND N.TNDR_AMT    =   :EPTND-TNDR-AMT                 03420000
035400           WITH UR                                                03430000
035500     END-EXEC.                                                    03440000
035600*---------------------------------------------------------------* 03450000
035700*    CURSOR TO EXTRACT MDSE_ID FROM COSA ITEM TABLE             * 03460000
035800*---------------------------------------------------------------* 03470000
035900                                                                  03480000
036000     EXEC SQL                                                     03490000
036100         DECLARE GISSU-CSR CURSOR                                 03500000
036200          FOR SELECT                                              03510000
036300                MDSE_ID                                           03520000
036400          FROM                                                    03530000
036500                TEPPART P                                         03540000
036600              , TEPITM  I                                         03550000
036700          WHERE                                                   03560000
036800                P.SLS_DTE     =   :SV022-POS-DTE                  03570000
036900            AND P.PARTN_NBR   =  I.PARTN_NBR                      03580000
037000            AND STR_NBR       =   :SV022-STR-NBR                  03590000
037100            AND RGST_ID       =   :SV022-TRMNL-NBR                03600000
037200*           AND TRN_NBR       =   :SV022-TRN-NBR                  03610000
037300            AND DEPT_NBR      =   '983'                           03620000
037400            AND CUST_CHRGD_AMT =   :SV022-APP-AUTH-AMT            03630000
037500           WITH UR                                                03640000
037600     END-EXEC.                                                    03650000
037700*---------------------------------------------------------------* 03660000
037800*    CURSOR TO EXTRACT TNDR_ID VOID FROM COSA TENDER TABLE      * 03670000
037900*---------------------------------------------------------------* 03680000
038000                                                                  03690000
038100     EXEC SQL                                                     03700000
038200         DECLARE GVOID-CSR CURSOR                                 03710000
038300          FOR SELECT                                              03720000
038400                TNDR_ID                                           03730000
038500               ,TNDR_ID_LEN_NBR                                   03740000
038600          FROM                                                    03750000
038700                TEPPART P                                         03760000
038800              , TEPTND  N                                         03770000
038900          WHERE                                                   03780000
039000                P.SLS_DTE     =   :SV022-POS-DTE                  03790000
039100            AND P.PARTN_NBR   =  N.PARTN_NBR                      03800000
039200            AND N.STR_NBR     =   :SV022-STR-NBR                  03810000
039300            AND N.RGST_ID     =   :SV022-TRMNL-NBR                03820000
039400            AND N.TRN_NBR     =   :SV022-TRN-NBR                  03830000
039500            AND TNDR_TYP_CDE  IN  ('02', '13')                    03840000
039600            AND TNDR_VOID_IND =   :SV004-VOID-TRANS               03850000
039700            AND TNDR_AMT      = 0                                 03860000
039800           WITH UR                                                03870000
039900     END-EXEC.                                                    03880000
040000*---------------------------------------------------------------* 03890000
040100*    CURSOR TO EXTRACT MDSE_ID VOID FROM COSA TENDER TABLE      * 03900000
040200*---------------------------------------------------------------* 03910000
040300                                                                  03920000
040400     EXEC SQL                                                     03930000
040500         DECLARE VISSU-CSR CURSOR                                 03940000
040600          FOR SELECT                                              03950000
040700                MDSE_ID                                           03960000
040800          FROM                                                    03970000
040900                TEPPART P                                         03980000
041000              , TEPITM  I                                         03990000
041100          WHERE                                                   04000000
041200                P.SLS_DTE     =   :SV022-POS-DTE                  04010000
041300            AND P.PARTN_NBR   =  I.PARTN_NBR                      04020000
041400            AND STR_NBR       =   :SV022-STR-NBR                  04030000
041500            AND RGST_ID       =   :SV022-TRMNL-NBR                04040000
041600            AND TRN_NBR       =   :SV022-TRN-NBR                  04050000
041700            AND DEPT_NBR      =   '983'                           04060000
041800            AND CUST_CHRGD_AMT = 0                                04070000
041900           WITH UR                                                04080000
042000     END-EXEC.                                                    04090000
042100                                                                  04100000
042200*---------------------------------------------------------------* 04110000
042300*    CURSOR TO EXTRACT ALL ECOMMERCE STORE NUMBERS FROM XST00001* 04120000
042400*---------------------------------------------------------------* 04130000
042500                                                                  04140000
042600     EXEC SQL                                                     04150000
042700        DECLARE XSTR-CSR CURSOR                                   04160000
042800        FOR SELECT LOC_NBR                                        04170000
042900              FROM XST_LOC                                        04180000
043000            WHERE  E_BUS_IND    = 'Y'                             04190000
043100              AND  LOC_TYP_CDE  = 'DS'                            04200000
043200     END-EXEC.                                                    04210000
043300                                                                  04220000
043400 PROCEDURE DIVISION.                                              04230000
043500******************************************************************04240000
043600 A100-MAINLINE.                                                   04250000
043700******************************************************************04260000
043800     PERFORM B100-INITIALIZE.                                     04270000
043900                                                                  04280000
044000     PERFORM B200-COMPARE-SVT00002-FILES                          04290000
044100         UNTIL PS-END-OF-SVT00002-FILE                            04300000
044200            OR PS-END-OF-DAILY-POS-FILE.                          04310000
044300                                                                  04320000
044400     IF PS-END-OF-SVT00002-FILE                                   04330000
044500         PERFORM B300-PROCESS-REST-POS-FILE                       04340000
044600             UNTIL PS-END-OF-DAILY-POS-FILE                       04350000
044700     ELSE                                                         04360000
044800         PERFORM B400-PROCESS-REST-SVT0002-FILE                   04370000
044900             UNTIL PS-END-OF-SVT00002-FILE                        04380000
045000     END-IF.                                                      04390000
045100                                                                  04400000
045200     PERFORM B500-EOJ-ROUTINE.                                    04410000
045300                                                                  04420000
045400     GOBACK.                                                      04430000
045500                                                                  04440000
045600******************************************************************04450000
045700*     B100-INITIALIZE                                            *04460000
045800* ==> PROCESSES:                                                 *04470000
045900*     - OPENS THE FILES                                          *04480000
046000*     - READS THE FIRST RECORD FROM THE                          *04490000
046100*     - SVT_KOHLS_CRD_TXN AND THE POS *                           04500000
046200*       EXTRACT FILES                                            *04510000
046300* ==> PERFORMED FROM: A100-MAINLINE                              *04520000
046400******************************************************************04530000
046500 B100-INITIALIZE.                                                 04540000
046600                                                                  04550000
046700     OPEN INPUT  DAILY-SVT00002-ACTIVITY                          04560000
046800                 DAILY-POS-ACTIVITY                               04570000
046900                 CONTROL-DATE-FILE                                04580021
046900                 CUTOFF-SHIP-DAYS.                                04581021
047000     OPEN OUTPUT KMC-POSTING-FILE                                 04590000
047100                 AUDIT-REPORT-FILE                                04600000
047200                 TOTAL-DETAIL-FILE                                04610000
047300                 TOTAL-FILE.                                      04620000
047400                                                                  04630000
047500     READ CONTROL-DATE-FILE INTO CR-CONTROL-RECORD                04640021
047600         AT END                                                   04650000
047700             SET PS-END-OF-CONTROL-FILE TO TRUE.                  04660000
047800                                                                  04670000
047900     IF PS-END-OF-CONTROL-FILE                                    04680000
048000         DISPLAY ' '                                              04690000
048100         DISPLAY '** ABEND     **'                                04700000
048200         DISPLAY '** PROGRAM   **  = ' PC-PROGRAM-NAME            04710000
048300         DISPLAY '** PARAGRAPH **  = B100-INITIALIZE      '       04720000
048400         DISPLAY '** CONTROL DATE FILE IS EMPTY  '                04730000
048500         DISPLAY ' '                                              04740000
048600         MOVE +4002 TO ABEND-CODE                                 04750000
048700         CALL WS-ABEND-ROUTINE USING ABEND-CODE                   04760000
048800     ELSE                                                         04770000
048900         DISPLAY PC-PROGRAM-NAME ' CONTROL DATE:  '               04780000
049000                 CR-CONTROL-DATE                                  04790000
049100     END-IF.                                                      04800000
                                                                        04800121
           MOVE 'N' TO PS-END-OF-CONTROL-FILE-SW.                       04800221
047500     READ CUTOFF-SHIP-DAYS  INTO PV-CUTOFF-SHIP-RECORD            04801021
047600         AT END                                                   04802021
047700             SET PS-END-OF-CONTROL-FILE TO TRUE.                  04803021
047800                                                                  04804021
047900     IF PS-END-OF-CONTROL-FILE                                    04805021
048000         DISPLAY ' '                                              04806021
048100         DISPLAY '** ABEND     **'                                04807021
048200         DISPLAY '** PROGRAM   **  = ' PC-PROGRAM-NAME            04808021
048300         DISPLAY '** PARAGRAPH **  = B100-INITIALIZE      '       04809021
048400         DISPLAY '** SHIP CUTOFF DAYS FILE IS EMPTY  '            04809121
048500         DISPLAY ' '                                              04809221
048600         MOVE +4002 TO ABEND-CODE                                 04809321
048700         CALL WS-ABEND-ROUTINE USING ABEND-CODE                   04809421
049100     END-IF.                                                      04809821
049200                                                                  04810000
P10237     MOVE PC-PROGRAM-NAME TO DP031-PROGRAM-NAME.                  04811014
049300     INITIALIZE SV043-RECORD.                                     04820000
049400     PERFORM B110-OPEN-XSTR-CSR.                                  04830000
049500     PERFORM B112-FETCH-XSTR-CSR UNTIL PS-END-OF-XSTR-CSR.        04840000
049600     PERFORM B114-CLOSE-XSTR-CSR.                                 04850000
049600     PERFORM B115-CALC-CUTOFF-SHIP-DATE.                          04851023
049700     PERFORM Y100-READ-SVT00002-ACTIVITY.                         04860000
049800     PERFORM Y200-READ-POS-ACTIVITY.                              04870000
049900                                                                  04880000
050000*----------------------------------------------------------------*04890000
050100* OPEN THE XST00001 CURSOR                                       *04900000
050200*----------------------------------------------------------------*04910000
050300 B110-OPEN-XSTR-CSR.                                              04920000
050400     EXEC SQL                                                     04930000
050500         OPEN XSTR-CSR                                            04940000
050600     END-EXEC.                                                    04950000
050700     EVALUATE TRUE                                                04960000
050800        WHEN SQLCODE = ZERO                                       04970000
050900             CONTINUE                                             04980000
051000        WHEN OTHER                                                04990000
051100             MOVE 'B110-OPEN-XSTR-CSR'                            05000000
051200                               TO PV-PARAGRAPH-NAME               05010000
051300             MOVE 'OPEN E STORE CURSOR - '                        05020000
051400                               TO PV-DB2-OPERATION-ATTEMPTED      05030000
051500             PERFORM Z900-SQL-ABEND                               05040000
051600     END-EVALUATE.                                                05050000
051700                                                                  05060000
051800******************************************************************05070000
051900*     B112-FETCH-XSTR-CSR                                        *05080000
052000* ==> PROCESSES:                                                 *05090000
052100*     - CHECK THE LOCATION DOMAIN TABLE FOR ECOMMERCE STORES     *05100000
052200******************************************************************05110000
052300 B112-FETCH-XSTR-CSR.                                             05120000
052400     EXEC SQL                                                     05130000
052500          FETCH XSTR-CSR                                          05140000
052600          INTO :XST00001-LOC-NBR                                  05150000
052700     END-EXEC.                                                    05160000
052800                                                                  05170000
052900     EVALUATE SQLCODE                                             05180000
053000         WHEN ZERO                                                05190000
053100             ADD +1 TO PV-SUB                                     05200000
053200             MOVE XST00001-LOC-NBR TO PV-ECOMM-STR(PV-SUB)        05210000
053300         WHEN +100                                                05220000
053400             SET PS-END-OF-XSTR-CSR   TO TRUE                     05230000
053500             MOVE PV-SUB              TO PV-MAX-STORE             05240000
053600         WHEN OTHER                                               05250000
053700             MOVE 'B112-FETCH-XSTR-CSR'                           05260000
053800                               TO PV-PARAGRAPH-NAME               05270000
053900             MOVE 'FETCH E STORE CURSOR - '                       05280000
054000                               TO PV-DB2-OPERATION-ATTEMPTED      05290000
054100             PERFORM Z900-SQL-ABEND                               05300000
054200     END-EVALUATE.                                                05310000
054300                                                                  05320000
054400******************************************************************05330000
054500*     B114-CLOSE-XSTR-CSR                                        *05340000
054600* ==> PROCESSES:                                                 *05350000
054700*     - CLOSE THE E STORE CURSOR                                 *05360000
054800******************************************************************05370000
054900 B114-CLOSE-XSTR-CSR.                                             05380000
055000     EXEC SQL                                                     05390000
055100         CLOSE XSTR-CSR                                           05400000
055200     END-EXEC.                                                    05410000
055300                                                                  05420000
055400     EVALUATE TRUE                                                05430000
055500         WHEN SQLCODE = ZERO                                      05440000
055600            CONTINUE                                              05450000
055700         WHEN OTHER                                               05460000
055800             MOVE 'B114-CLOSE-XSTR-CSR'                           05470000
055900                               TO PV-PARAGRAPH-NAME               05480000
056000             MOVE 'CLOSE E STORE CURSOR - '                       05490000
056100                               TO PV-DB2-OPERATION-ATTEMPTED      05500000
056200             PERFORM Z900-SQL-ABEND                               05510000
056300     END-EVALUATE.                                                05520000
056400                                                                  05530000
126100******************************************************************05531020
126200*     B115-CALC-CUTOFF-SHIP-DATE                                 *05532023
126700******************************************************************05537020
126800 B115-CALC-CUTOFF-SHIP-DATE.                                      05538023
126900                                                                  05539020
127000     INITIALIZE DPG51 DPG52 DPG53                                 05539120
127100                DPG54 DPG55 DPG56.                                05539220
127200                                                                  05539320
127300     SET DPG51-ACTUAL-CALENDAR-ONLY  TO TRUE.                     05539420
127400     SET DPG51-INCREMENT-DATE        TO TRUE.                     05539520
127500     MOVE PV-CUTOFF-SHIP-DAYS        TO DPG51-INCR-DECR-DAYS-9.   05539621
127600                                                                  05539720
127700     MOVE CR-CONTROL-DATE            TO DPG52-LK-DATE-INPUT.      05539821
127800     SET DPG52-LK-DTE-ISO-FMT        TO TRUE.                     05539920
127900                                                                  05540020
128000     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52          05540120
128100                                             DPG53 DPG54          05540220
128200                                             DPG55 DPG56          05540320
128300                                                                  05540420
128400     EVALUATE TRUE                                                05540520
128500         WHEN DPG54-SEVERE-ERROR                                  05540620
128600         WHEN DPG54-DATE-INVALID                                  05540720
128700             DISPLAY ' '                                          05540820
128800             DISPLAY '** ABEND     **'                            05540920
128900             DISPLAY '** PROGRAM   **  = ' PC-PROGRAM-NAME        05541020
129000             DISPLAY '** PARAGRAPH **  = B115-CALC-CUTOFF'        05541123
129100             DISPLAY '** BAD CALL TO CALENDAR MODULE '            05541220
129200                 DP500-KOHLS-CALENDAR-ROUTINE                     05541320
129300             DISPLAY DPG54-ERROR-MESSAGE                          05541420
129500             MOVE +4019 TO ABEND-CODE                             05541720
129600             CALL WS-ABEND-ROUTINE USING ABEND-CODE               05541820
129700     END-EVALUATE.                                                05541920
129800                                                                  05542020
129900     MOVE DPG55-DB2-ISO-DATE-FMT  TO  PV-SHIP-DATE-CUTOFF.        05542126
130000                                                                  05542220
056500*----------------------------------------------------------------*05543000
056600* OPEN THE POS-TNDR CURSOR                                       *05550000
056700*----------------------------------------------------------------*05560000
056800                                                                  05570000
056900 B120-OPEN-PTNDR-CSR.                                             05580000
057000     EXEC SQL                                                     05590000
057100         OPEN PTNDR-CSR                                           05600000
057200     END-EXEC.                                                    05610000
057300     EVALUATE TRUE                                                05620000
057400        WHEN SQLCODE = ZERO                                       05630000
057500             CONTINUE                                             05640000
057600        WHEN OTHER                                                05650000
057700             MOVE 'B120-OPEN-PTNDR-CSR'                           05660000
057800                               TO PV-PARAGRAPH-NAME               05670000
057900             MOVE 'OPEN POS TNDR CURSOR - '                       05680000
058000                               TO PV-DB2-OPERATION-ATTEMPTED      05690000
058100             PERFORM Z900-SQL-ABEND                               05700000
058200     END-EVALUATE.                                                05710000
058300*----------------------------------------------------------------*05720000
058400* OPEN THE GISSU CURSOR                                          *05730000
058500* CURSOR TO EXTRACT MDSE_ID FROM COSA TENDER TABLE               *05740000
058600*----------------------------------------------------------------*05750000
058700                                                                  05760000
058800 B140-OPEN-GISSU-CSR.                                             05770000
058900     EXEC SQL                                                     05780000
059000         OPEN GISSU-CSR                                           05790000
059100     END-EXEC.                                                    05800000
059200     EVALUATE TRUE                                                05810000
059300        WHEN SQLCODE = ZERO                                       05820000
059400             CONTINUE                                             05830000
059500        WHEN OTHER                                                05840000
059600             MOVE 'B140-OPEN-GISSU-CSR'                           05850000
059700                               TO PV-PARAGRAPH-NAME               05860000
059800             MOVE 'OPEN GFT ISSU CURSOR - '                       05870000
059900                               TO PV-DB2-OPERATION-ATTEMPTED      05880000
060000             PERFORM Z900-SQL-ABEND                               05890000
060100     END-EVALUATE.                                                05900000
060200*----------------------------------------------------------------*05910000
060300* OPEN THE GVOID CURSOR                                          *05920000
060400*    CURSOR TO EXTRACT TNDR_ID VOID FROM COSA TENDER TABLE      * 05930000
060500*----------------------------------------------------------------*05940000
060600                                                                  05950000
060700 B170-OPEN-GVOID-CSR.                                             05960000
060800     EXEC SQL                                                     05970000
060900         OPEN GVOID-CSR                                           05980000
061000     END-EXEC.                                                    05990000
061100     EVALUATE TRUE                                                06000000
061200        WHEN SQLCODE = ZERO                                       06010000
061300             CONTINUE                                             06020000
061400        WHEN OTHER                                                06030000
061500             MOVE 'B170-OPEN-GVOID-CSR'                           06040000
061600                               TO PV-PARAGRAPH-NAME               06050000
061700             MOVE 'OPEN GFT VOID CURSOR - '                       06060000
061800                               TO PV-DB2-OPERATION-ATTEMPTED      06070000
061900             PERFORM Z900-SQL-ABEND                               06080000
062000     END-EVALUATE.                                                06090000
062100*----------------------------------------------------------------*06100000
062200* OPEN THE POS-TNDR CURSOR                                       *06110000
062300*----------------------------------------------------------------*06120000
062400                                                                  06130000
062500 B180-OPEN-VISSU-CSR.                                             06140000
062600     EXEC SQL                                                     06150000
062700         OPEN VISSU-CSR                                           06160000
062800     END-EXEC.                                                    06170000
062900     EVALUATE TRUE                                                06180000
063000        WHEN SQLCODE = ZERO                                       06190000
063100             CONTINUE                                             06200000
063200        WHEN OTHER                                                06210000
063300             MOVE 'B180-OPEN-VISSU-CSR'                           06220000
063400                               TO PV-PARAGRAPH-NAME               06230000
063500             MOVE 'OPEN VOID ISS CURSOR - '                       06240000
063600                               TO PV-DB2-OPERATION-ATTEMPTED      06250000
063700             PERFORM Z900-SQL-ABEND                               06260000
063800     END-EVALUATE.                                                06270000
063900******************************************************************06280000
064000*     B200-COMPARE-SVT00002-FILES.                               *06290000
064100* ==> PROCESSES:                                                 *06300000
064200*     - COMPARES INFORMATION FROM BOTH EXTRACT FILES TO SEE IF   *06310000
064300*       THERE IS A MATCH.  IF A MATCH IS FOUND AN UPDATE RECORD  *06320000
064400*       IS WRITTEN AND A RECORD IS READ FROM BOTH EXTRACT FILES. *06330000
064500*     - IF THE POS RECORD IS MISSING, AN AUDIT RECORD IS WRITTEN *06340000
064600*       AND ANOTHER POS RECORD IS READ.                          *06350000
064700*     - IF THE SVT00002 RECORD IS MISSING, THE                   *06360000
064800*     - SVT_KOHLS_CRD_TXN TABLE IS *                              06370000
064900*       QUERIED FOR THE PREVIOUS PC-NUMBER-DAYS-TO-CHECK TO SEE  *06380000
065000*       IF A MATCH CAN BE FOUND.   IF A MATCH IS FOUND, AN       *06390000
065100*       UPDATE RECORD IS WRITTEN.  IF A MATCH IS NOT FOUND, AN   *06400000
065200*       AUDIT RECORD IS WRITTEN.  IN EITHER CASE ANOTHER         *06410000
065300*        SVT00002 RECORD IS READ.                                *06420000
065400*     - **** NOTE:  REVERSAL CODE SHOULD BE ADDED TO COMPARISON  *06430000
065500*                   WHEN POS EXTRACT IS CHANGED TO PASS THIS     *06440000
065600*                   VALUE.                                       *06450000
065700* ==> PERFORMED FROM: A100-MAINLINE                              *06460000
065800******************************************************************06470000
065900 B200-COMPARE-SVT00002-FILES.                                     06480000
R66000                                                                  06490000
066100     IF SV022-CRD-NBR = SV021-CRD-NBR                             06500000
066600       IF SV022-APP-AUTH-AMT  = SV021-APP-AUTH-AMT                06510000
P12431         IF ((SV022-POS-OPER-ID = SV021-POS-OPER-ID AND           06520035
P12431             SV022-POS-OPER-ID > 0) OR                            06530035
P12431            (SV022-ORD-NBR     = SV021-ORD-NBR AND                06531035
P12431             SV022-ORD-NBR     NOT EQUAL SPACES ))                06532035
066700           IF SV022-TRN-VOID-IND  = SV021-TRN-VOID-IND            06540000
066800               PERFORM D100-MATCH-PROCESS                         06550000
066900               PERFORM Y200-READ-POS-ACTIVITY                     06560000
067000               PERFORM Y100-READ-SVT00002-ACTIVITY                06570000
067100           ELSE                                                   06580000
067200               IF SV022-TRN-VOID-IND > SV021-TRN-VOID-IND         06590000
067300                    PERFORM C600-CHECK-FOR-ORIG-POS-VOID          06600000
067400               ELSE                                               06610000
067500                    PERFORM C000-CHECK-SVT-KOHLS-CRD-TXN          06620000
067600                    IF PS-MISSING-SVT00002-TRAN-FOUND             06630000
067700                        PERFORM Y100-READ-SVT00002-ACTIVITY       06640000
067800                    END-IF                                        06650000
067900                    PERFORM Y200-READ-POS-ACTIVITY                06660000
068000               END-IF                                             06670000
068000           END-IF                                                 06680000
067400         ELSE                                                     06690000
P12431           IF ((SV022-POS-OPER-ID > SV021-POS-OPER-ID) OR         06700036
P12431              (SV022-ORD-NBR     > SV021-ORD-NBR AND              06711036
P12431               SV022-ORD-NBR NOT EQUAL SPACES))                   06712036
071000              PERFORM C000-CHECK-SVT-KOHLS-CRD-TXN                06720000
071100              PERFORM Y200-READ-POS-ACTIVITY                      06730000
071200           ELSE                                                   06740000
071300              PERFORM C100-MISSING-POS-RECORD                     06750000
071400              IF PS-KMC-REC-SAVED-NO                              06760000
071500                 PERFORM Y100-READ-SVT00002-ACTIVITY              06770000
071600              ELSE                                                06780000
071700                 SET PS-KMC-REC-SAVED-NO TO TRUE                  06790000
071800              END-IF                                              06800000
072000           END-IF                                                 06810000
074700       ELSE                                                       06820000
068300          IF SV022-APP-AUTH-AMT > SV021-APP-AUTH-AMT              06830000
068400             PERFORM C000-CHECK-SVT-KOHLS-CRD-TXN                 06840000
068500             PERFORM Y200-READ-POS-ACTIVITY                       06850000
068600          ELSE                                                    06860000
068700             PERFORM C100-MISSING-POS-RECORD                      06870000
068800             IF PS-KMC-REC-SAVED-NO                               06880000
068900                PERFORM Y100-READ-SVT00002-ACTIVITY               06890000
069000             ELSE                                                 06900000
069100                SET PS-KMC-REC-SAVED-NO TO TRUE                   06910000
069200             END-IF                                               06920000
068000          END-IF                                                  06930000
074700     ELSE                                                         06940000
074800       IF SV022-CRD-NBR > SV021-CRD-NBR                           06950000
074900          PERFORM C000-CHECK-SVT-KOHLS-CRD-TXN                    06960000
075000          PERFORM Y200-READ-POS-ACTIVITY                          06970000
075100       ELSE                                                       06980000
075200          PERFORM C100-MISSING-POS-RECORD                         06990000
075300          IF PS-KMC-REC-SAVED-NO                                  07000000
075400             PERFORM Y100-READ-SVT00002-ACTIVITY                  07010000
075500          ELSE                                                    07020000
075600             SET PS-KMC-REC-SAVED-NO TO TRUE                      07030000
075700          END-IF                                                  07040000
075800       END-IF                                                     07050000
075900     END-IF.                                                      07060000
076000                                                                  07070000
076100******************************************************************07080000
076200*     B300-PROCESS-REST-POS-FILE                                 *07090000
076300* ==> PROCESSES:                                                 *07100000
076400*     - PROCESSES THE REST OF THE POS EXTRACT RECORDS.           *07110000
076500*     - WRITES OUT AN AUDIT RECORD FOR THE MISSING               *07120000
076600*     - SVT00002 RECORD.                                         *07130000
076700* ==> PERFORMED FROM: A100-MAINLINE                              *07140000
076800******************************************************************07150000
076900 B300-PROCESS-REST-POS-FILE.                                      07160000
077000                                                                  07170000
077100     PERFORM C000-CHECK-SVT-KOHLS-CRD-TXN.                        07180000
077200     PERFORM Y200-READ-POS-ACTIVITY.                              07190000
077300                                                                  07200000
077400******************************************************************07210000
077500*     B400-PROCESS-REST-SVT0002-FILE                            * 07220000
077600* ==> PROCESSES:                                                 *07230000
077700*     - PROCESSES THE REST OF THE SVT00002 EXTRACT RECORDS.      *07240000
077800*     - WRITES OUT AN AUDIT RECORD FOR THE MISSING POS RECORD.   *07250000
077900* ==> PERFORMED FROM: A100-MAINLINE                              *07260000
078000******************************************************************07270000
078100 B400-PROCESS-REST-SVT0002-FILE.                                  07280000
078200                                                                  07290000
078300     PERFORM C100-MISSING-POS-RECORD.                             07300000
078400     IF PS-KMC-REC-SAVED-NO                                       07310000
078500          PERFORM Y100-READ-SVT00002-ACTIVITY                     07320000
078600     ELSE                                                         07330000
078700          SET PS-KMC-REC-SAVED-NO TO TRUE                         07340000
078800     END-IF.                                                      07350000
078900                                                                  07360000
079000******************************************************************07370000
079100*     B500-EOJ-ROUTINE                                           *07380000
079200* ==> PROCESSES:                                                 *07390000
079300*     - CLOSES THE FILES.                                        *07400000
079400*     - DISPLAYS THE PROGRAM COUNTS TO SYSOUT.                   *07410000
079500* ==> PERFORMED FROM: A100-MAINLINE                              *07420000
079600******************************************************************07430000
079700 B500-EOJ-ROUTINE.                                                07440000
079800                                                                  07450000
079900     WRITE TOTAL-RECORD FROM SV043-RECORD.                        07460000
080000                                                                  07470000
080100     CLOSE DAILY-SVT00002-ACTIVITY                                07480000
080200           DAILY-POS-ACTIVITY                                     07490000
080300           CONTROL-DATE-FILE                                      07500000
080400           KMC-POSTING-FILE                                       07510000
080500           AUDIT-REPORT-FILE                                      07520000
080600           TOTAL-DETAIL-FILE                                      07530000
080700           TOTAL-FILE.                                            07540000
080800                                                                  07550000
080900     DISPLAY ' '.                                                 07560000
081000     DISPLAY 'MESSAGES FOR PROGRAM ' PC-PROGRAM-NAME.             07570000
081100     DISPLAY 'NUMBER OF SVT00002 EXTRACT RECORDS READ:       '    07580000
081200             PA-SVT00002-ACTIVITY-RECS-READ.                      07590000
081300     DISPLAY 'NUMBER OF DAILY SALES EXTRACT RECORDS READ:  '      07600000
081400             PA-SALES-ACTIVITY-RECS-READ.                         07610000
081500     DISPLAY 'NUMBER OF UPDATE/INSERT RECORDS WRITTEN:     '      07620000
081600             PA-UPDATE-RECORDS-WRITTEN.                           07630000
081700     DISPLAY 'NUMBER OF AUDIT REPORT RECORDS WRITTEN:      '      07640000
081800             PA-AUDIT-RECORDS-WRITTEN.                            07650000
081900     DISPLAY ' '.                                                 07660000
082000                                                                  07670000
082100*----------------------------------------------------------------*07680000
082200* CLOSE THE POS-TNDR CURSOR                                      *07690000
082300*----------------------------------------------------------------*07700000
082400                                                                  07710000
082500 B520-CLOSE-PTNDR-CSR.                                            07720000
082600     EXEC SQL                                                     07730000
082700         CLOSE PTNDR-CSR                                          07740000
082800     END-EXEC.                                                    07750000
082900                                                                  07760000
083000     EVALUATE TRUE                                                07770000
083100         WHEN SQLCODE = ZERO                                      07780000
083200            CONTINUE                                              07790000
083300         WHEN OTHER                                               07800000
083400             MOVE 'B520-CLOSE-PTNDR-CSR'                          07810000
083500                               TO PV-PARAGRAPH-NAME               07820000
083600             MOVE 'CLOSE POS TNDR CURSOR - '                      07830000
083700                               TO PV-DB2-OPERATION-ATTEMPTED      07840000
083800             PERFORM Z900-SQL-ABEND                               07850000
083900     END-EVALUATE.                                                07860000
084000                                                                  07870000
084100*----------------------------------------------------------------*07880000
084200* CLOSE THE GISSU CURSOR                                         *07890000
084300* CURSOR TO EXTRACT MDSE_ID FROM COSA TENDER TABLE               *07900000
084400*----------------------------------------------------------------*07910000
084500                                                                  07920000
084600 B540-CLOSE-GISSU-CSR.                                            07930000
084700     EXEC SQL                                                     07940000
084800         CLOSE GISSU-CSR                                          07950000
084900     END-EXEC.                                                    07960000
085000                                                                  07970000
085100     EVALUATE TRUE                                                07980000
085200         WHEN SQLCODE = ZERO                                      07990000
085300            CONTINUE                                              08000000
085400         WHEN OTHER                                               08010000
085500             MOVE 'B540-CLOSE-GISSU-CSR'                          08020000
085600                               TO PV-PARAGRAPH-NAME               08030000
085700             MOVE 'CLOSE GFT ISSU CURSOR - '                      08040000
085800                               TO PV-DB2-OPERATION-ATTEMPTED      08050000
085900             PERFORM Z900-SQL-ABEND                               08060000
086000     END-EVALUATE.                                                08070000
086100                                                                  08080000
086200*----------------------------------------------------------------*08090000
086300* CLOSE THE GVOID CURSOR                                         *08100000
086400*    CURSOR TO EXTRACT TNDR_ID VOID FROM COSA TENDER TABLE      * 08110000
086500*----------------------------------------------------------------*08120000
086600                                                                  08130000
086700 B570-CLOSE-GVOID-CSR.                                            08140000
086800     EXEC SQL                                                     08150000
086900         CLOSE GVOID-CSR                                          08160000
087000     END-EXEC.                                                    08170000
087100                                                                  08180000
087200     EVALUATE TRUE                                                08190000
087300         WHEN SQLCODE = ZERO                                      08200000
087400            CONTINUE                                              08210000
087500         WHEN OTHER                                               08220000
087600             MOVE 'B570-CLOSE-GVOID-CSR'                          08230000
087700                               TO PV-PARAGRAPH-NAME               08240000
087800             MOVE 'CLOSE GFT VOID CURSOR - '                      08250000
087900                               TO PV-DB2-OPERATION-ATTEMPTED      08260000
088000             PERFORM Z900-SQL-ABEND                               08270000
088100     END-EVALUATE.                                                08280000
088200                                                                  08290000
088300*----------------------------------------------------------------*08300000
088400* CLOSE THE POS-TNDR CURSOR                                      *08310000
088500*----------------------------------------------------------------*08320000
088600                                                                  08330000
088700 B580-CLOSE-VISSU-CSR.                                            08340000
088800     EXEC SQL                                                     08350000
088900         CLOSE VISSU-CSR                                          08360000
089000     END-EXEC.                                                    08370000
089100                                                                  08380000
089200     EVALUATE TRUE                                                08390000
089300         WHEN SQLCODE = ZERO                                      08400000
089400            CONTINUE                                              08410000
089500         WHEN OTHER                                               08420000
089600             MOVE 'B580-CLOSE-VISSU-CSR'                          08430000
089700                               TO PV-PARAGRAPH-NAME               08440000
089800             MOVE 'CLOSE VOID ISS CURSOR - '                      08450000
089900                               TO PV-DB2-OPERATION-ATTEMPTED      08460000
090000             PERFORM Z900-SQL-ABEND                               08470000
090100     END-EVALUATE.                                                08480000
090200                                                                  08490000
090300******************************************************************08500000
090400 C000-CHECK-SVT-KOHLS-CRD-TXN.                                    08510000
090500     SET PS-MISS-SVT00002-TRAN-NOT-FND TO TRUE.                   08520000
090600     MOVE SV021-POS-DTE TO PV-POS-DATE.                           08530000
090700     PERFORM C200-CALCULATE-CUTOFF-DATE.                          08540000
090800     PERFORM C300-LOOK-FOR-MISSING-TRANS                          08550000
090900         VARYING PV-DATE-COUNTER FROM 1 BY 1                      08560000
091000         UNTIL PS-MISSING-SVT00002-TRAN-FOUND                     08570000
091100            OR PV-POS-DATE < PV-POS-CUTOFF-DATE                   08580000
091200            OR PV-DATE-COUNTER > PC-NUMBER-DAYS-TO-CHECK.         08590000
091300     IF PS-MISSING-SVT00002-TRAN-FOUND                            08600000
091400         PERFORM C400-FOUND-MATCH-PROCESS                         08610000
091500     ELSE                                                         08620000
091600        PERFORM C500-MISSING-SVT00002-RECORD                      08630000
091700     END-IF.                                                      08640000
091800******************************************************************08650000
091900*     C100-MISSING-POS-RECORD                                    *08660000
092000* ==> PROCESSES:                                                 *08670000
092100*     - CHECK THE POS DATE ON THE KMRC RECORD.  WHEN IT IS LESS  *08680000
092200*       THAN THE CONTROL DATE, LOOK FOR THE TRANSACTION ON THE   *08690000
092300*       COSA TABLES USING THE POS DATE.  IF IT IS FOUND WRITE    *08700000
092400*       THE TRANSACTION TO THE UPDATE FILE OTHERWISE WRITE IT    *08710000
092500*       TO THE AUDIT FILE.                                       *08720000
092600*     - IF AN ISSUANCE COMES FROM THE ON-LINE ISSUANCE OF CARDS  *08730000
092700*       THEY WILL NOT BE FOUND ON THE POS FILE.  THESE CARDS     *08740000
092800*       WILL HAVE AN APPROVAL USER ID OF RDUCRD, WHICH IS THE    *08750000
092900*       MNEMONIC.  WE DONT WANT TO FLAG THESE CARDS AS HAVING A  *08760000
093000*       MISSING POS TRANSACTION, SO THEY WILL BE PASSED TO THE   *08770000
093100*       UPDATE PROGRAM AS AN OK TRANSACTION.  THE ACTIVITY STATUS*08780000
093200*       WILL BE CHANGED TO VERIFIED.                             *08790000
093300*     - WRITES OUT AN AUDIT RECORD FOR THE MISSING POS RECORD    *08800000
093400*       AND FLAGS IT AS A VOID OR NORMAL TRANSACTION             *08810000
093500*     - CHECKS FOR AN OVERRIDDEN DOLLAR AMOUNT                   *08820000
093600*     - CHECKS FOR AN OVERTENDERED BALANCE FOR THE DAY           *08830000
093700* ==> PERFORMED FROM:  B200-COMPARE-SVT00002-FILES               *08840000
093800*                      B400-PROCESS-REST-SVT0002-FILE           * 08850000
093900******************************************************************08860000
094000 C100-MISSING-POS-RECORD.                                         08870000
094100                                                                  08880000
094200     SET PS-KMC-REC-SAVED-NO       TO TRUE.                       08890000
094300     COMPUTE EPTND-TNDR-AMT =                                     08900000
094400             SV022-APP-AUTH-AMT * -1                              08910000
094500     END-COMPUTE.                                                 08920000
094600                                                                  08930000
094700     IF SV022-POS-DTE = CR-CONTROL-DATE                           08940000
094800         SET PS-KMC-REC-SAVED-NO-MATCH TO TRUE                    08950000
094900         PERFORM C110-CHECK-FOR-VOID                              08960000
095000     ELSE                                                         08970000
095100         SET PS-KMC-REC-SAVED-MATCH    TO TRUE                    08980000
095200         IF SV022-CRD-TYP-CDE = 1                                 08990000
095300             SET PS-NOT-FOUND-PTNDR-TRANS  TO TRUE                09000000
095400             SET PS-NOT-END-OF-PTNDR-CSR   TO TRUE                09010000
095500                                                                  09020000
095600             PERFORM B120-OPEN-PTNDR-CSR                          09030000
095700             PERFORM C120-FETCH-PTNDR-CSR                         09040000
095800               UNTIL PS-FOUND-PTNDR-TRANS                         09050000
095900                  OR PS-END-OF-PTNDR-CSR                          09060000
096000             PERFORM B520-CLOSE-PTNDR-CSR                         09070000
096100         ELSE                                                     09080000
096200             IF SV022-ACTVY-TYP-CDE = 3                           09090000
096300                 SET PS-NOT-FOUND-PTNDR-TRANS  TO TRUE            09100000
096400                 SET PS-NOT-END-OF-PTNDR-CSR   TO TRUE            09110000
096500                 PERFORM B120-OPEN-PTNDR-CSR                      09120000
096600                 PERFORM C120-FETCH-PTNDR-CSR                     09130000
096700                   UNTIL PS-FOUND-PTNDR-TRANS                     09140000
096800                      OR PS-END-OF-PTNDR-CSR                      09150000
096900                 PERFORM B520-CLOSE-PTNDR-CSR                     09160000
097000             ELSE                                                 09170000
097100                 SET PS-NOT-FOUND-GISSU-TRANS  TO TRUE            09180000
097200                 SET PS-NOT-END-OF-GISSU-CSR   TO TRUE            09190000
097300                 PERFORM B140-OPEN-GISSU-CSR                      09200000
097400                 PERFORM C140-FETCH-GISSU-CSR                     09210000
097500                   UNTIL PS-FOUND-GISSU-TRANS                     09220000
097600                      OR PS-END-OF-GISSU-CSR                      09230000
097700                 PERFORM B540-CLOSE-GISSU-CSR                     09240000
097800             END-IF                                               09250000
097900         END-IF                                                   09260000
098000     END-IF.                                                      09270000
098100                                                                  09280000
098200                                                                  09290000
098300     IF PS-KMC-REC-SAVED-NO-MATCH                                 09300000
098400         IF PS-KMC-REC-SAVED-YES                                  09310000
098500             MOVE SV022-KMCACT-EXTRACT-RECORD                     09320000
098600               TO PV-HOLD-SV022-RECORD                            09330000
098700             MOVE PV-SAVE-SV022-RECORD                            09340000
098800               TO SV022-KMCACT-EXTRACT-RECORD                     09350000
098900         END-IF                                                   09360000
099000                                                                  09370000
099100         MOVE +1 TO PV-SUB                                        09380000
099200         SET PS-NOT-ECOMM-STR TO TRUE                             09390000
099300         MOVE SV022-STR-NBR TO PV-STORE-NBR                       09400000
099400         PERFORM Z600-ECOMM-STR UNTIL PV-SUB > PV-MAX-STORE       09410000
099500                                                                  09420000
099600         IF ((SV022-APPR-USER-ID = SV004-ISSUE-MNEMONIC AND       09430000
099700              PS-NOT-ECOMM-STR)                                   09440000
099800             OR SV022-APPR-USER-ID = PC-PEPLSOFT)                 09450000
099900             PERFORM D100-MATCH-PROCESS                           09460000
100000         ELSE                                                     09470000
100100             IF SV022-TRN-VOID-IND = SV004-NOT-VOID-TRANS         09480000
100200                 SET SV019-MISSING-POS-TRANS TO TRUE              09490000
100300             ELSE                                                 09500000
100400                 SET SV019-MISSING-POS-VOID TO TRUE               09510000
100500             END-IF                                               09520000
100600                                                                  09530000
100700             PERFORM Z200-MOVE-KMC-TO-AUDIT                       09540000
100700             PERFORM C101-FIND-EXPECTED-SHIP-DATE                 09540121
                   IF PV-EXPECTED-SHIP-DATE < PV-SHIP-DATE-CUTOFF       09541026
100800             PERFORM Z300-WRITE-AUDIT-RECORD                      09550000
                   END-IF                                               09551021
101000             PERFORM E100-CHECK-OVERRIDDEN-DOLLAR                 09570000
101100             PERFORM E200-CHECK-OVERTENDERED-BALNCE               09580000
101200         END-IF                                                   09590000
101300         IF PS-KMC-REC-SAVED-YES                                  09600000
101400             MOVE PV-HOLD-SV022-RECORD                            09610000
101500               TO SV022-KMCACT-EXTRACT-RECORD                     09620000
101600         END-IF                                                   09630000
101700     END-IF.                                                      09640000
101800                                                                  09650000
101900******************************************************************09660000
101900*C101-FIND-EXPECTED-SHIP-DATE                                     09660121
101900******************************************************************09661021
       C101-FIND-EXPECTED-SHIP-DATE.                                    09661121
                                                                        09661221
127000     INITIALIZE DPG51 DPG52 DPG53                                 09661321
127100                DPG54 DPG55 DPG56.                                09661421
127200                                                                  09661521
127300     SET DPG51-ACTUAL-CALENDAR-ONLY  TO TRUE.                     09661621
127400     SET DPG51-INCREMENT-DATE        TO TRUE.                     09661721
127500     MOVE PV-CUTOFF-SHIP-DAYS        TO DPG51-INCR-DECR-DAYS-9.   09661821
127600                                                                  09661921
127700     MOVE SV022-POS-DTE              TO DPG52-LK-DATE-INPUT.      09662021
127800     SET DPG52-LK-DTE-ISO-FMT        TO TRUE.                     09662121
127900                                                                  09662221
128000     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52          09662321
128100                                             DPG53 DPG54          09662421
128200                                             DPG55 DPG56          09662521
128300                                                                  09662621
128400     EVALUATE TRUE                                                09662721
128500         WHEN DPG54-SEVERE-ERROR                                  09662821
128600         WHEN DPG54-DATE-INVALID                                  09662921
128700             DISPLAY ' '                                          09663021
128800             DISPLAY '** ABEND     **'                            09663121
128900             DISPLAY '** PROGRAM   **  = ' PC-PROGRAM-NAME        09663221
129000             DISPLAY '** PARAGRAPH **  = C101-FIND  PARA'         09663321
129100             DISPLAY '** BAD CALL TO CALENDAR MODULE '            09663421
129200                 DP500-KOHLS-CALENDAR-ROUTINE                     09663521
129300             DISPLAY DPG54-ERROR-MESSAGE                          09663621
129500             MOVE +4019 TO ABEND-CODE                             09663721
129600             CALL WS-ABEND-ROUTINE USING ABEND-CODE               09663821
129700     END-EVALUATE.                                                09663921
129800                                                                  09664021
129900     MOVE DPG55-DB2-ISO-DATE-FMT  TO  PV-EXPECTED-SHIP-DATE.      09664125
101900******************************************************************09665021
102000*     C110-CHECK-FOR-VOID                                        *09670000
102100* ==> PROCESSES:                                                 *09680000
102200*     - CHECK TO SEE IF THE TRANSACTION WAS AN ABORT ON THE COSA *09690000
102300*       TRANSACTION TABLE.                                       *09700000
102400*     - IF IT IS AN ABORT CHECK WHETHER THE NEXT KMRC RECORD IS  *09710000
102500*       A MATCHING VOID.  IF IT IS WRITE THE RECORD TO THE       *09720000
102600*       UPDATE FILE.                                             *09730000
102700* ==> PERFORMED FROM:  C100-MISSING-POS-RECORD.                  *09740000
102800******************************************************************09750000
102900 C110-CHECK-FOR-VOID.                                             09760000
103000                                                                  09770000
103100     EXEC SQL                                                     09780000
103200         SELECT TRN_NBR                                           09790000
103300           INTO :EPTRN-TRN-NBR                                    09800000
103400           FROM TEPPART P                                         09810000
103500              , TEPTRN T                                          09820000
103600          WHERE P.SLS_DTE = :SV022-POS-DTE                        09830000
103700            AND P.PARTN_NBR = T.PARTN_NBR                         09840000
103800            AND STR_NBR = :SV022-STR-NBR                          09850000
103900            AND RGST_ID = :SV022-TRMNL-NBR                        09860000
104000            AND TRN_NBR = :SV022-TRN-NBR                          09870000
104100            AND VOID_ABRT_CDE = 'A'                               09880000
104200           WITH UR                                                09890000
104300     END-EXEC.                                                    09900000
104400                                                                  09910000
104500     EVALUATE TRUE                                                09920000
104600         WHEN SQLCODE = +0                                        09930000
104700         WHEN SQLCODE = -811                                      09940000
104800             MOVE SV022-KMCACT-EXTRACT-RECORD                     09950000
104900                 TO PV-SAVE-SV022-RECORD                          09960000
105000             SET PS-KMC-REC-SAVED-YES TO TRUE                     09970000
105100             PERFORM Y100-READ-SVT00002-ACTIVITY                  09980000
105200             COMPUTE PV-SV022-APP-AUTH-AMT =                      09990000
105300                       (SV022-APP-AUTH-AMT * (-1))                10000000
105500             IF SV022-CRD-NBR     = PV-SAVE-SV022-CRD-NBR AND     10010000
066200                SV022-POS-OPER-ID = PV-SAVE-SV022-POS-OPR AND     10020000
106000                PV-SV022-APP-AUTH-AMT =                           10030000
106100                                    PV-SAVE-SV022-APP-AMT         10040000
106200                 IF SV022-TRN-VOID-IND NOT =                      10050000
106300                                    PV-SAVE-SV022-TRNVOID         10060000
106400                     SET PS-KMC-REC-SAVED-MATCH TO TRUE           10070000
106500                     SET PS-KMC-REC-SAVED-NO    TO TRUE           10080000
106600                     PERFORM D100-MATCH-PROCESS                   10090000
106700                 END-IF                                           10100000
106800             END-IF                                               10110000
106900         WHEN SQLCODE = +100                                      10120000
107000             CONTINUE                                             10130000
107100         WHEN OTHER                                               10140000
107200             MOVE 'C100-MISSING-POS-RECORD       '                10150000
107300                               TO PV-PARAGRAPH-NAME               10160000
107400             MOVE 'READ TEPPART/TEPTRN 4 VOID TRN'                10170000
107500                               TO PV-DB2-OPERATION-ATTEMPTED      10180000
107600             PERFORM Z900-SQL-ABEND                               10190000
107700     END-EVALUATE.                                                10200000
107800                                                                  10210000
107900******************************************************************10220000
108000*     C120-FETCH-PTNDR-CSR                                       *10230000
108100* ==> PROCESSES:                                                 *10240000
108200*     - CHECK THE COSA TENDER TABLE TO SEE IF A MATCH IS FOUND   *10250000
108300*       FOR THE TRANSACTION.                                     *10260000
108400* ==> PERFORMED FROM:  C100-MISSING-POS-RECORD.                  *10270000
108500******************************************************************10280000
108600 C120-FETCH-PTNDR-CSR.                                            10290000
108700                                                                  10300000
108800     EXEC SQL                                                     10310000
108900          FETCH PTNDR-CSR                                         10320000
109000          INTO                                                    10330000
109100                :EPTND-TNDR-ID                                    10340000
109200               ,:EPTND-TNDR-ID-LEN-NBR                            10350000
109300     END-EXEC.                                                    10360000
109400                                                                  10370000
109500     EVALUATE TRUE                                                10380000
109600         WHEN SQLCODE = ZERO                                      10390000
109700              PERFORM C190-TNDR-ID-CONVERSION                     10400000
109800              IF SV007-CARD-NBR = SV022-CRD-NBR                   10410000
109900                 SET PS-FOUND-PTNDR-TRANS  TO TRUE                10420000
110000                 PERFORM D100-MATCH-PROCESS                       10430000
110100              END-IF                                              10440000
110200         WHEN SQLCODE = +100                                      10450000
110300             SET PS-END-OF-PTNDR-CSR   TO TRUE                    10460000
110400             IF SV022-TRN-VOID-IND = SV004-NOT-VOID-TRANS         10470000
110500                 SET SV019-MISSING-POS-TRANS TO TRUE              10480000
110600                 PERFORM Z200-MOVE-KMC-TO-AUDIT                   10490000
110700                 PERFORM Z300-WRITE-AUDIT-RECORD                  10500000
110800             ELSE                                                 10510000
110900                 SET PS-NOT-FOUND-GVOID-TRANS  TO TRUE            10520000
111000                 SET PS-NOT-END-OF-GVOID-CSR   TO TRUE            10530000
111100                 PERFORM B170-OPEN-GVOID-CSR                      10540000
111200                 PERFORM C170-FETCH-GVOID-CSR                     10550000
111300                   UNTIL PS-FOUND-GVOID-TRANS                     10560000
111400                      OR PS-END-OF-GVOID-CSR                      10570000
111500                 PERFORM B570-CLOSE-GVOID-CSR                     10580000
111600             END-IF                                               10590000
111700         WHEN OTHER                                               10600000
111800             MOVE 'C120-FETCH-PTNDR-CSR     '                     10610000
111900                               TO PV-PARAGRAPH-NAME               10620000
112000             MOVE 'READ TEPPART/TEPTRN 4 VOID TRN'                10630000
112100                               TO PV-DB2-OPERATION-ATTEMPTED      10640000
112200             PERFORM Z900-SQL-ABEND                               10650000
112300     END-EVALUATE.                                                10660000
112400                                                                  10670000
112500******************************************************************10680000
112600*     C140-FETCH-GISSU-CSR.                                      *10690000
112700* ==> PROCESSES:                                                 *10700000
112800*     - CHECK TO SEE IF THE GIFT CARD ISSUE TRANSACTION IS FOUND *10710000
112900*       ON THE TEPITM TABLE.                                     *10720000
113000* ==> PERFORMED FROM:  C100-MISSING-POS-RECORD.                  *10730000
113100******************************************************************10740000
113200 C140-FETCH-GISSU-CSR.                                            10750000
113300                                                                  10760000
113400     EXEC SQL                                                     10770000
113500          FETCH GISSU-CSR                                         10780000
113600          INTO                                                    10790000
113700                :EPITM-MDSE-ID                                    10800000
113800     END-EXEC.                                                    10810000
113900                                                                  10820000
114000     EVALUATE TRUE                                                10830000
114100         WHEN SQLCODE = ZERO                                      10840000
114200              MOVE EPITM-MDSE-ID TO SV007-CARD-NUMBER-IN          10850000
114300              MOVE 0             TO SV007-CARD-NUMBER-LENGTH      10860000
114400              PERFORM SV007-FORMAT-CARD                           10870000
114500              IF SV007-CARD-NBR = SV022-CRD-NBR                   10880000
114600                 SET PS-FOUND-GISSU-TRANS  TO TRUE                10890000
114700                 PERFORM D100-MATCH-PROCESS                       10900000
114800              END-IF                                              10910000
114900         WHEN SQLCODE = +100                                      10920000
115000             SET PS-END-OF-GISSU-CSR   TO TRUE                    10930000
115100             IF SV022-TRN-VOID-IND = SV004-NOT-VOID-TRANS         10940000
115200                 SET SV019-MISSING-POS-TRANS TO TRUE              10950000
115300                 PERFORM Z200-MOVE-KMC-TO-AUDIT                   10960000
115400                 PERFORM Z300-WRITE-AUDIT-RECORD                  10970000
115500             ELSE                                                 10980000
115600                 SET PS-NOT-FOUND-VISSU-TRANS  TO TRUE            10990000
115700                 SET PS-NOT-END-OF-VISSU-CSR   TO TRUE            11000000
115800                 PERFORM B180-OPEN-VISSU-CSR                      11010000
115900                 PERFORM C180-FETCH-VISSU-CSR                     11020000
116000                   UNTIL PS-FOUND-VISSU-TRANS                     11030000
116100                      OR PS-END-OF-VISSU-CSR                      11040000
116200                 PERFORM B580-CLOSE-VISSU-CSR                     11050000
116300             END-IF                                               11060000
116400         WHEN OTHER                                               11070000
116500             MOVE 'C140-FETCH-GISSU-CSR'                          11080000
116600                               TO PV-PARAGRAPH-NAME               11090000
116700             MOVE 'READ TEPPART/TEPTRN 4 VOID TRN'                11100000
116800                               TO PV-DB2-OPERATION-ATTEMPTED      11110000
116900             PERFORM Z900-SQL-ABEND                               11120000
117000     END-EVALUATE.                                                11130000
117100                                                                  11140000
117200******************************************************************11150000
117300*     C170-FETCH-GVOID-CSR                                       *11160000
117400* ==> PROCESSES:                                                 *11170000
117500*     - CHECK THE COSA TENDER TABLE TO SEE IF THERE IS A VOID    *11180000
117600*       FOR THE CARD AND TRANSACTION.                            *11190000
117700* ==> PERFORMED FROM:  C120-CHECK-FOR-GFT-CRD-TENDER.            *11200000
117800******************************************************************11210000
117900 C170-FETCH-GVOID-CSR.                                            11220000
118000                                                                  11230000
118100     EXEC SQL                                                     11240000
118200          FETCH GVOID-CSR                                         11250000
118300          INTO                                                    11260000
118400                :EPTND-TNDR-ID                                    11270000
118500               ,:EPTND-TNDR-ID-LEN-NBR                            11280000
118600     END-EXEC.                                                    11290000
118700                                                                  11300000
118800     EVALUATE TRUE                                                11310000
118900         WHEN SQLCODE = ZERO                                      11320000
119000              PERFORM C190-TNDR-ID-CONVERSION                     11330000
119100              IF SV007-CARD-NBR = SV022-CRD-NBR                   11340000
119200                 SET PS-FOUND-GVOID-TRANS  TO TRUE                11350000
119300                 PERFORM D100-MATCH-PROCESS                       11360000
119400              END-IF                                              11370000
119500         WHEN SQLCODE = +100                                      11380000
119600             SET PS-END-OF-GVOID-CSR   TO TRUE                    11390000
119700             SET SV019-MISSING-POS-VOID TO TRUE                   11400000
119800             PERFORM Z200-MOVE-KMC-TO-AUDIT                       11410000
119900             PERFORM Z300-WRITE-AUDIT-RECORD                      11420000
120000         WHEN OTHER                                               11430000
120100             MOVE 'C170-FETCH-GVOID-CSROID       '                11440000
120200                               TO PV-PARAGRAPH-NAME               11450000
120300             MOVE 'SELECT JOINED TEPPART/TEPTND'                  11460000
120400                               TO PV-DB2-OPERATION-ATTEMPTED      11470000
120500             PERFORM Z900-SQL-ABEND                               11480000
120600     END-EVALUATE.                                                11490000
120700                                                                  11500000
120800******************************************************************11510000
120900*     C180-FETCH-VISSU-CSR.                                      *11520000
121000* ==> PROCESSES:                                                 *11530000
121100*     - CHECK IF THE GIFT CARD EXISTS ON THE TRANSACTION WITH A  *11540000
121200*       AMOUNT OF ZERO.                                          *11550000
121300* ==> PERFORMED FROM:  C140-CHECK-FOR-GIFT-CARD.                 *11560000
121400******************************************************************11570000
121500 C180-FETCH-VISSU-CSR.                                            11580000
121600                                                                  11590000
121700     EXEC SQL                                                     11600000
121800          FETCH VISSU-CSR                                         11610000
121900          INTO                                                    11620000
122000                :EPITM-MDSE-ID                                    11630000
122100     END-EXEC.                                                    11640000
122200                                                                  11650000
122300     EVALUATE TRUE                                                11660000
122400         WHEN SQLCODE = ZERO                                      11670000
122500              MOVE EPITM-MDSE-ID TO SV007-CARD-NUMBER-IN          11680000
122600              MOVE 0             TO SV007-CARD-NUMBER-LENGTH      11690000
122700              PERFORM SV007-FORMAT-CARD                           11700000
122800              IF SV007-CARD-NBR = SV022-CRD-NBR                   11710000
122900                 SET PS-FOUND-VISSU-TRANS  TO TRUE                11720000
123000                 PERFORM D100-MATCH-PROCESS                       11730000
123100              END-IF                                              11740000
123200         WHEN SQLCODE = +100                                      11750000
123300                 SET PS-END-OF-VISSU-CSR   TO TRUE                11760000
123400                 SET SV019-MISSING-POS-VOID  TO TRUE              11770000
123500                 PERFORM Z200-MOVE-KMC-TO-AUDIT                   11780000
123600                 PERFORM Z300-WRITE-AUDIT-RECORD                  11790000
123700         WHEN OTHER                                               11800000
123800             MOVE 'C180-FETCH-VISSU-CSR'                          11810000
123900                               TO PV-PARAGRAPH-NAME               11820000
124000             MOVE 'SELECT JOINED TEPPARTN/TEPITM'                 11830000
124100                               TO PV-DB2-OPERATION-ATTEMPTED      11840000
124200             PERFORM Z900-SQL-ABEND                               11850000
124300     END-EVALUATE.                                                11860000
124400                                                                  11870000
124500******************************************************************11880000
124600* EXTRACT TENDER ID FOR CARD NUMBER CONVERSION                   *11890000
124700******************************************************************11900000
124800 C190-TNDR-ID-CONVERSION.                                         11910000
124900                                                                  11920000
125000     IF EPTND-TNDR-ID-LEN-NBR = 16                                11930000
125100         MOVE EPTND-TNDR-ID(2:15) TO SV007-CARD-NUMBER-IN         11940000
125200     ELSE                                                         11950000
125300         MOVE EPTND-TNDR-ID(1:EPTND-TNDR-ID-LEN-NBR)              11960000
125400                                  TO SV007-CARD-NUMBER-IN         11970000
125500     END-IF.                                                      11980000
125600                                                                  11990000
125700     MOVE EPTND-TNDR-ID-LEN-NBR TO SV007-CARD-NUMBER-LENGTH.      12000000
125800                                                                  12010000
125900     PERFORM SV007-FORMAT-CARD.                                   12020000
126000                                                                  12030000
126100******************************************************************12040000
126200*     C200-CALCULATE-CUTOFF-DATE                                 *12050000
126300* ==> PROCESSES:                                                 *12060000
126400*     - SUBTRACTS PC-NUMBER-DAYS-TO-CHECK FROM THE POINT OF SALE *12070000
126500*       DATE TO GET THE CUTOFF DATE                              *12080000
126600* ==> PERFORMED FROM:  B200-COMPARE-SVT00002-FILES               *12090000
126700******************************************************************12100000
126800 C200-CALCULATE-CUTOFF-DATE.                                      12110000
126900                                                                  12120000
127000     INITIALIZE DPG51 DPG52 DPG53                                 12130000
127100                DPG54 DPG55 DPG56.                                12140000
127200                                                                  12150000
127300     SET DPG51-ACTUAL-CALENDAR-ONLY  TO TRUE.                     12160000
127400     SET DPG51-DECREMENT-DATE        TO TRUE.                     12170000
127500     MOVE PC-NUMBER-DAYS-TO-CHECK    TO DPG51-INCR-DECR-DAYS-9.   12180000
127600                                                                  12190000
127700     MOVE SV021-POS-DTE              TO DPG52-LK-DATE-INPUT.      12200000
127800     SET DPG52-LK-DTE-ISO-FMT        TO TRUE.                     12210000
127900                                                                  12220000
128000     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52          12230000
128100                                             DPG53 DPG54          12240000
128200                                             DPG55 DPG56          12250000
128300                                                                  12260000
128400     EVALUATE TRUE                                                12270000
128500         WHEN DPG54-SEVERE-ERROR                                  12280000
128600         WHEN DPG54-DATE-INVALID                                  12290000
128700             DISPLAY ' '                                          12300000
128800             DISPLAY '** ABEND     **'                            12310000
128900             DISPLAY '** PROGRAM   **  = ' PC-PROGRAM-NAME        12320000
129000             DISPLAY '** PARAGRAPH **  = C200-CALCULATE-CUTOFF'   12330000
129100             DISPLAY '** BAD CALL TO CALENDAR MODULE '            12340000
129200                 DP500-KOHLS-CALENDAR-ROUTINE                     12350000
129300             DISPLAY DPG54-ERROR-MESSAGE                          12360000
129400             DISPLAY ' '                                          12370000
090600             DISPLAY 'SV021-POS-DTE ' SV021-POS-DTE               12380000
129500             MOVE +4019 TO ABEND-CODE                             12400000
129600             CALL WS-ABEND-ROUTINE USING ABEND-CODE               12410000
129700     END-EVALUATE.                                                12420000
129800                                                                  12430000
129900     MOVE DPG55-DB2-ISO-DATE-FMT  TO PV-POS-CUTOFF-DATE.          12440000
130000                                                                  12450000
130100******************************************************************12460000
130200*     C300-LOOK-FOR-MISSING-TRANS                                *12470000
130300* ==> PROCESSES:                                                 *12480000
130400*     - DOES AN INQUIRY AGAINST THE KMC ACTIVITY TABLE           *12490000
130500*     -  (SVT_KOHLS_CRD_TXN) *                                    12500000
130600*       WITH THE INFORMATION FROM THE POS EXTRACT FILE.  THE     *12510000
130700*       TRANSACTION WAS MISSING FROM THE SVT00002 EXTRACT.       *12520000
130800*     - **** NOTE:  REVERSAL CODE SHOULD BE ADDED TO THE WHERE   *12530000
130900*                   CLAUSE WHEN THE POS EXTRACT IS CHANGED TO    *12540000
131000*                   PASS THIS VALUE.                             *12550000
131100* ==> PERFORMED FROM:  B200-COMPARE-SVT00002-FILES               *12560000
131200******************************************************************12570000
131300 C300-LOOK-FOR-MISSING-TRANS.                                     12580000
131400                                                                  12590000
P12431     MOVE 0               TO PV-ORD-NBR-NULL-IND.                 12591033
P12431     MOVE SPACES          TO SVT00002-ORD-NBR-TEXT.               12592033
P12431                                                                  12593033
131500     EXEC SQL                                                     12600000
131600         SELECT  POS_DTE                                          12610000
131700                ,DRV_LIC_NBR                                      12620000
131800                ,TRN_RVRSL_CDE                                    12630000
131900                ,TRN_VOID_IND                                     12640000
132000                ,ACTVY_STAT_CDE                                   12650000
132100                ,POS_OPRT_ID                                      12660000
P12431                ,ORD_NBR                                          12661033
132200                ,APVL_USR_ID                                      12670000
132300                ,TRN_AUTH_TMST                                    12680000
132400           INTO  :SVT00002-POS-DTE                                12690000
132500                ,:SVT00002-DRV-LIC-NBR                            12700000
132600                ,:SVT00002-TRN-RVRSL-CDE                          12710000
132700                ,:SVT00002-TRN-VOID-IND                           12720000
132800                ,:SVT00002-ACTVY-STAT-CDE                         12730000
132900                ,:SVT00002-POS-OPRT-ID                            12740000
P12431                ,:SVT00002-ORD-NBR :PV-ORD-NBR-NULL-IND           12741033
133000                ,:SVT00002-APVL-USR-ID                            12750000
133100                ,:SVT00002-TRN-AUTH-TMST                          12760000
133200           FROM  SVT_KOHLS_CRD_TXN                                12770000
133300          WHERE  CRD_NBR      = :SV021-CRD-NBR                    12780000
133400            AND POS_DTE       = :PV-POS-DATE                      12790000
133500            AND ACTVY_TYP_CDE = :SV021-ACTVY-TYP-CDE              12800000
133600*           AND STR_NBR       = :SV021-STR-NBR                    12810000
133700*           AND POS_TRMNL_NBR = :SV021-TRMNL-NBR                  12820000
133800*           AND POS_TRN_NBR   = :SV021-TRN-NBR                    12830000
133900            AND APP_AUTH_AMT  = :SV021-APP-AUTH-AMT               12840000
134000            AND ORIG_AUTH_AMT = :SV021-ORIG-AUTH-AMT              12850000
134100            AND TRN_VOID_IND  = :SV021-TRN-VOID-IND               12860000
134200     END-EXEC.                                                    12870000
134300                                                                  12880000
134400     EVALUATE TRUE                                                12890000
134500         WHEN SQLCODE = 0                                         12900000
134600         WHEN SQLCODE = -811                                      12910000
134700             SET PS-MISSING-SVT00002-TRAN-FOUND TO TRUE           12920000
134800         WHEN SQLCODE = +100                                      12930000
134900             PERFORM D200-SUBTRACT-DAY-POS-DATE                   12940000
135000         WHEN OTHER                                               12950000
135100             MOVE 'C300-LOOK-FOR-MISSING-TRANS   '                12960000
135200                               TO PV-PARAGRAPH-NAME               12970000
135300             MOVE 'SELECT ON SVT_KOHLS_CRD_TXN             '      12980000
135400                               TO PV-DB2-OPERATION-ATTEMPTED      12990000
135500             PERFORM Z900-SQL-ABEND                               13000000
135600     END-EVALUATE.                                                13010000
135700                                                                  13020000
135800******************************************************************13030000
135900*     C400-FOUND-MATCH-PROCESS                                   *13040000
136000* ==> PROCESSES:                                                 *13050000
136100*     - MOVES THE CURRENT RD015 (THE SVT00002) EXTRACT RECORD TO *13060000
136200*       A HOLD RECORD                                            *13070000
136300*     - INITIALIZES THE RD015 RECORD AND THEN MOVES THE DATA FOR *13080000
136400*       THE SVT00002 RECORD THAT WAS FOUND ON THE TABLE TO THE   *13090000
136500*       RD015 RECORD.  THIS IS DONE SO THAT THE EXISTING LOGIC   *13100000
136600*       COULD BE USED TO PROCESS THE MATCH.                      *13110000
136700*     - WHEN THE MATCH PROCESSING IS DONE THE RD015 RECORD IS    *13120000
136800*       INITIALIZED AND THE ORIGINAL RD015 INFORMATION IS MOVED  *13130000
136900*       BACK FROM THE HOLD RECORD.                               *13140000
137000* ==> PERFORMED FROM:  B200-COMPARE-SVT00002-FILES               *13150000
137100******************************************************************13160000
137200 C400-FOUND-MATCH-PROCESS.                                        13170000
137300                                                                  13180000
137400     INITIALIZE PV-HOLD-SV022-RECORD.                             13190000
137500     MOVE SV022-KMCACT-EXTRACT-RECORD TO PV-HOLD-SV022-RECORD.    13200000
137600     INITIALIZE SV022-KMCACT-EXTRACT-RECORD.                      13210000
137700                                                                  13220000
137800     MOVE SV021-CRD-TYP-CDE     TO SV022-CRD-TYP-CDE.             13230000
137900     MOVE SV021-CRD-NBR         TO SV022-CRD-NBR.                 13240000
138000     MOVE SVT00002-POS-DTE      TO SV022-POS-DTE.                 13250000
138100     MOVE SV021-STR-NBR         TO SV022-STR-NBR.                 13260000
138200     MOVE SV021-TRMNL-NBR       TO SV022-TRMNL-NBR.               13270000
138300     MOVE SV021-TRN-NBR         TO SV022-TRN-NBR.                 13280000
138400     MOVE SV021-TRN-STAT-CDE    TO SV022-TRN-STAT-CDE.            13290000
138500     MOVE SV021-APP-AUTH-AMT    TO SV022-APP-AUTH-AMT.            13300000
138600     MOVE SV021-ORIG-AUTH-AMT   TO SV022-ORIG-AUTH-AMT.           13310000
138700     MOVE SVT00002-TRN-VOID-IND TO SV022-TRN-VOID-IND.            13320000
138800     MOVE SVT00002-TRN-RVRSL-CDE TO SV022-TRN-RVRSL-CDE.          13330000
P10237     IF SVT00002-DRV-LIC-NBR NOT = SPACES                         13341000
P10237        PERFORM C410-EBCDIC-ASCII                                 13342000
P10237        PERFORM C420-ENCRYPT-DL                                   13343000
P10237        PERFORM C430-BINARY-BASE64                                13344000
P10237        MOVE PV-OUTPUT-TEXT      TO SV022-DRV-LIC-NBR             13345000
P10237     ELSE                                                         13346000
P10237        MOVE SPACES              TO SV022-DRV-LIC-NBR             13347000
P10237     END-IF.                                                      13348000
139000     MOVE SVT00002-ACTVY-STAT-CDE TO SV022-ACTVY-STAT-CDE.        13350000
139100     MOVE SV021-ACTVY-TYP-CDE   TO SV022-ACTVY-TYP-CDE.           13360000
139200     MOVE SVT00002-POS-OPRT-ID  TO SV022-POS-OPER-ID.             13370000
P12431     IF PV-ORD-NBR-NULL-IND < +0                                  13371033
P12431        MOVE SPACES                TO SV022-ORD-NBR               13372033
P12431     ELSE                                                         13373033
P12431        MOVE SVT00002-ORD-NBR-TEXT TO SV022-ORD-NBR               13374033
P12431     END-IF.                                                      13375033
139300     MOVE SVT00002-APVL-USR-ID  TO SV022-APPR-USER-ID.            13380000
139400     MOVE SVT00002-TRN-AUTH-TMST TO SV022-TRN-AUTH-TMST.          13390000
139500                                                                  13400000
139600     EXEC SQL                                                     13410000
139700         SELECT  SUM(APP_AUTH_AMT)                                13420000
139800           INTO  :PV-CARD-BALANCE                                 13430000
139900           FROM  SVT_KOHLS_CRD_TXN                                13440000
140000          WHERE  CRD_NBR = :SV021-CRD-NBR                         13450000
140100     END-EXEC.                                                    13460000
140200                                                                  13470000
140300     EVALUATE TRUE                                                13480000
140400         WHEN SQLCODE = +0                                        13490000
140500             IF PV-CARD-BALANCE NEGATIVE                          13500000
140600                 SET SV022-OVERTENDERED TO TRUE                   13510000
140700             ELSE                                                 13520000
140800                 SET SV022-NOT-OVER     TO TRUE                   13530000
140900             END-IF                                               13540000
141000         WHEN OTHER                                               13550000
141100             MOVE 'C400-FOUND-MATCH-PROCESS      '                13560000
141200                               TO PV-PARAGRAPH-NAME               13570000
141300             MOVE 'SUMMATION OF APPROVED AUTH AMT'                13580000
141400                               TO PV-DB2-OPERATION-ATTEMPTED      13590000
141500             PERFORM Z900-SQL-ABEND                               13600000
141600     END-EVALUATE.                                                13610000
141700                                                                  13620000
141800     PERFORM D100-MATCH-PROCESS.                                  13630000
141900                                                                  13640000
142000     INITIALIZE SV022-KMCACT-EXTRACT-RECORD.                      13650000
142100     MOVE PV-HOLD-SV022-RECORD TO SV022-KMCACT-EXTRACT-RECORD.    13660000
142200                                                                  13670000
P10237******************************************************************13671000
P10237*     C410-EBCDIC-ASCII                                          *13672000
P10237* ==> PROCESSES:                                                 *13673000
P10237*     - CONVERTS THE DATA FROM EBCDIC TO ASCII FORMAT            *13674000
P10237* ==> PERFORMED FROM: C400-FOUND-MATCH-PROCESS                   *13675000
P10237******************************************************************13676000
P10237 C410-EBCDIC-ASCII.                                               13677000
P10237     INITIALIZE LK52-DPKUT052-SUBRTN-WORK-AREA                    13678000
P10237                PV-ASCII                                          13679000
P10237                PV-DL-LENGTH.                                     13679100
P10237                                                                  13679200
P10237     INSPECT FUNCTION REVERSE(SVT00002-DRV-LIC-NBR)               13679500
P10237          TALLYING PV-DL-LENGTH FOR LEADING SPACES.               13679600
P10237     COMPUTE PV-DL-LENGTH = 21 - PV-DL-LENGTH.                    13679700
P10237     SET  EBCDIC-TO-ASCII       TO TRUE.                          13679800
P10237     MOVE SVT00002-DRV-LIC-NBR  TO LK52-FROM-AREA.                13679900
P10237     MOVE PV-DL-LENGTH          TO LK52-LENGTH.                   13680000
P10237                                                                  13680100
P10237     CALL PC-DPKUT052       USING LK52-CONVERSION-TYPE            13680214
P10237                                  LK52-LENGTH                     13680300
P10237                                  LK52-FROM-AREA                  13680400
P10237                                  LK52-TO-AREA                    13680500
P10237                                  LK52-RETURN-CODE.               13680600
P10237     IF GOOD-LK52-RET-CODE                                        13680700
P10237        MOVE  LK52-TO-AREA      TO  PV-ASCII                      13680800
P10237     ELSE                                                         13680900
P10237        DISPLAY 'ERROR WHILE CONVERTING DL# TO ASCII'             13681114
P10237        DISPLAY 'RETURN CODE     - ' LK52-RETURN-CODE             13681216
P10237        DISPLAY 'TRN-AUTH-TMST   - ' SVT00002-TRN-AUTH-TMST       13681314
P10237        DISPLAY 'POS-DATE        - ' SVT00002-POS-DTE             13681414
P10237        DISPLAY 'POS-OPRT-ID     - ' SVT00002-POS-OPRT-ID         13681514
P10237        DISPLAY 'INPUT DL LENGTH - ' PV-DL-LENGTH                 13681614
P10237        MOVE +4008 TO ABEND-CODE                                  13681714
P10237        CALL 'ILBOABN0' USING ABEND-CODE                          13681827
P10237     END-IF.                                                      13681914
P10237                                                                  13682014
P10237******************************************************************13682114
P10237*     C420-ENCRYPT-DL                                            *13682214
P10237* ==> PROCESSES:                                                 *13682314
P10237*     - CALLS THE PROTEGRITY MODULE TO ENCRYPT THE DL#           *13682414
P10237*     - RETURNED DL# WILL BE IN BINARY FORMAT                    *13682514
P10237* ==> PERFORMED FROM: C400-FOUND-MATCH-PROCESS                   *13682614
P10237******************************************************************13682714
P10237 C420-ENCRYPT-DL.                                                 13682814
P10237     INITIALIZE CSI-PARAMETERS                                    13682914
P10237                DP031-PROTEG-PGM-PARAMETERS.                      13683014
P10237     MOVE 'DRIVER-LICENSE'        TO DP031-FIELD.                 13683114
P10237     SET CSI-ENCRYPT-FUNCTION     TO TRUE.                        13683214
P10237     SET DP031-IDNBR              TO TRUE.                        13683314
P10237     MOVE LK52-LENGTH             TO CSI-CLEAR-TEXT-LENGTH.       13683414
P10237     MOVE 34                      TO CSI-CIPHER-TEXT-LENGTH.      13683514
P10237     MOVE PV-ASCII                TO DP031-CLEAR-TEXT.            13683614
P10237     PERFORM DP031-1000-PROTG-ENCRYP-DECRYP.                      13683714
P10237     IF CSI-RETURN-CODE NOT = ZERO                                13683814
P10237        DISPLAY 'ABEND IN THE FOLLOWING RECORD'                   13683914
P10237        DISPLAY 'TRN-AUTH-TMST   - ' SVT00002-TRN-AUTH-TMST       13684014
P10237        DISPLAY 'POS-DATE        - ' SVT00002-POS-DTE             13684114
P10237        DISPLAY 'POS-OPRT-ID     - ' SVT00002-POS-OPRT-ID         13684214
P10237        DISPLAY 'INPUT DL LENGTH - ' PV-DL-LENGTH                 13684314
P10237        PERFORM DP031-9999-ABEND                                  13684414
P10237     END-IF.                                                      13684514
P10237                                                                  13684614
P10237******************************************************************13684714
P10237*     C430-BINARY-BASE64                                         *13684814
P10237* ==> PROCESSES:                                                 *13684914
P10237*     - CONVERTS THE DATA FROM BINARY TO BASE64 FORMAT           *13685014
P10237* ==> PERFORMED FROM:  C400-FOUND-MATCH-PROCESS                  *13685114
P10237******************************************************************13685214
P10237 C430-BINARY-BASE64.                                              13685314
P10237     INITIALIZE PV-INPUT-TEXT                                     13685414
P10237                PV-OUTPUT-TEXT.                                   13685514
P10237     MOVE DP031-CIPHER-TEXT      TO PV-INPUT-TEXT.                13685614
P10237     MOVE CSI-CIPHER-TEXT-LENGTH TO DP022-INLEN.                  13685714
P10237     MOVE 48                     TO DP022-OUTLEN-IN.              13685814
P10237     CALL  DP022-MGCXB2R  USING DP022-PARMS,                      13685914
P10237                                PV-INPUT-TEXT,                    13686014
P10237                                PV-OUTPUT-TEXT.                   13686114
P10237     IF RETURN-CODE NOT EQUAL 0                                   13686214
P10237        DISPLAY 'ERROR WHILE CONVERTING DL# TO BASE64'            13686414
P10237        DISPLAY 'RETURN CODE     - ' RETURN-CODE                  13686516
P10237        DISPLAY 'TRN-AUTH-TMST   - ' SVT00002-TRN-AUTH-TMST       13686614
P10237        DISPLAY 'POS-DATE        - ' SVT00002-POS-DTE             13686714
P10237        DISPLAY 'POS-OPRT-ID     - ' SVT00002-POS-OPRT-ID         13686814
P10237        DISPLAY 'INPUT DL LENGTH - ' PV-DL-LENGTH                 13686914
P10237        MOVE +4008 TO ABEND-CODE                                  13687014
P10237        CALL 'ILBOABN0' USING ABEND-CODE                          13687127
P10237     END-IF.                                                      13687214
P10237                                                                  13687314
142300******************************************************************13688014
142400*     C500-MISSING-SVT00002-RECORD                               *13690000
142500* ==> PROCESSES:                                                 *13700000
142600*     - IF THE POS RECORD IS A VOID AN INSERT RECORD IS WRITTEN  *13710000
142700*       TO THE UPDATE FILE AND A RECORD IS WRITTEN TO THE AUDIT  *13720000
142800*       FILE (ONLY IF THERE IS NOT A TENDER RECORD ASSOCIATED    *13730000
142900*       WITH THE CARD).  IF THE CARD IS NOT FOUND ON THE         *13740000
143000*       SVT_KOHLS_CRD_ACCT,                                       13750000
143100*       AN INSERT RECORD IS NOT WRITTEN.  IT IS FLAGGED ON THE   *13760000
143200*       AUDIT REPORT AS AN UNKNOWN CARD ID.                      *13770000
143300*     - IF THE POS RECORD IS A NORMAL TRANSACTION A RECORD IS    *13780000
143400*       WRITTEN TO THE AUDIT FILE.                               *13790000
143500* ==> PERFORMED FROM:  B200-COMPARE-SVT00002-FILES               *13800000
143600*                      B300-PROCESS-REST-POS-FILE                *13810000
143700******************************************************************13820000
143800 C500-MISSING-SVT00002-RECORD.                                    13830000
143900                                                                  13840000
144000     IF SV021-TRN-VOID                                            13850000
144100                                                                  13860000
144200         IF (SV021-ACTVY-TYP-CDE = SV004-ISSUE-KMRC-ACT-TYP       13870000
144300         OR  SV021-ACTVY-TYP-CDE = SV004-ISSUE-GIFT-CRD-ACT-TYP)  13880000
144400             PERFORM D300-CHECK-FOR-TENDER                        13890000
144500         ELSE                                                     13900000
144600             PERFORM D400-CHECK-CARD-ON-SVT-ACCT                  13910000
144700         END-IF                                                   13920000
144800                                                                  13930000
144900     ELSE                                                         13940000
145000         SET SV019-MISSING-KMC-TRANS      TO TRUE                 13950000
145100     END-IF.                                                      13960000
145200                                                                  13970000
145300     PERFORM Z100-MOVE-POS-TO-AUDIT.                              13980000
145400     PERFORM Z300-WRITE-AUDIT-RECORD.                             13990000
145500                                                                  14000000
145600******************************************************************14010000
145700*     C600-CHECK-FOR-ORIG-POS-VOID                               *14020000
145800* ==> PROCESSES:                                                 *14030000
145900*     - THIS CHECK IS NEEDED BECAUSE THE VOID INDICATOR IS NOT   *14040000
146000*       CHANGED ON THE ORIGINAL TRANSACTION ON THE POS EXTRACT   *14050000
146100*       RECORD, BUT IT IS ON THE                                 *14060000
146200*       SVT_KOHLS_CRD_TXN TABLE AS DESCRIBED *                    14070000
146300*       BELOW                                                    *14080000
146400*     - THERE ARE TWO PARTS TO A VOID ON THE                     *14090000
146500*     - SVT_KOHLS_CRD_TXN TABLE: *                                14100000
146600*       1)  THE ORIGINAL TRANSACTION HAS THE VOID INDICATOR SET  *14110000
146700*           TO A Y, BUT THE REVERSAL CODE REMAINS A ZERO.        *14120000
146800*       1)  THE REVERSING TRANSACTION FOR THE VOID, HAS THE VOID *14130000
146900*           INDICATOR SET TO A Y, THE REVERSAL CODE IS A 1, AND  *14140000
147000*           THE AMOUNTS ARE OPPOSITE THE AMOUNTS ON THE ORIGINAL *14150000
147100*           TRANSACTION.                                         *14160000
147200* ==> PERFORMED FROM:  B200-COMPARE-SVT00002-FILES               *14170000
147300******************************************************************14180000
147400 C600-CHECK-FOR-ORIG-POS-VOID.                                    14190000
147500                                                                  14200000
147600     IF SV022-TRN-VOID-IND = SV004-VOID-TRANS AND                 14210000
147700        SV022-TRN-RVRSL-CDE = SV004-REV-CDE-NORMAL AND            14220000
147800        SV021-TRN-VOID-IND = SV004-NOT-VOID-TRANS                 14230000
147900         PERFORM D100-MATCH-PROCESS                               14240000
148000         PERFORM Y200-READ-POS-ACTIVITY                           14250000
148100         PERFORM Y100-READ-SVT00002-ACTIVITY                      14260000
148200     ELSE                                                         14270000
                                                                        14271018
148300         PERFORM C100-MISSING-POS-RECORD                          14280000
148400         IF PS-KMC-REC-SAVED-NO                                   14290000
148500            PERFORM Y100-READ-SVT00002-ACTIVITY                   14300000
148600         ELSE                                                     14310000
148700            SET PS-KMC-REC-SAVED-NO TO TRUE                       14320000
148800         END-IF                                                   14330000
148900     END-IF.                                                      14340000
149000                                                                  14350000
149100                                                                  14360000
149200******************************************************************14370000
149300*     D100-MATCH-PROCESS                                         *14380000
149400* ==> PROCESSES:                                                 *14390000
149500*     - IF THE ACTIVITY STATUS WAS AUTHORIZED A RECORD IS WRITTEN*14400000
149600*       TO UPDATE THE STATUS TO BE VERIFIED.                     *14410000
149700*     - IF THE ACTIVITY STATUS WAS NOT AUTHORIZED OR IS ALREADY  *14420000
149800*       A VERIFIED AN AUDIT RECORD IS WRITTEN TO INDICATE THIS.  *14430000
149900* ==> PERFORMED FROM:  B200-COMPARE-SVT00002-FILES               *14440000
150000*                      C100-MISSING-POS-RECORD                   *14450000
150100*                      C400-FOUND-MATCH-PROCESS                  *14460000
150200******************************************************************14470000
150300 D100-MATCH-PROCESS.                                              14480000
150400                                                                  14490000
150500     IF PS-KMC-REC-SAVED-YES                                      14500000
150600         EVALUATE TRUE                                            14510000
150700           WHEN PV-SAVE-SV022-ACT-STA =                           14520000
150800                SV004-STAT-AUTH-RECEIVED-CD                       14530000
150900               PERFORM Z260-MOVE-SAVED-KMC-TO-POSTING             14540000
151000               PERFORM Z400-WRITE-UPDATE-RECORD                   14550000
151100               PERFORM E100-CHECK-OVERRIDDEN-DOLLAR               14560000
151200               PERFORM E200-CHECK-OVERTENDERED-BALNCE             14570000
151300           WHEN PV-SAVE-SV022-ACT-STA = SV004-STAT-NO-AUTH-CD     14580000
151400             IF PV-SAVE-SV022-APP-USR = SPACES                    14590000
151500                 SET SV019-VERIFIED-DUPLICATE TO TRUE             14600000
151600                 PERFORM Z200-MOVE-KMC-TO-AUDIT                   14610000
151700                 PERFORM Z300-WRITE-AUDIT-RECORD                  14620000
151800             ELSE                                                 14630000
151900                 PERFORM Z260-MOVE-SAVED-KMC-TO-POSTING           14640000
152000                 PERFORM Z400-WRITE-UPDATE-RECORD                 14650000
152100                 PERFORM E100-CHECK-OVERRIDDEN-DOLLAR             14660000
152200                 PERFORM E200-CHECK-OVERTENDERED-BALNCE           14670000
152300             END-IF                                               14680000
152400                                                                  14690000
152500           WHEN PV-SAVE-SV022-ACT-STA = SV004-STAT-VERIFIED-CD    14700000
152600               SET SV019-VERIFIED-DUPLICATE TO TRUE               14710000
152700               PERFORM Z200-MOVE-KMC-TO-AUDIT                     14720000
152800               PERFORM Z300-WRITE-AUDIT-RECORD                    14730000
152900         END-EVALUATE                                             14740000
153000     END-IF.                                                      14750000
153100                                                                  14760000
153200     EVALUATE TRUE                                                14770000
153300         WHEN SV022-ACTVY-STAT-CDE = SV004-STAT-AUTH-RECEIVED-CD  14780000
153400             PERFORM Z250-MOVE-KMC-TO-POSTING                     14790000
153500             PERFORM Z400-WRITE-UPDATE-RECORD                     14800000
153600             PERFORM E100-CHECK-OVERRIDDEN-DOLLAR                 14810000
153700             PERFORM E200-CHECK-OVERTENDERED-BALNCE               14820000
153800         WHEN SV022-ACTVY-STAT-CDE = SV004-STAT-NO-AUTH-CD        14830000
153900             IF SV022-APPR-USER-ID = SPACES                       14840000
154000                 SET SV019-VERIFIED-DUPLICATE TO TRUE             14850000
154100                 PERFORM Z200-MOVE-KMC-TO-AUDIT                   14860000
154200                 PERFORM Z300-WRITE-AUDIT-RECORD                  14870000
154300             ELSE                                                 14880000
154400                 PERFORM Z250-MOVE-KMC-TO-POSTING                 14890000
154500                 PERFORM Z400-WRITE-UPDATE-RECORD                 14900000
154600                 PERFORM E100-CHECK-OVERRIDDEN-DOLLAR             14910000
154700                 PERFORM E200-CHECK-OVERTENDERED-BALNCE           14920000
154800             END-IF                                               14930000
154900                                                                  14940000
155000         WHEN SV022-ACTVY-STAT-CDE = SV004-STAT-VERIFIED-CD       14950000
155100             SET SV019-VERIFIED-DUPLICATE TO TRUE                 14960000
155200             PERFORM Z200-MOVE-KMC-TO-AUDIT                       14970000
155300             PERFORM Z300-WRITE-AUDIT-RECORD                      14980000
155400     END-EVALUATE.                                                14990000
155500                                                                  15000000
155600******************************************************************15010000
155700*     D200-SUBTRACT-DAY-POS-DATE                                 *15020000
155800* ==> PROCESSES:                                                 *15030000
155900*     - SUBTRACTS A DAYS FROM THE VARIABLE PV-POS-DATE.          *15040000
156000* ==> PERFORMED FROM:  C300-LOOK-FOR-MISSING-TRANS               *15050000
156100******************************************************************15060000
156200 D200-SUBTRACT-DAY-POS-DATE.                                      15070000
156300                                                                  15080000
156400     INITIALIZE DPG51 DPG52 DPG53                                 15090000
156500                DPG54 DPG55 DPG56.                                15100000
156600                                                                  15110000
156700     SET DPG51-ACTUAL-CALENDAR-ONLY  TO TRUE.                     15120000
156800     SET DPG51-DECREMENT-DATE        TO TRUE.                     15130000
156900     MOVE PC-ONE                     TO DPG51-INCR-DECR-DAYS-9.   15140000
157000                                                                  15150000
157100     MOVE PV-POS-DATE                TO DPG52-LK-DATE-INPUT.      15160000
157200     SET DPG52-LK-DTE-ISO-FMT        TO TRUE.                     15170000
157300                                                                  15180000
157400     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52          15190000
157500                                             DPG53 DPG54          15200000
157600                                             DPG55 DPG56.         15210000
157700                                                                  15220000
157800     EVALUATE TRUE                                                15230000
157900         WHEN DPG54-SEVERE-ERROR                                  15240000
158000         WHEN DPG54-DATE-INVALID                                  15250000
158100             DISPLAY ' '                                          15260000
158200             DISPLAY '** ABEND     **'                            15270000
158300             DISPLAY '** PROGRAM   **  = ' PC-PROGRAM-NAME        15280000
158400             DISPLAY '** PARAGRAPH **  = D200-SUBTRACT-DAY-POS'   15290000
158500             DISPLAY '** BAD CALL TO CALENDAR MODULE '            15300000
158600                 DP500-KOHLS-CALENDAR-ROUTINE                     15310000
158700             DISPLAY DPG54-ERROR-MESSAGE                          15320000
158800             DISPLAY ' '                                          15330000
158900             MOVE +4019 TO ABEND-CODE                             15340000
159000             CALL WS-ABEND-ROUTINE USING ABEND-CODE               15350000
159100     END-EVALUATE.                                                15360000
159200                                                                  15370000
159300     MOVE DPG55-DB2-ISO-DATE-FMT  TO PV-POS-DATE.                 15380000
159400                                                                  15390000
159500******************************************************************15400000
159600*     D300-CHECK-FOR-TENDER                                      *15410000
159700* ==> PROCESSES:                                                 *15420000
159800*     - DOES A SELECT ON THE                                     *15430000
159900*     - SVT_KOHLS_CRD_TXN TABLE TO SEE IF A TENDER *              15440000
160000*       EXISTS FOR A SPECIFIC CARD                               *15450000
160100*     - IF A TENDER EXISTS FOR THE CARD, AN UPDATE/INSERT RECORD *15460000
160200*       IS NOT WRITTEN FOR PROGRAM SVKUP014, BUT AN AUDIT RECORD *15470000
160300*       IS WRITTEN INDICATING THAT LP SHOULD INVESTIGATE         *15480000
160400*     - IF A TENDER DOES NOT EXIST OR THE TENDERS HAVE ALL BEEN  *15490000
160500*       VOIDED, AND THE CARD ID IS FOUND ON THE                  *15500000
160600*       SVT_KOHLS_CRD_ACCT,                                       15510000
160700*       AN UPDATE/INSERT RECORD IS WRITTEN FOR SVKUP014          *15520000
160800*       AND AN AUDIT RECORD IS WRITTEN STATING THAT THERE WAS    *15530000
160900*       A MISSING KMRC VOID.                                     *15540000
161000*     - IF THE CARD ID IS NOT FOUND ON THE TKMCTBL,              *15550000
161100*       SVT_KOHLS_CRD_ACCT, AN AUDIT                              15560000
161200*       RECORD IS WRITTEN STATING THAT THERE IS AN UNKNOWN CARD  *15570000
161300*       ID.                                                      *15580000
161400* ==> PERFORMED FROM:  C500-MISSING-SVT00002-RECORD              *15590000
161500******************************************************************15600000
161600 D300-CHECK-FOR-TENDER.                                           15610000
161700                                                                  15620000
161800     MOVE SV004-TENDER-ACT-TYP  TO PV-TENDER-ACT-TYP.             15630000
161900                                                                  15640000
162000     EXEC SQL                                                     15650000
162100         SELECT  '1'                                              15660000
162200           INTO  :PV-SELECT                                       15670000
162300           FROM  SVT_KOHLS_CRD_TXN                                15680000
162400          WHERE  CRD_NBR      = :SV021-CRD-NBR                    15690000
162500            AND ACTVY_TYP_CDE = :PV-TENDER-ACT-TYP                15700000
162600            AND TRN_VOID_IND  = :SV004-NOT-VOID-TRANS             15710000
162700     END-EXEC.                                                    15720000
162800                                                                  15730000
162900     EVALUATE TRUE                                                15740000
163000         WHEN SQLCODE = 0                                         15750000
163100             SET SV019-MISSING-KMC-VOID-W-TNDR TO TRUE            15760000
163200                                                                  15770000
163300         WHEN SQLCODE = -811                                      15780000
163400             SET SV019-MISSING-KMC-VOID-W-TNDR TO TRUE            15790000
163500                                                                  15800000
163600         WHEN SQLCODE = +100                                      15810000
163700             PERFORM D400-CHECK-CARD-ON-SVT-ACCT                  15820000
163800                                                                  15830000
163900         WHEN OTHER                                               15840000
164000             MOVE 'D300-CHECK-FOR-TENDER         '                15850000
164100                               TO PV-PARAGRAPH-NAME               15860000
164200             MOVE 'SELECT ON SVT_KOHLS_CRD_TXN             '      15870000
164300                               TO PV-DB2-OPERATION-ATTEMPTED      15880000
164400             PERFORM Z900-SQL-ABEND                               15890000
164500                                                                  15900000
164600     END-EVALUATE.                                                15910000
164700                                                                  15920000
164800******************************************************************15930000
164900*     D400-CHECK-CARD-ON-SVT-ACCT                      *          15940000
165000* ==> PROCESSES:                                                 *15950000
165100*     - VERIFY THE CARD ID THAT IS NOT FOUND ON THE              *15960000
165200*     - SVT_KOHLS_CRD_TXN IS *                                    15970000
165300*       ON THE SVT_KOHLS_CRD_ACCT.                               *15980000
165400*     - IF THE CARD ID IS NOT ON THE TKMCTBL,                     15990000
165500*       SVT_KOHLS_CRD_ACCT, IT IS AN UNKNOWN *                    16000000
165600*       CARD ID AND WILL BE FLAGGED THAT WAY ON THE AUDIT REPORT.*16010000
165700* ==> PERFORMED FROM:  C500-MISSING-SVT00002-RECORD              *16020000
165800*                      D300-CHECK-FOR-TENDER                     *16030000
165900******************************************************************16040000
166000 D400-CHECK-CARD-ON-SVT-ACCT.                                     16050000
166100                                                                  16060000
166200     EXEC SQL                                                     16070000
166300         SET :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP            16080000
166400     END-EXEC.                                                    16090000
166500                                                                  16100000
166600     EXEC SQL                                                     16110000
166700         SELECT  CRD_NBR                                          16120000
166700              ,  CRD_TYP_CDE                                      16130000
166800           INTO :SVT00002-CRD-NBR                                 16140000
166800              , :SVT00001-CRD-TYP-CDE                             16150000
166900           FROM  SVT_KOHLS_CRD_ACCT                               16160000
167000          WHERE  CRD_NBR = :SV021-CRD-NBR                         16170000
167100     END-EXEC.                                                    16180000
167200                                                                  16190000
167300     EVALUATE TRUE                                                16200000
167400         WHEN SQLCODE = 0                                         16210000
167500             SET SV019-MISSING-KMC-VOID TO TRUE                   16220000
167600             MOVE PC-INSERT-RECORD      TO SV018-RECORD-TYPE      16230000
167700             MOVE SV004-STAT-NO-AUTH-CD TO SV018-UPDATED-ACTIVITY 16240000
167800             MOVE SVT00001-CRD-TYP-CDE  TO SV018-CRD-TYP-CDE      16250000
167900             MOVE SV021-CRD-NBR         TO SV018-KMC-CRD-NBR      16260000
168000             MOVE SV021-POS-DTE         TO SV018-POS-DATE         16270000
168100             MOVE SV021-STR-NBR         TO SV018-STORE-NBR        16280000
168200             MOVE SV021-TRMNL-NBR       TO SV018-TERMINAL-NBR     16290000
168300             MOVE SV021-TRN-NBR         TO SV018-TRANSACTION-NBR  16300000
168400             MOVE SV021-APP-AUTH-AMT    TO SV018-APPROVED-TRAN-AMT16310000
168500             MOVE SV021-ORIG-AUTH-AMT   TO SV018-ORIGINAL-AUTH-AMT16320000
168600             MOVE SV021-TRN-STAT-CDE    TO SV018-TRN-STAT-CDE     16330000
168700             MOVE SV004-VOID-TRANS      TO SV018-TRANS-VOID-IND   16340000
168800             MOVE SV004-REV-CDE-REVERSAL TO SV018-REVERSAL-IND    16350000
168900             MOVE SV021-DRV-LIC-NBR     TO SV018-DRIVERS-LICENSE  16360000
169000             MOVE SV021-ACTVY-TYP-CDE   TO SV018-TRANS-TYPE       16370000
169100             MOVE SV021-POS-OPER-ID     TO SV018-POS-OPERATOR-ID  16380000
P12431             MOVE SV021-ORD-NBR         TO SV018-ORD-NBR          16381033
169200             MOVE SV021-APPR-USER-ID    TO SV018-APPROVAL-USER-ID 16390000
169300             MOVE PV-CURRENT-TIMESTAMP  TO SV018-TRN-AUTH-TMST    16400000
169400                                                                  16410000
169500             PERFORM Z400-WRITE-UPDATE-RECORD                     16420000
169600                                                                  16430000
169700         WHEN SQLCODE = +100                                      16440000
169800             SET SV019-UNKNOWN-CARD-ID  TO TRUE                   16450000
169900                                                                  16460000
170000         WHEN OTHER                                               16470000
170100             MOVE 'D400-CHECK-CARD-ON-SVT-ACCT    '               16480000
170200                               TO PV-PARAGRAPH-NAME               16490000
170300             MOVE 'SELECT ON SVT_KOHLS_CRD_ACCT             '     16500000
170400                               TO PV-DB2-OPERATION-ATTEMPTED      16510000
170500             PERFORM Z900-SQL-ABEND                               16520000
170600                                                                  16530000
170700     END-EVALUATE.                                                16540000
170800******************************************************************16550000
170900*     E100-CHECK-OVERRIDDEN-DOLLAR                               *16560000
171000* ==> PROCESSES:                                                 *16570000
171100*     - IF THE APPROVED AUTHORIZATION AMOUNT IS GREATER THAN THE *16580000
171200*       ORIGINAL AUTHORIZATION AMOUNT THE AMOUNT HAS BEEN        *16590000
171300*       OVERRIDDEN AND AN AUDIT RECORD IS WRITTEN.               *16600000
171400* ==> PERFORMED FROM:  C100-MISSING-POS-RECORD                   *16610000
171500*                      D100-MATCH-PROCESS                        *16620000
171600******************************************************************16630000
171700 E100-CHECK-OVERRIDDEN-DOLLAR.                                    16640000
171800                                                                  16650000
171900     IF SV022-APP-AUTH-AMT NOT = SV022-ORIG-AUTH-AMT              16660000
172000         SET SV019-AMOUNT-OVERRIDDEN TO TRUE                      16670000
172100         PERFORM Z200-MOVE-KMC-TO-AUDIT                           16680000
172200         PERFORM Z300-WRITE-AUDIT-RECORD                          16690000
172300     END-IF.                                                      16700000
172400                                                                  16710000
172500******************************************************************16720000
172600*     E200-CHECK-OVERTENDERED-BALNCE                             *16730000
172700* ==> PROCESSES:                                                 *16740000
172800*     - IF THE CARD BALANCE FOR THE DAY IS NEGATIVE AN AUDIT     *16750000
172900*       RECORD IS WRITTEN.  THE EXTRACT PROGRAM FOR TABLE        *16760000
173000*       SVT_KOHLS_CRD_TXN*                                        16770000
173100*       (RDKUT003) DOES A SUM ON THE CARD NUMBER AND THEN SETS   *16780000
173200*       A SWITCH INDICATING WHETHER THE BALANCE IS OVERTENDERED  *16790000
173300*       OR NOT.                                                  *16800000
173400* ==> PERFORMED FROM:  C100-MISSING-POS-RECORD                   *16810000
173500*                      D100-MATCH-PROCESS                        *16820000
173600******************************************************************16830000
173700 E200-CHECK-OVERTENDERED-BALNCE.                                  16840000
173800                                                                  16850000
173900     IF SV022-OVERTENDERED                                        16860000
174000         IF SV022-CRD-NBR = PV-HOLD-OVERTENDER-CRD-NBR            16870000
174100             CONTINUE                                             16880000
174200         ELSE                                                     16890000
174300             MOVE SV022-CRD-NBR TO PV-HOLD-OVERTENDER-CRD-NBR     16900000
174400             SET SV019-CARD-OVERTENDERED TO TRUE                  16910000
174500             PERFORM Z200-MOVE-KMC-TO-AUDIT                       16920000
174600             PERFORM Z300-WRITE-AUDIT-RECORD                      16930000
174700         END-IF                                                   16940000
174800     END-IF.                                                      16950000
174900*----------------------------------------------------------------*16960000
175000**  CONVERSION OF CARD NUMBER                                    *16970000
175100*----------------------------------------------------------------*16980000
175200     COPY SVPD007.                                                16990000
175300******************************************************************17000000
175400*     Y100-READ-SVT00002-ACTIVITY                                *17010000
175500* ==> PROCESSES:                                                 *17020000
175600* ==> PERFORMED FROM: B100-INITIALIZE                            *17030000
175700*                     B200-COMPARE-SVT00002-FILES                *17040000
175800*                     B400-PROCESS-REST-SVT0002-FILE            * 17050000
175900*                     C100-MISSING-POS-RECORD                    *17060000
176000******************************************************************17070000
176100 Y100-READ-SVT00002-ACTIVITY.                                     17080000
176200                                                                  17090000
176300     READ DAILY-SVT00002-ACTIVITY                                 17100000
176400                               INTO SV022-KMCACT-EXTRACT-RECORD   17110000
176500         AT END                                                   17120000
176600             SET PS-END-OF-SVT00002-FILE TO TRUE.                 17130000
176700                                                                  17140000
176800     IF PS-END-OF-SVT00002-FILE                                   17150000
176900       CONTINUE                                                   17160000
177000     ELSE                                                         17170000
177100       ADD +1 TO PA-SVT00002-ACTIVITY-RECS-READ                   17180000
177200       IF SV022-ACTVY-STAT-CDE = 1 AND                            17190000
177300                 SV022-POS-DTE = CR-CONTROL-DATE                  17200000
177400         IF SV022-CRD-TYP-CDE = 1                                 17210000
177500            IF SV022-ACTVY-TYP-CDE = 1                            17220000
177600               ADD SV022-APP-AUTH-AMT TO                          17230000
177700                       SV043-TOT-AUTH-ISSUE-K                     17240000
177800                       SV043-TOT-COMP-ISSUE-K                     17250000
177900               MOVE SV022-APP-AUTH-AMT TO                         17260000
178000                    SV044-TOT-AUTH-ISSUE-K                        17270000
178100            ELSE                                                  17280000
178200                IF SV022-ACTVY-TYP-CDE = 3                        17290000
178300                   ADD SV022-APP-AUTH-AMT TO                      17300000
178400                       SV043-TOT-AUTH-TND-K                       17310000
178500                       SV043-TOT-COMP-TND-K                       17320000
178600                   MOVE SV022-APP-AUTH-AMT TO                     17330000
178700                       SV044-TOT-AUTH-TND-K                       17340000
178800                END-IF                                            17350000
178900            END-IF                                                17360000
179000         ELSE                                                     17370000
179100          IF SV022-CRD-TYP-CDE = 2                                17380000
179200            IF SV022-ACTVY-TYP-CDE = 3                            17390000
179300                  ADD SV022-APP-AUTH-AMT TO                       17400000
179400                      SV043-TOT-AUTH-TND-G                        17410000
179500                      SV043-TOT-COMP-TND-G                        17420000
179600                  MOVE SV022-APP-AUTH-AMT TO                      17430000
179700                       SV044-TOT-AUTH-TND-G                       17440000
179800            ELSE                                                  17450000
179900               IF SV022-ACTVY-TYP-CDE = 2                         17460000
180000                  ADD SV022-APP-AUTH-AMT TO                       17470000
180100                      SV043-TOT-AUTH-ISSUE-G                      17480000
180200                      SV043-TOT-COMP-ISSUE-G                      17490000
180300*           ROLLING TOTALS                                        17500000
180400                  MOVE SV043-TOT-AUTH-ISSUE-G TO                  17510000
180500                       SV044-TOT-AUTH-ISSUE-G                     17520000
180600               END-IF                                             17530000
180700            END-IF                                                17540000
180800          END-IF                                                  17550000
180900         END-IF                                                   17560000
181000         MOVE SV022-STR-NBR         TO SV044-STORE-NBR            17570000
181100         MOVE SV022-POS-DTE         TO SV044-POS-DATE             17580000
181200         MOVE SV022-TRMNL-NBR       TO SV044-TERMINAL-NBR         17590000
181300         MOVE SV022-TRN-NBR         TO SV044-TRANSACTION-NBR      17600000
181400         MOVE SV022-CRD-NBR         TO SV044-KMC-CRD-NBR          17610000
181500         MOVE SV022-DRV-LIC-NBR     TO SV044-DRIVERS-LICENSE      17620000
181600         MOVE SV022-APP-AUTH-AMT    TO SV044-APPROVED-TRAN-AMT    17630000
181700         MOVE SV022-ORIG-AUTH-AMT   TO SV044-ORIGINAL-AUTH-AMT    17640000
181800         MOVE SV022-POS-OPER-ID     TO SV044-OPERATOR-ID          17650000
P12431         MOVE SV022-ORD-NBR         TO SV044-ORD-NBR              17651033
181900         MOVE SV022-APPR-USER-ID    TO SV044-USER-ID              17660000
182000         MOVE SV022-TRN-VOID-IND    TO SV044-TRANS-VOID-IND       17670000
182100         MOVE SV022-TRN-RVRSL-CDE   TO SV044-REVERSAL-IND         17680000
182200         MOVE SV022-ACTVY-TYP-CDE   TO SV044-TRANS-TYPE           17690000
182300         MOVE ZERO                  TO SV044-ERROR-TYPE           17700000
182400         MOVE SV022-CRD-TYP-CDE     TO SV044-CRD-TYP-CDE          17710000
182500         WRITE TOTAL-DETAIL-RECORD                                17720000
182600                 FROM SV044-TOTAL-DETAIL-OUT                      17730000
182700       END-IF                                                     17740000
182800     END-IF.                                                      17750000
182900                                                                  17760000
183000******************************************************************17770000
183100*     Y200-READ-POS-ACTIVITY                                     *17780000
183200* ==> PROCESSES:                                                 *17790000
183300* ==> PERFORMED FROM: B100-INITIALIZE                            *17800000
183400*                     B200-COMPARE-SVT00002-FILES                *17810000
183500*                     B300-PROCESS-REST-POS-FILE                 *17820000
183600******************************************************************17830000
183700 Y200-READ-POS-ACTIVITY.                                          17840000
183800                                                                  17850000
183900     READ DAILY-POS-ACTIVITY INTO SV021-POS-ACTIVITY-RECORD       17860000
184000         AT END                                                   17870000
184100             SET PS-END-OF-DAILY-POS-FILE TO TRUE.                17880000
184200                                                                  17890000
184300     IF PS-END-OF-DAILY-POS-FILE                                  17900000
184400         CONTINUE                                                 17910000
184500     ELSE                                                         17920000
184600         ADD +1 TO PA-SALES-ACTIVITY-RECS-READ                    17930000
184700     END-IF.                                                      17940000
184800                                                                  17950000
184900******************************************************************17960000
185000*     Z100-MOVE-POS-TO-AUDIT                                     *17970000
185100* ==> PROCESSES:                                                 *17980000
185200* ==> PERFORMED FROM:                                            *17990000
185300******************************************************************18000000
185400 Z100-MOVE-POS-TO-AUDIT.                                          18010000
185500                                                                  18020000
185600     MOVE SV021-CRD-NBR           TO SV019-KMC-CRD-NBR            18030000
185700     MOVE SV021-CRD-TYP-CDE       TO SV019-CRD-TYP-CDE            18040000
185800     MOVE SV021-POS-DTE           TO SV019-POS-DATE               18050000
185900     MOVE SV021-STR-NBR           TO SV019-STORE-NBR.             18060000
186000     MOVE SV021-TRMNL-NBR         TO SV019-TERMINAL-NBR.          18070000
186100     MOVE SV021-TRN-NBR           TO SV019-TRANSACTION-NBR.       18080000
186200     MOVE SV021-APP-AUTH-AMT      TO SV019-APPROVED-TRAN-AMT.     18090000
186300     MOVE SV021-ORIG-AUTH-AMT     TO SV019-ORIGINAL-AUTH-AMT.     18100000
186400                                                                  18110000
186500     IF SV021-TRN-VOID-IND = SV004-VOID-TRANS                     18120000
186600         MOVE SV004-VOID-DISPLAY  TO SV019-TRANS-VOID-IND         18130000
186700     ELSE                                                         18140000
186800         MOVE SV021-TRN-VOID-IND  TO SV019-TRANS-VOID-IND         18150000
186900     END-IF.                                                      18160000
187000                                                                  18170000
187100     MOVE SV021-TRN-RVRSL-CDE     TO SV019-REVERSAL-IND.          18180000
187200     MOVE SV021-DRV-LIC-NBR       TO SV019-DRIVERS-LICENSE.       18190000
187300     MOVE SV021-ACTVY-TYP-CDE     TO SV019-TRANS-TYPE.            18200000
187400     MOVE SV021-POS-OPER-ID       TO SV019-OPERATOR-ID.           18210000
P12431     MOVE SV021-ORD-NBR           TO SV019-ORD-NBR.               18211033
187500     MOVE SV021-APPR-USER-ID      TO SV019-USER-ID.               18220000
187600     MOVE SV021-TRN-STAT-CDE      TO SV019-TRN-STAT-CDE.          18230000
187700     MOVE SPACES                  TO SV019-TRN-AUTH-TMST.         18240000
187700     MOVE SV021-OMNI-CHNL-FFLMT   TO SV019-OMNI-CHNL-FFLMT.       18250000
187800                                                                  18260000
187900******************************************************************18270000
188000*     Z200-MOVE-KMC-TO-AUDIT                                     *18280000
188100* ==> PROCESSES:                                                 *18290000
188200* ==> PERFORMED FROM:                                            *18300000
188300******************************************************************18310000
188400 Z200-MOVE-KMC-TO-AUDIT.                                          18320000
188500                                                                  18330000
188600     MOVE SV022-CRD-NBR           TO SV019-KMC-CRD-NBR            18340000
188700     MOVE SV022-CRD-TYP-CDE       TO SV019-CRD-TYP-CDE            18350000
188800     MOVE SV022-POS-DTE           TO SV019-POS-DATE               18360000
188900     MOVE SV022-STR-NBR           TO SV019-STORE-NBR.             18370000
189000     MOVE SV022-TRMNL-NBR         TO SV019-TERMINAL-NBR.          18380000
189100     MOVE SV022-TRN-NBR           TO SV019-TRANSACTION-NBR.       18390000
189200     MOVE SV021-TRN-STAT-CDE      TO SV019-TRN-STAT-CDE.          18400000
189300     MOVE SV022-APP-AUTH-AMT      TO SV019-APPROVED-TRAN-AMT.     18410000
189400     MOVE SV022-ORIG-AUTH-AMT     TO SV019-ORIGINAL-AUTH-AMT.     18420000
189500                                                                  18430000
189600     IF SV022-TRN-VOID-IND = SV004-VOID-TRANS                     18440000
189700         MOVE SV004-VOID-DISPLAY  TO SV019-TRANS-VOID-IND         18450000
189800     ELSE                                                         18460000
189900         MOVE SV022-TRN-VOID-IND  TO SV019-TRANS-VOID-IND         18470000
190000     END-IF.                                                      18480000
190100                                                                  18490000
190200     MOVE SV022-TRN-RVRSL-CDE     TO SV019-REVERSAL-IND.          18500000
190300     MOVE SV022-DRV-LIC-NBR       TO SV019-DRIVERS-LICENSE.       18510000
190400     MOVE SV022-ACTVY-TYP-CDE     TO SV019-TRANS-TYPE.            18520000
190500     MOVE SV022-POS-OPER-ID       TO SV019-OPERATOR-ID.           18530000
P12431     MOVE SV022-ORD-NBR           TO SV019-ORD-NBR.               18531033
190600     MOVE SV022-APPR-USER-ID      TO SV019-USER-ID.               18540000
190700     MOVE SV022-TRN-AUTH-TMST     TO SV019-TRN-AUTH-TMST.         18550000
188600     IF  SV022-CRD-NBR = SV021-CRD-NBR AND                        18550100
151500       SV019-VERIFIED-DUPLICATE                                   18550200
187700         MOVE SV021-OMNI-CHNL-FFLMT TO SV019-OMNI-CHNL-FFLMT      18551000
188600     ELSE                                                         18551100
187700         MOVE SPACES                TO SV019-OMNI-CHNL-FFLMT      18551200
190800     END-IF.                                                      18552000
190900******************************************************************18553000
191000*     Z250-MOVE-KMC-TO-POSTING                                   *18554000
191100* ==> PROCESSES:                                                 *18555000
191200* ==> PERFORMED FROM: D100-MATCH-PROCESS                         *18556000
191300******************************************************************18557000
191400 Z250-MOVE-KMC-TO-POSTING.                                        18558000
191500                                                                  18559000
191600     MOVE PC-UPDATE-RECORD        TO SV018-RECORD-TYPE.           18560000
191700     MOVE SV004-STAT-VERIFIED-CD  TO SV018-UPDATED-ACTIVITY.      18570000
191800                                                                  18580000
191900     MOVE SV022-CRD-TYP-CDE       TO SV018-CRD-TYP-CDE.           18590000
192000     MOVE SV022-CRD-NBR           TO SV018-KMC-CRD-NBR.           18600000
192100     MOVE SV022-POS-DTE           TO SV018-POS-DATE.              18610000
192200     MOVE SV022-STR-NBR           TO SV018-STORE-NBR.             18620000
192300     MOVE SV022-TRMNL-NBR         TO SV018-TERMINAL-NBR.          18630000
192400     MOVE SV022-TRN-NBR           TO SV018-TRANSACTION-NBR.       18640000
192400*    MOVE SV021-TRN-NBR           TO SV018-TRANSACTION-NBR.       18650000
192500     MOVE SV022-APP-AUTH-AMT      TO SV018-APPROVED-TRAN-AMT.     18660000
192600     MOVE SV022-ORIG-AUTH-AMT     TO SV018-ORIGINAL-AUTH-AMT.     18670000
192700     MOVE SV022-TRN-VOID-IND      TO SV018-TRANS-VOID-IND.        18680000
192800     MOVE SV022-TRN-RVRSL-CDE     TO SV018-REVERSAL-IND.          18690000
192900     MOVE SV022-DRV-LIC-NBR       TO SV018-DRIVERS-LICENSE.       18700000
193000     MOVE SV022-ACTVY-TYP-CDE     TO SV018-TRANS-TYPE.            18710000
193100     MOVE SV022-POS-OPER-ID       TO SV018-POS-OPERATOR-ID.       18720000
P12431     MOVE SV022-ORD-NBR           TO SV018-ORD-NBR.               18721033
193200     MOVE SV022-APPR-USER-ID      TO SV018-APPROVAL-USER-ID.      18730000
193300     MOVE SV022-TRN-AUTH-TMST     TO SV018-TRN-AUTH-TMST.         18740000
193400                                                                  18750000
193500******************************************************************18760000
193600*     Z260-MOVE-SAVED-KMC-TO-POSTING                             *18770000
193700* ==> PROCESSES:                                                 *18780000
193800* ==> PERFORMED FROM: D100-MATCH-PROCESS                         *18790000
193900******************************************************************18800000
194000 Z260-MOVE-SAVED-KMC-TO-POSTING.                                  18810000
194100     MOVE PC-UPDATE-RECORD        TO SV018-RECORD-TYPE.           18820000
194200     MOVE SV004-STAT-VERIFIED-CD  TO SV018-UPDATED-ACTIVITY.      18830000
194300     MOVE PV-SAVE-SV022-CRD-TYP   TO SV018-CRD-TYP-CDE.           18840000
194400     MOVE PV-SAVE-SV022-CRD-NBR   TO SV018-KMC-CRD-NBR.           18850000
194500     MOVE PV-SAVE-SV022-POS-DTE   TO SV018-POS-DATE.              18860000
194600     MOVE PV-SAVE-SV022-STR-NBR   TO SV018-STORE-NBR.             18870000
194700     MOVE PV-SAVE-SV022-TRMNLNO   TO SV018-TERMINAL-NBR.          18880000
194800     MOVE PV-SAVE-SV022-TRN-NBR   TO SV018-TRANSACTION-NBR.       18890000
194900     MOVE PV-SAVE-SV022-APP-AMT   TO SV018-APPROVED-TRAN-AMT.     18900000
195000     MOVE PV-SAVE-SV022-ORG-AMT   TO SV018-ORIGINAL-AUTH-AMT.     18910000
195100     MOVE PV-SAVE-SV022-TRNVOID   TO SV018-TRANS-VOID-IND.        18920000
195200     MOVE PV-SAVE-SV022-TRNRCDE   TO SV018-REVERSAL-IND.          18930000
195300     MOVE PV-SAVE-SV022-DRV-LIC   TO SV018-DRIVERS-LICENSE.       18940000
195400     MOVE PV-SAVE-SV022-ACT-TYP   TO SV018-TRANS-TYPE.            18950000
195500     MOVE PV-SAVE-SV022-POS-OPR   TO SV018-POS-OPERATOR-ID.       18960000
P12431     MOVE PV-SAVE-SV022-ORD-NBR   TO SV018-ORD-NBR.               18961033
195600     MOVE PV-SAVE-SV022-APP-USR   TO SV018-APPROVAL-USER-ID.      18970000
195700     MOVE PV-SAVE-SV022-TRN-AUTH-TMST TO SV018-TRN-AUTH-TMST.     18980000
195800                                                                  18990000
195900******************************************************************19000000
196000*     Z300-WRITE-AUDIT-RECORD                                    *19010000
196100* ==> PROCESSES:                                                 *19020000
196200* ==> PERFORMED FROM:                                            *19030000
196300******************************************************************19040000
196400 Z300-WRITE-AUDIT-RECORD.                                         19050000
196500                                                                  19060000
196600     INITIALIZE SV044-TOTAL-DETAIL-OUT.                           19070000
196700     MOVE +1 TO PV-SUB.                                           19080000
196800     SET PS-NOT-ECOMM-STR TO TRUE.                                19090000
196900     MOVE SV019-STORE-NBR TO PV-STORE-NBR.                        19100000
197000     PERFORM Z600-ECOMM-STR UNTIL PV-SUB > PV-MAX-STORE.          19110000
197100                                                                  19120000
197200*    NOT FULFILLED TOTALS - UNMATCHED                             19130000
197300     IF PS-ECOMM-STR                                              19140000
197400       IF SV019-CRD-TYP-CDE = 1                                   19150000
197500         IF SV019-TRANS-TYPE = 3                                  19160000
197600           PERFORM Z310-ECOMM-KMRC-TENDER                         19170000
197700         ELSE                                                     19180000
197800           IF SV019-TRANS-TYPE = 1                                19190000
197900             PERFORM Z320-ECOMM-KMRC-ISSUE                        19200000
198000           END-IF                                                 19210000
198100         END-IF                                                   19220000
198200       ELSE                                                       19230000
198300         IF SV019-CRD-TYP-CDE = 2                                 19240000
198400           IF SV019-TRANS-TYPE = 3                                19250000
198500             PERFORM Z330-ECOMM-GIFTCARD-TENDER                   19260000
198600           ELSE                                                   19270000
198700             IF SV019-TRANS-TYPE = 2                              19280000
198800               PERFORM Z340-ECOMM-GIFTCARD-ISSUE                  19290000
198900             END-IF                                               19300000
199000           END-IF                                                 19310000
199100         END-IF                                                   19320000
199200       END-IF                                                     19330000
199300     END-IF.                                                      19340000
199400                                                                  19350000
199500     WRITE AUDIT-REPORT-RECORD                                    19360000
199600         FROM SV019-AUDIT-REPORT-RECORD.                          19370000
199700     ADD +1 TO PA-AUDIT-RECORDS-WRITTEN.                          19380000
199800                                                                  19390000
199900******************************************************************19400000
200000*    UNMATCHED ECOMMERCE KMRC TENDERS                            *19410000
200100******************************************************************19420000
200200 Z310-ECOMM-KMRC-TENDER.                                          19430000
200300     IF SV019-POS-DATE = CR-CONTROL-DATE                          19440000
200400       IF SV019-TRANS-VOID-IND = 'N'                              19450000
200500         ADD SV019-APPROVED-TRAN-AMT TO                           19460000
200600             SV043-ECOMM-DOL-TNDNT-K                              19470000
200700         ADD +1 TO SV043-ECOMM-CNT-TNDNT-K                        19480000
200800         MOVE SV019-APPROVED-TRAN-AMT TO                          19490000
200900              SV044-ECOMM-DOL-TNDNT-K                             19500000
201000       ELSE                                                       19510000
201100         ADD SV019-APPROVED-TRAN-AMT TO                           19520000
201200             SV043-ECOMM-DOL-TNDVNT-K                             19530000
201300         ADD +1 TO SV043-ECOMM-CNT-TNDVNT-K                       19540000
201400         MOVE SV019-APPROVED-TRAN-AMT TO                          19550000
201500              SV044-ECOMM-DOL-TNDVNT-K                            19560000
201600       END-IF                                                     19570000
201700     ELSE                                                         19580000
201800       IF SV019-POS-DATE < CR-CONTROL-DATE                        19590000
201900         IF SV019-TRANS-VOID-IND = 'N'                            19600000
202000           ADD SV019-APPROVED-TRAN-AMT TO                         19610000
202100               SV043-ECOMM-DOL-TNDNTP-K                           19620000
202200           ADD +1 TO SV043-ECOMM-CNT-TNDNTP-K                     19630000
202300           MOVE SV019-APPROVED-TRAN-AMT TO                        19640000
202400                SV044-ECOMM-DOL-TNDNTP-K                          19650000
202500         ELSE                                                     19660000
202600           ADD SV019-APPROVED-TRAN-AMT TO                         19670000
202700               SV043-ECOMM-DOL-TNDVNTP-K                          19680000
202800           ADD +1 TO SV043-ECOMM-CNT-TNDVNTP-K                    19690000
202900           MOVE SV019-APPROVED-TRAN-AMT TO                        19700000
203000                SV044-ECOMM-DOL-TNDVNTP-K                         19710000
203100         END-IF                                                   19720000
203200       END-IF                                                     19730000
203300     END-IF.                                                      19740000
203400******************************************************************19750000
203500*    UNMATCHED ECOMMERCE KMRC ISSUES                             *19760000
203600******************************************************************19770000
203700 Z320-ECOMM-KMRC-ISSUE.                                           19780000
203800     IF SV019-POS-DATE = CR-CONTROL-DATE                          19790000
203900       IF SV019-TRANS-VOID-IND = 'N'                              19800000
204000         ADD SV019-APPROVED-TRAN-AMT TO                           19810000
204100             SV043-ECOMM-DOL-ISSNT-K                              19820000
204200         ADD +1 TO SV043-ECOMM-CNT-ISSNT-K                        19830000
204300         MOVE SV019-APPROVED-TRAN-AMT TO                          19840000
204400              SV044-ECOMM-DOL-ISSNT-K                             19850000
204500       ELSE                                                       19860000
204600         ADD SV019-APPROVED-TRAN-AMT TO                           19870000
204700             SV043-ECOMM-DOL-ISSVNT-K                             19880000
204800         ADD +1 TO SV043-ECOMM-CNT-ISSVNT-K                       19890000
204900         MOVE SV019-APPROVED-TRAN-AMT TO                          19900000
205000              SV044-ECOMM-DOL-ISSVNT-K                            19910000
205100       END-IF                                                     19920000
205200     ELSE                                                         19930000
205300       IF SV019-POS-DATE < CR-CONTROL-DATE                        19940000
205400         IF SV019-TRANS-VOID-IND = 'N'                            19950000
205500           ADD SV019-APPROVED-TRAN-AMT TO                         19960000
205600               SV043-ECOMM-DOL-ISSNTP-K                           19970000
205700           ADD +1 TO SV043-ECOMM-CNT-ISSNTP-K                     19980000
205800           MOVE SV019-APPROVED-TRAN-AMT TO                        19990000
205900                SV044-ECOMM-DOL-ISSNTP-K                          20000000
206000         ELSE                                                     20010000
206100           ADD SV019-APPROVED-TRAN-AMT TO                         20020000
206200               SV043-ECOMM-DOL-ISSVNTP-K                          20030000
206300           ADD +1 TO SV043-ECOMM-CNT-ISSVNTP-K                    20040000
206400           MOVE SV019-APPROVED-TRAN-AMT TO                        20050000
206500                SV044-ECOMM-DOL-ISSVNTP-K                         20060000
206600         END-IF                                                   20070000
206700       END-IF                                                     20080000
206800     END-IF.                                                      20090000
206900******************************************************************20100000
207000*    UNMATCHED ECOMMERCE GIFTCARD TENDER                         *20110000
207100******************************************************************20120000
207200 Z330-ECOMM-GIFTCARD-TENDER.                                      20130000
207300     IF SV019-POS-DATE = CR-CONTROL-DATE                          20140000
207400       IF SV019-TRANS-VOID-IND = 'N'                              20150000
207500         ADD SV019-APPROVED-TRAN-AMT TO                           20160000
207600             SV043-ECOMM-DOL-TNDNT-G                              20170000
207700         ADD +1 TO SV043-ECOMM-CNT-TNDNT-G                        20180000
207800         MOVE SV019-APPROVED-TRAN-AMT TO                          20190000
207900              SV044-ECOMM-DOL-TNDNT-G                             20200000
208000       ELSE                                                       20210000
208100         ADD SV019-APPROVED-TRAN-AMT TO                           20220000
208200             SV043-ECOMM-DOL-TNDVNT-G                             20230000
208300         ADD +1 TO SV043-ECOMM-CNT-TNDVNT-G                       20240000
208400         MOVE SV019-APPROVED-TRAN-AMT TO                          20250000
208500              SV044-ECOMM-DOL-TNDVNT-G                            20260000
208600       END-IF                                                     20270000
208700     ELSE                                                         20280000
208800       IF SV019-POS-DATE < CR-CONTROL-DATE                        20290000
208900         IF SV019-TRANS-VOID-IND = 'N'                            20300000
209000           ADD SV019-APPROVED-TRAN-AMT TO                         20310000
209100               SV043-ECOMM-DOL-TNDNTP-G                           20320000
209200           ADD +1 TO SV043-ECOMM-CNT-TNDNTP-G                     20330000
209300           MOVE SV019-APPROVED-TRAN-AMT TO                        20340000
209400                SV044-ECOMM-DOL-TNDNTP-G                          20350000
209500         ELSE                                                     20360000
209600           ADD SV019-APPROVED-TRAN-AMT TO                         20370000
209700               SV043-ECOMM-DOL-TNDVNTP-G                          20380000
209800           ADD +1 TO SV043-ECOMM-CNT-TNDVNTP-G                    20390000
209900           MOVE SV019-APPROVED-TRAN-AMT TO                        20400000
210000                SV044-ECOMM-DOL-TNDVNTP-G                         20410000
210100         END-IF                                                   20420000
210200       END-IF                                                     20430000
210300     END-IF.                                                      20440000
210400******************************************************************20450000
210500*    UNMATCHED ECOMMERCE GIFTCARD TENDER                         *20460000
210600******************************************************************20470000
210700 Z340-ECOMM-GIFTCARD-ISSUE.                                       20480000
210800     IF SV019-POS-DATE = CR-CONTROL-DATE                          20490000
210900       IF SV019-TRANS-VOID-IND = 'N'                              20500000
211000         ADD SV019-APPROVED-TRAN-AMT TO                           20510000
211100             SV043-ECOMM-DOL-ISSNT-G                              20520000
211200         ADD +1 TO SV043-ECOMM-CNT-ISSNT-G                        20530000
211300         MOVE SV019-APPROVED-TRAN-AMT TO                          20540000
211400              SV044-ECOMM-DOL-ISSNT-G                             20550000
211500       ELSE                                                       20560000
211600         ADD SV019-APPROVED-TRAN-AMT TO                           20570000
211700             SV043-ECOMM-DOL-ISSVNT-G                             20580000
211800         ADD +1 TO SV043-ECOMM-CNT-ISSVNT-G                       20590000
211900         MOVE SV019-APPROVED-TRAN-AMT TO                          20600000
212000              SV044-ECOMM-DOL-ISSVNT-G                            20610000
212100       END-IF                                                     20620000
212200     ELSE                                                         20630000
212300       IF SV019-POS-DATE < CR-CONTROL-DATE                        20640000
212400         IF SV019-TRANS-VOID-IND = 'N'                            20650000
212500           ADD SV019-APPROVED-TRAN-AMT TO                         20660000
212600               SV043-ECOMM-DOL-ISSNTP-G                           20670000
212700           ADD +1 TO SV043-ECOMM-CNT-ISSNTP-G                     20680000
212800           MOVE SV019-APPROVED-TRAN-AMT TO                        20690000
212900                SV044-ECOMM-DOL-ISSNTP-G                          20700000
213000         ELSE                                                     20710000
213100           ADD SV019-APPROVED-TRAN-AMT TO                         20720000
213200               SV043-ECOMM-DOL-ISSVNTP-G                          20730000
213300           ADD +1 TO SV043-ECOMM-CNT-ISSVNTP-G                    20740000
213400           MOVE SV019-APPROVED-TRAN-AMT TO                        20750000
213500                SV044-ECOMM-DOL-ISSVNTP-G                         20760000
213600         END-IF                                                   20770000
213700       END-IF                                                     20780000
213800     END-IF.                                                      20790000
213900******************************************************************20800000
214000*     Z400-WRITE-UPDATE-RECORD                                   *20810000
214100******************************************************************20820000
214200 Z400-WRITE-UPDATE-RECORD.                                        20830000
214300                                                                  20840000
214400     INITIALIZE SV044-TOTAL-DETAIL-OUT.                           20850000
214500     WRITE KMC-POSTING-RECORD                                     20860000
214600         FROM SV018-UPDATE-POSTING-RECORD.                        20870000
214700     ADD +1 TO PA-UPDATE-RECORDS-WRITTEN.                         20880000
214800                                                                  20890000
214900     IF SV018-SETTLED                                             20900000
215000        IF SV022-CRD-TYP-CDE = 1                                  20910000
215100           IF SV022-ACTVY-TYP-CDE = 1                             20920000
215200               ADD SV022-APP-AUTH-AMT TO                          20930000
215300                   SV043-TOT-VER-ISSUE-K                          20940000
215400                   SV043-TOT-COMP-ISSUE-K                         20950000
215500           ELSE                                                   20960000
215600               ADD SV022-APP-AUTH-AMT TO                          20970000
215700                   SV043-TOT-VER-TND-K                            20980000
215800                   SV043-TOT-COMP-TND-K                           20990000
215900           END-IF                                                 21000000
216000        ELSE                                                      21010000
216100           IF SV022-ACTVY-TYP-CDE = 2                             21020000
216200               ADD SV022-APP-AUTH-AMT TO                          21030000
216300                   SV043-TOT-VER-ISSUE-G                          21040000
216400                   SV043-TOT-COMP-ISSUE-G                         21050000
216500           ELSE                                                   21060000
216600               ADD SV022-APP-AUTH-AMT TO                          21070000
216700                   SV043-TOT-VER-TND-G                            21080000
216800                   SV043-TOT-COMP-TND-G                           21090000
216900           END-IF                                                 21100000
217000        END-IF                                                    21110000
217100     END-IF.                                                      21120000
217200                                                                  21130000
217300     MOVE +1 TO PV-SUB.                                           21140000
217400     SET PS-NOT-ECOMM-STR TO TRUE.                                21150000
217500     MOVE SV018-STORE-NBR TO PV-STORE-NBR.                        21160000
217600     PERFORM Z600-ECOMM-STR UNTIL PV-SUB > PV-MAX-STORE.          21170000
217700                                                                  21180000
217800     IF PS-ECOMM-STR                                              21190000
217900       IF SV018-CRD-TYP-CDE = 1                                   21200000
218000         IF SV018-TRANS-TYPE = 3                                  21210000
218100           PERFORM Z410-ECOMM-KMRC-TENDER                         21220000
218200         ELSE                                                     21230000
218300           IF SV018-TRANS-TYPE = 1                                21240000
218400             PERFORM Z420-ECOMM-KMRC-ISSUE                        21250000
218500           END-IF                                                 21260000
218600         END-IF                                                   21270000
218700       ELSE                                                       21280000
218800         IF SV018-CRD-TYP-CDE = 2                                 21290000
218900           IF SV018-TRANS-TYPE = 3                                21300000
219000             PERFORM Z430-ECOMM-GIFTCARD-TENDER                   21310000
219100           ELSE                                                   21320000
219200             IF SV018-TRANS-TYPE = 2                              21330000
219300               PERFORM Z440-ECOMM-GIFTCARD-ISSUE                  21340000
219400             END-IF                                               21350000
219500           END-IF                                                 21360000
219600         END-IF                                                   21370000
219700       END-IF                                                     21380000
219800     END-IF.                                                      21390000
219900                                                                  21400000
220000******************************************************************21410000
220100*     MATCHED ECOMMERCE KMRC TENDER                              *21420000
220200******************************************************************21430000
220300 Z410-ECOMM-KMRC-TENDER.                                          21440000
220400     IF SV018-TRANS-VOID-IND = 'N'                                21450000
220500         ADD SV018-APPROVED-TRAN-AMT TO                           21460000
220600             SV043-ECOMM-DOL-TNDT-K                               21470000
220700         ADD +1 TO SV043-ECOMM-CNT-TNDT-K                         21480000
220800         MOVE SV018-APPROVED-TRAN-AMT TO                          21490000
220900              SV044-ECOMM-DOL-TNDT-K                              21500000
221000     ELSE                                                         21510000
221100         ADD SV018-APPROVED-TRAN-AMT TO                           21520000
221200             SV043-ECOMM-DOL-TNDVT-K                              21530000
221300         ADD +1 TO SV043-ECOMM-CNT-TNDVT-K                        21540000
221400         MOVE SV018-APPROVED-TRAN-AMT TO                          21550000
221500              SV044-ECOMM-DOL-TNDVT-K                             21560000
221600     END-IF.                                                      21570000
221700******************************************************************21580000
221800*     MATCHED ECOMMERCE KMRC ISSUE                               *21590000
221900******************************************************************21600000
222000 Z420-ECOMM-KMRC-ISSUE.                                           21610000
222100     IF SV018-TRANS-VOID-IND = 'N'                                21620000
222200         ADD SV018-APPROVED-TRAN-AMT TO                           21630000
222300             SV043-ECOMM-DOL-ISST-K                               21640000
222400         ADD +1 TO SV043-ECOMM-CNT-ISST-K                         21650000
222500         MOVE SV018-APPROVED-TRAN-AMT TO                          21660000
222600              SV044-ECOMM-DOL-ISST-K                              21670000
222700     ELSE                                                         21680000
222800         ADD SV018-APPROVED-TRAN-AMT TO                           21690000
222900             SV043-ECOMM-DOL-ISSVT-K                              21700000
223000         ADD +1 TO SV043-ECOMM-CNT-ISSVT-K                        21710000
223100         MOVE SV018-APPROVED-TRAN-AMT TO                          21720000
223200              SV044-ECOMM-DOL-ISSVT-K                             21730000
223300     END-IF.                                                      21740000
223400******************************************************************21750000
223500*     MATCHED ECOMMERCE GIFTCARD TENDER                          *21760000
223600******************************************************************21770000
223700 Z430-ECOMM-GIFTCARD-TENDER.                                      21780000
223800     IF SV018-TRANS-VOID-IND = 'N'                                21790000
223900         ADD SV018-APPROVED-TRAN-AMT TO                           21800000
224000             SV043-ECOMM-DOL-TNDT-G                               21810000
224100         ADD +1 TO SV043-ECOMM-CNT-TNDT-G                         21820000
224200         MOVE SV018-APPROVED-TRAN-AMT TO                          21830000
224300              SV044-ECOMM-DOL-TNDT-G                              21840000
224400     ELSE                                                         21850000
224500         ADD SV018-APPROVED-TRAN-AMT TO                           21860000
224600             SV043-ECOMM-DOL-TNDVT-G                              21870000
224700         ADD +1 TO SV043-ECOMM-CNT-TNDVT-G                        21880000
224800         MOVE SV018-APPROVED-TRAN-AMT TO                          21890000
224900              SV044-ECOMM-DOL-TNDVT-G                             21900000
225000     END-IF.                                                      21910000
225100******************************************************************21920000
225200*     MATCHED ECOMMERCE GIFTCARD ISSUE                           *21930000
225300******************************************************************21940000
225400 Z440-ECOMM-GIFTCARD-ISSUE.                                       21950000
225500     IF SV018-TRANS-VOID-IND = 'N'                                21960000
225600         ADD SV018-APPROVED-TRAN-AMT TO                           21970000
225700             SV043-ECOMM-DOL-ISST-G                               21980000
225800         ADD +1 TO SV043-ECOMM-CNT-ISST-G                         21990000
225900         MOVE SV018-APPROVED-TRAN-AMT TO                          22000000
226000              SV044-ECOMM-DOL-ISST-G                              22010000
226100     ELSE                                                         22020000
226200         ADD SV018-APPROVED-TRAN-AMT TO                           22030000
226300             SV043-ECOMM-DOL-ISSVT-G                              22040000
226400         ADD +1 TO SV043-ECOMM-CNT-ISSVT-G                        22050000
226500         MOVE SV018-APPROVED-TRAN-AMT TO                          22060000
226600              SV044-ECOMM-DOL-ISSVT-G                             22070000
226700     END-IF.                                                      22080000
226800******************************************************************22090000
226900*     Z600-ECOM-STR                                              *22100000
227000* ==> PROCESSES:                                                 *22110000
227100*     -SEARCHES THROUGH THE ECOMMERCE STORE TABLE                *22120000
227200******************************************************************22130000
227300 Z600-ECOMM-STR.                                                  22140000
227400     IF PV-STORE-NBR = PV-ECOMM-STR (PV-SUB)                      22150000
227500         SET PS-ECOMM-STR TO TRUE                                 22160000
227600     END-IF.                                                      22170000
227700     ADD +1 TO PV-SUB.                                            22180000
227800                                                                  22190000
227900******************************************************************22200000
228000*     Z900-SQL-ABEND                                             *22210000
228100* ==> PROCESSES:                                                 *22220000
228200*     -PERFORMS ABEND PROCESSING FOR SQL ERRORS.                 *22230000
228300* ==> PERFORMED FROM:                                            *22240000
228400******************************************************************22250000
228500 Z900-SQL-ABEND.                                                  22260000
228600                                                                  22270000
228700     DISPLAY 'Z900-SQL-ABEND'.                                    22280000
228800     DISPLAY '**  ABEND     **'.                                  22290000
228900     DISPLAY '**  PROGRAM   ** = ' PC-PROGRAM-NAME.               22300000
229000     DISPLAY '**  PARAGRAPH ** = ' PV-PARAGRAPH-NAME.             22310000
229100     DISPLAY '**  OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.    22320000
229200                                                                  22330000
229300******************************************************************22340000
229400* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *22350000
229500* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *22360000
229600* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *22370000
229700* FORMAT.                                                        *22380000
229800******************************************************************22390000
229900     COPY DPPD004.                                                22400000
230000                                                                  22410000
230100     MOVE +4013 TO ABEND-CODE.                                    22420000
230200     CALL WS-ABEND-ROUTINE USING ABEND-CODE.                      22430000
P10237                                                                  22440000
P10237******************************************************************22450000
P10237* COPY MEMBER DPPD031 CONTAINS STATEMENTS NEEDED TO INVOKE      * 22460014
P10237* PROTEGRITY MODULE FOR PROTECTION / UNPROTECTION               * 22470000
P10237******************************************************************22480000
P10237     COPY DPPD031.                                                22490014
P10237                                                                  22500000
