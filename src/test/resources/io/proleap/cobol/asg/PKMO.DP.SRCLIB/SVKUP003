000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400 PROGRAM-ID.                SVKUP003.                             00040000
000500 AUTHOR.                    BARB SCHULTZ.                         00050000
000600 INSTALLATION.              KOHLS DEPARTMENT STORES.              00060000
000700 DATE-WRITTEN.              09-15-2000.                           00070000
000800 DATE-COMPILED.                                                   00080000
000900                                                                  00090000
001000******************************************************************00100000
001100*  BATCH PROGRAM - SVKUP003                                      *00110000
001200*                                                                *00120000
001300*       STORED VALUE OFFLINE SUPPORT                             *00130000
001400*                                                                *00140000
001500*  THIS PROGRAM WILL UPDATE SVT_KOHLS_CRD_TXN FOR VOID AFTER     *00150000
001600*  ACTIVITY IN AN OFFLINE SITUATION.                             *00160000
001700*                                                                *00170000
001800******************************************************************00180000
P10237*  04/08/2015  CHANGES TO DE-TOKENIZE THE GIFT CARD NUMBER       *00181000
P10237*              AS PART OF COSA DATA SECURITY PROJECT.            *00182000
P10237*  MADE BY: COGNIZANT                   WR#: CHG0104429          *00183000
P10237******************************************************************00184000
050222*  05/02/2022 DAN PAYNTER                                        *00184100
050222*  CHG0268732                                                    *00184200
050222*  OMIT SEPHORA GIFT CARDS                                       *00184300
050222******************************************************************00184400
001800                                                                  00185000
001900 ENVIRONMENT DIVISION.                                            00190000
002000******************************************************************00200000
002100                                                                  00210000
002200 CONFIGURATION SECTION.                                           00220000
002300                                                                  00230000
002400 SOURCE-COMPUTER.    IBM-3090.                                    00240000
002500 OBJECT-COMPUTER.    IBM-3090.                                    00250000
002600                                                                  00260000
002700 INPUT-OUTPUT SECTION.                                            00270000
002800                                                                  00280000
002900 FILE-CONTROL.                                                    00290000
003000                                                                  00300000
003100     SELECT POS-DATE-CARD-FILE                                    00310000
003200         ASSIGN TO INP01.                                         00320000
003300                                                                  00330000
003400******************************************************************00340000
003500 DATA DIVISION.                                                   00350000
003600******************************************************************00360000
003700                                                                  00370000
003800 FILE SECTION.                                                    00380000
003900                                                                  00390000
004000 FD  POS-DATE-CARD-FILE                                           00400000
004100     RECORDING MODE IS F                                          00410000
004200     BLOCK CONTAINS 0 RECORDS                                     00420000
004300     LABEL RECORDS ARE STANDARD.                                  00430000
004400                                                                  00440000
004500 01  POS-DATE-CARD-RECORD            PIC X(80).                   00450000
004600                                                                  00460000
004700 WORKING-STORAGE SECTION.                                         00470000
004800                                                                  00480000
004900 01  FILLER                            PIC X(50)  VALUE           00490000
005000     ' *** WORKING STORAGE STARTS HERE FOR SVKUP003 *** '.        00500000
005100                                                                  00510000
005200******************************************************************00520000
005300*  RECORD LAYOUT FOR INPUT DATE CARD (POS DATE)                   00530000
005400******************************************************************00540000
005500 01  CC-CONTROL-CARD.                                             00550000
005600     05  CC-POS-DATE-CCYY-MM-DD  PIC X(10)    VALUE SPACES.       00560000
005700     05  FILLER                  PIC X(70)    VALUE SPACES.       00570000
005800                                                                  00580000
005900 01  PS-PROGRAM-SWITCHES.                                         00590000
006000     05  PS-END-OF-ITEM-CSR-SW     PIC  X(01)        VALUE 'N'.   00600000
006100         88  PS-END-OF-ITEM-CSR                      VALUE 'Y'.   00610000
006200     05  PS-END-OF-TND-CSR-SW      PIC  X(01)        VALUE 'N'.   00620000
006300         88  PS-END-OF-TND-CSR                       VALUE 'Y'.   00630000
006400     05  PS-END-OF-CARD-FILE-SW    PIC  X(01)        VALUE 'N'.   00640000
006500         88  PS-END-OF-CARD-FILE                     VALUE 'Y'.   00650000
006600     05  PS-DUPLICATE-SW         PIC X(1)          VALUE 'N'.     00660000
006700         88  PS-DUPLICATE                          VALUE 'Y'.     00670000
006800         88  PS-NOT-DUPLICATE                      VALUE 'N'.     00680000
006900     05  PS-CONTINUE-SW          PIC X(1)          VALUE 'Y'.     00690000
007000         88  PS-CONTINUE                           VALUE 'Y'.     00700000
007100         88  PS-DONT-CONTINUE                      VALUE 'N'.     00710000
007200     05  PS-UPDATE-SUCCESSFUL-SW PIC X(1)          VALUE 'N'.     00720000
007300         88  PS-UPDATE-SUCCESSFUL                  VALUE 'Y'.     00730000
007400         88  PS-UPDATE-NOT-SUCCESSFUL              VALUE 'N'.     00740000
007500                                                                  00750000
007600 01  PC-PROGRAM-CONSTANTS.                                        00760000
007700     05  PC-PROGRAM-NAME         PIC X(8)     VALUE 'SVKUP003'.   00770000
007800     05  PC-DRIVER-LICENSE       PIC X(8)     VALUE '98100000'.   00780000
007900     05  PC-OFFLINE              PIC X(8)     VALUE 'OFFLINE '.   00790000
008000     05  PC-DEFAULT-TIMESTAMP    PIC X(26)    VALUE               00800000
008100                '9999-09-09-09.09.09.000000'.                     00810000
008200     05  PC-TRN-RVRSL-CD         PIC S9(1)V COMP-3 VALUE +0.      00820000
008300                                                                  00830000
008400 01  PV-PROGRAM-VARIABLES.                                        00840000
008500     05  PV-CARD-NBR             PIC S9(12)V COMP-3 VALUE ZERO.   00850000
008600     05  PV-PARAGRAPH-NAME       PIC X(30)         VALUE SPACE.   00860000
008700     05  PV-DB2-OPERATION        PIC X(30)         VALUE SPACE.   00870000
008800     05  PV-OPERATION-MSG        PIC X(30)         VALUE SPACE.   00880000
008900     05  PV-POS-DATE-CCYY-MM-DD  PIC X(10)         VALUE SPACES.  00890000
009000     05  FILLER REDEFINES PV-POS-DATE-CCYY-MM-DD.                 00900000
009100         10  PV-POS-CCYY         PIC X(04).                       00910000
009200         10  FILLER              PIC X(01).                       00920000
009300         10  PV-POS-MM           PIC X(02).                       00930000
009400         10  FILLER              PIC X(01).                       00940000
009500         10  PV-POS-DD           PIC X(02).                       00950000
009600     05  PV-TIMESTAMP            PIC X(26)         VALUE SPACES.  00960000
009700     05  PV-TIMESTAMP-SEPARATE.                                   00970000
009800         10  PV-CCYY             PIC X(04)         VALUE SPACES.  00980000
009900         10  PV-DASH-1           PIC X(01)         VALUE '-'.     00990000
010000         10  PV-MM               PIC X(02)         VALUE SPACES.  01000000
010100         10  PV-DASH-2           PIC X(01)         VALUE '-'.     01010000
010200         10  PV-DD               PIC X(02)         VALUE SPACES.  01020000
010300         10  PV-PER-1            PIC X(01)         VALUE '-'.     01030000
010400         10  PV-HR               PIC X(2)          VALUE SPACES.  01040000
010500         10  PV-PER-0            PIC X(01)         VALUE '.'.     01050000
010600         10  PV-MIN              PIC X(2)          VALUE SPACES.  01060000
010700         10  PV-PER-1            PIC X(01)         VALUE '.'.     01070000
010800         10  PV-SEC              PIC X(2)          VALUE '00'.    01080000
010900         10  PV-PER-1            PIC X(01)         VALUE '.'.     01090000
011000         10  PV-NONOSEC          PIC X(6)          VALUE '000000'.01100000
011100*               '9999-09-09-09.09.09.000000'.                     01110000
011200                                                                  01120000
011300                                                                  01130000
011400 01  AC-ABEND-CODE               PIC S9(04)        VALUE ZERO     01140000
011500                                                   COMP SYNC.     01150000
011600     88  AC-CONTROL-CARD-ERROR                     VALUE +4003.   01160000
011700     88  AC-DB2-ERROR                              VALUE +4013.   01170000
011700                                                                  01171000
004900 01  ABEND-CODE                  PIC S9(04)        VALUE +0 COMP. 01172000
011800**********************************************************        01180000
011900*  WS FIELDS FOR SVPD007 ROUTINE                                  01190000
012000**********************************************************        01200000
012100     COPY SVWS007.                                                01210000
012200     COPY SVWS004.                                                01220000
012300**********************************************************        01230000
012400*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            01240000
012500**********************************************************        01250000
012600     COPY DPWS004.                                                01260000
P10237******************************************************************01261000
P10237* LAYOUT FOR THE PARAMETERS NEEDED TO INVOKE PROTEGRITY MODULE   *01262000
P10237******************************************************************01263000
P10237     COPY PTYCCSIP.                                               01265000
P10237******************************************************************01266000
P10237* LAYOUT FOR THE WORKING VARIABLES TO INVOKE PROTEGRITY MODULE   *01267000
P10237******************************************************************01268000
P10237     COPY DPWS031.                                                01269000
012700******************************************************************01270000
012800*  TRANSACTION PREPARATION MODULE COMMUNICATIONS AREA            *01280000
012900******************************************************************01290000
013000     COPY DPLS001.                                                01300000
013100     05  WORK-STORAGE-PASSED.                                     01310000
013200******************************************************************01320000
013300*PA - PROGRAM ACCUMULATORS                                        01330000
013400******************************************************************01340000
013500        10  PROGRAM-ACCUMULATORS.                                 01350000
013600             15  PA-ACTIVITY-INSERTED      PIC S9(11)             01360000
013700                                           VALUE ZERO COMP-3.     01370000
013800             15  PA-ACTIVITY-TIMES-COMMITTED PIC S9(11)           01380000
013900                                           VALUE ZERO COMP-3.     01390000
014000             15  PA-TOTAL-ACTIVITY-INSERTED PIC S9(11)            01400000
014100                                           VALUE ZERO COMP-3.     01410000
014200             15  PA-GIFT-CARD-VOIDS-READ    PIC S9(11)            01420000
014300                                           VALUE ZERO COMP-3.     01430000
014400             15  PA-TENDER-VOIDS-READ       PIC S9(11)            01440000
014500                                           VALUE ZERO COMP-3.     01450000
014600                                                                  01460000
014700******************************************************************01470000
014800*  KOHL'S STORED VALUE TABLE                                     *01480000
014900******************************************************************01490000
015000                                                                  01500000
015100     EXEC SQL                                                     01510000
015200         INCLUDE SVT00001                                         01520000
015300     END-EXEC.                                                    01530000
015400                                                                  01540000
015500******************************************************************01550000
015600*  KOHL'S STORED VALUE TRANSACTION TABLE                         *01560000
015700******************************************************************01570000
015800                                                                  01580000
015900     EXEC SQL                                                     01590000
016000         INCLUDE SVT00002                                         01600000
016100     END-EXEC.                                                    01610000
016200                                                                  01620000
016300******************************************************************01630000
016400*  KOHL'S DOMAIN LOCATION TABLE                                  *01640000
016500******************************************************************01650000
016600                                                                  01660000
016700     EXEC SQL                                                     01670000
016800         INCLUDE XST00001                                         01680000
016900     END-EXEC.                                                    01690000
017000                                                                  01700000
017100******************************************************************01710000
017200*  DB2 TABLE DB2PDBA.TEPVDA - VOID AFTER TABLE                    01720000
017300******************************************************************01730000
017400                                                                  01740000
017500     EXEC SQL                                                     01750000
017600         INCLUDE TEPVDA                                           01760000
017700     END-EXEC.                                                    01770000
017800                                                                  01780000
017900******************************************************************01790000
018000*  DB2 TABLE DB2PDBA.TEPITM - COSA-ITEM TABLE                     01800000
018100******************************************************************01810000
018200                                                                  01820000
018300     EXEC SQL                                                     01830000
018400         INCLUDE TEPITM                                           01840000
018500     END-EXEC.                                                    01850000
018600                                                                  01860000
018700******************************************************************01870000
018800*  DB2 TABLE DB2PDBA.TEPTND - COSA-TENDER TABLE                   01880000
018900******************************************************************01890000
019000                                                                  01900000
019100     EXEC SQL                                                     01910000
019200         INCLUDE TEPTND                                           01920000
019300     END-EXEC.                                                    01930000
019400                                                                  01940000
019500***************************************************************** 01950000
019600*  DB2 TABLE DB2PDBA.TEPPART - COSA-PARTITIONING TABLE            01960000
019700***************************************************************** 01970000
019800     EXEC SQL                                                     01980000
019900          INCLUDE TEPPART                                         01990000
020000     END-EXEC.                                                    02000000
020100                                                                  02010000
020200***************************************************************** 02020000
020300*  DB2 TABLE DB2PDBA.TEPSVC - COSA STORED VALUE TABLE             02030000
020400***************************************************************** 02040000
020500     EXEC SQL                                                     02050000
020600          INCLUDE TEPSVC                                          02060000
020700     END-EXEC.                                                    02070000
020800                                                                  02080000
020900***************************************************************** 02090000
021000*  DB2 TABLE DB2PDBA.TEPGCA - COSA GIFT CARD AUTH TABLE           02100000
021100***************************************************************** 02110000
021200     EXEC SQL                                                     02120000
021300          INCLUDE TEPGCA                                          02130000
021400     END-EXEC.                                                    02140000
021500                                                                  02150000
021600******************************************************************02160000
021700*  TEPITM CURSOR                                                  02170000
021800******************************************************************02180000
021900     EXEC SQL                                                     02190000
022000        DECLARE ITEM-CSR CURSOR WITH HOLD FOR                     02200000
022100          SELECT A.NET_CHRGD_AMT                                  02210000
022200               , A.MDSE_ID                                        02220000
022300               , A.STR_NBR                                        02230000
022400               , A.RGST_ID                                        02240000
022500               , B.VOID_TRN_NBR                                   02250000
022600               , E.ST_CDE                                         02260000
022700           FROM  TEPPART C                                        02270000
022800                ,TEPITM A                                         02280000
022900                ,TEPVDA B                                         02290000
023000                ,TEPGCA D                                         02300000
023100                ,XST_LOC E                                        02310000
023200          WHERE A.PARTN_NBR = C.PARTN_NBR                         02320000
023300            AND A.PARTN_NBR = B.PARTN_NBR                         02330000
023400            AND A.STR_NBR   = B.STR_NBR                           02340000
023500            AND A.RGST_ID   = B.RGST_ID                           02350000
023600            AND A.TRN_NBR   = B.VOID_TRN_NBR                      02360000
023700            AND A.PARTN_NBR = D.PARTN_NBR                         02370000
023800            AND A.STR_NBR   = D.STR_NBR                           02380000
023900            AND A.RGST_ID   = D.RGST_ID                           02390000
024000            AND A.TRN_NBR   = D.TRN_NBR                           02400000
024100            AND A.STRT_TM   = D.STRT_TM                           02410000
024200            AND A.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR           02420000
024300            AND A.LNE_ITM_SEQ_NBR = D.LNE_ITM_SEQ_NBR             02430000
024400            AND A.STR_NBR   = E.LOC_NBR                           02440000
024500            AND C.SLS_DTE   = :PV-POS-DATE-CCYY-MM-DD             02450000
024600            AND DEPT_NBR  = '983'                                 02460000
024700            AND LIV_RSLU_CDE = '+'                                02470000
024800            AND D.AUTH_APVL_CDE = '00'                            02480000
024900          WITH UR                                                 02490000
025000     END-EXEC.                                                    02500000
025100                                                                  02510000
025200******************************************************************02520000
025300*  TEPTND CURSOR                                                  02530000
025400******************************************************************02540000
025500                                                                  02550000
025600     EXEC SQL                                                     02560000
025700       DECLARE TND-CSR CURSOR WITH HOLD FOR                       02570000
025800          SELECT A.TNDR_TYP_CDE                                   02580000
025900               , A.TNDR_ID                                        02590000
026000               , A.TNDR_AMT                                       02600000
026100               , A.TNDR_ID_LEN_NBR                                02610000
026200               , A.STR_NBR                                        02620000
026300               , A.RGST_ID                                        02630000
026400               , B.VOID_TRN_NBR                                   02640000
026500               , E.ST_CDE                                         02650000
026600               , D.REQ_TYP_CDE                                    02660000
026700          FROM TEPPART C                                          02670000
026800              ,TEPTND A                                           02680000
026900              ,TEPVDA B                                           02690000
027000              ,TEPSVC D                                           02700000
027100              ,XST_LOC E                                          02710000
027200          WHERE A.PARTN_NBR = C.PARTN_NBR                         02720000
027300            AND A.PARTN_NBR = B.PARTN_NBR                         02730000
027400            AND A.STR_NBR   = B.STR_NBR                           02740000
027500            AND A.RGST_ID   = B.RGST_ID                           02750000
027600            AND A.TRN_NBR   = B.VOID_TRN_NBR                      02760000
027700            AND A.PARTN_NBR = D.PARTN_NBR                         02770000
027800            AND A.STR_NBR   = D.STR_NBR                           02780000
027900            AND A.RGST_ID   = D.RGST_ID                           02790000
028000            AND A.TRN_NBR   = D.TRN_NBR                           02800000
028100            AND A.STRT_TM   = D.STRT_TM                           02810000
028200            AND A.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR           02820000
028300            AND A.TNDR_SEQ_NBR = D.TNDR_SEQ_NBR                   02830000
028400            AND A.STR_NBR   = E.LOC_NBR                           02840000
028500            AND C.SLS_DTE   = :PV-POS-DATE-CCYY-MM-DD             02850000
028600            AND D.AUTH_APVL_CDE IN ('00','01')                    02860000
028700            AND TNDR_TYP_CDE IN ('02','13')                       02870000
050222            AND TNDR_ID_SRC_CDE <> '14'                           02871000
028800            AND TNDR_VOID_IND = 'N'                               02880000
028900            AND TNDR_ID_LEN_NBR > 9                               02890000
029000         WITH UR                                                  02900000
029100     END-EXEC.                                                    02910000
029200                                                                  02920000
029300*  STANDARD LAYPUT FOR THE SQL COMMUNICATION AREA.                02930000
029400                                                                  02940000
029500     EXEC SQL                                                     02950000
029600         INCLUDE SQLCA                                            02960000
029700     END-EXEC.                                                    02970000
029800                                                                  02980000
029900******************************************************************02990000
030000 PROCEDURE DIVISION.                                              03000000
030100******************************************************************03010000
030200                                                                  03020000
030300 0000-MAINLINE.                                                   03030000
030400                                                                  03040000
030500     PERFORM 1000-INITIALIZE.                                     03050000
030600                                                                  03060000
030700     PERFORM 2000-PROCESS-GIFTCARD-ISSUES.                        03070000
030800                                                                  03080000
030900     PERFORM 2300-PROCESS-SV-TENDERS.                             03090000
031000                                                                  03100000
031100     DISPLAY 'GIFT CARD VOIDS READ ' PA-GIFT-CARD-VOIDS-READ.     03110000
031200     DISPLAY 'TENDER VOIDS READ ' PA-TENDER-VOIDS-READ.           03120000
031300     DISPLAY 'TOTAL COMMITS TAKEN ' PA-ACTIVITY-TIMES-COMMITTED.  03130000
031400     IF PA-TOTAL-ACTIVITY-INSERTED = ZERO                         03140000
031500         MOVE PA-ACTIVITY-INSERTED TO PA-TOTAL-ACTIVITY-INSERTED. 03150000
031600     DISPLAY 'TOTAL ACTIVITY INSERTS ' PA-TOTAL-ACTIVITY-INSERTED.03160000
031700                                                                  03170000
031800     GOBACK.                                                      03180000
031900                                                                  03190000
032000******************************************************************03200000
032100* 1000-INITIALIZE-PROGRAM                                         03210000
032200* GET CONTROL CARD                                                03220000
032300******************************************************************03230000
032400 1000-INITIALIZE.                                                 03240000
032500                                                                  03250000
032600     OPEN INPUT  POS-DATE-CARD-FILE.                              03260000
032700                                                                  03270000
P10237     MOVE PC-PROGRAM-NAME       TO DP031-PROGRAM-NAME.            03271000
032800     READ POS-DATE-CARD-FILE INTO CC-CONTROL-CARD                 03280000
032900        AT END                                                    03290000
033000           SET PS-END-OF-CARD-FILE TO TRUE.                       03300000
033100                                                                  03310000
033200     IF PS-END-OF-CARD-FILE                                       03320000
033300         MOVE '1000-INITIALIZE'  TO PV-PARAGRAPH-NAME             03330000
033400         MOVE 'NO CONTROL CARD TO PROCESS' TO PV-OPERATION-MSG    03340000
033500         SET AC-CONTROL-CARD-ERROR TO TRUE                        03350000
033600         PERFORM 9999-ABEND                                       03360000
033700     END-IF.                                                      03370000
033800                                                                  03380000
033900     MOVE CC-POS-DATE-CCYY-MM-DD TO PV-POS-DATE-CCYY-MM-DD.       03390000
034000                                                                  03400000
034100     CLOSE POS-DATE-CARD-FILE.                                    03410000
034200                                                                  03420000
034300******************************************************************03430000
034400*     - SELECT THE CURRENT TIME FROM DB2                          03440000
034500*     - SYSIBM.SYSDUMMY1 IS AN EBCDIC TABLE PROVIDED BY DB2 TO    03450000
034600*       BE USED WHEN SELECTING DB2 DATA THAT IS NOT IN A TABLE    03460000
034700*       SUCH AS SPECIAL REGISTER VALUES                           03470000
034800******************************************************************03480000
034900 1100-GET-CURRENT-TIMESTAMP.                                      03490000
035000     EXEC SQL                                                     03500000
035100         SELECT CURRENT TIMESTAMP                                 03510000
035200           INTO :PV-TIMESTAMP                                     03520000
035300           FROM SYSIBM.SYSDUMMY1                                  03530000
035400        WITH UR                                                   03540000
035500     END-EXEC.                                                    03550000
035600                                                                  03560000
035700     EVALUATE TRUE                                                03570000
035800         WHEN SQLCODE = +0                                        03580000
035900             CONTINUE                                             03590000
036000         WHEN OTHER                                               03600000
036100             MOVE 'ERROR SELECTING CURR TIMESTAMP'                03610000
036200                          TO PV-DB2-OPERATION                     03620000
036300             MOVE '1000-INITIALIZATION'                           03630000
036400                                            TO PV-PARAGRAPH-NAME  03640000
036500             PERFORM 9100-SQL-ABEND                               03650000
036600     END-EVALUATE.                                                03660000
036700                                                                  03670000
036800******************************************************************03680000
036900* 2000-PROCESS-GIFTCARD-ISSUES                                    03690000
037000******************************************************************03700000
037100 2000-PROCESS-GIFTCARD-ISSUES.                                    03710000
037200                                                                  03720000
037300     PERFORM 3100-OPEN-ITEM-CURSOR.                               03730000
037400                                                                  03740000
037500     PERFORM 3150-FETCH-ITEM-CURSOR.                              03750000
037600                                                                  03760000
037700     PERFORM 2100-PROCESS-ITEMS                                   03770000
037800         UNTIL PS-END-OF-ITEM-CSR.                                03780000
037900                                                                  03790000
038000     PERFORM 3175-CLOSE-ITEM-CURSOR.                              03800000
038100                                                                  03810000
038200     IF PA-ACTIVITY-INSERTED > 1000                               03820000
038300         PERFORM 9000-COMMIT                                      03830000
038400         ADD +1 TO PA-ACTIVITY-TIMES-COMMITTED                    03840000
038500         ADD PA-ACTIVITY-INSERTED TO PA-TOTAL-ACTIVITY-INSERTED   03850000
038600         MOVE ZERO TO PA-ACTIVITY-INSERTED                        03860000
038700     END-IF.                                                      03870000
038800                                                                  03880000
038900******************************************************************03890000
039000* 2100-PROCESS-ITEMS                                              03900000
039100******************************************************************03910000
039200 2100-PROCESS-ITEMS.                                              03920000
039300                                                                  03930000
039400     ADD +1 TO PA-GIFT-CARD-VOIDS-READ.                           03940000
039500                                                                  03950000
039600     IF EPITM-NET-CHRGD-AMT = 0                                   03960000
039700         CONTINUE                                                 03970000
039800     ELSE                                                         03980000
039900         PERFORM 2200-ITEM-DATA                                   03990000
040000     END-IF.                                                      04000000
040100                                                                  04010000
040200     PERFORM 3150-FETCH-ITEM-CURSOR.                              04020000
040300                                                                  04030000
040400*************************************************************     04040000
040500* VOIDING THE BUYING OF A GIFT CARD                               04050000
040600*************************************************************     04060000
040700 2200-ITEM-DATA.                                                  04070000
040800                                                                  04080000
040900     MOVE  2             TO SVT00002-ACTVY-TYP-CDE.               04090000
041000     MOVE EPITM-MDSE-ID  TO SV007-CARD-NUMBER-IN.                 04100000
041100     MOVE ZERO           TO SV007-CARD-NUMBER-LENGTH.             04110000
041200                                                                  04120000
041300     PERFORM SV007-FORMAT-CARD.                                   04130000
041400                                                                  04140000
041500     MOVE SV007-CARD-NBR TO SVT00002-CRD-NBR                      04150000
041600                            PV-CARD-NBR.                          04160000
041700     COMPUTE EPITM-NET-CHRGD-AMT =                                04170000
041800             EPITM-NET-CHRGD-AMT * -1.                            04180000
041900     MOVE EPITM-NET-CHRGD-AMT     TO SVT00002-APP-AUTH-AMT        04190000
042000                                     SVT00002-ORIG-AUTH-AMT.      04200000
042100     MOVE SPACES                  TO SVT00002-DRV-LIC-NBR.        04210000
042200     MOVE PV-POS-DATE-CCYY-MM-DD  TO SVT00002-POS-DTE.            04220000
042300     MOVE EPITM-STR-NBR           TO SVT00002-STR-NBR.            04230000
042400     MOVE EPITM-RGST-ID           TO SVT00002-POS-TRMNL-NBR.      04240000
042500     MOVE EPVDA-VOID-TRN-NBR      TO SVT00002-POS-TRN-NBR.        04250000
042600     MOVE 1                       TO SVT00002-TRN-RVRSL-CDE       04260000
042700     MOVE 'Y'                     TO SVT00002-TRN-VOID-IND.       04270000
042800     MOVE PC-DEFAULT-TIMESTAMP    TO SVT00002-TRN-PSTD-TMST.      04280000
042900     MOVE ZEROES                  TO SVT00002-POS-OPRT-ID.        04290000
043000     MOVE 'SVKUP003'              TO SVT00002-APVL-USR-ID.        04300000
043100     MOVE 1                       TO SVT00002-ACTVY-STAT-CDE.     04310000
043200                                                                  04320000
043300*************************************************************     04330000
043400*  CHECK IF THIS CARD IS ON THE SVT_KOHLS_CRD_ACCT TABLE.         04340000
043500*  IF IT IS, UPDATE THE ACTIVITY TABLE.                           04350000
043600*************************************************************     04360000
043700     PERFORM 7000-VALIDATE-CARD.                                  04370000
043800*************************************************************     04380000
043900*  CHECK IF THIS CARD'S TRANSACTION HAS ALREADY BEEN APPLIED      04390000
044000*  TO THE DATABASE.  IF IT HAS, GO ON TO THE NEXT CARD.           04400000
044100*************************************************************     04410000
044200                                                                  04420000
044300     IF PS-CONTINUE                                               04430000
044400         PERFORM 6000-CHK-FOR-DUPLICATE                           04440000
044500*************************************************************     04450000
044600* IF THE TRANSACTION IS A VOID, AN UPDATE IS MADE TO THE KMRC OR  04460000
044700* GIFT CARD, THEN AN INSERT IS DONE TO CREATE ANOTHER ROW         04470000
044800* WITH THE VOID.                                                  04480000
044900*************************************************************     04490000
045000         IF PS-DUPLICATE                                          04500000
045100             CONTINUE                                             04510000
045200         ELSE                                                     04520000
045300             PERFORM 4005-UPDATE-KMC-ACTIVITY-TABLE               04530000
045400             IF PS-UPDATE-SUCCESSFUL                              04540000
045500                 PERFORM 4000-INSERT-KMC-ACTIVITY-TABLE           04550000
045600             ELSE                                                 04560000
045700                 MOVE 1 TO SVT00002-TRN-RVRSL-CDE                 04570000
045800                 MOVE 'Y' TO SVT00002-TRN-VOID-IND                04580000
045900                 PERFORM 4000-INSERT-KMC-ACTIVITY-TABLE           04590000
046000                 COMPUTE SVT00002-APP-AUTH-AMT =                  04600000
046100                         SVT00002-APP-AUTH-AMT * -1               04610000
046200                 COMPUTE SVT00002-ORIG-AUTH-AMT =                 04620000
046300                         SVT00002-ORIG-AUTH-AMT * -1              04630000
046400                 MOVE 0 TO SVT00002-TRN-RVRSL-CDE                 04640000
046500                 MOVE 'Y' TO SVT00002-TRN-VOID-IND                04650000
046600                 PERFORM 4000-INSERT-KMC-ACTIVITY-TABLE           04660000
046700             END-IF                                               04670000
046800         END-IF                                                   04680000
046900     END-IF.                                                      04690000
047000                                                                  04700000
047100******************************************************************04710000
047200* 2300-PROCESS-SV-TENDERS.                                        04720000
047300******************************************************************04730000
047400 2300-PROCESS-SV-TENDERS.                                         04740000
047500                                                                  04750000
047600     PERFORM 3200-OPEN-TND-CURSOR.                                04760000
047700                                                                  04770000
047800     PERFORM 3250-FETCH-TND-CURSOR.                               04780000
047900                                                                  04790000
048000     PERFORM 2400-PROCESS-TENDERS                                 04800000
048100         UNTIL PS-END-OF-TND-CSR.                                 04810000
048200                                                                  04820000
048300     PERFORM 3275-CLOSE-TND-CURSOR.                               04830000
048400                                                                  04840000
048500     IF PA-ACTIVITY-INSERTED > 1000                               04850000
048600         PERFORM 9000-COMMIT                                      04860000
048700         ADD +1 TO PA-ACTIVITY-TIMES-COMMITTED                    04870000
048800         ADD PA-ACTIVITY-INSERTED TO PA-TOTAL-ACTIVITY-INSERTED   04880000
048900         MOVE ZERO TO PA-ACTIVITY-INSERTED                        04890000
049000     END-IF.                                                      04900000
049100                                                                  04910000
049200******************************************************************04920000
049300* 2400-PROCESS-TENDERS                                            04930000
049400******************************************************************04940000
049500 2400-PROCESS-TENDERS.                                            04950000
049600                                                                  04960000
049700     ADD +1 TO PA-TENDER-VOIDS-READ.                              04970000
049800                                                                  04980000
049900     IF EPTND-TNDR-AMT = 0                                        04990000
050000         CONTINUE                                                 05000000
050100     ELSE                                                         05010000
050200         PERFORM 2500-UPDATE-ACTIVITY-TABLE                       05020000
050300     END-IF.                                                      05030000
050400                                                                  05040000
050500     PERFORM 3250-FETCH-TND-CURSOR.                               05050000
050600                                                                  05060000
050700*************************************************************     05070000
050800* PAID BY A GIFT CARD OR KMRC CARD                                05080000
050900*  OR ISSUED A KMRC CARD                                          05090000
051000*************************************************************     05100000
051100 2500-UPDATE-ACTIVITY-TABLE.                                      05110000
051200                                                                  05120000
P10237     IF EPTND-TNDR-ID NOT EQUAL SPACES                            05120100
P10237        PERFORM 2510-DETOKENIZE-TID                               05121000
P10237     END-IF.                                                      05123000
051300     IF EPTND-TNDR-TYP-CDE = '02'                                 05130000
051400         MOVE EPTND-TNDR-ID(1:EPTND-TNDR-ID-LEN-NBR)              05140000
051500                                TO SV007-CARD-NUMBER-IN           05150000
051600         MOVE EPTND-TNDR-ID-LEN-NBR                               05160000
051700                                TO SV007-CARD-NUMBER-LENGTH       05170000
051800         MOVE PC-DRIVER-LICENSE TO SVT00002-DRV-LIC-NBR           05180000
051900         IF EPSVC-REQ-TYP-CDE = 'I'                               05190000
052000             MOVE 1 TO SVT00002-ACTVY-TYP-CDE                     05200000
052100         ELSE                                                     05210000
052200             IF EPSVC-REQ-TYP-CDE = 'T'                           05220000
052300                 MOVE 3 TO SVT00002-ACTVY-TYP-CDE                 05230000
052400             END-IF                                               05240000
052500         END-IF                                                   05250000
052600     ELSE                                                         05260000
052700         IF EPTND-TNDR-TYP-CDE = '13'                             05270000
052800             MOVE EPTND-TNDR-ID(1:EPTND-TNDR-ID-LEN-NBR)          05281000
052900                                TO SV007-CARD-NUMBER-IN           05282000
053000             MOVE EPTND-TNDR-ID-LEN-NBR                           05300000
053100                                TO SV007-CARD-NUMBER-LENGTH       05310000
053200             MOVE SPACES        TO SVT00002-DRV-LIC-NBR           05320000
053300             MOVE 3 TO SVT00002-ACTVY-TYP-CDE                     05330000
053400         END-IF                                                   05340000
053500     END-IF.                                                      05350000
053600                                                                  05360000
053700     PERFORM SV007-FORMAT-CARD.                                   05370000
053800                                                                  05380000
053900     MOVE SV007-CARD-NBR TO SVT00002-CRD-NBR                      05390000
054000                            PV-CARD-NBR.                          05400000
054100                                                                  05410000
054200     MOVE EPTND-TNDR-AMT TO SVT00002-APP-AUTH-AMT                 05420000
054300                            SVT00002-ORIG-AUTH-AMT.               05430000
054400                                                                  05440000
054500     IF SVT00002-ACTVY-TYP-CDE = 1                                05450000
054600         IF SVT00002-APP-AUTH-AMT LESS THAN 0                     05460000
054700             MOVE 1               TO SVT00002-TRN-RVRSL-CDE       05470000
054800         ELSE                                                     05480000
054900             MOVE 0               TO SVT00002-TRN-RVRSL-CDE       05490000
055000         END-IF                                                   05500000
055100     ELSE                                                         05510000
055200         IF SVT00002-APP-AUTH-AMT LESS THAN 0                     05520000
055300             MOVE 0               TO SVT00002-TRN-RVRSL-CDE       05530000
055400         ELSE                                                     05540000
055500             MOVE 1               TO SVT00002-TRN-RVRSL-CDE       05550000
055600         END-IF                                                   05560000
055700     END-IF.                                                      05570000
055800                                                                  05580000
055900     MOVE PV-POS-DATE-CCYY-MM-DD  TO SVT00002-POS-DTE.            05590000
056000                                                                  05600000
056100     MOVE EPTND-STR-NBR           TO SVT00002-STR-NBR.            05610000
056200     MOVE EPTND-RGST-ID           TO SVT00002-POS-TRMNL-NBR.      05620000
056300     MOVE EPVDA-VOID-TRN-NBR      TO SVT00002-POS-TRN-NBR.        05630000
056400     MOVE 'Y'                     TO SVT00002-TRN-VOID-IND.       05640000
056500     MOVE PC-DEFAULT-TIMESTAMP    TO SVT00002-TRN-PSTD-TMST.      05650000
056600     MOVE ZEROES                  TO SVT00002-POS-OPRT-ID.        05660000
056700     MOVE 'SVKUP003'              TO SVT00002-APVL-USR-ID.        05670000
056800     MOVE 1                       TO SVT00002-ACTVY-STAT-CDE.     05680000
056900                                                                  05690000
057000*************************************************************     05700000
057100*  CHECK IF THIS CARD IS ON THE SVT_KOHLS_CRD_ACCT TABLE          05710000
057200*  IF IT IS, UPDATE THE ACTIVITY TABLE.                           05720000
057300*************************************************************     05730000
057400     PERFORM 7000-VALIDATE-CARD.                                  05740000
057500*************************************************************     05750000
057600*  CHECK IF THIS CARD'S TRANSACTION HAS ALREADY BEEN APPLIED      05760000
057700*  TO THE DATABASE.  IF IT HAS, GO ON TO THE NEXT CARD.           05770000
057800*************************************************************     05780000
057900                                                                  05790000
058000     IF PS-CONTINUE                                               05800000
058100         PERFORM 6000-CHK-FOR-DUPLICATE                           05810000
058200*************************************************************     05820000
058300* IF THE TRANSACTION IS A VOID, AN UPDATE IS MADE TO THE KMRC OR  05830000
058400* GIFT CARD, THEN AN INSERT IS DONE TO CREATE ANOTHER ROW         05840000
058500* WITH THE VOID.                                                  05850000
058600* IF THE TRANSACTION IS NOT A VOID, BUT AN ISSUE OF A KMRC OR A   05860000
058700* TENDER OF KMRC OR GIFT, AN ACTIVITY ROW IS INSERTED.            05870000
058800*************************************************************     05880000
058900         IF PS-DUPLICATE                                          05890000
059000             CONTINUE                                             05900000
059100         ELSE                                                     05910000
059200             PERFORM 4005-UPDATE-KMC-ACTIVITY-TABLE               05920000
059300             IF PS-UPDATE-SUCCESSFUL                              05930000
059400                 PERFORM 4000-INSERT-KMC-ACTIVITY-TABLE           05940000
059500             ELSE                                                 05950000
059600                 MOVE 1 TO SVT00002-TRN-RVRSL-CDE                 05960000
059700                 MOVE 'Y' TO SVT00002-TRN-VOID-IND                05970000
059800                 PERFORM 4000-INSERT-KMC-ACTIVITY-TABLE           05980000
059900                 COMPUTE SVT00002-APP-AUTH-AMT =                  05990000
060000                         SVT00002-APP-AUTH-AMT * -1               06000000
060100                 COMPUTE SVT00002-ORIG-AUTH-AMT =                 06010000
060200                         SVT00002-ORIG-AUTH-AMT * -1              06020000
060300                 MOVE 0 TO SVT00002-TRN-RVRSL-CDE                 06030000
060400                 MOVE 'Y' TO SVT00002-TRN-VOID-IND                06040000
060500                 PERFORM 4000-INSERT-KMC-ACTIVITY-TABLE           06050000
060600             END-IF                                               06060000
060700         END-IF                                                   06070000
060800     END-IF.                                                      06080000
060900                                                                  06090000
P10237*************************************************************     06100000
P10237* DETOKENIZE THE TENDER ID FIELD                                  06110000
P10237*************************************************************     06120000
P10237 2510-DETOKENIZE-TID.                                             06130000
P10237                                                                  06140000
P10237     INITIALIZE CSI-PARAMETERS                                    06140100
P10237                DP031-PROTEG-PGM-PARAMETERS.                      06140200
P10237     MOVE 'TENDER-ID'           TO DP031-FIELD.                   06140300
P10237     SET CSI-DECRYPT-FUNCTION   TO TRUE.                          06140400
P10237     SET DP031-ACCTNBR          TO TRUE.                          06140500
P10237     MOVE EPTND-TNDR-ID         TO DP031-CIPHER-TEXT.             06140600
P10237     MOVE EPTND-TNDR-ID-LEN-NBR TO DP031-INPUT-LEN.               06140700
P10237     PERFORM DP031-0000-PROTG-TOKEN-DETOKEN.                      06140800
P10237     IF CSI-RETURN-CODE NOT = ZERO                                06140900
P10237        DISPLAY 'ABEND IN THE FOLLOWING RECORD'                   06141000
P10237        DISPLAY 'STORE NUMBER         - ' EPTND-STR-NBR           06141200
P10237        DISPLAY 'REGISTER ID          - ' EPTND-RGST-ID           06141300
P10237        DISPLAY 'TOKENIZED TENDER ID  - ' EPTND-TNDR-ID           06141500
P10237        DISPLAY 'TENDER-ID LENGTH NBR - ' EPTND-TNDR-ID-LEN-NBR   06141600
P10237        PERFORM DP031-9999-ABEND                                  06141700
P10237     ELSE                                                         06141800
P10237        MOVE DP031-CLEAR-TEXT     TO EPTND-TNDR-ID                06141900
P10237     END-IF.                                                      06142000
P10237                                                                  06142100
061000*************************************************************     06142200
061100* CHECK TRANSACTION ON TEPITM TABLE                               06142300
061200*************************************************************     06143000
061300 3100-OPEN-ITEM-CURSOR.                                           06144000
061400     EXEC SQL                                                     06145000
061500         OPEN ITEM-CSR                                            06150000
061600     END-EXEC.                                                    06160000
061700                                                                  06170000
061800     EVALUATE TRUE                                                06180000
061900        WHEN SQLCODE = ZERO                                       06190000
062000             CONTINUE                                             06200000
062100        WHEN SQLWARN0 NOT EQUAL SPACE                             06210000
062200        WHEN SQLCODE NOT EQUAL ZERO                               06220000
062300            MOVE '3100-OPEN-ITEM-CURSOR'                          06230000
062400                                           TO PV-PARAGRAPH-NAME   06240000
062500            MOVE 'ERROR ON OPEN OF ITEM-CSR'                      06250000
062600                                           TO PV-DB2-OPERATION    06260000
062700            PERFORM 9100-SQL-ABEND                                06270000
062800     END-EVALUATE.                                                06280000
062900                                                                  06290000
063000******************************************************************06300000
063100* 3150-FETCH-ITEM-CURSOR                                          06310000
063200******************************************************************06320000
063300 3150-FETCH-ITEM-CURSOR.                                          06330000
063400     EXEC SQL                                                     06340000
063500         FETCH ITEM-CSR                                           06350000
063600           INTO :EPITM-NET-CHRGD-AMT                              06360000
063700              , :EPITM-MDSE-ID                                    06370000
063800              , :EPITM-STR-NBR                                    06380000
063900              , :EPITM-RGST-ID                                    06390000
064000              , :EPVDA-VOID-TRN-NBR                               06400000
064100              , :XST00001-ST-CDE                                  06410000
064200     END-EXEC.                                                    06420000
064300                                                                  06430000
064400     EVALUATE TRUE                                                06440000
064500        WHEN SQLCODE = ZERO                                       06450000
064600           CONTINUE                                               06460000
064700        WHEN SQLCODE = +100                                       06470000
064800           SET PS-END-OF-ITEM-CSR TO TRUE                         06480000
064900        WHEN SQLWARN0 NOT EQUAL SPACE                             06490000
065000        WHEN SQLCODE NOT EQUAL ZERO                               06500000
065100           MOVE '3150-FETCH-ITEM-CURSOR' TO PV-PARAGRAPH-NAME     06510000
065200           MOVE 'ERROR ON FETCH OF ITEM-CSR'                      06520000
065300                                           TO PV-DB2-OPERATION    06530000
065400           PERFORM 9100-SQL-ABEND                                 06540000
065500     END-EVALUATE.                                                06550000
065600                                                                  06560000
065700*************************************************************     06570000
065800* CLOSE ITEM CURSOR                                               06580000
065900*************************************************************     06590000
066000 3175-CLOSE-ITEM-CURSOR.                                          06600000
066100                                                                  06610000
066200     EXEC SQL                                                     06620000
066300         CLOSE ITEM-CSR                                           06630000
066400     END-EXEC.                                                    06640000
066500                                                                  06650000
066600     EVALUATE TRUE                                                06660000
066700         WHEN SQLCODE NOT = 0                                     06670000
066800         WHEN SQLWARN0    = 'W'                                   06680000
066900             DISPLAY ' '                                          06690000
067000             DISPLAY '** ABEND     **'                            06700000
067100             DISPLAY '** PROGRAM   **  = ' PC-PROGRAM-NAME        06710000
067200             DISPLAY '** PARAGRAPH **  = 3175-CLOSE-ITEM-CSR'     06720000
067300             DISPLAY '** CLOSE CURSOR TO TEPITM TABLE'            06730000
067400             PERFORM 9100-SQL-ABEND                               06740000
067500     END-EVALUATE.                                                06750000
067600                                                                  06760000
067700*************************************************************     06770000
067800* OPEN TENDER CURSOR                                              06780000
067900*************************************************************     06790000
068000 3200-OPEN-TND-CURSOR.                                            06800000
068100     EXEC SQL                                                     06810000
068200         OPEN TND-CSR                                             06820000
068300     END-EXEC.                                                    06830000
068400                                                                  06840000
068500     EVALUATE TRUE                                                06850000
068600        WHEN SQLCODE = ZERO                                       06860000
068700             CONTINUE                                             06870000
068800        WHEN SQLWARN0 NOT EQUAL SPACE                             06880000
068900        WHEN SQLCODE NOT EQUAL ZERO                               06890000
069000            MOVE '3200-OPEN-TND-CURSOR' TO PV-PARAGRAPH-NAME      06900000
069100            MOVE 'ERROR ON OPEN OF TND-CSR'                       06910000
069200                                           TO PV-DB2-OPERATION    06920000
069300            PERFORM 9100-SQL-ABEND                                06930000
069400     END-EVALUATE.                                                06940000
069500                                                                  06950000
069600******************************************************************06960000
069700* 3250-FETCH-TENDER-CURSOR                                        06970000
069800******************************************************************06980000
069900 3250-FETCH-TND-CURSOR.                                           06990000
070000                                                                  07000000
070100     EXEC SQL                                                     07010000
070200         FETCH TND-CSR                                            07020000
070300           INTO :EPTND-TNDR-TYP-CDE                               07030000
070400              , :EPTND-TNDR-ID                                    07040000
070500              , :EPTND-TNDR-AMT                                   07050000
070600              , :EPTND-TNDR-ID-LEN-NBR                            07060000
070700              , :EPTND-STR-NBR                                    07070000
070800              , :EPTND-RGST-ID                                    07080000
070900              , :EPVDA-VOID-TRN-NBR                               07090000
071000              , :XST00001-ST-CDE                                  07100000
071100              , :EPSVC-REQ-TYP-CDE                                07110000
071200     END-EXEC.                                                    07120000
071300                                                                  07130000
071400     EVALUATE TRUE                                                07140000
071500        WHEN SQLCODE = ZERO                                       07150000
071600           CONTINUE                                               07160000
071700        WHEN SQLCODE = +100                                       07170000
071800           SET PS-END-OF-TND-CSR TO TRUE                          07180000
071900        WHEN SQLWARN0 NOT EQUAL SPACE                             07190000
072000        WHEN SQLCODE NOT EQUAL ZERO                               07200000
072100           MOVE '3250-FETCH-TND-CURSOR' TO PV-PARAGRAPH-NAME      07210000
072200           MOVE 'ERROR ON FETCH OF VOID-CSR'                      07220000
072300                                           TO PV-DB2-OPERATION    07230000
072400           PERFORM 9100-SQL-ABEND                                 07240000
072500     END-EVALUATE.                                                07250000
072600                                                                  07260000
072700*************************************************************     07270000
072800* CLOSE TENDER CURSOR                                             07280000
072900*************************************************************     07290000
073000 3275-CLOSE-TND-CURSOR.                                           07300000
073100                                                                  07310000
073200     EXEC SQL                                                     07320000
073300         CLOSE TND-CSR                                            07330000
073400     END-EXEC.                                                    07340000
073500                                                                  07350000
073600     EVALUATE TRUE                                                07360000
073700         WHEN SQLCODE NOT = 0                                     07370000
073800         WHEN SQLWARN0    = 'W'                                   07380000
073900             DISPLAY ' '                                          07390000
074000             DISPLAY '** ABEND     **'                            07400000
074100             DISPLAY '** PROGRAM   **  = ' PC-PROGRAM-NAME        07410000
074200             DISPLAY '** PARAGRAPH **  = 3275-CLOSE-TND-CSR'      07420000
074300             DISPLAY '** CLOSE CURSOR TO TENDER TABLE'            07430000
074400             PERFORM 9100-SQL-ABEND                               07440000
074500     END-EVALUATE.                                                07450000
074600                                                                  07460000
074700******************************************************************07470000
074800*  INSERT SVT_KOHLS_CRD_TXN TABLE                                *07480000
074900******************************************************************07490000
075000 4000-INSERT-KMC-ACTIVITY-TABLE.                                  07500000
075100                                                                  07510000
075200******************************************************************07520000
075300*  NEEDED TO HARD CODE 01 IN THE HOUR SO THAT THIS TRANSACTION   *07530000
075400*  WILL GET ON THE CORRECT AUDIT REPORT.  THE AUDIT REPORT TAKES *07540000
075500*  ANY TRANSACTION THAT HAPPENED FROM AROUND 3AM TO 3AM AND      *07550000
075600*  SOMETIMES THIS PROGRAM WAS RUNNING AFTER 3AM.                 *07560000
075700******************************************************************07570000
075800     PERFORM 1100-GET-CURRENT-TIMESTAMP.                          07580000
075900     MOVE PV-TIMESTAMP            TO PV-TIMESTAMP-SEPARATE.       07590000
076000     MOVE '01'                    TO PV-HR.                       07600000
076100     MOVE PV-TIMESTAMP-SEPARATE   TO SVT00002-TRN-AUTH-TMST.      07610000
076200                                                                  07620000
076300     EXEC SQL INSERT                                              07630000
076400              INTO SVT_KOHLS_CRD_TXN                              07640000
076500                  (CRD_NBR                                        07650000
076600                  ,TRN_AUTH_TMST                                  07660000
076700                  ,DRV_LIC_NBR                                    07670000
076800                  ,TRN_RVRSL_CDE                                  07680000
076900                  ,TRN_VOID_IND                                   07690000
077000                  ,ACTVY_TYP_CDE                                  07700000
077100                  ,POS_DTE                                        07710000
077200                  ,STR_NBR                                        07720000
077300                  ,POS_TRMNL_NBR                                  07730000
077400                  ,POS_TRN_NBR                                    07740000
077500                  ,TRN_PSTD_TMST                                  07750000
077600                  ,APP_AUTH_AMT                                   07760000
077700                  ,POS_OPRT_ID                                    07770000
077800                  ,APVL_USR_ID                                    07780000
077900                  ,ACTVY_STAT_CDE                                 07790000
078000                  ,ORIG_AUTH_AMT                                  07800000
078100                  ,ST_CDE)                                        07810000
078200           VALUES                                                 07820000
078300              (:SVT00002-CRD-NBR                                  07830000
078400              ,:SVT00002-TRN-AUTH-TMST                            07840000
078500              ,:SVT00002-DRV-LIC-NBR                              07850000
078600              ,:SVT00002-TRN-RVRSL-CDE                            07860000
078700              ,:SVT00002-TRN-VOID-IND                             07870000
078800              ,:SVT00002-ACTVY-TYP-CDE                            07880000
078900              ,:SVT00002-POS-DTE                                  07890000
079000              ,:SVT00002-STR-NBR                                  07900000
079100              ,:SVT00002-POS-TRMNL-NBR                            07910000
079200              ,:SVT00002-POS-TRN-NBR                              07920000
079300              ,:SVT00002-TRN-PSTD-TMST                            07930000
079400              ,:SVT00002-APP-AUTH-AMT                             07940000
079500              ,:SVT00002-POS-OPRT-ID                              07950000
079600              ,:SVT00002-APVL-USR-ID                              07960000
079700              ,:SVT00002-ACTVY-STAT-CDE                           07970000
079800              ,:SVT00002-ORIG-AUTH-AMT                            07980000
079900              ,:XST00001-ST-CDE)                                  07990000
080000     END-EXEC.                                                    08000000
080100                                                                  08010000
080200     EVALUATE TRUE                                                08020000
080300         WHEN SQLCODE = ZERO                                      08030000
080400             ADD +1 TO PA-ACTIVITY-INSERTED                       08040000
080500         WHEN SQLWARN0 NOT EQUAL SPACE                            08050000
080600         WHEN SQLCODE NOT EQUAL ZERO                              08060000
080700             MOVE '4000-INSERT-KMC-ACTIVITY-TABLE'                08070000
080800                                            TO PV-PARAGRAPH-NAME  08080000
080900             MOVE 'ERROR ON INSERT OF SVT_KOHLS_CRD_TXN'          08090000
081000                                            TO PV-DB2-OPERATION   08100000
081100             PERFORM 9100-SQL-ABEND                               08110000
081200     END-EVALUATE.                                                08120000
081300                                                                  08130000
081400******************************************************************08140000
081500*  UPDATE THE ACTIVITY TABLE - SVT_KOHLS_CRD_TXN                 *08150000
081600******************************************************************08160000
081700 4005-UPDATE-KMC-ACTIVITY-TABLE.                                  08170000
081800                                                                  08180000
081900     EXEC SQL                                                     08190000
082000     UPDATE SVT_KOHLS_CRD_TXN                                     08200000
082100         SET TRN_VOID_IND  = 'Y'                                  08210000
082200     WHERE CRD_NBR         = :SVT00002-CRD-NBR                    08220000
082300         AND TRN_RVRSL_CDE = :PC-TRN-RVRSL-CD                     08230000
082400         AND TRN_VOID_IND  = 'N'                                  08240000
082500         AND ACTVY_TYP_CDE = :SVT00002-ACTVY-TYP-CDE              08250000
082600         AND POS_DTE       = :SVT00002-POS-DTE                    08260000
082700         AND STR_NBR       = :SVT00002-STR-NBR                    08270000
082800         AND POS_TRMNL_NBR = :SVT00002-POS-TRMNL-NBR              08280000
082900         AND POS_TRN_NBR   = :SVT00002-POS-TRN-NBR                08290000
083000     END-EXEC.                                                    08300000
083100                                                                  08310000
083200     EVALUATE TRUE                                                08320000
083300         WHEN SQLCODE = ZERO                                      08330000
083400             SET PS-UPDATE-SUCCESSFUL TO TRUE                     08340000
083500         WHEN SQLCODE = +100                                      08350000
083600             SET PS-UPDATE-NOT-SUCCESSFUL TO TRUE                 08360000
083700         WHEN SQLWARN0 NOT EQUAL SPACE                            08370000
083800         WHEN SQLCODE NOT EQUAL ZERO                              08380000
083900             MOVE '4005-UPDATE-KMC-ACTIVITY-TABLE'                08390000
084000                                            TO PV-PARAGRAPH-NAME  08400000
084100             MOVE 'ERROR ON UPDATE OF SVT_KOHLS_CRD_TXN'          08410000
084200                                            TO PV-DB2-OPERATION   08420000
084300             PERFORM 9100-SQL-ABEND                               08430000
084400     END-EVALUATE.                                                08440000
084500                                                                  08450000
084600******************************************************************08460000
084700* 6000-CHK-FOR-DUPLICATE.  CHECK IF THE CARD HAS ALREADY BEEN     08470000
084800* UPDATED FOR THIS TRANSACTION.  IN CASE THE AUTHORIZATION TIMED  08480000
084900* OUT AT THE REGISTER, CAUSING AN OFFLINE, BUT THE AUTHORIZATION  08490000
085000* STILL UPDATES THAT DATABASE.                                    08500000
085100******************************************************************08510000
085200 6000-CHK-FOR-DUPLICATE.                                          08520000
085300                                                                  08530000
085400     SET PS-NOT-DUPLICATE TO TRUE.                                08540000
085500                                                                  08550000
085600     EXEC SQL                                                     08560000
085700         SELECT CRD_NBR                                           08570000
085800           INTO :PV-CARD-NBR                                      08580000
085900           FROM SVT_KOHLS_CRD_TXN                                 08590000
086000          WHERE CRD_NBR       = :SVT00002-CRD-NBR                 08600000
086100            AND TRN_RVRSL_CDE = :SVT00002-TRN-RVRSL-CDE           08610000
086200            AND TRN_VOID_IND  = :SVT00002-TRN-VOID-IND            08620000
086300            AND ACTVY_TYP_CDE = :SVT00002-ACTVY-TYP-CDE           08630000
086400            AND POS_DTE       = :SVT00002-POS-DTE                 08640000
086500            AND POS_TRMNL_NBR = :SVT00002-POS-TRMNL-NBR           08650000
086600            AND POS_TRN_NBR   = :SVT00002-POS-TRN-NBR             08660000
086700            AND APP_AUTH_AMT  = :SVT00002-APP-AUTH-AMT            08670000
086800            WITH UR                                               08680000
086900     END-EXEC.                                                    08690000
087000                                                                  08700000
087100     EVALUATE TRUE                                                08710000
087200         WHEN SQLCODE = 0                                         08720000
087300         WHEN SQLCODE = -811                                      08730000
087400             SET PS-DUPLICATE TO TRUE                             08740000
087500             SET PS-DONT-CONTINUE TO TRUE                         08750000
087600         WHEN SQLCODE = +100                                      08760000
087700             CONTINUE                                             08770000
087800         WHEN OTHER                                               08780000
087900             MOVE '6000-CHK-FOR-DUPLICATE' TO PV-PARAGRAPH-NAME   08790000
088000             MOVE 'ERROR ON SELECT OF SVT_KOHLS_CRD_TXN'          08800000
088100                                            TO PV-DB2-OPERATION   08810000
088200             PERFORM 9100-SQL-ABEND                               08820000
088300     END-EVALUATE.                                                08830000
088400                                                                  08840000
088500******************************************************************08850000
088600* 7000-VALIDATE-CARD. CHECK IF THE CARD IS VALID ON               08860000
088700*   SVT_KOHLS_CRD_ACCT.                                           08870000
088800******************************************************************08880000
088900 7000-VALIDATE-CARD.                                              08890000
089000                                                                  08900000
089100     EXEC SQL                                                     08910000
089200         SELECT CRD_NBR                                           08920000
089300           INTO :PV-CARD-NBR                                      08930000
089400           FROM SVT_KOHLS_CRD_ACCT                                08940000
089500          WHERE CRD_NBR       = :SVT00002-CRD-NBR                 08950000
089600            WITH UR                                               08960000
089700     END-EXEC.                                                    08970000
089800                                                                  08980000
089900     EVALUATE TRUE                                                08990000
090000         WHEN SQLCODE = 0                                         09000000
090100             SET PS-CONTINUE TO TRUE                              09010000
090200         WHEN SQLCODE = +100                                      09020000
090300             SET PS-DONT-CONTINUE TO TRUE                         09030000
090400         WHEN OTHER                                               09040000
090500             MOVE '7000-VALIDATE-CARD' TO PV-PARAGRAPH-NAME       09050000
090600             MOVE 'ERROR ON SELECT OF SVT_KOHLS_CRD_ACCT'         09060000
090700                                            TO PV-DB2-OPERATION   09070000
090800             PERFORM 9100-SQL-ABEND                               09080000
090900     END-EVALUATE.                                                09090000
091000                                                                  09100000
091100***************************************************************** 09110000
091200*    COPYBOOK TO CONVERT OLD STORED VALUE CARD NUMBER TO NEW      09120000
091300***************************************************************** 09130000
091400     COPY SVPD007.                                                09140000
091500***************************************************************** 09150000
091600*    COMMIT DB2 UPDATES                                           09160000
091700***************************************************************** 09170000
091800 9000-COMMIT.                                                     09180000
091900     EXEC SQL                                                     09190000
092000        COMMIT                                                    09200000
092100     END-EXEC.                                                    09210000
092200                                                                  09220000
092300     EVALUATE TRUE                                                09230000
092400        WHEN SQLCODE = 0                                          09240000
092500            CONTINUE                                              09250000
092600        WHEN OTHER                                                09260000
092700            MOVE '9000-COMMIT' TO PV-PARAGRAPH-NAME               09270000
092800            MOVE 'COMMIT FAILED' TO PV-DB2-OPERATION              09280000
092900            PERFORM 9100-SQL-ABEND                                09290000
093000     END-EVALUATE.                                                09300000
093100                                                                  09310000
093200******************************************************************09320000
093300* 9100-SQL-ABEND - PERFORMS THE ABEND FOR THE PROGRAM IN THE      09330000
093400* EVENT THAT AN SQL ERROR OR WARNING CODE OCCURS.                 09340000
093500******************************************************************09350000
093600 9100-SQL-ABEND.                                                  09360000
093700     DISPLAY '** ABEND     **'.                                   09370000
093800     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                09380000
093900     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              09390000
094000     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               09400000
094100                                                                  09410000
094200******************************************************************09420000
094300* COPYBOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED      09430000
094400* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS       09440000
094500******************************************************************09450000
094600                                                                  09460000
094700     COPY DPPD004.                                                09470000
094800                                                                  09480000
094900     SET AC-DB2-ERROR TO TRUE.                                    09490000
095000     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         09500000
095100                                                                  09510000
095200******************************************************************09520000
095300* 9999-ABEND - PERFORMS A NON-SQL-ABEND                           09530000
095400******************************************************************09540000
095500 9999-ABEND.                                                      09550000
095600     DISPLAY '** ABEND           **'.                             09560000
095700     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          09570000
095800     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        09580000
095900     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG.         09590000
096000     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         09600000
096100                                                                  09610000
P10237******************************************************************09620000
P10237* COPY MEMBER DPPD031 CONTAINS STATEMENTS NEEDED TO INVOKE        09630000
P10237* PROTEGRITY MODULE FOR PROTECTION / UNPROTECTION                 09631000
P10237******************************************************************09640000
P10237     COPY DPPD031.                                                09650000
P10237                                                                  09660000
