000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400 PROGRAM-ID.    CNKUP001.                                         00040000
000500 AUTHOR.        TOM RUSKA. GREENBRIER & RUSSEL.                   00050000
000600 INSTALLATION.  KOHLS.                                            00060000
000700 DATE-WRITTEN   APRIL 12, 1993.                                   00070000
000800 DATE-COMPILED.                                                   00080000
000900******************************************************************00090000
001000*  THIS PROGRAM READS RECORD TYPES "SCL" FROM THE MERCHANDISE     00100000
001100*  BUSINESS EXTRACT FILE CREATED IN JOB FSK510 TO UPDATE THE      00110000
001200*  DEPARTMENT/CLASS FACILITY LOCATION ASSIGNMENT AND DEPARTMENT/  00120000
001300*  CLASS TICKET FORMAT ASSIGNMENT DATABASES WITH CURRENT          00130000
001400*  INFORMATION.                                                   00140000
001500******************************************************************00150000
001600*                                                                 00160000
001700*  THE INPUT FILE WILL BE SORTED BY DEPARTMENT/CLASS EXTRACTING   00170000
001800*  ONLY THOSE RECORDS WHOSE LEVEL IS EQUAL TO "SCL"               00180000
001900*                                                                 00190000
002000******************************************************************00200000
002100 ENVIRONMENT DIVISION.                                            00210000
002200******************************************************************00220000
002300 CONFIGURATION SECTION.                                           00230000
002400 SOURCE-COMPUTER. IBM-3090.                                       00240000
002500 OBJECT-COMPUTER. IBM-3090.                                       00250000
002600 INPUT-OUTPUT SECTION.                                            00260000
002700 FILE-CONTROL.                                                    00270000
002800                                                                  00280000
002900     SELECT MBS-STRUCTURE-FILE-IN                                 00290000
003000         ASSIGN TO INP01.                                         00300000
003100/                                                                 00310000
003200******************************************************************00320000
003300 DATA DIVISION.                                                   00330000
003400******************************************************************00340000
003500 FILE SECTION.                                                    00350000
003600                                                                  00360000
003700 FD  MBS-STRUCTURE-FILE-IN                                        00370000
003800     RECORDING MODE IS F                                          00380000
003900     BLOCK CONTAINS 0 RECORDS                                     00390000
004000     LABEL RECORDS ARE STANDARD.                                  00400000
004100                                                                  00410000
004200 01  MBS-STRUCTURE-RECORD-IN          PIC X(48).                  00420000
004300                                                                  00430000
004400/                                                                 00440000
004500 WORKING-STORAGE SECTION.                                         00450000
004510                                                                  00451001
004520 01  DK-DB2-KEYS.                                                 00452001
004530     05  DK-DEPT                      PIC X(03)  VALUE SPACES.    00453001
004540     05  DK-CLASS                     PIC X(02)  VALUE SPACES.    00454001
004600                                                                  00460000
004700 01  PC-PROGRAM-CONSTANTS.                                        00470000
004800     05  PC-CURRENT-PROGRAM-NAME      PIC X(08)  VALUE 'CNKUP001'.00480000
004900     05  PC-MAX-RETRIES               PIC S9(04) VALUE  +3        00490000
005000                                                 COMP.            00500000
005100                                                                  00510000
005200 01  PS-PROGRAM-SWITCHES.                                         00520000
005300     05  PS-MBS-FILE-EOF-SW           PIC X(01)  VALUE SPACES.    00530000
005400         88  PS-MBS-FILE-EOF                     VALUE 'Y'.       00540000
005500     05  PS-NEW-OPER-UNT-CSR-SW       PIC X(01)  VALUE SPACES.    00550000
005600         88  PS-NEW-OPER-UNT-CSR-EOF             VALUE 'Y'.       00560000
005700     05  PS-DEL-OPER-UNT-CSR-SW       PIC X(01)  VALUE SPACES.    00570000
005800         88  PS-DEL-OPER-UNT-CSR-EOF             VALUE 'Y'.       00580000
005900     05  PS-CUR-OPER-UNT-CSR-SW       PIC X(01)  VALUE SPACES.    00590000
006000         88  PS-CUR-OPER-UNT-CSR-EOF             VALUE 'Y'.       00600000
006100     05  PS-DEPT-CL-NBR-CSR-SW        PIC X(01)  VALUE SPACES.    00610000
006200         88  PS-DEPT-CL-NBR-CSR-EOF              VALUE 'Y'.       00620000
006210     05  PS-MISSING-DEPT-CL-SW        PIC X(01)  VALUE SPACES.    00621003
006220         88  PS-MISSING-DEPT-CL-EOF              VALUE 'Y'.       00622003
006230         88  PS-MISSING-DEPT-CL-EOF-NO           VALUE 'N'.       00623012
006300                                                                  00630000
006400 01  PV-PROGRAM-VARIABLES.                                        00640000
006500     05  PV-DISPLAY-OPER-ID           PIC  9(04) VALUE 0.         00650007
006510     05  PV-ABEND-CODE                PIC S9(04) VALUE +0         00651007
006600                                                 COMP.            00660000
006700     05  PV-FCLTY-AREA-ID-NULL        PIC S9(04) VALUE +0         00670000
006800                                                 COMP.            00680000
006900     05  PV-TKT-FMT-ID-NULL           PIC S9(04) VALUE +0         00690000
007000                                                 COMP.            00700000
007100     05  PV-ABEND-PARAGRAPH           PIC X(30)  VALUE SPACES.    00710000
007200     05  PV-MBS-RECORDS-READ          PIC S9(07) VALUE +0         00720000
007300                                                 COMP-3.          00730000
007400     05  PV-TDCFAAS-ROWS-INSERTED     PIC S9(07) VALUE +0         00740000
007500                                                 COMP-3.          00750000
007600     05  PV-TDCTFAS-ROWS-INSERTED     PIC S9(07) VALUE +0         00760000
007700                                                 COMP-3.          00770000
007800     05  PV-TDCFAAS-ROWS-DELETED      PIC S9(07) VALUE +0         00780000
007900                                                 COMP-3.          00790000
008000     05  PV-TDCTFAS-ROWS-DELETED      PIC S9(07) VALUE +0         00800000
008100                                                 COMP-3.          00810000
008200     05  PV-RETRY-COUNTER             PIC S9(04) VALUE +0         00820000
008300                                                 COMP SYNC.       00830000
008400     05  PV-DB2-OPERATION-ATTEMPTED   PIC X(30)  VALUE SPACES.    00840000
008500     05  PV-FS001O-KEY.                                           00850000
008600         10  PV-FS001O-DEPT-NBR       PIC X(03)  VALUE SPACES.    00860000
008700         10  PV-FS001O-CL-NBR         PIC X(02)  VALUE SPACES.    00870000
008800     05  PV-TDCFAAS-KEY.                                          00880000
008900         10  PV-TDCFAAS-DEPT-NBR      PIC X(03)  VALUE SPACES.    00890000
009000         10  PV-TDCFAAS-CL-NBR        PIC X(02)  VALUE SPACES.    00900000
009100     05  PV-NEW-OPER-UNT-COUNT        PIC S9(09) VALUE +0         00910000
009200                                                 COMP-3.          00920000
009300     05  PV-NEW-OPER-UNT-TABLE        OCCURS 99 TIMES             00930000
009400                                INDEXED BY PV-NEW-OPER-UNT-IX.    00940000
009500         10  PV-NEW-OPER-UNT-ID       PIC S9(04) COMP.            00950000
009600         10  PV-NEW-FCLTY-ID          PIC S9(04) COMP.            00960000
009610         10  PV-NEW-OPER-SET          PIC S9(04) COMP.            00961002
009700     05  PV-CUR-OPER-UNT-COUNT        PIC S9(09) VALUE +0         00970000
009800                                                 COMP-3.          00980000
009900     05  PV-CUR-OPER-UNT-TABLE        OCCURS 99 TIMES             00990000
010000                                INDEXED BY PV-CUR-OPER-UNT-IX.    01000000
010100         10  PV-CUR-OPER-UNT-ID       PIC S9(04) COMP.            01010000
010200         10  PV-CUR-FCLTY-ID          PIC S9(04) COMP.            01020000
010210         10  PV-CUR-OPER-SET          PIC S9(04) COMP.            01021002
010300                                                                  01030000
010400 01  PE-PROGRAM-ERROR-MESSAGES.                                   01040000
010500     05  PE-MSG-01                    PIC X(30)  VALUE            01050000
010600         'OPEN OF NEW OPER UNIT CSR     '.                        01060000
010700     05  PE-MSG-02                    PIC X(30)  VALUE            01070000
010800         'FETCH OF NEW OPER UNIT CSR    '.                        01080000
010900     05  PE-MSG-03                    PIC X(30)  VALUE            01090000
011000         'OPEN OF DEL OPER UNIT CSR     '.                        01100000
011100     05  PE-MSG-04                    PIC X(30)  VALUE            01110000
011200         'OPEN OF DEPT/CLASS CSR        '.                        01120000
011300     05  PE-MSG-05                    PIC X(30)  VALUE            01130000
011400         'FETCH OF DEPT/CLASS CSR       '.                        01140000
011500     05  PE-MSG-06                    PIC X(30)  VALUE            01150000
011600         'FETCH OF DEL OPER UNIT CSR    '.                        01160000
011700     05  PE-MSG-07                    PIC X(30)  VALUE            01170000
011800         'INSERT ON TDCFAAS             '.                        01180000
011900     05  PE-MSG-08                    PIC X(30)  VALUE            01190000
012000         'INSERT ON TDCTFAS             '.                        01200000
012100     05  PE-MSG-09                    PIC X(30)  VALUE            01210000
012200         'DELETE ON TDCFAAS             '.                        01220000
012300     05  PE-MSG-10                    PIC X(30)  VALUE            01230000
012400         'DELETE ON TDCTFAS             '.                        01240000
012500     05  PE-MSG-11                    PIC X(30)  VALUE            01250000
012600         'OPEN OF CUR OPER UNIT CSR     '.                        01260000
012700     05  PE-MSG-12                    PIC X(30)  VALUE            01270000
012800         'FETCH OF CUR OPER UNIT CSR    '.                        01280000
012900     05  PE-MSG-13                    PIC X(30)  VALUE            01290000
013000         'MAX RETRIES EXCEEDED          '.                        01300000
013100                                                                  01310000
013200/                                                                 01320000
013300******************************************************************01330000
013400*  RECORD LAYOUT FOR MBS STRUCTURE RECORD                         01340000
013500******************************************************************01350000
013600     COPY FSRD001O.                                               01360000
013700/                                                                 01370000
013800                                                                  01380000
013900******************************************************************01390000
014000*  COPY BOOK FOR DB2 FORMATTED MESSAGE AREA                       01400000
014100******************************************************************01410000
014200     COPY DPWS004.                                                01420000
014300                                                                  01430000
014400/                                                                 01440000
014500******************************************************************01450000
014600*  COMMUNICATIONS AREA FOR DB2                                    01460000
014700******************************************************************01470000
014800     EXEC SQL                                                     01480000
014900          INCLUDE SQLCA                                           01490000
015000     END-EXEC.                                                    01500000
015100                                                                  01510000
015200                                                                  01520003
015300******************************************************************01530000
015400*  TFLAREA DCLGEN  (FACILITY LOCATION AREA TABLE)                 01540000
015500******************************************************************01550000
015600     EXEC SQL                                                     01560000
015700          INCLUDE TFLAREA                                         01570000
015800     END-EXEC.                                                    01580000
015900                                                                  01590000
016000                                                                  01600003
016100******************************************************************01610000
016200*  TTKTFMT DCLGEN  (TICKET FORMAT TABLE)                          01620000
016300******************************************************************01630000
016400     EXEC SQL                                                     01640000
016500          INCLUDE TTKTFMT                                         01650000
016600     END-EXEC.                                                    01660000
016700                                                                  01670000
016800                                                                  01680003
016900******************************************************************01690000
017000*  TDCFAAS DCLGEN  (DEPT/CLASS FACILITY LOCATION AREA TABLE)      01700000
017100******************************************************************01710000
017200     EXEC SQL                                                     01720000
017300          INCLUDE TDCFAAS                                         01730000
017400     END-EXEC.                                                    01740000
017500                                                                  01750000
017600                                                                  01760003
017700******************************************************************01770000
017800*  TDCTFAS DCLGEN  (DEPT/CLASS TICKET FORMAT TABLE)               01780000
017900******************************************************************01790000
018000     EXEC SQL                                                     01800000
018100          INCLUDE TDCTFAS                                         01810000
018200     END-EXEC.                                                    01820000
018300                                                                  01830000
018400                                                                  01840003
018410******************************************************************01841003
018420*  TCOCNTL DCLGEN  (COMPANY CONTROL TABLE)                        01842003
018430******************************************************************01843003
018440     EXEC SQL                                                     01844003
018450          INCLUDE TCOCNTL                                         01845003
018460     END-EXEC.                                                    01846003
018470                                                                  01847003
018480                                                                  01848003
018490******************************************************************01849004
018491*  LOCATION DCLGEN  (LOCATION TABLE)                              01849116
018492******************************************************************01849204
018493     EXEC SQL                                                     01849304
018494          INCLUDE XLT00010                                        01849416
018495     END-EXEC.                                                    01849504
018496                                                                  01849604
018497                                                                  01849704
018500******************************************************************01850000
018600**  CURSOR USED TO LIST NEW OPERATING UNITS                       01860000
018700******************************************************************01870000
018800     EXEC SQL                                                     01880000
018900          DECLARE NEW_OPER_UNT CURSOR FOR                         01890000
019000           SELECT DISTINCT A.OPER_UNT_ID                          01900000
019100                          ,A.FCLTY_ID                             01910000
019110                          ,C.DFLT_OPER_SET_ID                     01911002
019200            FROM  TFLAREA A                                       01920000
019210                 ,TCOCNTL C                                       01921002
019220                 ,XLT_LOC D                                       01922016
019300            WHERE DEPT_CL_IND = 'Y'                               01930000
019310              AND A.OPER_UNT_ID  =  C.OPER_UNT_ID                 01931002
019320              AND C.OPER_UNT_ID  =  D.LOC_NBR                     01932016
019330              AND D.LOC_TYP_CDE  = 'DC'                           01933016
019340              AND D.CLO_DTE      = '9999-09-09'                   01934016
019400              AND NOT EXISTS                                      01940008
019500                   (SELECT CURRENT DATE                           01950000
019600                    FROM   TDCFAAS B                              01960000
019700                    WHERE  A.OPER_UNT_ID = B.OPER_UNT_ID          01970000
019800                      AND  A.FCLTY_ID    = B.FCLTY_ID)            01980000
019900           ORDER BY A.OPER_UNT_ID                                 01990000
020000                   ,A.FCLTY_ID                                    02000000
020100     END-EXEC.                                                    02010000
020200                                                                  02020000
020300                                                                  02030003
020400******************************************************************02040000
020500**  CURSOR USED TO LIST CURRENT OPERATING UNITS                   02050000
020600******************************************************************02060000
020700     EXEC SQL                                                     02070000
020800          DECLARE CUR_OPER_UNT CURSOR FOR                         02080000
020900           SELECT DISTINCT A.OPER_UNT_ID                          02090000
021000                          ,A.FCLTY_ID                             02100000
021010                          ,C.DFLT_OPER_SET_ID                     02101002
021100            FROM  TFLAREA A                                       02110000
021110                 ,TCOCNTL C                                       02111003
021200            WHERE DEPT_CL_IND = 'Y'                               02120000
021210              AND A.OPER_UNT_ID  =  C.OPER_UNT_ID                 02121002
021300            AND EXISTS                                            02130000
021400                   (SELECT CURRENT DATE                           02140000
021500                    FROM   TDCFAAS B                              02150000
021600                    WHERE  A.OPER_UNT_ID = B.OPER_UNT_ID          02160000
021700                      AND  A.FCLTY_ID    = B.FCLTY_ID)            02170000
021800           ORDER BY A.OPER_UNT_ID                                 02180000
021900                   ,A.FCLTY_ID                                    02190000
022000     END-EXEC.                                                    02200000
022100                                                                  02210000
022200/                                                                 02220000
022300******************************************************************02230000
022400**  CURSOR USED TO LIST OPERATING UNITS NOT ON TFLAREA            02240000
022500**  BUT ARE ON TDCFAAS                                            02250000
022600******************************************************************02260000
022700     EXEC SQL                                                     02270000
022800          DECLARE DEL_OPER_UNT CURSOR FOR                         02280000
022900           SELECT DISTINCT A.OPER_UNT_ID                          02290000
023000                          ,A.FCLTY_ID                             02300000
023100           FROM   TDCFAAS A                                       02310000
023200           WHERE NOT EXISTS                                       02320000
023300                   (SELECT CURRENT DATE                           02330000
023400                    FROM   TFLAREA B                              02340000
023500                    WHERE  A.OPER_UNT_ID = B.OPER_UNT_ID          02350000
023600                      AND  A.FCLTY_ID    = B.FCLTY_ID             02360000
023700                      AND  DEPT_CL_IND = 'Y')                     02370000
023800           ORDER BY A.OPER_UNT_ID                                 02380000
023900                   ,A.FCLTY_ID                                    02390000
024000     END-EXEC.                                                    02400000
024100                                                                  02410000
024200/                                                                 02420000
024300******************************************************************02430000
024400**  CURSOR USED TO LIST CURRENT DEPT/CLASSES                      02440000
024500******************************************************************02450000
024600     EXEC SQL                                                     02460000
024700          DECLARE DEPT_CL_CSR CURSOR FOR                          02470000
024800           SELECT DEPT_NBR                                        02480000
024900                 ,CL_NBR                                          02490000
025000             FROM TDCFAAS                                         02500000
025100            GROUP BY DEPT_NBR                                     02510000
025200                    ,CL_NBR                                       02520000
025300            ORDER BY DEPT_NBR                                     02530000
025400                    ,CL_NBR                                       02540000
025500     END-EXEC.                                                    02550000
025600                                                                  02560000
025700                                                                  02570001
025800******************************************************************02580000
025801* CURSOR WILL BRING BACK DC'S THAT DO NOT HAVE ENTRIES FOR A     *02580101
025802* GIVEN DEPT CLASS                                               *02580201
025803******************************************************************02580301
025804     EXEC SQL                                                     02580401
025805          DECLARE MISS_DEPT_CL_CSR CURSOR FOR                     02580504
025806           SELECT  C.OPER_UNT_ID                                  02580608
025807                  ,C.DFLT_OPER_SET_ID                             02580701
025808             FROM  XLT_LOC B                                      02580816
025809                  ,TCOCNTL C                                      02580901
025810            WHERE  B.LOC_TYP_CDE     = 'DC'                       02581016
025811              AND  B.CLO_DTE         = '9999-09-09'               02581116
025812              AND  B.LOC_NBR         =  C.OPER_UNT_ID             02581216
025813              AND  B.LOC_NBR   NOT IN                             02581316
025814                   (SELECT A.OPER_UNT_ID                          02581401
025815                      FROM TDCFAAS A                              02581501
025816                     WHERE DEPT_NBR  = :DK-DEPT                   02581601
025817                       AND CL_NBR    = :DK-CLASS                  02581706
025818                       AND A.OPER_UNT_ID  = B.LOC_NBR)            02581816
025819     END-EXEC.                                                    02581901
025820                                                                  02582001
025821                                                                  02582101
025830******************************************************************02583001
025900 PROCEDURE DIVISION.                                              02590000
026000******************************************************************02600000
026100                                                                  02610000
026200******************************************************************02620000
026300*  CONTROLS THE MAIN PROCESSING OF THE PROGRAM.                   02630000
026400******************************************************************02640000
026500 0000-PROGRAM-MAINLINE.                                           02650000
026600                                                                  02660000
026700     PERFORM 1000-INITIALIZE.                                     02670000
026800                                                                  02680000
026900     PERFORM 2000-PROCESS-MBS-RECORDS.                            02690000
027000                                                                  02700000
027100     PERFORM 9000-EOJ-ROUTINE.                                    02710000
027200                                                                  02720000
027300     STOP RUN.                                                    02730000
027400                                                                  02740000
027500/                                                                 02750000
027600******************************************************************02760000
027700*    -- OPEN INPUT FILE (MBS STRUCTURE FILE)                      02770000
027800*    -- CHECK TO SEE IF ANY OPER UNITS ARE ON TDCFAAS AND NOT ON  02780000
027900*       TFLAREA. IF SO, DELETE ALL ROWS FOR THAT OPER UNIT FROM   02790000
028000*       TDCFAAS AND TDCTFAS.                                      02800000
028100*    -- LOAD NEW OPER UNIT NUMBERS INTO A TABLE                   02810000
028200*    -- LOAD CURRENT OPER UNIT NUMBERS INTO A TABLE               02820000
028300*    -- PERFORM FIRST READ OF INPUT FILE                          02830000
028400******************************************************************02840000
028500 1000-INITIALIZE.                                                 02850000
028501                                                                  02850110
028600                                                                  02860000
028700     OPEN INPUT MBS-STRUCTURE-FILE-IN.                            02870000
028800                                                                  02880000
028900     PERFORM 7000-OPEN-DEL-OPER-UNT-CSR.                          02890000
029000     PERFORM 7005-FETCH-DEL-OPER-UNT-CSR.                         02900000
029100                                                                  02910000
029200     PERFORM UNTIL PS-DEL-OPER-UNT-CSR-EOF                        02920000
029300        PERFORM 7620-DELETE2-TDCFAAS                              02930000
029400        PERFORM 7630-DELETE2-TDCTFAS                              02940000
029500        PERFORM 7005-FETCH-DEL-OPER-UNT-CSR                       02950000
029600     END-PERFORM.                                                 02960000
029700                                                                  02970000
029800     PERFORM 7010-OPEN-NEW-OPER-UNT-CSR.                          02980000
029900     PERFORM 7015-FETCH-NEW-OPER-UNT-CSR.                         02990000
030000                                                                  03000000
030100     INITIALIZE PV-NEW-OPER-UNT-COUNT.                            03010000
030200     SET PV-NEW-OPER-UNT-IX        TO 1.                          03020000
030300                                                                  03030000
030400     PERFORM UNTIL PS-NEW-OPER-UNT-CSR-EOF                        03040000
030500        MOVE FLAREA-OPER-UNT-ID    TO PV-NEW-OPER-UNT-ID          03050000
030600                                             (PV-NEW-OPER-UNT-IX) 03060000
030700        MOVE FLAREA-FCLTY-ID       TO PV-NEW-FCLTY-ID             03070000
030800                                             (PV-NEW-OPER-UNT-IX) 03080000
030810        MOVE COCNTL-DFLT-OPER-SET-ID  TO PV-NEW-OPER-SET          03081002
030820                                             (PV-NEW-OPER-UNT-IX) 03082002
030900        SET PV-NEW-OPER-UNT-IX     UP BY 1                        03090000
031000        ADD 1                      TO PV-NEW-OPER-UNT-COUNT       03100000
031100        PERFORM 7015-FETCH-NEW-OPER-UNT-CSR                       03110000
031200     END-PERFORM.                                                 03120000
031300                                                                  03130000
031400     PERFORM 7070-OPEN-CUR-OPER-UNT-CSR.                          03140000
031500     PERFORM 7080-FETCH-CUR-OPER-UNT-CSR.                         03150000
031600                                                                  03160000
031700     INITIALIZE PV-CUR-OPER-UNT-COUNT.                            03170000
031800     SET PV-CUR-OPER-UNT-IX        TO 1.                          03180000
031900                                                                  03190000
032000     PERFORM UNTIL PS-CUR-OPER-UNT-CSR-EOF                        03200000
032100        MOVE FLAREA-OPER-UNT-ID    TO PV-CUR-OPER-UNT-ID          03210000
032200                                             (PV-CUR-OPER-UNT-IX) 03220000
032300        MOVE FLAREA-FCLTY-ID       TO PV-CUR-FCLTY-ID             03230000
032400                                             (PV-CUR-OPER-UNT-IX) 03240000
032410        MOVE COCNTL-DFLT-OPER-SET-ID  TO PV-CUR-OPER-SET          03241002
032420                                             (PV-CUR-OPER-UNT-IX) 03242002
032500        SET PV-CUR-OPER-UNT-IX     UP BY 1                        03250000
032600        ADD 1                      TO PV-CUR-OPER-UNT-COUNT       03260000
032700        PERFORM 7080-FETCH-CUR-OPER-UNT-CSR                       03270000
032800     END-PERFORM.                                                 03280000
032900                                                                  03290000
033000     PERFORM 7030-OPEN-DEPT-CL-NBR-CSR.                           03300000
033100     PERFORM 7040-FETCH-DEPT-CL-NBR-CSR.                          03310000
033200                                                                  03320000
033300     PERFORM 8000-READ-MBS-STRUCTURE-FILE.                        03330000
033400                                                                  03340000
033500/                                                                 03350000
033600******************************************************************03360000
033700*    -- IF THE TDCFAAS TABLE IS EMPTY, PERFORM INITIAL LOAD       03370000
033800*    -- ELSE UPDATE TDCFAAS AND TDCTFAS TABLES WITH               03380000
033900*       MBS EXTRACT DATA                                          03390000
034000******************************************************************03400000
034100 2000-PROCESS-MBS-RECORDS.                                        03410000
034101                                                                  03410110
034200                                                                  03420000
034300     IF PS-DEPT-CL-NBR-CSR-EOF                                    03430000
034400        PERFORM 3000-INITIAL-LOAD                                 03440000
034500          UNTIL PS-MBS-FILE-EOF                                   03450000
034600     ELSE                                                         03460000
034700        PERFORM 4000-UPDATE-TABLES                                03470000
034800          UNTIL PS-MBS-FILE-EOF                                   03480000
034900            OR  PS-DEPT-CL-NBR-CSR-EOF                            03490000
035000        IF PS-DEPT-CL-NBR-CSR-EOF AND NOT PS-MBS-FILE-EOF         03500000
035100           PERFORM UNTIL PS-MBS-FILE-EOF                          03510000
035200              PERFORM 5000-ADD-PROCESSING                         03520000
035300              PERFORM 8000-READ-MBS-STRUCTURE-FILE                03530000
035400           END-PERFORM                                            03540000
035500        ELSE                                                      03550000
035600           IF PS-MBS-FILE-EOF AND NOT PS-DEPT-CL-NBR-CSR-EOF      03560000
035700              PERFORM UNTIL PS-DEPT-CL-NBR-CSR-EOF                03570000
035800                 PERFORM 7600-DELETE-TDCFAAS                      03580000
035900                 PERFORM 7610-DELETE-TDCTFAS                      03590000
036000                 PERFORM 7040-FETCH-DEPT-CL-NBR-CSR               03600000
036100              END-PERFORM                                         03610000
036200           END-IF                                                 03620000
036300        END-IF                                                    03630000
036400     END-IF.                                                      03640000
036500                                                                  03650000
036600/                                                                 03660000
036700******************************************************************03670000
036800*    LOAD TABLES FOR EACH NEW OPERATING UNIT FOR THE FIRST TIME   03680000
036900******************************************************************03690000
037000 3000-INITIAL-LOAD.                                               03700000
037001                                                                  03700110
037100                                                                  03710000
037200     PERFORM VARYING PV-NEW-OPER-UNT-IX FROM 1 BY 1               03720000
037300               UNTIL PV-NEW-OPER-UNT-IX > PV-NEW-OPER-UNT-COUNT   03730000
037400        INITIALIZE DCLTDCFAAS                                     03740000
037500                   DCLTDCTFAS                                     03750000
037600        MOVE PV-NEW-OPER-UNT-ID (PV-NEW-OPER-UNT-IX)              03760000
037700                                   TO DCFAAS-OPER-UNT-ID          03770000
037800                                      DCTFAS-OPER-UNT-ID          03780000
037900        MOVE PV-NEW-FCLTY-ID    (PV-NEW-OPER-UNT-IX)              03790000
038000                                   TO DCFAAS-FCLTY-ID             03800000
038100                                      DCTFAS-FCLTY-ID             03810000
038110        MOVE PV-NEW-OPER-SET    (PV-NEW-OPER-UNT-IX)              03811002
038120                                   TO DCFAAS-OPER-SET-ID          03812002
038200        MOVE FS001O-DEPT           TO DCFAAS-DEPT-NBR             03820000
038300                                      DCTFAS-DEPT-NBR             03830000
038400        MOVE FS001O-SUB-CLASS-NMBR TO DCFAAS-CL-NBR               03840000
038500                                      DCTFAS-CL-NBR               03850000
038600        MOVE 1                     TO DCFAAS-RANK-NBR             03860000
038700                                      DCTFAS-RANK-NBR             03870000
038800        MOVE 'PA'                  TO DCFAAS-FCLTY-LOC-TYP-CDE    03880000
038900        MOVE -1                    TO PV-FCLTY-AREA-ID-NULL       03890000
039000                                      PV-TKT-FMT-ID-NULL          03900000
039100        PERFORM 7500-INSERT-TDCFAAS                               03910000
039200        PERFORM 7510-INSERT-TDCTFAS                               03920000
039300     END-PERFORM.                                                 03930000
039400                                                                  03940000
039500     PERFORM 8000-READ-MBS-STRUCTURE-FILE.                        03950000
039600                                                                  03960000
039700/                                                                 03970000
039800******************************************************************03980000
039900*   -PERFORM CLASSIC MATCH-MERGE LOGIC                            03990000
040000*   -ADD DEPT/CLASS INFO FOR NEW OPER UNIT EVEN THOUGH NO NEW DATA04000000
040100*    MAY BE COMING THRU, BUT A NEW OPER UNIT CONDITION EXISTS     04010000
040200******************************************************************04020000
040300 4000-UPDATE-TABLES.                                              04030000
040310                                                                  04031010
040400                                                                  04040000
040500     IF PV-FS001O-KEY = PV-TDCFAAS-KEY                            04050000
040600        IF  PV-NEW-OPER-UNT-COUNT > ZERO                          04060003
040700            PERFORM 5010-ADD-NEW-OPER-UNIT                        04070003
040710        ELSE                                                      04071003
040720            PERFORM 6000-CHECK-MISSING-DC                         04072003
040800        END-IF                                                    04080000
040900        PERFORM 8000-READ-MBS-STRUCTURE-FILE                      04090000
041000        PERFORM 7040-FETCH-DEPT-CL-NBR-CSR                        04100000
041100     ELSE                                                         04110000
041200        IF PV-FS001O-KEY < PV-TDCFAAS-KEY                         04120000
041300           PERFORM 5000-ADD-PROCESSING                            04130000
041400           PERFORM 8000-READ-MBS-STRUCTURE-FILE                   04140000
041500        ELSE                                                      04150000
041600           PERFORM 7600-DELETE-TDCFAAS                            04160000
041700           PERFORM 7610-DELETE-TDCTFAS                            04170000
041800           PERFORM 7040-FETCH-DEPT-CL-NBR-CSR                     04180000
041900        END-IF                                                    04190000
042000     END-IF.                                                      04200000
042100                                                                  04210000
042200/                                                                 04220000
042300******************************************************************04230000
042400*    ADD ROWS FOR EACH CURRENT AND NEW OPERATING UNIT TO          04240000
042500*    TDCFAAS AND TDCTFAS TABLES                                   04250000
042600******************************************************************04260000
042700 5000-ADD-PROCESSING.                                             04270000
042710                                                                  04271010
042800                                                                  04280000
042900     PERFORM VARYING PV-CUR-OPER-UNT-IX FROM 1 BY 1               04290000
043000               UNTIL PV-CUR-OPER-UNT-IX > PV-CUR-OPER-UNT-COUNT   04300000
043100        INITIALIZE DCLTDCFAAS                                     04310000
043200                   DCLTDCTFAS                                     04320000
043300        MOVE PV-CUR-OPER-UNT-ID (PV-CUR-OPER-UNT-IX)              04330000
043400                                   TO DCFAAS-OPER-UNT-ID          04340000
043500                                      DCTFAS-OPER-UNT-ID          04350000
043600        MOVE PV-CUR-FCLTY-ID    (PV-CUR-OPER-UNT-IX)              04360000
043700                                   TO DCFAAS-FCLTY-ID             04370000
043800                                      DCTFAS-FCLTY-ID             04380000
043810        MOVE PV-CUR-OPER-SET    (PV-CUR-OPER-UNT-IX)              04381002
043820                                   TO DCFAAS-OPER-SET-ID          04382002
043900        MOVE FS001O-DEPT           TO DCFAAS-DEPT-NBR             04390000
044000                                      DCTFAS-DEPT-NBR             04400000
044100        MOVE FS001O-SUB-CLASS-NMBR TO DCFAAS-CL-NBR               04410000
044200                                      DCTFAS-CL-NBR               04420000
044300        MOVE 1                     TO DCFAAS-RANK-NBR             04430000
044400                                      DCTFAS-RANK-NBR             04440000
044500        MOVE 'PA'                  TO DCFAAS-FCLTY-LOC-TYP-CDE    04450000
044600        MOVE -1                    TO PV-FCLTY-AREA-ID-NULL       04460000
044700                                      PV-TKT-FMT-ID-NULL          04470000
044800        PERFORM 7500-INSERT-TDCFAAS                               04480000
044900        PERFORM 7510-INSERT-TDCTFAS                               04490000
045000     END-PERFORM.                                                 04500000
045100                                                                  04510000
045200     IF PV-NEW-OPER-UNT-COUNT > ZERO                              04520000
045300        PERFORM 5010-ADD-NEW-OPER-UNIT                            04530000
045400     END-IF.                                                      04540000
045500                                                                  04550000
045600/                                                                 04560000
045700******************************************************************04570000
045800*    ADD ROWS FOR EACH NEW OPERATING UNIT ON TDCFAAS AND          04580000
045900*    TDCTFAS TABLES                                               04590000
046000******************************************************************04600000
046100 5010-ADD-NEW-OPER-UNIT.                                          04610000
046110                                                                  04611010
046200                                                                  04620000
046300     PERFORM VARYING PV-NEW-OPER-UNT-IX FROM 1 BY 1               04630000
046400               UNTIL PV-NEW-OPER-UNT-IX > PV-NEW-OPER-UNT-COUNT   04640000
046500        INITIALIZE DCLTDCFAAS                                     04650000
046600                   DCLTDCTFAS                                     04660000
046700        MOVE PV-NEW-OPER-UNT-ID (PV-NEW-OPER-UNT-IX)              04670000
046800                                   TO DCFAAS-OPER-UNT-ID          04680000
046900                                      DCTFAS-OPER-UNT-ID          04690000
047000        MOVE PV-NEW-FCLTY-ID    (PV-NEW-OPER-UNT-IX)              04700000
047100                                   TO DCFAAS-FCLTY-ID             04710000
047200                                      DCTFAS-FCLTY-ID             04720000
047300        MOVE FS001O-DEPT           TO DCFAAS-DEPT-NBR             04730000
047400                                      DCTFAS-DEPT-NBR             04740000
047500        MOVE FS001O-SUB-CLASS-NMBR TO DCFAAS-CL-NBR               04750000
047600                                      DCTFAS-CL-NBR               04760000
047700        MOVE 1                     TO DCFAAS-RANK-NBR             04770000
047800                                      DCTFAS-RANK-NBR             04780000
047900        MOVE 'PA'                  TO DCFAAS-FCLTY-LOC-TYP-CDE    04790000
048000        MOVE -1                    TO PV-FCLTY-AREA-ID-NULL       04800000
048100                                      PV-TKT-FMT-ID-NULL          04810000
048200        PERFORM 7500-INSERT-TDCFAAS                               04820000
048300        PERFORM 7510-INSERT-TDCTFAS                               04830000
048400     END-PERFORM.                                                 04840000
048500                                                                  04850000
048600                                                                  04860003
048601******************************************************************04860103
048602*  CHECK TO SEE IF DEPT-CLASS IS MISSING FOR ANY DC               04860203
048603******************************************************************04860303
048604 6000-CHECK-MISSING-DC.                                           04860403
048605                                                                  04860510
048612                                                                  04861203
048620     SET  PS-MISSING-DEPT-CL-EOF-NO  TO  TRUE.                    04862003
048621     MOVE FS001O-DEPT                TO  DK-DEPT.                 04862106
048622     MOVE FS001O-SUB-CLASS-NMBR      TO  DK-CLASS.                04862206
048630                                                                  04863003
048631     PERFORM 6010-OPEN-MISSING-CSR.                               04863103
048632     PERFORM 6020-FETCH-MISSING-CSR.                              04863203
048633                                                                  04863303
048634     PERFORM 6040-PROCESS-MISSING-CSR                             04863403
048635       UNTIL PS-MISSING-DEPT-CL-EOF.                              04863503
048636                                                                  04863603
048637     PERFORM 6030-CLOSE-MISSING-CSR.                              04863703
048640                                                                  04864003
048641                                                                  04864103
048642******************************************************************04864203
048643* OPEN MISSING DEPT-CLASS CURSOR                                 *04864303
048644******************************************************************04864403
048645 6010-OPEN-MISSING-CSR.                                           04864503
048646                                                                  04864603
048654                                                                  04865410
048655     PERFORM                                                      04865503
048656         WITH TEST AFTER                                          04865603
048657         VARYING PV-RETRY-COUNTER                                 04865703
048658         FROM 1 BY 1                                              04865803
048659         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               04865903
048660            OR  (SQLCODE = +0))                                   04866003
048661                                                                  04866103
048662         EXEC SQL                                                 04866203
048663             OPEN MISS_DEPT_CL_CSR                                04866304
048664         END-EXEC                                                 04866403
048665                                                                  04866503
048666         EVALUATE TRUE                                            04866603
048667             WHEN SQLCODE = +0                                    04866703
048668             WHEN SQLCODE = -904                                  04866803
048669             WHEN SQLCODE = -913                                  04866903
048670                  CONTINUE                                        04867003
048671             WHEN SQLWARN0 NOT = SPACE                            04867103
048672             WHEN SQLCODE  NOT = +0                               04867203
048673                  MOVE '6010-OPEN-MISSING-CSR     '               04867303
048674                                   TO PV-ABEND-PARAGRAPH          04867403
048675                  MOVE 'OPEN MISSING DEPT-CL CUSROR   '           04867503
048676                                   TO PV-DB2-OPERATION-ATTEMPTED  04867603
048677                  PERFORM 9200-SQL-ABEND                          04867703
048678          END-EVALUATE                                            04867803
048679     END-PERFORM.                                                 04867903
048680                                                                  04868003
048681     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        04868103
048682         MOVE '6010-OPEN-MISSING-CSR     '                        04868203
048683                                   TO PV-ABEND-PARAGRAPH          04868303
048684         MOVE PE-MSG-13            TO PV-DB2-OPERATION-ATTEMPTED  04868403
048685         PERFORM 9200-SQL-ABEND                                   04868503
048686     END-IF.                                                      04868603
048687                                                                  04868703
048688                                                                  04868803
048689******************************************************************04868903
048690* FETCH MISSING DEPT-CLASS CURSOR                                *04869003
048691******************************************************************04869103
048692 6020-FETCH-MISSING-CSR.                                          04869203
048693                                                                  04869310
048700                                                                  04870003
048701     EXEC SQL                                                     04870103
048702          FETCH MISS_DEPT_CL_CSR                                  04870204
048703           INTO :COCNTL-OPER-UNT-ID                               04870308
048704               ,:COCNTL-DFLT-OPER-SET-ID                          04870403
048705     END-EXEC.                                                    04870503
048706                                                                  04870603
048707     EVALUATE TRUE                                                04870703
048708         WHEN SQLCODE = +0                                        04870803
048709              CONTINUE                                            04870903
048710         WHEN SQLCODE = +100                                      04871003
048711              SET PS-MISSING-DEPT-CL-EOF                          04871104
048712                                 TO TRUE                          04871203
048713         WHEN SQLWARN0 NOT = SPACE                                04871303
048714         WHEN SQLCODE  NOT = +0                                   04871403
048715              MOVE '6020-FETCH-MISSING-CSR     '                  04871503
048716                                   TO PV-ABEND-PARAGRAPH          04871603
048717              MOVE 'FETCH MISSING DEPT-CL CUSROR  '               04871703
048718                                   TO PV-DB2-OPERATION-ATTEMPTED  04871803
048719              PERFORM 9200-SQL-ABEND                              04871903
048720     END-EVALUATE.                                                04872003
048721                                                                  04872103
048722                                                                  04872203
048723                                                                  04872303
048724******************************************************************04872403
048725* CLOSE MISSING DEPT-CLASS CURSOR                                *04872503
048726******************************************************************04872603
048727 6030-CLOSE-MISSING-CSR.                                          04872703
048728                                                                  04872810
048735                                                                  04873503
048736     PERFORM                                                      04873603
048737         WITH TEST AFTER                                          04873703
048738         VARYING PV-RETRY-COUNTER                                 04873803
048739         FROM 1 BY 1                                              04873903
048740         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               04874003
048741            OR  (SQLCODE = +0))                                   04874103
048742                                                                  04874203
048743         EXEC SQL                                                 04874303
048744             CLOSE MISS_DEPT_CL_CSR                               04874405
048745         END-EXEC                                                 04874503
048746                                                                  04874603
048747         EVALUATE TRUE                                            04874703
048748             WHEN SQLCODE = +0                                    04874803
048749             WHEN SQLCODE = -904                                  04874903
048750             WHEN SQLCODE = -913                                  04875003
048751                  CONTINUE                                        04875103
048752             WHEN SQLWARN0 NOT = SPACE                            04875203
048753             WHEN SQLCODE  NOT = +0                               04875303
048754                  MOVE '6030-CLOSE-MISSING-CSR    '               04875403
048755                                   TO PV-ABEND-PARAGRAPH          04875503
048756                  MOVE 'CLOSE MISSING DEPT-CL CUSROR  '           04875603
048757                                   TO PV-DB2-OPERATION-ATTEMPTED  04875703
048758                  PERFORM 9200-SQL-ABEND                          04875803
048759          END-EVALUATE                                            04875903
048760     END-PERFORM.                                                 04876003
048761                                                                  04876103
048762     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        04876203
048763         MOVE '6030-CLOSE-MISSING-CSR    '                        04876303
048764                                   TO PV-ABEND-PARAGRAPH          04876403
048765         MOVE PE-MSG-13            TO PV-DB2-OPERATION-ATTEMPTED  04876503
048766         PERFORM 9200-SQL-ABEND                                   04876603
048767     END-IF.                                                      04876703
048768                                                                  04876803
048769                                                                  04876903
048770******************************************************************04877003
048771* PROCESS MISSING DEPT-CLASS CURSOR                              *04877103
048772******************************************************************04877203
048773 6040-PROCESS-MISSING-CSR.                                        04877304
048774                                                                  04877410
048781                                                                  04878103
048782     MOVE COCNTL-OPER-UNT-ID       TO DCFAAS-OPER-UNT-ID          04878208
048783                                      DCTFAS-OPER-UNT-ID.         04878304
048784     MOVE 1                        TO DCFAAS-FCLTY-ID             04878403
048785                                      DCTFAS-FCLTY-ID.            04878504
048786     MOVE COCNTL-DFLT-OPER-SET-ID  TO DCFAAS-OPER-SET-ID.         04878604
048787     MOVE DK-DEPT                  TO DCFAAS-DEPT-NBR             04878703
048788                                      DCTFAS-DEPT-NBR.            04878804
048789     MOVE DK-CLASS                 TO DCFAAS-CL-NBR               04878903
048790                                      DCTFAS-CL-NBR.              04879004
048791     MOVE 1                        TO DCFAAS-RANK-NBR             04879103
048792                                      DCTFAS-RANK-NBR.            04879204
048793     MOVE 'PA'                     TO DCFAAS-FCLTY-LOC-TYP-CDE.   04879304
048794     MOVE -1                       TO PV-FCLTY-AREA-ID-NULL       04879403
048795                                      PV-TKT-FMT-ID-NULL.         04879504
048796                                                                  04879607
048797     MOVE DCFAAS-OPER-UNT-ID       TO PV-DISPLAY-OPER-ID.         04879707
048798     DISPLAY 'ROW(S) INSERTED FOR TDCFAAS FOR DEPT-CLASS '        04879807
048799              DCFAAS-DEPT-NBR '-'                                 04879907
048800              DCFAAS-CL-NBR   ' AND OPER '                        04880007
048801              PV-DISPLAY-OPER-ID.                                 04880107
048802                                                                  04880207
048803     PERFORM 7500-INSERT-TDCFAAS.                                 04880303
048804     PERFORM 7510-INSERT-TDCTFAS.                                 04880403
048805                                                                  04880503
048806     PERFORM 6020-FETCH-MISSING-CSR.                              04880603
048807                                                                  04880703
048808                                                                  04880803
048809******************************************************************04880903
048810*  OPEN THE DEL OPER UNIT CURSOR                                  04881000
048900******************************************************************04890000
049000 7000-OPEN-DEL-OPER-UNT-CSR.                                      04900000
049110                                                                  04911010
049180                                                                  04918010
049200     PERFORM                                                      04920000
049300         WITH TEST AFTER                                          04930000
049400         VARYING PV-RETRY-COUNTER                                 04940000
049500         FROM 1 BY 1                                              04950000
049600         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               04960000
049700            OR  (SQLCODE = +0))                                   04970000
049800                                                                  04980000
049900         EXEC SQL                                                 04990000
050000             OPEN DEL_OPER_UNT                                    05000000
050100         END-EXEC                                                 05010000
050200                                                                  05020000
050300         EVALUATE TRUE                                            05030000
050400             WHEN SQLCODE = +0                                    05040000
050500             WHEN SQLCODE = -904                                  05050000
050600             WHEN SQLCODE = -913                                  05060000
050700                  CONTINUE                                        05070000
050800             WHEN SQLWARN0 NOT = SPACE                            05080000
050900             WHEN SQLCODE  NOT = +0                               05090000
051000                  MOVE '7000-OPEN-DEL-OPER-UNT-CSR'               05100000
051100                                   TO PV-ABEND-PARAGRAPH          05110000
051200                  MOVE PE-MSG-03   TO PV-DB2-OPERATION-ATTEMPTED  05120000
051300                  PERFORM 9200-SQL-ABEND                          05130000
051400          END-EVALUATE                                            05140000
051500     END-PERFORM.                                                 05150000
051600                                                                  05160000
051700     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        05170000
051800         MOVE '7000-OPEN-DEL-OPER-UNT-CSR'                        05180000
051900                                   TO PV-ABEND-PARAGRAPH          05190000
052000         MOVE PE-MSG-13            TO PV-DB2-OPERATION-ATTEMPTED  05200000
052100         PERFORM 9200-SQL-ABEND                                   05210000
052200     END-IF.                                                      05220000
052300                                                                  05230000
052400/                                                                 05240000
052500******************************************************************05250000
052600*  FETCH EACH DELETED OPER UNIT NUMBER                            05260000
052700******************************************************************05270000
052800 7005-FETCH-DEL-OPER-UNT-CSR.                                     05280000
052810                                                                  05281010
052900                                                                  05290000
053000     EXEC SQL                                                     05300000
053100          FETCH DEL_OPER_UNT                                      05310000
053200           INTO :DCFAAS-OPER-UNT-ID                               05320000
053300               ,:DCFAAS-FCLTY-ID                                  05330000
053400     END-EXEC.                                                    05340000
053500                                                                  05350000
053600     EVALUATE TRUE                                                05360000
053700         WHEN SQLCODE = +0                                        05370000
053800              CONTINUE                                            05380000
053900         WHEN SQLCODE = +100                                      05390000
054000              SET PS-DEL-OPER-UNT-CSR-EOF                         05400000
054100                                 TO TRUE                          05410000
054200         WHEN SQLWARN0 NOT = SPACE                                05420000
054300         WHEN SQLCODE  NOT = +0                                   05430000
054400              MOVE '7005-FETCH-DEL-OPER-UNT-CSR'                  05440000
054500                                   TO PV-ABEND-PARAGRAPH          05450000
054600              MOVE PE-MSG-06       TO PV-DB2-OPERATION-ATTEMPTED  05460000
054700              PERFORM 9200-SQL-ABEND                              05470000
054800     END-EVALUATE.                                                05480000
054900                                                                  05490000
055000/                                                                 05500000
055100******************************************************************05510000
055200*  OPEN THE NEW OPER UNIT CURSOR                                  05520000
055300******************************************************************05530000
055400 7010-OPEN-NEW-OPER-UNT-CSR.                                      05540000
055410                                                                  05541010
055500                                                                  05550000
055600     PERFORM                                                      05560000
055700         WITH TEST AFTER                                          05570000
055800         VARYING PV-RETRY-COUNTER                                 05580000
055900         FROM 1 BY 1                                              05590000
056000         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               05600000
056100            OR  (SQLCODE = +0))                                   05610000
056200                                                                  05620000
056300         EXEC SQL                                                 05630000
056400             OPEN NEW_OPER_UNT                                    05640000
056500         END-EXEC                                                 05650000
056600                                                                  05660000
056700         EVALUATE TRUE                                            05670000
056800             WHEN SQLCODE = +0                                    05680000
056900             WHEN SQLCODE = -904                                  05690000
057000             WHEN SQLCODE = -913                                  05700000
057100                  CONTINUE                                        05710000
057200             WHEN SQLWARN0 NOT = SPACE                            05720000
057300             WHEN SQLCODE  NOT = +0                               05730000
057400                  MOVE '7010-OPEN-NEW-OPER-UNT-CSR'               05740000
057500                                   TO PV-ABEND-PARAGRAPH          05750000
057600                  MOVE PE-MSG-01   TO PV-DB2-OPERATION-ATTEMPTED  05760000
057700                  PERFORM 9200-SQL-ABEND                          05770000
057800         END-EVALUATE                                             05780000
057900     END-PERFORM.                                                 05790000
058000                                                                  05800000
058100     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        05810000
058200         MOVE '7010-OPEN-NEW-OPER-UNT-CSR'                        05820000
058300                                   TO PV-ABEND-PARAGRAPH          05830000
058400         MOVE PE-MSG-13            TO PV-DB2-OPERATION-ATTEMPTED  05840000
058500         PERFORM 9200-SQL-ABEND                                   05850000
058600     END-IF.                                                      05860000
058700                                                                  05870000
058800/                                                                 05880000
058900******************************************************************05890000
059000*  FETCH EACH NEW OPER UNIT NUMBER                                05900000
059100******************************************************************05910000
059200 7015-FETCH-NEW-OPER-UNT-CSR.                                     05920000
059210                                                                  05921010
059300                                                                  05930000
059400     EXEC SQL                                                     05940000
059500          FETCH NEW_OPER_UNT                                      05950000
059600           INTO :FLAREA-OPER-UNT-ID                               05960000
059700               ,:FLAREA-FCLTY-ID                                  05970000
059710               ,:COCNTL-DFLT-OPER-SET-ID                          05971003
059800     END-EXEC.                                                    05980000
059900                                                                  05990000
060000     EVALUATE TRUE                                                06000000
060100         WHEN SQLCODE = +0                                        06010000
060200              CONTINUE                                            06020000
060300         WHEN SQLCODE = +100                                      06030000
060400              SET PS-NEW-OPER-UNT-CSR-EOF                         06040000
060500                                 TO TRUE                          06050000
060600         WHEN SQLWARN0 NOT = SPACE                                06060000
060700         WHEN SQLCODE  NOT = +0                                   06070000
060800              MOVE '7015-FETCH-NEW-OPER-UNT-CSR'                  06080000
060900                                   TO PV-ABEND-PARAGRAPH          06090000
061000              MOVE PE-MSG-02       TO PV-DB2-OPERATION-ATTEMPTED  06100000
061100              PERFORM 9200-SQL-ABEND                              06110000
061200     END-EVALUATE.                                                06120000
061300                                                                  06130000
061400/                                                                 06140000
061500******************************************************************06150000
061600*  OPEN THE DEPT/CLASS CURSOR ON TABLE TDCFAAS                    06160000
061700******************************************************************06170000
061800 7030-OPEN-DEPT-CL-NBR-CSR.                                       06180000
061810                                                                  06181010
061900                                                                  06190000
062000     PERFORM                                                      06200000
062100         WITH TEST AFTER                                          06210000
062200         VARYING PV-RETRY-COUNTER                                 06220000
062300         FROM 1 BY 1                                              06230000
062400         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               06240000
062500            OR  (SQLCODE = +0))                                   06250000
062600                                                                  06260000
062700         EXEC SQL                                                 06270000
062800             OPEN DEPT_CL_CSR                                     06280000
062900         END-EXEC                                                 06290000
063000                                                                  06300000
063100         EVALUATE TRUE                                            06310000
063200             WHEN SQLCODE = +0                                    06320000
063300             WHEN SQLCODE = -904                                  06330000
063400             WHEN SQLCODE = -913                                  06340000
063500                  CONTINUE                                        06350000
063600             WHEN SQLWARN0 NOT = SPACE                            06360000
063700             WHEN SQLCODE  NOT = +0                               06370000
063800                  MOVE '7030-OPEN-DEPT-CL-NBR-CSR'                06380000
063900                                   TO PV-ABEND-PARAGRAPH          06390000
064000                  MOVE PE-MSG-01   TO PV-DB2-OPERATION-ATTEMPTED  06400000
064100                  PERFORM 9200-SQL-ABEND                          06410000
064200         END-EVALUATE                                             06420000
064300     END-PERFORM.                                                 06430000
064400                                                                  06440000
064500     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        06450000
064600         MOVE '7030-OPEN-DEPT-CL-NBR-CSR'                         06460000
064700                                   TO PV-ABEND-PARAGRAPH          06470000
064800         MOVE PE-MSG-13            TO PV-DB2-OPERATION-ATTEMPTED  06480000
064900         PERFORM 9200-SQL-ABEND                                   06490000
065000     END-IF.                                                      06500000
065100                                                                  06510000
065200/                                                                 06520000
065300******************************************************************06530000
065400*  FETCH THE NEXT DEPT/CLASS FROM TDCFAAS                         06540000
065500******************************************************************06550000
065600 7040-FETCH-DEPT-CL-NBR-CSR.                                      06560000
065610                                                                  06561010
065700                                                                  06570000
065800     EXEC SQL                                                     06580000
065900          FETCH DEPT_CL_CSR                                       06590000
066000           INTO :DCFAAS-DEPT-NBR,                                 06600000
066100                :DCFAAS-CL-NBR                                    06610000
066200     END-EXEC.                                                    06620000
066300                                                                  06630000
066400     EVALUATE TRUE                                                06640000
066500         WHEN SQLCODE = +0                                        06650000
066600              MOVE DCFAAS-DEPT-NBR TO PV-TDCFAAS-DEPT-NBR         06660000
066700              MOVE DCFAAS-CL-NBR   TO PV-TDCFAAS-CL-NBR           06670000
066800         WHEN SQLCODE = +100                                      06680000
066900              SET PS-DEPT-CL-NBR-CSR-EOF                          06690000
067000                                 TO TRUE                          06700000
067100         WHEN SQLWARN0 NOT = SPACE                                06710000
067200         WHEN SQLCODE  NOT = +0                                   06720000
067300              MOVE '7040-FETCH-DEPT-CL-NBR-CSR'                   06730000
067400                                   TO PV-ABEND-PARAGRAPH          06740000
067500              MOVE PE-MSG-02       TO PV-DB2-OPERATION-ATTEMPTED  06750000
067600              PERFORM 9200-SQL-ABEND                              06760000
067700     END-EVALUATE.                                                06770000
067800                                                                  06780000
067900/                                                                 06790000
068000******************************************************************06800000
068100*  OPEN THE CURRENT OPER UNIT CURSOR                              06810000
068200******************************************************************06820000
068300 7070-OPEN-CUR-OPER-UNT-CSR.                                      06830000
068310                                                                  06831010
068400                                                                  06840000
068500     PERFORM                                                      06850000
068600         WITH TEST AFTER                                          06860000
068700         VARYING PV-RETRY-COUNTER                                 06870000
068800         FROM 1 BY 1                                              06880000
068900         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               06890000
069000            OR  (SQLCODE = +0))                                   06900000
069100                                                                  06910000
069200         EXEC SQL                                                 06920000
069300              OPEN CUR_OPER_UNT                                   06930000
069400         END-EXEC                                                 06940000
069500                                                                  06950000
069600         EVALUATE TRUE                                            06960000
069700             WHEN SQLCODE = +0                                    06970000
069800             WHEN SQLCODE = -904                                  06980000
069900             WHEN SQLCODE = -913                                  06990000
070000                  CONTINUE                                        07000000
070100             WHEN SQLWARN0 NOT = SPACE                            07010000
070200             WHEN SQLCODE  NOT = +0                               07020000
070300                  MOVE '7070-OPEN-CUR-OPER-UNT-CSR'               07030000
070400                                   TO PV-ABEND-PARAGRAPH          07040000
070500                  MOVE PE-MSG-11   TO PV-DB2-OPERATION-ATTEMPTED  07050000
070600                  PERFORM 9200-SQL-ABEND                          07060000
070700         END-EVALUATE                                             07070000
070800     END-PERFORM.                                                 07080000
070900                                                                  07090000
071000     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        07100000
071100         MOVE '7040-OPEN-CUR-OPER-UNT-CSR'                        07110000
071200                                   TO PV-ABEND-PARAGRAPH          07120000
071300         MOVE PE-MSG-13            TO PV-DB2-OPERATION-ATTEMPTED  07130000
071400         PERFORM 9200-SQL-ABEND                                   07140000
071500     END-IF.                                                      07150000
071600                                                                  07160000
071700/                                                                 07170000
071800******************************************************************07180000
071900*  FETCH EACH CURENT OPER UNIT NUMBER                             07190000
072000******************************************************************07200000
072100 7080-FETCH-CUR-OPER-UNT-CSR.                                     07210000
072110                                                                  07211010
072200                                                                  07220000
072300     EXEC SQL                                                     07230000
072400          FETCH CUR_OPER_UNT                                      07240000
072500           INTO :FLAREA-OPER-UNT-ID                               07250000
072600               ,:FLAREA-FCLTY-ID                                  07260000
072610               ,:COCNTL-DFLT-OPER-SET-ID                          07261003
072700     END-EXEC.                                                    07270000
072800                                                                  07280000
072900     EVALUATE TRUE                                                07290000
073000         WHEN SQLCODE = +0                                        07300000
073100              CONTINUE                                            07310000
073200         WHEN SQLCODE = +100                                      07320000
073300              SET PS-CUR-OPER-UNT-CSR-EOF                         07330000
073400                                 TO TRUE                          07340000
073500         WHEN SQLWARN0 NOT = SPACE                                07350000
073600         WHEN SQLCODE  NOT = +0                                   07360000
073700              MOVE '7080-FETCH-CUR-OPER-UNT-CSR'                  07370000
073800                                 TO PV-ABEND-PARAGRAPH            07380000
073900              MOVE PE-MSG-12     TO PV-DB2-OPERATION-ATTEMPTED    07390000
074000              PERFORM 9200-SQL-ABEND                              07400000
074100     END-EVALUATE.                                                07410000
074200                                                                  07420000
074300/                                                                 07430000
074400******************************************************************07440000
074500*    INSERT ROW INTO TDCFAAS TABLE                                07450000
074600******************************************************************07460000
074700                                                                  07470000
074800 7500-INSERT-TDCFAAS.                                             07480000
074810                                                                  07481010
074900                                                                  07490000
075000     PERFORM                                                      07500000
075100         WITH TEST AFTER                                          07510000
075200         VARYING PV-RETRY-COUNTER                                 07520000
075300         FROM 1 BY 1                                              07530000
075400         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               07540000
075500            OR  (SQLCODE = +0))                                   07550000
075600                                                                  07560000
075700         EXEC SQL                                                 07570000
075800              INSERT INTO TDCFAAS                                 07580000
075900                          ( OPER_UNT_ID                           07590000
076000                           ,FCLTY_ID                              07600000
076100                           ,DEPT_NBR                              07610000
076200                           ,CL_NBR                                07620000
076300                           ,FCLTY_LOC_TYP_CDE                     07630000
076400                           ,RANK_NBR                              07640000
076500                           ,FCLTY_AREA_ID                         07650002
076510                           ,OPER_SET_ID)                          07651003
076600                   VALUES (:DCFAAS-OPER-UNT-ID                    07660000
076700                          ,:DCFAAS-FCLTY-ID                       07670000
076800                          ,:DCFAAS-DEPT-NBR                       07680000
076900                          ,:DCFAAS-CL-NBR                         07690000
077000                          ,:DCFAAS-FCLTY-LOC-TYP-CDE              07700000
077100                          ,:DCFAAS-RANK-NBR                       07710000
077200                          ,:DCFAAS-FCLTY-AREA-ID                  07720000
077300                               :PV-FCLTY-AREA-ID-NULL             07730002
077310                          ,:DCFAAS-OPER-SET-ID)                   07731002
077400         END-EXEC                                                 07740000
077500                                                                  07750000
077600         EVALUATE TRUE                                            07760000
077700             WHEN SQLCODE = +0                                    07770000
077800                  ADD 1            TO PV-TDCFAAS-ROWS-INSERTED    07780000
077900             WHEN SQLCODE = -904                                  07790000
078000             WHEN SQLCODE = -913                                  07800000
078100                  CONTINUE                                        07810000
078200             WHEN SQLWARN0 NOT = SPACE                            07820000
078300             WHEN SQLCODE  NOT = +0                               07830000
078400             WHEN SQLWARN0 NOT = SPACE                            07840000
078500             WHEN SQLCODE  NOT = +0                               07850000
078600                  MOVE '7500-INSERT-TDCFAAS'                      07860000
078700                                   TO PV-ABEND-PARAGRAPH          07870000
078800                  MOVE PE-MSG-07   TO PV-DB2-OPERATION-ATTEMPTED  07880000
078900                  PERFORM 9200-SQL-ABEND                          07890000
079000         END-EVALUATE                                             07900000
079100     END-PERFORM.                                                 07910000
079200                                                                  07920000
079300     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        07930000
079400         MOVE '7500-INSERT-TDCFAAS'                               07940000
079500                                   TO PV-ABEND-PARAGRAPH          07950000
079600         MOVE PE-MSG-13            TO PV-DB2-OPERATION-ATTEMPTED  07960000
079700         PERFORM 9200-SQL-ABEND                                   07970000
079800     END-IF.                                                      07980000
079900/                                                                 07990000
080000******************************************************************08000000
080100*    INSERT ROW INTO TDCTFAS TABLE                                08010000
080200******************************************************************08020000
080300                                                                  08030000
080400 7510-INSERT-TDCTFAS.                                             08040000
080410                                                                  08041010
080500                                                                  08050000
080600     PERFORM                                                      08060000
080700         WITH TEST AFTER                                          08070000
080800         VARYING PV-RETRY-COUNTER                                 08080000
080900         FROM 1 BY 1                                              08090000
081000         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               08100000
081100            OR  (SQLCODE = +0))                                   08110000
081200                                                                  08120000
081300         EXEC SQL                                                 08130000
081400              INSERT INTO TDCTFAS                                 08140000
081500                          ( OPER_UNT_ID                           08150000
081600                           ,FCLTY_ID                              08160000
081700                           ,DEPT_NBR                              08170000
081800                           ,CL_NBR                                08180000
081900                           ,RANK_NBR                              08190000
082000                           ,TKT_FMT_ID )                          08200000
082100                   VALUES (:DCTFAS-OPER-UNT-ID                    08210000
082200                          ,:DCTFAS-FCLTY-ID                       08220000
082300                          ,:DCTFAS-DEPT-NBR                       08230000
082400                          ,:DCTFAS-CL-NBR                         08240000
082500                          ,:DCTFAS-RANK-NBR                       08250000
082600                          ,:DCTFAS-TKT-FMT-ID                     08260000
082700                               :PV-TKT-FMT-ID-NULL )              08270000
082800         END-EXEC                                                 08280000
082900                                                                  08290000
083000         EVALUATE TRUE                                            08300000
083100             WHEN SQLCODE = +0                                    08310000
083200                  ADD 1            TO PV-TDCTFAS-ROWS-INSERTED    08320000
083210             WHEN SQLCODE = -803                                  08321013
083300             WHEN SQLCODE = -904                                  08330000
083400             WHEN SQLCODE = -913                                  08340000
083500                  CONTINUE                                        08350000
083600             WHEN SQLWARN0 NOT = SPACE                            08360000
083700             WHEN SQLCODE  NOT = +0                               08370000
083800                  MOVE '7510-INSERT-TDCTFAS'                      08380000
083900                                   TO PV-ABEND-PARAGRAPH          08390000
084000                  MOVE PE-MSG-08   TO PV-DB2-OPERATION-ATTEMPTED  08400000
084100                  PERFORM 9200-SQL-ABEND                          08410000
084200         END-EVALUATE                                             08420000
084300     END-PERFORM.                                                 08430000
084400                                                                  08440000
084410     IF  SQLCODE  = +0  OR                                        08441014
084420         SQLCODE  = -803                                          08442014
084430         CONTINUE                                                 08443014
084440     ELSE                                                         08444014
084500     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        08450000
084600         MOVE '7510-INSERT-TDCTFAS'                               08460000
084700                                   TO PV-ABEND-PARAGRAPH          08470000
084800         MOVE PE-MSG-13            TO PV-DB2-OPERATION-ATTEMPTED  08480000
084900         PERFORM 9200-SQL-ABEND                                   08490000
085000     END-IF                                                       08500014
085010     END-IF.                                                      08501014
085100                                                                  08510000
085200/                                                                 08520000
085300******************************************************************08530000
085400*  DELETE ROW(S) FROM THE TDCFAAS TABLE                           08540000
085500******************************************************************08550000
085600 7600-DELETE-TDCFAAS.                                             08560000
085610                                                                  08561010
085700                                                                  08570000
085800     PERFORM                                                      08580000
085900         WITH TEST AFTER                                          08590000
086000         VARYING PV-RETRY-COUNTER                                 08600000
086100         FROM 1 BY 1                                              08610000
086200         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               08620000
086300            OR  (SQLCODE = +0))                                   08630000
086400                                                                  08640000
086500         EXEC SQL                                                 08650000
086600              DELETE                                              08660000
086700              FROM TDCFAAS                                        08670000
086800              WHERE DEPT_NBR = :DCFAAS-DEPT-NBR                   08680000
086900                AND CL_NBR   = :DCFAAS-CL-NBR                     08690000
087000         END-EXEC                                                 08700000
087100                                                                  08710000
087200         EVALUATE TRUE                                            08720000
087300             WHEN SQLCODE = +0                                    08730000
087400                  DISPLAY 'ROW(S) DELETED FROM TDCFAAS FOR DEPT ' 08740000
087500                           DCFAAS-DEPT-NBR ' AND CLASS '          08750000
087600                           DCFAAS-CL-NBR                          08760000
087700                  ADD SQLERRD(3)   TO PV-TDCFAAS-ROWS-DELETED     08770000
087800             WHEN SQLCODE = -904                                  08780000
087900             WHEN SQLCODE = -913                                  08790000
088000                  CONTINUE                                        08800000
088100             WHEN SQLWARN0 NOT = SPACE                            08810000
088200             WHEN SQLCODE  NOT = +0                               08820000
088300                  MOVE '7600-DELETE-TDCFAAS'                      08830000
088400                                   TO PV-ABEND-PARAGRAPH          08840000
088500                  MOVE PE-MSG-09   TO PV-DB2-OPERATION-ATTEMPTED  08850000
088600                  PERFORM 9200-SQL-ABEND                          08860000
088700         END-EVALUATE                                             08870000
088800     END-PERFORM.                                                 08880000
088900                                                                  08890000
089000     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        08900000
089100         MOVE '7600-DELETE-TDCFAAS'                               08910000
089200                                   TO PV-ABEND-PARAGRAPH          08920000
089300         MOVE PE-MSG-13            TO PV-DB2-OPERATION-ATTEMPTED  08930000
089400         PERFORM 9200-SQL-ABEND                                   08940000
089500     END-IF.                                                      08950000
089600                                                                  08960000
089700/                                                                 08970000
089800******************************************************************08980000
089900*  DELETE ROW(S) FROM TDCTFAS TABLE                               08990000
090000******************************************************************09000000
090100 7610-DELETE-TDCTFAS.                                             09010000
090110                                                                  09011010
090200                                                                  09020000
090300     PERFORM                                                      09030000
090400         WITH TEST AFTER                                          09040000
090500         VARYING PV-RETRY-COUNTER                                 09050000
090600         FROM 1 BY 1                                              09060000
090700         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               09070000
090800            OR  (SQLCODE = +0))                                   09080000
090900                                                                  09090000
091000         EXEC SQL                                                 09100000
091100              DELETE                                              09110000
091200              FROM TDCTFAS                                        09120000
091300              WHERE DEPT_NBR = :DCFAAS-DEPT-NBR                   09130000
091400                AND CL_NBR   = :DCFAAS-CL-NBR                     09140000
091500         END-EXEC                                                 09150000
091600                                                                  09160000
091700         EVALUATE TRUE                                            09170000
091800             WHEN SQLCODE = +0                                    09180000
091900                  DISPLAY 'ROW(S) DELETED FROM TDCTFAS FOR DEPT ' 09190000
092000                           DCFAAS-DEPT-NBR ' AND CLASS '          09200000
092100                           DCFAAS-CL-NBR                          09210000
092200                  ADD SQLERRD(3)   TO PV-TDCTFAS-ROWS-DELETED     09220000
092300             WHEN SQLCODE = -904                                  09230000
092400             WHEN SQLCODE = -913                                  09240000
092500                  CONTINUE                                        09250000
092600             WHEN SQLWARN0 NOT = SPACE                            09260000
092700             WHEN SQLCODE  NOT = +0                               09270000
092800                  MOVE '7610-DELETE-TDCTFAS'                      09280000
092900                                   TO PV-ABEND-PARAGRAPH          09290000
093000                  MOVE PE-MSG-10   TO PV-DB2-OPERATION-ATTEMPTED  09300000
093100                  PERFORM 9200-SQL-ABEND                          09310000
093200         END-EVALUATE                                             09320000
093300     END-PERFORM.                                                 09330000
093400                                                                  09340000
093500     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        09350000
093600         MOVE '7610-DELETE-TDCTFAS'                               09360000
093700                                   TO PV-ABEND-PARAGRAPH          09370000
093800         MOVE PE-MSG-13            TO PV-DB2-OPERATION-ATTEMPTED  09380000
093900         PERFORM 9200-SQL-ABEND                                   09390000
094000     END-IF.                                                      09400000
094100                                                                  09410000
094200/                                                                 09420000
094300******************************************************************09430000
094400*  DELETE ROW(S) FROM THE TDCFAAS TABLE                           09440000
094500******************************************************************09450000
094600 7620-DELETE2-TDCFAAS.                                            09460000
094610                                                                  09461010
094700                                                                  09470000
094800     PERFORM                                                      09480000
094900         WITH TEST AFTER                                          09490000
095000         VARYING PV-RETRY-COUNTER                                 09500000
095100         FROM 1 BY 1                                              09510000
095200         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               09520000
095300            OR  (SQLCODE = +0))                                   09530000
095400                                                                  09540000
095500         EXEC SQL                                                 09550000
095600              DELETE                                              09560000
095700              FROM TDCFAAS                                        09570000
095800              WHERE OPER_UNT_ID = :DCFAAS-OPER-UNT-ID             09580000
095900         END-EXEC                                                 09590000
096000                                                                  09600000
096100         EVALUATE TRUE                                            09610000
096200             WHEN SQLCODE = +0                                    09620000
096300              DISPLAY 'ROW(S) DELETED FROM TDCFAAS FOR OPER UNIT '09630000
096400                           DCFAAS-OPER-UNT-ID                     09640000
096500                  ADD SQLERRD(3)   TO PV-TDCFAAS-ROWS-DELETED     09650000
096600             WHEN SQLCODE = -904                                  09660000
096700             WHEN SQLCODE = -913                                  09670000
096800                  CONTINUE                                        09680000
096900             WHEN SQLWARN0 NOT = SPACE                            09690000
097000             WHEN SQLCODE  NOT = +0                               09700000
097100                  MOVE '7620-DELETE2-TDCFAAS'                     09710000
097200                                   TO PV-ABEND-PARAGRAPH          09720000
097300                  MOVE PE-MSG-09   TO PV-DB2-OPERATION-ATTEMPTED  09730000
097400                  PERFORM 9200-SQL-ABEND                          09740000
097500         END-EVALUATE                                             09750000
097600     END-PERFORM.                                                 09760000
097700                                                                  09770000
097800     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        09780000
097900         MOVE '7620-DELETE2-TDCFAAS'                              09790000
098000                                   TO PV-ABEND-PARAGRAPH          09800000
098100         MOVE PE-MSG-13            TO PV-DB2-OPERATION-ATTEMPTED  09810000
098200         PERFORM 9200-SQL-ABEND                                   09820000
098300     END-IF.                                                      09830000
098400                                                                  09840000
098500/                                                                 09850000
098600******************************************************************09860000
098700*  DELETE ROW(S) FROM TDCTFAS TABLE                               09870000
098800******************************************************************09880000
098900 7630-DELETE2-TDCTFAS.                                            09890000
098910                                                                  09891010
099000                                                                  09900000
099100     PERFORM                                                      09910000
099200         WITH TEST AFTER                                          09920000
099300         VARYING PV-RETRY-COUNTER                                 09930000
099400         FROM 1 BY 1                                              09940000
099500         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               09950000
099600            OR  (SQLCODE = +0))                                   09960000
099700                                                                  09970000
099800         EXEC SQL                                                 09980000
099900              DELETE                                              09990000
100000              FROM TDCTFAS                                        10000000
100100              WHERE OPER_UNT_ID = :DCFAAS-OPER-UNT-ID             10010000
100200         END-EXEC                                                 10020000
100300                                                                  10030000
100400         EVALUATE TRUE                                            10040000
100500             WHEN SQLCODE = +0                                    10050000
100600              DISPLAY 'ROW(S) DELETED FROM TDCTFAS FOR OPER UNIT '10060000
100700                           DCFAAS-OPER-UNT-ID                     10070000
100800                  ADD SQLERRD(3)   TO PV-TDCTFAS-ROWS-DELETED     10080000
100900             WHEN SQLCODE = -904                                  10090000
101000             WHEN SQLCODE = -913                                  10100000
101100                  CONTINUE                                        10110000
101200             WHEN SQLWARN0 NOT = SPACE                            10120000
101300             WHEN SQLCODE  NOT = +0                               10130000
101400                  MOVE '7630-DELETE2-TDCTFAS'                     10140000
101500                                   TO PV-ABEND-PARAGRAPH          10150000
101600                  MOVE PE-MSG-10   TO PV-DB2-OPERATION-ATTEMPTED  10160000
101700                  PERFORM 9200-SQL-ABEND                          10170000
101800         END-EVALUATE                                             10180000
101900     END-PERFORM.                                                 10190000
102000                                                                  10200000
102100     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        10210000
102200         MOVE '7630-DELETE2-TDCTFAS'                              10220000
102300                                   TO PV-ABEND-PARAGRAPH          10230000
102400         MOVE PE-MSG-13            TO PV-DB2-OPERATION-ATTEMPTED  10240000
102500         PERFORM 9200-SQL-ABEND                                   10250000
102600     END-IF.                                                      10260000
102700/                                                                 10270000
102800******************************************************************10280000
102900*    READ A RECORD FROM THE MBS STRUCTURE FILE                    10290000
103000******************************************************************10300000
103100                                                                  10310000
103200 8000-READ-MBS-STRUCTURE-FILE.                                    10320000
103210                                                                  10321010
103300                                                                  10330000
103400     READ MBS-STRUCTURE-FILE-IN                                   10340000
103500        INTO FS001O-MBS-STRUCTURE-RECORD                          10350000
103600        AT END SET PS-MBS-FILE-EOF TO TRUE.                       10360000
103700                                                                  10370000
103800     IF NOT PS-MBS-FILE-EOF                                       10380000
103900        ADD 1                      TO PV-MBS-RECORDS-READ         10390000
104000        MOVE FS001O-DEPT           TO PV-FS001O-DEPT-NBR          10400000
104100        MOVE FS001O-SUB-CLASS-NMBR TO PV-FS001O-CL-NBR            10410000
104200     END-IF.                                                      10420000
104300                                                                  10430000
104400/                                                                 10440000
104500******************************************************************10450000
104600*  CLOSE FILES ASSOCIATED WITH THE PROGRAM.                       10460000
104700******************************************************************10470000
104800 9000-EOJ-ROUTINE.                                                10480000
104810                                                                  10481010
104900                                                                  10490000
105000     CLOSE MBS-STRUCTURE-FILE-IN.                                 10500000
105100                                                                  10510000
105200     DISPLAY ' '.                                                 10520000
105300     DISPLAY 'MBS INPUT RECORDS READ - ' PV-MBS-RECORDS-READ.     10530000
105400     DISPLAY 'TDCFAAS ROWS INSERTED -- ' PV-TDCFAAS-ROWS-INSERTED.10540000
105500     DISPLAY 'TDCFAAS ROWS DELETED  -- ' PV-TDCFAAS-ROWS-DELETED. 10550000
105600     DISPLAY 'TDCTFAS ROWS INSERTED -- ' PV-TDCTFAS-ROWS-INSERTED.10560000
105700     DISPLAY 'TDCTFAS ROWS DELETED  -- ' PV-TDCTFAS-ROWS-DELETED. 10570000
105800                                                                  10580000
105900/                                                                 10590000
106000******************************************************************10600000
106100*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    10610000
106200*  ERROR OR WARNING CODE OCCURS.                                  10620000
106300******************************************************************10630000
106400 9200-SQL-ABEND.                                                  10640000
106500     DISPLAY '9200-SQL-ABEND'.                                    10650000
106600     DISPLAY '** ABEND     **'.                                   10660000
106700     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        10670000
106800     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.             10680000
106900     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     10690000
107000                                                                  10700000
107100/                                                                 10710000
107200******************************************************************10720000
107300* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    10730000
107400* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         10740000
107500* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     10750000
107600* FORMAT.                                                         10760000
107700******************************************************************10770000
107800     COPY DPPD004.                                                10780000
107900                                                                  10790000
108000     IF  SQLCODE NOT = -911                                       10800000
108100         EXEC SQL                                                 10810000
108200              COMMIT                                              10820000
108300         END-EXEC                                                 10830000
108400     END-IF.                                                      10840000
108500                                                                  10850000
108600     MOVE +4013                  TO PV-ABEND-CODE.                10860000
108700     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         10870000
