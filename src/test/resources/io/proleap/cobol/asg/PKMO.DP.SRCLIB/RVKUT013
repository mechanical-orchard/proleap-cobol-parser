000100 IDENTIFICATION DIVISION.                                         00010001
000200                                                                  00020001
000300 PROGRAM-ID.             RVKUT013.                                00030001
000400 AUTHOR.                 DAN HINTZ.                               00040001
000500 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00050001
000600 DATE-WRITTEN.           JULY 2005.                               00060002
000700 DATE-COMPILED.                                                   00070001
000800                                                                  00080001
000900*                                                                 00090001
001100******************************************************************00091001
001000*  PROGRAM NARRATIVE:                                             00100001
001100*  THIS PROGRAM WILL CREATE A FILE CONTAINING ITEM DATA           00110001
001200*  INFORMATION TO BE USED BY AUDITORS FOR FOLLOW-UP ON RETURNED   00120001
001200*  MERCHANDISE.                                                   00120101
001100******************************************************************00121001
001400*                                                                 00130001
002800 ENVIRONMENT DIVISION.                                            00150001
002900                                                                  00160001
003000 CONFIGURATION SECTION.                                           00170001
003100                                                                  00180001
003200 SOURCE-COMPUTER.                        IBM-3090.                00190001
003300 OBJECT-COMPUTER.                        IBM-3090.                00200001
003400                                                                  00210001
003500 INPUT-OUTPUT SECTION.                                            00220001
003600                                                                  00230001
003700 FILE-CONTROL.                                                    00240001
003800                                                                  00250001
003900     SELECT  RV-ITEM-FILE                                         00260001
004000         ASSIGN TO OUT01.                                         00270001
004100                                                                  00280001
004500******************************************************************00293001
004600 DATA DIVISION.                                                   00294001
004700******************************************************************00295001
004800                                                                  00296001
004900 FILE SECTION.                                                    00297001
005000*                                                                 00298001
005100 FD  RV-ITEM-FILE                                                 00299001
005200     RECORDING MODE IS F                                          00300001
005300     LABEL RECORDS ARE STANDARD                                   00310001
005400     BLOCK CONTAINS 0 RECORDS.                                    00320001
005500 01  RV-ITEM-RECORD                   PIC  X(117).                00330002
005600*                                                                 00400001
006300*                                                                 00410001
006500 WORKING-STORAGE SECTION.                                         00420001
013800***************************************************************** 00430001
013800*    PROGRAM CONSTANTS                                            00440001
013800***************************************************************** 00450001
013600 01  PC-CONSTANTS.                                                00460001
013700     05  PC-CURRENT-PGM-RVKUT013      PIC  X(08) VALUE 'RVKUT013'.00470001
013700     05  PC-MAX-RETRIES               PIC S9(04) VALUE +3         00480001
013700                                                 COMP SYNC.       00490001
013800                                                                  00500001
013800***************************************************************** 00510001
013800*    PROGRAM SWITCHES                                             00520001
013800***************************************************************** 00530001
013900 01  PS-SWITCHES.                                                 00540001
014000     05  PS-END-CURSOR-SWITCH         PIC  X(01) VALUE 'N'.       00550001
014100         88  PS-END-CSR                          VALUE 'Y'.       00560001
014100         88  PS-NOT-END-CSR                      VALUE 'N'.       00570001
014200                                                                  00580001
013800***************************************************************** 00590001
013800*    PROGRAM VARIABLES                                            00600001
013800***************************************************************** 00610001
008000 01  PV-VARIABLES.                                                00620001
013700     05  PV-RETRY-COUNT               PIC S9(04) VALUE +0         00630001
006800                                                 COMP SYNC.       00640001
006700     05  PV-ABEND-CODE                PIC S9(04) VALUE ZERO       00650001
006800                                                 COMP SYNC.       00660001
011000     05  PV-PARAGRAPH                 PIC  X(30) VALUE SPACES.    00670001
010800     05  PV-DB2-FUNCTION              PIC  X(30) VALUE SPACES.    00680001
010900     05  PV-ABEND-TABLE-1             PIC  X(20) VALUE SPACES.    00690001
010900     05  PV-ABEND-TABLE-2             PIC  X(20) VALUE SPACES.    00700001
010900     05  PV-ABEND-TABLE-3             PIC  X(20) VALUE SPACES.    00710001
019710     05  PV-CURRENT-TIMESTAMP         PIC  X(26) VALUE SPACES.    00711001
019720     05  PV-COMMIT-TIMESTAMP          PIC  X(26) VALUE SPACES.    00712001
010900     05  PV-ERROR-MSG                 PIC  X(60) VALUE SPACES.    00713001
010900     05  PV-ERROR-MSG-2               PIC  X(60) VALUE SPACES.    00713102
009700     05  PV-RECS-WRITTEN              PIC  9(09) VALUE ZERO.      00714001
009700     05  PV-ENT-ID-X.                                             00717001
009700         10  PV-ENT-ID                PIC  9(09) VALUE ZERO.      00718001
009700     05  PV-DUNS-NBR-X.                                           00730003
009700         10  PV-DUNS-NBR              PIC  9(09) VALUE ZERO.      00740002
008300     05  PV-RUN-DATE                  PIC  X(10) VALUE SPACES.    00758001
008400     05  PV-RUN-DATE-R REDEFINES PV-RUN-DATE.                     00759001
008500         10  PV-RUN-CCYY              PIC  X(04).                 00760001
008600         10  FILLER                   PIC  X(01).                 00770001
008700         10  PV-RUN-MO                PIC  X(02).                 00771001
008800         10  FILLER                   PIC  X(01).                 00772001
008900         10  PV-RUN-DD                PIC  X(02).                 00773001
009400     05  PV-RUN-TIME                  PIC  X(08) VALUE SPACES.    00778001
009500     05  PV-RUN-TIME-R REDEFINES PV-RUN-TIME.                     00779001
009600         10  PV-RUN-HH                PIC  X(02).                 00780001
009700         10  FILLER                   PIC  X(01).                 00790001
009800         10  PV-RUN-MM                PIC  X(02).                 00800001
009900         10  FILLER                   PIC  X(01).                 00810001
010000         10  PV-RUN-SS                PIC  X(02).                 00820001
014600                                                                  00877001
015400***  ITEM FILE LAYOUT                                             00890001
014700     COPY RVRD999.                                                00900001
014800                                                                  00910001
015400***  DB2 ABEND COPYBOOK                                           00920001
014700     COPY DPWS004.                                                00930001
014800                                                                  00940001
014900     EXEC SQL                                                     00950001
015000         INCLUDE SQLCA                                            00960001
015100     END-EXEC.                                                    00970001
015200                                                                  00980001
015300     COPY SQLCA2.                                                 00990001
015400                                                                  01000001
034300*---------------------------------------------------------------* 01010001
034400*    DCLGEN FOR VENDOR LOGISTICS DOMAIN SKU TABLE               * 01020001
034500*    (XLT_SKU)                                                  * 01030001
034600*---------------------------------------------------------------* 01040001
016300     EXEC SQL                                                     01050001
016400         INCLUDE XLT00003                                         01060001
016500     END-EXEC.                                                    01070001
016600                                                                  01080001
034300*---------------------------------------------------------------* 01081001
034400*    DCLGEN FOR VENDOR LOGISTICS DOMAIN VENDOR STYLE TABLE      * 01082001
034500*    (XLT_VND_STYL)                                             * 01083001
034600*---------------------------------------------------------------* 01084001
016300     EXEC SQL                                                     01085001
016400         INCLUDE XLT00004                                         01086001
016500     END-EXEC.                                                    01087001
016600                                                                  01088001
034300*---------------------------------------------------------------* 01089001
034400*    DCLGEN FOR VENDOR LOGISTICS DOMAIN UPC TABLE               * 01090001
034500*    (XLT_UPC)                                                  * 01100001
034600*---------------------------------------------------------------* 01110001
016300     EXEC SQL                                                     01120001
016400         INCLUDE XLT00006                                         01130001
016500     END-EXEC.                                                    01131001
016600                                                                  01132001
034300*---------------------------------------------------------------* 01133003
034400*    DCLGEN FOR THE EXTERNAL ENTITY TABLE (TEXTENT)             * 01134003
034600*---------------------------------------------------------------* 01136003
016300     EXEC SQL                                                     01137003
016400         INCLUDE TEXTENT                                          01138003
016500     END-EXEC.                                                    01139003
016600                                                                  01139103
014310******************************************************************01139201
014320** COBOL DECLARATION AND DCLGEN MEMBER FOR THE CHECKPOINT       **01139301
014321** RESTART CONTROL TABLE.  THIS PROGRAM IS NOT WRITTEN USING    **01139401
014322** THE CHECKPOINT RESTART MODULE.  WE ARE USING THIS TABLE      **01139501
014323** TO DYNAMICALLY DETERMINE HOW OFTEN COMMITS ARE TO BE TAKEN.  **01139601
014330******************************************************************01139701
014340     EXEC SQL                                                     01139801
014350          INCLUDE TCKRSTCN                                        01139901
014360     END-EXEC.                                                    01140001
016600                                                                  01140101
016600                                                                  01140201
016600***  EXTRACT CURSOR                                               01140301
016600     EXEC SQL                                                     01140401
016600         DECLARE EXTRACT-CSR CURSOR WITH HOLD FOR                 01140501
016600         SELECT                                                   01140601
                      A.ITM_NBR                                         01140904
                    , A.SKU_NBR                                         01141001
                    , A.INNR_PK_QTY                                     01142001
                    , A.SKU_DESC                                        01142101
                    , A.KOHLS_SIZE_CDE                                  01143001
                    , A.SIZE_DESC                                       01144001
                    , A.NRF_CLOR_CDE                                    01145001
                    , A.CSTM_CLOR_DESC                                  01146001
                    , B.UPC_NBR                                         01147001
                    , C.DEPT_NBR                                        01149001
                    , C.SUB_CL_NBR                                      01160001
                    , C.VS_NBR                                          01170001
                    , C.ENT_ID                                          01180001
016600           FROM                                                   01200001
                      XLT_SKU      A                                    01210001
                    , XLT_UPC      B                                    01210101
                    , XLT_VND_STYL C                                    01210201
                 WHERE                                                  01210301
                      A.INTR_UPC_ID = B.INTR_UPC_ID                     01210401
                   AND                                                  01210501
                      A.STYL_ID     = C.STYL_ID                         01210601
              ORDER BY                                                  01210701
                      A.SKU_NBR                                         01210801
                    , B.UPC_NBR                                         01210901
              WITH UR                                                   01211001
016600     END-EXEC.                                                    01212001
016600                                                                  01213001
016700 LINKAGE SECTION.                                                 01214001
016800                                                                  01215001
016900 PROCEDURE DIVISION.                                              01216001
017000***************************************************************** 01217001
017200*  MAINLINE LOGIC FOR PROGRAM                                     01218001
017000***************************************************************** 01219001
017100 0000-MAINLINE.                                                   01220001
017500     PERFORM 1000-INITIALIZE.                                     01230001
017600                                                                  01240001
017700     PERFORM 2000-PROCESS                                         01250001
017800         UNTIL PS-END-CSR.                                        01260001
017900                                                                  01270001
018100     PERFORM 9000-EOJ.                                            01280001
018200                                                                  01290001
018200     STOP RUN.                                                    01300001
018200                                                                  01310001
017000***************************************************************** 01320001
017200*  INITIALIZATION PARAGRAPH                                       01330001
017000***************************************************************** 01340001
018600 1000-INITIALIZE.                                                 01350001
020200     OPEN OUTPUT RV-ITEM-FILE.                                    01360001
019500                                                                  01380001
017600     EXEC SQL                                                     01390001
017700       SET :PV-RUN-DATE = CURRENT DATE                            01400001
017800     END-EXEC.                                                    01410001
017900                                                                  01420001
018000     DISPLAY '** CURRENT RUN DATE  => '  PV-RUN-DATE.             01430001
018100                                                                  01440001
018200     EXEC SQL                                                     01450001
018300       SET :PV-RUN-TIME = CURRENT TIME                            01460001
018400     END-EXEC.                                                    01470001
018500                                                                  01480001
018600     DISPLAY '** CURRENT RUN TIME  => '  PV-RUN-TIME.             01490001
018700                                                                  01500001
033710     PERFORM 1100-FETCH-COMMIT-TIMESTAMP.                         01553001
033500                                                                  01554001
020300     PERFORM 7000-OPEN-EXTRACT-CURSOR.                            01555001
020400     PERFORM 7200-FETCH-EXTRACT-CURSOR.                           01556001
022400                                                                  01557001
022400                                                                  01558001
038700******************************************************************01559001
038800*  FETCH THE TIMESTAMP THAT WILL BE USED TO DETERMINE WHEN A      01560001
038900*  COMMIT IS TAKEN.  THE TIME INTERVAL IS DETERMINED BY A VALUE   01570001
039000*  ON THE TCKRSTCNTL TABLE.                                       01580001
039100******************************************************************01581001
039200 1100-FETCH-COMMIT-TIMESTAMP.                                     01582001
039210                                                                  01583001
000971     PERFORM                                                      01584001
000972         WITH TEST AFTER                                          01585001
000973         VARYING PV-RETRY-COUNT                                   01586001
000974         FROM 1 BY 1                                              01587001
000975         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 01588001
000976                   OR (SQLCODE = ZERO))                           01589001
039210                                                                  01589101
039300         EXEC SQL                                                 01589201
039400             SELECT (CURRENT TIMESTAMP +                          01589301
                           CKPT_FRQNCY_QTY SECONDS)                     01589401
039500               INTO  :PV-COMMIT-TIMESTAMP                         01589501
039600               FROM  TCKRSTCNTL                                   01589601
039700              WHERE  PLAN_NAME = :PC-CURRENT-PGM-RVKUT013         01589701
039710         END-EXEC                                                 01589801
039800                                                                  01589901
039810         EVALUATE TRUE                                            01590001
000982             WHEN SQLCODE = +0                                    01590101
000983             WHEN SQLCODE = -904                                  01590201
000984             WHEN SQLCODE = -911                                  01590301
000985             WHEN SQLCODE = -913                                  01590401
039830                 CONTINUE                                         01590501
039870             WHEN SQLWARN0 NOT = SPACES                           01590601
039880             WHEN SQLCODE < ZERO                                  01590701
039890             WHEN SQLCODE > ZERO                                  01590801
001000                 DISPLAY '** ABEND **'                            01590901
001010                 DISPLAY '** PROGRAM = RVKUT013 **'               01591001
001011                 DISPLAY '** PARAGRAPH = '                        01591101
                               '1100-FETCH-COMMIT-TIMESTAMP'            01591201
001012                 MOVE 'FETCH COMMIT TIMESTAMP'                    01591301
001013                                 TO PV-ERROR-MSG                  01591401
001014                 MOVE 'TCKRSTCNTL'                                01591501
                                       TO PV-ABEND-TABLE-1              01591601
001015                 PERFORM 9200-SQL-ERROR                           01591701
039897         END-EVALUATE                                             01591801
000997     END-PERFORM.                                                 01591901
000998                                                                  01592001
000999     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          01592101
001000         DISPLAY '** ABEND **'                                    01592201
001010         DISPLAY '** PROGRAM = RVKUT013 **'                       01592301
001011         DISPLAY '** PARAGRAPH =  1100-FETCH-COMMIT-TIMESTAMP **' 01592401
001012         MOVE 'FETCH COMMIT TIMESTAMP RETRIES ENCOUNTERED'        01592501
001013                                      TO PV-ERROR-MSG             01592601
001014         MOVE 'TCKRSTCNTL'            TO PV-ABEND-TABLE-1         01592701
001015         PERFORM 9200-SQL-ERROR                                   01592801
001016     END-IF.                                                      01592901
041600                                                                  01593001
041700                                                                  01593101
017000***************************************************************** 01593201
017200* PROCESS DATA FROM CURSOR AND WRITE OUTPUT RECORD                01593301
017000***************************************************************** 01593401
024200 2000-PROCESS.                                                    01593501
000014     MOVE XLT00004-SUB-CL-NBR     TO RV999-SUB-CL-NBR.            01593702
000014     MOVE XLT00004-DEPT-NBR       TO RV999-DEPT-NBR.              01593802
000011     MOVE XLT00003-SKU-NBR        TO RV999-SKU-NBR.               01594202
000012     MOVE XLT00006-UPC-NBR        TO RV999-UPC-NBR.               01594302
000014     MOVE XLT00003-SKU-DESC       TO RV999-SKU-DESC.              01594402
000014     MOVE XLT00004-VS-NBR         TO RV999-VS-NBR.                01594902
000013     MOVE XLT00003-NRF-CLOR-CDE   TO RV999-NRF-CLOR-CDE.          01598002
000013     MOVE XLT00003-CSTM-CLOR-DESC TO RV999-CSTM-CLOR-DESC.        01599002
000013     MOVE XLT00003-SIZE-DESC      TO RV999-SIZE-DESC.             01600002
000013     MOVE XLT00003-KOHLS-SIZE-CDE TO RV999-KOHLS-SIZE-CDE.        01610002
000013     MOVE XLT00003-INNR-PK-QTY    TO RV999-INNR-PK-QTY.           01620002
000013     MOVE 'EA'                    TO RV999-QTY-OF-MEASURE.        01621002
022400                                                                  01630001
002800     PERFORM 2100-FETCH-VENDOR-DUNS-NBR.                          01640002
022400                                                                  01650001
000014     MOVE PV-DUNS-NBR-X           TO RV999-DUNS-NBR.              01660002
  2400     MOVE XLT00003-ITM-NBR        TO RV999-ITM-NBR.               01761902
002800                                                                  01762001
002800     PERFORM 8000-WRITE-OUTPUT.                                   01763001
026000                                                                  01764001
043910     EXEC SQL                                                     01765001
043920         SET :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP            01766001
043930     END-EXEC.                                                    01767001
043940*                                                                 01768001
043950     IF  SQLCODE = +0                                             01769001
043960         IF  PV-CURRENT-TIMESTAMP > PV-COMMIT-TIMESTAMP           01770001
043970             PERFORM 7600-COMMIT-AND-RELEASE-LOCKS                01780001
043980             PERFORM 1100-FETCH-COMMIT-TIMESTAMP                  01790001
043990         END-IF                                                   01800001
043991     ELSE                                                         01810001
000989         DISPLAY '** ABEND **'                                    01820001
000990         DISPLAY '** PROGRAM = RVKUT013 **'                       01830001
000991         DISPLAY '** PARAGRAPH =  2000-PROCESS-ASN-HDR **'        01840001
000993         MOVE 'ERROR FETCHING CURRENT TIMESTAMP'                  01850001
                                       TO PV-ERROR-MSG                  01860001
000994         MOVE SPACES             TO PV-ABEND-TABLE-1              01870001
000995         PERFORM 9200-SQL-ERROR                                   01880001
043998     END-IF.                                                      01890001
043999                                                                  01900001
026200     PERFORM 7200-FETCH-EXTRACT-CURSOR.                           01910001
021700                                                                  01920001
042800                                                                  01930001
026400******************************************************************01940001
026600* FETCH THE VENDOR DUNS NUMBER.                                   01950001
026700******************************************************************01960001
060600 2100-FETCH-VENDOR-DUNS-NBR.                                      01970002
118710     INITIALIZE DCLTEXTENT.                                       01980002
061000                                                                  01990001
001078     PERFORM                                                      02000001
001079         WITH TEST AFTER                                          02010001
001080         VARYING PV-RETRY-COUNT                                   02020001
001081         FROM 1 BY 1                                              02030001
001082         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 02040001
001083                   OR (SQLCODE = ZERO) OR (SQLCODE = +100))       02050001
060700         EXEC SQL                                                 02060001
016600             SELECT                                               02070001
                          DUN_NBR                                       02080002
016600               INTO                                               02100001
                          :EXTENT-DUN-NBR                               02110002
016600               FROM                                               02130001
                          TEXTENT                                       02140002
                     WHERE                                              02150001
                          ENT_ID = :XLT00004-ENT-ID                     02160002
060900         END-EXEC                                                 02190001
061000                                                                  02200001
061100         EVALUATE TRUE                                            02210001
061300             WHEN SQLCODE = +0                                    02220001
                       MOVE EXTENT-DUN-NBR  TO PV-DUNS-NBR-X            02222002
061300             WHEN SQLCODE = +100                                  02223002
                       MOVE 'NOT FOUND'     TO PV-DUNS-NBR-X            02224002
001036             WHEN SQLCODE = -904                                  02230001
001037             WHEN SQLCODE = -911                                  02240001
001038             WHEN SQLCODE = -913                                  02250001
061300                 CONTINUE                                         02260001
061200             WHEN SQLWARN0 NOT EQUAL SPACE                        02300001
061300             WHEN SQLCODE NOT EQUAL ZERO                          02310001
061400                 DISPLAY '** ABEND **'                            02320001
061500                 DISPLAY '** PROGRAM = RVKUT013 **'               02330001
061600                 DISPLAY '** PARAGRAPH = **'                      02340001
061600                 DISPLAY '** 2100-FETCH-VENDOR-DUNS-NBR **'       02350002
118726                 MOVE 'FETCH INFO'    TO PV-ERROR-MSG             02360001
118726                 MOVE XLT00004-ENT-ID TO PV-ENT-ID                02362002
118726                 STRING '** VENDOR ENT ID ' DELIMITED BY SIZE     02363002
118726                        PV-ENT-ID-X         DELIMITED BY SIZE     02364002
118726                        ' **'               DELIMITED BY SIZE     02365002
118726                                    INTO PV-ERROR-MSG-2           02366002
118726                 MOVE 'TEXTENT'       TO PV-ABEND-TABLE-1         02370002
061700                 PERFORM 9200-SQL-ERROR                           02380001
061800         END-EVALUATE                                             02390001
001161     END-PERFORM.                                                 02400001
001163                                                                  02410001
001164     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          02420001
061400         DISPLAY '** ABEND **'                                    02430001
061500         DISPLAY '** PROGRAM = RVKUT013 **'                       02440001
061600         DISPLAY '** PARAGRAPH = **'                              02450001
061600         DISPLAY '** 2100-FETCH-VENDOR-DUNS-NBR **'               02460002
118726         MOVE 'FETCH INFO'      TO PV-ERROR-MSG                   02470001
118726         MOVE XLT00004-ENT-ID   TO PV-ENT-ID                      02470102
118726         STRING '** VENDOR ENT ID ' DELIMITED BY SIZE             02470202
118726                PV-ENT-ID-X         DELIMITED BY SIZE             02470302
118726                ' **'               DELIMITED BY SIZE             02470402
118726                              INTO PV-ERROR-MSG-2                 02470502
118726         MOVE 'TEXTENT'         TO PV-ABEND-TABLE-1               02480002
061700         PERFORM 9200-SQL-ERROR                                   02490001
001176     END-IF.                                                      02500001
001163                                                                  02510001
001163                                                                  02520001
026400******************************************************************02530001
026600* OPEN CURSOR                                                     02540001
026700******************************************************************02550001
060600 7000-OPEN-EXTRACT-CURSOR.                                        02560001
061000                                                                  02570001
000971     PERFORM                                                      02580001
000972         WITH TEST AFTER                                          02590001
000973         VARYING PV-RETRY-COUNT                                   02600001
000974         FROM 1 BY 1                                              02610001
000975         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 02620001
000976                   OR (SQLCODE = ZERO))                           02630001
060700         EXEC SQL                                                 02640001
060800              OPEN EXTRACT-CSR                                    02650001
060900         END-EXEC                                                 02660001
061000                                                                  02670001
061100         EVALUATE TRUE                                            02680001
061300             WHEN SQLCODE = +0                                    02690001
001036             WHEN SQLCODE = -904                                  02700001
001037             WHEN SQLCODE = -911                                  02710001
001038             WHEN SQLCODE = -913                                  02720001
061300                 CONTINUE                                         02730001
061200             WHEN SQLWARN0 NOT EQUAL SPACE                        02740001
061300             WHEN SQLCODE NOT EQUAL ZERO                          02750001
061400                 DISPLAY '** ABEND **'                            02760001
061500                 DISPLAY '** PROGRAM = RVKUT013 **'               02770001
061600                 DISPLAY '** PARAGRAPH = '                        02780001
                               '7000-OPEN-EXTRACT-CURSOR **'            02790001
118726                 MOVE 'OPEN CURSOR'   TO PV-ERROR-MSG             02800001
118726                 MOVE 'XLT_SKU'       TO PV-ABEND-TABLE-1         02810001
118726                 MOVE 'XLT_UPC'       TO PV-ABEND-TABLE-2         02820001
118726                 MOVE 'XLT_VND_STYL'  TO PV-ABEND-TABLE-3         02830001
061700                 PERFORM 9200-SQL-ERROR                           02840001
061800         END-EVALUATE                                             02850001
000997     END-PERFORM.                                                 02860001
000998                                                                  02870001
000999     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          02880001
061400         DISPLAY '** ABEND **'                                    02890001
061500         DISPLAY '** PROGRAM = RVKUT013 **'                       02900001
061600         DISPLAY '** PARAGRAPH = 7000-OPEN-EXTRACT-CURSOR **'     02910001
118726         MOVE 'OPEN CURSOR'           TO PV-ERROR-MSG             02920001
118726         MOVE 'XLT_SKU'               TO PV-ABEND-TABLE-1         02930001
118726         MOVE 'XLT_UPC'               TO PV-ABEND-TABLE-2         02930101
118726         MOVE 'XLT_VND_STYL'          TO PV-ABEND-TABLE-3         02930201
061700         PERFORM 9200-SQL-ERROR                                   02930301
001016     END-IF.                                                      02930401
001017                                                                  02930501
061900                                                                  02930601
062000******************************************************************02930701
062100* CLOSE CURSOR                                                    02930801
062200******************************************************************02930901
062300 7100-CLOSE-EXTRACT-CURSOR.                                       02931001
001023                                                                  02932001
001024     PERFORM                                                      02933001
001025         WITH TEST AFTER                                          02934001
001026         VARYING PV-RETRY-COUNT                                   02935001
001027         FROM 1 BY 1                                              02936001
001028         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 02937001
001029                   OR (SQLCODE = ZERO))                           02938001
062400         EXEC SQL                                                 02939001
062500             CLOSE EXTRACT-CSR                                    02940001
062600         END-EXEC                                                 02950001
062700                                                                  02960001
062800         EVALUATE TRUE                                            02970001
061300             WHEN SQLCODE = +0                                    02980001
001036             WHEN SQLCODE = -904                                  02990001
001037             WHEN SQLCODE = -911                                  03000001
001038             WHEN SQLCODE = -913                                  03010001
061300                 CONTINUE                                         03020001
062900             WHEN SQLWARN0 NOT EQUAL SPACE                        03030001
063000             WHEN SQLCODE NOT EQUAL ZERO                          03040001
063100             DISPLAY '** ABEND **'                                03050001
063200             DISPLAY '** PROGRAM = RVKUT013 **'                   03060001
063300             DISPLAY '** PARAGRAPH = '                            03070001
                           '7100-CLOSE-EXTRACT-CURSOR**'                03080001
118726             MOVE 'CLOSE CURSOR'      TO PV-ERROR-MSG             03090001
118726             MOVE 'XLT_SKU'           TO PV-ABEND-TABLE-1         03100001
118726             MOVE 'XLT_UPC'           TO PV-ABEND-TABLE-2         03110001
118726             MOVE 'XLT_VND_STYL'      TO PV-ABEND-TABLE-3         03120001
063400             PERFORM 9200-SQL-ERROR                               03130001
063500         END-EVALUATE                                             03140001
001050     END-PERFORM.                                                 03141001
001051                                                                  03142001
001052     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          03143001
063100         DISPLAY '** ABEND **'                                    03144001
063200         DISPLAY '** PROGRAM = RVKUT013 **'                       03145001
063300         DISPLAY '** PARAGRAPH = 7100-CLOSE-EXTRACT-CURSOR**'     03146001
118726         MOVE 'CLOSE CURSOR'          TO PV-ERROR-MSG             03147001
118726         MOVE 'XLT_SKU'               TO PV-ABEND-TABLE-1         03148001
118726         MOVE 'XLT_UPC'               TO PV-ABEND-TABLE-2         03149001
118726         MOVE 'XLT_VND_STYL'          TO PV-ABEND-TABLE-3         03149101
063400         PERFORM 9200-SQL-ERROR                                   03149201
001072     END-IF.                                                      03149301
001073                                                                  03149401
063600                                                                  03149501
063700******************************************************************03149601
063800*  FETCH CURSOR                                                   03149701
063900******************************************************************03149801
064000 7200-FETCH-EXTRACT-CURSOR.                                       03149901
063600                                                                  03150001
001078     PERFORM                                                      03160001
001079         WITH TEST AFTER                                          03170001
001080         VARYING PV-RETRY-COUNT                                   03180001
001081         FROM 1 BY 1                                              03190001
001082         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 03191001
001083                   OR (SQLCODE = ZERO) OR (SQLCODE = +100))       03192001
064100         EXEC SQL                                                 03193001
064200              FETCH EXTRACT-CSR                                   03194001
064400              INTO                                                03195001
                          :XLT00003-ITM-NBR                             03196004
                        , :XLT00003-SKU-NBR                             03198001
                        , :XLT00003-INNR-PK-QTY                         03199001
                        , :XLT00003-SKU-DESC                            03200001
                        , :XLT00003-KOHLS-SIZE-CDE                      03210001
                        , :XLT00003-SIZE-DESC                           03220001
                        , :XLT00003-NRF-CLOR-CDE                        03230001
                        , :XLT00003-CSTM-CLOR-DESC                      03231001
                        , :XLT00006-UPC-NBR                             03232001
                        , :XLT00004-DEPT-NBR                            03234001
                        , :XLT00004-SUB-CL-NBR                          03236001
                        , :XLT00004-VS-NBR                              03237001
                        , :XLT00004-ENT-ID                              03238001
065100         END-EXEC                                                 03241001
065200                                                                  03250001
065300         EVALUATE TRUE                                            03260001
065400             WHEN SQLCODE = ZERO                                  03270001
001036             WHEN SQLCODE = -904                                  03271001
001037             WHEN SQLCODE = -911                                  03272001
001038             WHEN SQLCODE = -913                                  03273001
065500                 CONTINUE                                         03274001
065600             WHEN SQLCODE = +100                                  03275001
065700                 SET PS-END-CSR       TO TRUE                     03276001
065800             WHEN SQLWARN0 NOT EQUAL SPACE                        03277001
065900             WHEN SQLCODE NOT EQUAL ZERO                          03278001
066000                 DISPLAY '** ABEND **'                            03279001
066100                 DISPLAY '** PROGRAM = RVKUT013 **'               03280001
066200                 DISPLAY '** PARAGRAPH = '                        03290001
                               '7200-FETCH-EXTRACT-CURSOR**'            03300001
118726                 MOVE 'FETCH CURSOR'  TO PV-ERROR-MSG             03310001
118726                 MOVE 'XLT_SKU'       TO PV-ABEND-TABLE-1         03320001
118726                 MOVE 'XLT_UPC'       TO PV-ABEND-TABLE-2         03330001
118726                 MOVE 'XLT_VND_STYL'  TO PV-ABEND-TABLE-3         03340001
066300                 PERFORM 9200-SQL-ERROR                           03350001
066400         END-EVALUATE                                             03360001
001161     END-PERFORM.                                                 03370001
001163                                                                  03380001
001164     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          03390001
066000         DISPLAY '** ABEND **'                                    03391001
066100         DISPLAY '** PROGRAM = RVKUT013 **'                       03392001
066200         DISPLAY '** PARAGRAPH = 7200-FETCH-EXTRACT-CURSOR**'     03393001
118726         MOVE 'FETCH CURSOR'          TO PV-ERROR-MSG             03394001
118726         MOVE 'XLT_SKU'               TO PV-ABEND-TABLE-1         03395001
118726         MOVE 'XLT_UPC'               TO PV-ABEND-TABLE-2         03396001
118726         MOVE 'XLT_VND_STYL'          TO PV-ABEND-TABLE-3         03397001
066300         PERFORM 9200-SQL-ERROR                                   03398001
001176     END-IF.                                                      03399001
001177                                                                  03399101
066500                                                                  03399201
044534******************************************************************03399301
044535*  ISSUE A DB2 COMMIT TO RELEASE THE READ LOCKS BEING HELD ON THE 03399401
044535*  TABLES.                                                        03399501
044536******************************************************************03399601
044537 7600-COMMIT-AND-RELEASE-LOCKS.                                   03399701
044538                                                                  03399801
044540     EXEC SQL                                                     03399901
044550          COMMIT                                                  03400001
044564     END-EXEC.                                                    03401001
044565                                                                  03402001
044566     EVALUATE TRUE                                                03403001
044567         WHEN SQLCODE = ZERO                                      03404001
044569             CONTINUE                                             03405001
044580         WHEN SQLWARN0 NOT = SPACES                               03406001
044581         WHEN SQLCODE < ZERO                                      03407001
044582         WHEN SQLCODE > ZERO                                      03408001
001103             DISPLAY '** ABEND **'                                03409001
001110             DISPLAY '** PROGRAM = RVKUT013 **'                   03409101
001120             DISPLAY '** PARAGRAPH = '                            03409201
001121                     '7600-COMMIT-AND-RELEASE-LOCKS **'           03409301
001130             MOVE 'FETCH CURSOR'      TO PV-ERROR-MSG             03409401
118726             MOVE 'XLT_SKU'           TO PV-ABEND-TABLE-1         03409501
118726             MOVE 'XLT_UPC'           TO PV-ABEND-TABLE-2         03409601
118726             MOVE 'XLT_VND_STYL'      TO PV-ABEND-TABLE-3         03409701
001150             PERFORM 9200-SQL-ERROR                               03409801
044590     END-EVALUATE.                                                03409901
044591                                                                  03410001
044592                                                                  03411001
051200***************************************************************** 03412001
051200*  WRITE OUTPUT FILE                                              03413001
051200***************************************************************** 03414001
050800 8000-WRITE-OUTPUT.                                               03415001
050900     WRITE RV-ITEM-RECORD FROM RV999-ITEM-RECORD.                 03416001
051000                                                                  03417001
051100     ADD 1                TO PV-RECS-WRITTEN.                     03418001
002800                                                                  03419001
051200***************************************************************** 03480901
051200*  END OF JOB PROCESSING                                          03481001
051200***************************************************************** 03482001
051400 9000-EOJ.                                                        03483001
020300     PERFORM 7100-CLOSE-EXTRACT-CURSOR.                           03484001
051800                                                                  03485001
051800     DISPLAY 'RECORDS WRITTEN ===>  ' PV-RECS-WRITTEN.            03486001
051800                                                                  03487001
051600     CLOSE RV-ITEM-FILE.                                          03490001
002800                                                                  03510001
052500                                                                  03520001
051200***************************************************************** 03530001
051200*  PARAGRAPH EXECUTED WHEN SERIOUS DB2 ERROR OCCURRED             03540001
051200***************************************************************** 03550001
052600 9200-SQL-ERROR.                                                  03560001
052700     CLOSE RV-ITEM-FILE.                                          03570001
052900                                                                  03590001
053000     MOVE SQLCODE                     TO SQLCODE2.                03600001
053100     MOVE SQLERRD(3)                  TO SQLERRD3.                03610001
053200                                                                  03620001
053300     DISPLAY '** ABEND **         ** = SQLERROR'.                 03630001
053400     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PGM-RVKUT013.        03640001
053500     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH.                   03650001
053600     DISPLAY '** OPERATION ** = ' PV-DB2-FUNCTION.                03660001
118726     DISPLAY '**           ** = ' PV-ABEND-TABLE-1.               03670001
118726     DISPLAY '**           ** = ' PV-ABEND-TABLE-2.               03680001
118726     DISPLAY '**           ** = ' PV-ABEND-TABLE-3.               03690001
053700     DISPLAY '**           ** = ' PV-ERROR-MSG                    03700001
053700     DISPLAY '**           ** = ' PV-ERROR-MSG-2                  03701002
053800                                                                  03710001
053900     DISPLAY '** SQLCODE          ** = ' SQLCODE2.                03720001
054000     DISPLAY '** ROWS PROCESSED   ** = ' SQLERRD3.                03730001
054100     DISPLAY '** SQLERRM          ** = ' SQLERRM.                 03740001
054200     DISPLAY '** SQLERRMC         ** = ' SQLERRMC.                03750001
054300                                                                  03760001
054400     COPY DPPD004.                                                03770001
054500                                                                  03780001
054600     MOVE +4013                       TO PV-ABEND-CODE.           03790001
054700     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         03800001
054800                                                                  03810001
054800*************  END OF RVKUT013  ********************************  03820001
