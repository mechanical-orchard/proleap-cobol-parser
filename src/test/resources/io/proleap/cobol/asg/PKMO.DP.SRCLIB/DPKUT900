000100 IDENTIFICATION DIVISION.                                         00010002
000200*                                                                 00020002
000300 PROGRAM-ID.         DPKUT900.                                    00030002
000400 AUTHOR.             J.FECHTER.                                   00040002
000500 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00050002
000600 DATE-WRITTEN.       10-20-89.                                    00060002
000700 DATE-COMPILED.                                                   00070002
000800                                                                  00080002
000900******************************************************************00090002
001000*  THIS PROGRAM PREPARES THE TRANSACTION FILE OF A DB2 MAINTEN-  *00100002
001100*  ANCE PROGRAM TO BE RUN UNDER THE DB2 CHECKPOINT RESTART SYS-  *00110002
001200*  TEM.  THE PROGRAM IS INVOKED BY A TRANSACTION PREPARATION     *00120002
001300*  PROGRAM WHICH IS WRITTEN FOR EACH DB2 MAINTENANCE PROGRAM.    *00130002
001400*                                                                *00140002
001500*  THE PROGRAMS PROCESSING IS CONTROLED BY FUNCTION CODES (OPEN, *00150002
001600*  WRITE & CLOSE) THAT ARE PASSED TO IT BY A TRANSACTION PREP-   *00160002
001700*  ARATION PROGRAM.                                              *00170002
001800*                                                                *00180002
001900*  AN OPEN FUNCTION CODE WILL VERIFY THAT THE JOB/PLAN THAT THE  *00190002
002000*  TRANSACTION FILE IS BEING PREPARED FOR IS DEFINED IN THE      *00200002
002100*  CHECKPOINT CONTROL TABLE (TCKRSTCNTL), SET THE CKPT_STAT-CODE *00210002
002200*  TO '1' (TRANSACTION PREPARATION PROCESS STARTED),INITIALIZE   *00220002
002300*  WORKING STORAGE, AND OPEN THE OUTPUT TRANSACTION PREPARATION  *00230002
002400*  FILE.                                                         *00240002
002500*                                                                *00250002
002600*  A WRITE FUNCTION CODE WILL ASSIGN A SEQUENCE NUMBER TO THE    *00260002
002700*  TRANSACTION BEING PREPARED, REFORMAT THE TRANSACTION DEPEND-  *00270002
002800*  ING ON HOW CHECKPOINTS ARE BEING TAKEN AND WRITE OUT THE      *00280002
002900*  REFORMATTED TRANSACTION RECORD.                               *00290002
003000*                                                                *00300002
003100*  A CLOSE FUNCTION CODE WILL CLOSE THE TRANSACTION PREPARATION  *00310002
003200*  FILE, SET THE CKPT_STAT_CODE TO '2' (TRANSACTION PREPARATION  *00320002
003300*  PROCESS COMPLETED) AND UPDATE OTHER STATISTICS PERTAINING TO  *00330002
003400*  THE TRANSACTION PREPARATION PROCESS IN THE CHECKPOINT CONTROL *00340002
003500*  RECORD.                                                       *00350002
003600*                                                                *00360002
003700*  DB2 TABLES:                                                   *00370002
003800*    - TCKRSTCNTL                                                *00380002
003900*                                                                *00390002
004000*  INPUT FILES:                                                  *00400002
004100*    - N/A                                                       *00410002
004200*                                                                *00420002
004300*  OUTPUT FILES:                                                 *00430002
004400*    - TRANSACTION PREPARATION FILE            DDNAME = OUT01    *00440002
004500******************************************************************00450002
004600 EJECT                                                            00460002
004700 ENVIRONMENT DIVISION.                                            00470002
004800*                                                                 00480002
004900 CONFIGURATION SECTION.                                           00490002
005000                                                                  00500002
005100 SOURCE-COMPUTER.    IBM-3090.                                    00510002
005200 OBJECT-COMPUTER.    IBM-3090.                                    00520002
005300                                                                  00530002
005400 INPUT-OUTPUT SECTION.                                            00540002
005500                                                                  00550002
005600 FILE-CONTROL.                                                    00560002
005700                                                                  00570002
005800     SELECT TRANS-PREP-FILE ASSIGN TO OUT01.                      00580002
005900                                                                  00590002
006000 EJECT                                                            00600002
006100 DATA DIVISION.                                                   00610002
006200*                                                                 00620002
006300 FILE SECTION.                                                    00630002
006400                                                                  00640002
006500 FD  TRANS-PREP-FILE                                              00650002
006600     LABEL RECORDS ARE OMITTED                                    00660002
006700     RECORDING MODE IS V                                          00670002
006800     BLOCK CONTAINS 0 RECORDS                                     00680002
006900     DATA RECORD IS DP010O-TRANS-PREP-RECORD.                     00690002
007000                                                                  00700002
007100     COPY DPRD010O.                                               00710002
007200  EJECT                                                           00720002
007300*                                                                 00730002
007400*                                                                 00740002
007500 WORKING-STORAGE SECTION.                                         00750002
007600                                                                  00760002
007700 01  ABEND-CODE                  PIC S9(04)     VALUE +0  COMP.   00770002
007800                                                                  00780002
007900 01  PROGRAM-ACCUMULATORS.                                        00790002
008000     05  PA-CONTENTION-LIMIT     PIC S9(05)     VALUE +3  COMP-3. 00800002
008100     05  PA-CKPT-CNTLS-COUNT     PIC S9(05)     VALUE +0  COMP-3. 00810002
008200     05  PA-NBR-TRANS-WRITTEN    PIC S9(09)     VALUE +0  COMP-3. 00820002
008300 EJECT                                                            00830002
008400 01  PROGRAM-VARIABLES.                                           00840002
008500     05  PV-SYSTEM-DATE.                                          00850002
008600         10  PV-SYSTEM-DATE-YY   PIC XX         VALUE SPACES.     00860002
008700         10  PV-SYSTEM-DATE-MM   PIC XX         VALUE SPACES.     00870002
008800         10  PV-SYSTEM-DATE-DD   PIC XX         VALUE SPACES.     00880002
008900     05  PV-SYSTEM-TIME.                                          00890002
009000         10  PV-SYSTEM-TIME-HH   PIC XX         VALUE SPACES.     00900002
009100         10  PV-SYSTEM-TIME-MM   PIC XX         VALUE SPACES.     00910002
009200         10  PV-SYSTEM-TIME-SS   PIC XX         VALUE SPACES.     00920002
009300         10  PV-SYSTEM-TIME-HUN  PIC XX         VALUE SPACES.     00930002
009400     05  PV-DATE-TIME.                                            00940002
009500         10  PV-DATE-STAMP.                                       00950002
009600             15  PV-DATE-STAMP-CC                                 00960002
009700                                 PIC X(02)      VALUE SPACES.     00970003
009710                 88  PV-DATE-STAMP-CC-19        VALUE '19'.       00971003
009720                 88  PV-DATE-STAMP-CC-20        VALUE '20'.       00972004
009800             15  PV-DATE-STAMP-YY                                 00980002
009900                                 PIC X(02)      VALUE SPACES.     00990002
010000             15  FILLER          PIC X(01)      VALUE '-'.        01000002
010100             15  PV-DATE-STAMP-MM                                 01010002
010200                                 PIC X(02)      VALUE SPACES.     01020002
010300             15  FILLER          PIC X(01)      VALUE '-'.        01030002
010400             15  PV-DATE-STAMP-DD                                 01040002
010500                                 PIC X(02)      VALUE SPACES.     01050002
010600         10  FILLER              PIC X(01)      VALUE '-'.        01060002
010700         10  PV-TIME-STAMP.                                       01070002
010800             15  PV-TIME-STAMP-HH                                 01080002
010900                                 PIC X(02)      VALUE SPACES.     01090002
011000             15  FILLER          PIC X(01)      VALUE '.'.        01100002
011100             15  PV-TIME-STAMP-MM                                 01110002
011200                                 PIC X(02)      VALUE SPACES.     01120002
011300             15  FILLER          PIC X(01)      VALUE '.'.        01130002
011400             15  PV-TIME-STAMP-SS                                 01140002
011500                                 PIC X(02)      VALUE SPACES.     01150002
011600             15  FILLER          PIC X(01)      VALUE '.'.        01160002
011700             15  PV-TIME-STAMP-HUN                                01170002
011800                                 PIC X(04)      VALUE ZERO.       01180002
011900     05  PV-DATE-TIME-STAMP REDEFINES PV-DATE-TIME                01190002
012000                                 PIC X(24).                       01200002
012100     05  PV-SQLCODE              PIC S9(9)      VALUE +0  COMP.   01210002
012200         88  SQLCODE-OK                         VALUE +0.         01220002
012300         88  JOB-PLAN-DOESNT-EXIST              VALUE +100.       01230002
012400         88  TABLE-CONTENTION                   VALUES ARE        01240002
012500                                                      -904        01250002
012600                                                      -911.       01260002
012700     05  PV-OPEN-REQUEST-VERIFIED-SW                              01270002
012800                                 PIC X(01)      VALUE 'N'.        01280002
012900         88  OPEN-REQUEST-VERIFIED              VALUE 'Y'.        01290002
013000     05  PV-DB2-CALL-COMPLETE-SW                                  01300002
013100                                 PIC X(01)      VALUE 'N'.        01310002
013200         88  DB2-CALL-COMPLETE                  VALUE 'Y'.        01320002
013300 EJECT                                                            01330002
013400 01  PROGRAM-CONSTANTS.                                           01340002
013410     05  PC-PIVOT-YEAR           PIC XX         VALUE '80'.       01341003
013500     05  PC-BAD-SQLCODE.                                          01350002
013600         10  PC-MSG-BAD-SQLCODE  PIC X(80)      VALUE             01360002
013700         'BAD SQLCODE RECEIVED                                    01370002
013800-        '                        '.                              01380002
013900         10  PC-RC-BAD-SQLCODE   PIC 9(04)      VALUE 4013.       01390002
014000                                                                  01400002
014100     05  PC-JOB-PLAN-DOESNT-EXIST.                                01410002
014200         10  PC-MSG-DOESNT-EXIST PIC X(80)      VALUE             01420002
014300         'CHECKPOINT CONTROLS ARE NOT DEFINED FOR THE THE JOB/PLAN01430002
014400-        ' REQUESTED              '.                              01440002
014500         10  PC-RC-DOESNT-EXIST  PIC 9(04)      VALUE 4021.       01450002
014600                                                                  01460002
014700     05  PC-INVALID-FUNCTION.                                     01470002
014800         10  PC-MSG-INVALID-FUNC                                  01480002
014900                                 PIC X(80)      VALUE             01490002
015000         'INVALID FUNCTION CODE - REQUEST CANNOT BE PROCESSED     01500002
015100-        '                        '.                              01510002
015200         10  PC-RC-INVALID-FUNC  PIC 9(04)      VALUE 4022.       01520002
015300                                                                  01530002
015400     05  PC-TRANS-PREP-FILE-EXISTS.                               01540002
015500         10  PC-MSG-TRAN-PREP-FILE-EXISTS                         01550002
015600                                 PIC X(80)      VALUE             01560002
015700         'TRANSACTION PREPARATION FILE ALREADY EXISTS FOR THIS JOB01570002
015800-        '/PLAN                   '.                              01580002
015900         10  PC-RC-TRAN-PREP-FILE-EXISTS                          01590002
016000                                 PIC 9(04)      VALUE 4023.       01600002
016100                                                                  01610002
016200     05  PC-CKPT-CNTLS-IN-USE.                                    01620002
016300         10  PC-MSG-CKPT-CNTLS-IN-USE                             01630002
016400                                 PIC X(80)      VALUE             01640002
016500         'CHECKPOINT CONTROLS FOR THIS JOB/PLAN ARE BEING UPDATED 01650002
016600-        'BY THE MAINT. SESSION   '.                              01660002
016700         10  PC-RC-CKPT-CNTLS-IN-USE                              01670002
016800                                 PIC 9(04)      VALUE 4024.       01680002
016900 EJECT                                                            01690002
017000*                                                                 01700002
017100*    DCLGEN OF CHECKPOINT RESTART CONTROL TABLE.                  01710002
017200*                                                                 01720002
017300     EXEC SQL                                                     01730002
017400         INCLUDE TCKRSTCN                                         01740002
017500     END-EXEC.                                                    01750002
017600 EJECT                                                            01760002
017700     EXEC SQL                                                     01770002
017800         INCLUDE SQLCA                                            01780002
017900     END-EXEC.                                                    01790002
018000 EJECT                                                            01800002
018100 LINKAGE SECTION.                                                 01810002
018200*                                                                 01820002
018300*    TRANSACITON PREPARATION MODULE LINKAGE SECTION.              01830002
018400*                                                                 01840002
018500     COPY DPLS000.                                                01850002
018600 EJECT                                                            01860002
018700 PROCEDURE DIVISION USING DP000-TRANS-PREP-PARAMETERS.            01870002
018800                                                                  01880002
018900                                                                  01890002
019000******************************************************************01900002
019100* A100-MAINLINE-PROCESSING                                       *01910002
019200*      CONTROLS FLOW OF THE PROGRAM.                             *01920002
019300******************************************************************01930002
019400 A100-MAINLINE-PROCESSING.                                        01940002
019500                                                                  01950002
019600     PERFORM B050-INITIALIZATION-ROUTINE.                         01960002
019700                                                                  01970002
019800     IF DP000-FUNC-CODE = 'OPEN'                                  01980002
019900         PERFORM B100-VERIFY-OPEN-REQUEST                         01990002
020000           UNTIL OPEN-REQUEST-VERIFIED                            02000002
020100     ELSE                                                         02010002
020200         IF DP000-FUNC-CODE = 'WRITE'                             02020002
020300             PERFORM B200-PROCESS-WRITE-REQUEST                   02030002
020400         ELSE                                                     02040002
020500             IF DP000-FUNC-CODE = 'CLOSE'                         02050002
020600                 PERFORM B300-PROCESS-CLOSE-REQUEST               02060002
020700             ELSE                                                 02070002
020800                 MOVE PC-MSG-INVALID-FUNC TO DP000-MESSAGE        02080002
020900                 MOVE PC-RC-INVALID-FUNC TO DP000-RET-CODE        02090002
021000             END-IF                                               02100002
021100         END-IF                                                   02110002
021200     END-IF.                                                      02120002
021300                                                                  02130002
021400     IF DP000-SQLCODE = ZERO                                      02140002
021500       OR DP000-SQLCODE = +100                                    02150002
021600       OR DP000-SQLCODE = -911                                    02160002
021700         CONTINUE                                                 02170002
021800     ELSE                                                         02180002
021900         PERFORM Z500-ROLLBACK                                    02190002
022000     END-IF.                                                      02200002
022100                                                                  02210002
022200     GOBACK.                                                      02220002
022300 EJECT                                                            02230002
022400******************************************************************02240002
022500* B050-INITIALIZATION-ROUTINE.                                   *02250002
022600*      INITIALIZE ALL WORKAREAS USED IN PROCESSING A REQUEST.    *02260002
022700*                                                                *02270002
022800*      PERFORMED BY A100-MAINLINE-PROCESSING.                    *02280002
022900******************************************************************02290002
023000                                                                  02300002
023100 B050-INITIALIZATION-ROUTINE.                                     02310002
023200                                                                  02320002
023300     MOVE +0 TO DP000-RET-CODE                                    02330002
023400                DP000-SQLCODE                                     02340002
023500                DP000-SQLERRD3                                    02350002
023600                PA-CKPT-CNTLS-COUNT.                              02360002
023700                                                                  02370002
023800     MOVE SPACES TO DP000-MESSAGE                                 02380002
023900                    DP000-SQLERRMC.                               02390002
024000                                                                  02400002
024100     MOVE 'N' TO PV-OPEN-REQUEST-VERIFIED-SW.                     02410002
024200 EJECT                                                            02420002
024300******************************************************************02430002
024400* B100-VERIFY-OPEN-REQUEST.                                      *02440002
024500*      DETERMINE IF THE CHECKPOINT CONTROLS EXIST IN THE CHECK-  *02450002
024600*      POINT CONTROL TABLE (TCKRSTCNTL) FOR THE JOB/PLAN RE-     *02460002
024700*      QUESTED.                                                  *02470002
024800*                                                                *02480002
024900*      PERFORMED BY A100-MAINLINE-PROCESSING.                    *02490002
025000******************************************************************02500002
025100                                                                  02510002
025200 B100-VERIFY-OPEN-REQUEST.                                        02520002
025300                                                                  02530002
025400     PERFORM Z100-DETERMINE-JOB-PLAN-EXISTS.                      02540002
025500                                                                  02550002
025600     MOVE SQLCODE TO PV-SQLCODE.                                  02560002
025700                                                                  02570002
025800     IF SQLCODE-OK                                                02580002
025900         MOVE 'Y' TO PV-OPEN-REQUEST-VERIFIED-SW                  02590002
026000         IF TCKRSTCNTL-CKPT-STAT-CODE = ('0' OR '4')              02600002
026100             PERFORM C100-PROCESS-OPEN-REQUEST                    02610002
026200         ELSE                                                     02620002
026300             PERFORM C200-SET-CKPT-STAT-ERROR-MSG                 02630002
026400         END-IF                                                   02640002
026500     ELSE                                                         02650002
026600         IF JOB-PLAN-DOESNT-EXIST                                 02660002
026700             MOVE PC-MSG-DOESNT-EXIST TO DP000-MESSAGE            02670002
026800             MOVE PC-RC-DOESNT-EXIST TO DP000-RET-CODE            02680002
026900             MOVE SQLCODE TO DP000-SQLCODE                        02690002
027000             MOVE SQLERRD(3) TO DP000-SQLERRD3                    02700002
027100             MOVE SQLERRMC TO DP000-SQLERRMC                      02710002
027200             MOVE 'Y' TO PV-OPEN-REQUEST-VERIFIED-SW              02720002
027300         ELSE                                                     02730002
027400             IF TABLE-CONTENTION                                  02740002
027500                 ADD +1 TO PA-CKPT-CNTLS-COUNT                    02750002
027600                 IF (PA-CKPT-CNTLS-COUNT > PA-CONTENTION-LIMIT)   02760002
027700                   OR (PA-CKPT-CNTLS-COUNT =                      02770002
027800                       PA-CONTENTION-LIMIT)                       02780002
027900                     MOVE PC-MSG-BAD-SQLCODE TO DP000-MESSAGE     02790002
028000                     MOVE PC-RC-BAD-SQLCODE TO DP000-RET-CODE     02800002
028100                     MOVE SQLCODE TO DP000-SQLCODE                02810002
028200                     MOVE SQLERRD(3) TO DP000-SQLERRD3            02820002
028300                     MOVE SQLERRMC TO DP000-SQLERRMC              02830002
028400                     MOVE 'Y' TO PV-OPEN-REQUEST-VERIFIED-SW      02840002
028500                 END-IF                                           02850002
028600             ELSE                                                 02860002
028700                 MOVE PC-MSG-BAD-SQLCODE TO DP000-MESSAGE         02870002
028800                 MOVE PC-RC-BAD-SQLCODE TO DP000-RET-CODE         02880002
028900                 MOVE SQLCODE TO DP000-SQLCODE                    02890002
029000                 MOVE SQLERRD(3) TO DP000-SQLERRD3                02900002
029100                 MOVE SQLERRMC TO DP000-SQLERRMC                  02910002
029200                 MOVE SQLWARN TO DP000-SQLWARN                    02920002
029300                 MOVE 'Y' TO PV-OPEN-REQUEST-VERIFIED-SW          02930002
029400             END-IF                                               02940002
029500         END-IF                                                   02950002
029600     END-IF.                                                      02960002
029700 EJECT                                                            02970002
029800******************************************************************02980002
029900* B200-PROCESS-WRITE-REQUEST.                                    *02990002
030000*      BUILD THE TRANSACTION PREPARATION RECORD FROM THE TRANS-  *03000002
030100*      ACTION RECORD PASSED IN THE LINKAGE SECTION AND WRITE OUT *03010002
030200*      THE RECORD.                                               *03020002
030300*                                                                *03030002
030400*      PERFORMED BY A100-MAINLINE-PROCESSING.                    *03040002
030500******************************************************************03050002
030600                                                                  03060002
030700 B200-PROCESS-WRITE-REQUEST.                                      03070002
030800                                                                  03080002
030900     ADD +1 TO PA-NBR-TRANS-WRITTEN.                              03090002
031000                                                                  03100002
031100     MOVE PA-NBR-TRANS-WRITTEN TO DP010O-TRANS-SEQ-NMBR.          03110002
031200                                                                  03120002
031300     MOVE DP000-CHECKPOINT-IND TO DP010O-CHECKPOINT-IND.          03130002
031400                                                                  03140002
031500     MOVE DP000-TRANS-REC-LENGTH TO DP010O-TRANS-REC-LENGTH.      03150002
031600                                                                  03160002
031700     MOVE DP000-TRANS-REC TO DP010O-TRANS-REC.                    03170002
031800                                                                  03180002
031900     WRITE DP010O-TRANS-PREP-RECORD.                              03190002
032000 EJECT                                                            03200002
032100******************************************************************03210002
032200* B300-PROCESS-CLOSE-REQUEST.                                    *03220002
032300*      CLOSE THE TRANSACTION PREPARATION FILE AND UPDATE THE     *03230002
032400*      CHECKPOINT CONTROL RECORD FOR THE JOB/PLAN INDICATING     *03240002
032500*      THAT THE TRANSACTION PREPARATION PROCESS IS COMPLETED,    *03250002
032600*      STORE THE NUMBER OF TRANSACTIONS ON THE TRANSACTION FILE  *03260002
032700*      PREPARED AND THE DATE/TIME THAT THE FILE WAS PREPARED.    *03270002
032800*                                                                *03280002
032900*      PERFORMED BY A100-MAINLINE-PROCESSING.                    *03290002
033000******************************************************************03300002
033100                                                                  03310002
033200 B300-PROCESS-CLOSE-REQUEST.                                      03320002
033300                                                                  03330002
033400     CLOSE TRANS-PREP-FILE.                                       03340002
033500                                                                  03350002
033600     ACCEPT PV-SYSTEM-DATE FROM DATE.                             03360002
033700     MOVE PV-SYSTEM-DATE-YY TO PV-DATE-STAMP-YY.                  03370002
033800     MOVE PV-SYSTEM-DATE-MM TO PV-DATE-STAMP-MM.                  03380002
033900     MOVE PV-SYSTEM-DATE-DD TO PV-DATE-STAMP-DD.                  03390002
033910     IF PV-DATE-STAMP-YY > PC-PIVOT-YEAR                          03391003
033920         SET PV-DATE-STAMP-CC-19 TO TRUE                          03392003
033930     ELSE                                                         03393003
033940         SET PV-DATE-STAMP-CC-20 TO TRUE                          03394003
033950     END-IF.                                                      03395003
034000                                                                  03400002
034100     ACCEPT PV-SYSTEM-TIME FROM TIME.                             03410002
034200     MOVE PV-SYSTEM-TIME-HH TO PV-TIME-STAMP-HH.                  03420002
034300     MOVE PV-SYSTEM-TIME-MM TO PV-TIME-STAMP-MM.                  03430002
034400     MOVE PV-SYSTEM-TIME-SS TO PV-TIME-STAMP-SS.                  03440002
034500     MOVE PV-SYSTEM-TIME-HUN TO PV-TIME-STAMP-HUN.                03450002
034600                                                                  03460002
034700     MOVE 'N' TO PV-DB2-CALL-COMPLETE-SW.                         03470002
034800                                                                  03480002
034900     PERFORM Z300-UPDATE-CKPT-CNTLS                               03490002
035000         UNTIL DB2-CALL-COMPLETE.                                 03500002
035100                                                                  03510002
035200     IF SQLCODE-OK                                                03520002
035300         PERFORM Z400-COMMIT-UPDATES                              03530002
035400     END-IF.                                                      03540002
035500                                                                  03550002
035600 EJECT                                                            03560002
035700******************************************************************03570002
035800* C100-PROCESS-OPEN-REQUEST.                                     *03580002
035900*      SET THE CHECKPOINT CONTROL STATUS TO 'PREPARATION PROCESS *03590002
036000*      STARTED' AND OPEN THE OUTPUT TRANSACTION PREPARATION FILE.*03600002
036100*                                                                *03610002
036200*      PERFORMED BY B100-VERIFY-OPEN-REQUEST.                    *03620002
036300******************************************************************03630002
036400                                                                  03640002
036500 C100-PROCESS-OPEN-REQUEST.                                       03650002
036600                                                                  03660002
036700     MOVE 'N' TO PV-DB2-CALL-COMPLETE-SW.                         03670002
036800                                                                  03680002
036900     PERFORM Z200-UPDATE-CKPT-CNTL-STATUS                         03690002
037000         UNTIL DB2-CALL-COMPLETE.                                 03700002
037100                                                                  03710002
037200     IF SQLCODE-OK                                                03720002
037300         PERFORM Z400-COMMIT-UPDATES                              03730002
037400         IF SQLCODE-OK                                            03740002
037500             OPEN OUTPUT TRANS-PREP-FILE                          03750002
037600             IF TCKRSTCNTL-CKPT-CNTL-CODE = 'A'                   03760002
037700                 MOVE TCKRSTCNTL-CKPT-TYPE-CODE TO                03770002
037800                     DP000-CKPT-TYPE-CODE                         03780002
037900             ELSE                                                 03790002
038000                 MOVE TCKRSTCNTL-CKPT-CNTL-CODE TO                03800002
038100                     DP000-CKPT-TYPE-CODE                         03810002
038200             END-IF                                               03820002
038300         END-IF                                                   03830002
038400     END-IF.                                                      03840002
038500 EJECT                                                            03850002
038600******************************************************************03860002
038700* C200-SET-CKPT-STAT-ERROR-MSG.                                  *03870002
038800*      SET AN APPROPRIATE ERROR MESSAGE INDICATING THE STATUS OF *03880002
038900*      THE CHECKPOINT CONTROL RECORD.                            *03890002
039000*                                                                *03900002
039100*      PERFORMED BY B100-VERIFY-OPEN-REQUEST.                    *03910002
039200******************************************************************03920002
039300                                                                  03930002
039400 C200-SET-CKPT-STAT-ERROR-MSG.                                    03940002
039500                                                                  03950002
039600     IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           03960002
039700         MOVE PC-MSG-CKPT-CNTLS-IN-USE TO DP000-MESSAGE           03970002
039800         MOVE PC-RC-CKPT-CNTLS-IN-USE TO DP000-RET-CODE           03980002
039900     ELSE                                                         03990002
040000         MOVE PC-MSG-TRAN-PREP-FILE-EXISTS TO DP000-MESSAGE       04000002
040100         MOVE PC-RC-TRAN-PREP-FILE-EXISTS TO DP000-RET-CODE       04010002
040200     END-IF.                                                      04020002
040300 EJECT                                                            04030002
040400******************************************************************04040002
040500* Z100-DETERMINE-JOB-PLAN-EXISTS.                                *04050002
040600*      RETRIEVES THE CHECKPOINT STATUS CODE AND CHECKPOINT TYPE  *04060002
040700*      FOR THE JOB/PLAN REQUESTED.                               *04070002
040800*                                                                *04080002
040900*      PERFORMED BY B100-VERIFY-OPEN-REQUEST.                    *04090002
041000******************************************************************04100002
041100                                                                  04110002
041200 Z100-DETERMINE-JOB-PLAN-EXISTS.                                  04120002
041300                                                                  04130002
041400     EXEC SQL                                                     04140002
041500         SELECT CKPT_STAT_CODE,                                   04150002
041600                CKPT_CNTL_CODE,                                   04160002
041700                CKPT_TYPE_CODE                                    04170002
041800           INTO :TCKRSTCNTL-CKPT-STAT-CODE,                       04180002
041900                :TCKRSTCNTL-CKPT-CNTL-CODE,                       04190002
042000                :TCKRSTCNTL-CKPT-TYPE-CODE                        04200002
042100           FROM TCKRSTCNTL                                        04210002
042200          WHERE JOB_NAME = :DP000-JOB-NAME                        04220002
042300            AND PLAN_NAME = :DP000-PLAN-NAME                      04230002
042400     END-EXEC.                                                    04240002
042500 EJECT                                                            04250002
042600******************************************************************04260002
042700* Z200-UPDATE-CKPT-CNTL-STATUS.                                  *04270002
042800*      UPDATE THE CHECKPOINT CONTROLS STATUS CODE.                04280002
042900*                                                                *04290002
043000*      PERFORMED BY B200-PROCESS-OPEN-REQUEST.                   *04300002
043100******************************************************************04310002
043200                                                                  04320002
043300 Z200-UPDATE-CKPT-CNTL-STATUS.                                    04330002
043400                                                                  04340002
043500     EXEC SQL                                                     04350002
043600         UPDATE TCKRSTCNTL                                        04360002
043700            SET CKPT_STAT_CODE = '1'                              04370002
043800          WHERE JOB_NAME = :DP000-JOB-NAME                        04380002
043900            AND PLAN_NAME = :DP000-PLAN-NAME                      04390002
044000     END-EXEC.                                                    04400002
044100                                                                  04410002
044200     MOVE SQLCODE TO PV-SQLCODE.                                  04420002
044300                                                                  04430002
044400     IF SQLCODE-OK                                                04440002
044500         MOVE 'Y' TO PV-DB2-CALL-COMPLETE-SW                      04450002
044600     ELSE                                                         04460002
044700         IF TABLE-CONTENTION                                      04470002
044800             ADD +1 TO PA-CKPT-CNTLS-COUNT                        04480002
044900             IF PA-CKPT-CNTLS-COUNT > PA-CONTENTION-LIMIT         04490002
045000               OR PA-CKPT-CNTLS-COUNT = PA-CONTENTION-LIMIT       04500002
045100                 MOVE PC-MSG-BAD-SQLCODE TO DP000-MESSAGE         04510002
045200                 MOVE PC-RC-BAD-SQLCODE TO DP000-RET-CODE         04520002
045300                 MOVE SQLCODE TO DP000-SQLCODE                    04530002
045400                 MOVE SQLWARN TO DP000-SQLWARN                    04540002
045500                 MOVE SQLERRD(3) TO DP000-SQLERRD3                04550002
045600                 MOVE SQLERRMC TO DP000-SQLERRMC                  04560002
045700                 MOVE 'Y' TO PV-DB2-CALL-COMPLETE-SW              04570002
045800             END-IF                                               04580002
045900         ELSE                                                     04590002
046000             MOVE PC-MSG-BAD-SQLCODE TO DP000-MESSAGE             04600002
046100             MOVE PC-RC-BAD-SQLCODE TO DP000-RET-CODE             04610002
046200             MOVE SQLCODE TO DP000-SQLCODE                        04620002
046300             MOVE SQLWARN TO DP000-SQLWARN                        04630002
046400             MOVE SQLERRD(3) TO DP000-SQLERRD3                    04640002
046500             MOVE SQLERRMC TO DP000-SQLERRMC                      04650002
046600             MOVE 'Y' TO PV-DB2-CALL-COMPLETE-SW                  04660002
046700         END-IF                                                   04670002
046800     END-IF.                                                      04680002
046900 EJECT                                                            04690002
047000******************************************************************04700002
047100* Z300-UPDATE-CKPT-CNTLS.                                        *04710002
047200*      UPDATE THE CHECKPOINT CONTROLS RECORD FOR THE JOB/PLAN.   *04720002
047300*                                                                *04730002
047400*      PERFORMED BY B300-PROCESS-CLOSE-REQUEST.                  *04740002
047500******************************************************************04750002
047600                                                                  04760002
047700 Z300-UPDATE-CKPT-CNTLS.                                          04770002
047800                                                                  04780002
047900     EXEC SQL                                                     04790002
048000         UPDATE TCKRSTCNTL                                        04800002
048100            SET  CKPT_STAT_CODE = '2'                             04810002
048200                ,TRANS_QTY = :PA-NBR-TRANS-WRITTEN                04820002
048300                ,PREP_TMESTP = :PV-DATE-TIME-STAMP                04830002
048400          WHERE JOB_NAME = :DP000-JOB-NAME                        04840002
048500            AND PLAN_NAME = :DP000-PLAN-NAME                      04850002
048600     END-EXEC.                                                    04860002
048700                                                                  04870002
048800     MOVE SQLCODE TO PV-SQLCODE.                                  04880002
048900                                                                  04890002
049000     IF SQLCODE-OK                                                04900002
049100         MOVE 'Y' TO PV-DB2-CALL-COMPLETE-SW                      04910002
049200     ELSE                                                         04920002
049300         IF TABLE-CONTENTION                                      04930002
049400             ADD +1 TO PA-CKPT-CNTLS-COUNT                        04940002
049500             IF (PA-CKPT-CNTLS-COUNT > PA-CONTENTION-LIMIT        04950002
049600               OR PA-CKPT-CNTLS-COUNT = PA-CONTENTION-LIMIT)      04960002
049700                 MOVE PC-MSG-BAD-SQLCODE TO DP000-MESSAGE         04970002
049800                 MOVE PC-RC-BAD-SQLCODE TO DP000-RET-CODE         04980002
049900                 MOVE SQLCODE TO DP000-SQLCODE                    04990002
050000                 MOVE SQLWARN TO DP000-SQLWARN                    05000002
050100                 MOVE SQLERRD(3) TO DP000-SQLERRD3                05010002
050200                 MOVE SQLERRMC TO DP000-SQLERRMC                  05020002
050300                 MOVE 'Y' TO PV-DB2-CALL-COMPLETE-SW              05030002
050400             END-IF                                               05040002
050500         ELSE                                                     05050002
050600             MOVE PC-MSG-BAD-SQLCODE TO DP000-MESSAGE             05060002
050700             MOVE PC-RC-BAD-SQLCODE TO DP000-RET-CODE             05070002
050800             MOVE SQLCODE TO DP000-SQLCODE                        05080002
050900             MOVE SQLWARN TO DP000-SQLWARN                        05090002
051000             MOVE SQLERRD(3) TO DP000-SQLERRD3                    05100002
051100             MOVE SQLERRMC TO DP000-SQLERRMC                      05110002
051200             MOVE 'Y' TO PV-DB2-CALL-COMPLETE-SW                  05120002
051300         END-IF                                                   05130002
051400     END-IF.                                                      05140002
051500 EJECT                                                            05150002
051600******************************************************************05160002
051700* Z400-COMMIT-UPDATES.                                           *05170002
051800*      COMMIT THE UPDATES TO THE CHECKPOINT CONTROL TABLE.       *05180002
051900*                                                                *05190002
052000*      PERFORMED BY B200-PROCESS-UPDATE-REQUEST.                 *05200002
052100*      PERFORMED BY B300-PROCESS-CLOSE-REQUEST.                  *05210002
052200******************************************************************05220002
052300                                                                  05230002
052400 Z400-COMMIT-UPDATES.                                             05240002
052500                                                                  05250002
052600     EXEC SQL                                                     05260002
052700         COMMIT                                                   05270002
052800     END-EXEC.                                                    05280002
052900                                                                  05290002
053000     MOVE SQLCODE TO PV-SQLCODE.                                  05300002
053100                                                                  05310002
053200     IF SQLCODE-OK                                                05320002
053300         CONTINUE                                                 05330002
053400     ELSE                                                         05340002
053500         MOVE PC-MSG-BAD-SQLCODE TO DP000-MESSAGE                 05350002
053600         MOVE PC-RC-BAD-SQLCODE TO DP000-RET-CODE                 05360002
053700         MOVE SQLCODE TO DP000-SQLCODE                            05370002
053800         MOVE SQLWARN TO DP000-SQLWARN                            05380002
053900         MOVE SQLERRD(3) TO DP000-SQLERRD3                        05390002
054000         MOVE SQLERRMC TO DP000-SQLERRMC                          05400002
054100     END-IF.                                                      05410002
054200 EJECT                                                            05420002
054300******************************************************************05430002
054400* Z500-ROLLBACK.                                                 *05440002
054500*      ROLLBACK ANY UPDATES SINCE THE LAST COMMIT IF A           *05450002
054600*      BAD SQLCODE IS RETURNED ON ANY DB2 CALL.                  *05460002
054700*                                                                *05470002
054800*      PERFORMED BY A100--MAINLINE-PROCESSING.                   *05480002
054900******************************************************************05490002
055000                                                                  05500002
055100 Z500-ROLLBACK.                                                   05510002
055200                                                                  05520002
055300     EXEC SQL                                                     05530002
055400         ROLLBACK                                                 05540002
055500     END-EXEC.                                                    05550002
