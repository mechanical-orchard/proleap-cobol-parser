000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400                                                                  00040000
000500 PROGRAM-ID.    AHKUP074.                                         00050000
000600 AUTHOR.        DENISE HAHN.                                      00060000
000700 INSTALLATION.  KOHLS.                                            00070000
000800 DATE-WRITTEN   APRIL, 2020.                                      00080000
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100******************************************************************00110000
001200*  THIS PROGRAM DELETES ALL ROWS FROM RCT_TRLR_UNLD TABLE AND    *00120000
001300*  CASCADE DELETE TO RCT_RCVR_TRLR_LST. THE EXTRACT FILE IS      *00130000
001400*  CREATED BY AHKUT073 FOR WEEKLY PURGE TO CHECK IF ANY TRIPS    *00140000
001410*  WERE PURGED FROM TVHTRIP AND NOT THESE TABLES.  THE EXTRACT   *00141000
001420*  IS ALSO CREATED AS PART OF THE REGULAR PURGE BY AHKUT606.     *00142000
001500******************************************************************00150000
001600                                                                  00160000
001700******************************************************************00170000
001800 ENVIRONMENT DIVISION.                                            00180000
001900******************************************************************00190000
002000                                                                  00200000
002100 CONFIGURATION SECTION.                                           00210000
002200                                                                  00220000
002300 SOURCE-COMPUTER.        IBM-3090.                                00230000
002400 OBJECT-COMPUTER.        IBM-3090.                                00240000
002500                                                                  00250000
002600 INPUT-OUTPUT SECTION.                                            00260000
002700                                                                  00270000
002800 FILE-CONTROL.                                                    00280000
002900                                                                  00290000
003000     SELECT RCT00014-FILE                                         00300000
003100         ASSIGN TO INP01.                                         00310000
003200                                                                  00320000
003300******************************************************************00330000
003400 DATA DIVISION.                                                   00340000
003500******************************************************************00350000
003600                                                                  00360000
003700 FILE SECTION.                                                    00370000
003800                                                                  00380000
003900 FD  RCT00014-FILE                                                00390000
004000     RECORDING MODE IS F                                          00400000
004100     LABEL RECORDS ARE STANDARD                                   00410000
004200     BLOCK CONTAINS 0 RECORDS.                                    00420000
004300                                                                  00430000
004400 01  RCT00014-RECORD            PIC  X(101).                      00440000
004500                                                                  00450000
004600                                                                  00460000
004700******************************************************************00470000
004800 WORKING-STORAGE SECTION.                                         00480000
004900******************************************************************00490000
005000                                                                  00500000
005100                                                                  00510000
005200******************************************************************00520000
005300** DB2 FORMATTED MESSAGE AREA                                   **00530000
005400******************************************************************00540000
005500     COPY DPWS004.                                                00550000
005600                                                                  00560000
005700                                                                  00570000
005800******************************************************************00580000
005900** COMMUNICATIONS AREA FOR DB2                                  **00590000
006000******************************************************************00600000
006100     EXEC SQL                                                     00610000
006200          INCLUDE SQLCA                                           00620000
006300     END-EXEC.                                                    00630000
006400                                                                  00640000
006500                                                                  00650000
006600******************************************************************00660000
006700** RCT_TRLR_UNLD                                                **00670000
006800******************************************************************00680000
006900     EXEC SQL                                                     00690000
007000          INCLUDE RCT00014                                        00700000
007100     END-EXEC.                                                    00710000
007200                                                                  00720000
007300                                                                  00730000
007301******************************************************************00730103
007302** RCT_RCVR_TRLR_LST                                            **00730203
007303******************************************************************00730303
007304     EXEC SQL                                                     00730403
007305          INCLUDE RCT00016                                        00730503
007306     END-EXEC.                                                    00730603
007307                                                                  00730703
007308                                                                  00730803
007310******************************************************************00731000
007320** TVEHICL                                                      **00732000
007330******************************************************************00733000
007340     EXEC SQL                                                     00734000
007350          INCLUDE TVEHICL                                         00735000
007360     END-EXEC.                                                    00736000
007370                                                                  00737000
007380                                                                  00738000
007400 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00740000
007500                                                   COMP SYNC.     00750000
007600                                                                  00760000
007700 01  PS-PROGRAM-SWITCHES.                                         00770000
007800     05  PS-EOF-RCT00014-FILE-SW     PIC  X(01)    VALUE 'N'.     00780000
007900         88  PS-EOF-RCT00014-FILE                  VALUE 'Y'.     00790000
008000         88  PS-NOT-EOF-RCT00014-FILE              VALUE 'N'.     00800000
008010     05  PS-RCT00014-CSR-END-SW      PIC  X(01)    VALUE 'N'.     00801006
008020         88  PS-RCT00014-CSR-END                   VALUE 'Y'.     00802006
008030         88  PS-RCT00014-CSR-END-NO                VALUE 'N'.     00803006
008100                                                                  00810000
008110 01  DK-DB2-KEYS.                                                 00811004
008120     05  DK-TRIP-ID                  PIC  S9(9) COMP.             00812005
008200                                                                  00820000
008300 01  PC-PROGRAM-CONSTANTS.                                        00830000
008400     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00840000
008500         'AHKUP074'.                                              00850000
008600     05  PC-MAX-RETRIES              PIC S9(04)    VALUE +3       00860000
008700                                                   COMP SYNC.     00870000
008800                                                                  00880000
008900 01  PV-PROGRAM-VARIABLES.                                        00890000
009000     05  PV-SQLERRD3                 PIC S9(09)    VALUE ZERO     00900000
009100                                                   COMP-3.        00910000
009200     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  00920000
009300     05  PV-DB2-TABLE-NAME-1         PIC  X(30)    VALUE SPACES.  00930000
009400     05  PV-DB2-TABLE-NAME-2         PIC  X(30)    VALUE SPACES.  00940000
009500     05  PV-DB2-OPERATION-MSG-1      PIC  X(50)    VALUE SPACES.  00950003
009510     05  PV-DB2-OPERATION-MSG-2      PIC  X(50)    VALUE SPACES.  00951003
009600     05  PV-RETRY-COUNTER            PIC S9(04)    VALUE ZERO     00960000
009700                                                   COMP SYNC.     00970000
009800     05  PV-INPUT-COUNTER            PIC S9(09)    VALUE ZERO     00980000
009900                                                   COMP-3.        00990000
009910     05  PV-DISPLAY-COUNTER          PIC S9(09)    VALUE ZERO     00991013
009920                                                   COMP-3.        00992013
010000     05  PV-DELETE-COUNTER           PIC S9(09)    VALUE ZERO     01000000
010001                                                   COMP-3.        01000103
010010     05  PV-RCT00016-DELETE          PIC S9(09)    VALUE ZERO     01001003
010110                                                   COMP-3.        01011003
010200     05  PV-COMMIT-COUNTER           PIC S9(09)    VALUE ZERO     01020000
010300                                                   COMP-3.        01030000
010400     05  PV-COMMIT-COUNT             PIC S9(09)    VALUE ZERO     01040000
010500                                                   COMP-3.        01050000
010600     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             01060000
010610     05  PV-DISP-TRIP                PIC Z(09).                   01061006
010620     05  PV-DISP-COUNT               PIC Z(09).                   01062013
010700                                                                  01070000
010800     05  PV-DB2-COUNT                PIC S9(09)    VALUE ZERO     01080000
010900                                                   COMP-3.        01090000
011000     05  PV-OPER-UNT-ID              PIC 9(04)     VALUE ZERO.    01100000
011100     05  PV-RECV-SEQ-NBR             PIC 9(03)     VALUE ZERO.    01110000
011200     05  PV-PO-NBR                   PIC S9(08)    VALUE ZERO.    01120000
011300     05  PV-PO-LNE-NBR               PIC 9(03)     VALUE ZERO.    01130000
011400     05  PV-CURRENT-TIMESTAMP        PIC X(26)     VALUE SPACES.  01140000
011500     05  PV-COMMIT-TIME-AND-TRIP.                                 01150001
011600         10  FILLER                  PIC X(09)     VALUE          01160001
011700         'TRIP ID: '.                                             01170001
011800         10  PV-COMMIT-TRIP-ID       PIC 9(08)     VALUE ZEROS.   01180001
012300         10  FILLER                  PIC X(20)     VALUE          01230000
012400         '      COMMIT COUNT: '.                                  01240000
012500         10  PV-TRIPS                PIC ZZZ,ZZZ,ZZZ.             01250012
012501         10  FILLER                  PIC X(05)     VALUE          01250112
012502         '     '.                                                 01250212
012503         10  PV-RCT00014-DELETED     PIC ZZZ,ZZZ,ZZZ.             01250312
012504         10  FILLER                  PIC X(05)     VALUE          01250412
012505         '     '.                                                 01250512
012510         10  PV-RCT00016-DELETED     PIC ZZZ,ZZZ,ZZZ.             01251003
013000                                                                  01300000
013001                                                                  01300103
013010*---------------------------------------------------------------* 01301003
013020*    DEFINE CURSOR FOR RCT_TRLR_UNLD ENTRIES FOR THE TRIP THAT  * 01302003
013030*    WAS PREVIOUSLY PURGED                                      * 01303003
013040*---------------------------------------------------------------* 01304003
013050     EXEC SQL                                                     01305003
013060         DECLARE TABLE-CURSOR CURSOR FOR                          01306003
013070           SELECT CRE_TMST                                        01307003
013071                 ,CRE_BY_USR_ID                                   01307103
013080             FROM RCT_TRLR_UNLD                                   01308015
013090            WHERE TRIP_ID = :DK-TRIP-ID                           01309003
013094             WITH UR                                              01309403
013095     END-EXEC.                                                    01309503
013097                                                                  01309703
013100                                                                  01310000
013200******************************************************************01320000
013300 PROCEDURE DIVISION.                                              01330000
013400******************************************************************01340000
013500                                                                  01350000
013600******************************************************************01360000
013700* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     01370000
013800*      PROGRAM.                                                   01380000
013900******************************************************************01390000
014000 0000-PROGRAM-MAINLINE.                                           01400000
014100                                                                  01410000
014200     PERFORM 1000-INITIALIZE.                                     01420000
014300                                                                  01430000
014400     SET PS-NOT-EOF-RCT00014-FILE TO TRUE.                        01440000
014500     PERFORM 7000-READ-RCT00014-FILE.                             01450000
014600                                                                  01460000
014700     PERFORM 2000-PROCESS-RCT00014-RECORDS                        01470000
014800        UNTIL PS-EOF-RCT00014-FILE.                               01480000
014900                                                                  01490000
015000     CLOSE RCT00014-FILE.                                         01500000
015100                                                                  01510000
015200     MOVE PV-INPUT-COUNTER TO PV-DISPLAY-COUNT.                   01520000
015300     DISPLAY 'TOTAL TRIPS................: ' PV-DISPLAY-COUNT.    01530007
015400                                                                  01540000
015500     MOVE PV-DELETE-COUNTER TO PV-DISPLAY-COUNT.                  01550000
015600     DISPLAY 'TOTAL RCT00014 ROWS DELETED: ' PV-DISPLAY-COUNT.    01560000
015700                                                                  01570000
015710     MOVE PV-RCT00016-DELETE TO PV-DISPLAY-COUNT.                 01571007
015720     DISPLAY 'TOTAL RCT00016 ROWS DELETED: ' PV-DISPLAY-COUNT.    01572007
015730                                                                  01573007
015800     MOVE PV-COMMIT-COUNT        TO PV-DISPLAY-COUNT.             01580000
015900     DISPLAY 'TOTAL COMMITS TAKEN: ' PV-DISPLAY-COUNT.            01590000
016000                                                                  01600000
016100     STOP RUN.                                                    01610000
016200                                                                  01620000
016300                                                                  01630000
016400******************************************************************01640000
016500*                                                                 01650000
016600******************************************************************01660000
016700 1000-INITIALIZE.                                                 01670000
016710                                                                  01671009
016720***  DISPLAY ' 1000-INITIALIZE'.                                  01672011
016800                                                                  01680000
016900     INITIALIZE PV-INPUT-COUNTER                                  01690000
017000                PV-DELETE-COUNTER                                 01700000
017100                PV-COMMIT-COUNTER                                 01710000
017200                PV-COMMIT-COUNT.                                  01720000
017300                                                                  01730000
017400     OPEN INPUT RCT00014-FILE.                                    01740000
017500                                                                  01750000
017600                                                                  01760000
017700******************************************************************01770000
017800*  PROCESS THE RCT_TRLR_UNLD ROWS THAT ARE IN THE EXTRACT FILE.   01780000
017900*  DELETE THE ROW FROM THE RCT_TRLR_UNLD TABLE.                   01790000
018000******************************************************************01800000
018100 2000-PROCESS-RCT00014-RECORDS.                                   01810000
018110                                                                  01811009
018120***  DISPLAY ' 2000-PROCESS-RCT00014-RECORDS'.                    01812011
018200                                                                  01820000
018300     ADD +1 TO PV-INPUT-COUNTER                                   01830013
018310               PV-DISPLAY-COUNTER.                                01831013
018400                                                                  01840000
018401     IF  PV-DISPLAY-COUNTER > 99                                  01840113
018402         MOVE PV-INPUT-COUNTER    TO PV-DISP-COUNT                01840213
018403         MOVE VEHICL-CURR-TRIP-ID TO PV-DISP-TRIP                 01840313
018405         DISPLAY ' TRIP: '     PV-DISP-TRIP                       01840513
018406                 '   INPUT: '  PV-DISP-COUNT                      01840614
018407         MOVE ZEROES TO PV-DISPLAY-COUNTER                        01840713
018408     END-IF.                                                      01840813
018409                                                                  01840913
018410     PERFORM 2500-PROCESS-TRIP                                    01841003
018600                                                                  01860000
018700     IF PV-COMMIT-COUNTER   > 1000                                01870000
018800         PERFORM 2200-COMMIT-CHANGES                              01880000
018900         MOVE 0     TO PV-COMMIT-COUNTER                          01890000
019000     END-IF.                                                      01900000
019100                                                                  01910000
019200     PERFORM 7000-READ-RCT00014-FILE.                             01920000
019300                                                                  01930000
019400                                                                  01940000
019500******************************************************************01950000
019600*  DELETE THE CURRENT ROW FROM THE RCT_TRLR_UNLD TABLE.           01960000
019700*  IF THE RCT_TRLR_UNLD ROW IS NOT FOUND, THAT IS OK.             01970000
019800*  THIS CONDITION HAPPENS, WE ARE IN A RESTART MODE AND THE       01980000
019900*  ROW WAS DELETED IN THE ORIGINAL RUN.                           01990000
020000******************************************************************02000000
020100 2100-DELETE-RCT00014.                                            02010000
020110                                                                  02011009
020120***  DISPLAY ' 2100-DELETE-RCT00014         '.                    02012011
020200                                                                  02020000
020300     PERFORM WITH TEST AFTER                                      02030000
020400       VARYING PV-RETRY-COUNTER FROM 1 BY 1                       02040000
020500         UNTIL (PV-RETRY-COUNTER > PC-MAX-RETRIES  OR             02050000
020600                SQLCODE = ZERO                     OR             02060000
020700                SQLCODE = +100)                                   02070000
020800                                                                  02080000
020900         EXEC SQL                                                 02090000
021000              DELETE FROM RCT_TRLR_UNLD                           02100015
021100               WHERE TRIP_ID          = :VEHICL-CURR-TRIP-ID      02110000
021800         END-EXEC                                                 02180000
021900                                                                  02190000
022000         EVALUATE TRUE                                            02200000
022100             WHEN SQLCODE = ZERO                                  02210000
022200                  MOVE SQLERRD(3) TO PV-SQLERRD3                  02220000
022300                  ADD PV-SQLERRD3 TO PV-DELETE-COUNTER            02230000
022400                                     PV-COMMIT-COUNTER            02240000
022500             WHEN SQLCODE = +100                                  02250000
022600             WHEN SQLCODE = -904                                  02260000
022700             WHEN SQLCODE = -911                                  02270000
022800                 CONTINUE                                         02280000
022900             WHEN SQLWARN0 NOT = SPACES                           02290000
023000             WHEN SQLCODE < ZERO                                  02300000
023100             WHEN SQLCODE > ZERO                                  02310000
023200                 MOVE '2100-DELETE-RCT00014           '           02320000
023300                                      TO PV-PARAGRAPH-NAME        02330000
023400                 MOVE 'ERROR DELETING ROW FROM RCT00014 TABLE'    02340000
023500                                      TO PV-DB2-OPERATION-MSG-1   02350003
023600                 MOVE 'RCT_TRLR_UNLD' TO PV-DB2-TABLE-NAME-1      02360000
023700                 PERFORM 9100-SQL-ABEND                           02370000
023800         END-EVALUATE                                             02380000
023900     END-PERFORM.                                                 02390000
024000                                                                  02400000
024100     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         02410000
024200         MOVE '2100-DELETE-RCT00014          '                    02420000
024300                                 TO PV-PARAGRAPH-NAME             02430000
024400         MOVE '** DEADLOCK ENCOUNTERED ON THE DELETE **'          02440000
024500                                 TO PV-DB2-OPERATION-MSG-1        02450003
024600         MOVE 'RCT_TRLR_UNLD'    TO PV-DB2-TABLE-NAME-1           02460000
024700         PERFORM 9100-SQL-ABEND                                   02470000
024800     END-IF.                                                      02480000
024900                                                                  02490000
025000                                                                  02500000
025100******************************************************************02510000
025200*  COMMIT THE CHANGES                                             02520000
025300******************************************************************02530000
025400 2200-COMMIT-CHANGES.                                             02540000
025410                                                                  02541009
025420***  DISPLAY ' 2200-COMMIT-CHANGES          '.                    02542011
025500                                                                  02550000
025600     EXEC SQL                                                     02560000
025700          COMMIT                                                  02570000
025800     END-EXEC.                                                    02580000
025900                                                                  02590000
026000     EVALUATE TRUE                                                02600000
026100         WHEN SQLCODE = ZERO                                      02610000
026200             ADD +1    TO PV-COMMIT-COUNT                         02620000
026300             MOVE VEHICL-CURR-TRIP-ID  TO PV-COMMIT-TRIP-ID       02630001
026600             MOVE PV-DELETE-COUNTER    TO PV-RCT00014-DELETED     02660000
026610             MOVE PV-RCT00016-DELETE   TO PV-RCT00016-DELETED     02661003
026620             MOVE PV-INPUT-COUNTER     TO PV-TRIPS                02662012
026700                                                                  02670000
026800             DISPLAY PV-COMMIT-TIME-AND-TRIP                      02680001
026900                                                                  02690000
027000         WHEN SQLWARN0 NOT = SPACES                               02700000
027100         WHEN SQLCODE < ZERO                                      02710000
027200         WHEN SQLCODE > ZERO                                      02720000
027300             MOVE '2200-COMMIT-CHANGES'                           02730000
027400                                 TO PV-PARAGRAPH-NAME             02740000
027500             MOVE 'ERROR ON COMMIT OF THE CHANGES'                02750000
027600                                 TO PV-DB2-OPERATION-MSG-1        02760003
027700             MOVE 'RCT_TRLR_UNLD' TO PV-DB2-TABLE-NAME-1          02770000
027800             PERFORM 9100-SQL-ABEND                               02780000
027900     END-EVALUATE.                                                02790000
028000                                                                  02800000
028001******************************************************************02800103
028002* PROCESS CURSOR FOR TRIP ENTRIES IN RCT_TRLR_UNLD               *02800203
028003******************************************************************02800303
028010 2500-PROCESS-TRIP.                                               02801003
028020                                                                  02802009
028030***  DISPLAY ' 2500-PROCESS-TRIP            '.                    02803011
028100                                                                  02810000
028101     SET  PS-RCT00014-CSR-END-NO  TO  TRUE.                       02810103
028102                                                                  02810203
028103     MOVE  VEHICL-CURR-TRIP-ID TO DK-TRIP-ID                      02810310
028104                                  PV-DISP-TRIP.                   02810410
028105***  DISPLAY ' TRIP: ' PV-DISP-TRIP.                              02810511
028106                                                                  02810610
028107     PERFORM 2510-OPEN-RCT00014-CSR.                              02810710
028108                                                                  02810810
028109     PERFORM 2520-FETCH-RCT00014-CSR                              02810910
028110       UNTIL PS-RCT00014-CSR-END.                                 02811010
028111                                                                  02811110
028112     PERFORM 2530-CLOSE-RCT00014-CSR.                             02811210
028113                                                                  02811310
028114     PERFORM 2100-DELETE-RCT00014.                                02811410
028115                                                                  02811510
028116                                                                  02811610
028117******************************************************************02811710
028118* OPEN RCT_TRLR_UNLD CURSOR                                      *02811810
028119******************************************************************02811910
028120 2510-OPEN-RCT00014-CSR.                                          02812010
028121                                                                  02812110
028122***  DISPLAY ' 2510-OPEN-RCT00014-CSR       '.                    02812211
028123                                                                  02812310
028124     EXEC SQL                                                     02812410
028125          OPEN TABLE-CURSOR                                       02812510
028126     END-EXEC.                                                    02812610
028127                                                                  02812710
028128     EVALUATE TRUE                                                02812810
028129         WHEN SQLCODE = ZERO                                      02812910
028130              CONTINUE                                            02813010
028136         WHEN SQLWARN0 NOT EQUAL SPACE                            02813603
028137         WHEN SQLCODE  NOT EQUAL ZERO                             02813703
028138              MOVE DK-TRIP-ID  TO  PV-DISP-TRIP                   02813803
028139              SET PS-RCT00014-CSR-END TO TRUE                     02813903
028140              MOVE '2510-OPEN-RCT00014-CSR'                       02814003
028141                                  TO PV-PARAGRAPH-NAME            02814103
028142              MOVE 'OPEN TABLE CURSOR'                            02814203
028143                                  TO PV-DB2-OPERATION-MSG-1       02814303
028144              MOVE PV-DISP-TRIP   TO PV-DB2-OPERATION-MSG-2       02814403
028145              MOVE 'RCT_TRLR_UNLD' TO PV-DB2-TABLE-NAME-1         02814503
028146              MOVE '       '      TO PV-DB2-TABLE-NAME-2          02814603
028147              PERFORM 9100-SQL-ABEND                              02814706
028148     END-EVALUATE.                                                02814803
028149                                                                  02814903
028150                                                                  02815003
028151******************************************************************02815103
028152* FETCH RCT_TRLR_UNLD CURSOR                                     *02815203
028153******************************************************************02815303
028154 2520-FETCH-RCT00014-CSR.                                         02815403
028155                                                                  02815509
028156***  DISPLAY ' 2520-FETCH-RCT00014-CSR      '.                    02815611
028157                                                                  02815703
028158     EXEC SQL                                                     02815803
028159         FETCH TABLE-CURSOR                                       02815903
028160          INTO  :RCT00014-CRE-TMST                                02816003
028161             ,  :RCT00014-CRE-BY-USR-ID                           02816103
028162     END-EXEC.                                                    02816203
028163                                                                  02816303
028164     EVALUATE TRUE                                                02816403
028165         WHEN SQLCODE = ZERO                                      02816503
028166              PERFORM 2540-DELETE-RCT00016                        02816608
028167                                                                  02816703
028168         WHEN SQLCODE = +100                                      02816803
028169              SET PS-RCT00014-CSR-END TO TRUE                     02816903
028170                                                                  02817003
028171         WHEN SQLWARN0 NOT EQUAL SPACE                            02817103
028172         WHEN SQLCODE NOT EQUAL ZERO                              02817203
028173              MOVE DK-TRIP-ID  TO  PV-DISP-TRIP                   02817303
028174              MOVE '2520-FETCH-RCT00014-CSR'                      02817403
028175                                  TO PV-PARAGRAPH-NAME            02817503
028176              MOVE 'FETCH TABLE CURSOR'                           02817603
028177                                  TO PV-DB2-OPERATION-MSG-1       02817703
028178              MOVE PV-DISP-TRIP   TO PV-DB2-OPERATION-MSG-2       02817803
028179              MOVE 'RCT_TRLR_UNLD' TO PV-DB2-TABLE-NAME-1         02817903
028180              MOVE '       '      TO PV-DB2-TABLE-NAME-2          02818003
028181              PERFORM 9100-SQL-ABEND                              02818106
028182     END-EVALUATE.                                                02818203
028183                                                                  02818303
028184                                                                  02818403
028185                                                                  02818503
028186******************************************************************02818603
028187* FETCH RCT_TRLR_UNLD CURSOR                                     *02818703
028188******************************************************************02818803
028189 2530-CLOSE-RCT00014-CSR.                                         02818903
028190                                                                  02819009
028191***  DISPLAY ' 2530-CLOSE-RCT00014-CSR      '.                    02819111
028192                                                                  02819203
028193     EXEC SQL                                                     02819303
028194          CLOSE TABLE-CURSOR                                      02819403
028195     END-EXEC.                                                    02819503
028196                                                                  02819603
028197     EVALUATE TRUE                                                02819703
028198         WHEN SQLCODE = ZERO                                      02819803
028199              CONTINUE                                            02819903
028200         WHEN SQLWARN0 NOT EQUAL SPACE                            02820003
028201         WHEN SQLCODE  NOT EQUAL ZERO                             02820103
028202              MOVE DK-TRIP-ID  TO  PV-DISP-TRIP                   02820203
028203              MOVE '2530-CLOSE-RCT00014-CSR'                      02820303
028204                                  TO PV-PARAGRAPH-NAME            02820403
028205              MOVE 'CLOSE TABLE CURSOR'                           02820503
028206                                  TO PV-DB2-OPERATION-MSG-1       02820603
028207              MOVE PV-DISP-TRIP   TO PV-DB2-OPERATION-MSG-2       02820703
028208              MOVE 'RCT_TRLR_UNLD' TO PV-DB2-TABLE-NAME-1         02820803
028209              MOVE '       '      TO PV-DB2-TABLE-NAME-2          02820903
028210              PERFORM 9100-SQL-ABEND                              02821006
028211     END-EVALUATE.                                                02821103
028212                                                                  02821203
028213                                                                  02821303
028214******************************************************************02821403
028215*  DELETE CHILDREN ROWS FROM RCT_RCVR_TRLR_LST                    02821503
028216******************************************************************02821603
028217 2540-DELETE-RCT00016.                                            02821708
028218                                                                  02821809
028219***  DISPLAY ' 2540-DELETE-RCT00016         '.                    02821911
028220                                                                  02822003
028221***     DISPLAY RCT00014-CRE-TMST '  -  '                         02822111
028222***             RCT00014-CRE-BY-USR-ID.                           02822211
028223                                                                  02822308
028224         EXEC SQL                                                 02822403
028225              DELETE FROM RCT_RCVR_TRLR_LST                       02822515
028226               WHERE CRE_TMST       = :RCT00014-CRE-TMST          02822603
028227                 AND CRE_BY_USR_ID  = :RCT00014-CRE-BY-USR-ID     02822703
028228         END-EXEC.                                                02822808
028229                                                                  02822903
028230         EVALUATE TRUE                                            02823003
028231             WHEN SQLCODE = ZERO                                  02823103
028232                  MOVE SQLERRD(3) TO PV-SQLERRD3                  02823203
028233                  ADD PV-SQLERRD3 TO PV-RCT00016-DELETE           02823303
028234                                     PV-COMMIT-COUNTER            02823403
028235             WHEN SQLCODE = +100                                  02823503
028236             WHEN SQLCODE = -904                                  02823603
028237             WHEN SQLCODE = -911                                  02823703
028238                 CONTINUE                                         02823803
028239             WHEN SQLWARN0 NOT = SPACES                           02823903
028240             WHEN SQLCODE < ZERO                                  02824003
028241             WHEN SQLCODE > ZERO                                  02824103
028242                 MOVE DK-TRIP-ID  TO  PV-DISP-TRIP                02824203
028243                 MOVE '2540-DELETE-RCT00016           '           02824308
028244                                      TO PV-PARAGRAPH-NAME        02824403
028245                 MOVE 'ERROR DELETING ROW FROM RCT00016 TABLE'    02824503
028246                                      TO PV-DB2-OPERATION-MSG-1   02824603
028247                  MOVE PV-DISP-TRIP   TO PV-DB2-OPERATION-MSG-2   02824703
028248                 MOVE 'RCT00016'      TO PV-DB2-TABLE-NAME-1      02824803
028249                 PERFORM 9100-SQL-ABEND                           02824903
028250         END-EVALUATE.                                            02825008
028261                                                                  02826103
028262                                                                  02826203
028270******************************************************************02827003
028300*  READ A RECORD FROM THE RCT_TRLR_UNLD FILE                      02830000
028400******************************************************************02840000
028500 7000-READ-RCT00014-FILE.                                         02850000
028510                                                                  02851009
028520***  DISPLAY ' 7000-READ-RCT00014-FILE      '.                    02852011
028600                                                                  02860000
028700     READ RCT00014-FILE                                           02870000
028800       INTO DCLTVEHICL                                            02880000
028900           AT END                                                 02890000
029000               SET PS-EOF-RCT00014-FILE TO TRUE.                  02900000
029100                                                                  02910000
029200                                                                  02920000
029300 9100-SQL-ABEND.                                                  02930000
029400******************************************************************02940000
029500*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    02950000
029600*  ERROR OR WARNING CODE OCCURS.                                  02960000
029700******************************************************************02970000
029800     DISPLAY '9100-SQL-ABEND'.                                    02980000
029900     DISPLAY '** ABEND             **'.                           02990000
030000     DISPLAY '** PROGRAM           ** = '                         03000000
030100                                       PC-CURRENT-PROGRAM-NAME.   03010000
030200     DISPLAY '** PARAGRAPH         ** = '                         03020000
030300                                       PV-PARAGRAPH-NAME.         03030000
030400     DISPLAY '** TABLE(S) AFFECTED ** = '                         03040000
030500                                       PV-DB2-TABLE-NAME-1.       03050000
030600     DISPLAY '**                   ** = '                         03060000
030700                                       PV-DB2-TABLE-NAME-2.       03070000
030800     DISPLAY '** OPERATION         ** = '                         03080000
030900                                       PV-DB2-OPERATION-MSG-1     03090003
030910     DISPLAY '**                   ** = '                         03091003
030920                                       PV-DB2-OPERATION-MSG-2     03092003
031000     DISPLAY '**                   ** = '                         03100000
031500                                                                  03150000
031600******************************************************************03160000
031700* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    03170000
031800* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         03180000
031900* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     03190000
032000* FORMAT.                                                         03200000
032100******************************************************************03210000
032200     COPY DPPD004.                                                03220000
032300                                                                  03230000
032400     EXEC SQL                                                     03240000
032500         ROLLBACK                                                 03250000
032600     END-EXEC.                                                    03260000
032700                                                                  03270000
032800     MOVE +4013                  TO ABEND-CODE.                   03280000
032900     CALL 'ILBOABN0' USING ABEND-CODE.                            03290000
