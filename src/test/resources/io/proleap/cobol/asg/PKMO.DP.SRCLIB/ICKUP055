       IDENTIFICATION DIVISION.                                                 
       PROGRAM-ID.    ICKUP055.                                                 
       AUTHOR.        R. KELLEN.                                                
       INSTALLATION.  KOHLS DEPARTMENT STORES.                                  
       DATE-WRITTEN.  02/01/2008.                                               
       DATE-COMPILED.                                                           
                                                                                
      *****************************************************************         
      * ICKUP055 - DETERMINE ACTIVE COUNTS FOR MAINT OF O/H DATA                
      *****************************************************************         
      *        THIS PROGRAM WILL LOOK FOR ACTIVE USA IC COUNTS FOR THE          
      *        PURPOSE OF MAINTAINING THE UNT_RTL_AMT,ONHAND_QTY                
      *        INTRANSIT_QTY, TRUCK_ACKN_QTY, ACTIVE_IND, GROUP_LVL_CDE         
      *        AND ORIG_CLR_DTE ON THE ICT_SKU_LOC_CNT BY PROGRAM               
      *        ICKUP056. THIS PROGRAM HAS 2 CURSORS FOR THIS PROCESS,           
      *        THE FIRST WILL GATHER UPDATE DATA FOR THE NIGHTLY PROCESS        
      *        AND THE SECOND WILL GATHER DATA FOR THE HOURLY PROCESS.          
      *        A FILE OF MANIFEST DATA IS ALSO READ TO GET THE TRUCK            
      *        ACKNOWLEDGED QTY.                                                
      *****************************************************************         
      *                                                                         
      *  TABLES USED ARE:                                                       
      *      ICT_CNT_STUP    (RO) - IC COUNT SETUP                              
      *      ICT_LOC_CNT_STAT(RO) - IC LOCATION COUNT STAT                      
      *      ICT_SKU_LOC_CNT (RO) - IC SKU LOCATION COUNT                       
      *      ICT_CNT_EXTR_PRC(U)  - IC COUNT LAST PROCESS TIMESTAMP             
      *  FILES READ ARE:                                                        
      *      NONE                                                               
      *****************************************************************         
      * 02/02/08 - R KELLEN         -  WR NO. WR30388                           
      *    - NEW PROGRAM.                                                       
      *                                                                         
      * 07/15/08 - R KELLEN         -  WR NO. WR30388                           
      *    - INITIAL IMPLEMENTATION                                             
      *                                                                         
      * 08/05/08 - R KELLEN         -  WR NO. WR30388                           
      *    - SUBTRACT INTRANSIT QTY FROM STORE EXPECTED QTY                     
      *                                                                         
      * 08/19/08 - R KELLEN         -  WR NO. WR30388                           
      *    - LOOKUP SALES,RETURN/XFER IN/XFER OUT QTY AND PASS TO               
      *      ICKUP056.                                                          
      *                                                                         
      * 10/13/09 - Cognizant        -  INC#993597                               
      *    - Code change done to Nightly counts process to fine tune            
      *      the job performance                                                
      *                                                                         
P11361* 12/05/10 - COGNIZANT        -                                           
P11361*    Modified the NIGHTLY-LOC-CSR, NIGHTLY-CNT-CSR to consider            
P11361*    stores that are already completed the counts before                  
P11361*    pulling the onhands.                                                 
      *                                                                         
P14593* 09/15/11 - COGNIZANT        -                                           
P14593*    Modified the NIGHTLY-LOC-CSR, NIGHTLY-CNT-CSR to skip counts         
P14593*    of void status that has maximum timestamp and consider the           
P14593*    next maximum timestamp with available or complete status.            
C20361*                                                                         
C20361* 02/22/12 - COGNIZANT       -  CRQ000000020361                           
C20361*    Changes are made to the program to improve the CPU                   
C20361*    Performance                                                          
C20361*    NIGHTLY-CNT-CSR and NIGHTLY-LOC-CSR unloaded using job               
C20361*    and the program changed as file driven                               
C20361*                                                                         
      *****************************************************************         
      * 03/28/2012 CHANGED BY:  DEANNA BRANTNER   PR#3403                       
      *            DESCRIPTION: Compile only changes to TTFITEM Database        
      *                         for Large Retail Project                        
      ******************************************************************        
C38624* 04/02/2016 CHANGED BY:  COGNIZANT - CHG0138624                          
C38624*            DESCRIPTION: Increased the maximum retry count to 5          
C38624******************************************************************        
      ******************************************************************        
C46632* 07/20/2016 CHANGED BY:  COGNIZANT - CHG0146632                          
C46632*            DESCRIPTION: Added a para to check ORIG-CLR-DTE              
C46632******************************************************************        
                                                                                
       ENVIRONMENT DIVISION.                                                    
       CONFIGURATION SECTION.                                                   
       SOURCE-COMPUTER. IBM-3090.                                               
       OBJECT-COMPUTER. IBM-3090.                                               
       INPUT-OUTPUT SECTION.                                                    
                                                                                
       FILE-CONTROL.                                                            
           SELECT NIGHTLY-HOURLY-CTL-FILE    ASSIGN TO INP01.                   
C20361                                                                          
C20361     SELECT NIGHTLY-DRIVER-FILE        ASSIGN TO INP02.                   
                                                                                
           SELECT IC-COUNT-QTY-MAINT-FILE    ASSIGN TO OUT01.                   
                                                                                
      *****************************************************************         
       DATA DIVISION.                                                           
      *****************************************************************         
       FILE SECTION.                                                            
                                                                                
       FD  NIGHTLY-HOURLY-CTL-FILE                                              
           LABEL RECORDS ARE STANDARD                                           
           RECORDING MODE IS F                                                  
           BLOCK CONTAINS 0 RECORDS                                             
           DATA RECORD IS NIGHTLY-HOURLY-CTL-REC.                               
       01  NIGHTLY-HOURLY-CTL-REC.                                              
           05  NIGHTLY-HOURLY-CTL-IND PIC X.                                    
           05  FILLER                 PIC X(79).                                
                                                                                
C20361 FD  NIGHTLY-DRIVER-FILE                                                  
C20361     LABEL RECORDS ARE STANDARD                                           
C20361     RECORDING MODE IS F                                                  
C20361     BLOCK CONTAINS 0 RECORDS                                             
C20361     DATA RECORD IS NIGHTLY-DRIVER-FILE.                                  
C20361 01  NIGHTLY-DRIVER-FL-REC      PIC X(44).                                
C20361                                                                          
       FD  IC-COUNT-QTY-MAINT-FILE                                              
           LABEL RECORDS ARE STANDARD                                           
           RECORDING MODE IS F                                                  
           BLOCK CONTAINS 0 RECORDS                                             
           DATA RECORD IS IC-COUNT-QTY-MAINT-FILE.                              
       01  IC-COUNT-QTY-MAINT-REC     PIC  X(60).                               
      *                                                                         
       WORKING-STORAGE SECTION.                                                 
      ******************************************************************        
      * PC PROGRAM CONSTANTS                                           *        
      ******************************************************************        
       01  PC-PROGRAM-CONSTANTS.                                                
           05  PC-PROGRAM-NAME                PIC X(08)    VALUE                
                                                 'ICKUP055'.                    
C38624     05  PC-MAXIMUM-RETRY-COUNT         PIC S9(04)   VALUE +5             
                                                           COMP SYNC.           
           05  PC-DEFAULT-TMST                PIC X(26)    VALUE                
               '2007-01-01-00.00.00.000000'.                                    
                                                                                
      ******************************************************************        
      * PV PROGRAM VARIABLES                                           *        
      ******************************************************************        
       01  PV-WORK-VARIABLES.                                                   
           05  PV-RETRIES                     PIC S9(04)   VALUE +0             
                                                           COMP.                
           05  PV-PARAGRAPH-NAME              PIC  X(30)   VALUE SPACES.        
           05  PV-NIGHTLY-HOURLY-CTL-IND      PIC  X       VALUE SPACES.        
             88 PV-NIGHTLY-RUN                VALUE 'N'.                        
             88 PV-HOURLY-RUN                 VALUE 'H'.                        
           05  PV-DB2-OPERATION-ATTEMPTED     PIC  X(30)   VALUE SPACES.        
           05  PV-SQLCODE-DISPLAY             PIC +(8)9    VALUE ZEROES.00830000
           05  PV-EXTR-PRC-TMST-NI         PIC S9(04)  COMP                CL*15
                                                         VALUE ZERO.       CL*15
               88 PV-EXTR-PRC-TMST-IS-NULL VALUE -1.                            
           05  PV-ORIG-CLR-DTE-NULL-IND    PIC S9(04)  COMP                CL*15
                                                         VALUE ZERO.       CL*15
               88 PV-ORIG-CLR-DTE-IS-NULL  VALUE -1.                            
           05  PV-CURRENT-WEEKDAY          PIC 9.                          CL**4
           05  PV-CURRENT-WEEK-NBR         PIC 9.                          CL**4
           05  PV-CURRENT-DATE             PIC X(10).                      CL**4
           05  PV-CURRENT-TMST             PIC X(26).                      CL**4
           05  PV-LOCATION-TMST            PIC X(26).                      CL**4
           05  PV-LAST-RUN-TMST            PIC X(26).                      CL**4
           05  PV-YEST-DTE                 PIC X(10).                      CL**4
           05  PV-YEST-TMST                PIC X(26).                      CL**4
           05  PV-YEST-TMST-BOD.                                                
             10 PV-YEST-CC-BOD             PIC XX.                              
             10 PV-YEST-YY-BOD             PIC XX.                              
             10 FILLER                     PIC X.                               
             10 PV-YEST-MM-BOD             PIC XX.                              
             10 FILLER                     PIC X.                               
             10 PV-YEST-DD-BOD             PIC XX.                              
             10 FILLER                     PIC X.                               
             10 PV-YEST-TIME-BOD.                                               
               15 PV-YEST-HH-BOD           PIC XX.                              
               15 FILLER                   PIC X.                               
               15 PV-YEST-MI-BOD           PIC XX.                              
               15 FILLER                   PIC X.                               
               15 PV-YEST-SS-BOD           PIC XX.                              
               15 FILLER                   PIC X.                               
               15 PV-YEST-MS-BOD           PIC X(6).                            
           05  PV-YEST-TMST-BOD-RED        PIC X(26).                           
           05  PV-YEST-TMST-EOD.                                                
             10 PV-YEST-CC-EOD             PIC XX.                              
             10 PV-YEST-YY-EOD             PIC XX.                              
             10 FILLER                     PIC X.                               
             10 PV-YEST-MM-EOD             PIC XX.                              
             10 FILLER                     PIC X.                               
             10 PV-YEST-DD-EOD             PIC XX.                              
             10 FILLER                     PIC X.                               
             10 PV-YEST-TIME-EOD.                                               
               15 PV-YEST-HH-EOD           PIC XX.                              
               15 FILLER                   PIC X.                               
               15 PV-YEST-MI-EOD           PIC XX.                              
               15 FILLER                   PIC X.                               
               15 PV-YEST-SS-EOD           PIC XX.                              
               15 FILLER                   PIC X.                               
               15 PV-YEST-MS-EOD           PIC X(6).                            
           05  PV-YEST-TMST-EOD-RED        PIC X(26).                           
           05  PV-COMPLETED-COUNT-FLG      PIC X.                          CL**4
               88  PV-NOT-COMPLETED-COUNT  VALUE 'N'.                           
               88  PV-COMPLETED-COUNT      VALUE 'Y'.                           
           05  PV-SUM-SLD-QTY           PIC S9(09)  VALUE +0 COMP.              
           05  PV-SUM-RET-QTY           PIC S9(09)  VALUE +0 COMP.              
           05  PV-XFER-IN-QTY           PIC S9(09)  VALUE +0 COMP.              
           05  PV-XFER-OUT-QTY          PIC S9(09)  VALUE +0 COMP.              
C20361     05  PV-NIGHTLY-DRIVER-FL-REC.                                        
C20361         10  PV-RTL-SAL-UNT-QTY   PIC S9(09)  VALUE +0 COMP.              
C20361         10  PV-RTL-RET-UNT-QTY   PIC S9(09)  VALUE +0 COMP.              
C20361         10  PV-XFER-IN-UNT-QTY   PIC S9(09)  VALUE +0 COMP.              
C20361         10  PV-XFER-OUT-UNT-QTY  PIC S9(09)  VALUE +0 COMP.              
C20361         10  PV-LOC-NBR           PIC S9(04)  VALUE +0 COMP.              
C20361         10  PV-SKU-NBR           PIC S9(08)V VALUE +0 COMP-3.            
C20361         10  PV-CNT-STUP-ID       PIC S9(09)  VALUE +0 COMP.              
C20361         10  PV-EXEC-LVL-CDE      PIC  X(03).                             
C20361         10  PV-CNT-SEQ-NBR       PIC S9(04)  VALUE +0 COMP.              
C20361         10  PV-ITM-NBR           PIC S9(15)V VALUE +0 COMP-3.            
C20361         10  PV-INTR-UPC-ID       PIC S9(09)  VALUE +0 COMP.              
                                                                                
      ******************************************************************        
      * PS PROGRAM SWITCHES                                            *        
      ******************************************************************        
       01  PS-PROGRAM-SWITCHES.                                                 
           05  PS-END-OF-MAN-FL-SW            PIC  X(01)   VALUE 'N'.           
               88  PS-END-OF-MAN-FL                        VALUE 'Y'.           
           05  PS-END-OF-CTL-FL-SW            PIC  X(01)   VALUE 'N'.           
               88  PS-END-OF-CTL-FILE                       VALUE 'Y'.          
           05  PS-NO-MORE-NIGHTLY-CNT-SW      PIC  X(01)   VALUE 'N'.           
               88  PS-NO-MORE-NIGHTLY-CNT                  VALUE 'Y'.           
               88  PS-MORE-NIGHTLY-CNT                     VALUE 'N'.           
           05  PS-NO-MORE-NIGHTLY-LOC-SW      PIC  X(01)   VALUE 'N'.           
               88  PS-NO-MORE-NIGHTLY-LOC                  VALUE 'Y'.           
               88  PS-MORE-NIGHTLY-LOC                     VALUE 'N'.           
           05  PS-NO-MORE-HOURLY-CNT-SW       PIC  X(01)   VALUE 'N'.           
               88  PS-NO-MORE-HOURLY-CNT                   VALUE 'Y'.           
               88  PS-MORE-HOURLY-CNT                      VALUE 'N'.           
           05  PS-PROCESS-STOP-SW             PIC  X(01)   VALUE 'N'.           
               88  PS-PROCESS-STOP                         VALUE 'Y'.           
           05  PS-LAST-RUN-TMST-FOUND-SW      PIC  X(01)   VALUE 'N'.           
               88  PS-LAST-RUN-TMST-FOUND                  VALUE 'Y'.           
C20361     05  PS-END-OF-DRV-FL-SW            PIC  X(01)   VALUE 'N'.           
C20361         88  PS-END-OF-DRV-FILE                      VALUE 'Y'.           
                                                                                
       01  ABEND-CODE                         PIC S9(04)   VALUE +0             
                                                           COMP SYNC.           
                                                                                
       01  DISPLAY-EDITS.                                                       
           05  DI-CNTS                      PIC  9(09)  VALUE ZEROS.            
                                                                                
      *                                                                         
      *****************************************************************         
      *    INPUT COPYBOOKS                                                      
      *****************************************************************         
           COPY ICRD058.                                                        
      *****************************************************************         
      *    OUTPUT COPYBOOKS                                                     
      *****************************************************************         
           COPY ICRD057.                                                        
      *****************************************************************         
      *    DB2 COMMUNICATION AREA                                               
      *****************************************************************         
           COPY DPWS004.                                                        
                                                                                
      *****************************************************************         
      *  XST_LOC TABLE                                                          
      *****************************************************************         
           EXEC SQL                                                             
                INCLUDE XST00001                                                
           END-EXEC.                                                            
                                                                                
      *****************************************************************         
      *  XST_SKU  TABLE                                                         
      *****************************************************************         
           EXEC SQL                                                             
                INCLUDE XST00010                                                
           END-EXEC.                                                            
                                                                                
      *****************************************************************         
      *  XST_SKU_LOC  TABLE                                                     
      *****************************************************************         
           EXEC SQL                                                             
                INCLUDE XST00008                                                
           END-EXEC.                                                            
                                                                                
      *****************************************************************         
      *  ICT_CNT_EXTR_PRC TABLE                                                 
      *****************************************************************         
           EXEC SQL                                                             
                INCLUDE ICT00007                                                
           END-EXEC.                                                            
                                                                                
      *****************************************************************         
      *  ICT_CNT_STUP_STAT TABLE                                                
      *****************************************************************         
           EXEC SQL                                                             
                INCLUDE ICT00019                                                
           END-EXEC.                                                            
                                                                                
      *****************************************************************         
      *  PCT_TRN_CLSN_BAL TABLE                                                 
      *****************************************************************         
           EXEC SQL                                                             
                INCLUDE PCT00014                                                
           END-EXEC.                                                            
                                                                                
      *****************************************************************         
      *  TSKST TABLE                                                            
      *****************************************************************         
           EXEC SQL                                                             
                INCLUDE TSKST                                                   
           END-EXEC.                                                            
                                                                                
      *****************************************************************         
      *  TSKXREF TABLE                                                          
      *****************************************************************         
           EXEC SQL                                                             
                INCLUDE TSKXREF                                                 
           END-EXEC.                                                            
                                                                                
      *****************************************************************         
      *  TINVPAR TABLE                                                          
      *****************************************************************         
           EXEC SQL                                                             
                INCLUDE TINVPAR                                                 
           END-EXEC.                                                            
                                                                                
      *****************************************************************         
      *  ICT_CNT_STUP TABLE                                                     
      *****************************************************************         
           EXEC SQL                                                             
                INCLUDE ICT00010                                                
           END-EXEC.                                                            
                                                                                
      *****************************************************************         
      *  ICT_LOC_CNT_STAT TABLE                                                 
      *****************************************************************         
           EXEC SQL                                                             
                INCLUDE ICT00020                                                
           END-EXEC.                                                            
                                                                                
      *****************************************************************         
      *  ICT_SKU_LOC_CNT TABLE                                                  
      *****************************************************************         
           EXEC SQL                                                             
                INCLUDE ICT00011                                                
           END-EXEC.                                                            
                                                                                
      *--------------------------------------------------------------*          
      * DB2 TABLE TTFSTAT -- TF TRANSFER STATUS TABLE                           
      *--------------------------------------------------------------*          
           EXEC SQL                                                             
             INCLUDE TTFSTAT                                                    
           END-EXEC.                                                            
                                                                                
      *--------------------------------------------------------------*          
      * DB2 TABLE TEPPART -- COSA PARTIONING TABLE                              
      *--------------------------------------------------------------*          
           EXEC SQL                                                             
             INCLUDE TEPPART                                                    
           END-EXEC.                                                            
                                                                                
      *--------------------------------------------------------------*          
      * DB2 TABLE TEPTRN -- COSA TRANSACTION TABLE                              
      *--------------------------------------------------------------*          
           EXEC SQL                                                             
             INCLUDE TEPTRN                                                     
           END-EXEC.                                                            
                                                                                
      *--------------------------------------------------------------*          
      * DB2 TABLE TEPITM -- COSA ITEM TABLE                                     
      *--------------------------------------------------------------*          
           EXEC SQL                                                             
             INCLUDE TEPITM                                                     
           END-EXEC.                                                            
                                                                                
      *--------------------------------------------------------------*          
      * DB2 TABLE FSTT_ON_SLS_AUD  TABLE                                        
      *--------------------------------------------------------------*          
           EXEC SQL                                                             
             INCLUDE FST00005                                                   
           END-EXEC.                                                            
                                                                                
      *--------------------------------------------------------------*          
      * DB2 TABLE TTFMSTR TABLE                                                 
      *--------------------------------------------------------------*          
           EXEC SQL                                                             
             INCLUDE TTFMSTR                                                    
           END-EXEC.                                                            
                                                                                
      *****************************************************************         
      *  TDTATTR DATE TABLE                                                     
      *****************************************************************         
           EXEC SQL                                                             
                INCLUDE TDTATTR                                                 
           END-EXEC.                                                            
                                                                                
           EXEC SQL                                                             
               INCLUDE SQLCA                                                    
           END-EXEC.                                                            
                                                                                
           COPY SQLCA2.                                                         
                                                                                
      *----------------------------------------------------------------         
      *  USA IC COUNTS CURSOR WILL FETCH ACTIVE HOURLY COUNTS                   
      *----------------------------------------------------------------         
           EXEC SQL                                                             
             DECLARE HOURLY-CNT-CSR CURSOR FOR                                  
             SELECT                                                             
                  COALESCE(EE1.RTL_SAL_UNT_QTY,0)                               
                 ,COALESCE(EE2.RTL_RET_UNT_QTY,0)                               
                 ,COALESCE(EE3.XFER_IN_UNT_QTY,0)                               
                 ,COALESCE(EE4.XFER_OUT_UNT_QTY,0)                              
                 ,A.LOC_NBR                                                     
                 ,A.SKU_NBR                                                     
                 ,A.CNT_STUP_ID                                                 
                 ,C.EXEC_LVL_CDE                                                
                 ,A.CNT_SEQ_NBR                                                 
                                                                                
              FROM                                                              
                   ICT_LOC_CNT_STAT    B                                        
                  ,ICT_CNT_STUP        C                                        
                  ,ICT_SKU_LOC_CNT     A                                        
                    LEFT OUTER JOIN (SELECT  SUM (AA.SLD_QTY)                   
                      AS RTL_SAL_UNT_QTY                                        
                        ,AA.LOC_NBR                                             
                        ,BB.SKU                                                 
                      FROM FSTT_OH_SLS_AUD AA                                   
                          ,TSKXREF         BB                                   
                      WHERE AA.PRCG_DTE  = (CURRENT DATE - 1 DAY)               
                        AND AA.ITM_NBR   = BB.ITM_NBR                           
                        AND AA.SLS_DTE   = (CURRENT DATE - 1 DAY)               
                        AND AA.POS_TRN_TYP_CDE IN                               
                     ('01','02')                                                
                     GROUP BY                                                   
                     AA.LOC_NBR,BB.SKU) EE1                                     
                    ON         EE1.SKU= A.SKU_NBR AND                           
                               EE1.LOC_NBR= A.LOC_NBR                           
                     LEFT OUTER JOIN (SELECT  SUM (ABS(AA.SLD_QTY))             
                       AS RTL_RET_UNT_QTY                                       
                         ,AA.LOC_NBR,BB.SKU                                     
                      FROM FSTT_OH_SLS_AUD AA                                   
                          ,TSKXREF         BB                                   
                      WHERE AA.PRCG_DTE  = (CURRENT DATE - 1 DAY)               
                        AND AA.ITM_NBR   = BB.ITM_NBR                           
                        AND AA.SLS_DTE   = (CURRENT DATE - 1 DAY)               
                        AND AA.POS_TRN_TYP_CDE IN                               
                     ('11','12')                                                
                     GROUP BY                                                   
                     AA.LOC_NBR,BB.SKU) EE2                                     
                    ON         EE2.SKU= A.SKU_NBR AND                           
                               EE2.LOC_NBR= A.LOC_NBR                           
                     LEFT OUTER JOIN (SELECT SUM (BBB.XFER_QTY)                 
                       AS XFER_IN_UNT_QTY                                       
                         ,EEE.SKU_NBR                                           
                         ,AAA.TO_STR_NBR                                        
                             FROM TTFMSTR       AAA                             
                                 ,TTFITEM       BBB                             
                                 ,XST_UPC       CCC                             
                                 ,XST_SKU       EEE                             
                                 ,TTFSTAT       FFF                             
                                 ,(SELECT MAX(GGG.XFER_STAT_TMST)               
                                    AS MAX_TMST,XFER_DKEY_ID                    
                                  FROM TTFSTAT GGG                              
                                  GROUP BY                                      
                                  XFER_DKEY_ID) G                               
                             WHERE AAA.XFER_DKEY_ID = BBB.XFER_DKEY_ID          
                               AND BBB.SCN_UPC_NBR  = CCC.UPC_NBR               
                            AND CCC.INTR_UPC_ID    = EEE.INTR_UPC_ID            
                            AND AAA.CMPT_XFER_END_TMST >=                       
                             TIMESTAMP(CURRENT DATE - 1 DAY,'00:00:00')         
                            AND AAA.XFER_DKEY_ID   = FFF.XFER_DKEY_ID           
                            AND FFF.XFER_STAT_CDE NOT IN                        
                                ('PR','RC','RN','VD')                           
                            AND FFF.XFER_STAT_TMST = G.MAX_TMST                 
                            AND FFF.XFER_DKEY_ID   = G.XFER_DKEY_ID             
                            GROUP BY                                            
                            EEE.SKU_NBR,AAA.TO_STR_NBR) EE3                     
                            ON EE3.SKU_NBR = A.SKU_NBR AND                      
                               EE3.TO_STR_NBR = A.LOC_NBR                       
                      LEFT OUTER JOIN (SELECT SUM (BBB.XFER_QTY)                
                        AS XFER_OUT_UNT_QTY                                     
                          ,EEE.SKU_NBR                                          
                          ,AAA.FR_STR_NBR                                       
                             FROM TTFMSTR       AAA                             
                                 ,TTFITEM       BBB                             
                                 ,XST_UPC       CCC                             
                                 ,XST_SKU       EEE                             
                                 ,TTFSTAT       FFF                             
                                 ,(SELECT MAX(GGG.XFER_STAT_TMST)               
                                    AS MAX_TMST                                 
                                      ,XFER_DKEY_ID                             
                                  FROM TTFSTAT GGG                              
                                  GROUP BY                                      
                                  XFER_DKEY_ID) G                               
                            WHERE AAA.XFER_DKEY_ID   = BBB.XFER_DKEY_ID         
                              AND BBB.SCN_UPC_NBR    = CCC.UPC_NBR              
                            AND CCC.INTR_UPC_ID    = EEE.INTR_UPC_ID            
                            AND AAA.CMPT_XFER_END_TMST >=                       
                             TIMESTAMP(CURRENT DATE - 1 DAY,'00:00:00')         
                            AND AAA.XFER_DKEY_ID   = FFF.XFER_DKEY_ID           
                            AND FFF.XFER_STAT_CDE NOT IN                        
                                ('PR','RC','RN','VD')                           
                            AND FFF.XFER_STAT_TMST = G.MAX_TMST                 
                            AND FFF.XFER_DKEY_ID   = G.XFER_DKEY_ID             
                            GROUP BY                                            
                            EEE.SKU_NBR,AAA.FR_STR_NBR) EE4                     
                            ON EE4.SKU_NBR = A.SKU_NBR AND                      
                               EE4.FR_STR_NBR = A.LOC_NBR                       
                           WHERE B.CNT_STAT_CDE      = 'AVA'                    
                             AND A.LOC_NBR           = B.LOC_NBR                
                             AND A.CNT_STUP_ID       = B.CNT_STUP_ID            
                             AND A.CNT_SEQ_NBR       = B.CNT_SEQ_NBR            
                             AND C.CNT_STUP_ID       = B.CNT_STUP_ID            
                             AND DATE(A.LAST_UPD_TMST)  =                       
                                    DATE(B.LAST_UPD_TMST)                       
                             AND C.LAST_UPD_TMST=                               
                            (SELECT MAX(LAST_UPD_TMST)                          
                             FROM ICT_CNT_STUP     E                            
                             WHERE  E.CNT_STUP_ID    = B.CNT_STUP_ID            
                               AND  E.LAST_ACTN_CDE  = 'A')                     
                            AND B.LAST_UPD_TMST      =                          
                            (SELECT MAX(D.LAST_UPD_TMST)                        
                             FROM ICT_LOC_CNT_STAT D                            
                             WHERE D.LOC_NBR  = B.LOC_NBR                       
                               AND D.CNT_STUP_ID= B.CNT_STUP_ID                 
                               AND D.CNT_SEQ_NBR = B.CNT_SEQ_NBR)               
                    ORDER BY   A.SKU_NBR                                        
                              ,A.LOC_NBR                                        
                    WITH CS                                                     
           END-EXEC.                                                            
                                                                                
                                                                                
       PROCEDURE DIVISION.                                                      
      ******************************************************************        
      * 0000-MAIN-MODULE.                                              *        
      *  ==> PROCESSES:                                                *        
      *    - CONTROLS HIGHEST LEVEL FLOW OF PROGRAM                    *        
      ******************************************************************        
       0000-MAIN-MODULE.                                                        
           MOVE '0000-MAIN-MODULE' TO PV-PARAGRAPH-NAME.                        
                                                                                
           PERFORM 1000-INITIALIZATION.                                         
                                                                                
           PERFORM 2000-PROCESS-COUNTS.                                         
                                                                                
           PERFORM 3000-EOJ-PROCESSING.                                         
                                                                                
           STOP RUN.                                                            
                                                                                
      ******************************************************************        
      * 1000-INITIALIZATION.                                           *        
      ******************************************************************        
       1000-INITIALIZATION.                                                     
           MOVE '1000-INITIALIZATION ' TO PV-PARAGRAPH-NAME.                    
      * THE SAME 'QMT' ICT_CNT_EXTR_PRC ROW IS USED FOR THE NIGHTLY AND         
      * HOURLY RUN TO DETERMINE WHAT HAS HAPPENED SINCE THE LAST RUN.           
           PERFORM 8300-SELECT-LAST-RUN-TMST.                                   
           IF PV-EXTR-PRC-TMST-IS-NULL                                          
             MOVE PC-DEFAULT-TMST TO PV-LAST-RUN-TMST                           
           ELSE                                                                 
             MOVE ICT00007-EXTR-PRC-TMST TO PV-LAST-RUN-TMST.                   
           DISPLAY 'LAST RUN WAS -  ' PV-LAST-RUN-TMST.                         
                                                                                
           OPEN INPUT  NIGHTLY-HOURLY-CTL-FILE                                  
                OUTPUT IC-COUNT-QTY-MAINT-FILE.                                 
                                                                                
           EXEC SQL                                                             
               SET :PV-CURRENT-DATE = CURRENT DATE                              
           END-EXEC.                                                            
                                                                                
           EXEC SQL                                                             
               SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                         
           END-EXEC.                                                            
                                                                                
           EXEC SQL                                                             
               SET :PV-YEST-DTE = CURRENT DATE - 1 DAY                          
           END-EXEC.                                                            
           EXEC SQL                                                             
               SET :PV-YEST-TMST = CURRENT TIMESTAMP - 1 DAY                    
           END-EXEC.                                                            
                                                                                
           MOVE PV-YEST-TMST TO PV-YEST-TMST-BOD                                
                                PV-YEST-TMST-EOD.                               
           MOVE '00.00.00.000000'    TO PV-YEST-TIME-BOD.                       
           MOVE '11.59.59.999999'    TO PV-YEST-TIME-EOD.                       
           MOVE PV-YEST-TMST-BOD     TO PV-YEST-TMST-BOD-RED.                   
           MOVE PV-YEST-TMST-EOD     TO PV-YEST-TMST-EOD-RED.                   
           DISPLAY 'YESTERDAYS DATES - ' PV-YEST-DTE ' - '                      
                                         PV-YEST-TMST-BOD ' - '                 
                                         PV-YEST-TMST-EOD.                      
                                                                                
           PERFORM 7000-READ-CTL-FILE.                                          
           IF PS-END-OF-CTL-FILE                                                
             DISPLAY 'NO CONTROL RECORD PRESENT' UPON CONSOLE                   
             PERFORM 9999-SQL-ABEND.                                            
           MOVE NIGHTLY-HOURLY-CTL-IND TO PV-NIGHTLY-HOURLY-CTL-IND.            
      ******************************************************************        
      * 2000-PROCESS-COUNTS.                                           *        
      *  ==> FINDS NON-COMPLETED/CANCELLED COUNTS TO BE UPDATE WITH    *        
      *  ==> VARIOUS QUANTITIES.                                       *        
      ******************************************************************        
       2000-PROCESS-COUNTS.                                                     
           MOVE '2000-PROCESS-COUNTS ' TO PV-PARAGRAPH-NAME.                    
           IF PV-NIGHTLY-RUN                                                    
C20361                                                                          
C20361        OPEN INPUT NIGHTLY-DRIVER-FILE                                    
C20361                                                                          
C20361        READ NIGHTLY-DRIVER-FILE   INTO PV-NIGHTLY-DRIVER-FL-REC          
C20361           AT END                                                         
C20361              SET PS-END-OF-DRV-FILE TO TRUE                              
C20361        END-READ                                                          
C20361                                                                          
C20361        PERFORM                                                           
C20361            UNTIL PS-END-OF-DRV-FILE                                      
C20361            ADD 1 TO DI-CNTS                                              
C20361            PERFORM 2150-PROCESS-ACT-COUNTS-FL                            
C20361            READ NIGHTLY-DRIVER-FILE   INTO                               
C20361                 PV-NIGHTLY-DRIVER-FL-REC                                 
C20361              AT END                                                      
C20361                 SET PS-END-OF-DRV-FILE TO TRUE                           
C20361            END-READ                                                      
C20361        END-PERFORM                                                       
C20361        CLOSE NIGHTLY-DRIVER-FILE                                         
           ELSE                                                                 
             SET  PS-MORE-HOURLY-CNT TO TRUE                                    
             PERFORM 8200-OPEN-HOURLY-CNT                                       
             PERFORM 8210-FETCH-HOURLY-CNT                                      
             PERFORM                                                            
               UNTIL PS-NO-MORE-HOURLY-CNT                                      
               PERFORM 2100-PROCESS-ACT-COUNTS                                  
               PERFORM 8210-FETCH-HOURLY-CNT                                    
             END-PERFORM                                                        
             PERFORM 8220-CLOSE-HOURLY-CNT.                                     
                                                                                
      ******************************************************************        
      * 2100-PROCESS-ACT-COUNTS.                                      *         
      *  ==> CREATES IC COUNT QTY MAINT RECORDS                                 
      ******************************************************************        
       2100-PROCESS-ACT-COUNTS.                                                 
           MOVE ICT00011-CNT-STUP-ID     TO ICRD057-CNT-STUP-ID.                
           MOVE ICT00011-LOC-NBR         TO ICRD057-LOC-NBR                     
                                            TSKST-LOC-NBR                       
                                            XST00008-LOC-NBR.                   
           MOVE ICT00011-SKU-NBR         TO ICRD057-SKU-NBR                     
                                            SKXREF-SKU                          
                                            XST00010-SKU-NBR.                   
           MOVE ICT00011-LOC-NBR         TO ICRD057-UNT-RTL-AMT.                
           MOVE ICT00020-CNT-SEQ-NBR     TO ICRD057-CNT-SEQ-NBR.                
           PERFORM 8550-SELECT-OH-QTY.                                          
           PERFORM 8600-CHECK-FOR-ACTIVE.                                       
           MOVE XST00008-UNT-RTL-AMT     TO ICRD057-UNT-RTL-AMT.                
           IF XST00008-LOC-SKU-STAT-CDE < '30'                                  
             MOVE SPACE                  TO ICRD057-ORIG-CLR-DTE                
             MOVE 'Y'                    TO ICRD057-ACTIVE-IND                  
           ELSE                                                                 
             MOVE XST00008-ORIG-CLR-DTE  TO ICRD057-ORIG-CLR-DTE                
             MOVE 'N'                    TO ICRD057-ACTIVE-IND.                 
           MOVE ICT00010-EXEC-LVL-CDE TO ICRD057-EXEC-LVL-CDE.                  
           MOVE ICT00011-SKU-NBR         TO XST00010-SKU-NBR.                   
           MOVE ICT00011-LOC-NBR         TO PCT00014-LOC-NBR.                   
           PERFORM 8800-SELECT-INTRANSIT-QTY.                                   
           MOVE PCT00014-TRN-CLSN-QTY    TO ICRD057-INTRANSIT-QTY.              
           MOVE TSKST-ONHAND-QTY         TO ICRD057-LOC-EXPTED-UNT-QTY.         
           COMPUTE ICRD057-LOC-EXPTED-UNT-QTY =                                 
                   ICRD057-LOC-EXPTED-UNT-QTY  - PCT00014-TRN-CLSN-QTY.         
           MOVE PV-SUM-SLD-QTY     TO ICRD057-SALES-QTY.                        
           MOVE PV-SUM-RET-QTY     TO ICRD057-RETURN-QTY.                       
           MOVE PV-XFER-IN-QTY     TO ICRD057-XFER-IN-QTY.                      
           MOVE PV-XFER-OUT-QTY    TO ICRD057-XFER-OUT-QTY.                     
           PERFORM 7100-WRITE-QTY-MAINT-FILE.                                   
      *    IF DI-CNTS(7:3) = '000'                                              
      *      DISPLAY 'ON RECORD - ' DI-CNTS ' - '                               
      *        ICRD057-IC-CNT-QTY-MAINT-FILE.                                   
                                                                                
C20361******************************************************************        
C20361* 2150-PROCESS-ACT-COUNTS-FL.    -                              *         
C20361*  ==> CREATES IC COUNT QTY MAINT RECORDS                                 
C20361******************************************************************        
C20361 2150-PROCESS-ACT-COUNTS-FL.                                              
C20361     MOVE PV-CNT-STUP-ID           TO ICRD057-CNT-STUP-ID.                
C20361     MOVE PV-LOC-NBR               TO ICRD057-LOC-NBR                     
C20361                                      TSKST-LOC-NBR                       
C20361                                      XST00008-LOC-NBR.                   
C20361     MOVE PV-SKU-NBR               TO ICRD057-SKU-NBR                     
C20361                                      SKXREF-SKU                          
C20361                                      XST00010-SKU-NBR.                   
C20361     MOVE PV-ITM-NBR               TO TSKST-ITEM-NMBR.                    
C20361     MOVE PV-INTR-UPC-ID           TO XST00008-INTR-UPC-ID                
C20361                                      PCT00014-INTR-UPC-ID.               
C20361     MOVE PV-LOC-NBR               TO ICRD057-UNT-RTL-AMT.                
C20361     MOVE PV-CNT-SEQ-NBR           TO ICRD057-CNT-SEQ-NBR.                
C20361                                                                          
C20361     PERFORM 8551-SELECT-OH-QTY-FL.                                       
C20361     PERFORM 8601-CHECK-FOR-ACTIVE-FL.                                    
C20361                                                                          
C20361     MOVE XST00008-UNT-RTL-AMT     TO ICRD057-UNT-RTL-AMT.                
C20361                                                                          
C20361     IF  XST00008-LOC-SKU-STAT-CDE < '30'                                 
C20361         MOVE SPACE                TO ICRD057-ORIG-CLR-DTE                
C20361         MOVE 'Y'                  TO ICRD057-ACTIVE-IND                  
C20361     ELSE                                                                 
C20361         MOVE XST00008-ORIG-CLR-DTE                                       
C20361                                   TO ICRD057-ORIG-CLR-DTE                
C20361         MOVE 'N'                  TO ICRD057-ACTIVE-IND                  
C20361     END-IF.                                                              
C20361                                                                          
C20361     MOVE PV-EXEC-LVL-CDE          TO ICRD057-EXEC-LVL-CDE.               
C20361     MOVE PV-SKU-NBR               TO XST00010-SKU-NBR.                   
C20361     MOVE PV-LOC-NBR               TO PCT00014-LOC-NBR.                   
C20361     PERFORM 8801-SELECT-INTRANSIT-QTY-FL.                                
C20361     MOVE PCT00014-TRN-CLSN-QTY    TO ICRD057-INTRANSIT-QTY.              
C20361     MOVE TSKST-ONHAND-QTY         TO ICRD057-LOC-EXPTED-UNT-QTY.         
C20361                                                                          
C20361     COMPUTE ICRD057-LOC-EXPTED-UNT-QTY =                                 
C20361             ICRD057-LOC-EXPTED-UNT-QTY  - PCT00014-TRN-CLSN-QTY.         
C20361     MOVE PV-RTL-SAL-UNT-QTY       TO ICRD057-SALES-QTY.                  
C20361     MOVE PV-RTL-RET-UNT-QTY       TO ICRD057-RETURN-QTY.                 
C20361     MOVE PV-XFER-IN-UNT-QTY       TO ICRD057-XFER-IN-QTY.                
C20361     MOVE PV-XFER-OUT-UNT-QTY      TO ICRD057-XFER-OUT-QTY.               
C20361     PERFORM 7100-WRITE-QTY-MAINT-FILE.                                   
C20361                                                                          
      ******************************************************************        
      * 3000-EOJ-PROCESSING.                                           *        
      *  ==> PROCESSES:                                                *        
      *    - CLOSE FILES                                               *        
      *    - DISPLAYS PROCESSING TOTALS                                *        
      *    - TAKES A FINAL COMMIT                                      *        
      ******************************************************************        
       3000-EOJ-PROCESSING.                                                     
           MOVE '3000-EOJ-PROCESSING' TO PV-PARAGRAPH-NAME.                     
           CLOSE NIGHTLY-HOURLY-CTL-FILE                                        
                 IC-COUNT-QTY-MAINT-FILE.                                       
                                                                                
           IF PS-LAST-RUN-TMST-FOUND                                            
             PERFORM 8400-UPDATE-LAST-RUN-TMST                                  
           ELSE                                                                 
      **THIS SHOULD ONLY BE USED THE FIRST TIME THIS PGM IS RUN IN PROD         
             PERFORM 8500-INSERT-LAST-RUN-TMST.                                 
           PERFORM 9990-DISPLAY-CONTROL-INFO.                                   
                                                                                
                                                                                
      *----------------------------------------------------------               
      * 7000-READ-CTL-FILE.                                                     
      *----------------------------------------------------------               
       7000-READ-CTL-FILE.                                                      
           READ NIGHTLY-HOURLY-CTL-FILE                                         
             AT END SET PS-END-OF-CTL-FILE TO TRUE.                             
                                                                                
                                                                                
      *----------------------------------------------------------               
      * 7100-WRITE-QTY-MAINT-FILE.                                              
      *----------------------------------------------------------               
       7100-WRITE-QTY-MAINT-FILE.                                               
           WRITE IC-COUNT-QTY-MAINT-REC                                         
             FROM ICRD057-IC-CNT-QTY-MAINT-FILE.                                
                                                                                
      *----------------------------------------------------------               
      * 8200-OPEN-HOURLY-CNT.                                                   
      *      OPEN THE CURSOR OF RELEASED COUNTS.                                
      *----------------------------------------------------------               
       8200-OPEN-HOURLY-CNT.                                                    
                                                                                
           MOVE '8200-OPEN-HOURLY-CNT' TO PV-PARAGRAPH-NAME.                    
                                                                                
           PERFORM                                                              
               WITH TEST AFTER                                                  
               VARYING PV-RETRIES                                               
               FROM 1 BY 1                                                      
               UNTIL (PV-RETRIES GREATER PC-MAXIMUM-RETRY-COUNT OR              
                      PS-PROCESS-STOP                    OR                     
                      SQLCODE = 0)                                              
                                                                                
                 EXEC SQL                                                       
                    OPEN HOURLY-CNT-CSR                                         
                 END-EXEC                                                       
                                                                                
               EVALUATE TRUE                                                    
                   WHEN SQLCODE = -904                                          
                   WHEN SQLCODE = -911                                          
                   WHEN SQLCODE = -913                                          
                       CONTINUE                                                 
                   WHEN SQLCODE = 0                                             
                       CONTINUE                                                 
                   WHEN OTHER                                                   
                       SET PS-PROCESS-STOP TO TRUE                              
               END-EVALUATE                                                     
           END-PERFORM.                                                         
                                                                                
           IF PV-RETRIES GREATER PC-MAXIMUM-RETRY-COUNT OR                      
              PS-PROCESS-STOP                                                   
               SET PS-PROCESS-STOP    TO TRUE                                   
               DISPLAY '** ICKUP055 OPEN OF HOURLY-CNT CURSOR FOR '             
                       ' HAD SQLCODE OF ' SQLCODE                               
               PERFORM 9999-SQL-ABEND                                           
           END-IF.                                                              
                                                                                
      *----------------------------------------------------------               
      * 8210-FETCH-HOURLY-CNT.                                                  
      *      FETCH A RELEASED COUNTS ROW.                                       
      *----------------------------------------------------------               
       8210-FETCH-HOURLY-CNT.                                                   
                                                                                
           MOVE '8210-FETCH-HOURLY-CNT' TO PV-PARAGRAPH-NAME.                   
                                                                                
           PERFORM                                                              
               WITH TEST AFTER                                                  
               VARYING PV-RETRIES                                               
               FROM 1 BY 1                                                      
               UNTIL (PV-RETRIES GREATER PC-MAXIMUM-RETRY-COUNT OR              
                      PS-PROCESS-STOP                   OR                      
                      SQLCODE = 0                       OR                      
                      SQLCODE = +100)                                           
                                                                                
                 EXEC SQL                                                       
                    FETCH HOURLY-CNT-CSR                                        
                    INTO  :PV-SUM-SLD-QTY                                       
                         ,:PV-SUM-RET-QTY                                       
                         ,:PV-XFER-IN-QTY                                       
                         ,:PV-XFER-OUT-QTY                                      
                         ,:ICT00011-LOC-NBR                                     
                         ,:ICT00011-SKU-NBR                                     
                         ,:ICT00011-CNT-STUP-ID                                 
                         ,:ICT00010-EXEC-LVL-CDE                                
                         ,:ICT00020-CNT-SEQ-NBR                                 
                 END-EXEC                                                       
                                                                                
                EVALUATE TRUE                                                   
                    WHEN SQLCODE = -904                                         
                    WHEN SQLCODE = -911                                         
                    WHEN SQLCODE = -913                                         
                        CONTINUE                                                
                    WHEN SQLCODE = ZERO                                         
                        ADD +1 TO DI-CNTS                                       
TEST  *             DISPLAY 'HRLY CNT - '                                       
TEST  *             ' - '   ICT00011-LOC-NBR                                    
TEST  *             ' - '   ICT00011-SKU-NBR                                    
TEST  *             ' - '   ICT00011-CNT-STUP-ID                                
                    WHEN SQLCODE = +100                                         
                        SET PS-NO-MORE-HOURLY-CNT TO TRUE                       
                    WHEN OTHER                                                  
                        SET PS-PROCESS-STOP        TO TRUE                      
                END-EVALUATE                                                    
           END-PERFORM.                                                         
                                                                                
           IF PV-RETRIES GREATER PC-MAXIMUM-RETRY-COUNT OR                      
              PS-PROCESS-STOP                                                   
               SET PS-PROCESS-STOP    TO TRUE                                   
               DISPLAY '** ICKUP055 FETCH OF HOURLY-CNT CURSOR'                 
                       ' HAD SQLCODE OF ' SQLCODE                               
               PERFORM 9999-SQL-ABEND                                           
           END-IF.                                                              
                                                                                
      *-------------------------------------------------------------            
      * 8220-CLOSE-HOURLY-CNT.                                                  
      *      CLOSE THE RELEASED COUNTS CURSOR.                                  
      *-------------------------------------------------------------            
       8220-CLOSE-HOURLY-CNT.                                                   
                                                                                
           MOVE '8220-CLOSE-HOURLY-CNT' TO PV-PARAGRAPH-NAME.                   
                                                                                
           PERFORM                                                              
               WITH TEST AFTER                                                  
               VARYING PV-RETRIES                                               
               FROM 1 BY 1                                                      
               UNTIL (PV-RETRIES GREATER PC-MAXIMUM-RETRY-COUNT OR              
                      PS-PROCESS-STOP                    OR                     
                      SQLCODE = 0)                                              
                                                                                
                 EXEC SQL                                                       
                    CLOSE HOURLY-CNT-CSR                                        
                 END-EXEC                                                       
                                                                                
                EVALUATE TRUE                                                   
                   WHEN SQLCODE = -904                                          
                   WHEN SQLCODE = -911                                          
                   WHEN SQLCODE = -913                                          
                       CONTINUE                                                 
                   WHEN SQLCODE = 0                                             
                       CONTINUE                                                 
                   WHEN OTHER                                                   
                       SET PS-PROCESS-STOP TO TRUE                              
                END-EVALUATE                                                    
           END-PERFORM.                                                         
                                                                                
           IF PV-RETRIES GREATER PC-MAXIMUM-RETRY-COUNT OR                      
              PS-PROCESS-STOP                                                   
               SET PS-PROCESS-STOP    TO TRUE                                   
               DISPLAY '** ICKUP055 CLOSE OF HOURLY-CNT CURSOR'                 
                       ' HAD SQLCODE OF ' SQLCODE                               
               PERFORM 9999-SQL-ABEND                                           
           END-IF.                                                              
                                                                                
      *-------------------------------------------------------------            
      * 8300-SELECT-LAST-RUN-TMST                                               
      *      GET TIMESTAMP OF LAST RUN OF PROGRAM                               
      *-------------------------------------------------------------            
       8300-SELECT-LAST-RUN-TMST.                                               
           MOVE '8300-SELECT-LAST-RUN-TMST' TO PV-PARAGRAPH-NAME.               
           EXEC SQL                                                             
             SELECT   EXTR_PRC_DTE                                              
                     ,EXTR_PRC_TMST                                             
               INTO :ICT00007-EXTR-PRC-DTE                                      
                   ,:ICT00007-EXTR-PRC-TMST:PV-EXTR-PRC-TMST-NI                 
               FROM   ICT_CNT_EXTR_PRC    A                                     
               WHERE A.EXTR_PRC_TYP_CDE  = 'QMT'                                
           END-EXEC.                                                            
           EVALUATE TRUE                                                        
              WHEN SQLCODE = 0                                                  
                  SET PS-LAST-RUN-TMST-FOUND TO TRUE                            
              WHEN SQLCODE = +100                                               
               MOVE PC-DEFAULT-TMST TO ICT00007-EXTR-PRC-TMST                   
              WHEN OTHER                                                        
               SET PS-PROCESS-STOP    TO TRUE                                   
               DISPLAY '** ICKUP055 CHECK LAST RUN TMST'                        
                       ' HAD SQLCODE OF ' SQLCODE                               
               PERFORM 9999-SQL-ABEND                                           
           END-EVALUATE.                                                        
                                                                                
      *-------------------------------------------------------------            
      * 8400-UPDATE-LAST-RUN-TMST                                               
      *      UPDATE LAST RUN TIMESTAMP OF TO ICT_CNT_STUP_STAT TABLE            
      *-------------------------------------------------------------            
       8400-UPDATE-LAST-RUN-TMST.                                               
           MOVE '8400-UPDATE-LAST-RUN-TMST' TO PV-PARAGRAPH-NAME.               
           EXEC SQL                                                             
           UPDATE ICT_CNT_EXTR_PRC                                              
           SET EXTR_PRC_TMST = :PV-CURRENT-TMST                                 
           WHERE EXTR_PRC_TYP_CDE = 'QMT'                                       
             AND EXTR_PRC_DTE     = :ICT00007-EXTR-PRC-DTE                      
           END-EXEC.                                                            
           EVALUATE TRUE                                                        
              WHEN SQLCODE = 0                                                  
                  CONTINUE                                                      
              WHEN OTHER                                                        
               SET PS-PROCESS-STOP    TO TRUE                                   
               DISPLAY '** ICKUP055 UPDATE LAST RUN TMST'                       
                       ' HAD SQLCODE OF ' SQLCODE                               
               PERFORM 9999-SQL-ABEND                                           
           END-EVALUATE.                                                        
      *-------------------------------------------------------------            
      * 8500-INSERT-LAST-RUN-TMST                                               
      *      INSERT LAST RUN TIMESTAMP OF TO ICT_CNT_EXTR_PRC TABLE             
      *-------------------------------------------------------------            
       8500-INSERT-LAST-RUN-TMST.                                               
           MOVE '8500-INSERT-LAST-RUN-TMST' TO PV-PARAGRAPH-NAME.               
           EXEC SQL                                                             
             INSERT INTO ICT_CNT_EXTR_PRC                                       
             (EXTR_PRC_TYP_CDE                                                  
             ,EXTR_PRC_DTE                                                      
             ,EXTR_PRC_TMST)                                                    
             VALUES                                                             
             ('QMT'                                                             
             ,:PV-CURRENT-DATE                                                  
             ,:PV-CURRENT-TMST)                                                 
           END-EXEC.                                                            
           EVALUATE TRUE                                                        
              WHEN SQLCODE = 0                                                  
                  CONTINUE                                                      
              WHEN OTHER                                                        
               SET PS-PROCESS-STOP    TO TRUE                                   
               DISPLAY '** ICKUP055 INSERT LAST RUN TMST'                       
                       ' HAD SQLCODE OF ' SQLCODE                               
               PERFORM 9999-SQL-ABEND                                           
           END-EVALUATE.                                                        
                                                                                
      *-------------------------------------------------------------            
      * 8550-SELECT-OH-QTY.                                                     
      *      SELECT OHNHAND QTY                                                 
      *-------------------------------------------------------------            
       8550-SELECT-OH-QTY.                                                      
           MOVE '8550-SELECT-OH-QTY' TO PV-PARAGRAPH-NAME.                      
           EXEC SQL                                                             
             SELECT  A.ONHAND_QTY                                               
                    ,A.ITEM_NMBR                                                
             INTO   :TSKST-ONHAND-QTY                                           
                   ,:TSKST-ITEM-NMBR                                            
             FROM  TSKST    A                                                   
                  ,TSKXREF  B                                                   
             WHERE B.SKU        = :SKXREF-SKU                                   
              AND  A.LOC_NBR    = :TSKST-LOC-NBR                                
              AND  A.ITEM_NMBR = B.ITM_NBR                                      
           END-EXEC.                                                            
           EVALUATE TRUE                                                        
              WHEN SQLCODE = 0                                                  
TEST  *        DISPLAY 'O/H QTY USED            - ' SKXREF-SKU                  
TEST  *                                    ' - '    TSKST-LOC-NBR               
                  CONTINUE                                                      
              WHEN SQLCODE = +100                                               
TEST  *        DISPLAY 'O/H QTY DEFAULT TO ZERO - ' SKXREF-SKU                  
TEST  *                                    ' - '    TSKST-LOC-NBR               
               MOVE 0 TO TSKST-ONHAND-QTY                                       
              WHEN OTHER                                                        
               SET PS-PROCESS-STOP    TO TRUE                                   
               DISPLAY '** ICKUP055 CHECK FOR INV SELECT'                       
                       ' HAD SQLCODE OF ' SQLCODE                               
               PERFORM 9999-SQL-ABEND                                           
           END-EVALUATE.                                                        
                                                                                
      *-------------------------------------------------------------            
      * 8600-CHECK-FOR-ACTIVE.                                                  
      *      CHECK TO SEE IF A SKU IS ACTIVE OR CLEARANCE                       
      *-------------------------------------------------------------            
       8600-CHECK-FOR-ACTIVE.                                                   
           MOVE '8600-CHECK-FOR-ACTIVE' TO PV-PARAGRAPH-NAME.                   
           EXEC SQL                                                             
             SELECT  UNT_RTL_AMT                                                
                    ,LOC_SKU_STAT_CDE                                           
                    ,ORIG_CLR_DTE                                               
             INTO   :XST00008-UNT-RTL-AMT                                       
                   ,:XST00008-LOC-SKU-STAT-CDE                                  
                   ,:XST00008-ORIG-CLR-DTE:PV-ORIG-CLR-DTE-NULL-IND             
             FROM   XST_SKU_LOC  A                                              
                   ,XST_SKU      B                                              
             WHERE A.LOC_NBR     = :XST00008-LOC-NBR                            
              AND  A.BEG_TMST   <= CURRENT TIMESTAMP                            
              AND (A.END_TMST    > CURRENT TIMESTAMP                            
               OR  A.END_TMST    IS NULL)                                       
              AND  B.SKU_NBR     = :XST00010-SKU-NBR                            
              AND  A.INTR_UPC_ID = B.INTR_UPC_ID                                
           END-EXEC.                                                            
           EVALUATE TRUE                                                        
              WHEN SQLCODE = 0                                                  
C46632          PERFORM 8900-CHK-CLEARANCE-DATE                                 
              WHEN SQLCODE = +100                                               
                PERFORM 8700-CHECK-FOR-ACT-LOC-0                                
              WHEN OTHER                                                        
               SET PS-PROCESS-STOP    TO TRUE                                   
               DISPLAY '** ICKUP055 CHECK FOR ACT SELECT'                       
                       ' HAD SQLCODE OF ' SQLCODE                               
               PERFORM 9999-SQL-ABEND                                           
           END-EVALUATE.                                                        
                                                                                
      *-------------------------------------------------------------            
      * 8700-CHECK-FOR-ACT-LOC-0                                                
      *      CHECK TO SEE IF A SKU IS ACTIVE OR CLEARANCE                       
      *-------------------------------------------------------------            
       8700-CHECK-FOR-ACT-LOC-0.                                                
           MOVE '8700-CHECK-FOR-ACT-LOC-0' TO PV-PARAGRAPH-NAME.                
           EXEC SQL                                                             
             SELECT  UNT_RTL_AMT                                                
                    ,LOC_SKU_STAT_CDE                                           
                    ,ORIG_CLR_DTE                                               
             INTO  :XST00008-UNT-RTL-AMT                                        
                  ,:XST00008-LOC-SKU-STAT-CDE                                   
                  ,:XST00008-ORIG-CLR-DTE:PV-ORIG-CLR-DTE-NULL-IND              
             FROM   XST_SKU_LOC   A                                             
                   ,XST_SKU       B                                             
             WHERE A.LOC_NBR     = 0                                            
              AND  A.BEG_TMST   <= CURRENT TIMESTAMP                            
              AND (A.END_TMST    > CURRENT TIMESTAMP                            
               OR  A.END_TMST    IS NULL)                                       
              AND  B.SKU_NBR     = :XST00010-SKU-NBR                            
              AND  A.INTR_UPC_ID = B.INTR_UPC_ID                                
           END-EXEC.                                                            
           EVALUATE TRUE                                                        
              WHEN SQLCODE = 0                                                  
C46632         PERFORM 8900-CHK-CLEARANCE-DATE                                  
              WHEN SQLCODE = +100                                               
                MOVE '99' TO XST00008-LOC-SKU-STAT-CDE                          
                DISPLAY 'STORE NOT FOUND ' XST00010-SKU-NBR                     
              WHEN OTHER                                                        
               SET PS-PROCESS-STOP    TO TRUE                                   
               DISPLAY '** ICKUP055 CHECK FOR ACT SELECT'                       
                       ' HAD SQLCODE OF ' SQLCODE                               
               PERFORM 9999-SQL-ABEND                                           
           END-EVALUATE.                                                        
                                                                                
      *-------------------------------------------------------------            
      * 8800-SELECT-INTRANSIT-QTY.                                              
      *      CHECK TO SEE IF A COUNT HAS BEEN COMPLETED                         
      *-------------------------------------------------------------            
       8800-SELECT-INTRANSIT-QTY.                                               
           MOVE '8800-SELECT-INTRANSIT-QTY' TO PV-PARAGRAPH-NAME.               
           EXEC SQL                                                             
             SELECT A.TRN_CLSN_QTY                                              
             INTO :PCT00014-TRN-CLSN-QTY                                        
             FROM   PCT_TRN_CLSN_BAL A                                          
                   ,XST_SKU          B                                          
             WHERE B.SKU_NBR        = :XST00010-SKU-NBR                         
               AND A.LOC_NBR        = :PCT00014-LOC-NBR                         
               AND A.INTR_UPC_ID    = B.INTR_UPC_ID                             
               AND A.TRN_CLSN_CDE   = 'SE'                                      
               AND A.TRN_CLSN_QTY  >= 0                                         
             WITH CS                                                            
           END-EXEC.                                                            
           EVALUATE TRUE                                                        
              WHEN SQLCODE = 0                                                  
                continue                                                        
              WHEN SQLCODE = +100                                               
                MOVE 0 TO PCT00014-TRN-CLSN-QTY                                 
              WHEN OTHER                                                        
               SET PS-PROCESS-STOP    TO TRUE                                   
               DISPLAY '** ICKUP055 CHECK FOR CPLTD COUNT SELECT'               
                       ' HAD SQLCODE OF ' SQLCODE                               
               PERFORM 9999-SQL-ABEND                                           
           END-EVALUATE.                                                        
                                                                                
C20361*-------------------------------------------------------------            
C20361* 8551-SELECT-OH-QTY-FL.                                                  
C20361*      SELECT OHNHAND QTY                                                 
C20361*-------------------------------------------------------------            
C20361 8551-SELECT-OH-QTY-FL.                                                   
C20361     MOVE '8551-SELECT-OH-QTY-FL' TO PV-PARAGRAPH-NAME.                   
C20361     EXEC SQL                                                             
C20361       SELECT  A.ONHAND_QTY                                               
C20361              ,A.ITEM_NMBR                                                
C20361       INTO   :TSKST-ONHAND-QTY                                           
C20361             ,:TSKST-ITEM-NMBR                                            
C20361       FROM  TSKST    A                                                   
C20361       WHERE                                                              
C20361             A.LOC_NBR    = :TSKST-LOC-NBR                                
C20361        AND  A.ITEM_NMBR = :TSKST-ITEM-NMBR                               
C20361     END-EXEC.                                                            
C20361     EVALUATE TRUE                                                        
C20361        WHEN SQLCODE = 0                                                  
C20361            CONTINUE                                                      
C20361        WHEN SQLCODE = +100                                               
C20361         MOVE 0 TO TSKST-ONHAND-QTY                                       
C20361        WHEN OTHER                                                        
C20361         SET PS-PROCESS-STOP    TO TRUE                                   
C20361         DISPLAY '** ICKUP055 CHECK FOR INV SELECT'                       
C20361                 ' HAD SQLCODE OF ' SQLCODE                               
C20361         PERFORM 9999-SQL-ABEND                                           
C20361     END-EVALUATE.                                                        
C20361*-------------------------------------------------------------            
C20361* 8601-CHECK-FOR-ACTIVE-FL.                                               
C20361*      CHECK TO SEE IF A SKU IS ACTIVE OR CLEARANCE                       
C20361*-------------------------------------------------------------            
C20361 8601-CHECK-FOR-ACTIVE-FL.                                                
C20361     MOVE '8601-CHECK-FOR-ACTIVE-FL' TO PV-PARAGRAPH-NAME.                
C20361     EXEC SQL                                                             
C20361       SELECT  UNT_RTL_AMT                                                
C20361              ,LOC_SKU_STAT_CDE                                           
C20361              ,ORIG_CLR_DTE                                               
C20361       INTO   :XST00008-UNT-RTL-AMT                                       
C20361             ,:XST00008-LOC-SKU-STAT-CDE                                  
C20361             ,:XST00008-ORIG-CLR-DTE:PV-ORIG-CLR-DTE-NULL-IND             
C20361       FROM   XST_SKU_LOC  A                                              
C20361       WHERE A.LOC_NBR     = :XST00008-LOC-NBR                            
C20361        AND  A.BEG_TMST   <= CURRENT TIMESTAMP                            
C20361        AND (A.END_TMST    > CURRENT TIMESTAMP                            
C20361         OR  A.END_TMST    IS NULL)                                       
C20361        AND  A.INTR_UPC_ID = :XST00008-INTR-UPC-ID                        
C20361     END-EXEC.                                                            
C20361     EVALUATE TRUE                                                        
C20361        WHEN SQLCODE = 0                                                  
C46632          PERFORM 8900-CHK-CLEARANCE-DATE                                 
C20361        WHEN SQLCODE = +100                                               
C20361          PERFORM 8701-CHECK-FOR-ACT-LOC-0-FL                             
C20361        WHEN OTHER                                                        
C20361         SET PS-PROCESS-STOP    TO TRUE                                   
C20361         DISPLAY '** ICKUP055 CHECK FOR ACT SELECT'                       
C20361                 ' HAD SQLCODE OF ' SQLCODE                               
C20361         PERFORM 9999-SQL-ABEND                                           
C20361     END-EVALUATE.                                                        
C20361                                                                          
C20361*-------------------------------------------------------------            
C20361* 8701-CHECK-FOR-ACT-LOC-0-FL                                             
C20361*      CHECK TO SEE IF A SKU IS ACTIVE OR CLEARANCE                       
C20361*-------------------------------------------------------------            
C20361 8701-CHECK-FOR-ACT-LOC-0-FL.                                             
C20361     MOVE '8700-CHECK-FOR-ACT-LOC-0-FL' TO PV-PARAGRAPH-NAME.             
C20361     EXEC SQL                                                             
C20361       SELECT  UNT_RTL_AMT                                                
C20361              ,LOC_SKU_STAT_CDE                                           
C20361              ,ORIG_CLR_DTE                                               
C20361       INTO  :XST00008-UNT-RTL-AMT                                        
C20361            ,:XST00008-LOC-SKU-STAT-CDE                                   
C20361            ,:XST00008-ORIG-CLR-DTE:PV-ORIG-CLR-DTE-NULL-IND              
C20361       FROM   XST_SKU_LOC   A                                             
C20361       WHERE A.LOC_NBR     = 0                                            
C20361        AND  A.BEG_TMST   <= CURRENT TIMESTAMP                            
C20361        AND (A.END_TMST    > CURRENT TIMESTAMP                            
C20361         OR  A.END_TMST    IS NULL)                                       
C20361        AND  A.INTR_UPC_ID = :XST00008-INTR-UPC-ID                        
C20361     END-EXEC.                                                            
C20361     EVALUATE TRUE                                                        
C20361        WHEN SQLCODE = 0                                                  
C46632         PERFORM 8900-CHK-CLEARANCE-DATE                                  
C20361        WHEN SQLCODE = +100                                               
C20361          MOVE '99' TO XST00008-LOC-SKU-STAT-CDE                          
C20361          DISPLAY 'STORE NOT FOUND ' XST00010-SKU-NBR                     
C20361          DISPLAY 'UPC   NOT FOUND ' XST00010-INTR-UPC-ID                 
C20361        WHEN OTHER                                                        
C20361         SET PS-PROCESS-STOP    TO TRUE                                   
C20361         DISPLAY '** ICKUP055 CHECK FOR ACT SELECT'                       
C20361                 ' HAD SQLCODE OF ' SQLCODE                               
C20361         PERFORM 9999-SQL-ABEND                                           
C20361     END-EVALUATE.                                                        
C20361                                                                          
C20361*-------------------------------------------------------------            
C20361* 8801-SELECT-INTRANSIT-QTY-FL.                                           
C20361*      CHECK TO SEE IF A COUNT HAS BEEN COMPLETED                         
C20361*-------------------------------------------------------------            
C20361 8801-SELECT-INTRANSIT-QTY-FL.                                            
C20361     MOVE '8801-SELECT-INTRANSIT-QTY-FL' TO PV-PARAGRAPH-NAME.            
C20361     EXEC SQL                                                             
C20361       SELECT A.TRN_CLSN_QTY                                              
C20361       INTO :PCT00014-TRN-CLSN-QTY                                        
C20361       FROM   PCT_TRN_CLSN_BAL A                                          
C20361       WHERE                                                              
C20361             A.LOC_NBR        = :PCT00014-LOC-NBR                         
C20361         AND A.INTR_UPC_ID    = :PCT00014-INTR-UPC-ID                     
C20361         AND A.TRN_CLSN_CDE   = 'SE'                                      
C20361         AND A.TRN_CLSN_QTY  >= 0                                         
C20361       WITH CS                                                            
C20361     END-EXEC.                                                            
C20361     EVALUATE TRUE                                                        
C20361        WHEN SQLCODE = 0                                                  
C20361          continue                                                        
C20361        WHEN SQLCODE = +100                                               
C20361          MOVE 0 TO PCT00014-TRN-CLSN-QTY                                 
C20361        WHEN OTHER                                                        
C20361         SET PS-PROCESS-STOP    TO TRUE                                   
C20361         DISPLAY '** ICKUP055 CHECK FOR CPLTD COUNT SELECT'               
C20361                 ' HAD SQLCODE OF ' SQLCODE                               
C20361         PERFORM 9999-SQL-ABEND                                           
C20361     END-EVALUATE.                                                        
C20361                                                                          
C46632******************************************************************        
C46632* 8900-CHK-CLEARANCE-DATE                                     *           
C46632*  ==> PROCESSES:                                                *        
C46632*    - CHECK FOR CLEARANCE DATE                                           
C46632******************************************************************        
C46632 8900-CHK-CLEARANCE-DATE.                                                 
C46632     IF PV-ORIG-CLR-DTE-IS-NULL                                           
C46632        MOVE SPACE                  TO XST00008-ORIG-CLR-DTE              
C46632     END-IF.                                                              
      ******************************************************************        
      ******************************************************************        
      * 9990-DISPLAY-CONTROL-INFO.                                     *        
      *  ==> PROCESSES:                                                *        
      *    - DISPLAYS CONTROL INFORMATION AT END OF JOB                *        
      ******************************************************************        
       9990-DISPLAY-CONTROL-INFO.                                               
                                                                                
           DISPLAY '********************************************'.              
           DISPLAY '**** RUN STATISTICS FOR PROGRAM ICKUP055 ***'.              
           DISPLAY '****'.                                                      
           DISPLAY 'COUNT ROWS PROCESSED       :' DI-CNTS                       
           DISPLAY '****'.                                                      
           DISPLAY '**** RUN STATS END FOR PROGRAM ICKUP055  ***'.              
           DISPLAY '********************************************'.              
                                                                                
      ******************************************************************        
      * 9999-SQL-ABEND.                                                *        
      *  ==> PROCESSES:                                                *        
      *    - PERFORMS ABENDS AFTER UNEXPECTED SQLCODE                  *        
      ******************************************************************        
       9999-SQL-ABEND.                                                          
                                                                                
           MOVE SQLCODE TO PV-SQLCODE-DISPLAY.                                  
                                                                                
           DISPLAY '** ABEND **'.                                               
           DISPLAY 'ICKUP055 - ABEND'.                                          
           DISPLAY 'PARAGRAPH = ' PV-PARAGRAPH-NAME.                            
           DISPLAY 'OPERATION = ' PV-DB2-OPERATION-ATTEMPTED.                   
           DISPLAY 'SQL CODE  = ' PV-SQLCODE-DISPLAY.                           
           PERFORM 9990-DISPLAY-CONTROL-INFO.                                   
                                                                                
           COPY DPPD004.                                                        
                                                                                
           MOVE +4013 TO ABEND-CODE.                                            
           CALL 'ILBOABN0' USING ABEND-CODE.                                    
                                                                                
