000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.     APKUT333.                                        00020000
000300 AUTHOR.         SCOTT KRUSCHKA.                                  00030000
000400 DATE-WRITTEN.   03/26/2008.                                      00040000
000500 DATE-COMPILED.                                                   00050000
000600***************************************************************** 00060000
000700*  COBOL 2 WITH SQL                                             * 00070000
000800*                                                               * 00080000
000900*  DUE DATE SOURCE CODE WEEKLY EXTRACT.                         * 00090000
001000*                                                               * 00100000
001100*  CREATE WEEKLY FILE OF NET COST AMOUNT SUMMERIZED BY DUE DATE * 00110000
001110*  SOURCE CODE AND MATCH LEVEL CODE.  THIS FILE WILL THEN BE    * 00111000
001120*  FORMATTED AND FTP'D TO THE SERVER.                           * 00112000
001130*                                                               * 00113000
001140***************************************************************** 00114000
001150*---------------------------------------------------------------* 00115000
001160* CHANGE LOG:                                                   * 00116000
001170*                                                               * 00117000
001180* DATE  05/12/2008                                              * 00118000
001190*     CHANGE MADE: CREATED A LARGER WORKING STORAGE FIELD:      * 00119000
001200*     PV-SUM-INVC-NET-COST-AMT, TO CONTAIN THE SUMMATION OF THE * 00120000
001300*     INVC_NET_COST_AMT THAT IS CREATED IN THE DATESRC_CSR.     * 00130000
001400*     MADE BY: MICHELE RINDFLEISCH     WR/IR #: INC000000360282 * 00140000
001170*                                                               * 00152002
001180* DATE  01/15/2018                                              * 00153005
001190*     CHANGE MADE: ADDED A NEW PO TYPE CODE 'LE' IN THE         * 00154003
001190*     DATESRC_CSR.                                              * 00154103
001200*     MADE BY: BARB SCHULTZ            WR/IR #: CHG0181356      * 00155004
001500*---------------------------------------------------------------* 00158002
001600                                                                  00160000
001700 ENVIRONMENT DIVISION.                                            00170000
001800 CONFIGURATION SECTION.                                           00180000
001900 SOURCE-COMPUTER.    IBM-3090.                                    00190000
002000 OBJECT-COMPUTER.    IBM-3090.                                    00200000
002100                                                                  00210000
002200 INPUT-OUTPUT SECTION.                                            00220000
002300 FILE-CONTROL.                                                    00230000
002400     SELECT DATESRC-FILE     ASSIGN TO UT-S-OUT01.                00240000
002500                                                                  00250000
002600 DATA DIVISION.                                                   00260000
002700 FILE SECTION.                                                    00270000
002800                                                                  00280000
002900 FD  DATESRC-FILE                                                 00290000
003000     RECORDING MODE IS F                                          00300000
003100     LABEL RECORDS ARE STANDARD                                   00310000
003200     DATA RECORD IS DATESRC-REC.                                  00320000
003300                                                                  00330000
003400 01  DATESRC-REC                 PIC X(35).                       00340000
003500                                                                  00350000
003600 WORKING-STORAGE SECTION.                                         00360000
003700                                                                  00370000
003800 01  DATESRC-DETAIL-REC.                                          00380000
003900     05  DS-SOURCE-CDE      PIC X(01).                            00390000
004000     05  DS-DELIMIT-01      PIC X(01) VALUE ",".                  00400000
004100     05  DS-STORE           PIC X(05).                            00410000
004200     05  DS-DELIMIT-02      PIC X(01) VALUE ",".                  00420000
004300     05  DS-COUNT           PIC ---------9.                       00430000
004400     05  DS-DELIMIT-03      PIC X(01) VALUE ",".                  00440000
004500     05  DS-NET-COST-AMT    PIC ---------9.99.                    00450000
004600     05  DS-DELIMIT-04      PIC X(01) VALUE ",".                  00460000
004700     05  FILLER             PIC X(02).                            00470000
004800                                                                  00480000
004900 01  PV-PROGRAM-VARIABLES.                                        00490000
005000     05  FILLER                  PIC  X(31)  VALUE                00500000
005100         '** BEGINNING OF APKUT333 W/S **'.                       00510000
005200     05  PV-PROGRAM-NAME         PIC  X(08)  VALUE 'APKUT333'.    00520000
005300     05  PV-START-DATE           PIC  X(10)  VALUE SPACES.        00530000
005400     05  PV-END-DATE             PIC  X(10)  VALUE SPACES.        00540000
005500     05  PV-STORE                PIC  X(05)  VALUE SPACES.        00550000
005600     05  PV-COUNT                PIC  S9(09)    COMP   VALUE 0.   00560000
005700     05  PV-UNIT-COST-AMT        PIC  S9(9)V999 COMP-3 VALUE 0.   00570000
005800     05  PV-SUM-INVC-NET-COST-AMT PIC S9(9)V99 COMP-3 VALUE 0.    00580000
005900                                                                  00590000
006000 01  PC-COUNTERS.                                                 00600000
006100     05  PC-COUNT-DATESRC-READ    PIC  9(07)  VALUE ZEROS.        00610000
006200     05  PC-COUNT-DATESRC-WRITTEN PIC  9(07)  VALUE ZEROS.        00620000
006300                                                                  00630000
006400 01  PS-PROGRAM-SWITCHES.                                         00640000
006500     05  PS-END-OF-DATESRC-SW    PIC X(01)    VALUE 'N'.          00650000
006600         88  MORE-DATESRC-CSR                 VALUE 'N'.          00660000
006700         88  END-OF-DATESRC-CSR               VALUE 'Y'.          00670000
006800                                                                  00680000
006900*----------------------------------------------------------------*00690000
007000*  COMMUNICATIONS AREA2 FOR DB2                                  *00700000
007100*----------------------------------------------------------------*00710000
007200     COPY SQLCA2.                                                 00720000
007300                                                                  00730000
007400     EXEC SQL                                                     00740000
007500          INCLUDE SQLCA                                           00750000
007600     END-EXEC.                                                    00760000
007700                                                                  00770000
007800*----------------------------------------------------------------*00780000
007900*  AP CONTROL TABLE                                              *00790000
008000*----------------------------------------------------------------*00800000
008100     EXEC SQL                                                     00810000
008200          INCLUDE TAPCNTL                                         00820000
008300     END-EXEC.                                                    00830000
008400                                                                  00840000
008500*----------------------------------------------------------------*00850000
008600*  INVOICE TABLE                                                 *00860000
008700*----------------------------------------------------------------*00870000
008800     EXEC SQL                                                     00880000
008900          INCLUDE TINVOIC                                         00890000
009000     END-EXEC.                                                    00900000
009100                                                                  00910000
009200*----------------------------------------------------------------*00920000
009300*  PURCHASE ORDER HEADER TABLE                                   *00930000
009400*----------------------------------------------------------------*00940000
009500     EXEC SQL                                                     00950000
009600          INCLUDE TPURCHS                                         00960000
009700     END-EXEC.                                                    00970000
009800                                                                  00980000
009900*----------------------------------------------------------------*00990000
010000*   DATESRC CSR SUMMARIZES NET COST BY DUE DATE SOURCE CODE AND  *01000000
010100*   MATCH LEVEL CODE FOR THE WEEK.                               *01010000
010200*----------------------------------------------------------------*01020000
010300     EXEC SQL                                                     01030000
010400       DECLARE DATESRC_CSR CURSOR FOR                             01040000
010500         SELECT DUE_DTE_SRC_CDE                                   01050000
010600              , MTCH_LVL_CDE                                      01060000
010700              , COUNT(*)                                          01070000
010800              , SUM(INVC_NET_COST_AMT)                            01080000
010900           FROM TINVOIC I                                         01090000
011000          WHERE RMIT_VND_ID ^= '009206194'                        01100000
011100            AND INVC_TYP_CDE  = 'MI'                              01110000
011200            AND AP_PRC_DTE BETWEEN :PV-START-DATE                 01120000
011300                               AND :PV-END-DATE                   01130000
011400            AND NOT EXISTS                                        01140000
011500              (SELECT 1                                           01150000
011600                 FROM TPURCHS P                                   01160000
011700                WHERE P.PO_NBR = I.PO_NBR                         01170000
011800                  AND P.PO_TYP_CDE IN ('LD','IM','IE','IF','LE')  01180001
011900              )                                                   01190000
012000          GROUP BY DUE_DTE_SRC_CDE, MTCH_LVL_CDE                  01200000
012100          ORDER BY MTCH_LVL_CDE, DUE_DTE_SRC_CDE                  01210000
012200     END-EXEC.                                                    01220000
012300                                                                  01230000
012400*----------------------------------------------------------------*01240000
012500*  ABEND DATA AREAS                                              *01250000
012600*----------------------------------------------------------------*01260000
012700 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01270000
012800                                             COMP SYNC.           01280000
012900     88  AC-BAD-DATA                         VALUE +4003.         01290000
013000     88  AC-DB2-ERROR                        VALUE +4013.         01300000
013100                                                                  01310000
013200 01  ABEND-AREAS.                                                 01320000
013300     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01330000
013400             '*****       ABEND'.                                 01340000
013500     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01350000
013600             '*****   PROGRAM: APKUT333'.                         01360000
013700     05  AA-PARAGRAPH-LIT.                                        01370000
013800         10  FILLER              PIC  X(17)  VALUE                01380000
013900             '***** PARAGRAPH: '.                                 01390000
014000         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01400000
014100     05  AA-MESSAGE-LINE.                                         01410000
014200         10  FILLER              PIC  X(06)  VALUE '*****'.       01420000
014300         10  AA-MESSAGE          PIC  X(127) VALUE SPACES.        01430000
014400     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01440000
014500             '*****    DB2 ERROR'.                                01450000
014600     05  AA-DB2-OPERATION-LIT.                                    01460000
014700         10  FILLER              PIC  X(17)  VALUE                01470000
014800             '***** OPERATION: '.                                 01480000
014900         10  AA-DB2-OPERATION.                                    01490000
015000             15  AA-DB2-OP-1     PIC  X(25)  VALUE SPACES.        01500000
015100             15  AA-DB2-OP-2     PIC  X(25)  VALUE SPACES.        01510000
015200     05  AA-DB2-TABLE-1          PIC  X(08)  VALUE SPACES.        01520000
015300     05  AA-DB2-TABLE-2          PIC  X(08)  VALUE SPACES.        01530000
015400     05  AA-DB2-TABLE-3          PIC  X(08)  VALUE SPACES.        01540000
015500     05  AA-DB2-TABLE-4          PIC  X(08)  VALUE SPACES.        01550000
015600                                                                  01560000
015700     COPY DPWS004.                                                01570000
015800 01  FILLER                      PIC  X(25)  VALUE                01580000
015900     '** END OF APKUT333 W/S **'.                                 01590000
016000                                                                  01600000
016100 PROCEDURE DIVISION.                                              01610000
016200                                                                  01620000
016300 A100-MAIN.                                                       01630000
016400     PERFORM B100-INITIALIZATION.                                 01640000
016500                                                                  01650000
016600     PERFORM B200-PROCESS-DATESRC                                 01660000
016700       UNTIL END-OF-DATESRC-CSR.                                  01670000
016800                                                                  01680000
016900     PERFORM B300-END-PROGRAM.                                    01690000
017000                                                                  01700000
017100     GOBACK.                                                      01710000
017200                                                                  01720000
017300 B100-INITIALIZATION.                                             01730000
017400*----------------------------------------------------------------*01740000
017500*    OPEN OUTPUT FILE AND PERFORM INITIALIZATION.                *01750000
017600*----------------------------------------------------------------*01760000
017700     OPEN OUTPUT DATESRC-FILE.                                    01770000
017800                                                                  01780000
017900     INITIALIZE DCLTINVOIC                                        01790000
018000                DCLTPURCHS                                        01800000
018100                DATESRC-REC.                                      01810000
018200                                                                  01820000
018300     PERFORM S100-GET-DATES.                                      01830000
018400                                                                  01840000
018500     PERFORM Y100-OPEN-DATESRC-CSR.                               01850000
018600                                                                  01860000
018700     PERFORM R100-FETCH-DATESRC.                                  01870000
018800     IF END-OF-DATESRC-CSR                                        01880000
018900         DISPLAY '***  APKUT333  ***'                             01890000
019000         DISPLAY 'FIRST FETCH OF DATESRC CURSOR'                  01900000
019100         DISPLAY 'NOTHING FOUND'                                  01910000
019200         DISPLAY ' '                                              01920000
019300     END-IF.                                                      01930000
019400                                                                  01940000
019500 B200-PROCESS-DATESRC.                                            01950000
019600*----------------------------------------------------------------*01960000
019700*    CREATING OUTPUT FILE BY MOVING FIELDS FETCHED INTO THEIR    *01970000
019800*    CORRESPONDING FIELDS.                                       *01980000
019900*----------------------------------------------------------------*01990000
020000     INITIALIZE DATESRC-REC.                                      02000000
020100                                                                  02010000
020200     MOVE INVOIC-DUE-DTE-SRC-CDE   TO DS-SOURCE-CDE.              02020000
020300     EVALUATE INVOIC-MTCH-LVL-CDE                                 02030000
020400       WHEN 'P'                                                   02040000
020500         MOVE 'BULK '              TO DS-STORE                    02050000
020600       WHEN 'D'                                                   02060000
020700         MOVE 'DC   '              TO DS-STORE                    02070000
020800       WHEN OTHER                                                 02080000
020900         MOVE 'STORE'              TO DS-STORE                    02090000
021000     END-EVALUATE.                                                02100000
021100     MOVE PV-COUNT                 TO DS-COUNT.                   02110000
021200     MOVE PV-SUM-INVC-NET-COST-AMT TO DS-NET-COST-AMT.            02120000
021300     MOVE DATESRC-DETAIL-REC       TO DATESRC-REC.                02130000
021400                                                                  02140000
021500     PERFORM W100-WRITE-DATESRC-REC.                              02150000
021600                                                                  02160000
021700     PERFORM R100-FETCH-DATESRC.                                  02170000
021800                                                                  02180000
021900 B300-END-PROGRAM.                                                02190000
022000*----------------------------------------------------------------*02200000
022100*    ENDING PROCESSING: DISPLAYS COUNTS, AND CLOSES FILES.       *02210000
022200*----------------------------------------------------------------*02220000
022300     CLOSE DATESRC-FILE.                                          02230000
022400                                                                  02240000
022500     DISPLAY '       '                                            02250000
022600     DISPLAY '**********************************'                 02260000
022700     DISPLAY '******** APKUT333 SUMMARY ********'.                02270000
022800     DISPLAY 'START DATE = ' PV-START-DATE                        02280000
022900     DISPLAY 'END DATE   = ' PV-END-DATE                          02290000
023000     DISPLAY 'DATESRC FETCHED = ' PC-COUNT-DATESRC-READ.          02300000
023100     DISPLAY 'TOTAL RECORDS WRITTEN  = ' PC-COUNT-DATESRC-WRITTEN.02310000
023200     DISPLAY '**********************************'                 02320000
023300     DISPLAY '       '                                            02330000
023400                                                                  02340000
023500     PERFORM Y200-CLOSE-DATESRC-CSR.                              02350000
023600                                                                  02360000
023700 R100-FETCH-DATESRC.                                              02370000
023800*----------------------------------------------------------------*02380000
023900*  RETRIEVES THE DATESRC_CSR DATA                                *02390000
024000*----------------------------------------------------------------*02400000
024100     EXEC SQL                                                     02410000
024200         FETCH   DATESRC_CSR                                      02420000
024300          INTO  :INVOIC-DUE-DTE-SRC-CDE                           02430000
024400               ,:INVOIC-MTCH-LVL-CDE                              02440000
024500               ,:PV-COUNT                                         02450000
024600               ,:PV-SUM-INVC-NET-COST-AMT                         02460000
024700     END-EXEC.                                                    02470000
024800                                                                  02480000
024900     EVALUATE TRUE                                                02490000
025000         WHEN SQLCODE = ZERO                                      02500000
025100             ADD 1 TO PC-COUNT-DATESRC-READ                       02510000
025200         WHEN SQLCODE = +100                                      02520000
025300             SET END-OF-DATESRC-CSR TO TRUE                       02530000
025400                                                                  02540000
025500         WHEN SQLWARN0 NOT = SPACES                               02550000
025600         WHEN SQLCODE  NOT = ZERO                                 02560000
025700             MOVE 'R100-FETCH-DATESRC'                            02570000
025800                                        TO AA-PARAGRAPH-NAME      02580000
025900             MOVE 'UNSUCCESSFUL FETCH WITH DATESRC_CSR'           02590000
026000                                        TO AA-DB2-OPERATION       02600000
026100             MOVE 'TINVOIC'             TO AA-DB2-TABLE-1         02610000
026200             MOVE 'TPURCHS'             TO AA-DB2-TABLE-2         02620000
026300             MOVE SPACES                TO AA-DB2-TABLE-3         02630000
026400             MOVE SPACES                TO AA-DB2-TABLE-4         02640000
026500             PERFORM Z998-DB2-ABEND                               02650000
026600     END-EVALUATE.                                                02660000
026700                                                                  02670000
026800 S100-GET-DATES.                                                  02680000
026900*----------------------------------------------------------------*02690000
027000*    SELECT THE BEGINNING AND ENDING DATES BY USING              *02700000
027100*    PREV_WK_END_DTE.  THIS PROGRAM RUNS AFTER IT'S UPDATED      *02710000
027200*    BY APKUP076 IN JOB APK200.                                  *02720000
027300*    THE EXTRACT DATES SHOULD BE FOR MONDAY THRU SUNDAY.         *02730000
027400*----------------------------------------------------------------*02740000
027500                                                                  02750000
027600         EXEC SQL                                                 02760000
027700             SELECT  (PREV_WK_END_DTE - 5 DAYS)                   02770000
027800                    ,(PREV_WK_END_DTE + 1 DAY)                    02780000
027900               INTO  :PV-START-DATE                               02790000
028000                    ,:PV-END-DATE                                 02800000
028100               FROM  TAPCNTL                                      02810000
028200         END-EXEC.                                                02820000
028300                                                                  02830000
028400         EVALUATE TRUE                                            02840000
028500           WHEN SQLCODE = ZERO                                    02850000
028600             CONTINUE                                             02860000
028700           WHEN SQLWARN0 NOT = SPACES                             02870000
028800           WHEN SQLCODE NOT  = ZERO                               02880000
028900             MOVE 'S100-GET-DATES'                                02890000
029000                                 TO AA-PARAGRAPH-NAME             02900000
029100             MOVE 'UNSUCCESSFUL SELECT'                           02910000
029200                                 TO AA-DB2-OPERATION              02920000
029300             MOVE 'TAPCNTL'      TO AA-DB2-TABLE-1                02930000
029400             MOVE SPACES         TO AA-DB2-TABLE-2                02940000
029500                                    AA-DB2-TABLE-3                02950000
029600                                    AA-DB2-TABLE-4                02960000
029700             PERFORM Z998-DB2-ABEND                               02970000
029800         END-EVALUATE.                                            02980000
029900                                                                  02990000
030000 W100-WRITE-DATESRC-REC.                                          03000000
030100*----------------------------------------------------------------*03010000
030200*    WRITE THE RECORDS TO THE FILE                               *03020000
030300*----------------------------------------------------------------*03030000
030400                                                                  03040000
030500     WRITE DATESRC-REC.                                           03050000
030600                                                                  03060000
030700     ADD 1 TO PC-COUNT-DATESRC-WRITTEN.                           03070000
030800                                                                  03080000
030900 Y100-OPEN-DATESRC-CSR.                                           03090000
031000*---------------------------------------------------------------- 03100000
031100*    OPEN DATESRC_CSR CURSOR.                                     03110000
031200*---------------------------------------------------------------- 03120000
031300                                                                  03130000
031400     EXEC SQL                                                     03140000
031500         OPEN DATESRC_CSR                                         03150000
031600     END-EXEC.                                                    03160000
031700                                                                  03170000
031800     EVALUATE TRUE                                                03180000
031900         WHEN SQLCODE = ZERO                                      03190000
032000             CONTINUE                                             03200000
032100         WHEN SQLWARN0 NOT = SPACES                               03210000
032200         WHEN SQLCODE  NOT = ZERO                                 03220000
032300             MOVE 'Y100-OPEN-DATESRC-CSR'                         03230000
032400                                 TO AA-PARAGRAPH-NAME             03240000
032500             MOVE 'UNSUCCESSFUL OPEN ON DATESRC_CSR'              03250000
032600                                 TO AA-DB2-OPERATION              03260000
032700             MOVE 'TINVOIC'      TO AA-DB2-TABLE-1                03270000
032800             MOVE 'TPURCHS'      TO AA-DB2-TABLE-2                03280000
032900             MOVE SPACES         TO AA-DB2-TABLE-3                03290000
033000             MOVE SPACES         TO AA-DB2-TABLE-4                03300000
033100             MOVE SPACES         TO AA-MESSAGE                    03310000
033200             PERFORM Z998-DB2-ABEND                               03320000
033300     END-EVALUATE.                                                03330000
033400                                                                  03340000
033500 Y200-CLOSE-DATESRC-CSR.                                          03350000
033600*---------------------------------------------------------------- 03360000
033700*    CLOSE THE DATESRC_CSR CURSOR.                              * 03370000
033800*---------------------------------------------------------------- 03380000
033900                                                                  03390000
034000     EXEC SQL                                                     03400000
034100         CLOSE DATESRC_CSR                                        03410000
034200     END-EXEC.                                                    03420000
034300                                                                  03430000
034400     EVALUATE TRUE                                                03440000
034500         WHEN SQLCODE = ZERO                                      03450000
034600              CONTINUE                                            03460000
034700                                                                  03470000
034800         WHEN SQLWARN0 NOT = SPACES                               03480000
034900         WHEN SQLCODE  NOT = ZERO                                 03490000
035000             MOVE 'Y200-CLOSE-DATESRC-CSR'                        03500000
035100                                 TO AA-PARAGRAPH-NAME             03510000
035200             MOVE 'UNSUCCESSFUL CLOSE ON DATESRC_CSR'             03520000
035300                                 TO AA-DB2-OPERATION              03530000
035400             MOVE 'TINVOIC'      TO AA-DB2-TABLE-1                03540000
035500             MOVE 'TPURCHS'      TO AA-DB2-TABLE-2                03550000
035600             MOVE SPACES         TO AA-DB2-TABLE-3                03560000
035700             MOVE SPACES         TO AA-DB2-TABLE-4                03570000
035800             MOVE SPACES         TO AA-MESSAGE                    03580000
035900             PERFORM Z998-DB2-ABEND                               03590000
036000     END-EVALUATE.                                                03600000
036100                                                                  03610000
036200 Z998-DB2-ABEND.                                                  03620000
036300*----------------------------------------------------------------*03630000
036400*    ABEND ROUTINE FOR DB2 ERRORS                                *03640000
036500*----------------------------------------------------------------*03650000
036600     CLOSE DATESRC-FILE.                                          03660000
036700                                                                  03670000
036800     DISPLAY AA-ABEND-LIT.                                        03680000
036900     DISPLAY AA-DB2-ERROR-LIT.                                    03690000
037000     DISPLAY AA-PROGRAM-LIT.                                      03700000
037100     DISPLAY AA-PARAGRAPH-LIT.                                    03710000
037200     DISPLAY AA-DB2-OPERATION-LIT.                                03720000
037300     DISPLAY AA-DB2-TABLE-1.                                      03730000
037400     DISPLAY AA-DB2-TABLE-2.                                      03740000
037500     DISPLAY AA-DB2-TABLE-3.                                      03750000
037600     DISPLAY AA-DB2-TABLE-4.                                      03760000
037700     SET AC-DB2-ERROR TO TRUE.                                    03770000
037800                                                                  03780000
037900     COPY DPPD004.                                                03790000
038000                                                                  03800000
038100     CALL 'ILBOABN0' USING ABEND-CODE.                            03810000
038200                                                                  03820000
