000100******************************************************************00010000
000200*  I M P O R T A N T --- WHEN COMPILING THIS PROGRAM THE MQ SERIES00020000
000300*  SWITCH ON THE 2ND COMPILE SCREEN NEEDS TO BE SET TO 'Y'.       00030000
000400*  THIS PROGRAM USES MQSERIES.                                    00040000
000500******************************************************************00050000
000600 IDENTIFICATION DIVISION.                                         00060000
000700 PROGRAM-ID.             SNKUP100.                                00070000
000800 AUTHOR.                 MIKE MACHNIK.                            00080071
000900 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00090000
001000 DATE-WRITTEN.           OCTOBER 2005.                            00100000
001100 DATE-COMPILED.                                                   00110000
001200******************************************************************00120000
001300*           A S N   D O W N L O A D   F R O M   M Q               00130006
001400*                                                                 00140000
001500* THIS PROGRAM WILL READ ADVANCE SHIP NOTICES FROM THE EDI MQ     00150000
001600* QUEUE (SN.ASN.FROM.EDI.Q). THIS PROGRAM WILL THEN PARSE THE     00160000
001700* MESSAGE INTO 350 BYTE RECS AND LOAD THE DATA INTO DB2 TABLES:   00170000
001800* SNT_DAT_CNTL (ASN DATA TRANSFER CONTROL) AND SNT_DAT_XFER       00180000
001900* (ASN DATA TRANSFER DETAIL). THE COPYBOOK SNRD005 CONTAINS       00190039
002000* THE REC TYPES FOUND IN THE MSGS. EACH RECORD IS 350 BYTES.      00200000
002100*                                                                 00210019
002200* JUST PRIOR TO COMMITTING THE DATA UPON INSERTING ALL ROWS       00220019
002300* OF AN ASN, THE PROGRAM WILL INSERT A MESSAGE INTO A MQ QUEUE,   00230029
002400* SN.ASN.READY.INPUT.Q, WHICH WILL TRIGGER ANOTHER STARTED TASK.  00240029
002500*                                                                 00250019
002600* STARTED TASK:                                                   00260000
002700* -------------                                                   00270000
002800* THIS PROGRAM RUNS IN A REGULAR JOB - SNASNMQ. IT RUNS           00280000
002900* CONTINUOUSLY UNTIL IT ENCOUNTERS THE "END RUN OF PROGRAM"       00290000
003000* MESSAGE THAT WILL BE SENT TO THE ASN QUEUE FROM PROGRAM         00300000
003100* SNKUP101 USING AN MQPUT1 CALL.                                  00310000
003200*                                                                 00320000
003300* ASSUMPTIONS ABOUT THE MESSAGES COMING FROM EDI:                 00330000
003400* -----------------------------------------------                 00340000
003500* 1) THE RECORDS WILL BE BUNDLED 20 RECORDS TO AN MQ MESSAGE.     00350005
003600*                                                                 00360005
003700* 2) THE LAST RECORD TYPE FOR EVERY ASN WILL BE 'END'.            00370005
003800*    THAT IS HOW THE PROGRAM WILL DETERMINE THE FINISH OF         00380005
003900*    ONE ASN AND THE START OF ANOTHER.                            00390005
004000*                                                                 00400000
004100* UNITS OF WORK AND COMMITS:                                      00410000
004200* --------------------------                                      00420000
004300* A UNIT OF WORK FOR A DB2 COMMIT WILL BE COMPLETE WHEN ALL       00430005
004400* MESSAGES FOR AN ASN HAVE BEEN READ FROM THE QUEUE, A CONTROL    00440005
004500* ROW HAS BEEN INSERTED TO SNT_DAT_CNTL & EACH 350 BYTE RECORD    00450005
004600* HAS BEEN INSERTED TO SNT_DAT_XFER. THE DB2 COMMIT IS PERFORMED, 00460005
004700* THEN AN MQ COMMIT WILL BE PERFORMED TO PERMANENTLY 'REMOVE' THE 00470000
004800* MESSAGES FROM THE ASN QUEUE.                                    00480007
004900*                                                                 00490000
005000* ON LARGER ASNS, COMMITS WILL NEED TO BE TAKEN ON EVERY 10,000   00500086
005100* ROWS INSERTED/UPDATED ON THE DB2 TABLES.  PER BEST PRACTICES,   00510086
005200* AN MQ COMMIT WILL ALWAYS FOLLOW A DB2 COMMIT.                   00520086
005300******************************************************************00530000
005400 ENVIRONMENT DIVISION.                                            00540000
005500******************************************************************00550000
005600 CONFIGURATION SECTION.                                           00560000
005700 SOURCE-COMPUTER.        IBM-3090.                                00570000
005800 OBJECT-COMPUTER.        IBM-3090.                                00580000
005900                                                                  00590000
006000 INPUT-OUTPUT SECTION.                                            00600000
006100 FILE-CONTROL.                                                    00610000
006200* ------------------------------------------------------------- * 00620000
006300*  CONTROL CARD 1 = QUEUE MANAGER NAME                            00630000
006400*  READ CONTROL CARD TO GET QUEUE MANAGER NAME                    00640000
006500* ------------------------------------------------------------- * 00650000
006600     SELECT CONTROL-CARD-1                                        00660000
006700     FILE STATUS IS CONTROL-CARD-1-STATUS                         00670000
006800     ASSIGN TO UT-S-INP01.                                        00680000
006900                                                                  00690000
007000* ------------------------------------------------------------- * 00700000
007100*  CONTROL CARD 2 = TRANSACTION QUEUE NAME                        00710000
007200*  READ CONTROL CARD TO GET TRANSACTION QUEUE NAME FOR ASN        00720008
007300*  ORDER READS.                                                   00730028
007400* ------------------------------------------------------------- * 00740000
007500     SELECT CONTROL-CARD-2                                        00750000
007600     FILE STATUS IS CONTROL-CARD-2-STATUS                         00760000
007700     ASSIGN TO UT-S-INP02.                                        00770000
007800                                                                  00780000
007900* ------------------------------------------------------------- * 00790051
008000*  EMAIL FILE                                                     00800051
008100* ------------------------------------------------------------- * 00810051
008200     SELECT EMAIL-MSG-FILE                                        00820051
008300     ASSIGN TO UT-S-OUT01.                                        00830051
008400                                                                  00840028
008500******************************************************************00850000
008600 DATA DIVISION.                                                   00860000
008700******************************************************************00870000
008800 FILE SECTION.                                                    00880000
008900                                                                  00890000
009000 FD  CONTROL-CARD-1                                               00900000
009100     RECORDING MODE F                                             00910000
009200     BLOCK CONTAINS 0 RECORDS                                     00920000
009300     LABEL RECORDS ARE OMITTED.                                   00930000
009400 01  CONTROL-CARD-1-LINE              PIC  X(80).                 00940000
009500                                                                  00950000
009600 FD  CONTROL-CARD-2                                               00960000
009700     RECORDING MODE F                                             00970000
009800     BLOCK CONTAINS 0 RECORDS                                     00980000
009900     LABEL RECORDS ARE OMITTED.                                   00990000
010000 01  CONTROL-CARD-2-LINE              PIC  X(80).                 01000000
010100                                                                  01010051
010200 FD  EMAIL-MSG-FILE                                               01020051
010300     RECORDING MODE F                                             01030051
010400     BLOCK CONTAINS 0 RECORDS                                     01040051
010500     LABEL RECORDS ARE STANDARD.                                  01050051
010600 01  EMAIL-MSG-FILE-RECORD            PIC  X(80).                 01060051
010700                                                                  01070028
010800******************************************************************01080000
010900 WORKING-STORAGE SECTION.                                         01090000
011000******************************************************************01100000
011100 01  PS-PROGRAM-SWITCHES.                                         01110006
011200     05  PS-CONTROL-CARD-1-END-SW    PIC  X(01) VALUE 'N'.        01120006
011300         88  PS-CONTROL-CARD-1-END-YES          VALUE 'Y'.        01130006
011400         88  PS-CONTROL-CARD-1-END-NO           VALUE 'N'.        01140006
011500     05  PS-CONTROL-CARD-2-END-SW    PIC  X(01) VALUE 'N'.        01150006
011600         88  PS-CONTROL-CARD-2-END-YES          VALUE 'Y'.        01160006
011700         88  PS-CONTROL-CARD-2-END-NO           VALUE 'N'.        01170006
011800     05  PS-TIME-TO-END-PROGRAM-SW   PIC  X(01) VALUE 'N'.        01180006
011900         88  PS-TIME-TO-END-PROGRAM-YES         VALUE 'Y'.        01190006
012000         88  PS-TIME-TO-END-PROGRAM-NO          VALUE 'N'.        01200006
012100     05  PS-LOAD-XFER-SW             PIC  X(01) VALUE 'N'.        01210006
012200         88  PS-LOAD-XFER-YES                   VALUE 'Y'.        01220006
012300         88  PS-LOAD-XFER-NO                    VALUE 'N'.        01230006
012400     05  PS-FIRST-MQ-MSG-SW          PIC  X(01) VALUE 'N'.        01240009
012500         88  PS-FIRST-MQ-MSG-YES                VALUE 'Y'.        01250009
012600         88  PS-FIRST-MQ-MSG-NO                 VALUE 'N'.        01260009
012700     05  PS-END-OF-ASN-SW            PIC  X(01) VALUE 'N'.        01270009
012800         88  PS-END-OF-ASN-YES                  VALUE 'Y'.        01280009
012900         88  PS-END-OF-ASN-NO                   VALUE 'N'.        01290009
013000     05  PS-FAIL-SW                  PIC  X(01) VALUE 'N'.        01300069
013100         88  PS-IN-FAIL-STATUS                  VALUE 'Y'.        01310069
013200         88  PS-NOT-IN-FAIL-STATUS              VALUE 'N'.        01320069
013300     05  PS-CORPORATE-ASN-SW         PIC  X(01) VALUE 'N'.        01330022
013400         88  PS-CORPORATE-ASN-YES               VALUE 'Y'.        01340022
013500         88  PS-CORPORATE-ASN-NO                VALUE 'N'.        01350022
013600     05  PS-WAITING-FOR-END-SW       PIC  X(01) VALUE 'N'.        01360045
013700         88  PS-WAITING-FOR-END-YES             VALUE 'Y'.        01370045
013800         88  PS-WAITING-FOR-END-NO              VALUE 'N'.        01380045
013900     05  PS-FIRST-ROW-IS-ID-SW       PIC  X(01) VALUE 'N'.        01390088
014000         88  PS-FIRST-ROW-IS-ID-YES             VALUE 'Y'.        01400088
014100         88  PS-FIRST-ROW-IS-ID-NO              VALUE 'N'.        01410088
014200                                                                  01420006
014300 01  PC-PROGRAM-CONSTANTS.                                        01430006
014400     05  PC-MAX-RETRIES              PIC S9(03) VALUE +5 COMP-3.  01440006
014500     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08) VALUE 'SNKUP100'. 01450006
014600     05  PC-L                        PIC  X(01) VALUE 'L'.        01460006
014700     05  PC-R                        PIC  X(01) VALUE 'R'.        01470008
014800     05  PC-F                        PIC  X(01) VALUE 'F'.        01480041
014900     05  PC-STAT                     PIC  X(01) VALUE 'R'.        01490089
015000     05  PC-DEFAULT-TMST             PIC  X(26) VALUE             01500006
015100                                    '0001-01-01-00.00.00.000000'. 01510006
015200     05  PC-END-RUN-MSG              PIC  X(18) VALUE             01520006
015300                                    'END RUN OF PROGRAM'.         01530006
015400                                                                  01540006
015500 01  ABEND-CODE                      PIC S9(04) VALUE +0          01550006
015600                                                COMP SYNC.        01560006
015700 01  PV-PROGRAM-VARIABLES.                                        01570006
015800     05  PV-CURRENT-TMST             PIC  X(26) VALUE SPACES.     01580006
015900     05  PV-PARAGRAPH                PIC  X(48) VALUE SPACES.     01590006
016000     05  PV-REC-SEQ-NBR              PIC S9(09) VALUE +0 COMP.    01600006
016100     05  PV-MSG-LENGTH               PIC S9(09) BINARY.           01610006
016200     05  PV-DATA-LENGTH              PIC S9(09) BINARY.           01620006
016300     05  PV-HOLD-COMPLETION-CODE     PIC S9(09) BINARY.           01630006
016400     05  PV-HOLD-REASON              PIC S9(09) BINARY.           01640006
016500     05  PV-HOLD-CORRELID            PIC  X(24) VALUE SPACES.     01650006
016600     05  PV-RETRY-COUNTER            PIC S9(04) VALUE +0          01660006
016700                                                COMP SYNC.        01670006
016800     05  PV-CURRENT-PRC-CNTL-TMST    PIC  X(26) VALUE SPACES.     01680006
016900     05  FILLER REDEFINES PV-CURRENT-PRC-CNTL-TMST.               01690008
017000         10  PV-TMST-CCYY            PIC  9(04).                  01700006
017100         10  PV-TMST-H1              PIC  X(01).                  01710006
017200         10  PV-TMST-MM              PIC  9(02).                  01720006
017300         10  PV-TMST-H2              PIC  X(01).                  01730006
017400         10  PV-TMST-DD              PIC  9(02).                  01740006
017500         10  PV-TMST-H3              PIC  X(01).                  01750006
017600         10  PV-TMST-HR              PIC  9(02).                  01760006
017700         10  PV-TMST-P1              PIC  X(01).                  01770006
017800         10  PV-TMST-MIN             PIC  9(02).                  01780006
017900         10  PV-TMST-P2              PIC  X(01).                  01790006
018000         10  PV-TMST-SEC             PIC  9(02).                  01800006
018100         10  PV-TMST-P2              PIC  X(01).                  01810006
018200         10  PV-TMST-LAST6           PIC  9(06).                  01820006
018300     05  PV-ASN-TYPE                 PIC  X(01) VALUE SPACES.     01830024
018400*----------------------------------------------------------       01840051
018500* EM - EMAIL MESSAGE DATA LINES                                   01850051
018600*----------------------------------------------------------       01860051
018700 01  EM-EMAIL-MESSAGE-DATA-LINES.                                 01870051
018800     05  EM-DATA-LINE-1           PIC X(80)  VALUE                01880051
018900           'HELO KOHLS@KOHLS.COM'.                                01890051
019000     05  EM-DATA-LINE-2           PIC X(80)  VALUE                01900051
019100           'MAIL FROM: <KOHLSBATCHMAIL@KOHLS.COM>'.               01910051
019200     05  EM-DATA-LINE-3           PIC X(80)  VALUE                01920051
019300           'RCPT TO: <IS-REALTIMEASN@KOHLS.COM>'.                 01930064
019400     05  EM-DATA-LINE-4           PIC X(80)  VALUE                01940051
019500           'DATA'.                                                01950051
019600     05  EM-DATA-LINE-5           PIC X(80)  VALUE                01960051
019700           'TO: IS-REALTIMEASN'.                                  01970064
019800     05  EM-DATA-LINE-6.                                          01980051
019900         10  EM-DATA-LINE-6-TXT   PIC X(56)  VALUE                01990051
020000       'SUBJECT: REALTIME ASN MQ MESSAGE HANDLER ISSUES'.         02000054
020100         10  EM-DATA-LINE-6-QM    PIC X(04)  VALUE SPACES.        02010051
020200         10  FILLER               PIC X(20)  VALUE SPACES.        02020051
020300     05  EM-DATA-LINE-7           PIC X(80)  VALUE                02030051
020400           'REVIEW SNASNMQ SYSOUT FOR MESSAGE ERRORS'.            02040058
020500                                                                  02050006
020600*PV-DTL IS WHAT GETS BROKEN DOWN INTO SEPARATE RECORDS.           02060006
020700 01  PV-MSG-IN.                                                   02070030
020800     05  PV-DTL                      PIC  X(7000) VALUE SPACES.   02080006
020900     05  PV-DTL-OVERFLOW             PIC  X(03) VALUE SPACES.     02090006
021000                                                                  02100006
021100 01  PV-DTL-TABLE                    PIC  X(7000).                02110006
021200 01  FILLER REDEFINES PV-DTL-TABLE.                               02120006
021300     05  PV-DTL-ENTRY OCCURS 20 TIMES INDEXED BY DTL-INDEX.       02130006
021400         10  PV-DTL-RECORD           PIC X(350).                  02140006
021500                                                                  02150006
021600 01  PV-MSG-OUT.                                                  02160030
021700     05  PV-MQ-OUT-KEY               PIC  9(09) VALUE ZEROES.     02170030
021800     05  PV-MQ-OUT-TMST              PIC  X(26) VALUE SPACES.     02180030
021900                                                                  02190030
022000 01  PA-PROGRAM-ACCUMULATORS.                                     02200006
022100     05  PA-CNTL-INSERTS             PIC S9(09) VALUE +0 COMP-3.  02210006
022200     05  PA-CNTL-INSERTS-C           PIC S9(09) VALUE +0 COMP-3.  02220024
022300     05  PA-XFER-INSERTS             PIC S9(09) VALUE +0 COMP-3.  02230006
022400     05  PA-MQGETS                   PIC S9(09) VALUE +0 COMP-3.  02240006
022500     05  PA-DB2-COMMITS              PIC S9(09) VALUE +0 COMP-3.  02250006
022600     05  PA-MQ-COMMITS               PIC S9(09) VALUE +0 COMP-3.  02260006
022700     05  PA-ROW-COUNT                PIC S9(09) VALUE +0 COMP-3.  02270086
022800                                                                  02280006
022900* COMMUNICATIONS AREA FOR DB2                                     02290000
023000     EXEC SQL                                                     02300000
023100         INCLUDE SQLCA                                            02310000
023200     END-EXEC.                                                    02320000
023300                                                                  02330000
023400* DB2 TABLE DECLARATION                                           02340000
023500* (SNT_DAT_CNTL - ASN DATA TRANSFER CONTROL TABLE)                02350000
023600     EXEC SQL                                                     02360000
023700         INCLUDE SNT00000                                         02370008
023800     END-EXEC.                                                    02380000
023900                                                                  02390000
024000* DB2 TABLE DECLARATION                                           02400000
024100* (SNT_DAT_XFER - ASN DATA TRANSFER DETAIL TABLE)                 02410000
024200     EXEC SQL                                                     02420000
024300         INCLUDE SNT00001                                         02430008
024400     END-EXEC.                                                    02440000
024500                                                                  02450000
024600* INPUT LAYOUT - ASN DTL RECORD COPYBOOK - UNPACKED.              02460039
024700     COPY SNRD005.                                                02470039
024800                                                                  02480000
024900*  DB2 FORMATTED MESSAGE AREA.                                    02490012
025000     COPY DPWS004.                                                02500000
025100                                                                  02510051
025200*  PARAMETER LIST FOR THE DYNAMIC ALLOCATION ROUTINE              02520051
025300     COPY DPWS023.                                                02530051
025400***************************************************************** 02540000
025500* FILE OPEN STATUS'S ON THE CONTROL CARDS USED FOR GETTING        02550000
025600* MQ-SERIES QUEUE MANAGER AND QUEUE NAME.                         02560000
025700***************************************************************** 02570000
025800 01  CONTROL-CARD-1-STATUS           PIC  X(02) VALUE '00'.       02580000
025900     88  CONTROL-CARD-1-SUCCESS                 VALUE '00'.       02590000
026000     88  CONTROL-CARD-1-ERROR                   VALUE '42'.       02600000
026100 01  CONTROL-CARD-2-STATUS           PIC  X(02) VALUE '00'.       02610000
026200     88  CONTROL-CARD-2-SUCCESS                 VALUE '00'.       02620000
026300     88  CONTROL-CARD-2-ERROR                   VALUE '42'.       02630000
026400                                                                  02640000
026500 01  PV-ABEND-VARIABLES.                                          02650000
026600     05  PV-ABEND-CODE               PIC S9(4) VALUE +0 COMP SYNC.02660004
026700     88  ABEND-4001-WRITE-ERROR                VALUE +4001.       02670000
026800     88  ABEND-4002-READ-ERROR                 VALUE +4002.       02680000
026900     88  ABEND-4003-CTRL-CARD-ERROR            VALUE +4003.       02690000
027000     88  ABEND-4004-TABLE-ERROR                VALUE +4004.       02700000
027100     88  ABEND-4005-OPEN-ERROR                 VALUE +4005.       02710000
027200     88  ABEND-4006-CLOSE-ERROR                VALUE +4006.       02720000
027300     88  ABEND-4007-SEQUENCE-ERROR             VALUE +4007.       02730000
027400     88  ABEND-4008-DATA-ERROR                 VALUE +4008.       02740000
027500     88  ABEND-4009-KEY-DATA-ERROR             VALUE +4009.       02750000
027600     88  ABEND-4013-DB2-ERROR                  VALUE +4013.       02760000
027700     88  ABEND-4019-CAL-SUB-ERROR              VALUE +4019.       02770000
027800     88  ABEND-4020-MQ-ERROR                   VALUE +4020.       02780000
027900     88  ABEND-4444-FORCED-ABEND               VALUE +4444.       02790000
028000                                                                  02800000
028100 01  PE-MQ-ABEND-VARIABLES.                                       02810000
028200     10  PE-MQ-QMANAGER             PIC  X(05) VALUE SPACES.      02820000
028300     10  PE-MQ-QNAME                PIC  X(30) VALUE SPACES.      02830000
028400     10  PE-MQ-COMPLETION-CODE      PIC  9(04) VALUE ZEROES.      02840000
028500     10  PE-MQ-REASON-CODE          PIC  9(04) VALUE ZEROES.      02850000
028600                                                                  02860000
028700****************************************************************  02870000
028800**     M Q   S E R I E S    W O R K I N G   S T O R A G E     **  02880000
028900**                                                            **  02890000
029000**                  M  Q    C O P Y B O O K S                 **  02900000
029100****************************************************************  02910000
029200 01  MQM-OBJECT-DESCRIPTOR.                                       02920000
029300     COPY CMQODV.                                                 02930000
029400                                                                  02940000
029500 01  MQM-MESSAGE-DESCRIPTOR.                                      02950000
029600     COPY CMQMDV.                                                 02960000
029700                                                                  02970000
029800 01  MQM-GET-MESSAGE-OPTIONS.                                     02980000
029900     COPY CMQGMOV.                                                02990000
030000                                                                  03000000
030100 01  MQM-PUT-MESSAGE-OPTIONS.                                     03010000
030200     COPY CMQPMOV.                                                03020000
030300                                                                  03030000
030400 01  MQM-CONSTANTS.                                               03040000
030500     COPY CMQV.                                                   03050000
030600                                                                  03060000
030700****************************************************************  03070000
030800**      CONTROL CARDS FOR QUEUE MANAGER AND QUEUE NAMES       **  03080000
030900**                                                            **  03090000
031000****************************************************************  03100000
031100* ------------------------------------------------------------- * 03110000
031200*  CONTROL CARD 1 = QUEUE MANAGER NAME                            03120000
031300*  READ CONTROL CARD TO GET QUEUE MANAGER NAME                    03130000
031400* ------------------------------------------------------------- * 03140000
031500 01  CC-CONTROL-CARD-1.                                           03150000
031600     05  CC-QMGR-NAME               PIC X(48).                    03160000
031700     05  FILLER                     PIC X(32).                    03170000
031800                                                                  03180000
031900* ------------------------------------------------------------- * 03190000
032000*  CONTROL CARD 2 = TRANSACTION QUEUE NAME                        03200000
032100*  READ CONTROL CARD TO GET THE 'GET' TRANSACTION QUEUE NAME      03210028
032200* ------------------------------------------------------------- * 03220000
032300 01  CC-CONTROL-CARD-2.                                           03230000
032400     05  CC-ASN-ORDER-QUEUE-NAME-I  PIC X(48).                    03240028
032500     05  FILLER                     PIC X(32).                    03250000
032600                                                                  03260000
032700****************************************************************  03270000
032800** MQ SERIES CONSTANTS FOR CALLING MODULES SUCH AS PUT AND    **  03280000
032900** OPEN, CONNECT, DISCONNECT.                                 **  03290000
033000****************************************************************  03300000
033100 01  MQ-WORKING-STORAGE.                                          03310000
033200     05  PC-MQCONN                  PIC X(08) VALUE 'CSQBCONN'.   03320000
033300     05  PC-MQOPEN                  PIC X(08) VALUE 'CSQBOPEN'.   03330000
033400     05  PC-MQINQ                   PIC X(08) VALUE 'CSQBINQ'.    03340000
033500     05  PC-MQPUT                   PIC X(08) VALUE 'CSQBPUT'.    03350000
033600     05  PC-MQGET                   PIC X(08) VALUE 'CSQBGET'.    03360000
033700     05  PC-MQCMIT                  PIC X(08) VALUE 'CSQBCOMM'.   03370000
033800     05  PC-MQBACK                  PIC X(08) VALUE 'CSQBBACK'.   03380000
033900     05  PC-MQCLOSE                 PIC X(08) VALUE 'CSQBCLOS'.   03390000
034000     05  PC-MQDISC                  PIC X(08) VALUE 'CSQBDISC'.   03400000
034100     05  PC-QMGR-NAME               PIC X(04) VALUE SPACES.       03410000
034200         88  PC-PROD-QMGR-NAME                VALUE 'QKSP'.       03420000
034300         88  PC-ACCEPT-QMGR-NAME              VALUE 'QKSQ'.       03430000
034400         88  PC-TEST-QMGR-NAME                VALUE 'QKST'.       03440000
034500     05  PC-RESPONSE-QNAME          PIC X(30) VALUE SPACES.       03450000
034600     05  PC-WAIT-15-SECS            PIC S9(9) VALUE 15000.        03460000
034700     05  PC-WAIT-6-SECS             PIC S9(9) VALUE 6000.         03470000
034800     05  PC-DELAY-INTERVAL.                                       03480000
034900         10  FILLER                 PIC X(2)  VALUE SPACES.       03490000
035000         10  PC-DELAY-TIME          PIC 9(8)  VALUE 1500.         03500000
035100                                                                  03510000
035200****************************************************************  03520000
035300** QUEUE MANAGER HANDLE                                           03530000
035400*  QUEUE HANDLES                                                  03540000
035500****************************************************************  03550000
035600 01 PV-MQ-PROGRAM-HANDLES.                                        03560000
035700     05  PV-QMGR-NAME               PIC X(48).                    03570000
035800     05  PV-HCONN                   PIC S9(9) BINARY VALUE 0.     03580000
035900     05  PV-GQ-HANDLE               PIC S9(9) BINARY VALUE 0.     03590000
036000     05  PV-PQ-HANDLE               PIC S9(9) BINARY VALUE 0.     03600000
036100     05  PV-INPUT-HANDLE            PIC S9(9) BINARY VALUE 0.     03610030
036200     05  PV-OUTPUT-HANDLE           PIC S9(9) BINARY VALUE 0.     03620030
036300     05  PV-CLOSE-HANDLE            PIC S9(9) BINARY VALUE 0.     03630030
036400                                                                  03640000
036500****************************************************************  03650000
036600* ERROR PROCESSING VARIABLES                                      03660000
036700* CODES FROM CALLS ARE STORED HERE                                03670000
036800****************************************************************  03680000
036900 01 PV-MQ-PROGRAM-VARIABLES.                                      03690000
037000     05  PV-COMPLETION-CODE         PIC S9(9) BINARY.             03700000
037100     05  PV-REASON                  PIC S9(9) BINARY.             03710000
037200     05  PV-CON-REASON              PIC S9(9) BINARY.             03720000
037300     05  PV-ERROR-MESSAGE           PIC X(48) VALUE SPACES.       03730000
037400     05  PV-OPEN-OPTIONS            PIC S9(9) BINARY.             03740000
037500     05  PV-MSGBUFFER-IN            PIC X(8000) VALUE SPACES.     03750030
037600     05  PV-MSGBUFFER-OUT           PIC X(1000) VALUE SPACES.     03760030
037700     05  PV-MQCHECK                 PIC X(8)  VALUE 'MQR2C'.      03770000
037800     05  PV-MQ-REASON-TEXT          PIC X(30) VALUE SPACES.       03780000
037900                                                                  03790000
038000****************************************************************  03800000
038100**                     E N D   O F   M Q                      **  03810000
038200****************************************************************  03820000
038300/                                                                 03830000
038400 PROCEDURE DIVISION.                                              03840000
038500******************************************************************03850000
038600 0000-PROGRAM-MAINLINE.                                           03860000
038700     DISPLAY '************ START OF SNKUP100 ***************'.    03870031
038800                                                                  03880000
038900*INIT VARIABLES, SET SWITCHES.                                    03890021
039000     PERFORM 1000-INITIALIZE.                                     03900000
039100     DISPLAY '=============================='.                    03910032
039200                                                                  03920000
039300*GET FIRST MSG FROM QUEUE.                                        03930004
039400     PERFORM 1900-MQ-GET-MSG.                                     03940004
039500     DISPLAY '** 0000- PS-FIRST-ROW-IS-ID-SW = '                  03950091
039600             PS-FIRST-ROW-IS-ID-SW ' **'.                         03960091
039700                                                                  03970004
039800*PROCESS THE ASN ORDERS.                                          03980008
039900     PERFORM 2000-PROCESS-ASNS                                    03990006
040000         UNTIL PS-TIME-TO-END-PROGRAM-YES.                        04000000
040100                                                                  04010000
040200******************************************************************04020000
040300*                                                                *04030004
040400*              I N I T I A L I Z A T I O N                       *04040004
040500*                                                                *04050004
040600******************************************************************04060000
040700 1000-INITIALIZE.                                                 04070000
040800     MOVE '1000-INITIALIZE'        TO PV-PARAGRAPH.               04080008
040900                                                                  04090000
041000     INITIALIZE PV-DATA-LENGTH.                                   04100008
041100                                                                  04110000
041200     SET PS-TIME-TO-END-PROGRAM-NO                                04120008
041300         PS-FIRST-MQ-MSG-YES                                      04130009
041400         PS-END-OF-ASN-NO          TO TRUE.                       04140008
041500                                                                  04150000
041600*GET CURRENT TIMESTAMP.                                           04160004
041700     PERFORM 1100-SET-CURRENT-TMST.                               04170004
041800                                                                  04180004
041900*READ CONTROL CARDS(FOR QUEUE MANAGER/QUEUE NAMES).               04190004
042000     PERFORM 1200-READ-CC-CARDS.                                  04200004
042100                                                                  04210004
042200*CONNECT TO QUEUE MANAGER.                                        04220004
042300     PERFORM 1300-MQ-CONNECT-TO-QMGR.                             04230004
042400                                                                  04240004
042500*OPEN THE QUEUE FOR GETS.                                         04250004
042600     PERFORM 1400-MQGET-QUEUE-OPEN.                               04260030
042700                                                                  04270030
042800******************************************************************04280004
042900 1100-SET-CURRENT-TMST.                                           04290000
043000     MOVE '1100-SET-CURRENT-TMST'   TO PV-PARAGRAPH.              04300006
043100                                                                  04310000
043200     EXEC SQL                                                     04320000
043300         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 04330000
043400     END-EXEC.                                                    04340036
043500                                                                  04350000
043600     EVALUATE TRUE                                                04360000
043700       WHEN SQLCODE = ZERO                                        04370000
043800           CONTINUE                                               04380000
043900                                                                  04390000
044000       WHEN OTHER                                                 04400000
044100           DISPLAY '**************************************'       04410000
044200           DISPLAY '** ABEND                            **'       04420000
044300           DISPLAY '** PROGRAM = SNKUP100               **'       04430000
044400           DISPLAY '** PARAGRAPH = 1100-SET-CURRENT-TMST**'       04440000
044500           DISPLAY '** SET CURRENT TIMESTAMP            **'       04450000
044600           DISPLAY '**************************************'       04460000
044700           PERFORM 9100-SQL-ABEND                                 04470000
044800     END-EVALUATE.                                                04480000
044900                                                                  04490000
045000****************************************************************  04500000
045100 1200-READ-CC-CARDS.                                              04510000
045200     MOVE '1200-READ-CC-CARDS'      TO PV-PARAGRAPH.              04520006
045300                                                                  04530000
045400*OPEN CC CARD 1 TO OBTAIN QUEUE MANAGER NAME                      04540000
045500      OPEN INPUT CONTROL-CARD-1.                                  04550000
045600      IF CONTROL-CARD-1-ERROR                                     04560000
045700          PERFORM 9200-MQ-ABEND                                   04570000
045800      END-IF.                                                     04580000
045900                                                                  04590000
046000      READ CONTROL-CARD-1 INTO CC-CONTROL-CARD-1                  04600000
046100        AT END                                                    04610000
046200          SET PS-CONTROL-CARD-1-END-YES TO TRUE                   04620000
046300      END-READ.                                                   04630000
046400                                                                  04640000
046500      IF PS-CONTROL-CARD-1-END-YES                                04650000
046600          DISPLAY PC-CURRENT-PROGRAM-NAME                         04660000
046700                  ' CONTROL CARD MISSING - FOR QMGR NAME'         04670000
046800          MOVE 'QMGR NAME IS MISSING IN CARD?'                    04680000
046900            TO PV-ERROR-MESSAGE                                   04690000
047000          PERFORM 9200-MQ-ABEND                                   04700000
047100      END-IF.                                                     04710000
047200                                                                  04720000
047300      IF CC-QMGR-NAME EQUAL SPACES                                04730000
047400          DISPLAY PC-CURRENT-PROGRAM-NAME                         04740000
047500                  ' CONTROL CARD MISSING - FOR QMGR NAME'         04750000
047600          MOVE 'QMGR NAME IS SPACES!' TO PV-ERROR-MESSAGE         04760000
047700          PERFORM 9200-MQ-ABEND                                   04770000
047800      END-IF.                                                     04780000
047900                                                                  04790000
048000      DISPLAY PC-CURRENT-PROGRAM-NAME                             04800000
048100              ' - CONTROL CARD 1 : ' CC-CONTROL-CARD-1.           04810000
048200                                                                  04820000
048300      CLOSE CONTROL-CARD-1.                                       04830000
048400                                                                  04840000
048500*OPEN CC CARD 2 TO OBTAIN QUEUE NAME FOR MQGETS                   04850028
048600      OPEN INPUT CONTROL-CARD-2.                                  04860000
048700      IF CONTROL-CARD-2-ERROR                                     04870000
048800          PERFORM 9200-MQ-ABEND                                   04880000
048900      END-IF.                                                     04890000
049000                                                                  04900000
049100      READ CONTROL-CARD-2 INTO CC-CONTROL-CARD-2                  04910000
049200        AT END                                                    04920000
049300          SET PS-CONTROL-CARD-2-END-YES TO TRUE                   04930000
049400      END-READ.                                                   04940000
049500                                                                  04950000
049600      IF PS-CONTROL-CARD-2-END-YES                                04960000
049700          DISPLAY PC-CURRENT-PROGRAM-NAME                         04970000
049800                  ' CONTROL CARD MISSING - FOR QUEUE NAME'        04980000
049900          MOVE 'QUEUE NAME IS MISSING IN CARD?'                   04990000
050000            TO PV-ERROR-MESSAGE                                   05000000
050100          PERFORM 9200-MQ-ABEND                                   05010000
050200      END-IF.                                                     05020000
050300                                                                  05030000
050400      IF CC-ASN-ORDER-QUEUE-NAME-I EQUAL SPACES                   05040028
050500          DISPLAY PC-CURRENT-PROGRAM-NAME                         05050000
050600                  ' CONTROL CARD MISSING - FOR QUEUE NAME'        05060000
050700          MOVE 'QUEUE NAME IS SPACES!' TO PV-ERROR-MESSAGE        05070000
050800          PERFORM 9200-MQ-ABEND                                   05080000
050900      END-IF.                                                     05090000
051000                                                                  05100000
051100      DISPLAY PC-CURRENT-PROGRAM-NAME                             05110000
051200              ' - CONTROL CARD 2 : ' CC-CONTROL-CARD-2.           05120000
051300                                                                  05130000
051400      CLOSE CONTROL-CARD-2.                                       05140000
051500                                                                  05150000
051600****************************************************************  05160028
051700 1300-MQ-CONNECT-TO-QMGR.                                         05170004
051800     MOVE '1300-MQ-CONNECT-TO-QMGR' TO PV-PARAGRAPH.              05180004
051900                                                                  05190004
052000* CONNECT TO THE QUEUE                                            05200004
052100* CONTROL CARD 1 - QMGR NAME                                      05210004
052200     MOVE CC-QMGR-NAME TO PV-QMGR-NAME.                           05220004
052300                                                                  05230004
052400     CALL PC-MQCONN USING PV-QMGR-NAME                            05240004
052500                          PV-HCONN                                05250004
052600                          PV-COMPLETION-CODE                      05260004
052700                          PV-REASON.                              05270004
052800                                                                  05280004
052900*IF CONNECTION FAILED THEN DISPLAY ERROR MESSAGE AND EXIT         05290004
053000     MOVE PV-REASON TO PV-CON-REASON.                             05300004
053100     IF PV-COMPLETION-CODE = MQCC-OK THEN                         05310004
053200         CONTINUE                                                 05320004
053300     ELSE                                                         05330004
053400         CALL PV-MQCHECK USING PV-REASON                          05340004
053500                               PV-MQ-REASON-TEXT                  05350004
053600         MOVE PV-QMGR-NAME         TO PE-MQ-QMANAGER              05360004
053700         MOVE PV-COMPLETION-CODE   TO PE-MQ-COMPLETION-CODE       05370004
053800         MOVE PV-REASON            TO PE-MQ-REASON-CODE           05380004
053900         MOVE 'CONNECT TO QMGR'    TO PV-ERROR-MESSAGE            05390004
054000         PERFORM 9200-MQ-ABEND                                    05400004
054100     END-IF.                                                      05410004
054200                                                                  05420004
054300****************************************************************  05430004
054400** OPEN THE ASN ORDER QUEUE FOR GETS.                             05440004
054500****************************************************************  05450004
054600 1400-MQGET-QUEUE-OPEN.                                           05460030
054700     MOVE '1400-MQGET-QUEUE-OPEN'   TO PV-PARAGRAPH.              05470030
054800                                                                  05480004
054900* CONTROL CARD 2 - ASN ORDER QUEUE NAME                           05490008
055000     MOVE CC-ASN-ORDER-QUEUE-NAME-I TO MQOD-OBJECTNAME            05500030
055100     MOVE PV-QMGR-NAME              TO MQOD-OBJECTQMGRNAME.       05510030
055200                                                                  05520004
055300     COMPUTE PV-OPEN-OPTIONS       = MQOO-INPUT-SHARED            05530004
055400                                   + MQOO-OUTPUT                  05540004
055500                                   + MQOO-SET-IDENTITY-CONTEXT    05550004
055600                                   + MQOO-FAIL-IF-QUIESCING.      05560004
055700                                                                  05570004
055800     CALL PC-MQOPEN USING PV-HCONN                                05580004
055900                          MQM-OBJECT-DESCRIPTOR                   05590004
056000                          PV-OPEN-OPTIONS                         05600004
056100                          PV-GQ-HANDLE                            05610004
056200                          PV-COMPLETION-CODE                      05620004
056300                          PV-REASON.                              05630004
056400                                                                  05640004
056500     IF PV-COMPLETION-CODE = MQCC-OK THEN                         05650004
056600         MOVE PV-GQ-HANDLE TO PV-INPUT-HANDLE                     05660030
056700     ELSE                                                         05670004
056800         CALL PV-MQCHECK USING PV-REASON                          05680004
056900                               PV-MQ-REASON-TEXT                  05690004
057000         MOVE PV-QMGR-NAME            TO PE-MQ-QMANAGER           05700004
057100         MOVE CC-ASN-ORDER-QUEUE-NAME-I TO PE-MQ-QNAME            05710030
057200         MOVE PV-COMPLETION-CODE      TO PE-MQ-COMPLETION-CODE    05720004
057300         MOVE PV-REASON               TO PE-MQ-REASON-CODE        05730004
057400         MOVE 'OPEN ASN ORDER QUEUEI' TO PV-ERROR-MESSAGE         05740030
057500         PERFORM 9200-MQ-ABEND                                    05750004
057600     END-IF.                                                      05760004
057700                                                                  05770004
057800****************************************************************  05780030
057900** THE QUEUE IS SET UP SO MSGS ARE RETRIEVED IN FIFO ORDER.       05790004
058000** THE UNLIMITED WAIT INTERVAL MEANS THAT PROCESSING WILL JUST    05800004
058100** 'WAIT' UNTIL A MESSAGE APPEARS ON THE QUEUE.                   05810004
058200****************************************************************  05820004
058300 1900-MQ-GET-MSG.                                                 05830004
058400***  DISPLAY '1900-MQ-GET-MSG'.                                   05840031
058500     MOVE '1900-MQ-GET-MSG' TO PV-PARAGRAPH.                      05850031
058600                                                                  05860004
058700     INITIALIZE PV-MSGBUFFER-IN                                   05870030
058800                PV-MSG-IN.                                        05880030
058900                                                                  05890004
059000*MSG ID IS NOT POPULATED IN THIS PGM.                             05900004
059100     MOVE MQMI-NONE    TO MQMD-MSGID.                             05910031
059200                                                                  05920004
059300*MSGS ARE UNQUALIFIED IN THIS PGM.                                05930004
059400     MOVE MQCI-NONE    TO MQMD-CORRELID.                          05940031
059500                                                                  05950004
059600*FORMAT TRANSLATES THE DATA ACROSS PLATFORMS,                     05960004
059700     MOVE MQFMT-STRING TO MQMD-FORMAT.                            05970031
059800     MOVE +7003        TO PV-MSG-LENGTH.                          05980031
059900                                                                  05990004
060000*WAIT UNTIL A MSG APPEARS ON THE QUEUE.                           06000004
060100*    MOVE MQWI-UNLIMITED  TO MQGMO-WAITINTERVAL.                  06010038
060200*    * WAIT FOR 30 MINUTES (1,800,000 MILLISECONDS)...            06020038
060300     MOVE 1800000         TO MQGMO-WAITINTERVAL.                  06030081
060400     COMPUTE MQGMO-OPTIONS = MQGMO-SYNCPOINT +                    06040031
060500                             MQGMO-CONVERT   +                    06050031
060600                             MQGMO-ACCEPT-TRUNCATED-MSG +         06060031
060700                             MQGMO-WAIT.                          06070031
060800                                                                  06080004
060900     CALL PC-MQGET USING PV-HCONN                                 06090004
061000                         PV-GQ-HANDLE                             06100004
061100                         MQM-MESSAGE-DESCRIPTOR                   06110004
061200                         MQM-GET-MESSAGE-OPTIONS                  06120004
061300                         PV-MSG-LENGTH                            06130004
061400                         PV-MSGBUFFER-IN                          06140030
061500                         PV-DATA-LENGTH                           06150004
061600                         PV-COMPLETION-CODE                       06160004
061700                         PV-REASON.                               06170004
061800                                                                  06180039
061900     IF PV-COMPLETION-CODE NOT = MQCC-OK                          06190039
062000        IF PV-REASON = MQRC-NO-MSG-AVAILABLE                      06200039
062100           PERFORM 1100-SET-CURRENT-TMST                          06210045
062200           IF PS-WAITING-FOR-END-YES                              06220047
062300              DISPLAY PV-CURRENT-TMST ' INCOMPLETE ASN-NOW ENDED' 06230041
062400              DISPLAY 'CHECK ' SNT00000-DAT-XFER-CNTL-ID          06240069
062500              PERFORM 2150-UPDATE-CNTL-STAT-CDE-FAIL              06250040
062600              PERFORM 3000-DB2-COMMIT                             06260040
062700              PERFORM 3100-MQ-COMMIT                              06270040
062800              DISPLAY '==========================19-1'            06280078
062900              PERFORM 6000-SEND-EMAIL-MSG                         06290081
063000              SET PS-END-OF-ASN-YES TO TRUE                       06300075
063100           ELSE                                                   06310045
063200              DISPLAY PV-CURRENT-TMST ' ALL ASN COMPLETE'         06320046
063300           END-IF                                                 06330045
063400         END-IF                                                   06340040
063500     END-IF.                                                      06350038
063600                                                                  06360004
063700*IF 'GET' FAILED, THEN DISPLAY ERROR MESSAGE AND ABEND.           06370004
063800     IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        06380004
063900         IF (PV-REASON NOT = MQRC-NO-MSG-AVAILABLE)               06390004
064000           AND (PV-REASON NOT = MQRC-TRUNCATED-MSG-ACCEPTED)      06400004
064100             CALL PV-MQCHECK USING PV-REASON                      06410004
064200                                   PV-MQ-REASON-TEXT              06420004
064300             MOVE 'MQGET ERROR'         TO PV-ERROR-MESSAGE       06430004
064400             MOVE '1900-MQ-GET-UNQUALIFIED' TO PV-PARAGRAPH       06440004
064500             MOVE PV-COMPLETION-CODE    TO PV-HOLD-COMPLETION-CODE06450004
064600             MOVE PV-REASON             TO PV-HOLD-REASON         06460004
064700             PERFORM 3200-BACK-OUT-MQ                             06470006
064800             MOVE PV-HOLD-COMPLETION-CODE TO PV-COMPLETION-CODE   06480004
064900                                             PE-MQ-COMPLETION-CODE06490004
065000             MOVE PV-HOLD-REASON        TO PV-REASON              06500004
065100                                           PE-MQ-REASON-CODE      06510004
065200             PERFORM 9200-MQ-ABEND                                06520004
065300         END-IF                                                   06530004
065400     ELSE                                                         06540004
065500         ADD +1                          TO PA-MQGETS             06550006
065600         MOVE PV-MSGBUFFER-IN            TO PV-MSG-IN             06560030
065700                                                                  06570092
065800*THE "END RUN OF PROGRAM" MSG WILL SHUT DOWN THIS STARTED TASK.   06580004
065900         IF PV-MSG-IN (1:18) = PC-END-RUN-MSG                     06590030
066000             SET PS-TIME-TO-END-PROGRAM-YES TO TRUE               06600004
066100             PERFORM 5000-END-RUN-ROUTINE                         06610004
066200         ELSE                                                     06620078
066300*IF WAITING FOR 'END', NEXT MESSAGE START WILL END PREVIOUS.      06630081
066400            IF PV-MSG-IN(1:3) = 'ID '                             06640078
066500               IF PS-WAITING-FOR-END-YES                          06650078
066600                  PERFORM 1100-SET-CURRENT-TMST                   06660078
066700                  DISPLAY PV-CURRENT-TMST                         06670079
066800                          ' INCOMPLETE ASN-NOW ENDED'             06680078
066900                  DISPLAY 'CHECK ' SNT00000-DAT-XFER-CNTL-ID      06690078
067000                  PERFORM 2150-UPDATE-CNTL-STAT-CDE-FAIL          06700078
067100                  PERFORM 3000-DB2-COMMIT                         06710078
067200                  PERFORM 3100-MQ-COMMIT                          06720078
067300                  DISPLAY '==========================19-2'        06730078
067400                  PERFORM 6000-SEND-EMAIL-MSG                     06740081
067500                  SET PS-END-OF-ASN-YES TO TRUE                   06750078
067600               END-IF                                             06760078
067700            END-IF                                                06770078
067800         END-IF                                                   06780004
067900     END-IF.                                                      06790004
068000                                                                  06800004
068100******************************************************************06810000
068200*                                                                *06820004
068300*                M A I N   P R O C E S S I N G                   *06830004
068400*                                                                *06840004
068500******************************************************************06850013
068600 2000-PROCESS-ASNS.                                               06860006
068700***  DISPLAY '2000-PROCESS-ASNS'.                                 06870031
068800     MOVE '2000-PROCESS-ASNS' TO PV-PARAGRAPH.                    06880031
068900                                                                  06890000
069000*INSERT SNT_DAT_CNTL ROW ON FIRST MESSAGE.                        06900009
069100     IF PV-DTL > SPACES                                           06910048
069200        IF PS-FIRST-MQ-MSG-YES                                    06920048
069300            PERFORM 2200-INSERT-SNT-DAT-CNTL                      06930048
069400            MOVE +1 TO PV-REC-SEQ-NBR                             06940048
069500            SET PS-FIRST-MQ-MSG-NO TO TRUE                        06950048
069600            SET PS-CORPORATE-ASN-NO TO TRUE                       06960048
069700        END-IF                                                    06970048
069800                                                                  06980009
069900*IF AN 'END' RECORD IS ENCOUNTERED, WE HAVE COMPLETED THE ASN.    06990008
070000*INSERT CONTROL ROW INTO SNT_DAT_CNTL.                            07000006
070100        IF PS-END-OF-ASN-YES                                      07010048
070200            PERFORM 2200-INSERT-SNT-DAT-CNTL                      07020048
070300            MOVE +1 TO PV-REC-SEQ-NBR                             07030048
070400            SET PS-END-OF-ASN-NO TO TRUE                          07040048
070500        END-IF                                                    07050048
070600                                                                  07060008
070700*INSERT MQ MESSAGE RECORDS TO SNT_DAT_XFER.                       07070006
070800        MOVE PV-MSG-IN TO PV-DTL-TABLE                            07080048
070900        SET DTL-INDEX  TO 1                                       07090048
071000        SET PS-LOAD-XFER-YES TO TRUE                              07100048
071100        PERFORM 2300-INSERT-SNT-DAT-XFER                          07110048
071200          UNTIL PS-LOAD-XFER-NO                                   07120048
071300                                                                  07130000
071400*IF AN 'END' RECORD IS ENCOUNTERED, WE HAVE COMPLETED THE ASN.    07140020
071500*UPDATE CONTROL STATUS CODE OF CURRENT ASN TO 'READY' IF NOT      07150069
071600*ALREADY IN 'FAIL' STATUS.                                        07160069
071700*COMMIT DB2 AND MQ DATA.                                          07170020
071800        IF PS-END-OF-ASN-YES                                      07180048
071900            INITIALIZE SNT00000-STAT-CDE                          07190073
072000            PERFORM 2175-CHECK-CNTL-STAT-CDE                      07200073
072100            IF PS-IN-FAIL-STATUS                                  07210073
072200               CONTINUE                                           07220073
072300            ELSE                                                  07230073
072400               PERFORM 2100-UPDATE-CNTL-STAT-CDE                  07240069
072500               SET PS-FIRST-ROW-IS-ID-NO TO TRUE                  07250090
072600               DISPLAY '** 2000- PS-FIRST-ROW-IS-ID-SW = '        07260091
072700                       PS-FIRST-ROW-IS-ID-SW ' **'                07270091
072800            END-IF                                                07280073
072900            SET PS-CORPORATE-ASN-NO TO TRUE                       07290048
073000            PERFORM 3000-DB2-COMMIT                               07300048
073100            PERFORM 3100-MQ-COMMIT                                07310048
073200            DISPLAY '=============================='              07320048
073300        END-IF                                                    07330048
073400     END-IF.                                                      07340048
073500                                                                  07350000
073600*GET NEXT MESSAGE FROM QUEUE.                                     07360020
073700     PERFORM 1900-MQ-GET-MSG.                                     07370020
073800                                                                  07380020
073900******************************************************************07390006
074000 2100-UPDATE-CNTL-STAT-CDE.                                       07400006
074100*    MOVE '2100-UPDATE-CNTL-STAT-CDE' TO PV-PARAGRAPH.            07410006
074200                                                                  07420006
074300     IF PS-CORPORATE-ASN-YES                                      07430024
074400         MOVE 'C' TO PV-ASN-TYPE                                  07440024
074500     ELSE                                                         07450024
074600         MOVE 'R' TO PV-ASN-TYPE                                  07460024
074700     END-IF.                                                      07470024
074800                                                                  07480024
074900     DISPLAY '** 2100- PS-FIRST-ROW-IS-ID-SW = '                  07490091
075000              PS-FIRST-ROW-IS-ID-SW ' **'.                        07500091
075100     IF PS-FIRST-ROW-IS-ID-YES                                    07510089
075200         MOVE PC-R TO PC-STAT                                     07520089
075300     ELSE                                                         07530089
075400         MOVE PC-L TO PC-STAT                                     07540089
075500     END-IF.                                                      07550089
075600                                                                  07560089
075700     EXEC SQL                                                     07570006
075800         UPDATE SNT_DAT_CNTL                                      07580006
075900            SET STAT_CDE         = :PC-STAT                       07590089
076000              , ASN_TYP_CDE      = :PV-ASN-TYPE                   07600024
076100          WHERE DAT_XFER_CNTL_ID = :SNT00000-DAT-XFER-CNTL-ID     07610008
076200     END-EXEC.                                                    07620006
076300                                                                  07630006
076400     EVALUATE TRUE                                                07640006
076500       WHEN SQLCODE = ZERO                                        07650006
076600           IF PS-CORPORATE-ASN-YES                                07660024
076700               ADD +1 TO PA-CNTL-INSERTS-C                        07670024
076800           END-IF                                                 07680024
076900                                                                  07690006
077000       WHEN OTHER                                                 07700027
077100           DISPLAY '**************************************'       07710006
077200           DISPLAY '** ABEND                             *'       07720006
077300           DISPLAY '** PROGRAM = SNKUP100                *'       07730006
077400           DISPLAY '** PARAGRAPH = 2100-UPDATE-CNTL-STAT-CDE'     07740006
077500           DISPLAY '** UPDATE SNT_DAT_CNTL               *'       07750006
077600           DISPLAY '**************************************'       07760006
077700           PERFORM 9100-SQL-ABEND                                 07770006
077800     END-EVALUATE.                                                07780006
077900******************************************************************07790040
078000 2150-UPDATE-CNTL-STAT-CDE-FAIL.                                  07800040
078100     MOVE '2150-UPDATE-CNTL-STAT-CDE-FAIL' TO PV-PARAGRAPH.       07810088
078200                                                                  07820040
078300     IF PS-CORPORATE-ASN-YES                                      07830040
078400         MOVE 'C' TO PV-ASN-TYPE                                  07840040
078500     ELSE                                                         07850040
078600         MOVE 'R' TO PV-ASN-TYPE                                  07860040
078700     END-IF.                                                      07870040
078800                                                                  07880040
078900     EXEC SQL                                                     07890040
079000         UPDATE SNT_DAT_CNTL                                      07900040
079100            SET STAT_CDE         = :PC-F                          07910040
079200              , ASN_TYP_CDE      = :PV-ASN-TYPE                   07920040
079300          WHERE DAT_XFER_CNTL_ID = :SNT00000-DAT-XFER-CNTL-ID     07930040
079400     END-EXEC.                                                    07940040
079500                                                                  07950040
079600     EVALUATE TRUE                                                07960040
079700       WHEN SQLCODE = ZERO                                        07970040
079800          SET PS-WAITING-FOR-END-NO TO TRUE                       07980045
079900          IF PS-CORPORATE-ASN-YES                                 07990045
080000             ADD +1 TO PA-CNTL-INSERTS-C                          08000045
080100          END-IF                                                  08010045
080200                                                                  08020040
080300       WHEN OTHER                                                 08030040
080400           DISPLAY '**************************************'       08040040
080500           DISPLAY '** ABEND                             *'       08050040
080600           DISPLAY '** PROGRAM = SNKUP100                *'       08060040
080700           DISPLAY '** PARAGRAPH = 2150-UPDATE-CNTL-STAT-CDE-FAIL'08070040
080800           DISPLAY '** UPDATE SNT_DAT_CNTL               *'       08080040
080900           DISPLAY '**************************************'       08090040
081000           PERFORM 9100-SQL-ABEND                                 08100040
081100     END-EVALUATE.                                                08110040
081200******************************************************************08120068
081300 2175-CHECK-CNTL-STAT-CDE.                                        08130068
081400     MOVE '2175-CHECK-CNTL-STAT-CDE' TO PV-PARAGRAPH.             08140068
081500                                                                  08150068
081600     EXEC SQL                                                     08160068
081700         SELECT STAT_CDE                                          08170068
081800           INTO  :SNT00000-STAT-CDE                               08180068
081900           FROM  SNT_DAT_CNTL                                     08190068
082000           WHERE DAT_XFER_CNTL_ID = :SNT00000-DAT-XFER-CNTL-ID    08200068
082100     END-EXEC.                                                    08210068
082200                                                                  08220068
082300     EVALUATE TRUE                                                08230068
082400       WHEN SQLCODE = ZERO                                        08240068
082500          IF SNT00000-STAT-CDE = 'F'                              08250068
082600             SET PS-IN-FAIL-STATUS TO TRUE                        08260068
082700          ELSE                                                    08270068
082800             SET PS-NOT-IN-FAIL-STATUS TO TRUE                    08280068
082900          END-IF                                                  08290071
083000       WHEN OTHER                                                 08300068
083100           DISPLAY '**************************************'       08310068
083200           DISPLAY '** ABEND                             *'       08320068
083300           DISPLAY '** PROGRAM = SNKUP100                *'       08330068
083400           DISPLAY '** PARAGRAPH = 2175-CHECK-CNTL-STAT-CDE'      08340068
083500           DISPLAY '** SELECT SNT_DAT_CNTL               *'       08350068
083600           DISPLAY '**************************************'       08360068
083700           PERFORM 9100-SQL-ABEND                                 08370068
083800     END-EVALUATE.                                                08380068
083900                                                                  08390068
084000******************************************************************08400006
084100 2200-INSERT-SNT-DAT-CNTL.                                        08410006
084200     MOVE '2200-INSERT-SNT-DAT-CNTL' TO PV-PARAGRAPH.             08420006
084300                                                                  08430006
084400     PERFORM 2210-GET-CURRENT-TIMESTAMP.                          08440006
084500     MOVE PV-TMST-LAST6 TO SNT00000-DAT-XFER-CNTL-ID.             08450008
084600                                                                  08460006
084700     PERFORM WITH TEST AFTER                                      08470006
084800       VARYING PV-RETRY-COUNTER FROM 1 BY 1                       08480006
084900         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  08490006
085000            OR SQLCODE = ZERO                                     08500006
085100                                                                  08510006
085200       EXEC SQL                                                   08520006
085300         INSERT INTO SNT_DAT_CNTL                                 08530006
085400             ( DAT_XFER_CNTL_ID                                   08540006
085500              ,CRE_TMST                                           08550006
085600              ,STAT_CDE                                           08560006
085700              ,END_PRC_TMST                                       08570006
085800              ,ASN_TYP_CDE                                        08580024
085900             )                                                    08590006
086000            VALUES                                                08600006
086100             (:SNT00000-DAT-XFER-CNTL-ID                          08610008
086200             ,:PV-CURRENT-PRC-CNTL-TMST                           08620006
086300             ,:PC-L                                               08630006
086400             ,:PC-DEFAULT-TMST                                    08640006
086500             ,:PV-ASN-TYPE                                        08650024
086600             )                                                    08660006
086700       END-EXEC                                                   08670006
086800                                                                  08680006
086900       EVALUATE TRUE                                              08690006
087000         WHEN SQLCODE = ZERO                                      08700006
087100*    DISPLAY 'ROW INSERTED IN CNTL = ' SNT00000-DAT-XFER-CNTL-ID  08710096
087200             ADD +1 TO PA-CNTL-INSERTS                            08720006
087300             SET PS-WAITING-FOR-END-YES TO TRUE                   08730045
087400*RETRY ON A DUPLICATE INSERT.                                     08740023
087500         WHEN SQLCODE = -803                                      08750023
087600             ADD +1 TO PV-TMST-LAST6                              08760023
087700             MOVE PV-TMST-LAST6 TO SNT00000-DAT-XFER-CNTL-ID      08770023
087800             DISPLAY 'PV-TMST-LAST6 = ' PV-TMST-LAST6             08780023
087900                                                                  08790023
088000         WHEN OTHER                                               08800006
088100             DISPLAY '*******************************************'08810006
088200             DISPLAY '*ABEND                                    *'08820006
088300             DISPLAY '*PROGRAM   = SNKUP100                     *'08830006
088400             DISPLAY '*PARAGRAPH = 2200-INSERT-SNT-DAT-CNTL     *'08840006
088500             DISPLAY '*DB2 OPER  = INSERT TO SNT_DAT_CNTL       *'08850006
088600             DISPLAY '*PRC CNTL  = ' PV-CURRENT-PRC-CNTL-TMST     08860006
088700             DISPLAY '*******************************************'08870006
088800             PERFORM 9100-SQL-ABEND                               08880006
088900       END-EVALUATE                                               08890006
089000     END-PERFORM.                                                 08900006
089100                                                                  08910006
089200     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         08920006
089300       AND SQLCODE NOT = ZERO                                     08930006
089400         DISPLAY '***********************************************'08940006
089500         DISPLAY '** MAX RETRIES EXCEEDED ATTEMPTING TO         *'08950006
089600         DISPLAY '** INSERT TO SNT_DAT_CNTL                     *'08960006
089700         DISPLAY '** PARAGRAPH = 2200-INSERT-SNT-DAT-CNTL       *'08970006
089800         DISPLAY '** PRC CNTL  = ' PV-CURRENT-PRC-CNTL-TMST       08980006
089900         DISPLAY '***********************************************'08990006
090000         PERFORM 9100-SQL-ABEND                                   09000006
090100     END-IF.                                                      09010006
090200                                                                  09020006
090300******************************************************************09030006
090400 2210-GET-CURRENT-TIMESTAMP.                                      09040006
090500     MOVE '2210-GET-CURRENT-TIMESTAMP' TO PV-PARAGRAPH.           09050006
090600                                                                  09060006
090700     INITIALIZE PV-CURRENT-PRC-CNTL-TMST.                         09070006
090800                                                                  09080006
090900     EXEC SQL                                                     09090006
091000         SET :PV-CURRENT-PRC-CNTL-TMST = CURRENT TIMESTAMP        09100006
091100     END-EXEC.                                                    09110006
091200                                                                  09120006
091300     EVALUATE TRUE                                                09130006
091400       WHEN SQLCODE = ZERO                                        09140006
091500           CONTINUE                                               09150006
091600                                                                  09160006
091700       WHEN OTHER                                                 09170006
091800           DISPLAY '**************************************'       09180006
091900           DISPLAY '** ABEND                             *'       09190006
092000           DISPLAY '** PROGRAM = SNKUP100                *'       09200006
092100           DISPLAY '** PARAGRAPH = 2210-GET-CURRENT-TIMESTAMP'    09210006
092200           DISPLAY '** SET DB2 CURRENT TIMESTAMP         *'       09220006
092300           DISPLAY '**************************************'       09230006
092400           PERFORM 9100-SQL-ABEND                                 09240006
092500     END-EVALUATE.                                                09250006
092600                                                                  09260006
092700******************************************************************09270008
092800 2300-INSERT-SNT-DAT-XFER.                                        09280006
092900     MOVE '2300-INSERT-SNT-DAT-XFER' TO PV-PARAGRAPH.             09290006
093000                                                                  09300000
093100     IF DTL-INDEX > 20                                            09310006
093200         SET PS-LOAD-XFER-NO TO TRUE                              09320006
093300     END-IF.                                                      09330006
093400                                                                  09340006
093500     IF PV-DTL-RECORD(DTL-INDEX) NOT > SPACES                     09350008
093600         DISPLAY 'RECORD IS SPACES'                               09360050
093700         SET PS-LOAD-XFER-NO TO TRUE                              09370006
093800     ELSE                                                         09380026
093900         MOVE PV-DTL-RECORD(DTL-INDEX)                            09390026
094000           TO SN005-ASN-UNPACKED                                  09400043
094100     END-IF.                                                      09410006
094200*    DISPLAY 'INPUT BUFFER=> ' PV-DTL-RECORD(DTL-INDEX)(1:20).    09420096
094300                                                                  09421001
094400     IF PV-DTL-RECORD(DTL-INDEX)(1:3) = 'ID '                     09430053
094500        SET PS-FIRST-ROW-IS-ID-YES TO TRUE                        09440088
094600        DISPLAY 'PROCESSING ASN - ' SN005-BSN02-SHIPT-ID ' / '    09450080
094700                                    SNT00000-DAT-XFER-CNTL-ID     09460080
094800     END-IF.                                                      09470053
094900                                                                  09480053
095000     IF PV-DTL-RECORD(DTL-INDEX)(1:3) = 'END'                     09490039
095100         SET PS-LOAD-XFER-NO   TO TRUE                            09500008
095200         SET PS-END-OF-ASN-YES TO TRUE                            09510008
095300         SET PS-WAITING-FOR-END-NO TO TRUE                        09520045
095400         DISPLAY 'RECORD IS END'                                  09530050
095500     END-IF.                                                      09540008
095600                                                                  09550008
095700     IF PV-DTL-RECORD(DTL-INDEX)(1:3) = 'N1 '                     09560022
095800*    INC000000258400                                              09561099
095900       AND (SN005-N101-ID-CDE = 'ST')                             09570098
096000*    INC000000258400                                              09571099
096100       AND (SN005-N104-NME-ID-CDE = '90' OR '090'                 09580042
096200                                OR '0090' OR '00090'              09590022
096300                              OR '000090' OR '0000090'            09600022
096400                            OR '00000090' OR '000000090')         09610022
096500         SET PS-CORPORATE-ASN-YES TO TRUE                         09620022
096600     END-IF.                                                      09630022
096700                                                                  09640022
096800                                                                  09640022
096900*    COMMENTED OUT 3/26/2008                                      09640022
097000*    IF PV-DTL-RECORD(DTL-INDEX)(1:3) = 'TD5'                     09650022
097100*      AND (SN005-TD504-TRANS-MTHD-CDE = 'S' OR                   09660094
097200*           SN005-TD504-TRANS-MTHD-CDE = 'A')                     09670094
097300*        SET PS-CORPORATE-ASN-YES TO TRUE                         09680022
097400*    END-IF.                                                      09690022
097500*    END CHANGE 3/26/2008                                         09640022
097600                                                                  09700022
097700     IF PV-DTL-RECORD(DTL-INDEX)(1:3) = 'TD5'                     09710025
097800         DISPLAY ' *** TD5 / ' SN005-TD501-RTE-SEQ-CDE            09720042
097900                         ' / ' SN005-TD502-CARR-ID-QUAL-CDE       09730042
098000                         ' / ' SN005-TD503-CARR-ID-CDE            09740042
098100                         ' / ' SN005-TD504-TRANS-MTHD-CDE         09750042
098200     END-IF.                                                      09760026
098300                                                                  09770025
098400     IF PS-LOAD-XFER-YES                                          09780006
098500         MOVE PV-DTL-RECORD(DTL-INDEX)(1:3)                       09790008
098600                           TO SNT00001-DAT-CTG-CDE                09800008
098700         MOVE 350          TO SNT00001-LOD-DAT-TXT-LEN            09810017
098800         MOVE PV-DTL-RECORD(DTL-INDEX)                            09820008
098900                           TO SNT00001-LOD-DAT-TXT-TEXT           09830017
099000                                                                  09840006
099100         EXEC SQL                                                 09850006
099200             INSERT INTO SNT_DAT_XFER                             09860006
099300                    (DAT_XFER_CNTL_ID                             09870037
099400                    ,PRC_LOD_SEQ_NBR                              09880006
099500                    ,DAT_CTG_CDE                                  09890006
099600                    ,LOD_DAT_TXT                                  09900006
099700                    )                                             09910006
099800             VALUES                                               09920006
099900                    (:SNT00000-DAT-XFER-CNTL-ID                   09930008
100000                    ,:PV-REC-SEQ-NBR                              09940006
100100                    ,:SNT00001-DAT-CTG-CDE                        09950008
100200                    ,:SNT00001-LOD-DAT-TXT                        09960008
100300                    )                                             09970006
100400         END-EXEC                                                 09980006
100500                                                                  09990006
100600         EVALUATE TRUE                                            10000006
100700           WHEN SQLCODE = ZERO                                    10010006
100800               ADD +1 TO PA-XFER-INSERTS                          10020006
100900                         PA-ROW-COUNT                             10030087
101000               ADD +1 TO PV-REC-SEQ-NBR                           10040006
101100               SET DTL-INDEX UP BY 1                              10050006
101200                                                                  10060006
101300           WHEN OTHER                                             10070006
101400               DISPLAY '*****************************************'10080006
101500               DISPLAY '*ABEND                                  *'10090006
101600               DISPLAY '*PROGRAM   = SNKUP100                   *'10100006
101700               DISPLAY '*PARAGRAPH = 2300-INSERT-SNT-DAT-XFER   *'10110006
101800               DISPLAY '*DB2 OPER  = INSERT TO SNT_DAT_XFER     *'10120006
101900               DISPLAY '*PRC CNTL  = ' PV-CURRENT-PRC-CNTL-TMST   10130006
102000               DISPLAY '*****************************************'10140006
102100               PERFORM 9100-SQL-ABEND                             10150006
102200         END-EVALUATE                                             10160006
102300     END-IF.                                                      10170006
102400                                                                  10180000
102500     IF PA-ROW-COUNT > 9995                                       10190087
102600         PERFORM 3000-DB2-COMMIT                                  10200084
102700         PERFORM 3100-MQ-COMMIT                                   10210086
102800     END-IF.                                                      10220037
102900                                                                  10230037
103000******************************************************************10240019
103100* COMMITTED RECORDS WILL REMAIN IN DB2 TABLES AFTER AN ABEND.     10250006
103200******************************************************************10260006
103300 3000-DB2-COMMIT.                                                 10270006
103400     MOVE '3000-DB2-COMMIT'          TO PV-PARAGRAPH.             10280006
103500                                                                  10290006
103600     EXEC SQL                                                     10300006
103700         COMMIT                                                   10310006
103800     END-EXEC.                                                    10320006
103900                                                                  10330006
104000     EVALUATE TRUE                                                10340006
104100       WHEN SQLCODE = +0                                          10350006
104200           ADD +1  TO PA-DB2-COMMITS                              10360086
104300           MOVE +0 TO PA-ROW-COUNT                                10370087
104400           DISPLAY 'DB2 COMMIT - SEQ = ' PV-REC-SEQ-NBR           10380037
104500                   ' / ' PV-MSG-OUT                               10390037
104600                                                                  10400006
104700       WHEN OTHER                                                 10410006
104800           DISPLAY '****************************'                 10420006
104900           DISPLAY '** ABEND                  **'                 10430006
105000           DISPLAY '** PROGRAM = SNKUP100     **'                 10440011
105100           DISPLAY '** PARAGRAPH = 3000-COMMIT**'                 10450058
105200           DISPLAY '** UNSUCCESSFUL COMMIT    **'                 10460006
105300           DISPLAY '****************************'                 10470006
105400           PERFORM 9100-SQL-ABEND                                 10480006
105500     END-EVALUATE.                                                10490006
105600                                                                  10500006
105700******************************************************************10510006
105800*  COMMIT MQ PROCESSING SINCE THE POINT OF THE LAST COMMIT        10520006
105900* COMMITTED RECORDS WILL REMAIN IN DB2 TABLES AFTER AN ABEND.     10530006
106000******************************************************************10540006
106100 3100-MQ-COMMIT.                                                  10550006
106200     MOVE '3100-MQ-COMMIT'           TO PV-PARAGRAPH.             10560006
106300                                                                  10570006
106400     CALL PC-MQCMIT USING PV-HCONN                                10580006
106500                          PV-COMPLETION-CODE                      10590006
106600                          PV-REASON.                              10600006
106700                                                                  10610006
106800     IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        10620006
106900         CALL PV-MQCHECK USING PV-REASON                          10630006
107000                               PV-MQ-REASON-TEXT                  10640006
107100         MOVE '3100-MQ-COMMIT'   TO PV-PARAGRAPH                  10650006
107200         MOVE 'MQCMIT ERROR'     TO PV-ERROR-MESSAGE              10660006
107300         MOVE PV-COMPLETION-CODE TO PV-HOLD-COMPLETION-CODE       10670006
107400         MOVE PV-REASON          TO PV-HOLD-REASON                10680006
107500         PERFORM 3200-BACK-OUT-MQ                                 10690006
107600         MOVE PV-HOLD-COMPLETION-CODE TO PV-COMPLETION-CODE       10700006
107700                                         PE-MQ-COMPLETION-CODE    10710006
107800         MOVE PV-HOLD-REASON          TO PV-REASON                10720006
107900                                         PE-MQ-REASON-CODE        10730006
108000         PERFORM 9200-MQ-ABEND                                    10740006
108100     ELSE                                                         10750006
108200         ADD +1 TO PA-MQ-COMMITS                                  10760006
108300         DISPLAY ' MQ COMMIT FOR ' PV-MSG-OUT                     10770034
108400     END-IF.                                                      10780006
108500                                                                  10790006
108600******************************************************************10800006
108700* BACK OUT MQ PROCESSING SINCE THE POINT OF THE LAST COMMIT       10810006
108800******************************************************************10820006
108900 3200-BACK-OUT-MQ.                                                10830006
109000     MOVE '3200-BACK-OUT-MQ'         TO PV-PARAGRAPH.             10840006
109100                                                                  10850006
109200     CALL PC-MQBACK USING PV-HCONN                                10860006
109300                          PV-COMPLETION-CODE                      10870006
109400                          PV-REASON.                              10880006
109500                                                                  10890006
109600     IF (PV-COMPLETION-CODE NOT = MQCC-OK) THEN                   10900006
109700         CALL PV-MQCHECK USING PV-REASON                          10910006
109800                               PV-MQ-REASON-TEXT                  10920006
109900        MOVE '3200-BACK-OUT-MQ'  TO PV-PARAGRAPH                  10930006
110000        MOVE 'MQBACK ERROR'      TO PV-ERROR-MESSAGE              10940006
110100        PERFORM 9200-MQ-ABEND                                     10950006
110200     END-IF.                                                      10960006
110300                                                                  10970029
110400****************************************************************  10980015
110500*                !!! I M P O R T A N T !!!                        10990004
110600*                                                                 11000000
110700* THE 'STOP RUN' NEEDS TO BE HERE INSTEAD OF IN THE MAIN LINE OF  11010000
110800* THE PROGRAM BECAUSE THIS IS CODED AS A STARTED TASK, AND THIS   11020000
110900* PROGRAM WILL RUN CONTINUOUSLY UNTIL IT RECEIVES THE 'END RUN    11030000
111000* OF PROGRAM' MESSAGE. IF THE STOP RUN IS MOVED TO THE MAIN LINE  11040000
111100* THE RESULT WILL BE AN MQ HCONN_ERROR.                           11050004
111200****************************************************************  11060000
111300 5000-END-RUN-ROUTINE.                                            11070000
111400     MOVE '5000-END-RUN-ROUTINE' TO PV-PARAGRAPH.                 11080030
111500                                                                  11090000
111600*CLOSE THE MQ QUEUE.                                              11100056
111700     MOVE PV-INPUT-HANDLE  TO PV-CLOSE-HANDLE.                    11110030
111800     PERFORM 5100-MQ-QUEUE-CLOSE.                                 11120030
111900                                                                  11130030
112000*DISCONNECT FROM THE QMGR.                                        11140000
112100     PERFORM 5200-DISCONNECT-QMGR.                                11150006
112200                                                                  11160000
112300*END OF JOB ROUTINE.                                              11170000
112400     PERFORM 8000-EOJ-ROUTINE.                                    11180000
112500                                                                  11190000
112600*END PROGRAM.                                                     11200000
112700     DISPLAY '************  END OF SNKUP100  ***************'     11210004
112800     STOP RUN.                                                    11220000
112900                                                                  11230000
113000******************************************************************11240000
113100** CLOSES THE TRANS QUEUE.                                        11250006
113200******************************************************************11260006
113300 5100-MQ-QUEUE-CLOSE.                                             11270006
113400     MOVE '5100-MQ-QUEUE-CLOSE' TO PV-PARAGRAPH.                  11280030
113500                                                                  11290006
113600     CALL PC-MQCLOSE USING PV-HCONN                               11300030
113700                           PV-CLOSE-HANDLE                        11310030
113800                           MQCO-NONE                              11320030
113900                           PV-COMPLETION-CODE                     11330030
114000                           PV-REASON.                             11340030
114100                                                                  11350030
114200     IF PV-COMPLETION-CODE = MQCC-OK                              11360006
114300         CONTINUE                                                 11370006
114400     ELSE                                                         11380006
114500         CALL PV-MQCHECK USING PV-REASON                          11390006
114600                               PV-MQ-REASON-TEXT                  11400006
114700         MOVE PV-QMGR-NAME            TO PE-MQ-QMANAGER           11410006
114800         MOVE PV-CLOSE-HANDLE         TO PE-MQ-QNAME              11420030
114900         MOVE PV-COMPLETION-CODE      TO PE-MQ-COMPLETION-CODE    11430006
115000         MOVE PV-REASON               TO PE-MQ-REASON-CODE        11440006
115100         MOVE 'PE-MQ-CLOSE'           TO PV-ERROR-MESSAGE         11450006
115200         PERFORM 9200-MQ-ABEND                                    11460006
115300     END-IF.                                                      11470006
115400                                                                  11480006
115500******************************************************************11490006
115600** DISCONNECT FROM THE QUEUE MANAGER                              11500006
115700****************************************************************  11510006
115800 5200-DISCONNECT-QMGR.                                            11520006
115900     MOVE '5200-DISCONNECT-QMGR' TO PV-PARAGRAPH.                 11530006
116000                                                                  11540006
116100     CALL PC-MQDISC USING PV-HCONN                                11550006
116200                          PV-COMPLETION-CODE                      11560006
116300                          PV-REASON                               11570006
116400                                                                  11580006
116500     IF PV-COMPLETION-CODE = MQCC-OK                              11590006
116600         CONTINUE                                                 11600006
116700     ELSE                                                         11610006
116800         CALL PV-MQCHECK USING PV-REASON                          11620006
116900                               PV-MQ-REASON-TEXT                  11630006
117000         MOVE PV-QMGR-NAME            TO PE-MQ-QMANAGER           11640006
117100         MOVE PV-COMPLETION-CODE      TO PE-MQ-COMPLETION-CODE    11650006
117200         MOVE PV-REASON               TO PE-MQ-REASON-CODE        11660006
117300         MOVE '5200-DISCONNECT-QMGR'  TO PV-ERROR-MESSAGE         11670035
117400         PERFORM 9200-MQ-ABEND                                    11680006
117500     END-IF.                                                      11690006
117600                                                                  11700051
117700*----------------------------------------------------------       11710051
117800* 6000-SEND-EMAIL-MSG.                                            11720051
117900*     SEND AN E-MAIL TO IS-RMSITEMSUPPORT                         11730051
118000*----------------------------------------------------------       11740051
118100 6000-SEND-EMAIL-MSG.                                             11750051
118200                                                                  11760051
118300     INITIALIZE DP023-DYNALC-PARMS.                               11770051
118400     MOVE 'OUT01' TO DP023-DDNAME.                                11780057
118500     SET DP023-DSNAME-SYSOUT TO TRUE.                             11790051
118600     SET DP023-FREE-CLOSE-YES TO TRUE.                            11800051
118700     SET DP023-RECFM-FIXED-BLOCK TO TRUE.                         11810051
118800     MOVE 80     TO DP023-RECSZ.                                  11820051
118900     MOVE 7      TO DP023-RECOUNT.                                11830051
119000     MOVE 'B'    TO DP023-PRINT-CLASS.                            11840051
119100     MOVE 'SMTP' TO DP023-PRINT-WRITER.                           11850051
119200     PERFORM DP023-0000-DYNALC.                                   11860051
119300                                                                  11870051
119400     OPEN OUTPUT EMAIL-MSG-FILE.                                  11880051
119500     WRITE EMAIL-MSG-FILE-RECORD FROM EM-DATA-LINE-1.             11890051
119600     WRITE EMAIL-MSG-FILE-RECORD FROM EM-DATA-LINE-2.             11900051
119700     WRITE EMAIL-MSG-FILE-RECORD FROM EM-DATA-LINE-3.             11910051
119800     WRITE EMAIL-MSG-FILE-RECORD FROM EM-DATA-LINE-4.             11920051
119900     WRITE EMAIL-MSG-FILE-RECORD FROM EM-DATA-LINE-5.             11930051
120000     WRITE EMAIL-MSG-FILE-RECORD FROM EM-DATA-LINE-6.             11940051
120100     WRITE EMAIL-MSG-FILE-RECORD FROM EM-DATA-LINE-7.             11950051
120200     CLOSE EMAIL-MSG-FILE.                                        11960051
120300     DISPLAY '*** SENT EMAIL ***'.                                11970059
120400                                                                  11980006
120500******************************************************************11990006
120600* UPDATE CHECKPOINT STATUS CODE WITH 0 FOR COMPLETION.            12000000
120700* DISPLAY STATISTICS FOR THE PROGRAM                              12010025
120800******************************************************************12020000
120900 8000-EOJ-ROUTINE.                                                12030000
121000     MOVE '8000-EOJ-ROUTINE'         TO PV-PARAGRAPH.             12040006
121100                                                                  12050000
121200         DISPLAY '*******************************************'    12060006
121300         DISPLAY '      * SNKUP100 SUMMARY STATISTICS *      '    12070011
121400         DISPLAY ' '                                              12080000
121500         DISPLAY '        ---------------------------        '    12090006
121600         DISPLAY '               ASN DOWNLOADS               '    12100006
121700         DISPLAY '        ---------------------------        '    12110006
121800         DISPLAY ' '                                              12120000
121900         DISPLAY ' TOTAL MESSAGES READ         :'                 12130006
122000                                        PA-MQGETS                 12140006
122100         DISPLAY ' '                                              12150006
122200         DISPLAY ' TOTAL SNT_DAT_CNTL INSERTED :'                 12160006
122300                                        PA-CNTL-INSERTS           12170006
122400         DISPLAY '    NUMBER OF CORPORATE ASNS :'                 12180024
122500                                        PA-CNTL-INSERTS-C         12190024
122600         DISPLAY ' TOTAL SNT_DAT_XFER INSERTED :'                 12200006
122700                                        PA-XFER-INSERTS           12210006
122800         DISPLAY ' '                                              12220006
122900         DISPLAY ' TOTAL DB2 COMMITS           :'                 12230006
123000                                        PA-DB2-COMMITS            12240006
123100         DISPLAY ' TOTAL MQ  COMMITS           :'                 12250006
123200                                        PA-MQ-COMMITS             12260006
123300         DISPLAY ' '                                              12270000
123400         DISPLAY 'NOTE: TOTAL MSGS INCLUDES AN ''END RUN'' MSG'.  12280000
123500         DISPLAY '********************************************'.  12290000
123600                                                                  12300000
123700******************************************************************12310000
123800* 9100-SQL-ABEND - PERFORMS THE ABEND FOR THE PROGRAM IN THE      12320000
123900* EVENT THAT AN SQL ERROR OR WARNING CODE OCCURS.                 12330000
124000******************************************************************12340000
124100 9100-SQL-ABEND.                                                  12350000
124200                                                                  12360000
124300* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    12370000
124400* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         12380000
124500* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     12390000
124600* FORMAT                                                          12400000
124700     COPY DPPD004.                                                12410000
124800                                                                  12420000
124900     DISPLAY '***********************************'.               12430000
125000     DISPLAY '     ASN ORDER DOWNLOAD ABEND      '.               12440008
125100     DISPLAY '***********************************'.               12450000
125200     DISPLAY '* CURRENT STATS AT TIME OF ABEND  *'.               12460000
125300     DISPLAY '***********************************'.               12470000
125400     DISPLAY 'SNT_CNTL ROWS CREATED :' PA-CNTL-INSERTS            12480011
125500     DISPLAY 'SNT_XFER ROWS CREATED :' PA-XFER-INSERTS            12490011
125600     DISPLAY 'NUMBER OF MQ GETS     :' PA-MQGETS.                 12500011
125700     DISPLAY '***********************************'.               12510000
125800     DISPLAY '*         COMMIT STATS            *'.               12520000
125900     DISPLAY '***********************************'.               12530000
126000     DISPLAY 'DB2 COMMITS         :' PA-DB2-COMMITS.              12540006
126100     DISPLAY '***********************************'.               12550000
126200     DISPLAY ' '.                                                 12560000
126300     MOVE +4013 TO ABEND-CODE.                                    12570000
126400     CALL 'ILBOABN0' USING ABEND-CODE.                            12580000
126500                                                                  12590000
126600****************************************************************  12600000
126700** PERFORM MQ-SERIES ABEND PROCESSING                             12610000
126800****************************************************************  12620000
126900 9200-MQ-ABEND.                                                   12630000
127000                                                                  12640000
127100     DISPLAY '**** ABEND *************************************'.  12650000
127200     DISPLAY '** MQSERIES ERROR **'.                              12660000
127300     DISPLAY '** PROGRAM:    ', PC-CURRENT-PROGRAM-NAME.          12670000
127400     DISPLAY '** ABEND CODE: ', PV-ABEND-CODE.                    12680000
127500     DISPLAY '** PARAGRAPH:  ', PV-PARAGRAPH.                     12690000
127600     DISPLAY '** MESSAGE:    ', PV-ERROR-MESSAGE.                 12700000
127700     DISPLAY '** COMP CODE:  ', PE-MQ-COMPLETION-CODE.            12710000
127800     DISPLAY '** RSN CODE:   ', PE-MQ-REASON-CODE.                12720000
127900     DISPLAY '** RSN TEXT:   ', PV-MQ-REASON-TEXT.                12730000
128000     DISPLAY '************************************************'.  12740000
128100     MOVE +4013 TO ABEND-CODE.                                    12750000
128200     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         12760000
128300                                                                  12770000
128400******************************************************************12780000
128500* DYNAMIC ALLOCATION ROUTINE                                      12790051
128600******************************************************************12800000
128700     COPY DPPD023.                                                12810051
128800                                                                  12820051
