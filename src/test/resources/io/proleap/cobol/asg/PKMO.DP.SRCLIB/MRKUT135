000100******************************************************************00010006
000200 IDENTIFICATION DIVISION.                                         00020006
000300******************************************************************00030006
000400                                                                  00040006
000500 PROGRAM-ID.    MRKUT135.                                         00050006
000600 AUTHOR.        ANNE KINTOPF.                                     00060006
000700 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00070006
000800 DATE-WRITTEN   06/04.                                            00080006
000900 DATE-COMPILED.                                                   00090006
001000                                                                  00100006
001100******************************************************************00110006
001200*   READ INFOREM HEADER AND DETAIL FILES AS INPUT AND CREATE AN   00120006
001300*     OUTPUT FILE THAT WILL BE USED TO SEND DATA TO THE STAGING   00130006
001400*     API                                                         00140006
001500******************************************************************00150006
001600*   03/16/2006 MARIA KLAMIK                 IR# PM00860764        00160006
001700*     PARAGRAPH F600-GET-LDTM-PRETK-INFO -                        00170006
001800*     PV-LDTM-DAYS-QTY AND PV-PRE-TICKNG-Y                        00180006
001900*     ARE NOT BEING INITIALIZED - ERRORS OCCURR IN STAGING        00190006
002000*     BECAUSE THE FIELDS ARE BEING SET IMPROPERLY.                00200006
3372A * CHANGED 06/18/2012 BY KUSHAL BOTHRA                             00210006
3372A *  WR#   3372A  CHANGED PARA. F000 TO GET-INNR-OUTR FROM THE NEW  00220006
3372A *            DB2 INNER/OUTER TABLE USING THE SKU                  00230006
3372A *                                                                 00240006
002100******************************************************************00250006
002200 ENVIRONMENT DIVISION.                                            00260006
002300******************************************************************00270006
002400                                                                  00280006
002500 INPUT-OUTPUT SECTION.                                            00290006
002600                                                                  00300006
002700 FILE-CONTROL.                                                    00310006
002800                                                                  00320006
002900     SELECT HEADER-FILE                                           00330006
003000            ASSIGN TO ICROH                                       00340006
003100            ORGANIZATION IS INDEXED                               00350006
003200            ACCESS MODE  IS DYNAMIC                               00360006
003300            RECORD KEY   IS H-ORDER-HEADER-KEY                    00370006
003400            FILE STATUS  IS SC-HEADER-STATUS.                     00380006
003500                                                                  00390006
003600     SELECT DETAIL-FILE                                           00400006
003700            ASSIGN TO ICROD                                       00410006
003800            ORGANIZATION IS INDEXED                               00420006
003900            ACCESS MODE  IS DYNAMIC                               00430006
004000            RECORD KEY   IS D-LINE-ITEM-KEY                       00440006
004100            FILE STATUS  IS SC-DETAIL-STATUS.                     00450006
004200                                                                  00460006
004300     SELECT OUTPUT-FILE                                           00470006
004400            ASSIGN TO OUT01.                                      00480006
004500                                                                  00490006
004600******************************************************************00500006
004700 DATA DIVISION.                                                   00510006
004800******************************************************************00520006
004900                                                                  00530006
005000 FILE SECTION.                                                    00540006
005100                                                                  00550006
005200 FD  HEADER-FILE                                                  00560006
005300     DATA RECORD IS HEADER-RECORD.                                00570006
005400                                                                  00580006
005500 01  HEADER-RECORD.                                               00590006
005600     COPY ICI085C.                                                00600006
005700     COPY ICI055C.                                                00610006
005800     COPY ICI056C.                                                00620006
005900     COPY ICI100C.                                                00630006
006000     COPY ICI090C.                                                00640006
006100                                                                  00650006
006200                                                                  00660006
006300 FD  DETAIL-FILE                                                  00670006
006400     DATA RECORD IS DETAIL-RECORD.                                00680006
006500                                                                  00690006
006600 01  DETAIL-RECORD.                                               00700006
006700     COPY ICI050C.                                                00710006
006800     COPY ICI030C.                                                00720006
006900     COPY ICI031C.                                                00730006
007000     COPY ICI095C.                                                00740006
007100                                                                  00750006
007200                                                                  00760006
007300 FD  OUTPUT-FILE                                                  00770006
007400     LABEL RECORDS ARE OMITTED                                    00780006
007500     RECORDING MODE F                                             00790006
007600     RECORD CONTAINS 106 CHARACTERS                               00800006
007700     BLOCK CONTAINS 0 RECORDS                                     00810006
007800     DATA RECORD IS SUGGESTED-PO-RECORD.                          00820006
007900                                                                  00830006
008000 01  SUGGESTED-PO-RECORD         PIC X(106).                      00840006
008100                                                                  00850006
008200******************************************************************00860006
008300 WORKING-STORAGE SECTION.                                         00870006
008400******************************************************************00880006
008500                                                                  00890006
008600 01  ABEND-CODE                  PIC S9(4) COMP SYNC VALUE ZERO.  00900006
008700     88  ABEND-4001-WRITE-ERROR                      VALUE +4001. 00910006
008800     88  ABEND-4002-READ-ERROR                       VALUE +4002. 00920006
008900     88  ABEND-4003-CTRL-CARD-ERROR                  VALUE +4003. 00930006
009000     88  ABEND-4004-TABLE-ERROR                      VALUE +4004. 00940006
009100     88  ABEND-4005-OPEN-ERROR                       VALUE +4005. 00950006
009200     88  ABEND-4006-CLOSE-ERROR                      VALUE +4006. 00960006
009300     88  ABEND-4007-SEQUENCE-ERROR                   VALUE +4007. 00970006
009400     88  ABEND-4008-DATA-ERROR                       VALUE +4008. 00980006
009500     88  ABEND-4009-KEY-DATA-ERROR                   VALUE +4009. 00990006
009600     88  ABEND-4013-DB2-ERROR                        VALUE +4013. 01000006
009700                                                                  01010006
009800 01  PC-PROGRAM-CONSTANTS.                                        01020006
009900     05  PC-ONE                  PIC  9(1) VALUE 1.               01030006
010000     05  PC-DISTRIBUTION-TYPE    PIC  X(1) VALUE 'S'.             01040006
010100     05  PC-GROUP-TYPE           PIC  X(4) VALUE '5000'.          01050006
010200     05  PC-SKU-TYPE             PIC  X(1) VALUE 'S'.             01060006
010300     05  PC-ACTION-INSERT        PIC  X(1) VALUE '1'.             01070006
010400     05  PC-SYSTEM-ID            PIC  X(2) VALUE 'MR'.            01080006
010500     05  PC-PGM-NAME             PIC  X(8) VALUE 'MRKUT135'.      01090006
010600     05  PC-WORKSHEET            PIC  X(1) VALUE 'W'.             01100006
010700     05  PC-PACKAGING            PIC  X(1) VALUE 'B'.             01110006
010800     05  PC-PO-TYPE              PIC  X(2) VALUE 'IN'.            01120006
010900     05  PC-PO-TYPE-EC           PIC  X(2) VALUE 'EC'.            01130006
011000     05  PC-STORE-CAT            PIC  X(2) VALUE 'XS'.            01140006
011100     05  PC-STORE-CAT-EC         PIC  X(2) VALUE 'ES'.            01150006
011200     05  PC-ROW-NOT-FOUND        PIC S9(4) COMP SYNC VALUE +100.  01160006
011300     05  PC-MAX-RETRIES          PIC S9(3) VALUE 3   COMP-3.      01170006
011400     05  PC-SPACES               PIC X(3)  VALUE SPACES.          01180006
011500     05  PC-DETAIL               PIC X     VALUE 'D'.             01190006
011600     05  PC-FIRST-LINE           PIC 9(5)  VALUE 1.               01200006
011700     05  PC-MULTI-RT             PIC 9(3)  VALUE 99.              01210006
011800                                                                  01220006
011900 01  PS-PROGRAM-SWITCHES.                                         01230006
012000     05  PS-END-OF-HEADER-SWITCH PIC X     VALUE 'N'.             01240006
012100         88  PS-NOT-END-OF-HEADER          VALUE 'N'.             01250006
012200         88  PS-END-OF-HEADER              VALUE 'Y'.             01260006
012300     05  PS-VALID-HEADER-SWITCH  PIC X     VALUE 'N'.             01270006
012400         88  PS-HEADER-INVALID             VALUE 'N'.             01280006
012500         88  PS-HEADER-VALID               VALUE 'Y'.             01290006
012600     05  PS-END-OF-DETAIL-SWITCH PIC X     VALUE 'N'.             01300006
012700         88  PS-NOT-END-OF-DETAIL          VALUE 'N'.             01310006
012800         88  PS-END-OF-DETAIL              VALUE 'Y'.             01320006
012900     05  PS-FIRST-DETAIL-SWITCH  PIC X     VALUE 'Y'.             01330006
013000         88  PS-NOT-FIRST-DETAIL           VALUE 'N'.             01340006
013100         88  PS-FIRST-DETAIL               VALUE 'Y'.             01350006
013200     05  PS-FIRST-ITEM-SWITCH    PIC X     VALUE 'Y'.             01360006
013300         88  PS-NOT-FIRST-ITEM             VALUE 'N'.             01370006
013400         88  PS-FIRST-ITEM                 VALUE 'Y'.             01380006
013500     05  PS-PO-MULTIPLE-LT       PIC X     VALUE 'N'.             01390006
013600         88  PS-NOT-MULTI-LT               VALUE 'N'.             01400006
013700         88  PS-MULTI-LT                   VALUE 'Y'.             01410006
013800     05  PS-PO-MULTIPLE-RT       PIC X     VALUE 'N'.             01420006
013900         88  PS-NOT-MULTI-RT               VALUE 'N'.             01430006
014000         88  PS-MULTI-RT                   VALUE 'Y'.             01440006
014100     05  PS-ECOMMERCE-PO         PIC X     VALUE 'Y'.             01450006
014200         88  PS-NOT-ECOMMERCE              VALUE 'N'.             01460006
014300         88  PS-ECOMMERCE                  VALUE 'Y'.             01470006
014400                                                                  01480006
014500 01  PV-PROGRAM-VARIABLES.                                        01490006
014600     05  PV-LINE-ITEM-KEY.                                        01500006
014700         10  PV-RECORD-TYPE      PIC X     VALUE SPACES.          01510006
014800         10  PV-REF-NO           PIC X(15) VALUE SPACES.          01520006
014900         10  PV-LINE-NO          PIC 9(5)  VALUE ZERO.            01530006
015000     05  PV-INAME.                                                01540006
015100         10  PV-SKU              PIC  X(8)  VALUE SPACES.         01550006
015200         10  FILLER              PIC  X(7)  VALUE SPACES.         01560006
015300***THIS NEEDS TO CHANGE FOR SNE                                   01570006
015400         10  PV-STORE            PIC  X(5)  VALUE SPACES.         01580006
015500     05  PV-UPC-COMP-3           PIC S9(11) COMP-3.               01590006
015600     05  PV-STORE-N              PIC  9(5).                       01600006
015700     05  PV-STORE-NC                  PIC  S9(4) COMP.            01610006
015800     05  PV-CURR-REF-NO          PIC  X(15) VALUE SPACES.         01620006
015900     05  PV-CURR-SKU             PIC  X(8)  VALUE SPACES.         01630006
016000     05  PV-CURR-SKU-NUMERIC REDEFINES PV-CURR-SKU.               01640006
016100         10  PV-CURR-SKU-N       PIC  9(8).                       01650006
016200     05  PV-CURR-SKU-P           PIC  S9(8)V COMP-3.              01660006
016300     05  PV-CURR-DEPT            PIC  X(3).                       01670006
016400     05  PV-ITEM-OQ              PIC  9(9)  VALUE ZERO.           01680006
016500     05  PV-ITEM-RAWOQ           PIC  9(9)  VALUE ZERO.           01690006
016600     05  PV-PO-OQ                PIC  9(9)  VALUE ZERO.           01700006
016700     05  PV-PO-RAWOQ             PIC  9(9)  VALUE ZERO.           01710006
016800     05  PV-PO-LEAD-TIME         PIC  9(3).                       01720006
016900     05  PV-PO-REVIEW-TIME       PIC  9(3).                       01730006
017000     05  PV-INHOUSE-VENDOR-X     PIC  X(3).                       01740006
017100     05  PV-INHOUSE-VENDOR       PIC S9(3).                       01750006
017200     05  PV-INHOUSE-VENDOR-N     PIC S9(3)V COMP-3.               01760006
017300     05  PV-SEQUENCE-NBR         PIC  9(9)  VALUE ZERO.           01770006
017400     05  PV-SQL-SUB              PIC S9(4)  COMP SYNC VALUE ZERO. 01780006
017500     05  PV-PARAGRAPH-NAME       PIC  X(30) VALUE SPACES.         01790006
017600     05  PV-DB2-OPER-ATTEMPTED   PIC  X(30) VALUE SPACES.         01800006
017700     05  PV-ORDER-RUN-DATE.                                       01810006
017800         10  PV-ORDER-RUN-MONTH  PIC 99.                          01820006
017900         10  PV-ORDER-RUN-SLASH1 PIC X.                           01830006
018000         10  PV-ORDER-RUN-DAY    PIC 99.                          01840006
018100         10  PV-ORDER-RUN-SLASH2 PIC X.                           01850006
018200         10  PV-ORDER-RUN-YEAR   PIC 9(4).                        01860006
018300     05  PV-PK-BY-STR            PIC X       VALUE 'N'.           01870006
018400         88  PV-PK-BY-STR-Y      VALUE 'Y'.                       01880006
018500         88  PV-PK-BY-STR-N      VALUE 'N'.                       01890006
018600     05  PV-HNG                  PIC X       VALUE 'N'.           01900006
018700         88  PV-HNG-Y            VALUE 'H'.                       01910006
018800         88  PV-HNG-N            VALUE 'F'.                       01920006
018900     05  PV-PRE-TICKNG           PIC X       VALUE 'N'.           01930006
019000         88  PV-PRE-TICKNG-Y     VALUE 'Y'.                       01940006
019100         88  PV-PRE-TICKNG-N     VALUE 'N'.                       01950006
019200     05  PV-LDTM-DAYS-QTY        PIC 9(5)    VALUE ZERO.          01960006
019300     05  PV-TVNDAGR-COUNT        PIC S9(09) COMP-3.               01970006
019400                                                                  01980006
019500 01  WS-I-ITEM-HOLD.                                              01990006
019600     05  WS-I-SYSTEM-KEY            PIC X(12).                    02000006
019700     05  WS-I-UPC-ID                PIC 9(10).                    02010006
019800     05  WS-I-INAME.                                              02020006
019900         10  WS-I-SKU               PIC X(08).                    02030006
020000         10  FILLER                 PIC X(07).                    02040006
020100     05  WS-I-SKU-TYPE              PIC X(01).                    02050006
020200     05  WS-I-ICOST                 PIC S9(4)V9(5) COMP-3.        02060006
020300     05  WS-I-UNIT-RETAIL-AMT       PIC 9(05)V99.                 02070006
020400     05  WS-I-GROUP-RETAIL-AMT      PIC 9(05)V99.                 02080006
020500     05  WS-I-GROUP-RETAIL-QTY      PIC 9(03).                    02090006
020600                                                                  02100006
020700 01  CD-SCHEDULE-DATE                 PIC X(10).                  02110006
020800 01  CD-DATE REDEFINES CD-SCHEDULE-DATE.                          02120006
020900     05  CD-YEAR                      PIC 9(4).                   02130006
021000     05  FILLER                       PIC X.                      02140006
021100     05  CD-MONTH                     PIC 99.                     02150006
021200     05  FILLER                       PIC X.                      02160006
021300     05  CD-DAY                       PIC 99.                     02170006
021400                                                                  02180006
021500 01  SC-STATUS-CODES.                                             02190006
021600     05  SC-HEADER-STATUS        PIC XX    VALUE SPACES.          02200006
021700         88  SC-HEADER-STATUS-OK           VALUE '00'.            02210006
021800         88  SC-HEADER-STATUS-DUPLICATE    VALUE '22'.            02220006
021900         88  SC-HEADER-STATUS-NOT-FOUND    VALUE '23'.            02230006
022000     05  SC-DETAIL-STATUS        PIC XX    VALUE SPACES.          02240006
022100         88  SC-DETAIL-STATUS-OK           VALUE '00'.            02250006
022200         88  SC-DETAIL-STATUS-DUPLICATE    VALUE '22'.            02260006
022300         88  SC-DETAIL-STATUS-NOT-FOUND    VALUE '23'.            02270006
022400                                                                  02280006
022500******************************************************************02290006
022600*   OUTPUT FILE RECORD                                            02300006
022700******************************************************************02310006
022800     COPY MRRD135.                                                02320006
022900*                                                                 02330006
023000*---------------------------------------------------------------* 02340006
023100*   ERROR MESSAGE AREA FOR DB2                                    02350006
023200*---------------------------------------------------------------* 02360006
023300     COPY DPWS004.                                                02370006
023400*                                                                 02380006
023500 EJECT                                                            02390006
023600************************                                          02400006
023700* DB2 TABLES                                                      02410006
023800************************                                          02420006
023900                                                                  02430006
024000     EXEC SQL                                                     02440006
024100         INCLUDE TVNDDPT                                          02450006
024200     END-EXEC.                                                    02460006
024300                                                                  02470006
024400     EXEC SQL                                                     02480006
024500         INCLUDE TMRITEM                                          02490006
024600     END-EXEC.                                                    02500006
024700                                                                  02510006
024800     EXEC SQL                                                     02520006
024900         INCLUDE TUPC                                             02530006
025000     END-EXEC.                                                    02540006
025100                                                                  02550006
025200     EXEC SQL                                                     02560006
025300         INCLUDE TSKXREF                                          02570006
025400     END-EXEC.                                                    02580006
025500                                                                  02590006
025600     EXEC SQL                                                     02600006
025700         INCLUDE XMT00001                                         02610006
025800     END-EXEC.                                                    02620006
025900                                                                  02630006
026000     EXEC SQL                                                     02640006
026100         INCLUDE TVNDAGR                                          02650006
026200     END-EXEC.                                                    02660006
026300                                                                  02670006
026400************************                                          02680006
026500* DB2 COMMUNICATION AREA                                          02690006
026600************************                                          02700006
026700                                                                  02710006
026800     EXEC SQL                                                     02720006
026900         INCLUDE SQLCA                                            02730006
027000     END-EXEC.                                                    02740006
027100                                                                  02750006
027200     COPY SQLCA2.                                                 02760006
027300                                                                  02770006
027400************************                                          02780006
027500* DB2 CUSRORS                                                     02790006
027600************************                                          02800006
027700                                                                  02810006
027800******************************************************************02820006
027900 PROCEDURE DIVISION.                                              02830006
028000******************************************************************02840006
028100 A100-PROGRAM-MAINLINE.                                           02850006
028200                                                                  02860006
028300     SET PS-NOT-END-OF-HEADER TO TRUE.                            02870006
028400                                                                  02880006
028500     PERFORM B100-PRE-PROCESSING.                                 02890006
028600                                                                  02900006
028700     PERFORM B200-PROCESS-INFILE                                  02910006
028800             UNTIL PS-END-OF-HEADER.                              02920006
028900                                                                  02930006
029000     PERFORM B300-POST-PROCESSING.                                02940006
029100                                                                  02950006
029200     STOP RUN.                                                    02960006
029300                                                                  02970006
029400                                                                  02980006
029500 B100-PRE-PROCESSING.                                             02990006
029600******************************************************************03000006
029700*   OPEN FILES                                                    03010006
029800*   ACCEPT PARAMETER INPUT                                        03020006
029900*   READ CONTROL FILE                                             03030006
030000*   READ FIRST HEADER RECORD                                      03040006
030100******************************************************************03050006
030200                                                                  03060006
030300     OPEN INPUT  HEADER-FILE                                      03070006
030400                 DETAIL-FILE                                      03080006
030500          OUTPUT OUTPUT-FILE.                                     03090006
030600                                                                  03100006
030700     IF  NOT SC-HEADER-STATUS-OK                                  03110006
030800          DISPLAY '**  ABEND  **'                                 03120006
030900          DISPLAY 'MRKUT135'                                      03130006
031000          DISPLAY 'I/O HEADER FILE OPEN ERROR'                    03140006
031100          DISPLAY 'FILE STATUS CODE = ' SC-HEADER-STATUS          03150006
031200          SET ABEND-4005-OPEN-ERROR TO TRUE                       03160006
031300          CALL 'ILBOABN0' USING ABEND-CODE                        03170006
031400     END-IF.                                                      03180006
031500                                                                  03190006
031600     IF  NOT SC-DETAIL-STATUS-OK                                  03200006
031700         DISPLAY '**  ABEND  **'                                  03210006
031800         DISPLAY 'MRKUT135'                                       03220006
031900         DISPLAY 'I/O DETAIL FILE OPEN ERROR'                     03230006
032000         DISPLAY 'FILE STATUS CODE = ' SC-DETAIL-STATUS           03240006
032100         SET ABEND-4005-OPEN-ERROR TO TRUE                        03250006
032200         CALL 'ILBOABN0' USING ABEND-CODE                         03260006
032300     END-IF.                                                      03270006
032400                                                                  03280006
032500     ACCEPT CD-SCHEDULE-DATE.                                     03290006
032600                                                                  03300006
032700     MOVE CD-MONTH TO PV-ORDER-RUN-MONTH.                         03310006
032800     MOVE '/'      TO PV-ORDER-RUN-SLASH1.                        03320006
032900     MOVE CD-DAY   TO PV-ORDER-RUN-DAY.                           03330006
033000     MOVE '/'      TO PV-ORDER-RUN-SLASH2.                        03340006
033100     MOVE CD-YEAR  TO PV-ORDER-RUN-YEAR.                          03350006
033200                                                                  03360006
033300     SET PS-HEADER-INVALID TO TRUE.                               03370006
033400                                                                  03380006
033500     PERFORM C100-READ-HEADER-FILE                                03390006
033600             UNTIL PS-HEADER-VALID OR                             03400006
033700                   PS-END-OF-HEADER.                              03410006
033800                                                                  03420006
033900 B200-PROCESS-INFILE.                                             03430006
034000******************************************************************03440006
034100*   PERFORM UNTIL NO MORE HEADER RECORDS :                        03450006
034200*     READ AND PROCESS ALL DETAIL RECORDS WITH THE SAME           03460006
034300*          REFERENCE NUMBER AS THE HEADER RECORD                  03470006
034400*     READ THE NEXT HEADER RECORD                                 03480006
034500******************************************************************03490006
034600                                                                  03500006
034700     SET PS-NOT-END-OF-DETAIL TO TRUE.                            03510006
034800                                                                  03520006
034900     PERFORM C200-BUILD-DETAIL-KEY THRU C200-EXIT.                03530006
035000                                                                  03540006
035100     PERFORM C300-PROCESS-DETAIL-FILE THRU C300-EXIT              03550006
035200             UNTIL PS-END-OF-DETAIL.                              03560006
035300                                                                  03570006
035400     SET PS-HEADER-INVALID TO TRUE.                               03580006
035500                                                                  03590006
035600     PERFORM C100-READ-HEADER-FILE                                03600006
035700             UNTIL PS-HEADER-VALID OR                             03610006
035800                   PS-END-OF-HEADER.                              03620006
035900                                                                  03630006
036000 B300-POST-PROCESSING.                                            03640006
036100******************************************************************03650006
036200*   CLOSE FILES                                                   03660006
036300******************************************************************03670006
036400                                                                  03680006
036500     MOVE WS-I-SKU   TO PV-CURR-SKU.                              03690006
036600     PERFORM D200-PROCESS-ITEM-RECORD.                            03700006
036700     PERFORM D300-PROCESS-HDR-RECORD.                             03710006
036800                                                                  03720006
036900     CLOSE HEADER-FILE                                            03730006
037000           DETAIL-FILE                                            03740006
037100           OUTPUT-FILE.                                           03750006
037200                                                                  03760006
037300     IF  NOT SC-HEADER-STATUS-OK                                  03770006
037400         DISPLAY '**  ABEND  **'                                  03780006
037500         DISPLAY 'MRKUT135'                                       03790006
037600         DISPLAY 'I/O HEADER FILE CLOSE ERROR'                    03800006
037700         DISPLAY 'FILE STATUS CODE = ' SC-HEADER-STATUS           03810006
037800         SET ABEND-4006-CLOSE-ERROR TO TRUE                       03820006
037900         CALL 'ILBOABN0' USING ABEND-CODE                         03830006
038000     END-IF                                                       03840006
038100                                                                  03850006
038200     IF  NOT SC-DETAIL-STATUS-OK                                  03860006
038300         DISPLAY '**  ABEND  **'                                  03870006
038400         DISPLAY 'MRKUT135'                                       03880006
038500         DISPLAY 'I/O DETAIL FILE CLOSE ERROR'                    03890006
038600         DISPLAY 'FILE STATUS CODE = ' SC-DETAIL-STATUS           03900006
038700         SET ABEND-4006-CLOSE-ERROR TO TRUE                       03910006
038800         CALL 'ILBOABN0' USING ABEND-CODE                         03920006
038900     END-IF.                                                      03930006
039000                                                                  03940006
039100 C100-READ-HEADER-FILE.                                           03950006
039200******************************************************************03960006
039300*   READ NEXT HEADER RECORD                                       03970006
039400******************************************************************03980006
039500                                                                  03990006
039600     READ HEADER-FILE NEXT                                        04000006
039700          AT END  SET PS-END-OF-HEADER TO TRUE.                   04010006
039800                                                                  04020006
039900     IF H-ORDER-HEADER-KEY = SPACES                               04030006
040000         SET PS-END-OF-HEADER TO TRUE                             04040006
040100     END-IF                                                       04050006
040200                                                                  04060006
040300     IF PS-NOT-END-OF-HEADER                                      04070006
040400        IF H-ORDER-HEADER-KEY = LOW-VALUES OR                     04080006
040500           H-REF-NO (15:1) = 'C' OR                               04090006
040600           TOTCOST = ZERO                                         04100006
040700            CONTINUE                                              04110006
040800        ELSE                                                      04120006
040900            SET PS-HEADER-VALID TO TRUE                           04130006
041000        END-IF                                                    04140006
041100     END-IF.                                                      04150006
041200                                                                  04160006
041300 C200-BUILD-DETAIL-KEY.                                           04170006
041400****************************************************************  04180006
041500*   FORMAT DETAIL KEY USING HEADER REFERENCE NUMBER               04190006
041600*   START READING DETAIL FILE AT FIRST RECORD WITH CURRENT        04200006
041700*     REFERENCE NUMBER                                            04210006
041800****************************************************************  04220006
041900                                                                  04230006
042000     MOVE PC-DETAIL        TO PV-RECORD-TYPE.                     04240006
042100     MOVE H-REF-NO         TO PV-REF-NO                           04250006
042200                              PV-CURR-REF-NO.                     04260006
042300     MOVE PC-FIRST-LINE    TO PV-LINE-NO.                         04270006
042400     MOVE PV-LINE-ITEM-KEY TO D-LINE-ITEM-KEY.                    04280006
042500                                                                  04290006
042600     START DETAIL-FILE                                            04300006
042700           KEY >= D-LINE-ITEM-KEY.                                04310006
042800                                                                  04320006
042900     READ DETAIL-FILE.                                            04330006
043000                                                                  04340006
043100     IF SC-DETAIL-STATUS-OK                                       04350006
043200         NEXT SENTENCE                                            04360006
043300     ELSE                                                         04370006
043400         SET PS-END-OF-DETAIL TO TRUE                             04380006
043500     END-IF.                                                      04390006
043600                                                                  04400006
043700 C200-EXIT.                                                       04410006
043800     EXIT.                                                        04420006
043900                                                                  04430006
044000 C300-PROCESS-DETAIL-FILE.                                        04440006
044100****************************************************************  04450006
044200*   IF SKU CHANGES : WRITE THE PREV ITEM RECORD                   04460006
044300*                    AND WRITE A STORE RECORD                     04470006
044400*   IF REFERENCE NUMBER CHANGES :                                 04480006
044500*                    WRITE THE PREV ITEM RECORD                   04490006
044600****************************************************************  04500006
044700                                                                  04510006
044800     IF NOT PS-END-OF-DETAIL                                      04520006
044900         IF D-REF-NO NOT = PV-CURR-REF-NO                         04530006
045000             MOVE WS-I-SKU        TO PV-CURR-SKU                  04540006
045100             PERFORM D200-PROCESS-ITEM-RECORD                     04550006
045200             PERFORM D300-PROCESS-HDR-RECORD                      04560006
045300             SET PS-END-OF-DETAIL TO TRUE                         04570006
045400         ELSE                                                     04580006
045500             MOVE INAME TO PV-INAME                               04590006
045600             IF PV-SKU     NOT = PV-CURR-SKU                      04600006
045700                 IF PS-FIRST-ITEM                                 04610006
045800                     MOVE PV-SKU           TO PV-CURR-SKU         04620006
045900                     PERFORM D100-PROCESS-STORE-RECORD            04630006
046000                     PERFORM F700-MOVE-ITEM-HOLD-INFO             04640006
046100                     SET PS-NOT-FIRST-ITEM TO TRUE                04650006
046200                 ELSE                                             04660006
046300                     MOVE WS-I-SKU         TO PV-CURR-SKU         04670006
046400                     PERFORM D200-PROCESS-ITEM-RECORD             04680006
046500                     MOVE PV-SKU           TO PV-CURR-SKU         04690006
046600                     PERFORM D100-PROCESS-STORE-RECORD            04700006
046700                     PERFORM F700-MOVE-ITEM-HOLD-INFO             04710006
046800                 END-IF                                           04720006
046900             ELSE                                                 04730006
047000                 PERFORM D100-PROCESS-STORE-RECORD                04740006
047100                 PERFORM F700-MOVE-ITEM-HOLD-INFO                 04750006
047200             END-IF                                               04760006
047300         END-IF                                                   04770006
047400     END-IF.                                                      04780006
047500                                                                  04790006
047600     IF NOT PS-END-OF-DETAIL                                      04800006
047700         PERFORM C400-READ-DETAIL-FILE                            04810006
047800     END-IF.                                                      04820006
047900                                                                  04830006
048000 C300-EXIT.                                                       04840006
048100     EXIT.                                                        04850006
048200                                                                  04860006
048300 C400-READ-DETAIL-FILE.                                           04870006
048400******************************************************************04880006
048500*   READ THE NEXT DETAIL RECORD                                   04890006
048600******************************************************************04900006
048700                                                                  04910006
048800     READ DETAIL-FILE NEXT                                        04920006
048900          AT END  SET PS-END-OF-DETAIL TO TRUE.                   04930006
049000                                                                  04940006
049100 C400-EXIT.                                                       04950006
049200     EXIT.                                                        04960006
049300                                                                  04970006
049400 D100-PROCESS-STORE-RECORD.                                       04980006
049500******************************************************************04990006
049600*   FORMAT A SUGGESTED PO STORE RECORD                            05000006
049700******************************************************************05010006
049800                                                                  05020006
049900     MOVE PV-STORE                  TO PV-STORE-N.                05030006
050000     MOVE PV-STORE-N                TO PV-STORE-NC.               05040006
050100                                                                  05050006
050200     IF PS-ECOMMERCE                                              05060006
050300         PERFORM F100-GET-STORE-INFO                              05070006
050400         IF XMT00001-E-BUS-IND = 'N'                              05080006
050500             SET PS-NOT-ECOMMERCE TO TRUE                         05090006
050600         END-IF                                                   05100006
050700     END-IF                                                       05110006
050800                                                                  05120006
050900     ADD OQ                         TO PV-ITEM-OQ                 05130006
051000     ADD OQ                         TO PV-PO-OQ                   05140006
051100     ADD RAWOQ                      TO PV-ITEM-RAWOQ.             05150006
051200                                                                  05160006
051300     PERFORM E100-FORMAT-WRITE-STORE-RECORD.                      05170006
051400                                                                  05180006
051500 D200-PROCESS-ITEM-RECORD.                                        05190006
051600******************************************************************05200006
051700*   FORMAT A SUGGESTED PO STORE RECORD                            05210006
051800******************************************************************05220006
051900                                                                  05230006
052000     IF PV-CURR-SKU NOT = SPACES                                  05240006
052100         MOVE PV-CURR-SKU-N TO PV-CURR-SKU-P                      05250006
052200     END-IF                                                       05260006
052300                                                                  05270006
052400     PERFORM F200-GET-ITEM-INFO.                                  05280006
052500                                                                  05290006
052600     IF PS-FIRST-DETAIL                                           05300006
052700         MOVE MRITEM-LT-QTY         TO PV-PO-LEAD-TIME            05310006
052800         MOVE MRITEM-RT-NBR         TO PV-PO-REVIEW-TIME          05320006
052900         SET PS-NOT-FIRST-DETAIL    TO TRUE                       05330006
053000     ELSE                                                         05340006
053100         IF PS-NOT-MULTI-LT                                       05350006
053200             IF MRITEM-LT-QTY NOT = PV-PO-LEAD-TIME               05360006
053300                 SET PS-MULTI-LT        TO TRUE                   05370006
053400             END-IF                                               05380006
053500         END-IF                                                   05390006
053600                                                                  05400006
053700         IF PS-NOT-MULTI-RT                                       05410006
053800             IF MRITEM-RT-NBR NOT =  PV-PO-REVIEW-TIME            05420006
053900                 SET PS-MULTI-RT        TO TRUE                   05430006
054000             END-IF                                               05440006
054100         END-IF                                                   05450006
054200     END-IF.                                                      05460006
054300                                                                  05470006
054400     PERFORM E200-FORMAT-WRITE-ITEM-RECORD                        05480006
054500                                                                  05490006
054600     MOVE ZEROES                    TO PV-ITEM-OQ                 05500006
054700                                       PV-ITEM-RAWOQ.             05510006
054800                                                                  05520006
054900     MOVE PV-SKU                    TO PV-CURR-SKU.               05530006
055000                                                                  05540006
055100 D300-PROCESS-HDR-RECORD.                                         05550006
055200******************************************************************05560006
055300*   FORMAT A SUGGESTED PO HEADER RECORD                           05570006
055400******************************************************************05580006
055500                                                                  05590006
055600     MOVE H-USERID(1:3)         TO PV-CURR-DEPT.                  05600006
055700     MOVE H-VENDOR-NO(1)        TO PV-INHOUSE-VENDOR-X.           05610006
055800     MOVE PV-INHOUSE-VENDOR-X(1:3)  TO PV-INHOUSE-VENDOR.         05620006
055900     MOVE PV-INHOUSE-VENDOR         TO PV-INHOUSE-VENDOR-N.       05630006
056000                                                                  05640006
056100     PERFORM F300-GET-VENDOR.                                     05650006
056200                                                                  05660006
056300     PERFORM F400-GET-PK-BY-STR-INFO.                             05670006
056400     PERFORM F500-GET-HNG-INFO.                                   05680006
056500     PERFORM F600-GET-LDTM-PRETK-INFO.                            05690006
056600                                                                  05700006
056700     PERFORM E300-FORMAT-WRITE-HDR-RECORD.                        05710006
056800                                                                  05720006
056900     MOVE ZEROES                TO PV-PO-OQ.                      05730006
057000     MOVE SPACES                TO PV-CURR-SKU.                   05740006
057100                                                                  05750006
057200     SET PS-FIRST-DETAIL        TO TRUE.                          05760006
057300     SET PS-FIRST-ITEM          TO TRUE.                          05770006
057400     SET PS-NOT-MULTI-LT        TO TRUE.                          05780006
057500     SET PS-NOT-MULTI-RT        TO TRUE.                          05790006
057600     SET PS-ECOMMERCE           TO TRUE.                          05800006
057700                                                                  05810006
057800 E100-FORMAT-WRITE-STORE-RECORD.                                  05820006
057900******************************************************************05830006
058000*   FORMAT A SUGGESTED PO STORE RECORD                            05840006
058100******************************************************************05850006
058200                                                                  05860006
058300     MOVE SPACES                TO MR135-STAGING-RECORD.          05870006
058400                                                                  05880006
058500     ADD  PC-ONE                TO PV-SEQUENCE-NBR.               05890006
058600     MOVE PV-SEQUENCE-NBR       TO MR135-SEQUENCE-NUMBER.         05900006
058700     SET  MR135-STORE-RECORD    TO TRUE.                          05910006
058800     MOVE PV-CURR-REF-NO(1:12)  TO MR135-S-SYSTEM-KEY.            05920006
058900     MOVE PV-CURR-SKU           TO MR135-S-SKU.                   05930006
059000     MOVE PC-DISTRIBUTION-TYPE  TO MR135-S-DISTRIBUTION-TYPE.     05940006
059100     MOVE PC-GROUP-TYPE         TO MR135-S-STORE-GROUP-TYPE.      05950006
059200     MOVE PV-STORE              TO MR135-S-DISTRIBUTION-ID.       05960006
059300     MOVE OQ                    TO MR135-S-SUGGESTED-OQ           05970006
059400                                   MR135-S-ACTUAL-OQ.             05980006
059500     MOVE RAWOQ                 TO MR135-S-OPTIMAL-OQ.            05990006
059600                                                                  06000006
059700     WRITE SUGGESTED-PO-RECORD  FROM MR135-STAGING-RECORD.        06010006
059800                                                                  06020006
059900 E200-FORMAT-WRITE-ITEM-RECORD.                                   06030006
060000******************************************************************06040006
060100*   FORMAT A SUGGESTED PO ITEM RECORD                             06050006
060200******************************************************************06060006
060300                                                                  06070006
060400     MOVE SPACES                TO MR135-STAGING-RECORD.          06080006
060500                                                                  06090006
060600     ADD  PC-ONE                TO PV-SEQUENCE-NBR.               06100006
060700     MOVE PV-SEQUENCE-NBR       TO MR135-SEQUENCE-NUMBER.         06110006
060800     SET  MR135-ITEM-RECORD     TO TRUE.                          06120006
060900     MOVE PV-CURR-REF-NO(1:12)  TO MR135-I-SYSTEM-KEY.            06130006
061000     MOVE SKXREF-INTR-UPC-ID    TO PV-UPC-COMP-3.                 06140006
061100     MOVE PV-UPC-COMP-3         TO MR135-I-UPC-ID.                06150006
061200     MOVE PV-CURR-SKU           TO MR135-I-SKU.                   06160006
061300     MOVE PC-SKU-TYPE           TO MR135-I-SKU-TYPE.              06170006
061400     MOVE WS-I-ICOST            TO MR135-I-UNIT-COST-AMOUNT.      06180006
061500     MOVE UPC-INNR-PK-QTY       TO MR135-I-INNER-PACK.            06190006
061600     MOVE UPC-OUTR-PK-QTY       TO MR135-I-OUTER-PACK.            06200006
061700     MOVE WS-I-UNIT-RETAIL-AMT  TO MR135-I-UNIT-RETAIL-AMOUNT.    06210006
061800     MOVE WS-I-GROUP-RETAIL-AMT TO MR135-I-GROUP-RETAIL-AMOUNT.   06220006
061900     MOVE WS-I-GROUP-RETAIL-QTY TO MR135-I-GROUP-RETAIL-QTY.      06230006
062000     MOVE PV-ITEM-OQ            TO MR135-I-SUGGESTED-OQ           06240006
062100                                   MR135-I-ACTUAL-OQ.             06250006
062200     MOVE PV-ITEM-RAWOQ         TO MR135-I-OPTIMAL-OQ.            06260006
062300                                                                  06270006
062400     WRITE SUGGESTED-PO-RECORD  FROM MR135-STAGING-RECORD.        06280006
062500                                                                  06290006
062600 E300-FORMAT-WRITE-HDR-RECORD.                                    06300006
062700*************************************************************     06310006
062800*   FORMAT AND WRITE A SUGGESTED PO HEADER RECORD                 06320006
062900*************************************************************     06330006
063000                                                                  06340006
063100     MOVE SPACES                TO MR135-STAGING-RECORD.          06350006
063200                                                                  06360006
063300     ADD  PC-ONE                TO PV-SEQUENCE-NBR.               06370006
063400     MOVE PV-SEQUENCE-NBR      TO MR135-SEQUENCE-NUMBER.          06380006
063500     SET  MR135-HEADER-RECORD   TO TRUE.                          06390006
063600     MOVE PV-CURR-REF-NO(1:12)  TO MR135-H-SYSTEM-KEY.            06400006
063700     MOVE PC-ACTION-INSERT      TO MR135-H-ACTION.                06410006
063800     MOVE PC-SYSTEM-ID          TO MR135-H-SYSTEM-ID.             06420006
063900     MOVE PC-PGM-NAME           TO MR135-H-USERID.                06430006
064000     MOVE PC-WORKSHEET          TO MR135-H-SUGGESTED-PO-STATUS.   06440006
064100     MOVE PC-PACKAGING          TO MR135-H-PACKAGING-CODE.        06450006
064200     IF PS-ECOMMERCE                                              06460006
064300         MOVE PC-PO-TYPE-EC     TO MR135-H-PO-TYPE-CODE           06470006
064400         MOVE PC-STORE-CAT-EC   TO MR135-H-STORE-CATEGORY         06480006
064500     ELSE                                                         06490006
064600         MOVE PC-PO-TYPE        TO MR135-H-PO-TYPE-CODE           06500006
064700         MOVE PC-STORE-CAT      TO MR135-H-STORE-CATEGORY         06510006
064800     END-IF                                                       06520006
064900     MOVE PV-CURR-DEPT          TO MR135-H-DEPARTMENT.            06530006
065000     MOVE VNDDPT-ENT-ID         TO MR135-H-VENDOR-ID              06540006
065100                                                                  06550006
065200     IF PS-NOT-MULTI-LT                                           06560006
065300         MOVE PV-PO-LEAD-TIME   TO MR135-H-LEAD-TIME              06570006
065400     END-IF.                                                      06580006
065500                                                                  06590006
065600     MOVE PV-ORDER-RUN-DATE     TO MR135-H-ORDER-RUN-DATE.        06600006
065700                                                                  06610006
065800     IF PS-MULTI-RT                                               06620006
065900         MOVE PC-MULTI-RT       TO MR135-H-REVIEW-TIME-NBR        06630006
066000     ELSE                                                         06640006
066100         MOVE PV-PO-REVIEW-TIME TO MR135-H-REVIEW-TIME-NBR        06650006
066200     END-IF.                                                      06660006
066300                                                                  06670006
066400     MOVE H-SYSTEM-ID           TO MR135-H-SYSTEM-CODE            06680006
066500     MOVE PV-PO-OQ              TO MR135-H-SUGGESTED-OQ           06690006
066600                                   MR135-H-ACTUAL-OQ.             06700006
066700                                                                  06710006
066800     MOVE PV-PK-BY-STR          TO MR135-H-PK-BY-STR.             06720006
066900     MOVE PV-HNG                TO MR135-H-HANGER.                06730006
067000     MOVE PV-PRE-TICKNG         TO MR135-H-PTKT-IND.              06740006
067100     MOVE PV-LDTM-DAYS-QTY      TO MR135-H-LDTM-DAYS-QTY.         06750006
067200                                                                  06760006
067300     WRITE SUGGESTED-PO-RECORD  FROM MR135-STAGING-RECORD.        06770006
067400                                                                  06780006
067500 F100-GET-STORE-INFO.                                             06790006
067600******************************************************************06800006
067700*   GET STORE INFO.                                               06810006
067800******************************************************************06820006
067900     MOVE 'F100-STORE-INFO'        TO PV-PARAGRAPH-NAME.          06830006
068000     MOVE 'SELECT STORE INFO'      TO PV-DB2-OPER-ATTEMPTED.      06840006
068100*                                                                 06850006
068200     PERFORM                                                      06860006
068300         WITH TEST AFTER                                          06870006
068400         VARYING PV-SQL-SUB                                       06880006
068500         FROM 1 BY 1                                              06890006
068600         UNTIL PV-SQL-SUB > PC-MAX-RETRIES                        06900006
068700            OR SQLCODE = ZERO                                     06910006
068800            OR SQLCODE = +100                                     06920006
068900                                                                  06930006
069000     EXEC SQL                                                     06940006
069100       SELECT E_BUS_IND                                           06950006
069200        INTO :XMT00001-E-BUS-IND                                  06960006
069300          FROM XMT_LOC A                                          06970006
069400          WHERE A.LOC_NBR      = :PV-STORE-NC                     06980006
069500     END-EXEC                                                     06990006
069600         EVALUATE TRUE                                            07000006
069700             WHEN SQLCODE = ZERO                                  07010006
069800                 CONTINUE                                         07020006
069900             WHEN SQLCODE = -904                                  07030006
070000             WHEN SQLCODE = -913                                  07040006
070100             WHEN SQLCODE = +100                                  07050006
070200                 CONTINUE                                         07060006
070300             WHEN SQLWARN0 NOT = SPACES                           07070006
070400             WHEN SQLCODE  NOT = ZERO                             07080006
070500                  PERFORM Z999-SQL-ABEND                          07090006
070600         END-EVALUATE                                             07100006
070700     END-PERFORM.                                                 07110006
070800*                                                                 07120006
070900     IF PV-SQL-SUB > PC-MAX-RETRIES                               07130006
071000        MOVE 'MAX RETRIES EXCEEDED FOR SELECT'                    07140006
071100                                   TO PV-DB2-OPER-ATTEMPTED       07150006
071200        PERFORM Z999-SQL-ABEND                                    07160006
071300     END-IF.                                                      07170006
071400*                                                                 07180006
071500                                                                  07190006
071600 F200-GET-ITEM-INFO.                                              07200006
071700******************************************************************07210006
071800*   GET ITEM INFO.                                                07220006
071900******************************************************************07230006
072000     MOVE 'F200-ITEM-INFO'        TO PV-PARAGRAPH-NAME.           07240006
072100     MOVE 'SELECT ITEM INFO'      TO PV-DB2-OPER-ATTEMPTED.       07250006
072200*                                                                 07260006
3372A        INITIALIZE DCLTMRITEM                                      07270006
                        DCLTUPC                                         07280006
                        DCLTSKXREF                                      07290006
072300     PERFORM                                                      07300006
072400         WITH TEST AFTER                                          07310006
072500         VARYING PV-SQL-SUB                                       07320006
072600         FROM 1 BY 1                                              07330006
072700         UNTIL PV-SQL-SUB > PC-MAX-RETRIES                        07340006
072800            OR SQLCODE = ZERO                                     07350006
072900            OR SQLCODE = +100                                     07360006
073000                                                                  07370006
073100     EXEC SQL                                                     07380006
3372A        WITH DATA_1 AS (                                           07390006
3372A        SELECT A.SKU SKU,                                          07400006
3372A               LT_QTY,                                             07410006
073300              RT_NBR,                                             07420006
073400              INNR_PK_QTY,                                        07430006
073500              OUTR_PK_QTY,                                        07440006
3372A               A.INTR_UPC_ID INTR_UPC_ID                           07450006
074200          FROM TSKXREF A,                                         07460006
074300               TUPC    B,                                         07470006
074400               TMRITEM C                                          07480006
074500          WHERE A.SKU          = :PV-CURR-SKU-P                   07490006
074600            AND A.ITM_NBR      = C.ITEM_NBR                       07500006
074700            AND A.INTR_UPC_ID  = B.INTR_UPC_ID                    07510006
074800            AND B.UPC_TYP_CDE      = 'I'                          07520006
3372A             AND B.EFF_END_DTE     IS NULL )                       07530006
3372A          SELECT                                                   07540006
3372A                DATA_1.LT_QTY,                                     07550006
3372A                DATA_1.RT_NBR,                                     07560006
3372A                COALESCE(M.INNR_PK_QTY,DATA_1.INNR_PK_QTY),        07570006
3372A                COALESCE(M.OUTR_PK_QTY,DATA_1.OUTR_PK_QTY),        07580006
3372A                DATA_1.INTR_UPC_ID                                 07590006
3372A         INTO :MRITEM-LT-QTY,                                      07600006
3372A              :MRITEM-RT-NBR,                                      07610006
3372A              :UPC-INNR-PK-QTY,                                    07620006
3372A              :UPC-OUTR-PK-QTY,                                    07630006
3372A              :SKXREF-INTR-UPC-ID                                  07640006
3372A         FROM      DATA_1 LEFT OUTER JOIN MRTW_SKU_PKGNG_OVRRID M  07650006
3372A           ON      (DATA_1.SKU=M.SKU_NBR)                          07660006
3372A                   AND M.DISTRB_TYP_CDE = 'B'                      07670006
075000     END-EXEC                                                     07680006
075100         EVALUATE TRUE                                            07690006
075200             WHEN SQLCODE = ZERO                                  07700006
075300                 CONTINUE                                         07710006
075400             WHEN SQLCODE = -904                                  07720006
075500             WHEN SQLCODE = -913                                  07730006
075600             WHEN SQLCODE = +100                                  07740006
075700                 CONTINUE                                         07750006
075800             WHEN SQLWARN0 NOT = SPACES                           07760006
075900             WHEN SQLCODE  NOT = ZERO                             07770006
076000                  PERFORM Z999-SQL-ABEND                          07780006
076100         END-EVALUATE                                             07790006
076200     END-PERFORM.                                                 07800006
076300*                                                                 07810006
076400     IF PV-SQL-SUB > PC-MAX-RETRIES                               07820006
076500        MOVE 'MAX RETRIES EXCEEDED FOR SELECT'                    07830006
076600                                   TO PV-DB2-OPER-ATTEMPTED       07840006
076700        PERFORM Z999-SQL-ABEND                                    07850006
076800     END-IF.                                                      07860006
076900*                                                                 07870006
077000 F300-GET-VENDOR.                                                 07880006
077100******************************************************************07890006
077200*   GET ENT-ID USING INHOUSE NUMBER                               07900006
077300******************************************************************07910006
077400                                                                  07920006
077500     MOVE 'F300-GET-VENDOR'       TO PV-PARAGRAPH-NAME.           07930006
077600     MOVE 'SELECT FOR VENDOR'     TO PV-DB2-OPER-ATTEMPTED.       07940006
077700*                                                                 07950006
077800     PERFORM                                                      07960006
077900         WITH TEST AFTER                                          07970006
078000         VARYING PV-SQL-SUB                                       07980006
078100         FROM 1 BY 1                                              07990006
078200         UNTIL PV-SQL-SUB > PC-MAX-RETRIES                        08000006
078300            OR SQLCODE = ZERO                                     08010006
078400            OR SQLCODE = +100                                     08020006
078500                                                                  08030006
078600     EXEC SQL                                                     08040006
078700       SELECT ENT_ID                                              08050006
078800         INTO :VNDDPT-ENT-ID                                      08060006
078900         FROM TVNDDPT                                             08070006
079000        WHERE INHOUSE_NBR = :PV-INHOUSE-VENDOR-N                  08080006
079100          AND DEPT_NBR    = :PV-CURR-DEPT                         08090006
079200     END-EXEC                                                     08100006
079300         EVALUATE TRUE                                            08110006
079400             WHEN SQLCODE = ZERO                                  08120006
079500                 CONTINUE                                         08130006
079600             WHEN SQLCODE = -904                                  08140006
079700             WHEN SQLCODE = -913                                  08150006
079800             WHEN SQLCODE = +100                                  08160006
079900                 CONTINUE                                         08170006
080000             WHEN SQLWARN0 NOT = SPACES                           08180006
080100             WHEN SQLCODE  NOT = ZERO                             08190006
080200                  PERFORM Z999-SQL-ABEND                          08200006
080300         END-EVALUATE                                             08210006
080400     END-PERFORM.                                                 08220006
080500*                                                                 08230006
080600     IF PV-SQL-SUB > PC-MAX-RETRIES                               08240006
080700        MOVE 'MAX RETRIES EXCEEDED FOR SELECT'                    08250006
080800                                   TO PV-DB2-OPER-ATTEMPTED       08260006
080900        PERFORM Z999-SQL-ABEND                                    08270006
081000     END-IF.                                                      08280006
081100*                                                                 08290006
081200 F400-GET-PK-BY-STR-INFO.                                         08300006
081300******************************************************************08310006
081400*   GET PK-BY-STR-INFO                                            08320006
081500******************************************************************08330006
081600                                                                  08340006
081700     MOVE 'F400-GET-PK-BY-STR'    TO PV-PARAGRAPH-NAME.           08350006
081800     MOVE 'SELECT FOR PK-BY-STR'  TO PV-DB2-OPER-ATTEMPTED.       08360006
081900*                                                                 08370006
082000     PERFORM                                                      08380006
082100         WITH TEST AFTER                                          08390006
082200         VARYING PV-SQL-SUB                                       08400006
082300         FROM 1 BY 1                                              08410006
082400         UNTIL PV-SQL-SUB > PC-MAX-RETRIES                        08420006
082500            OR SQLCODE = ZERO                                     08430006
082600            OR SQLCODE = +100                                     08440006
082700                                                                  08450006
082800     INITIALIZE DCLTVNDAGR                                        08460006
082900     MOVE ZERO                         TO PV-TVNDAGR-COUNT        08470006
083000                                                                  08480006
083100     EXEC SQL                                                     08490006
083200       SELECT COUNT(*)                                            08500006
083300         INTO :PV-TVNDAGR-COUNT                                   08510006
083400         FROM TVNDAGR                                             08520006
083500        WHERE ENT_ID        = :VNDDPT-ENT-ID                      08530006
083600          AND DEPT_NBR      = :PV-CURR-DEPT                       08540006
083700          AND AGRMT_TYP_ID  = '4'                                 08550006
083800          AND TYP_CDE       = 4                                   08560006
083900          AND CURRENT DATE >= EFFECTIVE_DATE                      08570006
084000          AND CURRENT DATE  < EXPIRATION_DATE                     08580006
084100     END-EXEC                                                     08590006
084200         EVALUATE TRUE                                            08600006
084300             WHEN SQLCODE = ZERO                                  08610006
084400                 IF PV-TVNDAGR-COUNT > ZERO                       08620006
084500                    SET PV-PK-BY-STR-Y  TO TRUE                   08630006
084600                 ELSE                                             08640006
084700                    SET PV-PK-BY-STR-N  TO TRUE                   08650006
084800                 END-IF                                           08660006
084900             WHEN SQLCODE = -904                                  08670006
085000             WHEN SQLCODE = -913                                  08680006
085100             WHEN SQLCODE = +100                                  08690006
085200                 CONTINUE                                         08700006
085300             WHEN SQLWARN0 NOT = SPACES                           08710006
085400             WHEN SQLCODE  NOT = ZERO                             08720006
085500                  PERFORM Z999-SQL-ABEND                          08730006
085600         END-EVALUATE                                             08740006
085700     END-PERFORM.                                                 08750006
085800*                                                                 08760006
085900     IF PV-SQL-SUB > PC-MAX-RETRIES                               08770006
086000        MOVE 'MAX RETRIES EXCEEDED FOR SELECT'                    08780006
086100                                   TO PV-DB2-OPER-ATTEMPTED       08790006
086200        PERFORM Z999-SQL-ABEND                                    08800006
086300     END-IF.                                                      08810006
086400*                                                                 08820006
086500 F500-GET-HNG-INFO.                                               08830006
086600******************************************************************08840006
086700*   GET GET-HNG-INFO                                              08850006
086800******************************************************************08860006
086900                                                                  08870006
087000     MOVE 'F500-GET-HNG'          TO PV-PARAGRAPH-NAME.           08880006
087100     MOVE 'SELECT FOR HNG'        TO PV-DB2-OPER-ATTEMPTED.       08890006
087200*                                                                 08900006
087300     PERFORM                                                      08910006
087400         WITH TEST AFTER                                          08920006
087500         VARYING PV-SQL-SUB                                       08930006
087600         FROM 1 BY 1                                              08940006
087700         UNTIL PV-SQL-SUB > PC-MAX-RETRIES                        08950006
087800            OR SQLCODE = ZERO                                     08960006
087900            OR SQLCODE = +100                                     08970006
088000                                                                  08980006
088100     INITIALIZE DCLTVNDAGR                                        08990006
088200     MOVE ZERO                         TO PV-TVNDAGR-COUNT        09000006
088300                                                                  09010006
088400     EXEC SQL                                                     09020006
088500       SELECT COUNT(*)                                            09030006
088600         INTO :PV-TVNDAGR-COUNT                                   09040006
088700         FROM TVNDAGR                                             09050006
088800        WHERE ENT_ID        = :VNDDPT-ENT-ID                      09060006
088900          AND DEPT_NBR      = :PV-CURR-DEPT                       09070006
089000          AND AGRMT_TYP_ID  = '4'                                 09080006
089100          AND TYP_CDE       = 2                                   09090006
089200          AND CURRENT DATE >= EFFECTIVE_DATE                      09100006
089300          AND CURRENT DATE  < EXPIRATION_DATE                     09110006
089400     END-EXEC                                                     09120006
089500         EVALUATE TRUE                                            09130006
089600             WHEN SQLCODE = ZERO                                  09140006
089700                 IF PV-TVNDAGR-COUNT > ZERO                       09150006
089800                    SET PV-HNG-Y  TO TRUE                         09160006
089900                 ELSE                                             09170006
090000                    SET PV-HNG-N  TO TRUE                         09180006
090100                 END-IF                                           09190006
090200             WHEN SQLCODE = -904                                  09200006
090300             WHEN SQLCODE = -913                                  09210006
090400             WHEN SQLCODE = +100                                  09220006
090500                 CONTINUE                                         09230006
090600             WHEN SQLWARN0 NOT = SPACES                           09240006
090700             WHEN SQLCODE  NOT = ZERO                             09250006
090800                  PERFORM Z999-SQL-ABEND                          09260006
090900         END-EVALUATE                                             09270006
091000     END-PERFORM.                                                 09280006
091100*                                                                 09290006
091200     IF PV-SQL-SUB > PC-MAX-RETRIES                               09300006
091300        MOVE 'MAX RETRIES EXCEEDED FOR SELECT'                    09310006
091400                                   TO PV-DB2-OPER-ATTEMPTED       09320006
091500        PERFORM Z999-SQL-ABEND                                    09330006
091600     END-IF.                                                      09340006
091700*                                                                 09350006
091800 F600-GET-LDTM-PRETK-INFO.                                        09360006
091900******************************************************************09370006
092000*   GET GET-LDTM-PRETK-INFO                                       09380006
092100******************************************************************09390006
092200                                                                  09400006
092300     MOVE 'F600-GET-LDTM-PRETK'   TO PV-PARAGRAPH-NAME.           09410006
092400     MOVE 'SELECT FOR LDTM-PRETK' TO PV-DB2-OPER-ATTEMPTED.       09420006
092500*                                                                 09430006
092600     INITIALIZE PV-LDTM-DAYS-QTY                                  09440006
092700                PV-PRE-TICKNG.                                    09450006
092800     PERFORM                                                      09460006
092900         WITH TEST AFTER                                          09470006
093000         VARYING PV-SQL-SUB                                       09480006
093100         FROM 1 BY 1                                              09490006
093200         UNTIL PV-SQL-SUB > PC-MAX-RETRIES                        09500006
093300            OR SQLCODE = ZERO                                     09510006
093400            OR SQLCODE = +100                                     09520006
093500                                                                  09530006
093600     INITIALIZE DCLTVNDAGR                                        09540006
093700     MOVE ZERO                         TO VNDAGR-LEADTIME-DAYS-QTY09550006
093800                                                                  09560006
093900     EXEC SQL                                                     09570006
094000       SELECT LEADTIME_DAYS_QTY                                   09580006
094100         INTO :VNDAGR-LEADTIME-DAYS-QTY                           09590006
094200         FROM TVNDAGR                                             09600006
094300        WHERE ENT_ID        = :VNDDPT-ENT-ID                      09610006
094400          AND DEPT_NBR      = :PV-CURR-DEPT                       09620006
094500          AND AGRMT_TYP_ID  = '4'                                 09630006
094600          AND TYP_CDE       = 1                                   09640006
094700          AND CURRENT DATE >= EFFECTIVE_DATE                      09650006
094800          AND CURRENT DATE  < EXPIRATION_DATE                     09660006
094900     END-EXEC                                                     09670006
095000         EVALUATE TRUE                                            09680006
095100             WHEN SQLCODE = ZERO                                  09690006
095200                 SET PV-PRE-TICKNG-Y TO TRUE                      09700006
095300                 IF VNDAGR-LEADTIME-DAYS-QTY > ZERO               09710006
095400                    MOVE VNDAGR-LEADTIME-DAYS-QTY TO              09720006
095500                                                 PV-LDTM-DAYS-QTY 09730006
095600                 ELSE                                             09740006
095700                    MOVE ZERO TO PV-LDTM-DAYS-QTY                 09750006
095800                 END-IF                                           09760006
095900             WHEN SQLCODE = -904                                  09770006
096000             WHEN SQLCODE = -913                                  09780006
096100                 CONTINUE                                         09790006
096200             WHEN SQLCODE = +100                                  09800006
096300                 SET PV-PRE-TICKNG-N TO TRUE                      09810006
096400             WHEN SQLWARN0 NOT = SPACES                           09820006
096500             WHEN SQLCODE  NOT = ZERO                             09830006
096600                  PERFORM Z999-SQL-ABEND                          09840006
096700         END-EVALUATE                                             09850006
096800     END-PERFORM.                                                 09860006
096900*                                                                 09870006
097000     IF PV-SQL-SUB > PC-MAX-RETRIES                               09880006
097100        MOVE 'MAX RETRIES EXCEEDED FOR SELECT'                    09890006
097200                                   TO PV-DB2-OPER-ATTEMPTED       09900006
097300        PERFORM Z999-SQL-ABEND                                    09910006
097400     END-IF.                                                      09920006
097500                                                                  09930006
097600 F700-MOVE-ITEM-HOLD-INFO.                                        09940006
097700                                                                  09950006
097800     MOVE INAME            TO WS-I-INAME.                         09960006
097900     MOVE ICOST            TO WS-I-ICOST.                         09970006
098000     MOVE CUR-UNIT-RTL-AMT TO WS-I-UNIT-RETAIL-AMT.               09980006
098100     MOVE GR-RTL-AMT       TO WS-I-GROUP-RETAIL-AMT.              09990006
098200     MOVE GR-QTY           TO WS-I-GROUP-RETAIL-QTY.              10000006
098300                                                                  10010006
098400 Z999-SQL-ABEND.                                                  10020006
098500*                                                                 10030006
098600     SET ABEND-4013-DB2-ERROR  TO TRUE.                           10040006
098700     DISPLAY '**  ABEND     **'.                                  10050006
098800     DISPLAY '**  PROGRAM   **  = MRKUT135'.                      10060006
098900     DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            10070006
099000     DISPLAY '**  OPERATION **  = ' PV-DB2-OPER-ATTEMPTED.        10080006
099100                                                                  10090006
099200*    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE         10100006
099300*    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.        10110006
099400                                                                  10120006
099500     COPY DPPD004.                                                10130006
099600                                                                  10140006
099700     CALL 'ILBOABN0'  USING ABEND-CODE.                           10150006
099800*                                                                 10160006
099900***************************************************************** 10170006
100000***********************END OF PROGRAM**************************** 10180006
