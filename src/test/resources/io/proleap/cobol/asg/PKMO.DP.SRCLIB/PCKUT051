000100 IDENTIFICATION DIVISION.                                                 
000200 TITLE 'CREATE SUMMARY TOTALS BY PO/RCVR'.                                
000300                                                                          
000400 PROGRAM-ID.             PCKUT051.                                        
000500 AUTHOR.                 DENNIS STEFFEN.                                  
000600 INSTALLATION.           KOHLS DEPARTMENT STORES.                         
000700 DATE-WRITTEN            DOG DAYS OF AUGUST 2005.                         
000800 DATE-COMPILED.                                                           
000900                                                                          
001000 ENVIRONMENT DIVISION.                                                    
001100 CONFIGURATION SECTION.                                                   
001200                                                                          
001300 SOURCE-COMPUTER.        IBM-3090.                                        
001400 OBJECT-COMPUTER.        IBM-3090.                                        
001500                                                                          
001600 INPUT-OUTPUT SECTION.                                                    
001700                                                                          
001800 FILE-CONTROL.                                                            
001900                                                                          
002000     SELECT ALL-TYPE-SE-FILE                                              
002100         ASSIGN TO INP01.                                                 
002200                                                                          
002300     SELECT PO-RCVR-SUMMARY-FILE                                          
002400         ASSIGN TO OUT01.                                                 
002500                                                                          
002600 DATA DIVISION.                                                           
002700 FILE SECTION.                                                            
002800                                                                          
002900                                                                          
003000 FD  ALL-TYPE-SE-FILE                                                     
003100     RECORDING MODE IS F                                                  
003200     LABEL RECORDS ARE STANDARD                                           
003300     BLOCK CONTAINS 0 RECORDS.                                            
003400                                                                          
003500 01  ALL-TYPE-SE-RECORD               PIC  X(048).                        
003600                                                                          
003700 FD  PO-RCVR-SUMMARY-FILE                                                 
003800     RECORDING MODE IS F                                                  
003900     LABEL RECORDS ARE STANDARD                                           
004000     BLOCK CONTAINS 0 RECORDS.                                            
004100                                                                          
004200 01  PO-RCVR-SUMMARY-REC              PIC X(070).                         
004300                                                                          
004400 WORKING-STORAGE SECTION.                                                 
004500                                                                          
004600 01  FILLER.                                                              
004700     05  FILLER                      PIC  X(36)    VALUE                  
004800         ' ***** WORKING STORAGE PGM=PCKUT051 '.                          
004900     05  PGM-COMPILED                PIC  X(20)    VALUE SPACE.           
005000                                                                          
005100 01  PS-SWITCHES.                                                         
005200     05  PS-EOF-DETAIL-SW             PIC X(01) VALUE 'N'.                
005300         88  PS-EOF-DETAIL-YES                  VALUE 'Y'.                
005400         88  PS-EOF-DETAIL-NO                   VALUE 'N'.                
005500                                                                          
005600                                                                          
005700*        THESE KEYS CONTROL THE OUTER LOOP OF PO/RCVR                     
005800 01  PV-MATCH-KEYS.                                                       
005900     05  PV-CURR-KEY.                                                     
006000         10  PV-CURR-PO               PIC 9(10) VALUE ZERO.               
0518           10  PV-CURR-RCVR             PIC S9(10) VALUE ZERO.              
006200                                                                          
006300     05  PV-PREV-KEY.                                                     
006400         10  PV-PREV-PO               PIC 9(10) VALUE ZERO.               
0518           10  PV-PREV-RCVR             PIC S9(10) VALUE ZERO.              
006600                                                                          
006700 01  PV-TYPE-TOTALS.                                                      
006800     05  PV-AR-TOTAL                  PIC S9(09) COMP-3                   
006900                                                 VALUE ZERO.              
007000     05  PV-UN-TOTAL                  PIC S9(09) COMP-3                   
007100                                                 VALUE ZERO.              
007200     05  PV-PERCENT                   PIC S9(04)V9(06) COMP-3             
007300                                                 VALUE ZERO.              
007400     05  PV-RCVR-REC-COUNT            PIC S9(09) COMP                     
007500                                                 VALUE ZERO.              
007600 01  PV-GLOBAL-TOTALS.                                                    
007700     05  PV-GLOBAL-AR-TOTAL           PIC S9(12) COMP                     
007800                                                 VALUE ZERO.              
007900     05  PV-GLOBAL-UN-TOTAL           PIC S9(12) COMP                     
008000                                                 VALUE ZERO.              
008100/                                                                         
008200 01  PC-CONSTANTS.                                                        
008300     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE                  
008400                                                   'PCKUT051'.            
008500     05  PC-ILBOABN0                 PIC  X(08)    VALUE                  
008600                                                   'ILBOABN0'.            
008700     05  PC-MAX-RETRIES              PIC S9(04)    VALUE  +3              
008800                                                   COMP.                  
008900                                                                          
009000 01  PV-MISC-STUFF.                                                       
009100     05  PV-TMST                      PIC X(26).                          
009200     05  PV-START-RCVR-DATE           PIC X(10).                          
009300     05  PV-END-RCVR-DATE             PIC X(10).                          
009400     05  PV-ABEND-PARAGRAPH           PIC  X(30) VALUE SPACES.            
009500     05  PV-DB2-OPERATION-ATTEMPTED   PIC  X(60) VALUE SPACE.             
009600     05  PV-SQL-CODE                  PIC  9(04) VALUE ZERO.              
009700     05  PV-COMP-10                   PIC S9(10) VALUE ZERO               
009800                                                   COMP SYNC.             
009900     05  PV-DISP-BIG                  PIC ZZZ,ZZZ,ZZZ,ZZ9.                
010000     05  PV-ABEND-CODE                PIC S9(04) VALUE ZERO               
010100                                                   COMP SYNC.             
010200     05  PV-READ-COUNTER-DTL          PIC S9(09) COMP-3                   
010300                                              VALUE ZERO.                 
010400     05  PV-WRITE-1-COUNTER           PIC S9(09) COMP-3                   
010500                                              VALUE ZERO.                 
010600     05  PV-DISP-NBR                  PIC ZZZ,ZZZ,ZZ9.                    
010700     05  PV-DISP-PERCENT              PIC ZZ9.9999.                       
010800     05  PV-ABEND-OPERATION           PIC X(20) VALUE SPACES.             
010900     05  PV-ABEND-STRUCTURE-1         PIC X(20) VALUE SPACES.             
011000                                                                          
011100 01  ABEND-CODE                       PIC S9(04)     VALUE +0             
011200                                                     COMP SYNC.           
011300     88  ABEND-4001-WRITE-ERROR                      VALUE +4001.         
011400     88  ABEND-4002-READ-ERROR                       VALUE +4002.         
011500     88  ABEND-4003-CTRL-CARD-ERROR                  VALUE +4003.         
011600     88  ABEND-4004-TABLE-ERROR                      VALUE +4004.         
011700     88  ABEND-4005-OPEN-ERROR                       VALUE +4005.         
011800     88  ABEND-4006-CLOSE-ERROR                      VALUE +4006.         
011900     88  ABEND-4007-SEQUENCE-ERROR                   VALUE +4007.         
012000     88  ABEND-4008-DATS-ERROR                       VALUE +4008.         
012100     88  ABEND-4009-KEY-DATS-ERROR                   VALUE +4009.         
012200     88  ABEND-4013-DB2-ERROR                        VALUE +4013.         
012300                                                                          
012400 01  PV-COUNT-MSG-1.                                                      
012500     05  FILLER                       PIC X(38) VALUE                     
012600         'RECORDS WRITTEN TO OUT01           = '.                         
012700     05  FILLER                       PIC X(31) VALUE SPACES.             
012800     05  PV-MSG-1-COUNT               PIC ZZZ,ZZZ,ZZ9.                    
012900                                                                          
013000 01  PV-COUNT-MSG-2.                                                      
013100     05  FILLER                       PIC X(38) VALUE                     
013200         'RECORDS READ FROM INP01            = '.                         
013300     05  FILLER                       PIC X(31) VALUE SPACES.             
013400     05  PV-MSG-READ-COUNT            PIC ZZZ,ZZZ,ZZ9.                    
013500                                                                          
013600*    SE UNBALANCED FILE                                                   
013700     COPY PCRD037.                                                        
013800                                                                          
013900*    PO/RCVR SUMMARY                                                      
014000     COPY PCRD042.                                                        
014100/                                                                         
014200     EXEC SQL                                                             
014300         INCLUDE SQLCA                                                    
014400     END-EXEC.                                                            
014500                                                                          
014600     COPY SQLCA2.                                                         
014700                                                                          
014800     COPY DPWS004.                                                        
014900/                                                                         
015000 PROCEDURE DIVISION.                                                      
015100                                                                          
015200     PERFORM 1000-INITIALIZATION.                                         
015300                                                                          
015400     PERFORM 2000-PROCESS UNTIL PS-EOF-DETAIL-YES                         
015500                                                                          
015600     PERFORM 9000-QUIT.                                                   
015700                                                                          
015800     GOBACK.                                                              
015900/                                                                         
016000 1000-INITIALIZATION.                                                     
016100     MOVE '1000-INITIALIZATION         '  TO PV-ABEND-PARAGRAPH.          
016200                                                                          
016300     DISPLAY SPACES.                                                      
016400     DISPLAY ' STARTING PCKUT051'                                         
016500                                                                          
016600     OPEN INPUT ALL-TYPE-SE-FILE                                          
016700          OUTPUT PO-RCVR-SUMMARY-FILE                                     
016800                                                                          
016900     PERFORM 8000-READ-DETAIL-EXTRACT                                     
017000             UNTIL PC037-PO-NBR > ZERO                                    
017100                  OR  PS-EOF-DETAIL-YES                                   
017200                                                                          
017300     IF PS-EOF-DETAIL-YES                                                 
017400         DISPLAY SPACES                                                   
017500         DISPLAY ALL '*'                                                  
017600         DISPLAY '  DETAIL INPUT FILE IS EMPTY '                          
017700         DISPLAY ALL '*'                                                  
017800         DISPLAY SPACES                                                   
017900     ELSE                                                                 
018000         MOVE PV-CURR-KEY             TO PV-PREV-KEY                      
018100     END-IF.                                                              
018200     MOVE '9999-09-09'                TO PV-START-RCVR-DATE               
018300     MOVE '0001-01-01'                TO PV-END-RCVR-DATE                 
018400     EXEC SQL                                                             
018500         SET :PV-TMST = CURRENT TIMESTAMP                                 
018600     END-EXEC.                                                            
018700/                                                                         
018800 2000-PROCESS.                                                            
018900                                                                          
019000     MOVE '2000-PROCESS'                  TO PV-ABEND-PARAGRAPH.          
019100                                                                          
019200     IF PV-CURR-KEY = PV-PREV-KEY                                         
019300         PERFORM 2005-SAVE-RCVR-DATES                                     
019400         PERFORM 2006-ADD-TO-RCVR-TOTS                                    
019500     ELSE                                                                 
019600         PERFORM 2200-PO-RCVR-BREAK                                       
019700         PERFORM 2005-SAVE-RCVR-DATES                                     
019800         PERFORM 2006-ADD-TO-RCVR-TOTS                                    
019900     END-IF.                                                              
020000                                                                          
020100     PERFORM 8000-READ-DETAIL-EXTRACT.                                    
020200                                                                          
020300 2005-SAVE-RCVR-DATES.                                                    
020400*    SAVE THE LATEST DATE OF THE PO/RCVR GROUP ONLY IF                    
020500*         THE TYPE IS NOT A CLEAN                                         
020600                                                                          
020700     IF PC037-TRN-TYP-CDE = 'CL'                                          
164325     OR PC037-TRN-TYP-CDE = 'AU'                                          
020800         CONTINUE                                                         
020900     ELSE                                                                 
021000         IF PC037-IN-TRNST-TRN-TMST (1:10) < PV-START-RCVR-DATE           
021100             MOVE PC037-IN-TRNST-TRN-TMST (1:10)                          
021200                                          TO PV-START-RCVR-DATE           
021300         END-IF                                                           
021400                                                                          
021500*        SAVE THE EARLIEST DATE OF THE PO/RCVR GROUP                      
021600         IF PC037-IN-TRNST-TRN-TMST (1:10) > PV-END-RCVR-DATE             
021700             MOVE PC037-IN-TRNST-TRN-TMST (1:10)                          
021800                                          TO PV-END-RCVR-DATE             
021900         END-IF                                                           
022000     END-IF.                                                              
022100                                                                          
022200 2006-ADD-TO-RCVR-TOTS.                                                   
022300                                                                          
022400     EVALUATE TRUE                                                        
022500         WHEN PC037-TRN-TYP-CDE = 'CL'                                    
022600             IF PC037-TRN-CLSN-PRCG-QTY < ZERO                            
022700                 MULTIPLY PC037-TRN-CLSN-PRCG-QTY BY -1                   
022800                     GIVING PC037-TRN-CLSN-PRCG-QTY                       
022900                 ADD PC037-TRN-CLSN-PRCG-QTY                              
023000                                      TO PV-UN-TOTAL                      
023100                                         PV-GLOBAL-UN-TOTAL               
023200             ELSE                                                         
023300                 ADD PC037-TRN-CLSN-PRCG-QTY                              
023400                                      TO PV-AR-TOTAL                      
023500                                         PV-GLOBAL-AR-TOTAL               
023600             END-IF                                                       
023700                                                                          
023800         WHEN PC037-TRN-TYP-CDE = 'UN'                                    
164325         WHEN PC037-TRN-TYP-CDE = 'AU'                                    
164325         WHEN PC037-TRN-TYP-CDE = 'MU'                                    
023900             MULTIPLY PC037-TRN-CLSN-PRCG-QTY BY -1                       
024000                     GIVING PC037-TRN-CLSN-PRCG-QTY                       
024100             ADD PC037-TRN-CLSN-PRCG-QTY                                  
024200                                      TO PV-UN-TOTAL                      
024300                                         PV-GLOBAL-UN-TOTAL               
024400                                                                          
024500         WHEN OTHER                                                       
024600             ADD PC037-TRN-CLSN-PRCG-QTY                                  
024700                                      TO PV-AR-TOTAL                      
024800                                         PV-GLOBAL-AR-TOTAL               
024900     END-EVALUATE.                                                        
025000     ADD 1                            TO PV-RCVR-REC-COUNT.               
025100                                                                          
025200 2050-CALC-PERCENTAGES.                                                   
025300                                                                          
025400     MOVE ZERO                        TO PV-PERCENT                       
025500                                                                          
025600     IF PV-AR-TOTAL < ZERO                                                
025700         MULTIPLY PV-AR-TOTAL BY -1 GIVING PV-AR-TOTAL                    
025800     END-IF                                                               
025900                                                                          
026000     IF PV-UN-TOTAL < ZERO                                                
026100         MULTIPLY PV-UN-TOTAL BY -1 GIVING PV-UN-TOTAL                    
026200     END-IF                                                               
026300                                                                          
026400     EVALUATE TRUE                                                        
026500         WHEN (PV-UN-TOTAL > PV-AR-TOTAL) AND PV-AR-TOTAL > ZERO          
026600             COMPUTE PV-PERCENT = (PV-AR-TOTAL / PV-UN-TOTAL)             
026700                                  * 100                                   
026800         WHEN (PV-UN-TOTAL < PV-AR-TOTAL) AND PV-UN-TOTAL > ZERO          
026900             COMPUTE PV-PERCENT = (PV-UN-TOTAL / PV-AR-TOTAL)             
027000                                  * 100                                   
027100     END-EVALUATE.                                                        
027200                                                                          
027300 2200-PO-RCVR-BREAK.                                                      
027400                                                                          
027500     PERFORM 2050-CALC-PERCENTAGES                                        
027600                                                                          
027700     INITIALIZE PC042-PO-RCVR-SUMMARY-REC                                 
027800     MOVE PV-PREV-PO                  TO PC042-PO-NBR                     
027900     MOVE PV-PREV-RCVR                TO PC042-RCVR-SEQ-NBR               
028000     MOVE PV-PERCENT                  TO PC042-PERCENTAGE                 
028100     MOVE PV-UN-TOTAL                 TO PC042-UN-TOTAL                   
028200     MOVE PV-AR-TOTAL                 TO PC042-AR-TOTAL                   
028300     MOVE PV-START-RCVR-DATE          TO PC042-PO-RCVR-START-DTE          
028400     MOVE PV-END-RCVR-DATE            TO PC042-PO-RCVR-END-DTE            
028500     MOVE PV-RCVR-REC-COUNT           TO PC042-REC-COUNT                  
028600                                                                          
028700     PERFORM 8300-WRITE-PC042                                             
028800                                                                          
028900     MOVE PV-CURR-KEY                 TO PV-PREV-KEY                      
029000     MOVE '9999-09-09'                TO PV-START-RCVR-DATE               
029100     MOVE '0001-01-01'                TO PV-END-RCVR-DATE                 
029200                                                                          
029300     MOVE ZERO                        TO PV-AR-TOTAL                      
029400                                         PV-UN-TOTAL                      
029500                                         PV-RCVR-REC-COUNT.               
029600/                                                                         
029700 8000-READ-DETAIL-EXTRACT.                                                
029800                                                                          
029900     MOVE '8000-READ-DETAIL-EXTRACT   '  TO PV-ABEND-PARAGRAPH.           
030000*                                                                         
030100     READ ALL-TYPE-SE-FILE                                                
030200         INTO                                                             
030300             PC037-BMC-UNLOAD-SE-REC                                      
030400         AT END                                                           
030500             SET PS-EOF-DETAIL-YES    TO TRUE                             
030600         NOT AT END                                                       
030700             ADD 1                    TO PV-READ-COUNTER-DTL              
030800             MOVE PC037-PO-NBR        TO PV-COMP-10                       
030900             MOVE PV-COMP-10          TO PV-CURR-PO                       
031000                                                                          
031100             MOVE PC037-RCVR-SEQ-NBR  TO PV-COMP-10                       
031200             MOVE PV-COMP-10          TO PV-CURR-RCVR                     
031300     END-READ.                                                            
031400                                                                          
031500 8300-WRITE-PC042.                                                        
031600     MOVE '8300-WRITE-PC042          ' TO PV-ABEND-PARAGRAPH.             
031700                                                                          
031800     WRITE                                                                
031900         PO-RCVR-SUMMARY-REC FROM PC042-PO-RCVR-SUMMARY-REC               
032000     END-WRITE.                                                           
032100     ADD 1                            TO PV-WRITE-1-COUNTER.              
032200/                                                                         
032300 9000-QUIT.                                                               
032400                                                                          
032500     PERFORM 2200-PO-RCVR-BREAK.                                          
032600                                                                          
032700     CLOSE ALL-TYPE-SE-FILE                                               
032800           PO-RCVR-SUMMARY-FILE                                           
032900                                                                          
033000     DISPLAY SPACES.                                                      
033100                                                                          
033200     MOVE PV-READ-COUNTER-DTL         TO PV-MSG-READ-COUNT                
033300     DISPLAY PV-COUNT-MSG-2.                                              
033400                                                                          
033500     DISPLAY SPACES                                                       
033600                                                                          
033700     MOVE PV-WRITE-1-COUNTER          TO PV-MSG-1-COUNT                   
033800     DISPLAY PV-COUNT-MSG-1.                                              
033900     PERFORM 9001-GLOBAL-TOTALS.                                          
034000                                                                          
034100 9001-GLOBAL-TOTALS.                                                      
034200                                                                          
034300     DISPLAY SPACES.                                                      
034400     MOVE PV-GLOBAL-AR-TOTAL          TO PV-DISP-BIG                      
034500     DISPLAY ' GLOBAL AR QTY  =       ' PV-DISP-BIG                       
034600                                                                          
034700     MOVE PV-GLOBAL-UN-TOTAL          TO PV-DISP-BIG                      
034800     DISPLAY ' GLOBAL UN QTY  =       ' PV-DISP-BIG                       
034900                                                                          
035000     EVALUATE TRUE                                                        
035100         WHEN (PV-GLOBAL-UN-TOTAL > PV-GLOBAL-AR-TOTAL)                   
035200                      AND PV-GLOBAL-AR-TOTAL > ZERO                       
035300             COMPUTE PV-PERCENT =                                         
035400                  (PV-GLOBAL-AR-TOTAL / PV-GLOBAL-UN-TOTAL)               
035500                                  * 100                                   
035600         WHEN (PV-GLOBAL-UN-TOTAL < PV-GLOBAL-AR-TOTAL)                   
035700         AND PV-GLOBAL-UN-TOTAL > ZERO                                    
035800             COMPUTE PV-PERCENT =                                         
035900                  (PV-GLOBAL-UN-TOTAL / PV-GLOBAL-AR-TOTAL)               
036000                                   * 100                                  
036100     END-EVALUATE.                                                        
036200                                                                          
036300     MOVE PV-PERCENT                  TO PV-DISP-PERCENT                  
036400     DISPLAY ' GLOBAL PERCENT =              ' PV-DISP-PERCENT.           
036500/                                                                         
036600 9100-SQL-ABEND.                                                          
036700******************************************************************        
036800*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL            
036900*  ERROR OR WARNING CODE OCCURS.                                          
037000******************************************************************        
037100     DISPLAY '9100-SQL-ABEND'.                                            
037200     DISPLAY '** ABEND     **'.                                           
037300     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.                
037400     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.                     
037500     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.             
037600     DISPLAY '**              ** = '                                      
037700     MOVE SQLCODE TO PV-SQL-CODE.                                         
037800     DISPLAY '** SQL CODE  ** = ' PV-SQL-CODE.                            
037900     MOVE +4013 TO PV-ABEND-CODE.                                         
038000     CALL 'ILBOABN0' USING PV-ABEND-CODE.                                 
038100                                                                          
038200******************************************************************        
038300*  THIS MODULE PERFORMS THE SQL WARNING.                         *        
038400******************************************************************        
038500                                                                          
038600 9800-SQL-WARNING.                                                        
038700                                                                          
038800     MOVE SQLCODE               TO SQLCODE2.                              
038900     MOVE SQLERRD(3)            TO SQLERRD3.                              
039000     DISPLAY '** ABEND **       ** = SQLWARNING'.                         
039100     DISPLAY '** PROGRAM        ** = PCKUT051'.                           
039200     DISPLAY '** PARAGRAPH      ** = ' PV-ABEND-PARAGRAPH.                
039300     DISPLAY '** SQLCODE        ** = ' SQLCODE2.                          
039400     DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                          
039500                                                                          
039600     COPY DPPD004.                                                        
039700     SET ABEND-4013-DB2-ERROR   TO TRUE                                   
039800     CALL 'ILBOABN0' USING ABEND-CODE.                                    
039900/                                                                         
040000******************************************************************        
040100* THIS MODULE PERFORMS THE SQL ERROR.                            *        
040200******************************************************************        
040300                                                                          
040400 9900-SQL-ERROR.                                                          
040500                                                                          
040600     MOVE SQLCODE               TO SQLCODE2.                              
040700     MOVE SQLERRD(3)            TO SQLERRD3.                              
040800     DISPLAY '** ABEND **       ** = SQLERROR'.                           
040900     DISPLAY '** PROGRAM        ** = PCKUT051'.                           
041000     DISPLAY '** PARAGRAPH      ** = ' PV-ABEND-PARAGRAPH.                
041100     DISPLAY '** OPERATION      ** = ' PV-ABEND-OPERATION                 
041200     DISPLAY '** TABLE          ** = ' PV-ABEND-STRUCTURE-1               
041300     DISPLAY SPACES                                                       
041400                                                                          
041500     COPY DPPD004.                                                        
041600     SET ABEND-4013-DB2-ERROR   TO TRUE                                   
041700     CALL 'ILBOABN0' USING ABEND-CODE.                                    
