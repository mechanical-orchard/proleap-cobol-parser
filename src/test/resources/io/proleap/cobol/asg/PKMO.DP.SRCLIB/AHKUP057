000100 IDENTIFICATION DIVISION.                                         00010038
000200 PROGRAM-ID.         AHKUP057.                                    00020044
000300 AUTHOR.             MIKE BESKE.                                  00030040
000400 DATE-WRITTEN.       DECEMBER 2000.                               00040040
000500*************************************************************     00050038
000600*    COBOL 2 WITH SQL                                       *     00060038
000700*                                                           *     00070038
000800*   AHKUP057 - ARCHIVE HISTORY DATA DELETION - TNINREC      *     00080044
000900*                                                           *     00090038
001000*   PROGRAM OVERVIEW:                                       *     00100038
001100*                                                           *     00110038
001200*  THIS PROGRAM DELETES "OLD" ROWS FROM DB2 TABLE TNINREC.  *     00120040
001300*  ROWS DELETED ARE THOSE PREVIOUSLY:                       *     00130038
001400*  - IDENTIFIED/EXTRACTED WITHIN THE ARCHIVE/HISTORY SYSTEM.*     00140038
001500*                                                           *     00150038
001600*  THE EXTRACT FILE USED AS INPUT WILL BE SORTED BY THE     *     00160038
001700*  CLUSTERING INDEX COLUMNS TO SPEED THE DELETION PROCESS.  *     00170038
001800*  THESE COLUMNS ARE PO_NBR.                                *     00180047
001900*                                                           *     00190038
002000*                                                           *     00200038
002100*   INPUT:                                                  *     00210038
002200*                                                           *     00220038
002300*     1. TPAYREQ DELETION FILE  COPYBOOK AHRD001            *     00230047
002400*                                                           *     00240038
002500*   DB2 TABLES:                                             *     00250038
002600*                                                           *     00260038
002700*        TNINREC - NON-INVOICED RECEIPTS TABLE              *     00270040
002800*        TCKRSTIN - CHECKPOINT/RESTART INFO TABLE           *     00280038
002900*        TCKRSTCN - CHECKPOINT/RESTART CONTROL TABLE        *     00290038
003000*                                                           *     00300038
003100*************************************************************     00310038
003110*-----------------------------------------------------------*     00311050
003120*  CHANGE LOG:                                              *     00312050
003130* 06/19/07                                                  *     00313054
003140*     MATCH BY DC PROJECT.                                  *     00314050
003150*     INCREASED SIZE OF INPUT FILE FROM 186 TO 189.  THIS   *     00315050
003160*     WAS NEEDED TO ALLOW FOR THE 2 NEW FIELDS IN THE       *     00316050
003170*     AHRD001 COPYBOOK: DC-NBR AND MTCH-LVL-CDE.            *     00317050
003180* MADE BY: MICHELE RINDFLEISCH                 WR# 32804    *     00318053
003190*-----------------------------------------------------------*     00319050
003300*************************************************************     00330038
003400 EJECT                                                            00340038
003500 ENVIRONMENT DIVISION.                                            00350038
003600 CONFIGURATION SECTION.                                           00360038
003700 SOURCE-COMPUTER.        IBM-370.                                 00370038
003800 OBJECT-COMPUTER.        IBM-370.                                 00380038
003900                                                                  00390038
004000 INPUT-OUTPUT SECTION.                                            00400038
004100 FILE-CONTROL.                                                    00410038
004200     SELECT TPAYREQ-EXTRACT-FILE ASSIGN TO INP01.                 00420047
004300                                                                  00430038
004400 DATA DIVISION.                                                   00440038
004500 FILE SECTION.                                                    00450038
004600 FD  TPAYREQ-EXTRACT-FILE                                         00460047
004700     RECORDING MODE IS F                                          00470038
004800     LABEL RECORDS ARE STANDARD                                   00480038
004900     BLOCK CONTAINS 0 RECORDS                                     00490038
005000     RECORD CONTAINS 189 CHARACTERS                               00500052
005100     DATA RECORD IS TPAYREQ-EXTRACT-DATA.                         00510047
005200 01  TPAYREQ-EXTRACT-DATA       PIC X(189).                       00520050
005300                                                                  00530038
005400                                                                  00540038
005500 EJECT                                                            00550038
005600 WORKING-STORAGE SECTION.                                         00560038
005700                                                                  00570038
005800 01  FILLER                       PIC X(58)     VALUE             00580038
005900     '************WORKING STORAGE STARTS HERE*******************'.00590038
006000                                                                  00600038
006100 01  PV-PROGRAM-VARIABLES.                                        00610038
006200     05  PV-PROGRAM-NAME          PIC  X(08)    VALUE 'AHKUP057'. 00620044
006300     05  PV-CKPT-STAT-CODE        PIC X(01)     VALUE SPACE.      00630038
006400     05  PV-CURRENT-PARAGRAPH     PIC X(50)     VALUE SPACES.     00640038
006500     05  PV-CURRENT-TMST          PIC X(26)     VALUE SPACES.     00650038
006600                                                                  00660038
006700     05  PV-TPAYREQ-INPUT-COUNT   PIC S9(09)    VALUE ZERO        00670047
006800                                                COMP-3.           00680038
006900     05  PV-TNINREC-DELETE-COUNT  PIC S9(09)    VALUE ZERO        00690040
007000                                                COMP-3.           00700038
007100     05  PV-SQL-DELETE-COUNT      PIC S9(09)    VALUE ZERO        00710038
007200                                                COMP-3.           00720038
007300     05  PV-SQLERRD3              PIC S9(09)    VALUE ZERO        00730038
007400                                                COMP-3.           00740038
007500     05  PV-DISP-PAYT-REQ-SEQ-NBR PIC X(09)    VALUE SPACES.      00750038
007600     05  PV-DISP-PO-NBR           PIC X(09)    VALUE SPACES.      00760038
007700 01  PC-PROGRAM-CONSTANTS.                                        00770038
007800     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          00780038
007900                                                COMP SYNC.        00790038
008000     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      00800038
008100     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00810038
008200     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00820038
008300                                                                  00830038
008400 01  PS-PROGRAM-SWITCHES.                                         00840038
008500     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.        00850038
008600         88  COMMITS-TAKEN                      VALUE 'T'.        00860038
008700         88  NO-COMMITS-TAKEN                   VALUE 'N'.        00870038
008800     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.        00880038
008900         88  MORE-EXTRACT                       VALUE 'M'.        00890038
009000         88  END-OF-EXTRACT                     VALUE 'E'.        00900038
009100     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        00910038
009200         88  NORMAL-RUN                         VALUE '0'.        00920038
009300         88  RESTART-RUN                        VALUE '9'.        00930038
009400                                                                  00940038
009500 01  WS-COUNTER.                                                  00950038
009600     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.     00960038
009700     05  WS-TMST                  PIC X(26)     VALUE SPACES.     00970038
009800                                                                  00980038
009900 01  CKPT-RESTART-INFO.                                           00990038
010000     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.       01000038
010100                                                                  01010038
010200*----------------------------------------------------------------*01020038
010300*  ABEND DATA AREAS                                              *01030038
010400*----------------------------------------------------------------*01040038
010500 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01050038
010600                                             COMP SYNC.           01060038
010700     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         01070038
010800     88  AC-BAD-DATA                         VALUE +4008.         01080038
010900     88  AC-DB2-ERROR                        VALUE +4013.         01090038
011000     88  AC-DATE-ERROR                       VALUE +4019.         01100038
011100                                                                  01110038
011200                                                                  01120038
011300 01  ABEND-AREAS.                                                 01130038
011400     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01140038
011500             '*****       ABEND'.                                 01150038
011600     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01160038
011700             '*****   PROGRAM: AHKUP057'.                         01170044
011800     05  AA-PARAGRAPH-LIT.                                        01180038
011900         10  FILLER              PIC  X(17)  VALUE                01190038
012000             '***** PARAGRAPH: '.                                 01200038
012100         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01210038
012200     05  AA-MESSAGE-LINE-1.                                       01220038
012300         10  FILLER              PIC  X(06)  VALUE '*****'.       01230038
012400         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01240038
012500     05  AA-MESSAGE-LINE-2.                                       01250038
012600         10  FILLER              PIC  X(06)  VALUE '*****'.       01260038
012700         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01270038
012800     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01280038
012900             '*****    DB2 ERROR'.                                01290038
013000     05  AA-DB2-OPERATION-LIT.                                    01300038
013100         10  FILLER              PIC  X(17)  VALUE                01310038
013200             '***** OPERATION: '.                                 01320038
013300         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01330038
013400     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01340038
013500     EJECT                                                        01350038
013600                                                                  01360038
013700*----------------------------------------------------------------*01370038
013800*      TPAYREQ DELETION CONTROL FILE                              01380047
013900*----------------------------------------------------------------*01390038
014000*                                                                 01400038
014100     COPY AHRD001.                                                01410040
014200     EJECT                                                        01420038
014300     COPY DPWS004.                                                01430038
014400     EJECT                                                        01440038
014500*----------------------------------------------------------------*01450038
014600*      TNINREC TABLE LAYOUT                                       01460042
014700*----------------------------------------------------------------*01470038
014800         EXEC SQL                                                 01480038
014900             INCLUDE TNINREC                                      01490042
015000         END-EXEC.                                                01500038
015100                                                                  01510038
015200*----------------------------------------------------------------*01520038
015300*      TCKRSTCNTL TABLE LAYOUT                                    01530038
015400*----------------------------------------------------------------*01540038
015500         EXEC SQL                                                 01550038
015600             INCLUDE TCKRSTCN                                     01560038
015700         END-EXEC.                                                01570038
015800                                                                  01580038
015900*----------------------------------------------------------------*01590038
016000*      TCKRSTINF TABLE LAYOUT                                     01600038
016100*----------------------------------------------------------------*01610038
016200         EXEC SQL                                                 01620038
016300             INCLUDE TCKRSTIN                                     01630038
016400         END-EXEC.                                                01640038
016500 EJECT                                                            01650038
016600*----------------------------------------------------------------*01660038
016700*  DB2 COMMUNICATION AREA                                         01670038
016800*----------------------------------------------------------------*01680038
016900*                                                                 01690038
017000     EXEC SQL                                                     01700038
017100         INCLUDE SQLCA                                            01710038
017200     END-EXEC.                                                    01720038
017300                                                                  01730038
017400*----------------------------------------------------------------*01740038
017500*  DB2 COMMUNICATION AREA2                                        01750038
017600*----------------------------------------------------------------*01760038
017700*                                                                 01770038
017800     COPY SQLCA2.                                                 01780038
017900     EJECT                                                        01790038
018000 PROCEDURE DIVISION.                                              01800038
018100 A100-MAINLINE-ROUTINE.                                           01810038
018200                                                                  01820038
018300     PERFORM B100-INITIALIZATION.                                 01830038
018400                                                                  01840038
018500     PERFORM B200-TNINREC-EXTRACT-PROCESS                         01850040
018600       UNTIL END-OF-EXTRACT.                                      01860038
018700                                                                  01870038
018800     PERFORM B300-EOJ-PROCESSING.                                 01880038
018900                                                                  01890038
019000     GOBACK.                                                      01900038
019100 EJECT                                                            01910038
019200 B100-INITIALIZATION.                                             01920038
019300                                                                  01930038
019400     EXEC SQL                                                     01940038
019500         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 01950038
019600     END-EXEC.                                                    01960038
019700                                                                  01970038
019800     PERFORM X300-GET-CHECKPOINT-CNTL.                            01980038
019900     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    01990038
020000                                                                  02000038
020100     OPEN INPUT TPAYREQ-EXTRACT-FILE.                             02010047
020200                                                                  02020038
020300     IF RESTART-RUN                                               02030038
020400         PERFORM X200-CHECKPOINT-RESTART                          02040038
020500     ELSE                                                         02050038
020600         PERFORM R100-READ-EXTRACT-FILE                           02060038
020700     END-IF.                                                      02070038
020800                                                                  02080038
020900     PERFORM X500-SET-CHECKPOINT-TIME.                            02090038
021000                                                                  02100038
021100                                                                  02110038
021200     EJECT                                                        02120038
021300 B200-TNINREC-EXTRACT-PROCESS.                                    02130040
021400                                                                  02140038
021500     MOVE AH001-B-PO-NBR            TO NINREC-PO-NBR              02150049
021600                                       PV-DISP-PO-NBR.            02160038
021700                                                                  02170038
021800     PERFORM D100-DELETE-TNINREC.                                 02180040
021900                                                                  02190038
022000     PERFORM X100-CHECKPOINT-CHECK.                               02200038
022100                                                                  02210038
022200     PERFORM R100-READ-EXTRACT-FILE.                              02220038
022300     EJECT                                                        02230038
022400                                                                  02240038
022500                                                                  02250038
022600 B300-EOJ-PROCESSING.                                             02260038
022700                                                                  02270038
022800     DISPLAY '** AHKUP057 SUMMARY **'.                            02280044
022900     DISPLAY '** PO NUMBER INPUT COUNT = ' PV-TPAYREQ-INPUT-COUNT.02290047
023000     DISPLAY '** NINREC PO DELETE COUNT= '                        02300046
023100                                         PV-TNINREC-DELETE-COUNT. 02310046
023200     DISPLAY '** SQL DELETE COUNT      = ' PV-SQL-DELETE-COUNT.   02320046
023300                                                                  02330038
023400     CLOSE  TPAYREQ-EXTRACT-FILE.                                 02340047
023500                                                                  02350038
023600     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02360038
023700     PERFORM X600-UPDATE-TCKRSTCNTL.                              02370038
023800                                                                  02380038
023900     EJECT                                                        02390038
024000*----------------------------------------------------------------*02400038
024100*    DELETES FROM THE TNINREC TABLE.                             *02410040
024200*----------------------------------------------------------------*02420038
024300 D100-DELETE-TNINREC.                                             02430040
024400                                                                  02440038
024500     MOVE 'D100-DELETE-TNINREC' TO PV-CURRENT-PARAGRAPH.          02450040
024600                                                                  02460038
024700     PERFORM WITH TEST AFTER                                      02470038
024800        VARYING PC-RETRY-COUNT FROM 1 BY 1                        02480038
024900          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                     02490038
025000             OR SQLCODE = ZERO                                    02500038
025100             OR SQLCODE = +100                                    02510045
025200                                                                  02520038
025300         EXEC SQL                                                 02530038
025400              DELETE                                              02540038
025500                FROM TNINREC                                      02550040
025600               WHERE PO_NBR            = :NINREC-PO-NBR           02560040
025700         END-EXEC                                                 02570038
025800                                                                  02580038
025900         EVALUATE TRUE                                            02590038
026000             WHEN SQLCODE = ZERO                                  02600038
026100                 ADD 1 TO PV-TNINREC-DELETE-COUNT                 02610043
026200                 MOVE SQLERRD(3) TO PV-SQLERRD3                   02620039
026300                 ADD PV-SQLERRD3 TO PV-SQL-DELETE-COUNT           02630038
026400                                                                  02640038
026500             WHEN SQLCODE = +100                                  02650040
026600             WHEN SQLCODE = -904                                  02660038
026700             WHEN SQLCODE = -913                                  02670038
026800                  CONTINUE                                        02680038
026900                                                                  02690038
027000             WHEN SQLWARN0 NOT = SPACES                           02700038
027100             WHEN SQLCODE  NOT = ZERO                             02710038
027200                 MOVE PV-CURRENT-PARAGRAPH                        02720038
027300                                     TO AA-PARAGRAPH-NAME         02730038
027400                 DISPLAY '******** PO NUMBER:'                    02740038
027500                          PV-DISP-PO-NBR                          02750038
027600                 MOVE SPACES TO AA-MESSAGE-1                      02760038
027700                                AA-MESSAGE-2                      02770038
027800                 MOVE 'UNSUCCESSFUL DELETE'                       02780038
027900                                     TO AA-DB2-OPERATION          02790038
028000                 MOVE 'TNINREC'      TO AA-DB2-TABLE              02800040
028100                 PERFORM Z999-DB2-ABEND                           02810038
028200         END-EVALUATE                                             02820038
028300     END-PERFORM.                                                 02830038
028400                                                                  02840038
028500     IF PC-RETRY-COUNT > PC-RETRY-MAX                             02850038
028600         MOVE PV-CURRENT-PARAGRAPH                                02860038
028700                             TO AA-PARAGRAPH-NAME                 02870038
028800         DISPLAY '******** PO NUMBER :'                           02880038
028900                          PV-DISP-PO-NBR                          02890038
029000         MOVE SPACES TO AA-MESSAGE-1                              02900038
029100                        AA-MESSAGE-2                              02910038
029200         MOVE 'MAX RETRIES EXCEEDED ON DELETE'                    02920038
029300                             TO AA-DB2-OPERATION                  02930038
029400         MOVE 'TNINREC'      TO AA-DB2-TABLE                      02940040
029500         PERFORM Z999-DB2-ABEND                                   02950038
029600     END-IF.                                                      02960038
029700                                                                  02970038
029800     EJECT                                                        02980038
029900 R100-READ-EXTRACT-FILE.                                          02990038
030000                                                                  03000038
030100     READ TPAYREQ-EXTRACT-FILE                                    03010047
030200          INTO AH001-DRIVER-RECORD-LAYOUT                         03020043
030300          AT END SET END-OF-EXTRACT TO TRUE.                      03030038
030400                                                                  03040038
030500     IF MORE-EXTRACT                                              03050038
030600         ADD 1 TO PV-TPAYREQ-INPUT-COUNT                          03060047
030700     END-IF.                                                      03070038
030800                                                                  03080038
030900                                                                  03090038
031000     EJECT                                                        03100038
031100*----------------------------------------------------------------*03110038
031200*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03120038
031300*----------------------------------------------------------------*03130038
031400 X100-CHECKPOINT-CHECK.                                           03140038
031500                                                                  03150038
031600     MOVE 'X100-CHECKPOINT-CHECK' TO PV-CURRENT-PARAGRAPH.        03160038
031700                                                                  03170038
031800     EXEC SQL                                                     03180038
031900       SET :WS-TMST = CURRENT TIMESTAMP                           03190038
032000     END-EXEC.                                                    03200038
032100                                                                  03210038
032200     IF SQLCODE = +0                                              03220038
032300         CONTINUE                                                 03230038
032400     ELSE                                                         03240038
032500         MOVE PV-CURRENT-PARAGRAPH                                03250038
032600                             TO AA-PARAGRAPH-NAME                 03260038
032700         MOVE SPACES TO AA-MESSAGE-1                              03270038
032800                        AA-MESSAGE-2                              03280038
032900         MOVE 'BAD SET COMMAND'                                   03290038
033000                             TO AA-DB2-OPERATION                  03300038
033100         MOVE SPACES             TO AA-DB2-TABLE                  03310038
033200         PERFORM Z999-DB2-ABEND                                   03320038
033300     END-IF.                                                      03330038
033400                                                                  03340038
033500     IF WS-TMST > WS-HOLD-TMST                                    03350038
033600         IF NO-COMMITS-TAKEN                                      03360038
033700             MOVE PC-IN-PROCESS-CODE TO PV-CKPT-STAT-CODE         03370038
033800             PERFORM X600-UPDATE-TCKRSTCNTL                       03380038
033900             SET COMMITS-TAKEN TO TRUE                            03390038
034000         END-IF                                                   03400038
034100         PERFORM X700-UPDATE-TCKRSTINF                            03410038
034200         PERFORM Y100-COMMIT                                      03420038
034300         PERFORM X500-SET-CHECKPOINT-TIME                         03430038
034400     END-IF.                                                      03440038
034500                                                                  03450038
034600 EJECT                                                            03460038
034700*----------------------------------------------------------------*03470038
034800*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03480038
034900*----------------------------------------------------------------*03490038
035000 X200-CHECKPOINT-RESTART.                                         03500038
035100                                                                  03510038
035200     MOVE 'X200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.      03520038
035300                                                                  03530038
035400     PERFORM X400-GET-CHECKPOINT-INFO.                            03540038
035500     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     03550038
035600                                                                  03560038
035700     DISPLAY '** AHKUP057 CHECKPOINT RESTART **'                  03570044
035800     DISPLAY '** EXTRACT RECS BYPASSED ON RESTART = '             03580038
035900              CR-EXTRACT-RECS-WORKED.                             03590038
036000     DISPLAY '***********************************************'    03600038
036100                                                                  03610038
036200     PERFORM R100-READ-EXTRACT-FILE                               03620038
036300         CR-EXTRACT-RECS-WORKED TIMES.                            03630038
036400     PERFORM R100-READ-EXTRACT-FILE.                              03640038
036500 EJECT                                                            03650038
036600*----------------------------------------------------------------*03660038
036700*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *03670038
036800*----------------------------------------------------------------*03680038
036900 X300-GET-CHECKPOINT-CNTL.                                        03690038
037000                                                                  03700038
037100     MOVE 'X300-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     03710038
037200                                                                  03720038
037300     PERFORM WITH TEST AFTER                                      03730038
037400             VARYING PC-RETRY-COUNT FROM 1 BY 1                   03740038
037500             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             03750038
037600                     SQLCODE = ZERO                               03760038
037700                                                                  03770038
037800             EXEC SQL                                             03780038
037900              SELECT CKPT_STAT_CODE                               03790038
038000               INTO :PV-CKPT-STAT-CODE                            03800038
038100               FROM TCKRSTCNTL                                    03810038
038200               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 03820038
038300             END-EXEC                                             03830038
038400                                                                  03840038
038500             EVALUATE TRUE                                        03850038
038600                 WHEN SQLCODE = ZERO                              03860038
038700                 WHEN SQLCODE = -904                              03870038
038800                 WHEN SQLCODE = -913                              03880038
038900                      CONTINUE                                    03890038
039000                                                                  03900038
039100                 WHEN SQLWARN0 NOT = SPACES                       03910038
039200                 WHEN SQLCODE  NOT = ZERO                         03920038
039300                     MOVE PV-CURRENT-PARAGRAPH                    03930038
039400                                         TO AA-PARAGRAPH-NAME     03940038
039500                     DISPLAY '******** PLAN_NAME:'                03950038
039600                              PV-PROGRAM-NAME                     03960038
039700                     MOVE SPACES TO AA-MESSAGE-1                  03970038
039800                                    AA-MESSAGE-2                  03980038
039900                     MOVE 'UNSUCCESSFUL SELECT'                   03990038
040000                                         TO AA-DB2-OPERATION      04000038
040100                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          04010038
040200                     PERFORM Z999-DB2-ABEND                       04020038
040300             END-EVALUATE                                         04030038
040400     END-PERFORM.                                                 04040038
040500                                                                  04050038
040600     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04060038
040700         MOVE PV-CURRENT-PARAGRAPH                                04070038
040800                             TO AA-PARAGRAPH-NAME                 04080038
040900         DISPLAY '******** PLAN_NAME:'                            04090038
041000                  PV-PROGRAM-NAME                                 04100038
041100         MOVE SPACES TO AA-MESSAGE-1                              04110038
041200                        AA-MESSAGE-2                              04120038
041300         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    04130038
041400                             TO AA-DB2-OPERATION                  04140038
041500         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      04150038
041600         PERFORM Z999-DB2-ABEND                                   04160038
041700     END-IF.                                                      04170038
041800                                                                  04180038
041900 EJECT                                                            04190038
042000*----------------------------------------------------------------*04200038
042100*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *04210038
042200*----------------------------------------------------------------*04220038
042300 X400-GET-CHECKPOINT-INFO.                                        04230038
042400                                                                  04240038
042500     MOVE 'X400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     04250038
042600                                                                  04260038
042700     PERFORM WITH TEST AFTER                                      04270038
042800             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04280038
042900             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04290038
043000                     SQLCODE = ZERO                               04300038
043100                                                                  04310038
043200             EXEC SQL                                             04320038
043300              SELECT WORK_STRG_DESC                               04330038
043400               INTO :TCKRSTINF-WORK-STRG-DESC                     04340038
043500               FROM TCKRSTINF                                     04350038
043600               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04360038
043700             END-EXEC                                             04370038
043800                                                                  04380038
043900             EVALUATE TRUE                                        04390038
044000                 WHEN SQLCODE = ZERO                              04400038
044100                 WHEN SQLCODE = -904                              04410038
044200                 WHEN SQLCODE = -913                              04420038
044300                      CONTINUE                                    04430038
044400                                                                  04440038
044500                 WHEN SQLWARN0 NOT = SPACES                       04450038
044600                 WHEN SQLCODE  NOT = ZERO                         04460038
044700                     MOVE PV-CURRENT-PARAGRAPH                    04470038
044800                                         TO AA-PARAGRAPH-NAME     04480038
044900                     DISPLAY '******** PLAN_NAME:'                04490038
045000                              PV-PROGRAM-NAME                     04500038
045100                     MOVE SPACES TO AA-MESSAGE-1                  04510038
045200                                    AA-MESSAGE-2                  04520038
045300                     MOVE 'UNSUCCESSFUL SELECT'                   04530038
045400                                         TO AA-DB2-OPERATION      04540038
045500                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          04550038
045600                     PERFORM Z999-DB2-ABEND                       04560038
045700             END-EVALUATE                                         04570038
045800     END-PERFORM.                                                 04580038
045900                                                                  04590038
046000     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04600038
046100         MOVE PV-CURRENT-PARAGRAPH                                04610038
046200                             TO AA-PARAGRAPH-NAME                 04620038
046300         DISPLAY '******** PLAN_NAME:'                            04630038
046400                  PV-PROGRAM-NAME                                 04640038
046500         MOVE SPACES TO AA-MESSAGE-1                              04650038
046600                        AA-MESSAGE-2                              04660038
046700         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    04670038
046800                             TO AA-DB2-OPERATION                  04680038
046900         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      04690038
047000         PERFORM Z999-DB2-ABEND                                   04700038
047100     END-IF.                                                      04710038
047200                                                                  04720038
047300 EJECT                                                            04730038
047400*----------------------------------------------------------------*04740038
047500*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *04750038
047600*----------------------------------------------------------------*04760038
047700 X500-SET-CHECKPOINT-TIME.                                        04770038
047800                                                                  04780038
047900     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-CURRENT-PARAGRAPH.     04790038
048000                                                                  04800038
048100     PERFORM WITH TEST AFTER                                      04810038
048200             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04820038
048300             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04830038
048400                     SQLCODE = ZERO                               04840038
048500                                                                  04850038
048600             EXEC SQL                                             04860038
048700              SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)04870038
048800               INTO :WS-HOLD-TMST                                 04880038
048900               FROM TCKRSTCNTL                                    04890038
049000               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04900038
049100             END-EXEC                                             04910038
049200                                                                  04920038
049300             EVALUATE TRUE                                        04930038
049400                 WHEN SQLCODE = ZERO                              04940038
049500                 WHEN SQLCODE = -904                              04950038
049600                 WHEN SQLCODE = -913                              04960038
049700                      CONTINUE                                    04970038
049800                                                                  04980038
049900                 WHEN SQLWARN0 NOT = SPACES                       04990038
050000                 WHEN SQLCODE  NOT = ZERO                         05000038
050100                     MOVE PV-CURRENT-PARAGRAPH                    05010038
050200                                         TO AA-PARAGRAPH-NAME     05020038
050300                     DISPLAY '******** PLAN_NAME:'                05030038
050400                              PV-PROGRAM-NAME                     05040038
050500                     MOVE SPACES TO AA-MESSAGE-1                  05050038
050600                                    AA-MESSAGE-2                  05060038
050700                     MOVE 'UNSUCCESSFUL SELECT'                   05070038
050800                                         TO AA-DB2-OPERATION      05080038
050900                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05090038
051000                     PERFORM Z999-DB2-ABEND                       05100038
051100             END-EVALUATE                                         05110038
051200     END-PERFORM.                                                 05120038
051300                                                                  05130038
051400     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05140038
051500         MOVE PV-CURRENT-PARAGRAPH                                05150038
051600                             TO AA-PARAGRAPH-NAME                 05160038
051700         DISPLAY '******** PLAN_NAME:'                            05170038
051800                  PV-PROGRAM-NAME                                 05180038
051900         MOVE SPACES TO AA-MESSAGE-1                              05190038
052000                        AA-MESSAGE-2                              05200038
052100         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05210038
052200                             TO AA-DB2-OPERATION                  05220038
052300         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05230038
052400         PERFORM Z999-DB2-ABEND                                   05240038
052500     END-IF.                                                      05250038
052600                                                                  05260038
052700 EJECT                                                            05270038
052800*----------------------------------------------------------------*05280038
052900*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *05290038
053000*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *05300038
053100*----------------------------------------------------------------*05310038
053200 X600-UPDATE-TCKRSTCNTL.                                          05320038
053300                                                                  05330038
053400     MOVE 'X600-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       05340038
053500                                                                  05350038
053600     PERFORM WITH TEST AFTER                                      05360038
053700             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05370038
053800             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05380038
053900                     SQLCODE = ZERO                               05390038
054000                                                                  05400038
054100             EXEC SQL                                             05410038
054200                 UPDATE TCKRSTCNTL                                05420038
054300                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          05430038
054400                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          05440038
054500             END-EXEC                                             05450038
054600                                                                  05460038
054700             EVALUATE TRUE                                        05470038
054800                 WHEN SQLCODE = ZERO                              05480038
054900                 WHEN SQLCODE = -904                              05490038
055000                 WHEN SQLCODE = -913                              05500038
055100                      CONTINUE                                    05510038
055200                                                                  05520038
055300                 WHEN SQLWARN0 NOT = SPACES                       05530038
055400                 WHEN SQLCODE  NOT = ZERO                         05540038
055500                     MOVE PV-CURRENT-PARAGRAPH                    05550038
055600                                         TO AA-PARAGRAPH-NAME     05560038
055700                     DISPLAY '******** PLAN_NAME:'                05570038
055800                              PV-PROGRAM-NAME                     05580038
055900                     MOVE SPACES TO AA-MESSAGE-1                  05590038
056000                                    AA-MESSAGE-2                  05600038
056100                     MOVE 'UNSUCCESSFUL UPDATE'                   05610038
056200                                         TO AA-DB2-OPERATION      05620038
056300                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05630038
056400                     PERFORM Z999-DB2-ABEND                       05640038
056500             END-EVALUATE                                         05650038
056600     END-PERFORM.                                                 05660038
056700                                                                  05670038
056800     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05680038
056900         MOVE PV-CURRENT-PARAGRAPH                                05690038
057000                             TO AA-PARAGRAPH-NAME                 05700038
057100         DISPLAY '******** PLAN_NAME:'                            05710038
057200                  PV-PROGRAM-NAME                                 05720038
057300         MOVE SPACES TO AA-MESSAGE-1                              05730038
057400                        AA-MESSAGE-2                              05740038
057500         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    05750038
057600                             TO AA-DB2-OPERATION                  05760038
057700         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05770038
057800         PERFORM Z999-DB2-ABEND                                   05780038
057900     END-IF.                                                      05790038
058000                                                                  05800038
058100     EJECT                                                        05810038
058200*----------------------------------------------------------------*05820038
058300*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *05830038
058400*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *05840038
058500*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *05850038
058600*----------------------------------------------------------------*05860038
058700 X700-UPDATE-TCKRSTINF.                                           05870038
058800                                                                  05880038
058900     MOVE 'X700-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        05890038
059000                                                                  05900038
059100     MOVE PV-TPAYREQ-INPUT-COUNT TO CR-EXTRACT-RECS-WORKED.       05910047
059200     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   05920038
059300     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    05930038
059400                                                                  05940038
059500     PERFORM WITH TEST AFTER                                      05950038
059600             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05960038
059700             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05970038
059800                     SQLCODE = ZERO                               05980038
059900                                                                  05990038
060000             EXEC SQL                                             06000038
060100                 UPDATE TCKRSTINF                                 06010038
060200                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 06020038
060300                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06030038
060400             END-EXEC                                             06040038
060500                                                                  06050038
060600             EVALUATE TRUE                                        06060038
060700                 WHEN SQLCODE = ZERO                              06070038
060800                 WHEN SQLCODE = -904                              06080038
060900                 WHEN SQLCODE = -913                              06090038
061000                      CONTINUE                                    06100038
061100                                                                  06110038
061200                 WHEN SQLWARN0 NOT = SPACES                       06120038
061300                 WHEN SQLCODE  NOT = ZERO                         06130038
061400                     MOVE PV-CURRENT-PARAGRAPH                    06140038
061500                                         TO AA-PARAGRAPH-NAME     06150038
061600                     DISPLAY '******** PLAN_NAME:'                06160038
061700                              PV-PROGRAM-NAME                     06170038
061800                     MOVE SPACES TO AA-MESSAGE-1                  06180038
061900                                    AA-MESSAGE-2                  06190038
062000                     MOVE 'UNSUCCESSFUL UPDATE'                   06200038
062100                                         TO AA-DB2-OPERATION      06210038
062200                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          06220038
062300                     PERFORM Z999-DB2-ABEND                       06230038
062400             END-EVALUATE                                         06240038
062500     END-PERFORM.                                                 06250038
062600                                                                  06260038
062700     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06270038
062800         MOVE PV-CURRENT-PARAGRAPH                                06280038
062900                             TO AA-PARAGRAPH-NAME                 06290038
063000         DISPLAY '******** PLAN_NAME:'                            06300038
063100                  PV-PROGRAM-NAME                                 06310038
063200         MOVE SPACES TO AA-MESSAGE-1                              06320038
063300                        AA-MESSAGE-2                              06330038
063400         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06340038
063500                             TO AA-DB2-OPERATION                  06350038
063600         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      06360038
063700         PERFORM Z999-DB2-ABEND                                   06370038
063800     END-IF.                                                      06380038
063900                                                                  06390038
064000 EJECT                                                            06400038
064100                                                                  06410038
064200*----------------------------------------------------------------*06420038
064300*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *06430038
064400*----------------------------------------------------------------*06440038
064500 Y100-COMMIT.                                                     06450038
064600                                                                  06460038
064700     MOVE 'Y100-COMMIT'    TO PV-CURRENT-PARAGRAPH.               06470038
064800                                                                  06480038
064900     EXEC SQL                                                     06490038
065000         COMMIT                                                   06500038
065100     END-EXEC.                                                    06510038
065200                                                                  06520038
065300     EVALUATE TRUE                                                06530038
065400         WHEN SQLCODE = ZEROS                                     06540038
065500             CONTINUE                                             06550038
065600         WHEN OTHER                                               06560038
065700             MOVE PV-CURRENT-PARAGRAPH                            06570038
065800                                 TO AA-PARAGRAPH-NAME             06580038
065900             MOVE SPACES TO AA-MESSAGE-1                          06590038
066000                            AA-MESSAGE-2                          06600038
066100             MOVE 'UNSUCCESSFUL COMMIT'                           06610038
066200                                 TO AA-DB2-OPERATION              06620038
066300             MOVE SPACES         TO AA-DB2-TABLE                  06630038
066400             PERFORM Z999-DB2-ABEND                               06640038
066500     END-EVALUATE.                                                06650038
066600 EJECT                                                            06660038
066700 Z900-PROCESS-ABEND.                                              06670038
066800                                                                  06680038
066900     DISPLAY '*** ABEND'.                                         06690038
067000     DISPLAY '*** PROGRAM   = AHKUP057'.                          06700044
067100     DISPLAY '*** PARAGRAPH = ' PV-CURRENT-PARAGRAPH.             06710038
067200     DISPLAY AA-MESSAGE-LINE-1.                                   06720038
067300     DISPLAY AA-MESSAGE-LINE-2.                                   06730038
067400     COPY DPPD004.                                                06740038
067500     CALL 'ILBOABN0' USING ABEND-CODE.                            06750038
067600                                                                  06760038
067700                                                                  06770038
067800                                                                  06780038
067900 Z999-DB2-ABEND.                                                  06790038
068000                                                                  06800038
068100     DISPLAY AA-ABEND-LIT.                                        06810038
068200     DISPLAY AA-DB2-ERROR-LIT.                                    06820038
068300     DISPLAY AA-PROGRAM-LIT.                                      06830038
068400     DISPLAY AA-PARAGRAPH-LIT.                                    06840038
068500     DISPLAY AA-DB2-OPERATION-LIT.                                06850038
068600     DISPLAY AA-DB2-TABLE.                                        06860038
068700     SET AC-DB2-ERROR TO TRUE.                                    06870038
068800                                                                  06880038
068900     COPY DPPD004.                                                06890038
069000                                                                  06900038
069100     CALL 'ILBOABN0' USING ABEND-CODE.                            06910038
