000100 TITLE 'INSERT CL ADJUSTMENTS INTO IN-TRANSIT TABLES'.                    
000200 IDENTIFICATION DIVISION.                                                 
000300 PROGRAM-ID.    PCKUP015.                                                 
000400 AUTHOR.        DENNIS STEFFEN.                                           
000500 DATE-WRITTEN.  APRIL, 2005.                                              
000600                                                                          
000700                                                                          
000800 ENVIRONMENT DIVISION.                                                    
000900 INPUT-OUTPUT SECTION.                                                    
001000 FILE-CONTROL.                                                            
001100     SELECT STORE-EXPECTED-EXTRACT-FILE                                   
001200         ASSIGN TO INP01.                                                 
001300                                                                          
001400 DATA DIVISION.                                                           
001500 FILE SECTION.                                                            
001600                                                                          
001700 FD  STORE-EXPECTED-EXTRACT-FILE                                          
001800     RECORDING MODE IS F                                                  
001900     LABEL RECORDS ARE STANDARD                                           
002000     BLOCK CONTAINS 0 RECORDS.                                            
002100                                                                          
002200 01  STORE-EXPECTED-RECORD               PIC  X(35).                      
002300                                                                          
002400/                                                                         
002500 WORKING-STORAGE SECTION.                                                 
002600                                                                          
002700 01  PS-PROGRAM-SWITCHES.                                                 
002800     05  PS-END-OF-FILE-SW               PIC  X(01)  VALUE 'N'.           
002900         88  PS-END-OF-FILE-YES                      VALUE 'Y'.           
003000 01  ABEND-CODE                          PIC S9(04)  VALUE ZERO           
003100                                                     COMP SYNC.           
003200 01  PV-PROGRAM-VARIABLES.                                                
003300     05  PV-ABEND-PARAGRAPH              PIC  X(30)  VALUE SPACE.         
003400     05  PV-DB2-OPERATION-ATTEMPTED      PIC  X(30)  VALUE SPACE.         
003500                                                                          
003600     05  PV-CKPT-JOB-NAME             PIC X(08) VALUE SPACES.     00720004
003700     05 PV-COMMIT-COUNTER             PIC S9(05) COMP-3                   
003800                                                 VALUE ZERO.              
003900                                                                          
004000     05 PV-NUMBER-OF-COMMITS          PIC S9(09) COMP-3                   
004100                                                 VALUE ZERO.              
004200                                                                          
004300     05 PV-TRAN-INSERT-COUNTER        PIC S9(09) COMP-3                   
004400                                              VALUE ZERO.                 
004500     05 PV-TRAN-DUP-IN-COUNTER        PIC S9(09) COMP-3                   
004600                                              VALUE ZERO.                 
004700     05 PV-READ-COUNTER               PIC S9(09) COMP-3                   
004800                                              VALUE ZERO.                 
004900     05 PV-DISP-NBR                   PIC ZZZ,ZZZ,ZZ9.                    
005000                                                                          
005100     05 PV-QTY-UPDATE-COUNTER         PIC S9(09) COMP-3                   
005200                                              VALUE ZERO.                 
005300     05 PV-QTY-INSERT-COUNTER         PIC S9(09) COMP-3                   
005400                                              VALUE ZERO.                 
005500     05 PV-TRAN-DELETE-COUNTER        PIC S9(09) COMP-3                   
005600                                              VALUE ZERO.                 
005700     05  PV-SQL-CODE                  PIC  9(04) VALUE ZERO.              
005800                                                                          
005900 01  PV-DISP-KEY-MSG.                                                     
006000     05  PV-DISP-LABEL                PIC X(08) VALUE SPACES.             
006100     05  FILLER                       PIC X(02) VALUE SPACES.             
006200     05  FILLER                      PIC X(14) VALUE                      
006300         'INTR-UPC-ID = '.                                                
006400     05  PV-KEY-INTR-UPC-ID          PIC 9(10) VALUE ZEROES.              
006500                                                                          
006600     05  FILLER                      PIC X(12) VALUE                      
006700         '; LOC-NBR = '.                                                  
006800     05  PV-KEY-LOC-NBR              PIC 9(04) VALUE ZEROES.              
006900     05  FILLER                      PIC X(13) VALUE                      
007000         '; CLSN-CDE = '.                                                 
007100     05  PV-KEY-CLSN-CDE             PIC X(02) VALUE ZEROES.              
007200     05  FILLER                      PIC X(12) VALUE                      
007300         '; BAL QTY = '.                                                  
007400     05  PV-KEY-BAL-QTY              PIC 9(06) VALUE ZEROES.              
007500                                                                          
007600 01  PV-REFORMAT-UPC.                                                     
007700     10  PV-DETAIL-INNER-UPC          PIC S9(10)  VALUE ZEROES            
007800                                                      COMP.               
007900     10  FILLER REDEFINES PV-DETAIL-INNER-UPC.                            
008000         15  FILLER                   PIC X(04).                          
008100         15  PV-DET-UPC-ID-4          PIC X(04).                          
008200         15  PV-DET-UPC-SPC REDEFINES PV-DET-UPC-ID-4                     
008300                                      PIC S9(9) COMP.                     
008400                                                                          
008500 01  PC-PROGRAM-CONSTANTS.                                                
008600     05  PC-CKPT-PLAN-NAME            PIC X(08) VALUE 'PCKUP015'. 00730004
008700     05  PC-CURRENT-PROGRAM-NAME      PIC X(08)  VALUE                    
008800         'PCKUP015'.                                                      
008900     05  PC-OPEN-FUNC                PIC X(05)     VALUE 'OPEN '. 00680004
009000     05  PC-TRANS-FUNC               PIC X(05)     VALUE 'TRANS'. 00690004
009100     05  PC-CLOSE-FUNC               PIC X(05)     VALUE 'CLOSE'. 00700004
009200     05  PC-RSTRT-FUNC               PIC X(05)     VALUE 'RSTRT'. 00710004
009300                                                                          
009400* TRANSACTION PRESENTATION MODULE PARAMETERS                      01460004
260107     COPY DPWS991.                                                01470004
009500                                                                          
009500     COPY DPLS001.                                                01470004
009600         05  WORK-STRG-AREA          PIC X(150).                  01480004
009700                                                                  01490004
009800*    CLEANUP RECORDS                                                      
009900     COPY PCRD041.                                                        
010000                                                                          
010100* IN-TRANSIT BALANCE TABLE                                                
010200*                                                                         
010300     EXEC SQL                                                             
010400          INCLUDE PCT00014                                                
010500     END-EXEC.                                                            
010600                                                                          
010700*  IN-TRANSIT DETAIL TABLE                                                
010800*                                                                         
010900     EXEC SQL                                                             
011000          INCLUDE PCT00015                                                
011100     END-EXEC.                                                            
011200                                                                          
011300     COPY DPWS004.                                                        
011400                                                                          
011500     EXEC SQL                                                             
011600         INCLUDE SQLCA                                                    
011700     END-EXEC.                                                            
011800     COPY SQLCA2.                                                 01850004
011900/                                                                         
012000 PROCEDURE DIVISION.                                                      
012100                                                                          
012200     PERFORM 1000-INITIALIZE.                                             
012300                                                                          
012400     PERFORM 2000-PROCESS                                                 
012500             UNTIL PS-END-OF-FILE-YES                                     
012600                                                                          
012700     PERFORM 9000-QUIT.                                                   
012800                                                                          
012900     GOBACK.                                                              
013000                                                                          
013100 1000-INITIALIZE.                                                         
013200                                                                          
013300     MOVE ZERO                        TO PV-COMMIT-COUNTER                
013400                                         PV-NUMBER-OF-COMMITS             
013500                                                                          
013600     ACCEPT PV-CKPT-JOB-NAME FROM SYSIN.                          02080004
013700     MOVE PC-OPEN-FUNC           TO DP001-FUNC-CODE.              02090004
013800                                                                  02100004
013900     PERFORM 8000-READ-EXTRACT-FILE.                                      
014000                                                                  02120004
014100     MOVE PC-TRANS-FUNC          TO DP001-FUNC-CODE.              02130004
014200                                                                  02140004
014300     IF PS-END-OF-FILE-YES                                                
014400         DISPLAY ' INP01 FILE IS EMPTY'                                   
014500     END-IF.                                                              
014600                                                                          
014700 2000-PROCESS.                                                            
014800                                                                          
014900     PERFORM 2100-LOAD-INSERT-DATA                                        
015000                                                                          
015100     PERFORM 7000-GET-HDR-BAL-QTY                                         
015200     IF SQLCODE = ZERO                                                    
015300*        MOVE ' BEFORE'               TO PV-DISP-LABEL                    
015400*        MOVE PCT00014-TRN-CLSN-QTY   TO PV-KEY-BAL-QTY                   
015500*        DISPLAY PV-DISP-KEY-MSG                                          
015600                                                                          
015700         COMPUTE                                                          
015800             PCT00014-TRN-CLSN-QTY = PCT00014-TRN-CLSN-QTY                
015900                                   + PC041-TRN-CLSN-QTY                   
016000         END-COMPUTE                                                      
016100                                                                          
016200*        MOVE '  AFTER'               TO PV-DISP-LABEL                    
016300*        MOVE PCT00014-TRN-CLSN-QTY   TO PV-KEY-BAL-QTY                   
016400*        DISPLAY PV-DISP-KEY-MSG                                          
016500                                                                          
016600         PERFORM 7100-UPDATE-INTRANSIT-HEADER                             
016700         PERFORM 7200-INSERT-INTRANSIT-DTL                                
016800     END-IF                                                               
016900                                                                          
017000     PERFORM 8000-READ-EXTRACT-FILE.                                      
017100                                                                          
017200 2100-LOAD-INSERT-DATA.                                                   
017300     MOVE PC041-INTR-UPC-ID           TO PCT00015-INTR-UPC-ID             
017400                                         PCT00014-INTR-UPC-ID             
017500                                         PV-DETAIL-INNER-UPC              
017600     MOVE PV-DET-UPC-SPC              TO PV-KEY-INTR-UPC-ID               
017700                                                                          
017800     MOVE PC041-LOC-NBR               TO PCT00015-LOC-NBR                 
017900                                         PCT00014-LOC-NBR                 
018000                                         PV-KEY-LOC-NBR                   
018100     MOVE 'SE'                        TO PCT00015-TRN-CLSN-CDE            
018200                                         PCT00014-TRN-CLSN-CDE            
018300     MOVE 'CL'                        TO PCT00015-TRN-TYP-CDE             
018400                                                                          
018500     MOVE PC041-TRN-CLSN-QTY          TO                                  
018600                                     PCT00015-TRN-CLSN-PRCG-QTY           
018700                                                                          
018800     MOVE PC041-PO-NBR                TO PCT00015-PO-NBR                  
018900     MOVE PC041-RCVR-SEQ-NBR          TO PCT00015-RCVR-SEQ-NBR.           
019000                                                                          
019100 7000-GET-HDR-BAL-QTY.                                                    
019200     MOVE '7000-GET-HDR-BAL-QTY'      TO PV-ABEND-PARAGRAPH.              
019300                                                                          
019400                                                                          
019500     EXEC SQL                                                             
019600         SELECT TRN_CLSN_QTY                                              
019700         INTO :PCT00014-TRN-CLSN-QTY                                      
019800         FROM   PCT_TRN_CLSN_BAL                                          
019900         WHERE                                                            
020000               INTR_UPC_ID  = :PCT00014-INTR-UPC-ID                       
020100           AND LOC_NBR      = :PCT00014-LOC-NBR                           
020200           AND TRN_CLSN_CDE = 'SE'                                        
020300     END-EXEC                                                             
020400                                                                          
020500     EVALUATE TRUE                                                        
020600         WHEN SQLCODE = ZERO                                              
020700             CONTINUE                                                     
020800         WHEN SQLCODE = +100                                              
020900             DISPLAY 'HEADER ROW NOT FOUND FOR UPDATE'                    
021000             DISPLAY PV-DISP-KEY-MSG                                      
021100*            PERFORM 9100-SQL-ABEND                                       
021200         WHEN SQLCODE = -904                                              
021300         WHEN SQLCODE = -911                                              
021400         WHEN SQLCODE = -913                                              
021500              CONTINUE                                                    
021600                                                                          
021700         WHEN SQLCODE < ZERO                                              
021800             DISPLAY '**************************************'             
021900             DISPLAY 'ERROR ISSUED ON                       '             
022000             DISPLAY 'UPDATE PCT_TRN_CLSN_BAL               '             
022100             DISPLAY PV-DISP-KEY-MSG                                      
022200             DISPLAY '**************************************'             
022300             PERFORM 9100-SQL-ABEND                                       
022400                                                                          
022500     END-EVALUATE.                                                        
022600                                                                          
022700 7100-UPDATE-INTRANSIT-HEADER.                                            
022800     MOVE '7100-UPDATE-INTRANSIT-HEADER' TO PV-ABEND-PARAGRAPH.           
022900                                                                          
023000     EXEC SQL                                                             
023100         UPDATE PCT_TRN_CLSN_BAL                                          
023200         SET TRN_CLSN_QTY   = :PCT00014-TRN-CLSN-QTY                      
023300           , LAST_UPD_DTE   = CURRENT DATE                                
023400         WHERE                                                            
023500               INTR_UPC_ID  = :PCT00014-INTR-UPC-ID                       
023600           AND LOC_NBR      = :PCT00014-LOC-NBR                           
023700           AND TRN_CLSN_CDE = 'SE'                                        
023800     END-EXEC                                                             
023900                                                                          
024000     EVALUATE TRUE                                                        
024100         WHEN SQLCODE = ZERO                                              
024200             ADD +1                   TO PV-QTY-UPDATE-COUNTER            
024300         WHEN SQLCODE = +100                                              
024400             DISPLAY 'HEADER ROW NOT FOUND FOR UPDATE'                    
024500             DISPLAY PV-DISP-KEY-MSG                                      
024600*            PERFORM 9100-SQL-ABEND                                       
024700         WHEN SQLCODE = -904                                              
024800         WHEN SQLCODE = -911                                              
024900         WHEN SQLCODE = -913                                              
025000              CONTINUE                                                    
025100                                                                          
025200         WHEN SQLCODE < ZERO                                              
025300             DISPLAY '**************************************'             
025400             DISPLAY 'ERROR ISSUED ON                       '             
025500             DISPLAY 'UPDATE PCT_TRN_CLSN_BAL               '             
025600             DISPLAY PV-DISP-KEY-MSG                                      
025700             DISPLAY '**************************************'             
025800             PERFORM 9100-SQL-ABEND                                       
025900                                                                          
026000     END-EVALUATE.                                                        
026100                                                                          
026200 7200-INSERT-INTRANSIT-DTL.                                               
026300                                                                          
026400      MOVE '7200-INSERT-INTRANSIT-DTL ' TO PV-ABEND-PARAGRAPH.            
026500                                                                          
026600      EXEC SQL                                                            
026700          INSERT INTO PCT_TRN_CLSN_DTL                                    
026800        (                                                                 
026900          INTR_UPC_ID                                                     
027000         ,LOC_NBR                                                         
027100         ,TRN_CLSN_CDE                                                    
027200         ,IN_TRNST_TRN_TMST                                               
027300         ,TRN_TYP_CDE                                                     
027400         ,TRN_CLSN_PRCG_QTY                                               
027500         ,TRN_CLSN_BAL_QTY                                                
027600         ,UPD_USR_ID                                                      
027700         ,OTBND_TRIP_ID                                                   
027800         ,PO_NBR                                                          
027900         ,RCVR_SEQ_NBR                                                    
028000        )                                                                 
028100          VALUES                                                          
028200        (                                                                 
028300          :PCT00015-INTR-UPC-ID                                           
028400        , :PCT00015-LOC-NBR                                               
028500        , 'SE'                                                            
028600        , CURRENT TIMESTAMP                                               
028700        , 'CL'                                                            
028800        , :PCT00015-TRN-CLSN-PRCG-QTY                                     
028900        , :PCT00014-TRN-CLSN-QTY                                          
029000        , 'PCKUP015'                                                      
029100        , NULL                                                            
029200        , :PCT00015-PO-NBR                                                
029300        , :PCT00015-RCVR-SEQ-NBR                                          
029400        )                                                                 
029500     END-EXEC                                                             
029600                                                                          
029700     EVALUATE TRUE                                                        
029800         WHEN SQLCODE = ZERO                                              
029900             ADD +1                   TO PV-TRAN-INSERT-COUNTER           
030000         WHEN SQLCODE = -803                                              
030100             ADD +1                   TO PV-TRAN-DUP-IN-COUNTER           
030200             MOVE PV-READ-COUNTER     TO PV-DISP-NBR                      
030300             DISPLAY 'DUP REC INPUT NUMBER ' PV-DISP-NBR                  
030400         WHEN SQLCODE = -904                                              
030500         WHEN SQLCODE = -911                                              
030600         WHEN SQLCODE = -913                                              
030700             CONTINUE                                                     
030800                                                                          
030900         WHEN SQLCODE < ZERO                                              
031000             DISPLAY '**************************************'             
031100             DISPLAY 'ERROR ISSUED'                                       
031200             DISPLAY 'INSERT PCT_TRN_CLSN_DTL               '             
031300             DISPLAY PV-DISP-KEY-MSG                                      
031400             DISPLAY '**************************************'             
031500             PERFORM 9100-SQL-ABEND                                       
031600     END-EVALUATE.                                                        
031700/                                                                         
031800 8000-READ-EXTRACT-FILE.                                                  
031900     MOVE LENGTH OF PC041-UNBAL-SUMMARY-REC                       06720004
032000                                     TO DP001-WORK-STRG-LENGTH.   06730004
032100     MOVE PV-CKPT-JOB-NAME           TO DP001-JOB-NAME.           06740004
032200     MOVE PC-CKPT-PLAN-NAME          TO DP001-PLAN-NAME.          06750004
032300                                                                  06760004
032400     PERFORM Z900-CALL-TRANS-PRES-MODULE.                         06770004
032500                                                                  06780004
032600     MOVE DP001-TRANS-RECORD  TO PC041-UNBAL-SUMMARY-REC          06790004
032700                                                                  06950004
032800     IF DP001-PREP-TRANS-EOF                                      06960004
032900         SET PS-END-OF-FILE-YES       TO TRUE                     06970004
033000     ELSE                                                         06980004
033100         ADD 1                        TO PV-READ-COUNTER          06990004
033200     END-IF.                                                      07000004
033300/                                                                         
033400 9000-QUIT.                                                               
033500                                                                          
033600*    CLOSE STORE-EXPECTED-EXTRACT-FILE.                                   
033700     MOVE PC-CLOSE-FUNC               TO DP001-FUNC-CODE.         07030004
033800     PERFORM 8000-READ-EXTRACT-FILE.                              07040004
033900                                                                          
034000     MOVE PV-READ-COUNTER             TO PV-DISP-NBR                      
034100     DISPLAY 'RECORDS READ               = ' PV-DISP-NBR                  
034200                                                                          
034300     MOVE PV-QTY-UPDATE-COUNTER       TO PV-DISP-NBR                      
034400     DISPLAY 'PCT_TRN_CLSN_BAL UPDATES   = '  PV-DISP-NBR                 
034500                                                                          
034600     MOVE PV-TRAN-INSERT-COUNTER      TO PV-DISP-NBR                      
034700     DISPLAY 'PCT_TRN_CLSN_DTL INSERTS   = '  PV-DISP-NBR.                
034800                                                                          
034900     MOVE PV-NUMBER-OF-COMMITS        TO PV-DISP-NBR                      
035000     DISPLAY 'NUMBER OF COMMITS TAKEN    = '  PV-DISP-NBR.                
035100/                                                                         
035200 9100-SQL-ABEND.                                                          
035300******************************************************************        
035400*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL            
035500*  ERROR OR WARNING CODE OCCURS.                                          
035600******************************************************************        
035700     DISPLAY '9100-SQL-ABEND'.                                            
035800     DISPLAY '** ABEND     **'.                                           
035900     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.                
036000     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.                     
036100     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.             
036200     DISPLAY '** INTR-UPC-ID  = ' PV-KEY-INTR-UPC-ID                      
036300     DISPLAY '** LOC-NBR      ** = ' PV-KEY-LOC-NBR                       
036400     DISPLAY '** TRIP-ID      ** = ' PCT00015-OTBND-TRIP-ID               
036500     DISPLAY '**              ** = '                                      
036600     MOVE SQLCODE TO PV-SQL-CODE.                                         
036700     DISPLAY '** SQL CODE  ** = ' PV-SQL-CODE.                            
036800     MOVE +4013 TO ABEND-CODE.                                            
036900     CALL 'ILBOABN0' USING ABEND-CODE.                                    
037000/                                                                 07740004
037100*    PRESENTATION MODULE (CHECKPOINT RESTART)                             
037200     COPY DPPD001.                                                07750004
