000100******************************************************************00010049
000200*              SVPD005 - KMC AUTHORIZATION PROCEDURE             *00020049
000300*                                                                *00030049
000400*   THIS PROCEDURE DIVISION WILL BE USED WITH SVWS005 TO CHECK/  *00040049
000500*   AUTHORIZE THE POS TRANSACTIONS OR MANUAL REFERRALS BEING     *00050049
000600*   SENT TO IT AND THEN RETURN A RESPONSE BACK.  VALID RESPONSES *00060049
000700*   ARE:                                                         *00070049
000800*           0 = APPROVE  6 = INVALID PIN  7= HARD DECLINE        *00080049
000900*           8 = REFERRAL 9 = THIS PROCEDURE ABENDED              *00090049
001000*                                                                *00100049
001100*   THE PROGRAMS WHICH USE THIS PROCEDURE MUST SUPPLY THE        *00110049
001200*   FOLLOWING:                                                   *00120049
001300*   1)  MOVE KMC CARD NUMBER           TO SV005-KMC-ID.          *00130049
001400*   2)  MOVE ACTIVITY TYPE             TO SV005-ACTIVITY-TYPE.   *00140049
001500*   3)  MOVE NORMAL/REVERSAL INDICATOR TO SV005-REVERSAL-CODE.   *00150049
001600*   4)  MOVE POS DATE                  TO SV005-POS-DATE.        *00160049
001700*   5)  MOVE STORE NUMBER              TO SV005-STORE-NBR.       *00170049
001800*   6)  MOVE TERMINAL NUMBER           TO SV005-TERMINAL-NBR.    *00180049
001900*   7)  MOVE TRANSACTION NUMBER        TO SV005-TRANSACTION-NBR. *00190049
002000*   8)  MOVE TRANSACTION AMOUNT        TO SV005-TRANS-AMT.       *00200049
002100*   9)  THE PROGRAM MUST INCLUDE THE DCLGENS FOR THE FOLLOWING   *00210049
002200*       TABLES:                                                  *00220049
002300*                SVT_KOHLS_CRD_ACCT                              *00230049
002400*                SVT_KOHLS_CRD_TXN                               *00240049
002500*  10)  THE PROGRAM MUST INCLUDE THE FOLLOWING COPYBOOKS/        *00250049
002600*       WORKING STORAGE AREAS:                                   *00260049
002700*                SVWS005  - (FOR THIS AUTHORIZATION PROCEDURE)   *00270049
002800*                SVWS006  - (FOR KMC APPROVAL NUMBER PROCEDURE)  *00280049
208819*                DPWS036  - (FOR CHECK DIGIT ROUTINE)            *00290063
003000*                                                                *00300049
003100*  11) PIN CHECK- IF PIN NUMBER IS TO BE CHECKED, IT MUST BE     *00310049
003200*         SENT IN FIELD SV005-PIN, AND SV005-E-BUS-LOC-IND MUST  *00320049
003300*         BE FILLED IN WITH 'Y' OR 'N'.                          *00330049
003400*         PIN IS REQUIRED FOR ECOMM TENDERS, OPTIONAL FOR BALANCE*00340049
003500*         INQUIRY AND POS TRANSACTIONS.                          *00350049
003600*         CURRENTLY, PIN CHECK IS ONLY ALLOWED FROM AUKCS502.    *00360049
003700*         IF ADDING TO ANOTHER PROGRAM, SEND '-1' IN SV005-PIN   *00370049
003800*         WHEN NOT CHECKING PIN.                                 *00380049
003900*                                                                *00390049
004000*   THIS PROCEDURE WILL POPULATE THE FOLLOWING FIELDS:           *00400049
004100*   1)  SV005-DUPLICATE-FLAG                                     *00410049
004200*   2)  SV005-RESPONSE-CODE                                      *00420049
004300*   3)  SV005-APPROVED-TENDER-AMT                                *00430049
004400*   4)  SV005-KMC-REMAINING-BALANCE                              *00440049
004500*   5)  SV005-KMC-ORIGINAL-BALANCE                               *00450049
004600*   6)  SV005-KMC-APPROVAL-NBR --> CALCULATED BY SVPD006         *00460049
004700*   7)  SV005-REVERSAL-AMT                                       *00470049
004800*   8)  SV005-MESSAGE-1  ---- \                                  *00480049
004900*   9)  SV005-MESSAGE-2  ---- /    ABEND MESSAGES                *00490049
005000*                                                                *00500049
005100******************************************************************00510049
005200*   AJR - 07/09/96 - IF THE CARD INQUIRED UPON HAS A BALANCE <=0 *00520049
005300*                    SEND BACK A REFERRAL WITH A ZERO REMAINING  *00530049
005400*                    BALANCE AND APPROVED TENDER AMOUNT          *00540049
005500* (UPDATED 7/15/03 BY BRAD GROCHOWSKI)                           *00550049
005600* NOTE: BALANCE INQUIRIES RETURNING BALANCE OF ZERO              *00560049
005700* WILL GIVE "APPROVE" RESPONSE TO AUKCS502, BUT                  *00570049
005800* "REFERRAL" TO ANY OTHER CALLING PROGRAM.                       *00580049
005900******************************************************************00590049
006000*   CLM - 03/10/97 - MODIFIED PROGRAM TO ACCOMODATE KMRC CASH    *00600049
006100*                    BACK IN AN APPROVAL SITUATION:              *00610049
006200*                  - IF COMING FROM RDKCS023 NO CASH BACK WILL   *00620049
006300*                    BE ISSUED.  LOGIC TO ISSUE A REFERRAL       *00630049
006400*                    REMAINED THE SAME                           *00640049
006500*                  - IF COMING FROM RDKCS080, RETRIEVED THE      *00650049
006600*                    CASH BACK PARAMETER FROM THE REFAUTHQ.      *00660049
006700*                    ADDITIONAL CHECKS WERE ADDED TO DETERMINE   *00670049
006800*                    IF CASH BACK WOULD BE ISSUED.               *00680049
006900******************************************************************00690049
007000*   CLM - 04/17/97 - MODIFIED PROGRAM TO ACCOMODATE KMRC CASH    *00700049
007100*                    BACK DURING MANUAL REFERRAL SITUATION:      *00710049
007200*                  - IF COMING FROM RDKCS023-AUDIT FUNCTION      *00720049
007300*                    CASH BACK MAY NOT BE ISSUED                 *00730049
007400*                  - IF COMING FROM RDKCS023-AUTHORIZATION       *00740049
007500*                    FUNCTION, AND THE REGISTER RELEASE IS NOT   *00750049
007600*                    LESS THAN 4, CASH BACK MAY BE ISSUED        *00760049
007700******************************************************************00770049
007800*   AJR - 06/18/97 - WR 5220 - GIFT CARDS                        *00780049
007900*                    MODIFIED THE PROGRAM TO PERFORM SPECIFIC    *00790049
008000*                    AUTHORIZATION CHECKS ON THE NEW GIFT CARDS. *00800049
008100******************************************************************00810049
008200*   AJR - 02/11/98 - COMMENTED OUT THE AUTHORIZATION CHECK TO    *00820049
008300*         ENSURE THE STORE ISSUING THE CARD IS THE STORE THE     *00830049
008400*         CARD IS ASSIGNED TO.  THIS WAS DONE DUE TO THE 9802PRES*00840049
008500*         CARD STOCK THAT WAS SENT TO THE STORES FOR THE FEB 98  *00850049
008600*         PRESIDENTS DAY GWP PROMOTION.  WE ARE VERY CONCERNED   *00860049
008700*         ABOUT THE ACCURACY OF THE CARDS THAT WERE ASSIGNED AND *00870049
008800*         SENT TO THE STORES, SO IF THE STORE DOES NOT HAVE THE  *00880049
008900*         CORRECT CARDS, THE CARDS WILL NOT DECLINE.             *00890049
009000******************************************************************00900049
009100*  CHANGED 05/13/99 BY DAVE MUSKAT - COMPUWARE                   *00910049
009200*   WR# COSA   COSA PROJECT                                      *00920049
009300*                                                                *00930049
009400*  CHANGED THE FOLLOWING PARAGRAPHS TO AUTOMATE VOID REVERSALS:  *00940049
009500*  1) SV005-A100-MAINLINE                                        *00950049
009600*    MADE 'SV005-ISSUE-GIFT-CRD' A VALID CONDITION FOR REVERSALS.*00960049
009700*  2) SV005-B400-REVERSE-TRANS.                                  *00970049
009800*    ADDED CALCULATION OF SV005-REVERSAL-AMT.                    *00980049
009900*    ADDED CHECK TO PREVENT THE REVERSAL OF THE ISSUANCE OF A    *00990049
010000*    CARD WITH A ZERO REMAINING BALANCE.                         *01000049
010100*  3) SV005-C500-NORM-TRANS-CHECK                                *01010049
010200*    ADDED A CHECK FOR THE 'SV005-ISSUE-GIFT-CRD' CONDITION.     *01020049
010300*  4) SV005-C600-KMCACT-DUP-CHECK                                *01030049
010400*    ADDED A CHECK FOR THE 'SV005-ISSUE-GIFT-CRD' CONDITION.     *01040049
010500*    ADDED USE OF SV005-REVERSAL-AMT.                            *01050049
010600*  5) SV005-D100-CHECK-NORMAL-TRANS                              *01060049
010700*    MADE SURE THE CARD NUMBER IS THE SAME WHEN LOOKING FOR THE  *01070049
010800*    ORIGINAL TRANSACTION.                                       *01080049
010900*    ADDED A CHECK FOR THE 'SV005-ISSUE-GIFT-CRD' CONDITION.     *01090049
011000*  6) SV005-D300-LOOK-FOR-DUPLICATE                              *01100049
011100*    ADDED USE OF SV005-VOID-IND IN THE SELECT SQL.              *01110049
011200*  7) FOR ANY REVERSAL, IF THE CARD IS NOT 'AV', REFER.          *01120049
011300******************************************************************01130049
011400*   BAE - 03/31/02 - WR 22603 - MULTI-CHANNEL GIFT CARD PROJECT  *01140049
011500*                    COPIED FROM RDPD000                         *01150049
011600******************************************************************01160049
011700*   GBS - 01/02/03 - P5163113 - ALLOW ISSUE IF CARD CURRENTY IS  *01170049
011800*                    MISING AN ISSUE                             *01180049
011900******************************************************************01190049
012000*  CHANGED 7/15/03 BY BRAD GROCHOWSKI TKMA557 WR#24596           *01200049
012100*  CHANGES TO ALLOW ECOMMERCE TO TENDER GIFT CARDS               *01210049
012200*     1. ADDED PIN VERIFY (PIN IS REQUIRED FOR ECOMM TENDERS,    *01220049
012300*        BUT OPTIONAL FOR BALANCE INQUIRY AND REGULAR STORES)    *01230049
012400*     2. APPROVAL NUMBER ROUTINE NOT RUN FOR AUKCS502            *01240049
012500*        TRANSACTIONS BECAUSE ITS NOT USED IN AUKCS502.          *01250049
012600*     3. FOR AUKCS502 ECOMMERCE STORE TRANSCATIONS,              *01260049
012700*        RETURN 0 BALANCE AND APPROVE FOR BALANCE INQUIRY        *01270049
012800*        WHEN BALANCE <= ZERO.                                   *01280049
012900*     4. FOR AUKCS502 ECOMMERCE STORE TRANSACTIONS, DECLINE      *01290049
013000*        IF CARD STATUS IS NOT 'AVAILABLE'.                      *01300049
013100*     5. NO CASH-BACK FOR ECOMM STORES.                          *01310049
013200*     6. SV005-D100-CHECK-NORMAL-TRANS ADDED TRN_VOID_IND TO     *01320049
013300*        SELECT BECAUSE YOU SHOULD ONLY LOOK FOR NON-VOIDED.     *01330049
013400*     7. SV005-B400-REVERSE-TRANS NO CHECK FOR DUP FOR TENDERS.  *01340049
013500*        NOW CHECK FOR 'NORMAL' TRANSACTION TO VOID ONLY.        *01350049
013600*     8. FILLS IN SV005-VOID-STATE-CD FROM NORM TRAN FOR VOIDS   *01360049
013700******************************************************************01370049
013800*  CHANGED 9/01/04 BY BRAD GROCHOWSKI TKMA557 WR#26187           *01380049
013900*  CHANGES TO ALLOW KOHLS GIFT CARD SALES AT SAFEWAY STORES      *01390049
014000*        (FOR SAFEWAY TRANSACTIONS ONLY)                         *01400049
014100*     1. GIFT CARDS ISSUANCES WILL BE CHECKED FOR DUPLICATE      *01410049
014200*        THIS IS DONE SO THAT SAFEWAY DECLINE CODE IS SET TO     *01420049
014300*        "ALREADY ACTIVE" IN AUKCS507.                           *01430049
014400*     2. IF ISSUE AMOUNT IS A DIFFERENT VALUE THAN THE           *01440049
014500*        PRE-DENOMINATED CARD VALUE, DECLINE THE TRANSACTION     *01450049
014600*                                                                *01460049
014700*  OTHER ENHANCEMENTS TO REDUCE DATABASE CALLS (FOR ANY TYPES)   *01470049
014800*     1. FOR ISSUANCES, CALC CURR BAL ONLY IF THERE HAS BEEN     *01480049
014900*        A PRIOR ISSUANCE FOR THIS CARD.                         *01490049
015000*     2. FOR TENDERS, DUP CHECK ONLY IF ACTIVITY_CNT > 1         *01500049
015100*     3. FOR ADD-ON, CHECK FOR PRE-DENOM BEFORE CHECKING REPLEN  *01510049
015200******************************************************************01520049
015300*  CHANGED 12/23/05BY BRAD GROCHOWSKI TKMA557                    *01530049
015400*          DO NOT ALLOW DUPLICATE INSERTS OF A VIRTUAL GIFT CARD *01540049
015500***************************************************************** 01550049
015600*  CHANGED 11/14/07BY BARB ERTL                                   01560049
015700*          ALLOW VIRTUAL GIFT CARD TENDERS FROM POS               01570049
015710***************************************************************** 01580049
015720*  CHANGED 08/14/08BY BARB ERTL                                   01590049
015730*          ADDED A WORK-AROUND FOR POS PROBLEM WHERE AMOUNT IN    01600049
015740*          THE REVERSAL IS NOT THE SAME AS THE AMOUNT IN THE      01610049
015750*          ORIGINAL TRANSACTION.  ADDED PARA D110-.               01620049
015800***************************************************************** 01630049
015720*  CHANGED 03/26/15 BY BARB SCHULTZ                               01640049
015730*          ADDED CODE WHEN CHECKING THE PIN ON A TENDER.IF IT'S   01650049
015730*          A REAUTH, THE PIN WILL NOT BE REQUIRED. THIS WAS NEEDED01660049
015730*          FOR BOPUS FOR OMS. ALSO ADDED REVERSAL-REAUTH LOGIC.   01670049
015730*          ADDED PARAGRAPH SV005-D115-CHECK-REVERSAL-TRAN FOR     01680049
015730*          REVERSAL-REAUTH LOGIC.  ECOMMERCE DOES NOT PASS THE    01690049
015730*          DATE OF THE ORIGINAL TRANSACTION BEFORE REVERSING IT.  01700049
015800***************************************************************** 01710049
015720*  CHANGED 06/27/16 BY BARB SCHULTZ                               01720049
015730*          IF COMING FROM AUKCS502 AND THE CARD IS A PLASTIC CARD 01730049
015730*          THEN DO NOT LET RE-ISSUE OCCUR.                        01740056
208819******************************************************************01750063
208819*  09/18/2018 - CHG0208819 - MAINFRAME REFACTORING               *01760063
208819*                            RENAMING CGU042MC TO DPWS036        *01770063
015900***************************************************************** 01780049
016000* SV005-A100-MAINLINE                                             01790049
016100*      CONTROLS FLOW OF THE PROGRAM.                              01800049
016200***************************************************************** 01810049
016300 SV005-A100-MAINLINE.                                             01820049
016400     SET SV005-DUPLICATE-NOT-FOUND     TO TRUE.                   01830049
016500     SET SV005-PS-NOT-END-ACTVY-CSR    TO TRUE.                   01840049
016600     SET SV005-PS-DO-NOT-DECLINE       TO TRUE.                   01850049
016700     SET SV005-PS-DUPLICATE-NOT-FOUND  TO TRUE.                   01860049
016800     SET SV005-PS-NORM-TRANS-NOT-FOUND TO TRUE.                   01870049
016900                                                                  01880049
017000     EVALUATE TRUE                                                01890049
017100                                                                  01900049
017200         WHEN SV005-REAUTH                                        01910049
017200         WHEN SV005-NORMAL                                        01920049
017300             EVALUATE TRUE                                        01930049
017400                 WHEN SV005-INQUIRE                               01940049
017500                     IF SV005-PS-ADD-ON                           01950049
017600                         PERFORM SV005-B150-BAL-INQ-ADD-ON        01960049
017700                     ELSE                                         01970049
017800                         PERFORM SV005-B100-BALANCE-INQUIRY       01980049
017900                     END-IF                                       01990049
018000                 WHEN SV005-ISSUE                                 02000049
018100                 WHEN SV005-ISSUE-GIFT-CRD                        02010049
018200                     IF SV005-E-ECOMM AND                         02020049
018300                        SV005-PV-FROM-AUKCS502                    02030049
018400                          CONTINUE                                02040049
018500                     ELSE                                         02050049
                             IF (SV005-PV-FROM-AUKCS521) AND            02060049
                                (SV005-DEACTIVATION)                    02070049
021000                          PERFORM SV005-B400-REVERSE-TRANS        02080049
                             ELSE                                       02090049
018600                          PERFORM SV005-B200-NORMAL-ISSUE         02100049
                             END-IF                                     02110049
018700                     END-IF                                       02120049
018800                 WHEN SV005-TENDER                                02130049
018900                     PERFORM SV005-B300-NORMAL-TENDER             02140049
019000                 WHEN OTHER                                       02150049
019100                     PERFORM SV005-Z200-RETURN-FOR-ABEND          02160049
019200                     MOVE SV005-PC-PROC-NAME                      02170049
019300                                       TO SV005-AM-PROC-NAME      02180049
019400                     MOVE 'LOGIC'      TO SV005-AM-TYPE-OF-ABEND  02190049
019500                     MOVE 'SV005-A100-MAINLINE      '             02200049
019600                                       TO SV005-AM-PARAGRAPH-NAME 02210049
019700                     MOVE SV005-AM-MESSAGE-LINE-1                 02220049
019800                                       TO SV005-MESSAGE-1         02230049
019900                     MOVE SV005-ACTIVITY-TYPE                     02240049
020000                                       TO SV005-AM-INV-N-ACT-TYP  02250049
020100                     MOVE SV005-AM-INVALID-N-ACTIVITY             02260049
020200                                       TO SV005-MESSAGE-2         02270049
020300             END-EVALUATE                                         02280049
020400                                                                  02290049
020500         WHEN SV005-REVERSAL                                      02300049
020500         WHEN SV005-REVERSAL-REAUTH                               02310049
020600             EVALUATE TRUE                                        02320049
020700                 WHEN SV005-ISSUE                                 02330049
020800                 WHEN SV005-TENDER                                02340049
020900                 WHEN SV005-ISSUE-GIFT-CRD                        02350049
021000                     PERFORM SV005-B400-REVERSE-TRANS             02360049
021100                 WHEN OTHER                                       02370049
021200                                                                  02380049
021300                     PERFORM SV005-Z200-RETURN-FOR-ABEND          02390049
021400                     MOVE SV005-PC-PROC-NAME                      02400049
021500                                       TO SV005-AM-PROC-NAME      02410049
021600                     MOVE 'LOGIC'      TO SV005-AM-TYPE-OF-ABEND  02420049
021700                     MOVE 'SV005-A100-MAINLINE      '             02430049
021800                                       TO SV005-AM-PARAGRAPH-NAME 02440049
021900                     MOVE SV005-AM-MESSAGE-LINE-1                 02450049
022000                                       TO SV005-MESSAGE-1         02460049
022100                     MOVE SV005-ACTIVITY-TYPE                     02470049
022200                                       TO SV005-AM-INV-R-ACT-TYP  02480049
022300                     MOVE SV005-AM-INVALID-R-ACTIVITY             02490049
022400                                       TO SV005-MESSAGE-2         02500049
022500             END-EVALUATE                                         02510049
022600                                                                  02520049
022700         WHEN OTHER                                               02530049
022800                                                                  02540049
022900             PERFORM SV005-Z200-RETURN-FOR-ABEND                  02550049
023000             MOVE SV005-PC-PROC-NAME                              02560049
023100                                       TO SV005-AM-PROC-NAME      02570049
023200             MOVE 'LOGIC'              TO SV005-AM-TYPE-OF-ABEND  02580049
023300             MOVE 'SV005-A100-MAINLINE      '                     02590049
023400                                       TO SV005-AM-PARAGRAPH-NAME 02600049
023500             MOVE SV005-AM-MESSAGE-LINE-1                         02610049
023600                                       TO SV005-MESSAGE-1         02620049
023700             MOVE SV005-REVERSAL-CODE  TO                         02630049
023800                                        SV005-AM-INVALID-RVRS-CODE02640049
023900             MOVE SV005-AM-INVALID-REV-CODE-MSG                   02650049
024000                                       TO SV005-MESSAGE-2         02660049
024100     END-EVALUATE.                                                02670049
024200                                                                  02680049
024300 EJECT                                                            02690049
024400                                                                  02700049
024500******************************************************************02710049
024600*     SV005-B100-BALANCE-INQUIRY                                 *02720049
024700* ==> PROCESSES:                                                 *02730049
024800*     -CHECKS THE KMC TABLE TO SEE IF THE CARD NUMBER EXISTS     *02740049
024900*     -IF THE NUMBER EXISTS, THE KMC ACTIVITY TABLE IS READ AND  *02750049
025000*      THE APPROVED AMOUNTS ARE SUMMED TO OBTAIN THE CURRENT     *02760049
025100*      BALANCE ON THE KMC CARD.                                  *02770049
025200*     - IF PIN NUMBER IS FILLED IN (>-1) IT WILL BE CHECKED.     *02780049
025300*       (PIN IS OPTIONAL FOR E-STORE BALANCE INQUIRIES)          *02790049
025400* ==> PERFORMED FROM: SV005-A100-MAINLINE                        *02800049
025500******************************************************************02810049
025600 SV005-B100-BALANCE-INQUIRY.                                      02820049
025700                                                                  02830049
                                                                        02840049
025800     EXEC SQL                                                     02850049
025900         SELECT  CRD_NBR,                                         02860049
026000                 CRD_TYP_CDE,                                     02870049
026100                 CRD_PIN_NBR,                                     02880049
026200                 CRD_STAT_CDE                                     02890049
026300           INTO  :SVT00001-CRD-NBR,                               02900049
026400                 :SVT00001-CRD-TYP-CDE,                           02910049
026500                 :SVT00001-CRD-PIN-NBR,                           02920049
026600                 :SVT00001-CRD-STAT-CDE                           02930049
026700           FROM  SVT_KOHLS_CRD_ACCT                               02940049
026800          WHERE  CRD_NBR = :SV005-KMC-ID                          02950049
026900     END-EXEC.                                                    02960049
027000                                                                  02970049
027100     EVALUATE TRUE                                                02980049
027200                                                                  02990049
027300       WHEN SQLCODE = 0                                           03000049
027400         MOVE SVT00001-CRD-TYP-CDE TO SV005-CARD-TYPE             03010049
027500                                                                  03020049
027600* VERIFY PIN FOR CALLS FROM AUKCS502, SKIP FOR OTHER              03030049
027700* CALLING PROGRAMS. IF PIN IS -1, IT WASN'T SENT.                 03040049
027800         IF SV005-PV-FROM-AUKCS502                                03050049
027900            AND SV005-PIN > -1                                    03060049
028000            AND (SVT00001-CRD-PIN-NBR NOT = SV005-PIN)            03070049
028100           PERFORM SV005-Z500-INVALID-PIN                         03080049
028200         END-IF                                                   03090049
028300                                                                  03100049
028400* CHECK FOR 'AVAILABLE' STATUS                                    03110049
      * FOR SAFEWAY THEY WANT A RESPONSE SENT BACK INSTEAD OF A         03120054
      * REFERRAL.                                                       03130054
028500         IF ((SVT00001-CRD-STAT-CDE) NOT =                        03140056
028600                               (SV004-CRD-STAT-TYP-AVAILABLE))    03150058
                     IF  (SV005-PV-FROM-AUKCS507)                       03160056
082200                 SET SV005-HARD-DECLINE               TO TRUE     03170049
                       SET SV005-CARD-STAT-INV-ISSUE        TO TRUE     03180049
                     ELSE                                               03190049
028700                 PERFORM SV005-Z400-REFERRAL                      03200049
                     END-IF                                             03210049
028800         END-IF                                                   03220049
028900                                                                  03230049
029000         IF (SV005-INVALID-PIN) OR (SV005-REFERRAL) OR            03240049
                  (SV005-HARD-DECLINE)                                  03250049
                  CONTINUE                                              03260049
               ELSE                                                     03270049
029100           PERFORM SV005-H100-INSERT-LOCK                         03280049
029200           IF SV005-REFERRAL                                      03290049
029300              CONTINUE                                            03300049
029400           ELSE                                                   03310049
029500             PERFORM SV005-E100-CALC-CURR-BALANCE                 03320049
029600             IF SV005-PGM-ABEND                                   03330049
029700                 CONTINUE                                         03340049
029800             ELSE                                                 03350049
029900               IF (SV005-PV-CURR-BALANCE < ZERO) OR               03360049
030000                  (SV005-PV-CURR-BALANCE = ZERO)                  03370049
030100* NOTE: BALANCE INQUIRIES RETURNING BALANCE OF ZERO               03380049
030200* WILL GIVE "APPROVE" RESPONSE TO AUKCS502 AND AUKCS507           03390049
030300* BUT, "REFERRAL" TO ANY OTHER CALLING PROGRAM.                   03400049
030400                 IF SV005-PV-FROM-AUKCS502                        03410049
030500                   AND SV005-E-ECOMM                              03420049
030600                   SET SV005-APPROVE       TO TRUE                03430049
030700                 ELSE                                             03440049
                         IF (SV005-PV-FROM-AUKCS507)                    03450049
030600                       SET SV005-APPROVE       TO TRUE            03460049
030700                   ELSE                                           03470049
030800                       SET SV005-REFERRAL      TO TRUE            03480049
030700                   END-IF                                         03490049
030900                 END-IF                                           03500049
031000                 MOVE ZERO               TO                       03510049
031100                                   SV005-APPROVED-TENDER-AMT      03520049
031200                                   SV005-KMC-REMAINING-BALANCE    03530049
031300               ELSE                                               03540049
031400                   SET SV005-APPROVE       TO TRUE                03550049
031500                   MOVE SV005-PV-CURR-BALANCE  TO                 03560049
031600                                     SV005-APPROVED-TENDER-AMT    03570049
031700                                     SV005-KMC-REMAINING-BALANCE  03580049
031800               END-IF                                             03590049
031900               MOVE SV005-PC-ZERO-APPROVAL TO                     03600049
032000                                     SV005-KMC-APPROVAL-NBR       03610049
032100             END-IF                                               03620049
032200           END-IF                                                 03630049
032300         END-IF                                                   03640049
032400                                                                  03650049
032500       WHEN SQLCODE = +100                                        03660049
      * FOR SAFEWAY THEY WANT A RESPONSE SENT BACK SO WE ARE SETTING    03670049
      * THIS SWITCH FOR THE CORRECT RESPONSE CODE.                      03680049
030400             IF SV005-PV-FROM-AUKCS507                            03690059
083700                 SET SV005-CARD-ID-INVALID-ISSUE  TO TRUE         03700059
083800             END-IF                                               03710059
                                                                        03720049
032600           PERFORM SV005-Z300-HARD-DECLINE                        03730049
032700                                                                  03740049
032800       WHEN OTHER                                                 03750049
032900                                                                  03760049
033000           PERFORM SV005-Z200-RETURN-FOR-ABEND                    03770049
033100           MOVE SV005-PC-PROC-NAME                                03780049
033200                                     TO SV005-AM-PROC-NAME        03790049
033300           MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND    03800049
033400           MOVE 'SV005-B100-BALANCE-INQUIRY          '            03810049
033500                                     TO SV005-AM-PARAGRAPH-NAME   03820049
033600           MOVE SV005-AM-MESSAGE-LINE-1                           03830049
033700                                     TO SV005-MESSAGE-1           03840049
033800           MOVE SQLCODE              TO SV005-AM-SQLCODE          03850049
033900           MOVE SV005-AM-SELECT-CRD-ACCT                          03860049
034000                                     TO SV005-AM-TABLE-INFO       03870049
034100           MOVE SV005-AM-SQL-MESSAGE-LINE-2                       03880049
034200                                     TO SV005-MESSAGE-2           03890049
034300     END-EVALUATE.                                                03900049
034400                                                                  03910049
034500                                                                  03920049
034600******************************************************************03930049
034700*     SV005-B150-BAL-INQ-ADD-ON                                  *03940049
034800* ==> PROCESSES:                                                 *03950049
034900*     -VERIFIES THAT THE CARD NUMBER IS ON THE KMC TABLE, THAT   *03960049
035000*      THE STATUS OF THE CARD IS AVAILABLE                       *03970049
035100*     -CHECKS IF THERE HAS BEEN ACTIVITY FOR THIS CARD ON THE    *03980049
035200*      SVT_KOHLS_CRD_TXN TABLE                                   *03990049
035300*     -IF CARD HAS ACTIVITY, CHECKS IF THIS CARD IS ELIGIBLE FOR *04000049
035400*      ADD-ON                                                    *04010049
035500*     -IF CARD PASSES ALL ELIGIBILITY RULES FOR ADD-ON,          *04020049
035600*      THE TRANSACTION IS APPROVED                               *04030049
035700* ==> PERFORMED FROM: SV005-A100-MAINLINE                        *04040049
035800******************************************************************04050049
035900 SV005-B150-BAL-INQ-ADD-ON.                                       04060049
036000                                                                  04070049
036100     PERFORM SV005-H100-INSERT-LOCK.                              04080049
036200                                                                  04090049
036300     IF SV005-REFERRAL                                            04100049
036400        CONTINUE                                                  04110049
036500     ELSE                                                         04120049
036600         PERFORM SV005-C100-CHECK-ISSUE                           04130049
036700         IF SV005-PGM-ABEND OR SV005-PS-DECLINE                   04140049
036800                            OR SV005-PS-REFERRAL                  04150049
036900             CONTINUE                                             04160049
037000         ELSE                                                     04170049
037100             PERFORM SV005-E100-CALC-CURR-BALANCE                 04180049
037200             IF SV005-PGM-ABEND                                   04190049
037300                 CONTINUE                                         04200049
037400             ELSE                                                 04210049
037500                 IF (SV005-PV-CURR-BALANCE < ZERO) OR             04220049
037600                    (SV005-PV-CURR-BALANCE = ZERO)                04230049
037700* NOTE: BALANCE INQUIRIES RETURNING BALANCE OF ZERO               04240049
037800* WILL GIVE "APPROVE" RESPONSE TO AUKCS502, BUT                   04250049
037900* "REFERRAL" TO ANY OTHER CALLING PROGRAM.                        04260049
038000                     IF SV005-PV-FROM-AUKCS502                    04270049
038100                       AND SV005-E-ECOMM                          04280049
038200                         SET SV005-APPROVE       TO TRUE          04290049
038300                     ELSE                                         04300049
038400                         SET SV005-REFERRAL      TO TRUE          04310049
038500                     END-IF                                       04320049
038600                     MOVE ZERO TO SV005-APPROVED-TENDER-AMT       04330049
038700                                  SV005-KMC-REMAINING-BALANCE     04340049
038800                 ELSE                                             04350049
038900                     SET SV005-APPROVE       TO TRUE              04360049
039000                     MOVE SV005-PV-CURR-BALANCE  TO               04370049
039100                                  SV005-APPROVED-TENDER-AMT       04380049
039200                                  SV005-KMC-REMAINING-BALANCE     04390049
039300                 END-IF                                           04400049
039400                 MOVE SV005-PC-ZERO-APPROVAL TO                   04410049
039500                                     SV005-KMC-APPROVAL-NBR       04420049
039600             END-IF                                               04430049
039700             IF SV005-GIFT-CRD                                    04440049
039800                 MOVE SV005-TRANS-AMT TO                          04450049
039900                                       SV005-APPROVED-TENDER-AMT  04460049
040000                 COMPUTE SV005-KMC-REMAINING-BALANCE =            04470049
040100                           SV005-KMC-ORIGINAL-BALANCE             04480049
040200                         + SV005-TRANS-AMT                        04490049
040300             ELSE                                                 04500049
040400                 MOVE SV005-TRANS-AMT     TO                      04510049
040500                                       SV005-APPROVED-TENDER-AMT  04520049
040600                 COMPUTE SV005-KMC-REMAINING-BALANCE =            04530049
040700                           SV005-KMC-ORIGINAL-BALANCE             04540049
040800                         + SV005-TRANS-AMT                        04550049
040900             END-IF                                               04560049
041000             PERFORM SV005-C250-CHECK-ADD-ON                      04570049
041100         END-IF                                                   04580049
041200         IF SV005-PGM-ABEND                                       04590049
041300             CONTINUE                                             04600049
041400         ELSE                                                     04610049
041500             IF SV005-PS-DECLINE                                  04620049
041600                 IF SV005-PV-FROM-AUKCS502                        04630049
041700                   AND SV005-E-ECOMM                              04640049
041800                     SET SV005-APPROVE       TO TRUE              04650049
041900                 ELSE                                             04660049
042000                     PERFORM SV005-Z300-HARD-DECLINE              04670049
042100                 END-IF                                           04680049
042200             END-IF                                               04690049
042300         END-IF                                                   04700049
042400     END-IF.                                                      04710049
042500                                                                  04720049
042600******************************************************************04730049
042700*     SV005-B200-NORMAL-ISSUE                                    *04740049
042800* ==> PROCESSES:                                                 *04750049
042900*     -VERIFIES THAT THE CARD NUMBER IS ON THE KMC TABLE, THAT   *04760049
043000*      THE STATUS OF THE CARD IS AVAILABLE                       *04770049
043100*     -CHECKS IF THERE HAS BEEN ACTIVITY FOR THIS CARD ON THE    *04780049
043200*      SVT_KOHLS_CRD_TXN TABLE                                   *04790049
043300*     -IF CARD HAS ACTIVITY, CHECKS IF THIS CARD IS ELIGIBLE FOR *04800049
043400*      ADD-ON                                                    *04810049
043500*     -IF CARD PASSES ALL ELIGIBILITY RULES FOR ISSUE OR ADD-ON, *04820049
043600*      THE TRANSACTION IS APPROVED                               *04830049
043700* ==> PERFORMED FROM: SV005-A100-MAINLINE                        *04840049
043800******************************************************************04850049
043900 SV005-B200-NORMAL-ISSUE.                                         04860049
044000                                                                  04870049
      ** A TRANSACTION CANNOT BE LARGER THEN $500 AND LESS THAN $5      04880049
                                                                        04890049
044100     IF SV005-PV-FROM-EPKCS209 OR                                 04900049
044200        SV005-PV-FROM-AUKCS502 OR                                 04910049
044200        SV005-PV-FROM-AUKCS507 OR                                 04920049
              SV005-PV-FROM-AUKCS521                                    04930049
044300         IF SV005-ISSUE-GIFT-CRD                                  04940049
044400             IF SV005-TRANS-AMT > SV005-PC-MAX-TRANS-AMT          04950049
044500                 SET SV005-PS-DECLINE                             04960049
044600                     SV005-TRAN-DLR-OVER-LIM-ADD-ON TO TRUE       04970049
044700             ELSE                                                 04980049
044400                 IF SV005-TRANS-AMT < SV005-PC-MIN-TRANS-AMT      04990049
044500                     SET SV005-PS-DECLINE                         05000049
044600                         SV005-TRAN-DLR-OVER-LIM-ADD-ON TO TRUE   05010049
044700                 END-IF                                           05020049
044700             END-IF                                               05030049
044800         END-IF                                                   05040049
044900     END-IF.                                                      05050049
045000                                                                  05060049
045100     IF SV005-PS-DECLINE                                          05070049
045200         CONTINUE                                                 05080049
045300     ELSE                                                         05090049
045400         PERFORM SV005-H100-INSERT-LOCK                           05100049
045500                                                                  05110049
045600         IF SV005-REFERRAL                                        05120049
045700            CONTINUE                                              05130049
045800         ELSE                                                     05140049
045900             SET SV005-PS-NOT-ADD-ON TO TRUE                      05150049
046000* THIS WILL SET THE ADD-ON FLAG IF THERE WAS PRIOR ACTIVITY       05160049
046000* SV005-PS-ADD-ON IS SET TO TRUE WHEN SQL = 0                     05170049
046100             PERFORM SV005-C200-CHECK-ID-ACTIVITY                 05180049
046200* THIS WILL DETERMINE IF CARD IS AVAILABLE                        05190049
046300             PERFORM SV005-C100-CHECK-ISSUE                       05200049
046400                                                                  05210049
046500* PERFORM SPECIAL CHECKS FOR SAFEWAY TRANSACTIONS                 05220049
046700             IF (SV005-PGM-ABEND OR SV005-PS-DECLINE              05230049
046800                                OR SV005-PS-REFERRAL)             05240049
                       CONTINUE                                         05250049
                   ELSE                                                 05260049
046600               IF SV005-PV-FROM-AUKCS507                          05270049
046900                  PERFORM SV005-C700-SAFEWAY-CHECKS               05280049
                     ELSE                                               05290049
046600                 IF SV005-PV-FROM-AUKCS521                        05300049
046900                   PERFORM SV005-C800-INCOMM-CHECKS               05310049
047000                 END-IF                                           05320049
047000               END-IF                                             05330049
                   END-IF                                               05340049
047100                                                                  05350049
047200             IF SV005-PGM-ABEND OR SV005-PS-DECLINE               05360049
047300                                OR SV005-PS-REFERRAL              05370049
047400                 CONTINUE                                         05380049
047500             ELSE                                                 05390049
047600* IF THERE WAS A PRIOR ISSUANCE FOR THIS CARD, CALC CURR BALANCE  05400049
047700                 IF SV005-PS-ADD-ON                               05410049
047800                     PERFORM SV005-E100-CALC-CURR-BALANCE         05420049
047900                 ELSE                                             05430049
048000                     MOVE ZERO TO SV005-KMC-ORIGINAL-BALANCE      05440049
048100                 END-IF                                           05450049
048200                                                                  05460049
                                                                        05470049
                         IF (SV005-PV-FROM-AUKCS521) AND                05480049
                            (SV005-KMC-ORIGINAL-BALANCE > 0)            05490049
090900                     SET SV005-PS-DECLINE                         05500049
091000                         SV005-TRAN-DAY-OVER-LIM-ADD-ON TO TRUE   05510049
                                                                        05520049
                         ELSE                                           05530049
                                                                        05540049
048500                     COMPUTE SV005-KMC-REMAINING-BALANCE =        05550049
048600                              SV005-KMC-ORIGINAL-BALANCE          05560049
048700                            + SV005-TRANS-AMT                     05570049
048800                                                                  05580049
048300                     MOVE SV005-TRANS-AMT TO                      05590049
048400                                       SV005-APPROVED-TENDER-AMT  05600049
048900                     IF SV005-PS-ADD-ON                           05610049
049000                       PERFORM SV005-C250-CHECK-ADD-ON            05620049
049100                     END-IF                                       05630049
048800                                                                  05640049
                         END-IF                                         05650049
                                                                        05660049
049200             END-IF                                               05670049
049300         END-IF                                                   05680049
049400     END-IF.                                                      05690049
049500                                                                  05700049
049600     IF SV005-PGM-ABEND OR SV005-REFERRAL                         05710049
049700         CONTINUE                                                 05720049
049800     ELSE                                                         05730049
049900         IF SV005-PS-DECLINE                                      05740049
050000             PERFORM SV005-Z300-HARD-DECLINE                      05750049
050100         ELSE                                                     05760049
050200             SET SV005-APPROVE               TO TRUE              05770049
050300             PERFORM SV005-Z100-GET-APPROVAL-NUMBER               05780049
050400         END-IF                                                   05790049
050500     END-IF.                                                      05800049
050600                                                                  05810049
050700******************************************************************05820049
050800*     SV005-B300-NORMAL-TENDER                                   *05830049
050900* ==> PROCESSES:                                                 *05840049
051000*     -VERIFIES THAT THE CARD NUMBER IS ON THE KMC TABLE AND     *05850049
051100*      THAT THE STATUS OF THE CARD IS AVAILABLE                  *05860049
051200*     -IF THE CARD NUMBER IS NOT FOUND ON THE KMC TABLE, THE     *05870049
051300*      TENDER OF THE CARD IS DECLINED                            *05880049
051400*     -IF THE STATUS OF THE CARD IS NOT AVAILABLE, THE TENDER OF *05890049
051500*      THE CARD IS DECLINED                                      *05900049
051600*     -IF THE PIN IS INVALID THEN 'INVALID PIN' IS RETURNED.     *05910049
051700*       - IF PIN IS FILLED IN, IT IS CHECKED. PIN IS ALWAYS      *05920049
051800*         REQUIRED FOR ECOMM, VIRTUAL AT POS, AND KEY-ENTERED.    05930049
051900*     -CHECKS THE KMC ACTIVITY TABLE FOR DUPLICATE TRANSACTIONS  *05940049
052000*     -COMPARES THE TRANSACTION AMOUNT TO THE CURRENT BALANCE ON *05950049
052100*      THE KMC CARD AND CALCULATES THE APPROVED TENDER AMOUNT    *05960049
052200*      FOR THE CARD                                              *05970049
052300*     -PIN IS CHECKED IN 'SV005-C300-CHECK-TENDER'.              *05980049
052400* ==> PERFORMED FROM: SV005-A100-MAINLINE                        *05990049
052500******************************************************************06000049
052600 SV005-B300-NORMAL-TENDER.                                        06010049
052700                                                                  06020049
052800     PERFORM SV005-H100-INSERT-LOCK.                              06030049
052900                                                                  06040049
053000     IF SV005-REFERRAL                                            06050049
053100          CONTINUE                                                06060049
053200     ELSE                                                         06070049
053300         PERFORM SV005-C300-CHECK-TENDER                          06080049
053400         IF SV005-PS-DECLINE OR SV005-PGM-ABEND OR                06090049
053400            SV005-REAUTH                                          06100049
053500             CONTINUE                                             06110049
053600         ELSE                                                     06120049
053700             MOVE SVT00001-CRD-TYP-CDE TO SV005-CARD-TYPE         06130049
053800             IF SVT00001-CRD-STAT-CDE =                           06140049
053900                                    SV004-CRD-STAT-TYP-AVAILABLE  06150049
054000                 PERFORM SV005-B310-CHECK-PIN                     06160049
054100             ELSE                                                 06170049
054200                 IF SV005-KMRC-CRD                                06180049
054300                     SET SV005-PS-DECLINE TO TRUE                 06190049
054400                 ELSE                                             06200049
054500                     SET SV005-PS-REFERRAL TO TRUE                06210049
054600                 END-IF                                           06220049
054700             END-IF                                               06230049
054800         END-IF                                                   06240049
054900     END-IF.                                                      06250049
055000                                                                  06260049
055100     IF SV005-PGM-ABEND                                           06270049
055200         CONTINUE                                                 06280049
055300     ELSE                                                         06290049
055400       IF SV005-INVALID-PIN                                       06300049
055500             PERFORM SV005-Z500-INVALID-PIN                       06310049
055600       ELSE                                                       06320049
055700         IF SV005-PS-DECLINE                                      06330049
055800             PERFORM SV005-Z300-HARD-DECLINE                      06340049
055900         ELSE                                                     06350049
056000             IF SV005-PS-REFERRAL                                 06360049
056100                 PERFORM SV005-Z400-REFERRAL                      06370049
056200             ELSE                                                 06380049
056300                 PERFORM SV005-E100-CALC-CURR-BALANCE             06390049
056400                 IF SV005-PGM-ABEND                               06400049
056500                     CONTINUE                                     06410049
056600                 ELSE                                             06420049
056700                     IF SV005-PV-ACTIVITY-CNT = 0                 06430049
056800                         SET SV005-PS-TENDER-W-NO-ISSUE TO TRUE   06440049
056900                         SET SV005-REFERRAL      TO TRUE          06450049
057000                         MOVE ZERO TO SV005-APPROVED-TENDER-AMT   06460049
057100                         MOVE SV005-PV-CURR-BALANCE               06470049
057200                                 TO SV005-KMC-REMAINING-BALANCE   06480049
057300                         MOVE SV005-PC-ZERO-APPROVAL              06490049
057400                                 TO SV005-KMC-APPROVAL-NBR        06500049
057500                     ELSE                                         06510049
057600                         SET SV005-PS-TENDER-W-ISSUE TO TRUE      06520049
057700                         IF SV005-PV-ACTIVITY-CNT > 1             06530049
057800                             PERFORM SV005-C600-DUP-CHECK         06540049
057900                         END-IF                                   06550049
058000                         IF SV005-PS-DUPLICATE-FOUND OR           06560049
058100                            SV005-PGM-ABEND                       06570049
058200                             CONTINUE                             06580049
058300                         ELSE                                     06590049
058400                            PERFORM SV005-C400-DETERMINE-CASH-BACK06600049
058500                         END-IF                                   06610049
058600                     END-IF                                       06620049
058700                 END-IF                                           06630049
058800             END-IF                                               06640049
058900         END-IF                                                   06650049
059000       END-IF                                                     06660049
059100     END-IF.                                                      06670049
059200                                                                  06680049
059300******************************************************************06690049
059400*     SV005-B310-CHECK-PIN                                       *06700049
059500* ==> PROCESSES:                                                 *06710049
059600*     -VERIFIES THE PIN NUMBER                                   *06720049
059700*     -IF PIN >-1 IT MUST MATCH.                                 *06730049
059800*     -IF PIN =-2 IT MEANS THE PIN ENTRY WAS BYPASSED - ONLY     *06740049
059900*      FROM POS - NOT ECOMM                                      *06750049
060000******************************************************************06760049
060100 SV005-B310-CHECK-PIN.                                            06770049
060200                                                                  06780049
060300     IF SV005-PV-FROM-AUKCS502                                    06790049
060400         IF SV005-E-ECOMM                                         06800049
060400           IF SV005-REAUTH OR SV005-REVERSAL-REAUTH               06810049
060400              CONTINUE                                            06820049
060400           ELSE                                                   06830049
060500             IF SV005-PIN > -1                                    06840049
060600                 IF SVT00001-CRD-PIN-NBR = SV005-PIN              06850049
060700                     CONTINUE                                     06860049
060800                 ELSE                                             06870049
060900                     SET SV005-INVALID-PIN TO TRUE                06880049
061000                 END-IF                                           06890049
061100             ELSE                                                 06900049
061200                 SET SV005-INVALID-PIN TO TRUE                    06910049
061300             END-IF                                               06920049
061300           END-IF                                                 06930049
061400         END-IF                                                   06940049
061500     END-IF.                                                      06950049
061600                                                                  06960049
061700     IF SV005-PV-FROM-EPKCS209                                    06970049
061800         IF SVT00001-CRD-SPCTY-TYP-CDE =                          06980049
061900                                      SV004-VIRTUAL-SPECIALTY     06990049
062000*            IF EP000-PV-KOHLS-PROD-SYSTEM                        07000049
062100                 IF XST00025-POS-CAP-LVL-ID > 17                  07010049
060400                   IF SV005-REAUTH OR SV005-REVERSAL-REAUTH       07020049
060400                     CONTINUE                                     07030049
060400                   ELSE                                           07040049
062200                     IF SVT00001-CRD-PIN-NBR = SV005-PIN          07050049
062300                         CONTINUE                                 07060049
062400                     ELSE                                         07070049
062500                         SET SV005-INVALID-PIN TO TRUE            07080049
062600                     END-IF                                       07090049
062600                   END-IF                                         07100049
062700                 ELSE                                             07110049
062701                     SET SV005-PS-DECLINE TO TRUE                 07120049
063000                 END-IF                                           07130049
063100*            ELSE                                                 07140049
063200*                IF SV005-PIN = 1234                              07150049
063300*                    CONTINUE                                     07160049
063400*                ELSE                                             07170049
063500*                    SET SV005-INVALID-PIN TO TRUE                07180049
063600*                END-IF                                           07190049
063700*            END-IF                                               07200049
063800         ELSE                                                     07210049
063900             IF SV005-KEY-ENTERED                                 07220049
064000                 IF XST00025-POS-CAP-LVL-ID > 17                  07230049
064100*                    IF EP000-PV-KOHLS-PROD-SYSTEM                07240049
060400                       IF SV005-REAUTH OR SV005-REVERSAL-REAUTH   07250049
060400                         CONTINUE                                 07260049
060400                       ELSE                                       07270049
064200                         SET SV005-PIN-ON-CRD TO TRUE             07280049
064300                         IF SVT00001-CRD-PROD-YR <                07290049
064400                            SV004-PIN-INIT-PROD-YR                07300049
064500                             SET SV005-PIN-NOT-ON-CRD TO TRUE     07310049
064600                         ELSE                                     07320049
064700                             IF SVT00001-CRD-PROD-YR =            07330049
064800                                           SV004-PIN-INIT-PROD-YR 07340049
064900                                 IF SVT00001-SHIPT-REQ-NBR <      07350049
065000                                         SV004-PIN-INIT-SHIPT-REQ 07360049
065100                                     SET SV005-PIN-NOT-ON-CRD     07370049
065200                                                          TO TRUE 07380049
065300                                 END-IF                           07390049
065400                             END-IF                               07400049
065500                         END-IF                                   07410049
065600                         IF SV005-PIN-ON-CRD                      07420049
065700                             IF SVT00001-CRD-PIN-NBR = SV005-PIN  07430049
065800                                 CONTINUE                         07440049
065900                             ELSE                                 07450049
066000                                 IF SV005-PIN < 0                 07460049
066100                                     SET SV005-PS-REFERRAL TO TRUE07470049
066200                                 ELSE                             07480049
066300                                     SET SV005-INVALID-PIN TO TRUE07490049
066400                                 END-IF                           07500049
066500                             END-IF                               07510049
066600                         END-IF                                   07520049
066600                       END-IF                                     07530049
066700*                    ELSE                                         07540049
066800*                        IF SV005-PIN = 1234                      07550049
066900*                            CONTINUE                             07560049
067000*                        ELSE                                     07570049
067100*                            SET SV005-INVALID-PIN TO TRUE        07580049
067200*                        END-IF                                   07590049
067300*                    END-IF                                       07600049
067400                 ELSE                                             07610049
067500                     SET SV005-PS-REFERRAL TO TRUE                07620049
067600                 END-IF                                           07630049
067700             END-IF                                               07640049
067800         END-IF                                                   07650049
067900     END-IF.                                                      07660049
068000                                                                  07670049
068100******************************************************************07680049
068200*     SV005-B400-REVERSE-TRANS                                   *07690049
068300* ==> PROCESSES:                                                 *07700049
068400*     -CHECKS THE KMC ACTIVITY TABLE FOR DUPLICATE TRANSACTIONS  *07710049
068500*     -SETS RESPONSE CODE TO 'REFERRAL' WHEN THE REVERSAL IS FOR *07720049
068600*      THE ISSUANCE OF A CARD THAT HAS A BALANCE LESS THAN ZERO  *07730049
068700*      (MEANING THAT THE FULL CARD VALUE HAS BEEN TENDERED, SO   *07740049
068800*       THEREFORE THE ISSUANCE OF THE CARD CAN NOT BE REVERSED)  *07750049
068900*     -VERIFIES THAT THE CORRESPONDING "NORMAL" STATUS TRANSAC-  *07760049
069000*      TION IS ON THE KMC ACTIVITY TABLE                         *07770049
069100*     8/11/03 - NO NEED TO CHECK FOR DUP ON TENDERS, JUST CHECK  *07780049
069200*               FOR 'NORMAL' AUTH AVAILABLE TO BE VOIDED.        *07790049
069300*               CHANGED BECAUSE ECOMM LETS MULTIPLE PAIRS OF     *07800049
069400*               AUTH/VOIDS FOR EACH GIFT CARD.                   *07810049
069500* ==> PERFORMED FROM: SV005-A100-MAINLINE                        *07820049
069600******************************************************************07830049
069700 SV005-B400-REVERSE-TRANS.                                        07840049
069800                                                                  07850049
069900     MOVE SV005-TRANS-AMT TO SV005-REVERSAL-AMT.                  07860049
070000     IF SV005-ISSUE                                               07870049
070100     OR SV005-ISSUE-GIFT-CRD                                      07880049
070200         COMPUTE SV005-REVERSAL-AMT = SV005-REVERSAL-AMT * -1     07890049
070300     END-IF.                                                      07900049
070400                                                                  07910049
      ***** FOR INCOMM                                                  07920049
      ***** DEACT REVERSALS HAVE A POSITIVE AMOUNT VERSUS A NEGATIVE    07930049
      ***** AMOUNT FOR REVERSALS.                                       07940049
                                                                        07950049
           IF (SV005-PV-FROM-AUKCS521) AND                              07960049
              (SV005-DEACT-REV)                                         07970049
069900         MOVE SV005-TRANS-AMT TO SV005-REVERSAL-AMT               07980049
           END-IF.                                                      07990049
                                                                        08000049
070500     PERFORM SV005-C050-CHECK-STATUS.                             08010049
070600     IF (SV005-PGM-ABEND                                          08020049
070700      OR SV005-REFERRAL                                           08030049
070800      OR SV005-HARD-DECLINE)                                      08040049
070900         CONTINUE                                                 08050049
071000     ELSE                                                         08060049
071100       IF NOT SV005-TENDER                                        08070049
               IF (SV005-PV-FROM-AUKCS521)                              08080049
046300            PERFORM SV005-I350-CHECK-ACTIVITY                     08090049
                  IF SV005-HARD-DECLINE                                 08100049
                     SET SV005-PS-INACTIVE TO TRUE                      08110049
                     CONTINUE                                           08120049
                  ELSE                                                  08130049
                    IF SV005-DEACTIVATION                               08140049
138200                PERFORM SV005-I340-INCOMM-CHECK-TEND              08150049
                    END-IF                                              08160049
                  END-IF                                                08170049
                                                                        08180049
                  IF (SV005-HARD-DECLINE) OR                            08190049
                     (SV005-PGM-ABEND)                                  08200049
                      CONTINUE                                          08210049
                  ELSE                                                  08220049
                    IF SV005-DEACTIVATION                               08230049
                       CONTINUE                                         08240049
                    ELSE                                                08250049
                       PERFORM SV005-I360-INCOMM-SET-VALUES             08260049
                    END-IF                                              08270049
                  END-IF                                                08280049
               ELSE                                                     08290049
071200           PERFORM SV005-C600-DUP-CHECK                           08300049
               END-IF                                                   08310049
071300       END-IF                                                     08320049
071400     END-IF.                                                      08330049
071500                                                                  08340049
071600     IF (SV005-PS-DUPLICATE-FOUND                                 08350049
071700      OR SV005-PGM-ABEND                                          08360049
071800      OR SV005-REFERRAL                                           08370049
071900      OR SV005-HARD-DECLINE)                                      08380049
072000         CONTINUE                                                 08390049
072100     ELSE                                                         08400049
072200         EVALUATE TRUE                                            08410049
072300             WHEN SV005-ISSUE                                     08420049
072400             WHEN SV005-ISSUE-GIFT-CRD                            08430049
072500                 PERFORM SV005-C500-NORM-TRANS-CHECK              08440049
072600             WHEN OTHER                                           08450049
072700                 PERFORM SV005-C500-NORM-TRANS-CHECK              08460049
072800                 PERFORM SV005-E100-CALC-CURR-BALANCE             08470049
072900                 COMPUTE SV005-KMC-REMAINING-BALANCE =            08480049
073000                (SV005-KMC-ORIGINAL-BALANCE + SV005-REVERSAL-AMT) 08490049
073100         END-EVALUATE                                             08500049
073200     END-IF.                                                      08510049
073300                                                                  08520049
073400******************************************************************08530049
073500*     SV005-C050-CHECK-STATUS                                    *08540049
073600* ==> PROCESSES:                                                 *08550049
073700*     -SELECTS THE STATUS CODE FROM THE KMC TABLE FOR THE CARD   *08560049
073800*      NUMBER                                                    *08570049
073900*     -IF THE CARD NUMBER IS NOT FOUND ON THE KMC TABLE, THE     *08580049
074000*      TRANSACTION IS DECLINED                                   *08590049
074100*     -IF STATUS OF THE CARD IS NOT AVAILABLE, THE CARD IS       *08600049
074200*      REFERRED.                                                 *08610049
074300* ==> PERFORMED FROM: SV005-B400-REVERSE-TRANS                   *08620049
074400******************************************************************08630049
074500 SV005-C050-CHECK-STATUS.                                         08640049
074600                                                                  08650049
074700     EXEC SQL                                                     08660049
074800         SELECT  CRD_STAT_CDE                                     08670049
074900           INTO  :SVT00001-CRD-STAT-CDE                           08680049
075000           FROM  SVT_KOHLS_CRD_ACCT T                             08690049
075100          WHERE  CRD_NBR = :SV005-KMC-ID                          08700049
075200     END-EXEC.                                                    08710049
075300                                                                  08720049
075400     EVALUATE TRUE                                                08730049
075500         WHEN SQLCODE = 0                                         08740049
075600           PERFORM SV005-H100-INSERT-LOCK                         08750049
075700           IF SV005-REFERRAL                                      08760049
075800              CONTINUE                                            08770049
075900           ELSE                                                   08780049
076000             IF SVT00001-CRD-STAT-CDE NOT =                       08790049
076100                                    SV004-CRD-STAT-TYP-AVAILABLE  08800049
                     IF  (SV005-PV-FROM-AUKCS507) OR                    08810049
                         (SV005-PV-FROM-AUKCS521)                       08820049
082200                 SET SV005-HARD-DECLINE               TO TRUE     08830049
                       SET SV005-CARD-STAT-INV-ISSUE        TO TRUE     08840049
                       SET SV005-PS-INACTIVE                TO TRUE     08850049
                     ELSE                                               08860049
076200                 PERFORM SV005-Z400-REFERRAL                      08870049
                     END-IF                                             08880049
076300             END-IF                                               08890049
076400           END-IF                                                 08900049
076500                                                                  08910049
076600         WHEN SQLCODE = +100                                      08920049
076700             PERFORM SV005-Z300-HARD-DECLINE                      08930049
                     IF  (SV005-PV-FROM-AUKCS507) OR                    08940049
                         (SV005-PV-FROM-AUKCS521)                       08950049
082200                 SET SV005-HARD-DECLINE               TO TRUE     08960049
                       SET SV005-CARD-ID-INVALID-ISSUE      TO TRUE     08970049
                     END-IF                                             08980049
076800                                                                  08990049
076900         WHEN OTHER                                               09000049
077000                                                                  09010049
077100             PERFORM SV005-Z200-RETURN-FOR-ABEND                  09020049
077200             MOVE SV005-PC-PROC-NAME                              09030049
077300                                       TO SV005-AM-PROC-NAME      09040049
077400             MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  09050049
077500             MOVE 'SV005-C050-CHECK-STATUS  '                     09060049
077600                                       TO SV005-AM-PARAGRAPH-NAME 09070049
077700             MOVE SV005-AM-MESSAGE-LINE-1                         09080049
077800                                       TO SV005-MESSAGE-1         09090049
077900             MOVE SQLCODE              TO SV005-AM-SQLCODE        09100049
078000             MOVE SV005-AM-SELECT-CRD-ACCT                        09110049
078100                                       TO SV005-AM-TABLE-INFO     09120049
078200             MOVE SV005-AM-SQL-MESSAGE-LINE-2                     09130049
078300                                       TO SV005-MESSAGE-2         09140049
078400     END-EVALUATE.                                                09150049
078500******************************************************************09160049
078600*     SV005-C100-CHECK-ISSUE                                     *09170049
078700* ==> PROCESSES:                                                 *09180049
078800*     -SELECTS THE STATUS CODE FROM THE ACCOUNT TABLE FOR THE    *09190049
078900*      CARD NUMBER                                               *09200049
079000*     -IF THE CARD NUMBER IS NOT FOUND ON THE KMC TABLE, THE     *09210049
079100*      ISSUE OF THE CARD IS DECLINED                             *09220049
079200*     -IF STATUS OF THE CARD IS NOT AVAILABLE, THE ISSUE OF CARD *09230049
079300*      IS DECLINED                                               *09240049
079400* ==> PERFORMED FROM: SV005-B200-NORMAL-ISSUE                    *09250049
079500******************************************************************09260049
079600 SV005-C100-CHECK-ISSUE.                                          09270049
079700                                                                  09280049
079800     EXEC SQL                                                     09290049
079900         SELECT  CRD_STAT_CDE                                     09300049
080000                ,PRE_DNNTD_CRD_AMT                                09310049
080100                ,T.CRD_TYP_CDE                                    09320049
080200                ,T.CRD_PROD_YR                                    09330049
080300                ,T.SHIPT_REQ_NBR                                  09340049
080400                ,CRD_STK_TYP_ID                                   09350049
080500           INTO  :SVT00001-CRD-STAT-CDE                           09360049
080600                ,:SVT00000-PRE-DNNTD-CRD-AMT                      09370049
080700                ,:SVT00001-CRD-TYP-CDE                            09380049
080800                ,:SVT00001-CRD-PROD-YR                            09390049
080900                ,:SVT00001-SHIPT-REQ-NBR                          09400049
081000                ,:SVT00000-CRD-STK-TYP-ID                         09410049
081100           FROM  SVT_KOHLS_CRD_ACCT T                             09420049
081200                ,SVT_CRD_PROD C                                   09430049
081300          WHERE  CRD_NBR = :SV005-KMC-ID                          09440049
081400            AND T.CRD_PROD_YR = C.CRD_PROD_YR                     09450049
081500            AND T.SHIPT_REQ_NBR = C.SHIPT_REQ_NBR                 09460049
081600     END-EXEC.                                                    09470049
081700                                                                  09480049
081800     EVALUATE TRUE                                                09490049
081900         WHEN SQLCODE = 0                                         09500049
082000             IF SVT00001-CRD-STAT-CDE NOT =                       09510049
082100                                    SV004-CRD-STAT-TYP-AVAILABLE  09520049
082200                 SET SV005-PS-DECLINE TO TRUE                     09530049
082300                 IF SV005-PS-ADD-ON                               09540049
082400                     SET SV005-CARD-STAT-INV-ADD-ON TO TRUE       09550049
082500                 ELSE                                             09560049
082600                     SET SV005-CARD-STAT-INV-ISSUE        TO TRUE 09570049
082700                 END-IF                                           09580049
                       IF  (SV005-PV-FROM-AUKCS521)                     09590049
                          SET SV005-PS-INACTIVE       TO TRUE           09600049
                       END-IF                                           09610049
082800             END-IF                                               09620049
082900             MOVE SVT00001-CRD-TYP-CDE TO SV005-CARD-TYPE         09630049
083000                                                                  09640049
083100                                                                  09650049
083200         WHEN SQLCODE = +100                                      09660049
083300             SET SV005-PS-DECLINE TO TRUE                         09670049
083400             IF SV005-PS-ADD-ON                                   09680049
083500                 SET SV005-CARD-ID-INVALID-ADD-ON TO TRUE         09690049
083600             ELSE                                                 09700049
083700                 SET SV005-CARD-ID-INVALID-ISSUE  TO TRUE         09710049
083800             END-IF                                               09720049
083900                                                                  09730049
084000         WHEN OTHER                                               09740049
084100                                                                  09750049
084200             PERFORM SV005-Z200-RETURN-FOR-ABEND                  09760049
084300             MOVE SV005-PC-PROC-NAME                              09770049
084400                                       TO SV005-AM-PROC-NAME      09780049
084500             MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  09790049
084600             MOVE 'SV005-C100-CHECK-ISSUE   '                     09800049
084700                                       TO SV005-AM-PARAGRAPH-NAME 09810049
084800             MOVE SV005-AM-MESSAGE-LINE-1                         09820049
084900                                       TO SV005-MESSAGE-1         09830049
085000             MOVE SQLCODE              TO SV005-AM-SQLCODE        09840049
085100             MOVE SV005-AM-SELECT-CRD-ACCT                        09850049
085200                                       TO SV005-AM-TABLE-INFO     09860049
085300             MOVE SV005-AM-SQL-MESSAGE-LINE-2                     09870049
085400                                       TO SV005-MESSAGE-2         09880049
085500     END-EVALUATE.                                                09890049
085600                                                                  09900049
085700******************************************************************09910049
085800*     SV005-C200-CHECK-ID-ACTIVITY                               *09920049
085900* ==> PROCESSES:                                                 *09930049
086000*     -CHECKS THE KMC ACTIVITY TABLE FOR THE CARD NUMBER         *09940049
086100*     -IF THE CARD NUMBER IS FOUND ON THE ACTIVITY TABLE, SET    *09950049
086200*      THE ADD-ON SWITCH                                         *09960049
086200*     -8/16 - CHANGE WAS MADE IF THE CARD IS ISSUED FROM ONLINE  *09970055
086200*      AND IT IS A PLASTIC GIFT CARD, DO NOT SET THE ADD-ON      *09980055
086200*      SWITCH                                                    *09990055
086300* ==> PERFORMED FROM: SV005-B200-NORMAL-ISSUE                    *10000055
086400******************************************************************10010055
086500 SV005-C200-CHECK-ID-ACTIVITY.                                    10020055
086600                                                                  10030055
086700     EXEC SQL                                                     10040055
086800         SELECT  CRD_NBR                                          10050055
086900           INTO  :SVT00002-CRD-NBR                                10060055
087000           FROM  SVT_KOHLS_CRD_TXN                                10070055
087100          WHERE  CRD_NBR       = :SV005-KMC-ID                    10080055
087200            AND  ACTVY_TYP_CDE = :SV005-ACTIVITY-TYPE             10090055
087300     END-EXEC.                                                    10100055
087400                                                                  10110055
087500     EVALUATE TRUE                                                10120055
087600         WHEN SQLCODE = 0 OR -811                                 10130055
060300             IF  SV005-PV-FROM-AUKCS502 AND                       10140055
072400                 SV005-ISSUE-GIFT-CRD                             10150055
061900               IF SV005-PLASTIC-CARD                              10160060
045900                 SET SV005-PS-NOT-ADD-ON TO TRUE                  10170055
                     ELSE                                               10180055
087700                 SET SV005-PS-ADD-ON TO TRUE                      10190055
                     END-IF                                             10200055
                   ELSE                                                 10210055
087700                 SET SV005-PS-ADD-ON TO TRUE                      10220055
                   END-IF                                               10230055
087800                                                                  10240055
087900         WHEN SQLCODE = +100                                      10250055
088000             CONTINUE                                             10260055
088100                                                                  10270055
088200         WHEN OTHER                                               10280055
088300                                                                  10290055
088400             PERFORM SV005-Z200-RETURN-FOR-ABEND                  10300055
088500             MOVE SV005-PC-PROC-NAME                              10310055
088600                                       TO SV005-AM-PROC-NAME      10320055
088700             MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  10330055
088800             MOVE 'SV005-C200-CHECK-ID-ACTIVITY'                  10340055
088900                                       TO SV005-AM-PARAGRAPH-NAME 10350055
089000             MOVE SV005-AM-MESSAGE-LINE-1                         10360055
089100                                       TO SV005-MESSAGE-1         10370055
089200             MOVE SQLCODE              TO SV005-AM-SQLCODE        10380055
089300             MOVE SV005-AM-SELECT-CRD-TXN TO SV005-AM-TABLE-INFO  10390055
089400             MOVE SV005-AM-SQL-MESSAGE-LINE-2                     10400055
089500                                       TO SV005-MESSAGE-2         10410055
089600     END-EVALUATE.                                                10420055
089700                                                                  10430055
089800******************************************************************10440055
089900*     SV005-C250-CHECK-ADD-ON                                    *10450055
090000* ==> PROCESSES:                                                 *10460055
090100*     -CHECKS THE SV CARD STOCK DENOMINATION TABLE TO SEE IF     *10470055
090200*      THIS CARD STOCK TYPE/DENOMINATION CAN HAVE ADD-ON.        *10480055
090300* ==> PERFORMED FROM: SV005-B200-NORMAL-ISSUE                    *10490055
090400******************************************************************10500055
090500 SV005-C250-CHECK-ADD-ON.                                         10510055
090600                                                                  10520055
                                                                        10530055
090700* PRE-DENOMINATED CARDS CANNOT ADD ON VALUE.                      10540055
      * HOWEVER FOR INCOMM, SINCE THEY DEACTIVATE CARDS THEY CAN RE-SELL10550055
      * THEM SO WE NEED TO CHECK THAT THE CALCULATED BALANCE            10560055
      *                                                                 10570055
      *  CANNOT ADD ON DENOM CARDS, HOWEVER IF DEACTIVATED THE TRAN AMT 10580055
      *  SHOULD = THE DENOM AMOUNT.                                     10590055
           IF (SV005-PV-FROM-AUKCS507) OR                               10600055
              (SV005-PV-FROM-AUKCS521)                                  10610055
              CONTINUE                                                  10620055
           ELSE                                                         10630055
090800         IF (SVT00000-PRE-DNNTD-CRD-AMT > 0)                      10640055
090900             SET SV005-PS-DECLINE                                 10650055
091000                 SV005-CARD-PRE-DENOM-ADD-ON TO TRUE              10660055
091100         ELSE                                                     10670055
091200             IF SVT00001-CRD-PROD-YR < SV004-PIN-INIT-PROD-YR     10680055
091300               SET SV005-PS-DECLINE                               10690055
091400                   SV005-CARD-NO-PIN-ADD-ON TO TRUE               10700055
091500             ELSE                                                 10710055
091600               IF SVT00001-CRD-PROD-YR = SV004-PIN-INIT-PROD-YR   10720055
091700                   IF SVT00001-SHIPT-REQ-NBR <                    10730055
091800                                   SV004-PIN-INIT-SHIPT-REQ       10740055
091900                     SET SV005-PS-DECLINE                         10750055
092000                         SV005-CARD-NO-PIN-ADD-ON TO TRUE         10760055
092100                   END-IF                                         10770055
092200               END-IF                                             10780055
092200             END-IF                                               10790055
092300         END-IF                                                   10800055
092400     END-IF.                                                      10810055
092500                                                                  10820055
092600* CHECK IF THIS CARD IS MARKED AS REPLENISHIBLE ON TABLE          10830055
092700     IF SV005-PS-DECLINE                                          10840055
092800         CONTINUE                                                 10850055
092900     ELSE                                                         10860055
093000         EXEC SQL                                                 10870055
093100             SELECT  CRD_RPLNT_IND                                10880055
093200               INTO  :SVT00008-CRD-RPLNT-IND                      10890055
093300               FROM  SVT_CRD_STK_DNMNTN                           10900055
093400              WHERE  CRD_TYP_CDE   = :SVT00001-CRD-TYP-CDE        10910055
093500                AND  CRD_STK_TYP_ID = :SVT00000-CRD-STK-TYP-ID    10920055
093600                AND  PRE_DNNTD_CRD_AMT                            10930055
093700                     = :SVT00000-PRE-DNNTD-CRD-AMT                10940055
093800         END-EXEC                                                 10950055
093900                                                                  10960055
094000         EVALUATE TRUE                                            10970055
094100             WHEN SQLCODE = 0                                     10980055
094200                 IF SVT00008-CRD-RPLNT-IND = 'N'                  10990055
094300                     SET SV005-PS-DECLINE                         11000055
094400                         SV005-CARD-STOCK-INV-ADD-ON  TO TRUE     11010055
094500                 END-IF                                           11020055
094600                                                                  11030055
094700             WHEN OTHER                                           11040055
094800                                                                  11050055
094900                 PERFORM SV005-Z200-RETURN-FOR-ABEND              11060055
095000                 MOVE SV005-PC-PROC-NAME                          11070055
095100                                       TO SV005-AM-PROC-NAME      11080055
095200                 MOVE '  DB2'          TO SV005-AM-TYPE-OF-ABEND  11090055
095300                 MOVE 'SV005-C250-CHECK-ADD-ON'                   11100055
095400                                       TO SV005-AM-PARAGRAPH-NAME 11110055
095500                 MOVE SV005-AM-MESSAGE-LINE-1                     11120055
095600                                       TO SV005-MESSAGE-1         11130055
095700                 MOVE SQLCODE          TO SV005-AM-SQLCODE        11140055
095800                 MOVE SV005-AM-SELECT-CRD-TXN                     11150055
095900                                       TO SV005-AM-TABLE-INFO     11160055
096000                 MOVE SV005-AM-SQL-MESSAGE-LINE-2                 11170055
096100                                       TO SV005-MESSAGE-2         11180055
096200         END-EVALUATE                                             11190055
096300     END-IF.                                                      11200055
096400                                                                  11210055
096500* CHECK IF TRANSACTION IS OVER LIMITS FOR ADD ON TRANSACTIONS     11220055
096600     IF SV005-PS-DECLINE                                          11230055
096700         CONTINUE                                                 11240055
096800     ELSE                                                         11250055
096900         IF SV005-ISSUE-GIFT-CRD                                  11260055
097000             IF SV005-TRANS-AMT > SV005-PC-MAX-TRANS-AMT          11270055
097100                 SET SV005-PS-DECLINE                             11280055
097200                     SV005-TRAN-DLR-OVER-LIM-ADD-ON TO TRUE       11290055
097300             ELSE                                                 11300055
097400                 IF SV005-KMC-REMAINING-BALANCE >                 11310055
097500                    SV005-PC-MAX-CARD-AMT                         11320055
097600                     SET SV005-PS-DECLINE                         11330055
097700                         SV005-CARD-BAL-OVER-LIM-ADD-ON           11340055
097800                                           TO TRUE                11350055
097900                 ELSE                                             11360055
098000                     IF (SV005-PV-FROM-RDKCS023-AUDIT)            11370055
098100                         CONTINUE                                 11380055
098200                     ELSE                                         11390055
098300                         PERFORM SV005-C260-CHK-IF-ADD-ON-TODAY   11400055
098400                     END-IF                                       11410055
098500                 END-IF                                           11420055
098600             END-IF                                               11430055
098700         END-IF                                                   11440055
098800     END-IF.                                                      11450055
098900                                                                  11460055
099000******************************************************************11470055
099100*     SV005-C260-CHK-IF-ADD-ON-TODAY                             *11480055
099200* ==> PROCESSES:                                                 *11490055
099300*     -CHECKS THE KMC ACTIVITY TABLE FOR THE CARD NUMBER         *11500055
099400*     -IF THE CARD HAS HAD VALUE ADDED TO IT TODAY, THE          *11510055
099500*      ADDITIONAL ADD-ON IS DECLINED.                            *11520055
099600* ==> PERFORMED FROM: SV005-C250-CHECK-ADD-ON                    *11530055
099700******************************************************************11540055
099800 SV005-C260-CHK-IF-ADD-ON-TODAY.                                  11550055
099900                                                                  11560055
100000     EXEC SQL                                                     11570055
100100         SELECT  CRD_NBR                                          11580055
100200           INTO  :SVT00002-CRD-NBR                                11590055
100300           FROM  SVT_KOHLS_CRD_TXN                                11600055
100400          WHERE  CRD_NBR       = :SV005-KMC-ID                    11610055
100500            AND  ACTVY_TYP_CDE = 2                                11620055
100600            AND  POS_DTE       = :SV005-POS-DATE                  11630055
100700            AND  TRN_VOID_IND  = 'N'                              11640055
100800     END-EXEC.                                                    11650055
100900                                                                  11660055
101000     EVALUATE TRUE                                                11670055
101100         WHEN SQLCODE = 0 OR -811                                 11680055
101200             SET SV005-PS-DECLINE                                 11690055
101300                 SV005-TRAN-DAY-OVER-LIM-ADD-ON TO TRUE           11700055
101400                                                                  11710055
101500         WHEN SQLCODE = +100                                      11720055
101600             CONTINUE                                             11730055
101700                                                                  11740055
101800         WHEN OTHER                                               11750055
101900                                                                  11760055
102000             PERFORM SV005-Z200-RETURN-FOR-ABEND                  11770055
102100             MOVE SV005-PC-PROC-NAME                              11780055
102200                                       TO SV005-AM-PROC-NAME      11790055
102300             MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  11800055
102400             MOVE 'SV005-C260-CHK-IF-ADD-ON-TODAY'                11810055
102500                                       TO SV005-AM-PARAGRAPH-NAME 11820055
102600             MOVE SV005-AM-MESSAGE-LINE-1                         11830055
102700                                       TO SV005-MESSAGE-1         11840055
102800             MOVE SQLCODE              TO SV005-AM-SQLCODE        11850055
102900             MOVE SV005-AM-SELECT-CRD-TXN TO SV005-AM-TABLE-INFO  11860055
103000             MOVE SV005-AM-SQL-MESSAGE-LINE-2                     11870055
103100                                       TO SV005-MESSAGE-2         11880055
103200     END-EVALUATE.                                                11890055
103300                                                                  11900055
103400******************************************************************11910055
103500*     SV005-C300-CHECK-TENDER                                    *11920055
103600* ==> PROCESSES:                                                 *11930055
103700*     -SELECTS FIELDS REQUIRED FOR VALIDATION FOR THE CARD NUMBER*11940055
103800* ==> PERFORMED FROM: SV005-B300-NORMAL-TENDER                   *11950055
103900******************************************************************11960055
104000 SV005-C300-CHECK-TENDER.                                         11970055
104100                                                                  11980055
104200     EXEC SQL                                                     11990055
104300         SELECT  CRD_STAT_CDE,                                    12000055
104400                 CRD_TYP_CDE,                                     12010055
104500                 CRD_PROD_YR,                                     12020055
104600                 SHIPT_REQ_NBR,                                   12030055
104700                 CRD_SPCTY_TYP_CDE,                               12040055
104800                 CRD_PIN_NBR                                      12050055
104900           INTO  :SVT00001-CRD-STAT-CDE,                          12060055
105000                 :SVT00001-CRD-TYP-CDE,                           12070055
105100                 :SVT00001-CRD-PROD-YR,                           12080055
105200                 :SVT00001-SHIPT-REQ-NBR,                         12090055
105300                 :SVT00001-CRD-SPCTY-TYP-CDE,                     12100055
105400                 :SVT00001-CRD-PIN-NBR                            12110055
105500           FROM  SVT_KOHLS_CRD_ACCT                               12120055
105600          WHERE  CRD_NBR = :SV005-KMC-ID                          12130055
105700     END-EXEC.                                                    12140055
105800                                                                  12150055
105900     EVALUATE TRUE                                                12160055
106000       WHEN SQLCODE = 0                                           12170055
106100           CONTINUE                                               12180055
106200                                                                  12190055
106300       WHEN SQLCODE = +100                                        12200055
106400             SET SV005-PS-DECLINE TO TRUE                         12210055
106500                                                                  12220055
106600       WHEN OTHER                                                 12230055
106700                                                                  12240055
106800             PERFORM SV005-Z200-RETURN-FOR-ABEND                  12250055
106900             MOVE SV005-PC-PROC-NAME                              12260055
107000                                       TO SV005-AM-PROC-NAME      12270055
107100             MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  12280055
107200             MOVE 'SV005-C300-CHECK-TENDER  '                     12290055
107300                                       TO SV005-AM-PARAGRAPH-NAME 12300055
107400             MOVE SV005-AM-MESSAGE-LINE-1                         12310055
107500                                       TO SV005-MESSAGE-1         12320055
107600             MOVE SQLCODE              TO SV005-AM-SQLCODE        12330055
107700             MOVE SV005-AM-SELECT-CRD-ACCT                        12340055
107800                                       TO SV005-AM-TABLE-INFO     12350055
107900             MOVE SV005-AM-SQL-MESSAGE-LINE-2                     12360055
108000                                       TO SV005-MESSAGE-2         12370055
108100     END-EVALUATE.                                                12380055
108200                                                                  12390055
108300******************************************************************12400055
108400*     SV005-C400-DETERMINE-CASH-BACK                             *12410055
108500* ==> PROCESSES:                                                 *12420055
108600*     -WHEN COMING FROM RDKCS023-AUDIT FUNCTION, CASH BACK MAY   *12430055
108700*      NOT BE ISSUED                                             *12440055
108800*     -WHEN STORE IS AN ECOMMERCE STORE, CASH BACK MY NOT BE     *12450055
108900*      GIVEN.                                                    *12460055
109000*     -THE CURRENT BALANCE ON THE KMC CARD IS COMPARED TO THE    *12470055
109100*      TRANSACTION AMOUNT                                        *12480055
109200*     -WHEN COMING FROM RDKCS080 CASH BACK MAY BE ISSUED         *12490055
109300*     -WHEN COMING FROM RDKCS023-AUTHORIZATION FUNCTION, THE     *12500055
109400*      REGISTER RELEASE IS VERIFIED.  CASH BACK MAY ONLY BE      *12510055
109500*      ISSUED IF THE REGISTER RELEASE IS NOT LESS THAN 4         *12520055
109600* ==> PERFORMED FROM: SV005-B300-NORMAL-TENDER                   *12530055
109700******************************************************************12540055
109800 SV005-C400-DETERMINE-CASH-BACK.                                  12550055
109900     IF SV005-PV-FROM-RDKCS023-AUDIT                              12560055
110000        OR SV005-E-ECOMM                                          12570055
110100         PERFORM SV005-C450-COMPARE-BALANCES                      12580055
110200     ELSE                                                         12590055
110300         IF SV005-PV-CURR-BALANCE > SV005-TRANS-AMT               12600055
110400             PERFORM SV005-C410-PROCESS-REMAIN-BAL                12610055
110500         ELSE                                                     12620055
110600             PERFORM SV005-C450-COMPARE-BALANCES                  12630055
110700         END-IF                                                   12640055
110800     END-IF.                                                      12650055
110900                                                                  12660055
111000                                                                  12670055
111100******************************************************************12680055
111200*     SV005-C410-PROCESS-REMAIN-BAL                              *12690055
111300* ==> PROCESSES:                                                 *12700055
111400*     -DETERMINE IF CASH BACK WILL BE ISSUED                     *12710055
111500*     -CALCULATE THE REMAINING BALANCE BECAUSE THE CURRENT       *12720055
111600*      BALANCE IS GREATER THAN OR EQUAL TO THE TRANSACTION AMOUNT*12730055
111700*     -TENDER WILL EITHER BE APPROVED FOR THE TRANSACTION AMOUNT *12740055
111800*      OR THE KMC REMAINING BALANCE                              *12750055
111900* ==> PERFORMED FROM: SV005-C400-DETERMINE-CASH-BACK             *12760055
112000******************************************************************12770055
112100 SV005-C410-PROCESS-REMAIN-BAL.                                   12780055
112200     COMPUTE SV005-PV-REMAINING-BALANCE =                         12790055
112300             SV005-PV-CURR-BALANCE - SV005-TRANS-AMT              12800055
112400     PERFORM SV005-C425-GET-CASH-BACK-VALUE                       12810055
112500     IF SV005-PGM-ABEND                                           12820055
112600         CONTINUE                                                 12830055
112700     ELSE                                                         12840055
112800         IF (SV005-PV-REMAINING-BALANCE > 0)                      12850055
112900         AND (SV005-PV-REMAINING-BALANCE <=                       12860055
113000              SV005-AP-MAX-CSH-BCK-AMT)                           12870055
113100              MOVE SV005-PV-CURR-BALANCE                          12880055
113200                  TO SV005-APPROVED-TENDER-AMT                    12890055
113300              SET SV005-APPROVE TO TRUE                           12900055
113400              MOVE ZERO TO SV005-KMC-REMAINING-BALANCE            12910055
113500              PERFORM SV005-Z100-GET-APPROVAL-NUMBER              12920055
113600         ELSE                                                     12930055
113700              PERFORM SV005-C450-COMPARE-BALANCES                 12940055
113800         END-IF                                                   12950055
113900     END-IF.                                                      12960055
114000                                                                  12970055
114100******************************************************************12980055
114200*     SV005-C425-GET-CASH-BACK-VALUE                             *12990055
114300* ==> PROCESSES:                                                 *13000055
114400*      - PERFORM THE READ TO GET THE CASH BACK VALUE             *13010055
114500* ==> PERFORMED FROM: SV005-C410-PROCESS-REMAIN-BAL              *13020055
114600******************************************************************13030055
114700 SV005-C425-GET-CASH-BACK-VALUE.                                  13040055
114800     MOVE SV005-STORE-NBR              TO SV005-PV-STORE-NUMBER   13050055
114900                                          SV005-PV-TSQ-STORE.     13060055
115000     INITIALIZE SV005-PV-RETRY-COUNT.                             13070055
115100     PERFORM SV005-G100-READ-AUTH-PARMS                           13080055
115200         WITH TEST AFTER                                          13090055
115300             UNTIL (((SV005-PV-CICS-RESPONSE                      13100055
115400                                       NOT = DFHRESP(QIDERR))     13110055
115500                   AND (SV005-PV-TSQ-STORE                        13120055
115600                                       = SV005-AP-STORE-NUMBER))  13130055
115700                   OR (SV005-PV-RETRY-COUNT                       13140055
115800                            > SV005-PC-MAXIMUM-RETRY-COUNT)).     13150055
115900     IF SV005-PV-CICS-RESPONSE = DFHRESP (QIDERR)                 13160055
116000******************************************************************13170055
116100*  READ THE AUTH PARM TSQ - ACCESS FAILED ON RETRIES             *13180055
116200*  REBUILD NOT COMPLETED                                         *13190055
116300******************************************************************13200055
116400         PERFORM SV005-Z200-RETURN-FOR-ABEND                      13210055
116500         MOVE SV005-PC-PROC-NAME       TO SV005-AM-PROC-NAME      13220055
116600         MOVE 'LOGIC'                  TO SV005-AM-TYPE-OF-ABEND  13230055
116700         MOVE 'SV005-C425-GET-CASH-BACK-VALUE'                    13240055
116800                                       TO SV005-AM-PARAGRAPH-NAME 13250055
116900         MOVE SV005-AM-MESSAGE-LINE-1  TO SV005-MESSAGE-1         13260055
117000         MOVE SV005-PV-CICS-RESPONSE   TO SV005-TS-CICS-RESPONSE  13270055
117100         MOVE SV005-AP-QUEUE-NAME      TO SV005-TS-QUEUE-NAME     13280055
117200         MOVE SV005-PV-STORE-NUMBER    TO SV005-TS-ITEM-NUMBER    13290055
117300         MOVE SV005-TS-TEMP-STORAGE-ERR-MSG                       13300055
117400                                       TO SV005-MESSAGE-2         13310055
117500     ELSE                                                         13320055
117600         IF SV005-STORE-NBR NOT = SV005-AP-STORE-NUMBER           13330055
117700******************************************************************13340055
117800*   READ THE AUTH PARM TSQ - SEQUENCE ERROR                      *13350055
117900*   READ - DELETE/REBUILD FAILED ON RETRIES                      *13360055
118000******************************************************************13370055
118100             PERFORM SV005-Z200-RETURN-FOR-ABEND                  13380055
118200             MOVE SV005-PC-PROC-NAME   TO SV005-AM-PROC-NAME      13390055
118300             MOVE 'LOGIC'              TO SV005-AM-TYPE-OF-ABEND  13400055
118400             MOVE 'SV005-C425-GET-CASH-BACK-VALUE'                13410055
118500                                       TO SV005-AM-PARAGRAPH-NAME 13420055
118600             MOVE SV005-AM-MESSAGE-LINE-1                         13430055
118700                                       TO SV005-MESSAGE-1         13440055
118800             MOVE SV005-PV-CICS-RESPONSE                          13450055
118900                                       TO SV005-TS-CICS-RESPONSE  13460055
119000             MOVE SV005-AP-QUEUE-NAME  TO SV005-TS-QUEUE-NAME     13470055
119100             MOVE SV005-PV-STORE-NUMBER                           13480055
119200                                       TO SV005-TS-ITEM-NUMBER    13490055
119300             MOVE SV005-TS-TEMP-STORAGE-ERR-MSG                   13500055
119400                                       TO SV005-MESSAGE-2         13510055
119500         END-IF                                                   13520055
119600     END-IF.                                                      13530055
119700******************************************************************13540055
119800*     SV005-C450-COMPARE-BALANCES                                *13550055
119900* ==> PROCESSES:                                                 *13560055
120000*     -PERFORMED WHEN COMING FROM RDKCS023 AUDIT FUNCTION        *13570055
120100*      OR WHEN THE REMAINING BALANCE ON THE KMC CARD IS LESS THAN*13580055
120200*      OR EQUAL TO THE TRANSACTION AMOUNT                        *13590055
120300*     -IF THE CURRENT BALANCE IS LESS THAN OR EQUAL TO ZERO, THE *13600055
120400*      TENDER OF THE CARD IS REFERRED                            *13610055
120500*     -IF THE CURRENT BALANCE IS LESS THAN THE TRANSACTION AMOUNT*13620055
120600*      THE TENDER IS APPROVED FOR THE CURRENT BALANCE            *13630055
120700*     -IF THE CURRENT BALANCE IS EQUAL TO THE TRANSACTION AMOUNT *13640055
120800*      THE TENDER IS APPROVED FOR THE TRANSACTION AMOUNT         *13650055
120900* ==> PERFORMED FROM: SV005-C400-DETERMINE-CASH-BACK             *13660055
121000******************************************************************13670055
121100                                                                  13680055
121200 SV005-C450-COMPARE-BALANCES.                                     13690055
121300                                                                  13700055
121400     IF (SV005-PV-CURR-BALANCE < ZERO) OR                         13710055
121500        (SV005-PV-CURR-BALANCE = ZERO)                            13720055
121600         SET SV005-REFERRAL      TO TRUE                          13730055
121700         MOVE ZERO               TO SV005-APPROVED-TENDER-AMT     13740055
121800         MOVE SV005-PV-CURR-BALANCE                               13750055
121900                                 TO SV005-KMC-REMAINING-BALANCE   13760055
122000         MOVE SV005-PC-ZERO-APPROVAL                              13770055
122100                                 TO SV005-KMC-APPROVAL-NBR        13780055
122200     ELSE                                                         13790055
122300         IF SV005-PV-CURR-BALANCE < SV005-TRANS-AMT               13800055
122400             SET SV005-APPROVE   TO TRUE                          13810055
122500             MOVE SV005-PV-CURR-BALANCE                           13820055
122600                                 TO SV005-APPROVED-TENDER-AMT     13830055
122700             MOVE ZERO           TO SV005-KMC-REMAINING-BALANCE   13840055
122800             PERFORM SV005-Z100-GET-APPROVAL-NUMBER               13850055
122900         ELSE                                                     13860055
123000             SET SV005-APPROVE   TO TRUE                          13870055
123100             MOVE SV005-TRANS-AMT                                 13880055
123200                                 TO SV005-APPROVED-TENDER-AMT     13890055
123300             COMPUTE SV005-KMC-REMAINING-BALANCE =                13900055
123400                 SV005-PV-CURR-BALANCE - SV005-TRANS-AMT          13910055
123500             PERFORM SV005-Z100-GET-APPROVAL-NUMBER               13920055
123600         END-IF                                                   13930055
123700     END-IF.                                                      13940055
123800                                                                  13950055
123900******************************************************************13960055
124000*     SV005-C500-NORM-TRANS-CHECK                                *13970055
124100* ==> PROCESSES:                                                 *13980055
124200*     -GETS THE CURRENT DATE FOR COMPARISON TO THE POS DATE      *13990055
124300*     -THE REVERSAL CODE IS SET TO ZERO FOR NORMAL               *14000055
124400*     -THE TRANSACTION AMOUNT IS MULTIPLIED BY NEGATIVE 1 FOR    *14010055
124500*      TENDER ACTIVITY, SO THAT THE NORMAL TRANSACTION AMOUNT CAN*14020055
124600*      BE FOUND ON THE SVT_KOHLS_CRD_TXN TABLE                   *14030055
124700*     -CHECKS THE KMC ACTIVITY TABLE FOR THE "NORMAL" TRANSACTION*14040055
124800*      ADDING 1 DAY TO THE POS DATE UNTIL THE TRANSACTION IS     *14050055
124900*      FOUND OR THE NUMBER OF INCREMENTATION IS GREATER THAN THE *14060055
125000*      CONSTANT SET IN WORKING STORAGE                           *14070055
125100*     -IF THE "NORMAL" TRANSACTION IS FOUND, THE REVERSAL IS     *14080055
125200*      APPROVED                                                  *14090055
125300*     -IF THE "NORMAL" TRANSACTION ISN'T FOUND, THE REVERSAL IS  *14100055
125400*      REFERRED                                                  *14110055
125500* ==> PERFORMED FROM: SV005-B400-REVERSE-TRANS                   *14120055
125600******************************************************************14130055
125700 SV005-C500-NORM-TRANS-CHECK.                                     14140055
125800                                                                  14150055
125900     MOVE SV005-POS-DATE TO SV005-PV-POS-DATE.                    14160055
126000                                                                  14170055
126100     PERFORM SV005-D200-GET-CURRENT-DATE.                         14180055
126200                                                                  14190055
126300     IF SV005-PGM-ABEND                                           14200055
126400         CONTINUE                                                 14210055
126500     ELSE                                                         14220055
126600         MOVE ZERO       TO SVT00002-TRN-RVRSL-CDE                14230055
126700         IF SV005-ISSUE                                           14240055
126800         OR SV005-ISSUE-GIFT-CRD                                  14250055
126900             MOVE SV005-TRANS-AMT TO SVT00002-APP-AUTH-AMT        14260055
127000         END-IF                                                   14270055
127100         IF SV005-TENDER                                          14280055
127200             COMPUTE SVT00002-APP-AUTH-AMT =                      14290055
127300                 SV005-PC-MINUS-ONE * SV005-TRANS-AMT             14300055
127400         END-IF                                                   14310055
127500         MOVE SV005-TERMINAL-NBR TO SVT00002-POS-TRMNL-NBR        14320055
127600         MOVE SV005-TRANSACTION-NBR TO SVT00002-POS-TRN-NBR       14330055
                                                                        14340055
127601*  DEACT REVERSAL MATCH A DEACT.  A DEACT HAS A NEG AMT ON DATABAS14350055
                                                                        14360055
               IF (SV005-PV-FROM-AUKCS521) AND                          14370055
                  (SV005-DEACT-REV)                                     14380055
127200             COMPUTE SVT00002-APP-AUTH-AMT =                      14390055
127300                 SV005-PC-MINUS-ONE * SV005-TRANS-AMT             14400055
               END-IF                                                   14410055
                                                                        14420055
BARB  *  ADDED THIS FOR THE BOPUS PROJECT.  NEED TO GET THE DATE OF     14430055
BARB  *  THE ROW THAT HAS THAT STR, TERM, TRAN TO REVERSE.              14440055
BARB           IF SV005-PV-FROM-EPKCS209 AND                            14450055
BARB              SV005-TENDER AND                                      14460055
BARB              SV005-REVERSAL-REAUTH                                 14470055
BARB                 PERFORM SV005-D115-CHECK-REVERSAL-TRAN             14480055
BARB           END-IF                                                   14490055
127601*  THIS LOGIC ADDED AS A WORK-AROUND FOR THE POS PROBLEM WITH     14500055
127602*  VOIDS.  THE AUTH AMOUNT IN THE REVERSAL IS NOT THE SAME AS     14510055
127603*  THE ORIGINAL.                                                  14520055
127610         IF (SV005-PV-FROM-EPKCS209)                              14530055
127620            AND SV005-TENDER                                      14540055
BARB              AND NOT SV005-REVERSAL-REAUTH                         14550055
127700             PERFORM SV005-D110-CHECK-NORMAL-TRANS                14560055
127800                 VARYING SV005-PV-DATE-COUNTER FROM 1 BY 1        14570055
127900                 UNTIL SV005-PS-NORMAL-TRANS-FOUND                14580055
128000                  OR SV005-PV-POS-DATE > SV005-PV-CURRENT-DATE    14590055
128100                  OR SV005-PV-DATE-COUNTER >                      14600055
128200                     SV005-PC-TOT-DAYS-INCREMENT                  14610055
128300                  OR SV005-PGM-ABEND                              14620055
128301         ELSE                                                     14630055
127610           IF (SV005-PV-FROM-AUKCS521)                            14640055
127620              IF (SV005-DEACTIVATION)                             14650055
029500                 PERFORM SV005-E100-CALC-CURR-BALANCE             14660055
029600                IF SV005-PGM-ABEND                                14670055
                         CONTINUE                                       14680055
                      ELSE                                              14690055
                         MOVE SV005-TRANS-AMT TO SVT00002-APP-AUTH-AMT  14700055
127700                   PERFORM SV005-D120-CHECK-DEACT-TRANS           14710055
127800                      VARYING SV005-PV-DATE-COUNTER FROM 1 BY 1   14720055
127900                   UNTIL SV005-PS-NORMAL-TRANS-FOUND              14730055
128100                      OR SV005-HARD-DECLINE                       14740055
128300                     OR SV005-PGM-ABEND                           14750055
128350                    OR SV005-PV-DATE-COUNTER >                    14760055
128360                       SV005-PC-TOT-DAYS-INCREMENT                14770055
                      END-IF                                            14780055
127620              ELSE                                                14790055
127700                   PERFORM SV005-D130-CHECK-DEACTREV              14800055
127800                      VARYING SV005-PV-DATE-COUNTER FROM 1 BY 1   14810055
127900                   UNTIL SV005-PS-NORMAL-TRANS-FOUND              14820055
128100                      OR SV005-HARD-DECLINE                       14830055
128300                     OR SV005-PGM-ABEND                           14840055
128350                    OR SV005-PV-DATE-COUNTER >                    14850055
128360                       SV005-PC-TOT-DAYS-INCREMENT                14860055
127620              END-IF                                              14870055
127610           ELSE                                                   14880055
128310             PERFORM SV005-D100-CHECK-NORMAL-TRANS                14890055
128320                 VARYING SV005-PV-DATE-COUNTER FROM 1 BY 1        14900055
128330                 UNTIL SV005-PS-NORMAL-TRANS-FOUND                14910055
128340                    OR SV005-PV-POS-DATE > SV005-PV-CURRENT-DATE  14920055
128350                    OR SV005-PV-DATE-COUNTER >                    14930055
128360                       SV005-PC-TOT-DAYS-INCREMENT                14940055
128370                    OR SV005-PGM-ABEND                            14950055
127610           END-IF                                                 14960055
128380         END-IF                                                   14970055
128400     END-IF.                                                      14980055
128500                                                                  14990055
128600     IF SV005-PGM-ABEND                                           15000055
128700         CONTINUE                                                 15010055
128800     ELSE                                                         15020055
              IF (((SV005-PV-FROM-AUKCS521) OR                          15030055
                 (SV005-PV-FROM-AUKCS507)) AND                          15040055
                 (SV005-HARD-DECLINE))                                  15050055
129100             MOVE ZEROES           TO SV005-APPROVED-TENDER-AMT   15060055
129200                                      SV005-KMC-REMAINING-BALANCE 15070055
129300             MOVE SV005-PC-ZERO-APPROVAL TO SV005-KMC-APPROVAL-NBR15080055
              ELSE                                                      15090055
128900          IF SV005-PS-NORM-TRANS-NOT-FOUND                        15100055
129000             SET SV005-REFERRAL    TO TRUE                        15110055
129100             MOVE ZEROES           TO SV005-APPROVED-TENDER-AMT   15120055
129200                                      SV005-KMC-REMAINING-BALANCE 15130055
129300             MOVE SV005-PC-ZERO-APPROVAL TO SV005-KMC-APPROVAL-NBR15140055
129400          END-IF                                                  15150055
              END-IF                                                    15160055
129500     END-IF.                                                      15170055
129600                                                                  15180055
129700******************************************************************15190055
129800*     SV005-C600-DUP-CHECK                                       *15200055
129900* ==> PROCESSES:                                                 *15210055
130000*     -GETS THE CURRENT DATE FOR COMPARISON TO THE POS DATE      *15220055
130100*     -THE TRANSACTION AMOUNT IS MULTIPLIED BY NEGATIVE 1 FOR    *15230055
130200*      TENDER ACTIVITY, SO THAT THE NORMAL TRANSACTION AMOUNT CAN*15240055
130300*      BE FOUND ON THE SVT_KOHLS_CRD_TXN TABLE                   *15250055
130400*     -CHECKS THE KMC ACTIVITY TABLE FOR DUPLICATE TRANSACTIONS, *15260055
130500*      ADDING 1 DAY TO THE POS DATE UNTIL THE TRANSACTION IS     *15270055
130600*      FOUND OR THE NUMBER OF INCREMENTATION IS GREATER THAN THE *15280055
130700*      CONSTANT SET IN WORKING STORAGE                           *15290055
130800*     -IF A DUPLICATE IS FOUND, THE DUPLICATE FLAG IS SET SO     *15300055
130900*      THE PROGRAM THAT CALLS THIS MODULE DOES NOT UPDATE THE    *15310055
131000*      ACTIVITY TABLE                                            *15320055
131100* ==> PERFORMED FROM: SV005-B300-NORMAL-TENDER                   *15330055
131200*                     SV005-B400-REVERSE-TRANS                   *15340055
131300******************************************************************15350055
131400 SV005-C600-DUP-CHECK.                                            15360055
131500                                                                  15370055
131600     MOVE SV005-POS-DATE TO SV005-PV-POS-DATE.                    15380055
131700                                                                  15390055
131800     PERFORM SV005-D200-GET-CURRENT-DATE.                         15400055
131900                                                                  15410055
132000     IF SV005-PGM-ABEND                                           15420055
132100         CONTINUE                                                 15430055
132200     ELSE                                                         15440055
132300         IF SV005-ISSUE                                           15450055
132400         OR SV005-ISSUE-GIFT-CRD                                  15460055
132500             IF SV005-NORMAL                                      15470055
132600                 MOVE SV005-TRANS-AMT TO SVT00002-APP-AUTH-AMT    15480055
132700             END-IF                                               15490055
132800             IF SV005-REVERSAL                                    15500055
132900                 MOVE SV005-REVERSAL-AMT TO SVT00002-APP-AUTH-AMT 15510055
133000             END-IF                                               15520055
133100         END-IF                                                   15530055
133200         IF SV005-TENDER                                          15540055
133300             IF SV005-NORMAL                                      15550055
133400                 COMPUTE SVT00002-APP-AUTH-AMT =                  15560055
133500                     SV005-PC-MINUS-ONE * SV005-TRANS-AMT         15570055
133600             END-IF                                               15580055
133700             IF SV005-REVERSAL OR                                 15590055
133700                SV005-REAUTH OR SV005-REVERSAL-REAUTH             15600055
133800                 MOVE SV005-REVERSAL-AMT TO SVT00002-APP-AUTH-AMT 15610055
133900             END-IF                                               15620055
134000         END-IF                                                   15630055
134100         MOVE SV005-TERMINAL-NBR TO SVT00002-POS-TRMNL-NBR        15640055
134200         MOVE SV005-TRANSACTION-NBR TO SVT00002-POS-TRN-NBR       15650055
                                                                        15660055
134300           PERFORM SV005-D300-LOOK-FOR-DUPLICATE                  15670055
134400             VARYING SV005-PV-DATE-COUNTER FROM 1 BY 1            15680055
134500             UNTIL SV005-PS-DUPLICATE-FOUND                       15690055
134600                OR SV005-PV-POS-DATE > SV005-PV-CURRENT-DATE      15700055
134700                OR SV005-PV-DATE-COUNTER >                        15710055
134800                       SV005-PC-TOT-DAYS-INCREMENT                15720055
134900                OR SV005-PGM-ABEND                                15730055
                                                                        15740055
135000     END-IF.                                                      15750055
135100                                                                  15760055
135200******************************************************************15770055
135300*     SV005-C700-SAFEWAY-CHECKS                                  *15780055
135400* ==> PROCESSES:                                                 *15790055
135500*     - PERFORM CHECKS THAT ARE SPECIFIC TO GIFT CARD SALES AT   *15800055
135600*       SAFEWAY STORES                                           *15810055
135700* ==> PERFORMED FROM: SV005-B200-NORMAL-ISSUE                    *15820055
135800******************************************************************15830055
135900                                                                  15840055
136000 SV005-C700-SAFEWAY-CHECKS.                                       15850055
136100                                                                  15860055
136200* SAFEWAY PRE-DENOMINATED CARD ISSUANCE TRANSACTION AMOUNTS       15870055
136300* MUST MATCH THE PRE-DENOMINATED CARD VALUE.                      15880055
136300* FOR SAFEWAY WE CAN NOW ADD ON ANY AMOUNT TO PRE-DENOM CARDS     15890055
           IF (SV005-PS-ADD-ON)                                         15900055
      * ANY ACTIVATION AND RELOAD MUST BE A MINIMUM OF $5.00            15910055
      * IF THE CARD IS JUST AN ACTIVATION AND NOT A RELOAD WE           15920055
      * WILL DECLINE THIS TRANSACTION.  RELOADS CAN ONLY BE DONE        15930055
      * FROM GO WALLET WHICH IS POS ENTRY = 4.  ACTIVATIONS ARE DONE    15940055
      * THROUGH THE POS, NOT GO WALLET.                                 15950055
                                                                        15960055
     *** THE MINIMUM TRANSACTION AMOUNT MUST BE > 5.00 AND CANNOT BE    15970055
     *** < $500.00                                                      15980055
               IF  (SV005-TRANS-AMT >= SV005-PC-MIN-TRANS-AMT) AND      15990055
                   (SV005-TRANS-AMT <= SV005-PC-MAX-TRANS-AMT)          16000055
                    CONTINUE                                            16010055
               ELSE                                                     16020055
                  SET SV005-PS-DECLINE TO TRUE                          16030055
083500            SET SV005-TRAN-DLR-OVER-LIM-ADD-ON TO TRUE            16040055
               END-IF                                                   16050055
           ELSE                                                         16060055
      ***** SAFEWAY CANNOT ACTIVATE VARIABLE LOADS CRD = 0              16070055
      ***** AND IF IT IS DENOMINATED CARD THEN THE CRD AMOUNT = THE     16080055
      ***** TRAN AMOUNT.                                                16090055
      ****  SAFEWAY CANNOT RELOAD CARDS THAT ARE NOT ACTIVE             16100055
             IF (SV005-VALID-RELOAD)                                    16110055
                SET SV005-PS-DECLINE TO TRUE                            16120055
                SET SV005-CARD-STAT-INV-ISSUE TO TRUE                   16130055
151800*      ELSE                                                       16140055
136400* SAFEWAY CAN NOW ISSUE PREDENOMINATED CARDS SO THIS CODE WAS     16150055
136400* COMMENTED OUT SINCE IT'S NOT VALID ANYMORE.                     16160055
136400*        IF SVT00000-PRE-DNNTD-CRD-AMT = ZERO                     16170055
136500*         OR (SVT00000-PRE-DNNTD-CRD-AMT NOT =                    16180055
136600*                               SV005-TRANS-AMT)                  16190055
136700*            SET SV005-PS-DECLINE TO TRUE                         16200055
083500*            SET SV005-TRAN-DLR-OVER-LIM-ADD-ON TO TRUE           16210055
136800*        END-IF                                                   16220055
151800       END-IF                                                     16230055
136800     END-IF.                                                      16240055
136900                                                                  16250055
137000* IF THERE HAS ALREADY BEEN AN ISSUE RECORD FOR THIS CARD         16260055
137200* BUT WILL CHECK IF THIS TRANSACTION IS A DUPLICATE.              16270055
137300* IT IS POSSIBLE THAT THE TRANSACTION WAS                         16280055
137400* APPROVED BUT SAFEWAY DID NOT GET THE RESPONSE AND IS            16290055
137500* SENDING AN IDENTICAL STORE-AND-FORWARD TRANSACTION LATER.       16300055
137600* AUKCS007 WILL CHECK THE DUPLICATE FLAG AND SEND THE             16310055
137700* APPROPRIATE DECLINE RESPONSE CODE FOR DUPLICATE TRANSACTION.    16320055
137800     IF SV005-PS-DECLINE                                          16330055
137900        CONTINUE                                                  16340055
138000     ELSE                                                         16350055
138100         IF SV005-PS-ADD-ON                                       16360055
138200            PERFORM SV005-C600-DUP-CHECK                          16370055
138300                                                                  16380055
138400* HAVE TO SET DECLINE IF DUPLICATE FOUND                          16390055
138700* SAFEWAY GIFT CARD SALES CAN BE ADD-ON TRANSACTIONS.             16400055
                 IF (SV005-PS-DUPLICATE-FOUND)                          16410055
138800                 SET SV005-PS-DECLINE TO TRUE                     16420055
138900                 SET SV005-HARD-DECLINE TO TRUE                   16430055
                 ELSE                                                   16440055
                   IF (SV005-NO-VALID-RELOAD)                           16450055
138800                 SET SV005-PS-DECLINE TO TRUE                     16460055
138900                 SET SV005-HARD-DECLINE TO TRUE                   16470055
                   END-IF                                               16480055
                 END-IF                                                 16490055
139000         END-IF                                                   16500055
139100     END-IF.                                                      16510055
139200                                                                  16520055
139200                                                                  16530055
135200******************************************************************16540055
135300*     SV005-C800-INCOMM-CHECKS                                   *16550055
135400* ==> PROCESSES:                                                 *16560055
135500*     - PERFORM CHECKS THAT ARE SPECIFIC TO GIFT CARD SALES AT   *16570055
135600*       THE INCOMM PROCESSOR                                     *16580055
135700* ==> PERFORMED FROM: SV005-B200-NORMAL-ISSUE                    *16590055
135800******************************************************************16600055
135900                                                                  16610055
    00 SV005-C800-INCOMM-CHECKS.                                        16620055
136100*----------------------------------------------------------       16630055
136200* INCOMM  PRE-DENOMINATED CARD ISSUANCE TRANSACTION AMOUNTS       16640055
136300* MUST MATCH THE PRE-DENOMINATED CARD VALUE.                      16650055
      *                                                                 16660055
136200* INCOMM  VAR-DENOMINATED CARD ISSUANCE TRANSACTION AMOUNTS       16670055
136300* MUST HAVE A MINIMUM DOLLAR AMOUNT OF 5 AND MAX TRAN AMOUNT      16680055
      * LESS THEN OR $500.00.                                           16690055
136100*----------------------------------------------------------       16700055
136400     IF (SVT00000-PRE-DNNTD-CRD-AMT >  ZERO)                      16710055
136500       AND (SVT00000-PRE-DNNTD-CRD-AMT NOT =                      16720055
136600                                SV005-TRANS-AMT)                  16730055
136700             SET SV005-PS-DECLINE TO TRUE                         16740055
136700             SET SV005-CARD-PRE-DENOM-ADD-ON TO TRUE              16750055
           ELSE                                                         16760055
136400       IF (SVT00000-PRE-DNNTD-CRD-AMT =  ZERO) AND                16770055
                (SV005-TRANS-AMT < SV005-PC-MIN-TRANS-AMT)              16780055
136700             SET SV005-PS-DECLINE TO TRUE                         16790055
136700             SET SV005-CARD-PRE-DENOM-ADD-ON TO TRUE              16800055
136400       END-IF                                                     16810055
136800     END-IF.                                                      16820055
136900                                                                  16830055
137800     IF SV005-PS-DECLINE                                          16840055
137900        CONTINUE                                                  16850055
138000     ELSE                                                         16860055
138100      IF SV005-PS-ADD-ON                                          16870055
               PERFORM SV005-I360-INCOMM-SET-VALUES                     16880055
                IF (SV005-PS-DUPLICATE-FOUND) OR                        16890055
                   (SV005-HARD-DECLINE) OR                              16900055
                   (SV005-PGM-ABEND)                                    16910055
138800               SET SV005-PS-DECLINE TO TRUE                       16920055
138900               SET SV005-HARD-DECLINE TO TRUE                     16930055
                     SET SV005-TRAN-DAY-OVER-LIM-ADD-ON TO TRUE         16940055
                     SET SV005-PS-DUPLICATE-NOT-FOUND  TO TRUE          16950055
                END-IF                                                  16960055
            END-IF                                                      16970055
139100     END-IF.                                                      16980055
139200                                                                  16990055
139300******************************************************************17000055
139400*     SV005-D100-CHECK-NORMAL-TRANS                              *17010055
139500* ==> PROCESSES:                                                 *17020055
139600*     -SELECTS THE CORRESPONDING "NORMAL" TRANSACTION FOR THE    *17030055
139700*      REVERSAL FROM THE KMC ACTIVITY TABLE                      *17040055
139800*   -8/11/2003 - ADDED TRN_VOID_IND BECAUSE YOU SHOULD ONLY      *17050055
139900*                LOOK FOR NON-VOIDED TRANSACTIONS                *17060055
140000*              - ADDED STATE CODE, TO RETURN TO AUTH PROGRAM     *17070055
140100* ==> PERFORMED FROM: SV005-C500-NORM-TRANS-CHECK                *17080055
140200******************************************************************17090055
140300 SV005-D100-CHECK-NORMAL-TRANS.                                   17100055
140400                                                                  17110055
140500     EXEC SQL                                                     17120055
140600         SELECT  CRD_NBR,                                         17130055
140700                 ST_CDE                                           17140055
140800           INTO  :SVT00002-CRD-NBR,                               17150055
140900                 :SVT00002-ST-CDE                                 17160055
141000           FROM  SVT_KOHLS_CRD_TXN                                17170055
141100          WHERE  CRD_NBR          = :SV005-KMC-ID                 17180055
141200            AND  TRN_RVRSL_CDE    = :SVT00002-TRN-RVRSL-CDE       17190055
141300            AND  TRN_VOID_IND     = :SV005-PC-NOT-VOID            17200055
141400            AND  ACTVY_TYP_CDE    = :SV005-ACTIVITY-TYPE          17210055
141500            AND  POS_DTE          = :SV005-PV-POS-DATE            17220055
141600            AND  STR_NBR          = :SV005-STORE-NBR              17230055
141700            AND  POS_TRMNL_NBR    = :SVT00002-POS-TRMNL-NBR       17240055
141800            AND  POS_TRN_NBR      = :SVT00002-POS-TRN-NBR         17250055
141900            AND  APP_AUTH_AMT     = :SVT00002-APP-AUTH-AMT        17260055
142000     END-EXEC.                                                    17270055
142100                                                                  17280055
142200     EVALUATE TRUE                                                17290055
142300         WHEN SQLCODE = 0                                         17300055
142400             SET SV005-PS-NORMAL-TRANS-FOUND                      17310055
142500                                     TO TRUE                      17320055
142600             SET SV005-APPROVE       TO TRUE                      17330055
142700             MOVE SVT00002-ST-CDE    TO SV005-VOID-STATE-CD       17340055
142800             MOVE SV005-TRANS-AMT    TO SV005-APPROVED-TENDER-AMT 17350055
142900             PERFORM SV005-E100-CALC-CURR-BALANCE                 17360055
143000             IF SV005-ISSUE                                       17370055
143100             OR SV005-ISSUE-GIFT-CRD                              17380055
143200                 COMPUTE SV005-KMC-REMAINING-BALANCE =            17390055
143300                         SV005-PV-CURR-BALANCE - SV005-TRANS-AMT  17400055
                                                                        17410055
      *** THIS CHECK IS DONE SO THAT IF THEY TRY TO REVERSE AFTER THEY  17420055
      *** SPENT MORE THEN WHAT IS LEFT ON THE CARD, THEY WILL NOT.      17430055
                                                                        17440055
                       IF (SV005-PV-FROM-AUKCS507) AND                  17450055
                          (SV005-KMC-REMAINING-BALANCE < 0)             17460055
071900                    SET SV005-HARD-DECLINE TO TRUE                17470055
143900                 ELSE                                             17480055
143900                    PERFORM SV005-Z100-GET-APPROVAL-NUMBER        17490055
143400                 END-IF                                           17500055
                   END-IF                                               17510055
                                                                        17520055
143500             IF SV005-TENDER                                      17530055
143600                 COMPUTE SV005-KMC-REMAINING-BALANCE =            17540055
143700                         SV005-PV-CURR-BALANCE + SV005-TRANS-AMT  17550055
143900                 PERFORM SV005-Z100-GET-APPROVAL-NUMBER           17560055
143800             END-IF                                               17570055
                                                                        17580055
144000                                                                  17590055
144100         WHEN SQLCODE = +100                                      17600055
146037             PERFORM SV005-E200-ADD-DAY-POS-DATE                  17610055
144300                                                                  17620055
144400         WHEN OTHER                                               17630055
144500                                                                  17640055
144600             PERFORM SV005-Z200-RETURN-FOR-ABEND                  17650055
144700             MOVE SV005-PC-PROC-NAME                              17660055
144800                                       TO SV005-AM-PROC-NAME      17670055
144900             MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  17680055
145000             MOVE 'SV005-D100-CHECK-NORMAL-TRANS'                 17690055
145100                                       TO SV005-AM-PARAGRAPH-NAME 17700055
145200             MOVE SV005-AM-MESSAGE-LINE-1                         17710055
145300                                       TO SV005-MESSAGE-1         17720055
145400             MOVE SQLCODE              TO SV005-AM-SQLCODE        17730055
145500             MOVE SV005-AM-SELECT-CRD-TXN TO SV005-AM-TABLE-INFO  17740055
145600             MOVE SV005-AM-SQL-MESSAGE-LINE-2                     17750055
145700                                       TO SV005-MESSAGE-2         17760055
145800     END-EVALUATE.                                                17770055
145900                                                                  17780055
145910******************************************************************17790055
145920*     SV005-D110-CHECK-NORMAL-TRANS                              *17800055
145930* ==> PROCESSES:                                                 *17810055
145940*     -SELECTS THE CORRESPONDING "NORMAL" TRANSACTION FOR THE    *17820055
145950*      REVERSAL FROM THE KMC ACTIVITY TABLE                      *17830055
145960*   -8/14/2008 - THIS PARAGRAPH WAS ADDED AS A WORK-AROUND FOR   *17840055
145970*                A POS PROBLEM WHERE THE AMOUNT IN THE REVERSAL  *17850055
145980*                IS NOT THE SAME AS THE AMOUNT IN THE ORIGINAL.  *17860055
145990* ==> PERFORMED FROM: SV005-C500-NORM-TRANS-CHECK                *17870055
145991******************************************************************17880055
145992 SV005-D110-CHECK-NORMAL-TRANS.                                   17890055
145993                                                                  17900055
145994     EXEC SQL                                                     17910055
145995         SELECT  CRD_NBR                                          17920055
145996                ,ST_CDE                                           17930055
145997                ,APP_AUTH_AMT                                     17940055
145998           INTO  :SVT00002-CRD-NBR                                17950055
145999                ,:SVT00002-ST-CDE                                 17960055
146000                ,:SVT00002-APP-AUTH-AMT                           17970055
146001           FROM  SVT_KOHLS_CRD_TXN                                17980055
146002          WHERE  CRD_NBR          = :SV005-KMC-ID                 17990055
146003            AND  TRN_RVRSL_CDE    = :SVT00002-TRN-RVRSL-CDE       18000055
146004            AND  TRN_VOID_IND     = :SV005-PC-NOT-VOID            18010055
146005            AND  ACTVY_TYP_CDE    = :SV005-ACTIVITY-TYPE          18020055
146006            AND  POS_DTE          = :SV005-PV-POS-DATE            18030055
146007            AND  STR_NBR          = :SV005-STORE-NBR              18040055
146008            AND  POS_TRMNL_NBR    = :SVT00002-POS-TRMNL-NBR       18050055
146009            AND  POS_TRN_NBR      = :SVT00002-POS-TRN-NBR         18060055
146011     END-EXEC.                                                    18070055
146012                                                                  18080055
146013     EVALUATE TRUE                                                18090055
146014         WHEN SQLCODE = 0                                         18100055
146015             SET SV005-PS-NORMAL-TRANS-FOUND                      18110055
146016                                     TO TRUE                      18120055
146017             SET SV005-APPROVE       TO TRUE                      18130055
146018             MOVE SVT00002-ST-CDE    TO SV005-VOID-STATE-CD       18140055
146019             IF SVT00002-APP-AUTH-AMT = SV005-TRANS-AMT           18150055
146020                 CONTINUE                                         18160055
146021             ELSE                                                 18170055
146022                 DISPLAY 'TABLE AMT = ' SVT00002-APP-AUTH-AMT     18180055
146023                 DISPLAY 'AUTH AMT =  ' SV005-TRANS-AMT           18190055
146024             END-IF                                               18200055
146025             COMPUTE SV005-TRANS-AMT = SVT00002-APP-AUTH-AMT * -1 18210055
146026             MOVE SV005-TRANS-AMT    TO SV005-APPROVED-TENDER-AMT 18220055
146029                                        SV005-REVERSAL-AMT        18230055
146031             PERFORM SV005-E100-CALC-CURR-BALANCE                 18240055
146032             COMPUTE SV005-KMC-REMAINING-BALANCE =                18250055
146033                     SV005-PV-CURR-BALANCE + SV005-TRANS-AMT      18260055
146034             PERFORM SV005-Z100-GET-APPROVAL-NUMBER               18270055
146035                                                                  18280055
146036         WHEN SQLCODE = +100                                      18290055
146037             PERFORM SV005-E200-ADD-DAY-POS-DATE                  18300055
146039         WHEN OTHER                                               18310055
146040                                                                  18320055
146041             PERFORM SV005-Z200-RETURN-FOR-ABEND                  18330055
146042             MOVE SV005-PC-PROC-NAME                              18340055
146043                                       TO SV005-AM-PROC-NAME      18350055
146044             MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  18360055
146045             MOVE 'SV005-D100-CHECK-NORMAL-TRANS'                 18370055
146046                                       TO SV005-AM-PARAGRAPH-NAME 18380055
146047             MOVE SV005-AM-MESSAGE-LINE-1                         18390055
146048                                       TO SV005-MESSAGE-1         18400055
146049             MOVE SQLCODE              TO SV005-AM-SQLCODE        18410055
146050             MOVE SV005-AM-SELECT-CRD-TXN TO SV005-AM-TABLE-INFO  18420055
146051             MOVE SV005-AM-SQL-MESSAGE-LINE-2                     18430055
146052                                       TO SV005-MESSAGE-2         18440055
146053     END-EVALUATE.                                                18450055
146054                                                                  18460055
BARB  ******************************************************************18470055
BARB  *     SV005-D115-CHECK-REVERSAL-TRAN                             *18480055
BARB  * ==> PROCESSES:                                                 *18490055
BARB  *     -SELECTS THE CORRESPONDING "NORMAL" TRANSACTION FOR THE    *18500055
BARB  *      REVERSAL FROM THE KMC ACTIVITY TABLE                      *18510055
BARB  *  03/30/15 - THIS IS A COPY OF PARAGRAPH SV005-D110-CHECK-NORMAL*18520055
BARB  *  -TRANS EXCEPT THAT WE GET THE POS_DTE FROM THE TABLE FOR THAT *18530055
BARB  *  CARD, STR, TERM, TRAN.                                        *18540055
BARB  * ==> PERFORMED FROM: SV005-C500-NORM-TRANS-CHECK                *18550055
BARB  ******************************************************************18560055
BARB   SV005-D115-CHECK-REVERSAL-TRAN.                                  18570055
BARB                                                                    18580055
BARB       EXEC SQL                                                     18590055
BARB           SELECT  CRD_NBR                                          18600055
BARB                  ,ST_CDE                                           18610055
BARB                  ,APP_AUTH_AMT                                     18620055
BARB                  ,POS_DTE                                          18630055
BARB             INTO  :SVT00002-CRD-NBR                                18640055
BARB                  ,:SVT00002-ST-CDE                                 18650055
BARB                  ,:SVT00002-APP-AUTH-AMT                           18660055
BARB                  ,:SVT00002-POS-DTE                                18670055
BARB             FROM  SVT_KOHLS_CRD_TXN                                18680055
BARB            WHERE  CRD_NBR          = :SV005-KMC-ID                 18690055
BARB              AND  TRN_RVRSL_CDE    = :SVT00002-TRN-RVRSL-CDE       18700055
BARB              AND  TRN_VOID_IND     = :SV005-PC-NOT-VOID            18710055
BARB              AND  ACTVY_TYP_CDE    = :SV005-ACTIVITY-TYPE          18720055
BARB              AND  STR_NBR          = :SV005-STORE-NBR              18730055
BARB              AND  POS_TRMNL_NBR    = :SVT00002-POS-TRMNL-NBR       18740055
BARB              AND  POS_TRN_NBR      = :SVT00002-POS-TRN-NBR         18750055
BARB       END-EXEC.                                                    18760055
BARB                                                                    18770055
BARB       EVALUATE TRUE                                                18780055
BARB           WHEN SQLCODE = 0                                         18790055
BARB               SET SV005-PS-NORMAL-TRANS-FOUND                      18800055
BARB                                       TO TRUE                      18810055
BARB               SET SV005-APPROVE       TO TRUE                      18820055
BARB               MOVE SVT00002-ST-CDE    TO SV005-VOID-STATE-CD       18830055
BARB               COMPUTE SV005-TRANS-AMT = SVT00002-APP-AUTH-AMT * -1 18840055
BARB               MOVE SV005-TRANS-AMT    TO SV005-APPROVED-TENDER-AMT 18850055
BARB                                          SV005-REVERSAL-AMT        18860055
BARB               MOVE SVT00002-POS-DTE   TO SV005-PV-POS-DATE         18870055
BARB                                          SV005-POS-DATE            18880055
BARB               PERFORM SV005-E100-CALC-CURR-BALANCE                 18890055
BARB               COMPUTE SV005-KMC-REMAINING-BALANCE =                18900055
BARB                       SV005-PV-CURR-BALANCE + SV005-TRANS-AMT      18910055
BARB               PERFORM SV005-Z100-GET-APPROVAL-NUMBER               18920055
BARB                                                                    18930055
BARB           WHEN OTHER                                               18940055
BARB                                                                    18950055
BARB               PERFORM SV005-Z200-RETURN-FOR-ABEND                  18960055
BARB               MOVE SV005-PC-PROC-NAME                              18970055
BARB                                         TO SV005-AM-PROC-NAME      18980055
BARB               MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  18990055
BARB               MOVE 'SV005-D115-CHECK-NORMAL-TRANS'                 19000055
BARB                                         TO SV005-AM-PARAGRAPH-NAME 19010055
BARB               MOVE SV005-AM-MESSAGE-LINE-1                         19020055
BARB                                         TO SV005-MESSAGE-1         19030055
BARB               MOVE SQLCODE              TO SV005-AM-SQLCODE        19040055
BARB               MOVE SV005-AM-SELECT-CRD-TXN TO SV005-AM-TABLE-INFO  19050055
BARB               MOVE SV005-AM-SQL-MESSAGE-LINE-2                     19060055
BARB                                         TO SV005-MESSAGE-2         19070055
BARB               MOVE SV005-KMC-ID         TO SV005-AM-KMC-ID         19080055
BARB               MOVE SVT00002-TRN-RVRSL-CDE TO SV005-AM-TRN-RVRSL-CDE19090055
BARB               MOVE SV005-ACTIVITY-TYPE  TO SV005-AM-ACTIVITY-TYPE  19100055
BARB               MOVE SV005-STORE-NBR      TO SV005-AM-STR            19110055
BARB               MOVE SVT00002-POS-TRMNL-NBR TO SV005-AM-POS-TRMNL-NBR19120055
BARB               MOVE SVT00002-POS-TRN-NBR TO SV005-AM-POS-TRN-NBR    19130055
BARB               MOVE SV005-PC-NOT-VOID    TO SV005-AM-VOID           19140055
BARB               MOVE SV005-AM-SQL-MESSAGE-LINE-3                     19150055
BARB                                         TO SV005-MESSAGE-3         19160055
                   SET SV005-HARD-DECLINE TO TRUE                       19170055
                   SET SV005-PS-INACTIVE TO TRUE                        19180055
BARB       END-EVALUATE.                                                19190055
BARB                                                                    19200055
139300******************************************************************19210055
139400*     SV005-D120-CHECK-DEACT-TRANS                              * 19220055
139500* ==> PROCESSES:                                                 *19230055
139600*     -SELECTS THE CORRESPONDING "NORMAL" TRANSACTION FOR THE    *19240055
139700*      REVERSAL FROM THE KMC ACTIVITY TABLE                      *19250055
      *                                                                 19260055
      *     - THESE ARE THE VALUES THAT ARE BEING CHECKED FOR A VALID  *19270055
      *       DEACTIVATION.  LOOKING FOR AN ACTIVATED CARD.             19280055
      *                                                                 19290055
      *     - IF THE TRANSACTION IS A DEACTIVATION                     *19300055
      *          REVERSAL INDICATOR WILL BE 0                          *19310055
      *          VOID INDICATOR = N                                    *19320055
      *          APP-AUTH-AMT = POSITIVE AMOUNT                        *19330055
      *                                                                *19340055
140100* ==> PERFORMED FROM: SV005-C500-NORM-TRANS-CHECK                *19350055
140200******************************************************************19360055
140300 SV005-D120-CHECK-DEACT-TRANS.                                    19370055
140400                                                                  19380055
140500     EXEC SQL                                                     19390055
140600         SELECT  CRD_NBR,                                         19400055
                       POS_DTE,                                         19410055
140700                 ST_CDE                                           19420055
140800           INTO  :SVT00002-CRD-NBR,                               19430055
140900                 :SVT00002-POS-DTE,                               19440055
140900                 :SVT00002-ST-CDE                                 19450055
141000           FROM  SVT_KOHLS_CRD_TXN                                19460055
141100          WHERE  CRD_NBR          = :SV005-KMC-ID                 19470055
141200            AND  TRN_RVRSL_CDE    = :SVT00002-TRN-RVRSL-CDE       19480055
141300            AND  TRN_VOID_IND     = :SV005-PC-NOT-VOID            19490055
141400            AND  ACTVY_TYP_CDE    = :SV005-ACTIVITY-TYPE          19500055
141900            AND  APP_AUTH_AMT     = :SVT00002-APP-AUTH-AMT        19510055
142000     END-EXEC.                                                    19520055
142100                                                                  19530055
142200     EVALUATE TRUE                                                19540055
142300         WHEN SQLCODE = 0                                         19550055
142700             MOVE SVT00002-ST-CDE    TO SV005-VOID-STATE-CD       19560055
142800             MOVE SV005-TRANS-AMT    TO SV005-APPROVED-TENDER-AMT 19570055
142400             SET SV005-PS-NORMAL-TRANS-FOUND                      19580055
142500                                     TO TRUE                      19590055
                                                                        19600055
142900             IF SV005-KMC-ORIGINAL-BALANCE = SV005-TRANS-AMT      19610055
144200                PERFORM SV005-I250-ADD-30DAY-POS-DATE             19620055
                        IF SV005-VALID-DEACT                            19630055
142600                      SET SV005-APPROVE       TO TRUE             19640055
143900                      PERFORM SV005-Z100-GET-APPROVAL-NUMBER      19650055
                        ELSE                                            19660055
                          SET SV005-HARD-DECLINE TO TRUE                19670055
                        END-IF                                          19680055
143400             ELSE                                                 19690055
                       SET SV005-HARD-DECLINE TO TRUE                   19700055
143400             END-IF                                               19710055
144000                                                                  19720055
144100         WHEN SQLCODE = +100 OR -811                              19730055
                   SET SV005-HARD-DECLINE TO TRUE                       19740055
                   SET SV005-PS-INACTIVE TO TRUE                        19750055
144400         WHEN OTHER                                               19760055
144500                                                                  19770055
144600             PERFORM SV005-Z200-RETURN-FOR-ABEND                  19780055
144700             MOVE SV005-PC-PROC-NAME                              19790055
144800                                       TO SV005-AM-PROC-NAME      19800055
144900             MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  19810055
145000             MOVE 'SV005-D120-CHECK-DEACT-TRANS'                  19820055
145100                                       TO SV005-AM-PARAGRAPH-NAME 19830055
145200             MOVE SV005-AM-MESSAGE-LINE-1                         19840055
145300                                       TO SV005-MESSAGE-1         19850055
145400             MOVE SQLCODE              TO SV005-AM-SQLCODE        19860055
145500             MOVE SV005-AM-SELECT-CRD-TXN TO SV005-AM-TABLE-INFO  19870055
145600             MOVE SV005-AM-SQL-MESSAGE-LINE-2                     19880055
145700                                       TO SV005-MESSAGE-2         19890055
                   SET SV005-HARD-DECLINE TO TRUE                       19900055
                   SET SV005-PS-INACTIVE TO TRUE                        19910055
145800     END-EVALUATE.                                                19920055
145900                                                                  19930055
139300******************************************************************19940055
139400*     SV005-D130-CHECK-DEACTREV                                  *19950055
139500* ==> PROCESSES:                                                 *19960055
139600*     -SELECTS THE CORRESPONDING "NORMAL" TRANSACTION FOR THE    *19970055
139700*      REVERSAL FROM THE KMC ACTIVITY TABLE                      *19980055
140100* ==> PERFORMED FROM: SV005-C500-NORM-TRANS-CHECK                *19990055
      *                                                                 20000055
      *   - THE SV005-PV-TMST-DATE GETS FILLED IN THE AUKCS521 7900-    20010055
      *     PARAGRAPH.  IN THE 7900 WE LOOK FOR THE MATCHING STAN       20020055
      *     THE SYSTEM TRACE AUDIT NUMBER IS A UNIQUE TRANSACTION FOR   20030055
      **    INCOM.  SO EVERY REVERSAL MUST MATCH THE STAN.  IF THE      20040055
      **    STAN IS NOT FOUND IN THE 7900 THEN YOU WILL NEVER GET       20050055
      **    INTO THIS SVPD005 MODULE.                                   20060055
      *                                                                 20070055
      *     - THESE ARE THE VALUES THAT ARE BEING CHECKED FOR A VALID  *20080055
      *       TRANSACTION TO REVERSE.                                   20090055
      *                                                                 20100055
      *     - IF THE TRANSACTION IS A REVERSAL                         *20110055
      *          REVERSAL INDICATOR WILL BE 0                          *20120055
      *          VOID INDICATOR = N                                    *20130055
      *          APP-AUTH-AMT = POSITIVE AMOUNT                        *20140055
      *                                                                *20150055
      *     - IF THE TRANSACTION IS A DEACT REVERSAL                   *20160055
      *          REVERSAL INDICATOR WILL BE 0                          *20170055
      *          VOID INDICATOR = Y                                    *20180055
      *          APP-AUTH-AMT = NEGATIVE AMOUNT                        *20190055
      *                                                                *20200055
140200******************************************************************20210055
140300 SV005-D130-CHECK-DEACTREV.                                       20220055
                                                                        20230055
            IF  (SV005-DEACT-REV)                                       20240055
                   MOVE 'Y' TO SV005-PC-VOID-CHK                        20250055
                   MOVE 0 TO SVT00002-TRN-RVRSL-CDE                     20260055
            ELSE                                                        20270055
                   MOVE 'N' TO SV005-PC-VOID-CHK                        20280055
            END-IF.                                                     20290055
                                                                        20300055
140500     EXEC SQL                                                     20310055
140600         SELECT  CRD_NBR,                                         20320055
140700                 ST_CDE                                           20330055
140800           INTO  :SVT00002-CRD-NBR,                               20340055
140900                 :SVT00002-ST-CDE                                 20350055
141000           FROM  SVT_KOHLS_CRD_TXN                                20360055
141100          WHERE  CRD_NBR          = :SV005-KMC-ID                 20370055
                  AND  TRN_AUTH_TMST    = :SV005-PV-TMST-DATE           20380055
141200            AND  TRN_RVRSL_CDE    = :SVT00002-TRN-RVRSL-CDE       20390055
141300            AND  TRN_VOID_IND     = :SV005-PC-VOID-CHK            20400055
141400            AND  ACTVY_TYP_CDE    = :SV005-ACTIVITY-TYPE          20410055
141500            AND  POS_DTE          = :SV005-PV-POS-DATE            20420055
141600            AND  STR_NBR          = :SV005-STORE-NBR              20430055
141900            AND  APP_AUTH_AMT     = :SVT00002-APP-AUTH-AMT        20440055
142000     END-EXEC.                                                    20450055
142100                                                                  20460055
142200     EVALUATE TRUE                                                20470055
142300         WHEN SQLCODE = 0                                         20480055
142400             SET SV005-PS-NORMAL-TRANS-FOUND                      20490055
142500                                     TO TRUE                      20500055
142600             SET SV005-APPROVE       TO TRUE                      20510055
142700             MOVE SVT00002-ST-CDE    TO SV005-VOID-STATE-CD       20520055
142800             MOVE SV005-TRANS-AMT    TO SV005-APPROVED-TENDER-AMT 20530055
142900             PERFORM SV005-E100-CALC-CURR-BALANCE                 20540055
      **-----------------------------------------------------------**   20550055
      **  FOR DEACT REVERSALS WE NEED TO ADD THE TRAN AMOUNT TO THE     20560055
      **  BALANCE                                                       20570055
      **                                                                20580055
      **  FOR REVERSALS WE NEED TO SUBTRACT THE TRAN AMOUNT FROM THE    20590055
      **  BALANCE.                                                      20600055
      **-----------------------------------------------------------**   20610055
                   IF (SV005-DEACT-REV)                                 20620055
                      IF SV005-ISSUE                                    20630055
                      OR SV005-ISSUE-GIFT-CRD                           20640055
                          COMPUTE SV005-KMC-REMAINING-BALANCE =         20650055
                               SV005-PV-CURR-BALANCE + SV005-TRANS-AMT  20660055
                      END-IF                                            20670055
                                                                        20680055
                      IF SV005-TENDER                                   20690055
                          COMPUTE SV005-KMC-REMAINING-BALANCE =         20700055
                              SV005-PV-CURR-BALANCE - SV005-TRANS-AMT   20710055
                      END-IF                                            20720055
                   ELSE                                                 20730055
                      IF SV005-ISSUE                                    20740055
                      OR SV005-ISSUE-GIFT-CRD                           20750055
                          COMPUTE SV005-KMC-REMAINING-BALANCE =         20760055
                             SV005-PV-CURR-BALANCE - SV005-TRANS-AMT    20770055
                      END-IF                                            20780055
                                                                        20790055
                      IF SV005-TENDER                                   20800055
                          COMPUTE SV005-KMC-REMAINING-BALANCE =         20810055
                              SV005-PV-CURR-BALANCE + SV005-TRANS-AMT   20820055
                      END-IF                                            20830055
                   END-IF                                               20840055
                                                                        20850055
                   PERFORM SV005-Z100-GET-APPROVAL-NUMBER               20860055
                                                                        20870055
               WHEN SQLCODE = +100                                      20880055
                   SET SV005-HARD-DECLINE TO TRUE                       20890055
144300                                                                  20900055
144400         WHEN OTHER                                               20910055
144500                                                                  20920055
144600             PERFORM SV005-Z200-RETURN-FOR-ABEND                  20930055
144700             MOVE SV005-PC-PROC-NAME                              20940055
144800                                       TO SV005-AM-PROC-NAME      20950055
144900             MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  20960055
145000             MOVE 'SV005-D130-CHECK-DEACTREV '                    20970055
145100                                       TO SV005-AM-PARAGRAPH-NAME 20980055
145200             MOVE SV005-AM-MESSAGE-LINE-1                         20990055
145300                                       TO SV005-MESSAGE-1         21000055
145400             MOVE SQLCODE              TO SV005-AM-SQLCODE        21010055
145500             MOVE SV005-AM-SELECT-CRD-TXN TO SV005-AM-TABLE-INFO  21020055
145600             MOVE SV005-AM-SQL-MESSAGE-LINE-2                     21030055
145700                                       TO SV005-MESSAGE-2         21040055
                   SET SV005-HARD-DECLINE TO TRUE                       21050055
145800     END-EVALUATE.                                                21060055
145900                                                                  21070055
146060******************************************************************21080055
146100*     SV005-D200-GET-CURRENT-DATE                                *21090055
146200* ==> PROCESSES:                                                 *21100055
146300*     -GETS THE CURRENT DATE FOR COMPARISON TO THE POS DATE      *21110055
146400* ==> PERFORMED FROM: SV005-C500-NORM-TRANS-CHECK                *21120055
146500*                     SV005-C600-DUP-CHECK                       *21130055
146600******************************************************************21140055
146700 SV005-D200-GET-CURRENT-DATE.                                     21150055
146800                                                                  21160055
146900     EXEC SQL                                                     21170055
147000         SET :SV005-PV-CURRENT-DATE = CURRENT DATE                21180055
147100     END-EXEC.                                                    21190055
147200                                                                  21200055
147300     EVALUATE TRUE                                                21210055
147400         WHEN SQLCODE = 0                                         21220055
147500             CONTINUE                                             21230055
147600         WHEN OTHER                                               21240055
147700                                                                  21250055
147800             PERFORM SV005-Z200-RETURN-FOR-ABEND                  21260055
147900             MOVE SV005-PC-PROC-NAME                              21270055
148000                                       TO SV005-AM-PROC-NAME      21280055
148100             MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  21290055
148200             MOVE 'SV005-D200-GET-CURRENT-DATE         '          21300055
148300                                       TO SV005-AM-PARAGRAPH-NAME 21310055
148400             MOVE SV005-AM-MESSAGE-LINE-1                         21320055
148500                                       TO SV005-MESSAGE-1         21330055
148600             MOVE SQLCODE              TO SV005-AM-SQLCODE        21340055
148700             MOVE SV005-AM-SET-DATE-ERROR TO SV005-AM-TABLE-INFO  21350055
148800             MOVE SV005-AM-SQL-MESSAGE-LINE-2                     21360055
148900                                       TO SV005-MESSAGE-2         21370055
149000     END-EVALUATE.                                                21380055
149100                                                                  21390055
149200******************************************************************21400055
149300*     SV005-D300-LOOK-FOR-DUPLICATE                              *21410055
149400* ==> PROCESSES:                                                 *21420055
149500*     -CHECKS THE KMC ACTIVITY TABLE FOR DUPLICATES              *21430055
149600* ==> PERFORMED FROM: SV005-C600-DUP-CHECK                       *21440055
149700******************************************************************21450055
149800 SV005-D300-LOOK-FOR-DUPLICATE.                                   21460055
149900                                                                  21470055
150000     EXEC SQL                                                     21480055
150100         SELECT  CRD_NBR                                          21490055
150200           INTO  :SVT00002-CRD-NBR                                21500055
150300           FROM  SVT_KOHLS_CRD_TXN                                21510055
150400          WHERE  CRD_NBR          = :SV005-KMC-ID                 21520055
150500            AND  TRN_RVRSL_CDE    = :SV005-REVERSAL-CODE          21530055
150600            AND  TRN_VOID_IND     = :SV005-VOID-IND               21540055
150700            AND  ACTVY_TYP_CDE    = :SV005-ACTIVITY-TYPE          21550055
150800            AND  POS_DTE          = :SV005-PV-POS-DATE            21560055
150900            AND  STR_NBR          = :SV005-STORE-NBR              21570055
151000            AND  POS_TRMNL_NBR    = :SVT00002-POS-TRMNL-NBR       21580055
151100            AND  POS_TRN_NBR      = :SVT00002-POS-TRN-NBR         21590055
151200            AND  APP_AUTH_AMT     = :SVT00002-APP-AUTH-AMT        21600055
151300     END-EXEC.                                                    21610055
151400                                                                  21620055
151500     EVALUATE TRUE                                                21630055
151600         WHEN SQLCODE = 0 OR -811                                 21640055
                                                                        21650055
                   IF SV005-PV-FROM-AUKCS507                            21660055
071900               SET SV005-HARD-DECLINE TO TRUE                     21670055
                   ELSE                                                 21680055
151900               SET SV005-REFERRAL      TO TRUE                    21690055
                   END-IF                                               21700055
                                                                        21710055
151700             SET SV005-PS-DUPLICATE-FOUND TO TRUE                 21720055
151800             SET SV005-DUPLICATE     TO TRUE                      21730055
152000             MOVE ZERO               TO SV005-APPROVED-TENDER-AMT 21740055
152100             MOVE SV005-PV-CURR-BALANCE                           21750055
152200                                 TO SV005-KMC-REMAINING-BALANCE   21760055
152300             MOVE SV005-PC-ZERO-APPROVAL                          21770055
152400                                 TO SV005-KMC-APPROVAL-NBR        21780055
152500                                                                  21790055
152600         WHEN SQLCODE = +100                                      21800055
152700             PERFORM SV005-E200-ADD-DAY-POS-DATE                  21810055
152800                                                                  21820055
152900         WHEN OTHER                                               21830055
153000                                                                  21840055
153100             PERFORM SV005-Z200-RETURN-FOR-ABEND                  21850055
153200             MOVE SV005-PC-PROC-NAME                              21860055
153300                                       TO SV005-AM-PROC-NAME      21870055
153400             MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  21880055
153500             MOVE 'SV005-D300-LOOK-FOR-DUPLICATE       '          21890055
153600                                       TO SV005-AM-PARAGRAPH-NAME 21900055
153700             MOVE SV005-AM-MESSAGE-LINE-1                         21910055
153800                                       TO SV005-MESSAGE-1         21920055
153900             MOVE SQLCODE              TO SV005-AM-SQLCODE        21930055
154000             MOVE SV005-AM-SELECT-CRD-TXN TO SV005-AM-TABLE-INFO  21940055
154100             MOVE SV005-AM-SQL-MESSAGE-LINE-2                     21950055
154200                                       TO SV005-MESSAGE-2         21960055
154300     END-EVALUATE.                                                21970055
154400                                                                  21980055
154400                                                                  21990055
154500******************************************************************22000055
154600*     SV005-E100-CALC-CURR-BALANCE                               *22010055
154700* ==> PROCESSES:                                                 *22020055
154800*     -OPENS A CURSOR ON THE KMC ACTIVITY TABLE                  *22030055
154900*     -FETCHES ROWS FOR THE CARD ID SPECIFIED AND ACCUMULATES THE*22040055
155000*      BALANCE FOR THE CARD.                                     *22050055
155100*     -MOVES THE ACCUMULATED AMOUNT TO THE ORIGINAL BALANCE      *22060055
155200*     -CLOSES THE CURSOR                                         *22070055
155300* ==> PERFORMED FROM: SV005-B100-BALANCE-INQUIRY                 *22080055
155400*                     SV005-B300-NORMAL-TENDER                   *22090055
155500*                     SV005-B400-REVERSE-TRANS                   *22100055
155600*                     SV005-D100-CHECK-NORMAL-TRANS              *22110055
155700*                     SV005-D300-LOOK-FOR-DUPLICATE              *22120055
155800******************************************************************22130055
155900 SV005-E100-CALC-CURR-BALANCE.                                    22140055
156000                                                                  22150055
156100     MOVE SV005-KMC-ID TO SVT00002-CRD-NBR.                       22160055
156200     PERFORM SV005-F100-OPEN-ACTVY-CURSOR.                        22170055
156300                                                                  22180055
156400     MOVE ZERO         TO SV005-PV-CURR-BALANCE                   22190055
156500                          SV005-PV-ACTIVITY-CNT.                  22200055
156600     SET SV005-PS-NOT-END-ACTVY-CSR    TO TRUE.                   22210055
156700     PERFORM SV005-F200-FETCH-ACTVY-CURSOR                        22220055
156800         UNTIL SV005-PS-END-OF-ACTVY-CSR                          22230055
156900            OR SV005-PGM-ABEND.                                   22240055
157000                                                                  22250055
157100     IF SV005-PGM-ABEND                                           22260055
157200         CONTINUE                                                 22270055
157300     ELSE                                                         22280055
157400         MOVE SV005-PV-CURR-BALANCE TO SV005-KMC-ORIGINAL-BALANCE 22290055
157500         PERFORM SV005-F300-CLOSE-ACTVY-CURSOR                    22300055
157600     END-IF.                                                      22310055
157700                                                                  22320055
157800******************************************************************22330055
157900*     SV005-E200-ADD-DAY-POS-DATE                                *22340055
158000* ==> PROCESSES:                                                 *22350055
158100*     -ADDS ONE DAY TO THE POS DATE BY CALLING THE DATE ROUTINE  *22360055
158200* ==> PERFORMED FROM: SV005-D100-CHECK-NORMAL-TRANS              *22370055
158300*                     SV005-D300-LOOK-FOR-DUPLICATE              *22380055
158400******************************************************************22390055
158500 SV005-E200-ADD-DAY-POS-DATE.                                     22400055
158600                                                                  22410055
158700     MOVE SV005-PV-CURR-YY          TO SV005-PV-DATE-YY.          22420055
158800     MOVE SV005-PV-CURR-MM          TO SV005-PV-DATE-MM.          22430055
158900     MOVE SV005-PV-CURR-DD          TO SV005-PV-DATE-DD.          22440055
159000                                                                  22450055
159100     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              22460055
159200                                                                  22470055
159300     SET DPG51-ACTUAL-CALENDAR-ONLY TO TRUE.                      22480055
159400     SET DPG51-INCREMENT-DATE       TO TRUE.                      22490055
159500     MOVE SV005-PC-DAYS-INCREMENT   TO DPG51-INCR-DECR-DAYS-9.    22500055
159600                                                                  22510055
159700     SET DPG52-LK-DTE-ISO-FMT       TO TRUE.                      22520055
159800     MOVE SV005-PV-POS-DATE         TO DPG52-LK-DATE-INPUT.       22530055
159900                                                                  22540055
160000                                                                  22550055
160100     CALL SV005-PC-CALENDAR-PGM USING DPG51 DPG52                 22560055
160200                                DPG53 DPG54                       22570055
160300                                DPG55 DPG56.                      22580055
160400                                                                  22590055
160500     EVALUATE TRUE                                                22600055
160600         WHEN DPG54-SEVERE-ERROR                                  22610055
160700         WHEN DPG54-DATE-INVALID                                  22620055
160800                                                                  22630055
160900             PERFORM SV005-Z200-RETURN-FOR-ABEND                  22640055
161000             MOVE SV005-PC-PROC-NAME                              22650055
161100                                       TO SV005-AM-PROC-NAME      22660055
161200             MOVE 'OTHER'              TO SV005-AM-TYPE-OF-ABEND  22670055
161300             MOVE 'SV005-E200-ADD-DAY-POS-DATE      '             22680055
161400                                       TO SV005-AM-PARAGRAPH-NAME 22690055
161500             MOVE SV005-AM-MESSAGE-LINE-1                         22700055
161600                                       TO SV005-MESSAGE-1         22710055
161700             MOVE SV005-PV-POS-DATE    TO SV005-AM-POS-DATE       22720055
161800             MOVE SV005-AM-DATE-ROUTINE-ERR-MSG                   22730055
161900                                       TO SV005-MESSAGE-2         22740055
162000     END-EVALUATE.                                                22750055
162100                                                                  22760055
162200     IF SV005-PGM-ABEND                                           22770055
162300         CONTINUE                                                 22780055
162400     ELSE                                                         22790055
162500         MOVE DPG55-DB2-ISO-DATE-FMT  TO SV005-PV-POS-DATE        22800055
162600     END-IF.                                                      22810055
162700                                                                  22820055
162800******************************************************************22830055
162900*     SV005-F100-OPEN-ACTVY-CURSOR                               *22840055
163000* ==> PERFORMED FROM: SV005-E100-CALC-CURR-BALANCE               *22850055
163100******************************************************************22860055
163200 SV005-F100-OPEN-ACTVY-CURSOR.                                    22870055
163300                                                                  22880055
163400     EXEC SQL                                                     22890055
163500         OPEN ACTVY_AMT_CURSOR                                    22900055
163600     END-EXEC.                                                    22910055
163700                                                                  22920055
163800     EVALUATE TRUE                                                22930055
163900         WHEN SQLCODE = 0                                         22940055
164000             CONTINUE                                             22950055
164100         WHEN OTHER                                               22960055
164200                                                                  22970055
164300             PERFORM SV005-Z200-RETURN-FOR-ABEND                  22980055
164400             MOVE SV005-PC-PROC-NAME                              22990055
164500                                       TO SV005-AM-PROC-NAME      23000055
164600             MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  23010055
164700             MOVE 'SV005-F100-OPEN-ACTVY-CURSOR        '          23020055
164800                                       TO SV005-AM-PARAGRAPH-NAME 23030055
164900             MOVE SV005-AM-MESSAGE-LINE-1                         23040055
165000                                       TO SV005-MESSAGE-1         23050055
165100             MOVE SQLCODE              TO SV005-AM-SQLCODE        23060055
165200             MOVE SV005-AM-OPEN-CRD-TXN-CSR                       23070055
165300                                       TO SV005-AM-TABLE-INFO     23080055
165400             MOVE SV005-AM-SQL-MESSAGE-LINE-2                     23090055
165500                                       TO SV005-MESSAGE-2         23100055
165600     END-EVALUATE.                                                23110055
165700                                                                  23120055
165800******************************************************************23130055
165900*     SV005-F200-FETCH-ACTVY-CURSOR                              *23140055
166000* ==> PERFORMED FROM: SV005-E100-CALC-CURR-BALANCE               *23150055
166100******************************************************************23160055
166200 SV005-F200-FETCH-ACTVY-CURSOR.                                   23170055
166300                                                                  23180055
166400     EXEC SQL                                                     23190055
166500         FETCH  ACTVY_AMT_CURSOR                                  23200055
166600          INTO  :SVT00002-APP-AUTH-AMT                            23210055
166700     END-EXEC.                                                    23220055
166800                                                                  23230055
166900     EVALUATE TRUE                                                23240055
167000         WHEN SQLCODE = 0                                         23250055
167100             ADD +1 TO SV005-PV-ACTIVITY-CNT                      23260055
167200             COMPUTE SV005-PV-CURR-BALANCE =                      23270055
167300                 SV005-PV-CURR-BALANCE + SVT00002-APP-AUTH-AMT    23280055
167400         WHEN SQLCODE = +100                                      23290055
167500             SET SV005-PS-END-OF-ACTVY-CSR TO TRUE                23300055
167600         WHEN OTHER                                               23310055
167700                                                                  23320055
167800             PERFORM SV005-Z200-RETURN-FOR-ABEND                  23330055
167900             MOVE SV005-PC-PROC-NAME                              23340055
168000                                       TO SV005-AM-PROC-NAME      23350055
168100             MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  23360055
168200             MOVE 'SV005-F200-FETCH-ACTVY-CURSOR       '          23370055
168300                                       TO SV005-AM-PARAGRAPH-NAME 23380055
168400             MOVE SV005-AM-MESSAGE-LINE-1                         23390055
168500                                       TO SV005-MESSAGE-1         23400055
168600             MOVE SQLCODE              TO SV005-AM-SQLCODE        23410055
168700             MOVE SV005-AM-FETCH-CRD-TXN-CSR                      23420055
168800                                       TO SV005-AM-TABLE-INFO     23430055
168900             MOVE SV005-AM-SQL-MESSAGE-LINE-2                     23440055
169000                                       TO SV005-MESSAGE-2         23450055
169100     END-EVALUATE.                                                23460055
169200                                                                  23470055
169300******************************************************************23480055
169400*     SV005-F300-CLOSE-ACTVY-CURSOR                              *23490055
169500* ==> PERFORMED FROM: SV005-E100-CALC-CURR-BALANCE               *23500055
169600******************************************************************23510055
169700 SV005-F300-CLOSE-ACTVY-CURSOR.                                   23520055
169800                                                                  23530055
169900     EXEC SQL                                                     23540055
170000         CLOSE ACTVY_AMT_CURSOR                                   23550055
170100     END-EXEC.                                                    23560055
170200                                                                  23570055
170300     EVALUATE TRUE                                                23580055
170400         WHEN SQLCODE = 0                                         23590055
170500             CONTINUE                                             23600055
170600         WHEN OTHER                                               23610055
170700                                                                  23620055
170800             PERFORM SV005-Z200-RETURN-FOR-ABEND                  23630055
170900             MOVE SV005-PC-PROC-NAME                              23640055
171000                                       TO SV005-AM-PROC-NAME      23650055
171100             MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  23660055
171200             MOVE 'SV005-F300-CLOSE-ACTVY-CURSOR       '          23670055
171300                                       TO SV005-AM-PARAGRAPH-NAME 23680055
171400             MOVE SV005-AM-MESSAGE-LINE-1                         23690055
171500                                       TO SV005-MESSAGE-1         23700055
171600             MOVE SQLCODE              TO SV005-AM-SQLCODE        23710055
171700             MOVE SV005-AM-CLOSE-CRD-TXN-CSR                      23720055
171800                                       TO SV005-AM-TABLE-INFO     23730055
171900             MOVE SV005-AM-SQL-MESSAGE-LINE-2                     23740055
172000                                       TO SV005-MESSAGE-2         23750055
172100     END-EVALUATE.                                                23760055
172200                                                                  23770055
172300******************************************************************23780055
172400*     SV005-G100-READ-AUTH-PARMS                                 *23790055
172500* ==> PROCESSES:                                                 *23800055
172600*     - READ THE REFUND AUTHORIZATION PARAMETERS TEMPORARY       *23810055
172700*       STORAGE QUEUE                                            *23820055
172800*     - IF THE STORE NUMBER ON THE ITEM READ DOES NOT MATCH THE  *23830055
172900*       CURRENT STORE NUMBER, ATTEMPT TO DELETE & REBUILD QUEUE  *23840055
173000*     - IF QUEUE DOESN'T EXIST, ATTEMPT TO REBUILD IT            *23850055
173100*     - IF CORRECTABLE ERRORS ARE DETECTED, READ WILL BE RETRIED *23860055
173200*       A SET NUMBER OF TIMES                                    *23870055
173300* ==> PERFORMED FROM: SV005-C400-DETERMINE-CASH-BACK             *23880055
173400******************************************************************23890055
173500                                                                  23900055
173600 SV005-G100-READ-AUTH-PARMS.                                      23910055
173700     EXEC CICS                                                    23920055
173800         READQ TS                                                 23930055
173900             QUEUE (SV005-AP-QUEUE-NAME)                          23940055
174000             INTO (SV005-AP-AUTH-PARAMETER-RECORD)                23950055
174100             LENGTH (SV005-AP-QUEUE-LENGTH)                       23960055
174200             ITEM (SV005-PV-STORE-NUMBER)                         23970055
174300             RESP (SV005-PV-CICS-RESPONSE)                        23980055
174400     END-EXEC.                                                    23990055
174500                                                                  24000055
174600     MOVE SV005-PV-CICS-RESPONSE TO SV005-PV-HOLD-CICS-RESPONSE.  24010055
174700                                                                  24020055
174800     EVALUATE SV005-PV-CICS-RESPONSE                              24030055
174900         WHEN DFHRESP (NORMAL)                                    24040055
175000             IF SV005-AP-STORE-NUMBER NOT = SV005-PV-TSQ-STORE    24050055
175100******************************************************************24060055
175200*                MOVE SV005-PV-CICS-RESPONSE                      24070055
175300*                                      TO SV005-TS-CICS-RESPONSE  24080055
175400*                MOVE SV005-AP-QUEUE-NAME                         24090055
175500*                                      TO SV005-TS-ITEM-NUMBER    24100055
175600*                MOVE SV005-TS-TEMP-STORAGE-ERR-MSG               24110055
175700*                                      TO SV005-MESSAGE-1         24120055
175800*                MOVE 'READ THE AUTH TSQ - SEQUENCE ERROR - '     24130055
175900*                                      DELIMITED BY SIZE          24140055
176000*                     SV005-AP-STORE-NUMBER                       24150055
176100*                                      DELIMITED BY SIZE          24160055
176200*                     'READ-DEL/REBUILD FAILED ON RETRIES'        24170055
176300*                                      TO SV005-MESSAGE-2         24180055
176400*                PERFORM SV005-Z200-RETURN-FOR-ABEND              24190055
176500*                MOVE SV005-PC-PROC-NAME                          24200055
176600*                                      TO SV005-AM-PROC-NAME      24210055
176700*                MOVE 'LOGIC'          TO SV005-AM-TYPE-OF-ABEND  24220055
176800*                MOVE 'SV005-G100-READ-AUTH-PARMS    '            24230055
176900*                                      TO SV005-AM-PARAGRAPH-NAME 24240055
177000******************************************************************24250055
177100                 PERFORM SV005-G500-REBUILD-AP-QUEUE              24260055
177200                 ADD 1 TO SV005-PV-RETRY-COUNT                    24270055
177300             END-IF                                               24280055
177400         WHEN DFHRESP (QIDERR)                                    24290055
177500             PERFORM SV005-G500-REBUILD-AP-QUEUE                  24300055
177600             ADD 1 TO SV005-PV-RETRY-COUNT                        24310055
177700         WHEN OTHER                                               24320055
177800******************************************************************24330055
177900*  READ THE AUTHORIZATION PARAMETER TEMPORARY STORAGE QUEUE      *24340055
178000******************************************************************24350055
178100             PERFORM SV005-Z200-RETURN-FOR-ABEND                  24360055
178200             MOVE SV005-PC-PROC-NAME                              24370055
178300                                       TO SV005-AM-PROC-NAME      24380055
178400             MOVE 'LOGIC'              TO SV005-AM-TYPE-OF-ABEND  24390055
178500             MOVE 'SV005-G100-READ-AUTH-PARMS    '                24400055
178600                                       TO SV005-AM-PARAGRAPH-NAME 24410055
178700             MOVE SV005-AM-MESSAGE-LINE-1                         24420055
178800                                       TO SV005-MESSAGE-1         24430055
178900             MOVE SV005-PV-CICS-RESPONSE                          24440055
179000                                       TO SV005-TS-CICS-RESPONSE  24450055
179100             MOVE SV005-AP-QUEUE-NAME                             24460055
179200                                       TO SV005-TS-QUEUE-NAME     24470055
179300             MOVE SV005-PV-STORE-NUMBER                           24480055
179400                                       TO SV005-TS-ITEM-NUMBER    24490055
179500             MOVE SV005-TS-TEMP-STORAGE-ERR-MSG                   24500055
179600                                       TO SV005-MESSAGE-2         24510055
179700                                                                  24520055
179800             COMPUTE SV005-PV-RETRY-COUNT =                       24530055
179900                 SV005-PC-MAXIMUM-RETRY-COUNT + 1                 24540055
180000     END-EVALUATE.                                                24550055
180100                                                                  24560055
180200******************************************************************24570055
180300*     SV005-G500-REBUILD-AP-QUEUE                                *24580055
180400* ==> PROCESSES:                                                 *24590055
180500*     - REBUILD THE REFUND AUTHORIZATION PARAMETERS TEMPORARY    *24600055
180600*       STORAGE QUEUE                                            *24610055
180700*     - IF QUEUE EXISTS, DELETE THE QUEUE, THEN REBUILD IT       *24620055
180800* ==> PERFORMED FROM: SV005-C400-DETERMINE-CASH-BACK             *24630055
180900******************************************************************24640055
181000 SV005-G500-REBUILD-AP-QUEUE.                                     24650055
181100     EXEC CICS                                                    24660055
181200         SYNCPOINT                                                24670055
181300     END-EXEC.                                                    24680055
181400                                                                  24690055
181500     IF SV005-PS-AP-QUEUE-NOT-FOUND                               24700055
181600         IF SV005-PV-CICS-RESPONSE NOT = DFHRESP(QIDERR)          24710055
181700             PERFORM SV005-G510-DELETE-AP-QUEUE                   24720055
181800         END-IF                                                   24730055
181900         IF SV005-APPROVE                                         24740055
182000             PERFORM SV005-G520-BUILD-AP-QUEUE                    24750055
182100         END-IF                                                   24760055
182200     END-IF.                                                      24770055
182300                                                                  24780055
182400******************************************************************24790055
182500*     SV005-G510-DELETE-AP-QUEUE                                 *24800055
182600* ==> PERFORMED FROM: SV005-G500-REBUILD-AP-QUEUE                *24810055
182700******************************************************************24820055
182800 SV005-G510-DELETE-AP-QUEUE.                                      24830055
182900     EXEC CICS                                                    24840055
183000         DELETEQ TS                                               24850055
183100             QUEUE(SV005-AP-QUEUE-NAME)                           24860055
183200     END-EXEC.                                                    24870055
183300                                                                  24880055
183400     IF ((SV005-PV-CICS-RESPONSE NOT = DFHRESP (NORMAL))          24890055
183500             AND (SV005-PV-CICS-RESPONSE NOT = DFHRESP (QIDERR))) 24900055
183600******************************************************************24910055
183700*  DELETE THE AUTHORIZATION PARAMETER TEMPORARY STORAGE QUEUE    *24920055
183800******************************************************************24930055
183900         PERFORM SV005-Z200-RETURN-FOR-ABEND                      24940055
184000         MOVE SV005-PC-PROC-NAME     TO SV005-AM-PROC-NAME        24950055
184100         MOVE 'LOGIC'                TO SV005-AM-TYPE-OF-ABEND    24960055
184200         MOVE 'SV005-G510-DELETE-AP-QUEUE    '                    24970055
184300                                     TO SV005-AM-PARAGRAPH-NAME   24980055
184400         MOVE SV005-AM-MESSAGE-LINE-1                             24990055
184500                                     TO SV005-MESSAGE-1           25000055
184600         MOVE SV005-PV-CICS-RESPONSE TO SV005-TS-CICS-RESPONSE    25010055
184700         MOVE SV005-AP-QUEUE-NAME    TO SV005-TS-QUEUE-NAME       25020055
184800         MOVE SV005-PV-STORE-NUMBER  TO SV005-TS-ITEM-NUMBER      25030055
184900         MOVE SV005-TS-TEMP-STORAGE-ERR-MSG                       25040055
185000                                     TO SV005-MESSAGE-2           25050055
185100     END-IF.                                                      25060055
185200                                                                  25070055
185300                                                                  25080055
185400******************************************************************25090055
185500*     SV005-G520-BUILD-AP-QUEUE                                  *25100055
185600* ==> PROCESSES:                                                 *25110055
185700*     - REBUILD THE REFUND AUTHORIZATION PARAMETERS TEMPORARY    *25120055
185800*       STORAGE QUEUE                                            *25130055
185900* ==> PERFORMED FROM: SV005-G500-REBUILD-AP-QUEUE                *25140055
186000******************************************************************25150055
186100                                                                  25160055
186200 SV005-G520-BUILD-AP-QUEUE.                                       25170055
186300     SET SV005-PS-BLDG-AUTH-PARMS-QUEUE TO TRUE.                  25180055
186400                                                                  25190055
186500                                                                  25200055
186600     EXEC CICS                                                    25210055
186700         START                                                    25220055
186800             TRANSID(SV005-PC-BUILD-AUTH-PARM-TR-ID)              25230055
186900             RESP(SV005-PV-CICS-RESPONSE)                         25240055
187000     END-EXEC.                                                    25250055
187100                                                                  25260055
187200     IF SV005-PV-CICS-RESPONSE = DFHRESP(NORMAL)                  25270055
187300         EXEC CICS                                                25280055
187400             DELAY                                                25290055
187500                 INTERVAL(SV005-PC-BUILD-QUEUE-WAIT-TIME)         25300055
187600         END-EXEC                                                 25310055
187700     ELSE                                                         25320055
187800         PERFORM SV005-Z200-RETURN-FOR-ABEND                      25330055
187900         MOVE SV005-PC-PROC-NAME   TO SV005-AM-PROC-NAME          25340055
188000         MOVE 'LOGIC'              TO SV005-AM-TYPE-OF-ABEND      25350055
188100         MOVE 'SV005-G520-BUILD-AP-QUEUE     '                    25360055
188200                                   TO SV005-AM-PARAGRAPH-NAME     25370055
188300         MOVE SV005-AM-MESSAGE-LINE-1                             25380055
188400                                   TO SV005-MESSAGE-1             25390055
188500         MOVE SV005-PV-CICS-RESPONSE                              25400055
188600                                   TO SV005-SE-CICS-RESPONSE      25410055
188700         MOVE 'START THE AUTH PARM TSQ REBUILD TRANS'             25420055
188800                                   TO SV005-SE-ATTEMPTED-ACTION   25430055
188900         MOVE SV005-SE-SYSTEM-ERROR-MESSAGE                       25440055
189000                                   TO SV005-MESSAGE-2             25450055
189100         MOVE SV005-PC-MAXIMUM-RETRY-COUNT                        25460055
189200                                   TO SV005-PV-RETRY-COUNT        25470055
189300         MOVE SV005-PV-HOLD-CICS-RESPONSE                         25480055
189400                                   TO SV005-PV-CICS-RESPONSE      25490055
189500     END-IF.                                                      25500055
189600*                                                                 25510055
189700******************************************************************25520055
189800*     SV005-H100-INSERT-LOCK                                     *25530055
189900*                                                                *25540055
190000*        INSERT ROW INTO TABLE SVT_CRD_ACCT_LCK FOR EACH         *25550055
190100*           SVT_KOHLS_CRD_ACCT ROW READ.                         *25560055
190200*        IF, AFTER INSERT, SQLCODE IS -803 (DUP) OR -911 (TIME   *25570055
190300*           OUT), TREAT TRANSACTION AS REFERRAL.                 *25580055
190400*                                                                *25590055
190500*        TABLE SVT_CRD_ACCT_LCK HAS ROW-LEVEL LOCKING.  ROW      *25600055
190600*           INSERTED TO ENSURE BALANCE ON CARD IS NOT UPDATED AT *25610055
190700*           SAME TIME A DIFFERENT TRANSACTION IS RETRIEVING      *25620055
190800*           ITS BALANCE.                                         *25630055
190900*                                                                *25640055
191000******************************************************************25650055
191100 SV005-H100-INSERT-LOCK.                                          25660055
191200                                                                  25670055
191300     SET SV006-PS-NO-LCK-ERROR TO TRUE.                           25680055
191400                                                                  25690055
191500     EXEC SQL                                                     25700055
191600          INSERT INTO SVT_CRD_ACCT_LCK                            25710055
191700             (CRD_NBR)                                            25720055
191800          VALUES                                                  25730055
191900             (:SV005-KMC-ID)                                      25740055
192000     END-EXEC.                                                    25750055
192100                                                                  25760055
192200     EVALUATE TRUE                                                25770055
192300         WHEN SQLCODE = 0                                         25780055
192400              CONTINUE                                            25790055
192500* DUPLICATE - CARD ALREADY LOCKED FOR ANOTHER TRANSACTION         25800055
192600         WHEN SQLCODE = -803                                      25810055
192700* TABLE NOT AVAILABLE                                             25820055
192800         WHEN SQLCODE = -911                                      25830055
192900*             SV005-REFERRAL SET TO TRUE IN Z400-                 25840055
193000              PERFORM SV005-Z400-REFERRAL                         25850055
193100              SET SV005-PS-REFERRAL TO TRUE                       25860055
193200              SET SV006-PS-LCK-ERROR TO TRUE                      25870055
BARB               PERFORM SV005-Z200-RETURN-FOR-ABEND                  25880055
BARB               MOVE SV005-PC-PROC-NAME                              25890055
BARB                                         TO SV005-AM-PROC-NAME      25900055
BARB               MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  25910055
BARB               MOVE 'SV005-H100-INSERT-LOCK'                        25920055
BARB                                         TO SV005-AM-PARAGRAPH-NAME 25930055
BARB               MOVE SV005-AM-MESSAGE-LINE-1                         25940055
BARB                                         TO SV005-MESSAGE-1         25950055
BARB               MOVE SQLCODE              TO SV005-AM-SQLCODE        25960055
BARB               MOVE SV005-AM-INVALID-REV-CODE-MSG                   25970055
BARB                                         TO SV005-MESSAGE-2         25980055
193400         WHEN SQLCODE = -530                                      25990055
193500              SET SV005-PS-DECLINE TO TRUE                        26000055
193600         WHEN OTHER                                               26010055
193700             PERFORM SV005-Z200-RETURN-FOR-ABEND                  26020055
193800             MOVE SV005-PC-PROC-NAME                              26030055
193900                                       TO SV005-AM-PROC-NAME      26040055
194000             MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  26050055
194100             MOVE 'SV005-H100-INSERT-LOCK'                        26060055
194200                                       TO SV005-AM-PARAGRAPH-NAME 26070055
194300             MOVE SV005-AM-MESSAGE-LINE-1                         26080055
194400                                       TO SV005-MESSAGE-1         26090055
194500             MOVE SQLCODE              TO SV005-AM-SQLCODE        26100055
194600             MOVE SV005-AM-INVALID-REV-CODE-MSG                   26110055
194700                                       TO SV005-MESSAGE-2         26120055
194800     END-EVALUATE.                                                26130055
                                                                        26140055
157800******************************************************************26150055
157900*     SV005-I250-ADD-30DAY-POS-DATE                               26160055
158000* ==> PROCESSES:                                                 *26170055
158100*     -ADDS 30  DAY TO THE POS DATE BY CALLING THE DATE ROUTINE  *26180055
      *     - INCOMM DEACTIVATIONS (THAT IS THE CUSTOMER CAN RETURN A   26190055
      *       CARD TO THE STORE) WITHIN 30 DAYS OF ACTIVATION.          26200055
158200* ==> PERFORMED FROM:                                             26210055
158300*             SV005-I340-INCOMM-CHECK-TEND                        26220055
158400******************************************************************26230055
158500 SV005-I250-ADD-30DAY-POS-DATE.                                   26240055
158600                                                                  26250055
159100     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              26260055
159200                                                                  26270055
159300     SET DPG51-ACTUAL-CALENDAR-ONLY TO TRUE.                      26280055
159400     SET DPG51-INCREMENT-DATE       TO TRUE.                      26290055
159500     MOVE SV005-PC-30DAYS-INCREMENT TO DPG51-INCR-DECR-DAYS-9.    26300055
159600                                                                  26310055
159700     SET DPG52-LK-DTE-ISO-FMT       TO TRUE.                      26320055
159800     MOVE SVT00002-POS-DTE          TO DPG52-LK-DATE-INPUT.       26330055
159900                                                                  26340055
160000                                                                  26350055
160100     CALL SV005-PC-CALENDAR-PGM USING DPG51 DPG52                 26360055
160200                                DPG53 DPG54                       26370055
160300                                DPG55 DPG56.                      26380055
160400                                                                  26390055
160500     EVALUATE TRUE                                                26400055
160600         WHEN DPG54-SEVERE-ERROR                                  26410055
160700         WHEN DPG54-DATE-INVALID                                  26420055
160800                                                                  26430055
160900             PERFORM SV005-Z200-RETURN-FOR-ABEND                  26440055
161000             MOVE SV005-PC-PROC-NAME                              26450055
161100                                       TO SV005-AM-PROC-NAME      26460055
161200             MOVE 'OTHER'              TO SV005-AM-TYPE-OF-ABEND  26470055
161300             MOVE 'SV005-I250-ADD-30DAY-POS-DATE    '             26480055
161400                                       TO SV005-AM-PARAGRAPH-NAME 26490055
161500             MOVE SV005-AM-MESSAGE-LINE-1                         26500055
161600                                       TO SV005-MESSAGE-1         26510055
161700             MOVE SV005-PV-POS-DATE    TO SV005-AM-POS-DATE       26520055
161800             MOVE SV005-AM-DATE-ROUTINE-ERR-MSG                   26530055
161900                                       TO SV005-MESSAGE-2         26540055
162000     END-EVALUATE.                                                26550055
162100                                                                  26560055
162200     IF SV005-PGM-ABEND                                           26570055
162300         CONTINUE                                                 26580055
162400     ELSE                                                         26590055
               MOVE DPG55-DB2-ISO-DATE-FMT  TO SV005-PV-FINAL-DATE      26600055
               IF SV005-PV-FINAL-DATE >= SV005-PV-CURRENT-DATE          26610055
                    SET SV005-VALID-DEACT  TO TRUE                      26620055
               END-IF                                                   26630055
162600     END-IF.                                                      26640055
162700                                                                  26650055
149200******************************************************************26660055
149300*     SV005-I340-INCOMM-CHECK-TEND                                26670055
149400* ==> PROCESSES:                                                 *26680055
149500*     -CHECKS THE ACTIVITY TABLE TO SEE IF THERE ARE ANY         *26690055
      *      TENDERS FOR THAT CARD.  IF THERE ARE THEN WE CANNOT DEACT  26700055
      *      A DEACTIVATION IS IF A CUSTOMER RETURNS THE CARD.  IF THEY 26710055
      *      HAVE ALREADY USED IT(TENDER), THEN THEY CAN'T DEACTIVATE.  26720055
      *                                                                 26730055
149600* ==> PERFORMED FROM: SV005-B400-REVERSE-TRANS                    26740055
      *                     SV005-C800-INCOMM-CHECKS                    26750055
149700******************************************************************26760055
149800 SV005-I340-INCOMM-CHECK-TEND.                                    26770055
149900                                                                  26780055
150000     EXEC SQL                                                     26790055
150100         SELECT  CRD_NBR                                          26800055
150200           INTO  :SVT00002-CRD-NBR                                26810055
150300           FROM  SVT_KOHLS_CRD_TXN                                26820055
150400          WHERE  CRD_NBR          = :SV005-KMC-ID                 26830055
150700            AND  ACTVY_TYP_CDE    = :SV005-PC-TENDER-TYPE         26840055
151300     END-EXEC.                                                    26850055
                                                                        26860055
151500     EVALUATE TRUE                                                26870055
087600         WHEN SQLCODE = 0 OR -811                                 26880055
083300             SET SV005-HARD-DECLINE                               26890055
151800                 SV005-PS-TENDER-W-ISSUE        TO TRUE           26900055
152500                                                                  26910055
152600         WHEN SQLCODE = +100                                      26920055
152700             CONTINUE                                             26930055
152800                                                                  26940055
152900         WHEN OTHER                                               26950055
153000                                                                  26960055
153100             PERFORM SV005-Z200-RETURN-FOR-ABEND                  26970055
153200             MOVE SV005-PC-PROC-NAME                              26980055
153300                                       TO SV005-AM-PROC-NAME      26990055
153400             MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  27000055
153500             MOVE 'SV005-I340-INCOMM-CHECK-TEND        '          27010055
153600                                       TO SV005-AM-PARAGRAPH-NAME 27020055
153700             MOVE SV005-AM-MESSAGE-LINE-1                         27030055
153800                                       TO SV005-MESSAGE-1         27040055
153900             MOVE SQLCODE              TO SV005-AM-SQLCODE        27050055
154000             MOVE SV005-AM-SELECT-CRD-TXN TO SV005-AM-TABLE-INFO  27060055
154100             MOVE SV005-AM-SQL-MESSAGE-LINE-2                     27070055
154200                                       TO SV005-MESSAGE-2         27080055
154300     END-EVALUATE.                                                27090055
154400                                                                  27100055
085700******************************************************************27110055
085800*     SV005-I350-CHECK-ACTIVITY                                   27120055
085900* ==> PROCESSES:                                                 *27130055
086000*     -CHECKS THE KMC ACTIVITY TABLE FOR THE CARD NUMBER         *27140055
086100*     -IF THE CARD NUMBER IS FOUND ON THE ACTIVITY TABLE, SET    *27150055
086300* ==> PERFORMED FROM: SV005-B200-NORMAL-ISSUE                    *27160055
086400******************************************************************27170055
086500 SV005-I350-CHECK-ACTIVITY.                                       27180055
086600                                                                  27190055
086700     EXEC SQL                                                     27200055
086800         SELECT  CRD_NBR                                          27210055
086900           INTO  :SVT00002-CRD-NBR                                27220055
087000           FROM  SVT_KOHLS_CRD_TXN                                27230055
087100          WHERE  CRD_NBR       = :SV005-KMC-ID                    27240055
087300     END-EXEC.                                                    27250055
087400                                                                  27260055
087500     EVALUATE TRUE                                                27270055
087600         WHEN SQLCODE = 0 OR -811                                 27280055
087700             CONTINUE                                             27290055
087800                                                                  27300055
087900         WHEN SQLCODE = +100                                      27310055
088100             SET SV005-HARD-DECLINE TO TRUE                       27320055
                   SET SV005-PS-INACTIVE  TO TRUE                       27330055
088200         WHEN OTHER                                               27340055
088300                                                                  27350055
088400             PERFORM SV005-Z200-RETURN-FOR-ABEND                  27360055
088500             MOVE SV005-PC-PROC-NAME                              27370055
088600                                       TO SV005-AM-PROC-NAME      27380055
088700             MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  27390055
088800             MOVE 'SV005-I350-CHECK-ACTIVITY'                     27400055
088900                                       TO SV005-AM-PARAGRAPH-NAME 27410055
089000             MOVE SV005-AM-MESSAGE-LINE-1                         27420055
089100                                       TO SV005-MESSAGE-1         27430055
089200             MOVE SQLCODE              TO SV005-AM-SQLCODE        27440055
089300             MOVE SV005-AM-SELECT-CRD-TXN TO SV005-AM-TABLE-INFO  27450055
089400             MOVE SV005-AM-SQL-MESSAGE-LINE-2                     27460055
089500                                       TO SV005-MESSAGE-2         27470055
089600     END-EVALUATE.                                                27480055
089700                                                                  27490055
149200******************************************************************27500055
149300*     SV005-I360-INCOMM-SET-VALUES                               *27510055
149400* ==> PROCESSES:                                                 *27520055
149500*     -CHECKS THE KMC ACTIVITY TABLE FOR DUPLICATES              *27530055
149600* ==> PERFORMED FROM:  SV005-B400-REVERSE-TRANS                  *27540055
149600*                      SV005-C800-INCOMM-CHECKS                  *27550055
149700******************************************************************27560055
149800 SV005-I360-INCOMM-SET-VALUES.                                    27570055
                                                                        27580055
131600     MOVE SV005-POS-DATE TO SV005-PV-POS-DATE.                    27590055
131700                                                                  27600055
131800     PERFORM SV005-D200-GET-CURRENT-DATE.                         27610055
131900                                                                  27620055
132000     IF SV005-PGM-ABEND                                           27630055
132100         CONTINUE                                                 27640055
132200     ELSE                                                         27650055
132300         IF SV005-ISSUE                                           27660055
132400         OR SV005-ISSUE-GIFT-CRD                                  27670055
132500             IF SV005-NORMAL                                      27680055
132600                 MOVE SV005-TRANS-AMT TO SVT00002-APP-AUTH-AMT    27690055
132700             END-IF                                               27700055
132800             IF SV005-REVERSAL                                    27710055
132900                 MOVE SV005-REVERSAL-AMT TO SVT00002-APP-AUTH-AMT 27720055
133000             END-IF                                               27730055
133100         END-IF                                                   27740055
133200         IF SV005-TENDER                                          27750055
133300             IF SV005-NORMAL                                      27760055
133400                 COMPUTE SVT00002-APP-AUTH-AMT =                  27770055
133500                     SV005-PC-MINUS-ONE * SV005-TRANS-AMT         27780055
133600             END-IF                                               27790055
133700             IF SV005-REVERSAL                                    27800055
133800                 MOVE SV005-REVERSAL-AMT TO SVT00002-APP-AUTH-AMT 27810055
133900             END-IF                                               27820055
134000         END-IF                                                   27830055
134100         MOVE SV005-TERMINAL-NBR TO SVT00002-POS-TRMNL-NBR        27840055
134200         MOVE SV005-TRANSACTION-NBR TO SVT00002-POS-TRN-NBR       27850055
               IF SV005-PS-ADD-ON                                       27860055
                  PERFORM SV005-I375-INCOMM-DUP-ADD                     27870055
               ELSE                                                     27880055
                  PERFORM SV005-I370-INCOMM-DUP-CHECK                   27890055
               END-IF                                                   27900055
132200     END-IF.                                                      27910055
                                                                        27920055
151400                                                                  27930055
149200******************************************************************27940055
149300*     SV005-I370-INCOMM-DUP-CHECK                                *27950055
149400* ==> PROCESSES:                                                 *27960055
149500*     -CHECKS THE KMC ACTIVITY TABLE FOR DUPLICATES              *27970055
149400* ==> PROCESSES:                                                 *27980055
149500*     -CHECKS THE KMC ACTIVITY TABLE FOR DUPLICATES              *27990055
      *     - THIS CHECKS TO MAKE SURE THAT THERE HAS NOT BEEN A TRAN  *28000055
      *       HAS NOT ALREADY OCCURRED.                                *28010055
      *                                                                 28020055
      *     - THESE ARE THE VALUES THAT ARE BEING CHECKED FOR THE DUP  *28030055
      *                                                                 28040055
      *     - IF THE TRANSACTION IS A REVERSAL                         *28050055
      *          REVERSAL INDICATOR WILL BE 1                          *28060055
      *          VOID INDICATOR = Y                                    *28070055
      *          APP-AUTH-AMT = NEGATIVE AMOUNT                        *28080055
      *                                                                *28090055
      *     - IF THE TRANSACTION IS A DEACT REVERSAL                   *28100055
      *          REVERSAL INDICATOR WILL BE 1                          *28110055
      *          VOID INDICATOR = Y                                    *28120055
      *          APP-AUTH-AMT = POSITIVE AMOUNT                        *28130055
      *                                                                *28140055
      *     - IF THE TRANSACTION IS A REGULAR ACTIVATION THAT HAS ROWS *28150055
      *       ON THE ACTIVITY DB, IT WILL BE TREATED AS AN ADD ON.     *28160055
      *       INCOMM DOES NOT DO ADD ONS, BECAUSE THERE ARE ROWS THIS  *28170055
      *       COULD BE AN ACCOUNT THAT WAS DEACTIVATED.                *28180055
      *          REVERSAL INDICATOR WILL BE 0                          *28190055
      *          VOID INDICATOR = N                                    *28200055
      *          APP-AUTH-AMT = POSITIVE AMOUNT                        *28210055
      *                                                                *28220055
149600* ==> PERFORMED FROM: SV005-I360-INCOMM-SET-VALUES               *28230055
      *                                                                *28240055
149700******************************************************************28250055
151400                                                                  28260055
149800 SV005-I370-INCOMM-DUP-CHECK.                                     28270055
                                                                        28280055
150000     EXEC SQL                                                     28290055
150100         SELECT  CRD_NBR                                          28300055
150200           INTO  :SVT00002-CRD-NBR                                28310055
150300           FROM  SVT_KOHLS_CRD_TXN                                28320055
150400          WHERE  CRD_NBR          = :SV005-KMC-ID                 28330055
150500            AND  TRN_AUTH_TMST    = :SV005-PV-TMST-DATE           28340055
150500            AND  TRN_RVRSL_CDE    = :SV005-REVERSAL-CODE          28350055
150600            AND  TRN_VOID_IND     = :SV005-VOID-IND               28360055
150700            AND  ACTVY_TYP_CDE    = :SV005-ACTIVITY-TYPE          28370055
150900            AND  STR_NBR          = :SV005-STORE-NBR              28380055
151200            AND  APP_AUTH_AMT     = :SVT00002-APP-AUTH-AMT        28390055
151300     END-EXEC.                                                    28400055
                                                                        28410055
151500     EVALUATE TRUE                                                28420055
151600         WHEN SQLCODE = 0 OR -811                                 28430055
151700             SET SV005-PS-DUPLICATE-FOUND TO TRUE                 28440055
151800             SET SV005-DUPLICATE     TO TRUE                      28450055
                   SET SV005-HARD-DECLINE  TO TRUE                      28460055
152000             MOVE ZERO               TO SV005-APPROVED-TENDER-AMT 28470055
152100             MOVE SV005-PV-CURR-BALANCE                           28480055
152200                                 TO SV005-KMC-REMAINING-BALANCE   28490055
152300             MOVE SV005-PC-ZERO-APPROVAL                          28500055
152400                                 TO SV005-KMC-APPROVAL-NBR        28510055
152500                                                                  28520055
152600         WHEN SQLCODE = +100                                      28530055
                    CONTINUE                                            28540055
152900         WHEN OTHER                                               28550055
153000                                                                  28560055
153100             PERFORM SV005-Z200-RETURN-FOR-ABEND                  28570055
153200             MOVE SV005-PC-PROC-NAME                              28580055
153300                                       TO SV005-AM-PROC-NAME      28590055
153400             MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  28600055
153500             MOVE 'SV005-I370-INCOMM-DUP-CHECK         '          28610055
153600                                       TO SV005-AM-PARAGRAPH-NAME 28620055
153700             MOVE SV005-AM-MESSAGE-LINE-1                         28630055
153800                                       TO SV005-MESSAGE-1         28640055
153900             MOVE SQLCODE              TO SV005-AM-SQLCODE        28650055
154000             MOVE SV005-AM-SELECT-CRD-TXN TO SV005-AM-TABLE-INFO  28660055
154100             MOVE SV005-AM-SQL-MESSAGE-LINE-2                     28670055
154200                                       TO SV005-MESSAGE-2         28680055
154300     END-EVALUATE.                                                28690055
154400                                                                  28700055
149200******************************************************************28710055
149300*     SV005-I375-INCOMM-DUP-ADD                                  *28720055
149400* ==> PROCESSES:                                                 *28730055
149500*     -CHECKS THE KMC ACTIVITY TABLE FOR DUPLICATES              *28740055
      *     - THIS CHECKS TO MAKE SURE THAT THERE HAS NOT BEEN A TRAN  *28750055
      *       HAS NOT ALREADY OCCURRED.                                *28760055
      *     - THESE ARE THE VALUES THAT ARE BEING CHECKED FOR THE DUP  *28770055
                                                                        28780055
      *     - IF THE TRANSACTION IS A REGULAR ACTIVATION:              *28790055
      *          REVERSAL INDICATOR WILL BE 0                          *28800055
      *          VOID INDICATOR = N                                    *28810055
      *          APP-AUTH-AMT = POSITIVE AMOUNT                        *28820055
      *                                                                *28830055
149600* ==> PERFORMED FROM: SV005-I360-INCOMM-SET-VALUES               *28840055
149700******************************************************************28850055
151400                                                                  28860055
149800 SV005-I375-INCOMM-DUP-ADD.                                       28870055
151400                                                                  28880055
150000     EXEC SQL                                                     28890055
150100         SELECT  CRD_NBR                                          28900055
150200           INTO  :SVT00002-CRD-NBR                                28910055
150300           FROM  SVT_KOHLS_CRD_TXN                                28920055
150400          WHERE  CRD_NBR          = :SV005-KMC-ID                 28930055
150500            AND  TRN_RVRSL_CDE    = :SV005-REVERSAL-CODE          28940055
150600            AND  TRN_VOID_IND     = :SV005-VOID-IND               28950055
150700            AND  ACTVY_TYP_CDE    = :SV005-ACTIVITY-TYPE          28960055
150900            AND  STR_NBR          = :SV005-STORE-NBR              28970055
151200            AND  APP_AUTH_AMT     = :SVT00002-APP-AUTH-AMT        28980055
151300     END-EXEC.                                                    28990055
                                                                        29000055
151500     EVALUATE TRUE                                                29010055
151600         WHEN SQLCODE = 0 OR -811                                 29020055
151700             SET SV005-PS-DUPLICATE-FOUND TO TRUE                 29030055
151800             SET SV005-DUPLICATE     TO TRUE                      29040055
                   SET SV005-HARD-DECLINE  TO TRUE                      29050055
152000             MOVE ZERO               TO SV005-APPROVED-TENDER-AMT 29060055
152100             MOVE SV005-PV-CURR-BALANCE                           29070055
152200                                 TO SV005-KMC-REMAINING-BALANCE   29080055
152300             MOVE SV005-PC-ZERO-APPROVAL                          29090055
152400                                 TO SV005-KMC-APPROVAL-NBR        29100055
152500                                                                  29110055
152600         WHEN SQLCODE = +100                                      29120055
                    CONTINUE                                            29130055
152900         WHEN OTHER                                               29140055
153000                                                                  29150055
153100             PERFORM SV005-Z200-RETURN-FOR-ABEND                  29160055
153200             MOVE SV005-PC-PROC-NAME                              29170055
153300                                       TO SV005-AM-PROC-NAME      29180055
153400             MOVE '  DB2'              TO SV005-AM-TYPE-OF-ABEND  29190055
153500             MOVE 'SV005-I375-INCOMM-DUP-CHECK         '          29200055
153600                                       TO SV005-AM-PARAGRAPH-NAME 29210055
153700             MOVE SV005-AM-MESSAGE-LINE-1                         29220055
153800                                       TO SV005-MESSAGE-1         29230055
153900             MOVE SQLCODE              TO SV005-AM-SQLCODE        29240055
154000             MOVE SV005-AM-SELECT-CRD-TXN TO SV005-AM-TABLE-INFO  29250055
154100             MOVE SV005-AM-SQL-MESSAGE-LINE-2                     29260055
154200                                       TO SV005-MESSAGE-2         29270055
154300     END-EVALUATE.                                                29280055
154400                                                                  29290055
195000******************************************************************29300055
195100*     SV005-Z100-GET-APPROVAL-NUMBER                             *29310055
195200* ==> PROCESSES:                                                 *29320055
195300*     -POPULATES THE WORKING STORAGE FOR PROCEDURE SVPD006, THE  *29330055
195400*      KMC APPROVAL NUMBER MODULE                                *29340055
195500*     -THE APPROVAL NUMBER IS CALCULATED AND SENT BACK           *29350055
195600* ==> PERFORMED FROM: SV005-B200-NORMAL-ISSUE                    *29360055
195700*                     SV005-C400-DETERMINE-CASH-BACK             *29370055
195800*                     SV005-C450-COMPARE-BALANCES                *29380055
195900*                     SV005-D100-CHECK-NORMAL-TRANS              *29390055
196000*                     SV005-D300-LOOK-FOR-DUPLICATE              *29400055
196100* CHANGE 7/1/2003                                                *29410055
196200* PROGRAM AUKCS502 DOES NOT USE THIS APPROVAL NUMBER, IT SENDS   *29420055
196300* BACK THE AMOUNT AS THE APPROVAL NUMBER, SO NOT NECESSARY TO RUN*29430055
196400* 11/14/2007 - EPKCS209 DOES NOT USE APPROVAL NUMBER             *29440055
196500******************************************************************29450055
196600 SV005-Z100-GET-APPROVAL-NUMBER.                                  29460055
196700                                                                  29470055
196800     IF SV005-PV-FROM-AUKCS502                                    29480055
196900      OR SV005-PV-FROM-EPKCS209                                   29490055
197000       CONTINUE                                                   29500055
197100     ELSE                                                         29510055
197200       MOVE SV005-KMC-ID              TO SV006-KMC-ID             29520055
197300       MOVE SV005-APPROVED-TENDER-AMT TO SV006-TENDER-AMT         29530055
197400       MOVE SV005-TERMINAL-NBR        TO SV006-TERMINAL-NBR       29540055
197500       MOVE SV005-TRANSACTION-NBR     TO SV006-TRANSACTION-NBR    29550055
197600                                                                  29560055
197700       PERFORM SV006-A100-MAINLINE                                29570055
197800                                                                  29580055
197900       MOVE SV006-KMC-APPROVAL-NBR    TO SV005-KMC-APPROVAL-NBR   29590055
198000     END-IF.                                                      29600055
198100******************************************************************29610055
198200*     SV005-Z200-RETURN-FOR-ABEND                                *29620055
198300* ==> PROCESSES:                                                 *29630055
198400*     -POPULATES THE FIELDS RETURNED TO THE CALLING PROGRAM WITH *29640055
198500*      CORRECT VALUES WHEN AN ABEND HAS OCCURRED DURING          *29650055
198600*      PROCESSING                                                *29660055
198700* ==> PERFORMED FROM: SV005-A100-MAINLINE                        *29670055
198800*                     SV005-B100-BALANCE-INQUIRY                 *29680055
198900*                     SV005-C100-CHECK-ISSUE                     *29690055
199000*                     SV005-C200-CHECK-ID-ACTIVITY               *29700055
199100*                     SV005-C300-CHECK-TENDER                    *29710055
199200*                     SV005-C400-DETERMINE-CASH-BACK             *29720055
199300*                     SV005-D100-CHECK-NORMAL-TRANS              *29730055
199400*                     SV005-D200-GET-CURRENT-DATE                *29740055
199500*                     SV005-D300-LOOK-FOR-DUPLICATE              *29750055
199600*                     SV005-F100-OPEN-ACTVY-CURSOR               *29760055
199700*                     SV005-F200-FETCH-ACTVY-CURSOR              *29770055
199800*                     SV005-F300-CLOSE-ACTVY-CURSOR              *29780055
199900******************************************************************29790055
200000 SV005-Z200-RETURN-FOR-ABEND.                                     29800055
200100                                                                  29810055
200200     SET SV005-PGM-ABEND     TO TRUE.                             29820055
200300     MOVE ZEROES             TO SV005-APPROVED-TENDER-AMT         29830055
200400                                SV005-KMC-REMAINING-BALANCE.      29840055
200500     MOVE SV005-PC-ZERO-APPROVAL TO SV005-KMC-APPROVAL-NBR.       29850055
200600                                                                  29860055
200700******************************************************************29870055
200800*     SV005-Z300-HARD-DECLINE                                    *29880055
200900* ==> PROCESSES:                                                 *29890055
201000*     -POPULATES THE FIELDS RETURNED TO THE CALLING PROGRAM WITH *29900055
201100*      CORRECT VALUES WHEN THE TRANSACTION IS BEING DECLINED     *29910055
201200* ==> PERFORMED FROM: SV005-B100-BALANCE-INQUIRY                 *29920055
201300*                     SV005-B200-NORMAL-ISSUE                    *29930055
201400*                     SV005-B300-NORMAL-TENDER                   *29940055
201500*                     SV005-B510-FETCH-CURSOR                    *29950055
201600***************************************************************** 29960055
201700 SV005-Z300-HARD-DECLINE.                                         29970055
201800     SET SV005-HARD-DECLINE TO TRUE.                              29980055
201900     MOVE ZEROES            TO SV005-APPROVED-TENDER-AMT          29990055
202000                               SV005-KMC-REMAINING-BALANCE.       30000055
202100     MOVE SV005-PC-ZERO-APPROVAL TO SV005-KMC-APPROVAL-NBR.       30010055
202200                                                                  30020055
202300******************************************************************30030055
202400*     SV005-Z400-REFERRAL                                        *30040055
202500* ==> PROCESSES:                                                 *30050055
202600*     -POPULATES THE FIELDS RETURNED TO THE CALLING PROGRAM WITH *30060055
202700*      CORRECT VALUES WHEN THE TRANSACTION IS BEING REFERRED     *30070055
202800* ==> PERFORMED FROM: SV005-B300-NORMAL-TENDER                   *30080055
202900*                     SV005-B100-BALANCE-INQUIRY                 *30090055
203000******************************************************************30100055
203100 SV005-Z400-REFERRAL.                                             30110055
203200                                                                  30120055
203300     SET SV005-REFERRAL     TO TRUE.                              30130055
203400     MOVE ZEROES            TO SV005-APPROVED-TENDER-AMT          30140055
203500                               SV005-KMC-REMAINING-BALANCE.       30150055
203600     MOVE SV005-PC-ZERO-APPROVAL TO SV005-KMC-APPROVAL-NBR.       30160055
203700                                                                  30170055
203800******************************************************************30180055
203900*     SV005-Z500-INVALID-PIN                                     *30190055
204000* ==> PROCESSES:                                                 *30200055
204100*     -POPULATES THE FIELDS RETURNED TO THE CALLING PROGRAM WITH *30210055
204200*      CORRECT VALUES WHEN THE PIN ENTERED WAS INCORRECT         *30220055
204300* ==> PERFORMED FROM:                                            *30230055
204400*     SV005-B100-BALANCE-INQUIRY                                 *30240055
204500*     SV005-B300-NORMAL-TENDER                                   *30250055
204600******************************************************************30260055
204700 SV005-Z500-INVALID-PIN.                                          30270055
204800     SET SV005-INVALID-PIN  TO TRUE.                              30280055
204900     MOVE ZEROES            TO SV005-APPROVED-TENDER-AMT          30290055
205000                               SV005-KMC-REMAINING-BALANCE.       30300055
205100     MOVE SV005-PC-ZERO-APPROVAL TO SV005-KMC-APPROVAL-NBR.       30310055
205200                                                                  30320055
205300******************************************************************30330055
205400*     SV006-A100-MAINLINE                                        *30340055
205500* ==> PROCESSES:                                                 *30350055
205600*     -PROCEDURE THAT CALCULATES THE KMC APPROVAL NUMBER         *30360055
205700* ==> PERFORMED FROM: SV005-Z100-GET-APPROVAL-NUMBER             *30370055
205800******************************************************************30380055
205900     COPY SVPD006.                                                30390049
