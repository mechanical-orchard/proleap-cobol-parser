000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.         SVKUT061.                                    00020000
000300 AUTHOR.             DANIEL OKYERE.                               00030000
000400 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00040000
000500 DATE-WRITTEN.       SEPTEMBER 2004.                              00050000
000600 DATE-COMPILED.                                                   00060000
000700                                                                  00070000
000800******************************************************************00080000
000900* THIS PROGRAM WILL VALIDATE THE SAFEWAY RECONCILIATION FILE AND *00090000
001000* OUTPUT A FILE FOR MATCHING TO THE SV EXTRACT.                  *00100000
001100*                                                                *00110000
001200* INPUT FILES:   SETTLEMENT-FILE           DDNAME = INP01        *00120000
001300*                                                                *00130000
001400* OUTPUT FILES:  DAILY-RECON-FILE          DDNAME = OUT01        *00140000
001500*                                                                *00150000
001600******************************************************************00160000
001700                                                                  00170000
001800******************************************************************00180000
001900 ENVIRONMENT DIVISION.                                            00190000
002000******************************************************************00200000
002100                                                                  00210000
002200 CONFIGURATION SECTION.                                           00220000
002300                                                                  00230000
002400 SOURCE-COMPUTER.    IBM-3090.                                    00240000
002500 OBJECT-COMPUTER.    IBM-3090.                                    00250000
002600                                                                  00260000
002700 INPUT-OUTPUT SECTION.                                            00270000
002800                                                                  00280000
002900 FILE-CONTROL.                                                    00290000
003000                                                                  00300000
003100     SELECT SETTLEMENT-FILE      ASSIGN TO INP01.                 00310000
003200     SELECT DAILY-RECON-FILE     ASSIGN TO OUT01.                 00320000
003300                                                                  00330000
003400******************************************************************00340000
003500 DATA DIVISION.                                                   00350000
003600******************************************************************00360000
003700                                                                  00370000
003800 FILE SECTION.                                                    00380000
003900                                                                  00390000
004000 FD  SETTLEMENT-FILE                                              00400000
004100     RECORDING MODE IS F                                          00410000
004200     BLOCK CONTAINS 0 RECORDS                                     00420000
004300     LABEL RECORDS ARE OMITTED.                                   00430000
004400                                                                  00440000
004500 01  SETTLEMENT-RECORD            PIC  X(465).                    00450000
004600                                                                  00460000
004700 FD  DAILY-RECON-FILE                                             00470000
004800     RECORDING MODE IS F                                          00480000
004900     BLOCK CONTAINS 0 RECORDS                                     00490000
005000     LABEL RECORDS ARE OMITTED.                                   00500000
005100                                                                  00510000
005200 01  DAILY-RECON-RECORD           PIC  X(90).                     00520000
005300                                                                  00530000
005400 WORKING-STORAGE SECTION.                                         00540000
005500                                                                  00550000
005600******************************************************************00560000
005700*    PC-PROGRAM CONSTANTS                                        *00570000
005800******************************************************************00580000
005900 01  PC-PROGRAM-CONSTANTS.                                        00590000
006000     05  PC-PROGRAM-NAME         PIC X(08)      VALUE 'SVKUT061'. 00600000
006100                                                                  00610000
006200******************************************************************00620000
006300*    PV-PROGRAM VARIABLES                                        *00630000
006400******************************************************************00640000
006500 01  PV-PROGRAM-VARIABLES.                                        00650000
006600     05  PV-PARAGRAPH-NAME            PIC  X(30)     VALUE SPACES.00660000
006700     05  PV-OPERATION-MSG-1           PIC  X(30)     VALUE SPACES.00670000
006800     05  PV-TRANSACTION-AMT           PIC  9(12)V9(4).            00680000
006900     05  PV-TRANSACTION-AMT-R REDEFINES PV-TRANSACTION-AMT.       00690000
007000         07 PV-SIGN                   PIC  9.                     00700000
007100         07 PV-DOLLARS                PIC  9(11).                 00710000
007200         07 PV-CENTS                  PIC  9(04).                 00720000
007300                                                                  00730000
007400******************************************************************00740000
007500*    PS-PROGRAM SWITCHES                                         *00750000
007600******************************************************************00760000
007700 01  PS-PROGRAM-SWITCHES.                                         00770000
007800     05  PS-END-OF-SETTLEMENT-FILE-SW PIC  X(01)     VALUE 'N'.   00780000
007900         88  PS-END-OF-SETTLEMENT-FILE               VALUE 'Y'.   00790000
008000     05  PS-FOUND-START-SW            PIC  X(01)     VALUE 'N'.   00800000
008100         88  PS-NOT-FOUND-START                      VALUE 'N'.   00810000
008200         88  PS-FOUND-START                          VALUE 'Y'.   00820000
008300                                                                  00830000
008400******************************************************************00840000
008500*    PA-PROGRAM ACCUMULATORS                                     *00850000
008600******************************************************************00860000
008700 01  PA-PROGRAM-ACCUMULATORS.                                     00870000
008800     05  PA-DETAIL-RECORDS-WRITTEN     PIC 9(08)  VALUE ZEROES.   00880000
008900                                                                  00890000
009000 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      00900000
009100                                                  COMP.           00910000
009200     88  AC-DATASET-DATA-ERROR                    VALUE +4008.    00920000
009300                                                                  00930000
009400******************************************************************00940000
009500*    SAFEWAY SETTLEMENT FILE LAYOUT                              *00950000
009600******************************************************************00960000
009700*    COPY SVRD052.                                                00970000
009800     COPY SVRD068.                                                00980000
009900                                                                  00990000
010000******************************************************************01000000
010100*    RECONCILIATION FILE LAYOUT                                  *01010000
010200******************************************************************01020000
010300     COPY SVRD053.                                                01030000
010400                                                                  01040000
010500******************************************************************01050000
010600* RECORD LAYOUT FOR CONVERSION OF CARD NUMBER                     01060000
010700******************************************************************01070000
010800     COPY SVWS007.                                                01080000
010900                                                                  01090000
011000******************************************************************01100000
011100* STORED VALUE CONSTANTS                                          01110000
011200******************************************************************01120000
011300     COPY SVWS004.                                                01130000
011400                                                                  01140000
011500******************************************************************01150000
011600* PROCEDURE DIVISION                                             *01160000
011700******************************************************************01170000
011800 PROCEDURE DIVISION.                                              01180000
011900                                                                  01190000
012000 0000-MAINLINE-PROCESSING.                                        01200000
012100                                                                  01210000
012200     PERFORM 1000-INITIALIZE-PROGRAM.                             01220000
012300                                                                  01230000
012400     PERFORM 2000-PROCESS-SETTLEMENT-FILE                         01240000
012500       UNTIL PS-END-OF-SETTLEMENT-FILE.                           01250000
012600                                                                  01260000
012700     CLOSE SETTLEMENT-FILE                                        01270000
012800           DAILY-RECON-FILE.                                      01280000
012900                                                                  01290000
013000     GOBACK.                                                      01300000
013100                                                                  01310000
013200******************************************************************01320000
013300* 1000-INITIALIZE-PROGRAM : OPEN INPUT AND OUTPUT FILES AND      *01330000
013400* PERFORM AN INITIAL READ OF THE INPUT FILE AND VERIFY IF THE    *01340000
013500* FIRST RECORD IS A HEADER RECORD.                               *01350000
013600******************************************************************01360000
013700 1000-INITIALIZE-PROGRAM.                                         01370000
013800                                                                  01380000
013900     OPEN INPUT  SETTLEMENT-FILE                                  01390000
014000          OUTPUT DAILY-RECON-FILE.                                01400000
014100     INITIALIZE SV053-DETAIL-TRANS.                               01410000
014200     PERFORM 7000-READ-SETTLEMENT-FILE.                           01420000
014300                                                                  01430000
014400     IF SV068-HEADER                                              01440000
014500         PERFORM 7000-READ-SETTLEMENT-FILE                        01450000
014600     ELSE                                                         01460000
014700         MOVE '1000-INITIALIZE-PROGRAM'     TO PV-PARAGRAPH-NAME  01470000
014800         MOVE 'NO HEADER RECORD FOUND'      TO PV-OPERATION-MSG-1 01480000
014900         PERFORM 9999-ABEND                                       01490000
015000     END-IF.                                                      01500000
015100                                                                  01510000
015200******************************************************************01520000
015300* 2000-PROCESS-SETTLEMENT-FILE                                   *01530000
015400*    PROCESS THE INPUT FILE AND WRITE THE OUTPUT RECORDS         *01540000
015500******************************************************************01550000
015600 2000-PROCESS-SETTLEMENT-FILE.                                    01560000
015700                                                                  01570000
015800     IF SV068-DETAIL                                              01580000
015900         MOVE SV068-GIFT-CARD-NUMBER    TO SV007-CARD-NUMBER-IN   01590000
016000         MOVE SV004-PC-SAFEWAY-CRD-LGTH TO                        01600000
016100                                        SV007-CARD-NUMBER-LENGTH  01610000
016200                                                                  01620000
016300         PERFORM SV007-FORMAT-CARD                                01630000
016400                                                                  01640000
016500         MOVE SV007-CARD-NBR            TO SV053-GIFT-CARD-NBR    01650000
016600                                                                  01660000
016700         MOVE SV068-POS-TRANSACTION-DATE                          01670000
016800                                        TO SV053-TRANSACTION-DATE 01680000
016900         MOVE SV068-POS-TRANSACTION-TIME                          01690000
017000                                        TO SV053-TRANSACTION-TIME 01700000
017100         MOVE SV068-MERCHANT-TRANS-ID(13:4)                       01710000
017200                                        TO SV053-TRANSACTION-NBR  01720000
017300                                                                  01730000
017400         UNSTRING SV068-TRANSACTION-AMOUNT DELIMITED BY "."       01740000
017500             INTO PV-DOLLARS PV-CENTS                             01750000
017600         MOVE ZERO                      TO PV-SIGN                01760000
017700         MOVE PV-TRANSACTION-AMT        TO SV053-TRANSACTION-AMT  01770000
017800* SV053-SAFEWAY-IDENTIFIER                                        01780000
017900         MOVE SV068-MERCHANT-TRANS-ID(5:12)                       01790000
018000                                        TO SV053-INTERNAL-SEQ-NBR 01800000
018100         MOVE SV068-STORE-ID(11:5)      TO SV053-SAFEWAY-STORE-NBR01810000
018200         MOVE SV068-TERMINAL-ID(13:4)   TO SV053-SAFEWAY-RGST-NBR 01820000
018500* mid                                                             01850000
018600         MOVE SV068-MERCHANT-ID(21:5)   TO SV053-SAFEWAY-DIVISION 01860000
018800                                                                  01880000
018900                                                                  01890000
019000* new format does not have state or zip code                      01900000
019400                                                                  01940000
019500         MOVE SV068-APPROVAL-CODE       TO SV053-APPROVAL-CDE     01950000
019600                                                                  01960000
019700         WRITE DAILY-RECON-RECORD FROM SV053-DETAIL-TRANS         01970000
019800         ADD +1 TO PA-DETAIL-RECORDS-WRITTEN                      01980000
019900     ELSE                                                         01990000
020000         IF SV068-TRAILER                                         02000000
020100             PERFORM 3000-PROCESS-TRAILER-RECORD                  02010000
020200         ELSE                                                     02020000
020300             MOVE '2000-PROCESS-SETTLEMENT-FILE' TO               02030000
020400                                               PV-PARAGRAPH-NAME  02040000
020500             MOVE 'NO TRAILER RECORD FOUND' TO PV-OPERATION-MSG-1 02050000
020600             PERFORM 9999-ABEND                                   02060000
020700         END-IF                                                   02070000
020800     END-IF.                                                      02080000
020900                                                                  02090000
021000     PERFORM 7000-READ-SETTLEMENT-FILE.                           02100000
021100                                                                  02110000
021200******************************************************************02120000
021300* 3000-PROCESS-TRAILER-RECORD                                    *02130000
021400*    VALIDATE THE NUMBER OF DETAIL RECORDS IN THE INPUT FILE TO  *02140000
021500*    THE NUMBER OF RECORDS STATED IN THE TRAILER RECORD.         *02150000
021600******************************************************************02160000
021700 3000-PROCESS-TRAILER-RECORD.                                     02170000
021800                                                                  02180000
021900     DISPLAY 'RECORD COUNT ' PA-DETAIL-RECORDS-WRITTEN.           02190000
022000     DISPLAY 'FILE COUNT '   SV068-TOTAL-TRANSACTION-COUNT        02200000
022100                                                                  02210000
022200                                                                  02220000
022300     IF PA-DETAIL-RECORDS-WRITTEN = SV068-TOTAL-TRANSACTION-COUNT 02230000
022400         CONTINUE                                                 02240000
022500     ELSE                                                         02250000
022600         MOVE '3000-PROCESS-TRAILER-RECORD' TO PV-PARAGRAPH-NAME  02260000
022700         MOVE 'INVALID DATA ON DATASET '    TO PV-OPERATION-MSG-1 02270000
022800         SET AC-DATASET-DATA-ERROR          TO TRUE               02280000
022900         PERFORM 9999-ABEND                                       02290000
023000     END-IF.                                                      02300000
023100                                                                  02310000
023200******************************************************************02320000
023300* 7000-READ-SETTLEMENT-FILE                                      *02330000
023400*    READ THE INPUT FILE AND SET THE END OF FILE SWITCH WHEN     *02340000
023500*    THERE IS NO MORE RECORDS TO READ.                           *02350000
023600******************************************************************02360000
023700 7000-READ-SETTLEMENT-FILE.                                       02370000
023800                                                                  02380000
023900     READ SETTLEMENT-FILE INTO SV068-SETTLEMENT-RECORD            02390000
024000         AT END                                                   02400000
024100             SET PS-END-OF-SETTLEMENT-FILE TO TRUE.               02410000
024200                                                                  02420000
024300******************************************************************02430000
024400*   CONVERSION OF CARD NUMBER                                     02440000
024500******************************************************************02450000
024600     COPY SVPD007.                                                02460000
024700                                                                  02470000
024800******************************************************************02480000
024900* 9999-ABEND - PERFORMS A NON-SQL-ABEND                           02490000
025000******************************************************************02500000
025100 9999-ABEND.                                                      02510000
025200     DISPLAY '** ABEND           **'.                             02520000
025300     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          02530000
025400     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        02540000
025500     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       02550000
025600     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         02560000
