000100 IDENTIFICATION DIVISION.                                                 
000200 PROGRAM-ID.    SUKUT060.                                                 
000300 AUTHOR.        DENNIS STEFFEN.                                           
000400 DATE-WRITTEN.  WINTER 2002.                                              
000500 ENVIRONMENT DIVISION.                                                    
000600 INPUT-OUTPUT SECTION.                                                    
000700                                                                          
000800 FILE-CONTROL.                                                            
000900     SELECT CARTON-EXTRACT-FILE ASSIGN TO OUT01.                          
001000                                                                          
001100 DATA DIVISION.                                                           
001200 FILE SECTION.                                                            
001300                                                                          
001400 FD  CARTON-EXTRACT-FILE                                                  
001500     RECORDING MODE IS F                                                  
001600     LABEL RECORDS ARE STANDARD                                           
001700     RECORD CONTAINS 100                                                  
001800     BLOCK CONTAINS 0 RECORDS                                             
001900     DATA RECORD IS CARTON-EXTRACT-RECORD.                                
002000 01  CARTON-EXTRACT-RECORD       PIC X(100).                              
002100                                                                          
002200 WORKING-STORAGE SECTION.                                                 
002300                                                                          
002400 01  PV-ABEND-CODE                    PIC S9(04)   VALUE +0               
002500                                                   COMP SYNC.             
002600                                                                          
002700 01  PS-PROGRAM-SWITCHES.                                                 
002800     05  PS-END-CSR-SW                PIC X(1)   VALUE 'N'.               
002900         88  PS-END-CSR                          VALUE 'Y'.               
003000         88  PS-NOT-END-CSR                      VALUE 'N'.               
003010     05  PS-END-DTL-CSR-SW            PIC X(1)   VALUE 'N'.               
003020         88  PS-END-DTL-CSR                      VALUE 'Y'.               
003030         88  PS-NOT-END-DTL-CSR                  VALUE 'N'.               
003040     05  PS-PO-NBR-CSR-SW             PIC X(1)   VALUE 'N'.               
003050         88  PS-VALID-PO-NBR                     VALUE 'Y'.               
003060         88  PS-INVALID-PO-NBR                   VALUE 'N'.               
003100                                                                          
003110 01  DN-DB2-NULL-INDICATORS.                                              
003120     05  DN-SHUUPC-QTY              PIC S9(04) COMP VALUE ZEROES.         
003200                                                                          
003300 01  PV-PROGRAM-VARIABLES.                                                
003400     05  PV-PREV-PO-NBR               PIC S9(09)  VALUE ZEROES            
003401                                                  COMP.                   
003402     05  PV-PREV-SEQ-NBR              PIC S9(04)  VALUE ZEROES            
003403                                                  COMP.                   
003404     05  PV-PROCESS-DATE              PIC  X(10)  VALUE SPACES.           
003405                                                                          
003410     05  PV-RETRY-COUNT               PIC S9(04)  VALUE +0                
003500                                                  COMP SYNC.              
003600     05  PV-PARAGRAPH-NAME            PIC X(30)   VALUE SPACES.           
003700     05  PV-ERROR-MESSAGE-1           PIC X(60)   VALUE SPACES.           
003800     05  PV-ERROR-MESSAGE-2           PIC X(60)   VALUE SPACES.           
003900     05  PV-SQLCODE                   PIC 9(9)    VALUE ZERO.             
004000     05  PV-CARTON-COUNT              PIC S9(9) COMP-3                    
004001                                                   VALUE ZERO.            
004200     05  PV-COUNT                     PIC S9(9) COMP-3                    
004300                                                   VALUE ZERO.            
004400     05  PV-DISP-NBR                  PIC Z(8)9.                          
004500     05  PV-DISP-PO-NBR               PIC Z(8)9.                          
004600     05  PV-DISP-SEQ-NBR              PIC Z(8)9.                          
004700     05  PV-CRE-DATE                  PIC X(10)   VALUE SPACES.           
004800     05  PV-CRE-TIME                  PIC X(08)   VALUE SPACES.           
004900                                                                          
005000 01  PC-PROGRAM-CONSTANTS.                                                
005100     05  PC-PROGRAM-NAME              PIC X(08)  VALUE 'SUKUT060'.        
005200     05  PC-MAX-RETRIES               PIC S9(04) VALUE +3                 
005300                                                 COMP SYNC.               
005400 01  PV-ABEND-FIELDS.                                                     
005500     05  PV-ABEND-PROGRAM             PIC X(8)   VALUE 'SUKUT060'.        
005600     05  PV-ABEND-PARAGRAPH           PIC X(50)  VALUE SPACES.            
005700     05  PV-ABEND-OPERATION           PIC X(50)  VALUE SPACES.            
005800     05  PV-ABEND-STRUCTURE-1         PIC X(8)   VALUE SPACES.            
005900     05  PV-ABEND-STRUCTURE-2         PIC X(8)   VALUE SPACES.            
006000     05  PV-ABEND-STRUCTURE-3         PIC X(8)   VALUE SPACES.            
006100     05  PV-ABEND-STATUS              PIC XX     VALUE SPACES.            
006200     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.            
006300     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.            
006400     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.            
006500     05  PV-DB2-OPERATION-MESSAGE-4   PIC  X(79) VALUE SPACES.            
006600                                                                          
006700     COPY SURD027.                                                        
006800/                                                                         
006900*  USED FOR DB2 ERROR MESSAGE BUILDING                                    
007000     COPY DPWS004.                                                        
007100                                                                          
007200*   DB2 SQL COMMUNICATION AREA                                            
007300     EXEC SQL                                                             
007400          INCLUDE SQLCA                                                   
007500     END-EXEC.                                                            
007600                                                                          
007700     EXEC SQL                                                             
007800          INCLUDE TCOCNTL                                                 
007900     END-EXEC.                                                            
008000                                                                          
008500     EXEC SQL                                                             
008600          INCLUDE TSHUNLO                                                 
008700     END-EXEC.                                                            
008800                                                                          
008900     EXEC SQL                                                             
009000          INCLUDE TSHUUPC                                                 
009100     END-EXEC.                                                            
009200                                                                          
009300     EXEC SQL                                                             
009400          INCLUDE TINPKSU                                                 
009500     END-EXEC.                                                            
009600                                                                          
009700     EXEC SQL                                                             
009800          INCLUDE TPKSLIP                                                 
009900     END-EXEC.                                                            
010000                                                                          
010100     EXEC SQL                                                             
010200          INCLUDE TPURCHS                                                 
010300     END-EXEC.                                                            
010400*                                                                         
010500* CARTON CURSOR                                                           
010600*    EXEC SQL                                                             
010700*         DECLARE CARTON-CSR CURSOR FOR                                   
010800*      SELECT                                                             
010900*             T1.SHIPT_UNT_ID                                             
011000*      ,      T1.CRE_DATE                                                 
011100*      ,      T1.CRE_TIME                                                 
011200*      ,      T2.OPER_UNT_ID                                              
011300*      ,      T3.TRN_LNE_NBR                                              
011400*      ,      T3.SHPD_QTY                                                 
011500*      ,      T4.PO_NBR                                                   
011600*      ,      T4.SEQ_NBR                                                  
011700*                                                                         
011800*     FROM                                                                
011900*         (SELECT                                                         
012000*             CTL.OPER_UNT_ID                                             
012100*         ,   BXF.SHIPT_UNT_ID                                            
012200*         ,   DATE(BXF.CRE_TMST) AS CRE_DATE                              
012300*         ,   TIME(BXF.CRE_TMST) AS CRE_TIME                              
012400*                                                                         
012500*                                                                         
012600*         FROM                                                            
012700*            TCOCNTL CTL                                                  
012800*         ,  TSULBXF BXF                                                  
012900*                                                                         
013000*         WHERE                                                           
013100*                CTL.BTCH_PRC_DTE = DATE(BXF.CRE_TMST)                    
013200*           AND CTL.OPER_UNT_ID   = 90 ) AS T1                            
013300*                                                                         
013400*     INNER JOIN                                                          
013500*                                                                         
013600*        (SELECT                                                          
013700*           UNLO.SHIPT_UNT_ID                                             
013800*        ,  UNLO.OPER_UNT_ID                                              
013900*         FROM                                                            
014000*           TSHUNLO UNLO                                                  
014100*         WHERE                                                           
014200*           UNLO.ACTV_CDE = 'A' ) AS T2                                   
014300*                                                                         
014400*         ON T1.SHIPT_UNT_ID = T2.SHIPT_UNT_ID                            
014500*                                                                         
014600*         INNER JOIN                                                      
014700*                                                                         
014800*         (SELECT                                                         
014900*             UPC.SHIPT_UNT_ID                                            
015000*         ,   UPC.TRN_NBR                                                 
015100*         ,   UPC.TRN_LNE_NBR                                             
015200*         ,   UPC.SHPD_QTY                                                
015300*                                                                         
015400*         FROM                                                            
015500*             TSHUUPC UPC ) AS T3                                         
015600*                                                                         
015700*         ON T1.SHIPT_UNT_ID = T3.SHIPT_UNT_ID                            
015800*                                                                         
015900*         INNER JOIN                                                      
016000*                                                                         
016100*         (SELECT                                                         
016200*             PKSU.SHIPT_UNT_ID                                           
016300*         ,   PKSU.PO_NBR                                                 
016400*         ,   PKSU.SEQ_NBR                                                
016500*         FROM                                                            
016600*             TINPKSU PKSU)   AS T4                                       
016700*                                                                         
016800*         ON T1.SHIPT_UNT_ID = T4.SHIPT_UNT_ID                            
016900*                                                                         
017000*        ORDER BY                                                         
017100*            T4.PO_NBR                                                    
017200*         ,  T4.SEQ_NBR                                                   
017300*                                                                         
017400*        WITH UR                                                          
017500*                                                                         
017600*    END-EXEC.                                                            
017700                                                                          
017710                                                                          
017711* CARTON CURSOR                                                           
017712     EXEC SQL                                                             
017713          DECLARE CARTON-CSR CURSOR FOR                                   
017714             SELECT                                                       
017716                    A.SHIPT_UNT_ID                                        
017717                  , DATE(A.CRE_TMST) AS CRE_DATE                          
017718                  , TIME(A.CRE_TMST) AS CRE_TIME                          
017719                  , A.OPER_UNT_ID                                         
017720                  , B.PO_NBR                                              
017721                  , B.SEQ_NBR                                             
017726            FROM                                                          
017728                    TSHUNLO A                                             
017729                  , TINPKSU B                                             
017732            WHERE                                                         
017733                    DATE(A.CRE_TMST) =  :PV-PROCESS-DATE                  
017734                AND A.ACTV_CDE       =  'A'                               
017735                AND A.SCN_LOC_ID     =  'RECV'                            
017736                AND A.SHIPT_UNT_ID   =  B.SHIPT_UNT_ID                    
017738                                                                          
017739            ORDER BY                                                      
017740                    B.PO_NBR                                              
017741                  , B.SEQ_NBR                                             
017743     END-EXEC.                                                            
017744                                                                          
017750                                                                          
017818                                                                          
017819                                                                          
017820 PROCEDURE DIVISION.                                                      
017900                                                                          
018000     PERFORM 1000-INIT.                                                   
018100                                                                          
018200     PERFORM 2000-PROCESS                                                 
018300        UNTIL PS-END-CSR.                                                 
018400                                                                          
018500     PERFORM 7020-CLOSE-CARTON-CURSOR.                                    
018600                                                                          
018700     PERFORM 9000-TERMINATE.                                              
018800                                                                          
018900     GOBACK.                                                              
019000                                                                          
019100 1000-INIT.                                                               
019200                                                                          
019210     PERFORM 1050-SELECT-COCNTL.                                          
019220                                                                          
019230     DISPLAY '************************'.                                  
019240     DISPLAY '******* SUKUT060 *******'.                                  
019250     DISPLAY '************************'.                                  
019260     DISPLAY SPACES                                                       
019270     DISPLAY 'PROCESS DATE               = ' PV-PROCESS-DATE.             
019290     DISPLAY SPACES                                                       
019291                                                                          
019300     OPEN OUTPUT CARTON-EXTRACT-FILE.                                     
019400                                                                          
019500     PERFORM 7000-OPEN-CARTON-CURSOR.                                     
019600     PERFORM 7010-FETCH-CARTON-CURSOR.                                    
019700                                                                          
019800                                                                          
019900 1050-SELECT-COCNTL.                                                      
019980                                                                          
019990     EXEC SQL                                                             
019991         SELECT  BTCH_PRC_DTE                                             
019993           INTO :PV-PROCESS-DATE                                          
019995           FROM  TCOCNTL                                                  
019997          WHERE  OPER_UNT_ID  =  90                                       
020001     END-EXEC.                                                            
020002                                                                          
020003     EVALUATE TRUE                                                        
020004         WHEN SQLCODE = ZERO                                              
020010              CONTINUE                                                    
020011         WHEN SQLCODE = -904                                              
020012         WHEN SQLCODE = -911                                              
020013         WHEN SQLCODE = -913                                              
020014              CONTINUE                                                    
020015         WHEN SQLWARN0 NOT = SPACE                                        
020016         WHEN SQLCODE       NOT = +0                                      
020017              MOVE '1050-SELECT-COCNTL'                                   
020018                             TO PV-ABEND-PARAGRAPH                        
020019              MOVE 'SELECT ' TO PV-ABEND-OPERATION                        
020020              MOVE 'TCOCNTL'        TO PV-ABEND-STRUCTURE-1               
020021              PERFORM 9900-DB2-ABEND                                      
020022     END-EVALUATE.                                                        
020023                                                                          
020034                                                                          
020035 2000-PROCESS.                                                            
020036                                                                          
020037     PERFORM 7040-FETCH-CARTON-DTL-CSR.                                   
020047     PERFORM 2000-PROCESS-DETAIL.                                         
020060                                                                          
020080     PERFORM 7010-FETCH-CARTON-CURSOR.                                    
020082                                                                          
020083                                                                          
020084 2000-PROCESS-DETAIL.                                                     
020090                                                                          
020100*    IF THERE IS NO ROW ON TPURCHS, DO NOT WRITE AN EXTRACT               
020110     IF  INPKSU-PO-NBR  =  PV-PREV-PO-NBR                                 
020120         CONTINUE                                                         
020130     ELSE                                                                 
020140         SET  PS-INVALID-PO-NBR       TO  TRUE                            
020200         MOVE INPKSU-PO-NBR           TO  PURCHS-PO-NBR                   
020300         PERFORM 7150-SELECT-TPURCHS                                      
020310     END-IF.                                                              
020320                                                                          
020400     IF  PS-VALID-PO-NBR                                                  
020500         INITIALIZE SU027-CARTON-EXTRACT-RECORD                           
020600                                                                          
020700         MOVE SHUNLO-OPER-UNT-ID      TO  SU027-OPER-UNT-ID               
020800         MOVE SHUNLO-SHIPT-UNT-ID     TO  SU027-SHIPT-UNT-ID              
020900         MOVE INPKSU-PO-NBR           TO  SU027-PO-NBR                    
021000         MOVE SHUUPC-SHPD-QTY         TO  SU027-SHPD-QTY                  
021100                                                                          
021200*    THIS FIELD WILL ALWAYS HAVE THE VALUE 1.  IT WILL BE SUMMED          
021300*    BY SYNCSORT IN A LATER STEP TO PROVIDE THE NUMBER OF CARTONS         
021400*    WITHIN A PO/RECEIVER.                                                
021500         MOVE 1                       TO  SU027-PO-RCVR-CTN-CNT           
021600                                                                          
021700         MOVE SHUUPC-TRN-LNE-NBR      TO  SU027-PO-LNE-NBR                
021800         MOVE PV-CRE-DATE             TO  SU027-CRE-DATE                  
021900         MOVE PV-CRE-TIME             TO  SU027-CRE-TIME                  
022000                                                                          
022001         IF  INPKSU-PO-NBR  =  PV-PREV-PO-NBR AND                         
022010             INPKSU-SEQ-NBR =  PV-PREV-SEQ-NBR                            
022020             CONTINUE                                                     
022030         ELSE                                                             
022100             PERFORM 7100-SELECT-TPKSLIP                                  
022110         END-IF                                                           
022120                                                                          
022200         MOVE PKSLIP-REC-SEQ-NBR      TO  SU027-REC-SEQ-NBR               
022300                                                                          
022400         IF SU027-REC-SEQ-NBR = ZERO                                      
022500             CONTINUE                                                     
022600         ELSE                                                             
022700             PERFORM 8100-WRITE-EXTRACT-REC                               
022800         END-IF                                                           
022900                                                                          
023100     END-IF.                                                              
023101                                                                          
023110     MOVE  INPKSU-PO-NBR   TO  PV-PREV-PO-NBR.                            
023120     MOVE  INPKSU-SEQ-NBR  TO  PV-PREV-SEQ-NBR.                           
023200                                                                          
023210                                                                          
023300 7000-OPEN-CARTON-CURSOR.                                                 
023400     PERFORM                                                              
023500         WITH TEST AFTER                                                  
023600         VARYING PV-RETRY-COUNT                                           
023700         FROM 1 BY 1                                                      
023800         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                         
023900            OR  (SQLCODE = +0))                                           
024000                                                                          
024100         EXEC SQL                                                         
024200             OPEN CARTON-CSR                                              
024300         END-EXEC                                                         
024400                                                                          
024500         EVALUATE TRUE                                                    
024600             WHEN SQLCODE = +0                                            
024700             WHEN SQLCODE = -904                                          
024800             WHEN SQLCODE = -911                                          
024900             WHEN SQLCODE = -913                                          
025000                  CONTINUE                                                
025100             WHEN SQLWARN0 NOT = SPACE                                    
025200             WHEN SQLCODE  NOT = +0                                       
025300                  MOVE '7000-OPEN-CARTON-CURSOR'                          
025400                                 TO PV-ABEND-PARAGRAPH                    
025500                  MOVE 'OPEN CARTON CURSOR'                               
025600                                 TO PV-ABEND-OPERATION                    
025800                  MOVE 'TSULBXF' TO PV-ABEND-STRUCTURE-1                  
025900                  PERFORM 9900-DB2-ABEND                                  
026000         END-EVALUATE                                                     
026100     END-PERFORM.                                                         
026200                                                                          
026300     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                                  
026400         MOVE '7000-OPEN-CARTON-CURSOR'                                   
026500                                 TO PV-ABEND-PARAGRAPH                    
026600         MOVE 'MAX RETRIES EXCEEDED'                                      
026700                                 TO PV-ABEND-OPERATION                    
026800         PERFORM 9900-DB2-ABEND                                           
026900     END-IF.                                                              
027000                                                                          
027100 7010-FETCH-CARTON-CURSOR.                                                
027200                                                                          
027300     EXEC SQL                                                             
027400          FETCH CARTON-CSR                                                
027500           INTO                                                           
027600              :SHUNLO-SHIPT-UNT-ID                                        
027700       ,      :PV-CRE-DATE                                                
027800       ,      :PV-CRE-TIME                                                
027900       ,      :SHUNLO-OPER-UNT-ID                                         
028000       ,      :INPKSU-PO-NBR                                              
028100       ,      :INPKSU-SEQ-NBR                                             
028400     END-EXEC.                                                            
028500                                                                          
028600     EVALUATE TRUE                                                        
028700         WHEN SQLCODE = +0                                                
028800             ADD 1                    TO PV-CARTON-COUNT                  
028900         WHEN SQLCODE = +100                                              
029000              SET PS-END-CSR        TO TRUE                               
029100         WHEN SQLWARN0 NOT = SPACE                                        
029200         WHEN SQLCODE  NOT = +0                                           
029300              MOVE '7010-FETCH-CARTON-CURSOR'                             
029400                                   TO PV-ABEND-PARAGRAPH                  
029500              MOVE 'FETCH CARTON CURSOR'                                  
029600                                   TO PV-ABEND-OPERATION                  
029800              MOVE 'TSULBXF'       TO PV-ABEND-STRUCTURE-1                
029900              PERFORM 9900-DB2-ABEND                                      
030000     END-EVALUATE.                                                        
030100                                                                          
030200 7020-CLOSE-CARTON-CURSOR.                                                
030300                                                                          
030400     PERFORM                                                              
030500         WITH TEST AFTER                                                  
030600         VARYING PV-RETRY-COUNT                                           
030700         FROM 1 BY 1                                                      
030800         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                         
030900            OR  (SQLCODE = +0))                                           
031000                                                                          
031100            EXEC SQL                                                      
031200                CLOSE CARTON-CSR                                          
031300            END-EXEC                                                      
031400                                                                          
031500            EVALUATE TRUE                                                 
031600                WHEN SQLCODE = ZERO                                       
031700                    CONTINUE                                              
031800                WHEN SQLCODE = -911                                       
031900                WHEN SQLCODE = -913                                       
032000                WHEN SQLCODE = -904                                       
032100                    CONTINUE                                              
032200                WHEN SQLCODE  NOT = +0                                    
032300                     MOVE '7020-CLOSE-CARTON-CURSOR'                      
032400                                  TO PV-ABEND-PARAGRAPH                   
032500                     MOVE 'CLOSE CURSOR'                                  
032600                                  TO PV-ABEND-OPERATION                   
032700                     PERFORM 9900-DB2-ABEND                               
032800            END-EVALUATE                                                  
032900                                                                          
033000     END-PERFORM.                                                         
033100                                                                          
033200     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                                  
033300         MOVE '7020-CLOSE-CARTON-CURSOR'                                  
033400                                 TO PV-ABEND-PARAGRAPH                    
033500         MOVE 'MAX RETRIES EXCEEDED'                                      
033600                                 TO PV-ABEND-OPERATION                    
033700         PERFORM 9900-DB2-ABEND                                           
033800     END-IF.                                                              
033900                                                                          
033901                                                                          
034019                                                                          
034020 7040-FETCH-CARTON-DTL-CSR.                                               
034021                                                                          
034022     EXEC SQL                                                             
034023          SELECT   SUM(C.SHPD_QTY)                                        
034024            INTO  :SHUUPC-SHPD-QTY :DN-SHUUPC-QTY                         
034026            FROM   TSHUUPC C                                              
034029            WHERE                                                         
034030                    C.SHIPT_UNT_ID   =  :SHUNLO-SHIPT-UNT-ID              
034032     END-EXEC.                                                            
034040                                                                          
034041     EVALUATE TRUE                                                        
034042         WHEN SQLCODE = +0                                                
034043              IF DN-SHUUPC-QTY = -1                                       
034044                 MOVE ZEROES       TO   SHUUPC-SHPD-QTY                   
034048              END-IF                                                      
034049         WHEN SQLCODE = +100                                              
034050              CONTINUE                                                    
034051         WHEN SQLWARN0 NOT = SPACE                                        
034052         WHEN SQLCODE  NOT = +0                                           
034053              MOVE '7040-FETCH-CARTON-DTL-CSR'                            
034054                                   TO PV-ABEND-PARAGRAPH                  
034055              MOVE 'FETCH CARTON CURSOR'                                  
034056                                   TO PV-ABEND-OPERATION                  
034057              MOVE 'TSHUNLO'       TO PV-ABEND-STRUCTURE-1                
034058              MOVE 'TSHUUPC'       TO PV-ABEND-STRUCTURE-2                
034059              PERFORM 9900-DB2-ABEND                                      
034060     END-EVALUATE.                                                        
034070                                                                          
034090 7100-SELECT-TPKSLIP.                                                     
034100                                                                          
034200     INITIALIZE  PKSLIP-REC-SEQ-NBR                                       
034300                                                                          
034400     PERFORM                                                              
034500         WITH TEST AFTER                                                  
034600         VARYING PV-RETRY-COUNT                                           
034700         FROM 1 BY 1                                                      
034800         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                         
034900            OR  (SQLCODE = +0 OR SQLCODE = +100))                         
035000                                                                          
035100         EXEC SQL                                                         
035200             SELECT                                                       
035300                  PK.REC_SEQ_NBR                                          
035400             INTO                                                         
035500                  :PKSLIP-REC-SEQ-NBR                                     
035600             FROM                                                         
035700                  TPKSLIP PK                                              
035800             WHERE                                                        
035900                 PK.PO_NBR       =  :INPKSU-PO-NBR                        
036000             AND PK.SEQ_NBR      =  :INPKSU-SEQ-NBR                       
036100             AND PK.VER_STAT_CDE =  'A'                                   
036200             WITH UR                                                      
036300         END-EXEC                                                         
036400                                                                          
036500         EVALUATE TRUE                                                    
036600             WHEN SQLCODE = ZERO                                          
036700             WHEN SQLCODE = +100                                          
036800                 CONTINUE                                                 
036900             WHEN SQLCODE = -904                                          
037000             WHEN SQLCODE = -911                                          
037100             WHEN SQLCODE = -913                                          
037200                  CONTINUE                                                
037300             WHEN SQLWARN0 NOT = SPACE                                    
037400             WHEN SQLCODE  NOT = ZERO                                     
037500                  MOVE '7100-SELECT-TPKSLIP'                              
037600                                 TO PV-ABEND-PARAGRAPH                    
037800                  MOVE 'SELECT ' TO PV-ABEND-OPERATION                    
037900                  MOVE 'TPKSLIP'   TO PV-ABEND-STRUCTURE-1                
038000                  MOVE INPKSU-PO-NBR  TO PV-DISP-PO-NBR                   
038100                  MOVE INPKSU-SEQ-NBR TO PV-DISP-SEQ-NBR                  
038200                  DISPLAY 'PO= ' PV-DISP-PO-NBR                           
038300                  DISPLAY 'SEQ= ' PV-DISP-SEQ-NBR                         
038400                  PERFORM 9900-DB2-ABEND                                  
038500         END-EVALUATE                                                     
038600     END-PERFORM.                                                         
038700                                                                          
038800     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                                  
038900            AND NOT (SQLCODE = +0 OR SQLCODE = +100)                      
039000         MOVE '7100-SELECT-TPKSLIP'                                       
039100                                 TO PV-ABEND-PARAGRAPH                    
039200         MOVE 'MAX RETRIES EXCEEDED'                                      
039300                                 TO PV-ABEND-OPERATION                    
039400         PERFORM 9900-DB2-ABEND                                           
039500     END-IF.                                                              
039600                                                                          
039700 7150-SELECT-TPURCHS.                                                     
039800                                                                          
039900     PERFORM                                                              
040000         WITH TEST AFTER                                                  
040100         VARYING PV-RETRY-COUNT                                           
040200         FROM 1 BY 1                                                      
040300         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                         
040400            OR  (SQLCODE = +0 OR SQLCODE = +100))                         
040500                                                                          
040600         EXEC SQL                                                         
040700             SELECT                                                       
040800                  PO.PO_NBR                                               
040900             INTO                                                         
041000                  :PURCHS-PO-NBR                                          
041100             FROM                                                         
041200                  TPURCHS PO                                              
041300             WHERE                                                        
041400                 PO.PO_NBR         =  :PURCHS-PO-NBR                      
041500             AND PO.VER_STATUS_CDE =  'A'                                 
041600             WITH UR                                                      
041700         END-EXEC                                                         
041800                                                                          
041900         EVALUATE TRUE                                                    
042000             WHEN SQLCODE = ZERO                                          
042010                  SET  PS-VALID-PO-NBR  TO  TRUE                          
042020                                                                          
042100             WHEN SQLCODE = +100                                          
042300             WHEN SQLCODE = -904                                          
042400             WHEN SQLCODE = -911                                          
042500             WHEN SQLCODE = -913                                          
042600                  CONTINUE                                                
042610                                                                          
042700             WHEN SQLWARN0 NOT = SPACE                                    
042800             WHEN SQLCODE  NOT = +0                                       
042900                  MOVE '7150-SELECT-TPURCHS'                              
043000                                 TO PV-ABEND-PARAGRAPH                    
043200                  MOVE 'SELECT ' TO PV-ABEND-OPERATION                    
043300                  MOVE 'TPURCHS'   TO PV-ABEND-STRUCTURE-1                
043310                  MOVE PURCHS-PO-NBR  TO PV-DISP-PO-NBR                   
043320                  DISPLAY 'PO= ' PV-DISP-PO-NBR                           
043400                  PERFORM 9900-DB2-ABEND                                  
043500         END-EVALUATE                                                     
043600     END-PERFORM.                                                         
043700                                                                          
043800     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                                  
043900            AND NOT (SQLCODE = +0 OR SQLCODE = +100)                      
044000         MOVE '7150-SELECT-TPURCHS'                                       
044100                                 TO PV-ABEND-PARAGRAPH                    
044200         MOVE 'MAX RETRIES EXCEEDED'                                      
044300                                 TO PV-ABEND-OPERATION                    
044400         PERFORM 9900-DB2-ABEND                                           
044500     END-IF.                                                              
044600                                                                          
044700 8100-WRITE-EXTRACT-REC.                                                  
044800                                                                          
044900     ADD 1                         TO PV-COUNT                            
045000     WRITE CARTON-EXTRACT-RECORD FROM                                     
045100           SU027-CARTON-EXTRACT-RECORD.                                   
045200/                                                                         
045300 9000-TERMINATE.                                                          
045400                                                                          
045500     CLOSE CARTON-EXTRACT-FILE                                            
045600                                                                          
046100     MOVE PV-CARTON-COUNT             TO PV-DISP-NBR                      
046200     DISPLAY 'CARTONS FETCHED            = ' PV-DISP-NBR                  
046400     MOVE PV-COUNT                    TO PV-DISP-NBR                      
046500     DISPLAY 'EXTRACTS WRITTEN           = ' PV-DISP-NBR                  
046600     DISPLAY SPACES                                                       
046700     DISPLAY '************************'.                                  
046800                                                                          
046900 9900-DB2-ABEND.                                                          
047000                                                                          
047100     MOVE SQLCODE TO PV-SQLCODE.                                          
047200     DISPLAY '*** DB2 ERROR '.                                            
047300     DISPLAY '*** SQLCODE   = ' PV-SQLCODE.                               
047400     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                         
047500     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.                       
047600     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.                       
047700     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.               
047800     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.               
047900     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-3.               
048000     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.                     
048100                                                                          
048200     IF PV-ABEND-STRUCTURE-2 > SPACES                                     
048300         DISPLAY '*** TABLE 2   = ' PV-ABEND-STRUCTURE-2                  
048400     END-IF.                                                              
048500                                                                          
048600                                                                          
048700     COPY DPPD004.                                                        
048800                                                                          
048900     IF SQLCODE NOT = -911                                                
049000         EXEC SQL                                                         
049100              ROLLBACK                                                    
049200         END-EXEC                                                         
049300     END-IF.                                                              
049400                                                                          
049500     MOVE +4013                  TO PV-ABEND-CODE.                        
049600     CALL 'ILBOABN0' USING PV-ABEND-CODE.                                 
049700                                                                          
049800*9200-ABEND.                                                              
049900******************************************************************        
050000*  PERFORMS A NON-SQL ABEND FOR THE PROGRAM                               
050100******************************************************************        
050200*    DISPLAY '***************************'.                               
050300*    DISPLAY '**       ABEND           **'.                               
050400*    DISPLAY '**  IN PROGRAM SUKUT060  **'.                               
050500*    DISPLAY '***************************'.                               
050600*    DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.                
050700*    DISPLAY '**                 ** = ' PV-ERROR-MESSAGE-1.               
050800*    DISPLAY '**                 ** = ' PV-ERROR-MESSAGE-2.               
050900*                                                                         
051000*    MOVE +4014                  TO PV-ABEND-CODE.                        
051100*    CALL 'ILBOABN0' USING PV-ABEND-CODE.                                 
051200*                                                                         
