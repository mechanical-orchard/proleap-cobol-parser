000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400 PROGRAM-ID.                SVKUP091.                             00040000
000500 AUTHOR.                    COGNIZANT.                            00050000
000600 INSTALLATION.              KOHLS DEPARTMENT STORES.              00060000
000700 DATE-WRITTEN.              08-16-2018.                           00070000
000800 DATE-COMPILED.                                                   00080000
000900                                                                  00090000
001000******************************************************************00100000
001100*  BATCH PROGRAM - SVKUP091                                      *00110000
001200*                                                                *00120000
001300*  ONE TIME PROGRAM TO COPY THE ORDER NUMBERS FROM THE           *00130000
001400*  POS_OPRT_ID COLUMN TO THE NEWLY ADDED ORD_NBR COLUMN IN THE   *00140000
001500*  SVT_KOHLS_CRD_TXN TABLE.                                      *00150000
001700*                                                                *00160000
001800******************************************************************00170000
001800                                                                  00180000
001900 ENVIRONMENT DIVISION.                                            00190000
002000******************************************************************00200000
002100                                                                  00210000
002200 CONFIGURATION SECTION.                                           00220000
002300                                                                  00230000
002400 SOURCE-COMPUTER.    IBM-3090.                                    00240000
002500 OBJECT-COMPUTER.    IBM-3090.                                    00250000
002600                                                                  00260000
002700 INPUT-OUTPUT SECTION.                                            00270000
002800                                                                  00280000
002900 FILE-CONTROL.                                                    00290000
003300                                                                  00300000
003400******************************************************************00310000
003500 DATA DIVISION.                                                   00320000
003600******************************************************************00330000
003800 FILE SECTION.                                                    00340000
003900                                                                  00350000
004700 WORKING-STORAGE SECTION.                                         00360000
004800                                                                  00370000
004900 01  FILLER                            PIC X(50)  VALUE           00380000
005000     ' *** WORKING STORAGE STARTS HERE FOR SVKUP091 *** '.        00390000
005100                                                                  00400000
005900 01  PS-PROGRAM-SWITCHES.                                         00410000
006000     05  PS-END-OF-ORD-NBR-CURSOR-SW PIC X(01)       VALUE 'N'.   00420001
006100         88  PS-END-OF-ORD-NBR-CURSOR                VALUE 'Y'.   00430001
006900     05  PS-CONTINUE-SW          PIC X(1)          VALUE 'Y'.     00440001
007000         88  PS-CONTINUE                           VALUE 'Y'.     00450001
007100         88  PS-DONT-CONTINUE                      VALUE 'N'.     00460001
007200     05  PS-UPDATE-SUCCESSFUL-SW PIC X(1)          VALUE 'N'.     00470000
007300         88  PS-UPDATE-SUCCESSFUL                  VALUE 'Y'.     00480000
007400         88  PS-UPDATE-NOT-SUCCESSFUL              VALUE 'N'.     00490000
007500                                                                  00500000
007600 01  PC-PROGRAM-CONSTANTS.                                        00510000
007700     05  PC-PROGRAM-NAME         PIC X(8)     VALUE 'SVKUP091'.   00520000
008300                                                                  00530000
008400 01  PV-PROGRAM-VARIABLES.                                        00540000
008600     05  PV-PARAGRAPH-NAME       PIC X(30)         VALUE SPACE.   00550000
008700     05  PV-DB2-OPERATION        PIC X(30)         VALUE SPACE.   00560000
008800     05  PV-OPERATION-MSG        PIC X(30)         VALUE SPACE.   00570000
008800     05  PV-ORD-COUNT            PIC S9(04)        VALUE +0       00570125
008800                                                   COMP SYNC.     00570211
008800     05  PV-POS-OPRT-ID-N        PIC 9(11)         VALUE ZERO.    00571122
008800     05  PV-POS-OPRT-ID-X        PIC X(11)         VALUE SPACE.   00572011
011300                                                                  00580000
011400 01  AC-ABEND-CODE               PIC S9(04)        VALUE ZERO     00590000
011500                                                   COMP SYNC.     00600000
011600     88  AC-CONTROL-CARD-ERROR                     VALUE +4003.   00610000
011700     88  AC-DB2-ERROR                              VALUE +4013.   00620000
011700                                                                  00630000
004900 01  ABEND-CODE                  PIC S9(04)        VALUE +0 COMP. 00640000
012300**********************************************************        00650000
012400*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            00660000
012500**********************************************************        00670000
012600     COPY DPWS004.                                                00680000
013100     05  WORK-STORAGE-PASSED.                                     00690000
013200******************************************************************00700000
013300*PA - PROGRAM ACCUMULATORS                                        00710000
013400******************************************************************00720000
013500        10  PROGRAM-ACCUMULATORS.                                 00730000
013600             15  PA-ORDNBR-UPDATED          PIC S9(11)            00740001
013700                                           VALUE ZERO COMP-3.     00750000
013600             15  PA-ORDNBR-FETCH            PIC S9(11)            00753033
013700                                           VALUE ZERO COMP-3.     00754033
013800             15  PA-UPDATE-TIMES-COMMITTED  PIC S9(11)            00760001
013900                                           VALUE ZERO COMP-3.     00770000
014000             15  PA-TOTAL-ORDNBR-UPDATED    PIC S9(11)            00780001
014100                                           VALUE ZERO COMP-3.     00790000
014600                                                                  00800000
015500******************************************************************00810000
015600*  KOHL'S STORED VALUE TRANSACTION TABLE                         *00820000
015700******************************************************************00830000
015800                                                                  00840000
015900     EXEC SQL                                                     00850000
016000         INCLUDE SVT00002                                         00860000
016100     END-EXEC.                                                    00870000
016200                                                                  00880000
021600******************************************************************00890000
021700*  ORD_NBR_CURSOR                                                 00900001
021800******************************************************************00910000
021900     EXEC SQL                                                     00920000
022000         DECLARE ORD_NBR_CURSOR CURSOR WITH HOLD FOR              00930001
022100          SELECT CRD_NBR                                          00940001
022200                ,TRN_AUTH_TMST                                    00950039
022200                ,POS_OPRT_ID                                      00951039
022300            FROM SVT_KOHLS_CRD_TXN                                00960003
022400           WHERE POS_OPRT_ID > '9999999'                          00970001
022400             AND APVL_USR_ID = ' '                                00971006
022400             AND ORD_NBR IS NULL                                  00972006
022500           WITH UR                                                00990001
022600     END-EXEC.                                                    01000001
025100                                                                  01010000
029300*  STANDARD LAYPUT FOR THE SQL COMMUNICATION AREA.                01020000
029400                                                                  01030000
029500     EXEC SQL                                                     01040000
029600         INCLUDE SQLCA                                            01050000
029700     END-EXEC.                                                    01060000
029800                                                                  01070000
029900******************************************************************01080000
030000 PROCEDURE DIVISION.                                              01090000
030100******************************************************************01100000
030200                                                                  01110000
030300 0000-MAINLINE.                                                   01120000
030400                                                                  01130000
030500     PERFORM 1000-INITIALIZE.                                     01140000
030600                                                                  01150000
037300     PERFORM 2000-PROCESS-ORDNBR.                                 01160001
031000                                                                  01170000
031600     DISPLAY 'TOTAL ORDNBR FETCHED ' PA-ORDNBR-FETCH.             01171037
031300     DISPLAY 'TOTAL COMMITS TAKEN ' PA-UPDATE-TIMES-COMMITTED.    01180001
031400     IF PA-TOTAL-ORDNBR-UPDATED = ZERO                            01190001
031500         MOVE PA-ORDNBR-UPDATED TO PA-TOTAL-ORDNBR-UPDATED        01200034
031500     ELSE                                                         01210034
031500       IF PA-ORDNBR-UPDATED <= 10000                              01210135
038500         ADD PA-ORDNBR-UPDATED TO PA-TOTAL-ORDNBR-UPDATED         01210234
031500     END-IF.                                                      01210334
031600     DISPLAY 'TOTAL ORDNBR UPDATES ' PA-TOTAL-ORDNBR-UPDATED.     01211022
031700                                                                  01220000
031800     GOBACK.                                                      01230000
031900                                                                  01240000
032000******************************************************************01250000
032100* 1000-INITIALIZE-PROGRAM                                         01260000
032300******************************************************************01270000
032400 1000-INITIALIZE.                                                 01280000
032500                                                                  01290000
034000     DISPLAY PC-PROGRAM-NAME ' PROGRAM STARTS'.                   01300030
034200                                                                  01310000
036800******************************************************************01320000
036900* 2000-PROCESS-ORDNBR                                             01330001
037000******************************************************************01340000
037100 2000-PROCESS-ORDNBR.                                             01350001
037200                                                                  01360000
037300     PERFORM 2100-OPEN-ORDER-CURSOR.                              01370001
037400                                                                  01380000
037500     PERFORM 2200-FETCH-ORDER-CURSOR.                             01390001
037600                                                                  01400000
037700     PERFORM 2300-UPDATE-ORDNBR                                   01410001
037800       UNTIL PS-END-OF-ORD-NBR-CURSOR.                            01420001
037900                                                                  01430000
038000     PERFORM 2400-CLOSE-ORDER-CURSOR.                             01440001
038100                                                                  01450000
038800                                                                  01460000
061000*************************************************************     01470000
061100* 2100-OPEN-ORDER-CURSOR                                          01480038
061200*************************************************************     01490000
061300 2100-OPEN-ORDER-CURSOR.                                          01500001
061400                                                                  01510030
061400     EXEC SQL                                                     01511030
061500         OPEN ORD_NBR_CURSOR                                      01520001
061600     END-EXEC.                                                    01530000
061700                                                                  01540000
061800     EVALUATE TRUE                                                01550000
061900        WHEN SQLCODE = ZERO                                       01560000
062000             CONTINUE                                             01570000
062100        WHEN SQLWARN0 NOT EQUAL SPACE                             01580000
062200        WHEN SQLCODE NOT EQUAL ZERO                               01590000
062300            MOVE '2100-OPEN-ORDER-CURSOR'                         01600001
062400                                           TO PV-PARAGRAPH-NAME   01610000
062500            MOVE 'ERROR ON OPEN OF ORD_NBR_CURSOR'                01620001
062600                                           TO PV-DB2-OPERATION    01630000
062700            PERFORM 9100-SQL-ABEND                                01640000
062800     END-EVALUATE.                                                01650000
062900                                                                  01660000
063000******************************************************************01670000
063100* 2200-FETCH-ORDER-CURSOR                                         01680001
063200******************************************************************01690000
063300 2200-FETCH-ORDER-CURSOR.                                         01700001
063400                                                                  01710001
063400     SET PS-DONT-CONTINUE TO TRUE.                                01720001
063400                                                                  01730001
063400     EXEC SQL                                                     01740001
063500         FETCH ORD_NBR_CURSOR                                     01750001
063600           INTO :SVT00002-CRD-NBR                                 01760001
063700              , :SVT00002-TRN-AUTH-TMST                           01770039
063700              , :SVT00002-POS-OPRT-ID                             01771039
064200     END-EXEC.                                                    01780000
064300                                                                  01790000
064400     EVALUATE TRUE                                                01800000
064500        WHEN SQLCODE = ZERO                                       01810000
064600           SET PS-CONTINUE TO TRUE                                01820001
083400           ADD +1 TO PA-ORDNBR-FETCH                              01821033
064700        WHEN SQLCODE = +100                                       01830000
064800           SET PS-END-OF-ORD-NBR-CURSOR TO TRUE                   01840001
064900        WHEN SQLWARN0 NOT EQUAL SPACE                             01850000
065000        WHEN SQLCODE NOT EQUAL ZERO                               01860000
065100           MOVE '2200-FETCH-ORDER-CURSOR' TO PV-PARAGRAPH-NAME    01870001
065200           MOVE 'ERROR ON FETCH OF ORD_NBR_CURSOR'                01880001
065300                                           TO PV-DB2-OPERATION    01890000
065400           PERFORM 9100-SQL-ABEND                                 01900000
065500     END-EVALUATE.                                                01910000
065600                                                                  01920000
038900******************************************************************01930001
039000* 2300-UPDATE-ORDNBR                                              01940001
039100******************************************************************01950001
039200 2300-UPDATE-ORDNBR.                                              01960001
039300                                                                  01970001
039300     IF PS-CONTINUE                                               01980001
039400       MOVE SVT00002-POS-OPRT-ID TO PV-POS-OPRT-ID-N              01980122
039400       MOVE PV-POS-OPRT-ID-N     TO PV-POS-OPRT-ID-X              01980425
039500       INITIALIZE PV-ORD-COUNT                                    01981225
039500       INITIALIZE SVT00002-ORD-NBR                                01981340
039500       INSPECT PV-POS-OPRT-ID-X                                   01981440
039500         TALLYING PV-ORD-COUNT FOR LEADING ZEROES                 01981540
039500       COMPUTE SVT00002-ORD-NBR-LEN = LENGTH OF PV-POS-OPRT-ID-X  01981640
039500                                      - PV-ORD-COUNT              01981740
039400       ADD +1 TO PV-ORD-COUNT                                     01991028
039400       MOVE PV-POS-OPRT-ID-X(PV-ORD-COUNT:SVT00002-ORD-NBR-LEN)   01991127
039400                                 TO SVT00002-ORD-NBR-TEXT         01991227
039500                                                                  02003008
039500       EXEC SQL                                                   02010001
039500       UPDATE SVT_KOHLS_CRD_TXN                                   02020001
039500           SET ORD_NBR     = :SVT00002-ORD-NBR                    02030001
039500       WHERE CRD_NBR       = :SVT00002-CRD-NBR                    02040001
039500         AND TRN_AUTH_TMST = :SVT00002-TRN-AUTH-TMST              02041039
039500         AND POS_OPRT_ID   = :SVT00002-POS-OPRT-ID                02042039
039500       END-EXEC                                                   02050001
040100                                                                  02060001
083200       EVALUATE TRUE                                              02070001
083300           WHEN SQLCODE = ZERO                                    02080001
083400               ADD +1 TO PA-ORDNBR-UPDATED                        02090001
083400               SET PS-UPDATE-SUCCESSFUL TO TRUE                   02100001
083500           WHEN SQLCODE = +100                                    02110001
083600               SET PS-UPDATE-NOT-SUCCESSFUL TO TRUE               02120001
083700           WHEN SQLWARN0 NOT EQUAL SPACE                          02130001
083800           WHEN SQLCODE NOT EQUAL ZERO                            02140001
083900               MOVE '2300-UPDATE-ORDNBR'                          02150001
084000                                              TO PV-PARAGRAPH-NAME02160001
084100               MOVE 'ERROR ON UPDATE OF SVT_KOHLS_CRD_TXN'        02170001
084200                                              TO PV-DB2-OPERATION 02180001
084300               PERFORM 9100-SQL-ABEND                             02190001
084400       END-EVALUATE                                               02200001
084500     END-IF.                                                      02210001
084500                                                                  02211006
038200     IF PA-ORDNBR-UPDATED > 10000                                 02220030
038300         PERFORM 9000-COMMIT                                      02230005
038400         ADD +1 TO PA-UPDATE-TIMES-COMMITTED                      02240005
038500         ADD PA-ORDNBR-UPDATED TO PA-TOTAL-ORDNBR-UPDATED         02250005
038600         MOVE ZERO TO PA-ORDNBR-UPDATED                           02260005
038700     END-IF.                                                      02270005
084500                                                                  02280001
040200     PERFORM 2200-FETCH-ORDER-CURSOR.                             02290001
040300                                                                  02300001
065700*************************************************************     02310000
065800* CLOSE ORDER CURSOR                                              02320038
065900*************************************************************     02330000
066000 2400-CLOSE-ORDER-CURSOR.                                         02340001
066100                                                                  02350000
066200     EXEC SQL                                                     02360000
066300         CLOSE ORD_NBR_CURSOR                                     02370001
066400     END-EXEC.                                                    02380000
066500                                                                  02390000
066600     EVALUATE TRUE                                                02400000
066700         WHEN SQLCODE NOT = 0                                     02410000
066800         WHEN SQLWARN0    = 'W'                                   02420000
066900             DISPLAY ' '                                          02430000
067000             DISPLAY '** ABEND     **'                            02440000
067100             DISPLAY '** PROGRAM   **  = ' PC-PROGRAM-NAME        02450000
067200             DISPLAY '** PARAGRAPH **  = 2400-CLOSE-ORDER-CURSOR' 02460001
067300             DISPLAY '** CLOSE CURSOR TO SVT TABLE'               02470001
067400             PERFORM 9100-SQL-ABEND                               02480000
067500     END-EVALUATE.                                                02490000
067600                                                                  02500000
091500***************************************************************** 02510000
091600*    COMMIT DB2 UPDATES                                           02520000
091700***************************************************************** 02530000
091800 9000-COMMIT.                                                     02540000
091900     EXEC SQL                                                     02550000
092000        COMMIT                                                    02560000
092100     END-EXEC.                                                    02570000
092200                                                                  02580000
092300     EVALUATE TRUE                                                02590000
092400        WHEN SQLCODE = 0                                          02600000
092500            CONTINUE                                              02610000
092600        WHEN OTHER                                                02620000
092700            MOVE '9000-COMMIT' TO PV-PARAGRAPH-NAME               02630000
092800            MOVE 'COMMIT FAILED' TO PV-DB2-OPERATION              02640000
092900            PERFORM 9100-SQL-ABEND                                02650000
093000     END-EVALUATE.                                                02660000
093100                                                                  02670000
093200******************************************************************02680000
093300* 9100-SQL-ABEND - PERFORMS THE ABEND FOR THE PROGRAM IN THE      02690000
093400* EVENT THAT AN SQL ERROR OR WARNING CODE OCCURS.                 02700000
093500******************************************************************02710000
093600 9100-SQL-ABEND.                                                  02720000
093700     DISPLAY '** ABEND     **'.                                   02730000
093800     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                02740000
093900     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              02750000
094000     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               02760000
094100                                                                  02770000
094200******************************************************************02780000
094300* COPYBOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED      02790000
094400* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS       02800000
094500******************************************************************02810000
094600                                                                  02820000
094700     COPY DPPD004.                                                02830000
094800                                                                  02840000
094900     SET AC-DB2-ERROR TO TRUE.                                    02850000
095000     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         02860000
096100                                                                  02970000
