000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400 PROGRAM-ID.   WSKUP019.                                          00040001
000500 AUTHOR.       JOE LAROSA.                                        00050000
000600 INSTALLATION. KOHLS DEPARTMENT STORES.                           00060000
000700 DATE-WRITTEN. MARCH 2007.                                        00070000
000800 DATE-COMPILED.                                                   00080000
000900******************************************************************00090000
001000*       WMOS OUTBOUND TRANSACTION REPOSITORY PURGE PROGRAM        00100001
001100*                                                                 00110000
001200* THIS PROGRAM READS A FILE OF TRANSACTIONS FROM THE DB2          00120007
001300* REPOSITORY TABLE (WST_OTBND_DAT_CNTL) THAT ARE OVER XX          00130007
001400* DAYS OLD, AND DELETES THE CORRESPONDING ROWS FROM THE           00140007
001500* WST_OTBND_DAT_CNTL AND WST_OTBND_DAT_XFER TABLES.               00150007
001810*                                                                 00181005
001820* NOTE: PURGE DATES ARE GOTTEN FROM PARM TABLE AND MAY VARY.      00182005
001900******************************************************************00190000
002000 ENVIRONMENT DIVISION.                                            00200000
002100******************************************************************00210000
002200 CONFIGURATION SECTION.                                           00220000
002300 SOURCE-COMPUTER.        IBM-3090.                                00230000
002400 OBJECT-COMPUTER.        IBM-3090.                                00240000
002500                                                                  00250000
002600 INPUT-OUTPUT SECTION.                                            00260000
002700 FILE-CONTROL.                                                    00270000
002910                                                                  00271007
002920     SELECT INPUT-FILE ASSIGN TO INP01.                           00272007
002930                                                                  00273007
002800******************************************************************00280000
002900 DATA DIVISION.                                                   00290000
003000******************************************************************00300000
003100 FILE SECTION.                                                    00310000
003310                                                                  00311007
003320 FD  INPUT-FILE                                                   00312007
003330     RECORDING MODE F                                             00313007
003340     BLOCK CONTAINS 0 RECORDS                                     00314007
003350     LABEL RECORDS ARE OMITTED.                                   00315007
003360 01  INPUT-REC                        PIC X(38).                  00316007
003200                                                                  00320000
003300 WORKING-STORAGE SECTION.                                         00330000
003400 01  PS-PROGRAM-SWITCHES.                                         00340000
003700     05  PS-INPUT-FILE-EOF-SW        PIC X(01) VALUE 'N'.         00341007
003800         88  PS-INPUT-FILE-EOF-YES             VALUE 'Y'.         00342007
003900         88  PS-INPUT-FILE-EOF-NO              VALUE 'N'.         00343007
005200                                                                  00344007
005100 01  PC-PROGRAM-CONSTANTS.                                        00510000
005200     05  PC-CURRENT-PROGRAM-NAME     PIC X(08) VALUE 'WSKUP019'.  00520001
005400                                                                  00540000
005500 01  PA-PROGRAM-ACCUMULATORS.                                     00550000
005800     05  PA-CNT-CMPLTD               PIC S9(09) COMP-3 VALUE 0.   00551007
006402     05  PA-CNT-OTHER                PIC S9(09) COMP-3 VALUE 0.   00552007
006403     05  PA-CNT-TOTAL                PIC S9(09) COMP-3 VALUE 0.   00553007
006404     05  PA-CNT-ERROR-DTL            PIC S9(09) COMP-3 VALUE 0.   00554007
006405     05  PA-CNT-ERROR-HDR            PIC S9(09) COMP-3 VALUE 0.   00555007
006406     05  PA-CNT-DEL-DTL-CMPLTD       PIC S9(09) COMP-3 VALUE 0.   00556007
006407     05  PA-CNT-DEL-DTL-OTHER        PIC S9(09) COMP-3 VALUE 0.   00557007
006408     05  PA-CNT-DEL-HDR-CMPLTD       PIC S9(09) COMP-3 VALUE 0.   00558007
006409     05  PA-CNT-DEL-HDR-OTHER        PIC S9(09) COMP-3 VALUE 0.   00559007
006500                                                                  00559107
006400 01  PV-PROGRAM-VARIABLES.                                        00640000
006500     05  PV-DISPLAY-COUNT            PIC Z,ZZZ,ZZ9-.              00650007
006500                                                                  00660007
010700 01  PV-ABEND-VARIABLES.                                          01070000
010800     05  PV-ABEND-CODE               PIC S9(4) VALUE +0 COMP SYNC.01080000
011000     05  PV-SQLCODE                  PIC S9(9).                   01100000
011100     05  PV-DISPLAY-SQLCODE          PIC -------999.              01110000
011200     05  PV-ABEND-PROGRAM            PIC X(08) VALUE 'WSKUP019'.  01120001
011300     05  PV-ABEND-PARAGRAPH          PIC X(25) VALUE SPACES.      01130000
011400     05  PV-ABEND-OPERATION          PIC X(20) VALUE SPACES.      01140000
011500     05  PV-ABEND-STRUCTURE-1        PIC X(08) VALUE SPACES.      01150000
011600     05  PV-DB2-OPERATION-MESSAGE-1  PIC X(79) VALUE SPACES.      01160000
011700                                                                  01170000
011970                                                                  01171007
012500******************************************************************01172007
012600*  INPUT RECORD LAYOUT                                            01173007
012700******************************************************************01174007
012800     COPY WSRD052.                                                01175007
012900                                                                  01176007
012300******************************************************************01230000
012400*  DB2 FORMATTED MESSAGE AREA                                     01240000
012500******************************************************************01250000
012600     COPY DPWS004.                                                01260000
012700                                                                  01270000
012800******************************************************************01280000
012900*  COMMUNICATIONS AREA FOR DB2                                    01290000
013000******************************************************************01300000
013100     EXEC SQL                                                     01310000
013200         INCLUDE SQLCA                                            01320000
013300     END-EXEC.                                                    01330000
013400                                                                  01340000
013500******************************************************************01350000
013600*  DB2 TABLE DECLARATION - WMOS OUTBOUND REPOSITORY CONTROL       01360001
013700*      TABLE (WST_OTBND_DAT_CNTL)                                 01370001
013800******************************************************************01380000
013900     EXEC SQL                                                     01390000
014000         INCLUDE WST00005                                         01400001
014100     END-EXEC.                                                    01410000
014200                                                                  01420000
014300******************************************************************01430000
014400*  DB2 TABLE DECLARATION - WMOS OUTBOUND REPOSITORY TRANSACTIONS  01440001
014500*      TABLE (WST_OTBND_DAT_XFER)                                 01450001
014600******************************************************************01460000
014700     EXEC SQL                                                     01470000
014800         INCLUDE WST00006                                         01480001
014900     END-EXEC.                                                    01490000
015000                                                                  01500000
015000                                                                  01510007
023900******************************************************************02390000
024000 LINKAGE SECTION.                                                 02400000
024100******************************************************************02410000
024200                                                                  02420000
024300                                                                  02430000
024400/*****************************************************************02440000
024500 PROCEDURE DIVISION.                                              02450000
024600******************************************************************02460000
024700 0000-PROGRAM-MAINLINE.                                           02470000
024800     DISPLAY '************ START OF WSKUP019 ***************'     02480001
024900                                                                  02490000
025000     PERFORM 1000-INITIALIZE.                                     02500000
025100                                                                  02510000
023800*PROCESS TRANSACTIONS.                                            02511007
023900     PERFORM 2000-PROCESS-RECORDS.                                02512007
025100                                                                  02513007
025800*EOJ ROUTINE.                                                     02580000
025900     PERFORM 9000-EOJ-ROUTINE.                                    02590000
026000                                                                  02600000
026100*STOP                                                             02610000
026200     DISPLAY ' '.                                                 02620000
026300     DISPLAY '************  END OF WSKUP019  ***************'     02630001
026400     STOP RUN.                                                    02640000
026500                                                                  02650000
026600******************************************************************02660000
026700*                                                                *02670000
026800*                I N I T I A L I Z A T I O N                     *02680000
026900*                                                                *02690000
027000******************************************************************02700000
027100 1000-INITIALIZE.                                                 02710000
027200                                                                  02720000
027200     OPEN INPUT INPUT-FILE.                                       02721007
027200                                                                  02722007
027300*INIT COUNTERS.                                                   02730000
027400     INITIALIZE PA-CNT-CMPLTD                                     02740007
027500                PA-CNT-OTHER                                      02750007
027600                PA-CNT-TOTAL                                      02760007
027700                PA-CNT-ERROR-DTL                                  02770007
027800                PA-CNT-ERROR-HDR                                  02780007
027900                PA-CNT-DEL-DTL-CMPLTD                             02790007
028000                PA-CNT-DEL-DTL-OTHER                              02800007
028100                PA-CNT-DEL-HDR-CMPLTD                             02810007
028100                PA-CNT-DEL-HDR-OTHER.                             02811007
028100                                                                  02814007
048900                                                                  04890000
042200******************************************************************04891007
042400*      PROCESS RECORDS                                           *04892007
042600******************************************************************04893007
042700 2000-PROCESS-RECORDS.                                            04894007
042701                                                                  04895007
042702     READ INPUT-FILE INTO WS052-OTBN-REPOSITORY-RECORD            04896007
042703        AT END                                                    04897007
042704           SET PS-INPUT-FILE-EOF-YES  TO TRUE.                    04898007
042705                                                                  04899007
042706     PERFORM 2100-DELETE-RECORDS                                  04899107
042707         UNTIL PS-INPUT-FILE-EOF-YES.                             04899207
042708                                                                  04899307
042709                                                                  04899407
042710******************************************************************04899507
042711*      DELETE THE RECORDS FROM THE TABLES                        *04899607
042712******************************************************************04899707
042713 2100-DELETE-RECORDS.                                             04899807
042714                                                                  04899907
042715     IF WS052-STAT-CDE = 'CMPLTD'                                 04900008
042716         ADD 1                     TO PA-CNT-CMPLTD               04901007
042717     ELSE                                                         04902007
042718         ADD 1                     TO PA-CNT-OTHER                04903007
042719     END-IF.                                                      04904007
042720                                                                  04905007
042724     PERFORM 3210-DELETE-XFER-ROW.                                04908007
042725     PERFORM 2400-DELETE-CNTL.                                    04909007
042726                                                                  04909107
042727*COMMIT THE DATA.                                                 04909207
042728     IF PA-CNT-TOTAL > 1000                                       04909311
042729         PERFORM 2800-COMMIT                                      04909407
042732         MOVE 0                    TO PA-CNT-TOTAL                04909707
042733     END-IF.                                                      04909807
042734                                                                  04909907
042735     READ INPUT-FILE INTO WS052-OTBN-REPOSITORY-RECORD            04910007
042736        AT END                                                    04911007
042737           SET PS-INPUT-FILE-EOF-YES  TO TRUE.                    04912007
042738                                                                  04913007
042708                                                                  04920007
055100******************************************************************04930007
055200 2400-DELETE-CNTL.                                                04940007
055300                                                                  04950007
055400     EXEC SQL                                                     04960007
055500         DELETE FROM WST_OTBND_DAT_CNTL                           04970007
055600          WHERE PRC_CNTL_TMST = :WS052-PRC-CNTL-TMST              04980007
055700            AND TRN_TYP_CDE   = :WS052-TRN-TYP-CDE                04990007
056000     END-EXEC.                                                    05020007
056100                                                                  05030007
056200     EVALUATE TRUE                                                05040007
056300       WHEN SQLCODE = ZERO                                        05050007
056410           IF WS052-STAT-CDE = 'CMPLTD'                           05060007
056420               ADD 1                  TO PA-CNT-DEL-HDR-CMPLTD    05070007
056430           ELSE                                                   05080007
056440               ADD 1                  TO PA-CNT-DEL-HDR-OTHER     05090007
056450           END-IF                                                 05100007
      * COUNT NUMBER OF ROWS DELETED TO DETERMINE WHEN TO COMMIT        05101011
                 ADD SQLERRD(3)         TO PA-CNT-TOTAL                 05102011
056500                                                                  05110007
056510       WHEN SQLCODE = +100                                        05120007
056520           CONTINUE                                               05130007
056600       WHEN OTHER                                                 05140007
056610           ADD 1                      TO PA-CNT-ERROR-HDR         05150007
056700           MOVE '2400-DELETE-CNTL'    TO PV-ABEND-PARAGRAPH       05160007
056800           MOVE 'DELETE WST_OTBND_DAT_CNTL'                       05170007
056800                                      TO PV-ABEND-OPERATION       05171007
056900           MOVE DCLWST00005 TO PV-DB2-OPERATION-MESSAGE-1         05180007
057000           PERFORM 9900-DB2-ABEND                                 05190007
057100     END-EVALUATE.                                                05200007
061100                                                                  06110000
061200******************************************************************06120000
061300 2800-COMMIT.                                                     06130000
061400                                                                  06140000
061500     EXEC SQL                                                     06150000
061600         COMMIT                                                   06160000
061700     END-EXEC.                                                    06170000
061800                                                                  06180000
061900     EVALUATE TRUE                                                06190000
062000       WHEN SQLCODE = ZERO                                        06200000
042730           MOVE PA-CNT-TOTAL          TO PV-DISPLAY-COUNT         06211009
042731           DISPLAY ' COMMIT COUNT = '    PV-DISPLAY-COUNT         06212009
062200                                                                  06220000
062300       WHEN OTHER                                                 06230000
062400           MOVE '2800-COMMIT'        TO PV-ABEND-PARAGRAPH        06240000
062500           MOVE 'COMMIT LOAD TABLES' TO PV-ABEND-OPERATION        06250000
062600           PERFORM 9900-DB2-ABEND                                 06260000
062700     END-EVALUATE.                                                06270000
062800                                                                  06280000
062900                                                                  06290007
068300******************************************************************06830000
068400 3210-DELETE-XFER-ROW.                                            06840000
068500                                                                  06850000
069200     EXEC SQL                                                     06920007
069300         DELETE FROM WST_OTBND_DAT_XFER                           06930007
069400            WHERE PRC_CNTL_TMST = :WS052-PRC-CNTL-TMST            06940007
069400              AND TRN_TYP_CDE   = :WS052-TRN-TYP-CDE              06941007
069500     END-EXEC.                                                    06950007
069600                                                                  06960000
069700     EVALUATE TRUE                                                06970007
069800         WHEN SQLCODE = ZERO                                      06980007
067900             IF WS052-STAT-CDE = 'CMPLTD'                         06981007
068000                 ADD SQLERRD(3)         TO PA-CNT-DEL-DTL-CMPLTD  06982007
068100             ELSE                                                 06983007
068200                 ADD SQLERRD(3)         TO PA-CNT-DEL-DTL-OTHER   06984007
068300             END-IF                                               06985007
      * COUNT NUMBER OF ROWS DELETED TO DETERMINE WHEN TO COMMIT        06985111
                   ADD SQLERRD(3)         TO PA-CNT-TOTAL               06985211
070800                                                                  07080000
070900         WHEN SQLCODE = +100                                      07090007
070900         WHEN SQLCODE = -911                                      07091007
071000         WHEN SQLCODE = -913                                      07100007
071100             CONTINUE                                             07110007
071200                                                                  07120000
071300         WHEN OTHER                                               07130007
069210             ADD 1                       TO PA-CNT-ERROR-DTL      07131007
071400             MOVE '3210-DELETE-XFER-ROW' TO PV-ABEND-PARAGRAPH    07140007
071500             MOVE 'DELETE WST_OTBND_DAT_XFER'                     07150007
071600                                         TO PV-ABEND-OPERATION    07160007
071700             MOVE DCLWST00005    TO PV-DB2-OPERATION-MESSAGE-1    07170007
071800             PERFORM 9900-DB2-ABEND                               07180007
071900     END-EVALUATE.                                                07190007
072100                                                                  07210000
099800                                                                  09980000
099900******************************************************************09990000
100000*                                                                *10000000
100100*                   E O J   P R O C E S S I N G                  *10010000
100200*                                                                *10020000
100300******************************************************************10030000
100400 9000-EOJ-ROUTINE.                                                10040000
100500                                                                  10050000
097610     PERFORM 2800-COMMIT.                                         10051007
097620                                                                  10052007
100600     DISPLAY ' '.                                                 10060000
100700     DISPLAY '*******************************************'.       10070000
100800     DISPLAY '      * WSKUP019 SUMMARY STATISTICS *      '.       10080001
100900     DISPLAY ' '.                                                 10090000
101000     DISPLAY '      -------------------------------      '.       10100000
101100     DISPLAY '       LOAD REPOSITORY PURGE RESULTS       '.       10110000
101200     DISPLAY '      -------------------------------      '.       10120000
098310     DISPLAY SPACES.                                              10121007
098400     MOVE PA-CNT-CMPLTD                   TO PV-DISPLAY-COUNT.    10122007
098500     DISPLAY ' CMPLTD HEADERS         ='     PV-DISPLAY-COUNT.    10123007
098600                                                                  10124007
098610     MOVE PA-CNT-OTHER                    TO PV-DISPLAY-COUNT.    10125007
098620     DISPLAY ' OTHER HEADERS          ='     PV-DISPLAY-COUNT.    10126007
098630                                                                  10127007
098700     MOVE PA-CNT-DEL-DTL-CMPLTD           TO PV-DISPLAY-COUNT.    10128007
098800     DISPLAY ' DELETED DTL FOR CMPLTD ='     PV-DISPLAY-COUNT.    10129007
098900                                                                  10129107
098910     MOVE PA-CNT-DEL-DTL-OTHER            TO PV-DISPLAY-COUNT.    10129207
098920     DISPLAY ' DELETED DTL FOR OTHER  ='     PV-DISPLAY-COUNT.    10129307
098921                                                                  10129407
098922     MOVE PA-CNT-ERROR-DTL                TO PV-DISPLAY-COUNT.    10129507
098923     DISPLAY ' ERRORS ON DETAIL DEL   ='     PV-DISPLAY-COUNT.    10129607
098930                                                                  10129707
098931     MOVE PA-CNT-ERROR-HDR                TO PV-DISPLAY-COUNT.    10129807
098932     DISPLAY ' ERRORS ON HEADER DEL   ='     PV-DISPLAY-COUNT.    10129907
098933                                                                  10130007
098940     DISPLAY SPACES.                                              10130107
099700     DISPLAY '*******************************************'.       10130207
099800                                                                  10130307
099810     CLOSE INPUT-FILE.                                            10130407
099820                                                                  10130507
102700                                                                  10270000
102800******************************************************************10280000
102900* 9900-DB2-ABEND - PERFORMS THE ABEND FOR THE PROGRAM IN THE      10290000
103000* EVENT THAT AN SQL ERROR OR WARNING CODE OCCURS.                 10300000
103100******************************************************************10310000
103200 9900-DB2-ABEND.                                                  10320000
103300                                                                  10330000
103400     MOVE SQLCODE    TO PV-SQLCODE.                               10340000
103500     MOVE PV-SQLCODE TO PV-DISPLAY-SQLCODE.                       10350000
103600     DISPLAY '*** DB2 ERROR ***'.                                 10360000
103700     DISPLAY '*** SQLCODE   = ' PV-DISPLAY-SQLCODE.               10370000
103800     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 10380000
103900     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               10390000
104000     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               10400000
104100     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       10410000
104200     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.             10420000
104300                                                                  10430000
104400******************************************************************10440000
104500* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    10450000
104600* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         10460000
104700* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     10470000
104800* FORMAT.                                                         10480000
104900******************************************************************10490000
105000     COPY DPPD004.                                                10500000
105100                                                                  10510000
105200     IF SQLCODE NOT = -911                                        10520000
105300         EXEC SQL                                                 10530000
105400             ROLLBACK                                             10540000
105500         END-EXEC                                                 10550000
105600     END-IF.                                                      10560000
105700                                                                  10570000
105800     MOVE +4013         TO PV-ABEND-CODE.                         10580000
105900     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         10590000
106000******************************************************************10600000
106100******************************************************************10610000
