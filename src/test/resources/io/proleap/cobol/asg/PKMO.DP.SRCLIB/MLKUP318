000100 IDENTIFICATION DIVISION.                                         00010000
000200                                                                  00020000
000300 PROGRAM-ID.    MLKUP318.                                         00030000
000400 AUTHOR.        DAVE METZGER.                                     00040000
000500 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00050000
000600 DATE-WRITTEN.  07-24-98.                                         00060000
000700 DATE-COMPILED.                                                   00070000
000800                                                                  00080000
000900******************************************************************00090000
001000* MLKUP318 - POST PERIOD UPDATES TO DB2 TABLE TMLCNTL             00100000
000900******************************************************************00100142
      *  !!! THIS PROGRAM IS EXECUTED IN JOBS MLK140 AND MWK178 !!!     00100242
      ******************************************************************00101042
001100*                                                                 00110000
001200*  UPDATE THE POSTING MONTH END DATE AND MONTH NUMBER AND MAX     00120000
001202*  POSTING MONTH END DATE AND MONTH NUMBER COLUMNS ON DB2 TABLE   00120200
001210*  TMLCNTL BASED ON THE CONTROL CARD DATE BEING PROCESSED.  THE   00121000
001300*  CONTROL CARD DATE WILL BE A FISCAL MONTH END DATE (CCYY-MM-DD) 00130000
001400*  TO WHICH THE CURRENT LEDGER RUN WILL BE POSTING.               00140000
001600*                                                                 00160000
001700******************************************************************00170000
001800                                                                  00180000
001900 ENVIRONMENT DIVISION.                                            00190000
002000                                                                  00200000
002100 CONFIGURATION SECTION.                                           00210000
002200 SOURCE-COMPUTER.        IBM-3090.                                00220000
002300 OBJECT-COMPUTER.        IBM-3090.                                00230000
002400                                                                  00240000
002500 INPUT-OUTPUT SECTION.                                            00250000
002600 FILE-CONTROL.                                                    00260000
002700                                                                  00270000
002800     SELECT CONTROL-DATE-FILE                                     00280000
002900         ASSIGN TO INP01.                                         00290000
003000                                                                  00300000
003100******************************************************************00310000
003200 DATA DIVISION.                                                   00320000
003300******************************************************************00330000
003400 FILE SECTION.                                                    00340000
003500                                                                  00350000
003600 FD  CONTROL-DATE-FILE                                            00360000
003700     LABEL RECORDS ARE STANDARD                                   00370000
003800     RECORDING MODE IS F                                          00380000
003900     BLOCK CONTAINS 0 RECORDS.                                    00390000
004000 01  CONTROL-DATE-RECORD          PIC X(80).                      00400000
004100                                                                  00410000
004200 WORKING-STORAGE SECTION.                                         00420000
004300                                                                  00430000
004400 01  FILLER                      PIC X(40)                        00440000
004500      VALUE '***** WORKING STORAGE STARTS HERE ******'.           00450000
004600                                                                  00460000
004700******************************************************************00470000
004800*** DATE CONTROL CARD RECORD LAYOUT                               00480000
004900******************************************************************00490000
005000*** CONTROL DATE MUST BE IN CCYY-MM-DD FORMAT                     00500000
005100*** AND MUST BE A FISCAL WEEK END DATE                            00510000
005200******************************************************************00520000
005300 01  CC-CONTROL-RECORD.                                           00530000
005400     05  FILLER                  PIC X(03).                       00540000
005500     05  CC-FSCL-WEEK-END-DTE    PIC X(10).                       00550000
005600     05  FILLER                  PIC X(67).                       00560000
005700******************************************************************00570000
005800*** MISCELLANEOUS PROGRAM CONSTANTS                               00580000
005900******************************************************************00590000
006000*                                                                 00600000
006100 01  PC-PROGRAM-CONSTANTS.                                        00610000
006200     05  PC-MAX-RETRIES           PIC S9(01)   VALUE +3.          00620000
006300                                                                  00630000
006400******************************************************************00640000
006500*** MISCELLANEOUS PROGRAM VARIABLES                               00650000
006600******************************************************************00660000
006700*                                                                 00670000
006800 01  PV-PROGRAM-VARIABLES.                                        00680000
006900     05  PV-RETRY-CNT              PIC  9(01) VALUE ZEROES.       00690000
007000     05  PV-OLD-PSTG-FSCL-MN-DTE   PIC X(10) VALUE  SPACES.       00700000
007100     05  PV-OLD-PSTG-FSCL-MN-NBR   PIC X(02) VALUE  SPACES.       00710000
007200     05  PV-OLD-PSTG-FSCL-WK-DTE   PIC X(10) VALUE  SPACES.       00720000
007300     05  PV-OLD-PSTG-FSCL-WK-NBR   PIC X(02) VALUE  SPACES.       00730000
007400     05  PV-OLD-MXPSTG-FSCL-MN-DTE PIC X(10) VALUE  SPACES.       00740000
007500     05  PV-OLD-MXPSTG-FSCL-MN-NBR PIC X(02) VALUE  SPACES.       00750000
007400     05  PV-OLD-MXPSTG-FSCL-WK-DTE PIC X(10) VALUE  SPACES.       00751000
007500     05  PV-OLD-MXPSTG-FSCL-WK-NBR PIC X(02) VALUE  SPACES.       00752000
007600                                                                  00760000
007700*                                                                 00770000
007800 01  PROGRAM-ERROR-MESSAGES.                                      00780000
007810    05  PE-MSG-01                    PIC X(25)      VALUE         00781000
007820         'CONTROL CARD EMPTY'.                                    00782000
007830    05  PE-MSG-02                    PIC X(42)      VALUE         00783000
007840         'CONTROL DATE NOT A FISCAL WEEK END DATE'.               00784000
007900    05  PE-MSG-03                    PIC X(25)      VALUE         00790000
008000         'SELECT TDTATTR ROW'.                                    00800000
008100    05  PE-MSG-04                    PIC X(25)      VALUE         00810000
008200         'SELECT TMLCNTL ROW'.                                    00820000
008300    05  PE-MSG-05                    PIC X(25)      VALUE         00830000
008400         'UPDATE FSCL DATES'.                                     00840000
008410    05  PE-MSG-06                    PIC X(25)      VALUE         00841000
008420         'UPDATE MAX DATES'.                                      00842000
008500    05  PE-MSG-07                    PIC X(25)      VALUE         00850000
008600         'MAX RETRIES EXCEEDED'.                                  00860000
008610    05  PE-MSG-08                    PIC X(25)      VALUE         00861000
008611        'TDTATTR ROW NOT FOUND'.                                  00861100
008612    05  PE-MSG-09                    PIC X(35)      VALUE         00861200
008614        'TMLCNTL ROW NOT FOUND - NONE EXIST'.                     00861400
008615    05  PE-MSG-10                    PIC X(25)      VALUE         00861500
008616        'TDTATTR TABLE WARNING'.                                  00861600
008617    05  PE-MSG-11                    PIC X(25)      VALUE         00861700
008618        'TDTATTR TABLE ERROR'.                                    00861800
008619    05  PE-MSG-12                    PIC X(25)      VALUE         00861900
008620        'TMLCNTL TABLE WARNING'.                                  00862000
008621    05  PE-MSG-13                    PIC X(25)      VALUE         00862100
008622        'TMLCNTL TABLE ERROR'.                                    00862200
008630                                                                  00863000
008900 EJECT                                                            00890000
009000******************************************************************00900000
009100*  ABEND AREA                                                     00910000
009200******************************************************************00920000
009300*                                                                 00930000
009400 01 ABEND-AREAS.                                                  00940000
009500     05 ABEND-CODE               PIC S9(04)  VALUE ZERO           00950000
009600                                             COMP SYNC.           00960000
009700         88  AC-BAD-DATA                     VALUE +4003.         00970000
009800         88  AC-DB2-ERROR                    VALUE +4013.         00980000
009900     05  AA-ABEND-LIT            PIC X(40)   VALUE                00990000
010000           '*****       ABEND'.                                   01000000
010100     05  AA-PROGRAM-LIT          PIC X(40)   VALUE                01010000
010200             '*****   PROGRAM: MLKUP318'.                         01020000
010300     05  AA-PARAGRAPH-LIT.                                        01030000
010400         10  FILLER              PIC X(17)   VALUE                01040000
010500             '***** PARAGRAPH: '.                                 01050000
010600         10  AA-PARAGRAPH-NAME   PIC X(35)   VALUE SPACES.        01060000
010700     05  AA-MESSAGE-LINE.                                         01070000
010800         10  FILLER              PIC X(06)   VALUE '*****'.       01080000
010900         10  AA-MESSAGE          PIC X(127)  VALUE SPACES.        01090000
011000     05  AA-DB2-ERROR-LIT        PIC X(40)   VALUE                01100000
011100             '*****    DB2 ERROR'.                                01110000
011200     05  AA-DB2-OPERATION-LIT.                                    01120000
011300         10  FILLER              PIC X(17)   VALUE                01130000
011400             '***** OPERATION: '.                                 01140000
011500         10  AA-DB2-OPERATION.                                    01150000
011600             15  AA-DB2-OP-1     PIC X(25)   VALUE SPACES.        01160000
011700             15  AA-DB2-OP-2     PIC X(25)   VALUE SPACES.        01170000
012200                                                                  01220000
012300 EJECT                                                            01230000
012400                                                                  01240000
012500******************************************************************01250000
012600*  DB2 ERROR MESSAGES FORMAT AREA.                                01260000
012700******************************************************************01270000
012800*                                                                 01280000
012900     COPY DPWS004.                                                01290000
013000                                                                  01300000
013100******************************************************************01310000
013200*  USED FOR DB2 ERRORS                                            01320000
013300******************************************************************01330000
013400*                                                                 01340000
013500     EXEC SQL                                                     01350000
013600         INCLUDE SQLCA                                            01360000
013700     END-EXEC.                                                    01370000
013800                                                                  01380000
013900******************************************************************01390000
014000*  LAYOUT FOR DATE TABLE                                          01400000
014100******************************************************************01410000
014200*                                                                 01420000
014300     EXEC SQL                                                     01430000
014400         INCLUDE TDTATTR                                          01440000
014500     END-EXEC.                                                    01450000
014600                                                                  01460000
014700******************************************************************01470000
014800*  LAYOUT FOR OPEN FISCAL PERIOD TABLE                            01480000
014900******************************************************************01490000
015000*                                                                 01500000
015100     EXEC SQL                                                     01510000
015200         INCLUDE TMLCNTL                                          01520000
015300     END-EXEC.                                                    01530000
015400                                                                  01540000
015500 01  FILLER                      PIC X(22)                        01550000
015600     VALUE 'END OF WORKING STORAGE'.                              01560000
015700                                                                  01570000
015800 EJECT                                                            01580000
015900                                                                  01590000
016000*================================================================*01600000
016100 PROCEDURE DIVISION.                                              01610000
016200*================================================================*01620000
016300                                                                  01630000
016400******************************************************************01640000
016500*  MAINLINE                                                       01650000
016600******************************************************************01660000
016700 0000-MAINLINE.                                                   01670000
016800                                                                  01680000
016900     PERFORM 1000-INITIALIZATION.                                 01690000
017000                                                                  01700000
017100     PERFORM 2000-PROCESS-CONTROL-DATE.                           01710000
017200                                                                  01720000
017300     PERFORM 8000-EOJ-PROCESS.                                    01730000
017400                                                                  01740000
017500     STOP RUN.                                                    01750000
017600                                                                  01760000
017700 EJECT                                                            01770000
017800                                                                  01780000
017900******************************************************************01790000
018000* PERFORM INITIALIZATION PROCESSES (OPEN, FIRST READ, EDIT DATE)  01800000
018100******************************************************************01810000
018200 1000-INITIALIZATION.                                             01820000
018300                                                                  01830000
018400     OPEN INPUT CONTROL-DATE-FILE.                                01840000
018500                                                                  01850000
018600     PERFORM 1100-READ-CONTROL-DATE-FILE.                         01860000
018700                                                                  01870000
018800     DISPLAY ' '.                                                 01880000
018900     DISPLAY '***===================================***'          01890000
019000     DISPLAY '*** INPUT CONTROL CARD PROCESSED      ***'.         01900000
019100     DISPLAY '***===================================***'          01910000
019200     DISPLAY CC-CONTROL-RECORD.                                   01920000
019300                                                                  01930000
019400     PERFORM 1200-VERIFY-CONTROL-DATE.                            01940000
019500                                                                  01950000
019600 EJECT                                                            01960000
019700                                                                  01970000
019800******************************************************************01980000
019900* READ THE THE LEDGER CONTROL CARD DATE                           01990000
020000******************************************************************02000000
020100 1100-READ-CONTROL-DATE-FILE.                                     02010000
020200                                                                  02020000
020300     READ CONTROL-DATE-FILE                                       02030000
020400         INTO CC-CONTROL-RECORD                                   02040000
020500         AT END                                                   02050000
020600             MOVE '1100-READ-CONTROL-DATE-FILE'                   02060000
020700                                 TO AA-PARAGRAPH-NAME             02070000
020800             MOVE PE-MSG-01      TO AA-MESSAGE                    02080000
021000             MOVE +4002          TO ABEND-CODE                    02100000
021100             PERFORM 9900-COMMON-ABEND-ROUTINE                    02110000
021200     END-READ.                                                    02120000
021300                                                                  02130000
021400 EJECT                                                            02140000
021500                                                                  02150000
021600******************************************************************02160000
021700* IF CONTROL CARD DATE IS NOT A FISCAL WEEK END DATE, ABEND       02170000
021800******************************************************************02180000
021900 1200-VERIFY-CONTROL-DATE.                                        02190000
022000                                                                  02200000
022100     MOVE CC-FSCL-WEEK-END-DTE  TO DTATTR-KY-DTE.                 02210000
022200     PERFORM 7000-SELECT-TDTATTR.                                 02220000
022300                                                                  02230000
022400     IF CC-FSCL-WEEK-END-DTE = DTATTR-FSCL-WK-END-DTE             02240000
022500         NEXT SENTENCE                                            02250000
022600     ELSE                                                         02260000
022700         MOVE '1200-VERIFY-CONTROL-DATE'                          02270000
022800                                 TO AA-PARAGRAPH-NAME             02280000
022900         MOVE PE-MSG-02          TO AA-MESSAGE                    02290000
022900         DISPLAY 'ACCORDING TO CNTL CARD WEEK END DATE SHOULD BE '02300000
022900                                    DTATTR-FSCL-WK-END-DTE        02301000
023100         MOVE +4004              TO ABEND-CODE                    02310000
023200         PERFORM 9900-COMMON-ABEND-ROUTINE                        02320000
023300     END-IF.                                                      02330000
023400                                                                  02340000
023500 EJECT                                                            02350000
023600                                                                  02360000
023700******************************************************************02370000
023800*  PROCESS THE CONTROL CARD DATE.  UPDATE THE POSTING DATES ON    02380000
023900*  TMLCNTL AND MAX POSTING DATES IF THE CONTROL CARD FISCAL WEEK  02390041
024000*  END DATE IS GREATER THAN THE CURRENT MAX WEEK POSTING DATE.    02400041
024100******************************************************************02410000
024200 2000-PROCESS-CONTROL-DATE.                                       02420000
024300                                                                  02430000
024400     PERFORM 7100-SELECT-TMLCNTL.                                 02440000
024500                                                                  02450000
024600*** MOVE OLD VALUES FROM TMLCNTL TO WS VARIABLES FOR DISPLAY      02460000
024700     MOVE MLCNTL-PSTG-FSCL-MN-DTE   TO PV-OLD-PSTG-FSCL-MN-DTE.   02470000
024800     MOVE MLCNTL-PSTG-FSCL-MN-NBR   TO PV-OLD-PSTG-FSCL-MN-NBR.   02480000
024900     MOVE MLCNTL-PSTG-FSCL-WK-DTE   TO PV-OLD-PSTG-FSCL-WK-DTE.   02490000
025000     MOVE MLCNTL-PSTG-FSCL-WK-NBR   TO PV-OLD-PSTG-FSCL-WK-NBR.   02500000
025100     MOVE MLCNTL-MXPSTG-FSCL-MN-DTE TO PV-OLD-MXPSTG-FSCL-MN-DTE. 02510000
025200     MOVE MLCNTL-MXPSTG-FSCL-MN-NBR TO PV-OLD-MXPSTG-FSCL-MN-NBR. 02520000
025100     MOVE MLCNTL-MXPSTG-FSCL-WK-DTE TO PV-OLD-MXPSTG-FSCL-WK-DTE. 02521000
025200     MOVE MLCNTL-MXPSTG-FSCL-WK-NBR TO PV-OLD-MXPSTG-FSCL-WK-NBR. 02522000
025300                                                                  02530000
025400*** MOVE NEW VALUES FROM TDTATTR TO TMLCNTL FOR UPDATE            02540000
025500     MOVE DTATTR-FSCL-MN-END-DTE    TO MLCNTL-PSTG-FSCL-MN-DTE.   02550000
025600     MOVE DTATTR-FSCL-MN-NBR        TO MLCNTL-PSTG-FSCL-MN-NBR.   02560000
025700     MOVE DTATTR-FSCL-WK-END-DTE    TO MLCNTL-PSTG-FSCL-WK-DTE.   02570000
025800     MOVE DTATTR-FSCL-WK-NBR        TO MLCNTL-PSTG-FSCL-WK-NBR.   02580000
025900                                                                  02590000
026000     PERFORM 7200-UPDATE-FSCL-DATES.                              02600000
026100                                                                  02610000
026200     PERFORM 2100-DISPLAY-FSCL-VAL-UPDATES.                       02620000
026300                                                                  02630000
026400***  ONLY UPDATE MAXIMUM POSTING DATES AND NUMBERS WHEN           02640041
026500***  THE CONTROL CARD FISCAL WEEK END DATE IS GREATER             02650000
026600***  THAN THE CURRENT MAX POSTING FISCAL WEEK END DATE            02660041
026700     IF CC-FSCL-WEEK-END-DTE > MLCNTL-MXPSTG-FSCL-WK-DTE          02670041
026800        MOVE DTATTR-FSCL-MN-END-DTE TO MLCNTL-MXPSTG-FSCL-MN-DTE  02680000
026900        MOVE DTATTR-FSCL-MN-NBR     TO MLCNTL-MXPSTG-FSCL-MN-NBR  02690000
026800        MOVE DTATTR-FSCL-WK-END-DTE TO MLCNTL-MXPSTG-FSCL-WK-DTE  02691000
026900        MOVE DTATTR-FSCL-WK-NBR     TO MLCNTL-MXPSTG-FSCL-WK-NBR  02692000
027000        PERFORM 7300-UPDATE-MAX-DATES                             02700000
027100        PERFORM 2200-DISPLAY-MAX-VAL-UPDATES                      02710000
027200     END-IF.                                                      02720000
027300                                                                  02730000
027400 EJECT                                                            02740000
027500                                                                  02750000
027600******************************************************************02760000
027700* DISPLAY THE FISCAL MONTH AND WEEK UPDATE VALUES (BOTH OLD AND   02770000
027800* NEW VALUES WILL BE DISPLAYED.                                   02780000
027900******************************************************************02790000
028000 2100-DISPLAY-FSCL-VAL-UPDATES.                                   02800000
028100                                                                  02810000
028200     DISPLAY ' '.                                                 02820000
028300     DISPLAY '***===================================***'.         02830000
028400     DISPLAY '*** TMLCNTL POSTING DATES UPDATED     ***'.         02840000
028500     DISPLAY '***===================================***'.         02850000
028600     DISPLAY 'POSTING FISCAL MONTH END DTE - UPDATED '.           02860000
028700     DISPLAY '    FROM ' PV-OLD-PSTG-FSCL-MN-DTE ' TO '           02870000
028800             MLCNTL-PSTG-FSCL-MN-DTE.                             02880000
028900     DISPLAY ' '.                                                 02890000
029000     DISPLAY 'POSTING FISCAL MONTH NUMBER  - UPDATED '.           02900000
029100     DISPLAY '    FROM ' PV-OLD-PSTG-FSCL-MN-NBR ' TO '           02910000
029200             MLCNTL-PSTG-FSCL-MN-NBR.                             02920000
029300     DISPLAY ' '.                                                 02930000
029400     DISPLAY 'POSTING FISCAL WEEK END DTE  - UPDATED '.           02940000
029500     DISPLAY '    FROM ' PV-OLD-PSTG-FSCL-WK-DTE ' TO '           02950000
029600             MLCNTL-PSTG-FSCL-WK-DTE.                             02960000
029700     DISPLAY ' '.                                                 02970000
029800     DISPLAY 'POSTING FISCAL WEEK NUMBER   - UPDATED '.           02980000
029900     DISPLAY '    FROM ' PV-OLD-PSTG-FSCL-WK-NBR ' TO '           02990000
030000             MLCNTL-PSTG-FSCL-WK-NBR.                             03000000
030100     DISPLAY ' '.                                                 03010000
030200                                                                  03020000
030300 EJECT                                                            03030000
030400                                                                  03040000
030500******************************************************************03050000
030600* DISPLAY THE MAX UPDATES VALUES FOR MONTH AND WEEK (BOTH OLD     03060041
030700* AND NEW VALUES WILL BE DISPLAYED).                              03070000
030800******************************************************************03080000
030900 2200-DISPLAY-MAX-VAL-UPDATES.                                    03090000
031000                                                                  03100000
031100     DISPLAY '***===================================***'.         03110000
031200     DISPLAY '*** TMLCNTL MAX POSTING DATES UPDATED ***'.         03120000
031300     DISPLAY '***===================================***'.         03130000
031400     DISPLAY 'MAX POSTING FISCAL MONTH END DATE - UPDATED '.      03140000
031500     DISPLAY '    FROM ' PV-OLD-MXPSTG-FSCL-MN-DTE ' TO '         03150000
031600              MLCNTL-MXPSTG-FSCL-MN-DTE.                          03160000
031700     DISPLAY ' '.                                                 03170000
031800     DISPLAY 'MAX POSTING FISCAL MONTH NUMBER   - UPDATED '.      03180000
031900     DISPLAY '    FROM ' PV-OLD-MXPSTG-FSCL-MN-NBR ' TO '         03190000
032000             MLCNTL-MXPSTG-FSCL-MN-NBR.                           03200000
031700     DISPLAY ' '.                                                 03200100
031400     DISPLAY 'MAX POSTING FISCAL WEEK END DATE  - UPDATED '.      03201000
031500     DISPLAY '    FROM ' PV-OLD-MXPSTG-FSCL-WK-DTE ' TO '         03202000
 31600              MLCNTL-MXPSTG-FSCL-WK-DTE.                          03203000
031700     DISPLAY ' '.                                                 03204000
031800     DISPLAY 'MAX POSTING FISCAL WEEK NUMBER    - UPDATED '.      03205000
031900     DISPLAY '    FROM ' PV-OLD-MXPSTG-FSCL-WK-NBR ' TO '         03206000
032000             MLCNTL-MXPSTG-FSCL-WK-NBR.                           03207000
032100     DISPLAY ' '.                                                 03210000
032200                                                                  03220000
032300 EJECT                                                            03230000
032400                                                                  03240000
032500******************************************************************03250000
032600* SELECT THE FISCAL MONTH AND WEEK INFO FROM TDTATTR BASED ON THE 03260000
032700* CONTROL CARD FISCAL WEEK END DATE                               03270041
032800******************************************************************03280000
032900 7000-SELECT-TDTATTR.                                             03290000
033000                                                                  03300000
033100     MOVE ZERO TO PV-RETRY-CNT.                                   03310000
033110     MOVE '7000-SELECT-TDTATTR'    TO AA-PARAGRAPH-NAME.          03311000
033150     MOVE PE-MSG-03                TO AA-DB2-OP-1.                03315000
033200                                                                  03320000
033300     PERFORM WITH TEST AFTER                                      03330000
033400         UNTIL PV-RETRY-CNT > PC-MAX-RETRIES                      03340000
033500            OR SQLCODE = ZERO                                     03350000
033600                                                                  03360000
033700        EXEC SQL                                                  03370000
033800            SELECT FSCL_MN_NBR,                                   03380000
033900                   FSCL_MN_END_DTE,                               03390000
034000                   FSCL_WK_NBR,                                   03400000
034100                   FSCL_WK_END_DTE                                03410000
034200            INTO  :DTATTR-FSCL-MN-NBR,                            03420000
034300                  :DTATTR-FSCL-MN-END-DTE,                        03430000
034400                  :DTATTR-FSCL-WK-NBR,                            03440000
034500                  :DTATTR-FSCL-WK-END-DTE                         03450000
034600            FROM TDTATTR                                          03460000
034700            WHERE KY_DTE = :DTATTR-KY-DTE                         03470000
034800        END-EXEC                                                  03480000
034900                                                                  03490000
035000        EVALUATE TRUE                                             03500000
035100           WHEN SQLCODE = ZERO                                    03510000
035200           WHEN SQLCODE = -904                                    03520000
035300           WHEN SQLCODE = -911                                    03530000
035400           WHEN SQLCODE = -913                                    03540000
035500                CONTINUE                                          03550000
035600           WHEN SQLCODE = 100                                     03560000
036000               MOVE PE-MSG-08     TO AA-MESSAGE                   03600000
036200               PERFORM 9998-DB2-ABEND                             03620000
036300           WHEN SQLCODE < 0                                       03630000
036600               MOVE PE-MSG-11     TO AA-MESSAGE                   03660000
036900               PERFORM 9998-DB2-ABEND                             03690000
037000           WHEN SQLCODE > 0                                       03700000
037100           WHEN SQLWARN0 NOT = SPACES                             03710000
037400               MOVE PE-MSG-10     TO AA-MESSAGE                   03740000
037700               PERFORM 9998-DB2-ABEND                             03770000
037800        END-EVALUATE                                              03780000
037900        COMPUTE PV-RETRY-CNT = PV-RETRY-CNT + 1                   03790000
038000     END-PERFORM.                                                 03800000
038100                                                                  03810000
038200     IF  PV-RETRY-CNT > PC-MAX-RETRIES                            03820000
038400         MOVE  PE-MSG-07    TO AA-DB2-OP-1                        03840000
038500         PERFORM 9998-DB2-ABEND                                   03850000
038600     END-IF.                                                      03860000
038700                                                                  03870000
038800 EJECT                                                            03880000
038900                                                                  03890000
039000******************************************************************03900000
039100* SELECT ROW FROM THE LEDGER CONTROL TABLE - TMLCNTL              03910000
039200* (ONLY 1 ROW SHOULD EXIST, ABEND IF NOT FOUND)                   03920000
039300******************************************************************03930000
039400 7100-SELECT-TMLCNTL.                                             03940000
039500                                                                  03950000
039600     MOVE ZERO TO PV-RETRY-CNT.                                   03960000
039610     MOVE '7100-SELECT-TMLCNTL'    TO AA-PARAGRAPH-NAME.          03961000
039640     MOVE PE-MSG-04                TO AA-DB2-OP-1.                03964000
039700                                                                  03970000
039800     PERFORM WITH TEST AFTER                                      03980000
039900         UNTIL PV-RETRY-CNT > PC-MAX-RETRIES                      03990000
040000            OR SQLCODE = ZERO                                     04000000
040100                                                                  04010000
040200        EXEC SQL                                                  04020000
040300            SELECT PSTG_FSCL_MN_DTE                               04030000
040400                  ,PSTG_FSCL_MN_NBR                               04040000
040500                  ,PSTG_FSCL_WK_DTE                               04050000
040600                  ,PSTG_FSCL_WK_NBR                               04060000
040700                  ,MXPSTG_FSCL_MN_DTE                             04070000
040800                  ,MXPSTG_FSCL_MN_NBR                             04080000
040700                  ,MXPSTG_FSCL_WK_DTE                             04081000
040800                  ,MXPSTG_FSCL_WK_NBR                             04082000
040900            INTO  :MLCNTL-PSTG-FSCL-MN-DTE                        04090000
041000                 ,:MLCNTL-PSTG-FSCL-MN-NBR                        04100000
041100                 ,:MLCNTL-PSTG-FSCL-WK-DTE                        04110000
041200                 ,:MLCNTL-PSTG-FSCL-WK-NBR                        04120000
041300                 ,:MLCNTL-MXPSTG-FSCL-MN-DTE                      04130000
041400                 ,:MLCNTL-MXPSTG-FSCL-MN-NBR                      04140000
041300                 ,:MLCNTL-MXPSTG-FSCL-WK-DTE                      04141000
041400                 ,:MLCNTL-MXPSTG-FSCL-WK-NBR                      04142000
041500            FROM TMLCNTL                                          04150000
041600        END-EXEC                                                  04160000
041700                                                                  04170000
041800        EVALUATE TRUE                                             04180000
041900           WHEN SQLCODE = ZERO                                    04190000
042000           WHEN SQLCODE = -904                                    04200000
042100           WHEN SQLCODE = -911                                    04210000
042200           WHEN SQLCODE = -913                                    04220000
042300               CONTINUE                                           04230000
042400           WHEN SQLCODE = 100                                     04240000
042800               MOVE PE-MSG-09     TO AA-MESSAGE                   04280000
043000               PERFORM 9998-DB2-ABEND                             04300000
043100           WHEN SQLCODE < 0                                       04310000
043400               MOVE PE-MSG-13     TO AA-MESSAGE                   04340000
043700               PERFORM 9998-DB2-ABEND                             04370000
043800           WHEN SQLCODE > 0                                       04380000
043900           WHEN SQLWARN0 NOT = SPACES                             04390000
044200               MOVE PE-MSG-12     TO AA-MESSAGE                   04420000
044500               PERFORM 9998-DB2-ABEND                             04450000
044600        END-EVALUATE                                              04460000
044700        COMPUTE PV-RETRY-CNT = PV-RETRY-CNT + 1                   04470000
044800     END-PERFORM.                                                 04480000
044900                                                                  04490000
045000     IF  PV-RETRY-CNT > PC-MAX-RETRIES                            04500000
045200         MOVE  PE-MSG-07    TO AA-DB2-OP-1                        04520000
045300         PERFORM 9998-DB2-ABEND                                   04530000
045400     END-IF.                                                      04540000
045500                                                                  04550000
045600 EJECT                                                            04560000
045700                                                                  04570000
045800******************************************************************04580000
045900* UPDATE THE CONTROL TABLE FISCAL MONTH AND WEEK POSTING DATES    04590000
046000* AND NUMBERS BASED ON THE DATA RETRIEVED FROM TDTATTR            04600000
046100******************************************************************04610000
046200 7200-UPDATE-FSCL-DATES.                                          04620000
046300                                                                  04630000
046400     MOVE ZERO TO PV-RETRY-CNT.                                   04640000
046410     MOVE '7200-UPDATE-FSCL-DATES'  TO AA-PARAGRAPH-NAME.         04641000
046450     MOVE PE-MSG-05                 TO AA-DB2-OP-1.               04645000
046500                                                                  04650000
046600     PERFORM WITH TEST AFTER                                      04660000
046700         UNTIL PV-RETRY-CNT > PC-MAX-RETRIES                      04670000
046800            OR SQLCODE = ZERO                                     04680000
046900                                                                  04690000
047000        EXEC SQL                                                  04700000
047100         UPDATE TMLCNTL                                           04710000
047200               SET PSTG_FSCL_MN_DTE = :MLCNTL-PSTG-FSCL-MN-DTE    04720000
047300                  ,PSTG_FSCL_MN_NBR = :MLCNTL-PSTG-FSCL-MN-NBR    04730000
047400                  ,PSTG_FSCL_WK_DTE = :MLCNTL-PSTG-FSCL-WK-DTE    04740000
047500                  ,PSTG_FSCL_WK_NBR = :MLCNTL-PSTG-FSCL-WK-NBR    04750000
047600        END-EXEC                                                  04760000
047700                                                                  04770000
047800        EVALUATE TRUE                                             04780000
047900           WHEN SQLCODE = ZERO                                    04790000
048000           WHEN SQLCODE = -904                                    04800000
048100           WHEN SQLCODE = -911                                    04810000
048200           WHEN SQLCODE = -913                                    04820000
048300               CONTINUE                                           04830000
048400            WHEN SQLCODE < 0                                      04840000
048700                MOVE PE-MSG-13     TO AA-MESSAGE                  04870000
049000                PERFORM 9998-DB2-ABEND                            04900000
049100            WHEN SQLCODE > 0                                      04910000
049200            WHEN SQLWARN0 NOT = SPACES                            04920000
049500                MOVE PE-MSG-12     TO AA-MESSAGE                  04950000
049800                PERFORM 9998-DB2-ABEND                            04980000
049900        END-EVALUATE                                              04990000
050000        COMPUTE PV-RETRY-CNT = PV-RETRY-CNT + 1                   05000000
050100     END-PERFORM.                                                 05010000
050200                                                                  05020000
050300     IF  PV-RETRY-CNT > PC-MAX-RETRIES                            05030000
050500         MOVE  PE-MSG-07           TO AA-DB2-OP-1                 05050000
050600         PERFORM 9998-DB2-ABEND                                   05060000
050700     END-IF.                                                      05070000
050800                                                                  05080000
050900 EJECT                                                            05090000
051000                                                                  05100000
051100******************************************************************05110000
051200* UPDATE THE MAX POSTING FISCAL MONTH DATE & NUMBER AND THE       05120000
051200* MAX POSTING FISCAL WEEK DATE & NUMBER BASED ON THE DATA         05121000
051300* RETRIEVED FROM TDTATTR (ONLY UPDATED WHEN CONTROL CARD          05130000
051400* DATE IS GREATER THAN THE CURRENT MAX POSTING FISCAL WEEK DATE)  05140041
051500******************************************************************05150000
051600 7300-UPDATE-MAX-DATES.                                           05160000
051700                                                                  05170000
051800     MOVE ZERO TO PV-RETRY-CNT.                                   05180000
051810     MOVE '7300-UPDATE-MAX-DATES'   TO AA-PARAGRAPH-NAME.         05181000
051850     MOVE PE-MSG-06                 TO AA-DB2-OP-1.               05185000
051900                                                                  05190000
052000     PERFORM WITH TEST AFTER                                      05200000
052100         UNTIL PV-RETRY-CNT > PC-MAX-RETRIES                      05210000
052200            OR SQLCODE = ZERO                                     05220000
052300                                                                  05230000
052400        EXEC SQL                                                  05240000
052500          UPDATE TMLCNTL                                          05250000
052600             SET MXPSTG_FSCL_MN_DTE = :MLCNTL-MXPSTG-FSCL-MN-DTE  05260000
052700                ,MXPSTG_FSCL_MN_NBR = :MLCNTL-MXPSTG-FSCL-MN-NBR  05270000
052600                ,MXPSTG_FSCL_WK_DTE = :MLCNTL-MXPSTG-FSCL-WK-DTE  05271000
052700                ,MXPSTG_FSCL_WK_NBR = :MLCNTL-MXPSTG-FSCL-WK-NBR  05272000
052800        END-EXEC                                                  05280000
052900                                                                  05290000
053000        EVALUATE TRUE                                             05300000
053100           WHEN SQLCODE = ZERO                                    05310000
053200           WHEN SQLCODE = -904                                    05320000
053300           WHEN SQLCODE = -911                                    05330000
053400           WHEN SQLCODE = -913                                    05340000
053500               CONTINUE                                           05350000
053600            WHEN SQLCODE < 0                                      05360000
053900                MOVE PE-MSG-13     TO AA-MESSAGE                  05390000
054200                PERFORM 9998-DB2-ABEND                            05420000
054300            WHEN SQLCODE > 0                                      05430000
054400            WHEN SQLWARN0 NOT = SPACES                            05440000
054700                MOVE PE-MSG-12     TO AA-MESSAGE                  05470000
055000                PERFORM 9998-DB2-ABEND                            05500000
055100        END-EVALUATE                                              05510000
055200        COMPUTE PV-RETRY-CNT = PV-RETRY-CNT + 1                   05520000
055300     END-PERFORM.                                                 05530000
055400                                                                  05540000
055500     IF  PV-RETRY-CNT > PC-MAX-RETRIES                            05550000
055700         MOVE  PE-MSG-07           TO AA-DB2-OP-1                 05570000
055800         PERFORM 9998-DB2-ABEND                                   05580000
055900     END-IF.                                                      05590000
056000                                                                  05600000
056100 EJECT                                                            05610000
056200                                                                  05620000
056300******************************************************************05630000
056400* END-OF-JOB PROCESSING - CLOSE FILES                             05640000
056500******************************************************************05650000
056600 8000-EOJ-PROCESS.                                                05660000
056700                                                                  05670000
056800     CLOSE CONTROL-DATE-FILE.                                     05680000
056900                                                                  05690000
057000 EJECT                                                            05700000
057100                                                                  05710000
057200******************************************************************05720000
057300* COMMON PROGRAM ABEND ROUTINE                                    05730000
057400******************************************************************05740000
057500 9900-COMMON-ABEND-ROUTINE.                                       05750000
057600                                                                  05760000
057700     DISPLAY AA-ABEND-LIT.                                        05770000
057800     DISPLAY AA-PROGRAM-LIT.                                      05780000
057900     DISPLAY AA-PARAGRAPH-LIT.                                    05790000
058000     DISPLAY AA-MESSAGE-LINE.                                     05800000
058100     DISPLAY ABEND-CODE.                                          05810000
058200                                                                  05820000
058300     CALL 'ILBOABN0' USING ABEND-CODE.                            05830000
058400                                                                  05840000
058500 EJECT                                                            05850000
058600                                                                  05860000
058700******************************************************************05870000
058800* COMMON DB2 PROGRAM ABEND ROUTINE                                05880000
058900******************************************************************05890000
059000 9998-DB2-ABEND.                                                  05900000
059100                                                                  05910000
059200     DISPLAY AA-ABEND-LIT.                                        05920000
059300     DISPLAY AA-DB2-ERROR-LIT.                                    05930000
059400     DISPLAY AA-PROGRAM-LIT.                                      05940000
059500     DISPLAY AA-PARAGRAPH-LIT.                                    05950000
059600     DISPLAY AA-MESSAGE-LINE.                                     05960000
059700     DISPLAY AA-DB2-OPERATION-LIT.                                05970000
059800     SET AC-DB2-ERROR TO TRUE.                                    05980000
059900     MOVE +4013                  TO ABEND-CODE.                   05990000
060000                                                                  06000000
060100     COPY DPPD004.                                                06010000
060200     CALL 'ILBOABN0' USING ABEND-CODE.                            06020000
060300                                                                  06030000
060400******************************************************************06040000
060500*****      E N D   O F   P R O G R A M   M L K U P 3 1 8     *****06050000
060600******************************************************************06060000
