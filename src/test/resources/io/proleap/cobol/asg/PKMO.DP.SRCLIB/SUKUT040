000100******************************************************************00010002
000200 IDENTIFICATION DIVISION.                                         00020002
000300******************************************************************00030002
000400                                                                  00040002
000500 PROGRAM-ID.    SUKUT040.                                         00050002
000600 AUTHOR.        GERMAN BANDA                                      00060002
000700 INSTALLATION.  KOHLS.                                            00070002
000800 DATE-WRITTEN   OCTOBER, 2000.                                    00080002
000900 DATE-COMPILED.                                                   00090002
001000                                                                  00100002
001100******************************************************************00110002
001200*  THIS PROGRAM CREATES AN EXTRACT FILE OF DATA FROM THE          00120002
001300*  REPORT REQUEST DATA FILE (TSURPRQ).                            00130002
001400******************************************************************00140002
001500                                                                  00150002
001600******************************************************************00160002
001700 ENVIRONMENT DIVISION.                                            00170002
001800******************************************************************00180002
001900                                                                  00190002
002000 CONFIGURATION SECTION.                                           00200002
002100                                                                  00210002
002200 SOURCE-COMPUTER.        IBM-3090.                                00220002
002300 OBJECT-COMPUTER.        IBM-3090.                                00230002
002400                                                                  00240002
002500 INPUT-OUTPUT SECTION.                                            00250002
002600                                                                  00260002
002700 FILE-CONTROL.                                                    00270002
002800                                                                  00280002
002900                                                                  00290002
003000     SELECT TIMESTAMP-FILE                                        00300002
003100         ASSIGN TO IN01.                                          00310002
003200                                                                  00320002
003300     SELECT RPT-REQ-DATA-EXTRACT                                  00330002
003400         ASSIGN TO OUT02.                                         00340002
003500                                                                  00350002
003600******************************************************************00360002
003700 DATA DIVISION.                                                   00370002
003800******************************************************************00380002
003900                                                                  00390002
004000 FILE SECTION.                                                    00400002
004100                                                                  00410002
004200 FD  TIMESTAMP-FILE                                               00420002
004300     RECORDING MODE IS F                                          00430002
004400     LABEL RECORDS ARE STANDARD                                   00440002
004500     BLOCK CONTAINS 0 RECORDS.                                    00450002
004600                                                                  00460002
004700 01  TIMESTAMP-RECORD           PIC  X(50).                       00470002
004800                                                                  00480002
004900 FD  RPT-REQ-DATA-EXTRACT                                         00490002
005000     RECORDING MODE IS F                                          00500002
005100     LABEL RECORDS ARE STANDARD                                   00510002
005200     BLOCK CONTAINS 0 RECORDS.                                    00520002
005300                                                                  00530002
005400 01  RPT-REQ-DATA-RECORD.                                         00540002
005500     10 RPRQ-WRKR-USR-ID            PIC   X(8).                   00550002
005600     10 RPRQ-TRIP-ID                PIC  S9(9) COMP.              00560002
005700     10 RPRQ-PO-NBR                 PIC  S9(9) COMP.              00570002
005800     10 RPRQ-RQST-TMST              PIC   X(26).                  00580002
005900     10 RPRQ-ALL-PO-IND             PIC   X(1).                   00590002
006000                                                                  00600002
006100                                                                  00610002
006200******************************************************************00620002
006300 WORKING-STORAGE SECTION.                                         00630002
006400******************************************************************00640002
006500                                                                  00650002
006600*-----------------------------------------------------------------00660002
006700*  RECORD LAYOUT FOR THE TIMESTAMP FILE.                          00670002
006800*-----------------------------------------------------------------00680002
006900     COPY RCRD011.                                                00690002
007000                                                                  00700002
007100*-----------------------------------------------------------------00710002
007200*  DB2 FORMATTED MESSAGE AREA                                     00720002
007300*-----------------------------------------------------------------00730002
007400     COPY DPWS004.                                                00740004
007500                                                                  00750002
007600*-----------------------------------------------------------------00760002
007700*  COMMUNICATIONS AREA FOR DB2                                    00770002
007800*-----------------------------------------------------------------00780002
007900     EXEC SQL                                                     00790002
008000          INCLUDE SQLCA                                           00800002
008100     END-EXEC.                                                    00810002
008200                                                                  00820002
008300*-----------------------------------------------------------------00830002
008400*  COBOL DECLARATION AND DCLGEN MEMBER FOR THE REPORT REQUEST     00840002
008500*  TABLE                                                          00850002
008600*-----------------------------------------------------------------00860002
008700     EXEC SQL                                                     00870002
008800          INCLUDE TSURPRQ                                         00880002
008900     END-EXEC.                                                    00890002
009000                                                                  00900002
009100*-----------------------------------------------------------------00910002
009200*                                                                 00920002
009300*-----------------------------------------------------------------00930002
009400 01  ABEND-CODE                    PIC S9(04) VALUE +0            00940002
009500                                              COMP SYNC.          00950002
009600                                                                  00960002
009700 01  PS-PROGRAM-SWITCHES.                                         00970002
009800     05  PS-EOF-PRNT-REQ-DATA-CSR-SW  PIC  X(01) VALUE 'N'.       00980002
009900         88  PS-EOF-PRT-REQ-DATA-CSR          VALUE 'Y'.          00990002
010000         88  PS-MORE-PRT-REQ-DATA-CSR         VALUE 'N'.          01000002
010100                                                                  01010002
010200                                                                  01020002
010300 01  PC-PROGRAM-CONSTANTS.                                        01030002
010400     05  PC-CURRENT-PROGRAM-NAME   PIC  X(08) VALUE 'SUKUT040'.   01040002
010500     05  PC-CURRENT-TIMESTAMP      PIC  X(26) VALUE SPACES.       01050002
010600                                                                  01060002
010700 01  PV-PROGRAM-VARIABLES.                                        01070002
010800     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  01080002
010900     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  01090002
011000     05  PV-DISPLAY-COUNT            PIC S9(09)    VALUE ZERO     01100002
011100                                                   COMP SYNC.     01110002
011200     05  PV-WRITE-COUNTER            PIC S9(09)    VALUE ZERO     01120002
011300                                                   COMP SYNC.     01130002
011400                                                                  01140002
011500*-----------------------------------------------------------------01150002
011600*  PRINT REQUEST DATA TO BE DELETED CURSOR                        01160002
011700*-----------------------------------------------------------------01170002
011800     EXEC SQL                                                     01180002
011900          DECLARE PRINT_REQ_CURSOR CURSOR FOR                     01190002
012000           SELECT DISTINCT                                        01200002
012100                  WRKR_USR_ID                                     01210002
012200                 ,TRIP_ID                                         01220002
012300                 ,PO_NBR                                          01230002
012400                 ,RQST_TMST                                       01240002
012500                 ,ALL_PO_IND                                      01250002
012600             FROM TSURPRQ                                         01260002
012700            WHERE RQST_TMST < :PC-CURRENT-TIMESTAMP               01270002
012800     END-EXEC.                                                    01280002
012900                                                                  01290002
013000                                                                  01300002
013100******************************************************************01310002
013200 PROCEDURE DIVISION.                                              01320002
013300******************************************************************01330002
013400                                                                  01340002
013500                                                                  01350002
013600*-----------------------------------------------------------------01360002
013700* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     01370002
013800*      PROGRAM.                                                   01380002
013900*-----------------------------------------------------------------01390002
014000 0000-PROGRAM-MAINLINE.                                           01400002
014100                                                                  01410002
014200     PERFORM 1000-INITIALIZE.                                     01420002
014300     IF  PS-MORE-PRT-REQ-DATA-CSR                                 01430002
014400         PERFORM 2000-PROCESS-PRT-REQ-DATA                        01440002
014500           UNTIL PS-EOF-PRT-REQ-DATA-CSR                          01450002
014600     END-IF.                                                      01460002
014700     PERFORM 9000-EOJ-ROUTINE.                                    01470002
014800                                                                  01480002
014900     STOP RUN.                                                    01490002
015000                                                                  01500002
015100                                                                  01510002
015200*-----------------------------------------------------------------01520002
015300*  DO FIRST TIME PROGRAM INITIALIZATION TASKS.                    01530002
015400*    -- OPEN OUTPUT FILE                                          01540002
015500*    -- OPEN CURSOR                                               01550002
015600*    -- FETCH CURSOR                                              01560002
015700*-----------------------------------------------------------------01570002
015800 1000-INITIALIZE.                                                 01580002
015900                                                                  01590002
016000     OPEN INPUT  TIMESTAMP-FILE.                                  01600002
016100     OPEN OUTPUT RPT-REQ-DATA-EXTRACT.                            01610002
016200                                                                  01620002
016300     PERFORM 1100-READ-CONTROL-CARD.                              01630002
016400                                                                  01640002
016500     PERFORM 7000-OPEN-PRT-REQ-DATA-CURSOR.                       01650002
016600     PERFORM 7100-FETCH-PRT-REQ-DATA-CURSOR.                      01660002
016700                                                                  01670002
016800                                                                  01680002
016900*-----------------------------------------------------------------01690002
017000*                                                                 01700002
017100*-----------------------------------------------------------------01710002
017200 1100-READ-CONTROL-CARD.                                          01720002
017300                                                                  01730002
017400     READ TIMESTAMP-FILE   INTO RC011-CONTROL-RECORD.             01740002
017500                                                                  01750002
017600     MOVE RC011-CONTROL-TMST TO PC-CURRENT-TIMESTAMP.             01760002
017700                                                                  01770002
017800     DISPLAY 'SUKUT040 CONTROL CARD -- ' RC011-CONTROL-TMST.      01780002
017900                                                                  01790002
018000                                                                  01800002
018100*-----------------------------------------------------------------01810002
018200*  LOOP THROUGH THE RESULTS TABLE.                                01820002
018300*  FORMAT THE OUTPUT RECORD.  WRITE THE RECORDS THAT MEET CRITERIA01830002
018400*-----------------------------------------------------------------01840002
018500 2000-PROCESS-PRT-REQ-DATA.                                       01850002
018600                                                                  01860002
018700     PERFORM 8000-WRITE-PRT-REQ-DATA-RECORD.                      01870002
018800                                                                  01880002
018900     PERFORM 7100-FETCH-PRT-REQ-DATA-CURSOR.                      01890002
019000                                                                  01900002
019100                                                                  01910002
019200*-----------------------------------------------------------------01920002
019300*  OPEN THE CURSOR.                                               01930002
019400*-----------------------------------------------------------------01940002
019500 7000-OPEN-PRT-REQ-DATA-CURSOR.                                   01950002
019600                                                                  01960002
019700     EXEC SQL                                                     01970002
019800          OPEN PRINT_REQ_CURSOR                                   01980002
019900     END-EXEC                                                     01990002
020000                                                                  02000002
020100     EVALUATE TRUE                                                02010002
020200         WHEN SQLCODE = ZERO                                      02020002
020300              CONTINUE                                            02030002
020400         WHEN SQLCODE = -904                                      02040002
020500         WHEN SQLCODE = -911                                      02050002
020600              CONTINUE                                            02060002
020700         WHEN SQLWARN0 NOT = SPACES                               02070002
020800         WHEN SQLCODE < ZERO                                      02080002
020900         WHEN SQLCODE > ZERO                                      02090002
021000             MOVE '7000-OPEN-PRT-REQ-DATA-CURSOR    '             02100002
021100                                 TO PV-PARAGRAPH-NAME             02110002
021200             MOVE 'OPEN THE PRINT_REQ_CURSOR      '               02120002
021300                                 TO PV-DB2-OPERATION-ATTEMPTED    02130002
021400             PERFORM 9100-SQL-ABEND                               02140002
021500     END-EVALUATE.                                                02150002
021600                                                                  02160002
021700                                                                  02170002
021800*-----------------------------------------------------------------02180002
021900*  FETCH THE ROW FROM THE RESULTS TABLE USING THE CURSOR.         02190002
022000*-----------------------------------------------------------------02200002
022100 7100-FETCH-PRT-REQ-DATA-CURSOR.                                  02210002
022200                                                                  02220002
022300     EXEC SQL                                                     02230002
022400          FETCH PRINT_REQ_CURSOR                                  02240002
022810           INTO :SURPRQ-WRKR-USR-ID,                              02281003
022820                :SURPRQ-TRIP-ID,                                  02282003
022830                :SURPRQ-PO-NBR,                                   02283003
022840                :SURPRQ-RQST-TMST,                                02284003
022850                :SURPRQ-ALL-PO-IND                                02285002
022900     END-EXEC.                                                    02290002
023000                                                                  02300002
023100     EVALUATE TRUE                                                02310002
023200         WHEN SQLCODE = ZERO                                      02320002
023300             CONTINUE                                             02330002
023400         WHEN SQLCODE = +100                                      02340002
023500             SET PS-EOF-PRT-REQ-DATA-CSR TO TRUE                  02350002
023600                                                                  02360002
023700         WHEN SQLWARN0 NOT = SPACES                               02370002
023800         WHEN SQLCODE < ZERO                                      02380002
023900         WHEN SQLCODE > ZERO                                      02390002
024000             MOVE '7100-FETCH-PRT-REQ-DATA-CURSOR  '              02400002
024100                                 TO PV-PARAGRAPH-NAME             02410002
024200             MOVE 'FETCH THE SHIPMT-UNIT-CURSOR   '               02420002
024300                                 TO PV-DB2-OPERATION-ATTEMPTED    02430002
024400             PERFORM 9100-SQL-ABEND                               02440002
024500     END-EVALUATE.                                                02450002
024600                                                                  02460002
024700                                                                  02470002
024800*-----------------------------------------------------------------02480002
024900*  WRITE THE SHIPMENT-UNIT-RECORD                                 02490002
025000*-----------------------------------------------------------------02500002
025100 8000-WRITE-PRT-REQ-DATA-RECORD.                                  02510002
025200                                                                  02520002
025300     INITIALIZE RPT-REQ-DATA-RECORD.                              02530002
025400     MOVE SURPRQ-WRKR-USR-ID      TO RPRQ-WRKR-USR-ID.            02540002
025500     MOVE SURPRQ-TRIP-ID          TO RPRQ-TRIP-ID.                02550002
025600     MOVE SURPRQ-PO-NBR           TO RPRQ-PO-NBR.                 02560002
025700     MOVE SURPRQ-RQST-TMST        TO RPRQ-RQST-TMST.              02570002
025800     MOVE SURPRQ-ALL-PO-IND       TO RPRQ-ALL-PO-IND.             02580002
025810                                                                  02581002
025820                                                                  02582002
025900     WRITE RPT-REQ-DATA-RECORD.                                   02590002
026000     ADD +1 TO PV-WRITE-COUNTER.                                  02600002
026100                                                                  02610002
026200                                                                  02620002
026300*-----------------------------------------------------------------02630002
026400*  CLOSE OUTPUT FILE.  CLOSE THE CURSOR.                          02640002
026500*-----------------------------------------------------------------02650002
026600 9000-EOJ-ROUTINE.                                                02660002
026700     CLOSE RPT-REQ-DATA-EXTRACT                                   02670002
026800           TIMESTAMP-FILE.                                        02680002
026900                                                                  02690002
027000     MOVE PV-WRITE-COUNTER TO PV-DISPLAY-COUNT.                   02700002
027100     DISPLAY 'TOTL PRT REQ BATCH RECORDS WRITTEN' PV-DISPLAY-COUNT02710002
027200                                                                  02720002
027300     EXEC SQL                                                     02730002
027400          CLOSE PRINT_REQ_CURSOR                                  02740002
027500     END-EXEC.                                                    02750002
027600                                                                  02760002
027700     EVALUATE TRUE                                                02770002
027800         WHEN SQLCODE = ZERO                                      02780002
027900              CONTINUE                                            02790002
028000         WHEN SQLCODE = -904                                      02800002
028100         WHEN SQLCODE = -911                                      02810002
028200              CONTINUE                                            02820002
028300         WHEN SQLWARN0 NOT = SPACES                               02830002
028400         WHEN SQLCODE < ZERO                                      02840002
028500         WHEN SQLCODE > ZERO                                      02850002
028600              MOVE '9000-EOJ-ROUTINE               '              02860002
028700                                 TO PV-PARAGRAPH-NAME             02870002
028800              MOVE 'CLOSE THE PRINT_REQ_CURSOR      '             02880002
028900                                 TO PV-DB2-OPERATION-ATTEMPTED    02890002
029000              PERFORM 9100-SQL-ABEND                              02900002
029100     END-EVALUATE.                                                02910002
029200                                                                  02920002
029300                                                                  02930002
029400*-----------------------------------------------------------------02940002
029500*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    02950002
029600*  ERROR OR WARNING CODE OCCURS.                                  02960002
029700*-----------------------------------------------------------------02970002
029800 9100-SQL-ABEND.                                                  02980002
029900     DISPLAY '9100-SQL-ABEND'.                                    02990002
030000     DISPLAY '** ABEND     **'.                                   03000002
030100     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        03010002
030200     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              03020002
030300     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     03030002
030400                                                                  03040002
030500******************************************************************03050002
030600* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    03060002
030700* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         03070002
030800* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     03080002
030900* FORMAT.                                                         03090002
031000******************************************************************03100002
031100     COPY DPPD004.                                                03110002
031200                                                                  03120002
031300     MOVE +4013                  TO ABEND-CODE.                   03130002
031400     CALL 'ILBOABN0' USING ABEND-CODE.                            03140002
