000100******************************************************************00010001
000200 IDENTIFICATION DIVISION.                                         00020001
000300******************************************************************00030001
000400 PROGRAM-ID.         SVKUP017.                                    00040001
000500 AUTHOR.             DANIEL OKYERE.                               00050001
000600 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00060001
000700 DATE-WRITTEN.       SEPTEMBER 2004.                              00070001
000800 DATE-COMPILED.                                                   00080001
000900                                                                  00090001
001000******************************************************************00100001
001100* THIS PROGRAM WILL UPDATE THE ACTIVITY STATUS ON THE STORED     *00110001
001200* VALUE TRANSACTION TABLE, SVT_KOHLS_CRD_TXN USING CHECKPOINT/   *00120001
001300* RESTART. IT ALSO UPDATES THE SELR_PSTL_CDE AND SELR_TRN_ID ON  *00130007
001400* THE SVT_3RD_PTY_TRN TABLE.                                     *00140001
001500*                                                                *00150001
002400* INPUT FILES:   UPDATE POSTING FILE       DDNAME = INP01        *00240001
002500*                                                                *00250001
002600* OUTPUT FILES:  N/A                                             *00260001
002700*                                                                *00270001
002800******************************************************************00280001
260107* CHG0260107   JIM HUNTER   08-19-21   ADD COPYBOOK DPWS991 TO    00281012
260107*                                      MAKE DPKUT901 CALL DYNAMIC.00282012
003000******************************************************************00300001
003100 ENVIRONMENT DIVISION.                                            00310001
003200******************************************************************00320001
003300                                                                  00330001
003400 CONFIGURATION SECTION.                                           00340001
003500                                                                  00350001
003600 SOURCE-COMPUTER.    IBM-3090.                                    00360001
003700 OBJECT-COMPUTER.    IBM-3090.                                    00370001
003800                                                                  00380001
003900 INPUT-OUTPUT SECTION.                                            00390001
004000                                                                  00400001
004100 FILE-CONTROL.                                                    00410001
004200                                                                  00420001
004300******************************************************************00430001
004400 DATA DIVISION.                                                   00440001
004500******************************************************************00450001
004600                                                                  00460001
004700 WORKING-STORAGE SECTION.                                         00470001
004800                                                                  00480001
004900 01  ABEND-CODE                  PIC S9(04)     VALUE +0  COMP.   00490001
005000                                                                  00500001
005100******************************************************************00510001
005200*PC - PROGRAM CONSTANTS                                           00520001
005300******************************************************************00530001
005400 01  PROGRAM-CONSTANTS.                                           00540001
005500     05  PC-MAX-RETRIES          PIC S9(04)     VALUE +3          00550001
005600                                                COMP SYNC.        00560001
005700     05  PC-MAX-DEADLOCKS        PIC S9(04)     VALUE +3          00570001
005800                                                COMP SYNC.        00580001
005900     05  PC-CKPT-JOB-NAME        PIC  X(08)     VALUE 'SVK075  '. 00590001
006000     05  PC-CKPT-PLAN-NAME       PIC  X(08)     VALUE 'SVKUP017'. 00600001
006100     05  PC-CURRENT-PROGRAM-NAME PIC  X(08)     VALUE 'SVKUP017'. 00610001
006200                                                                  00620001
006300     05  PC-TRAN-PRES-FUNC-CODES.                                 00630001
006400         10  PC-TRAN-PRES-FUNC-OPEN   PIC  X(05)  VALUE 'OPEN '.  00640001
006500         10  PC-TRAN-PRES-FUNC-TRANS  PIC  X(05)  VALUE 'TRANS'.  00650001
006600         10  PC-TRAN-PRES-FUNC-RSTRT  PIC  X(05)  VALUE 'RSTRT'.  00660001
006700         10  PC-TRAN-PRES-FUNC-CLOSE  PIC  X(05)  VALUE 'CLOSE'.  00670001
006800                                                                  00680001
007200******************************************************************00720001
007300*PV - PROGRAM VARIABLES                                           00730001
007400******************************************************************00740001
007500 01  PROGRAM-VARIABLES.                                           00750001
007600     05  PV-SQL-SUB                   PIC  9(03)   VALUE ZERO.    00760001
007700     05  PV-DEADLOCK-COUNTER          PIC  9(03)   VALUE ZERO.    00770001
007800     05  PV-PARAGRAPH-NAME            PIC  X(30)   VALUE SPACE.   00780001
007900     05  PV-DB2-OPER-ATTEMPTED        PIC  X(30)   VALUE SPACE.   00790001
008100     05  PV-CARD-NUMBER               PIC  9(12)   VALUE ZERO.    00810001
008200                                                                  00820001
008300******************************************************************00830001
008400*PS - PROGRAM SWITCHES                                            00840001
008500******************************************************************00850001
008600 01  PROGRAM-SWITCHES.                                            00860001
008700     05  PS-RESTART-REQUIRED-SW  PIC X(01)      VALUE 'N'.        00870001
008800         88  PS-RESTART-REQUIRED                VALUE 'Y'.        00880001
008900         88  PS-RESTART-NOT-REQUIRED            VALUE 'N'.        00890001
009000                                                                  00900001
009010******************************************************************00901010
009020*  SAFEWAY UPDATE POSTING RECORD LAYOUT                          *00902011
009030******************************************************************00903011
009040     COPY SVRD054.                                                00904011
009050                                                                  00905011
009600******************************************************************00960001
009700*  STORED VALUE CARD CONSTANTS                                   *00970001
009800******************************************************************00980001
009900     COPY SVWS004.                                                00990001
010000                                                                  01000001
010100******************************************************************01010001
010200*  DCLGEN FOR KOHL'S MERCHANDISE CARD ACTIVITY TABLE             *01020001
010300******************************************************************01030001
010400     EXEC SQL                                                     01040001
010500         INCLUDE SVT00002                                         01050001
010600     END-EXEC.                                                    01060001
010700                                                                  01070001
010800******************************************************************01080011
010900*  DCLGEN FOR KOHL'S THIRD PARTY TRANSACTION TABLE               *01090004
011000******************************************************************01100004
011100     EXEC SQL                                                     01110004
011200         INCLUDE SVT00015                                         01120004
011300     END-EXEC.                                                    01130004
011400                                                                  01140004
011500******************************************************************01150001
011600*  SQL COMMUNICATIONS WORK AREA                                  *01160001
011700******************************************************************01170001
011800     COPY SQLCA2.                                                 01180001
011900                                                                  01190001
012000******************************************************************01200001
012100*  DB2 FORMATTED ERROR MESSAGE                                   *01210001
012200******************************************************************01220001
012300     COPY DPWS004.                                                01230001
012400                                                                  01240001
012500******************************************************************01250001
012600*  TRANSACTION PREPARATION MODULE COMMUNICATIONS AREA            *01260001
012700******************************************************************01270001
260107     COPY DPWS991.                                                01280012
012800                                                                  01281012
012800     COPY DPLS001.                                                01282012
012900     05  WORK-STORAGE-PASSED.                                     01290001
013000******************************************************************01300001
013100*PA - PROGRAM ACCUMULATORS                                        01310001
013200******************************************************************01320001
013300         10  PROGRAM-ACCUMULATORS.                                01330001
013400             15  PA-CRD-TXN-ROWS-UPDATED   PIC S9(11)  VALUE ZERO 01340001
013500                                                       COMP-3.    01350001
013600             15  PA-CRD-TXN-ORIG-INSERTED  PIC S9(11)  VALUE ZERO 01360001
013700                                                       COMP-3.    01370001
013800             15  PA-CRD-TXN-VOIDS-INSERTED PIC S9(11)  VALUE ZERO 01380001
013900                                                       COMP-3.    01390001
014000                                                                  01400001
014100 01  FILLER                          PIC X(4096)  VALUE SPACE.    01410001
014200******************************************************************01420001
014300*  COMMUNICATIONS AREA FOR DB2                                   *01430001
014400******************************************************************01440001
014500     EXEC SQL                                                     01450001
014600         INCLUDE SQLCA                                            01460001
014700     END-EXEC.                                                    01470001
014800                                                                  01480001
014900******************************************************************01490001
015000 PROCEDURE DIVISION.                                              01500001
015100******************************************************************01510001
015200 A100-MAINLINE.                                                   01520001
015300                                                                  01530001
015400     PERFORM B100-INITIALIZE.                                     01540001
015500                                                                  01550001
015600     PERFORM B200-PROCESS-UPDATE-RECORDS                          01560001
015700         UNTIL DP001-PREP-TRANS-EOF.                              01570001
015800                                                                  01580001
015900     PERFORM B300-EOJ-ROUTINE.                                    01590001
016000                                                                  01600001
016100     GOBACK.                                                      01610001
016200                                                                  01620001
016300******************************************************************01630001
016400*     B100-INITIALIZE                                            *01640001
016500* ==> PROCESSES:                                                 *01650001
016600* ==> PERFORMED FROM: A100-MAINLINE                              *01660001
016700******************************************************************01670001
016800 B100-INITIALIZE.                                                 01680001
016900                                                                  01690001
017000     MOVE PC-TRAN-PRES-FUNC-OPEN TO DP001-FUNC-CODE.              01700001
017100     PERFORM Z100-BUILD-COMM-AREA-TRAN-PRES.                      01710001
017200                                                                  01720001
017300******************************************************************01730001
017400*     B200-PROCESS-UPDATE-RECORDS                                *01740001
017500* ==> PROCESSES:                                                 *01750001
017600* ==> PERFORMED FROM: A100-MAINLINE                              *01760001
017700******************************************************************01770001
017800 B200-PROCESS-UPDATE-RECORDS.                                     01780001
017900                                                                  01790001
018000     SET PS-RESTART-NOT-REQUIRED TO TRUE.                         01800001
018100                                                                  01810001
018200     PERFORM C100-UPDATE-CRD-TXN-RECORD.                          01820002
018210     IF SV054-RF-REVERSAL                                         01821010
018220         CONTINUE                                                 01822010
018230     ELSE                                                         01823010
018300         PERFORM C200-UPDATE-THIRD-PTY-RECORD                     01830010
018400     END-IF.                                                      01840010
018900                                                                  01890001
019000*----------------------------------------------------------------*01900001
019100*  IF A RESTART IS REQUIRED, ISSUE A RESTART CALL RATHER THAN A  *01910001
019200*  TRANS CALL.  THIS WILL ALLOW PROCESSING TO RESUME WITH THE    *01920001
019300*  FIRST TRANSACTION AFTER THE LAST COMMIT.                      *01930001
019400*----------------------------------------------------------------*01940001
019500     IF PS-RESTART-REQUIRED                                       01950001
019600         MOVE PC-TRAN-PRES-FUNC-RSTRT TO DP001-FUNC-CODE          01960001
019700     ELSE                                                         01970001
019800         MOVE PC-TRAN-PRES-FUNC-TRANS TO DP001-FUNC-CODE          01980001
019900     END-IF.                                                      01990001
020000                                                                  02000001
020100     PERFORM Z100-BUILD-COMM-AREA-TRAN-PRES.                      02010001
020200                                                                  02020001
020300******************************************************************02030001
020400*     B300-EOJ-ROUTINE                                           *02040001
020500* ==> PROCESSES:                                                 *02050001
020600* ==> PERFORMED FROM: A100-MAINLINE                              *02060001
020700******************************************************************02070001
020800 B300-EOJ-ROUTINE.                                                02080001
020900                                                                  02090001
021000     MOVE PC-TRAN-PRES-FUNC-CLOSE TO DP001-FUNC-CODE.             02100001
021100     PERFORM Z100-BUILD-COMM-AREA-TRAN-PRES.                      02110001
021200                                                                  02120001
021300******************************************************************02130001
021400*     Z100-BUILD-COMM-AREA-TRAN-PRES                             *02140001
021500* ==> PROCESSES:                                                 *02150001
021600*     - BUILD THE COMMUNICATION AREA FOR A CALL TO THE           *02160001
021700*       TRANSACTION PRESENTATION MODULE.                         *02170001
021800* ==> PERFORMED FROM:                                            *02180001
021900******************************************************************02190001
022000 Z100-BUILD-COMM-AREA-TRAN-PRES.                                  02200001
022100                                                                  02210001
022200     MOVE LENGTH OF WORK-STORAGE-PASSED                           02220001
022300                                       TO DP001-WORK-STRG-LENGTH. 02230001
022400     MOVE PC-CKPT-JOB-NAME             TO DP001-JOB-NAME.         02240001
022500     MOVE PC-CKPT-PLAN-NAME            TO DP001-PLAN-NAME.        02250001
022600     PERFORM Z900-CALL-TRANS-PRES-MODULE.                         02260001
022700     MOVE DP001-TRANS-RECORD   TO SV054-DETAIL-TRANS.             02270005
022800     IF DP001-CKPT-TAKEN                                          02280001
022900         INITIALIZE PV-DEADLOCK-COUNTER                           02290001
023000     END-IF.                                                      02300001
023100                                                                  02310001
023200******************************************************************02320001
023300*     C100-UPDATE-CRD-TXN-RECORD                                 *02330002
023400* ==> PROCESSES:                                                 *02340001
023500*     - UPDATES THE ACTIVITY STATUS CODE TO VERIFIED             *02350002
023700* ==> PERFORMED FROM:  B200-PROCESS-UPDATE-RECORDS               *02370001
023800******************************************************************02380001
023900 C100-UPDATE-CRD-TXN-RECORD.                                      02390002
024000                                                                  02400001
024100     PERFORM WITH TEST AFTER                                      02410001
024200         VARYING PV-SQL-SUB                                       02420001
024300         FROM 1 BY 1                                              02430001
024400         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       02440001
024500                OR SQLCODE = -911                                 02450001
024700                OR SQLCODE = 0)                                   02470001
024800                                                                  02480001
024900         EXEC SQL                                                 02490001
025000             UPDATE SVT_KOHLS_CRD_TXN                             02500001
025100             SET  ACTVY_STAT_CDE  = :SV004-STAT-VERIFIED-CD       02510006
025200                 ,TRN_PSTD_TMST   = CURRENT_TIMESTAMP             02520003
025300             WHERE CRD_NBR        = :SV054-GIFT-CARD-NBR          02530009
025400               AND TRN_AUTH_TMST  = :SV054-TRN-AUTH-TMST          02540009
025500         END-EXEC                                                 02550001
025600                                                                  02560001
025700         EVALUATE TRUE                                            02570001
025800             WHEN SQLCODE = 0                                     02580001
025900                 ADD +1 TO PA-CRD-TXN-ROWS-UPDATED                02590001
026300             WHEN SQLCODE = -911                                  02630001
026400                 ADD +1 TO PV-DEADLOCK-COUNTER                    02640001
026500                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        02650001
026600                     MOVE 'C100-VERIFY-CRD-TXN-RECORD           ' 02660001
026700                                      TO PV-PARAGRAPH-NAME        02670001
026800                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        02680001
026900                                      TO PV-DB2-OPER-ATTEMPTED    02690001
027000                     PERFORM Z900-SQL-ABEND                       02700001
027100                 ELSE                                             02710001
027200                     SET PS-RESTART-REQUIRED TO TRUE              02720001
027300                 END-IF                                           02730001
027400             WHEN OTHER                                           02740001
027500                 MOVE SV054-GIFT-CARD-NBR TO PV-CARD-NUMBER       02750002
027600                 DISPLAY 'UPDATE ABENDED ON CARD ' PV-CARD-NUMBER 02760001
027700                 MOVE 'C100-UPDATE-CRD-TXN-RECORD           '     02770002
027800                                      TO PV-PARAGRAPH-NAME        02780001
027900                 MOVE 'UPDATE SVT_KOHLS_CRD_TXN      '            02790001
028000                                      TO PV-DB2-OPER-ATTEMPTED    02800001
028100                 PERFORM Z900-SQL-ABEND                           02810001
028200         END-EVALUATE                                             02820001
028300     END-PERFORM.                                                 02830001
028400                                                                  02840001
029500     IF PV-SQL-SUB > PC-MAX-RETRIES                               02950001
029600         MOVE 'C100-VERIFY-CRD-TXN-RECORD           '             02960001
029700                                      TO PV-PARAGRAPH-NAME        02970001
029800         MOVE 'VERIFY RETRIES EXCEEDED       '                    02980001
029900                                      TO PV-DB2-OPER-ATTEMPTED    02990001
030000         PERFORM Z900-SQL-ABEND                                   03000001
030100     END-IF.                                                      03010001
030200                                                                  03020001
030300******************************************************************03030002
030400*     C200-UPDATE-THIRD-PTY-RECORD                               *03040002
030500* ==> PROCESSES:                                                 *03050002
030600*     - UPDATES THE SELLER ZIP CODE AND SELLER TRANSACTION NBR.  *03060002
030700* ==> PERFORMED FROM:  B200-PROCESS-UPDATE-RECORDS               *03070002
030800******************************************************************03080002
030900 C200-UPDATE-THIRD-PTY-RECORD.                                    03090002
031000                                                                  03100002
031100     PERFORM WITH TEST AFTER                                      03110002
031200         VARYING PV-SQL-SUB                                       03120002
031300         FROM 1 BY 1                                              03130002
031400         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       03140002
031500                OR SQLCODE = -911                                 03150002
031600                OR SQLCODE = 0)                                   03160002
031700                                                                  03170002
031800         EXEC SQL                                                 03180002
031900             UPDATE SVT_3RD_PTY_TRN                               03190002
032000                SET SELR_PSTL_CDE = :SV054-SAFEWAY-ZIP-CDE        03200002
032100                   ,SELR_TRN_ID   = :SV054-TRANSACTION-NBR        03210002
032200             WHERE CRD_NBR       = :SV054-GIFT-CARD-NBR           03220002
032300         END-EXEC                                                 03230002
032400                                                                  03240002
032500         EVALUATE TRUE                                            03250002
032600             WHEN SQLCODE = 0                                     03260002
032700                 ADD +1 TO PA-CRD-TXN-ROWS-UPDATED                03270002
032800             WHEN SQLCODE = -911                                  03280002
032900                 ADD +1 TO PV-DEADLOCK-COUNTER                    03290002
033000                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        03300002
033100                     MOVE 'C200-UPDATE-THIRD-PTY-RECORD         ' 03310002
033200                                      TO PV-PARAGRAPH-NAME        03320002
033300                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        03330002
033400                                      TO PV-DB2-OPER-ATTEMPTED    03340002
033500                     PERFORM Z900-SQL-ABEND                       03350002
033600                 ELSE                                             03360002
033700                     SET PS-RESTART-REQUIRED TO TRUE              03370002
033800                 END-IF                                           03380002
033900             WHEN OTHER                                           03390002
034000                 MOVE SV054-GIFT-CARD-NBR TO PV-CARD-NUMBER       03400002
034100                 DISPLAY 'UPDATE ABENDED ON CARD ' PV-CARD-NUMBER 03410002
034200                 MOVE 'C200-UPDATE-THIRD-PTY-RECORD         '     03420002
034300                                      TO PV-PARAGRAPH-NAME        03430002
034400                 MOVE 'UPDATE SVT_3RD_PTY_TRN        '            03440002
034500                                      TO PV-DB2-OPER-ATTEMPTED    03450002
034600                 PERFORM Z900-SQL-ABEND                           03460002
034700         END-EVALUATE                                             03470002
034800     END-PERFORM.                                                 03480002
034900                                                                  03490002
035000     IF PV-SQL-SUB > PC-MAX-RETRIES                               03500002
035100         MOVE 'C200-UPDATE-THIRD-PTY-RECORD         '             03510002
035200                                      TO PV-PARAGRAPH-NAME        03520002
035300         MOVE 'VERIFY RETRIES EXCEEDED       '                    03530002
035400                                      TO PV-DB2-OPER-ATTEMPTED    03540002
035500         PERFORM Z900-SQL-ABEND                                   03550002
035600     END-IF.                                                      03560002
035700                                                                  03570002
070700******************************************************************07070001
070800*  ABEND THE PROGRAM IN THE EVENT THAT A SQL ERROR OR WARNING    *07080001
070900*  CODE OCCURS.                                                  *07090001
071000******************************************************************07100001
071100 Z900-SQL-ABEND.                                                  07110001
071200                                                                  07120001
071300     DISPLAY '** ABEND     **'.                                   07130001
071400     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        07140001
071500     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              07150001
071600     DISPLAY '** OPERATION ** = ' PV-DB2-OPER-ATTEMPTED.          07160001
071700                                                                  07170001
071800******************************************************************07180001
071900*  THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-  *07190001
072000*  MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE       *07200001
072100*  'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE   *07210001
072200*  FORMAT.                                                       *07220001
072300******************************************************************07230001
072400     COPY DPPD004.                                                07240001
072500                                                                  07250001
072600     MOVE +4013 TO ABEND-CODE.                                    07260001
072700     CALL 'ILBOABN0' USING ABEND-CODE.                            07270001
072800                                                                  07280001
072900******************************************************************07290001
073000*  THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-  *07300001
073100*  MENTS THAT ARE REQUIRED TO INVOKE THE TRANSACTION PRESENTATION*07310001
073200*  MODULE (DPKUT901) OF THE DB2 CHECKPOINT RESTART SYSTEM.       *07320001
073300******************************************************************07330001
073400     COPY DPPD001.                                                07340001
