000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.    AHKUT007.                                         00020000
000300 AUTHOR.        NANCY EILBES.                                     00030000
000400 INSTALLATION.  KOHLS.                                            00040000
000500 DATE-WRITTEN   AUG, 2002.                                        00050000
000600 DATE-COMPILED.                                                   00060000
000700*----------------------------------------------------------------*00070000
000800*          BYPASS ARCHIVING IMPORT PURCHASE ORDERS               *00080000
000900*                      COBOL WITH DB2                            *00090000
000901*                                                                *00090100
000902* THE PURPOSE OF THIS PROGRAM IS TO ELIMINATE IMPORT PO'S FROM   *00090200
000903* THE PURGE/ARCHIVE DRIVER FILE.  FOR EACH RECORD ON THE DRIVER  *00090300
000904* FILE, IT WILL RETRIEVE THE PO TYPE FROM THE PURCHASE ORDER     *00090400
000905* HEADER TABLE FOR THE MATCHING PO. IF THE PO TYPE IS 'IM','IE'  *00090500
000906* OR 'IF', NO RECORDS FROM THE INPUT FILE WITH THAT PO WILL BE   *00090600
000907* WRITTEN TO THE OUTPUT FILE.                                    *00090700
000908*                                                                *00090800
000909*----------------------------------------------------------------*00090900
000910*  DB2 TABLES:                                                   *00091000
000920*  1. PURCHASE ORDER HEADER TABLE (TPURCHS)                      *00092000
000930*                                                                *00093000
000940*  INPUT:                                                        *00094000
000950*  1. ARCHIVE DRIVER FILE (AHRD001)                              *00095000
000960*                                                                *00096000
000970*  OUTPUT:                                                       *00097000
000980*  1. ARCHIVE DRIVER FILE WITHOUT IMPORT PO'S (AHRD001)          *00098000
000990*----------------------------------------------------------------*00099000
001000*  CHANGE LOG:                                                   *00100000
001100*  DATE 01/07/2004                                               *00110000
001200*       CHANGE MADE: ADDED CONDITION TO SQL IN PARAGRAPH         *00120000
001300*       S100-CHECK-FOR-IMPORT TO ALSO CHECK FOR POS THAT ARE     *00130000
001400*       IN RMS.  THESE POS WILL ALSO BE BYPASSED IN THE ARCHIVE  *00140000
001500*       PROCESS.                                                 *00150000
001600*       MADE BY: NANCY EILBES                 WR#: 24481         *00160000
001700*                                                                *00170000
001800*  DATE 06/04/2007                                               *00180019
001900*       CHANGE MADE: MODIFIED PROGRAM TO ACCEPT A PARM TO        *00190000
002000*       INDICATE WHETHER OR NOT IMPORTS ARE BEING ARCHIVED IN    *00200000
002100*       THIS RUN.  THE PROGRAM NEEDS TO ALWAYS CHECK FOR PO'S    *00210019
002200*       WITH A RMS INDICATOR = 'Y' AND DROP THESE PO'S FROM THE  *00220019
002300*       DRIVER FILE.  ALSO, INCREASED THE SIZE OF THE INPUT AND  *00230019
002310*       OUTPUT FILES FROM 186 TO 189 TO ALLOW FOR THE 2 NEW      *00231019
002311*       FIELDS, DC-NBR AND MTCH-LVL-CDE, ADDED TO COPYBOOK       *00231119
002312*       AHRD001.                                                 *00231219
002320*       MADE BY: ROLF NOHE                    WR#: 30241         *00232000
002321*                                                                *00232120
002322*  DATE 07/02/2007                                               *00232223
002323*       CHANGE MADE: REMOVED RMS-IND AND THE CHECK FOR RMS-IND   *00232321
002324*       IN ORDER TO ALLOW THE ARCHIVING OF PO'S WITH RMS-IND.    *00232421
002331*       MADE BY: ROLF NOHE                    WR#: 31939         *00233120
002332*----------------------------------------------------------------*00233220
002340 ENVIRONMENT DIVISION.                                            00234000
002350 CONFIGURATION SECTION.                                           00235000
002360 SOURCE-COMPUTER.        IBM-3090.                                00236000
002370 OBJECT-COMPUTER.        IBM-3090.                                00237000
002380                                                                  00238000
002390 INPUT-OUTPUT SECTION.                                            00239000
002400 FILE-CONTROL.                                                    00240000
002500                                                                  00250000
002600     SELECT  IN-DRIVER-FILE   ASSIGN TO INP01.                    00260000
002700     SELECT  OUT-DRIVER-FILE  ASSIGN TO OUT01.                    00270000
002800                                                                  00280000
002900 DATA DIVISION.                                                   00290000
003000 FILE SECTION.                                                    00300000
003100                                                                  00310000
003200 FD  IN-DRIVER-FILE                                               00320000
003300     RECORDING MODE IS F                                          00330000
003400     LABEL RECORDS ARE STANDARD                                   00340000
003500     BLOCK CONTAINS 0 RECORDS.                                    00350000
003600 01  IN-DRIVER-RECORD                PIC  X(189).                 00360000
003700                                                                  00370000
003800 FD  OUT-DRIVER-FILE                                              00380000
003900     RECORDING MODE IS F                                          00390000
004000     LABEL RECORDS ARE STANDARD                                   00400000
004100     BLOCK CONTAINS 0 RECORDS.                                    00410000
004200 01  OUT-DRIVER-RECORD               PIC  X(189).                 00420000
004370                                                                  00437005
004400 WORKING-STORAGE SECTION.                                         00440000
004500                                                                  00450000
004600 01  PS-PROGRAM-SWITCHES.                                         00460000
004700     05  PS-NEW-PO-SW                PIC X(01) VALUE 'N'.         00470000
004800         88  PS-NEW-PO                         VALUE 'Y'.         00480000
004900     05  PS-END-OF-INPUT-SW          PIC X(01) VALUE 'N'.         00490000
005000         88  PS-END-OF-INPUT                   VALUE 'Y'.         00500000
005100     05  PS-PO-IS-IMPORT-SW          PIC X(01) VALUE 'N'.         00510000
005200         88  PS-PO-IS-IMPORT                   VALUE 'Y'.         00520000
005500                                                                  00550000
005600 01  PV-PROGRAM-VARIABLES.                                        00560000
005700     05  PV-INPUT-COUNT              PIC  9(9) VALUE 0.           00570000
005800     05  PV-INPUT-PO-COUNT           PIC  9(9) VALUE 0.           00580000
005900     05  PV-RECORDS-BYPASSED-COUNT   PIC  9(9) VALUE 0.           00590000
005920     05  PV-RCRDS-BYPASSED-COUNT-IMP PIC  9(9) VALUE 0.           00592001
006000     05  PV-RECORDS-WRITTEN-COUNT    PIC  9(9) VALUE 0.           00600000
006100     05  PV-PREV-PO-NBR              PIC S9(9) VALUE 0 COMP.      00610000
006200     05  PV-ONE                      PIC  X(1) VALUE SPACES.      00620000
006300                                                                  00630000
006400*---------------------------------------------------------------* 00640000
006500*  RECORD LAYOUT FOR DRIVER FILE.                               * 00650000
006600*---------------------------------------------------------------* 00660000
006700     COPY AHRD001.                                                00670000
006800                                                                  00680000
006900 01  WS-ABEND-FIELDS.                                             00690000
007000     05  WS-ABEND-PROGRAM          PIC X(8)   VALUE 'AHKUT007'.   00700000
007100     05  WS-ABEND-PARAGRAPH        PIC X(50)  VALUE SPACES.       00710000
007200     05  WS-ABEND-OPERATION        PIC X(50)  VALUE SPACES.       00720000
007300     05  WS-ABEND-STRUCTURE-1      PIC X(8)   VALUE SPACES.       00730000
007400     05  WS-ABEND-STRUCTURE-2      PIC X(8)   VALUE SPACES.       00740000
007500     05  WS-ABEND-STATUS           PIC XX     VALUE SPACES.       00750000
007600                                                                  00760000
007700 01  ABEND-CODE                    PIC S9(4)  COMP SYNC           00770000
007800                                              VALUE ZEROS.        00780000
007900     88 AP-TABLE-FULL              VALUE +4004.                   00790000
008000     88 AP-EMPTY-FILE              VALUE +4005.                   00800000
008100     88 AP-DB2-ERROR               VALUE +4013.                   00810000
008200                                                                  00820000
008300                                                                  00830000
008400*---------------------------------------------------------------* 00840000
008500*  LAYOUT FOR THE CONTROL CARD.                                 * 00850000
008600*---------------------------------------------------------------* 00860000
008700 01  CC-CONTROL-CARD.                                             00870000
008800     05  CC-PROGRAM-ID            PIC X(08) VALUE SPACES.         00880000
008810     05  FILLER                   PIC X(01) VALUE SPACES.         00881000
008820     05  FILLER                   PIC X(17) VALUE SPACES.         00882000
008830     05  FILLER                   PIC X(01) VALUE SPACES.         00883000
008840     05  CC-ARCHIVE-IMPORT-IND    PIC X(01) VALUE SPACES.         00884000
008850                                                                  00885000
008860                                                                  00886000
008870*---------------------------------------------------------------* 00887000
008880*  DB2 FORMATTED MESSAGE AREA FOR SQLA                            00888000
008890*---------------------------------------------------------------* 00889000
008900     COPY DPWS004.                                                00890000
009000                                                                  00900000
009100*---------------------------------------------------------------* 00910000
009200* SQL COMMUNICATIONS AREA DCLGEN                                  00920000
009300*---------------------------------------------------------------* 00930000
009400     EXEC SQL                                                     00940000
009500          INCLUDE SQLCA                                           00950000
009600     END-EXEC.                                                    00960000
009700                                                                  00970000
009800*--------------------------------------------------------------*  00980000
009900* DB2 AREA FOR SYSDUMMY1                                          00990000
010000*--------------------------------------------------------------*  01000000
010100     EXEC SQL                                                     01010000
010200          INCLUDE SYSDUMMY                                        01020000
010300     END-EXEC.                                                    01030000
010400                                                                  01040000
010500*---------------------------------------------------------------* 01050000
010600* DB2 AREA FOR TPURCHS                                          * 01060000
010700*---------------------------------------------------------------* 01070000
010800     EXEC SQL                                                     01080000
010900          INCLUDE TPURCHS                                         01090000
011000     END-EXEC.                                                    01100000
011100                                                                  01110000
011480 PROCEDURE DIVISION.                                              01148000
011490                                                                  01149000
011500 A100-PROGRAM-MAINLINE.                                           01150000
011600                                                                  01160000
011700     PERFORM B100-INITIALIZE.                                     01170000
011800                                                                  01180000
011900     PERFORM B200-PROCESS-DRIVER-FILE                             01190000
012000         UNTIL PS-END-OF-INPUT.                                   01200000
012100                                                                  01210000
012200     PERFORM B300-END-OF-JOB.                                     01220000
012300     GOBACK.                                                      01230000
012400                                                                  01240000
012500                                                                  01250000
012600*----------------------------------------------------------------*01260000
012700*   OPEN FILES, PERFORM PRIMING READ.                            *01270000
012800*----------------------------------------------------------------*01280000
012900 B100-INITIALIZE.                                                 01290000
013000                                                                  01300000
013100     DISPLAY '******************************'.                    01310000
013200     DISPLAY '*  STARTING PROGRAM AHKUT007 *'.                    01320000
013300     DISPLAY '******************************'.                    01330000
013400                                                                  01340000
013500     OPEN  INPUT IN-DRIVER-FILE                                   01350000
013600          OUTPUT OUT-DRIVER-FILE.                                 01360015
013700                                                                  01370000
013800     ACCEPT CC-CONTROL-CARD.                                      01380000
013900     DISPLAY 'CONTROL CARD VALUES FOR THIS EXECUTION:'            01390000
013910     DISPLAY CC-CONTROL-CARD.                                     01391000
013920                                                                  01392000
013930     PERFORM R100-READ-DRIVER-FILE.                               01393000
013940                                                                  01394000
013950*----------------------------------------------------------------*01395000
013960* DETERMINES IF EACH RECORD SHOULD BE WRITTEN OR BYPASSED.       *01396000
013970*----------------------------------------------------------------*01397000
013980 B200-PROCESS-DRIVER-FILE.                                        01398000
013990                                                                  01399000
014000     IF AH001-B-PO-NBR = PV-PREV-PO-NBR                           01400000
014100         CONTINUE                                                 01410000
014200     ELSE                                                         01420000
014300         MOVE AH001-B-PO-NBR   TO PV-PREV-PO-NBR                  01430000
014400         MOVE 'N'              TO PS-PO-IS-IMPORT-SW              01440000
014500         ADD +1                TO PV-INPUT-PO-COUNT               01450000
014600         PERFORM S100-CHECK-FOR-IMPORT                            01460000
015200     END-IF.                                                      01520000
015300                                                                  01530000
015410     IF PS-PO-IS-IMPORT                                           01541010
015710        IF CC-ARCHIVE-IMPORT-IND = 'N'                            01571022
015711           ADD +1            TO PV-RECORDS-BYPASSED-COUNT         01571122
015720           ADD +1            TO PV-RCRDS-BYPASSED-COUNT-IMP       01572022
015731        ELSE                                                      01573122
015740           PERFORM W100-WRITE-DRIVER-RECORD                       01574022
015750        END-IF                                                    01575022
015770     ELSE                                                         01577000
015780        PERFORM W100-WRITE-DRIVER-RECORD                          01578022
015790     END-IF.                                                      01579000
015800                                                                  01580000
015900     PERFORM R100-READ-DRIVER-FILE.                               01590000
016000                                                                  01600000
016100*---------------------------------------------------------------* 01610000
016200*   CLOSE FILES AND DISPLAY END OF RUN MESSAGE.                  *01620000
016300*---------------------------------------------------------------* 01630000
016400 B300-END-OF-JOB.                                                 01640000
016500                                                                  01650000
016600     CLOSE IN-DRIVER-FILE                                         01660000
016700           OUT-DRIVER-FILE.                                       01670015
016800                                                                  01680000
016900     DISPLAY 'RECORDS READ    :' PV-INPUT-COUNT.                  01690000
017000     DISPLAY 'NUMBER OF POS   :' PV-INPUT-PO-COUNT                01700000
017100     DISPLAY 'RECORDS WRITTEN :' PV-RECORDS-WRITTEN-COUNT.        01710000
017200     DISPLAY 'RECORDS BYPASSED:' PV-RECORDS-BYPASSED-COUNT.       01720002
017300                                                                  01730000
017400                                                                  01740000
017500                                                                  01750000
017600*---------------------------------------------------------------* 01760000
017700*   READ INPUT DRIVER FILE INTO COPY BOOK AHRD001                *01770000
017800*---------------------------------------------------------------* 01780000
017900 R100-READ-DRIVER-FILE.                                           01790000
018000                                                                  01800000
018100     READ IN-DRIVER-FILE INTO AH001-DRIVER-RECORD-LAYOUT          01810000
018200       AT END SET PS-END-OF-INPUT TO TRUE.                        01820000
018300                                                                  01830000
018400     IF PS-END-OF-INPUT                                           01840000
018500         CONTINUE                                                 01850000
018600     ELSE                                                         01860000
018700         ADD +1 TO PV-INPUT-COUNT                                 01870000
018800     END-IF.                                                      01880000
018900                                                                  01890000
019000*---------------------------------------------------------------* 01900000
019100* PERFORMS A CHECK TO VERIFY THE PO BEING POCESSED IS AN IMPORT.  01910000
019200*---------------------------------------------------------------* 01920000
019300 S100-CHECK-FOR-IMPORT.                                           01930000
019400     EXEC SQL                                                     01940000
019500      SELECT '1'                                                  01950000
019600        INTO :PV-ONE                                              01960000
019700        FROM SYSIBM.SYSDUMMY1 X                                   01970000
019800       WHERE EXISTS                                               01980000
019900            (SELECT '1'                                           01990000
020000               FROM TPURCHS                                       02000000
020100              WHERE PO_NBR         = :AH001-B-PO-NBR              02010000
020200                AND VER_STATUS_CDE = 'A'                          02020000
020300                AND PO_TYP_CDE     IN ('IM','IE','IF')            02030000
020400                AND X.IBMREQD      = X.IBMREQD)                   02040000
020500     END-EXEC.                                                    02050000
020600                                                                  02060000
020700     EVALUATE TRUE                                                02070000
020800         WHEN SQLCODE = ZERO                                      02080000
020900              SET PS-PO-IS-IMPORT    TO TRUE                      02090000
021000         WHEN SQLCODE = +100                                      02100000
021100              CONTINUE                                            02110000
021200         WHEN SQLWARN0 NOT EQUAL SPACE                            02120000
021300         WHEN SQLCODE NOT EQUAL ZERO                              02130000
021400              MOVE 'S100-CHECK-FOR-IMPORT'                        02140000
021500                                     TO WS-ABEND-PARAGRAPH        02150000
021600              MOVE 'CHECK PO FOR IMPORT'                          02160000
021700                                     TO WS-ABEND-OPERATION        02170000
021800              MOVE 'TPURCHS'         TO WS-ABEND-STRUCTURE-1      02180000
021900              PERFORM Z999-DB2-ABEND                              02190000
022000     END-EVALUATE.                                                02200000
022100                                                                  02210000
022200                                                                  02220000
022783*----------------------------------------------------------------*02278300
022784*   WRITE A RECORD TO THE DRIVER FILE IN THE FORMAT OF AHRD001   *02278400
022785*----------------------------------------------------------------*02278500
022786 W100-WRITE-DRIVER-RECORD.                                        02278600
022787                                                                  02278700
022788     WRITE OUT-DRIVER-RECORD FROM AH001-DRIVER-RECORD-LAYOUT.     02278800
022789     ADD +1 TO PV-RECORDS-WRITTEN-COUNT.                          02278900
022798                                                                  02279803
022910*----------------------------------------------------------------*02291005
023000*   DISPLAY INFORMATION NEEDED FOR DEBUGGING/MAINTENANCE/SUPPORT *02300000
023100*   AND CALL THE ABEND PROCESSOR IN THE EVENT THAT AN            *02310000
023200*   SQL ERROR OR WARNING CODE OCCURS.                            *02320000
023300*----------------------------------------------------------------*02330000
023400 Z999-DB2-ABEND.                                                  02340000
023500                                                                  02350000
023600     COPY DPPD004.                                                02360000
023700                                                                  02370000
023800     DISPLAY '*** DB2 ERROR '.                                    02380000
023900     DISPLAY '*** PROGRAM   = ' WS-ABEND-PROGRAM.                 02390000
024000     DISPLAY '*** PARAGRAPH = ' WS-ABEND-PARAGRAPH.               02400000
024100     DISPLAY '*** OPERATION = ' WS-ABEND-OPERATION.               02410000
024200     DISPLAY '*** TABLE 1   = ' WS-ABEND-STRUCTURE-1.             02420000
024300                                                                  02430000
024400*----------------------------------------------------------------*02440000
024500* CALL ABEND                                                     *02450000
024600*----------------------------------------------------------------*02460000
024700     MOVE +4013                  TO ABEND-CODE.                   02470000
024800     CALL 'ILBOABN0' USING ABEND-CODE.                            02480000
