000500***************************************************************** 00050001
000600 IDENTIFICATION DIVISION.                                         00060001
000700***************************************************************** 00070001
000800*                                                                 00080001
000900 PROGRAM-ID.             SUKUP011.                                00090001
001000 AUTHOR.                 TOM BOYD                                 00100001
001100 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00110001
001200 DATE-WRITTEN.           JUNE 2002.                               00120001
001300 DATE-COMPILED.                                                   00130001
001400*                                                                 00140001
001500***************************************************************** 00150001
001600* THIS PROGRAM WILL BE USED TO DELETE OLD ENTRIES FROM THE UPLOAD 00160001
001700* ERROR TABLE (TSUCRDV).                                          00170001
001800***************************************************************** 00180001
001900 ENVIRONMENT DIVISION.                                            00190001
002000***************************************************************** 00200001
002100 CONFIGURATION SECTION.                                           00210001
002200 SOURCE-COMPUTER.                        IBM-3090.                00220001
002300 OBJECT-COMPUTER.                        IBM-3090.                00230001
002400 INPUT-OUTPUT SECTION.                                            00240001
002500 FILE-CONTROL.                                                    00250001
002600                                                                  00260001
002700     SELECT EXTRACT-FILE                                          00270001
002800         ASSIGN TO INP01.                                         00280001
002900/                                                                 00290001
003000***************************************************************** 00300001
003100 DATA DIVISION.                                                   00310001
003200***************************************************************** 00320001
003300 FILE SECTION.                                                    00330001
003400                                                                  00340001
003500 FD  EXTRACT-FILE                                                 00350001
003600     RECORDING MODE IS F                                          00360001
003700     LABEL RECORDS ARE STANDARD                                   00370001
003800     BLOCK CONTAINS 0 RECORDS.                                    00380001
003900 01  EXTRACT-RECORD                   PIC X(100).                 00390008
004000/                                                                 00400001
004100***************************************************************** 00410001
004200 WORKING-STORAGE SECTION.                                         00420001
004300***************************************************************** 00430001
004400                                                                  00440001
004500 01  PS-SWITCHES.                                                 00450001
004600     05  PS-END-OF-INPUT-FILE-SW      PIC X(01) VALUE 'N'.        00460001
004700         88  PS-END-OF-INPUT                    VALUE 'Y'.        00470001
004800         88  PS-NOT-END-OF-INPUT                VALUE 'N'.        00480001
004900                                                                  00490001
005000 01  PV-VARIABLES.                                                00500001
005100     05  PV-COUNT                     PIC  9(09) VALUE ZERO.      00510012
005200     05  PV-READ-COUNT                PIC  9(09) VALUE ZERO.      00520012
005300     05  PV-DELETE-COUNT              PIC  9(09) VALUE ZERO.      00530008
005400     05  PV-DUPLICATE-CNT             PIC  9(09) VALUE ZERO.      00540011
008500     05  PV-DISPLAY-COUNT             PIC ZZZ,ZZZ,ZZ9.            00850001
008510     05  PV-NOT-FOUND-COUNT           PIC  9(09) VALUE ZERO.      00851009
008600     05  PV-COMMIT-COUNT              PIC  9(09) VALUE ZERO.      00860008
008700     05  PV-SKIP-CNT                  PIC  9(09) VALUE ZERO.      00870010
008800     05  PV-PREVIOUS-SML              PIC  9(18) VALUE ZERO.      00880010
009300                                                                  00930001
009400******************************************************************00940001
009500 01  PV-ABEND-FIELDS.                                             00950001
009600     05  PV-ABEND-CODE                PIC S9(04) VALUE +0         00960001
009700                                                 COMP SYNC.       00970001
009800     05  PV-ABEND-PROGRAM             PIC  X(08) VALUE 'SUKUP011'.00980001
009900     05  PV-ABEND-PARAGRAPH           PIC  X(50) VALUE SPACES.    00990001
010000     05  PV-ABEND-OPERATION           PIC  X(51) VALUE SPACES.    01000001
010100     05  PV-ABEND-STRUCTURE-1         PIC  X(08) VALUE SPACES.    01010009
010200     05  PV-ABEND-STRUCTURE-2         PIC  X(08) VALUE SPACES.    01020009
010300     05  PV-ABEND-STRUCTURE-3         PIC  X(08) VALUE SPACES.    01030009
010400     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    01040001
010500     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    01050001
010600     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    01060001
010610     05  PV-DB2-FUNCTION              PIC  X(50) VALUE SPACES.    01061009
010700/                                                                 01070001
010800 01  PC-CONSTANTS.                                                01080001
010900     05  PC-CURRENT-PROGRAM-NAME      PIC X(08) VALUE 'SUKUP011'. 01090001
011000     05  PC-ROW-NOT-FOUND             PIC S9(04)    VALUE +100    01100001
011100                                                   COMP SYNC.     01110001
011200     05  PC-COMMIT-HOLD               PIC 9(3)  VALUE 100.        01120012
011300     05  PC-COUNT-HOLD                PIC 9(9)  VALUE 100000.     01130012
011400/                                                                 01140001
012000******************************************************************01200001
012100*  COPYBOOK FOR PURGE RECORDS FROM OUTBOUND DATABASE.             01210008
012200******************************************************************01220001
012300     COPY SURD049.                                                01230008
012400*                                                                 01240001
013900                                                                  01390009
014500******************************************************************01450001
014600*   DB2 SQL COMMUNICATION AREA                                    01460001
014700******************************************************************01470001
014800     EXEC SQL                                                     01480001
014900         INCLUDE SQLCA                                            01490001
015000     END-EXEC.                                                    01500001
015100*                                                                 01510001
015200     COPY SQLCA2.                                                 01520001
015300*                                                                 01530001
015400******************************************************************01540001
015500*   UPLOAD ERROR TABLE                                            01550001
015600******************************************************************01560001
015700*                                                                 01570001
015800     EXEC SQL                                                     01580001
015900         INCLUDE TSUCRDV                                          01590001
016000     END-EXEC.                                                    01600001
016100*                                                                 01610001
016200******************************************************************01620001
016300 PROCEDURE DIVISION.                                              01630001
016400******************************************************************01640001
016500 0000-MAINLINE.                                                   01650001
016600                                                                  01660001
016700     PERFORM 1000-INITIALIZE.                                     01670001
016800                                                                  01680001
016900     PERFORM 2000-PROCESS-EXTRACT                                 01690001
017000         UNTIL PS-END-OF-INPUT.                                   01700001
017100                                                                  01710001
017200     PERFORM 9000-EOJ.                                            01720001
017300                                                                  01730001
017400      GOBACK.                                                     01740001
017500                                                                  01750001
017600******************************************************************01760001
017700*  INITIALIZATION TASKS.                                          01770001
017800*    -- OPEN INPUT FILE                                           01780001
017900*    -- READ FILE                                                 01790001
018000******************************************************************01800001
018100 1000-INITIALIZE.                                                 01810001
018200                                                                  01820001
018300     OPEN INPUT  EXTRACT-FILE.                                    01830001
018400                                                                  01840001
018500     PERFORM 2100-READ-EXTRACT.                                   01850001
018600/                                                                 01860001
018700******************************************************************01870001
018800 2000-PROCESS-EXTRACT.                                            01880001
018900******************************************************************01890001
019000*                                                                 01900001
019001     IF  PV-COUNT  <  PC-COUNT-HOLD                               01900112
019002         CONTINUE                                                 01900212
019003     ELSE                                                         01900312
019004         MOVE PV-READ-COUNT  TO  PV-DISPLAY-COUNT                 01900413
019005         DISPLAY 'READ:  '       PV-DISPLAY-COUNT                 01900513
019006         MOVE  ZEROES  TO        PV-COUNT                         01900613
019008     END-IF.                                                      01900812
019009                                                                  01900912
019010     IF  SU049-SML  =  PV-PREVIOUS-SML                            01901010
019020         ADD  1    TO  PV-DUPLICATE-CNT                           01902011
019030     ELSE                                                         01903010
019040     IF  SU049-PURGE-NO                                           01904010
019050         ADD  1    TO  PV-SKIP-CNT                                01905010
019060     ELSE                                                         01906010
019070         PERFORM 8000-DELETE-DIVERT-RECS                          01907010
019090         ADD +1 TO PV-COMMIT-COUNT                                01909010
019091     END-IF                                                       01909110
019092     END-IF.                                                      01909210
019093                                                                  01909310
019094     MOVE SU049-SML  TO  PV-PREVIOUS-SML.                         01909410
019300                                                                  01930001
019400     IF PV-COMMIT-COUNT > PC-COMMIT-HOLD                          01940009
019410         PERFORM 2200-COMMIT-DELETE                               01941004
020100     END-IF.                                                      02010001
020200                                                                  02020001
020300     PERFORM 2100-READ-EXTRACT.                                   02030001
020400*                                                                 02040001
020500******************************************************************02050001
020600*  READ NEXT INPUT FILE RECORD.                                   02060001
020700******************************************************************02070001
020800 2100-READ-EXTRACT.                                               02080001
020900                                                                  02090001
021000     READ EXTRACT-FILE INTO SU049-EXTRACT-RECORD                  02100008
021100        AT END                                                    02110001
021200           SET PS-END-OF-INPUT TO TRUE                            02120001
021300        NOT AT END                                                02130001
021400           ADD +1                   TO PV-READ-COUNT              02140001
021410                                       PV-COUNT                   02141012
021500     END-READ.                                                    02150001
021600*                                                                 02160001
021700******************************************************************02170001
021800* COMMIT THE DELETE FROM ERROR TABLE                              02180004
021900******************************************************************02190001
022000 2200-COMMIT-DELETE.                                              02200004
022001                                                                  02200104
022002      EXEC SQL                                                    02200204
022003          COMMIT                                                  02200308
022004      END-EXEC.                                                   02200408
022005                                                                  02200504
022007      MOVE +0 TO PV-COMMIT-COUNT.                                 02200709
022008                                                                  02200804
022010*                                                                 02201004
022020******************************************************************02202004
022030* DELETE THE ROW FROM THE DIVERT DATABASE                         02203008
022040******************************************************************02204004
022050 8000-DELETE-DIVERT-RECS.                                         02205008
022100                                                                  02210001
022200     EXEC SQL                                                     02220001
022300          DELETE                                                  02230008
022400            FROM  TSUCRDV                                         02240008
022500           WHERE  SHIPT_UNT_ID  = :SU049-SML                      02250008
023000     END-EXEC.                                                    02300001
023100                                                                  02310001
023200     EVALUATE TRUE                                                02320001
023300         WHEN SQLCODE = 0                                         02330001
023400             ADD +1           TO PV-DELETE-COUNT                  02340001
023500         WHEN SQLCODE = +100                                      02350001
023600             ADD +1           TO PV-NOT-FOUND-COUNT               02360001
023700         WHEN SQLCODE < 0                                         02370001
023800         WHEN SQLCODE > 0                                         02380001
023900         WHEN SQLWARN0 = 'W'                                      02390001
024000             MOVE '8000-DELETE-DIVERT-RECS'                       02400008
024100                         TO PV-ABEND-PARAGRAPH                    02410009
024200             MOVE 'DELETE OF TSUCRDV'                             02420007
024300                         TO PV-DB2-FUNCTION                       02430001
024400             PERFORM 9200-SQL-ABEND                               02440001
024500     END-EVALUATE.                                                02450001
024600/                                                                 02460001
024700******************************************************************02470001
024800*CLOSE INPUT FILE.                                                02480001
024900******************************************************************02490001
025000 9000-EOJ.                                                        02500001
025100*                                                                 02510001
025200     CLOSE EXTRACT-FILE.                                          02520001
025300                                                                  02530001
025400     MOVE PV-READ-COUNT      TO PV-DISPLAY-COUNT.                 02540010
025500     DISPLAY 'READ:         '   PV-DISPLAY-COUNT.                 02550010
025510     MOVE PV-DELETE-COUNT    TO PV-DISPLAY-COUNT.                 02551010
025520     DISPLAY 'DELETE:       '   PV-DISPLAY-COUNT.                 02552010
025600     MOVE PV-NOT-FOUND-COUNT TO PV-DISPLAY-COUNT.                 02560001
025700     DISPLAY 'NOT FOUND     '   PV-DISPLAY-COUNT.                 02570010
025701     MOVE PV-SKIP-CNT        TO PV-DISPLAY-COUNT.                 02570110
025702     DISPLAY 'SKIP          '   PV-DISPLAY-COUNT.                 02570210
025703     MOVE PV-DUPLICATE-CNT   TO PV-DISPLAY-COUNT.                 02570311
025704     DISPLAY 'DUPLICATE     '   PV-DISPLAY-COUNT.                 02570411
025710                                                                  02571010
026000/                                                                 02600001
026100******************************************************************02610001
026200 9200-SQL-ABEND.                                                  02620001
026300******************************************************************02630001
026400                                                                  02640001
026500     MOVE SQLCODE                     TO SQLCODE2.                02650001
026600     MOVE SQLERRD(3)                  TO SQLERRD3.                02660001
026700                                                                  02670001
026800     DISPLAY '** ABEND **         ** = SQLERROR'.                 02680001
026900     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        02690001
027000     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.             02700009
027100     DISPLAY '** OPERATION ** = ' PV-DB2-FUNCTION.                02710001
027200     DISPLAY '*** MESSAGE     = ' PV-DB2-OPERATION-MESSAGE-1.     02720001
027300     DISPLAY '***             = ' PV-DB2-OPERATION-MESSAGE-2.     02730001
027400     DISPLAY '***             = ' PV-DB2-OPERATION-MESSAGE-3.     02740001
027500                                                                  02750001
027600     DISPLAY '** SQLCODE          ** = ' SQLCODE2.                02760001
027700     DISPLAY '** ROWS PROCESSED   ** = ' SQLERRD3.                02770001
027800     DISPLAY '** SQLERRM          ** = ' SQLERRM.                 02780001
027900     DISPLAY '** SQLERRMC         ** = ' SQLERRMC.                02790001
028000                                                                  02800001
028100                                                                  02810001
028200     MOVE +4013                       TO PV-ABEND-CODE.           02820001
028300     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         02830001
028400                                                                  02840001
