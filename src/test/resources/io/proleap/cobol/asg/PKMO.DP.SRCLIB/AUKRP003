000100***************************************************************** 00010003
000200 IDENTIFICATION DIVISION.                                         00020003
000300***************************************************************** 00030003
000400                                                                  00040003
000500 PROGRAM-ID.             AUKRP003.                                00050003
000600 AUTHOR.                 BARB ERTL.                               00060003
000700 INSTALLATION.           KOHLS.                                   00070003
000800 DATE-WRITTEN            FEBRUARY 2008.                           00080003
000900 DATE-COMPILED.                                                   00090003
001000                                                                  00100003
001100***************************************************************** 00110003
001200*                                                                 00120003
001300*  THIS PROGRAM WILL CREATE A DAILY REPORT OF BLACKHAWK 3RD PARTY 00130003
001400*  GIFT CARDS SOLD THAT WERE NOT PASSED FOR AUTHORIZATION.        00140003
001500*                                                                 00150003
001600*   INPUT: INP01 - CONTAINS POS DATE, WHICH IS USED AS THE        00160003
001700*                  PROCESS DATE TO CREATE THE REPORT.             00170003
001800*  OUTPUT: RPT01 - REPORT SHOWING 3RD PARTY GIFT CARDS SOLD BUT   00180003
001900*                  NOT AUTHORIZED.                                00190005
002000***************************************************************** 00200003
002100*                                                                 00210003
002200*  THE PROGRAM READS A CONTROL CARD FILE TO GET THE POS DATE.     00220003
002300*                                                                 00230003
002400*  THIS DATE IS PASSED TO THE KOHLS CALENDAR ROUTINE.  THE DATE   00240003
002500*  IS VALIDATED AND RETURNED IN DB2 DATE FORMAT.                  00250003
002600*                                                                 00260003
002700*  THE POS DATE IS USED IN A CURSOR TO SELECT SALES DATA FROM     00270003
002800*  THE COSA TABLES. THIS CURSOR IS A UNION OF TWO SELECT          00280003
002900*  STATEMENTS:                                                    00290003
003000*    1. A JOIN OF TABLES TEPPART, TEPITM AND TEPTRN TO GET        00300003
003100*       SALES DATA FOR DEPARTMENTS 833 AND 834.                   00310003
003200*    2. A JOIN OF TABLES TEPDKEY, TEPPART, TEPITM AND             00320003
003300*       TEPTRN TO GET LATE/CORRECTION SALES DATA.                 00330003
003400*                                                                 00340003
003500*  AS THE CURSOR IS PROCESSED, THE REPORT IS WRITTEN UNTIL END    00350003
003600*  OF CURSOR.                                                     00360003
003700*                                                                 00370003
003800******************************************************************00380003
003900 ENVIRONMENT DIVISION.                                            00390003
004000***************************************************************** 00400003
004100                                                                  00410003
004200 CONFIGURATION SECTION.                                           00420003
004300                                                                  00430003
004400 SOURCE-COMPUTER.        IBM-3090.                                00440003
004500 OBJECT-COMPUTER.        IBM-3090.                                00450003
004600                                                                  00460003
004700 INPUT-OUTPUT SECTION.                                            00470003
004800                                                                  00480003
004900 FILE-CONTROL.                                                    00490003
005000                                                                  00500003
005100     SELECT POS-DATE-CARD-FILE                                    00510003
005200         ASSIGN TO INP01.                                         00520003
005300                                                                  00530003
005400     SELECT MISSING-AUTH-RPT                                      00540003
005500         ASSIGN TO RPT01.                                         00550003
005600                                                                  00560003
005700                                                                  00570003
005800******************************************************************00580003
005900 DATA DIVISION.                                                   00590003
006000******************************************************************00600003
006100                                                                  00610003
006200 FILE SECTION.                                                    00620003
006300                                                                  00630003
006400 FD  POS-DATE-CARD-FILE                                           00640003
006500     RECORDING MODE IS F                                          00650003
006600     BLOCK CONTAINS 0 RECORDS                                     00660003
006700     LABEL RECORDS ARE STANDARD.                                  00670003
006800                                                                  00680003
006900 01  POS-DATE-CARD-RECORD            PIC X(80).                   00690003
007000                                                                  00700003
007100 FD  MISSING-AUTH-RPT                                             00710003
007200     RECORDING MODE IS F                                          00720003
007300     BLOCK CONTAINS 0  RECORDS.                                   00730003
007400                                                                  00740003
007500 01  MISSING-AUTH-RCD                PIC  X(132).                 00750012
007600                                                                  00760003
007700******************************************************************00770003
007800 WORKING-STORAGE SECTION.                                         00780003
007900******************************************************************00790003
008000 01  FILLER                            PIC X(50)  VALUE           00800003
008100     ' *** WORKING STORAGE STARTS HERE FOR AUKRP003 *** '.        00810003
008200                                                                  00820003
008300******************************************************************00830003
008400* RECORD LAYOUT FOR INPUT DATE CARD (POS DATE)                    00840003
008500******************************************************************00850003
008600 01  CC-CONTROL-CARD.                                             00860003
008700     05  CC-CONTROL-CARD-DISPLAY.                                 00870003
008800         10  CC-POS-DATE         PIC X(10)    VALUE SPACES.       00880003
008900     05  FILLER                  PIC X(70)    VALUE SPACE.        00890003
009000******************************************************************00900003
009100*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             00910003
009200******************************************************************00920003
009300     COPY DPWS500.                                                00930003
009400                                                                  00940003
009500 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      00950003
009600                                                  COMP SYNC.      00960003
009700     88  AC-CONTROL-CARD-ERROR                    VALUE +4003.    00970003
009800     88  AC-DB2-ERROR                             VALUE +4013.    00980003
009900     88  AC-CALENDAR-ROUTINE-ERROR                VALUE +4019.    00990003
010000                                                                  01000003
010100 01  PS-PROGRAM-SWITCHES.                                         01010003
010200     05  PS-END-OF-TRANS-CURSOR-SW     PIC X(01)  VALUE 'N'.      01020003
010300         88  PS-END-OF-TRANS-CURSOR               VALUE 'Y'.      01030003
010400     05  PS-END-OF-CARD-FILE-SW        PIC X(01)  VALUE 'N'.      01040003
010500         88  PS-END-OF-CARD-FILE                  VALUE 'Y'.      01050003
010600     05  PS-CARD-FOUND-SW              PIC X(01)  VALUE 'N'.      01060006
010700         88  PS-CARD-FOUND                        VALUE 'Y'.      01070006
010800         88  PS-CARD-NOT-FOUND                    VALUE 'N'.      01080006
010900     05  PS-AUTH-FOUND-SW              PIC X(01)  VALUE 'N'.      01090005
011000         88  PS-AUTH-FOUND                        VALUE 'Y'.      01100005
011100         88  PS-AUTH-NOT-FOUND                    VALUE 'N'.      01110005
011200                                                                  01120003
011300 01  PC-CONSTANTS.                                                01130003
011400     05  PC-LINE-LIMIT               PIC S9(04)    VALUE +66.     01140003
011500     05  PC-ROW-NOT-FOUND            PIC S9(04)    VALUE +100     01150003
011600                                                   COMP SYNC.     01160003
011700     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          01170003
011800                                                   'AUKRP003'.    01180003
011900     05  PC-REPORT-NBR-1             PIC  9(01)    VALUE 1.       01190003
012000                                                                  01200003
012100 01  PV-MISC-COUNT-FIELDS.                                        01210003
012200     05  PV-PAGE-CNT                 PIC S9(04)    VALUE ZERO     01220003
012300                                                   COMP-3.        01230003
012400     05  PV-LINE-CNT                 PIC S9(04)    VALUE +70      01240012
012500                                                   COMP SYNC.     01250003
012600 01  PV-MISC-FIELDS.                                              01260003
012700     05  PV-RETURN-CODE              PIC S9(08)    COMP-3         01270011
012800                                                   VALUE ZERO.    01280011
012900     05  PV-PRINT-RECORD             PIC X(132)    VALUE SPACE.   01290012
013000     05  PV-LINE-SPACING             PIC S9(04)    VALUE ZERO     01300003
013100                                                   COMP SYNC.     01310003
013200     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACE.   01320003
013300     05  PV-OPERATION-MSG-1          PIC  X(40)    VALUE SPACE.   01330003
013400     05  PV-OPERATION-MSG-2          PIC  X(40)    VALUE SPACE.   01340003
013500     05  PV-DB2-OPERATION            PIC  X(40)    VALUE SPACE.   01350003
013600                                                                  01360003
013700 01  PV-DATE-AND-TIME-FIELDS.                                     01370003
013800     05  PV-DB2-CCYY-MM-DD           PIC X(10)     VALUE SPACE.   01380003
013900     05  PV-POS-CCYY-MM-DD           PIC X(10)     VALUE SPACE.   01390003
014000     05  FILLER REDEFINES PV-POS-CCYY-MM-DD.                      01400003
014100         10  PV-POS-CCYY             PIC X(04).                   01410003
014200         10  FILLER                  PIC X(01).                   01420003
014300         10  PV-POS-MM               PIC X(02).                   01430003
014400         10  FILLER                  PIC X(01).                   01440003
014500         10  PV-POS-DD               PIC X(02).                   01450003
014600     05  PV-CURR-DATE-CCYYMMDD.                                   01460003
014700         10  PV-CURR-DATE-CCYY       PIC  9(04).                  01470003
014800         10  PV-CURR-DATE-MM         PIC  9(02).                  01480003
014900         10  PV-CURR-DATE-DD         PIC  9(02).                  01490003
015000     05  PV-CURR-TIME.                                            01500003
015100         10  PV-CURR-TIME-HH         PIC  9(02)    VALUE ZERO.    01510003
015200         10  PV-CURR-TIME-MM         PIC  9(02)    VALUE ZERO.    01520003
015300         10  PV-CURR-TIME-SSHH       PIC  9(04)    VALUE ZERO.    01530003
015400                                                                  01540003
015500******************************************************************01550003
015600*  TOP OF PAGE HEADING LINE FOR PRINTING A 132 CHARACTER REPORT.  01560012
015700******************************************************************01570003
015800     COPY DPWS132.                                                01580012
015900                                                                  01590003
016000******************************************************************01600003
016100*  HEADING FOR THE SECOND LINE OF THE REPORT.                     01610003
016200******************************************************************01620003
016300 01  H2-HEADING-LINE-2.                                           01630003
016400     05  FILLER                      PIC  X(14)    VALUE SPACE.   01640003
016500     05  FILLER                      PIC  X(39)    VALUE          01650004
016600        'BLACKHAWK AUTHORIZATION EXCEPTIONS FOR '.                01660004
016700     05  H2-DATE                     PIC  X(10).                  01670003
016800     05  FILLER                      PIC  X(12)    VALUE SPACE.   01680004
016900******************************************************************01690003
017000*  HEADING FOR THE TRANSACTION DATA ON THE REPORT.                01700003
017100******************************************************************01710003
017200 01  H3-HEADING-LINE-3.                                           01720003
017300     05  FILLER                      PIC  X(05)    VALUE SPACE.   01730003
017400     05  FILLER                      PIC  X(03)    VALUE 'UPC'.   01740003
017500     05  FILLER                      PIC  X(09)    VALUE SPACE.   01750003
017600     05  FILLER                      PIC  X(11)    VALUE          01760003
017700                                         'CARD NUMBER'.           01770003
017800     05  FILLER                      PIC  X(10)    VALUE SPACE.   01780003
017900     05  FILLER                      PIC  X(05)    VALUE 'PRICE'. 01790003
018000     05  FILLER                      PIC  X(03)    VALUE SPACE.   01800003
018100     05  FILLER                      PIC  X(10)    VALUE          01810003
018200                                         'SALES DATE'.            01820003
018300     05  FILLER                      PIC  X(02)    VALUE SPACE.   01830003
018400     05  FILLER                      PIC  X(05)    VALUE 'STORE'. 01840003
018500     05  FILLER                      PIC  X(02)    VALUE SPACE.   01850003
018600     05  FILLER                      PIC  X(04)    VALUE 'RGST'.  01860003
018700     05  FILLER                      PIC  X(02)    VALUE SPACE.   01870003
018800     05  FILLER                      PIC  X(04)    VALUE 'TRAN'.  01880003
018900     05  FILLER                      PIC  X(02)    VALUE SPACE.   01890012
019000     05  FILLER                      PIC  X(55)    VALUE          01900012
019100                                         'MESSAGE'.               01910012
019200******************************************************************01920003
019300*  DETAIL LINES                                                   01930003
019400******************************************************************01940003
019500 01  D1-DETAIL-LINE-1.                                            01950003
019600     05  FILLER                      PIC  X(01)    VALUE SPACE.   01960003
019700     05  D1-UPC                      PIC  Z(13).                  01970003
019800     05  FILLER                      PIC  X(02)    VALUE SPACE.   01980003
019900     05  D1-CARD-NBR                 PIC  X(19).                  01990003
020000     05  FILLER                      PIC  X(02)    VALUE SPACE.   02000003
020100     05  D1-PRICE                    PIC  Z99.99-.                02010003
020200     05  FILLER                      PIC  X(02)    VALUE SPACE.   02020003
020300     05  D1-SLS-DTE                  PIC  X(10).                  02030003
020400     05  FILLER                      PIC  X(02)    VALUE SPACE.   02040003
020500     05  D1-STORE                    PIC  ZZZZ.                   02050003
020600     05  FILLER                      PIC  X(03)    VALUE SPACE.   02060003
020700     05  D1-RGST                     PIC  ZZZZ.                   02070003
020800     05  FILLER                      PIC  X(02)    VALUE SPACE.   02080003
020900     05  D1-TRAN                     PIC  ZZZZ.                   02090003
021000     05  FILLER                      PIC  X(02)    VALUE SPACE.   02100012
021100     05  D1-MESSAGE                  PIC  X(55).                  02110012
021200                                                                  02120004
021300******************************************************************02130003
021400*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            02140003
021500******************************************************************02150003
021600     COPY DPWS004.                                                02160003
021700                                                                  02170003
021800******************************************************************02180003
021900*  DB2 COMMUNICATION AREA.                                        02190003
022000******************************************************************02200003
022100     EXEC SQL                                                     02210003
022200          INCLUDE SQLCA                                           02220003
022300     END-EXEC.                                                    02230003
022400******************************************************************02240003
022500*  DB2 TABLE TEPPART - COSA-PARTITIONING TABLE                    02250004
022600******************************************************************02260003
022700     EXEC SQL                                                     02270003
022800          INCLUDE TEPPART                                         02280003
022900     END-EXEC.                                                    02290003
023000******************************************************************02300003
023100*  DB2 TABLE TEPDKEY - COSA-PROCESSING DAY KEY TABLE              02310004
023200******************************************************************02320003
023300     EXEC SQL                                                     02330003
023400          INCLUDE TEPDKEY                                         02340003
023500     END-EXEC.                                                    02350003
023600******************************************************************02360003
023700*  DB2 TABLE TEPTRN - COSA-TRANSACTION TABLE                      02370004
023800******************************************************************02380003
023900     EXEC SQL                                                     02390003
024000          INCLUDE TEPTRN                                          02400003
024100     END-EXEC.                                                    02410003
024200******************************************************************02420003
024300*  DB2 TABLE TEPITM - COSA-ITEM TABLE                             02430004
024400******************************************************************02440003
024500     EXEC SQL                                                     02450003
024600          INCLUDE TEPITM                                          02460003
024700     END-EXEC.                                                    02470003
024800******************************************************************02480004
024900*  DB2 TABLE EPT-3RDPTY-GFTCRD                                    02490004
025000******************************************************************02500004
025100     EXEC SQL                                                     02510004
025200          INCLUDE EPT00053                                        02520004
025300     END-EXEC.                                                    02530004
025400******************************************************************02540003
025500*  DB2 TABLE GCT_GFT_CRD_TRN                                      02550005
025600******************************************************************02560003
025700     EXEC SQL                                                     02570003
025800          INCLUDE GCT00002                                        02580005
025900     END-EXEC.                                                    02590003
026000******************************************************************02600003
026100*  TRANSACTION CURSOR                                             02610003
026200******************************************************************02620003
026300     EXEC SQL                                                     02630003
026400       DECLARE TRANSACTION-CURSOR CURSOR FOR                      02640003
026500            SELECT  E.PARTN_NBR                                   02650005
026600                   ,E.SLS_DTE                                     02660015
026700                   ,E.STR_NBR                                     02670005
026800                   ,E.RGST_ID                                     02680005
026900                   ,E.TRN_NBR                                     02690005
027000                   ,E.STRT_TM                                     02700005
027100                   ,E.SLS_CORR_SEQ_NBR                            02710005
027200                   ,B.LNE_ITM_SEQ_NBR                             02720004
027300                   ,E.VOID_ABRT_CDE                               02730004
027400                   ,B.LIV_RSLU_CDE                                02740004
027500                   ,B.UPC_NBR                                     02750005
027600                   ,B.CUST_CHRGD_AMT                              02760005
027700            FROM  TEPITM B                                        02770003
027800                 ,TEPPART D                                       02780003
027900                 ,TEPTRN E                                        02790003
028000            WHERE   E.PARTN_NBR        = B.PARTN_NBR              02800004
028100              AND   E.STR_NBR          = B.STR_NBR                02810003
028200              AND   E.RGST_ID          = B.RGST_ID                02820003
028300              AND   E.TRN_NBR          = B.TRN_NBR                02830003
028400              AND   E.STRT_TM          = B.STRT_TM                02840003
028500              AND   E.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR       02850003
028600              AND   B.PARTN_NBR        = D.PARTN_NBR              02860003
028700              AND   D.SLS_DTE          = :PV-POS-CCYY-MM-DD       02870003
028800              AND   D.DB_STRUC_CDE     = 'O'                      02880003
028900              AND   D.STR_GP_CDE       = 'A'                      02890017
029000              AND   E.TRN_TYP_CDE      IN ('01','02')             02900014
029100              AND   B.DEPT_NBR        IN ('833','834')            02910008
029200         UNION ALL                                                02920003
029300            SELECT  E.PARTN_NBR                                   02930005
029400                   ,E.SLS_DTE                                     02940015
029500                   ,E.STR_NBR                                     02950005
029600                   ,E.RGST_ID                                     02960005
029700                   ,E.TRN_NBR                                     02970005
029800                   ,E.STRT_TM                                     02980005
029900                   ,E.SLS_CORR_SEQ_NBR                            02990005
030000                   ,B.LNE_ITM_SEQ_NBR                             03000005
030100                   ,E.VOID_ABRT_CDE                               03010005
030200                   ,B.LIV_RSLU_CDE                                03020005
030300                   ,B.UPC_NBR                                     03030005
030400                   ,B.CUST_CHRGD_AMT                              03040005
030500            FROM  TEPDKEY A                                       03050003
030600                 ,TEPITM B                                        03060004
030700                 ,TEPPART D                                       03070003
030800                 ,TEPTRN E                                        03080003
030900            WHERE   A.SLS_DTE          = D.SLS_DTE                03090004
031000              AND   A.STR_NBR          = B.STR_NBR                03100003
031100              AND   A.RGST_ID          = B.RGST_ID                03110003
031200              AND   A.TRN_NBR          = B.TRN_NBR                03120003
031300              AND   A.STRT_TM          = B.STRT_TM                03130003
031400              AND   A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR       03140003
031500              AND   E.PARTN_NBR        = B.PARTN_NBR              03150003
031600              AND   E.STR_NBR          = B.STR_NBR                03160003
031700              AND   E.RGST_ID          = B.RGST_ID                03170003
031800              AND   E.TRN_NBR          = B.TRN_NBR                03180003
031900              AND   E.STRT_TM          = B.STRT_TM                03190003
032000              AND   E.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR       03200003
032100              AND   B.PARTN_NBR        = D.PARTN_NBR              03210003
032200              AND   A.PRCG_DTE         = :EPDKEY-PRCG-DTE         03220004
032300              AND   D.DB_STRUC_CDE     = 'O'                      03230004
032400              AND   D.STR_GP_CDE       = 'A'                      03240017
032500              AND   E.TRN_TYP_CDE      IN ('01','02')             03250014
032600              AND   B.DEPT_NBR        IN ('833','834')            03260008
032700              WITH UR                                             03270003
032800     END-EXEC.                                                    03280003
032900                                                                  03290003
033000***************************************************************** 03300003
033100* PROCEDURE DIVISION.                                           * 03310003
033200***************************************************************** 03320003
033300 PROCEDURE DIVISION.                                              03330003
033400                                                                  03340003
033500******************************************************************03350003
033600* 0000-MAINLINE-PARAGRAPH                                         03360003
033700*      PRODUCE BLACKHAWK AUTHORIZATION EXCEPTION REPORT           03370004
033800******************************************************************03380003
033900 0000-MAINLINE-PARAGRAPH.                                         03390003
034000                                                                  03400003
034100     PERFORM 1000-INITIALIZE-PROGRAM.                             03410003
034200     PERFORM 2000-PRODUCE-REPORT-LINES                            03420003
034300       UNTIL PS-END-OF-TRANS-CURSOR.                              03430003
034400     PERFORM 3000-CLOSE-FILES.                                    03440003
034500                                                                  03450003
034600     MOVE PV-RETURN-CODE TO RETURN-CODE.                          03460011
034700                                                                  03470011
034800     STOP RUN.                                                    03480003
034900                                                                  03490003
035000******************************************************************03500003
035100* 1000-INITIALIZE-PROGRAM                                         03510003
035200*     OPEN FILES, PROCESS CONTROL CARD, FORMAT REPORT HEADINGS,   03520003
035300*     OPEN TRANSACTION-CURSOR, ATTEMPT FIRST FETCH OF CURSOR.     03530003
035400******************************************************************03540003
035500 1000-INITIALIZE-PROGRAM.                                         03550003
035600                                                                  03560003
035700     OPEN INPUT  POS-DATE-CARD-FILE                               03570003
035800          OUTPUT MISSING-AUTH-RPT.                                03580003
035900                                                                  03590003
036000     PERFORM 1100-PROCESS-CONTROL-CARD.                           03600003
036100     PERFORM 1200-FORMAT-HEADINGS.                                03610003
036200     PERFORM 1400-PREPARE-FOR-REPORT.                             03620003
036300                                                                  03630003
036400******************************************************************03640003
036500* 1100-PROCESS-CONTROL-CARD                                       03650003
036600*     READ CONTROL CARD TO GET POS DATE IN MMDDYY FORMAT.  CALL   03660003
036700*     DATE ROUTINE TO CONVERT DATE TO A CCYY-MM-DD PROCESS DATE.  03670003
036800******************************************************************03680003
036900 1100-PROCESS-CONTROL-CARD.                                       03690003
037000                                                                  03700003
037100     PERFORM 1110-READ-POS-DATE-CARD-FILE.                        03710003
037200     CLOSE POS-DATE-CARD-FILE.                                    03720003
037300     IF PS-END-OF-CARD-FILE                                       03730003
037400         MOVE '1100-PROCESS-CONTROL-CARD'  TO PV-PARAGRAPH-NAME   03740003
037500         MOVE 'NO CONTROL CARD TO PROCESS' TO PV-OPERATION-MSG-1  03750003
037600         SET AC-CONTROL-CARD-ERROR TO TRUE                        03760003
037700         PERFORM 9999-ABEND                                       03770003
037800     END-IF.                                                      03780003
037900     DISPLAY PC-CURRENT-PROGRAM-NAME                              03790003
038000             ' - CONTROL CARD = (' CC-CONTROL-CARD-DISPLAY  ')'.  03800003
038100     PERFORM 1115-VALIDATE-INPUT-DATE.                            03810003
038200                                                                  03820003
038300******************************************************************03830003
038400* 1110-READ-POS-DATE-CARD-FILE                                    03840003
038500*     READ DATE CONTROL CARD.                                     03850003
038600******************************************************************03860003
038700 1110-READ-POS-DATE-CARD-FILE.                                    03870003
038800                                                                  03880003
038900     READ POS-DATE-CARD-FILE INTO CC-CONTROL-CARD                 03890003
039000        AT END                                                    03900003
039100           SET PS-END-OF-CARD-FILE TO TRUE.                       03910003
039200                                                                  03920003
039300******************************************************************03930003
039400* 1115-VALIDATE-INPUT-DATE                                        03940003
039500*     CALL KOHLS CALENDAR ROUTINE:                                03950003
039600*       RETURN: ACTUAL CALENDAR DB2 ISO DATE (CCYY-MM-DD FORMAT). 03960003
039700******************************************************************03970003
039800 1115-VALIDATE-INPUT-DATE.                                        03980003
039900                                                                  03990003
040000     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              04000003
040100                                                                  04010003
040200     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   04020003
040300     SET  DPG52-LK-DTE-ISO-FMT         TO TRUE.                   04030003
040400     MOVE CC-POS-DATE                  TO DPG52-LK-DATE-INPUT.    04040003
040500     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    04050003
040600                                             DPG54 DPG55 DPG56.   04060003
040700     EVALUATE TRUE                                                04070003
040800         WHEN DPG54-SEVERE-ERROR                                  04080003
040900         WHEN DPG54-DATE-INVALID                                  04090003
041000             MOVE '1115-VALIDATE-INPUT-DATE'                      04100003
041100                                           TO PV-PARAGRAPH-NAME   04110003
041200             MOVE 'ERROR CONVERTING INPUT CARD DATE'              04120003
041300                                           TO PV-OPERATION-MSG-1  04130003
041400             SET AC-CALENDAR-ROUTINE-ERROR TO TRUE                04140003
041500             MOVE DPG54-ERROR-MESSAGE      TO PV-OPERATION-MSG-2  04150003
041600             PERFORM 9999-ABEND                                   04160003
041700     END-EVALUATE.                                                04170003
041800                                                                  04180003
041900     MOVE DPG55-DB2-ISO-DATE-FMT       TO PV-POS-CCYY-MM-DD       04190003
042000                                          EPDKEY-PRCG-DTE         04200004
042100                                          H2-DATE.                04210004
042200                                                                  04220003
042300******************************************************************04230003
042400* 1200-FORMAT-HEADINGS                                            04240003
042500*     GET CURRENT DATE AND TIME FROM SYSTEM.                      04250003
042600*     FORMAT REPORT FIELDS IN THE TOP PAGE HEADING LINE.          04260003
042700*     FORMAT HEADING LINE 2 WITH CONVERTED POS DATE.              04270003
042800******************************************************************04280003
042900 1200-FORMAT-HEADINGS.                                            04290003
043000                                                                  04300003
043100     MOVE FUNCTION CURRENT-DATE (1:8) TO PV-CURR-DATE-CCYYMMDD.   04310003
043200     ACCEPT PV-CURR-TIME FROM TIME.                               04320003
043300                                                                  04330003
043400     MOVE PV-CURR-DATE-MM             TO DP132-RUN-MONTH.         04340012
043500     MOVE PV-CURR-DATE-DD             TO DP132-RUN-DAY.           04350012
043600     MOVE PV-CURR-DATE-CCYY           TO DP132-RUN-YEAR.          04360012
043700                                                                  04370003
043800     MOVE PV-CURR-TIME-HH             TO DP132-RUN-HOUR.          04380012
043900     MOVE PV-CURR-TIME-MM             TO DP132-RUN-MINUTE.        04390012
044000     MOVE PC-CURRENT-PROGRAM-NAME     TO DP132-PROGRAM-NAME.      04400012
044100     MOVE PC-REPORT-NBR-1             TO DP132-REPORT-NUMBER.     04410012
044200                                                                  04420003
044300******************************************************************04430003
044400* 1400-PREPARE-FOR-REPORT.                                        04440003
044500*   DO FIRST FETCH OF CURSOR.                                     04450003
044600*   NOTE: IF CURSOR DATA NOT PRESENT, NO REPORT WILL BE PRODUCED. 04460003
044700******************************************************************04470003
044800 1400-PREPARE-FOR-REPORT.                                         04480003
044900                                                                  04490003
045000     MOVE 4095 TO PV-RETURN-CODE.                                 04500011
045100                                                                  04510011
045200     PERFORM 7000-OPEN-TRANSACTION-CURSOR.                        04520003
045300     PERFORM 7010-FETCH-TRANSACTION-CURSOR.                       04530003
045400     IF PS-END-OF-TRANS-CURSOR                                    04540003
045500         DISPLAY '*** NO BLACKHAWK SALES FOR '                    04550004
045600                 'PROCESS DATE '  PV-POS-CCYY-MM-DD    ' ***'     04560003
045700     END-IF.                                                      04570003
045800                                                                  04580003
045900******************************************************************04590003
046000* 2000-PRODUCE-REPORT-LINES                                       04600003
046100*     PROCESS TRANSACTION-CURSOR DATA                             04610003
046200******************************************************************04620003
046300 2000-PRODUCE-REPORT-LINES.                                       04630003
046400                                                                  04640003
046500     IF EPTRN-VOID-ABRT-CDE = 'N' AND EPITM-LIV-RSLU-CDE = '+'    04650005
046600         PERFORM 4000-CHECK-FOR-GIFT-CARD                         04660005
046700         IF PS-CARD-FOUND                                         04670006
046800             PERFORM 4100-CHECK-FOR-AUTH                          04680005
046900             IF PS-AUTH-FOUND                                     04690005
047000                 CONTINUE                                         04700005
047100             ELSE                                                 04710005
047200                 MOVE 'AUTH MISSING'              TO D1-MESSAGE   04720012
047300                 PERFORM 4300-PRINT-RPT-LINE                      04730005
047400             END-IF                                               04740005
047500         ELSE                                                     04750005
047600             MOVE 'CARD NUMBER MISSING FROM COSA' TO D1-MESSAGE   04760012
047700             PERFORM 4300-PRINT-RPT-LINE                          04770005
047800         END-IF                                                   04780005
047900     ELSE                                                         04790005
048000         PERFORM 4100-CHECK-FOR-AUTH                              04800005
048100         IF PS-AUTH-FOUND                                         04810005
048200             MOVE 'VOIDED TRANSACTION AUTHORIZED' TO D1-MESSAGE   04820012
048300             PERFORM 4300-PRINT-RPT-LINE                          04830005
048400         END-IF                                                   04840005
048500     END-IF.                                                      04850005
048600                                                                  04860005
048700     IF PS-CARD-FOUND AND PS-AUTH-FOUND                           04870006
048800         IF EPT00053-CRD-ACCT-NBR = GCT00002-CRD-ACCT-NBR         04880005
048900             CONTINUE                                             04890005
049000         ELSE                                                     04900005
049100             MOVE 'NO MATCH ON CARD NUMBER'       TO D1-MESSAGE   04910012
049200             PERFORM 4300-PRINT-RPT-LINE                          04920005
049300         END-IF                                                   04930005
049400     END-IF.                                                      04940005
049500                                                                  04950005
049600     PERFORM 7010-FETCH-TRANSACTION-CURSOR.                       04960003
049700                                                                  04970003
049800******************************************************************04980003
049900* 3000-CLOSE-FILES                                                04990005
050000*     CLOSE TRANSACTION-CURSOR,                                   05000003
050100*     CLOSE REPORT FILE.                                          05010003
050200******************************************************************05020003
050300 3000-CLOSE-FILES.                                                05030003
050400                                                                  05040003
050500     PERFORM 7020-CLOSE-TRANSACTION-CURSOR.                       05050003
050600                                                                  05060003
050700     CLOSE MISSING-AUTH-RPT.                                      05070003
050800                                                                  05080003
050900******************************************************************05090003
051000* 4000-CHECK-FOR-GIFT-CARD                                        05100005
051100*     CHECK FOR THE CARD NUMBER ON EPT_3RDPTY_GFTCRD              05110005
051200******************************************************************05120003
051300 4000-CHECK-FOR-GIFT-CARD.                                        05130005
051400                                                                  05140005
051500     EXEC SQL                                                     05150005
051600          SELECT CRD_ACCT_NBR                                     05160005
051700            INTO :EPT00053-CRD-ACCT-NBR                           05170005
051800            FROM EPT_3RDPTY_GFTCRD                                05180005
051900           WHERE PARTN_NBR        = :EPTRN-PARTN-NBR              05190005
052000             AND STR_NBR          = :EPTRN-STR-NBR                05200005
052100             AND RGST_ID          = :EPTRN-RGST-ID                05210005
052200             AND TRN_NBR          = :EPTRN-TRN-NBR                05220005
052300             AND STRT_TM          = :EPTRN-STRT-TM                05230005
052400             AND SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR       05240005
052500             AND LNE_ITM_SEQ_NBR  = :EPITM-LNE-ITM-SEQ-NBR        05250005
052600           WITH UR                                                05260005
052700     END-EXEC.                                                    05270005
052800                                                                  05280005
052900     EVALUATE TRUE                                                05290005
053000         WHEN SQLCODE = ZERO                                      05300005
053100             SET PS-CARD-FOUND TO TRUE                            05310005
053200         WHEN SQLCODE = PC-ROW-NOT-FOUND                          05320005
053300             SET PS-CARD-NOT-FOUND TO TRUE                        05330005
053400         WHEN SQLWARN0 NOT EQUAL SPACE                            05340005
053500         WHEN SQLCODE NOT EQUAL ZERO                              05350005
053600             MOVE '4000-CHECK-FOR-GIFT-CARD'                      05360005
053700                                            TO PV-PARAGRAPH-NAME  05370005
053800             MOVE 'ERROR ON SELECT EPT_3RDPTY_GFTCRD'             05380005
053900                                            TO PV-DB2-OPERATION   05390005
054000             PERFORM 9100-SQL-ABEND                               05400005
054100     END-EVALUATE.                                                05410005
054200                                                                  05420003
054300******************************************************************05430003
054400* 4100-CHECK-FOR-AUTH                                             05440005
054500*     CHECK FOR THE AUTHORIZATION ON GCT_GFT_CRD_TRN              05450005
054600******************************************************************05460003
054700 4100-CHECK-FOR-AUTH.                                             05470005
054800                                                                  05480003
054900     EXEC SQL                                                     05490005
055000          SELECT CRD_ACCT_NBR                                     05500005
055100            INTO :GCT00002-CRD-ACCT-NBR                           05510005
055200            FROM GCT_GFT_CRD_TRN                                  05520005
055300           WHERE SLS_DTE          = :EPTRN-SLS-DTE                05530015
055400             AND STR_NBR          = :EPTRN-STR-NBR                05540005
055500             AND RGST_ID          = :EPTRN-RGST-ID                05550005
055600             AND TRN_NBR          = :EPTRN-TRN-NBR                05560005
055700             AND STRT_TM          = :EPTRN-STRT-TM                05570005
055800             AND LNE_ITM_SEQ_NBR  = :EPITM-LNE-ITM-SEQ-NBR        05580005
055900           WITH UR                                                05590005
056000     END-EXEC.                                                    05600005
056100                                                                  05610005
056200     EVALUATE TRUE                                                05620005
056300         WHEN SQLCODE = ZERO                                      05630005
056400             SET PS-AUTH-FOUND TO TRUE                            05640005
056500         WHEN SQLCODE = PC-ROW-NOT-FOUND                          05650005
056600             SET PS-AUTH-NOT-FOUND TO TRUE                        05660005
056700         WHEN SQLWARN0 NOT EQUAL SPACE                            05670005
056800         WHEN SQLCODE NOT EQUAL ZERO                              05680005
056900             MOVE '4100-CHECK-FOR-AUTH'                           05690005
057000                                            TO PV-PARAGRAPH-NAME  05700005
057100             MOVE 'ERROR ON SELECT GCT_GFT_CRD_TRN'               05710005
057200                                            TO PV-DB2-OPERATION   05720005
057300             PERFORM 9100-SQL-ABEND                               05730005
057400     END-EVALUATE.                                                05740005
057500                                                                  05750003
057600******************************************************************05760003
057700* 4300-PRINT-RPT-LINE                                             05770005
057800*     PRINT THE REPORT                                            05780005
057900******************************************************************05790003
058000 4300-PRINT-RPT-LINE.                                             05800005
058100                                                                  05810003
058200     MOVE ZERO TO PV-RETURN-CODE.                                 05820011
058300                                                                  05830011
058400     IF PV-LINE-CNT > PC-LINE-LIMIT                               05840006
058500         PERFORM 8000-PRINT-HEADINGS                              05850003
058600     END-IF.                                                      05860003
058700                                                                  05870003
058800     MOVE EPITM-UPC-NBR    TO  D1-UPC.                            05880009
058900     IF PS-CARD-FOUND                                             05890009
059000         MOVE EPT00053-CRD-ACCT-NBR TO D1-CARD-NBR                05900010
059100     ELSE                                                         05910009
059200         MOVE SPACES                TO D1-CARD-NBR                05920010
059300     END-IF.                                                      05930009
059400     MOVE EPITM-CUST-CHRGD-AMT      TO D1-PRICE.                  05940009
059500     MOVE EPTRN-SLS-DTE             TO D1-SLS-DTE.                05950015
059600     MOVE EPTRN-STR-NBR             TO D1-STORE.                  05960010
059700     MOVE EPTRN-RGST-ID             TO D1-RGST.                   05970009
059800     MOVE EPTRN-TRN-NBR             TO D1-TRAN.                   05980009
059900                                                                  05990009
060000     MOVE D1-DETAIL-LINE-1 TO  PV-PRINT-RECORD.                   06000005
060100     MOVE +2               TO  PV-LINE-SPACING.                   06010003
060200     PERFORM 8200-WRITE-REPORT-LINE.                              06020003
060300                                                                  06030003
060400******************************************************************06040003
060500* 7000-OPEN-TRANSACTION-CURSOR                                    06050003
060600******************************************************************06060003
060700 7000-OPEN-TRANSACTION-CURSOR.                                    06070003
060800                                                                  06080003
060900     EXEC SQL                                                     06090003
061000          OPEN TRANSACTION-CURSOR                                 06100003
061100     END-EXEC.                                                    06110003
061200                                                                  06120003
061300     EVALUATE TRUE                                                06130003
061400         WHEN SQLCODE = ZERO                                      06140003
061500              CONTINUE                                            06150003
061600         WHEN SQLWARN0 NOT EQUAL SPACE                            06160003
061700         WHEN SQLCODE NOT EQUAL ZERO                              06170003
061800             MOVE '7000-OPEN-TRANSACTION-CURSOR'                  06180003
061900                                            TO PV-PARAGRAPH-NAME  06190003
062000             MOVE 'ERROR ON OPEN OF TRANSACTION-CURSOR'           06200003
062100                                            TO PV-DB2-OPERATION   06210003
062200             PERFORM 9100-SQL-ABEND                               06220003
062300     END-EVALUATE.                                                06230003
062400                                                                  06240003
062500******************************************************************06250003
062600* 7010-FETCH-TRANSACTION-CURSOR                                   06260003
062700******************************************************************06270003
062800 7010-FETCH-TRANSACTION-CURSOR.                                   06280003
062900                                                                  06290003
063000     EXEC SQL                                                     06300003
063100          FETCH TRANSACTION-CURSOR                                06310003
063200           INTO :EPTRN-PARTN-NBR                                  06320005
063300               ,:EPTRN-SLS-DTE                                    06330015
063400               ,:EPTRN-STR-NBR                                    06340005
063500               ,:EPTRN-RGST-ID                                    06350005
063600               ,:EPTRN-TRN-NBR                                    06360005
063700               ,:EPTRN-STRT-TM                                    06370005
063800               ,:EPTRN-SLS-CORR-SEQ-NBR                           06380005
063900               ,:EPITM-LNE-ITM-SEQ-NBR                            06390005
064000               ,:EPTRN-VOID-ABRT-CDE                              06400005
064100               ,:EPITM-LIV-RSLU-CDE                               06410005
064200               ,:EPITM-UPC-NBR                                    06420005
064300               ,:EPITM-CUST-CHRGD-AMT                             06430005
064400     END-EXEC.                                                    06440003
064500                                                                  06450003
064600     EVALUATE TRUE                                                06460003
064700         WHEN SQLCODE = ZERO                                      06470003
064800             CONTINUE                                             06480003
064900         WHEN SQLCODE = PC-ROW-NOT-FOUND                          06490003
065000             SET PS-END-OF-TRANS-CURSOR TO TRUE                   06500003
065100         WHEN SQLWARN0 NOT EQUAL SPACE                            06510003
065200         WHEN SQLCODE NOT EQUAL ZERO                              06520003
065300             MOVE '7010-FETCH-TRANSACTION-CURSOR'                 06530003
065400                                            TO PV-PARAGRAPH-NAME  06540003
065500             MOVE 'ERROR ON FETCH OF TRANSACTION-CURSOR'          06550003
065600                                            TO PV-DB2-OPERATION   06560003
065700             PERFORM 9100-SQL-ABEND                               06570003
065800     END-EVALUATE.                                                06580003
065900                                                                  06590003
066000******************************************************************06600003
066100* 7020-CLOSE-TRANSACTION-CURSOR                                   06610003
066200******************************************************************06620003
066300 7020-CLOSE-TRANSACTION-CURSOR.                                   06630003
066400                                                                  06640003
066500     EXEC SQL                                                     06650003
066600          CLOSE TRANSACTION-CURSOR                                06660003
066700     END-EXEC.                                                    06670003
066800                                                                  06680003
066900     EVALUATE TRUE                                                06690003
067000         WHEN SQLCODE = ZERO                                      06700003
067100              CONTINUE                                            06710003
067200         WHEN SQLWARN0 NOT EQUAL SPACE                            06720003
067300         WHEN SQLCODE NOT EQUAL ZERO                              06730003
067400             MOVE '7020-CLOSE-TRANSACTION-CURSOR'                 06740003
067500                                            TO PV-PARAGRAPH-NAME  06750003
067600             MOVE 'ERROR ON CLOSE OF TRANSACTION-CURSOR'          06760003
067700                                            TO PV-DB2-OPERATION   06770003
067800             PERFORM 9100-SQL-ABEND                               06780003
067900     END-EVALUATE.                                                06790003
068000                                                                  06800003
068100******************************************************************06810003
068200* 8000-PRINT-HEADINGS                                             06820003
068300*     PRINT THE HEADINGS FOR THE REPORT.                          06830003
068400******************************************************************06840003
068500 8000-PRINT-HEADINGS.                                             06850003
068600                                                                  06860003
068700     ADD +1                      TO PV-PAGE-CNT.                  06870003
068800     MOVE PV-PAGE-CNT TO DP132-PAGE-NUMBER.                       06880012
068900     MOVE DP132-STANDRD-HEADER-132-COLS                           06890012
069000                                 TO PV-PRINT-RECORD.              06900003
069100     PERFORM 8100-WRITE-RPT-TOP-OF-PAGE.                          06910003
069200                                                                  06920003
069300     MOVE H2-HEADING-LINE-2      TO PV-PRINT-RECORD.              06930003
069400     MOVE +1                     TO PV-LINE-SPACING.              06940003
069500     PERFORM 8200-WRITE-REPORT-LINE.                              06950003
069600                                                                  06960003
069700     MOVE H3-HEADING-LINE-3      TO PV-PRINT-RECORD.              06970013
069800     MOVE +2                     TO PV-LINE-SPACING.              06980013
069900     PERFORM 8200-WRITE-REPORT-LINE.                              06990013
070000                                                                  07000013
070100******************************************************************07010003
070200* 8100-WRITE-RPT-TOP-OF-PAGE                                      07020003
070300*     WRITE FIRST REPORT LINE AFTER PAGE BREAK.                   07030003
070400******************************************************************07040003
070500 8100-WRITE-RPT-TOP-OF-PAGE.                                      07050003
070600                                                                  07060003
070700     WRITE MISSING-AUTH-RCD                                       07070003
070800       FROM PV-PRINT-RECORD                                       07080003
070900         AFTER ADVANCING PAGE.                                    07090003
071000     MOVE +1             TO PV-LINE-CNT.                          07100003
071100                                                                  07110003
071200******************************************************************07120003
071300* 8200-WRITE-REPORT-LINE                                          07130003
071400*     WRITE REPORT LINE AFTER ADVANCING LINE SPACING.             07140003
071500******************************************************************07150003
071600 8200-WRITE-REPORT-LINE.                                          07160003
071700                                                                  07170003
071800     WRITE MISSING-AUTH-RCD                                       07180003
071900       FROM PV-PRINT-RECORD                                       07190003
072000         AFTER ADVANCING PV-LINE-SPACING.                         07200003
072100                                                                  07210003
072200     ADD PV-LINE-SPACING TO PV-LINE-CNT.                          07220003
072300                                                                  07230003
072400******************************************************************07240003
072500* 9100-SQL-ABEND                                                  07250003
072600*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.07260003
072700******************************************************************07270003
072800 9100-SQL-ABEND.                                                  07280003
072900                                                                  07290003
073000     DISPLAY '** ABEND     **'.                                   07300003
073100     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        07310003
073200     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              07320003
073300     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               07330003
073400                                                                  07340003
073500******************************************************************07350003
073600* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     07360003
073700* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      07370003
073800******************************************************************07380003
073900     COPY DPPD004.                                                07390003
074000                                                                  07400003
074100     SET AC-DB2-ERROR TO TRUE.                                    07410003
074200     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         07420003
074300                                                                  07430003
074400******************************************************************07440003
074500* 9999-ABEND                                                      07450003
074600*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  07460003
074700******************************************************************07470003
074800 9999-ABEND.                                                      07480003
074900                                                                  07490003
075000     DISPLAY '** ABEND           **'.                             07500003
075100     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  07510003
075200     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        07520003
075300     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       07530003
075400     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       07540003
075500     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         07550003
