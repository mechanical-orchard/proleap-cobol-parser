000100 IDENTIFICATION DIVISION.                                         00010014
000200 PROGRAM-ID.         AHKUP036.                                    00020014
000300 AUTHOR.             NANCY EILBES.                                00030014
000400 DATE-WRITTEN.       APRIL 2000.                                  00040014
000500 DATE-COMPILED.                                                   00050014
000600*************************************************************     00060014
000700*    COBOL 2 WITH SQL                                       *     00070014
000800*                                                           *     00080014
000900*   AHKUP036 - ARCHIVE HISTORY DATA DELETION - TPOAGMT      *     00090014
001000*                                                           *     00100014
001100*   PROGRAM OVERVIEW:                                       *     00110014
001200*                                                           *     00120014
001300*  THIS PROGRAM DELETES "OLD" ROWS FROM DB2 TABLE TPOAGMT.  *     00130014
001400*  ROWS DELETED ARE THOSE PREVIOUSLY - IDENTIFIED/EXTRACTED *     00140014
001500*  WITHIN THE ARCHIVE/HISTORY SYSTEM.                       *     00150014
001600*                                                           *     00160014
001700*  THE EXTRACT FILE USED AS INPUT WILL BE SORTED BY THE     *     00170014
001800*  UNIQUE INDEX COLUMNS TO SPEED THE DELETION PROCESS.      *     00180014
001900*  THESE COLUMNS ARE PO_NBR, VER_NBR, AGMT_TYP_ID, SEQ_NBR. *     00190014
002000*                                                           *     00200014
002100*   INPUT:                                                  *     00210014
002200*                                                           *     00220014
002300*     1. TPOAGMT DELETION FILE  COPYBOOK DCLTPOAGMT         *     00230014
002400*                                                           *     00240014
002500*   DB2 TABLES:                                             *     00250014
002600*                                                           *     00260014
002700*        TPOAGMT - PURCHASE ORDER AGREEMENT TABLE           *     00270014
002800*        TCKRSTIN - CHECKPOINT/RESTART INFO TABLE           *     00280014
002900*        TCKRSTCN - CHECKPOINT/RESTART CONTROL TABLE        *     00290014
003000*                                                           *     00300014
003100*************************************************************     00310014
P5207 * DATE: 11/18/2013 CHANGE MADE BY: COGNIZANT(SHEBENA)       *     00320123
P5207 * CHANGE MADE: MODIFIED THE PROGRAM TO REMOVE THE           *     00320223
P5207 *              PO_IN_RMS_IND CHECK BEFORE DELETE.           *     00320323
P5207 * CHANGE TAG - P5207, CR NO - CHG0081355                    *     00320424
P5207 *************************************************************     00330021
003400 EJECT                                                            00340014
003500 ENVIRONMENT DIVISION.                                            00350014
003600 CONFIGURATION SECTION.                                           00360014
003700 SOURCE-COMPUTER.        IBM-370.                                 00370014
003800 OBJECT-COMPUTER.        IBM-370.                                 00380014
003900                                                                  00390014
004000 INPUT-OUTPUT SECTION.                                            00400014
004100 FILE-CONTROL.                                                    00410014
004200     SELECT TPOAGMT-EXTRACT-FILE ASSIGN TO INP01.                 00420014
004300                                                                  00430014
004400 DATA DIVISION.                                                   00440014
004500 FILE SECTION.                                                    00450014
004600 FD  TPOAGMT-EXTRACT-FILE                                         00460014
004700     RECORDING MODE IS F                                          00470014
004800     LABEL RECORDS ARE STANDARD                                   00480014
004900     BLOCK CONTAINS 0 RECORDS                                     00490014
005000     RECORD CONTAINS 99 CHARACTERS                                00500014
005100     DATA RECORD IS TPOAGMT-EXTRACT-DATA.                         00510014
005200 01  TPOAGMT-EXTRACT-DATA       PIC X(99).                        00520014
005300                                                                  00530014
005400                                                                  00540014
005500 EJECT                                                            00550014
005600 WORKING-STORAGE SECTION.                                         00560014
005700                                                                  00570014
005800 01  FILLER                       PIC X(58)     VALUE             00580014
005900     '************WORKING STORAGE STARTS HERE*******************'.00590014
006000                                                                  00600014
006100 01  PV-PROGRAM-VARIABLES.                                        00610014
006200     05  PV-PROGRAM-NAME          PIC  X(08)    VALUE 'AHKUP036'. 00620014
006300     05  PV-CKPT-STAT-CODE        PIC X(01)     VALUE SPACE.      00630014
006400     05  PV-CURRENT-PARAGRAPH     PIC X(50)     VALUE SPACES.     00640014
006500     05  PV-CURRENT-TMST          PIC X(26)     VALUE SPACES.     00650014
006600                                                                  00660014
006700     05  PV-TPOAGMT-INPUT-COUNT   PIC 9(09)     VALUE ZERO        00670014
006800                                                COMP-3.           00680014
006900     05  PV-TPOAGMT-DELETE-COUNT  PIC 9(09)     VALUE ZERO        00690014
007000                                                COMP-3.           00700014
007100     05  PV-SQL-DELETE-COUNT      PIC 9(09)     VALUE ZERO        00710014
007200                                                COMP-3.           00720014
007300     05  PV-SQLERRD3              PIC S9(09)    VALUE ZERO        00730014
007400                                                COMP-3.           00740014
007500     05  PV-DISP-PO-NBR           PIC X(09)    VALUE SPACES.      00750014
007600     05  PV-DISP-VER-NBR          PIC X(09)    VALUE SPACES.      00760014
007700     05  PV-DISP-SEQ-NBR          PIC X(09)    VALUE SPACES.      00770014
007900     05  PV-SAVE-PO-NBR           PIC S9(09) COMP                 00790014
008000                                               VALUE ZEROES.      00800014
008100 01  PC-PROGRAM-CONSTANTS.                                        00810014
008200     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          00820014
008300                                                COMP SYNC.        00830014
008400     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      00840014
008500     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00850014
008600     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00860014
008700                                                                  00870014
008800 01  PS-PROGRAM-SWITCHES.                                         00880014
008900     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.        00890014
009000         88  COMMITS-TAKEN                      VALUE 'T'.        00900014
009100         88  NO-COMMITS-TAKEN                   VALUE 'N'.        00910014
009200     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.        00920014
009300         88  MORE-EXTRACT                       VALUE 'M'.        00930014
009400         88  END-OF-EXTRACT                     VALUE 'E'.        00940014
009500     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        00950014
009600         88  NORMAL-RUN                         VALUE '0'.        00960014
009700         88  RESTART-RUN                        VALUE '9'.        00970014
010100                                                                  01010014
010200 01  WS-COUNTER.                                                  01020014
010300     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.     01030014
010400     05  WS-TMST                  PIC X(26)     VALUE SPACES.     01040014
010500                                                                  01050014
010600 01  CKPT-RESTART-INFO.                                           01060014
010700     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.       01070014
010800                                                                  01080014
010900*----------------------------------------------------------------*01090014
011000*  ABEND DATA AREAS                                              *01100014
011100*----------------------------------------------------------------*01110014
011200 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01120014
011300                                             COMP SYNC.           01130014
011400     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         01140014
011500     88  AC-BAD-DATA                         VALUE +4008.         01150014
011600     88  AC-DB2-ERROR                        VALUE +4013.         01160014
011700     88  AC-DATE-ERROR                       VALUE +4019.         01170014
011800                                                                  01180014
011900                                                                  01190014
012000 01  ABEND-AREAS.                                                 01200014
012100     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01210014
012200             '*****       ABEND'.                                 01220014
012300     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01230014
012400             '*****   PROGRAM: AHKUP036'.                         01240014
012500     05  AA-PARAGRAPH-LIT.                                        01250014
012600         10  FILLER              PIC  X(17)  VALUE                01260014
012700             '***** PARAGRAPH: '.                                 01270014
012800         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01280014
012900     05  AA-MESSAGE-LINE-1.                                       01290014
013000         10  FILLER              PIC  X(06)  VALUE '*****'.       01300014
013100         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01310014
013200     05  AA-MESSAGE-LINE-2.                                       01320014
013300         10  FILLER              PIC  X(06)  VALUE '*****'.       01330014
013400         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01340014
013500     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01350014
013600             '*****    DB2 ERROR'.                                01360014
013700     05  AA-DB2-OPERATION-LIT.                                    01370014
013800         10  FILLER              PIC  X(17)  VALUE                01380014
013900             '***** OPERATION: '.                                 01390014
014000         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01400014
014100     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01410014
014200     EJECT                                                        01420014
014300                                                                  01430014
014400     COPY DPWS004.                                                01440014
014500     EJECT                                                        01450014
014600*----------------------------------------------------------------*01460014
014700*      TPOAGMT TABLE LAYOUT                                       01470014
014800*----------------------------------------------------------------*01480014
014900         EXEC SQL                                                 01490014
015000             INCLUDE TPOAGMT                                      01500014
015100         END-EXEC.                                                01510014
015200                                                                  01520014
015300*----------------------------------------------------------------*01530014
015400*      TPURCHS TABLE LAYOUT                                       01540014
015500*----------------------------------------------------------------*01550014
015600         EXEC SQL                                                 01560014
015700             INCLUDE TPURCHS                                      01570014
015800         END-EXEC.                                                01580014
015900                                                                  01590014
016000*----------------------------------------------------------------*01600014
016100*      TCKRSTCNTL TABLE LAYOUT                                    01610014
016200*----------------------------------------------------------------*01620014
016300         EXEC SQL                                                 01630014
016400             INCLUDE TCKRSTCN                                     01640014
016500         END-EXEC.                                                01650014
016600                                                                  01660014
016700*----------------------------------------------------------------*01670014
016800*      TCKRSTINF TABLE LAYOUT                                     01680014
016900*----------------------------------------------------------------*01690014
017000         EXEC SQL                                                 01700014
017100             INCLUDE TCKRSTIN                                     01710014
017200         END-EXEC.                                                01720014
017300 EJECT                                                            01730014
017400*----------------------------------------------------------------*01740014
017500*  DB2 COMMUNICATION AREA                                         01750014
017600*----------------------------------------------------------------*01760014
017700*                                                                 01770014
017800     EXEC SQL                                                     01780014
017900         INCLUDE SQLCA                                            01790014
018000     END-EXEC.                                                    01800014
018100                                                                  01810014
018200*----------------------------------------------------------------*01820014
018300*  DB2 COMMUNICATION AREA2                                        01830014
018400*----------------------------------------------------------------*01840014
018500*                                                                 01850014
018600     COPY SQLCA2.                                                 01860014
018700     EJECT                                                        01870014
018800 PROCEDURE DIVISION.                                              01880014
018900 A100-MAINLINE-ROUTINE.                                           01890014
019000                                                                  01900014
019100     PERFORM B100-INITIALIZATION.                                 01910014
019200                                                                  01920014
019300     PERFORM B200-TPOAGMT-EXTRACT-PROCESS                         01930014
019400       UNTIL END-OF-EXTRACT.                                      01940014
019500                                                                  01950014
019600     PERFORM B300-EOJ-PROCESSING.                                 01960014
019700                                                                  01970014
019800     GOBACK.                                                      01980014
019900 EJECT                                                            01990014
020000 B100-INITIALIZATION.                                             02000014
020100                                                                  02010014
020200     EXEC SQL                                                     02020014
020300         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 02030014
020400     END-EXEC.                                                    02040014
020500                                                                  02050014
020600     PERFORM X300-GET-CHECKPOINT-CNTL.                            02060014
020700     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    02070014
020800                                                                  02080014
020900     OPEN INPUT TPOAGMT-EXTRACT-FILE.                             02090014
021000                                                                  02100014
021100     IF RESTART-RUN                                               02110014
021200         PERFORM X200-CHECKPOINT-RESTART                          02120014
021300     ELSE                                                         02130014
021400         PERFORM R100-READ-EXTRACT-FILE                           02140014
021500     END-IF.                                                      02150014
021600                                                                  02160014
021700     PERFORM X500-SET-CHECKPOINT-TIME.                            02170014
021800                                                                  02180014
021900                                                                  02190014
022000     EJECT                                                        02200014
022100 B200-TPOAGMT-EXTRACT-PROCESS.                                    02210014
022200                                                                  02220014
022300     MOVE POAGMT-PO-NBR             TO PV-DISP-PO-NBR.            02230014
022400     MOVE POAGMT-VER-NBR            TO PV-DISP-VER-NBR.           02240014
022500     MOVE POAGMT-SEQ-NBR            TO PV-DISP-SEQ-NBR.           02250014
022600     IF POAGMT-PO-NBR NOT = PV-SAVE-PO-NBR                        02260014
022700         MOVE POAGMT-PO-NBR TO PV-SAVE-PO-NBR                     02270014
022900     END-IF.                                                      02290014
023000                                                                  02300014
023200     PERFORM D100-DELETE-TPOAGMT                                  02320022
023400                                                                  02340014
023500     PERFORM X100-CHECKPOINT-CHECK.                               02350014
023600                                                                  02360014
023700     PERFORM R100-READ-EXTRACT-FILE.                              02370014
023800     EJECT                                                        02380014
023900                                                                  02390014
024000                                                                  02400014
024100 B300-EOJ-PROCESSING.                                             02410014
024200                                                                  02420014
024300     DISPLAY '** AHKUP036 SUMMARY **'.                            02430014
024400     DISPLAY '** TPOAGMT INPUT COUNT = ' PV-TPOAGMT-INPUT-COUNT.  02440014
024500     DISPLAY '** TPOAGMT DELETE COUNT = ' PV-TPOAGMT-DELETE-COUNT.02450014
024600     DISPLAY '** SQL DELETE COUNT = ' PV-SQL-DELETE-COUNT.        02460014
024700                                                                  02470014
024800     CLOSE  TPOAGMT-EXTRACT-FILE.                                 02480014
024900                                                                  02490014
025000     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02500014
025100     PERFORM X600-UPDATE-TCKRSTCNTL.                              02510014
025200                                                                  02520014
025300     EJECT                                                        02530014
032900                                                                  03290014
033000*----------------------------------------------------------------*03300014
033100*    DELETES FROM THE TPOAGMT TABLE.  CASCADE DELETE WILL ALSO   *03310014
033200*    CAUSE ROWS TO BE DELETED FROM TMIITEM, TVNDINV AND TEXINVC  *03320014
033300*    TABLES.                                                     *03330014
033400*----------------------------------------------------------------*03340014
033500 D100-DELETE-TPOAGMT.                                             03350014
033600                                                                  03360014
033700     MOVE 'D100-DELETE-TPOAGMT' TO PV-CURRENT-PARAGRAPH.          03370014
033800                                                                  03380014
033900     PERFORM WITH TEST AFTER                                      03390014
034000        VARYING PC-RETRY-COUNT FROM 1 BY 1                        03400014
034100          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                     03410014
034200             OR SQLCODE = ZERO                                    03420014
034300                                                                  03430014
034400         EXEC SQL                                                 03440014
034500              DELETE                                              03450014
034600                FROM TPOAGMT                                      03460014
034700               WHERE PO_NBR       = :POAGMT-PO-NBR                03470014
034800                 AND VER_NBR      = :POAGMT-VER-NBR               03480014
034900                 AND AGRMT_TYP_ID = :POAGMT-AGRMT-TYP-ID          03490014
035000                 AND SEQ_NBR      = :POAGMT-SEQ-NBR               03500014
035100         END-EXEC                                                 03510014
035200                                                                  03520014
035300         EVALUATE TRUE                                            03530014
035400             WHEN SQLCODE = ZERO                                  03540014
035500                 ADD 1 TO PV-TPOAGMT-DELETE-COUNT                 03550014
035600                 MOVE SQLERRD(3) TO PV-SQLERRD3                   03560014
035700                 ADD PV-SQLERRD3 TO PV-SQL-DELETE-COUNT           03570014
035800                                                                  03580014
035900             WHEN SQLCODE = -904                                  03590014
036000             WHEN SQLCODE = -913                                  03600014
036100             WHEN SQLCODE = +100                                  03610014
036200                  CONTINUE                                        03620014
036300                                                                  03630014
036400             WHEN SQLWARN0 NOT = SPACES                           03640014
036500             WHEN SQLCODE  NOT = ZERO                             03650014
036600                 MOVE PV-CURRENT-PARAGRAPH                        03660014
036700                                     TO AA-PARAGRAPH-NAME         03670014
036800                 DISPLAY '******** PO NUMBER:'                    03680014
036900                          PV-DISP-PO-NBR                          03690014
037000                 DISPLAY '******** PO VER NBR:'                   03700014
037100                          PV-DISP-VER-NBR                         03710014
037200                 DISPLAY '******** AGRMT TYP ID:'                 03720014
037300                          POAGMT-AGRMT-TYP-ID                     03730014
037400                 DISPLAY '******** SEQ NBR:'                      03740014
037500                          PV-DISP-SEQ-NBR                         03750014
037600                 MOVE SPACES TO AA-MESSAGE-1                      03760014
037700                                AA-MESSAGE-2                      03770014
037800                 MOVE 'UNSUCCESSFUL DELETE'                       03780014
037900                                     TO AA-DB2-OPERATION          03790014
038000                 MOVE 'TPOAGMT'      TO AA-DB2-TABLE              03800014
038100                 PERFORM Z999-DB2-ABEND                           03810014
038200         END-EVALUATE                                             03820014
038300     END-PERFORM.                                                 03830014
038400                                                                  03840014
038500     IF PC-RETRY-COUNT > PC-RETRY-MAX                             03850014
038600         MOVE PV-CURRENT-PARAGRAPH                                03860014
038700                             TO AA-PARAGRAPH-NAME                 03870014
038800         DISPLAY '******** PO NUMBER:'                            03880014
038900                          PV-DISP-PO-NBR                          03890014
039000         DISPLAY '******** PO VER NBR :'                          03900014
039100                          PV-DISP-VER-NBR                         03910014
039200         DISPLAY '******** AGRMT TYP ID:'                         03920014
039300                          POAGMT-AGRMT-TYP-ID                     03930014
039400         DISPLAY '******** SEQ NBR:'                              03940014
039500                          PV-DISP-SEQ-NBR                         03950014
039600         MOVE SPACES TO AA-MESSAGE-1                              03960014
039700                        AA-MESSAGE-2                              03970014
039800         MOVE 'MAX RETRIES EXCEEDED ON DELETE'                    03980014
039900                             TO AA-DB2-OPERATION                  03990014
040000         MOVE 'TPOAGMT'      TO AA-DB2-TABLE                      04000014
040100         PERFORM Z999-DB2-ABEND                                   04010014
040200     END-IF.                                                      04020014
040300                                                                  04030014
040400     EJECT                                                        04040014
040500 R100-READ-EXTRACT-FILE.                                          04050014
040600                                                                  04060014
040700     READ TPOAGMT-EXTRACT-FILE                                    04070014
040800          INTO DCLTPOAGMT                                         04080014
040900          AT END SET END-OF-EXTRACT TO TRUE.                      04090014
041000                                                                  04100014
041100     IF MORE-EXTRACT                                              04110014
041200         ADD 1 TO PV-TPOAGMT-INPUT-COUNT                          04120014
041300     END-IF.                                                      04130014
041400                                                                  04140014
041500                                                                  04150014
041600     EJECT                                                        04160014
041700*----------------------------------------------------------------*04170014
041800*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *04180014
041900*----------------------------------------------------------------*04190014
042000 X100-CHECKPOINT-CHECK.                                           04200014
042100                                                                  04210014
042200     MOVE 'X100-CHECKPOINT-CHECK' TO PV-CURRENT-PARAGRAPH.        04220014
042300                                                                  04230014
042400     EXEC SQL                                                     04240014
042500       SET :WS-TMST = CURRENT TIMESTAMP                           04250014
042600     END-EXEC.                                                    04260014
042700                                                                  04270014
042800     IF SQLCODE = +0                                              04280014
042900         CONTINUE                                                 04290014
043000     ELSE                                                         04300014
043100         MOVE PV-CURRENT-PARAGRAPH                                04310014
043200                             TO AA-PARAGRAPH-NAME                 04320014
043300         MOVE SPACES TO AA-MESSAGE-1                              04330014
043400                        AA-MESSAGE-2                              04340014
043500         MOVE 'BAD SET COMMAND'                                   04350014
043600                             TO AA-DB2-OPERATION                  04360014
043700         MOVE SPACES             TO AA-DB2-TABLE                  04370014
043800         PERFORM Z999-DB2-ABEND                                   04380014
043900     END-IF.                                                      04390014
044000                                                                  04400014
044100     IF WS-TMST > WS-HOLD-TMST                                    04410014
044200         IF NO-COMMITS-TAKEN                                      04420014
044300             MOVE PC-IN-PROCESS-CODE TO PV-CKPT-STAT-CODE         04430014
044400             PERFORM X600-UPDATE-TCKRSTCNTL                       04440014
044500             SET COMMITS-TAKEN TO TRUE                            04450014
044600         END-IF                                                   04460014
044700         PERFORM X700-UPDATE-TCKRSTINF                            04470014
044800         PERFORM Y100-COMMIT                                      04480014
044900         PERFORM X500-SET-CHECKPOINT-TIME                         04490014
045000     END-IF.                                                      04500014
045100                                                                  04510014
045200 EJECT                                                            04520014
045300*----------------------------------------------------------------*04530014
045400*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *04540014
045500*----------------------------------------------------------------*04550014
045600 X200-CHECKPOINT-RESTART.                                         04560014
045700                                                                  04570014
045800     MOVE 'X200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.      04580014
045900                                                                  04590014
046000     PERFORM X400-GET-CHECKPOINT-INFO.                            04600014
046100     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     04610014
046200                                                                  04620014
046300     DISPLAY '** AHKUP036 CHECKPOINT RESTART **'                  04630014
046400     DISPLAY '** EXTRACT RECS BYPASSED ON RESTART = '             04640014
046500              CR-EXTRACT-RECS-WORKED.                             04650014
046600     DISPLAY '***********************************************'    04660014
046700                                                                  04670014
046800     PERFORM R100-READ-EXTRACT-FILE                               04680014
046900         CR-EXTRACT-RECS-WORKED TIMES.                            04690014
047000     PERFORM R100-READ-EXTRACT-FILE.                              04700014
047100 EJECT                                                            04710014
047200*----------------------------------------------------------------*04720014
047300*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *04730014
047400*----------------------------------------------------------------*04740014
047500 X300-GET-CHECKPOINT-CNTL.                                        04750014
047600                                                                  04760014
047700     MOVE 'X300-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     04770014
047800                                                                  04780014
047900     PERFORM WITH TEST AFTER                                      04790014
048000             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04800014
048100             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04810014
048200                     SQLCODE = ZERO                               04820014
048300                                                                  04830014
048400             EXEC SQL                                             04840014
048500              SELECT CKPT_STAT_CODE                               04850014
048600               INTO :PV-CKPT-STAT-CODE                            04860014
048700               FROM TCKRSTCNTL                                    04870014
048800               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04880014
048900             END-EXEC                                             04890014
049000                                                                  04900014
049100             EVALUATE TRUE                                        04910014
049200                 WHEN SQLCODE = ZERO                              04920014
049300                 WHEN SQLCODE = -904                              04930014
049400                 WHEN SQLCODE = -913                              04940014
049500                      CONTINUE                                    04950014
049600                                                                  04960014
049700                 WHEN SQLWARN0 NOT = SPACES                       04970014
049800                 WHEN SQLCODE  NOT = ZERO                         04980014
049900                     MOVE PV-CURRENT-PARAGRAPH                    04990014
050000                                         TO AA-PARAGRAPH-NAME     05000014
050100                     DISPLAY '******** PLAN_NAME:'                05010014
050200                              PV-PROGRAM-NAME                     05020014
050300                     MOVE SPACES TO AA-MESSAGE-1                  05030014
050400                                    AA-MESSAGE-2                  05040014
050500                     MOVE 'UNSUCCESSFUL SELECT'                   05050014
050600                                         TO AA-DB2-OPERATION      05060014
050700                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05070014
050800                     PERFORM Z999-DB2-ABEND                       05080014
050900             END-EVALUATE                                         05090014
051000     END-PERFORM.                                                 05100014
051100                                                                  05110014
051200     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05120014
051300         MOVE PV-CURRENT-PARAGRAPH                                05130014
051400                             TO AA-PARAGRAPH-NAME                 05140014
051500         DISPLAY '******** PLAN_NAME:'                            05150014
051600                  PV-PROGRAM-NAME                                 05160014
051700         MOVE SPACES TO AA-MESSAGE-1                              05170014
051800                        AA-MESSAGE-2                              05180014
051900         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05190014
052000                             TO AA-DB2-OPERATION                  05200014
052100         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05210014
052200         PERFORM Z999-DB2-ABEND                                   05220014
052300     END-IF.                                                      05230014
052400                                                                  05240014
052500 EJECT                                                            05250014
052600*----------------------------------------------------------------*05260014
052700*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *05270014
052800*----------------------------------------------------------------*05280014
052900 X400-GET-CHECKPOINT-INFO.                                        05290014
053000                                                                  05300014
053100     MOVE 'X400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     05310014
053200                                                                  05320014
053300     PERFORM WITH TEST AFTER                                      05330014
053400             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05340014
053500             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05350014
053600                     SQLCODE = ZERO                               05360014
053700                                                                  05370014
053800             EXEC SQL                                             05380014
053900              SELECT WORK_STRG_DESC                               05390014
054000               INTO :TCKRSTINF-WORK-STRG-DESC                     05400014
054100               FROM TCKRSTINF                                     05410014
054200               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05420014
054300             END-EXEC                                             05430014
054400                                                                  05440014
054500             EVALUATE TRUE                                        05450014
054600                 WHEN SQLCODE = ZERO                              05460014
054700                 WHEN SQLCODE = -904                              05470014
054800                 WHEN SQLCODE = -913                              05480014
054900                      CONTINUE                                    05490014
055000                                                                  05500014
055100                 WHEN SQLWARN0 NOT = SPACES                       05510014
055200                 WHEN SQLCODE  NOT = ZERO                         05520014
055300                     MOVE PV-CURRENT-PARAGRAPH                    05530014
055400                                         TO AA-PARAGRAPH-NAME     05540014
055500                     DISPLAY '******** PLAN_NAME:'                05550014
055600                              PV-PROGRAM-NAME                     05560014
055700                     MOVE SPACES TO AA-MESSAGE-1                  05570014
055800                                    AA-MESSAGE-2                  05580014
055900                     MOVE 'UNSUCCESSFUL SELECT'                   05590014
056000                                         TO AA-DB2-OPERATION      05600014
056100                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          05610014
056200                     PERFORM Z999-DB2-ABEND                       05620014
056300             END-EVALUATE                                         05630014
056400     END-PERFORM.                                                 05640014
056500                                                                  05650014
056600     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05660014
056700         MOVE PV-CURRENT-PARAGRAPH                                05670014
056800                             TO AA-PARAGRAPH-NAME                 05680014
056900         DISPLAY '******** PLAN_NAME:'                            05690014
057000                  PV-PROGRAM-NAME                                 05700014
057100         MOVE SPACES TO AA-MESSAGE-1                              05710014
057200                        AA-MESSAGE-2                              05720014
057300         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05730014
057400                             TO AA-DB2-OPERATION                  05740014
057500         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      05750014
057600         PERFORM Z999-DB2-ABEND                                   05760014
057700     END-IF.                                                      05770014
057800                                                                  05780014
057900 EJECT                                                            05790014
058000*----------------------------------------------------------------*05800014
058100*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *05810014
058200*----------------------------------------------------------------*05820014
058300 X500-SET-CHECKPOINT-TIME.                                        05830014
058400                                                                  05840014
058500     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-CURRENT-PARAGRAPH.     05850014
058600                                                                  05860014
058700     PERFORM WITH TEST AFTER                                      05870014
058800             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05880014
058900             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05890014
059000                     SQLCODE = ZERO                               05900014
059100                                                                  05910014
059200             EXEC SQL                                             05920014
059300              SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)05930014
059400               INTO :WS-HOLD-TMST                                 05940014
059500               FROM TCKRSTCNTL                                    05950014
059600               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05960014
059700             END-EXEC                                             05970014
059800                                                                  05980014
059900             EVALUATE TRUE                                        05990014
060000                 WHEN SQLCODE = ZERO                              06000014
060100                 WHEN SQLCODE = -904                              06010014
060200                 WHEN SQLCODE = -913                              06020014
060300                      CONTINUE                                    06030014
060400                                                                  06040014
060500                 WHEN SQLWARN0 NOT = SPACES                       06050014
060600                 WHEN SQLCODE  NOT = ZERO                         06060014
060700                     MOVE PV-CURRENT-PARAGRAPH                    06070014
060800                                         TO AA-PARAGRAPH-NAME     06080014
060900                     DISPLAY '******** PLAN_NAME:'                06090014
061000                              PV-PROGRAM-NAME                     06100014
061100                     MOVE SPACES TO AA-MESSAGE-1                  06110014
061200                                    AA-MESSAGE-2                  06120014
061300                     MOVE 'UNSUCCESSFUL SELECT'                   06130014
061400                                         TO AA-DB2-OPERATION      06140014
061500                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          06150014
061600                     PERFORM Z999-DB2-ABEND                       06160014
061700             END-EVALUATE                                         06170014
061800     END-PERFORM.                                                 06180014
061900                                                                  06190014
062000     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06200014
062100         MOVE PV-CURRENT-PARAGRAPH                                06210014
062200                             TO AA-PARAGRAPH-NAME                 06220014
062300         DISPLAY '******** PLAN_NAME:'                            06230014
062400                  PV-PROGRAM-NAME                                 06240014
062500         MOVE SPACES TO AA-MESSAGE-1                              06250014
062600                        AA-MESSAGE-2                              06260014
062700         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    06270014
062800                             TO AA-DB2-OPERATION                  06280014
062900         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06290014
063000         PERFORM Z999-DB2-ABEND                                   06300014
063100     END-IF.                                                      06310014
063200                                                                  06320014
063300 EJECT                                                            06330014
063400*----------------------------------------------------------------*06340014
063500*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *06350014
063600*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *06360014
063700*----------------------------------------------------------------*06370014
063800 X600-UPDATE-TCKRSTCNTL.                                          06380014
063900                                                                  06390014
064000     MOVE 'X600-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       06400014
064100                                                                  06410014
064200     PERFORM WITH TEST AFTER                                      06420014
064300             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06430014
064400             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06440014
064500                     SQLCODE = ZERO                               06450014
064600                                                                  06460014
064700             EXEC SQL                                             06470014
064800                 UPDATE TCKRSTCNTL                                06480014
064900                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          06490014
065000                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06500014
065100             END-EXEC                                             06510014
065200                                                                  06520014
065300             EVALUATE TRUE                                        06530014
065400                 WHEN SQLCODE = ZERO                              06540014
065500                 WHEN SQLCODE = -904                              06550014
065600                 WHEN SQLCODE = -913                              06560014
065700                      CONTINUE                                    06570014
065800                                                                  06580014
065900                 WHEN SQLWARN0 NOT = SPACES                       06590014
066000                 WHEN SQLCODE  NOT = ZERO                         06600014
066100                     MOVE PV-CURRENT-PARAGRAPH                    06610014
066200                                         TO AA-PARAGRAPH-NAME     06620014
066300                     DISPLAY '******** PLAN_NAME:'                06630014
066400                              PV-PROGRAM-NAME                     06640014
066500                     MOVE SPACES TO AA-MESSAGE-1                  06650014
066600                                    AA-MESSAGE-2                  06660014
066700                     MOVE 'UNSUCCESSFUL UPDATE'                   06670014
066800                                         TO AA-DB2-OPERATION      06680014
066900                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          06690014
067000                     PERFORM Z999-DB2-ABEND                       06700014
067100             END-EVALUATE                                         06710014
067200     END-PERFORM.                                                 06720014
067300                                                                  06730014
067400     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06740014
067500         MOVE PV-CURRENT-PARAGRAPH                                06750014
067600                             TO AA-PARAGRAPH-NAME                 06760014
067700         DISPLAY '******** PLAN_NAME:'                            06770014
067800                  PV-PROGRAM-NAME                                 06780014
067900         MOVE SPACES TO AA-MESSAGE-1                              06790014
068000                        AA-MESSAGE-2                              06800014
068100         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06810014
068200                             TO AA-DB2-OPERATION                  06820014
068300         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06830014
068400         PERFORM Z999-DB2-ABEND                                   06840014
068500     END-IF.                                                      06850014
068600                                                                  06860014
068700     EJECT                                                        06870014
068800*----------------------------------------------------------------*06880014
068900*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *06890014
069000*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *06900014
069100*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *06910014
069200*----------------------------------------------------------------*06920014
069300 X700-UPDATE-TCKRSTINF.                                           06930014
069400                                                                  06940014
069500     MOVE 'X700-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        06950014
069600                                                                  06960014
069700     MOVE PV-TPOAGMT-INPUT-COUNT TO CR-EXTRACT-RECS-WORKED.       06970014
069800     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   06980014
069900     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    06990014
070000                                                                  07000014
070100     PERFORM WITH TEST AFTER                                      07010014
070200             VARYING PC-RETRY-COUNT FROM 1 BY 1                   07020014
070300             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             07030014
070400                     SQLCODE = ZERO                               07040014
070500                                                                  07050014
070600             EXEC SQL                                             07060014
070700                 UPDATE TCKRSTINF                                 07070014
070800                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 07080014
070900                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          07090014
071000             END-EXEC                                             07100014
071100                                                                  07110014
071200             EVALUATE TRUE                                        07120014
071300                 WHEN SQLCODE = ZERO                              07130014
071400                 WHEN SQLCODE = -904                              07140014
071500                 WHEN SQLCODE = -913                              07150014
071600                      CONTINUE                                    07160014
071700                                                                  07170014
071800                 WHEN SQLWARN0 NOT = SPACES                       07180014
071900                 WHEN SQLCODE  NOT = ZERO                         07190014
072000                     MOVE PV-CURRENT-PARAGRAPH                    07200014
072100                                         TO AA-PARAGRAPH-NAME     07210014
072200                     DISPLAY '******** PLAN_NAME:'                07220014
072300                              PV-PROGRAM-NAME                     07230014
072400                     MOVE SPACES TO AA-MESSAGE-1                  07240014
072500                                    AA-MESSAGE-2                  07250014
072600                     MOVE 'UNSUCCESSFUL UPDATE'                   07260014
072700                                         TO AA-DB2-OPERATION      07270014
072800                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          07280014
072900                     PERFORM Z999-DB2-ABEND                       07290014
073000             END-EVALUATE                                         07300014
073100     END-PERFORM.                                                 07310014
073200                                                                  07320014
073300     IF PC-RETRY-COUNT > PC-RETRY-MAX                             07330014
073400         MOVE PV-CURRENT-PARAGRAPH                                07340014
073500                             TO AA-PARAGRAPH-NAME                 07350014
073600         DISPLAY '******** PLAN_NAME:'                            07360014
073700                  PV-PROGRAM-NAME                                 07370014
073800         MOVE SPACES TO AA-MESSAGE-1                              07380014
073900                        AA-MESSAGE-2                              07390014
074000         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    07400014
074100                             TO AA-DB2-OPERATION                  07410014
074200         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      07420014
074300         PERFORM Z999-DB2-ABEND                                   07430014
074400     END-IF.                                                      07440014
074500                                                                  07450014
074600 EJECT                                                            07460014
074700                                                                  07470014
074800*----------------------------------------------------------------*07480014
074900*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *07490014
075000*----------------------------------------------------------------*07500014
075100 Y100-COMMIT.                                                     07510014
075200                                                                  07520014
075300     MOVE 'Y100-COMMIT'    TO PV-CURRENT-PARAGRAPH.               07530014
075400                                                                  07540014
075500     EXEC SQL                                                     07550014
075600         COMMIT                                                   07560014
075700     END-EXEC.                                                    07570014
075800                                                                  07580014
075900     EVALUATE TRUE                                                07590014
076000         WHEN SQLCODE = ZEROS                                     07600014
076100             CONTINUE                                             07610014
076200         WHEN OTHER                                               07620014
076300             MOVE PV-CURRENT-PARAGRAPH                            07630014
076400                                 TO AA-PARAGRAPH-NAME             07640014
076500             MOVE SPACES TO AA-MESSAGE-1                          07650014
076600                            AA-MESSAGE-2                          07660014
076700             MOVE 'UNSUCCESSFUL COMMIT'                           07670014
076800                                 TO AA-DB2-OPERATION              07680014
076900             MOVE SPACES         TO AA-DB2-TABLE                  07690014
077000             PERFORM Z999-DB2-ABEND                               07700014
077100     END-EVALUATE.                                                07710014
077200 EJECT                                                            07720014
077300 Z999-DB2-ABEND.                                                  07730014
077400                                                                  07740014
077500     DISPLAY AA-ABEND-LIT.                                        07750014
077600     DISPLAY AA-DB2-ERROR-LIT.                                    07760014
077700     DISPLAY AA-PROGRAM-LIT.                                      07770014
077800     DISPLAY AA-PARAGRAPH-LIT.                                    07780014
077900     DISPLAY AA-DB2-OPERATION-LIT.                                07790014
078000     DISPLAY AA-DB2-TABLE.                                        07800014
078100     SET AC-DB2-ERROR TO TRUE.                                    07810014
078200                                                                  07820014
078300     COPY DPPD004.                                                07830014
078400                                                                  07840014
078500     CALL 'ILBOABN0' USING ABEND-CODE.                            07850014
