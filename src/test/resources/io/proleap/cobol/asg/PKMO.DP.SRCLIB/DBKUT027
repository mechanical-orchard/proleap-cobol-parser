00001 ******************************************************************00010066
00002  IDENTIFICATION DIVISION.                                         00020066
00003 ******************************************************************00030066
00004                                                                   00040066
00005  PROGRAM-ID.             DBKUT027.                                00050066
00006  AUTHOR.                 BRAD DORN.                               00060066
00007  INSTALLATION.           KOHLS.                                   00070066
00008  DATE-WRITTEN            NOVEMBER 2021.                           00080066
00009  DATE-COMPILED.                                                   00090066
00010                                                                   00100066
00017 ******************************************************************00110066
00012 * THIS PROGRAM READS IN A LISTCAT FILE FOR DB2 NON-PARTITIONED    00120066
00012 * INDEXES THAT REFERENCE PARTITIONED TABLES.  A REPORT IS CREATED 00130066
00012 * SHOWING CURRENT NUMBER OF PIECES (DATASETS), MAXIMUM NUMBER     00130166
00012 * OF PIECES ALLOWED, AND REMAINING CAPACITY OF THE LAST PIECE     00130266
00012 * IF IT IS AT THE MAXIMUM PIECE LIMIT.                            00130366
00017 ******************************************************************00130466
00018                                                                   00130566
00019 ******************************************************************00130666
00020  ENVIRONMENT DIVISION.                                            00130766
00021 ******************************************************************00130866
00022                                                                   00130966
00023  CONFIGURATION SECTION.                                           00131066
00024                                                                   00132066
00025  SOURCE-COMPUTER.        IBM-3090.                                00133066
00026  OBJECT-COMPUTER.        IBM-3090.                                00134066
00027                                                                   00135066
00028  INPUT-OUTPUT SECTION.                                            00136066
00029                                                                   00137066
00030  FILE-CONTROL.                                                    00138066
00031                                                                   00139066
00032      SELECT INPUT-IX-LISTCAT         ASSIGN TO INP01.             00140066
00033      SELECT OUTPUT-REPORT            ASSIGN TO OUT01.             00150066
00035                                                                   00160066
00036 ******************************************************************00170066
00037  DATA DIVISION.                                                   00180066
00038 ******************************************************************00190066
00039                                                                   00200066
00040  FILE SECTION.                                                    00210066
00041                                                                   00220066
00042  FD  INPUT-IX-LISTCAT                                             00230066
00043      RECORDING MODE IS V                                          00240066
00044      LABEL RECORDS ARE STANDARD                                   00250066
00045      BLOCK CONTAINS 0 RECORDS.                                    00260066
00046                                                                   00270066
00047  01  INPUT-IX-LISTCAT-REC            PIC  X(121).                 00280066
00048                                                                   00290066
00049  FD  OUTPUT-REPORT                                                00300066
00050      RECORDING MODE IS F                                          00310066
00051      LABEL RECORDS ARE STANDARD                                   00320066
00052      BLOCK CONTAINS 0 RECORDS.                                    00330066
00053                                                                   00340066
00054  01  OUTPUT-REPORT-REC               PIC  X(132).                 00350066
00055                                                                   00360066
00064 ******************************************************************00370066
00065  WORKING-STORAGE SECTION.                                         00380066
00066 ******************************************************************00390066
00073                                                                   00400066
00112  01  HEADING-LINE-1.                                              00410066
00089      05  HL1-RUN-DATE.                                            00420066
00091          10  FILLER                        PIC X(01) VALUE SPACE. 00430066
00090          10  HL1-RUN-MONTH                 PIC 9(02) VALUE ZERO.  00440066
00091          10  FILLER                        PIC X(01) VALUE '/'.   00450066
00092          10  HL1-RUN-DAY                   PIC 9(02) VALUE ZERO.  00460066
00093          10  FILLER                        PIC X(01) VALUE '/'.   00470066
00094          10  HL1-RUN-YEAR                  PIC 9(02) VALUE ZERO.  00480066
00113      05  FILLER                      PIC  X(40)      VALUE SPACE. 00490066
00114      05  FILLER                      PIC  X(37)      VALUE        00500066
00115          'NON-PARTITIONED INDEX CAPACITY REPORT'.                 00510066
00116                                                                   00520066
00117  01  HEADING-LINE-2.                                              00530066
00118      05  FILLER                      PIC  X(104)     VALUE SPACES.00540066
00123      05  FILLER                      PIC  X(06)      VALUE        00550066
00120          'CURR #'.                                                00560066
00123      05  FILLER                      PIC  X(03)      VALUE SPACES.00570066
00123      05  FILLER                      PIC  X(05)      VALUE        00580066
00120          'MAX #'.                                                 00590066
00123      05  FILLER                      PIC  X(03)      VALUE SPACES.00600066
00123      05  FILLER                      PIC  X(10)      VALUE        00610066
00124          'REMAINING '.                                            00620066
00129                                                                   00630066
00117  01  HEADING-LINE-3.                                              00640066
00123      05  FILLER                      PIC  X(05)      VALUE        00650066
00120          'INDEX'.                                                 00660066
00118      05  FILLER                      PIC  X(46)      VALUE SPACES.00670066
00123      05  FILLER                      PIC  X(05)      VALUE        00680066
00120          'TABLE'.                                                 00690066
00118      05  FILLER                      PIC  X(36)      VALUE SPACES.00700066
00123      05  FILLER                      PIC  X(09)      VALUE        00710066
00120          'PIECESIZE'.                                             00711066
00118      05  FILLER                      PIC  X(03)      VALUE SPACES.00712066
00123      05  FILLER                      PIC  X(06)      VALUE        00713066
00120          'PIECES'.                                                00714066
00118      05  FILLER                      PIC  X(03)      VALUE SPACES.00715066
00123      05  FILLER                      PIC  X(06)      VALUE        00716066
00120          'PIECES'.                                                00717066
00118      05  FILLER                      PIC  X(02)      VALUE SPACES.00718066
00123      05  FILLER                      PIC  X(10)      VALUE        00719066
00120          'CAPACITY %'.                                            00719166
00116                                                                   00719266
00117  01  HEADING-LINE-4.                                              00719366
00118      05  FILLER                      PIC  X(121)     VALUE SPACES.00719466
00123      05  FILLER                      PIC  X(10)      VALUE        00719566
00120          '(CURR=MAX)'.                                            00719666
00116                                                                   00719766
00151  01  DETAIL-LINE.                                                 00719866
00153      05  DL-INDEX                    PIC  X(50)      VALUE SPACES.00719966
00154      05  FILLER                      PIC  X(01)      VALUE SPACES.00720066
00153      05  DL-TABLE                    PIC  X(40)      VALUE SPACES.00721066
00154      05  FILLER                      PIC  X(03)      VALUE SPACES.00721166
00155      05  DL-PIECESIZE                PIC  ZZ9        VALUE ZERO.  00721266
00154      05  FILLER                      PIC  X(01)      VALUE SPACES.00721366
00154      05  DL-PIECESIZE-UNIT           PIC  X(02)      VALUE SPACES.00721466
00156      05  FILLER                      PIC  X(04)      VALUE SPACES.00721566
00155      05  DL-CURR-NBR-PIECES          PIC  ZZZ99      VALUE ZERO.  00721666
00156      05  FILLER                      PIC  X(04)      VALUE SPACES.00721766
00155      05  DL-MAX-NBR-PIECES           PIC  ZZZ99      VALUE ZERO.  00721866
00158      05  FILLER                      PIC  X(07)      VALUE SPACES.00721966
00159      05  DL-PCT-REMAINING            PIC  ZZ9        VALUE ZERO.  00722066
           05  FILLER REDEFINES DL-PCT-REMAINING.                       00722166
               10  DL-PCT-REMAINING-X      PIC  X(03).                  00722266
00287                                                                   00722366
00288  01  END-OF-REPORT-LINE.                                          00722466
00289      05  FILLER                      PIC  X(54)      VALUE SPACE. 00722566
00290      05  FILLER                      PIC  X(25)      VALUE        00722666
00291          '***** END OF REPORT *****'.                             00722766
00292      05  FILLER                      PIC  X(53)      VALUE SPACE. 00722866
00293                                                                   00722966
00294  01  BLANK-LINE                      PIC X(80) VALUE SPACES.      00723066
00073                                                                   00724066
       01  WS-SYSTEM-DATE.                                              00724166
           05  WS-SYSTEM-YEAR              PIC 9(02) VALUE ZERO.        00724266
           05  WS-SYSTEM-MONTH             PIC 9(02) VALUE ZERO.        00724366
           05  WS-SYSTEM-DAY               PIC 9(02) VALUE ZERO.        00724466
00073                                                                   00724566
00074  01  WS-MISC.                                                     00724666
           05  WS-ABEND-CODE             PIC  9(04)  COMP VALUE 0.      00724766
           05  WS-AT-MAX-NBR-PIECES      PIC  X(01)  VALUE SPACES.      00724866
           05  WS-BYTES-IN-KBYTES        PIC  9(10)  COMP VALUE 1024.   00724966
00069      05  WS-DATASET-FIELD1         PIC  X(06)  VALUE SPACES.      00725066
00069      05  WS-DATASET-FIELD2         PIC  X(06)  VALUE SPACES.      00726066
00069      05  WS-DATASET-FIELD3         PIC  X(08)  VALUE SPACES.      00727066
00069      05  WS-DATASET-FIELD4         PIC  X(08)  VALUE SPACES.      00728066
00069      05  WS-DATASET-FIELD5         PIC  X(05)  VALUE SPACES.      00729066
00069      05  WS-DATASET-FIELD6         PIC  X(04)  VALUE SPACES.      00730066
           05  WS-HI-USED-KB             PIC  9(09)V99  COMP VALUE 0.   00740066
           05  WS-HI-USED-RBA            PIC  9(15)  COMP VALUE 0.      00750066
           05  WS-INPUT-EOF-SW           PIC  X(01)  VALUE 'N'.         00760066
           05  WS-MAX-NBR-PIECES         PIC  S9(9)  COMP VALUE 0.      00770075
           05  WS-NO-MORE-ROWS           PIC  X(01)  VALUE 'N'.         00780066
           05  WS-PIECE-COUNT            PIC  S9(4)  COMP VALUE 0.      00790068
           05  WS-PIECESIZE              PIC  S9(4)  COMP   VALUE 0.    00800068
           05  WS-PIECESIZE-PCT-FULL     PIC  9V99   COMP   VALUE 0.    00810066
           05  WS-PIECESIZE-UNIT         PIC  X(02)  VALUE SPACES.      00820066
           05  WS-PCT-REMAINING          PIC  S9(4)  COMP VALUE 0.      00830068
           05  WS-PREVIOUS-DBNAME        PIC  X(08)  VALUE SPACES.      00840066
           05  WS-PREVIOUS-IXSPACE       PIC  X(08)  VALUE SPACES.      00850066
           05  WS-INDEX                  PIC  X(50)  VALUE SPACES.      00860066
           05  WS-TWO-TO-32ND-POWER      PIC  9(15)  COMP               00870066
                                                     VALUE 4294967296.  00880066
00079  01  WS-INPUT-RECORD.                                             00890066
           05  FILLER                    PIC X(121)    VALUE SPACES.    00900066
00078                                                                   00910066
00079  01  WS-IN-DATASET-RECORD  REDEFINES WS-INPUT-RECORD.             00920066
           05  IN-DATASET-BYTES-1-17     PIC X(17).                     00930066
           05  IN-DATASET-NAME           PIC X(42).                     00940066
           05  FILLER                    PIC X(62).                     00950066
00080                                                                   00951066
00079  01  WS-IN-HI-USED-RECORD  REDEFINES WS-INPUT-RECORD.             00952066
           05  FILLER                    PIC X(37).                     00953066
           05  IN-HI-USED-BYTES-38-45    PIC X(08).                     00954066
           05  IN-HI-USED-BYTES-46-61    PIC X(16).                     00955066
           05  FILLER                    PIC X(60).                     00956066
                                                                        00957066
       01  DP004-DB2-ERROR-FIELDS.                                      00958066
           05  DP004-ASTERISK-LINE       PIC  X(80)  VALUE ALL '*'.     00959066
           05  DP004-MAX-MESSAGE-LINES   PIC S9(04)  VALUE +12          00960066
                                                     COMP SYNC.         00970066
           05  DP004-ERROR-LINE-LENGTH   PIC S9(09)  VALUE +75          00980066
                                                     COMP SYNC.         00990066
           05  DP004-FORMATTED-MESSAGE.                                 01000066
               10  FILLER                PIC S9(04)  VALUE +900         01010066
                                                     COMP SYNC.         01020066
               10  DP004-MESSAGE-LINE    OCCURS 12 TIMES                01030066
                                         INDEXED BY DP004-MSG-IDX       01040066
                                         PIC  X(75).                    01050066
                                                                        01060066
           EXEC SQL                                                     01070066
               INCLUDE SYSINDEX                                         01080066
           END-EXEC.                                                    01090066
                                                                        01100066
           EXEC SQL                                                     01110066
               INCLUDE SYSTABLE                                         01120066
           END-EXEC.                                                    01130066
                                                                        01140066
           EXEC SQL                                                     01150066
               INCLUDE SYSTABSP                                         01160066
           END-EXEC.                                                    01170066
                                                                        01180066
           EXEC SQL                                                     01190066
               INCLUDE SQLCA                                            01200066
           END-EXEC.                                                    01210066
                                                                        01220066
           EXEC SQL                                                     01230066
               DECLARE GTT-CURSOR CURSOR FOR                            01240066
                   SELECT GTT_INDEX, GTT_TABLE, GTT_PIECESIZE_UNIT,     01250066
                          GTT_PIECESIZE, GTT_CURR_NBR_PIECES,           01260066
                          GTT_MAX_NBR_PIECES, GTT_PCT_REMAINING,        01270066
                          GTT_AT_MAX_NBR_PIECES                         01280066
                   FROM SESSION.GTT                                     01290066
                   ORDER BY GTT_AT_MAX_NBR_PIECES DESC,                 01300066
                            GTT_PCT_REMAINING ASC,                      01310066
                            GTT_CURR_NBR_PIECES DESC,                   01311074
                            GTT_INDEX, GTT_TABLE                        01320066
               WITH UR                                                  01330066
           END-EXEC.                                                    01340066
                                                                        01350066
                                                                        01360066
                                                                        01370066
00139 ******************************************************************01380066
00140  PROCEDURE DIVISION.                                              01390066
00141 ******************************************************************01400066
00142                                                                   01410066
00143  0000-PROGRAM-MAINLINE SECTION.                                   01420066
00144                                                                   01430066
00145      PERFORM 1000-INITIALIZATION.                                 01440066
00152      PERFORM 2000-PROCESS-IX-FILE.                                01450066
00152      PERFORM 3000-CREATE-REPORT.                                  01460066
00153      PERFORM 4000-END-OF-JOB.                                     01470066
00146                                                                   01480066
00154      GOBACK.                                                      01490066
00155                                                                   01500066
00204                                                                   01510066
00205  1000-INITIALIZATION.                                             01520066
00206                                                                   01530066
00207      OPEN INPUT  INPUT-IX-LISTCAT                                 01540066
00208           OUTPUT OUTPUT-REPORT.                                   01550066
00209                                                                   01560066
00209      ACCEPT WS-SYSTEM-DATE FROM DATE.                             01570066
00209                                                                   01580066
           MOVE WS-SYSTEM-YEAR         TO HL1-RUN-YEAR.                 01590066
           MOVE WS-SYSTEM-MONTH        TO HL1-RUN-MONTH.                01600066
           MOVE WS-SYSTEM-DAY          TO HL1-RUN-DAY.                  01610066
                                                                        01620066
           WRITE OUTPUT-REPORT-REC FROM HEADING-LINE-1.                 01630066
           WRITE OUTPUT-REPORT-REC FROM BLANK-LINE.                     01640066
           WRITE OUTPUT-REPORT-REC FROM HEADING-LINE-2.                 01650066
           WRITE OUTPUT-REPORT-REC FROM HEADING-LINE-3.                 01651066
           WRITE OUTPUT-REPORT-REC FROM HEADING-LINE-4.                 01652066
           WRITE OUTPUT-REPORT-REC FROM BLANK-LINE.                     01653066
                                                                        01654066
           EXEC SQL                                                     01655066
               DECLARE GLOBAL TEMPORARY TABLE GTT                       01656066
                   ( GTT_INDEX             CHAR(50)  NOT NULL,          01656166
                     GTT_TABLE             CHAR(40)  NOT NULL,          01656266
                     GTT_PIECESIZE_UNIT    CHAR(02)  NOT NULL,          01656366
                     GTT_PIECESIZE         SMALLINT  NOT NULL,          01656466
                     GTT_CURR_NBR_PIECES   SMALLINT  NOT NULL,          01656566
                     GTT_MAX_NBR_PIECES    SMALLINT  NOT NULL,          01656666
                     GTT_PCT_REMAINING     SMALLINT  NOT NULL,          01656766
                     GTT_AT_MAX_NBR_PIECES CHAR(01)  NOT NULL)          01656866
                 ON COMMIT PRESERVE ROWS                                01656966
           END-EXEC.                                                    01657066
                                                                        01657166
           IF SQLCODE NOT EQUAL ZERO                                    01657266
00284          MOVE +4013      TO WS-ABEND-CODE                         01657366
00285          DISPLAY '*****************************************'      01657466
00286          DISPLAY '*** PROGRAM ERROR - DBKUT027          ***'      01657566
00287          DISPLAY '***                                   ***'      01657666
00288          DISPLAY '*** BAD SQL CALL - DECLARE GTT        ***'      01657766
00288          DISPLAY '*** 1000-INITIALIZATION               ***'      01657866
00289          DISPLAY '*****************************************'      01657966
00290          PERFORM 9999-SQL-ABEND                                   01658066
           END-IF.                                                      01658166
                                                                        01658266
                                                                        01658366
00223                                                                   01658466
00224  2000-PROCESS-IX-FILE.                                            01658566
00215 ******************************************************************01658666
00218 * PERFORM AN INITIAL READ ON THE INDEX LISTCAT FILE.              01658766
00218 * LOOP THROUGH AND PROCESS EACH RECORD UNTIL END OF FILE.         01658866
00218 * PROCESS LAST INDEX DATASET AT END OF FILE.                      01658966
00222 ******************************************************************01659066
00225                                                                   01660066
00167      PERFORM 2100-READ-IX-FILE.                                   01670066
00214                                                                   01680066
00270      IF WS-INPUT-EOF-SW = 'Y'                                     01690066
00363          MOVE +4013      TO WS-ABEND-CODE                         01700066
00364          DISPLAY '*****************************************'      01710066
00365          DISPLAY '*** PROGRAM ERROR - DBKUT027          ***'      01720066
00366          DISPLAY '***                                   ***'      01730066
00367          DISPLAY '*** EMPTY INDEX LISTCAT FILE          ***'      01740066
00288          DISPLAY '*** 2000-PROCESS-IX-FILE.             ***'      01750066
00368          DISPLAY '*****************************************'      01760066
00369          PERFORM 9999-NONSQL-ABEND                                01770066
00370      END-IF.                                                      01780066
00371                                                                   01790066
00152      PERFORM 2200-PROCESS-IX-RECORD                               01800066
00170          UNTIL WS-INPUT-EOF-SW IS EQUAL TO 'Y'.                   01810066
00371                                                                   01820066
           PERFORM 2310-PROCESS-PREV-INDEX.                             01830066
00153                                                                   01840066
00223                                                                   01850066
00267  2100-READ-IX-FILE.                                               01860066
00215 ******************************************************************01870066
00218 * READ THE INPUT FILE CONTAINING INDEX LISTCAT OUTPUT.            01880066
00222 ******************************************************************01890066
00268                                                                   01900066
00269      READ INPUT-IX-LISTCAT INTO WS-INPUT-RECORD                   01910066
00270          AT END MOVE 'Y' TO WS-INPUT-EOF-SW.                      01920066
00271                                                                   01930066
00223                                                                   01940066
00224  2200-PROCESS-IX-RECORD.                                          01950066
00215 ******************************************************************01960066
00218 * - PARSE THE INPUT RECORDS FOR EITHER A RECORD CONTAINING        01970066
00218 *   THE DATASET NAME OR A RECORD CONTAINING HI-USED-RBA.          01980066
00218 * - PERFORM THE APPROPRIATE PARAGRAPH IF FOUND.                   01990066
00218 * - READ THE NEXT INDEX LISTCAT RECORD.                           02000066
00222 ******************************************************************02010066
00225                                                                   02020066
           IF IN-DATASET-BYTES-1-17 = '0DATA ---------- '               02030066
               PERFORM 2300-PROCESS-DATASET-REC                         02040066
           ELSE                                                         02050066
               IF IN-HI-USED-BYTES-38-45 = 'HI-U-RBA'                   02060066
                   PERFORM 2400-PROCESS-HI-USED-REC                     02070066
               END-IF                                                   02080066
           END-IF.                                                      02090066
                                                                        02100066
00167      PERFORM 2100-READ-IX-FILE.                                   02110066
00214                                                                   02120066
00214                                                                   02130066
00224  2300-PROCESS-DATASET-REC.                                        02140066
00215 ******************************************************************02150066
00218 * EXTRACT THE DATASET NAME FROM THE LISTCAT RECORD                02160066
00218 * --------------------------------------------------------------  02170066
00218 * IF NO CHANGE IN DATABASE.INDEXSPACE FROM PREVIOUS RECORD:       02180066
00218 *   1) UPDATE THE COUNTER FOR NUMBER OF PIECES FOR THE INDEX      02190066
00218 *                                                                 02200066
00218 * IF A CHANGE IN DATABASE.INDEXSPACE FROM PREVIOUS RECORD:        02210066
00218 *   1) INSERT DATA TO GLOBAL TEMP TABLE FOR THE PREVIOUS INDEX    02220066
00218 *   2) FOR CURRENT INDEX RECORD GET THE MAXIMUM NBR OF PIECES     02230066
00222 ******************************************************************02240066
                                                                        02250066
           UNSTRING IN-DATASET-NAME                                     02260066
              DELIMITED BY '.'                                          02270066
           INTO WS-DATASET-FIELD1                                       02280066
                WS-DATASET-FIELD2                                       02290066
                WS-DATASET-FIELD3                                       02300066
                WS-DATASET-FIELD4                                       02310066
                WS-DATASET-FIELD5                                       02320066
                WS-DATASET-FIELD6                                       02330066
           END-UNSTRING.                                                02340066
                                                                        02350066
           IF WS-DATASET-FIELD3 = WS-PREVIOUS-DBNAME                    02360066
               AND WS-DATASET-FIELD4 = WS-PREVIOUS-IXSPACE              02370066
                   ADD +1 TO WS-PIECE-COUNT                             02380066
           ELSE                                                         02390066
             IF WS-PREVIOUS-DBNAME = SPACES                             02400066
                  AND WS-PREVIOUS-IXSPACE = SPACES                      02410066
                    PERFORM 2320-PROCESS-NEW-INDEX                      02420066
             ELSE                                                       02430066
               PERFORM 2310-PROCESS-PREV-INDEX                          02440066
               PERFORM 2320-PROCESS-NEW-INDEX                           02450066
             END-IF                                                     02460066
           END-IF.                                                      02470066
                                                                        02480066
                                                                        02490066
       2310-PROCESS-PREV-INDEX.                                         02500066
      ******************************************************************02510066
      * THIS PARAGRAPH INSERTS DATA FOR THE PREVIOUS INDEX LISTCAT      02520066
      * RECORD TO A GLOBAL TEMP TABLE.  A REPORT WILL BE GENERATED      02530066
      * USING DATA IN THE GTT.                                          02540066
      ******************************************************************02550066
                                                                        02560066
      * SYSINDEX-PIECESIZE IS STORED IN KB.                             02570066
           IF SYSINDEX-PIECESIZE < 1024                                 02580066
             MOVE SYSINDEX-PIECESIZE TO WS-PIECESIZE                    02590066
             MOVE 'KB' TO WS-PIECESIZE-UNIT                             02600066
           ELSE                                                         02610066
             IF SYSINDEX-PIECESIZE <= 524288                            02620066
               COMPUTE WS-PIECESIZE = SYSINDEX-PIECESIZE / 1024         02630066
               MOVE 'MB' TO WS-PIECESIZE-UNIT                           02640066
             ELSE                                                       02650066
               COMPUTE WS-PIECESIZE = SYSINDEX-PIECESIZE / 1048576      02660066
               MOVE 'GB' TO WS-PIECESIZE-UNIT                           02670066
           END-IF.                                                      02680066
                                                                        02690066
           IF WS-PIECE-COUNT = WS-MAX-NBR-PIECES                        02700076
             MOVE 'Y' TO WS-AT-MAX-NBR-PIECES                           02710066
           ELSE                                                         02720066
             MOVE 'N' TO WS-AT-MAX-NBR-PIECES                           02730066
             MOVE 0   TO WS-PCT-REMAINING                               02731073
           END-IF.                                                      02740066
                                                                        02750066
           EXEC SQL                                                     02760066
               INSERT                                                   02770066
                INTO SESSION.GTT                                        02780066
                   ( GTT_INDEX                                          02790066
                    ,GTT_TABLE                                          02800066
                    ,GTT_PIECESIZE_UNIT                                 02810066
                    ,GTT_PIECESIZE                                      02820066
                    ,GTT_CURR_NBR_PIECES                                02830066
                    ,GTT_MAX_NBR_PIECES                                 02840066
                    ,GTT_PCT_REMAINING                                  02850066
                    ,GTT_AT_MAX_NBR_PIECES)                             02860066
                VALUES                                                  02870066
                    ( :WS-INDEX                                         02880066
                     ,:SYSINDEX-TBNAME                                  02890067
                     ,:WS-PIECESIZE-UNIT                                02900066
                     ,:WS-PIECESIZE                                     02910066
                     ,:WS-PIECE-COUNT                                   02920066
                     ,:WS-MAX-NBR-PIECES                                02930066
                     ,:WS-PCT-REMAINING                                 02940066
                     ,:WS-AT-MAX-NBR-PIECES)                            02950066
           END-EXEC.                                                    02960066
                                                                        02970066
00283      IF  SQLCODE NOT = ZERO                                       02980066
00284          MOVE +4013      TO WS-ABEND-CODE                         02990066
00285          DISPLAY '*****************************************'      03000066
00286          DISPLAY '*** PROGRAM ERROR - DBKUT027          ***'      03010066
00287          DISPLAY '***                                   ***'      03020066
00288          DISPLAY '*** BAD SQL CALL ON INSERT TO GTT     ***'      03030066
00288          DISPLAY '*** 2310-PROCESS-PREV-INDEX           ***'      03040066
00289          DISPLAY '*****************************************'      03050066
00290          PERFORM 9999-SQL-ABEND                                   03060066
00291      END-IF.                                                      03070066
                                                                        03080066
                                                                        03090066
       2320-PROCESS-NEW-INDEX.                                          03100066
      ******************************************************************03110066
      * THIS PARAGRAPH PROCESSES A NEW INDEX LISTCAT RECORD.            03120066
      ******************************************************************03130066
                                                                        03140066
           MOVE SPACES TO SYSINDEX-TBNAME-TEXT.                         03150066
                                                                        03160066
           EXEC SQL                                                     03170066
             SELECT RTRIM(IX.CREATOR) || '.' || RTRIM(IX.NAME),         03180066
                    IX.TBNAME,                                          03190066
                    IX.PIECESIZE,IX.PGSIZE,TS.TYPE,TS.DSSIZE,           03200066
                    TS.PARTITIONS                                       03210066
               INTO :WS-INDEX,                                          03220066
                    :SYSINDEX-TBNAME,                                   03230066
                    :SYSINDEX-PIECESIZE,                                03240066
                    :SYSINDEX-PGSIZE,                                   03250066
                    :SYSTABSP-TYPE,                                     03260066
                    :SYSTABSP-DSSIZE,                                   03270066
                    :SYSTABSP-PARTITIONS                                03280066
                  FROM SYSIBM.SYSINDEXES    IX,                         03290066
                       SYSIBM.SYSTABLES     TBL,                        03300066
                       SYSIBM.SYSTABLESPACE TS                          03310066
               WHERE IX.DBNAME      = :WS-DATASET-FIELD3                03320066
                 AND IX.INDEXSPACE  = :WS-DATASET-FIELD4                03330066
                 AND IX.TBCREATOR   = TBL.CREATOR                       03340066
                 AND IX.TBNAME      = TBL.NAME                          03350066
                 AND TBL.TYPE IN ('T','M')                              03360066
                 AND TBL.DBNAME     = TS.DBNAME                         03370066
                 AND TBL.TSNAME     = TS.NAME                           03380066
             WITH UR                                                    03390066
00281      END-EXEC.                                                    03400066
00282                                                                   03410066
00283      IF  SQLCODE NOT = ZERO                                       03420066
00284          MOVE +4013      TO WS-ABEND-CODE                         03430066
00285          DISPLAY '*****************************************'      03440066
00286          DISPLAY '*** PROGRAM ERROR - DBKUT027          ***'      03450066
00287          DISPLAY '***                                   ***'      03460066
00288          DISPLAY '*** BAD SQL CALL - SYSINDEXES         ***'      03470066
00288          DISPLAY '***                SYSTABLES          ***'      03480066
00288          DISPLAY '***                SYSTABLESPACE      ***'      03490066
00288          DISPLAY '*** 2320-PROCESS-NEW-INDEX            ***'      03500066
00289          DISPLAY '*****************************************'      03510066
00290          PERFORM 9999-SQL-ABEND                                   03520066
00291      END-IF.                                                      03530066
                                                                        03540066
           MOVE 1 TO WS-PIECE-COUNT.                                    03550066
                                                                        03560066
           IF SYSINDEX-PGSIZE = 4096                                    03570066
             MOVE 4 TO SYSINDEX-PGSIZE                                  03580066
           END-IF.                                                      03590066
                                                                        03600066
      * SET PIECESIZE TO DEFAULT IF NO VALUE ASSIGNED                   03610066
           IF SYSINDEX-PIECESIZE = 0                                    03620066
             IF (SYSTABSP-TYPE NOT EQUAL 'L'                            03630066
                     AND SYSTABSP-DSSIZE = 0                            03640071
                     AND SYSTABSP-PARTITIONS <= 64)                     03650071
                 MOVE 2097152 TO SYSINDEX-PIECESIZE                     03660066
             ELSE                                                       03670066
                 MOVE 4194304 TO SYSINDEX-PIECESIZE                     03680066
           END-IF.                                                      03690066
                                                                        03700066
           PERFORM 2321-GET-MAX-NBR-PIECES.                             03710066
                                                                        03720066
           MOVE WS-DATASET-FIELD3 TO WS-PREVIOUS-DBNAME.                03730066
           MOVE WS-DATASET-FIELD4 TO WS-PREVIOUS-IXSPACE.               03740066
                                                                        03750066
                                                                        03760066
00224  2321-GET-MAX-NBR-PIECES.                                         03770066
00215 ******************************************************************03780066
00216 * THIS PARAGRAPH GETS THE MAXIMUM NUMBER OF PIECES (I.E. DATASETS)03790066
00216 * FOR A NON-PARTITIONED INDEX.  FORMULAS ARE TAKEN FROM THE DB2   03800066
00216 * SQL REFERENCE MANUAL.                                           03810066
00222 ******************************************************************03820066
00225                                                                   03830066
           IF (SYSTABSP-TYPE NOT EQUAL 'L'                              03840066
                   AND SYSTABSP-DSSIZE = 0                              03850071
                   AND SYSTABSP-PARTITIONS <= 64)                       03860071
                 MOVE 32 TO WS-MAX-NBR-PIECES                           03870066
           ELSE                                                         03880066
             COMPUTE WS-MAX-NBR-PIECES =                                03890066
             (WS-TWO-TO-32ND-POWER /                                    03900066
                    (SYSINDEX-PIECESIZE / SYSINDEX-PGSIZE))             03910066
             IF WS-MAX-NBR-PIECES > 4096                                03920066
               MOVE 4096 TO WS-MAX-NBR-PIECES                           03930066
             END-IF                                                     03940066
           END-IF.                                                      03950066
                                                                        03960066
                                                                        03970066
00260  2400-PROCESS-HI-USED-REC.                                        03980066
00215 ******************************************************************03990066
00218 * EXTRACT THE HI-USED RBA FIELD (BYTES) FROM THE LISTCAT RECORD.  04000066
00218 * CALCULATE THE PERCENT OF AVAILABLE SPACE REMAINING IN THE       04010066
00218 * DATASET.                                                        04020066
00222 ******************************************************************04030066
                                                                        04040066
           INSPECT IN-HI-USED-BYTES-46-61                               04050066
               REPLACING ALL '-' BY '0'.                                04060066
           MOVE IN-HI-USED-BYTES-46-61 TO WS-HI-USED-RBA.               04070066
           DIVIDE WS-HI-USED-RBA BY WS-BYTES-IN-KBYTES                  04080066
               GIVING WS-HI-USED-KB ROUNDED.                            04090066
           DIVIDE WS-HI-USED-KB BY SYSINDEX-PIECESIZE                   04100066
               GIVING WS-PIECESIZE-PCT-FULL ROUNDED.                    04110066
                                                                        04120066
           COMPUTE WS-PCT-REMAINING =                                   04130066
             100 - (WS-PIECESIZE-PCT-FULL * 100).                       04140066
                                                                        04150066
                                                                        04160066
00260  3000-CREATE-REPORT.                                              04170066
00215 ******************************************************************04180066
00218 * CREATE THE REPORT USING DATA STORED ON THE GLOBAL TEMP TABLE.   04190066
00222 ******************************************************************04200066
                                                                        04210066
193600     EXEC SQL                                                     04220066
193700        OPEN GTT-CURSOR                                           04230066
193800     END-EXEC.                                                    04240066
193900                                                                  04250066
194000     IF  SQLCODE NOT = ZERO                                       04260066
194100         DISPLAY '******************************************'     04270066
194200         DISPLAY '*** PROGRAM ERROR - DBKUT027           ***'     04280066
194300         DISPLAY '***                                    ***'     04290066
194400         DISPLAY '*** PARAGRAPH 3000-CREATE-REPORT       ***'     04300066
194500         DISPLAY '*** BAD OPEN ON GTT-CURSOR             ***'     04310066
194600         DISPLAY '******************************************'     04320066
194700         PERFORM 9999-SQL-ABEND.                                  04330069
194800                                                                  04340066
195100     PERFORM 3100-FETCH-GTT-ROW                                   04350066
195200         UNTIL WS-NO-MORE-ROWS = 'Y'.                             04360066
195300                                                                  04370066
195400     EXEC SQL                                                     04380066
195500        CLOSE GTT-CURSOR                                          04390066
195600     END-EXEC.                                                    04400066
195700                                                                  04410066
195800     IF  SQLCODE NOT = ZERO                                       04420066
195900         DISPLAY '******************************************'     04430066
196000         DISPLAY '*** PROGRAM ERROR - DBKUT027           ***'     04440066
196100         DISPLAY '***                                    ***'     04450066
196200         DISPLAY '*** PARAGRAPH 3000-CREATE-REPORT       ***'     04460066
196300         DISPLAY '*** BAD CLOSE ON GTT-CURSOR            ***'     04470066
196400         DISPLAY '******************************************'     04480066
196500         PERFORM 9999-SQL-ABEND.                                  04490069
                                                                        04500066
                                                                        04510066
00260  3100-FETCH-GTT-ROW.                                              04530066
00215 ******************************************************************04540066
00218 * FETCH ROW FROM THE GLOBAL TEMP TABLE                            04550070
00222 ******************************************************************04560066
                                                                        04570066
198400     EXEC SQL                                                     04580066
198500         FETCH GTT-CURSOR                                         04590066
198600          INTO :DL-INDEX,                                         04600066
198700               :DL-TABLE,                                         04610066
198800               :DL-PIECESIZE-UNIT,                                04620066
198900               :WS-PIECESIZE,                                     04630066
199000               :WS-PIECE-COUNT,                                   04640066
199100               :WS-MAX-NBR-PIECES,                                04650066
199200               :WS-PCT-REMAINING,                                 04660066
                     :WS-AT-MAX-NBR-PIECES                              04670066
199400     END-EXEC.                                                    04680066
199500                                                                  04690066
199600     IF SQLCODE = +0                                              04700066
199700         PERFORM 3110-WRITE-REPORT-RECORD                         04710070
199900     ELSE                                                         04720066
200000         IF SQLCODE = +100                                        04730066
200100             MOVE 'Y' TO WS-NO-MORE-ROWS                          04740069
200300         ELSE                                                     04760066
200400             DISPLAY '*****************************************'  04770066
200500             DISPLAY '*** PROGRAM ERROR - DBKUT027          ***'  04780066
200600             DISPLAY '***                                   ***'  04790066
200700             DISPLAY '*** PARAGRAPH 3100-FETCH-GTT-ROW      ***'  04800066
200800             DISPLAY '*** BAD FETCH ON GTT-CURSOR           ***'  04810066
200900             DISPLAY '*****************************************'  04820066
201000             PERFORM 9999-SQL-ABEND.                              04830069
                                                                        04840066
                                                                        04840170
00260  3110-WRITE-REPORT-RECORD.                                        04841070
00215 ******************************************************************04842070
00218 * WRITE A REPORT RECORD                                           04843070
00218 * - IF THE CURRENT NUMBER OF PIECES IS EQUAL TO THE MAXIMUM       04843176
00218 *   ALLOWED THEN REPORT ON THE REMAINING CAPACITY OF THE LAST     04843276
00218 *   PIECE.                                                        04843376
00222 ******************************************************************04844070
                                                                        04845070
           MOVE WS-PIECESIZE            TO DL-PIECESIZE.                04850066
           MOVE WS-PIECE-COUNT          TO DL-CURR-NBR-PIECES.          04860066
           MOVE WS-MAX-NBR-PIECES       TO DL-MAX-NBR-PIECES.           04870066
                                                                        04880066
           IF WS-PIECE-COUNT = WS-MAX-NBR-PIECES                        04890076
             MOVE WS-PCT-REMAINING TO DL-PCT-REMAINING                  04910066
           ELSE                                                         04920066
             MOVE SPACES TO DL-PCT-REMAINING-X                          04930066
           END-IF.                                                      04940066
                                                                        04950066
           WRITE OUTPUT-REPORT-REC FROM DETAIL-LINE.                    04960066
                                                                        04970066
                                                                        04980066
00416  4000-END-OF-JOB.                                                 04990066
00410 ******************************************************************05000066
00413 * CLOSE THE INPUT AND OUTPUT FILES.                               05010066
00413 * WRITE END-OF-REPORT RECORD.                                     05020066
00414 ******************************************************************05030066
00417                                                                   05040066
           WRITE OUTPUT-REPORT-REC FROM BLANK-LINE.                     05050066
           WRITE OUTPUT-REPORT-REC FROM END-OF-REPORT-LINE.             05060066
                                                                        05070066
00422      CLOSE INPUT-IX-LISTCAT                                       05080066
00423            OUTPUT-REPORT.                                         05090066
                                                                        05100066
                                                                        05110066
00430  9999-SQL-ABEND.                                                  05120066
00425 ************************************************************      05130066
00426 * THIS PARAGRAPH PERFORMS DB2 ABEND PROCESSING.            *      05140066
00428 ************************************************************      05150066
00431                                                                   05160066
00432      CALL 'DSNTIAR' USING SQLCA                                   05170066
00433                           DP004-FORMATTED-MESSAGE                 05180066
00434                           DP004-ERROR-LINE-LENGTH.                05190066
00435                                                                   05200066
00436      DISPLAY DP004-ASTERISK-LINE.                                 05210066
00437                                                                   05220066
00438      PERFORM                                                      05230066
00439          VARYING DP004-MSG-IDX                                    05240066
00440          FROM 1 BY 1                                              05250066
00441          UNTIL DP004-MSG-IDX > DP004-MAX-MESSAGE-LINES            05260066
00442              DISPLAY '**'                                         05270066
00443                      DP004-MESSAGE-LINE (DP004-MSG-IDX)           05280066
00444                      ' **'                                        05290066
00445      END-PERFORM.                                                 05300066
00446                                                                   05310066
00447      DISPLAY DP004-ASTERISK-LINE.                                 05320066
00448                                                                   05330066
00449      CALL 'ILBOABN0' USING WS-ABEND-CODE.                         05340066
00450                                                                   05350066
00450                                                                   05360066
00430  9999-NONSQL-ABEND.                                               05370066
00425 ************************************************************      05380066
00426 * THIS PARAGRAPH PERFORMS NON-DB2 ABEND PROCESSING.        *      05390066
00428 ************************************************************      05400066
00448                                                                   05410066
00449      CALL 'ILBOABN0' USING WS-ABEND-CODE.                         05420066
00431                                                                   05430066
