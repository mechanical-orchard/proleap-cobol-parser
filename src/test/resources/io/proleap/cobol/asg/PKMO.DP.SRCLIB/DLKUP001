000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.    DLKUP001.                                         00020000
000300 AUTHOR.        PAUL OMAN.                                        00030000
000400                                                                  00040000
000500 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00050000
000600 DATE-WRITTEN.  NOVEMBER 2003.                                    00060000
000700 DATE-COMPILED.                                                   00070000
000800                                                                  00080000
000900 ENVIRONMENT DIVISION.                                            00090000
001000 CONFIGURATION SECTION.                                           00100000
001100 SOURCE-COMPUTER. IBM-3090.                                       00110000
001200 OBJECT-COMPUTER. IBM-3090.                                       00120000
001300                                                                  00130000
001400****************************************************************  00140000
001500*                                                              *  00150000
001600*     CALLED MODULE THAT IS USED TO SECURE THE NEXT SEQUENCE   *  00160000
001700*     NUMBER FOR THE PURPOSE OF NUMBERING DETAIL BUSINESS      *  00170000
001800*     EVENTS WITHIN A LABOR ASSIGNMENT.                        *  00180000
001900*                                                              *  00190000
002000*     THIS MODULE ALSO CALLS DLKUT002 WITH COPYBOOK DLWS004.   *  00200000
002100*                                                              *  00210000
002200*  DB2 ACCESS:                                                 *  00220000
002300*     DLT_ASGMT (DLT00004) TABLE                               *  00230000
002400*                SELECTS                                       *  00240000
002500*                UPDATES                                       *  00250000
002600*                                                              *  00260000
002700*     USED ONLY IN CICS PROGRAMS.                              *  00270000
002800*                                                              *  00280000
002900*  COPYBOOK: DLWS001                                           *  00290000
003000*                                                              *  00300000
003100*                                                              *  00310000
003200****************************************************************  00320000
003300                                                                  00330000
003400 DATA DIVISION.                                                   00340000
003500 WORKING-STORAGE SECTION.                                         00350000
003600                                                                  00360000
003700 01  PV-CHARACTER-FIELDS.                                         00370000
003800     05  PV-KEY-START-DATE        PIC X(10)  VALUE SPACES.        00380000
003900     05  PV-KEY-NBR-TXT           PIC X(10)  VALUE SPACES.        00390000
004000                                                                  00400000
004100 01  PV-COMP-FIELDS.                                              00410000
004200     05  PV-WORK-SEQ-NBR          PIC S9(04) VALUE 0 COMP.        00420000
004300     05  PV-RETRY-COUNTER         PIC S9(04) VALUE 0 COMP.        00430000
004400     05  PV-KEY-NBR-SEQ-NBR       PIC S9(09) VALUE 0 COMP.        00440000
004500                                                                  00450000
004600 01  PS-SWITCHES.                                                 00460000
004700     05  PS-UPDATE-COMPLETE-SW        PIC X(01)  VALUE ' '.       00470000
004800         88  PS-UPDATE-COMPLETE                  VALUE 'C'.       00480000
004900         88  PS-UPDATE-ERROR                     VALUE 'E'.       00490000
005000                                                                  00500000
005100 01  PC-CONSTANTS.                                                00510000
005200     05  PC-MAX-RETRIES           PIC S9(04) VALUE +3 COMP.       00520000
005300     05  PC-N                        PIC X      VALUE 'N'.        00530000
005400     05  PC-ASTERISK-LINE            PIC X(40)  VALUE ALL '*'.    00540000
005500     05  PC-FIVE-BLANKS              PIC X(05)  VALUE '     '.    00550000
005600     05  PC-TEN-BLANKS               PIC X(10)  VALUE SPACES.     00560000
005700                                                                  00570000
005800****************************************************************  00580000
005900*    DLT00003 - DLT_TEM_ASGMT                                  *  00590000
006000*    DLT00004 - DLT_ASGMT                                      *  00600000
006100*                                                              *  00610000
006200****************************************************************  00620000
006300                                                                  00630000
006400     EXEC SQL                                                     00640000
006500         INCLUDE DLT00004                                         00650000
006600     END-EXEC.                                                    00660000
006700                                                                  00670000
006800     EXEC SQL                                                     00680000
006900         INCLUDE DLT00003                                         00690000
007000     END-EXEC.                                                    00700000
007100                                                                  00710000
007200     EXEC SQL                                                     00720000
007300          INCLUDE SQLCA                                           00730000
007400     END-EXEC.                                                    00740000
007500                                                                  00750000
007600****************************************************************  00760000
007700*    COPYBOOK USED TO CALL DLKUT002                            *  00770000
007800****************************************************************  00780000
007900                                                                  00790000
008000     COPY DLWS004.                                                00800000
008100                                                                  00810000
008200                                                                  00820000
008300 LINKAGE SECTION.                                                 00830000
008400     COPY DLWS001.                                                00840000
008500                                                                  00850000
008600                                                                  00860000
008700 PROCEDURE DIVISION USING DL001-ASGMT-COMMAREA.                   00870000
008800                                                                  00880000
008900     SET DL001-SUCCESSFUL  TO TRUE.                               00890000
009000                                                                  00900000
009100     EVALUATE TRUE                                                00910000
009200         WHEN DL001-BY-ASGMT-KEY                                  00920000
009300              PERFORM 1000-FIND-SEQUENCE-NBR                      00930000
009400                                                                  00940000
009500         WHEN OTHER                                               00950000
009600              SET DL001-INVALID-ACCESS TO TRUE                    00960000
009700                                                                  00970000
009800     END-EVALUATE.                                                00980000
009900                                                                  00990000
010000     GOBACK.                                                      01000000
010100                                                                  01010000
010200                                                                  01020000
010300****************************************************************  01030000
010400*    VALIDATE THAT ALL INPUT FIELDS ARE PRESENT.               *  01040000
010500*        STOP PROCESSING AND RETURN IF THERE ARE ANY ERRORS.   *  01050000
010600*                                                              *  01060000
010700****************************************************************  01070000
010800                                                                  01080000
010900 1000-FIND-SEQUENCE-NBR.                                          01090000
011000                                                                  01100000
011100     EVALUATE TRUE                                                01110000
011200         WHEN DL001-KEY-START-DTE = SPACES                        01120000
011300              SET DL001-KEY-FIELDS-MISSING TO TRUE                01130000
011400                                                                  01140000
011500         WHEN DL001-KEY-NBR-TXT = SPACES                          01150000
011600              SET DL001-KEY-FIELDS-MISSING TO TRUE                01160000
011700                                                                  01170000
011800         WHEN DL001-KEY-NBR-SEQ-NBR = 0                           01180000
011900              SET DL001-KEY-FIELDS-MISSING TO TRUE                01190000
012000                                                                  01200000
012100         WHEN DL001-NBRS-NEED-QTY-EMPTY                           01210000
012200              SET DL001-NBR-NEED-QTY-0 TO TRUE                    01220000
012300                                                                  01230000
012400         WHEN OTHER                                               01240000
012500              IF DL001-COMMIT-UPDATE OR                           01250000
012600                 DL001-DO-NOT-COMMIT-UPDATE                       01260000
012700                 CONTINUE                                         01270000
012800              ELSE                                                01280000
012900                 SET DL001-COMMIT-CODE-INVALID TO TRUE            01290000
013000              END-IF                                              01300000
013100                                                                  01310000
013200              IF DL001-FIND-NEXT-ASGMT OR                         01320000
013300                 DL001-DO-NOT-FIND-NEXT-ASGMT                     01330000
013400                 CONTINUE                                         01340000
013500              ELSE                                                01350000
013600                 SET DL001-FIND-ASGMT-INVALID TO TRUE             01360000
013700              END-IF                                              01370000
013800                                                                  01380000
013900              IF DL001-SUCCESSFUL                                 01390000
014000                 PERFORM 2000-PROCESS-ASSIGNMENTS                 01400000
014100              END-IF                                              01410000
014200                                                                  01420000
014300     END-EVALUATE.                                                01430000
014400                                                                  01440000
014500                                                                  01450000
014600****************************************************************  01460000
014700*    SELECT THE ASSIGNMENT FROM THE DLT-ASGMT (DLT00004)       *  01470000
014800*       TABLE.  CHECK THE ASGMT-STP-RSN-CDE.                   *  01480000
014900*       IF IT IS AN "N", COMPUTE THE NEXT SEQUENCE NUMBERS TO  *  01490000
015000*       TO BE USED BY ADDING THE NUMBER NEEDED TO THE          *  01500000
015100*       LAST-USD-SEQ-NBR.  THEN UPDATE THE ROW WITH NEW VALUE. *  01510000
015200*                                                              *  01520000
015300****************************************************************  01530000
015400                                                                  01540000
015500 2000-PROCESS-ASSIGNMENTS.                                        01550000
015600                                                                  01560000
015700     MOVE DL001-KEY-START-DTE   TO PV-KEY-START-DATE.             01570000
015800     MOVE DL001-KEY-NBR-TXT     TO PV-KEY-NBR-TXT.                01580000
015900     MOVE DL001-KEY-NBR-SEQ-NBR TO PV-KEY-NBR-SEQ-NBR.            01590000
016000                                                                  01600000
016100     PERFORM 3000-SELECT-ASSIGNMENT.                              01610000
016200                                                                  01620000
016300     EVALUATE TRUE                                                01630000
016400        WHEN DL001-SQL-ERROR                                      01640000
016500             MOVE SQLCA TO DL001-SQLCA                            01650000
016600                                                                  01660000
016700        WHEN DLT00004-ASGMT-STP-RSN-CDE = 'N'                     01670000
016800             COMPUTE PV-WORK-SEQ-NBR =                            01680000
016900                             DLT00004-LAST-USD-SEQ-NBR +          01690000
017000                             DL001-NBR-OF-NBRS-NEED-QTY           01700000
017100             PERFORM 5000-UPDATE-ASSIGNMENT                       01710000
017200                                                                  01720000
017300             EVALUATE TRUE                                        01730000
017400                 WHEN PS-UPDATE-COMPLETE                          01740000
017500                      SET DL001-SUCCESSFUL TO TRUE                01750000
017600                      SET DL001-ASGMT-FOUND TO TRUE               01760000
017700                                                                  01770000
017800                      COMPUTE DL001-SEQ-START-NBR =               01780000
017900                                  DLT00004-LAST-USD-SEQ-NBR + 1   01790000
018000                      MOVE PV-WORK-SEQ-NBR TO DL001-SEQ-END-NBR   01800000
018100                                                                  01810000
018200                 WHEN PS-UPDATE-ERROR                             01820000
018300                      PERFORM 3000-SELECT-ASSIGNMENT              01830000
018400                      PERFORM 5000-UPDATE-ASSIGNMENT              01840000
018500                                                                  01850000
018600                 WHEN DL001-SQL-CONTENTION                        01860000
018700                      CONTINUE                                    01870000
018800                                                                  01880000
018900                 WHEN OTHER                                       01890000
019000                      SET DL001-SQL-ERROR TO TRUE                 01900000
019100                                                                  01910000
019200             END-EVALUATE                                         01920000
019300                                                                  01930000
019400*        *******************************************************  01940000
019500*          FORMAT DATA TO SEND BACK AND DO COMMIT IF REQUIRED. *  01950000
019600*        *******************************************************  01960000
019700                                                                  01970000
019800             IF PS-UPDATE-COMPLETE                                01980000
019900                COMPUTE DL001-SEQ-START-NBR =                     01990000
020000                                  DLT00004-LAST-USD-SEQ-NBR + 1   02000000
020100                MOVE PV-WORK-SEQ-NBR TO DL001-SEQ-END-NBR         02010000
020200                                                                  02020000
020300                IF DL001-COMMIT-UPDATE                            02030000
020400                   PERFORM 8000-SYNCPOINT                         02040000
020500                END-IF                                            02050000
020600             END-IF                                               02060000
020700                                                                  02070000
020800*        *******************************************************  02080000
020900*          "T" INDICATES THE SYSTEM CLOSED THE ASSIGNMENT      *  02090000
021000*              BECAUSE IT HAD BEEN OPENED FOR X NUMBER OF      *  02100000
021100*              MINUTES.                                        *  02110000
021200*        *******************************************************  02120000
021300        WHEN DLT00004-ASGMT-STP-RSN-CDE = 'T' AND                 02130000
021400             DL001-FIND-NEXT-ASGMT                                02140000
021500             PERFORM 4000-CALL-DLKUT002                           02150000
021600                                                                  02160000
021700        WHEN OTHER                                                02170000
021800             SET DL001-ASGMT-CLOSED TO TRUE                       02180000
021900             SET DL001-ASGMT-CLOSED-RETURN TO TRUE                02190000
022000                                                                  02200000
022100     END-EVALUATE.                                                02210000
022200                                                                  02220000
022300                                                                  02230000
022400 3000-SELECT-ASSIGNMENT.                                          02240000
022500                                                                  02250000
022600     PERFORM                                                      02260000
022700         WITH TEST AFTER                                          02270000
022800         VARYING PV-RETRY-COUNTER                                 02280000
022900         FROM 1 BY 1                                              02290000
023000         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  02300000
023100            OR SQLCODE = ZERO                                     02310000
023200                                                                  02320000
023300         EXEC SQL                                                 02330000
023400             SELECT                                               02340000
023500                    LAST_USD_SEQ_NBR                              02350000
023600                   ,ASGMT_STP_RSN_CDE                             02360000
023700                   ,WK_TYP_DESC                                   02370000
023800                   ,WK_AREA_DESC                                  02380000
023900                   ,DC_NBR                                        02390000
024000              INTO                                                02400000
024100                    :DLT00004-LAST-USD-SEQ-NBR                    02410000
024200                   ,:DLT00004-ASGMT-STP-RSN-CDE                   02420000
024300                   ,:DLT00004-WK-TYP-DESC                         02430000
024400                   ,:DLT00004-WK-AREA-DESC                        02440000
024500                   ,:DLT00004-DC-NBR                              02450000
024600              FROM  DLT_ASGMT                                     02460000
024700             WHERE  ASGMT_STRT_DTE    = :PV-KEY-START-DATE        02470000
024800               AND  ASGMT_NBR_SEQ_NBR = :PV-KEY-NBR-SEQ-NBR       02480000
024900               AND  ASGMT_NBR_TXT     = :PV-KEY-NBR-TXT           02490000
025000         END-EXEC                                                 02500000
025100                                                                  02510000
025200         EVALUATE TRUE                                            02520000
025300             WHEN SQLCODE = ZERO                                  02530000
025400             WHEN SQLCODE = -904                                  02540000
025500             WHEN SQLCODE = -913                                  02550000
025600             WHEN SQLCODE = -911                                  02560000
025700                  CONTINUE                                        02570000
025800                                                                  02580000
025900             WHEN SQLWARN0 NOT = SPACES                           02590000
026000             WHEN SQLCODE NOT = ZERO                              02600000
026100                  MOVE +4             TO PV-RETRY-COUNTER         02610000
026200         END-EVALUATE                                             02620000
026300     END-PERFORM.                                                 02630000
026400                                                                  02640000
026500     IF SQLCODE NOT = ZERO AND                                    02650000
026600        PV-RETRY-COUNTER > PC-MAX-RETRIES                         02660000
026700                                                                  02670000
026800        MOVE '3000-' TO DL001-SQL-ERROR-PARA                      02680000
026900                                                                  02690000
027000        SET DL001-SQL-ERROR TO TRUE                               02700000
027100        MOVE SQLCODE        TO DL001-ASGMT-SQLCODE                02710000
027200        MOVE SQLCA          TO DL001-SQLCA                        02720000
027300     END-IF.                                                      02730000
027400                                                                  02740000
027500 4000-CALL-DLKUT002.                                              02750000
027600                                                                  02760000
027700     INITIALIZE DL004-ASGMT-COMMAREA.                             02770000
027800     SET DL004-BY-WK-TYP-AREA-KEY TO TRUE.                        02780000
027900                                                                  02790000
028000     MOVE DLT00004-WK-TYP-DESC  TO DL004-KEY-WK-TYP.              02800000
028100     MOVE DLT00004-WK-AREA-DESC TO DL004-KEY-WK-AREA.             02810000
028200     MOVE DLT00004-DC-NBR       TO DL004-KEY-DC-NBR.              02820000
028300                                                                  02830000
028400     CALL DL004-USER-PGM USING DFHEIBLK                           02840000
028500                               DL004-COMMAREA                     02850000
028600                               DL004-ASGMT-COMMAREA.              02860000
028700                                                                  02870000
028800     EVALUATE TRUE                                                02880000
028900         WHEN DL004-SUCCESSFUL                                    02890000
029000          AND DL004-ASGMT-FOUND                                   02900000
029100              MOVE DL004-ASGMT-START-DTE   TO PV-KEY-START-DATE   02910000
029200              MOVE DL004-ASGMT-NBR-TXT     TO PV-KEY-NBR-TXT      02920000
029300              MOVE DL004-ASGMT-NBR-SEQ-NBR TO PV-KEY-NBR-SEQ-NBR  02930000
029400                                                                  02940000
029500              PERFORM 3000-SELECT-ASSIGNMENT                      02950000
029600                                                                  02960000
029700              EVALUATE TRUE                                       02970000
029800                 WHEN DL001-SQL-ERROR                             02980000
029900*  2/23/2004          SET DL001-SQL-ERROR TO TRUE                 02990000
030000*  2/23/2004          MOVE DL004-SQLCA TO DL001-SQLCA             03000000
030100                     CONTINUE                                     03010000
030200                                                                  03020000
030300                 WHEN DLT00004-ASGMT-STP-RSN-CDE = 'N'            03030000
030400                      COMPUTE PV-WORK-SEQ-NBR =                   03040000
030500                                      DLT00004-LAST-USD-SEQ-NBR + 03050000
030600                                      DL001-NBR-OF-NBRS-NEED-QTY  03060000
030700                      PERFORM 5000-UPDATE-ASSIGNMENT              03070000
030800                                                                  03080000
030900                      EVALUATE TRUE                               03090000
031000                          WHEN PS-UPDATE-COMPLETE                 03100000
031100                               PERFORM 4100-MOVE-DLWS004-FIELDS   03110000
031200                                                                  03120000
031300                          WHEN PS-UPDATE-ERROR                    03130000
031400                               PERFORM 5000-UPDATE-ASSIGNMENT     03140000
031500                                                                  03150000
031600                          WHEN DL001-SQL-CONTENTION               03160000
031700                               CONTINUE                           03170000
031800                                                                  03180000
031900                          WHEN OTHER                              03190000
032000                               CONTINUE                           03200000
032100                                                                  03210000
032200                      END-EVALUATE                                03220000
032300                                                                  03230000
032400*        *******************************************************  03240000
032500*          FORMAT DATA TO SEND BACK AND DO COMMIT IF REQUIRED. *  03250000
032600*        *******************************************************  03260000
032700                                                                  03270000
032800                      IF DL001-ASGMT-SQLCODE = 0                  03280000
032900                         COMPUTE DL001-SEQ-START-NBR =            03290000
033000                                  DLT00004-LAST-USD-SEQ-NBR + 1   03300000
033100                         MOVE PV-WORK-SEQ-NBR TO                  03310000
033200                                       DL001-SEQ-END-NBR          03320000
033300                                                                  03330000
033400                         IF DL001-COMMIT-UPDATE                   03340000
033500                            PERFORM 8000-SYNCPOINT                03350000
033600                         END-IF                                   03360000
033700                      END-IF                                      03370000
033800                                                                  03380000
033900                 WHEN OTHER                                       03390000
034000                      SET DL001-ASGMT-CLOSED TO TRUE              03400000
034100                                                                  03410000
034200              END-EVALUATE                                        03420000
034300                                                                  03420101
028900         WHEN DL004-SUCCESSFUL                                    03421001
029000          AND DL004-ASGMT-NOT-FOUND                               03422001
034000              SET DL001-ASGMT-CLOSED-RETURN TO TRUE               03423001
034300                                                                  03430000
034400         WHEN OTHER                                               03440000
034500              SET DL001-CALLED-MODULE-FAILURE TO TRUE             03450000
034600              MOVE DL004-CALL-MOD-FAIL-NM  TO                     03460000
034700                                     DL001-CALL-MOD-FAIL-NM       03470000
034800              MOVE DL004-CALL-MOD-FAIL-ERR-CDE TO                 03480000
034900                                     DL001-CALL-MOD-FAIL-ERR-CDE  03490000
035000                                                                  03500000
035100     END-EVALUATE.                                                03510000
035200                                                                  03520000
035300                                                                  03530000
035400 4100-MOVE-DLWS004-FIELDS.                                        03540000
035500                                                                  03550000
035600     MOVE DL004-ASGMT-START-DTE   TO DL001-NXT-START-DTE.         03560000
035700     MOVE DL004-ASGMT-NBR-TXT     TO DL001-NXT-NBR-TXT.           03570000
035800     MOVE DL004-ASGMT-NBR-SEQ-NBR TO DL001-NXT-NBR-SEQ-NBR.       03580000
035900     SET DL001-ASGMT-NEXT-USED TO TRUE.                           03590000
036000                                                                  03600000
036100                                                                  03610000
036200                                                                  03620000
036300 5000-UPDATE-ASSIGNMENT.                                          03630000
036400                                                                  03640000
036500     PERFORM                                                      03650000
036600         WITH TEST AFTER                                          03660000
036700         VARYING PV-RETRY-COUNTER                                 03670000
036800         FROM 1 BY 1                                              03680000
036900         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  03690000
037000            OR SQLCODE = ZERO                                     03700000
037100            OR SQLCODE = +100                                     03710000
037200                                                                  03720000
037300         EXEC SQL                                                 03730000
037400             UPDATE DLT_ASGMT                                     03740000
037500                SET LAST_USD_SEQ_NBR  =  :PV-WORK-SEQ-NBR         03750000
037600                                                                  03760000
037700             WHERE  ASGMT_STRT_DTE    = :PV-KEY-START-DATE        03770000
037800               AND  ASGMT_NBR_SEQ_NBR = :PV-KEY-NBR-SEQ-NBR       03780000
037900               AND  ASGMT_NBR_TXT     = :PV-KEY-NBR-TXT           03790000
038000               AND  LAST_USD_SEQ_NBR  =                           03800000
038100                                :DLT00004-LAST-USD-SEQ-NBR        03810000
038200               AND  ASGMT_STP_RSN_CDE = :PC-N                     03820000
038300         END-EXEC                                                 03830000
038400                                                                  03840000
038500         EVALUATE TRUE                                            03850000
038600             WHEN SQLCODE = ZERO                                  03860000
038700                  SET PS-UPDATE-COMPLETE TO TRUE                  03870000
038800             WHEN SQLCODE = +100                                  03880000
038900                  SET PS-UPDATE-COMPLETE TO TRUE                  03890000
039000                                                                  03900000
039100             WHEN SQLCODE = -904                                  03910000
039200             WHEN SQLCODE = -913                                  03920000
039300             WHEN SQLCODE = -911                                  03930000
039400                  CONTINUE                                        03940000
039500             WHEN SQLWARN0 NOT = SPACES                           03950000
039600             WHEN SQLCODE NOT = ZERO                              03960000
039700                  MOVE +4             TO PV-RETRY-COUNTER         03970000
039800         END-EVALUATE                                             03980000
039900     END-PERFORM.                                                 03990000
040000                                                                  04000000
040100     IF SQLCODE = 0 OR                                            04010000
040200        SQLCODE = +100                                            04020000
040300        CONTINUE                                                  04030000
040400     ELSE                                                         04040000
040500        IF PV-RETRY-COUNTER > PC-MAX-RETRIES                      04050000
040600           MOVE '5000-' TO DL001-SQL-ERROR-PARA                   04060000
040700                                                                  04070000
040800           SET DL001-SQL-ERROR TO TRUE                            04080000
040900           MOVE SQLCODE        TO DL001-ASGMT-SQLCODE             04090000
041000           MOVE SQLCA          TO DL001-SQLCA                     04100000
041100        END-IF                                                    04110000
041200     END-IF.                                                      04120000
041300                                                                  04130000
041400******************************************************************04140000
041500*                                                                *04150000
041600******************************************************************04160000
041700 8000-SYNCPOINT.                                                  04170000
041800                                                                  04180000
041900     EXEC CICS                                                    04190000
042000          SYNCPOINT                                               04200000
042100     END-EXEC.                                                    04210000
042200                                                                  04220000
042300                                                                  04230000
042400                                                                  04240000
